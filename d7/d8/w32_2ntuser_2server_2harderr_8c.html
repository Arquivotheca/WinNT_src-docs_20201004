<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: w32/ntuser/server/harderr.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>harderr.c File Reference</h1><code>#include "<a class="el" href="../../d3/d3/w32_2ntuser_2server_2precomp_8h-source.html">precomp.h</a>"</code><br>
<code>#include "ntlpcapi.h"</code><br>
<code>#include &lt;winsta.h&gt;</code><br>

<p>
<a href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a11">UserHardErrorEx</a> (PCSR_THREAD pt, PHARDERROR_MSG pmsg, <a class="el" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a> pCtxHEInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a12">UserExitWorkerThread</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a13">ProcessHardErrorRequest</a> (BOOL fNewThread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a14">HardErrorInsert</a> (PCSR_THREAD, PHARDERROR_MSG, <a class="el" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a15">HardErrorRemove</a> (<a class="el" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a16">UserRegisterEventSource</a> (PCWSTR pwszSourceName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a17">LogErrorPopup</a> (IN LPWSTR Caption, IN LPWSTR Message)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a18">SubstituteDeviceName</a> (PUNICODE_STRING InputDeviceName, LPSTR OutputDriveLetter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a19">GetErrorMode</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a20">FreePhi</a> (<a class="el" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a> (<a class="el" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwResponse)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a22">CheckDefaultDesktop</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a23">MsgBoxTimerFunc</a> (HWND <a class="el" href="../../d5/d8/jul98_2test_2main_8c.html#a29">hWnd</a>, UINT MessageType, UINT_PTR idEvent, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> TimeWhenCalled)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a24">GetHardErrorText</a> (<a class="el" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a25">HardErrorHandler</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LPWSTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a26">RtlLoadStringOrError</a> (HANDLE hModule, UINT wID, LPWSTR lpDefault, PBOOL pAllocated, BOOL bAnsi)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a27">HardErrorWorkerThread</a> (PVOID ThreadParameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a28">UserHardError</a> (PCSR_THREAD pt, PHARDERROR_MSG pmsg)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a29">BoostHardError</a> (ULONG_PTR dwProcessId, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCode)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a0">gbExitInProgress</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST UINT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a2">wIcons</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST UINT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a3">wOptions</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a4">dwResponses</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a5">dwResponseDefault</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT_PTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>FARPROC&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>FARPROC&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>FARPROC&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a10">wszDosDevices</a> [] = L"\\??\\A:"</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a29" doxytag="w32/ntuser/server/harderr.c::BoostHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL BoostHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>dwProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01906">1906</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00161">BHE_ACTIVATE</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00162">BHE_FORCE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00142">tagHARDERRORINFO::dwHEIFFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d1/d7/clenum_8c-source.html#l00206">EnumThreadWindows()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01255">FindWindowFromThread()</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00044">gdwHardErrorThreadId</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00043">gphiList</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00151">HEIF_ACTIVE</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00152">HEIF_NUKED</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00643">NtUserHardErrorControl()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00138">tagHARDERRORINFO::phiNext</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00481">PostThreadMessage()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00310">ReplyHardError()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03499">SetForegroundWindow()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03502">CreateCtrlThread()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01312">EndTaskDlgProc()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03451">KillProcess()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00757">ThreadShutdownNotify()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00219">UserClientShutdown()</a>, and <a class="el" href="../../d3/d7/api_8c-source.html#l00818">W32WinStationTerminate()</a>.
<p>
<pre class="fragment"><div>01909 {
01910     DESKRESTOREDATA drdRestore;
01911     <a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi, *pphi;
01912     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fHasError = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01913 
01914     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01915     <span class="comment">/*</span>
01916 <span class="comment">     * If the list is empty, nothing do to here.</span>
01917 <span class="comment">     */</span>
01918     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01919         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01920         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01921     }
01922     drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01923     <span class="comment">/*</span>
01924 <span class="comment">     * Walk the hard error list</span>
01925 <span class="comment">     */</span>
01926     pphi = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01927     <span class="keywordflow">while</span> (*pphi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01928         <span class="comment">/*</span>
01929 <span class="comment">         * If not not nuking all and not owned by dwProcessId, continue walking</span>
01930 <span class="comment">         */</span>
01931         <span class="keywordflow">if</span> (dwProcessId != (ULONG_PTR)-1) {
01932             <span class="keywordflow">if</span> (((*pphi)-&gt;pthread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01933                     || ((ULONG_PTR)((*pphi)-&gt;pthread-&gt;ClientId.UniqueProcess) != dwProcessId)) {
01934 
01935                 pphi = &amp;(*pphi)-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01936                 <span class="keywordflow">continue</span>;
01937             }
01938         } <span class="keywordflow">else</span> {
01939             UserAssert(dwCode == BHE_FORCE);
01940         }
01941         <span class="comment">/*</span>
01942 <span class="comment">         * Got one so we want to return TRUE</span>
01943 <span class="comment">         */</span>
01944         fHasError = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01945         <span class="comment">/*</span>
01946 <span class="comment">         * If nuking the request</span>
01947 <span class="comment">         */</span>
01948         <span class="keywordflow">if</span> (dwCode == <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>) {
01949             <span class="comment">/*</span>
01950 <span class="comment">             * Unlink it from the list.</span>
01951 <span class="comment">             */</span>
01952             phi = *pphi;
01953             *pphi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01954 
01955             <span class="comment">/*</span>
01956 <span class="comment">             * If this box is being shown right now, signal it to go away.</span>
01957 <span class="comment">             * Otherwise, nuke it</span>
01958 <span class="comment">             */</span>
01959             <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a21">HEIF_ACTIVE</a>) {
01960                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwHardErrorHandler = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>;
01961                 phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a22">HEIF_NUKED</a>;
01962                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01963                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(dwHardErrorHandler, WM_QUIT, 0, 0);
01964             } <span class="keywordflow">else</span> {
01965                 <span class="comment">/*</span>
01966 <span class="comment">                 * Acknowledge the error as not handled, reply and free</span>
01967 <span class="comment">                 */</span>
01968                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01969                 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a>(phi, ResponseNotHandled);
01970             }
01971 
01972             <span class="comment">/*</span>
01973 <span class="comment">             * Restart the search because we left the crit sect.</span>
01974 <span class="comment">             */</span>
01975             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01976             pphi = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01977 
01978             <span class="comment">/* continue */</span>
01979 
01980         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwCode == <a class="code" href="../../d7/d1/usersrv_8h.html#a29">BHE_ACTIVATE</a>) {
01981             <span class="comment">/*</span>
01982 <span class="comment">             * If it's active, find it and show it.</span>
01983 <span class="comment">             */</span>
01984             phi = *pphi;
01985             <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a21">HEIF_ACTIVE</a>) {
01986                 HWND hwndError = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01987                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwHardErrorHandler = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>;
01988 
01989                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01990                 <a class="code" href="../../d0/d8/clenum_8c.html#a9">EnumThreadWindows</a>(dwHardErrorHandler, FindWindowFromThread, (LPARAM)&amp;hwndError);
01991 
01992                 <span class="keywordflow">if</span> ((hwndError != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01993                         &amp;&amp; (HEC_SUCCESS == <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorAttachNoQueue, NULL, &amp;drdRestore))) {
01994 
01995                     <a class="code" href="../../d3/d8/client_8c.html#a131">SetForegroundWindow</a>(hwndError);
01996 
01997                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorDetachNoQueue, NULL, &amp;drdRestore);
01998                 }
01999                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02000             }
02001 
02002             <span class="comment">/*</span>
02003 <span class="comment">             * It's not active so move it to the head of the list</span>
02004 <span class="comment">             *  to make it show up next.</span>
02005 <span class="comment">             */</span>
02006             *pphi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
02007             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a> = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
02008             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a> = phi;
02009             <span class="keywordflow">break</span>;
02010 
02011         } <span class="keywordflow">else</span> { <span class="comment">/* BHE_TEST */</span>
02012             <span class="comment">/*</span>
02013 <span class="comment">             * The caller just want to know if this process owns a hard error</span>
02014 <span class="comment">             */</span>
02015             <span class="keywordflow">break</span>;
02016         }
02017     } <span class="comment">/*  while (*pphi != NULL) */</span>
02018 
02019     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02020 
02021     <span class="comment">/*</span>
02022 <span class="comment">     * Bug 284468. Wake up the hard error handler</span>
02023 <span class="comment">     */</span>
02024     <span class="keywordflow">if</span> (dwCode == <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a> &amp;&amp; <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> != 0) {
02025         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(gdwHardErrorThreadId, WM_NULL, 0, 0);
02026     }
02027 
02028     <span class="keywordflow">return</span> fHasError;
02029 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="w32/ntuser/server/harderr.c::CheckDefaultDesktop" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void CheckDefaultDesktop           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00347">347</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00142">tagHARDERRORINFO::dwHEIFFlags</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00043">gphiList</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00156">HEIF_WRONGDESKTOP</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00643">NtUserHardErrorControl()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00138">tagHARDERRORINFO::phiNext</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01129">HardErrorHandler()</a>.
<p>
<pre class="fragment"><div>00348 {
00349     <a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi;
00350 
00351     <span class="keywordflow">if</span> (HEC_WRONGDESKTOP == <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorInDefDesktop, NULL, NULL)) {
00352         <span class="keywordflow">return</span>;
00353     }
00354 
00355     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00356     phi = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
00357     <span class="keywordflow">while</span> (phi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00358         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp;= ~<a class="code" href="../../d7/d1/usersrv_8h.html#a26">HEIF_WRONGDESKTOP</a>;
00359         phi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
00360     }
00361     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00362 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="w32/ntuser/server/harderr.c::FreePhi" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void FreePhi           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>phi</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00291">291</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00142">tagHARDERRORINFO::dwHEIFFlags</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00153">HEIF_ALLOCATEDMSG</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00141">tagHARDERRORINFO::pmsg</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00144">tagHARDERRORINFO::usCaption</a>, and <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00143">tagHARDERRORINFO::usText</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00310">ReplyHardError()</a>, and <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>.
<p>
<pre class="fragment"><div>00292 {
00293     <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a23">HEIF_ALLOCATEDMSG</a>) {
00294         LocalFree(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>);
00295     }
00296 
00297     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>);
00298     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>);
00299 
00300     LocalFree(phi);
00301 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="w32/ntuser/server/harderr.c::GetErrorMode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> GetErrorMode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00255">255</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>.
<p>
<pre class="fragment"><div>00256 {
00257     HANDLE hKey;
00258     UNICODE_STRING UnicodeString;
00259     OBJECT_ATTRIBUTES OA;
00260     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00261     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Buf[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)];
00262     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
00263     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet = 0;
00264 
00265     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString,
00266             L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Windows"</span>);
00267     InitializeObjectAttributes(&amp;OA, &amp;UnicodeString, OBJ_CASE_INSENSITIVE, NULL, NULL);
00268 
00269     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKey, KEY_READ, &amp;OA);
00270     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00271         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, L<span class="stringliteral">"ErrorMode"</span>);
00272         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKey,
00273                 &amp;UnicodeString,
00274                 KeyValuePartialInformation,
00275                 (PKEY_VALUE_PARTIAL_INFORMATION)Buf,
00276                 <span class="keyword">sizeof</span>(Buf),
00277                 &amp;cbSize);
00278         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00279             dwRet = *((PDWORD)((PKEY_VALUE_PARTIAL_INFORMATION)Buf)-&gt;Data);
00280         }
00281         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKey);
00282     }
00283     <span class="keywordflow">return</span> dwRet;
00284 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="w32/ntuser/server/harderr.c::GetHardErrorText" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void GetHardErrorText           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>phi</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00423">423</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00075">ARRAY_SIZE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00142">tagHARDERRORINFO::dwHEIFFlags</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00145">tagHARDERRORINFO::dwMBFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00146">tagHARDERRORINFO::dwVDMParam0</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00147">tagHARDERRORINFO::dwVDMParam1</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d1/d7/clenum_8c-source.html#l00206">EnumThreadWindows()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01255">FindWindowFromThread()</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00781">GetWindowText()</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00825">GetWindowTextLength()</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00017">ghModuleWin</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00045">gNtDllHandle</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00047">gpwszaSUCCESS</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00050">gpwszaSYSTEM_ERROR</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00048">gpwszaSYSTEM_INFORMATION</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00049">gpwszaSYSTEM_WARNING</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00157">HEIF_SYSTEMERROR</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00158">HEIF_VDMERROR</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04150">LMEM_ZEROINIT</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">NtReadVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00141">tagHARDERRORINFO::pmsg</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01935">RtlCreateUnicodeString()</a>, <a class="el" href="../../d1/d7/message_8c-source.html#l00030">RtlFindMessage()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01249">RtlFreeAnsiString()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02272">ServerLoadString</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00191">SubstituteDeviceName()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00144">tagHARDERRORINFO::usCaption</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00143">tagHARDERRORINFO::usText</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00031">wIcons</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00037">wOptions</a>, and <a class="el" href="../../d7/d9/wsprintf_8c-source.html#l00995">wsprintfW()</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>.
<p>
<pre class="fragment"><div>00424 {
00425     <span class="keyword">static</span> WCHAR wszUnkownSoftwareException [] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"unknown software exception"</span>;
00426     <span class="keyword">static</span> WCHAR wszException [] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"{EXCEPTION}"</span>;
00427     <span class="keyword">static</span> WCHAR wszUnknownHardError [] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Unknown Hard Error"</span>;
00428     ANSI_STRING asLocal, asMessage;
00429     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFreeAppNameBuffer, fFreeCaption;
00430     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResAllocated, fResAllocated1, fErrorIsFromSystem;
00431     WCHAR wszErrorMessage[WSPRINTF_LIMIT + 1];
00432     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCounter, dwStringsToFreeMask, dwMBFlags;
00433     ULONG_PTR adwParameterVector[MAXIMUM_HARDERROR_PARAMETERS];
00434     HANDLE hClientProcess;
00435     HWND hwndOwner;
00436     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00437     PHARDERROR_MSG phemsg;
00438     PMESSAGE_RESOURCE_ENTRY MessageEntry;
00439     PWSTR pwszCaption, pwszFormatString;
00440     PWSTR pwszAppName, pwszResBuffer, pwszResBuffer1;
00441     PWSTR pwszMsg, pwszTitle, pwszFullCaption;
00442     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uMsgLen, uCaptionLen, uTitleLen;
00443     UNICODE_STRING usScratch, usLocal, usMessage, usCaption;
00444 
00445     <span class="comment">/*</span>
00446 <span class="comment">     * Initialize working variables</span>
00447 <span class="comment">     */</span>
00448     fFreeAppNameBuffer = fFreeCaption = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00449     hClientProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00450     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usCaption, NULL);
00451     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usMessage, NULL);
00452     <span class="comment">/*</span>
00453 <span class="comment">     * Initialize response in case something goes wrong</span>
00454 <span class="comment">     */</span>
00455     phemsg = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>;
00456     phemsg-&gt;Response = ResponseNotHandled;
00457     <span class="comment">/*</span>
00458 <span class="comment">     * Make a copy of the parameters. Initialize unused ones to point to empty</span>
00459 <span class="comment">     *  strings (in case we expect a string there).</span>
00460 <span class="comment">     */</span>
00461     UserAssert(phemsg-&gt;NumberOfParameters &lt;= MAXIMUM_HARDERROR_PARAMETERS);
00462     RtlCopyMemory(adwParameterVector, phemsg-&gt;Parameters, phemsg-&gt;NumberOfParameters * <span class="keyword">sizeof</span>(*phemsg-&gt;Parameters));
00463     dwCounter = phemsg-&gt;NumberOfParameters;
00464     <span class="keywordflow">while</span> (dwCounter &lt; MAXIMUM_HARDERROR_PARAMETERS) {
00465         adwParameterVector[dwCounter++] = (ULONG_PTR)<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00466     }
00467     <span class="comment">/*</span>
00468 <span class="comment">     * Open the client process so we can read the strings parameters, process</span>
00469 <span class="comment">     *  name, etc., from its address space</span>
00470 <span class="comment">     */</span>
00471     hClientProcess = OpenProcess(PROCESS_VM_READ | PROCESS_QUERY_INFORMATION,
00472                                 FALSE, HandleToUlong(phemsg-&gt;h.ClientId.UniqueProcess));
00473     fErrorIsFromSystem = (hClientProcess == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00474     <span class="comment">/*</span>
00475 <span class="comment">     * If there are unicode strings, then we need to</span>
00476 <span class="comment">     * convert them to ansi and store them in the</span>
00477 <span class="comment">     * parameter vector</span>
00478 <span class="comment">     */</span>
00479     dwStringsToFreeMask = 0;
00480     <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask) {
00481 
00482         <span class="keywordflow">for</span> (dwCounter = 0; dwCounter &lt; phemsg-&gt;NumberOfParameters; dwCounter++) {
00483             <span class="comment">/*</span>
00484 <span class="comment">             * if there is no string in this position, continue</span>
00485 <span class="comment">             */</span>
00486             <span class="keywordflow">if</span> (!(phemsg-&gt;UnicodeStringParameterMask &amp; (1 &lt;&lt; dwCounter))) {
00487                 <span class="keywordflow">continue</span>;
00488             }
00489             <span class="comment">/*</span>
00490 <span class="comment">             * Point to an empty string in case we don't have</span>
00491 <span class="comment">             * a client to read from or something fails later on.</span>
00492 <span class="comment">             */</span>
00493             adwParameterVector[dwCounter] = (ULONG_PTR)<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00494             <span class="keywordflow">if</span> (hClientProcess == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00495                 <span class="keywordflow">continue</span>;
00496             }
00497 
00498             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess,
00499                             (PVOID)phemsg-&gt;Parameters[dwCounter],
00500                             (PVOID)&amp;usScratch,
00501                              <span class="keyword">sizeof</span>(usScratch), NULL);
00502 
00503             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00504                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to read error string struct!"</span>);
00505                 <span class="keywordflow">continue</span>;
00506             }
00507 
00508             usLocal = usScratch;
00509             usLocal.Buffer = (PWSTR)LocalAlloc(LMEM_ZEROINIT, usLocal.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00510             <span class="keywordflow">if</span> (usLocal.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00511                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to alloc string buffer!"</span>);
00512                 <span class="keywordflow">continue</span>;
00513             }
00514 
00515             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess,
00516                             (PVOID)usScratch.Buffer,
00517                             (PVOID)usLocal.Buffer,
00518                             usLocal.Length,
00519                             NULL);
00520 
00521             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00522                 LocalFree(usLocal.Buffer);
00523                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to read error string!"</span>);
00524                 <span class="keywordflow">continue</span>;
00525             }
00526 
00527             usLocal.MaximumLength = usLocal.Length;
00528             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>(&amp;asLocal, &amp;usLocal, TRUE);
00529             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00530                 LocalFree(usLocal.Buffer);
00531                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to translate error string!"</span>);
00532                 <span class="keywordflow">continue</span>;
00533             }
00534 
00535             <span class="comment">/*</span>
00536 <span class="comment">             * check to see if string contains an NT</span>
00537 <span class="comment">             * device name. If so, then attempt a</span>
00538 <span class="comment">             * drive letter substitution</span>
00539 <span class="comment">             */</span>
00540 
00541             <span class="keywordflow">if</span> (strstr(asLocal.Buffer,<span class="stringliteral">"\\Device"</span>) == asLocal.Buffer) {
00542                 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a18">SubstituteDeviceName</a>(&amp;usLocal,asLocal.Buffer);
00543             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((asLocal.Length &gt; 4) &amp;&amp; !_strnicmp(asLocal.Buffer, <span class="stringliteral">"\\??\\"</span>, 4)) {
00544                 strcpy( asLocal.Buffer, asLocal.Buffer+4 );
00545                 asLocal.Length -= 4;
00546             } <span class="keywordflow">else</span> {
00547                 <span class="comment">/*</span>
00548 <span class="comment">                 * Processing some status code doesn't require ansi strings.</span>
00549 <span class="comment">                 * Since no substitution took place, let's ignore the translation</span>
00550 <span class="comment">                 * to avoid losing chars -- incorrect code page translation</span>
00551 <span class="comment">                 */</span>
00552                 <span class="keywordflow">switch</span> (phemsg-&gt;Status) {
00553                     <span class="keywordflow">case</span> STATUS_SERVICE_NOTIFICATION:
00554                     <span class="keywordflow">case</span> STATUS_VDM_HARD_ERROR:
00555                         adwParameterVector[dwCounter] = (ULONG_PTR)usLocal.Buffer;
00556                         <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a>(&amp;asLocal);
00557                         <span class="keywordflow">continue</span>;
00558                 }
00559 
00560             }
00561 
00562             LocalFree(usLocal.Buffer);
00563 
00564             dwStringsToFreeMask |= (1 &lt;&lt; dwCounter);
00565             adwParameterVector[dwCounter] = (ULONG_PTR)asLocal.Buffer;
00566 
00567         } <span class="comment">/* for (dwCounter... */</span>
00568 
00569     } <span class="comment">/* if (phemsg-&gt;UnicodeStringParameterMask) */</span>
00570 
00571     <span class="comment">/*</span>
00572 <span class="comment">     * Read additional MB flags, if provided.</span>
00573 <span class="comment">     */</span>
00574 <span class="preprocessor">#if (HARDERROR_PARAMETERS_FLAGSPOS &gt;= MAXIMUM_HARDERROR_PARAMETERS)</span>
00575 <span class="preprocessor"></span><span class="preprocessor">#error Invalid HARDERROR_PARAMETERS_FLAGSPOS value.</span>
00576 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00577 <span class="preprocessor"></span><span class="preprocessor">#if (HARDERROR_FLAGS_DEFDESKTOPONLY != MB_DEFAULT_DESKTOP_ONLY)</span>
00578 <span class="preprocessor"></span><span class="preprocessor">#error Invalid HARDERROR_FLAGS_DEFDESKTOPONLY</span>
00579 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00580 <span class="preprocessor"></span>    dwMBFlags = 0;
00581     <span class="keywordflow">if</span> (phemsg-&gt;NumberOfParameters &gt; HARDERROR_PARAMETERS_FLAGSPOS) {
00582         <span class="comment">/*</span>
00583 <span class="comment">         * Currently we only use MB_DEFAULT_DESKTOP_ONLY</span>
00584 <span class="comment">         */</span>
00585         UserAssert(!(adwParameterVector[HARDERROR_PARAMETERS_FLAGSPOS] &amp; ~MB_DEFAULT_DESKTOP_ONLY));
00586         <span class="keywordflow">if</span> (adwParameterVector[HARDERROR_PARAMETERS_FLAGSPOS] &amp; MB_DEFAULT_DESKTOP_ONLY) {
00587             dwMBFlags |= MB_DEFAULT_DESKTOP_ONLY;
00588         }
00589     }
00590     <span class="comment">/*</span>
00591 <span class="comment">     * For some status codes, all MessageBox parameters are provided in the HardError parameters</span>
00592 <span class="comment">     */</span>
00593     <span class="keywordflow">switch</span> (phemsg-&gt;Status) {
00594         <span class="keywordflow">case</span> STATUS_SERVICE_NOTIFICATION:
00595             <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask &amp; 0x1) {
00596                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usMessage, (PWSTR)adwParameterVector[0]);
00597             } <span class="keywordflow">else</span> {
00598                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;asMessage, (PSTR)adwParameterVector[0]);
00599                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;usMessage, &amp;asMessage, TRUE);
00600             }
00601 
00602             <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask &amp; 0x2) {
00603                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usCaption, (PWSTR)adwParameterVector[1]);
00604             } <span class="keywordflow">else</span> {
00605                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;asMessage, (PSTR)adwParameterVector[1]);
00606                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;usCaption, &amp;asMessage, TRUE);
00607             }
00608 
00609             dwMBFlags = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)adwParameterVector[2] &amp; ~MB_SERVICE_NOTIFICATION;
00610             <span class="keywordflow">goto</span> CleanUpAndSaveParams;
00611 
00612         <span class="keywordflow">case</span> STATUS_VDM_HARD_ERROR:
00613             <span class="comment">/*</span>
00614 <span class="comment">             * Parameters[0] = (fForWOW &lt;&lt; 16) | wBtn1;</span>
00615 <span class="comment">             * Parameters[1] = (wBtn2   &lt;&lt; 16) | wBtn3;</span>
00616 <span class="comment">             * Parameters[2] = (DWORD) szTitle;</span>
00617 <span class="comment">             * Parameters[3] = (DWORD) szMessage;</span>
00618 <span class="comment">             */</span>
00619             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a28">HEIF_VDMERROR</a>;
00620             <span class="comment">/*</span>
00621 <span class="comment">             * Save VDM's Button(s) info to be used later.</span>
00622 <span class="comment">             */</span>
00623             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o8">dwVDMParam0</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)adwParameterVector[0];
00624             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o9">dwVDMParam1</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)adwParameterVector[1];
00625             <span class="comment">/*</span>
00626 <span class="comment">             * Get caption and text.</span>
00627 <span class="comment">             */</span>
00628             <span class="keywordflow">try</span> {
00629                 <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask &amp; 0x4) {
00630                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usCaption, (PWSTR)adwParameterVector[2]);
00631                 } <span class="keywordflow">else</span> {
00632                     MBToWCS((LPSTR)adwParameterVector[2], -1, &amp;pwszTitle, -1, TRUE);
00633                     <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usCaption, pwszTitle);
00634                     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, pwszTitle);
00635                 }
00636 
00637                 <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask &amp; 0x8) {
00638                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usMessage, (PWSTR)adwParameterVector[3]);
00639                 } <span class="keywordflow">else</span> {
00640                     MBToWCS((LPSTR)adwParameterVector[3], -1, &amp;pwszMsg, -1, TRUE);
00641                     <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, pwszMsg);
00642                     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, pwszMsg);
00643                 }
00644 
00645 
00646             } except (EXCEPTION_EXECUTE_HANDLER) {
00647 
00648                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Exception reading STATUS_VDM_HARD_ERROR paramerters"</span>);
00649 
00650                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;usCaption);
00651                 <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usCaption, L<span class="stringliteral">"VDM Internal Error"</span>);
00652                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;usMessage);
00653                 <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, L<span class="stringliteral">"Exception retrieving error text."</span>);
00654             }
00655             <span class="keywordflow">goto</span> CleanUpAndSaveParams;
00656     }
00657 
00658     <span class="comment">/*</span>
00659 <span class="comment">     * For all other status codes, we generate the information from the status code.</span>
00660 <span class="comment">     * First, Map status code and valid response to MessageBox flags.</span>
00661 <span class="comment">     */</span>
00662     dwMBFlags |= <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a2">wIcons</a>[(ULONG)(phemsg-&gt;Status) &gt;&gt; 30] | <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a3">wOptions</a>[phemsg-&gt;ValidResponseOptions];
00663 
00664 
00665     <span class="comment">/*</span>
00666 <span class="comment">     * If we have a client process, try to get the actual application name</span>
00667 <span class="comment">     */</span>
00668     pwszAppName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00669     <span class="keywordflow">if</span> (!fErrorIsFromSystem) {
00670         PPEB Peb;
00671         PROCESS_BASIC_INFORMATION BasicInfo;
00672         PLDR_DATA_TABLE_ENTRY LdrEntry;
00673         LDR_DATA_TABLE_ENTRY LdrEntryData;
00674         PLIST_ENTRY LdrHead, LdrNext;
00675         PPEB_LDR_DATA Ldr;
00676         PVOID ImageBaseAddress;
00677         PWSTR ClientApplicationName;
00678 
00679         <span class="comment">/*</span>
00680 <span class="comment">         * This is cumbersome, but basically, we locate the processes</span>
00681 <span class="comment">         * loader data table and get it's name directly out of the</span>
00682 <span class="comment">         * loader table</span>
00683 <span class="comment">         */</span>
00684 
00685         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a18">NtQueryInformationProcess</a>(hClientProcess, ProcessBasicInformation,
00686                     &amp;BasicInfo, <span class="keyword">sizeof</span>(BasicInfo), NULL);
00687 
00688         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00689             fErrorIsFromSystem = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00690             <span class="keywordflow">goto</span> noname;
00691         }
00692 
00693         Peb = BasicInfo.PebBaseAddress;
00694         <span class="keywordflow">if</span> (Peb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00695             fErrorIsFromSystem = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00696             <span class="keywordflow">goto</span> noname;
00697         }
00698 
00699         <span class="comment">/*</span>
00700 <span class="comment">         * ldr = Peb-&gt;Ldr</span>
00701 <span class="comment">         */</span>
00702         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, &amp;Peb-&gt;Ldr, &amp;Ldr,
00703                     <span class="keyword">sizeof</span>(Ldr), NULL);
00704 
00705         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00706             <span class="keywordflow">goto</span> noname;
00707         }
00708 
00709         LdrHead = &amp;Ldr-&gt;InLoadOrderModuleList;
00710 
00711         <span class="comment">/*</span>
00712 <span class="comment">         * LdrNext = Head-&gt;Flink;</span>
00713 <span class="comment">         */</span>
00714         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, &amp;LdrHead-&gt;Flink,
00715                     &amp;LdrNext, <span class="keyword">sizeof</span>(LdrNext), NULL );
00716 
00717         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00718             <span class="keywordflow">goto</span> noname;
00719         }
00720 
00721         <span class="keywordflow">if</span> (LdrNext == LdrHead) {
00722             <span class="keywordflow">goto</span> noname;
00723         }
00724         <span class="comment">/*</span>
00725 <span class="comment">         * This is the entry data for the image.</span>
00726 <span class="comment">         */</span>
00727         LdrEntry = CONTAINING_RECORD(LdrNext, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
00728         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, LdrEntry,
00729                     &amp;LdrEntryData, <span class="keyword">sizeof</span>(LdrEntryData), NULL);
00730 
00731         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00732             <span class="keywordflow">goto</span> noname;
00733         }
00734 
00735         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, &amp;Peb-&gt;ImageBaseAddress,
00736                     &amp;ImageBaseAddress, <span class="keyword">sizeof</span>(ImageBaseAddress), NULL);
00737 
00738         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00739             <span class="keywordflow">goto</span> noname;
00740         }
00741 
00742         <span class="keywordflow">if</span> (ImageBaseAddress != LdrEntryData.DllBase) {
00743             <span class="keywordflow">goto</span> noname;
00744         }
00745 
00746         LdrNext = LdrEntryData.InLoadOrderLinks.Flink;
00747 
00748         ClientApplicationName = (PWSTR)LocalAlloc(LMEM_ZEROINIT, LdrEntryData.BaseDllName.MaximumLength);
00749         <span class="keywordflow">if</span> (ClientApplicationName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00750             <span class="keywordflow">goto</span> noname;
00751         }
00752 
00753         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, LdrEntryData.BaseDllName.Buffer,
00754                     ClientApplicationName, LdrEntryData.BaseDllName.MaximumLength,
00755                     NULL);
00756 
00757         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00758             LocalFree(ClientApplicationName);
00759             <span class="keywordflow">goto</span> noname;
00760         }
00761 
00762         pwszAppName = ClientApplicationName;
00763         fFreeAppNameBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00764 
00765 noname:;
00766     } <span class="comment">/* if (!fErrorIsFromSystem) */</span>
00767 
00768     <span class="keywordflow">if</span> (pwszAppName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00769         <span class="comment">/*</span>
00770 <span class="comment">         * Load default application name (to be used in the caption).</span>
00771 <span class="comment">         */</span>
00772         pwszAppName = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(ghModuleWin, STR_UNKNOWN_APPLICATION,
00773                                         L<span class="stringliteral">"System Process"</span>, &amp;fFreeAppNameBuffer);
00774     }
00775 
00776     <span class="comment">/*</span>
00777 <span class="comment">     * Map status code to (optional) caption and format string.</span>
00778 <span class="comment">     * If a caption is provided, it's enclosed in {} and it's</span>
00779 <span class="comment">     *  the first thing in the format string</span>
00780 <span class="comment">     */</span>
00781     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00782     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a13">gNtDllHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00783         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a13">gNtDllHandle</a> = GetModuleHandle(TEXT(<span class="stringliteral">"ntdll"</span>));
00784         UserAssert(gNtDllHandle != NULL);
00785     }
00786     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00787 
00788     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a>((PVOID)gNtDllHandle, (ULONG_PTR)RT_MESSAGETABLE,
00789                             LANG_NEUTRAL, phemsg-&gt;Status, &amp;MessageEntry);
00790 
00791     <span class="comment">/*</span>
00792 <span class="comment">     * Parse the caption (if any) and the format string.</span>
00793 <span class="comment">     */</span>
00794     pwszCaption = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00795     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00796         pwszFormatString = wszUnknownHardError;
00797     } <span class="keywordflow">else</span> {
00798         pwszFormatString = (PWSTR)MessageEntry-&gt;Text;
00799         <span class="comment">/*</span>
00800 <span class="comment">         * If the message starts with a '{', it has a caption.</span>
00801 <span class="comment">         */</span>
00802         <span class="keywordflow">if</span> (*pwszFormatString == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'{'</span>) {
00803             uCaptionLen = 0;
00804             pwszFormatString++;
00805             <span class="comment">/*</span>
00806 <span class="comment">             * Find the closing bracket</span>
00807 <span class="comment">             */</span>
00808             <span class="keywordflow">while</span> ((*pwszFormatString != (WCHAR)0) &amp;&amp; (*pwszFormatString++ != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'}'</span>)) {
00809                 uCaptionLen++;
00810             }
00811             <span class="comment">/*</span>
00812 <span class="comment">             * Eat any non-printable stuff (\r\n), up to the NULL</span>
00813 <span class="comment">             */</span>
00814             <span class="keywordflow">while</span> ((*pwszFormatString != (WCHAR)0) &amp;&amp; (*pwszFormatString &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>)) {
00815                 pwszFormatString++;
00816             }
00817             <span class="comment">/*</span>
00818 <span class="comment">             * Allocate a buffer an copy the caption string</span>
00819 <span class="comment">             */</span>
00820             <span class="keywordflow">if</span> ((uCaptionLen++ &gt; 0)
00821                 &amp;&amp; ((pwszCaption = (PWSTR)LocalAlloc(LPTR, uCaptionLen * <span class="keyword">sizeof</span>(WCHAR))) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00822 
00823                 RtlCopyMemory(pwszCaption, (PWSTR)MessageEntry-&gt;Text + 1, (uCaptionLen - 1) * <span class="keyword">sizeof</span>(WCHAR));
00824                 fFreeCaption = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00825             }
00826         } <span class="comment">/* if (*pszParsedCaption == '{') */</span>
00827 
00828         <span class="keywordflow">if</span> (*pwszFormatString == (WCHAR)0) {
00829             pwszFormatString = wszUnknownHardError;
00830         }
00831     } <span class="comment">/* if (!NT_SUCCESS(Status))  (Failed to read caption/format string) */</span>
00832 
00833 
00834     <span class="comment">/*</span>
00835 <span class="comment">     * If the message didn't include a caption (or we didn't find the message),</span>
00836 <span class="comment">     *  default to something</span>
00837 <span class="comment">     */</span>
00838     <span class="keywordflow">if</span> (pwszCaption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00839         <span class="keywordflow">switch</span> (phemsg-&gt;Status &amp; ERROR_SEVERITY_ERROR) {
00840             <span class="keywordflow">case</span> ERROR_SEVERITY_SUCCESS:
00841                 pwszCaption = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a15">gpwszaSUCCESS</a>;
00842                 <span class="keywordflow">break</span>;
00843             <span class="keywordflow">case</span> ERROR_SEVERITY_INFORMATIONAL:
00844                 pwszCaption = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a16">gpwszaSYSTEM_INFORMATION</a>;
00845                 <span class="keywordflow">break</span>;
00846             <span class="keywordflow">case</span> ERROR_SEVERITY_WARNING:
00847                 pwszCaption = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a17">gpwszaSYSTEM_WARNING</a>;
00848                 <span class="keywordflow">break</span>;
00849             <span class="keywordflow">case</span> ERROR_SEVERITY_ERROR:
00850                 pwszCaption = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a18">gpwszaSYSTEM_ERROR</a>;
00851                 <span class="keywordflow">break</span>;
00852         }
00853     }
00854     UserAssert(pwszCaption != NULL);
00855     <span class="comment">/*</span>
00856 <span class="comment">     * If the client has a window, get its title so it can be added to</span>
00857 <span class="comment">     *  the caption.</span>
00858 <span class="comment">     */</span>
00859     hwndOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00860     <a class="code" href="../../d0/d8/clenum_8c.html#a9">EnumThreadWindows</a>(HandleToUlong(phemsg-&gt;h.ClientId.UniqueThread),
00861                         FindWindowFromThread, (LPARAM)&amp;hwndOwner);
00862     <span class="keywordflow">if</span> (hwndOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00863         uTitleLen = 0;
00864     } <span class="keywordflow">else</span> {
00865         uTitleLen = <a class="code" href="../../d5/d9/cltxt_8h.html#a22">GetWindowTextLength</a>(hwndOwner);
00866         <span class="keywordflow">if</span> (uTitleLen != 0) {
00867             pwszTitle = (PWSTR)LocalAlloc(LPTR, (uTitleLen + 3) * <span class="keyword">sizeof</span>(WCHAR));
00868             <span class="keywordflow">if</span> (pwszTitle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00869                 <a class="code" href="../../d5/d9/cltxt_8h.html#a21">GetWindowText</a>(hwndOwner, pwszTitle, uTitleLen + 1);
00870                 <span class="comment">/*</span>
00871 <span class="comment">                 * Add format chars.</span>
00872 <span class="comment">                 */</span>
00873                 *(pwszTitle + uTitleLen++) = (WCHAR)<span class="charliteral">':'</span>;
00874                 *(pwszTitle + uTitleLen++) = (WCHAR)<span class="charliteral">' '</span>;
00875             } <span class="keywordflow">else</span> {
00876                 <span class="comment">/*</span>
00877 <span class="comment">                 * We couldn't allocate a buffer to get the title</span>
00878 <span class="comment">                 */</span>
00879                 uTitleLen = 0;
00880             }
00881         } <span class="comment">/* if (uTitleLen != 0) */</span>
00882     } <span class="comment">/* else if (hwndOwner == NULL) */</span>
00883     <span class="comment">/*</span>
00884 <span class="comment">     * If we don't have a window title, make it an empty string so we won't</span>
00885 <span class="comment">     *  have to special case it later.</span>
00886 <span class="comment">     */</span>
00887     <span class="keywordflow">if</span> (uTitleLen == 0) {
00888         pwszTitle = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00889     }
00890     <span class="comment">/*</span>
00891 <span class="comment">     * Finally we can build the caption string now.</span>
00892 <span class="comment">     * It looks like this: [WindowTile: ]ApplicationName - ErrorCaption</span>
00893 <span class="comment">     */</span>
00894     uCaptionLen = uTitleLen + wcslen(pwszAppName) + 3 + wcslen(pwszCaption) + 1;
00895     pwszFullCaption = (PWSTR)LocalAlloc(LPTR, uCaptionLen * <span class="keyword">sizeof</span>(WCHAR));
00896     <span class="keywordflow">if</span> (pwszFullCaption != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00897 <span class="preprocessor">        #if DBG</span>
00898 <span class="preprocessor"></span>        <span class="keywordtype">int</span> iLen =
00899 <span class="preprocessor">        #endif</span>
00900 <span class="preprocessor"></span>            <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(pwszFullCaption, L<span class="stringliteral">"%s%s - %s"</span>, pwszTitle, pwszAppName, pwszCaption);
00901         UserAssert((UINT)iLen &lt; uCaptionLen);
00902         <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usCaption, pwszFullCaption);
00903         LocalFree(pwszFullCaption);
00904     }
00905     <span class="comment">/*</span>
00906 <span class="comment">     * Free caption working buffers, as appropriate.</span>
00907 <span class="comment">     */</span>
00908     <span class="keywordflow">if</span> (fFreeCaption) {
00909         LocalFree(pwszCaption);
00910     }
00911     <span class="keywordflow">if</span> (fFreeAppNameBuffer) {
00912         LocalFree(pwszAppName);
00913     }
00914     <span class="keywordflow">if</span> (uTitleLen != 0) {
00915         LocalFree(pwszTitle);
00916     }
00917     <span class="comment">/*</span>
00918 <span class="comment">     * Build the error message using pszFormatString and adwParameterVector.</span>
00919 <span class="comment">     * Special case UAE</span>
00920 <span class="comment">     */</span>
00921     <span class="keywordflow">if</span> (phemsg-&gt;Status == STATUS_UNHANDLED_EXCEPTION ) {
00922         <span class="comment">/*</span>
00923 <span class="comment">         * The first parameter has the exception status code. Map it to a</span>
00924 <span class="comment">         *  format string and build the error message with it and the</span>
00925 <span class="comment">         *  parameters.</span>
00926 <span class="comment">         */</span>
00927         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a>( (PVOID)gNtDllHandle, (ULONG_PTR)RT_MESSAGETABLE,
00928                                  LANG_NEUTRAL, (ULONG)adwParameterVector[0], &amp;MessageEntry);
00929 
00930         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00931             <span class="comment">/*</span>
00932 <span class="comment">             * We couldn't read the exception name so let's use unknown.</span>
00933 <span class="comment">             */</span>
00934             pwszResBuffer = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(ghModuleWin, STR_UNKNOWN_EXCEPTION,
00935                             wszUnkownSoftwareException, &amp;fResAllocated);
00936 
00937             <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, pwszFormatString, pwszResBuffer,
00938                       adwParameterVector[0], adwParameterVector[1]);
00939 
00940             <span class="keywordflow">if</span> (fResAllocated) {
00941                 LocalFree(pwszResBuffer);
00942             }
00943 
00944             <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, wszErrorMessage);
00945             UserAssert(usMessage.MaximumLength &lt;= <span class="keyword">sizeof</span>(wszErrorMessage));
00946 
00947         } <span class="keywordflow">else</span> {
00948             <span class="comment">/*</span>
00949 <span class="comment">             * Access Violations are handled a bit differently</span>
00950 <span class="comment">             */</span>
00951 
00952             <span class="keywordflow">if</span> (adwParameterVector[0] == STATUS_ACCESS_VIOLATION ) {
00953 
00954                 <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, (PWSTR)MessageEntry-&gt;Text, adwParameterVector[1],
00955                           adwParameterVector[3], adwParameterVector[2] ? L<span class="stringliteral">"written"</span> : L<span class="stringliteral">"read"</span>);
00956 
00957             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adwParameterVector[0] == STATUS_IN_PAGE_ERROR) {
00958                 <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, (PWSTR)MessageEntry-&gt;Text, adwParameterVector[1],
00959                           adwParameterVector[3], adwParameterVector[2]);
00960 
00961             } <span class="keywordflow">else</span> {
00962                 <span class="comment">/*</span>
00963 <span class="comment">                 * If this is a marked exception, skip the mark;</span>
00964 <span class="comment">                 *  the exception name follows it.</span>
00965 <span class="comment">                 */</span>
00966                 pwszCaption = (PWSTR)MessageEntry-&gt;Text;
00967                 <span class="keywordflow">if</span> (!wcsncmp(pwszCaption, wszException, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszException) - 1)) {
00968                     pwszCaption += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszException) - 1;
00969                     <span class="comment">/*</span>
00970 <span class="comment">                     * Skip not printable stuff (\r\n)</span>
00971 <span class="comment">                     */</span>
00972                     <span class="keywordflow">while</span> ((*pwszCaption != (WCHAR)0) &amp;&amp; (*pwszCaption &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>)) {
00973                         pwszCaption++;
00974                     }
00975 
00976                 } <span class="keywordflow">else</span> {
00977                     pwszCaption = wszUnkownSoftwareException;
00978                 }
00979 
00980                 <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, pwszFormatString, pwszCaption,
00981                           adwParameterVector[0], adwParameterVector[1]);
00982             }
00983 
00984             UserAssert(wcslen(wszErrorMessage) &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszErrorMessage));
00985 
00986             <span class="comment">/*</span>
00987 <span class="comment">             * Add button(s) explanation text.</span>
00988 <span class="comment">             */</span>
00989             pwszResBuffer = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(ghModuleWin, STR_OK_TO_TERMINATE,
00990                             L<span class="stringliteral">"Click on OK to terminate the application"</span>,
00991                             &amp;fResAllocated);
00992 
00993 
00994             <span class="keywordflow">if</span> (phemsg-&gt;ValidResponseOptions == OptionOkCancel ) {
00995                 pwszResBuffer1 = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(ghModuleWin,
00996                                 STR_CANCEL_TO_DEBUG, L<span class="stringliteral">"Click on CANCEL xx to debug the application"</span>,
00997                                 &amp;fResAllocated1);
00998             } <span class="keywordflow">else</span> {
00999                 pwszResBuffer1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01000                 fResAllocated1 = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01001             }
01002 
01003             <span class="comment">/*</span>
01004 <span class="comment">             * Conncatenate all strings, one per line.</span>
01005 <span class="comment">             */</span>
01006             uMsgLen = wcslen(wszErrorMessage)
01007                         + wcslen(pwszResBuffer) + 1
01008                         + (pwszResBuffer1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? 0 : wcslen(pwszResBuffer1) + 1)
01009                         + 1;
01010 
01011             pwszMsg = (PWSTR) LocalAlloc(LPTR, uMsgLen * <span class="keyword">sizeof</span>(WCHAR));
01012             <span class="keywordflow">if</span> (pwszMsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01013 <span class="preprocessor">                #if DBG</span>
01014 <span class="preprocessor"></span>                <span class="keywordtype">int</span> iLen =
01015 <span class="preprocessor">                #endif</span>
01016 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(pwszMsg, L<span class="stringliteral">"%s\n%s%s%s"</span>, wszErrorMessage, pwszResBuffer,
01017                               (pwszResBuffer1 == NULL ? L<span class="stringliteral">""</span> : L<span class="stringliteral">"\n"</span>),
01018                               (pwszResBuffer1 == NULL ? L<span class="stringliteral">""</span> : pwszResBuffer1));
01019 
01020                 UserAssert((UINT)iLen &lt; uMsgLen);
01021 
01022                 <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, pwszMsg);
01023                 LocalFree(pwszMsg);
01024             }
01025 
01026             <span class="comment">/*</span>
01027 <span class="comment">             * Free ServerLoadString allocations.</span>
01028 <span class="comment">             */</span>
01029             <span class="keywordflow">if</span> (fResAllocated) {
01030                 LocalFree(pwszResBuffer);
01031             }
01032 
01033             <span class="keywordflow">if</span> (fResAllocated1) {
01034                 LocalFree(pwszResBuffer1);
01035             }
01036 
01037 
01038         }
01039 
01040     } <span class="keywordflow">else</span> {
01041         <span class="comment">/*</span>
01042 <span class="comment">         * Default message text generation for all other status codes</span>
01043 <span class="comment">         */</span>
01044         <span class="keywordflow">try</span> {
01045 <span class="preprocessor">            #if DBG</span>
01046 <span class="preprocessor"></span>            <span class="keywordtype">int</span> iLen =
01047 <span class="preprocessor">            #endif</span>
01048 <span class="preprocessor"></span>                <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, pwszFormatString, adwParameterVector[0],
01049                                               adwParameterVector[1],
01050                                               adwParameterVector[2],
01051                                               adwParameterVector[3]);
01052             UserAssert((UINT)iLen &lt;  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszErrorMessage));
01053 
01054             <span class="comment">/*</span>
01055 <span class="comment">             * Remove \r\n</span>
01056 <span class="comment">             */</span>
01057             pwszFormatString = wszErrorMessage;
01058             <span class="keywordflow">while</span> (*pwszFormatString != (WCHAR)0) {
01059                 <span class="keywordflow">if</span> (*pwszFormatString == (WCHAR)0xd) {
01060                     *pwszFormatString = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>;
01061                     <span class="comment">/*</span>
01062 <span class="comment">                     * Move everything up if a CR LF sequence is found</span>
01063 <span class="comment">                     */</span>
01064                     <span class="keywordflow">if</span> (*(pwszFormatString+1) == (WCHAR)0xa) {
01065                         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uSize = (wcslen(pwszFormatString+1) + 1) * <span class="keyword">sizeof</span>(WCHAR);
01066                         RtlMoveMemory(pwszFormatString, pwszFormatString+1, uSize);
01067                     }
01068                  }
01069 
01070                 <span class="keywordflow">if</span> (*pwszFormatString == (WCHAR)0xa) {
01071                     *pwszFormatString = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>;
01072                 }
01073 
01074                 pwszFormatString++;
01075             }
01076 
01077             <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, wszErrorMessage);
01078             UserAssert(usMessage.MaximumLength &lt;= <span class="keyword">sizeof</span>(wszErrorMessage));
01079         } except(EXCEPTION_EXECUTE_HANDLER) {
01080 
01081             <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, L<span class="stringliteral">"Exception Processing Message %lx Parameters %lx %lx %lx %lx"</span>,
01082                       phemsg-&gt;Status, adwParameterVector[0], adwParameterVector[1],
01083                       adwParameterVector[2], adwParameterVector[3]);
01084 
01085             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;usMessage);
01086             <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, wszErrorMessage);
01087             UserAssert(usMessage.MaximumLength &lt;= <span class="keyword">sizeof</span>(wszErrorMessage));
01088 
01089         } <span class="comment">/* try */</span>
01090 
01091     } <span class="comment">/* else if (phemsg-&gt;Status == STATUS_UNHANDLED_EXCEPTION) */</span>
01092 
01093 
01094 CleanUpAndSaveParams:
01095      <span class="keywordflow">if</span> (hClientProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01096          <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hClientProcess);
01097      }
01098     <span class="comment">/*</span>
01099 <span class="comment">     * Free string parameters.</span>
01100 <span class="comment">     * Note that we're supposed to call RtlFreeAnsiString since these were</span>
01101 <span class="comment">     *  allocated by RtlUnicodeStringToAnsiString.... but we only saved the buffers...</span>
01102 <span class="comment">     */</span>
01103     <span class="keywordflow">if</span> (dwStringsToFreeMask != 0) {
01104         <span class="keywordflow">for</span> (dwCounter = 0; dwCounter &lt; phemsg-&gt;NumberOfParameters; dwCounter++) {
01105             <span class="keywordflow">if</span> (dwStringsToFreeMask &amp; (1 &lt;&lt; dwCounter)) {
01106                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, (PVOID)adwParameterVector[dwCounter]);
01107             }
01108         }
01109     }
01110     <span class="comment">/*</span>
01111 <span class="comment">     * Save MessageBox Parameters in phi to be used and freed later.</span>
01112 <span class="comment">     */</span>
01113     <span class="keywordflow">if</span> (fErrorIsFromSystem) {
01114         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a27">HEIF_SYSTEMERROR</a>;
01115     }
01116     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a> = usMessage;
01117     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a> = usCaption;
01118     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> = dwMBFlags;
01119     <span class="keywordflow">return</span>;
01120 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="w32/ntuser/server/harderr.c::HardErrorHandler" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HardErrorHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01129">1129</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00075">ARRAY_SIZE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03255">_MSGBOXDATA::CancelId</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03253">_MSGBOXDATA::cButtons</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00347">CheckDefaultDesktop()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00173">COPY_FLAG</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03254">_MSGBOXDATA::DefButton</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00142">tagHARDERRORINFO::dwHEIFFlags</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00145">tagHARDERRORINFO::dwMBFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00048">dwResponses</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00146">tagHARDERRORINFO::dwVDMParam0</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00147">tagHARDERRORINFO::dwVDMParam1</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00948">gbExitInProgress</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00044">gdwHardErrorThreadId</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00018">gfTimedOut</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00043">gphiList</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00931">gSessionId</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00077">gTimerId</a>, <a class="el" href="../../d6/d4/icamsg_8c.html#a7">HardErrorRemove()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00151">HEIF_ACTIVE</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00152">HEIF_NUKED</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00158">HEIF_VDMERROR</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00156">HEIF_WRONGDESKTOP</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03600">ISTS</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03120">MAX_SEB_STYLES</a>, <a class="el" href="../../d7/d3/msgbox_8c-source.html#l01627">MB_GetString()</a>, <a class="el" href="../../d3/d0/userexts_8c-source.html#l01830">msg</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1105">MSGBOXDATA</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00383">MsgBoxTimerFunc()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01475">MsgWaitForMultipleObjects()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00643">NtUserHardErrorControl()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00148">tagHARDERRORINFO::pCtxHEInfo</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00483">PeekMessage()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00138">tagHARDERRORINFO::phiNext</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03138">_MSGBOXDATA::pidButton</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00141">tagHARDERRORINFO::pmsg</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03139">_MSGBOXDATA::ppszButtonText</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00139">tagHARDERRORINFO::pthread</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00310">ReplyHardError()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00060">tagCTXHARDERRORINFO::Response</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03123">SEB_CANCEL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03132">SEB_DEFBUTTON</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00442">SetTimer</a>, <a class="el" href="../../d7/d3/msgbox_8c-source.html#l00730">SoftModalMessageBox()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00059">tagCTXHARDERRORINFO::Timeout</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00144">tagHARDERRORINFO::usCaption</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00143">tagHARDERRORINFO::usText</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01599">ProcessHardErrorRequest()</a>.
<p>
<pre class="fragment"><div>01130 {
01131     <span class="keywordtype">int</span> idResponse;
01132     <a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi, *pphi;
01133     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwResponse;
01134     DESKRESTOREDATA drdRestore;
01135     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNuked;
01136     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uHECRet;
01137     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCmd;
01138     HANDLE hThread;
01139     <span class="keywordtype">int</span> aidButton[3], cButtons;
01140     LPWSTR apstrButton[3];
01141     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">MSGBOXDATA</a> mbd;
01142     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bDoBlock;
01143     <a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a> pCtxHEInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01144     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01145 
01146 <span class="preprocessor">#if DBG</span>
01147 <span class="preprocessor"></span>    <span class="comment">/*</span>
01148 <span class="comment">     * We should have only one error handler at the time.</span>
01149 <span class="comment">     */</span>
01150     <span class="keyword">static</span> <span class="keywordtype">long</span> glReentered = -1;
01151     UserAssert(InterlockedIncrement(&amp;glReentered) == 0);
01152 <span class="preprocessor">#endif</span>
01153 <span class="preprocessor"></span>
01154     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01155         bDoBlock = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a> || (HEC_ERROR == <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorSetup, NULL, NULL)));
01156     } <span class="keywordflow">else</span> {
01157         bDoBlock = (HEC_ERROR == <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorSetup, NULL, NULL));
01158     }
01159 
01160     drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01161 
01162     <span class="keywordflow">if</span> (bDoBlock) {
01163         <span class="comment">/*</span>
01164 <span class="comment">         * We failed to set up to process hard errors.  Acknowledge all</span>
01165 <span class="comment">         * pending errors as NotHandled.</span>
01166 <span class="comment">         */</span>
01167         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01168         <span class="keywordflow">while</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01169             phi = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01170             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a> = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01171             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01172             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a>(phi, ResponseNotHandled);
01173             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01174         }
01175         UserAssert(InterlockedDecrement(&amp;glReentered) &lt; 0);
01176         UserAssert(gdwHardErrorThreadId == HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread));
01177         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> = 0;
01178         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01179         <span class="keywordflow">return</span>;
01180     }
01181 
01182     <span class="comment">/*</span>
01183 <span class="comment">     * Process all hard error requests.</span>
01184 <span class="comment">     */</span>
01185 
01186     <span class="keywordflow">for</span> (;;) {
01187         <span class="comment">/*</span>
01188 <span class="comment">         * Grab the next request (for the current desktop)</span>
01189 <span class="comment">         * If we're done, reset gdwHardErrorThreadId so any request</span>
01190 <span class="comment">         *  after this point will be handled by someone else</span>
01191 <span class="comment">         */</span>
01192         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01193         phi = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01194         <span class="keywordflow">if</span> (phi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01195             UserAssert(InterlockedDecrement(&amp;glReentered) &lt; 0);
01196             UserAssert(gdwHardErrorThreadId == HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread));
01197             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> = 0;
01198         } <span class="keywordflow">else</span> {
01199             <span class="keywordflow">while</span> ((phi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a26">HEIF_WRONGDESKTOP</a>)) {
01200                 phi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01201             }
01202             <span class="keywordflow">if</span> (phi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01203                 <span class="comment">/*</span>
01204 <span class="comment">                 * We're going to show this one.</span>
01205 <span class="comment">                 */</span>
01206                 phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a21">HEIF_ACTIVE</a>;
01207             } <span class="keywordflow">else</span> {
01208                 <span class="comment">/*</span>
01209 <span class="comment">                 * We have some requests pending but they are not</span>
01210 <span class="comment">                 *  for the current desktop. Let's wait for another</span>
01211 <span class="comment">                 *  request (WM_NULL posted) or a desktop switch (PostQuitMessage)</span>
01212 <span class="comment">                 */</span>
01213                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01214                 <a class="code" href="../../d3/d8/client_8c.html#a57">MsgWaitForMultipleObjects</a>(0, NULL, FALSE, INFINITE, QS_POSTMESSAGE);
01215                 <a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>(&amp;msg, NULL, 0, 0, PM_REMOVE);
01216                 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a22">CheckDefaultDesktop</a>();
01217                 <span class="keywordflow">continue</span>;
01218             }
01219         }
01220         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01221         <span class="comment">/*</span>
01222 <span class="comment">         * If no messages are pending, we're done.</span>
01223 <span class="comment">         */</span>
01224         <span class="keywordflow">if</span> (phi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01225             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorCleanup, NULL, NULL);
01226             <span class="keywordflow">return</span>;
01227         }
01228 
01229         <span class="comment">/*</span>
01230 <span class="comment">         * The Boost routine can mess with the list, so must get citrix info now.</span>
01231 <span class="comment">         */</span>
01232         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01233             pCtxHEInfo = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a>;
01234             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a>) {
01235                 dwResponse = ResponseOk;
01236                 <span class="keywordflow">goto</span> Reply;
01237             }
01238         }
01239 
01240         <span class="comment">/*</span>
01241 <span class="comment">         * Get win32k attach parameters.</span>
01242 <span class="comment">         */</span>
01243         dwCmd = (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> &amp; MB_DEFAULT_DESKTOP_ONLY) ? HardErrorAttachUser : HardErrorAttach;
01244         hThread = (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a>-&gt;ThreadHandle : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01245         <span class="comment">/*</span>
01246 <span class="comment">         * We have already handled the MB_SERVICE_NOTIFICATION flags.</span>
01247 <span class="comment">         * Clear it to prevent recursion.</span>
01248 <span class="comment">         * Also, don't let hard error boxes steal the foreground</span>
01249 <span class="comment">         */</span>
01250         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> &amp;= ~(MB_SERVICE_NOTIFICATION | MB_SETFOREGROUND | MB_SYSTEMMODAL);
01251         <span class="comment">/*</span>
01252 <span class="comment">         * If this is a VDM error, figure out buttons, default id, style, etc</span>
01253 <span class="comment">         */</span>
01254         <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a28">HEIF_VDMERROR</a>) {
01255             <span class="keywordtype">int</span> i;
01256             WORD rgwBtn[3], wBtn;
01257             <span class="comment">/*</span>
01258 <span class="comment">             * Initialize MSGBOXDATA with the information we</span>
01259 <span class="comment">             *  have already figured out.</span>
01260 <span class="comment">             */</span>
01261             RtlZeroMemory(&amp;mbd, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">MSGBOXDATA</a>));
01262             mbd.cbSize = <span class="keyword">sizeof</span>(MSGBOXPARAMS);
01263             mbd.lpszText = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer;
01264             mbd.lpszCaption = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer;
01265             <span class="comment">/*</span>
01266 <span class="comment">             * phi-&gt;dwVDMParam0 = (fForWOW &lt;&lt; 16) | wBtn1;</span>
01267 <span class="comment">             * phi-&gt;dwVDMParam1 = (wBtn2   &lt;&lt; 16) | wBtn3;</span>
01268 <span class="comment">             * Right now, only WOW does this.  If NTVDM does it,</span>
01269 <span class="comment">             * fForWOW will be false.</span>
01270 <span class="comment">             */</span>
01271             rgwBtn[0] = LOWORD(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o8">dwVDMParam0</a>);
01272             rgwBtn[1] = HIWORD(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o9">dwVDMParam1</a>);
01273             rgwBtn[2] = LOWORD(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o9">dwVDMParam1</a>);
01274             cButtons = 0;
01275             <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
01276                 wBtn = rgwBtn[i] &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a890">SEB_DEFBUTTON</a>;
01277                 <span class="keywordflow">if</span> (wBtn &amp;&amp; wBtn &lt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a880">MAX_SEB_STYLES</a>) {
01278                     apstrButton[cButtons] = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1144">MB_GetString</a>(wBtn-1);
01279                     aidButton[cButtons] = i + 1;
01280                     <span class="keywordflow">if</span> (rgwBtn[i] &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a890">SEB_DEFBUTTON</a>) {
01281                         mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o6">DefButton</a> = cButtons;
01282                     }
01283                     <span class="keywordflow">if</span> (wBtn == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a882">SEB_CANCEL</a>) {
01284                         mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o7">CancelId</a> = cButtons;
01285                     }
01286                     cButtons++;
01287                 }
01288             }
01289             mbd.dwStyle = MB_TOPMOST;
01290             <span class="keywordflow">if</span> ((cButtons != 1) || (aidButton[0] != 1)) {
01291                 mbd.dwStyle |= MB_OKCANCEL;
01292             }
01293             mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o4">ppszButtonText</a> = apstrButton;
01294             mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o3">pidButton</a> = aidButton;
01295             mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a> = cButtons;
01296         }
01297         <span class="comment">/*</span>
01298 <span class="comment">         * Attach to win32k and show the dialog.</span>
01299 <span class="comment">         * If we switch desktops, (loop and) show it on the new desktop (if applicable)</span>
01300 <span class="comment">         */</span>
01301         <span class="keywordflow">do</span> {
01302             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Response = ResponseNotHandled;
01303 
01304             uHECRet = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(dwCmd, hThread, &amp;drdRestore);
01305 
01306             <span class="keywordflow">if</span> (uHECRet == HEC_SUCCESS) {
01307                 <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a28">HEIF_VDMERROR</a>) {
01308                     idResponse = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1145">SoftModalMessageBox</a>(&amp;mbd);
01309                 } <span class="keywordflow">else</span> {
01310                     <span class="comment">/*</span>
01311 <span class="comment">                     * Bring up the message box. Or in MB_TOPMOST so</span>
01312 <span class="comment">                     * it comes up on top.</span>
01313 <span class="comment">                     * We want to preserve the MB_DEFAULT_DESKTOP_ONLY flag</span>
01314 <span class="comment">                     *  but don't want to pass it to MessageBox or we'll</span>
01315 <span class="comment">                     *  recurse due to a compatibility hack</span>
01316 <span class="comment">                     */</span>
01317 
01318                     <span class="comment">/*</span>
01319 <span class="comment">                     *  Really a Terminal Server message</span>
01320 <span class="comment">                     */</span>
01321                     <span class="keywordflow">if</span> (pCtxHEInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01322 
01323                         <span class="comment">/*</span>
01324 <span class="comment">                         * If timeout is not (-1), or 0, then we must queue</span>
01325 <span class="comment">                         * a system timer to call our timer callback function</span>
01326 <span class="comment">                         * to cancel the message box.</span>
01327 <span class="comment">                         */</span>
01328                         <span class="keywordflow">if</span> ((pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o5">Timeout</a> != (-1)) &amp;&amp; (pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o5">Timeout</a> != 0)) {
01329 
01330                             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Timeout;
01331 
01332                             <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o5">Timeout</a>) &lt; (MAXLONG/1000)) {
01333                                 Timeout = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o5">Timeout</a> * 1000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01334                             } <span class="keywordflow">else</span> {
01335                                 Timeout = MAXLONG;
01336                             }
01337 
01338                             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01339                             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a> = <a class="code" href="../../d3/d0/user32_8def.html#a56">SetTimer</a>((HWND)0,
01340                                                 (UINT)0,
01341                                                 Timeout,
01342                                                 MsgBoxTimerFunc);
01343                             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a> == 0) {
01344                                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"HardErrorHandler: Could not set system timer"</span>);
01345                             }
01346                         }
01347 
01348                         RIPMSG2(RIP_WARNING, <span class="stringliteral">"HardErrorHandler: MessageBoxEx( %S, %S )"</span>,
01349                                 phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer);
01350                     } <span class="keywordflow">else</span> {
01351                         RIPMSG2(RIP_WARNING, <span class="stringliteral">"HardErrorHandler: MessageBoxEx( %S, %S )"</span>,
01352                                 phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer);
01353                     }
01354 
01355                     idResponse = MessageBoxEx(NULL, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer,
01356                         (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> | MB_TOPMOST) &amp; ~MB_DEFAULT_DESKTOP_ONLY, 0);
01357                 }
01358                 <span class="comment">/*</span>
01359 <span class="comment">                 * Restore hard error handler desktop; this will also</span>
01360 <span class="comment">                 *  tell us if the input desktop has changed; if so,</span>
01361 <span class="comment">                 *  we want to bring the error box again on the new</span>
01362 <span class="comment">                 *  desktop.</span>
01363 <span class="comment">                 */</span>
01364                 uHECRet = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorDetach, NULL, &amp;drdRestore);
01365 
01366                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01367                     <span class="comment">/*</span>
01368 <span class="comment">                     * Kill the timer if set</span>
01369 <span class="comment">                     */</span>
01370                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a>) {
01371                         KillTimer((HWND)0, gTimerId);
01372                         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a> = 0;
01373                     }
01374                     <span class="comment">/*</span>
01375 <span class="comment">                     *  Really a citrix message</span>
01376 <span class="comment">                     */</span>
01377                     <span class="keywordflow">if</span> (uHECRet != HEC_DESKTOPSWITCH &amp;&amp; pCtxHEInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01378 
01379                         <span class="comment">/*</span>
01380 <span class="comment">                         * Check for message box timeout</span>
01381 <span class="comment">                         */</span>
01382                         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a>) {
01383                            uHECRet = HEC_SUCCESS;
01384                            <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01385                            pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o6">Response</a> = IDTIMEOUT;
01386                         } <span class="keywordflow">else</span> {
01387                            pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o6">Response</a> = idResponse;
01388                         }
01389 
01390                     }
01391                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a4">dwResponses</a>[idResponse] == ResponseNotHandled &amp;&amp;
01392                         uHECRet == HEC_DESKTOPSWITCH &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> == 0) {
01393 
01394                         RIPMSG2(RIP_WARNING, <span class="stringliteral">"HardErrorHandler: abort harderror, idResponse %u, uHECRet %u"</span>,
01395                                     idResponse, uHECRet);
01396 
01397                         <span class="keywordflow">break</span>;
01398                     }
01399                 }
01400             } <span class="keywordflow">else</span> {
01401                 idResponse = 0;
01402             }
01403             UserAssert((UINT)idResponse &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(dwResponses));
01404             dwResponse = <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a4">dwResponses</a>[idResponse];
01405             <span class="comment">/*</span>
01406 <span class="comment">             * If we don't want to reshow this box, done</span>
01407 <span class="comment">             */</span>
01408             <span class="keywordflow">if</span> (uHECRet != HEC_DESKTOPSWITCH) {
01409                 <span class="keywordflow">break</span>;
01410             } <span class="keywordflow">else</span> {
01411                 <span class="comment">/*</span>
01412 <span class="comment">                 * We've switched desktops; if we're in the default one</span>
01413 <span class="comment">                 *  now, then we can show all MB_DEFAULT_DESKTOP_ONLY</span>
01414 <span class="comment">                 *  requests.</span>
01415 <span class="comment">                 */</span>
01416                 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a22">CheckDefaultDesktop</a>();
01417             }
01418             <span class="comment">/*</span>
01419 <span class="comment">             * If BoostHardError nuked it, don't re-show it</span>
01420 <span class="comment">             */</span>
01421             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01422             fNuked = (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a22">HEIF_NUKED</a>);
01423             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01424         } <span class="keywordflow">while</span> (!fNuked);
01425 
01426         <span class="comment">/*</span>
01427 <span class="comment">         * If we didn't show this box because we're not in the</span>
01428 <span class="comment">         *  default desktop, mark this phi and continue</span>
01429 <span class="comment">         */</span>
01430         <span class="keywordflow">if</span> (uHECRet == HEC_WRONGDESKTOP) {
01431             UserAssert(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> &amp; MB_DEFAULT_DESKTOP_ONLY);
01432             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01433             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a14">COPY_FLAG</a>(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a>, HEIF_WRONGDESKTOP, HEIF_ACTIVE | HEIF_WRONGDESKTOP);
01434             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01435             <span class="keywordflow">continue</span>;
01436         }
01437 
01438 Reply:
01439         <span class="comment">/*</span>
01440 <span class="comment">         * We're done with this phi.</span>
01441 <span class="comment">         * Unlink it if BoostHardError haven't done so already;</span>
01442 <span class="comment">         *  If unlinked, it is marked as nuked.</span>
01443 <span class="comment">         */</span>
01444         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01445         UserAssert(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; HEIF_ACTIVE);
01446         fNuked = (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a22">HEIF_NUKED</a>);
01447         <span class="keywordflow">if</span> (!fNuked) {
01448             pphi = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01449             <span class="keywordflow">while</span> ((*pphi != phi) &amp;&amp; (*pphi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01450                 pphi = &amp;(*pphi)-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01451             }
01452             UserAssert(*pphi != NULL);
01453             *pphi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01454         }
01455 
01456 <span class="preprocessor">#if DBG</span>
01457 <span class="preprocessor"></span>         <span class="keywordflow">else</span> {
01458             <span class="comment">/*</span>
01459 <span class="comment">             * Let's make sure it was unlinked.</span>
01460 <span class="comment">             */</span>
01461             pphi = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01462             <span class="keywordflow">while</span> ((*pphi != phi) &amp;&amp; (*pphi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01463                 UserAssert(!((*pphi)-&gt;dwHEIFFlags &amp; (HEIF_ACTIVE | HEIF_NUKED)));
01464                 pphi = &amp;(*pphi)-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01465             }
01466             UserAssert(*pphi == NULL);
01467          }
01468 <span class="preprocessor">#endif</span>
01469 <span class="preprocessor"></span>
01470         <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a>) {
01471 
01472             <span class="comment">/*</span>
01473 <span class="comment">             * Clean up</span>
01474 <span class="comment">             */</span>
01475             <a class="code" href="../../d6/d4/icamsg_8c.html#a7">HardErrorRemove</a>(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a>);
01476 
01477             <span class="comment">/*</span>
01478 <span class="comment">             * Done</span>
01479 <span class="comment">             */</span>
01480             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01481         }
01482 
01483         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01484 
01485         <span class="comment">/*</span>
01486 <span class="comment">         * Save the response, reply and free phi</span>
01487 <span class="comment">         */</span>
01488         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a>(phi, (fNuked ? ResponseNotHandled : dwResponse));
01489 
01490     } <span class="comment">/* for (;;) */</span>
01491 
01492     <span class="comment">/*</span>
01493 <span class="comment">     * Nobody should break out of the loop.</span>
01494 <span class="comment">     */</span>
01495     UserAssert(FALSE);
01496 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="w32/ntuser/server/harderr.c::HardErrorInsert" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HardErrorInsert           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCSR_THREAD&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PHARDERROR_MSG&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a>&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01669">1669</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>01673 {
01674     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a11">UserHardErrorEx</a>(pt, pmsg, pCtxHEInfo);
01675 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="w32/ntuser/server/harderr.c::HardErrorRemove" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HardErrorRemove           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d3/icamsg_8c-source.html#l00282">282</a> of file <a class="el" href="../../d7/d3/icamsg_8c-source.html">icamsg.c</a>.
<p>
References <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00063">tagCTXHARDERRORINFO::DoNotWait</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00057">tagCTXHARDERRORINFO::pMessage</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00056">tagCTXHARDERRORINFO::pTitle</a>, <a class="el" href="../../d6/d3/icadis_8c-source.html#l00168">ReplyMessageToTerminalServer()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>00284 {
00285 
00286     <span class="comment">/*</span>
00287 <span class="comment">     *  Notify ICASRV's RPC thread if waiting</span>
00288 <span class="comment">     */</span>
00289     <span class="keywordflow">if</span> (!pchi-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o9">DoNotWait</a>) {
00290         <a class="code" href="../../d6/d4/icamsg_8c.html#a10">ReplyMessageToTerminalServer</a>(pchi);
00291     }
00292 
00293     <span class="comment">/*</span>
00294 <span class="comment">     *  Free memory</span>
00295 <span class="comment">     */</span>
00296     LocalFree(pchi-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o3">pMessage</a>);
00297     LocalFree(pchi-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o2">pTitle</a>);
00298     LocalFree(pchi);
00299 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="w32/ntuser/server/harderr.c::HardErrorWorkerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HardErrorWorkerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ThreadParameter</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01569">1569</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01599">ProcessHardErrorRequest()</a>, and <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a12">UserExitWorkerThread()</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01599">ProcessHardErrorRequest()</a>.
<p>
<pre class="fragment"><div>01572 {
01573     PCSR_THREAD pt;
01574     UNREFERENCED_PARAMETER(ThreadParameter);
01575 
01576     pt = CsrConnectToUser();
01577     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a13">ProcessHardErrorRequest</a>(FALSE);
01578     <span class="keywordflow">if</span> (pt) {
01579         CsrDereferenceThread(pt);
01580     }
01581     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a12">UserExitWorkerThread</a>();
01582 
01583     <span class="keywordflow">return</span> STATUS_SUCCESS;
01584 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="w32/ntuser/server/harderr.c::LogErrorPopup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LogErrorPopup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Caption</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Message</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00166">166</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00046">gEventSource</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00087">gfnReportEvent</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>.
<p>
<pre class="fragment"><div>00170 {
00171 
00172     LPWSTR lps[2];
00173 
00174     lps[0] = Caption;
00175     lps[1] = Message;
00176 
00177     UserAssert(gEventSource != NULL);
00178     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a>(gEventSource, EVENTLOG_INFORMATION_TYPE, 0,
00179         STATUS_LOG_HARD_ERROR, NULL, <span class="keyword">sizeof</span>(lps) / <span class="keyword">sizeof</span>(*lps),
00180         0, lps, NULL);
00181 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="w32/ntuser/server/harderr.c::MsgBoxTimerFunc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MsgBoxTimerFunc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hWnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>MessageType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>idEvent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TimeWhenCalled</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00383">383</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00044">gdwHardErrorThreadId</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00018">gfTimedOut</a>, <a class="el" href="../../d4/d7/aug98_2test_2main_8c-source.html#l00110">hWnd</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00481">PostThreadMessage()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01129">HardErrorHandler()</a>.
<p>
<pre class="fragment"><div>00389 {
00390     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> RetVal;
00391 
00392     RIPMSG0(RIP_WARNING, <span class="stringliteral">"MsgBoxTimerFunc: timer poped"</span>);
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Post a WM_QUIT message into the messagebox threads queue</span>
00396     <span class="comment">//</span>
00397     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> != 0 ) {
00398         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00399         RetVal = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(gdwHardErrorThreadId, WM_QUIT, 0, 0);
00400     }
00401 
00402     <span class="keywordflow">if</span>(- !RetVal ) {
00403         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MsgBoxTimerFunc: PostMessageFailed"</span>);
00404     }
00405 
00406     UNREFERENCED_PARAMETER(hWnd);
00407     UNREFERENCED_PARAMETER(MessageType);
00408     UNREFERENCED_PARAMETER(idEvent);
00409     UNREFERENCED_PARAMETER(TimeWhenCalled);
00410 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="w32/ntuser/server/harderr.c::ProcessHardErrorRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ProcessHardErrorRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>fNewThread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01599">1599</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00044">gdwHardErrorThreadId</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01129">HardErrorHandler()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01569">HardErrorWorkerThread()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00138">NtResumeThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00481">PostThreadMessage()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01241">RtlCreateUserThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01569">HardErrorWorkerThread()</a>, and <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>.
<p>
<pre class="fragment"><div>01602 {
01603     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01604     CLIENT_ID ClientId;
01605     HANDLE hThread;
01606 
01607     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01608 
01609     <span class="comment">/*</span>
01610 <span class="comment">     * If there's already a hard error handler, make sure he's awake.</span>
01611 <span class="comment">     */</span>
01612     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>) {
01613         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwHardErrorHandler = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>;
01614         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01615         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(dwHardErrorHandler, WM_NULL, 0, 0);
01616         <span class="keywordflow">return</span>;
01617     }
01618 
01619     <span class="comment">/*</span>
01620 <span class="comment">     * Create a worker thread to handle the hard error.</span>
01621 <span class="comment">     */</span>
01622     <span class="keywordflow">if</span> (fNewThread) {
01623         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01624         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(NtCurrentProcess(),
01625                                      NULL,
01626                                      TRUE,
01627                                      0,
01628                                      0,
01629                                      0,
01630                                      HardErrorWorkerThread,
01631                                      NULL,
01632                                      &amp;hThread,
01633                                      &amp;ClientId);
01634         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01635             CsrAddStaticServerThread(hThread, &amp;ClientId, 0);
01636             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(hThread, NULL);
01637             <span class="keywordflow">return</span>;
01638         }
01639         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01640     }
01641 
01642     <span class="comment">/*</span>
01643 <span class="comment">     * Let this thread handle the hard error.</span>
01644 <span class="comment">     */</span>
01645     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread);
01646     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01647     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a25">HardErrorHandler</a>();
01648 
01649     <span class="keywordflow">return</span>;
01650 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="w32/ntuser/server/harderr.c::ReplyHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void ReplyHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>phi</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwResponse</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00310">310</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00142">tagHARDERRORINFO::dwHEIFFlags</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00291">FreePhi()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00155">HEIF_DEREFTHREAD</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00154">HEIF_REPLIED</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00140">tagHARDERRORINFO::hEventHardError</a>, <a class="el" href="../../d6/d6/lpcreply_8c-source.html#l00044">NtReplyPort()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00141">tagHARDERRORINFO::pmsg</a>, and <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00139">tagHARDERRORINFO::pthread</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01906">BoostHardError()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01129">HardErrorHandler()</a>, and <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>.
<p>
<pre class="fragment"><div>00311 {
00312     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Response = dwResponse;
00313     <span class="comment">/*</span>
00314 <span class="comment">     * Signal the event if any. If not, reply if we haven't done so</span>
00315 <span class="comment">     *  already.</span>
00316 <span class="comment">     */</span>
00317     <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o2">hEventHardError</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00318         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o2">hEventHardError</a>, NULL);
00319     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a24">HEIF_REPLIED</a>)) {
00320         <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(((PCSR_THREAD)phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a>)-&gt;Process-&gt;ClientPort,
00321                     (PPORT_MESSAGE)phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>);
00322     }
00323     <span class="comment">/*</span>
00324 <span class="comment">     * If we had locked the thread or were holding the client port,</span>
00325 <span class="comment">     *   then let it go now.</span>
00326 <span class="comment">     */</span>
00327     <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a25">HEIF_DEREFTHREAD</a>) {
00328         CsrDereferenceThread(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a>);
00329     }
00330     <span class="comment">/*</span>
00331 <span class="comment">     * We're done with this dude</span>
00332 <span class="comment">     */</span>
00333     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a20">FreePhi</a>(phi);
00334 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="w32/ntuser/server/harderr.c::RtlLoadStringOrError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LPWSTR RtlLoadStringOrError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hModule</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>wID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>lpDefault</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PBOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>pAllocated</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>bAnsi</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01499">1499</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04150">LMEM_ZEROINIT</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d7/message_8c-source.html#l00030">RtlFindMessage()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01029">GetRegIntFromID()</a>, and <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00192">UserServerDllInitialization()</a>.
<p>
<pre class="fragment"><div>01506 {
01507     LPTSTR lpsz;
01508     <span class="keywordtype">int</span> cch;
01509     LPWSTR lpw;
01510     PMESSAGE_RESOURCE_ENTRY MessageEntry;
01511     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01512 
01513     cch = 0;
01514     lpw = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01515 
01516     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a>((PVOID)hModule, (ULONG_PTR)RT_MESSAGETABLE,
01517             0, wID, &amp;MessageEntry);
01518     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01519 
01520         <span class="comment">/*</span>
01521 <span class="comment">         * Return two fewer chars so the crlf in the message will be</span>
01522 <span class="comment">         * stripped out.</span>
01523 <span class="comment">         */</span>
01524         cch = wcslen((PWCHAR)MessageEntry-&gt;Text) - 2;
01525         lpsz = (LPWSTR)MessageEntry-&gt;Text;
01526 
01527         <span class="keywordflow">if</span> (bAnsi) {
01528             <span class="keywordtype">int</span> ich;
01529 
01530             <span class="comment">/*</span>
01531 <span class="comment">             * Add one to zero terminate then force the termination</span>
01532 <span class="comment">             */</span>
01533             ich = WCSToMB(lpsz, cch+1, (CHAR **)&amp;lpw, -1, TRUE);
01534             ((LPSTR)lpw)[ich-1] = 0;
01535 
01536             }
01537         <span class="keywordflow">else</span> {
01538             lpw = (LPWSTR)LocalAlloc(LMEM_ZEROINIT,(cch+1)*<span class="keyword">sizeof</span>(WCHAR));
01539             <span class="keywordflow">if</span> ( lpw ) {
01540 
01541                 <span class="comment">/*</span>
01542 <span class="comment">                 * Copy the string into the buffer.</span>
01543 <span class="comment">                 */</span>
01544                     RtlCopyMemory(lpw, lpsz, cch*<span class="keyword">sizeof</span>(WCHAR));
01545                 }
01546             }
01547         }
01548 
01549     <span class="keywordflow">if</span> ( !lpw ) {
01550         lpw = lpDefault;
01551         *pAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01552         } <span class="keywordflow">else</span> {
01553         *pAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01554         }
01555 
01556     <span class="keywordflow">return</span> lpw;
01557 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="w32/ntuser/server/harderr.c::SubstituteDeviceName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SubstituteDeviceName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>InputDeviceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputDriveLetter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00191">191</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00075">ARRAY_SIZE</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00247">NtOpenSymbolicLinkObject()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00189">wszDosDevices</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00423">GetHardErrorText()</a>.
<p>
<pre class="fragment"><div>00195 {
00196     UNICODE_STRING LinkName;
00197     UNICODE_STRING DeviceName;
00198     OBJECT_ATTRIBUTES Obja;
00199     HANDLE LinkHandle;
00200     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00201     ULONG i;
00202     PWCHAR p;
00203     WCHAR DeviceNameBuffer[MAXIMUM_FILENAME_LENGTH];
00204 
00205     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;LinkName,wszDosDevices);
00206     p = <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a10">wszDosDevices</a> + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszDosDevices) - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(L<span class="stringliteral">"A:"</span>);
00207     <span class="keywordflow">for</span>(i=0;i&lt;26;i++){
00208         *p = (WCHAR)(<span class="charliteral">'A'</span> + i);
00209 
00210         InitializeObjectAttributes(
00211             &amp;Obja,
00212             &amp;LinkName,
00213             OBJ_CASE_INSENSITIVE,
00214             NULL,
00215             NULL
00216             );
00217         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>(
00218                     &amp;LinkHandle,
00219                     SYMBOLIC_LINK_QUERY,
00220                     &amp;Obja
00221                     );
00222         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00223 
00224             <span class="comment">//</span>
00225             <span class="comment">// Open succeeded, Now get the link value</span>
00226             <span class="comment">//</span>
00227 
00228             DeviceName.Length = 0;
00229             DeviceName.MaximumLength = <span class="keyword">sizeof</span>(DeviceNameBuffer);
00230             DeviceName.Buffer = DeviceNameBuffer;
00231 
00232             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a7">NtQuerySymbolicLinkObject</a>(
00233                         LinkHandle,
00234                         &amp;DeviceName,
00235                         NULL
00236                         );
00237             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LinkHandle);
00238             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00239                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(InputDeviceName,&amp;DeviceName,TRUE) ) {
00240                     OutputDriveLetter[0]=(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)(<span class="charliteral">'A'</span>+i);
00241                     OutputDriveLetter[1]=<span class="charliteral">':'</span>;
00242                     OutputDriveLetter[2]=<span class="charliteral">'\0'</span>;
00243                     <span class="keywordflow">return</span>;
00244                     }
00245                 }
00246             }
00247         }
00248 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="w32/ntuser/server/harderr.c::UserExitWorkerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UserExitWorkerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01946">ConsoleInputThread()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01569">HardErrorWorkerThread()</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="w32/ntuser/server/harderr.c::UserHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UserHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCSR_THREAD&nbsp;</td>
          <td class="mdname" nowrap> <em>pt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PHARDERROR_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>pmsg</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01662">1662</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00192">UserServerDllInitialization()</a>.
<p>
<pre class="fragment"><div>01665 {
01666     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a11">UserHardErrorEx</a>(pt, pmsg, NULL);
01667 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="w32/ntuser/server/harderr.c::UserHardErrorEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UserHardErrorEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCSR_THREAD&nbsp;</td>
          <td class="mdname" nowrap> <em>pt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PHARDERROR_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>pmsg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pCtxHEInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">1686</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00075">ARRAY_SIZE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00142">tagHARDERRORINFO::dwHEIFFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00062">dwResponseDefault</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00291">FreePhi()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00255">GetErrorMode()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00423">GetHardErrorText()</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00046">gEventSource</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00086">gfnDeregisterEventSource</a>, <a class="el" href="../../d5/d5/ntuser_2server_2globals_8c-source.html#l00043">gphiList</a>, <a class="el" href="../../d7/d1/usersrv_8h.html#a48">HARDERRORINFO</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00153">HEIF_ALLOCATEDMSG</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00155">HEIF_DEREFTHREAD</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00154">HEIF_REPLIED</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00157">HEIF_SYSTEMERROR</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00140">tagHARDERRORINFO::hEventHardError</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03600">ISTS</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00166">LogErrorPopup()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d6/d6/lpcreply_8c-source.html#l00044">NtReplyPort()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00148">tagHARDERRORINFO::pCtxHEInfo</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00138">tagHARDERRORINFO::phiNext</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00141">tagHARDERRORINFO::pmsg</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01599">ProcessHardErrorRequest()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00139">tagHARDERRORINFO::pthread</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00310">ReplyHardError()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00144">tagHARDERRORINFO::usCaption</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00099">UserRegisterEventSource()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00143">tagHARDERRORINFO::usText</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01669">HardErrorInsert()</a>, and <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01662">UserHardError()</a>.
<p>
<pre class="fragment"><div>01690 {
01691     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fClientPort, fNoWait, fMsgBox, fLogEvent;
01692     <a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, *pphiLast;
01693     HANDLE hEvent;
01694     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwReportMode, dwResponse;
01695 
01696     UserAssert((ULONG)pmsg-&gt;NumberOfParameters &lt;= MAXIMUM_HARDERROR_PARAMETERS);
01697     <span class="comment">/*</span>
01698 <span class="comment">     * Allocate memory to queue request.</span>
01699 <span class="comment">     */</span>
01700     phi = (<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">HARDERRORINFO</a>));
01701     <span class="keywordflow">if</span> (phi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01702         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01703     }
01704     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a> = pt;
01705 
01706     <span class="comment">/*</span>
01707 <span class="comment">     * Set up citrix specific stuff</span>
01708 <span class="comment">     */</span>
01709     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01710         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a> = pCtxHEInfo;
01711     }
01712 
01713     <span class="comment">/*</span>
01714 <span class="comment">     * Determine reply type</span>
01715 <span class="comment">     */</span>
01716     fClientPort = ((pt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pt-&gt;Process-&gt;ClientPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
01717     fNoWait = (pmsg-&gt;ValidResponseOptions == OptionOkNoWait);
01718 
01719     <span class="comment">/*</span>
01720 <span class="comment">     * Capture HARDERROR_MSG data or create wait event as needed</span>
01721 <span class="comment">     */</span>
01722     <span class="keywordflow">if</span> (fClientPort || fNoWait) {
01723         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a> = (PHARDERROR_MSG)LocalAlloc(LPTR, pmsg-&gt;h.u1.s1.TotalLength);
01724         <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01725             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01726         }
01727         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a23">HEIF_ALLOCATEDMSG</a>;
01728         RtlCopyMemory(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>, pmsg, pmsg-&gt;h.u1.s1.TotalLength);
01729         hEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01730         <span class="comment">/*</span>
01731 <span class="comment">         * Set the magic response value (-1) to let CsrApiRequestThread know</span>
01732 <span class="comment">         * that we'll take care of dereferencing and replying.</span>
01733 <span class="comment">         */</span>
01734         <span class="keywordflow">if</span> (pt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01735             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a25">HEIF_DEREFTHREAD</a>;
01736         }
01737         pmsg-&gt;Response = (ULONG)-1;
01738         <span class="keywordflow">if</span> (fNoWait) {
01739             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;ValidResponseOptions = OptionOk;
01740         }
01741     } <span class="keywordflow">else</span> {
01742         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a> = pmsg;
01743         <span class="comment">/*</span>
01744 <span class="comment">         * There is no reply port but we need to wait; create an event.</span>
01745 <span class="comment">         */</span>
01746         hEvent = CreateEvent(NULL, FALSE, FALSE, NULL);
01747         <span class="keywordflow">if</span> (hEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01748             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01749         }
01750         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o2">hEventHardError</a> = hEvent;
01751     }
01752 
01753     <span class="comment">/*</span>
01754 <span class="comment">     * Build hard error title, message and flags. Then log the event.</span>
01755 <span class="comment">     */</span>
01756     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a24">GetHardErrorText</a>(phi);
01757 
01758     <span class="comment">/*</span>
01759 <span class="comment">     * Reply now if we're not going to wait.</span>
01760 <span class="comment">     */</span>
01761     <span class="keywordflow">if</span> (fNoWait) {
01762         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a24">HEIF_REPLIED</a>;
01763         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Response = ResponseOk;
01764         <span class="keywordflow">if</span> (fClientPort) {
01765             <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(pt-&gt;Process-&gt;ClientPort, (PPORT_MESSAGE)phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>);
01766         } <span class="keywordflow">else</span> {
01767             <span class="comment">/*</span>
01768 <span class="comment">             * Must let CsrApiRequestThread reply since we don't have a port</span>
01769 <span class="comment">             */</span>
01770             pmsg-&gt;Response = ResponseOk;
01771             <span class="comment">/*</span>
01772 <span class="comment">             * If we have a thread, reference it because we're telling</span>
01773 <span class="comment">             *  CsrApiRequestThread that we're done with it.</span>
01774 <span class="comment">             */</span>
01775             <span class="keywordflow">if</span> (pt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01776                 <span class="comment">/*</span>
01777 <span class="comment">                 * Later5.0 GerardoB. Let's stop to see how this happens.</span>
01778 <span class="comment">                 */</span>
01779                 UserAssert(pt == NULL);
01780                 CsrReferenceThread(pt);
01781             }
01782         }
01783     }
01784 
01785     <span class="comment">/*</span>
01786 <span class="comment">     * Register the event if we haven't done so already.</span>
01787 <span class="comment">     * Since RegisterEventSource is supported by a service, we must not hold</span>
01788 <span class="comment">     *  any locks while making this call. Hence we might have several threads</span>
01789 <span class="comment">     *  registering the event simultaneously.</span>
01790 <span class="comment">     */</span>
01791     fLogEvent = (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01792     <span class="keywordflow">if</span> (!fLogEvent) {
01793         HANDLE hEventSource;
01794         hEventSource = <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a16">UserRegisterEventSource</a>(L<span class="stringliteral">"Application Popup"</span>);
01795         <span class="comment">/*</span>
01796 <span class="comment">         * Save the first handle, deregister all others.</span>
01797 <span class="comment">         */</span>
01798         <span class="keywordflow">if</span> (InterlockedCompareExchangePointer(&amp;gEventSource, hEventSource, NULL) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01799             <span class="comment">/*</span>
01800 <span class="comment">             * This is the first handle. If valid, we can log events.</span>
01801 <span class="comment">             */</span>
01802             fLogEvent = (hEventSource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01803         } <span class="keywordflow">else</span> {
01804             <span class="comment">/*</span>
01805 <span class="comment">             * We had already saved another handle (so we can log events). Deregister this one.</span>
01806 <span class="comment">             */</span>
01807             <span class="keywordflow">if</span> (hEventSource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01808                 UserVerify(<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a>(hEventSource));
01809             }
01810             fLogEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01811         }
01812     }
01813 
01814     dwReportMode = (fLogEvent ? <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a19">GetErrorMode</a>() : 0);
01815     <span class="keywordflow">if</span> (fLogEvent) {
01816         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a17">LogErrorPopup</a>(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer);
01817     }
01818 
01819     <span class="comment">/*</span>
01820 <span class="comment">     * Determine if we need to display a message box.</span>
01821 <span class="comment">     */</span>
01822     <span class="keywordflow">if</span> ((phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Status == STATUS_SERVICE_NOTIFICATION) || (dwReportMode == 0)) {
01823         fMsgBox = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01824     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Status == STATUS_VDM_HARD_ERROR) {
01825         fMsgBox = (dwReportMode == 1);
01826         <span class="keywordflow">if</span> (!fMsgBox) {
01827             dwResponse = ResponseOk;
01828         }
01829     } <span class="keywordflow">else</span> {
01830         fMsgBox = ((dwReportMode == 1) &amp;&amp; !(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a27">HEIF_SYSTEMERROR</a>));
01831         <span class="keywordflow">if</span> (!fMsgBox) {
01832             UserAssert((UINT)phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;ValidResponseOptions &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(dwResponseDefault));
01833             dwResponse = <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a5">dwResponseDefault</a>[phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;ValidResponseOptions];
01834         }
01835     }
01836     <span class="comment">/*</span>
01837 <span class="comment">     * If we don't have to display a message box, we're done.</span>
01838 <span class="comment">     */</span>
01839     <span class="keywordflow">if</span> (!fMsgBox) {
01840         <span class="keywordflow">goto</span> DontNeedErrorHandler;
01841     }
01842 
01843     <span class="comment">/*</span>
01844 <span class="comment">     * We want to display a message box. Queue the request and go for it.</span>
01845 <span class="comment">     */</span>
01846     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01847     <span class="comment">/*</span>
01848 <span class="comment">     * Never mind if the process has terminated. Got to check this holding the</span>
01849 <span class="comment">     * critical section to make sure that no other thread makes it to BoostHardError</span>
01850 <span class="comment">     * before we add this phi to the list.</span>
01851 <span class="comment">     */</span>
01852     <span class="keywordflow">if</span> ((pt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pt-&gt;Process-&gt;Flags &amp; CSR_PROCESS_TERMINATED)) {
01853         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01854 DontNeedErrorHandler:
01855         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a>(phi, dwResponse);
01856         <span class="keywordflow">if</span> (hEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01857             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hEvent);
01858         }
01859         <span class="keywordflow">return</span>;
01860     }
01861     <span class="comment">/*</span>
01862 <span class="comment">     * Add it to the end of the list.</span>
01863 <span class="comment">     */</span>
01864     pphiLast = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01865     <span class="keywordflow">while</span> (*pphiLast != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01866         pphiLast = &amp;(*pphiLast)-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01867     }
01868     *pphiLast = phi;
01869     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01870 
01871     <span class="comment">/*</span>
01872 <span class="comment">     * Process the hard error request. If this is a NoWait request and there</span>
01873 <span class="comment">     * is no reply port, then we'll try to launch a new worker thread so this</span>
01874 <span class="comment">     * one can return.</span>
01875 <span class="comment">     */</span>
01876     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a13">ProcessHardErrorRequest</a>(fNoWait &amp;&amp; !fClientPort);
01877 
01878     <span class="comment">/*</span>
01879 <span class="comment">     * If there is an event handle, wait for it.</span>
01880 <span class="comment">     */</span>
01881     <span class="keywordflow">if</span> (hEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01882         <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(hEvent, FALSE, NULL);
01883         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hEvent);
01884     }
01885     <span class="keywordflow">return</span>;
01886 
01887 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01888     <span class="keywordflow">if</span> (phi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01889         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a20">FreePhi</a>(phi);
01890     }
01891     pmsg-&gt;Response = ResponseNotHandled;
01892 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="w32/ntuser/server/harderr.c::UserRegisterEventSource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE UserRegisterEventSource           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCWSTR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwszSourceName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00099">99</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
References <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00086">gfnDeregisterEventSource</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00085">gfnRegisterEventSource</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00087">gfnReportEvent</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>.
<p>
<pre class="fragment"><div>00101 {
00102     <span class="comment">/*</span>
00103 <span class="comment">     * If we haven't already dynamically linked to advadpi32.dll, do it now.</span>
00104 <span class="comment">     */</span>
00105     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00106         HINSTANCE hAdvApiDll;
00107         FARPROC fnRegisterEventSource;
00108         FARPROC fnDeregisterEventSource;
00109         FARPROC fnReportEvent;
00110 
00111         <span class="comment">/*</span>
00112 <span class="comment">         * Try to load the DLL and function pointers.</span>
00113 <span class="comment">         */</span>
00114         <span class="keywordflow">if</span> ((hAdvApiDll = LoadLibrary(L<span class="stringliteral">"advapi32.dll"</span>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00115             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00116         }
00117         fnRegisterEventSource = GetProcAddress(hAdvApiDll, <span class="stringliteral">"RegisterEventSourceW"</span>);
00118         fnDeregisterEventSource = GetProcAddress(hAdvApiDll, <span class="stringliteral">"DeregisterEventSource"</span>);
00119         fnReportEvent = GetProcAddress(hAdvApiDll, <span class="stringliteral">"ReportEventW"</span>);
00120         <span class="keywordflow">if</span> (!fnRegisterEventSource || !fnDeregisterEventSource || !fnReportEvent) {
00121             FreeLibrary(hAdvApiDll);
00122             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00123         }
00124 
00125         <span class="comment">/*</span>
00126 <span class="comment">         * Update the global function pointers if they're not set already.</span>
00127 <span class="comment">         */</span>
00128         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00129         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00130             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a> = fnReportEvent;
00131             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a> = fnDeregisterEventSource;
00132             <span class="comment">// This must be last since we test it above</span>
00133             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> = fnRegisterEventSource;
00134             hAdvApiDll = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00135         }
00136         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00137 
00138         <span class="comment">/*</span>
00139 <span class="comment">         * If another thread beat us to it, free the library.</span>
00140 <span class="comment">         */</span>
00141         <span class="keywordflow">if</span> (hAdvApiDll) {
00142             FreeLibrary(hAdvApiDll);
00143         }
00144     }
00145 
00146     <span class="comment">/*</span>
00147 <span class="comment">     * Let's be paranoid and verify we loaded everything correctly.</span>
00148 <span class="comment">     */</span>
00149     UserAssert(gfnRegisterEventSource != NULL);
00150     UserAssert(gfnDeregisterEventSource != NULL);
00151     UserAssert(gfnReportEvent != NULL);
00152 
00153     <span class="comment">/*</span>
00154 <span class="comment">     * Call the real function.</span>
00155 <span class="comment">     */</span>
00156     <span class="keywordflow">return</span> (HANDLE)<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a>(NULL, pwszSourceName);
00157 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a5" doxytag="w32/ntuser/server/harderr.c::dwResponseDefault" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a5">dwResponseDefault</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    ResponseAbort,      
    ResponseOk,         
    ResponseOk,         
    ResponseCancel,     
    ResponseYes,        
    ResponseYes,        
    ResponseOk,         
    ResponseOk,         
    ResponseCancel      
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00062">62</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="w32/ntuser/server/harderr.c::dwResponses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a4">dwResponses</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    ResponseNotHandled, 
    ResponseOk,         
    ResponseCancel,     
    ResponseAbort,      
    ResponseRetry,      
    ResponseIgnore,     
    ResponseYes,        
    ResponseNo,         
    ResponseNotHandled, 
    ResponseNotHandled, 
    ResponseTryAgain,   
    ResponseContinue    
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00048">48</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01129">HardErrorHandler()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="w32/ntuser/server/harderr.c::gbExitInProgress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d4/icamsg_8c.html#a0">gbExitInProgress</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00017">17</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="w32/ntuser/server/harderr.c::gfnDeregisterEventSource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> FARPROC <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00086">86</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>, and <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00099">UserRegisterEventSource()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="w32/ntuser/server/harderr.c::gfnRegisterEventSource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> FARPROC <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00085">85</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00099">UserRegisterEventSource()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="w32/ntuser/server/harderr.c::gfnReportEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> FARPROC <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00087">87</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00166">LogErrorPopup()</a>, and <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00099">UserRegisterEventSource()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="w32/ntuser/server/harderr.c::gfTimedOut" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00018">18</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01129">HardErrorHandler()</a>, and <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00383">MsgBoxTimerFunc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="w32/ntuser/server/harderr.c::gTimerId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT_PTR <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a> = 0<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00077">77</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01129">HardErrorHandler()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="w32/ntuser/server/harderr.c::wIcons" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST UINT <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a2">wIcons</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    0,
    MB_ICONINFORMATION,
    MB_ICONEXCLAMATION,
    MB_ICONSTOP
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00031">31</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00423">GetHardErrorText()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="w32/ntuser/server/harderr.c::wOptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST UINT <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a3">wOptions</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    MB_ABORTRETRYIGNORE,
    MB_OK,
    MB_OKCANCEL,
    MB_RETRYCANCEL,
    MB_YESNO,
    MB_YESNOCANCEL,
    MB_OK,              
    MB_OK,              
    MB_CANCELTRYCONTINUE
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00037">37</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00423">GetHardErrorText()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="w32/ntuser/server/harderr.c::wszDosDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR <a class="el" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a10">wszDosDevices</a>[] = L"\\??\\A:"<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00189">189</a> of file <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html">w32/ntuser/server/harderr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00191">SubstituteDeviceName()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
