<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wow.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wow.c</h1><a href="../../d6/d9/rtl_2wow_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: wow.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains shared code between USER32 and USER16</span>
00007 <span class="comment">* No New CODE should be added to this file, unless its shared</span>
00008 <span class="comment">* with USER16.</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">* 29-DEC-93 NanduriR      shared user32/user16 code.</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d7/d9/wow_8h.html">wow.h</a>"</span>
00015 
00016 
00017 <span class="preprocessor">#ifdef _USERK_</span>
00018 <span class="preprocessor"></span><span class="preprocessor">    #define CHECK_RESTRICTED()                                                      \</span>
00019 <span class="preprocessor">        if (((PTHREADINFO)W32GetCurrentThread())-&gt;TIF_flags &amp; TIF_RESTRICTED) {     \</span>
00020 <span class="preprocessor">            if (!ValidateHandleSecure(h))                                           \</span>
00021 <span class="preprocessor">                pobj = NULL;                                                        \</span>
00022 <span class="preprocessor">        }                                                                           \</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00025"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a0">00025</a> <span class="preprocessor"></span><span class="preprocessor">    #define CHECK_RESTRICTED()                                              \</span>
00026 <span class="preprocessor">        if (pci &amp;&amp; (pci-&gt;dwTIFlags &amp; TIF_RESTRICTED) &amp;&amp; pobj) {             \</span>
00027 <span class="preprocessor">            if (!NtUserValidateHandleSecure(h))                             \</span>
00028 <span class="preprocessor">                pobj = NULL;                                                \</span>
00029 <span class="preprocessor">        }                                                                   \</span>
00030 <span class="preprocessor"></span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
00033 
00034 
00035 <span class="preprocessor">#ifdef _USERK_</span>
00036 <span class="preprocessor"></span><span class="preprocessor">    #define GET_CURRENT_CLIENTINFO()                            \</span>
00037 <span class="preprocessor">        {                                                       \</span>
00038 <span class="preprocessor">            PW32THREAD pW32Thread;                              \</span>
00039 <span class="preprocessor">                                                                \</span>
00040 <span class="preprocessor">            pW32Thread = W32GetCurrentThread();                 \</span>
00041 <span class="preprocessor">                                                                \</span>
00042 <span class="preprocessor">            if (pW32Thread) {                                   \</span>
00043 <span class="preprocessor">                pci = ((PTHREADINFO)pW32Thread)-&gt;pClientInfo;   \</span>
00044 <span class="preprocessor">            } else {                                            \</span>
00045 <span class="preprocessor">                pci = NULL;                                     \</span>
00046 <span class="preprocessor">            }                                                   \</span>
00047 <span class="preprocessor">        }</span>
00048 <span class="preprocessor"></span>
00049 <span class="preprocessor">#else</span>
<a name="l00050"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a1">00050</a> <span class="preprocessor"></span><span class="preprocessor">    #define GET_CURRENT_CLIENTINFO()                            \</span>
00051 <span class="preprocessor">        pci = GetClientInfo();</span>
00052 <span class="preprocessor"></span>
00053 <span class="preprocessor">#endif // _USERK_</span>
00054 <span class="preprocessor"></span>
00055 
00056 <span class="comment">/*</span>
00057 <span class="comment"> * We have two types of desktop validation:</span>
00058 <span class="comment"> *</span>
00059 <span class="comment"> */</span>
00060 
00061 <span class="preprocessor">#ifdef _USERK_</span>
00062 <span class="preprocessor"></span>
00063 <span class="preprocessor">#define DESKTOPVALIDATE(pci, pobj) \</span>
00064 <span class="preprocessor">            UNREFERENCED_PARAMETER(pci);</span>
00065 <span class="preprocessor"></span>
00066 <span class="preprocessor">#define DESKTOPVALIDATECCX(pci, pobj)                               \</span>
00067 <span class="preprocessor">        if (    ((PVOID)pobj &gt;= pci-&gt;pDeskInfo-&gt;pvDesktopBase) &amp;&amp;  \</span>
00068 <span class="preprocessor">                ((PVOID)pobj &lt; pci-&gt;pDeskInfo-&gt;pvDesktopLimit)) {  \</span>
00069 <span class="preprocessor">            pobj = (PBYTE)pobj - pci-&gt;ulClientDelta;               \</span>
00070 <span class="preprocessor">        }                                                           \</span>
00071 <span class="preprocessor"></span>
00072 <span class="preprocessor"></span><span class="preprocessor">#define SHAREDVALIDATE(pobj)</span>
00073 <span class="preprocessor"></span>
00074 <span class="preprocessor">#else</span>
00075 <span class="preprocessor"></span>
<a name="l00076"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a2">00076</a> <span class="preprocessor">#define DESKTOPVALIDATE(pci, pobj)                              \</span>
00077 <span class="preprocessor">        if (    pci-&gt;pDeskInfo &amp;&amp;                               \</span>
00078 <span class="preprocessor">                pobj &gt;= pci-&gt;pDeskInfo-&gt;pvDesktopBase &amp;&amp;        \</span>
00079 <span class="preprocessor">                pobj &lt; pci-&gt;pDeskInfo-&gt;pvDesktopLimit) {        \</span>
00080 <span class="preprocessor">            pobj = (KERNEL_PVOID)((KERNEL_ULONG_PTR)pobj - pci-&gt;ulClientDelta);         \</span>
00081 <span class="preprocessor">        } else {                                                \</span>
00082 <span class="preprocessor">            pobj = (KERNEL_PVOID)NtUserCallOneParam((ULONG_PTR)h,                       \</span>
00083 <span class="preprocessor">                    SFI__MAPDESKTOPOBJECT);                     \</span>
00084 <span class="preprocessor">        }                                                       \</span>
00085 <span class="preprocessor"></span>
<a name="l00086"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a3">00086</a> <span class="preprocessor"></span><span class="preprocessor">#define SHAREDVALIDATE(pobj)                                    \</span>
00087 <span class="preprocessor">        pobj = REBASESHAREDPTRALWAYS(pobj);</span>
00088 <span class="preprocessor"></span>
00089 <span class="preprocessor">#endif // _USERK_</span>
00090 <span class="preprocessor"></span>
00091 
00092 <span class="comment">/*</span>
00093 <span class="comment"> * Keep the general path through validation straight without jumps - that</span>
00094 <span class="comment"> * means tunneling if()'s for this routine - this'll make validation fastest</span>
00095 <span class="comment"> * because of instruction caching.</span>
00096 <span class="comment"> *</span>
00097 <span class="comment"> * In order to have the validation code in one place only, we define</span>
00098 <span class="comment"> *  the *ValidateHandleMacro macros which are to be included by the</span>
00099 <span class="comment"> *  HMValidateHanlde* routines. We don't make these into functions</span>
00100 <span class="comment"> *  because we're optimizing on time, not size.</span>
00101 <span class="comment"> */</span>
<a name="l00102"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a4">00102</a> <span class="preprocessor">#define ValidateHandleMacro(pci, pobj, h, bType) \</span>
00103 <span class="preprocessor">    StartValidateHandleMacro(h) \</span>
00104 <span class="preprocessor">    BeginAliveValidateHandleMacro()  \</span>
00105 <span class="preprocessor">    BeginTypeValidateHandleMacro(pobj, bType) \</span>
00106 <span class="preprocessor">    DESKTOPVALIDATE(pci, pobj) \</span>
00107 <span class="preprocessor">    EndTypeValidateHandleMacro \</span>
00108 <span class="preprocessor">    EndAliveValidateHandleMacro()  \</span>
00109 <span class="preprocessor">    EndValidateHandleMacro</span>
00110 <span class="preprocessor"></span>
00111 <span class="preprocessor">#ifdef _USERK_</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#define ValidateCatHandleMacro(pci, pobj, h, bType) \</span>
00113 <span class="preprocessor">    StartValidateHandleMacro(h) \</span>
00114 <span class="preprocessor">    BeginTypeValidateHandleMacro(pobj, bType) \</span>
00115 <span class="preprocessor">    DESKTOPVALIDATE(pci, pobj) \</span>
00116 <span class="preprocessor">    EndTypeValidateHandleMacro \</span>
00117 <span class="preprocessor">    EndValidateHandleMacro</span>
00118 <span class="preprocessor"></span><span class="preprocessor">#define ValidateCatHandleMacroCcx(pci, pobj, h, bType) \</span>
00119 <span class="preprocessor">    StartValidateHandleMacro(h) \</span>
00120 <span class="preprocessor">    BeginTypeValidateHandleMacro(pobj, bType) \</span>
00121 <span class="preprocessor">    DESKTOPVALIDATECCX(pci, pobj) \</span>
00122 <span class="preprocessor">    EndTypeValidateHandleMacro \</span>
00123 <span class="preprocessor">    EndValidateHandleMacro</span>
00124 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00125 <span class="preprocessor"></span>
<a name="l00126"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a5">00126</a> <span class="preprocessor">#define ValidateSharedHandleMacro(pobj, h, bType) \</span>
00127 <span class="preprocessor">    StartValidateHandleMacro(h)  \</span>
00128 <span class="preprocessor">    BeginAliveValidateHandleMacro()  \</span>
00129 <span class="preprocessor">    BeginTypeValidateHandleMacro(pobj, bType) \</span>
00130 <span class="preprocessor">    SHAREDVALIDATE(pobj)        \</span>
00131 <span class="preprocessor">    EndTypeValidateHandleMacro \</span>
00132 <span class="preprocessor">    EndAliveValidateHandleMacro()  \</span>
00133 <span class="preprocessor">    EndValidateHandleMacro</span>
00134 <span class="preprocessor"></span>
00135 
00136 <span class="comment">/*</span>
00137 <span class="comment"> * The handle validation routines should be optimized for time, not size,</span>
00138 <span class="comment"> * since they get called so often.</span>
00139 <span class="comment"> */</span>
00140 <span class="preprocessor">#pragma optimize("t", on)</span>
00141 <span class="preprocessor"></span>
00142 <span class="comment">/***************************************************************************\</span>
00143 <span class="comment">* HMValidateHandle</span>
00144 <span class="comment">*</span>
00145 <span class="comment">* This routine validates a handle manager handle.</span>
00146 <span class="comment">*</span>
00147 <span class="comment">* 01-22-92 ScottLu      Created.</span>
00148 <span class="comment">\***************************************************************************/</span>
00149 
<a name="l00150"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">00150</a> PVOID <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>(
00151     HANDLE h,
00152     BYTE bType)
00153 {
00154     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwError;
00155     KERNEL_PVOID pobj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00156     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00157 
00158     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a1">GET_CURRENT_CLIENTINFO</a>();
00159 
00160 <span class="preprocessor">#if DBG != 0 &amp;&amp; !defined(_USERK_)</span>
00161 <span class="preprocessor"></span>    <span class="comment">/*</span>
00162 <span class="comment">     * We don't want 32 bit apps passing 16 bit handles</span>
00163 <span class="comment">     *  we should consider failing this before we get</span>
00164 <span class="comment">     *  stuck supporting it (Some VB apps do this).</span>
00165 <span class="comment">     */</span>
00166     <span class="keywordflow">if</span> (pci &amp;&amp; (h != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00167            &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a435">HMUniqFromHandle</a>(h) == 0)
00168            &amp;&amp; !(pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00169         RIPMSG3(RIP_WARNING, <span class="stringliteral">"HMValidateHandle: 32bit process [%d] using 16 bit handle [%#p] bType:%#lx"</span>,
00170                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess), h, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)bType);
00171     }
00172 <span class="preprocessor">#endif</span>
00173 <span class="preprocessor"></span>
00174     <span class="comment">/*</span>
00175 <span class="comment">     * Object can't be located in shared memory.</span>
00176 <span class="comment">     */</span>
00177     UserAssert(bType != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a248">TYPE_MONITOR</a>);
00178 
00179     <span class="comment">/*</span>
00180 <span class="comment">     * Validation macro. Falls through if the handle is invalid.</span>
00181 <span class="comment">     */</span>
00182     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a4">ValidateHandleMacro</a>(pci, pobj, h, bType);
00183 
00184     <span class="comment">/*</span>
00185 <span class="comment">     * check for secure process</span>
00186 <span class="comment">     */</span>
00187     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a0">CHECK_RESTRICTED</a>();
00188 
00189     <span class="keywordflow">if</span> (pobj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00190         <span class="keywordflow">return</span> pobj;
00191     }
00192 
00193     <span class="keywordflow">switch</span> (bType) {
00194 
00195     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a>:
00196         dwError = ERROR_INVALID_WINDOW_HANDLE;
00197         <span class="keywordflow">break</span>;
00198 
00199     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a238">TYPE_MENU</a>:
00200         dwError = ERROR_INVALID_MENU_HANDLE;
00201         <span class="keywordflow">break</span>;
00202 
00203     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>:
00204         dwError = ERROR_INVALID_CURSOR_HANDLE;
00205         <span class="keywordflow">break</span>;
00206 
00207     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a244">TYPE_ACCELTABLE</a>:
00208         dwError = ERROR_INVALID_ACCEL_HANDLE;
00209         <span class="keywordflow">break</span>;
00210 
00211     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a241">TYPE_HOOK</a>:
00212         dwError = ERROR_INVALID_HOOK_HANDLE;
00213         <span class="keywordflow">break</span>;
00214 
00215     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a240">TYPE_SETWINDOWPOS</a>:
00216         dwError = ERROR_INVALID_DWP_HANDLE;
00217         <span class="keywordflow">break</span>;
00218 
00219     <span class="keywordflow">default</span>:
00220         dwError = ERROR_INVALID_HANDLE;
00221         <span class="keywordflow">break</span>;
00222     }
00223 
00224     RIPERR2(dwError,
00225             RIP_WARNING,
00226             <span class="stringliteral">"HMValidateHandle: Invalid:%#p Type:%#lx"</span>,
00227             h, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)bType);
00228 
00229     <span class="comment">/*</span>
00230 <span class="comment">     * If we get here, it's an error.</span>
00231 <span class="comment">     */</span>
00232     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00233 }
00234 
00235 <span class="comment">/***************************************************************************\</span>
00236 <span class="comment">* HMValidateHandleNoSecure</span>
00237 <span class="comment">*</span>
00238 <span class="comment">* This routine validates a handle manager handle.</span>
00239 <span class="comment">*</span>
00240 <span class="comment">* 01-22-92 ScottLu      Created.</span>
00241 <span class="comment">\***************************************************************************/</span>
<a name="l00242"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a7">00242</a> PVOID <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a7">HMValidateHandleNoSecure</a>(
00243     HANDLE h,
00244     BYTE bType)
00245 {
00246     KERNEL_PVOID pobj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00247     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00248 
00249     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a1">GET_CURRENT_CLIENTINFO</a>();
00250 
00251 <span class="preprocessor">#if !defined(_USERK_)</span>
00252 <span class="preprocessor"></span>    <span class="comment">/*</span>
00253 <span class="comment">     * We don't want 32 bit apps passing 16 bit handles</span>
00254 <span class="comment">     *  we should consider failing this before we get</span>
00255 <span class="comment">     *  stuck supporting it (Some VB apps do this).</span>
00256 <span class="comment">     */</span>
00257     <span class="keywordflow">if</span> (pci &amp;&amp; (h != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00258            &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a435">HMUniqFromHandle</a>(h) == 0)
00259            &amp;&amp; !(pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00260         RIPMSG3(RIP_WARNING, <span class="stringliteral">"HMValidateHandle: 32bit process [%d] using 16 bit handle [%#p] bType:%#lx"</span>,
00261                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess), h, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)bType);
00262     }
00263 <span class="preprocessor">#endif</span>
00264 <span class="preprocessor"></span>
00265     <span class="comment">/*</span>
00266 <span class="comment">     * Object can't be located in shared memory.</span>
00267 <span class="comment">     */</span>
00268     UserAssert(bType != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a248">TYPE_MONITOR</a>);
00269 
00270     <span class="comment">/*</span>
00271 <span class="comment">     * Validation macro.</span>
00272 <span class="comment">     */</span>
00273     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a4">ValidateHandleMacro</a>(pci, pobj, h, bType);
00274 
00275     <span class="keywordflow">return</span> pobj;
00276 }
00277 
00278 <span class="preprocessor">#if defined(_USERK_)</span>
00279 <span class="preprocessor"></span>PVOID <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> <a class="code" href="../../d1/d0/inc_2user_8h.html#a1181">HMValidateCatHandleNoSecure</a>(
00280     HANDLE h,
00281     BYTE bType)
00282 {
00283     PVOID       pobj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00284     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00285 
00286     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a1">GET_CURRENT_CLIENTINFO</a>();
00287 
00288     <span class="comment">/*</span>
00289 <span class="comment">     * Object can't be located in shared memory.</span>
00290 <span class="comment">     */</span>
00291     UserAssert(bType != TYPE_MONITOR);
00292 
00293     <span class="comment">/*</span>
00294 <span class="comment">     * Validation macro.</span>
00295 <span class="comment">     */</span>
00296     ValidateCatHandleMacro(pci, pobj, h, bType);
00297 
00298     <span class="keywordflow">return</span> pobj;
00299 }
00300 PVOID <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> <a class="code" href="../../d1/d0/inc_2user_8h.html#a1182">HMValidateCatHandleNoSecureCCX</a>(
00301     HANDLE h,
00302     BYTE bType,
00303     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> ccxPci)
00304 {
00305     PVOID       pobj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00306 
00307     <span class="comment">/*</span>
00308 <span class="comment">     * Object can't be located in shared memory.</span>
00309 <span class="comment">     */</span>
00310     UserAssert(bType != TYPE_MONITOR);
00311 
00312     <span class="comment">/*</span>
00313 <span class="comment">     * Validation macro.</span>
00314 <span class="comment">     */</span>
00315     ValidateCatHandleMacroCcx(ccxPci, pobj, h, bType);
00316 
00317     <span class="keywordflow">return</span> pobj;
00318 }
00319 
00320 PVOID <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> <a class="code" href="../../d1/d0/inc_2user_8h.html#a1177">HMValidateCatHandleNoRip</a>(
00321     HANDLE h,
00322     BYTE bType)
00323 {
00324     PVOID       pobj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00325     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00326 
00327     <span class="comment">/*</span>
00328 <span class="comment">     * This is the fastest way way to do validation, because</span>
00329 <span class="comment">     *  unlike HMValidateHandle, this function doesn't set the</span>
00330 <span class="comment">     *  last error.</span>
00331 <span class="comment">     *</span>
00332 <span class="comment">     * Validation macro. Falls through if the handle is invalid.</span>
00333 <span class="comment">     */</span>
00334 
00335     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a1">GET_CURRENT_CLIENTINFO</a>();
00336 
00337     <span class="comment">/*</span>
00338 <span class="comment">     * Object can't be located in shared memory.</span>
00339 <span class="comment">     */</span>
00340     UserAssert(bType != TYPE_MONITOR);
00341 
00342     ValidateCatHandleMacro(pci, pobj, h, bType);
00343 
00344     <span class="comment">/*</span>
00345 <span class="comment">     * check for secure process</span>
00346 <span class="comment">     */</span>
00347     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a0">CHECK_RESTRICTED</a>();
00348 
00349     <span class="keywordflow">return</span> pobj;
00350 }
00351 <span class="preprocessor">#endif</span>
00352 <span class="preprocessor"></span>
<a name="l00353"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">00353</a> PVOID <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(
00354     HANDLE h,
00355     BYTE bType)
00356 {
00357     KERNEL_PVOID pobj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00358     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00359 
00360     <span class="comment">/*</span>
00361 <span class="comment">     * This is the fastest way way to do validation, because</span>
00362 <span class="comment">     *  unlike HMValidateHandle, this function doesn't set the</span>
00363 <span class="comment">     *  last error.</span>
00364 <span class="comment">     *</span>
00365 <span class="comment">     * Validation macro. Falls through if the handle is invalid.</span>
00366 <span class="comment">     */</span>
00367 
00368     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a1">GET_CURRENT_CLIENTINFO</a>();
00369 
00370     <span class="comment">/*</span>
00371 <span class="comment">     * Object can't be located in shared memory.</span>
00372 <span class="comment">     */</span>
00373     UserAssert(bType != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a248">TYPE_MONITOR</a>);
00374 
00375     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a4">ValidateHandleMacro</a>(pci, pobj, h, bType);
00376 
00377     <span class="comment">/*</span>
00378 <span class="comment">     * check for secure process</span>
00379 <span class="comment">     */</span>
00380     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a0">CHECK_RESTRICTED</a>();
00381 
00382     <span class="keywordflow">return</span> pobj;
00383 }
00384 
00385 <span class="preprocessor">#if DBG != 0 &amp;&amp; !defined(_USERK_)</span>
00386 <span class="preprocessor"></span><span class="comment">/*</span>
00387 <span class="comment"> * HMValidateHandleNoDesktop is a debug-client-side only function</span>
00388 <span class="comment"> *  used to verify a given handle without calling DESKTOPVALIDATE.</span>
00389 <span class="comment"> * If the handle is valid, it returns the object's kernel pointer</span>
00390 <span class="comment"> *  which can be used as a BOOL value only.</span>
00391 <span class="comment"> * Use this function to verify handles for which corresponding phe-&gt;phead</span>
00392 <span class="comment"> *  is a pool allocation (as opposed to desktop-heap allocations).</span>
00393 <span class="comment"> */</span>
00394 KERNEL_PVOID <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> <a class="code" href="../../d1/d0/inc_2user_8h.html#a1179">HMValidateHandleNoDesktop</a>(
00395     HANDLE h,
00396     BYTE bType)
00397 {
00398     KERNEL_PVOID pobj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00399 
00400     <a class="code" href="../../d7/d9/wow_8h.html#a0">StartValidateHandleMacro</a>(h)
00401     BeginTypeValidateHandleMacro(pobj, bType)
00402     EndTypeValidateHandleMacro
00403     EndValidateHandleMacro
00404     return pobj;
00405 }
00406 #endif
00407 
00408 
00409 <span class="comment">/***************************************************************************\</span>
00410 <span class="comment">* HMValidateSharedHandle</span>
00411 <span class="comment">*</span>
00412 <span class="comment">* This routine validates a handle manager handle allocated in</span>
00413 <span class="comment">* shared memory.</span>
00414 <span class="comment">*</span>
00415 <span class="comment">* History:</span>
00416 <span class="comment">* 02-Apr-1997 adams     Created.</span>
00417 <span class="comment">\***************************************************************************/</span>
00418 
<a name="l00419"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a9">00419</a> PVOID FASTCALL HMValidateSharedHandle(
00420     HANDLE h,
00421     BYTE bType)
00422 {
00423     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwError;
00424     KERNEL_PVOID pobj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00425 
00426 <span class="preprocessor">#if DBG != 0 &amp;&amp; !defined(_USERK_)</span>
00427 <span class="preprocessor"></span>
00428     <span class="comment">/*</span>
00429 <span class="comment">     * We don't want 32 bit apps passing 16 bit handles</span>
00430 <span class="comment">     *  we should consider failing this before we get</span>
00431 <span class="comment">     *  stuck supporting it (Some VB apps do this).</span>
00432 <span class="comment">     */</span>
00433     <span class="keywordflow">if</span> ((h != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00434            &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a435">HMUniqFromHandle</a>(h) == 0)
00435            &amp;&amp; !(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwTIFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00436         RIPMSG3(RIP_WARNING, <span class="stringliteral">"HMValidateHandle: 32bit process [%d] using 16 bit handle [%#p] bType:%#lx"</span>,
00437                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess), h, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)bType);
00438     }
00439 <span class="preprocessor">#endif</span>
00440 <span class="preprocessor"></span>
00441     <span class="comment">/*</span>
00442 <span class="comment">     * Validation macro. Falls through if the handle is invalid.</span>
00443 <span class="comment">     */</span>
00444     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a5">ValidateSharedHandleMacro</a>(pobj, h, bType);
00445 
00446     <span class="keywordflow">if</span> (pobj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00447         <span class="keywordflow">return</span> pobj;
00448 
00449     <span class="keywordflow">switch</span> (bType) {
00450         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a248">TYPE_MONITOR</a>:
00451             dwError = ERROR_INVALID_MONITOR_HANDLE;
00452             <span class="keywordflow">break</span>;
00453 
00454         <span class="keywordflow">default</span>:
00455             UserAssertMsg0(0, <span class="stringliteral">"Logic error in HMValidateSharedHandle"</span>);
00456             <span class="keywordflow">break</span>;
00457     }
00458 
00459     RIPERR2(dwError,
00460             RIP_WARNING,
00461             <span class="stringliteral">"HMValidateSharedHandle: Invalid:%#p Type:%#lx"</span>,
00462             h, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)bType);
00463 
00464     <span class="comment">/*</span>
00465 <span class="comment">     * If we get here, it's an error.</span>
00466 <span class="comment">     */</span>
00467     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00468 }
00469 
00470 
00471 <span class="comment">/*</span>
00472 <span class="comment"> * Switch back to default optimization.</span>
00473 <span class="comment"> */</span>
00474 <span class="preprocessor">#pragma optimize("", on)</span>
00475 <span class="preprocessor"></span>
00476 <span class="comment">/***************************************************************************\</span>
00477 <span class="comment">* MNLookUpItem</span>
00478 <span class="comment">*</span>
00479 <span class="comment">* Return a pointer to the menu item specified by wCmd and wFlags</span>
00480 <span class="comment">*</span>
00481 <span class="comment">* History:</span>
00482 <span class="comment">*   10-11-90 JimA       Translated from ASM</span>
00483 <span class="comment">*   01-07-93 FritzS     Ported from Chicago</span>
00484 <span class="comment">\***************************************************************************/</span>
00485 
<a name="l00486"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">00486</a> <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(
00487     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00488     UINT wCmd,
00489     BOOL fByPosition,
00490     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> *ppMenuItemIsOn)
00491 {
00492     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00493     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItemRet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00494     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItemMaybe;
00495     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>   pMenuMaybe = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00496     <span class="keywordtype">int</span> i;
00497 
00498     <span class="keywordflow">if</span> (ppMenuItemIsOn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00499         *ppMenuItemIsOn = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00500 
00501     <span class="keywordflow">if</span> (pMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> || wCmd == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
00502 <span class="comment">//      RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, "MNLookUpItem: invalid item");</span>
00503         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00504     }
00505 
00506     <span class="comment">/*</span>
00507 <span class="comment">     * dwFlags determines how we do the search</span>
00508 <span class="comment">     */</span>
00509     <span class="keywordflow">if</span> (fByPosition) {
00510         <span class="keywordflow">if</span> (wCmd &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) {
00511             pItemRet = &amp;((<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pMenu, rgItems))[wCmd];
00512             <span class="keywordflow">if</span> (ppMenuItemIsOn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00513                 *ppMenuItemIsOn = pMenu;
00514             <span class="keywordflow">return</span> (pItemRet);
00515         } <span class="keywordflow">else</span>
00516             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00517     }
00518     <span class="comment">/*</span>
00519 <span class="comment">     * Walk down the menu and try to find an item with an ID of wCmd.</span>
00520 <span class="comment">     * The search procedes from the end of the menu (as was done in</span>
00521 <span class="comment">     * assembler).</span>
00522 <span class="comment">     */</span>
00523 
00524 <span class="comment">/* this is the Chicago code, which walks from the front of the menu -- Fritz */</span>
00525 
00526 
00527 <span class="comment">//        for (pItem = &amp;pMenu-&gt;rgItems[i - 1]; pItemRet == NULL &amp;&amp; i--; --pItem) {</span>
00528     <span class="keywordflow">for</span> (i = 0, pItem = <a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pMenu, rgItems); i &lt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>;
00529             i++, pItem++) {
00530 
00531         <span class="comment">/*</span>
00532 <span class="comment">         * If the item is a popup, recurse down the tree</span>
00533 <span class="comment">         */</span>
00534         <span class="keywordflow">if</span> (pItem-&gt;spSubMenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00535         <span class="comment">//</span>
00536         <span class="comment">// COMPAT:</span>
00537         <span class="comment">// Allow apps to pass in menu handle as ID in menu APIs.  We</span>
00538         <span class="comment">// remember that this popup had a menu handle with the same ID</span>
00539         <span class="comment">// value.  This is a 2nd choice though.  We still want to see</span>
00540         <span class="comment">// if there's some actual command that has this ID value first.</span>
00541         <span class="comment">//</span>
00542             <span class="keywordflow">if</span> (pItem-&gt;wID == wCmd) {
00543                 pMenuMaybe = pMenu;
00544                 pItemMaybe = pItem;
00545             }
00546 
00547             pItemRet = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>((<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pMenu, pItem-&gt;spSubMenu),
00548                     wCmd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, ppMenuItemIsOn);
00549             <span class="keywordflow">if</span> (pItemRet != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00550                 <span class="keywordflow">return</span> pItemRet;
00551         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pItem-&gt;wID == wCmd) {
00552 
00553                 <span class="comment">/*</span>
00554 <span class="comment">                 * Found the item, now save things for later</span>
00555 <span class="comment">                 */</span>
00556                 <span class="keywordflow">if</span> (ppMenuItemIsOn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00557                     *ppMenuItemIsOn = pMenu;
00558                 <span class="keywordflow">return</span> pItem;
00559         }
00560     }
00561 
00562     <span class="keywordflow">if</span> (pMenuMaybe) {
00563         <span class="comment">// no non popup menu match found -- use the 2nd choice popup menu</span>
00564         <span class="comment">// match</span>
00565         <span class="keywordflow">if</span> (ppMenuItemIsOn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00566             *ppMenuItemIsOn = pMenuMaybe;
00567         <span class="keywordflow">return</span>(pItemMaybe);
00568     }
00569 
00570     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00571 }
00572 
00573 <span class="comment">/***************************************************************************\</span>
00574 <span class="comment">* GetMenuState</span>
00575 <span class="comment">*</span>
00576 <span class="comment">* Either returns the state of a menu item or the state and item count</span>
00577 <span class="comment">* of a popup.</span>
00578 <span class="comment">*</span>
00579 <span class="comment">* History:</span>
00580 <span class="comment">* 10-11-90 JimA       Translated from ASM</span>
00581 <span class="comment">\***************************************************************************/</span>
00582 
<a name="l00583"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a11">00583</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a11">_GetMenuState</a>(
00584     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00585     UINT wId,
00586     UINT dwFlags)
00587 {
00588     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00589     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fFlags;
00590 
00591     <span class="comment">/*</span>
00592 <span class="comment">     * If the item does not exist, leave</span>
00593 <span class="comment">     */</span>
00594     <span class="keywordflow">if</span> ((pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, wId, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; MF_BYPOSITION), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00595         <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
00596 
00597     fFlags = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o1">fState</a> | pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o0">fType</a>;
00598 
00599 <span class="preprocessor">#ifndef _USERK_</span>
00600 <span class="preprocessor"></span>    <span class="comment">/*</span>
00601 <span class="comment">     * Add old MFT_BITMAP flag to keep old apps happy</span>
00602 <span class="comment">     */</span>
00603     <span class="keywordflow">if</span> ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00604         fFlags |= MFT_BITMAP;
00605     }
00606 <span class="preprocessor">#endif</span>
00607 <span class="preprocessor"></span>
00608     <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00609         <span class="comment">/*</span>
00610 <span class="comment">         * If the item is a popup, return item count in high byte and</span>
00611 <span class="comment">         * popup flags in low byte</span>
00612 <span class="comment">         */</span>
00613 
00614         fFlags = ((fFlags | MF_POPUP) &amp; 0x00FF) +
00615             (((<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pMenu, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>))-&gt;cItems &lt;&lt; 8);
00616     }
00617 
00618     <span class="keywordflow">return</span> fFlags;
00619 }
00620 
00621 
00622 <span class="comment">/***************************************************************************\</span>
00623 <span class="comment">* GetPrevPwnd</span>
00624 <span class="comment">*</span>
00625 <span class="comment">*</span>
00626 <span class="comment">*</span>
00627 <span class="comment">* History:</span>
00628 <span class="comment">* 11-05-90 darrinm      Ported from Win 3.0 sources.</span>
00629 <span class="comment">\***************************************************************************/</span>
00630 
<a name="l00631"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a12">00631</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a12">GetPrevPwnd</a>(
00632     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndList,
00633     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFind)
00634 {
00635     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFound, pwndNext;
00636 
00637     <span class="keywordflow">if</span> (pwndList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00638         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00639 
00640     <span class="keywordflow">if</span> (pwndList-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00641         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00642 
00643     pwndNext = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwndList, spwndParent);
00644     pwndNext = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwndNext, spwndChild);
00645     pwndFound = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00646 
00647     <span class="keywordflow">while</span> (pwndNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00648         <span class="keywordflow">if</span> (pwndNext == pwndFind)
00649             <span class="keywordflow">break</span>;
00650         pwndFound = pwndNext;
00651         pwndNext = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwndNext, spwndNext);
00652     }
00653 
00654     <span class="keywordflow">return</span> (pwndNext == pwndFind) ? pwndFound : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00655 }
00656 
00657 
00658 <span class="comment">/***************************************************************************\</span>
00659 <span class="comment">* _GetWindow (API)</span>
00660 <span class="comment">*</span>
00661 <span class="comment">*</span>
00662 <span class="comment">* History:</span>
00663 <span class="comment">* 11-05-90 darrinm      Ported from Win 3.0 sources.</span>
00664 <span class="comment">* 02-19-91 JimA         Added enum access check</span>
00665 <span class="comment">* 05-04-02 DarrinM      Removed enum access check and moved to USERRTL.DLL</span>
00666 <span class="comment">\***************************************************************************/</span>
00667 
<a name="l00668"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a13">00668</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a13">_GetWindow</a>(
00669     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00670     UINT cmd)
00671 {
00672     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00673     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRebase = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00674 
00675     <span class="comment">/*</span>
00676 <span class="comment">     * If this is a desktop window, return NULL for sibling or</span>
00677 <span class="comment">     * parent information.</span>
00678 <span class="comment">     */</span>
00679     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) {
00680         <span class="keywordflow">switch</span> (cmd) {
00681         <span class="keywordflow">case</span> GW_CHILD:
00682             <span class="keywordflow">break</span>;
00683 
00684         <span class="keywordflow">default</span>:
00685             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00686             <span class="keywordflow">break</span>;
00687         }
00688     }
00689 
00690     <span class="comment">/*</span>
00691 <span class="comment">     * Rebase the returned window at the end of the routine</span>
00692 <span class="comment">     * to avoid multiple test for pwndT == NULL.</span>
00693 <span class="comment">     */</span>
00694     pwndT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00695     <span class="keywordflow">switch</span> (cmd) {
00696     <span class="keywordflow">case</span> GW_HWNDNEXT:
00697         pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00698         fRebase = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00699         <span class="keywordflow">break</span>;
00700 
00701     <span class="keywordflow">case</span> GW_HWNDFIRST:
00702         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00703             pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00704             pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwndT, spwndChild);
00705             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a34">GetAppCompatFlags</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp; GACF_IGNORETOPMOST) {
00706                 <span class="keywordflow">while</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00707                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>))
00708                         <span class="keywordflow">break</span>;
00709                     pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwndT, spwndNext);
00710                 }
00711             }
00712         }
00713         <span class="keywordflow">break</span>;
00714 
00715     <span class="keywordflow">case</span> GW_HWNDLAST:
00716         pwndT = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a12">GetPrevPwnd</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00717         <span class="keywordflow">break</span>;
00718 
00719     <span class="keywordflow">case</span> GW_HWNDPREV:
00720         pwndT = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a12">GetPrevPwnd</a>(pwnd, pwnd);
00721         <span class="keywordflow">break</span>;
00722 
00723     <span class="keywordflow">case</span> GW_OWNER:
00724         pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
00725         fRebase = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00726         <span class="keywordflow">break</span>;
00727 
00728     <span class="keywordflow">case</span> GW_CHILD:
00729         pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00730         fRebase = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00731         <span class="keywordflow">break</span>;
00732 
00733 <span class="preprocessor">#if !defined(_USERK_)</span>
00734 <span class="preprocessor"></span>    <span class="keywordflow">case</span> GW_ENABLEDPOPUP:
00735        pwndT = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a175">NtUserCallHwnd</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd), SFI_DWP_GETENABLEDPOPUP);
00736        fRebase = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00737        <span class="keywordflow">break</span>;
00738 <span class="preprocessor">#endif</span>
00739 <span class="preprocessor"></span>
00740     <span class="keywordflow">default</span>:
00741         RIPERR0(ERROR_INVALID_GW_COMMAND, RIP_VERBOSE, <span class="stringliteral">""</span>);
00742         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00743     }
00744 
00745     <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; fRebase)
00746         pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pwnd, pwndT);
00747 
00748     <span class="keywordflow">return</span> pwndT;
00749 }
00750 
00751 <span class="comment">/***************************************************************************\</span>
00752 <span class="comment">* _GetParent (API)</span>
00753 <span class="comment">*</span>
00754 <span class="comment">*</span>
00755 <span class="comment">*</span>
00756 <span class="comment">* History:</span>
00757 <span class="comment">* 11-12-90 darrinm      Ported.</span>
00758 <span class="comment">* 02-19-91 JimA         Added enum access check</span>
00759 <span class="comment">* 05-04-92 DarrinM      Removed enum access check and moved to USERRTL.DLL</span>
00760 <span class="comment">\***************************************************************************/</span>
00761 
<a name="l00762"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a14">00762</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a14">_GetParent</a>(
00763     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00764 {
00765     <span class="comment">/*</span>
00766 <span class="comment">     * For 1.03 compatibility reasons, we should return NULL</span>
00767 <span class="comment">     * for top level "tiled" windows and owner for other popups.</span>
00768 <span class="comment">     * pwndOwner is set to NULL in xxxCreateWindow for top level</span>
00769 <span class="comment">     * "tiled" windows.</span>
00770 <span class="comment">     */</span>
00771     <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a737">TestwndTiled</a>(pwnd))) {
00772         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd))
00773             pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00774         <span class="keywordflow">else</span>
00775             pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndOwner);
00776         <span class="keywordflow">return</span> pwnd;
00777     }
00778 
00779     <span class="comment">/*</span>
00780 <span class="comment">     * The window was not a child window; they may have been just testing</span>
00781 <span class="comment">     * if it was</span>
00782 <span class="comment">     */</span>
00783     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00784 }
00785 
00786 
00787 <span class="comment">/***************************************************************************\</span>
00788 <span class="comment">* GetSubMenu</span>
00789 <span class="comment">*</span>
00790 <span class="comment">* Return the handle of a popup menu.</span>
00791 <span class="comment">*</span>
00792 <span class="comment">* History:</span>
00793 <span class="comment">* 10-11-90 JimA       Translated from ASM</span>
00794 <span class="comment">\***************************************************************************/</span>
00795 
<a name="l00796"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a15">00796</a> <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a15">_GetSubMenu</a>(
00797     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00798     <span class="keywordtype">int</span> nPos)
00799 {
00800     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00801     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pPopup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00802 
00803     <span class="comment">/*</span>
00804 <span class="comment">     * Make sure nPos refers to a valid popup</span>
00805 <span class="comment">     */</span>
00806     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)nPos &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)pMenu)-&gt;cItems) {
00807         pItem = &amp;((<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pMenu, rgItems))[nPos];
00808         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00809             pPopup = (<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a25">REBASEPTR</a>(pMenu, pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>);
00810 
00811     }
00812 
00813     <span class="keywordflow">return</span> (PVOID)pPopup;
00814 }
00815 
00816 
00817 <span class="comment">/***************************************************************************\</span>
00818 <span class="comment">* _IsChild (API)</span>
00819 <span class="comment">*</span>
00820 <span class="comment">*</span>
00821 <span class="comment">*</span>
00822 <span class="comment">* History:</span>
00823 <span class="comment">* 11-07-90 darrinm      Translated from Win 3.0 ASM code.</span>
00824 <span class="comment">\***************************************************************************/</span>
00825 
<a name="l00826"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a16">00826</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a16">_IsChild</a>(
00827     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent,
00828     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00829 {
00830     <span class="comment">/*</span>
00831 <span class="comment">     * Don't need a test to get out of the loop because the</span>
00832 <span class="comment">     * desktop is not a child.</span>
00833 <span class="comment">     */</span>
00834     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00835         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwnd))
00836             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00837 
00838         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00839         <span class="keywordflow">if</span> (pwndParent == pwnd)
00840             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00841     }
00842     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00843 }
00844 
00845 
00846 
00847 <span class="comment">/***************************************************************************\</span>
00848 <span class="comment">* _IsWindowVisible (API)</span>
00849 <span class="comment">*</span>
00850 <span class="comment">* IsWindowVisible returns the TRUEVIS state of a window, rather than just</span>
00851 <span class="comment">* the state of its WFVISIBLE flag.  According to this routine, a window is</span>
00852 <span class="comment">* considered visible when it and all the windows on its parent chain are</span>
00853 <span class="comment">* visible (WFVISIBLE flag set).  A special case hack was put in that causes</span>
00854 <span class="comment">* any icon window being dragged to be considered as visible.</span>
00855 <span class="comment">*</span>
00856 <span class="comment">* History:</span>
00857 <span class="comment">* 11-12-90 darrinm      Ported.</span>
00858 <span class="comment">\***************************************************************************/</span>
00859 
<a name="l00860"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">00860</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(
00861     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00862 {
00863     <span class="comment">/*</span>
00864 <span class="comment">     * Check if this is the iconic window being moved around with a mouse</span>
00865 <span class="comment">     * If so, return a TRUE, though, strictly speaking, it is hidden.</span>
00866 <span class="comment">     * This helps the Tracer guys from going crazy!</span>
00867 <span class="comment">     * Fix for Bug #57 -- SANKAR -- 08-08-89 --</span>
00868 <span class="comment">     */</span>
00869     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00870         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00871 
00872     <span class="keywordflow">for</span> (;;) {
00873         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
00874             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00875         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>)
00876             <span class="keywordflow">break</span>;
00877         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00878     }
00879 
00880     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00881 }
00882 
00883 
00884 <span class="comment">/***************************************************************************\</span>
00885 <span class="comment">* _ClientToScreen (API)</span>
00886 <span class="comment">*</span>
00887 <span class="comment">* Map a point from client to screen-relative coordinates.</span>
00888 <span class="comment">*</span>
00889 <span class="comment">* History:</span>
00890 <span class="comment">* 11-12-90 darrinm      Translated from Win 3.0 ASM code.</span>
00891 <span class="comment">\***************************************************************************/</span>
00892 
<a name="l00893"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a18">00893</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a18">_ClientToScreen</a>(
00894     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00895     PPOINT ppt)
00896 {
00897     <span class="comment">/*</span>
00898 <span class="comment">     * Client and screen coordinates are the same for the</span>
00899 <span class="comment">     * desktop window.</span>
00900 <span class="comment">     */</span>
00901     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) {
00902 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00903 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
00904             ppt-&gt;x  = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - ppt-&gt;x;
00905         } <span class="keywordflow">else</span>
00906 <span class="preprocessor">#endif</span>
00907 <span class="preprocessor"></span>        {
00908             ppt-&gt;x += pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
00909         }
00910         ppt-&gt;y += pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
00911     }
00912 }
00913 
00914 
00915 <span class="comment">/***************************************************************************\</span>
00916 <span class="comment">* _GetClientRect (API)</span>
00917 <span class="comment">*</span>
00918 <span class="comment">*</span>
00919 <span class="comment">*</span>
00920 <span class="comment">* History:</span>
00921 <span class="comment">* 26-Oct-1990 DarrinM   Implemented.</span>
00922 <span class="comment">\***************************************************************************/</span>
00923 
<a name="l00924"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">00924</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(
00925     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00926     LPRECT prc)
00927 {
00928     <span class="comment">/*</span>
00929 <span class="comment">     * If this is a 3.1 app, and it's minimized, then we need to return</span>
00930 <span class="comment">     * a rectangle other than the real-client-rect.  This is necessary since</span>
00931 <span class="comment">     * there is no client-rect-size in Win4.0.  Apps such as PackRat 1.0</span>
00932 <span class="comment">     * will GPF if returned a empty-rect.</span>
00933 <span class="comment">     */</span>
00934     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
00935         prc-&gt;left   = 0;
00936         prc-&gt;top    = 0;
00937         prc-&gt;right  = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a19">SYSMETRTL</a>(CXMINIMIZED);
00938         prc-&gt;bottom = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a19">SYSMETRTL</a>(CYMINIMIZED);
00939 
00940     } <span class="keywordflow">else</span> {
00941 
00942         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) {
00943             *prc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>;
00944             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(prc, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
00945         } <span class="keywordflow">else</span> {
00946             <span class="comment">/*</span>
00947 <span class="comment">             * For compatibility, return the rect of the primary</span>
00948 <span class="comment">             * monitor for the desktop window.</span>
00949 <span class="comment">             */</span>
00950             prc-&gt;left = prc-&gt;top = 0;
00951             prc-&gt;right = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a19">SYSMETRTL</a>(CXSCREEN);
00952             prc-&gt;bottom = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a19">SYSMETRTL</a>(CYSCREEN);
00953         }
00954     }
00955 }
00956 
00957 
00958 <span class="comment">/***************************************************************************\</span>
00959 <span class="comment">* _GetWindowRect (API)</span>
00960 <span class="comment">*</span>
00961 <span class="comment">*</span>
00962 <span class="comment">*</span>
00963 <span class="comment">* History:</span>
00964 <span class="comment">* 26-Oct-1990 DarrinM   Implemented.</span>
00965 <span class="comment">\***************************************************************************/</span>
00966 
<a name="l00967"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a20">00967</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a20">_GetWindowRect</a>(
00968     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00969     LPRECT prc)
00970 {
00971 
00972     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) {
00973         *prc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00974     } <span class="keywordflow">else</span> {
00975         <span class="comment">/*</span>
00976 <span class="comment">         * For compatibility, return the rect of the primary</span>
00977 <span class="comment">         * monitor for the desktop window.</span>
00978 <span class="comment">         */</span>
00979         prc-&gt;left   = 0;
00980         prc-&gt;top    = 0;
00981         prc-&gt;right  = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a19">SYSMETRTL</a>(CXSCREEN);
00982         prc-&gt;bottom = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a19">SYSMETRTL</a>(CYSCREEN);
00983     }
00984 }
00985 
00986 <span class="comment">/***************************************************************************\</span>
00987 <span class="comment">* _ScreenToClient (API)</span>
00988 <span class="comment">*</span>
00989 <span class="comment">* Map a point from screen to client-relative coordinates.</span>
00990 <span class="comment">*</span>
00991 <span class="comment">* History:</span>
00992 <span class="comment">* 11-12-90 darrinm      Translated from Win 3.0 ASM code.</span>
00993 <span class="comment">\***************************************************************************/</span>
00994 
<a name="l00995"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a21">00995</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a21">_ScreenToClient</a>(
00996     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00997     PPOINT ppt)
00998 {
00999     <span class="comment">/*</span>
01000 <span class="comment">     * Client and screen coordinates are the same for the</span>
01001 <span class="comment">     * desktop window.</span>
01002 <span class="comment">     */</span>
01003     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) {
01004 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01005 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
01006             ppt-&gt;x  = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - ppt-&gt;x;
01007         } <span class="keywordflow">else</span>
01008 <span class="preprocessor">#endif</span>
01009 <span class="preprocessor"></span>        {
01010             ppt-&gt;x -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
01011         }
01012         ppt-&gt;y -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
01013     }
01014 }
01015 <span class="comment">/***************************************************************************\</span>
01016 <span class="comment">* PhkNextValid</span>
01017 <span class="comment">*</span>
01018 <span class="comment">* This helper routine walk the phkNext chain looking for the next valid</span>
01019 <span class="comment">*  hook (i.e., not marked as destroyed). If the end of the local (or</span>
01020 <span class="comment">*  thread specific) hook chain is reached, then it jumps to the global</span>
01021 <span class="comment">*  (or desktop) chain.</span>
01022 <span class="comment">*</span>
01023 <span class="comment">* Once a hook is destroyed, we don't want anymore activity on it; however,</span>
01024 <span class="comment">*  if the hook is locked at destroy time (= someone is calling it), then</span>
01025 <span class="comment">*  we keep it in the list so CallNextHook will work properly</span>
01026 <span class="comment">*</span>
01027 <span class="comment">* History:</span>
01028 <span class="comment">* 03/24/96  GerardoB        Moved to rtl and added *Valid stuff.</span>
01029 <span class="comment">* 01-30-91  DavidPe         Created.</span>
01030 <span class="comment">\***************************************************************************/</span>
<a name="l01031"></a><a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">01031</a> <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk)
01032 {
01033 
01034 <span class="preprocessor">#if DBG</span>
01035 <span class="preprocessor"></span>    <span class="keywordtype">int</span> iHook = phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>;
01036 <span class="preprocessor">#ifdef _USERK_</span>
01037 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a156">CheckCritInShared</a>();
01038 <span class="preprocessor">#endif</span>
01039 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01040 <span class="preprocessor"></span>
01041     <span class="keywordflow">do</span> {
01042         <span class="comment">/*</span>
01043 <span class="comment">         * If this hook is marked as destroyed, it must be either</span>
01044 <span class="comment">         *  locked or we should be in the process of destroying it</span>
01045 <span class="comment">         */</span>
01046         UserAssert(!(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>)
01047                     || (((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)phk)-&gt;cLockObj != 0)
01048                     || (phk-&gt;flags &amp; HF_INCHECKWHF));
01049         <span class="comment">/*</span>
01050 <span class="comment">         * Get the next hook</span>
01051 <span class="comment">         */</span>
01052         <span class="keywordflow">if</span> (phk-&gt;phkNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01053             phk = <a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(phk, phkNext);
01054         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(phk-&gt;flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>)) {
01055 <span class="preprocessor">#ifdef _USERK_</span>
01056 <span class="preprocessor"></span>            phk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pDeskInfo-&gt;aphkStart[phk-&gt;iHook + 1];
01057 <span class="preprocessor">#else</span>
01058 <span class="preprocessor"></span>            <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
01059             phk = pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o5">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[phk-&gt;iHook + 1];
01060             <span class="comment">/*</span>
01061 <span class="comment">             * If it found a pointer, rebase it.</span>
01062 <span class="comment">             */</span>
01063             <span class="keywordflow">if</span> (phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01064                 (KPBYTE)phk -= pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o6">ulClientDelta</a>;
01065             }
01066 <span class="preprocessor">#endif</span>
01067 <span class="preprocessor"></span>            UserAssert((phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (phk-&gt;flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>));
01068         } <span class="keywordflow">else</span> {
01069             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01070         }
01071         <span class="comment">/*</span>
01072 <span class="comment">         * If destroyed, keep looking.</span>
01073 <span class="comment">         */</span>
01074     } <span class="keywordflow">while</span> ((phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>));
01075 
01076 <span class="preprocessor">#ifdef _USERK_</span>
01077 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a>(phk, iHook);
01078 <span class="preprocessor">#endif</span>
01079 <span class="preprocessor"></span>
01080     <span class="keywordflow">return</span> phk;
01081 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
