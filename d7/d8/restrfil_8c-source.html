<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: restrfil.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>restrfil.c</h1><a href="../../d6/d9/restrfil_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1998  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    restrfil.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements file system redirection for the ActiveX sandbox.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Michael Warning (MikeW)     1-Mar-1998</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    User mode callable only</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 
00026 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00027 <span class="preprocessor">#include &lt;ntdef.h&gt;</span>
00028 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00029 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00030 <span class="preprocessor">#include &lt;windef.h&gt;</span>
00031 
00032 <span class="comment">//</span>
00033 <span class="comment">// We need this stuff to get the site directory.  This info should be moved</span>
00034 <span class="comment">// into the job object eventually.</span>
00035 <span class="comment">//</span>
00036 
<a name="l00037"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a0">00037</a> <span class="preprocessor">#define GetSiteSidFromToken xxxGetSiteSidFromToken</span>
<a name="l00038"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a1">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define GetMangledSiteSid   xxxGetMangledSiteSid</span>
<a name="l00039"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a2">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define IsTokenRestricted   xxxIsTokenRestricted</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#include &lt;winbase.h&gt;</span>
00041 <span class="preprocessor">#undef GetSiteSidFromToken</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#undef GetMangledSiteSid  </span>
00043 <span class="preprocessor"></span><span class="preprocessor">#undef IsTokenRestricted</span>
00044 <span class="preprocessor"></span>
00045 
00046 <span class="keywordtype">void</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a13">Base32Encode</a>(LPVOID pvData, UINT cbData, LPWSTR pchData);
00047 HRESULT <a class="code" href="../../d6/d9/restrfil_8c.html#a1">GetMangledSiteSid</a>(PSID pSid, ULONG cchMangledSite, LPWSTR *ppwszMangledSite);
00048 PSID <a class="code" href="../../d6/d9/restrfil_8c.html#a0">GetSiteSidFromToken</a>(IN HANDLE TokenHandle);
00049 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a2">IsTokenRestricted</a>(IN HANDLE TokenHandle);
00050 
00051 
00052 
00053 <span class="comment">//</span>
00054 <span class="comment">// Internal prototypes</span>
00055 <span class="comment">//</span>
00056 
00057 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     <a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(
00058                     OBJECT_ATTRIBUTES *NormalFile, 
00059                     OBJECT_ATTRIBUTES *RestrictedFile);
00060 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a18">CopyRestrictedFile</a>(
00061                     OBJECT_ATTRIBUTES *SourceAttributes, 
00062                     OBJECT_ATTRIBUTES *DestinationAttributes);
00063 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a19">CreateDirectories</a>(OBJECT_ATTRIBUTES *Attributes);
00064 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     <a class="code" href="../../d6/d9/restrfil_8c.html#a20">FileExists</a>(OBJECT_ATTRIBUTES *Attributes);
00065 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a21">CopyStream</a>(
00066                 HANDLE SourceFile, 
00067                 HANDLE DestinationFile, 
00068                 FILE_STREAM_INFORMATION *StreamInfo,
00069                 BYTE  *Buffer,
00070                 ULONG  BufferSize);
00071 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a22">InitializeRestrictedStuff</a>();
00072 
00073 <span class="comment">//</span>
00074 <span class="comment">// UnRestricted versions of the api's</span>
00075 <span class="comment">//</span>
00076 
00077 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(
00078                         OUT PHANDLE             FileHandle,
00079                         IN  ACCESS_MASK         DesiredAccess,
00080                         IN  POBJECT_ATTRIBUTES  ObjectAttributes,
00081                         OUT PIO_STATUS_BLOCK    IoStatusBlock,
00082                         IN  PLARGE_INTEGER      AllocationSize OPTIONAL,
00083                         IN  ULONG               FileAttributes,
00084                         IN  ULONG               ShareAccess,
00085                         IN  ULONG               CreateDisposition,
00086                         IN  ULONG               CreateOptions,
00087                         IN  PVOID               EaBuffer OPTIONAL,
00088                         IN  ULONG               EaLength);
00089 
00090 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a>(
00091                         OUT PHANDLE             FileHandle,
00092                         IN  ACCESS_MASK         DesiredAccess,
00093                         IN  POBJECT_ATTRIBUTES  ObjectAttributes,
00094                         OUT PIO_STATUS_BLOCK    IoStatusBlock,
00095                         IN  ULONG               ShareAccess,
00096                         IN  ULONG               OpenOptions);
00097 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a>(
00098                         IN  POBJECT_ATTRIBUTES  ObjectAttributes);
00099 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a>(
00100                         IN  POBJECT_ATTRIBUTES      ObjectAttributes,
00101                         OUT PFILE_BASIC_INFORMATION FileInformation);
00102 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a27">NtUnRestrictedSetInformationFile</a>(
00103                         IN  HANDLE FileHandle,
00104                         OUT PIO_STATUS_BLOCK IoStatusBlock,
00105                         IN  PVOID FileInformation,
00106                         IN  ULONG Length,
00107                         IN  FILE_INFORMATION_CLASS FileInformationClass);
00108 
00109 <span class="comment">//</span>
00110 <span class="comment">// Miscellaneous globals</span>
00111 <span class="comment">//</span>
00112 
00113 <span class="keyword">enum</span>            
00114 {
00115     <a class="code" href="../../d6/d9/restrfil_8c.html#a41a10">eUnRestricted</a> = 0,
00116     <a class="code" href="../../d6/d9/restrfil_8c.html#a41a11">eRestricted</a>,
00117     <a class="code" href="../../d6/d9/restrfil_8c.html#a41a12">eUnknownRestricted</a>
00118 }
00119 <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a41a12">eUnknownRestricted</a>;
00120 
<a name="l00121"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a6">00121</a> UNICODE_STRING  <a class="code" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a> = {0, 0, 0};
<a name="l00122"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a7">00122</a> UNICODE_STRING  <a class="code" href="../../d6/d9/restrfil_8c.html#a7">SystemPath2</a> = {0, 0, 0};
<a name="l00123"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a8">00123</a> UNICODE_STRING  <a class="code" href="../../d6/d9/restrfil_8c.html#a8">SystemPath3</a> = {0, 0, 0};
<a name="l00124"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a9">00124</a> UNICODE_STRING  <a class="code" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a> = {0, 0, 0};
00125 
00126 
00127 
00128 <span class="keywordtype">void</span> 
<a name="l00129"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a28">00129</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a28">CheckRestricted</a>()
00130 <span class="comment">/*++</span>
00131 <span class="comment"></span>
00132 <span class="comment">Routine Description:</span>
00133 <span class="comment"></span>
00134 <span class="comment">    Determine if this is a restricted process and thus should have filesystem</span>
00135 <span class="comment">    redirection active.</span>
00136 <span class="comment"></span>
00137 <span class="comment">Arguments:</span>
00138 <span class="comment"></span>
00139 <span class="comment">    None</span>
00140 <span class="comment"></span>
00141 <span class="comment">Return Value:</span>
00142 <span class="comment"></span>
00143 <span class="comment">    void</span>
00144 <span class="comment"></span>
00145 <span class="comment">--*/</span>
00146 {
00147     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00148     HANDLE              hToken;
00149     UNICODE_STRING      SandboxKeyName;
00150     HANDLE              SandboxKey;
00151     OBJECT_ATTRIBUTES   Attributes;
00152     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>                <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[256];
00153     ULONG               Length;
00154 
00155     KEY_VALUE_PARTIAL_INFORMATION *ValueInfo = (KEY_VALUE_PARTIAL_INFORMATION *) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">// Assume unrestricted unless we have reason to believe otherwise</span>
00159     <span class="comment">//</span>
00160 
00161     <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a41a10">eUnRestricted</a>;
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">// HACKHACK: Temporarily allow redirection to be forced off by setting</span>
00165     <span class="comment">//           HKLM\Software\Sandbox!FileSystemRedir = (REG_DWORD) 0</span>
00166     <span class="comment">//</span>
00167 
00168     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SandboxKeyName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Sandbox"</span>);
00169 
00170     InitializeObjectAttributes(
00171             &amp;Attributes,
00172             &amp;SandboxKeyName,
00173             OBJ_CASE_INSENSITIVE,
00174             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00175             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00176 
00177     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;SandboxKey, KEY_READ, &amp;Attributes);
00178 
00179     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; STATUS_OBJECT_NAME_NOT_FOUND != <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
00180         <span class="keywordflow">return</span>;
00181 
00182     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00183     {
00184         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SandboxKeyName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"FileSystemRedir"</span>);
00185 
00186         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00187                         SandboxKey,
00188                         &amp;SandboxKeyName,
00189                         KeyValuePartialInformation,
00190                         ValueInfo,
00191                         <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>),
00192                         &amp;Length);
00193 
00194         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SandboxKey);
00195 
00196         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; STATUS_OBJECT_NAME_NOT_FOUND != <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
00197             <span class="keywordflow">return</span>;
00198 
00199         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; 0 == * (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *) (&amp;ValueInfo-&gt;Data))
00200             <span class="keywordflow">return</span>;
00201     }
00202 
00203     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(NtCurrentProcess(), TOKEN_READ, &amp;hToken);
00204 
00205     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00206     {
00207         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a2">IsTokenRestricted</a>(hToken))
00208         {
00209             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a22">InitializeRestrictedStuff</a>();
00210 
00211             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00212                 <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a41a11">eRestricted</a>;
00213         }
00214 
00215         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hToken);
00216     }
00217 }
00218  
00219 
00220    
00221 __inline
00222 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> 
<a name="l00223"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a29">00223</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>()
00224 <span class="comment">/*++</span>
00225 <span class="comment"></span>
00226 <span class="comment">Routine Description:</span>
00227 <span class="comment"></span>
00228 <span class="comment">    Determine if this is a restricted process and thus should have filesystem</span>
00229 <span class="comment">    redirection active.</span>
00230 <span class="comment"></span>
00231 <span class="comment">Arguments:</span>
00232 <span class="comment"></span>
00233 <span class="comment">    None</span>
00234 <span class="comment"></span>
00235 <span class="comment">Return Value:</span>
00236 <span class="comment"></span>
00237 <span class="comment">    TRUE if this is a restricted process, otherwise FALSE</span>
00238 <span class="comment"></span>
00239 <span class="comment">--*/</span>
00240 {
00241     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a41a10">eUnRestricted</a> == <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>)
00242         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00243     
00244     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a41a12">eUnknownRestricted</a> == <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>)
00245         <a class="code" href="../../d6/d9/restrfil_8c.html#a28">CheckRestricted</a>();
00246 
00247     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a41a11">eRestricted</a> == <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>);
00248 }
00249 
00250 
00251 
00252 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00253"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a30">00253</a> <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00254     OUT PHANDLE FileHandle,
00255     IN ACCESS_MASK DesiredAccess,
00256     IN POBJECT_ATTRIBUTES ObjectAttributes,
00257     OUT PIO_STATUS_BLOCK IoStatusBlock,
00258     IN PLARGE_INTEGER AllocationSize OPTIONAL,
00259     IN ULONG FileAttributes,
00260     IN ULONG ShareAccess,
00261     IN ULONG CreateDisposition,
00262     IN ULONG CreateOptions,
00263     IN PVOID EaBuffer OPTIONAL,
00264     IN ULONG EaLength
00265     )
00266 <span class="comment">/*++</span>
00267 <span class="comment"></span>
00268 <span class="comment">Routine Description:</span>
00269 <span class="comment"></span>
00270 <span class="comment">    Entry point for the restricted version of NtCreateFile</span>
00271 <span class="comment"></span>
00272 <span class="comment">Arguments:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    FileHandle - A pointer to a variable to receive the handle to the open file.</span>
00275 <span class="comment"></span>
00276 <span class="comment">    DesiredAccess - Supplies the types of access that the caller would like to</span>
00277 <span class="comment">        the file.</span>
00278 <span class="comment"></span>
00279 <span class="comment">    ObjectAttributes - Supplies the attributes to be used for file object (name,</span>
00280 <span class="comment">        SECURITY_DESCRIPTOR, etc.)</span>
00281 <span class="comment"></span>
00282 <span class="comment">    IoStatusBlock - Specifies the address of the caller's I/O status block.</span>
00283 <span class="comment"></span>
00284 <span class="comment">    AllocationSize - Initial size that should be allocated to the file.  This</span>
00285 <span class="comment">        parameter only has an affect if the file is created.  Further, if</span>
00286 <span class="comment">        not specified, then it is taken to mean zero.</span>
00287 <span class="comment"></span>
00288 <span class="comment">    FileAttributes - Specifies the attributes that should be set on the file,</span>
00289 <span class="comment">        if it is created.</span>
00290 <span class="comment"></span>
00291 <span class="comment">    ShareAccess - Supplies the types of share access that the caller would like</span>
00292 <span class="comment">        to the file.</span>
00293 <span class="comment"></span>
00294 <span class="comment">    CreateDisposition - Supplies the method for handling the create/open.</span>
00295 <span class="comment"></span>
00296 <span class="comment">    CreateOptions - Caller options for how to perform the create/open.</span>
00297 <span class="comment"></span>
00298 <span class="comment">    EaBuffer - Optionally specifies a set of EAs to be applied to the file if</span>
00299 <span class="comment">        it is created.</span>
00300 <span class="comment"></span>
00301 <span class="comment">    EaLength - Supplies the length of the EaBuffer.</span>
00302 <span class="comment"></span>
00303 <span class="comment">Return Value:</span>
00304 <span class="comment"></span>
00305 <span class="comment">    The function value is the final status of the create/open operation.</span>
00306 <span class="comment"></span>
00307 <span class="comment">--*/</span>
00308 {
00309 <span class="preprocessor">#define CALL_CREATE(object)                 \</span>
00310 <span class="preprocessor">            NtUnRestrictedCreateFile(       \</span>
00311 <span class="preprocessor">                    FileHandle,             \</span>
00312 <span class="preprocessor">                    DesiredAccess,          \</span>
00313 <span class="preprocessor">                    object,                 \</span>
00314 <span class="preprocessor">                    IoStatusBlock,          \</span>
00315 <span class="preprocessor">                    AllocationSize,         \</span>
00316 <span class="preprocessor">                    FileAttributes,         \</span>
00317 <span class="preprocessor">                    ShareAccess,            \</span>
00318 <span class="preprocessor">                    CreateDisposition,      \</span>
00319 <span class="preprocessor">                    CreateOptions,          \</span>
00320 <span class="preprocessor">                    EaBuffer,               \</span>
00321 <span class="preprocessor">                    EaLength)                       </span>
00322 <span class="preprocessor"></span>    <span class="comment">/*\</span>
00323 <span class="comment">        ((st =                                       \</span>
00324 <span class="comment">       ) ? st                                        \</span>
00325 <span class="comment">    :  ((Restricted == eRestricted) ? DbgPrint("%s %wZ\n", (object==NormalFile)?"UnMapped":"  Mapped",object-&gt;ObjectName) : 0), st)</span>
00326 <span class="comment">*/</span>
00327                     
00328     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00329     OBJECT_ATTRIBUTES  *OriginalAttributes;
00330     OBJECT_ATTRIBUTES  *NormalFile;
00331     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00332     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00333     UNICODE_STRING      RestrictedObjectName;
00334 
00335     FILE_BASIC_INFORMATION  BasicInfo;
00336 
00337 <span class="comment">//NTSTATUS st;</span>
00338 
00339     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>())
00340         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>);
00341 
00342     <span class="comment">//</span>
00343     <span class="comment">// Check to see if this file is mappable.  If not don't try</span>
00344     <span class="comment">//</span>
00345 
00346     NormalFile = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00347 
00348     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00349     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00350 
00351     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00352         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(NormalFile);
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">// The file/directory is mappable</span>
00356     <span class="comment">//</span>
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">// If this is a directory, try to access the normal one first, then the </span>
00360     <span class="comment">// shadowed one</span>
00361     <span class="comment">//</span>
00362     <span class="keywordflow">if</span> (CreateOptions &amp; FILE_DIRECTORY_FILE)
00363     {
00364         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(NormalFile);
00365 
00366         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00367         {
00368             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(RestrictedFile);
00369         }
00370     }
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// If this is a file which which already has a shadowed version, try the</span>
00374     <span class="comment">// operation only on that version</span>
00375     <span class="comment">//</span>
00376     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a20">FileExists</a>(RestrictedFile))
00377     {
00378         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(RestrictedFile);
00379     }
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">// This is a file operation and no shadowed version of the file exists,</span>
00383     <span class="comment">// try the operation in the unshadowed area</span>
00384     <span class="comment">//</span>
00385     <span class="keywordflow">else</span>
00386     {
00387         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(NormalFile);
00388 
00389         <span class="keywordflow">if</span> (STATUS_ACCESS_DENIED == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
00390         {
00391             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a19">CreateDirectories</a>(RestrictedFile);
00392             
00393             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00394             {
00395                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a18">CopyRestrictedFile</a>(NormalFile, RestrictedFile);
00396 
00397                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) 
00398                     || STATUS_OBJECT_NAME_NOT_FOUND == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
00399                 {
00400                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a3">CALL_CREATE</a>(RestrictedFile);
00401                 }
00402             }
00403         }
00404     }
00405 
00406 
00407 <span class="comment">/*</span>
00408 <span class="comment">if (!NT_SUCCESS(Status))</span>
00409 <span class="comment">  DbgPrint("  Failed %wZ\n", NormalFile-&gt;ObjectName);</span>
00410 <span class="comment">*/</span>
00411     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00412 
00413     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00414     
00415 <span class="preprocessor">#undef CALL_CREATE</span>
00416 <span class="preprocessor"></span>}
00417 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00418"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a31">00418</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(
00419     OUT PHANDLE FileHandle,
00420     IN ACCESS_MASK DesiredAccess,
00421     IN POBJECT_ATTRIBUTES ObjectAttributes,
00422     OUT PIO_STATUS_BLOCK IoStatusBlock,
00423     IN PLARGE_INTEGER AllocationSize OPTIONAL,
00424     IN ULONG FileAttributes,
00425     IN ULONG ShareAccess,
00426     IN ULONG CreateDisposition,
00427     IN ULONG CreateOptions,
00428     IN PVOID EaBuffer OPTIONAL,
00429     IN ULONG EaLength
00430     )
00431 {
00432     <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00433                     FileHandle,
00434                     DesiredAccess,
00435                     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00436                     IoStatusBlock,
00437                     AllocationSize,
00438                     <a class="code" href="../../d2/d2/rtload_8c.html#a5">FileAttributes</a>,
00439                     ShareAccess,
00440                     CreateDisposition,
00441                     CreateOptions,
00442                     EaBuffer,
00443                     EaLength);
00444 }
00445 
00446 
00447 
00448 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00449"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a32">00449</a> <a class="code" href="../../d4/d2/open_8c.html#a0">NtOpenFile</a>(
00450     OUT PHANDLE FileHandle,
00451     IN ACCESS_MASK DesiredAccess,
00452     IN POBJECT_ATTRIBUTES ObjectAttributes,
00453     OUT PIO_STATUS_BLOCK IoStatusBlock,
00454     IN ULONG ShareAccess,
00455     IN ULONG OpenOptions
00456     )
00457 <span class="comment">/*++</span>
00458 <span class="comment"></span>
00459 <span class="comment">Routine Description:</span>
00460 <span class="comment"></span>
00461 <span class="comment">    Entry point for the restricted version of NtOpenFile</span>
00462 <span class="comment"></span>
00463 <span class="comment">Arguments:</span>
00464 <span class="comment"></span>
00465 <span class="comment">    FileHandle - A pointer to a variable to receive the handle to the open file.</span>
00466 <span class="comment"></span>
00467 <span class="comment">    DesiredAccess - Supplies the types of access that the caller would like to</span>
00468 <span class="comment">        the file.</span>
00469 <span class="comment"></span>
00470 <span class="comment">    ObjectAttributes - Supplies the attributes to be used for file object (name,</span>
00471 <span class="comment">        SECURITY_DESCRIPTOR, etc.)</span>
00472 <span class="comment"></span>
00473 <span class="comment">    IoStatusBlock - Specifies the address of the caller's I/O status block.</span>
00474 <span class="comment"></span>
00475 <span class="comment">    ShareAccess - Supplies the types of share access that the caller would like</span>
00476 <span class="comment">        to the file.</span>
00477 <span class="comment"></span>
00478 <span class="comment">    OpenOptions - Caller options for how to perform the open.</span>
00479 <span class="comment"></span>
00480 <span class="comment">Return Value:</span>
00481 <span class="comment"></span>
00482 <span class="comment">    The function value is the final completion status of the open/create</span>
00483 <span class="comment">    operation.</span>
00484 <span class="comment"></span>
00485 <span class="comment">--*/</span>
00486 {
00487 <span class="preprocessor">#define CALL_OPEN(object)                 \</span>
00488 <span class="preprocessor">            NtUnRestrictedOpenFile(       \</span>
00489 <span class="preprocessor">                    FileHandle,             \</span>
00490 <span class="preprocessor">                    DesiredAccess,          \</span>
00491 <span class="preprocessor">                    object,                 \</span>
00492 <span class="preprocessor">                    IoStatusBlock,          \</span>
00493 <span class="preprocessor">                    ShareAccess,            \</span>
00494 <span class="preprocessor">                    OpenOptions)                   </span>
00495 <span class="preprocessor"></span>    <span class="comment">/*\</span>
00496 <span class="comment">        ((st =                                       \</span>
00497 <span class="comment">       ) ? st                                        \</span>
00498 <span class="comment">    :  ((Restricted == eRestricted) ? DbgPrint("%s %wZ\n", (object==NormalFile)?"UnMapped":"  Mapped",object-&gt;ObjectName) : 0), st)</span>
00499 <span class="comment">*/</span>
00500                     
00501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00502     OBJECT_ATTRIBUTES  *OriginalAttributes;
00503     OBJECT_ATTRIBUTES  *NormalFile;
00504     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00505     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00506     UNICODE_STRING      RestrictedObjectName;
00507 
00508     FILE_BASIC_INFORMATION  BasicInfo;
00509 
00510 <span class="comment">//NTSTATUS st;</span>
00511 
00512     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>())
00513         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>);
00514 
00515     <span class="comment">//</span>
00516     <span class="comment">// Check to see if this file is mappable.  If not don't try</span>
00517     <span class="comment">//</span>
00518 
00519     NormalFile = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00520 
00521     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00522     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00523 
00524     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00525         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(NormalFile);
00526 
00527     <span class="comment">//</span>
00528     <span class="comment">// The file/directory is mappable</span>
00529     <span class="comment">//</span>
00530 
00531     <span class="keywordflow">if</span> (OpenOptions &amp; FILE_DIRECTORY_FILE)
00532     {
00533         <span class="comment">//</span>
00534         <span class="comment">// This is a directory, attempt to access the given one, if that fails</span>
00535         <span class="comment">// try to access the shadowed version</span>
00536         <span class="comment">//</span>
00537 
00538         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(NormalFile);
00539 
00540         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00541         {
00542             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(RestrictedFile);
00543         }
00544     }
00545     <span class="keywordflow">else</span>
00546     {
00547         <span class="comment">//</span>
00548         <span class="comment">// This is a file (not a directory).  Attempt to open the shadowed</span>
00549         <span class="comment">// version.  If that fails, attempt to open the real version.  If that</span>
00550         <span class="comment">// fails with access denied, then try to copy the file to the shadow</span>
00551         <span class="comment">// area and try to open it there again.</span>
00552         <span class="comment">//</span>
00553 
00554         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(RestrictedFile);
00555 
00556         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00557         {           
00558             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(NormalFile);
00559 
00560             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00561             {
00562                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a18">CopyRestrictedFile</a>(NormalFile, RestrictedFile);
00563 
00564                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00565                 {
00566                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a4">CALL_OPEN</a>(RestrictedFile);
00567                 }
00568             }
00569         }
00570     }
00571 <span class="comment">/*</span>
00572 <span class="comment">if (!NT_SUCCESS(Status))</span>
00573 <span class="comment">  DbgPrint("  Failed %wZ\n", NormalFile-&gt;ObjectName);</span>
00574 <span class="comment">*/</span>
00575     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00576 
00577     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00578     
00579 <span class="preprocessor">#undef CALL_OPEN</span>
00580 <span class="preprocessor"></span>}
00581 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00582"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a33">00582</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00583     OUT PHANDLE FileHandle,
00584     IN ACCESS_MASK DesiredAccess,
00585     IN POBJECT_ATTRIBUTES ObjectAttributes,
00586     OUT PIO_STATUS_BLOCK IoStatusBlock,
00587     IN ULONG ShareAccess,
00588     IN ULONG OpenOptions
00589     )
00590 {
00591     <span class="keywordflow">return</span> <a class="code" href="../../d4/d2/open_8c.html#a0">NtOpenFile</a>(
00592                 FileHandle,
00593                 DesiredAccess,
00594                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00595                 IoStatusBlock,
00596                 ShareAccess,
00597                 OpenOptions);
00598 }
00599 
00600 
00601 
<a name="l00602"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a34">00602</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a2">NtDeleteFile</a>(IN POBJECT_ATTRIBUTES ObjectAttributes)
00603 <span class="comment">/*++</span>
00604 <span class="comment"></span>
00605 <span class="comment">Routine Description:</span>
00606 <span class="comment"></span>
00607 <span class="comment">    Attempt to delete the shadowed version of the given file.  If that fails</span>
00608 <span class="comment">    attempt to delete the real version of the file</span>
00609 <span class="comment"></span>
00610 <span class="comment">Arguments:</span>
00611 <span class="comment"></span>
00612 <span class="comment">    ObjectAttributes - Supplies the attributes to be used for file object (name,</span>
00613 <span class="comment">        SECURITY_DESCRIPTOR, etc.)</span>
00614 <span class="comment"></span>
00615 <span class="comment">Return Value:</span>
00616 <span class="comment"></span>
00617 <span class="comment">    The status returned is the final completion status of the operation.</span>
00618 <span class="comment"></span>
00619 <span class="comment">--*/</span>
00620 {
00621     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00622     OBJECT_ATTRIBUTES  *NormalFile;
00623     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00624     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00625     UNICODE_STRING      RestrictedObjectName;
00626 
00627     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>())
00628         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>);
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">// Check to see if this file is mappable.  Map it if it is</span>
00632     <span class="comment">//</span>
00633 
00634     NormalFile = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00635 
00636     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00637     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00638 
00639     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00640     {
00641         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a>(RestrictedFile);
00642         
00643         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00644             
00645         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || STATUS_ACCESS_DENIED == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
00646             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00647     }
00648 
00649     <span class="comment">//</span>
00650     <span class="comment">// The file is not mappable or deleting the mapped version failed.</span>
00651     <span class="comment">//</span>
00652 
00653     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a>(NormalFile);
00654 }
<a name="l00655"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a35">00655</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a35">ZwDeleteFile</a>(IN POBJECT_ATTRIBUTES ObjectAttributes)
00656 {
00657     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/io_2misc_8c.html#a2">NtDeleteFile</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>);
00658 }
00659 
00660 
00661 
00662 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00663"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a36">00663</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a4">NtQueryAttributesFile</a>(
00664     IN POBJECT_ATTRIBUTES ObjectAttributes,
00665     OUT PFILE_BASIC_INFORMATION FileInformation
00666     )
00667 <span class="comment">/*++</span>
00668 <span class="comment"></span>
00669 <span class="comment">Routine Description:</span>
00670 <span class="comment"></span>
00671 <span class="comment">    Attempt to query the shadowed version of the given file.  If that fails</span>
00672 <span class="comment">    attempt to query the real version of the file</span>
00673 <span class="comment"></span>
00674 <span class="comment">Arguments:</span>
00675 <span class="comment"></span>
00676 <span class="comment">    ObjectAttributes - Supplies the attributes to be used for file object (name,</span>
00677 <span class="comment">        SECURITY_DESCRIPTOR, etc.)</span>
00678 <span class="comment"></span>
00679 <span class="comment">    FileInformation - Supplies an output buffer to receive the returned file</span>
00680 <span class="comment">        attributes information.</span>
00681 <span class="comment"></span>
00682 <span class="comment">Return Value:</span>
00683 <span class="comment"></span>
00684 <span class="comment">    The status returned is the final completion status of the operation.</span>
00685 <span class="comment"></span>
00686 <span class="comment">--*/</span>
00687 {
00688     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00689     OBJECT_ATTRIBUTES  *NormalFile;
00690     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00691     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00692     UNICODE_STRING      RestrictedObjectName;
00693 
00694     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>())
00695         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a>(
00696                         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, 
00697                         FileInformation);
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// Check to see if this file is mappable.  Map it if it is</span>
00701     <span class="comment">//</span>
00702 
00703     NormalFile = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00704 
00705     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00706     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00707 
00708     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00709     {
00710         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a>(
00711                         RestrictedFile, 
00712                         FileInformation);
00713 
00714         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00715             
00716         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || STATUS_ACCESS_DENIED == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
00717             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00718     }
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// The file is not mappable or accessing the mapped version failed.</span>
00722     <span class="comment">//</span>
00723 
00724     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a>(
00725                     NormalFile, 
00726                     FileInformation);
00727 }
00728 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00729"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a37">00729</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a37">ZwQueryAttributesFile</a>(
00730     IN POBJECT_ATTRIBUTES ObjectAttributes,
00731     OUT PFILE_BASIC_INFORMATION FileInformation
00732     )
00733 {
00734     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/io_2misc_8c.html#a4">NtQueryAttributesFile</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, FileInformation);
00735 }
00736 
00737 
00738 
00739 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00740"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a38">00740</a> <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a>(
00741     IN HANDLE FileHandle,
00742     OUT PIO_STATUS_BLOCK IoStatusBlock,
00743     IN PVOID FileInformation,
00744     IN ULONG Length,
00745     IN FILE_INFORMATION_CLASS FileInformationClass
00746     )
00747 <span class="comment">/*++</span>
00748 <span class="comment"></span>
00749 <span class="comment">Routine Description:</span>
00750 <span class="comment"></span>
00751 <span class="comment">    Hook NtSetInformationFile to catch renames/moves of files by restricted </span>
00752 <span class="comment">    processes.</span>
00753 <span class="comment"></span>
00754 <span class="comment">Arguments:</span>
00755 <span class="comment"></span>
00756 <span class="comment">    FileHandle - Supplies a handle to the file whose information should be</span>
00757 <span class="comment">        changed.</span>
00758 <span class="comment"></span>
00759 <span class="comment">    IoStatusBlock - Address of the caller's I/O status block.</span>
00760 <span class="comment"></span>
00761 <span class="comment">    FileInformation - Supplies a buffer containing the information which should</span>
00762 <span class="comment">        be changed on the file.</span>
00763 <span class="comment"></span>
00764 <span class="comment">    Length - Supplies the length, in bytes, of the FileInformation buffer.</span>
00765 <span class="comment"></span>
00766 <span class="comment">    FileInformationClass - Specifies the type of information which should be</span>
00767 <span class="comment">        changed about the file.</span>
00768 <span class="comment"></span>
00769 <span class="comment">Return Value:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    The status returned is the final completion status of the operation.</span>
00772 <span class="comment"></span>
00773 <span class="comment">--*/</span>
00774 {
00775     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00776     OBJECT_ATTRIBUTES   NormalFileAttributes;
00777     OBJECT_ATTRIBUTES  *NormalFile = &amp;NormalFileAttributes;
00778     UNICODE_STRING      NormalFileName;
00779     OBJECT_ATTRIBUTES   RestrictedFileAttributes;
00780     OBJECT_ATTRIBUTES  *RestrictedFile = &amp;RestrictedFileAttributes;
00781     UNICODE_STRING      RestrictedObjectName;
00782 
00783     FILE_RENAME_INFORMATION *RenameInfo;
00784 
00785     <span class="comment">//</span>
00786     <span class="comment">// Try the original operation first</span>
00787     <span class="comment">//</span>
00788 
00789     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a27">NtUnRestrictedSetInformationFile</a>(
00790                         FileHandle, 
00791                         IoStatusBlock, 
00792                         FileInformation, 
00793                         Length, 
00794                         FileInformationClass);
00795 
00796     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) 
00797         || !<a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>() 
00798         || FileRenameInformation != FileInformationClass)
00799     {
00800         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00801     }
00802 
00803     <span class="comment">//</span>
00804     <span class="comment">// Check to see if this file is mappable.  Map it if it is</span>
00805     <span class="comment">//</span>
00806 
00807     RenameInfo = (FILE_RENAME_INFORMATION *) FileInformation;
00808 
00809     NormalFileName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) RenameInfo-&gt;FileNameLength;
00810     NormalFileName.Length        = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) RenameInfo-&gt;FileNameLength;
00811     NormalFileName.Buffer        = RenameInfo-&gt;FileName;
00812 
00813     InitializeObjectAttributes(
00814             NormalFile,
00815             &amp;NormalFileName,
00816             OBJ_CASE_INSENSITIVE,
00817             RenameInfo-&gt;RootDirectory,
00818             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00819 
00820     CopyMemory(RestrictedFile, NormalFile, <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES));
00821     RestrictedFile-&gt;ObjectName = &amp;RestrictedObjectName;
00822 
00823     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(NormalFile, RestrictedFile))
00824     {
00825         FILE_RENAME_INFORMATION *NewRenameInfo;
00826         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                 Status2;
00827 
00828         NewRenameInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
00829                             RtlProcessHeap(), 
00830                             0, 
00831                             <span class="keyword">sizeof</span>(*RenameInfo) + RestrictedObjectName.Length);
00832 
00833         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != RenameInfo)
00834         {
00835             NewRenameInfo-&gt;ReplaceIfExists = RenameInfo-&gt;ReplaceIfExists;
00836             NewRenameInfo-&gt;RootDirectory   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00837             NewRenameInfo-&gt;FileNameLength  = RestrictedObjectName.Length;
00838             CopyMemory(
00839                     NewRenameInfo-&gt;FileName, 
00840                     RestrictedObjectName.Buffer, 
00841                     RestrictedObjectName.Length);
00842 
00843             Status2 = <a class="code" href="../../d6/d9/restrfil_8c.html#a27">NtUnRestrictedSetInformationFile</a>(
00844                                 FileHandle, 
00845                                 IoStatusBlock, 
00846                                 NewRenameInfo, 
00847                                 <span class="keyword">sizeof</span>(*RenameInfo) + RestrictedObjectName.Length, 
00848                                 FileInformationClass);
00849 
00850             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status2) ? Status2 : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00851 
00852             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, NewRenameInfo);
00853         }
00854 
00855         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedObjectName.Buffer);
00856     }
00857 
00858     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00859 }
00860 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00861"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a39">00861</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a39">ZwSetInformationFile</a>(
00862     IN HANDLE FileHandle,
00863     OUT PIO_STATUS_BLOCK IoStatusBlock,
00864     IN PVOID FileInformation,
00865     IN ULONG Length,
00866     IN FILE_INFORMATION_CLASS FileInformationClass
00867     )
00868 {
00869     <span class="keywordflow">return</span> <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a>(
00870                     FileHandle, 
00871                     IoStatusBlock, 
00872                     FileInformation, 
00873                     Length, 
00874                     FileInformationClass);
00875 }
00876 
00877 
00878 
<a name="l00879"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a22">00879</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a22">InitializeRestrictedStuff</a>()
00880 <span class="comment">/*++</span>
00881 <span class="comment"></span>
00882 <span class="comment">Routine Description:</span>
00883 <span class="comment"></span>
00884 <span class="comment">    Determine if this process needs to have file mapping turned on and if so</span>
00885 <span class="comment">    figure out the paths to the system drive and shadow area</span>
00886 <span class="comment"></span>
00887 <span class="comment">Arguments:</span>
00888 <span class="comment"></span>
00889 <span class="comment">    None</span>
00890 <span class="comment"></span>
00891 <span class="comment">Return Value:</span>
00892 <span class="comment"></span>
00893 <span class="comment">    STATUS_SUCCESS if file mapping support was initialized.</span>
00894 <span class="comment"></span>
00895 <span class="comment">--*/</span>
00896 {
00897     OBJECT_ATTRIBUTES   Attributes;
00898     UNICODE_STRING      Path;
00899     UNICODE_STRING      ProfileDirectory;
00900     HKEY                ProfileKey;
00901     HKEY                UserProfileKey;
00902     WCHAR               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION)+128/<span class="keyword">sizeof</span>(WCHAR)];
00903     ULONG               <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION)+128;
00904     IO_STATUS_BLOCK     IoStatus;
00905     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00906     HANDLE              SystemRoot;
00907     UNICODE_STRING     *TempString;
00908 
00909     HANDLE              hToken;
00910     PSID                SiteSid;
00911     WCHAR               MangledSiteBuffer[MAX_MANGLED_SITE];
00912     LPWSTR              MangledSite = MangledSiteBuffer;
00913 
00914     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00915 
00916     KEY_VALUE_PARTIAL_INFORMATION  *KeyInfo;
00917 
00918     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>)
00919         <span class="keywordflow">return</span> STATUS_SUCCESS;
00920 
00921     <span class="comment">//</span>
00922     <span class="comment">// Figure out the path to \Device&lt;systemvolume&gt;.  We need to open a</span>
00923     <span class="comment">// handle to SystemRoot and then query the name of that handle.</span>
00924     <span class="comment">//</span>
00925 
00926     Path.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00927     Path.Length        = 0;
00928     Path.Buffer        = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00929     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\??\\"</span>);
00930     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, USER_SHARED_DATA-&gt;NtSystemRoot);
00931 
00932     InitializeObjectAttributes(
00933             &amp;Attributes,
00934             &amp;Path,
00935             OBJ_CASE_INSENSITIVE,
00936             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00937             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00938 
00939     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a>(
00940                         &amp;SystemRoot, 
00941                         GENERIC_READ | SYNCHRONIZE, 
00942                         &amp;Attributes, 
00943                         &amp;IoStatus,
00944                         FILE_SHARE_READ | FILE_SHARE_WRITE,
00945                         FILE_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT);
00946 
00947     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00948         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00949 
00950     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>(
00951                     SystemRoot, 
00952                     ObjectNameInformation,
00953                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00954                     <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>),
00955                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00956 
00957     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemRoot);
00958 
00959     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00960         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00961 
00962     <span class="comment">// The path is the name of the SystemRoot handle minus the length of </span>
00963     <span class="comment">// NtSystemRoot minus the drive letter</span>
00964     
00965     TempString = &amp; ((OBJECT_NAME_INFORMATION *) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name;
00966     TempString-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR) * 
00967                                     (wcslen(USER_SHARED_DATA-&gt;NtSystemRoot) 
00968                                                 - <span class="keyword">sizeof</span>(<span class="stringliteral">"d"</span>));
00969 
00970     TempString-&gt;Buffer[TempString-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00971          
00972     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(
00973                         &amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a>, 
00974                         TempString-&gt;Buffer);
00975 
00976     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00977         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00978 
00979 <span class="comment">//DbgPrint("SystemPath1 = %wZ\n", &amp;SystemPath1);</span>
00980 
00981     <span class="comment">// Figure out the path to \??&lt;systemdrive&gt;</span>
00982 
00983     Path.Length        = 0;
00984     Path.Buffer        = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00985     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\??\\"</span>);
00986     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, USER_SHARED_DATA-&gt;NtSystemRoot);
00987     Path.Buffer[<span class="keyword">sizeof</span>(<span class="stringliteral">"\\??\\d"</span>)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00988 
00989     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a7">SystemPath2</a>, Path.Buffer);
00990 
00991     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00992         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00993 
00994 <span class="comment">//DbgPrint("SystemPath2 = %wZ\n", &amp;SystemPath2);</span>
00995 
00996     <span class="comment">// Figure out the path to \DosDevices&lt;systemdrive&gt;</span>
00997 
00998     Path.Length        = 0;
00999     Path.Buffer        = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01000     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\DosDevices\\"</span>);
01001     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, USER_SHARED_DATA-&gt;NtSystemRoot);
01002     Path.Buffer[<span class="keyword">sizeof</span>(<span class="stringliteral">"\\DosDevices\\d"</span>)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01003 
01004     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a8">SystemPath3</a>, Path.Buffer);
01005 
01006     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01007         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01008 
01009 <span class="comment">//DbgPrint("SystemPath3 = %wZ\n", &amp;SystemPath3);</span>
01010 
01011     <span class="comment">//</span>
01012     <span class="comment">// Figure out where the site directory is</span>
01013     <span class="comment">//</span>
01014     <span class="comment">// This code is temporary.  Eventually the shadow directory will be stored</span>
01015     <span class="comment">// in the job object</span>
01016     <span class="comment">//</span>
01017 
01018     <span class="comment">// First open the list of profile locations</span>
01019 
01020     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Path, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\ProfileList"</span>);
01021 
01022     InitializeObjectAttributes(
01023             &amp;Attributes,
01024             &amp;Path,
01025             OBJ_CASE_INSENSITIVE,
01026             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01027             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01028 
01029     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;ProfileKey, KEY_READ, &amp;Attributes);
01030 
01031     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01032         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01033 
01034     <span class="comment">// Next get a stringized version of the user's SID</span>
01035 
01036     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a26">RtlFormatCurrentUserKeyPath</a>(&amp;Path);
01037 
01038     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01039     {
01040         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProfileKey);
01041         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01042     }
01043 
01044     Path.Buffer += <span class="keyword">sizeof</span>(<span class="stringliteral">"\\Registry\\User"</span>);
01045     Path.Length -= <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\User"</span>);
01046 
01047     <span class="comment">// And open the profile for the current user</span>
01048 
01049     Attributes.RootDirectory = ProfileKey;
01050 
01051     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;UserProfileKey, KEY_READ, &amp;Attributes);
01052 
01053     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProfileKey);
01054     Path.Buffer -= <span class="keyword">sizeof</span>(<span class="stringliteral">"\\Registry\\User"</span>);
01055     Path.Length += <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\User"</span>);
01056     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;Path);
01057 
01058     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01059         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01060 
01061     <span class="comment">// Allocate a buffer and get the info</span>
01062 
01063     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Path, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ProfileImagePath"</span>);
01064 
01065     <span class="keywordflow">do</span>
01066     {
01067         ULONG ResultLength;
01068 
01069         KeyInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
01070 
01071         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == KeyInfo)
01072         {
01073             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(UserProfileKey);
01074             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01075             <span class="keywordflow">break</span>;
01076         }
01077 
01078         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
01079                         UserProfileKey,
01080                         &amp;Path,
01081                         KeyValuePartialInformation,
01082                         KeyInfo,
01083                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
01084                         &amp;ResultLength);
01085 
01086         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01087         {
01088             <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> *= 2;
01089             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, KeyInfo);
01090         }
01091     }
01092     <span class="keywordflow">while</span> (   STATUS_BUFFER_OVERFLOW == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> 
01093            || STATUS_BUFFER_TOO_SMALL == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01094 
01095     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(UserProfileKey);
01096 
01097     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01098         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01099 
01100     <span class="comment">// Create the path to the site directory</span>
01101 
01102     Path.Length         = 0;
01103     Path.MaximumLength  = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
01104     Path.Buffer         = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01105 
01106     ProfileDirectory.Length        = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) KeyInfo-&gt;DataLength;
01107     ProfileDirectory.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) KeyInfo-&gt;DataLength;
01108     ProfileDirectory.Buffer        = (WCHAR *) KeyInfo-&gt;Data;
01109 
01110     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a24">RtlExpandEnvironmentStrings_U</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ProfileDirectory, &amp;Path, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01111 
01112     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01113         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01114 
01115     <span class="comment">// RtlExpandEnvironmentStrings_U includes the null terminator in the length</span>
01116 
01117     Path.Length        -= <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>);
01118 
01119     <span class="comment">// Remove the drive letter from the path</span>
01120 
01121     Path.Length        -= 2 * <span class="keyword">sizeof</span>(WCHAR);
01122     MoveMemory(Path.Buffer, Path.Buffer + 2, Path.Length);
01123 
01124     <span class="comment">// </span>
01125     <span class="comment">// Figure out the site directory name</span>
01126     <span class="comment">//</span>
01127 
01128     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(NtCurrentProcess(), TOKEN_READ, &amp;hToken);
01129 
01130     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01131         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01132 
01133     SiteSid = <a class="code" href="../../d6/d9/restrfil_8c.html#a0">GetSiteSidFromToken</a>(hToken);
01134 
01135     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hToken);
01136 
01137     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == SiteSid)
01138         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01139 
01140     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a1">GetMangledSiteSid</a>(SiteSid, MAX_MANGLED_SITE, &amp;MangledSite);
01141 
01142     <a class="code" href="../../d8/d6/sertl_8c.html#a41">RtlFreeSid</a>(SiteSid);
01143 
01144     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01145         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01146 
01147     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
01148     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;Path, MangledSite);
01149 
01150     Path.Buffer[Path.Length / <span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01151 
01152     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a>, Path.Buffer);
01153 
01154 <span class="comment">//DbgPrint("Site Directory = %wZ\n", &amp;SiteDirectory);</span>
01155 
01156     <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01157 
01158     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01159 }
01160 
01161 
01162 
<a name="l01163"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a40">01163</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a40">IsInterestingPath</a>(
01164                 IN     POBJECT_ATTRIBUTES NormalFile, 
01165                 IN OUT POBJECT_ATTRIBUTES RestrictedFile)
01166 <span class="comment">/*++</span>
01167 <span class="comment"></span>
01168 <span class="comment">Routine Description:</span>
01169 <span class="comment"></span>
01170 <span class="comment">    Determine if this path pointed to by NormalFile can be mapped and if so</span>
01171 <span class="comment">    point RestrictedFile at the mapped version</span>
01172 <span class="comment"></span>
01173 <span class="comment">Arguments:</span>
01174 <span class="comment"></span>
01175 <span class="comment">    NormalFile - The file to be tested</span>
01176 <span class="comment">    RestrictedFile - The resultant restricted file</span>
01177 <span class="comment"></span>
01178 <span class="comment">Return Value:</span>
01179 <span class="comment"></span>
01180 <span class="comment">    STATUS_SUCCESS if RestrictedFile was setup</span>
01181 <span class="comment"></span>
01182 <span class="comment">--*/</span>
01183 {
01184     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>                    <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[1024];
01185     OBJECT_NAME_INFORMATION *NameInfo = (OBJECT_NAME_INFORMATION *) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01186     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01187     BOOLEAN                 CaseInSensitive;
01188     UNICODE_STRING         *SystemPath = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01189     UNICODE_STRING         *RestrictedName;
01190     
01191     <span class="comment">//</span>
01192     <span class="comment">// Expand out the root directory of a relative path, if applicable</span>
01193     <span class="comment">//</span>
01194 
01195     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != NormalFile-&gt;RootDirectory)
01196     {
01197         WCHAR  LastChar;
01198 
01199         <span class="comment">// Get the name corresponding to the root handle</span>
01200 
01201         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>(
01202                         NormalFile-&gt;RootDirectory,
01203                         ObjectNameInformation,
01204                         NameInfo,
01205                         <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>),
01206                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01207 
01208         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01209             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01210 
01211         <span class="comment">// Make sure there's a backslash on the end</span>
01212 
01213         LastChar = NameInfo-&gt;Name.Buffer[
01214                                 (NameInfo-&gt;Name.Length-1)*<span class="keyword">sizeof</span>(WCHAR)];
01215 
01216         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> != LastChar)
01217         {
01218             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;NameInfo-&gt;Name, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
01219 
01220             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01221                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01222         }
01223     }
01224     <span class="keywordflow">else</span>
01225     {
01226         NameInfo-&gt;Name.Length = 0;
01227         NameInfo-&gt;Name.Buffer = (WCHAR *) (((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *) NameInfo) 
01228                                                         + <span class="keyword">sizeof</span>(*NameInfo));
01229     }
01230 
01231     <span class="comment">//</span>
01232     <span class="comment">// Concatenate the file/directory to it's root to get a full path</span>
01233     <span class="comment">//</span>
01234 
01235     NameInfo-&gt;Name.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) 
01236                                         - <span class="keyword">sizeof</span>(*NameInfo) 
01237                                         - NameInfo-&gt;Name.Length;
01238 
01239     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(
01240                             &amp;NameInfo-&gt;Name, 
01241                             NormalFile-&gt;ObjectName);
01242 
01243     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01244         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01245     
01246     <span class="comment">//</span>
01247     <span class="comment">// Check to see if the path should be mapped</span>
01248     <span class="comment">//</span>
01249 
01250     CaseInSensitive = (BOOLEAN) 
01251                         ((OBJ_CASE_INSENSITIVE &amp; NormalFile-&gt;Attributes) != 0);
01252 
01253     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a>, &amp;NameInfo-&gt;Name, CaseInSensitive))
01254         SystemPath = &amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a>;
01255     <span class="keywordflow">else</span>
01256     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a7">SystemPath2</a>, &amp;NameInfo-&gt;Name, CaseInSensitive))
01257         SystemPath = &amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a7">SystemPath2</a>;
01258     <span class="keywordflow">else</span>
01259     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a8">SystemPath3</a>, &amp;NameInfo-&gt;Name, CaseInSensitive))
01260         SystemPath = &amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a8">SystemPath3</a>;
01261 
01262     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == SystemPath)
01263         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01264 
01265     <span class="comment">//</span>
01266     <span class="comment">// This path is on the system drive, reject it if it's pointing at the</span>
01267     <span class="comment">// mapped area already</span>
01268     <span class="comment">//</span>
01269 
01270     NameInfo-&gt;Name.Length -= SystemPath-&gt;Length;
01271     NameInfo-&gt;Name.Buffer += SystemPath-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
01272 
01273     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a>,&amp;NameInfo-&gt;Name,CaseInSensitive))
01274         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01275 
01276     NameInfo-&gt;Name.Length += SystemPath-&gt;Length;
01277     NameInfo-&gt;Name.Buffer -= SystemPath-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
01278 
01279     <span class="comment">//</span>
01280     <span class="comment">// This path should be mapped</span>
01281     <span class="comment">//</span>
01282 
01283     RestrictedName = RestrictedFile-&gt;ObjectName;
01284     RestrictedName-&gt;MaximumLength = <a class="code" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a>.Length
01285                                     + <a class="code" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a>.Length
01286                                     + NameInfo-&gt;Name.Length;
01287     RestrictedName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
01288                                     RtlProcessHeap(), 
01289                                     0, 
01290                                     RestrictedName-&gt;MaximumLength);
01291 
01292     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == RestrictedName-&gt;Buffer)
01293         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01294 
01295     NameInfo-&gt;Name.Buffer[NameInfo-&gt;Name.Length] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01296 
01297     RestrictedFile-&gt;RootDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01298     RestrictedName-&gt;Length = 0;
01299 
01300     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(RestrictedName, &amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a6">SystemPath1</a>);
01301     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(RestrictedName, &amp;<a class="code" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a>);
01302     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(
01303                 RestrictedName, 
01304                 NameInfo-&gt;Name.Buffer + SystemPath-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
01305 
01306     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01307 }
01308 
01309 
01310 
<a name="l01311"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a19">01311</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a19">CreateDirectories</a>(OBJECT_ATTRIBUTES *Attributes)
01312 <span class="comment">/*++</span>
01313 <span class="comment"></span>
01314 <span class="comment">Routine Description:</span>
01315 <span class="comment"></span>
01316 <span class="comment">    Given the path pointed to by Attributes, make sure all the directories</span>
01317 <span class="comment">    above the last element in the path exist.</span>
01318 <span class="comment"></span>
01319 <span class="comment">Parameters:</span>
01320 <span class="comment"></span>
01321 <span class="comment">    Attributes - The path</span>
01322 <span class="comment"></span>
01323 <span class="comment">Return Value:</span>
01324 <span class="comment"></span>
01325 <span class="comment">    STATUS_SUCCESS if all goes well</span>
01326 <span class="comment"></span>
01327 <span class="comment">--*/</span>
01328 {
01329     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01330     UNICODE_STRING      SubDirectory;
01331     OBJECT_ATTRIBUTES   DirectoryAttributes;
01332     HANDLE              NewDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01333     WCHAR              *NextDirectory;
01334     WCHAR              *EndOfString;
01335     IO_STATUS_BLOCK     IoStatus;
01336 
01337     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == Attributes-&gt;RootDirectory);
01338 
01339     InitializeObjectAttributes(
01340             &amp;DirectoryAttributes,
01341             &amp;SubDirectory,
01342             OBJ_CASE_INSENSITIVE,
01343             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01344             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01345 
01346     <span class="comment">// </span>
01347     <span class="comment">// Keep track of the end of the path and trim off any trailing '\'s</span>
01348     <span class="comment">//</span>
01349 
01350     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Attributes-&gt;ObjectName-&gt;Length &gt;= 2);
01351 
01352     EndOfString         = Attributes-&gt;ObjectName-&gt;Buffer 
01353                             + Attributes-&gt;ObjectName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
01354 
01355     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> == EndOfString[-1])
01356         --EndOfString;
01357 
01358     <span class="comment">// </span>
01359     <span class="comment">// Keep of a private version of the path so we can muck with it</span>
01360     <span class="comment">//</span>
01361 
01362     SubDirectory.Buffer = Attributes-&gt;ObjectName-&gt;Buffer;
01363     NextDirectory       = SubDirectory.Buffer;
01364     NextDirectory      += <a class="code" href="../../d6/d9/restrfil_8c.html#a9">SiteDirectory</a>.Length / <span class="keyword">sizeof</span>(WCHAR);
01365 
01366     <span class="comment">//</span>
01367     <span class="comment">// For each element in the path, try to create a directory using the full</span>
01368     <span class="comment">// path up to that element.</span>
01369     <span class="comment">//</span>
01370     <span class="comment">// Notes: CreateFile for "\??" returns STATUS_OBJECT_TYPE_MISMATCH</span>
01371     <span class="comment">//        CreateFile for "\??\D:" returns STATUS_INVALID_PARAMETER</span>
01372     <span class="comment">//</span>
01373 
01374     <span class="keywordflow">do</span>
01375     {
01376         <span class="comment">// Find the end of the next element</span>
01377 
01378         <span class="keywordflow">do</span>
01379         {
01380             ++NextDirectory;
01381         }
01382         <span class="keywordflow">while</span> (NextDirectory &lt; EndOfString &amp;&amp; <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> != *NextDirectory);
01383 
01384         <span class="keywordflow">if</span> ( !(NextDirectory &lt; EndOfString) )
01385             <span class="keywordflow">break</span>;
01386 
01387         <span class="comment">// Adjust SubDirectory to include it</span>
01388 
01389         SubDirectory.Length        = (NextDirectory - SubDirectory.Buffer);
01390         SubDirectory.Length       *= <span class="keyword">sizeof</span>(WCHAR);
01391         SubDirectory.MaximumLength = SubDirectory.Length;
01392 
01393         <span class="comment">// Create it</span>
01394 
01395         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(
01396                         &amp;NewDirectory,
01397                         GENERIC_READ | SYNCHRONIZE,
01398                         &amp;DirectoryAttributes,
01399                         &amp;IoStatus,
01400                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01401                         FILE_ATTRIBUTE_NORMAL,
01402                         FILE_SHARE_READ | FILE_SHARE_WRITE,
01403                         FILE_OPEN_IF,
01404                         FILE_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT,
01405                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01406                         0);
01407 
01408         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01409             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(NewDirectory);
01410 
01411         NewDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01412     }
01413     <span class="keywordflow">while</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) 
01414                     || STATUS_OBJECT_TYPE_MISMATCH == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
01415                     || STATUS_INVALID_PARAMETER    == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
01416            &amp;&amp; NextDirectory &lt; EndOfString);
01417 
01418     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01419 }
01420 
01421 
01422 
<a name="l01423"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a20">01423</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a20">FileExists</a>(OBJECT_ATTRIBUTES *Attributes)
01424 
01425 <span class="comment">/*++</span>
01426 <span class="comment"></span>
01427 <span class="comment">Routine Description:</span>
01428 <span class="comment"></span>
01429 <span class="comment">    Determine if the given file/directory exists</span>
01430 <span class="comment"></span>
01431 <span class="comment">Arguments:</span>
01432 <span class="comment"></span>
01433 <span class="comment">    Attributes      - The file/directory to check</span>
01434 <span class="comment"></span>
01435 <span class="comment">Return Value:</span>
01436 <span class="comment"></span>
01437 <span class="comment">    TRUE if it exists </span>
01438 <span class="comment"></span>
01439 <span class="comment">--*/</span>
01440 {
01441     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01442     FILE_BASIC_INFORMATION  FileInfo;
01443 
01444     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/io_2misc_8c.html#a4">NtQueryAttributesFile</a>(Attributes, &amp;FileInfo);
01445 
01446     <span class="keywordflow">return</span> (STATUS_SUCCESS == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01447 }
01448 
01449 
01450 
<a name="l01451"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a21">01451</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a21">CopyStream</a>(
01452                 HANDLE SourceFile, 
01453                 HANDLE DestinationFile, 
01454                 FILE_STREAM_INFORMATION *StreamInfo,
01455                 BYTE  *Buffer,
01456                 ULONG  BufferSize)
01457 <span class="comment">/*++</span>
01458 <span class="comment"></span>
01459 <span class="comment">Routine Description:</span>
01460 <span class="comment"></span>
01461 <span class="comment">    Copy a stream from one file to another</span>
01462 <span class="comment"></span>
01463 <span class="comment">Arguments:</span>
01464 <span class="comment"></span>
01465 <span class="comment">    SourceFile      - The source file</span>
01466 <span class="comment">    DestinationFile - The destination file</span>
01467 <span class="comment">    StreamInfo      - Information about the stream to copy</span>
01468 <span class="comment">    Buffer          - The buffer to use for copying</span>
01469 <span class="comment">    BufferSize      - The size of Buffer</span>
01470 <span class="comment"></span>
01471 <span class="comment">Return Value:</span>
01472 <span class="comment"></span>
01473 <span class="comment">    STATUS_SUCCESS if all goes well</span>
01474 <span class="comment"></span>
01475 <span class="comment">--*/</span>
01476 {
01477     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01478     UNICODE_STRING      StreamName;
01479     OBJECT_ATTRIBUTES   SourceAttributes;
01480     OBJECT_ATTRIBUTES   DestinationAttributes;
01481     HANDLE              SourceStream;
01482     HANDLE              DestinationStream;
01483     IO_STATUS_BLOCK     SourceIoStatus;
01484     IO_STATUS_BLOCK     DestinationIoStatus;
01485 
01486     StreamName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) StreamInfo-&gt;StreamNameLength;
01487     StreamName.Length        = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) StreamInfo-&gt;StreamNameLength;
01488     StreamName.Buffer        = StreamInfo-&gt;StreamName;
01489 
01490     <span class="comment">//</span>
01491     <span class="comment">// Data stream names are of the form ":&lt;name&gt;:$DATA" so if the second</span>
01492     <span class="comment">// char in the name is a colon then this is the default stream and we</span>
01493     <span class="comment">// don't need to open/create it</span>
01494     <span class="comment">//</span>
01495 
01496     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span> == StreamInfo-&gt;StreamName[1])
01497     {
01498         SourceStream = SourceFile;
01499         DestinationStream = DestinationFile;
01500     }
01501     <span class="keywordflow">else</span>
01502     {
01503         InitializeObjectAttributes(
01504                 &amp;SourceAttributes,
01505                 &amp;StreamName,
01506                 OBJ_CASE_INSENSITIVE,
01507                 SourceFile,
01508                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);            
01509         InitializeObjectAttributes(
01510                 &amp;DestinationAttributes,
01511                 &amp;StreamName,
01512                 OBJ_CASE_INSENSITIVE,
01513                 DestinationFile,
01514                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01515 
01516         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a>(
01517                         &amp;SourceStream,
01518                         GENERIC_READ | SYNCHRONIZE,
01519                         &amp;SourceAttributes,
01520                         &amp;SourceIoStatus,
01521                         FILE_SHARE_READ,
01522                         FILE_SEQUENTIAL_ONLY | FILE_SYNCHRONOUS_IO_NONALERT);
01523 
01524         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01525             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01526 
01527         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(
01528                         &amp;DestinationStream,
01529                         GENERIC_WRITE | SYNCHRONIZE,
01530                         &amp;DestinationAttributes,
01531                         &amp;DestinationIoStatus,
01532                         &amp;StreamInfo-&gt;StreamAllocationSize,
01533                         FILE_ATTRIBUTE_NORMAL,
01534                         0,
01535                         FILE_CREATE,
01536                         FILE_SEQUENTIAL_ONLY | FILE_SYNCHRONOUS_IO_NONALERT,
01537                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01538                         0);
01539 
01540         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01541         {
01542             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SourceStream);
01543             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01544         }
01545     }
01546 
01547     <span class="comment">//</span>
01548     <span class="comment">// Copy the stream</span>
01549     <span class="comment">//</span>
01550 
01551     <span class="keywordflow">do</span>
01552     {
01553         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/io_2read_8c.html#a1">NtReadFile</a>(
01554                         SourceStream,
01555                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01556                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01557                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01558                         &amp;SourceIoStatus,
01559                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01560                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
01561                         0,
01562                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01563 
01564         <span class="keywordflow">if</span> (STATUS_END_OF_FILE == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
01565         {
01566             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01567             <span class="keywordflow">break</span>;
01568         }
01569         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01570         {
01571             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/io_2write_8c.html#a0">NtWriteFile</a>(
01572                             DestinationStream,
01573                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01574                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01575                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01576                             &amp;DestinationIoStatus,
01577                             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01578                             SourceIoStatus.Information,
01579                             0,
01580                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01581         }
01582     }
01583     <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; SourceIoStatus.Information == <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
01584 
01585     <span class="keywordflow">if</span> (SourceStream != SourceFile)
01586     {
01587         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SourceStream);
01588         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(DestinationStream);
01589     }
01590 
01591     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01592 }
01593 
01594 
01595 
<a name="l01596"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a18">01596</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a18">CopyRestrictedFile</a>(
01597                     OBJECT_ATTRIBUTES *SourceAttributes, 
01598                     OBJECT_ATTRIBUTES *DestinationAttributes)
01599 <span class="comment">/*++</span>
01600 <span class="comment"></span>
01601 <span class="comment">Routine Description:</span>
01602 <span class="comment"></span>
01603 <span class="comment">    Copy a file.  Substreams in the file are copied and a best effort is made</span>
01604 <span class="comment">    to preserve the file attributes - although the copy does not fail if</span>
01605 <span class="comment">    the attributes can't be preserved.  Acl's and extended attributes such</span>
01606 <span class="comment">    as object id's are not copied.</span>
01607 <span class="comment"></span>
01608 <span class="comment">    If the any of the parent directories of the destination don't exist they</span>
01609 <span class="comment">    are created.</span>
01610 <span class="comment"></span>
01611 <span class="comment">Arguments:</span>
01612 <span class="comment"></span>
01613 <span class="comment">    SourceAttributes        - The source file</span>
01614 <span class="comment">    DestinationAttributues  - The destination file</span>
01615 <span class="comment"></span>
01616 <span class="comment">Return Value:</span>
01617 <span class="comment"></span>
01618 <span class="comment">    STATUS_SUCCESS if all goes well</span>
01619 <span class="comment"></span>
01620 <span class="comment">    The copy fails if the destination already exists or the source is read-only</span>
01621 <span class="comment"></span>
01622 <span class="comment">--*/</span>
01623 {
01624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01625     HANDLE          SourceFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01626     HANDLE          DestinationFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01627     IO_STATUS_BLOCK SourceIoStatus;
01628     IO_STATUS_BLOCK DestinationIoStatus;
01629     ULONG           StreamInfoSize = 4096;
01630     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>           *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01631     ULONG           <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = 8192;
01632 
01633     FILE_BASIC_INFORMATION      BasicInfo;
01634     FILE_STANDARD_INFORMATION   StandardInfo;
01635     FILE_STREAM_INFORMATION    *StreamInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01636     FILE_STREAM_INFORMATION    *Stream;
01637 
01638     <span class="comment">//</span>
01639     <span class="comment">// Check the attributes on the source.  If it's set to </span>
01640     <span class="comment">// read-only don't try to copy it</span>
01641     <span class="comment">//</span>
01642 
01643     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a26">NtUnRestrictedQueryAttributesFile</a>(SourceAttributes, &amp;BasicInfo);
01644 
01645     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01646         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01647     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (BasicInfo.FileAttributes &amp; FILE_ATTRIBUTE_READONLY)
01648         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01649 
01650 
01651     <span class="comment">//</span>
01652     <span class="comment">// Try to open the source file</span>
01653     <span class="comment">//</span>
01654 
01655     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a24">NtUnRestrictedOpenFile</a>(
01656                     &amp;SourceFile,
01657                     GENERIC_READ | SYNCHRONIZE,
01658                     SourceAttributes,
01659                     &amp;SourceIoStatus,
01660                     FILE_SHARE_READ,
01661                     FILE_SEQUENTIAL_ONLY | FILE_SYNCHRONOUS_IO_NONALERT);
01662 
01663     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01664         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01665 
01666     <span class="comment">//</span>
01667     <span class="comment">// Get the size of the source.  If this fails don't worry about it.</span>
01668     <span class="comment">//</span>
01669 
01670     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a3">NtQueryInformationFile</a>(
01671                     SourceFile,
01672                     &amp;SourceIoStatus,
01673                     &amp;StandardInfo,
01674                     <span class="keyword">sizeof</span>(StandardInfo),
01675                     FileStandardInformation);
01676 
01677     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01678         StandardInfo.AllocationSize.QuadPart = 0;
01679 
01680     <span class="comment">// </span>
01681     <span class="comment">// Get the file stream information.  There's no way to tell how big a </span>
01682     <span class="comment">// buffer we'll need to just keep doubling it.</span>
01683     <span class="comment">//</span>
01684 
01685     <span class="keywordflow">do</span>
01686     {
01687         StreamInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, StreamInfoSize);    
01688 
01689         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == StreamInfo)
01690         {
01691             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01692             <span class="keywordflow">goto</span> ErrorOut;
01693         }
01694 
01695         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a3">NtQueryInformationFile</a>(
01696                         SourceFile,
01697                         &amp;SourceIoStatus,
01698                         StreamInfo,
01699                         StreamInfoSize,
01700                         FileStreamInformation);
01701 
01702         StreamInfoSize *= 2;
01703     }
01704     <span class="keywordflow">while</span> (STATUS_BUFFER_OVERFLOW == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> 
01705                || STATUS_BUFFER_TOO_SMALL == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01706 
01707     <span class="comment">//</span>
01708     <span class="comment">// Allocate a buffer to do the copying</span>
01709     <span class="comment">//</span>
01710 
01711     <span class="keywordflow">do</span>
01712     {
01713         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
01714 
01715         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)
01716             <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> /= 2;
01717     }
01718     <span class="keywordflow">while</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> &amp;&amp; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &gt; 15);
01719 
01720     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)
01721         <span class="keywordflow">goto</span> ErrorOut;
01722             
01723     <span class="comment">//</span>
01724     <span class="comment">// Try to create the destination file</span>
01725     <span class="comment">//</span>
01726 
01727     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(
01728                     &amp;DestinationFile,
01729                     GENERIC_WRITE | SYNCHRONIZE,
01730                     DestinationAttributes,
01731                     &amp;DestinationIoStatus,
01732                     &amp;StandardInfo.AllocationSize,
01733                     BasicInfo.FileAttributes,
01734                     0,
01735                     FILE_CREATE,
01736                     FILE_SEQUENTIAL_ONLY | FILE_SYNCHRONOUS_IO_NONALERT,
01737                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01738                     0);
01739 
01740     <span class="comment">//</span>
01741     <span class="comment">// If creating the file failed because the path doesn't exist,</span>
01742     <span class="comment">// create the path and try again</span>
01743     <span class="comment">//</span>
01744 
01745     <span class="keywordflow">if</span> (STATUS_OBJECT_PATH_NOT_FOUND == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)
01746     {
01747         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a19">CreateDirectories</a>(DestinationAttributes);
01748 
01749         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01750         {
01751             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a23">NtUnRestrictedCreateFile</a>(
01752                             &amp;DestinationFile,
01753                             GENERIC_WRITE | SYNCHRONIZE,
01754                             DestinationAttributes,
01755                             &amp;DestinationIoStatus,
01756                             &amp;StandardInfo.AllocationSize,
01757                             BasicInfo.FileAttributes,
01758                             0,
01759                             FILE_CREATE,
01760                             FILE_SEQUENTIAL_ONLY |FILE_SYNCHRONOUS_IO_NONALERT,
01761                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01762                             0);
01763         }
01764     }
01765 
01766     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01767         <span class="keywordflow">goto</span> ErrorOut;
01768 
01769     <span class="comment">//</span>
01770     <span class="comment">// Set the file times.  It's ok to fail</span>
01771     <span class="comment">//</span>
01772 
01773     <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a>(
01774             DestinationFile,
01775             &amp;DestinationIoStatus,
01776             &amp;BasicInfo,
01777             <span class="keyword">sizeof</span>(BasicInfo),
01778             FileBasicInformation);
01779 
01780     <span class="comment">//</span>
01781     <span class="comment">// Copy each stream in the file</span>
01782     <span class="comment">//</span>
01783 
01784     Stream = StreamInfo;
01785 
01786     <span class="keywordflow">do</span>
01787     {
01788         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a21">CopyStream</a>(
01789                         SourceFile, 
01790                         DestinationFile, 
01791                         Stream, 
01792                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, 
01793                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
01794 
01795         <span class="keywordflow">if</span> (0 == Stream-&gt;NextEntryOffset)
01796             <span class="keywordflow">break</span>;
01797 
01798         Stream = (FILE_STREAM_INFORMATION *) 
01799                         (((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *) Stream) + Stream-&gt;NextEntryOffset);
01800     }
01801     <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01802 
01803 ErrorOut:
01804 
01805     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)
01806         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
01807     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != StreamInfo)
01808         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, StreamInfo);
01809     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != SourceFile)
01810         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SourceFile);
01811 
01812     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != DestinationFile)
01813     {
01814         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(DestinationFile);
01815 
01816         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01817         {
01818             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> DeleteStatus;
01819             DeleteStatus = <a class="code" href="../../d6/d9/restrfil_8c.html#a25">NtUnRestrictedDeleteFile</a>(DestinationAttributes);
01820             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DeleteStatus));
01821         }
01822     }
01823 
01824     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01825 }
01826 
01827 
01828 
01829 
01830 
01831 
01832 
01833 
01834 <span class="comment">//</span>
01835 <span class="comment">// The stuff below is copied from advapi.  It can be deleted once the path to</span>
01836 <span class="comment">// the site directory gets put in the job object and the job object is made</span>
01837 <span class="comment">// accessible</span>
01838 <span class="comment">//</span>
01839 
01840 
01841 
01842 
01843 PSID
<a name="l01844"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a15">01844</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a0">GetSiteSidFromToken</a>(
01845                     IN HANDLE TokenHandle
01846                     )
01847 {
01848     PTOKEN_GROUPS RestrictedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01849     ULONG ReturnLength;
01850     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01851     PSID psSiteSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01852 
01853 
01854     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01855         TokenHandle,
01856         TokenRestrictedSids,
01857         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01858         0,
01859         &amp;ReturnLength
01860         );
01861     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL)
01862     {
01863         <span class="comment">//BaseSetLastNTError(Status);</span>
01864         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01865     }
01866 
01867     RestrictedSids = (PTOKEN_GROUPS) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, ReturnLength);
01868     <span class="keywordflow">if</span> (RestrictedSids == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01869     {
01870 <span class="comment">//        SetLastError(ERROR_OUTOFMEMORY);</span>
01871         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01872     }
01873 
01874     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
01875         TokenHandle,
01876         TokenRestrictedSids,
01877         RestrictedSids,
01878         ReturnLength,
01879         &amp;ReturnLength
01880         );
01881     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01882     {
01883         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
01884         SID_IDENTIFIER_AUTHORITY InternetSiteAuthority = SECURITY_INTERNETSITE_AUTHORITY;
01885 
01886         <span class="keywordflow">for</span> (i = 0; i &lt; RestrictedSids-&gt;GroupCount; i++) {
01887 
01888             <span class="keywordflow">if</span> (RtlCompareMemory((PVOID) &amp;((SID *) RestrictedSids-&gt;Groups[i].Sid)-&gt;IdentifierAuthority,
01889                 (PVOID) &amp;InternetSiteAuthority,
01890                 <span class="keyword">sizeof</span>(SID_IDENTIFIER_AUTHORITY)) == <span class="keyword">sizeof</span>(SID_IDENTIFIER_AUTHORITY))
01891             {
01892                 psSiteSid = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>((RestrictedSids-&gt;Groups[i]).Sid));
01893                 <span class="keywordflow">if</span> (psSiteSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01894 <span class="comment">//                    SetLastError(ERROR_OUTOFMEMORY);</span>
01895                 }
01896                 <span class="keywordflow">else</span> {
01897                     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>((RestrictedSids-&gt;Groups[i]).Sid), psSiteSid, (RestrictedSids-&gt;Groups[i]).Sid);
01898                 }
01899 
01900                 <span class="keywordflow">break</span>;
01901             }
01902 
01903         }
01904     }
01905     <span class="keywordflow">else</span>
01906     {
01907         <span class="comment">//BaseSetLastNTError(Status);</span>
01908     }
01909 
01910     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedSids);
01911     <span class="keywordflow">return</span> psSiteSid;
01912 }
01913 
01914 HRESULT
<a name="l01915"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a14">01915</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a1">GetMangledSiteSid</a>(PSID pSid, ULONG cchMangledSite, LPWSTR *ppwszMangledSite)
01916 {
01917     <span class="keywordflow">if</span> (cchMangledSite &lt; MAX_MANGLED_SITE)
01918     {
01919 <span class="comment">/*        *ppwszMangledSite = (WCHAR *) LocalAlloc(</span>
01920 <span class="comment">                                            0,</span>
01921 <span class="comment">                                            MAX_MANGLED_SITE * sizeof(WCHAR));*/</span>
01922 <span class="comment">//        if (NULL == *ppwszMangledSite)</span>
01923             <span class="keywordflow">return</span> E_OUTOFMEMORY;
01924     }
01925 
01926     <span class="comment">// The value of MAX_MANGLED_SITE assumes 4 dwords</span>
01927     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(4 == *<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>(pSid));
01928 
01929     <a class="code" href="../../d6/d9/restrfil_8c.html#a13">Base32Encode</a>(
01930             <a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(pSid, 0),
01931             *<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>(pSid) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>),
01932             *ppwszMangledSite);
01933 
01934     <span class="comment">// The output string should always be MAX_MANGLED_SITE - 1 chars long</span>
01935     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(MAX_MANGLED_SITE - 1 == wcslen(*ppwszMangledSite));
01936 
01937     <span class="keywordflow">return</span> S_OK;
01938 }
01939 
01940 <span class="comment">//+----------------------------------------------------------------------------</span>
01941 <span class="comment">//</span>
01942 <span class="comment">//  Function:   Base32Encode</span>
01943 <span class="comment">//</span>
01944 <span class="comment">//  Synopsis:   Convert the given data to base32</span>
01945 <span class="comment">//</span>
01946 <span class="comment">//  Notes:      Adapted from Mim64Encode in the mshtml project.</span>
01947 <span class="comment">//</span>
01948 <span class="comment">//              For 128 bit input (4 DWORDs) the output string will be</span>
01949 <span class="comment">//              27 chars long (including the null terminator)</span>
01950 <span class="comment">//</span>
01951 <span class="comment">//-----------------------------------------------------------------------------</span>
01952 
<a name="l01953"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a13">01953</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d9/restrfil_8c.html#a13">Base32Encode</a>(LPVOID pvData, UINT cbData, LPWSTR pchData)
01954 {
01955     <span class="keyword">static</span> <span class="keyword">const</span> WCHAR alphabet[32] =
01956         { <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'b'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'c'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'d'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'f'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'g'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'h'</span>,
01957           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'i'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'j'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'k'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'l'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'m'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'n'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'o'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'p'</span>,
01958           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'q'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'r'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'s'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'u'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'v'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'w'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'x'</span>,
01959           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'y'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'z'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'1'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'2'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'3'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'4'</span>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'5'</span> };
01960 
01961     <span class="keywordtype">int</span>   shift = 0;    <span class="comment">// The # of unprocessed bits in accum</span>
01962     ULONG accum = 0;    <span class="comment">// The unprocessed bits</span>
01963     ULONG value;
01964     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *pData = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *) pvData;
01965 
01966     <span class="comment">// For each byte...</span>
01967 
01968     <span class="keywordflow">while</span> (cbData)
01969     {
01970         <span class="comment">// Move the byte into the low bits of the accumulator</span>
01971 
01972         accum = (accum &lt;&lt; 8) | *pData++;
01973         shift += 8;
01974         --cbData;
01975 
01976         <span class="comment">// Lop off the high 5 or 10 bits and write them out</span>
01977 
01978         <span class="keywordflow">while</span> ( shift &gt;= 5 )
01979         {
01980             shift -= 5;
01981             value = (accum &gt;&gt; shift) &amp; 0x1Fl;
01982 
01983             *pchData++ = alphabet[value];
01984         }
01985     }
01986 
01987     <span class="comment">// If there are any remaining bits, push out one more char padded with 0's</span>
01988 
01989     <span class="keywordflow">if</span> (shift)
01990     {
01991         value = (accum &lt;&lt; (5 - shift)) &amp; 0x1Fl;
01992 
01993         *pchData++ = alphabet[value];
01994     }
01995 
01996     *pchData = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01997 }
01998 
01999 
02000 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02001"></a><a class="code" href="../../d6/d9/restrfil_8c.html#a16">02001</a> <a class="code" href="../../d6/d9/restrfil_8c.html#a2">IsTokenRestricted</a>(
02002     IN HANDLE TokenHandle
02003     )
02004 {
02005     PTOKEN_GROUPS RestrictedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02006     ULONG ReturnLength;
02007     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02008     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02009 
02010 
02011     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02012                 TokenHandle,
02013                 TokenRestrictedSids,
02014                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02015                 0,
02016                 &amp;ReturnLength
02017                 );
02018     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL)
02019     {
02020 <span class="comment">//        BaseSetLastNTError(Status);</span>
02021         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02022     }
02023 
02024     RestrictedSids = (PTOKEN_GROUPS) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, ReturnLength);
02025     <span class="keywordflow">if</span> (RestrictedSids == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02026     {
02027 <span class="comment">//        SetLastError(ERROR_OUTOFMEMORY);</span>
02028         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02029     }
02030 
02031     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
02032                 TokenHandle,
02033                 TokenRestrictedSids,
02034                 RestrictedSids,
02035                 ReturnLength,
02036                 &amp;ReturnLength
02037                 );
02038     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
02039     {
02040         <span class="keywordflow">if</span> (RestrictedSids-&gt;GroupCount != 0)
02041         {
02042             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02043         }
02044     }
02045     <span class="keywordflow">else</span>
02046     {
02047 <span class="comment">//        BaseSetLastNTError(Status);</span>
02048     }
02049     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, RestrictedSids);
02050     <span class="keywordflow">return</span>(Result);
02051 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
