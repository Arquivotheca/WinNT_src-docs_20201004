<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kernlini.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kernlini.c</h1><a href="../../d6/d9/kernlini_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    kernlini.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code to initialize the kernel data structures</span>
00012 <span class="comment">    and to initialize the idle thread, its process, and the processor control</span>
00013 <span class="comment">    block.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    For the i386, it also contains code to initialize the PCR.</span>
00016 <span class="comment"></span>
00017 <span class="comment">Author:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    David N. Cutler (davec) 21-Apr-1989</span>
00020 <span class="comment"></span>
00021 <span class="comment">Environment:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Kernel mode only.</span>
00024 <span class="comment"></span>
00025 <span class="comment">Revision History:</span>
00026 <span class="comment"></span>
00027 <span class="comment">    24-Jan-1990  shielin</span>
00028 <span class="comment"></span>
00029 <span class="comment">                 Changed for NT386</span>
00030 <span class="comment"></span>
00031 <span class="comment">    20-Mar-1990     bryanwi</span>
00032 <span class="comment"></span>
00033 <span class="comment">                Added KiInitializePcr</span>
00034 <span class="comment"></span>
00035 <span class="comment">--*/</span>
00036 
00037 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="../../d1/d0/ki386_8h.html">ki386.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="../../d4/d1/fastsys_8inc.html">fastsys.inc</a>"</span>
00040 
<a name="l00041"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a0">00041</a> <span class="preprocessor">#define TRAP332_GATE 0xEF00</span>
00042 <span class="preprocessor"></span>
00043 <span class="comment">//</span>
00044 <span class="comment">// External data.</span>
00045 <span class="comment">//</span>
00046 
<a name="l00047"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a8">00047</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d5/d2/cachedat_8c.html#a0">CcMasterSpinLock</a>;
<a name="l00048"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a9">00048</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d5/d2/cachedat_8c.html#a18">CcVacbSpinLock</a>;
<a name="l00049"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a10">00049</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d7/d2/alpha_2initkr_8c.html#a2">MmPfnLock</a>;
<a name="l00050"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a11">00050</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a>;
00051 
00052 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00053 <a class="code" href="../../d6/d9/kernlini_8c.html#a33">KiSetProcessorType</a>(
00054     VOID
00055     );
00056 
00057 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00058 <a class="code" href="../../d6/d9/kernlini_8c.html#a34">KiSetCR0Bits</a>(
00059     VOID
00060     );
00061 
00062 BOOLEAN
00063 <a class="code" href="../../d6/d9/kernlini_8c.html#a35">KiIsNpxPresent</a>(
00064     VOID
00065     );
00066 
00067 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00068 <a class="code" href="../../d6/d9/kernlini_8c.html#a36">KiI386PentiumLockErrataFixup</a> (
00069     VOID
00070     );
00071 
00072 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00073 <a class="code" href="../../d6/d9/kernlini_8c.html#a37">KiInitializeDblFaultTSS</a>(
00074     IN PKTSS Tss,
00075     IN ULONG Stack,
00076     IN PKGDTENTRY TssDescriptor
00077     );
00078 
00079 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00080 <a class="code" href="../../d6/d9/kernlini_8c.html#a38">KiInitializeTSS2</a> (
00081     IN PKTSS Tss,
00082     IN PKGDTENTRY TssDescriptor
00083     );
00084 
00085 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00086 <a class="code" href="../../d6/d9/kernlini_8c.html#a59">KiSwapIDT</a> (
00087     VOID
00088     );
00089 
00090 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00091 <a class="code" href="../../d6/d9/kernlini_8c.html#a40">KeSetup80387OrEmulate</a> (
00092     IN PVOID *R3EmulatorTable
00093     );
00094 
00095 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00096 <a class="code" href="../../d6/d9/kernlini_8c.html#a41">KiGetCacheInformation</a>(
00097     VOID
00098     );
00099 
00100 ULONG
00101 <a class="code" href="../../d6/d9/kernlini_8c.html#a42">KiGetCpuVendor</a>(
00102     VOID
00103     );
00104 
00105 ULONG
00106 <a class="code" href="../../d6/d9/kernlini_8c.html#a43">KiGetFeatureBits</a> (
00107     VOID
00108     );
00109 
00110 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00111 <a class="code" href="../../d6/d9/kernlini_8c.html#a44">KiMoveRegTree</a>(
00112     HANDLE  Source,
00113     HANDLE  Dest
00114     );
00115 
00116 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00117 <a class="code" href="../../d6/d9/kernlini_8c.html#a45">Ki386EnableFxsr</a> (
00118     IN <span class="keyword">volatile</span> PLONG Number
00119     );
00120 
00121 
00122 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00123 <a class="code" href="../../d6/d9/kernlini_8c.html#a46">Ki386EnableXMMIExceptions</a> (
00124     IN <span class="keyword">volatile</span> PLONG Number
00125     );
00126 
00127 
00128 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00129 <a class="code" href="../../d6/d9/kernlini_8c.html#a47">Ki386EnableGlobalPage</a> (
00130     IN <span class="keyword">volatile</span> PLONG Number
00131     );
00132 
00133 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00134 <a class="code" href="../../d6/d9/kernlini_8c.html#a48">Ki386UseSynchronousTbFlush</a> (
00135     IN <span class="keyword">volatile</span> PLONG Number
00136     );
00137 
00138 BOOLEAN
00139 <a class="code" href="../../d0/d0/ki_8h.html#a120">KiInitMachineDependent</a> (
00140     VOID
00141     );
00142 
00143 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00144 <a class="code" href="../../d8/d4/mtrr_8c.html#a16">KiInitializeMTRR</a> (
00145     IN BOOLEAN LastProcessor
00146     );
00147 
00148 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00149 <a class="code" href="../../d9/d3/pat_8c.html#a4">KiInitializePAT</a> (
00150     VOID
00151     );
00152 
00153 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00154 <a class="code" href="../../d0/d5/mtrramd_8c.html#a24">KiAmdK6InitializeMTRR</a>(
00155     VOID
00156     );
00157 
00158 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00159 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiInitializeKernel)</span>
00160 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiInitializePcr)</span>
00161 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiInitializeDblFaultTSS)</span>
00162 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiInitializeTSS2)</span>
00163 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiSwapIDT)</span>
00164 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KeSetup80387OrEmulate)</span>
00165 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiGetFeatureBits)</span>
00166 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiGetCacheInformation)</span>
00167 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiGetCpuVendor)</span>
00168 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiMoveRegTree)</span>
00169 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiInitMachineDependent)</span>
00170 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,KiI386PentiumLockErrataFixup)</span>
00171 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00172 <span class="preprocessor"></span>
<a name="l00173"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a12">00173</a> BOOLEAN <a class="code" href="../../d6/d9/kernlini_8c.html#a12">KiI386PentiumLockErrataPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00174"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a13">00174</a> BOOLEAN <a class="code" href="../../d6/d9/kernlini_8c.html#a13">KiIgnoreUnexpectedTrap07</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00175 
00176 
00177 <span class="preprocessor">#if 0</span>
00178 <span class="preprocessor"></span>PVOID KiTrap08;
00179 <span class="preprocessor">#endif</span>
00180 <span class="preprocessor"></span>
<a name="l00181"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a14">00181</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d7/d3/i386init_8c.html#a7">Ki387RoundModeTable</a>;
<a name="l00182"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a15">00182</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d3/d1/biosc_8c.html#a7">Ki386IopmSaveArea</a>;
<a name="l00183"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a16">00183</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d7/d3/i386init_8c.html#a4">KeI386ForceNpxEmulation</a>;
<a name="l00184"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a17">00184</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d2/d2/i386_2initdat_8c.html#a11">CmDisabledFloatingPointProcessor</a>[];
<a name="l00185"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a18">00185</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a28">CmpCyrixID</a>[];
<a name="l00186"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a19">00186</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a29">CmpIntelID</a>[];
<a name="l00187"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a20">00187</a> <span class="keyword">extern</span> UCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a30">CmpAmdID</a>[];
00188 
00189 <span class="preprocessor">#ifndef NT_UP</span>
<a name="l00190"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a21">00190</a> <span class="preprocessor"></span><span class="keyword">extern</span> PVOID <a class="code" href="../../d6/d9/kernlini_8c.html#a21">ScPatchFxb</a>;
<a name="l00191"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a22">00191</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d6/d9/kernlini_8c.html#a22">ScPatchFxe</a>;
00192 <span class="preprocessor">#endif</span>
00193 <span class="preprocessor"></span>
<a name="l00194"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a61">00194</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
00195     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>,
00196     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>,
00197     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>,
00198     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a31">CPU_CYRIX</a>,
00199     <a class="code" href="../../d6/d9/kernlini_8c.html#a61a32">CPU_UNKNOWN</a>
00200 } <a class="code" href="../../d6/d9/kernlini_8c.html#a61">CPU_VENDORS</a>;
00201 
00202 
00203 <span class="comment">//</span>
00204 <span class="comment">// If this processor does XMMI, take advantage of it.  Default is</span>
00205 <span class="comment">// no XMMI.</span>
00206 <span class="comment">//</span>
00207 
<a name="l00208"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a23">00208</a> BOOLEAN <a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a>;
00209 
00210 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00211 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00212 <a class="code" href="../../d6/d9/kernlini_8c.html#a53">KiZeroPage</a> (
00213     PVOID PageBase
00214     );
00215 
00216 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00217 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00218 <a class="code" href="../../d6/d9/kernlini_8c.html#a54">KiXMMIZeroPage</a> (
00219     PVOID PageBase
00220     );
00221 
00222 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00223 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
00224 <a class="code" href="../../d6/d9/kernlini_8c.html#a55">KiXMMIZeroPageNoSave</a> (
00225     PVOID PageBase
00226     );
00227 
<a name="l00228"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a24">00228</a> KE_ZERO_PAGE_ROUTINE <a class="code" href="../../d6/d9/kernlini_8c.html#a24">KeZeroPage</a> = <a class="code" href="../../d6/d9/kernlini_8c.html#a53">KiZeroPage</a>;
<a name="l00229"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a25">00229</a> KE_ZERO_PAGE_ROUTINE <a class="code" href="../../d6/d9/kernlini_8c.html#a25">KeZeroPageFromIdleThread</a> = <a class="code" href="../../d6/d9/kernlini_8c.html#a53">KiZeroPage</a>;
00230 
00231 <span class="comment">//</span>
00232 <span class="comment">// The following spinlock is for compatiblity with 486 systems that don't</span>
00233 <span class="comment">// have a cmpxchg8b instruction and therefore need to synchronize using a</span>
00234 <span class="comment">// spinlock.  NOTE: This spinlock should be initialized on x86 systems.</span>
00235 <span class="comment">//</span>
00236 
<a name="l00237"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a26">00237</a> ULONG <a class="code" href="../../d6/d9/kernlini_8c.html#a26">Ki486CompatibilityLock</a>;
00238 
00239 <span class="comment">//</span>
00240 <span class="comment">// Profile vars</span>
00241 <span class="comment">//</span>
00242 
<a name="l00243"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a27">00243</a> <span class="keyword">extern</span>  KIDTENTRY <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[];
00244 
00245 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00246"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a56">00246</a> <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a11">KiInitializeKernel</a> (
00247     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process,
00248     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
00249     IN PVOID IdleStack,
00250     IN PKPRCB Prcb,
00251     IN CCHAR Number,
00252     <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00253     )
00254 
00255 <span class="comment">/*++</span>
00256 <span class="comment"></span>
00257 <span class="comment">Routine Description:</span>
00258 <span class="comment"></span>
00259 <span class="comment">    This function gains control after the system has been bootstrapped and</span>
00260 <span class="comment">    before the system has been initialized. Its function is to initialize</span>
00261 <span class="comment">    the kernel data structures, initialize the idle thread and process objects,</span>
00262 <span class="comment">    initialize the processor control block, call the executive initialization</span>
00263 <span class="comment">    routine, and then return to the system startup routine. This routine is</span>
00264 <span class="comment">    also called to initialize the processor specific structures when a new</span>
00265 <span class="comment">    processor is brought on line.</span>
00266 <span class="comment"></span>
00267 <span class="comment">Arguments:</span>
00268 <span class="comment"></span>
00269 <span class="comment">    Process - Supplies a pointer to a control object of type process for</span>
00270 <span class="comment">        the specified processor.</span>
00271 <span class="comment"></span>
00272 <span class="comment">    Thread - Supplies a pointer to a dispatcher object of type thread for</span>
00273 <span class="comment">        the specified processor.</span>
00274 <span class="comment"></span>
00275 <span class="comment">    IdleStack - Supplies a pointer the base of the real kernel stack for</span>
00276 <span class="comment">        idle thread on the specified processor.</span>
00277 <span class="comment"></span>
00278 <span class="comment">    Prcb - Supplies a pointer to a processor control block for the specified</span>
00279 <span class="comment">        processor.</span>
00280 <span class="comment"></span>
00281 <span class="comment">    Number - Supplies the number of the processor that is being</span>
00282 <span class="comment">        initialized.</span>
00283 <span class="comment"></span>
00284 <span class="comment">    LoaderBlock - Supplies a pointer to the loader parameter block.</span>
00285 <span class="comment"></span>
00286 <span class="comment">Return Value:</span>
00287 <span class="comment"></span>
00288 <span class="comment">    None.</span>
00289 <span class="comment"></span>
00290 <span class="comment">--*/</span>
00291 
00292 {
00293     LONG  <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00294     ULONG DirectoryTableBase[2];
00295     KIRQL OldIrql;
00296     PKPCR Pcr;
00297     BOOLEAN NpxFlag;
00298     BOOLEAN FxsrPresent;
00299     BOOLEAN XMMIPresent;
00300     ULONG FeatureBits;
00301 
00302     <a class="code" href="../../d6/d9/kernlini_8c.html#a33">KiSetProcessorType</a>();
00303     <a class="code" href="../../d6/d9/kernlini_8c.html#a34">KiSetCR0Bits</a>();
00304     NpxFlag = <a class="code" href="../../d6/d9/kernlini_8c.html#a35">KiIsNpxPresent</a>();
00305 
00306     Pcr = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>();
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// Initialize DPC listhead and lock.</span>
00310     <span class="comment">//</span>
00311 
00312     InitializeListHead(&amp;Prcb-&gt;DpcListHead);
00313     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;Prcb-&gt;DpcLock);
00314     Prcb-&gt;DpcRoutineActive = 0;
00315     Prcb-&gt;DpcQueueDepth = 0;
00316     Prcb-&gt;MaximumDpcQueueDepth = <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
00317     Prcb-&gt;MinimumDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
00318     Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00319     <a class="code" href="../../d1/d2/po_8h.html#a57">PoInitializePrcb</a> (Prcb);
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// Check for unsupported processor revision</span>
00323     <span class="comment">//</span>
00324 
00325     <span class="keywordflow">if</span> (Prcb-&gt;CpuType == 3) {
00326         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(UNSUPPORTED_PROCESSOR,0x386,0,0,0);
00327     }
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">// Get the processor FeatureBits for this processor.</span>
00331     <span class="comment">//</span>
00332 
00333     FeatureBits = <a class="code" href="../../d6/d9/kernlini_8c.html#a43">KiGetFeatureBits</a>();
00334     Prcb-&gt;FeatureBits = FeatureBits;
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Get processor Cache Size information.</span>
00338     <span class="comment">//</span>
00339 
00340     <a class="code" href="../../d6/d9/kernlini_8c.html#a41">KiGetCacheInformation</a>();
00341 
00342     <span class="comment">//</span>
00343     <span class="comment">// initialize the per processor lock queue entry for implemented locks.</span>
00344     <span class="comment">//</span>
00345 
00346 <span class="preprocessor">#if !defined(NT_UP)</span>
00347 <span class="preprocessor"></span>
00348     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a62">LockQueueDispatcherLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00349     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a62">LockQueueDispatcherLock</a>].Lock = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a38">KiDispatcherLock</a>;
00350     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a63">LockQueueContextSwapLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00351     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a63">LockQueueContextSwapLock</a>].Lock = &amp;<a class="code" href="../../d0/d0/ki_8h.html#a40">KiContextSwapLock</a>;
00352     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a64">LockQueuePfnLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00353     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a64">LockQueuePfnLock</a>].Lock = &amp;<a class="code" href="../../d7/d2/alpha_2initkr_8c.html#a2">MmPfnLock</a>;
00354     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a65">LockQueueSystemSpaceLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00355     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a65">LockQueueSystemSpaceLock</a>].Lock = &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a>;
00356     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a67">LockQueueMasterLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00357     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a67">LockQueueMasterLock</a>].Lock = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a0">CcMasterSpinLock</a>;
00358     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a66">LockQueueVacbLock</a>].Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00359     Prcb-&gt;LockQueue[<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a66">LockQueueVacbLock</a>].Lock = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a18">CcVacbSpinLock</a>;
00360 
00361 <span class="preprocessor">#endif</span>
00362 <span class="preprocessor"></span>
00363     <span class="comment">//</span>
00364     <span class="comment">// If the initial processor is being initialized, then initialize the</span>
00365     <span class="comment">// per system data structures.</span>
00366     <span class="comment">//</span>
00367 
00368     <span class="keywordflow">if</span> (Number == 0) {
00369 
00370         <span class="comment">//</span>
00371         <span class="comment">// Initial setting for global Cpu &amp; Stepping levels</span>
00372         <span class="comment">//</span>
00373 
00374         <a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a> = NpxFlag;
00375         <a class="code" href="../../d5/d3/i386_8h.html#a21">KeI386CpuType</a> = Prcb-&gt;CpuType;
00376         <a class="code" href="../../d5/d3/i386_8h.html#a22">KeI386CpuStep</a> = Prcb-&gt;CpuStep;
00377 
00378         <a class="code" href="../../d4/d9/ke_8h.html#a134">KeProcessorArchitecture</a> = PROCESSOR_ARCHITECTURE_INTEL;
00379         <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Prcb-&gt;CpuType;
00380         <span class="keywordflow">if</span> (Prcb-&gt;CpuID == 0) {
00381             <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = 0xFF00 |
00382                                   (((Prcb-&gt;CpuStep &gt;&gt; 4) + 0xa0 ) &amp; 0x0F0) |
00383                                   (Prcb-&gt;CpuStep &amp; 0xf);
00384         } <span class="keywordflow">else</span> {
00385             <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = Prcb-&gt;CpuStep;
00386         }
00387 
00388         <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> = FeatureBits;
00389 
00390         <a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a> = ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00391 
00392         <a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a> = ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00393 
00394         <span class="comment">//</span>
00395         <span class="comment">// If cmpxchg8b was available at boot, verify its still available</span>
00396         <span class="comment">//</span>
00397 
00398         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d3/i386_8h.html#a25">KiBootFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>) &amp;&amp; !(<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>)) {
00399             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>, 0, 0, 0);
00400         }
00401 
00402         <span class="comment">//</span>
00403         <span class="comment">// Lower IRQL to APC level.</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00407 
00408 
00409         <span class="comment">//</span>
00410         <span class="comment">// Initialize kernel internal spinlocks</span>
00411         <span class="comment">//</span>
00412 
00413         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d0/d0/ki_8h.html#a40">KiContextSwapLock</a>);
00414         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a38">KiDispatcherLock</a>);
00415         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a10">KiFreezeExecutionLock</a>);
00416 
00417         <span class="comment">//</span>
00418         <span class="comment">// Initialize 486 compatibility lock</span>
00419         <span class="comment">//</span>
00420 
00421         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d6/d9/kernlini_8c.html#a26">Ki486CompatibilityLock</a>);
00422 
00423 <span class="preprocessor">#if !defined(NT_UP)</span>
00424 <span class="preprocessor"></span>
00425         <span class="comment">//</span>
00426         <span class="comment">// During Text Mode setup, it is possible the system is</span>
00427         <span class="comment">// running with an MP kernel and a UP HAL.  On X86 systems,</span>
00428         <span class="comment">// spinlocks are implemented in both the kernel and the HAL</span>
00429         <span class="comment">// with the verisons that alter IRQL in the HAL.   If the</span>
00430         <span class="comment">// HAL is UP, it will not actually acquire/release locks</span>
00431         <span class="comment">// while the MP kernel will which will cause the system to</span>
00432         <span class="comment">// hang (or crash).   As this can only occur during text</span>
00433         <span class="comment">// mode setup, we will detect the situation and disable </span>
00434         <span class="comment">// the kernel only versions of queued spinlocks if the HAL</span>
00435         <span class="comment">// is UP (and the kernel MP).</span>
00436         <span class="comment">//</span>
00437         <span class="comment">// We need to patch 3 routines, two of them are void and</span>
00438         <span class="comment">// the other returns a boolean (must be true (and ZF must be</span>
00439         <span class="comment">// clear) in a UP case).</span>
00440         <span class="comment">//</span>
00441         <span class="comment">// Determine if the HAL us UP by acquiring the dispatcher</span>
00442         <span class="comment">// lock and examining it to see if the HAL actually did</span>
00443         <span class="comment">// anything to it.</span>
00444         <span class="comment">//</span>
00445 
00446         OldIrql = KfAcquireSpinLock(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a38">KiDispatcherLock</a>);
00447         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/kernldat_8c.html#a38">KiDispatcherLock</a> == 0) {
00448 
00449             <span class="comment">//</span>
00450             <span class="comment">// KfAcquireSpinLock is in the HAL and it did not</span>
00451             <span class="comment">// change the value of the lock.  This is a UP HAL.</span>
00452             <span class="comment">//</span>
00453 
00454             <span class="keyword">extern</span> UCHAR KiTryToAcquireQueuedSpinLockUP;
00455             PUCHAR PatchTarget, PatchSource;
00456             UCHAR Byte;
00457 
00458 <span class="preprocessor">            #define RET 0xc3</span>
00459 <span class="preprocessor"></span>
00460             *(PUCHAR)(KiAcquireQueuedSpinLock) = <a class="code" href="../../d6/d9/kernlini_8c.html#a1">RET</a>;
00461             *(PUCHAR)(KiReleaseQueuedSpinLock) = <a class="code" href="../../d6/d9/kernlini_8c.html#a1">RET</a>;
00462 
00463             <span class="comment">//</span>
00464             <span class="comment">// Copy the UP version of KiTryToAcquireQueuedSpinLock</span>
00465             <span class="comment">// over the top of the MP versin.</span>
00466             <span class="comment">//</span>
00467 
00468             PatchSource = &amp;(KiTryToAcquireQueuedSpinLockUP);
00469             PatchTarget = (PUCHAR)(<a class="code" href="../../d0/d0/ki_8h.html#a85">KiTryToAcquireQueuedSpinLock</a>);
00470 
00471             <span class="keywordflow">do</span> {
00472                 Byte = *PatchSource++;
00473                 *PatchTarget++ = Byte;
00474             } <span class="keywordflow">while</span> (Byte != <a class="code" href="../../d6/d9/kernlini_8c.html#a1">RET</a>);
00475 
00476 <span class="preprocessor">            #undef RET</span>
00477 <span class="preprocessor"></span>        }
00478         <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a38">KiDispatcherLock</a>, OldIrql);
00479 
00480 <span class="preprocessor">#endif</span>
00481 <span class="preprocessor"></span>
00482         <span class="comment">//</span>
00483         <span class="comment">// Performance architecture independent initialization.</span>
00484         <span class="comment">//</span>
00485 
00486         <a class="code" href="../../d2/d0/kiinit_8c.html#a1">KiInitSystem</a>();
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Initialize idle thread process object and then set:</span>
00490         <span class="comment">//</span>
00491         <span class="comment">//      1. all the quantum values to the maximum possible.</span>
00492         <span class="comment">//      2. the process in the balance set.</span>
00493         <span class="comment">//      3. the active processor mask to the specified process.</span>
00494         <span class="comment">//</span>
00495 
00496         DirectoryTableBase[0] = 0;
00497         DirectoryTableBase[1] = 0;
00498         <a class="code" href="../../d3/d5/procobj_8c.html#a3">KeInitializeProcess</a>(Process,
00499                             (KPRIORITY)0,
00500                             (KAFFINITY)(0xffffffff),
00501                             &amp;DirectoryTableBase[0],
00502                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00503 
00504         Process-&gt;ThreadQuantum = MAXCHAR;
00505 
00506     } <span class="keywordflow">else</span> {
00507 
00508         <span class="comment">//</span>
00509         <span class="comment">// Adjust global cpu setting to represent lowest of all processors</span>
00510         <span class="comment">//</span>
00511 
00512         FxsrPresent = ((FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00513         <span class="keywordflow">if</span> (FxsrPresent != <a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a>) {
00514             <span class="comment">//</span>
00515             <span class="comment">// FXSR support must be available on all processors or on none</span>
00516             <span class="comment">//</span>
00517             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>, 0, 0, 0);
00518         }
00519 
00520         XMMIPresent = ((FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00521         <span class="keywordflow">if</span> (XMMIPresent != <a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a>) {
00522             <span class="comment">//</span>
00523             <span class="comment">// XMMI support must be available on all processors or on none</span>
00524             <span class="comment">//</span>
00525             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>, 0, 0, 0);
00526         }
00527 
00528         <span class="keywordflow">if</span> (NpxFlag != <a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
00529             <span class="comment">//</span>
00530             <span class="comment">// NPX support must be available on all processors or on none</span>
00531             <span class="comment">//</span>
00532 
00533             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, 0x387, 0, 0, 0);
00534         }
00535 
00536         <span class="keywordflow">if</span> ((ULONG)(Prcb-&gt;CpuType) != <a class="code" href="../../d5/d3/i386_8h.html#a21">KeI386CpuType</a>) {
00537 
00538             <span class="keywordflow">if</span> ((ULONG)(Prcb-&gt;CpuType) &lt; <a class="code" href="../../d5/d3/i386_8h.html#a21">KeI386CpuType</a>) {
00539 
00540                 <span class="comment">//</span>
00541                 <span class="comment">// What is the lowest CPU type</span>
00542                 <span class="comment">//</span>
00543 
00544                 <a class="code" href="../../d5/d3/i386_8h.html#a21">KeI386CpuType</a> = (ULONG)Prcb-&gt;CpuType;
00545                 <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Prcb-&gt;CpuType;
00546             }
00547         }
00548 
00549         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d3/i386_8h.html#a25">KiBootFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>)  &amp;&amp;  !(FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>)) {
00550             <span class="comment">//</span>
00551             <span class="comment">// cmpxchg8b must be available on all processors, if installed at boot</span>
00552             <span class="comment">//</span>
00553 
00554             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>, 0, 0, 0);
00555         }
00556 
00557         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a4">KF_GLOBAL_PAGE</a>)  &amp;&amp;  !(FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a4">KF_GLOBAL_PAGE</a>)) {
00558             <span class="comment">//</span>
00559             <span class="comment">// Global page support must be available on all processors, if on boot processor</span>
00560             <span class="comment">//</span>
00561 
00562             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, <a class="code" href="../../d5/d3/i386_8h.html#a4">KF_GLOBAL_PAGE</a>, 0, 0, 0);
00563         }
00564 
00565         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>)  &amp;&amp;  !(FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>)) {
00566             <span class="comment">//</span>
00567             <span class="comment">// PAT must be available on all processors, if on boot processor</span>
00568             <span class="comment">//</span>
00569 
00570             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>, 0, 0, 0);
00571         }
00572 
00573         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>)  &amp;&amp;  !(FeatureBits &amp; <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>)) {
00574             <span class="comment">//</span>
00575             <span class="comment">// MTRR must be available on all processors, if on boot processor</span>
00576             <span class="comment">//</span>
00577 
00578             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MULTIPROCESSOR_CONFIGURATION_NOT_SUPPORTED, <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>, 0, 0, 0);
00579         }
00580 
00581         <span class="comment">//</span>
00582         <span class="comment">// Use lowest stepping value</span>
00583         <span class="comment">//</span>
00584 
00585         <span class="keywordflow">if</span> (Prcb-&gt;CpuStep &lt; <a class="code" href="../../d5/d3/i386_8h.html#a22">KeI386CpuStep</a>) {
00586             <a class="code" href="../../d5/d3/i386_8h.html#a22">KeI386CpuStep</a> = Prcb-&gt;CpuStep;
00587             <span class="keywordflow">if</span> (Prcb-&gt;CpuID == 0) {
00588                 <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = 0xFF00 |
00589                                       ((Prcb-&gt;CpuStep &gt;&gt; 8) + <span class="charliteral">'A'</span>) |
00590                                       (Prcb-&gt;CpuStep &amp; 0xf);
00591             } <span class="keywordflow">else</span> {
00592                 <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = Prcb-&gt;CpuStep;
00593             }
00594         }
00595 
00596         <span class="comment">//</span>
00597         <span class="comment">// Use subset of all NT feature bits available on each processor</span>
00598         <span class="comment">//</span>
00599 
00600         <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp;= FeatureBits;
00601 
00602         <span class="comment">//</span>
00603         <span class="comment">// Lower IRQL to DISPATCH level.</span>
00604         <span class="comment">//</span>
00605 
00606         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00607 
00608     }
00609 
00610     <span class="comment">//</span>
00611     <span class="comment">// Update processor features</span>
00612     <span class="comment">//</span>
00613 
00614     SharedUserData-&gt;ProcessorFeatures[PF_MMX_INSTRUCTIONS_AVAILABLE] =
00615         (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a8">KF_MMX</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00616 
00617     SharedUserData-&gt;ProcessorFeatures[PF_COMPARE_EXCHANGE_DOUBLE] =
00618         (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00619 
00620     SharedUserData-&gt;ProcessorFeatures[PF_XMMI_INSTRUCTIONS_AVAILABLE] =
00621         ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>) &amp;&amp; (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>)) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00622 
00623     SharedUserData-&gt;ProcessorFeatures[PF_3DNOW_INSTRUCTIONS_AVAILABLE] =
00624         (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a14">KF_3DNOW</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00625 
00626     SharedUserData-&gt;ProcessorFeatures[PF_RDTSC_INSTRUCTION_AVAILABLE] =
00627         (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a1">KF_RDTSC</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00628     <span class="comment">//</span>
00629     <span class="comment">// Initialize idle thread object and then set:</span>
00630     <span class="comment">//</span>
00631     <span class="comment">//      1. the initial kernel stack to the specified idle stack.</span>
00632     <span class="comment">//      2. the next processor number to the specified processor.</span>
00633     <span class="comment">//      3. the thread priority to the highest possible value.</span>
00634     <span class="comment">//      4. the state of the thread to running.</span>
00635     <span class="comment">//      5. the thread affinity to the specified processor.</span>
00636     <span class="comment">//      6. the specified processor member in the process active processors</span>
00637     <span class="comment">//          set.</span>
00638     <span class="comment">//</span>
00639 
00640     <a class="code" href="../../d9/d1/thredobj_8c.html#a1">KeInitializeThread</a>(Thread, (PVOID)((ULONG)IdleStack),
00641                        (<a class="code" href="../../d4/d9/ke_8h.html#a67">PKSYSTEM_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (<a class="code" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00642                        (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PCONTEXT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Process);
00643     Thread-&gt;NextProcessor = Number;
00644     Thread-&gt;Priority = HIGH_PRIORITY;
00645     Thread-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a>;
00646     Thread-&gt;Affinity = (KAFFINITY)(1&lt;&lt;Number);
00647     Thread-&gt;WaitIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>;
00648     <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, Process-&gt;ActiveProcessors);
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Initialize the processor block. (Note that some fields have been</span>
00652     <span class="comment">// initialized at KiInitializePcr().</span>
00653     <span class="comment">//</span>
00654 
00655     Prcb-&gt;CurrentThread = Thread;
00656     Prcb-&gt;NextThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00657     Prcb-&gt;IdleThread = Thread;
00658     Pcr-&gt;NtTib.StackBase = Thread-&gt;InitialStack;
00659 
00660     <span class="comment">//</span>
00661     <span class="comment">// call the executive initialization routine.</span>
00662     <span class="comment">//</span>
00663 
00664     <span class="keywordflow">try</span> {
00665         <a class="code" href="../../d0/d0/ki_8h.html#a86">ExpInitializeExecutive</a>(Number, LoaderBlock);
00666 
00667     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00668         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a> (PHASE0_EXCEPTION);
00669     }
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">// If the initial processor is being initialized, then compute the</span>
00673     <span class="comment">// timer table reciprocal value and reset the PRCB values for the</span>
00674     <span class="comment">// controllable DPC behavior in order to reflect any registry</span>
00675     <span class="comment">// overrides.</span>
00676     <span class="comment">//</span>
00677 
00678     <span class="keywordflow">if</span> (Number == 0) {
00679         <a class="code" href="../../d5/d9/kernldat_8c.html#a59">KiTimeIncrementReciprocal</a> = <a class="code" href="../../d2/d0/kiinit_8c.html#a2">KiComputeReciprocal</a>((LONG)<a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>,
00680                                                         &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a60">KiTimeIncrementShiftCount</a>);
00681 
00682         Prcb-&gt;MaximumDpcQueueDepth = <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
00683         Prcb-&gt;MinimumDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
00684         Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00685     }
00686 
00687     <span class="keywordflow">if</span> (Number == 0) {
00688 
00689         <span class="comment">//</span>
00690         <span class="comment">// Processor 0's DPC stack was temporarily allocated on</span>
00691         <span class="comment">// the Double Fault Stack, switch to a proper kernel </span>
00692         <span class="comment">// stack now.</span>
00693         <span class="comment">//</span>
00694 
00695         PVOID DpcStack;
00696 
00697         DpcStack = <a class="code" href="../../d4/d5/procsup_8c.html#a33">MmCreateKernelStack</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00698 
00699         <span class="keywordflow">if</span> (DpcStack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00700             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(NO_PAGES_AVAILABLE, 1, 0, 0, 0);
00701         }
00702         Prcb-&gt;DpcStack = DpcStack;
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// Allocate 8k IOPM bit map saved area to allow BiosCall swap</span>
00706         <span class="comment">// bit maps.</span>
00707         <span class="comment">//</span>
00708 
00709         <a class="code" href="../../d3/d1/biosc_8c.html#a7">Ki386IopmSaveArea</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00710                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 2,
00711                                                   '  eK');
00712         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/biosc_8c.html#a7">Ki386IopmSaveArea</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00713             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(NO_PAGES_AVAILABLE, 2, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 2, 0, 0);
00714         }
00715     }
00716 
00717     <span class="comment">//</span>
00718     <span class="comment">// Set the priority of the specified idle thread to zero, set appropriate</span>
00719     <span class="comment">// member in KiIdleSummary and return to the system start up routine.</span>
00720     <span class="comment">//</span>
00721 
00722     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>, &amp;OldIrql);
00723     <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(Thread, (KPRIORITY)0);
00724 
00725     <span class="comment">//</span>
00726     <span class="comment">// if a thread has not been selected to run on the current processors,</span>
00727     <span class="comment">// check to see if there are any ready threads; otherwise add this</span>
00728     <span class="comment">// processors to the IdleSummary</span>
00729     <span class="comment">//</span>
00730 
00731     KiAcquireQueuedSpinLock(<a class="code" href="../../d0/d0/ki_8h.html#a13">KiQueuedSpinLockContext</a>(<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a62">LockQueueDispatcherLock</a>));
00732     <span class="keywordflow">if</span> (Prcb-&gt;NextThread == (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00733         <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, <a class="code" href="../../d5/d9/kernldat_8c.html#a1">KiIdleSummary</a>);
00734     }
00735     KiReleaseQueuedSpinLock(<a class="code" href="../../d0/d0/ki_8h.html#a13">KiQueuedSpinLockContext</a>(<a class="code" href="../../d0/d9/ntosdef_8h.html#a75a62">LockQueueDispatcherLock</a>));
00736 
00737     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;OldIrql);
00738 
00739     <span class="comment">//</span>
00740     <span class="comment">// This processor has initialized</span>
00741     <span class="comment">//</span>
00742 
00743     LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o4">Prcb</a> = (ULONG)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00744 
00745     <span class="keywordflow">return</span>;
00746 }
00747 
00748 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00749"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a57">00749</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a57">KiInitializePcr</a> (
00750     IN ULONG Processor,
00751     IN PKPCR    Pcr,
00752     IN PKIDTENTRY Idt,
00753     IN PKGDTENTRY Gdt,
00754     IN PKTSS Tss,
00755     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
00756     IN PVOID DpcStack
00757     )
00758 
00759 <span class="comment">/*++</span>
00760 <span class="comment"></span>
00761 <span class="comment">Routine Description:</span>
00762 <span class="comment"></span>
00763 <span class="comment">    This function is called to initialize the PCR for a processor.  It</span>
00764 <span class="comment">    simply stuffs values into the PCR.  (The PCR is not inited statically</span>
00765 <span class="comment">    because the number varies with the number of processors.)</span>
00766 <span class="comment"></span>
00767 <span class="comment">    Note that each processor has its own IDT, GDT, and TSS as well as PCR!</span>
00768 <span class="comment"></span>
00769 <span class="comment">Arguments:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    Processor - Processor whose PCR to initialize.</span>
00772 <span class="comment"></span>
00773 <span class="comment">    Pcr - Linear address of PCR.</span>
00774 <span class="comment"></span>
00775 <span class="comment">    Idt - Linear address of i386 IDT.</span>
00776 <span class="comment"></span>
00777 <span class="comment">    Gdt - Linear address of i386 GDT.</span>
00778 <span class="comment"></span>
00779 <span class="comment">    Tss - Linear address (NOT SELECTOR!) of the i386 TSS.</span>
00780 <span class="comment"></span>
00781 <span class="comment">    Thread - Dummy thread object to use very early on.</span>
00782 <span class="comment"></span>
00783 <span class="comment">Return Value:</span>
00784 <span class="comment"></span>
00785 <span class="comment">    None.</span>
00786 <span class="comment"></span>
00787 <span class="comment">--*/</span>
00788 {
00789     <span class="comment">// set version values</span>
00790 
00791     Pcr-&gt;MajorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a114">PCR_MAJOR_VERSION</a>;
00792     Pcr-&gt;MinorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a113">PCR_MINOR_VERSION</a>;
00793 
00794     Pcr-&gt;PrcbData.MajorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a102">PRCB_MAJOR_VERSION</a>;
00795     Pcr-&gt;PrcbData.MinorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a101">PRCB_MINOR_VERSION</a>;
00796 
00797     Pcr-&gt;PrcbData.BuildType = 0;
00798 
00799 <span class="preprocessor">#if DBG</span>
00800 <span class="preprocessor"></span>    Pcr-&gt;PrcbData.BuildType |= PRCB_BUILD_DEBUG;
00801 <span class="preprocessor">#endif</span>
00802 <span class="preprocessor"></span>
00803 <span class="preprocessor">#ifdef NT_UP</span>
00804 <span class="preprocessor"></span>    Pcr-&gt;PrcbData.BuildType |= PRCB_BUILD_UNIPROCESSOR;
00805 <span class="preprocessor">#endif</span>
00806 <span class="preprocessor"></span>
00807 <span class="preprocessor">#if defined (_X86PAE_)</span>
00808 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Processor == 0) {
00809         <span class="comment">//</span>
00810         <span class="comment">//  PAE feature must be initialized prior to the first HAL call.</span>
00811         <span class="comment">//</span>
00812     
00813         SharedUserData-&gt;ProcessorFeatures[PF_PAE_ENABLED] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00814     }
00815 <span class="preprocessor">#endif</span>
00816 <span class="preprocessor"></span>
00817     <span class="comment">//  Basic addressing fields</span>
00818 
00819     Pcr-&gt;SelfPcr = Pcr;
00820     Pcr-&gt;Prcb = &amp;(Pcr-&gt;PrcbData);
00821 
00822     <span class="comment">//  Thread control fields</span>
00823 
00824     Pcr-&gt;NtTib.ExceptionList = EXCEPTION_CHAIN_END;
00825     Pcr-&gt;NtTib.StackBase = 0;
00826     Pcr-&gt;NtTib.StackLimit = 0;
00827     Pcr-&gt;NtTib.Self = 0;
00828 
00829     Pcr-&gt;PrcbData.CurrentThread = Thread;
00830 
00831     <span class="comment">//</span>
00832     <span class="comment">// Init Prcb.Number and ProcessorBlock such that Ipi will work</span>
00833     <span class="comment">// as early as possible.</span>
00834     <span class="comment">//</span>
00835 
00836     Pcr-&gt;PrcbData.Number = (UCHAR)Processor;
00837     Pcr-&gt;PrcbData.SetMember = 1 &lt;&lt; Processor;
00838     <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Processor] = Pcr-&gt;Prcb;
00839 
00840     Pcr-&gt;Irql = 0;
00841 
00842     <span class="comment">//  Machine structure addresses</span>
00843 
00844     Pcr-&gt;GDT = Gdt;
00845     Pcr-&gt;IDT = Idt;
00846     Pcr-&gt;TSS = Tss;
00847     Pcr-&gt;PrcbData.DpcStack = DpcStack;
00848 
00849     <span class="keywordflow">return</span>;
00850 }
00851 
00852 <span class="preprocessor">#if 0</span>
00853 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00854 <a class="code" href="../../d6/d9/kernlini_8c.html#a37">KiInitializeDblFaultTSS</a>(
00855     IN PKTSS Tss,
00856     IN ULONG Stack,
00857     IN PKGDTENTRY TssDescriptor
00858     )
00859 
00860 <span class="comment">/*++</span>
00861 <span class="comment"></span>
00862 <span class="comment">Routine Description:</span>
00863 <span class="comment"></span>
00864 <span class="comment">    This function is called to initialize the double-fault TSS for a</span>
00865 <span class="comment">    processor.  It will set the static fields of the TSS to point to</span>
00866 <span class="comment">    the double-fault handler and the appropriate double-fault stack.</span>
00867 <span class="comment"></span>
00868 <span class="comment">    Note that the IOPM for the double-fault TSS grants access to all</span>
00869 <span class="comment">    ports.  This is so the standard HAL's V86-mode callback to reset</span>
00870 <span class="comment">    the display to text mode will work.</span>
00871 <span class="comment"></span>
00872 <span class="comment">Arguments:</span>
00873 <span class="comment"></span>
00874 <span class="comment">    Tss - Supplies a pointer to the double-fault TSS</span>
00875 <span class="comment"></span>
00876 <span class="comment">    Stack - Supplies a pointer to the double-fault stack.</span>
00877 <span class="comment"></span>
00878 <span class="comment">    TssDescriptor - Linear address of the descriptor for the TSS.</span>
00879 <span class="comment"></span>
00880 <span class="comment">Return Value:</span>
00881 <span class="comment"></span>
00882 <span class="comment">    None.</span>
00883 <span class="comment"></span>
00884 <span class="comment">--*/</span>
00885 
00886 {
00887     PUCHAR  p;
00888     ULONG   i;
00889     ULONG   j;
00890 
00891     <span class="comment">//</span>
00892     <span class="comment">// Set limit for TSS</span>
00893     <span class="comment">//</span>
00894 
00895     <span class="keywordflow">if</span> (TssDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00896         TssDescriptor-&gt;LimitLow = <span class="keyword">sizeof</span>(KTSS) - 1;
00897         TssDescriptor-&gt;HighWord.Bits.LimitHi = 0;
00898     }
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Initialize IOPMs</span>
00902     <span class="comment">//</span>
00903 
00904     <span class="keywordflow">for</span> (i = 0; i &lt; IOPM_COUNT; i++) {
00905             p = (PUCHAR)(Tss-&gt;IoMaps[i]);
00906 
00907         <span class="keywordflow">for</span> (j = 0; j &lt; PIOPM_SIZE; j++) {
00908             p[j] = 0;
00909         }
00910     }
00911 
00912     <span class="comment">//  Set IO Map base address to indicate no IO map present.</span>
00913 
00914     <span class="comment">// N.B. -1 does not seem to be a valid value for the map base.  If this</span>
00915     <span class="comment">//      value is used, byte immediate in's and out's will actually go</span>
00916     <span class="comment">//      the hardware when executed in V86 mode.</span>
00917 
00918     Tss-&gt;IoMapBase = KiComputeIopmOffset(IO_ACCESS_MAP_NONE);
00919 
00920     <span class="comment">//  Set flags to 0, which in particular disables traps on task switches.</span>
00921 
00922     Tss-&gt;Flags = 0;
00923 
00924 
00925     <span class="comment">//  Set LDT and Ss0 to constants used by NT.</span>
00926 
00927     Tss-&gt;LDT  = 0;
00928     Tss-&gt;Ss0  = KGDT_R0_DATA;
00929     Tss-&gt;Esp0 = Stack;
00930     Tss-&gt;Eip  = (ULONG)KiTrap08;
00931     Tss-&gt;Cs   = KGDT_R0_CODE || RPL_MASK;
00932     Tss-&gt;Ds   = KGDT_R0_DATA;
00933     Tss-&gt;Es   = KGDT_R0_DATA;
00934     Tss-&gt;Fs   = KGDT_R0_DATA;
00935 
00936 
00937     <span class="keywordflow">return</span>;
00938 
00939 }
00940 <span class="preprocessor">#endif</span>
00941 <span class="preprocessor"></span>
00942 
00943 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00944"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a58">00944</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a58">KiInitializeTSS</a> (
00945     IN PKTSS Tss
00946     )
00947 
00948 <span class="comment">/*++</span>
00949 <span class="comment"></span>
00950 <span class="comment">Routine Description:</span>
00951 <span class="comment"></span>
00952 <span class="comment">    This function is called to initialize the TSS for a processor.</span>
00953 <span class="comment">    It will set the static fields of the TSS.  (ie Those fields that</span>
00954 <span class="comment">    the part reads, and for which NT uses constant values.)</span>
00955 <span class="comment"></span>
00956 <span class="comment">    The dynamic fields (Esp0 and CR3) are set in the context swap</span>
00957 <span class="comment">    code.</span>
00958 <span class="comment"></span>
00959 <span class="comment">Arguments:</span>
00960 <span class="comment"></span>
00961 <span class="comment">    Tss - Linear address of the Task State Segment.</span>
00962 <span class="comment"></span>
00963 <span class="comment">Return Value:</span>
00964 <span class="comment"></span>
00965 <span class="comment">    None.</span>
00966 <span class="comment"></span>
00967 <span class="comment">--*/</span>
00968 {
00969 
00970     <span class="comment">//  Set IO Map base address to indicate no IO map present.</span>
00971 
00972     <span class="comment">// N.B. -1 does not seem to be a valid value for the map base.  If this</span>
00973     <span class="comment">//      value is used, byte immediate in's and out's will actually go</span>
00974     <span class="comment">//      the hardware when executed in V86 mode.</span>
00975 
00976     Tss-&gt;IoMapBase = KiComputeIopmOffset(IO_ACCESS_MAP_NONE);
00977 
00978     <span class="comment">//  Set flags to 0, which in particular disables traps on task switches.</span>
00979 
00980     Tss-&gt;Flags = 0;
00981 
00982 
00983     <span class="comment">//  Set LDT and Ss0 to constants used by NT.</span>
00984 
00985     Tss-&gt;LDT = 0;
00986     Tss-&gt;Ss0 = KGDT_R0_DATA;
00987 
00988     <span class="keywordflow">return</span>;
00989 }
00990 
00991 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00992"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a38">00992</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a38">KiInitializeTSS2</a> (
00993     IN PKTSS Tss,
00994     IN PKGDTENTRY TssDescriptor
00995     )
00996 
00997 <span class="comment">/*++</span>
00998 <span class="comment"></span>
00999 <span class="comment">Routine Description:</span>
01000 <span class="comment"></span>
01001 <span class="comment">    Do part of TSS init we do only once.</span>
01002 <span class="comment"></span>
01003 <span class="comment">Arguments:</span>
01004 <span class="comment"></span>
01005 <span class="comment">    Tss - Linear address of the Task State Segment.</span>
01006 <span class="comment"></span>
01007 <span class="comment">    TssDescriptor - Linear address of the descriptor for the TSS.</span>
01008 <span class="comment"></span>
01009 <span class="comment">Return Value:</span>
01010 <span class="comment"></span>
01011 <span class="comment">    None.</span>
01012 <span class="comment"></span>
01013 <span class="comment">--*/</span>
01014 {
01015     PUCHAR  p;
01016     ULONG   i;
01017     ULONG   j;
01018 
01019     <span class="comment">//</span>
01020     <span class="comment">// Set limit for TSS</span>
01021     <span class="comment">//</span>
01022 
01023     <span class="keywordflow">if</span> (TssDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01024         TssDescriptor-&gt;LimitLow = <span class="keyword">sizeof</span>(KTSS) - 1;
01025         TssDescriptor-&gt;HighWord.Bits.LimitHi = 0;
01026     }
01027 
01028     <span class="comment">//</span>
01029     <span class="comment">// Initialize IOPMs</span>
01030     <span class="comment">//</span>
01031 
01032     <span class="keywordflow">for</span> (i = 0; i &lt; IOPM_COUNT; i++) {
01033         p = (PUCHAR)(Tss-&gt;IoMaps[i].IoMap);
01034 
01035         <span class="keywordflow">for</span> (j = 0; j &lt; PIOPM_SIZE; j++) {
01036             p[j] = (UCHAR)-1;
01037         }
01038     }
01039 
01040     <span class="comment">//</span>
01041     <span class="comment">// Initialize Software Interrupt Direction Maps</span>
01042     <span class="comment">//</span>
01043 
01044     <span class="keywordflow">for</span> (i = 0; i &lt; IOPM_COUNT; i++) {
01045         p = (PUCHAR)(Tss-&gt;IoMaps[i].DirectionMap);
01046         <span class="keywordflow">for</span> (j = 0; j &lt; INT_DIRECTION_MAP_SIZE; j++) {
01047             p[j] = 0;
01048         }
01049         <span class="comment">// dpmi requires special case for int 2, 1b, 1c, 23, 24</span>
01050         p[0] = 4;
01051         p[3] = 0x18;
01052         p[4] = 0x18;
01053     }
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">// Initialize the map for IO_ACCESS_MAP_NONE</span>
01057     <span class="comment">//</span>
01058     p = (PUCHAR)(Tss-&gt;IntDirectionMap);
01059     <span class="keywordflow">for</span> (j = 0; j &lt; INT_DIRECTION_MAP_SIZE; j++) {
01060         p[j] = 0;
01061     }
01062 
01063     <span class="comment">// dpmi requires special case for int 2, 1b, 1c, 23, 24</span>
01064     p[0] = 4;
01065     p[3] = 0x18;
01066     p[4] = 0x18;
01067 
01068     <span class="keywordflow">return</span>;
01069 }
01070 
01071 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01072"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a59">01072</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a59">KiSwapIDT</a> (
01073     )
01074 
01075 <span class="comment">/*++</span>
01076 <span class="comment"></span>
01077 <span class="comment">Routine Description:</span>
01078 <span class="comment"></span>
01079 <span class="comment">    This function is called to edit the IDT.  It swaps words of the address</span>
01080 <span class="comment">    and access fields around into the format the part actually needs.</span>
01081 <span class="comment">    This allows for easy static init of the IDT.</span>
01082 <span class="comment"></span>
01083 <span class="comment">    Note that this procedure edits the current IDT.</span>
01084 <span class="comment"></span>
01085 <span class="comment">Arguments:</span>
01086 <span class="comment"></span>
01087 <span class="comment">    None.</span>
01088 <span class="comment"></span>
01089 <span class="comment">Return Value:</span>
01090 <span class="comment"></span>
01091 <span class="comment">    None.</span>
01092 <span class="comment"></span>
01093 <span class="comment">--*/</span>
01094 {
01095     LONG    <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01096     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Temp;
01097 
01098     <span class="comment">//</span>
01099     <span class="comment">// Rearrange the entries of IDT to match i386 interrupt gate structure</span>
01100     <span class="comment">//</span>
01101 
01102     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt;= MAXIMUM_IDTVECTOR; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
01103         Temp = <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Selector;
01104         <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Selector = <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].ExtendedOffset;
01105         <a class="code" href="../../d6/d9/kernlini_8c.html#a27">IDT</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].ExtendedOffset = Temp;
01106     }
01107 }
01108 
01109 ULONG
<a name="l01110"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a42">01110</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a42">KiGetCpuVendor</a>(
01111     VOID
01112     )
01113 
01114 <span class="comment">/*++</span>
01115 <span class="comment"></span>
01116 <span class="comment">Routine Description:</span>
01117 <span class="comment"></span>
01118 <span class="comment">    (Try to) Determine the manufacturer of this processor based on</span>
01119 <span class="comment">    data returned by the CPUID instruction (if present).</span>
01120 <span class="comment"></span>
01121 <span class="comment">Arguments:</span>
01122 <span class="comment"></span>
01123 <span class="comment">    None.</span>
01124 <span class="comment"></span>
01125 <span class="comment">Return Value:</span>
01126 <span class="comment"></span>
01127 <span class="comment">    One of the members of the enumeration CPU_VENDORS (defined above).</span>
01128 <span class="comment"></span>
01129 <span class="comment">--*/</span>
01130 {
01131     PKPRCB Prcb;
01132     ULONG  Junk;
01133     ULONG  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[4];
01134 
01135     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01136     Prcb-&gt;VendorString[0] = 0;
01137 
01138     <span class="keywordflow">if</span> (!Prcb-&gt;CpuID) {
01139         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>;
01140     }
01141 
01142     <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(0, &amp;Junk, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+0, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+2, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+1);
01143     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[3] = 0;
01144 
01145     <span class="comment">//</span>
01146     <span class="comment">// Copy vendor string to Prcb for debugging (ensure it's NULL</span>
01147     <span class="comment">// terminated).</span>
01148     <span class="comment">//</span>
01149 
01150     RtlCopyMemory(
01151         Prcb-&gt;VendorString,
01152         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01153         <span class="keyword">sizeof</span>(Prcb-&gt;VendorString) - 1
01154         );
01155 
01156     Prcb-&gt;VendorString[<span class="keyword">sizeof</span>(Prcb-&gt;VendorString) - 1] = <span class="charliteral">'\0'</span>;
01157 
01158     <span class="keywordflow">if</span> (strcmp((PVOID)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a29">CmpIntelID</a>) == 0) {
01159         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>;
01160     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp((PVOID)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a30">CmpAmdID</a>) == 0) {
01161         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>;
01162     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp((PVOID)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a28">CmpCyrixID</a>) == 0) {
01163         <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a31">CPU_CYRIX</a>;
01164     }
01165     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a32">CPU_UNKNOWN</a>;
01166 }
01167 
01168 ULONG
01169 <a class="code" href="../../d6/d9/kernlini_8c.html#a43">KiGetFeatureBits</a> (
01170     VOID
01171     )
01172 
01173 <span class="comment">/*++</span>
01174 <span class="comment"></span>
01175 <span class="comment">Routine Description:</span>
01176 <span class="comment"></span>
01177 <span class="comment">    Examine the processor specific feature bits to determine the</span>
01178 <span class="comment">    Windows 2000 supported features supported by this processor.</span>
01179 <span class="comment"></span>
01180 <span class="comment">Arguments:</span>
01181 <span class="comment"></span>
01182 <span class="comment">    None.</span>
01183 <span class="comment"></span>
01184 <span class="comment">Return Value:</span>
01185 <span class="comment"></span>
01186 <span class="comment">    Returns a Windows 2000 normalized set of processor features.</span>
01187 <span class="comment"></span>
01188 <span class="comment">--*/</span>
01189 
01190 {
01191     ULONG           Junk;
01192     ULONG           Junk2;
01193     ULONG           ProcessorFeatures;
01194     ULONG           NtBits;
01195     ULONG           ExtendedProcessorFeatures;
01196     ULONG           ProcessorSignature;
01197     ULONG           CpuVendor;
01198     PKPRCB          Prcb;
01199     BOOLEAN         ExtendedCPUIDSupport = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01200 
01201     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01202 
01203     NtBits = <a class="code" href="../../d5/d3/i386_8h.html#a9">KF_WORKING_PTE</a>;
01204 
01205     <span class="comment">//</span>
01206     <span class="comment">// Determine the processor type</span>
01207     <span class="comment">//</span>
01208 
01209     CpuVendor = <a class="code" href="../../d6/d9/kernlini_8c.html#a42">KiGetCpuVendor</a>();
01210 
01211     <span class="comment">//</span>
01212     <span class="comment">// If this processor does not support the CPUID instruction,</span>
01213     <span class="comment">// don't try to use it.</span>
01214     <span class="comment">//</span>
01215 
01216     <span class="keywordflow">if</span> (CpuVendor == <a class="code" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>) {
01217         <span class="keywordflow">return</span> NtBits;
01218     }
01219 
01220     <span class="comment">//</span>
01221     <span class="comment">// Determine which NT compatible features are present</span>
01222     <span class="comment">//</span>
01223 
01224     <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a> (1, &amp;ProcessorSignature, &amp;Junk, &amp;Junk, &amp;ProcessorFeatures);
01225 
01226     <span class="comment">//</span>
01227     <span class="comment">// AMD specific stuff</span>
01228     <span class="comment">//</span>
01229 
01230     <span class="keywordflow">if</span> (CpuVendor == <a class="code" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>) {
01231 
01232         <span class="comment">//</span>
01233         <span class="comment">// Check for K5 and above.</span>
01234         <span class="comment">//</span>
01235 
01236         <span class="keywordflow">if</span> ((ProcessorSignature &amp; 0x0F00) &gt;= 0x0500) {
01237 
01238             <span class="keywordflow">if</span> ((ProcessorSignature &amp; 0x0F00) == 0x0500) {
01239 
01240                 <span class="keywordflow">switch</span> (ProcessorSignature &amp; 0x00F0) {
01241 
01242                 <span class="keywordflow">case</span> 0x0010: <span class="comment">// K5 Model 1</span>
01243 
01244                     <span class="comment">//</span>
01245                     <span class="comment">// for K5 Model 1 stepping 0 or 1 don't set global page</span>
01246                     <span class="comment">//</span>
01247 
01248                     <span class="keywordflow">if</span> ((ProcessorSignature &amp; 0x000F) &gt; 0x03) {
01249 
01250                         <span class="comment">//</span>
01251                         <span class="comment">// K5 Model 1 stepping 2 or greater</span>
01252                         <span class="comment">//</span>
01253 
01254                         <span class="keywordflow">break</span>;
01255                     }
01256 
01257                     <span class="comment">//</span>
01258                     <span class="comment">// K5 Model 1 stepping 0 or 1, FALL THRU.</span>
01259                     <span class="comment">//</span>
01260 
01261                 <span class="keywordflow">case</span> 0x0000:        <span class="comment">// K5 Model 0</span>
01262 
01263                     <span class="comment">//</span>
01264                     <span class="comment">// for K5 Model 0 or model unknown don't set global page</span>
01265                     <span class="comment">//</span>
01266 
01267                     ProcessorFeatures &amp;= ~0x2000;
01268                     <span class="keywordflow">break</span>;
01269 
01270                 <span class="keywordflow">case</span> 0x0080:        <span class="comment">// K6 Model 8 (K6-2)</span>
01271 
01272                     <span class="comment">//</span>
01273                     <span class="comment">// All steppings &gt;= 8 support MTRRs.</span>
01274                     <span class="comment">//</span>
01275 
01276                     <span class="keywordflow">if</span> ((ProcessorSignature &amp; 0x000F) &gt;= 0x8) {
01277                         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a15">KF_AMDK6MTRR</a>;
01278                     }
01279                     <span class="keywordflow">break</span>;
01280 
01281                 <span class="keywordflow">case</span> 0x0090:        <span class="comment">// K6 Model 9 (K6-3)</span>
01282 
01283                     NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a15">KF_AMDK6MTRR</a>;
01284                     <span class="keywordflow">break</span>;
01285 
01286                 <span class="keywordflow">default</span>:            <span class="comment">// anything else, nothing to do.</span>
01287 
01288                     <span class="keywordflow">break</span>;
01289                 }
01290             }
01291 
01292         } <span class="keywordflow">else</span> {
01293 
01294             <span class="comment">//</span>
01295             <span class="comment">// Less than family 5, don't set GLOBAL PAGE, LARGE</span>
01296             <span class="comment">// PAGE or CMOV.  (greater than family 5 will have the</span>
01297             <span class="comment">// bits set correctly).</span>
01298             <span class="comment">//</span>
01299 
01300             ProcessorFeatures &amp;= ~(0x08 | 0x2000 | 0x8000);
01301 
01302             <span class="comment">//</span>
01303             <span class="comment">// We don't know what this processor returns if we</span>
01304             <span class="comment">// probe for extended CPUID support.</span>
01305             <span class="comment">//</span>
01306 
01307             ExtendedCPUIDSupport = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01308         }
01309     }
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">// Intel specific stuff</span>
01313     <span class="comment">//</span>
01314 
01315     <span class="keywordflow">if</span> (CpuVendor == <a class="code" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>) {
01316         <span class="keywordflow">if</span> (Prcb-&gt;CpuType == 6) {
01317             <a class="code" href="../../d5/d3/i386_8h.html#a53">WRMSR</a> (0x8B, 0);
01318             <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a> (1, &amp;Junk, &amp;Junk, &amp;Junk, &amp;ProcessorFeatures);
01319             Prcb-&gt;UpdateSignature.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a> (0x8B);
01320         }
01321 
01322         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Prcb-&gt;CpuType == 5) {
01323             <a class="code" href="../../d6/d9/kernlini_8c.html#a12">KiI386PentiumLockErrataPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01324         }
01325 
01326         <span class="keywordflow">if</span> ( ((ProcessorSignature &amp; 0x0FF0) == 0x0610 &amp;&amp;
01327               (ProcessorSignature &amp; 0x000F) &lt;= 0x9) ||
01328 
01329              ((ProcessorSignature &amp; 0x0FF0) == 0x0630 &amp;&amp;
01330               (ProcessorSignature &amp; 0x000F) &lt;= 0x4)) {
01331 
01332             NtBits &amp;= ~<a class="code" href="../../d5/d3/i386_8h.html#a9">KF_WORKING_PTE</a>;
01333         }
01334 
01335         <span class="keywordflow">if</span> ( (Prcb-&gt;CpuType == 6)  &amp;&amp;
01336              (Prcb-&gt;CpuStep &gt;= 0x0303)  &amp;&amp;
01337              (ProcessorFeatures &amp; <a class="code" href="../../d4/d1/fastsys_8inc.html#a0">KI_FAST_SYSCALL_SUPPORTED</a>) ) {
01338 
01339               <span class="comment">// BUGBUG: Disable as it's preventing hibernate from working</span>
01340               <span class="comment">// NtBits |= KF_FAST_SYSCALL;</span>
01341         }
01342     }
01343 
01344     <span class="comment">//</span>
01345     <span class="comment">// Cyrix specific stuff</span>
01346     <span class="comment">//</span>
01347 
01348     <span class="keywordflow">if</span> (CpuVendor == <a class="code" href="../../d6/d9/kernlini_8c.html#a61a31">CPU_CYRIX</a>) {
01349 
01350         <span class="comment">//</span>
01351         <span class="comment">// Workaround bug 324467 which is caused by INTR being</span>
01352         <span class="comment">// held high too long during an FP instruction and causing</span>
01353         <span class="comment">// random Trap07 with no exception bits.</span>
01354         <span class="comment">//</span>
01355 
01356         <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d6/d9/kernlini_8c.html#a13">KiIgnoreUnexpectedTrap07</a>;
01357 
01358         <a class="code" href="../../d6/d9/kernlini_8c.html#a13">KiIgnoreUnexpectedTrap07</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01359 
01360         <span class="comment">//</span>
01361         <span class="comment">// Workaround CMPXCHG bug to Cyrix processors where</span>
01362         <span class="comment">// Family = 6, Model = 0, Stepping &lt;= 1.  Note that</span>
01363         <span class="comment">// Prcb-&gt;CpuStep contains both model and stepping.</span>
01364         <span class="comment">//</span>
01365         <span class="comment">// Disable Locking in one of processor specific registers</span>
01366         <span class="comment">// (accessible via i/o space index/data pair).</span>
01367         <span class="comment">//</span>
01368 
01369         <span class="keywordflow">if</span> ((Prcb-&gt;CpuType == 6) &amp;&amp;
01370             (Prcb-&gt;CpuStep &lt;= 1)) {
01371 
01372 <span class="preprocessor">            #define CRC_NDX (PUCHAR)0x22</span>
01373 <span class="preprocessor"></span><span class="preprocessor">            #define CRC_DAT (CRC_NDX + 1)</span>
01374 <span class="preprocessor"></span><span class="preprocessor">            #define CCR1    0xc1</span>
01375 <span class="preprocessor"></span>
01376             UCHAR ValueCCR1;
01377 
01378             <span class="comment">//</span>
01379             <span class="comment">// Get current setting.</span>
01380             <span class="comment">//</span>
01381 
01382             WRITE_PORT_UCHAR(CRC_NDX, CCR1);
01383 
01384             ValueCCR1 = READ_PORT_UCHAR(CRC_DAT);
01385 
01386             <span class="comment">//</span>
01387             <span class="comment">// Set the NO_LOCK bit and write it back.</span>
01388             <span class="comment">//</span>
01389 
01390             ValueCCR1 |= 0x10;
01391 
01392             WRITE_PORT_UCHAR(CRC_NDX, CCR1);
01393             WRITE_PORT_UCHAR(CRC_DAT, ValueCCR1);
01394 
01395 <span class="preprocessor">            #undef CCR1</span>
01396 <span class="preprocessor"></span><span class="preprocessor">            #undef CRC_DAT</span>
01397 <span class="preprocessor"></span><span class="preprocessor">            #undef CRC_NDX</span>
01398 <span class="preprocessor"></span>        }
01399     }
01400 
01401     <span class="comment">//</span>
01402     <span class="comment">// Check the standard CPUID feature bits.</span>
01403     <span class="comment">//</span>
01404     <span class="comment">// The following bits are known to work on Intel, AMD and Cyrix.</span>
01405     <span class="comment">// We hope (and assume) the clone makers will follow suit.</span>
01406     <span class="comment">//</span>
01407 
01408     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x00000002) {
01409         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a0">KF_V86_VIS</a> | <a class="code" href="../../d5/d3/i386_8h.html#a2">KF_CR4</a>;
01410     }
01411 
01412     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x00000008) {
01413         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a5">KF_LARGE_PAGE</a> | <a class="code" href="../../d5/d3/i386_8h.html#a2">KF_CR4</a>;
01414     }
01415 
01416     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x00000010) {
01417         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a1">KF_RDTSC</a>;
01418     }
01419 
01420     <span class="comment">//</span>
01421     <span class="comment">// N.B. CMPXCHG8B MUST be done in a generic manner or clone processors</span>
01422     <span class="comment">// will not be able to boot if they set this feature bit.</span>
01423     <span class="comment">//</span>
01424 
01425     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x00000100) {
01426         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>;
01427     }
01428 
01429     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x00001000) {
01430         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>;
01431     }
01432 
01433     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x00002000) {
01434         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a4">KF_GLOBAL_PAGE</a> | <a class="code" href="../../d5/d3/i386_8h.html#a2">KF_CR4</a>;
01435     }
01436 
01437     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x00008000) {
01438         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a3">KF_CMOV</a>;
01439     }
01440 
01441     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x00010000) {
01442         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>;
01443     }
01444 
01445     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x00800000) {
01446         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a8">KF_MMX</a>;
01447     }
01448 
01449     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x01000000) {
01450         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>;
01451     }
01452 
01453     <span class="keywordflow">if</span> (ProcessorFeatures &amp; 0x02000000) {
01454         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>;
01455     }
01456 
01457     <span class="comment">//</span>
01458     <span class="comment">// Check extended functions.   First, check for existance,</span>
01459     <span class="comment">// then check extended function 0x80000001 (Extended Processor</span>
01460     <span class="comment">// Features) if present.</span>
01461     <span class="comment">//</span>
01462     <span class="comment">// Note: Intel guarantees that no processor that doesn't support</span>
01463     <span class="comment">// extended CPUID functions will ever return a value with the </span>
01464     <span class="comment">// most significant bit set.   Microsoft asks all CPU vendors</span>
01465     <span class="comment">// to make the same guarantee.</span>
01466     <span class="comment">//</span>
01467 
01468     <span class="keywordflow">if</span> (ExtendedCPUIDSupport != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01469 
01470         <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(0x80000000, &amp;Junk2, &amp;Junk, &amp;Junk, &amp;Junk);
01471     
01472         <span class="comment">//</span>
01473         <span class="comment">// Sanity check the result, assuming there are no more</span>
01474         <span class="comment">// than 256 extended feature functions (should be valid</span>
01475         <span class="comment">// for a little while).</span>
01476         <span class="comment">//</span>
01477 
01478         <span class="keywordflow">if</span> ((Junk2 &amp; 0xffffff00) == 0x80000000) {
01479 
01480             <span class="comment">//</span>
01481             <span class="comment">// Check extended processor features.  These, by definition,</span>
01482             <span class="comment">// can vary on a processor by processor basis.</span>
01483             <span class="comment">//</span>
01484 
01485             <span class="keywordflow">if</span> (Junk2 &gt;= 0x80000001) {
01486     
01487                 <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(0x80000001, &amp;Junk2, &amp;Junk, &amp;Junk, &amp;ExtendedProcessorFeatures);
01488     
01489                 <span class="comment">//</span>
01490                 <span class="comment">// With these, we can only do what we're told.</span>
01491                 <span class="comment">//</span>
01492 
01493                 <span class="keywordflow">switch</span> (CpuVendor) {
01494                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>:
01495 
01496                     <span class="keywordflow">if</span> (ExtendedProcessorFeatures &amp; 0x80000000) {
01497                         NtBits |= <a class="code" href="../../d5/d3/i386_8h.html#a14">KF_3DNOW</a>;
01498                     }
01499                     <span class="keywordflow">break</span>;
01500                 }
01501             }
01502         }
01503     }
01504 
01505     <span class="keywordflow">return</span> NtBits;
01506 }
01507 
01508 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01509"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a41">01509</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a41">KiGetCacheInformation</a>(
01510     VOID
01511     )
01512 {
01513 <span class="preprocessor">#define CPUID_REG_COUNT 4</span>
01514 <span class="preprocessor"></span>    ULONG CpuidData[<a class="code" href="../../d6/d9/kernlini_8c.html#a5">CPUID_REG_COUNT</a>];
01515 
01516     ULONG CpuVendor;
01517     PKPCR Pcr;
01518 
01519     <span class="comment">//</span>
01520     <span class="comment">// Set default.</span>
01521     <span class="comment">//</span>
01522 
01523     Pcr = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>();
01524 
01525     Pcr-&gt;SecondLevelCacheSize = 0;
01526 
01527     <span class="comment">//</span>
01528     <span class="comment">// Determine the processor manufacturer</span>
01529     <span class="comment">//</span>
01530 
01531     CpuVendor = <a class="code" href="../../d6/d9/kernlini_8c.html#a42">KiGetCpuVendor</a>();
01532 
01533     <span class="keywordflow">if</span> (CpuVendor == <a class="code" href="../../d6/d9/kernlini_8c.html#a61a28">CPU_NONE</a>) {
01534         <span class="keywordflow">return</span>;
01535     }
01536 
01537     <span class="comment">//</span>
01538     <span class="comment">// Obtain Cache size information for those processors on which</span>
01539     <span class="comment">// we know how.</span>
01540     <span class="comment">//</span>
01541 
01542     <span class="keywordflow">switch</span> (CpuVendor) {
01543     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a29">CPU_INTEL</a>:
01544 
01545         <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(0, CpuidData, CpuidData+1, CpuidData+2, CpuidData+3);
01546 
01547         <span class="comment">//</span>
01548         <span class="comment">// Check this processor supports CPUID function 2 which is the</span>
01549         <span class="comment">// one that returns cache size info.</span>
01550         <span class="comment">//</span>
01551 
01552         <span class="keywordflow">if</span> (CpuidData[0] &gt;= 2) {
01553 
01554             <span class="comment">//</span>
01555             <span class="comment">// The above returns a series of bytes.    (In EAX, EBX, ECX</span>
01556             <span class="comment">// and EDX).   The least significant byte (of EAX) gives the</span>
01557             <span class="comment">// number of times CPUID(2 ...) should be issued to return</span>
01558             <span class="comment">// the complete set of data.   The bytes are self describing</span>
01559             <span class="comment">// data.</span>
01560             <span class="comment">//</span>
01561             <span class="comment">// In particular, the bytes describing the L2 cache size</span>
01562             <span class="comment">// will be in the following set (and meaning)</span>
01563             <span class="comment">//</span>
01564             <span class="comment">// 0x40       0  bytes</span>
01565             <span class="comment">// 0x41     128K bytes</span>
01566             <span class="comment">// 0x42     256K bytes</span>
01567             <span class="comment">// 0x43     512K bytes</span>
01568             <span class="comment">// 0x44    1024K bytes</span>
01569             <span class="comment">// 0x45    2048K bytes</span>
01570             <span class="comment">// 0x46    4096K bytes</span>
01571             <span class="comment">//</span>
01572             <span class="comment">// I am extrapolating the above as anything in the range</span>
01573             <span class="comment">// 0x41 thru 0x4f can be computed as</span>
01574             <span class="comment">//</span>
01575             <span class="comment">//   128KB &lt;&lt; (descriptor - 0x41)</span>
01576             <span class="comment">//</span>
01577             <span class="comment">// The Intel folks say keep it to a reasonable upper bound,</span>
01578             <span class="comment">// eg 49.</span>
01579             <span class="comment">//</span>
01580             <span class="comment">// N.B. the range 0x80 .. 0x86 indicates the same cache</span>
01581             <span class="comment">// sizes but 8 way associative.</span>
01582             <span class="comment">//</span>
01583             <span class="comment">// Also, the most significant bit of each register indicates</span>
01584             <span class="comment">// whether not the register contains valid information.</span>
01585             <span class="comment">// 0 == Valid, 1 == InValid.</span>
01586             <span class="comment">//</span>
01587 
01588             ULONG CpuidIterations;
01589             ULONG i;
01590             ULONG CpuidReg;
01591 
01592             BOOLEAN FirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01593 
01594             <span class="keywordflow">do</span> {
01595                 <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a>(2, CpuidData, CpuidData+1, CpuidData+2, CpuidData+3);
01596 
01597                 <span class="keywordflow">if</span> (FirstPass) {
01598 
01599                     <span class="comment">//</span>
01600                     <span class="comment">// Get the iteration count from the first byte</span>
01601                     <span class="comment">// of the returned data then replace that byte</span>
01602                     <span class="comment">// with 0 (a null descriptor).</span>
01603                     <span class="comment">//</span>
01604 
01605                     CpuidIterations = CpuidData[0] &amp; 0xff;
01606                     CpuidData[0] &amp;= 0xffffff00;
01607 
01608                     FirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01609                 }
01610 
01611                 <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d6/d9/kernlini_8c.html#a5">CPUID_REG_COUNT</a>; i++) {
01612 
01613                     CpuidReg = CpuidData[i];
01614 
01615                     <span class="keywordflow">if</span> (CpuidReg &amp; 0x80000000) {
01616 
01617                         <span class="comment">//</span>
01618                         <span class="comment">// Register doesn't contain valid data,</span>
01619                         <span class="comment">// skip it.</span>
01620                         <span class="comment">//</span>
01621 
01622                         <span class="keywordflow">continue</span>;
01623                     }
01624 
01625                     <span class="keywordflow">while</span> (CpuidReg) {
01626 
01627                         <span class="comment">//</span>
01628                         <span class="comment">// Get LS Byte from this DWORD and remove the</span>
01629                         <span class="comment">// byte.</span>
01630                         <span class="comment">//</span>
01631 
01632                         UCHAR Descriptor = (UCHAR)(CpuidReg &amp; 0xff);
01633                         CpuidReg &gt;&gt;= 8;
01634 
01635                         <span class="keywordflow">if</span> (Descriptor == 0) {
01636 
01637                             <span class="comment">//</span>
01638                             <span class="comment">// NULL descriptor</span>
01639                             <span class="comment">//</span>
01640 
01641                             <span class="keywordflow">continue</span>;
01642                         }
01643 
01644                         <span class="keywordflow">if</span> (((Descriptor &gt; 0x40) &amp;&amp; (Descriptor &lt;= 0x49)) ||
01645                             ((Descriptor &gt; 0x80) &amp;&amp; (Descriptor &lt;= 0x89))) {
01646 
01647                             <span class="comment">//</span>
01648                             <span class="comment">// L2 descriptor.</span>
01649                             <span class="comment">//</span>
01650 
01651                             Descriptor &amp;= 0x0f;
01652 
01653                             <span class="comment">//</span>
01654                             <span class="comment">// Assert the descriptor is in the range we</span>
01655                             <span class="comment">// officially know about.   If this hits on</span>
01656                             <span class="comment">// a checked build, check with Intel about</span>
01657                             <span class="comment">// the interpretation.</span>
01658                             <span class="comment">//</span>
01659 
01660                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor &lt;= 0x6);
01661 
01662                             Pcr-&gt;SecondLevelCacheSize = 0x10000 &lt;&lt; Descriptor;
01663                         }
01664 
01665                         <span class="comment">//</span>
01666                         <span class="comment">// else if (do other descriptors)</span>
01667                         <span class="comment">//</span>
01668 
01669                     } <span class="comment">// while more bytes in this register</span>
01670 
01671                 } <span class="comment">// for each register</span>
01672 
01673                 <span class="comment">//</span>
01674                 <span class="comment">// Note: Always run thru all iterations indicated by</span>
01675                 <span class="comment">// the first to ensure a subsequent call won't start</span>
01676                 <span class="comment">// part way thru.</span>
01677                 <span class="comment">//</span>
01678 
01679             } <span class="keywordflow">while</span> (--CpuidIterations);
01680         }
01681         <span class="keywordflow">break</span>;
01682     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/kernlini_8c.html#a61a30">CPU_AMD</a>:
01683         <span class="keywordflow">break</span>;
01684     }
01685 <span class="preprocessor">#undef CPUID_REG_COUNT</span>
01686 <span class="preprocessor"></span>}
01687 
<a name="l01688"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a6">01688</a> <span class="preprocessor">#define MAX_ATTEMPTS    10</span>
01689 <span class="preprocessor"></span>
01690 BOOLEAN
<a name="l01691"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a49">01691</a> <a class="code" href="../../d0/d0/ki_8h.html#a120">KiInitMachineDependent</a> (
01692     VOID
01693     )
01694 {
01695     KAFFINITY       ActiveProcessors, CurrentAffinity;
01696     ULONG           NumberProcessors;
01697     <a class="code" href="../../d5/d0/struct__IDENTITY__MAP.html">IDENTITY_MAP</a>    IdentityMap;
01698     ULONG           <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01699     ULONG           Average;
01700     ULONG           Junk;
01701     <span class="keyword">struct </span>{
01702         LARGE_INTEGER   PerfStart;
01703         LARGE_INTEGER   PerfEnd;
01704         LONGLONG        PerfDelta;
01705         LARGE_INTEGER   PerfFreq;
01706         LONGLONG        TSCStart;
01707         LONGLONG        TSCEnd;
01708         LONGLONG        TSCDelta;
01709         ULONG           MHz;
01710     } Samples[<a class="code" href="../../d6/d9/kernlini_8c.html#a6">MAX_ATTEMPTS</a>], *pSamp;
01711     PUCHAR          PatchLocation;
01712 
01713     <span class="comment">//</span>
01714     <span class="comment">// If PDE large page is supported, enable it.</span>
01715     <span class="comment">//</span>
01716     <span class="comment">// We enable large pages before global pages to make TLB invalidation</span>
01717     <span class="comment">// easier while turning on large pages.</span>
01718     <span class="comment">//</span>
01719 
01720     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a5">KF_LARGE_PAGE</a>) {
01721         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/largepag_8c.html#a6">Ki386CreateIdentityMap</a>(&amp;IdentityMap,
01722                                    &amp;<a class="code" href="../../d1/d0/ki386_8h.html#a16">Ki386EnableCurrentLargePage</a>,
01723                                    &amp;<a class="code" href="../../d1/d0/ki386_8h.html#a12">Ki386EnableCurrentLargePageEnd</a> )) {
01724 
01725             <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01726                 (<a class="code" href="../../d0/d0/ki_8h.html#a33">PKIPI_BROADCAST_WORKER</a>) <a class="code" href="../../d1/d0/ki386_8h.html#a14">Ki386EnableTargetLargePage</a>,
01727                 (ULONG)(&amp;IdentityMap)
01728             );
01729         }
01730 
01731         <span class="comment">//</span>
01732         <span class="comment">// Always call Ki386ClearIdentityMap() to free any memory allocated</span>
01733         <span class="comment">//</span>
01734 
01735         <a class="code" href="../../d2/d1/largepag_8c.html#a7">Ki386ClearIdentityMap</a>(&amp;IdentityMap);
01736     }
01737 
01738     <span class="comment">//</span>
01739     <span class="comment">// If PDE/PTE global page is supported, enable it</span>
01740     <span class="comment">//</span>
01741 
01742     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a4">KF_GLOBAL_PAGE</a>) {
01743         NumberProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
01744         <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01745             (<a class="code" href="../../d0/d0/ki_8h.html#a33">PKIPI_BROADCAST_WORKER</a>) <a class="code" href="../../d6/d9/kernlini_8c.html#a47">Ki386EnableGlobalPage</a>,
01746             (ULONG)(&amp;NumberProcessors)
01747         );
01748     }
01749 
01750 <span class="preprocessor">#if !defined(NT_UP)</span>
01751 <span class="preprocessor"></span>
01752     <span class="comment">//</span>
01753     <span class="comment">// If some processor doesn't have proper MP PTE implementation,</span>
01754     <span class="comment">// then use a synchronous TB shoot down handler</span>
01755     <span class="comment">//</span>
01756 
01757     <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a9">KF_WORKING_PTE</a>)) {
01758         NumberProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
01759         <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01760             (<a class="code" href="../../d0/d0/ki_8h.html#a33">PKIPI_BROADCAST_WORKER</a>) <a class="code" href="../../d8/d5/i386_2flushtb_8c.html#a5">Ki386UseSynchronousTbFlush</a>,
01761             (ULONG)(&amp;NumberProcessors)
01762         );
01763     }
01764 
01765 <span class="preprocessor">#endif</span>
01766 <span class="preprocessor"></span>
01767     <span class="comment">//</span>
01768     <span class="comment">// If PAT or MTRR supported but the HAL indicates it shouldn't</span>
01769     <span class="comment">// be used (eg on a Shared Memory Cluster), drop the feature.</span>
01770     <span class="comment">//</span>
01771 
01772     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; (<a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a> | <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>)) {
01773 
01774         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01775         BOOLEAN  UseFrameBufferCaching;
01776         ULONG    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01777 
01778         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a20">HalQuerySystemInformation</a>(
01779                      <a class="code" href="../../d2/d7/hal_8h.html#a237a150">HalFrameBufferCachingInformation</a>,
01780                      <span class="keyword">sizeof</span>(UseFrameBufferCaching),
01781                      &amp;UseFrameBufferCaching,
01782                      &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
01783                      );
01784 
01785         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp;
01786             (UseFrameBufferCaching == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01787 
01788             <span class="comment">//</span>
01789             <span class="comment">// Hal says don't use.</span>
01790             <span class="comment">//</span>
01791 
01792             <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp;= ~(<a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a> | <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>);
01793         }
01794     }
01795 
01796 
01797     <span class="comment">//</span>
01798     <span class="comment">// If PAT is supported then initialize it.</span>
01799     <span class="comment">//</span>
01800 
01801     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) {
01802         <a class="code" href="../../d9/d3/pat_8c.html#a4">KiInitializePAT</a>();
01803     }
01804 
01805     <span class="comment">//</span>
01806     <span class="comment">// Compute each processors approximate mhz</span>
01807     <span class="comment">//</span>
01808 
01809     <span class="comment">//</span>
01810     <span class="comment">// If FXSR feature is supported, set OSFXSR (bit 9) in CR4</span>
01811     <span class="comment">//</span>
01812 
01813     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>) {
01814         NumberProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
01815 
01816         <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01817             (<a class="code" href="../../d0/d0/ki_8h.html#a33">PKIPI_BROADCAST_WORKER</a>) <a class="code" href="../../d6/d9/kernlini_8c.html#a45">Ki386EnableFxsr</a>,
01818             (ULONG)(&amp;NumberProcessors)
01819         );
01820 
01821 
01822         <span class="comment">//</span>
01823         <span class="comment">// If XMMI feature is supported,</span>
01824         <span class="comment">//    a. Hook int 19 handler</span>
01825         <span class="comment">//    b. Set OSXMMEXCPT (bit 10) in CR4</span>
01826         <span class="comment">//    c. Enable use of fast XMMI based zero page routines.</span>
01827         <span class="comment">//</span>
01828 
01829         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>) {
01830             <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
01831                 (<a class="code" href="../../d0/d0/ki_8h.html#a33">PKIPI_BROADCAST_WORKER</a>) <a class="code" href="../../d6/d9/kernlini_8c.html#a46">Ki386EnableXMMIExceptions</a>,
01832                 (ULONG)(&amp;NumberProcessors)
01833             );
01834 
01835             <a class="code" href="../../d6/d9/kernlini_8c.html#a24">KeZeroPage</a> = <a class="code" href="../../d6/d9/kernlini_8c.html#a54">KiXMMIZeroPage</a>;
01836             <a class="code" href="../../d6/d9/kernlini_8c.html#a25">KeZeroPageFromIdleThread</a> = <a class="code" href="../../d6/d9/kernlini_8c.html#a55">KiXMMIZeroPageNoSave</a>;
01837         }
01838 
01839 
01840     } <span class="keywordflow">else</span> {
01841 <span class="preprocessor">#ifndef NT_UP</span>
01842 <span class="preprocessor"></span>        <span class="comment">//</span>
01843         <span class="comment">// Patch the fxsave instruction in SwapContext to use</span>
01844         <span class="comment">// "fnsave {dd, 31}, fwait {9b}"</span>
01845         <span class="comment">//</span>
01846         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((ULONG)&amp;<a class="code" href="../../d6/d9/kernlini_8c.html#a22">ScPatchFxe</a>-(ULONG)&amp;<a class="code" href="../../d6/d9/kernlini_8c.html#a21">ScPatchFxb</a>) &gt;= 3);
01847 
01848         PatchLocation = (PUCHAR)&amp;<a class="code" href="../../d6/d9/kernlini_8c.html#a21">ScPatchFxb</a>;
01849 
01850         *PatchLocation++ = 0xdd;
01851         *PatchLocation++ = 0x31;
01852         *PatchLocation++ = 0x9b;
01853 
01854         <span class="keywordflow">while</span> (PatchLocation &lt; (PUCHAR)&amp;<a class="code" href="../../d6/d9/kernlini_8c.html#a22">ScPatchFxe</a>) {
01855             <span class="comment">//</span>
01856             <span class="comment">// Put nop's in the remaining bytes</span>
01857             <span class="comment">//</span>
01858             *PatchLocation++ = 0x90;
01859         }
01860 <span class="preprocessor">#endif</span>
01861 <span class="preprocessor"></span>    }
01862 
01863     ActiveProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
01864     <span class="keywordflow">for</span> (CurrentAffinity=1; ActiveProcessors; CurrentAffinity &lt;&lt;= 1) {
01865 
01866         <span class="keywordflow">if</span> (ActiveProcessors &amp; CurrentAffinity) {
01867 
01868             <span class="comment">//</span>
01869             <span class="comment">// Switch to that processor, and remove it from the</span>
01870             <span class="comment">// remaining set of processors</span>
01871             <span class="comment">//</span>
01872 
01873             ActiveProcessors &amp;= ~CurrentAffinity;
01874             <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>(CurrentAffinity);
01875 
01876             <span class="comment">//</span>
01877             <span class="comment">// Determine the MHz for the processor</span>
01878             <span class="comment">//</span>
01879 
01880             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;MHz = 0;
01881 
01882             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a1">KF_RDTSC</a>) {
01883 
01884                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
01885                 pSamp = Samples;
01886 
01887                 <span class="keywordflow">for</span> (; ;) {
01888 
01889                     <span class="comment">//</span>
01890                     <span class="comment">// Collect a new sample</span>
01891                     <span class="comment">// Delay the thread a "long" amount and time it with</span>
01892                     <span class="comment">// a time source and RDTSC.</span>
01893                     <span class="comment">//</span>
01894 
01895                     <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a> (0, &amp;Junk, &amp;Junk, &amp;Junk, &amp;Junk);
01896                     pSamp-&gt;PerfStart = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01897                     pSamp-&gt;TSCStart = <a class="code" href="../../d5/d3/i386_8h.html#a51">RDTSC</a>();
01898                     pSamp-&gt;PerfFreq.QuadPart = -50000;
01899 
01900                     <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;pSamp-&gt;PerfFreq);
01901 
01902                     <a class="code" href="../../d5/d3/i386_8h.html#a50">CPUID</a> (0, &amp;Junk, &amp;Junk, &amp;Junk, &amp;Junk);
01903                     pSamp-&gt;PerfEnd = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> (&amp;pSamp-&gt;PerfFreq);
01904                     pSamp-&gt;TSCEnd = <a class="code" href="../../d5/d3/i386_8h.html#a51">RDTSC</a>();
01905 
01906                     <span class="comment">//</span>
01907                     <span class="comment">// Calculate processors MHz</span>
01908                     <span class="comment">//</span>
01909 
01910                     pSamp-&gt;PerfDelta = pSamp-&gt;PerfEnd.QuadPart - pSamp-&gt;PerfStart.QuadPart;
01911                     pSamp-&gt;TSCDelta = pSamp-&gt;TSCEnd - pSamp-&gt;TSCStart;
01912 
01913                     pSamp-&gt;MHz = (ULONG) ((pSamp-&gt;TSCDelta * pSamp-&gt;PerfFreq.QuadPart + 500000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) /
01914                                           (pSamp-&gt;PerfDelta * 1000000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
01915 
01916 
01917                     <span class="comment">//</span>
01918                     <span class="comment">// If last 2 samples matched within a MHz, done</span>
01919                     <span class="comment">//</span>
01920 
01921                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
01922                         <span class="keywordflow">if</span> (pSamp-&gt;MHz == pSamp[-1].MHz ||
01923                             pSamp-&gt;MHz == pSamp[-1].MHz + 1 ||
01924                             pSamp-&gt;MHz == pSamp[-1].MHz - 1) {
01925                                 <span class="keywordflow">break</span>;
01926                         }
01927                     }
01928 
01929                     <span class="comment">//</span>
01930                     <span class="comment">// Advance to next sample</span>
01931                     <span class="comment">//</span>
01932 
01933                     pSamp += 1;
01934                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01935 
01936                     <span class="comment">//</span>
01937                     <span class="comment">// If too many samples, then something is wrong</span>
01938                     <span class="comment">//</span>
01939 
01940                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d6/d9/kernlini_8c.html#a6">MAX_ATTEMPTS</a>) {
01941 
01942 <span class="preprocessor">#if DBG</span>
01943 <span class="preprocessor"></span>                        <span class="comment">//</span>
01944                         <span class="comment">// Temp breakpoint to see where this is failing</span>
01945                         <span class="comment">// and why</span>
01946                         <span class="comment">//</span>
01947 
01948                         DbgBreakPoint();
01949 <span class="preprocessor">#endif</span>
01950 <span class="preprocessor"></span>
01951                         Average = 0;
01952                         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d9/kernlini_8c.html#a6">MAX_ATTEMPTS</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01953                             Average += Samples[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].MHz;
01954                         }
01955                         pSamp[-1].MHz = Average / <a class="code" href="../../d6/d9/kernlini_8c.html#a6">MAX_ATTEMPTS</a>;
01956                         <span class="keywordflow">break</span>;
01957                     }
01958 
01959                 }
01960 
01961                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;MHz = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) pSamp[-1].MHz;
01962             }
01963 
01964             <span class="comment">//</span>
01965             <span class="comment">// If MTRRs are supported and PAT not supported, initialize MTRRs</span>
01966             <span class="comment">// per processor</span>
01967             <span class="comment">//</span>
01968 
01969             <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) &amp;&amp; (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a6">KF_MTRR</a>)) {
01970                 <a class="code" href="../../d8/d4/mtrr_8c.html#a16">KiInitializeMTRR</a> ( (BOOLEAN) (ActiveProcessors ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
01971             }
01972 
01973             <span class="comment">//</span>
01974             <span class="comment">// If the processor is a AMD K6 with MTRR support then</span>
01975             <span class="comment">// perform processor specific initialization.</span>
01976             <span class="comment">//</span>
01977 
01978             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a15">KF_AMDK6MTRR</a>) {
01979                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a24">KiAmdK6InitializeMTRR</a>();
01980             }
01981 
01982             <span class="comment">//</span>
01983             <span class="comment">// Apply Pentium workaround if needed</span>
01984             <span class="comment">//</span>
01985 
01986             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/kernlini_8c.html#a12">KiI386PentiumLockErrataPresent</a>) {
01987                 <a class="code" href="../../d6/d9/kernlini_8c.html#a36">KiI386PentiumLockErrataFixup</a> ();
01988             }
01989         }
01990     }
01991 
01992     <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
01993     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01994 }
01995 
01996 
01997 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01998"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a60">01998</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a60">KeOptimizeProcessorControlState</a> (
01999     VOID
02000     )
02001 {
02002     <a class="code" href="../../d9/d1/cyrix_8c.html#a27">Ke386ConfigureCyrixProcessor</a> ();
02003 }
02004 
02005 
02006 
02007 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02008"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a40">02008</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a40">KeSetup80387OrEmulate</a> (
02009     IN PVOID *R3EmulatorTable
02010     )
02011 
02012 <span class="comment">/*++</span>
02013 <span class="comment"></span>
02014 <span class="comment">Routine Description:</span>
02015 <span class="comment"></span>
02016 <span class="comment">    This routine is called by PS initialization after loading NTDLL.</span>
02017 <span class="comment"></span>
02018 <span class="comment">    If this is a 386 system without 387s (all processors must be</span>
02019 <span class="comment">    symmetrical) then this function will set the trap 07 vector on all</span>
02020 <span class="comment">    processors to point to the address passed in (which should be the</span>
02021 <span class="comment">    entry point of the 80387 emulator in NTDLL, NPXNPHandler).</span>
02022 <span class="comment"></span>
02023 <span class="comment">Arguments:</span>
02024 <span class="comment"></span>
02025 <span class="comment">    HandlerAddress - Supplies the address of the trap07 handler.</span>
02026 <span class="comment"></span>
02027 <span class="comment">Return Value:</span>
02028 <span class="comment"></span>
02029 <span class="comment">    None.</span>
02030 <span class="comment"></span>
02031 <span class="comment">--*/</span>
02032 
02033 {
02034     PKINTERRUPT_ROUTINE HandlerAddress;
02035     KAFFINITY           ActiveProcessors, CurrentAffinity;
02036     KIRQL               OldIrql;
02037     ULONG               disposition;
02038     HANDLE              SystemHandle, SourceHandle, DestHandle;
02039     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02040     UNICODE_STRING      unicodeString;
02041     OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02042     <span class="keywordtype">double</span>              Dividend, Divisor;
02043     BOOLEAN             PrecisionErrata;
02044 
02045     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
02046 
02047         <span class="comment">//</span>
02048         <span class="comment">// A coprocessor is present - check to see if the precision errata exists</span>
02049         <span class="comment">//</span>
02050 
02051         PrecisionErrata = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02052 
02053         ActiveProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
02054         <span class="keywordflow">for</span> (CurrentAffinity = 1; ActiveProcessors; CurrentAffinity &lt;&lt;= 1) {
02055 
02056             <span class="keywordflow">if</span> (ActiveProcessors &amp; CurrentAffinity) {
02057                 ActiveProcessors &amp;= ~CurrentAffinity;
02058 
02059                 <span class="comment">//</span>
02060                 <span class="comment">// Run calculation on each processor.</span>
02061                 <span class="comment">//</span>
02062 
02063                 <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>(CurrentAffinity);
02064                 _asm {
02065 
02066                     ;
02067                     ; This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to destroy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> coprocesssor,
02068                     ; but we know that there's no state currently in <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
02069                     ;
02070 
02071                     cli
02072                     mov     eax, cr0
02073                     mov     ecx, eax    ; hold original cr0 value
02074                     and     eax, not (CR0_TS+CR0_MP+CR0_EM)
02075                     mov     cr0, eax
02076 
02077                     fninit              ; to known state
02078                 }
02079 
02080                 Dividend = 4195835.0;
02081                 Divisor  = 3145727.0;
02082 
02083                 _asm {
02084                     fld     Dividend
02085                     fdiv    Divisor     ; test known faulty divison
02086                     fmul    Divisor     ; Multiple quotient by divisor
02087                     fcomp   Dividend    ; <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a> product and dividend
02088                     fstsw   ax          ; Move <span class="keywordtype">float</span> conditions to ax
02089                     sahf                ; <a class="code" href="../../d7/d4/conexts_8c.html#a1">move</a> to eflags
02090 
02091                     mov     cr0, ecx    ; restore cr0
02092                     sti
02093 
02094                     jc      <span class="keywordtype">short</span> em10
02095                     jz      <span class="keywordtype">short</span> em20
02096 em10:               mov     PrecisionErrata, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02097 em20:
02098                 }
02099             }
02100         }
02101 
02102 
02103         <span class="comment">//</span>
02104         <span class="comment">// Check to see if the emulator should be used anyway</span>
02105         <span class="comment">//</span>
02106 
02107         <span class="keywordflow">switch</span> (<a class="code" href="../../d7/d3/i386init_8c.html#a4">KeI386ForceNpxEmulation</a>) {
02108             <span class="keywordflow">case</span> 0:
02109                 <span class="comment">//</span>
02110                 <span class="comment">// Use the emulator based on the value in KeI386NpxPresent</span>
02111                 <span class="comment">//</span>
02112 
02113                 <span class="keywordflow">break</span>;
02114 
02115             <span class="keywordflow">case</span> 1:
02116                 <span class="comment">//</span>
02117                 <span class="comment">// Only use the emulator if any processor has the known</span>
02118                 <span class="comment">// Pentium floating point division problem.</span>
02119                 <span class="comment">//</span>
02120 
02121                 <span class="keywordflow">if</span> (PrecisionErrata) {
02122                     <a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02123                 }
02124                 <span class="keywordflow">break</span>;
02125 
02126             <span class="keywordflow">default</span>:
02127 
02128                 <span class="comment">//</span>
02129                 <span class="comment">// Unknown setting - use the emulator</span>
02130                 <span class="comment">//</span>
02131 
02132                 <a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02133                 <span class="keywordflow">break</span>;
02134         }
02135     }
02136 
02137     <span class="comment">//</span>
02138     <span class="comment">// Setup processor features, and install emulator if needed</span>
02139     <span class="comment">//</span>
02140 
02141     SharedUserData-&gt;ProcessorFeatures[PF_FLOATING_POINT_EMULATED] = !<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>;
02142     SharedUserData-&gt;ProcessorFeatures[PF_FLOATING_POINT_PRECISION_ERRATA] = PrecisionErrata;
02143 
02144     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
02145 
02146         <span class="comment">//</span>
02147         <span class="comment">// MMx not available when emulator is used</span>
02148         <span class="comment">//</span>
02149 
02150         <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp;= ~(<a class="code" href="../../d5/d3/i386_8h.html#a8">KF_MMX</a>|<a class="code" href="../../d5/d3/i386_8h.html#a11">KF_FXSR</a>|<a class="code" href="../../d5/d3/i386_8h.html#a13">KF_XMMI</a>);
02151         SharedUserData-&gt;ProcessorFeatures[PF_MMX_INSTRUCTIONS_AVAILABLE] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02152         SharedUserData-&gt;ProcessorFeatures[PF_XMMI_INSTRUCTIONS_AVAILABLE] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02153         SharedUserData-&gt;ProcessorFeatures[PF_3DNOW_INSTRUCTIONS_AVAILABLE] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02154 
02155         <span class="comment">//</span>
02156         <span class="comment">// Errata not present when using emulator</span>
02157         <span class="comment">//</span>
02158 
02159         SharedUserData-&gt;ProcessorFeatures[PF_FLOATING_POINT_PRECISION_ERRATA] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02160 
02161         <span class="comment">//</span>
02162         <span class="comment">// Use the user mode floating point emulator</span>
02163         <span class="comment">//</span>
02164 
02165         HandlerAddress = (PKINTERRUPT_ROUTINE) ((PULONG) R3EmulatorTable)[0];
02166         <a class="code" href="../../d7/d3/i386init_8c.html#a7">Ki387RoundModeTable</a> = (PVOID) ((PULONG) R3EmulatorTable)[1];
02167 
02168         ActiveProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
02169         <span class="keywordflow">for</span> (CurrentAffinity = 1; ActiveProcessors; CurrentAffinity &lt;&lt;= 1) {
02170 
02171             <span class="keywordflow">if</span> (ActiveProcessors &amp; CurrentAffinity) {
02172                 ActiveProcessors &amp;= ~CurrentAffinity;
02173 
02174                 <span class="comment">//</span>
02175                 <span class="comment">// Run this code on each processor.</span>
02176                 <span class="comment">//</span>
02177 
02178                 <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>(CurrentAffinity);
02179 
02180                 <span class="comment">//</span>
02181                 <span class="comment">// Raise IRQL and lock dispatcher database.</span>
02182                 <span class="comment">//</span>
02183 
02184                 <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
02185 
02186                 <span class="comment">//</span>
02187                 <span class="comment">// Make the trap 07 IDT entry point at the passed-in handler</span>
02188                 <span class="comment">//</span>
02189 
02190                 KiSetHandlerAddressToIDT(I386_80387_NP_VECTOR, HandlerAddress);
02191                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;IDT[I386_80387_NP_VECTOR].Selector = KGDT_R3_CODE;
02192                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;IDT[I386_80387_NP_VECTOR].Access = <a class="code" href="../../d6/d9/kernlini_8c.html#a0">TRAP332_GATE</a>;
02193 
02194 
02195                 <span class="comment">//</span>
02196                 <span class="comment">// Unlock dispatcher database and lower IRQL to its previous value.</span>
02197                 <span class="comment">//</span>
02198 
02199                 <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
02200             }
02201         }
02202 
02203         <span class="comment">//</span>
02204         <span class="comment">// Move any entries from ..\System\FloatingPointProcessor to</span>
02205         <span class="comment">// ..\System\DisabledFloatingPointProcessor.</span>
02206         <span class="comment">//</span>
02207 
02208         <span class="comment">//</span>
02209         <span class="comment">// Open system tree</span>
02210         <span class="comment">//</span>
02211 
02212         InitializeObjectAttributes(
02213             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02214             &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a17">CmRegistryMachineHardwareDescriptionSystemName</a>,
02215             OBJ_CASE_INSENSITIVE,
02216             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02217             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02218             );
02219 
02220         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( &amp;SystemHandle,
02221                             KEY_ALL_ACCESS,
02222                             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
02223                             );
02224 
02225         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02226 
02227             <span class="comment">//</span>
02228             <span class="comment">// Open FloatingPointProcessor key</span>
02229             <span class="comment">//</span>
02230 
02231             InitializeObjectAttributes(
02232                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02233                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a10">CmTypeName</a>[<a class="code" href="../../d1/d9/arc_8h.html#a315a189">FloatingPointProcessor</a>],
02234                 OBJ_CASE_INSENSITIVE,
02235                 SystemHandle,
02236                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02237                 );
02238 
02239             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey ( &amp;SourceHandle,
02240                                  KEY_ALL_ACCESS,
02241                                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
02242                                  );
02243 
02244             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02245 
02246                 <span class="comment">//</span>
02247                 <span class="comment">// Create DisabledFloatingPointProcessor key</span>
02248                 <span class="comment">//</span>
02249 
02250                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (
02251                     &amp;unicodeString,
02252                     <a class="code" href="../../d2/d2/i386_2initdat_8c.html#a11">CmDisabledFloatingPointProcessor</a>
02253                     );
02254 
02255                 InitializeObjectAttributes(
02256                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02257                     &amp;unicodeString,
02258                     OBJ_CASE_INSENSITIVE,
02259                     SystemHandle,
02260                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02261                     );
02262 
02263                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateKey( &amp;DestHandle,
02264                                       KEY_ALL_ACCESS,
02265                                       &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02266                                       0,
02267                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02268                                       REG_OPTION_VOLATILE,
02269                                       &amp;disposition
02270                                       );
02271 
02272                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02273 
02274                     <span class="comment">//</span>
02275                     <span class="comment">// Move it</span>
02276                     <span class="comment">//</span>
02277 
02278                     <a class="code" href="../../d6/d9/kernlini_8c.html#a44">KiMoveRegTree</a> (SourceHandle, DestHandle);
02279                     ZwClose (DestHandle);
02280                 }
02281                 ZwClose (SourceHandle);
02282             }
02283             ZwClose (SystemHandle);
02284         }
02285     }
02286 
02287     <span class="comment">//</span>
02288     <span class="comment">// Set affinity back to the original value.</span>
02289     <span class="comment">//</span>
02290 
02291     <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
02292 }
02293 
02294 
02295 
02296 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02297"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a44">02297</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a44">KiMoveRegTree</a>(
02298     HANDLE  Source,
02299     HANDLE  Dest
02300     )
02301 {
02302     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02303     PKEY_BASIC_INFORMATION      KeyInformation;
02304     PKEY_VALUE_FULL_INFORMATION KeyValue;
02305     OBJECT_ATTRIBUTES           <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02306     HANDLE                      SourceChild;
02307     HANDLE                      DestChild;
02308     ULONG                       ResultLength;
02309     UCHAR                       buffer[1024];           <span class="comment">// hmm....</span>
02310     UNICODE_STRING              <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
02311     UNICODE_STRING              <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
02312 
02313 
02314     KeyValue = (PKEY_VALUE_FULL_INFORMATION)buffer;
02315 
02316     <span class="comment">//</span>
02317     <span class="comment">// Move values from source node to dest node</span>
02318     <span class="comment">//</span>
02319 
02320     <span class="keywordflow">for</span> (; ;) {
02321         <span class="comment">//</span>
02322         <span class="comment">// Get first value</span>
02323         <span class="comment">//</span>
02324 
02325         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateValueKey(Source,
02326                                      0,
02327                                      KeyValueFullInformation,
02328                                      buffer,
02329                                      <span class="keyword">sizeof</span> (buffer),
02330                                      &amp;ResultLength);
02331 
02332         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02333             <span class="keywordflow">break</span>;
02334         }
02335 
02336 
02337         <span class="comment">//</span>
02338         <span class="comment">// Write value to dest node</span>
02339         <span class="comment">//</span>
02340 
02341         <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.Buffer = KeyValue-&gt;Name;
02342         <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) KeyValue-&gt;NameLength;
02343         ZwSetValueKey( Dest,
02344                        &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
02345                        KeyValue-&gt;TitleIndex,
02346                        KeyValue-&gt;Type,
02347                        buffer+KeyValue-&gt;DataOffset,
02348                        KeyValue-&gt;DataLength
02349                       );
02350 
02351         <span class="comment">//</span>
02352         <span class="comment">// Delete value and get first value again</span>
02353         <span class="comment">//</span>
02354 
02355         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeleteValueKey (Source, &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
02356         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02357             <span class="keywordflow">break</span>;
02358         }
02359     }
02360 
02361 
02362     <span class="comment">//</span>
02363     <span class="comment">// Enumerate node's children and apply ourselves to each one</span>
02364     <span class="comment">//</span>
02365 
02366     KeyInformation = (PKEY_BASIC_INFORMATION)buffer;
02367     <span class="keywordflow">for</span> (; ;) {
02368 
02369         <span class="comment">//</span>
02370         <span class="comment">// Open node's first key</span>
02371         <span class="comment">//</span>
02372 
02373         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateKey(
02374                     Source,
02375                     0,
02376                     KeyBasicInformation,
02377                     KeyInformation,
02378                     <span class="keyword">sizeof</span> (buffer),
02379                     &amp;ResultLength
02380                     );
02381 
02382         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02383             <span class="keywordflow">break</span>;
02384         }
02385 
02386         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = KeyInformation-&gt;Name;
02387         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) KeyInformation-&gt;NameLength;
02388 
02389         InitializeObjectAttributes(
02390             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02391             &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
02392             OBJ_CASE_INSENSITIVE,
02393             Source,
02394             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02395             );
02396 
02397         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey(
02398                     &amp;SourceChild,
02399                     KEY_ALL_ACCESS,
02400                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
02401                     );
02402 
02403         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02404             <span class="keywordflow">break</span>;
02405         }
02406 
02407         <span class="comment">//</span>
02408         <span class="comment">// Create key in dest tree</span>
02409         <span class="comment">//</span>
02410 
02411         InitializeObjectAttributes(
02412             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02413             &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
02414             OBJ_CASE_INSENSITIVE,
02415             Dest,
02416             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02417             );
02418 
02419         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateKey(
02420                     &amp;DestChild,
02421                     KEY_ALL_ACCESS,
02422                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02423                     0,
02424                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02425                     REG_OPTION_VOLATILE,
02426                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02427                     );
02428 
02429         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02430             <span class="keywordflow">break</span>;
02431         }
02432 
02433         <span class="comment">//</span>
02434         <span class="comment">// Move subtree</span>
02435         <span class="comment">//</span>
02436 
02437         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/kernlini_8c.html#a44">KiMoveRegTree</a>(SourceChild, DestChild);
02438 
02439         ZwClose(DestChild);
02440         ZwClose(SourceChild);
02441 
02442         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02443             <span class="keywordflow">break</span>;
02444         }
02445 
02446         <span class="comment">//</span>
02447         <span class="comment">// Loop and get first key.  (old first key was delete by the</span>
02448         <span class="comment">// call to KiMoveRegTree).</span>
02449         <span class="comment">//</span>
02450     }
02451 
02452     <span class="comment">//</span>
02453     <span class="comment">// Remove source node</span>
02454     <span class="comment">//</span>
02455 
02456     <span class="keywordflow">return</span> <a class="code" href="../../d7/d7/ntapi_8c.html#a15">NtDeleteKey</a> (Source);
02457 }
02458 
02459 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02460"></a><a class="code" href="../../d6/d9/kernlini_8c.html#a36">02460</a> <a class="code" href="../../d6/d9/kernlini_8c.html#a36">KiI386PentiumLockErrataFixup</a> (
02461     VOID
02462     )
02463 
02464 <span class="comment">/*++</span>
02465 <span class="comment"></span>
02466 <span class="comment">Routine Description:</span>
02467 <span class="comment"></span>
02468 <span class="comment">    This routine is called once on every processor when</span>
02469 <span class="comment">    KiI386PentiumLockErrataPresent is TRUE.</span>
02470 <span class="comment"></span>
02471 <span class="comment">    This routine replaces the local IDT with an IDT that has the first 7 IDT</span>
02472 <span class="comment">    entries on their own page and returns the first page to the caller to</span>
02473 <span class="comment">    be marked as read-only.  This causes the processor to trap-0e fault when</span>
02474 <span class="comment">    the errata occurs.  Special code in the trap-0e handler detects the</span>
02475 <span class="comment">    problem and performs the proper fixup.</span>
02476 <span class="comment"></span>
02477 <span class="comment">Arguments:</span>
02478 <span class="comment"></span>
02479 <span class="comment">    FixupPage   - Returns a virtual address of a page to be marked read-only</span>
02480 <span class="comment"></span>
02481 <span class="comment">Return Value:</span>
02482 <span class="comment"></span>
02483 <span class="comment">    None.</span>
02484 <span class="comment"></span>
02485 <span class="comment">--*/</span>
02486 
02487 {
02488     KDESCRIPTOR IdtDescriptor;
02489     ULONG       OrginalBase;
02490     PUCHAR      NewBase, BasePage;
02491     BOOLEAN     Enable;
02492     BOOLEAN     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02493 
02494 
02495 <span class="preprocessor">#define IDT_SKIP   (7 * sizeof (KIDTENTRY))</span>
02496 <span class="preprocessor"></span>
02497     <span class="comment">//</span>
02498     <span class="comment">// Allocate memory for a new copy of the processors IDT</span>
02499     <span class="comment">//</span>
02500 
02501     BasePage = <a class="code" href="../../d5/d6/iosup_8c.html#a61">MmAllocateIndependentPages</a> (2*<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02502 
02503     <span class="comment">//</span>
02504     <span class="comment">// The IDT base is such that the first 7 entries are on the</span>
02505     <span class="comment">// first (read-only) page, and the remaining entries are on the</span>
02506     <span class="comment">// second (read-write) page</span>
02507     <span class="comment">//</span>
02508 
02509     NewBase = BasePage + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d6/d9/kernlini_8c.html#a7">IDT_SKIP</a>;
02510 
02511     <span class="comment">//</span>
02512     <span class="comment">// Disable interrupts on this processor while updating the IDT base</span>
02513     <span class="comment">//</span>
02514 
02515     Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
02516 
02517     <span class="comment">//</span>
02518     <span class="comment">// Copy Old IDT to new IDT</span>
02519     <span class="comment">//</span>
02520 
02521     _asm {
02522         sidt IdtDescriptor.Limit
02523     }
02524 
02525     RtlMoveMemory ((PVOID) NewBase,
02526                    (PVOID) IdtDescriptor.Base,
02527                    IdtDescriptor.Limit + 1
02528                   );
02529 
02530     IdtDescriptor.Base = (ULONG) NewBase;
02531 
02532     <span class="comment">//</span>
02533     <span class="comment">// Set the new IDT</span>
02534     <span class="comment">//</span>
02535 
02536     _asm {
02537         lidt IdtDescriptor.Limit
02538     }
02539 
02540     <span class="comment">//</span>
02541     <span class="comment">// Update the PCR</span>
02542     <span class="comment">//</span>
02543 
02544     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;IDT = (PKIDTENTRY) NewBase;
02545 
02546     <span class="comment">//</span>
02547     <span class="comment">// Restore interrupts</span>
02548     <span class="comment">//</span>
02549 
02550     <a class="code" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts</a>(Enable);
02551 
02552     <span class="comment">//</span>
02553     <span class="comment">// Mark the first page which contains IDT entries 0-6 as read-only</span>
02554     <span class="comment">//</span>
02555 
02556     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d6/iosup_8c.html#a62">MmSetPageProtection</a> (BasePage, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, PAGE_READONLY);
02557     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02558 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:35 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
