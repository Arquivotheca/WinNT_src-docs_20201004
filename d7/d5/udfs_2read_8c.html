<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfs/read.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>read.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d8/d4/udfs_2read_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/udfs_2read_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_READ)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/udfs_2read_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_READ)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/udfs_2read_8c.html#a2">SafeZeroMemory</a>(IC, AT, BYTE_COUNT)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/udfs_2read_8c.html#a3">READ_AHEAD_GRANULARITY</a>&nbsp;&nbsp;&nbsp;(0x10000)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/udfs_2read_8c.html#a4">UdfCommonRead</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="udfs/read.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_READ)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00028">28</a> of file <a class="el" href="../../d8/d4/udfs_2read_8c-source.html">udfs/read.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="udfs/read.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_READ)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00034">34</a> of file <a class="el" href="../../d8/d4/udfs_2read_8c-source.html">udfs/read.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="udfs/read.c::READ_AHEAD_GRANULARITY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define READ_AHEAD_GRANULARITY&nbsp;&nbsp;&nbsp;(0x10000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00060">60</a> of file <a class="el" href="../../d8/d4/udfs_2read_8c-source.html">udfs/read.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="udfs/read.c::SafeZeroMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SafeZeroMemory          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>AT,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BYTE_COUNT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                  \
    <span class="keywordflow">try</span> {                                                   \
        RtlZeroMemory( (AT), (BYTE_COUNT) );                \
    } except( EXCEPTION_EXECUTE_HANDLER ) {                 \
         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IC, STATUS_INVALID_USER_BUFFER );   \
    }                                                       \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00048">48</a> of file <a class="el" href="../../d8/d4/udfs_2read_8c-source.html">udfs/read.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="udfs/read.c::UdfCommonRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">68</a> of file <a class="el" href="../../d8/d4/udfs_2read_8c-source.html">udfs/read.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00231">BytesFromSectors</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00287">_UDF_DATA::CacheManagerCallbacks</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01222">CcSetReadAheadGranularity()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01535">_FILE_OBJECT::CurrentByteOffset</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01019">_FCB::EmbeddedOffset</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01018">_FCB::EmbeddedVsn</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01064">FCB_STATE_EMBEDDED_DATA</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00986">_FCB::FcbState</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01315">FsRtlCheckLockForReadAccess()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00049">FsRtlNormalizeNtstatus()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03528">IoIsErrorUserInduced</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01241">IRP_CONTEXT_FLAG_ALLOC_IO</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00140">IRP_MN_MDL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01549">IRP_NOCACHE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01550">IRP_PAGING_IO</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00630">_VCB::MetadataFcb</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d4/d2/cache_8h.html#a13">PCC_FILE_SIZES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01522">_FILE_OBJECT::PrivateCacheMap</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00060">READ_AHEAD_GRANULARITY</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00048">SafeZeroMemory</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00212">SectorAlign</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00232">SectorOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a96">UDF_IO_CONTEXT</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01533">UdfAcquireFileShared</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01536">UdfAcquireFileSharedStarveExclusive</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01701">UdfAllocateIoContext</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00042">UdfData</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">UdfFsdPostRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00902">UdfMapUserBuffer</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">UdfNormalizeAndRaiseStatus()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">UdfOplockComplete()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01539">UdfReleaseFile</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00075                    :
00076 
00077     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common entry point <span class="keywordflow">for</span> <a class="code" href="../../d6/d5/io_2read_8c.html#a1">NtReadFile</a> calls.  For synchronous requests,
00078     CommonRead will complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.  If not
00079     synchronous <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request will be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a need to
00080     block.
00081 
00082 Arguments:
00083 
00084     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00085 
00086 Return Value:
00087 
00088     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The result of <span class="keyword">this</span> operation.
00089 
00090 --*/
00091 
00092 {
00093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00094     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00095 
00096     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00097     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00098     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00099     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00100 
00101     BOOLEAN Wait;
00102     ULONG PagingIo;
00103     ULONG <a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>;
00104     ULONG NonCachedIo;
00105 
00106     LONGLONG StartingOffset;
00107     LONGLONG ByteRange;
00108     ULONG ByteCount;
00109     ULONG ReadByteCount;
00110     ULONG OriginalByteCount;
00111 
00112     PVOID SystemBuffer, UserBuffer;
00113 
00114     BOOLEAN ReleaseFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00115 
00116     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> MappingFileObject;
00117 
00118     <a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">UDF_IO_CONTEXT</a> LocalIoContext;
00119 
00120     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">//  If this is a zero length read then return SUCCESS immediately.</span>
00124     <span class="comment">//</span>
00125 
00126     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length == 0) {
00127 
00128         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00129         <span class="keywordflow">return</span> STATUS_SUCCESS;
00130     }
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  Decode the file object and verify we support read on this.  It</span>
00134     <span class="comment">//  must be a user file, stream file or volume file (for a data disk).</span>
00135     <span class="comment">//</span>
00136 
00137     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb, &amp;Ccb );
00138 
00139     Vcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00140 
00141     <span class="keywordflow">if</span> ((TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) || (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>)) {
00142 
00143         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_DEVICE_REQUEST );
00144         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
00145     }
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">//  Examine our input parameters to determine if this is noncached and/or</span>
00149     <span class="comment">//  a paging io operation.</span>
00150     <span class="comment">//</span>
00151 
00152     Wait = <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT );
00153     PagingIo = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_PAGING_IO );
00154     NonCachedIo = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_NOCACHE );
00155     <a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_SYNCHRONOUS_IO );
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">//  Extract the range of the Io.</span>
00159     <span class="comment">//</span>
00160 
00161     StartingOffset = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.ByteOffset.QuadPart;
00162     OriginalByteCount = ByteCount = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length;
00163 
00164     ByteRange = StartingOffset + ByteCount;
00165 
00166     <span class="comment">//</span>
00167     <span class="comment">//  Make sure that Dasd access is always non-cached.</span>
00168     <span class="comment">//</span>
00169 
00170     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00171 
00172         NonCachedIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00173     }
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">//  Acquire the file shared to perform the read.  If we are doing paging IO,</span>
00177     <span class="comment">//  it may be the case that we would have a deadlock imminent because we may</span>
00178     <span class="comment">//  block on shared access, so starve out any exclusive waiters.  This requires</span>
00179     <span class="comment">//  a degree of caution - we believe that any paging IO bursts will recede and</span>
00180     <span class="comment">//  allow the exclusive waiter in.</span>
00181     <span class="comment">//</span>
00182 
00183     <span class="keywordflow">if</span> (PagingIo) {
00184 
00185         <a class="code" href="../../d3/d8/udfprocs_8h.html#a81">UdfAcquireFileSharedStarveExclusive</a>( IrpContext, Fcb );
00186     
00187     } <span class="keywordflow">else</span> {
00188         
00189         <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, Fcb );
00190     }
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00194     <span class="comment">//</span>
00195 
00196     <span class="keywordflow">try</span> {
00197 
00198         <span class="comment">//</span>
00199         <span class="comment">//  Verify the Fcb.</span>
00200         <span class="comment">//</span>
00201 
00202         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00203 
00204         <span class="comment">//</span>
00205         <span class="comment">//  If this is a user request then verify the oplock and filelock state.</span>
00206         <span class="comment">//</span>
00207 
00208         <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00209 
00210             <span class="comment">//</span>
00211             <span class="comment">//  We check whether we can proceed</span>
00212             <span class="comment">//  based on the state of the file oplocks.</span>
00213             <span class="comment">//</span>
00214 
00215             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
00216                                        Irp,
00217                                        IrpContext,
00218                                        UdfOplockComplete,
00219                                        UdfPrePostIrp );
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">//  If the result is not STATUS_SUCCESS then the Irp was completed</span>
00223             <span class="comment">//  elsewhere.</span>
00224             <span class="comment">//</span>
00225 
00226             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00227 
00228                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00229                 IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00230 
00231                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status );
00232             }
00233 
00234             <span class="keywordflow">if</span> (!PagingIo &amp;&amp;
00235                 (Fcb-&gt;FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00236                 !<a class="code" href="../../d1/d8/fsrtl_8h.html#a117">FsRtlCheckLockForReadAccess</a>( Fcb-&gt;FileLock, Irp )) {
00237 
00238                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_FILE_LOCK_CONFLICT );
00239             }
00240         }
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">//  Complete the request if it begins beyond the end of file.</span>
00244         <span class="comment">//</span>
00245 
00246         <span class="keywordflow">if</span> (StartingOffset &gt;= Fcb-&gt;FileSize.QuadPart) {
00247 
00248             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_END_OF_FILE );
00249         }
00250 
00251         <span class="comment">//</span>
00252         <span class="comment">//  Truncate the read if it extends beyond the end of the file.</span>
00253         <span class="comment">//</span>
00254 
00255         <span class="keywordflow">if</span> (ByteRange &gt; Fcb-&gt;FileSize.QuadPart) {
00256 
00257             ByteCount = (ULONG) (Fcb-&gt;FileSize.QuadPart - StartingOffset);
00258             ByteRange = Fcb-&gt;FileSize.QuadPart;
00259         }
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Now if the data is embedded in the ICB, map through the metadata</span>
00263         <span class="comment">//  stream to retrieve the bytes.</span>
00264         <span class="comment">//</span>
00265             
00266         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, FCB_STATE_EMBEDDED_DATA )) {
00267 
00268             <span class="comment">//</span>
00269             <span class="comment">//  The metadata stream better be here by now.</span>
00270             <span class="comment">//</span>
00271 
00272             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a>-&gt;FileObject != NULL );
00273 
00274             <span class="comment">//</span>
00275             <span class="comment">//  Bias our starting offset by the offset of the ICB in the metadata</span>
00276             <span class="comment">//  stream plus the offset of the data bytes in that ICB.  Obviously,</span>
00277             <span class="comment">//  we aren't doing non-cached IO here.</span>
00278             <span class="comment">//</span>
00279 
00280             StartingOffset += (<a class="code" href="../../d3/d8/fsrtlp_8h.html#a14">BytesFromSectors</a>( Vcb, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o15">EmbeddedVsn</a> ) + Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o16">EmbeddedOffset</a>);
00281             MappingFileObject = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a>-&gt;FileObject;
00282             NonCachedIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  We are mapping through the caller's fileobject</span>
00286         <span class="comment">//</span>
00287 
00288         } <span class="keywordflow">else</span> {
00289 
00290             MappingFileObject = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
00291         }
00292         
00293         <span class="comment">//</span>
00294         <span class="comment">//  Handle the non-cached read first.</span>
00295         <span class="comment">//</span>
00296 
00297         <span class="keywordflow">if</span> (NonCachedIo) {
00298 
00299             <span class="comment">//</span>
00300             <span class="comment">//  If we have an unaligned transfer then post this request if</span>
00301             <span class="comment">//  we can't wait.  Unaligned means that the starting offset</span>
00302             <span class="comment">//  is not on a sector boundary or the read is not integral</span>
00303             <span class="comment">//  sectors.</span>
00304             <span class="comment">//</span>
00305 
00306             ReadByteCount = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a12">SectorAlign</a>( Vcb, ByteCount );
00307 
00308             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb,  StartingOffset ) ||
00309                 (ReadByteCount &gt; OriginalByteCount)) {
00310 
00311                 <span class="keywordflow">if</span> (!Wait) {
00312 
00313                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00314                 }
00315 
00316                 <span class="comment">//</span>
00317                 <span class="comment">//  Make sure we don't overwrite the buffer.</span>
00318                 <span class="comment">//</span>
00319 
00320                 ReadByteCount = ByteCount;
00321             }
00322 
00323             <span class="comment">//</span>
00324             <span class="comment">//  Initialize the IoContext for the read.</span>
00325             <span class="comment">//  If there is a context pointer, we need to make sure it was</span>
00326             <span class="comment">//  allocated and not a stale stack pointer.</span>
00327             <span class="comment">//</span>
00328 
00329             <span class="keywordflow">if</span> (IrpContext-&gt;IoContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00330                 !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO )) {
00331 
00332                 <span class="comment">//</span>
00333                 <span class="comment">//  If we can wait, use the context on the stack.  Otherwise</span>
00334                 <span class="comment">//  we need to allocate one.</span>
00335                 <span class="comment">//</span>
00336 
00337                 <span class="keywordflow">if</span> (Wait) {
00338 
00339                     IrpContext-&gt;IoContext = &amp;LocalIoContext;
00340                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00341 
00342                 } <span class="keywordflow">else</span> {
00343 
00344                     IrpContext-&gt;IoContext = <a class="code" href="../../d3/d8/udfprocs_8h.html#a94">UdfAllocateIoContext</a>();
00345                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00346                 }
00347             }
00348 
00349             RtlZeroMemory( IrpContext-&gt;IoContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">UDF_IO_CONTEXT</a> ));
00350     
00351             <span class="comment">//</span>
00352             <span class="comment">//  Store whether we allocated this context structure in the structure</span>
00353             <span class="comment">//  itself.</span>
00354             <span class="comment">//</span>
00355     
00356             IrpContext-&gt;IoContext-&gt;AllocatedContext =
00357                 <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00358 
00359             <span class="keywordflow">if</span> (Wait) {
00360 
00361                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;IrpContext-&gt;IoContext-&gt;SyncEvent,
00362                                    NotificationEvent,
00363                                    FALSE );
00364 
00365             } <span class="keywordflow">else</span> {
00366 
00367                 IrpContext-&gt;IoContext-&gt;ResourceThreadId = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00368                 IrpContext-&gt;IoContext-&gt;Resource = Fcb-&gt;Resource;
00369                 IrpContext-&gt;IoContext-&gt;RequestedByteCount = ByteCount;
00370             }
00371     
00372             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = ReadByteCount;
00373 
00374             <span class="comment">//</span>
00375             <span class="comment">//  Call the NonCacheIo routine to perform the actual read.</span>
00376             <span class="comment">//</span>
00377 
00378             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a161">UdfNonCachedRead</a>( IrpContext, Fcb, StartingOffset, ReadByteCount );
00379 
00380             <span class="comment">//</span>
00381             <span class="comment">//  Don't complete this request now if STATUS_PENDING was returned.</span>
00382             <span class="comment">//</span>
00383 
00384             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00385 
00386                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00387                 ReleaseFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00388 
00389             <span class="comment">//</span>
00390             <span class="comment">//  Test is we should zero part of the buffer or update the</span>
00391             <span class="comment">//  synchronous file position.</span>
00392             <span class="comment">//</span>
00393 
00394             } <span class="keywordflow">else</span> {
00395 
00396                 <span class="comment">//</span>
00397                 <span class="comment">//  Convert any unknown error code to IO_ERROR.</span>
00398                 <span class="comment">//</span>
00399 
00400                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00401 
00402                     <span class="comment">//</span>
00403                     <span class="comment">//  Set the information field to zero.</span>
00404                     <span class="comment">//</span>
00405 
00406                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00407 
00408                     <span class="comment">//</span>
00409                     <span class="comment">//  Raise if this is a user induced error.</span>
00410                     <span class="comment">//</span>
00411 
00412                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a232">IoIsErrorUserInduced</a>( Status )) {
00413 
00414                         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, Status );
00415                     }
00416 
00417                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a136">FsRtlNormalizeNtstatus</a>( Status, STATUS_UNEXPECTED_IO_ERROR );
00418 
00419                 <span class="comment">//</span>
00420                 <span class="comment">//  Check if there is any portion of the user's buffer to zero.</span>
00421                 <span class="comment">//</span>
00422 
00423                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReadByteCount != ByteCount) {
00424 
00425                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;UserBuffer );
00426                     
00427                     <a class="code" href="../../d7/d5/udfs_2read_8c.html#a2">SafeZeroMemory</a>( IrpContext,
00428                                     <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer,
00429                                              ByteCount,
00430                                              PVOID ),
00431                                     ReadByteCount - ByteCount );
00432 
00433                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = ByteCount;
00434                 }
00435 
00436                 <span class="comment">//</span>
00437                 <span class="comment">//  Update the file position if this is a synchronous request.</span>
00438                 <span class="comment">//</span>
00439 
00440                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> &amp;&amp; !PagingIo &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00441 
00442                     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a>.QuadPart = ByteRange;
00443                 }
00444             }
00445 
00446             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00447         }
00448 
00449         <span class="comment">//</span>
00450         <span class="comment">//  Handle the cached case.  Start by initializing the private</span>
00451         <span class="comment">//  cache map.</span>
00452         <span class="comment">//</span>
00453 
00454         <span class="keywordflow">if</span> (MappingFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o7">PrivateCacheMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00455 
00456             <span class="comment">//</span>
00457             <span class="comment">//  The metadata Fcb stream was fired up before any data read.  We should never</span>
00458             <span class="comment">//  see it here.</span>
00459             <span class="comment">//</span>
00460 
00461             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( MappingFileObject != Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a>-&gt;FileObject );
00462             
00463             <span class="comment">//</span>
00464             <span class="comment">//  Now initialize the cache map.</span>
00465             <span class="comment">//</span>
00466 
00467             <a class="code" href="../../d4/d2/cache_8h.html#a58">CcInitializeCacheMap</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
00468                                   (<a class="code" href="../../d1/d9/struct__CC__FILE__SIZES.html">PCC_FILE_SIZES</a>) &amp;Fcb-&gt;AllocationSize,
00469                                   FALSE,
00470                                   &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>,
00471                                   Fcb );
00472 
00473             <a class="code" href="../../d4/d2/cache_8h.html#a86">CcSetReadAheadGranularity</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, READ_AHEAD_GRANULARITY );
00474         }
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">//  Read from the cache if this is not an Mdl read.</span>
00478         <span class="comment">//</span>
00479 
00480         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;MinorFunction, IRP_MN_MDL )) {
00481 
00482             <span class="comment">//</span>
00483             <span class="comment">// If we are in the Fsp now because we had to wait earlier,</span>
00484             <span class="comment">// we must map the user buffer, otherwise we can use the</span>
00485             <span class="comment">// user's buffer directly.</span>
00486             <span class="comment">//</span>
00487 
00488             <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;SystemBuffer);
00489 
00490             <span class="comment">//</span>
00491             <span class="comment">// Now try to do the copy.</span>
00492             <span class="comment">//</span>
00493 
00494             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d2/cache_8h.html#a74">CcCopyRead</a>( MappingFileObject,
00495                              (PLARGE_INTEGER) &amp;StartingOffset,
00496                              ByteCount,
00497                              Wait,
00498                              SystemBuffer,
00499                              &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a> )) {
00500 
00501                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_CANT_WAIT );
00502             }
00503 
00504             <span class="comment">//</span>
00505             <span class="comment">//  If the call didn't succeed, raise the error status</span>
00506             <span class="comment">//</span>
00507 
00508             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
00509 
00510                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
00511             }
00512 
00513             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00514 
00515         <span class="comment">//</span>
00516         <span class="comment">//  Otherwise perform the MdlRead operation.</span>
00517         <span class="comment">//</span>
00518 
00519         } <span class="keywordflow">else</span> {
00520 
00521             <a class="code" href="../../d4/d2/cache_8h.html#a78">CcMdlRead</a>( MappingFileObject,
00522                        (PLARGE_INTEGER) &amp;StartingOffset,
00523                        ByteCount,
00524                        &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>,
00525                        &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a> );
00526 
00527             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00528         }
00529 
00530         <span class="comment">//</span>
00531         <span class="comment">//  Update the current file position in the user file object.</span>
00532         <span class="comment">//</span>
00533 
00534         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> &amp;&amp; !PagingIo &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00535 
00536             IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a>.QuadPart = ByteRange;
00537         }
00538 
00539     } finally {
00540 
00541         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfCommonRead"</span> );
00542 
00543         <span class="comment">//</span>
00544         <span class="comment">//  Release the Fcb.</span>
00545         <span class="comment">//</span>
00546 
00547         <span class="keywordflow">if</span> (ReleaseFile) {
00548 
00549             <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, Fcb );
00550         }
00551     }
00552 
00553     <span class="comment">//</span>
00554     <span class="comment">//  Post the request if we got CANT_WAIT.</span>
00555     <span class="comment">//</span>
00556 
00557     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_WAIT) {
00558 
00559         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, Irp );
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">//  Otherwise complete the request.</span>
00563     <span class="comment">//</span>
00564 
00565     } <span class="keywordflow">else</span> {
00566 
00567         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00568     }
00569 
00570     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00571 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
