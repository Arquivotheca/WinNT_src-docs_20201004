<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: w32/ntuser/kernel/security.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>security.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a0">_SECURITY</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PACCESS_ALLOWED_ACE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a3">AllocAce</a> (PACCESS_ALLOWED_ACE pace, <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bType, <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bFlags, ACCESS_MASK am, PSID psid, LPDWORD lpdwLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSECURITY_DESCRIPTOR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a4">CreateSecurityDescriptor</a> (PACCESS_ALLOWED_ACE paceList, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbAce, BOOLEAN fDaclDefaulted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a5">InitSecurity</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a6">TestForInteractiveUser</a> (PLUID pluidCaller)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a7">_UserTestForWinStaAccess</a> (PUNICODE_STRING pstrWinSta, BOOL fInherit)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a8">CheckGrantedAccess</a> (ACCESS_MASK amGranted, ACCESS_MASK amRequest)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a9">CheckWinstaWriteAttributesAccess</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a10">AccessCheckObject</a> (PVOID pobj, ACCESS_MASK amRequest, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, CONST GENERIC_MAPPING *pGenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a11">IsPrivileged</a> (PPRIVILEGE_SET ppSet)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a12">_GetUserObjectInformation</a> (HANDLE h, int nIndex, PVOID ccxpvInfo, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nLength, LPDWORD lpnLengthNeeded)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a13">_SetUserObjectInformation</a> (HANDLE h, int nIndex, PVOID ccxpvInfo, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a14">UserScreenAccessCheck</a> (VOID)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PSECURITY_DESCRIPTOR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a1">gpsdInitWinSta</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRIVILEGE_SET&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a2">psTcb</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="w32/ntuser/kernel/security.c::_SECURITY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define _SECURITY&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00013">13</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a12" doxytag="w32/ntuser/kernel/security.c::_GetUserObjectInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _GetUserObjectInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>h</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>nIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ccxpvInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>nLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPDWORD&nbsp;</td>
          <td class="mdname" nowrap> <em>lpnLengthNeeded</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00626">626</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04464">CheckHandleFlag()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00033">ExDesktopObjectType</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00056">_OBJECT_HANDLE_INFORMATION::HandleAttributes</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07289">HF_DESKTOPHOOK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01539">LogDesktop</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00189">_OBJECT_TYPE::Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04569">POBJECT_NAME</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02743">tagWINDOWSTATION::psidUser</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00059">PtiCurrentShared</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l02704">WSF_NOIO</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00662">NtUserGetObjectInformation()</a>.
<p>
<pre class="fragment"><div>00632 {
00633     PUSEROBJECTFLAGS puof;
00634     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00635     PVOID pObject;
00636     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> pHead;
00637     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLengthNeeded = 0;
00638     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> ohi;
00639     PUNICODE_STRING pstrInfo;
00640     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00641     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00642 
00643     <span class="comment">/*</span>
00644 <span class="comment">     * Validate the object</span>
00645 <span class="comment">     */</span>
00646     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00647             h,
00648             0,
00649             NULL,
00650             UserMode,   <span class="comment">// this is always called from the client side</span>
00651             &amp;pObject,
00652             &amp;ohi);
00653     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00654         RIPNTERR0(Status, RIP_VERBOSE, <span class="stringliteral">"ObReferenceObjectByHandle Failed"</span>);
00655         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00656     }
00657 
00658     pHead = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject);
00659     <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a> &amp;&amp;
00660             pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00661         RIPERR0(ERROR_INVALID_FUNCTION, RIP_WARNING, <span class="stringliteral">"Object is not a USER object"</span>);
00662         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pObject);
00663         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00664     }
00665 
00666 <span class="preprocessor">#ifdef LOGDESKTOPLOCKS</span>
00667 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00668         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pObject, LD_REF_FN_GETUSEROBJECTINFORMATION, TRUE, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>());
00669     }
00670 <span class="preprocessor">#endif</span>
00671 <span class="preprocessor"></span>
00672     <span class="keywordflow">try</span> {
00673         <span class="keywordflow">switch</span> (nIndex) {
00674         <span class="keywordflow">case</span> UOI_FLAGS:
00675             dwLengthNeeded = <span class="keyword">sizeof</span>(USEROBJECTFLAGS);
00676             <span class="keywordflow">if</span> (nLength &lt; <span class="keyword">sizeof</span>(USEROBJECTFLAGS)) {
00677                 RIPERR0(ERROR_INSUFFICIENT_BUFFER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00678                 fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00679                 <span class="keywordflow">break</span>;
00680             }
00681             puof = ccxpvInfo;
00682             puof-&gt;fInherit = (ohi.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; OBJ_INHERIT) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00683             puof-&gt;fReserved = 0;
00684             puof-&gt;dwFlags = 0;
00685             <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00686                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2070">CheckHandleFlag</a>(h, HF_DESKTOPHOOK))
00687                     puof-&gt;dwFlags |= DF_ALLOWOTHERACCOUNTHOOK;
00688             } <span class="keywordflow">else</span> {
00689                 <span class="keywordflow">if</span> (!(((<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>)pObject)-&gt;dwWSF_Flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>))
00690                     puof-&gt;dwFlags |= WSF_VISIBLE;
00691             }
00692             <span class="keywordflow">break</span>;
00693 
00694         <span class="keywordflow">case</span> UOI_NAME:
00695             pstrInfo = <a class="code" href="../../d4/d1/userk_8h.html#a522">POBJECT_NAME</a>(pObject);
00696             <span class="keywordflow">goto</span> docopy;
00697 
00698         <span class="keywordflow">case</span> UOI_TYPE:
00699             pstrInfo = &amp;pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>;
00700 docopy:
00701             <span class="keywordflow">if</span> (pstrInfo) {
00702                 dwLengthNeeded = pstrInfo-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
00703                 <span class="keywordflow">if</span> (dwLengthNeeded &gt; nLength) {
00704                     RIPERR0(ERROR_INSUFFICIENT_BUFFER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00705                     fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00706                     <span class="keywordflow">break</span>;
00707                 }
00708                 RtlCopyMemory(ccxpvInfo, pstrInfo-&gt;Buffer, pstrInfo-&gt;Length);
00709                 *(PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpvInfo + pstrInfo-&gt;Length) = 0;
00710             } <span class="keywordflow">else</span> {
00711                 dwLengthNeeded = 0;
00712             }
00713             <span class="keywordflow">break</span>;
00714 
00715         <span class="keywordflow">case</span> UOI_USER_SID:
00716             <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>)
00717                 pwinsta = pObject;
00718             <span class="keywordflow">else</span>
00719                 pwinsta = ((<a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>)pObject)-&gt;rpwinstaParent;
00720             <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00721                 dwLengthNeeded = 0;
00722             } <span class="keywordflow">else</span> {
00723                 dwLengthNeeded = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>);
00724                 <span class="keywordflow">if</span> (dwLengthNeeded &gt; nLength) {
00725                     RIPERR0(ERROR_INSUFFICIENT_BUFFER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00726                     fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00727                     <span class="keywordflow">break</span>;
00728                 }
00729                 RtlCopyMemory(ccxpvInfo, pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>, dwLengthNeeded);
00730             }
00731             <span class="keywordflow">break</span>;
00732 
00733         <span class="keywordflow">default</span>:
00734             RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00735             fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00736             <span class="keywordflow">break</span>;
00737         }
00738     } except (W32ExceptionHandler(TRUE, RIP_WARNING)) {
00739         fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00740     }
00741 
00742     *lpnLengthNeeded = dwLengthNeeded;
00743 
00744 <span class="preprocessor">#ifdef LOGDESKTOPLOCKS</span>
00745 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00746         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pObject, LD_DEREF_FN_GETUSEROBJECTINFORMATION, FALSE, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>());
00747     }
00748 <span class="preprocessor">#endif</span>
00749 <span class="preprocessor"></span>
00750     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pObject);
00751 
00752     <span class="keywordflow">return</span> fSuccess;
00753 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="w32/ntuser/kernel/security.c::_SetUserObjectInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _SetUserObjectInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>h</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>nIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ccxpvInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>nLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00764">764</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00033">ExDesktopObjectType</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07289">HF_DESKTOPHOOK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01539">LogDesktop</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04494">SetHandleFlag()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00831">NtUserSetObjectInformation()</a>.
<p>
<pre class="fragment"><div>00769 {
00770     PUSEROBJECTFLAGS puof;
00771     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00772     PVOID pObject;
00773     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> pHead;
00774     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLengthNeeded = 0;
00775     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> ohi;
00776     OBJECT_HANDLE_FLAG_INFORMATION ofi;
00777     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00778 
00779     <span class="comment">/*</span>
00780 <span class="comment">     * Validate the object</span>
00781 <span class="comment">     */</span>
00782     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00783             h,
00784             0,
00785             NULL,
00786             UserMode,   <span class="comment">// this is always called from the client side</span>
00787             &amp;pObject,
00788             &amp;ohi);
00789     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00790         RIPNTERR0(Status, RIP_VERBOSE, <span class="stringliteral">"ObReferenceObjectByHandle Failed"</span>);
00791         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00792     }
00793 
00794     pHead = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject);
00795     <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a> &amp;&amp;
00796             pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00797         RIPERR0(ERROR_INVALID_FUNCTION, RIP_WARNING, <span class="stringliteral">"Object is not a USER object"</span>);
00798         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pObject);
00799         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00800     }
00801 
00802 <span class="preprocessor">#ifdef LOGDESKTOPLOCKS</span>
00803 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00804         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pObject, LD_REF_FN_SETUSEROBJECTINFORMATION, TRUE, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00805     }
00806 <span class="preprocessor">#endif</span>
00807 <span class="preprocessor"></span>
00808     <span class="keywordflow">try</span> {
00809         <span class="keywordflow">switch</span> (nIndex) {
00810         <span class="keywordflow">case</span> UOI_FLAGS:
00811             <span class="keywordflow">if</span> (nLength &lt; <span class="keyword">sizeof</span>(USEROBJECTFLAGS)) {
00812                 RIPERR0(ERROR_INVALID_DATA, RIP_VERBOSE, <span class="stringliteral">""</span>);
00813                 fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00814                 <span class="keywordflow">break</span>;
00815             }
00816             puof = ccxpvInfo;
00817             ZwQueryObject(h, ObjectHandleFlagInformation,
00818                     &amp;ofi, <span class="keyword">sizeof</span>(ofi), NULL);
00819             ofi.Inherit = (puof-&gt;fInherit != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00820             ZwSetInformationObject(h, ObjectHandleFlagInformation,
00821                     &amp;ofi, <span class="keyword">sizeof</span>(ofi));
00822             <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00823                 <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(h, HF_DESKTOPHOOK,
00824                         puof-&gt;dwFlags &amp; DF_ALLOWOTHERACCOUNTHOOK);
00825             }
00826             <span class="keywordflow">break</span>;
00827         <span class="keywordflow">default</span>:
00828             RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00829             fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00830             <span class="keywordflow">break</span>;
00831         }
00832     } except (W32ExceptionHandler(TRUE, RIP_WARNING)) {
00833         fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00834     }
00835 
00836 <span class="preprocessor">#ifdef LOGDESKTOPLOCKS</span>
00837 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00838         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pObject, LD_DEREF_FN_SETUSEROBJECTINFORMATION, FALSE, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00839     }
00840 <span class="preprocessor">#endif</span>
00841 <span class="preprocessor"></span>
00842     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pObject);
00843 
00844     <span class="keywordflow">return</span> fSuccess;
00845 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="w32/ntuser/kernel/security.c::_UserTestForWinStaAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS _UserTestForWinStaAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>pstrWinSta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fInherit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00295">295</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d9/d7/winsta_8c-source.html#l01019">_OpenWindowStation()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00555">AccessCheckObject()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04567">DEFAULT_WINSTA</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00938">gbSecureDesktop</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00648">grpWinStaList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00656">luidSystem</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02742">tagWINDOWSTATION::luidUser</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00017">OpenEffectiveToken()</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00805">WinStaMapping</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/desktop_8c-source.html#l04821">xxxResolveDesktop()</a>.
<p>
<pre class="fragment"><div>00299 {
00300     PTOKEN_STATISTICS   pStats;
00301     ULONG               BytesRequired;
00302     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>      pwinsta;
00303     HWINSTA             hwsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00304     OBJECT_ATTRIBUTES   ObjAttr;
00305     POBJECT_ATTRIBUTES  pObjAttr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00306     PUNICODE_STRING     pstrStatic;
00307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  STATUS_SUCCESS;
00308     SIZE_T              cbObjA;
00309     UNICODE_STRING      strDefWinSta;
00310     HANDLE              htoken;
00311 
00312     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00313 
00314     UserAssert(NtCurrentTeb());
00315     UserAssert(pstrWinSta-&gt;Buffer == NtCurrentTeb()-&gt;StaticUnicodeBuffer);
00316 
00317     <span class="comment">/*</span>
00318 <span class="comment">     * If we are testing against Default WindowStation (WinSta0) retreive</span>
00319 <span class="comment">     * pwinsta from the top of the grpwinstaList instead of doing an</span>
00320 <span class="comment">     * OpenWindowStation()</span>
00321 <span class="comment">     *</span>
00322 <span class="comment">     * !!!</span>
00323 <span class="comment">     *</span>
00324 <span class="comment">     * This relies on the fact that there is only ONE interactive</span>
00325 <span class="comment">     * windowstation and that it is the first one in the list.</span>
00326 <span class="comment">     * If multiple windowstations are ever supported</span>
00327 <span class="comment">     * a lookup will have to be done instead.</span>
00328 <span class="comment">     */</span>
00329     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDefWinSta, DEFAULT_WINSTA);
00330     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(pstrWinSta, &amp;strDefWinSta, TRUE)) {
00331 
00332 
00333         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status = <a class="code" href="../../d4/d1/userk_8h.html#a960">OpenEffectiveToken</a>(&amp;htoken))) {
00334             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00335         }
00336 
00337         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationToken(
00338                      htoken,                 <span class="comment">// Handle</span>
00339                      TokenStatistics,           <span class="comment">// TokenInformationClass</span>
00340                      NULL,                      <span class="comment">// TokenInformation</span>
00341                      0,                         <span class="comment">// TokenInformationLength</span>
00342                      &amp;BytesRequired             <span class="comment">// ReturnLength</span>
00343                      );
00344 
00345         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL) {
00346             ZwClose(htoken);
00347             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00348         }
00349 
00350         <span class="comment">//</span>
00351         <span class="comment">// Allocate space for the user info</span>
00352         <span class="comment">//</span>
00353 
00354         pStats = (PTOKEN_STATISTICS)UserAllocPoolWithQuota(BytesRequired, TAG_SECURITY);
00355         <span class="keywordflow">if</span> (pStats == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00356             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00357             ZwClose(htoken);
00358             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00359         }
00360 
00361         <span class="comment">//</span>
00362         <span class="comment">// Read in the user info</span>
00363         <span class="comment">//</span>
00364 
00365         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status = ZwQueryInformationToken(
00366                      htoken,             <span class="comment">// Handle</span>
00367                      TokenStatistics,       <span class="comment">// TokenInformationClass</span>
00368                      pStats,                <span class="comment">// TokenInformation</span>
00369                      BytesRequired,         <span class="comment">// TokenInformationLength</span>
00370                      &amp;BytesRequired         <span class="comment">// ReturnLength</span>
00371                      ))) {
00372             ZwClose(htoken);
00373             UserFreePool(pStats);
00374             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00375         }
00376 
00377         <span class="comment">/*</span>
00378 <span class="comment">         * Make sure that current process has access to this window station</span>
00379 <span class="comment">         */</span>
00380         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00381 
00382         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00383 
00384             <span class="comment">/*</span>
00385 <span class="comment">             * !!!</span>
00386 <span class="comment">             *</span>
00387 <span class="comment">             * This relies on the fact that there is only ONE interactive</span>
00388 <span class="comment">             * windowstation and that it is the first one in the list.</span>
00389 <span class="comment">             * If multiple windowstations are ever supported</span>
00390 <span class="comment">             * a lookup will have to be done here.</span>
00391 <span class="comment">             */</span>
00392             pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
00393 
00394             <span class="comment">/*</span>
00395 <span class="comment">             * For now we will just do the user luid test till we figure out</span>
00396 <span class="comment">             * what fInherit means for a Multi-User system</span>
00397 <span class="comment">             */</span>
00398             <span class="keywordflow">if</span> (fInherit) {
00399                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;pStats-&gt;AuthenticationId, &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>)) ||
00400                      (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;pStats-&gt;AuthenticationId, &amp;luidSystem)) ||
00401                      (<a class="code" href="../../d4/d1/userk_8h.html#a1271">AccessCheckObject</a>(pwinsta, GENERIC_EXECUTE, (KPROCESSOR_MODE)(gbSecureDesktop ? UserMode : KernelMode), &amp;WinStaMapping)) )  {
00402                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00403                 }
00404             } <span class="keywordflow">else</span> {
00405                 <span class="comment">/* Bug 42905. Service Controller clears the flag</span>
00406 <span class="comment">                 * ScStartupInfo.dwFlags &amp;= (~STARTF_DESKTOPINHERIT) to make services</span>
00407 <span class="comment">                 * running under the context of system non-interactive. Hence if fInherit</span>
00408 <span class="comment">                 * is false don't do the SystemLuid and AccessCheckObject tests.</span>
00409 <span class="comment">                 */</span>
00410 
00411                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;pStats-&gt;AuthenticationId, &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>)) {
00412                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00413                 }
00414             }
00415         }
00416 
00417         ZwClose(htoken);
00418         UserFreePool(pStats);
00419         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00420     }
00421 
00422     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a>) {
00423         <span class="comment">/*</span>
00424 <span class="comment">         * Since we don't have a pointer to the WindowStation Object we will do</span>
00425 <span class="comment">         * a OpenWindowStation() to make sure we have the desired access.</span>
00426 <span class="comment">         */</span>
00427         cbObjA = <span class="keyword">sizeof</span>(*pObjAttr) + <span class="keyword">sizeof</span>(*pstrStatic);
00428         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(NtCurrentProcess(),
00429                 &amp;pObjAttr, 0, &amp;cbObjA, MEM_COMMIT, PAGE_READWRITE);
00430         pstrStatic = (PUNICODE_STRING)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pObjAttr + <span class="keyword">sizeof</span>(*pObjAttr));
00431 
00432         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00433 
00434             <span class="comment">/*</span>
00435 <span class="comment">             * Note -- the string must be in client-space or the</span>
00436 <span class="comment">             * address validation in OpenWindowStation will fail.</span>
00437 <span class="comment">             *</span>
00438 <span class="comment">             * This code is called from xxxResolveDesktop and the buffer of the passed-in string</span>
00439 <span class="comment">             * is in the teb already.</span>
00440 <span class="comment">             */</span>
00441             <span class="keywordflow">try</span> {
00442                 *pstrStatic = *pstrWinSta;
00443                 InitializeObjectAttributes( pObjAttr,
00444                                             pstrStatic,
00445                                             OBJ_CASE_INSENSITIVE,
00446                                             NULL,
00447                                             NULL
00448                                             );
00449             } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
00450                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00451             }
00452 
00453             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00454                 hwsta = <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(pObjAttr, GENERIC_EXECUTE, UserMode);
00455             }
00456         } <span class="keywordflow">else</span> {
00457             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00458         }
00459 
00460         <span class="keywordflow">if</span> (pObjAttr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00461             ZwFreeVirtualMemory(NtCurrentProcess(), &amp;pObjAttr, &amp;cbObjA,
00462                             MEM_RELEASE);
00463         }
00464     } <span class="keywordflow">else</span> {
00465         InitializeObjectAttributes( &amp;ObjAttr,
00466                                     pstrWinSta,
00467                                     OBJ_CASE_INSENSITIVE,
00468                                     NULL,
00469                                     NULL
00470                                     );
00471         hwsta = <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(&amp;ObjAttr, GENERIC_EXECUTE, KernelMode);
00472     }
00473 
00474     <span class="keywordflow">if</span> (!hwsta) {
00475         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00476     }
00477 
00478     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwClose(hwsta);
00479 
00480     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00481     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00482 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="w32/ntuser/kernel/security.c::AccessCheckObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL AccessCheckObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>pobj</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>amRequest</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>CONST GENERIC_MAPPING *&nbsp;</td>
          <td class="mdname" nowrap> <em>pGenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00555">555</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00804">KeyMapping</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00180">SeCreateAccessState()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00348">SeDeleteAccessState()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/winsta_8c-source.html#l01264">_BuildNameList()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00295">_UserTestForWinStaAccess()</a>, <a class="el" href="../../d2/d6/w32_2ntuser_2kernel_2profile_8c-source.html#l00263">OpenCacheKeyEx()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l01366">ReferenceWindowStation()</a>, and <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03213">xxxMouseEventDirect()</a>.
<p>
<pre class="fragment"><div>00560 {
00561     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00562     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> AccessState;
00563     BOOLEAN fAccessGranted;
00564     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00565     BOOLEAN bMutexLocked = (pGenericMapping == (&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a303">KeyMapping</a>));
00566     <span class="comment">/*</span>
00567 <span class="comment">     * Due to a resource problem in the object manager, we must pass in a TRUE</span>
00568 <span class="comment">     * when checking access for registry keys, even if we do not explicitly have</span>
00569 <span class="comment">     * the object type mutex.  If we do not, we can get into a deadlock situation with this mutex</span>
00570 <span class="comment">     * and the CmpRegistry lock.</span>
00571 <span class="comment">     */</span>
00572 
00573     <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>(&amp;AccessState, &amp;AuxData, amRequest, (PGENERIC_MAPPING)pGenericMapping);
00574     fAccessGranted = <a class="code" href="../../d9/d1/obse_8c.html#a3">ObCheckObjectAccess</a>(
00575             pobj,
00576             &amp;AccessState,
00577             bMutexLocked,
00578             AccessMode,
00579             &amp;Status);
00580     <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>(&amp;AccessState);
00581     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(fAccessGranted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00582 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="w32/ntuser/kernel/security.c::AllocAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PACCESS_ALLOWED_ACE AllocAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PACCESS_ALLOWED_ACE&nbsp;</td>
          <td class="mdname" nowrap> <em>pace</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>bType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>bFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>am</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>psid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPDWORD&nbsp;</td>
          <td class="mdname" nowrap> <em>lpdwLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00037">37</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00152">InitSecurity()</a>, and <a class="el" href="../../d3/d6/service_8c-source.html#l00025">xxxConnectService()</a>.
<p>
<pre class="fragment"><div>00044 {
00045     PACCESS_ALLOWED_ACE paceNew;
00046     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> iEnd;
00047     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLength, dwLengthSid;
00048 
00049     <span class="comment">/*</span>
00050 <span class="comment">     * Allocate space for the ACE.</span>
00051 <span class="comment">     */</span>
00052     dwLengthSid = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(psid);
00053     dwLength = dwLengthSid + <span class="keyword">sizeof</span>(ACE_HEADER) + <span class="keyword">sizeof</span>(ACCESS_MASK);
00054     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00055         iEnd = 0;
00056         pace = UserAllocPoolWithQuota(dwLength, TAG_SECURITY);
00057         <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00058             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00059     } <span class="keywordflow">else</span> {
00060         iEnd = *lpdwLength;
00061         paceNew = UserAllocPoolWithQuota(iEnd + dwLength, TAG_SECURITY);
00062         <span class="keywordflow">if</span> (paceNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00063             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00064         RtlCopyMemory(paceNew, pace, iEnd);
00065         UserFreePool(pace);
00066         pace = paceNew;
00067     }
00068     *lpdwLength = dwLength + iEnd;
00069 
00070     <span class="comment">/*</span>
00071 <span class="comment">     * Insert the new ACE.</span>
00072 <span class="comment">     */</span>
00073     paceNew = (PACCESS_ALLOWED_ACE)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pace + iEnd);
00074     paceNew-&gt;Header.AceType = bType;
00075     paceNew-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)dwLength;
00076     paceNew-&gt;Header.AceFlags = bFlags;
00077     paceNew-&gt;Mask = am;
00078     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(dwLengthSid, &amp;paceNew-&gt;SidStart, psid);
00079     <span class="keywordflow">return</span> pace;
00080 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="w32/ntuser/kernel/security.c::CheckGrantedAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL CheckGrantedAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>amGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>amRequest</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00492">492</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03309">RtlAreAllAccessesGranted()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05082">NtUserGetCaretBlinkTime()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05142">NtUserGetDoubleClickTime()</a>, and <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03213">xxxMouseEventDirect()</a>.
<p>
<pre class="fragment"><div>00495 {
00496 
00497     <span class="comment">/*</span>
00498 <span class="comment">     * Check the granted access.</span>
00499 <span class="comment">     */</span>
00500     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(amGranted, amRequest)) {
00501         RIPERR0(ERROR_ACCESS_DENIED, RIP_VERBOSE, <span class="stringliteral">""</span>);
00502         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00503     }
00504     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00505 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="w32/ntuser/kernel/security.c::CheckWinstaWriteAttributesAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL CheckWinstaWriteAttributesAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00518">518</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03490">tagPROCESSINFO::amwinsta</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00793">gpidLogon</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00084">PpiCurrent</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03309">RtlAreAllAccessesGranted()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d1/hotkeys_8c-source.html#l00125">_RegisterHotKey()</a>, <a class="el" href="../../d5/d4/caret_8c-source.html#l00513">_SetCaretBlinkTime()</a>, <a class="el" href="../../d0/d8/sysmet_8c-source.html#l00074">_SetDoubleClickTime()</a>, <a class="el" href="../../d0/d8/sysmet_8c-source.html#l00225">xxxSetSysColors()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l01497">xxxSystemParametersInfo()</a>, <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00216">zzzClipCursor()</a>, <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00080">zzzSetCursorPos()</a>, and <a class="el" href="../../d5/d3/kernel_2acons_8c-source.html#l00028">zzzSetSystemCursor()</a>.
<p>
<pre class="fragment"><div>00519 {
00520     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
00521 
00522     <span class="comment">/*</span>
00523 <span class="comment">     * winlogon has rights to all windowstations.</span>
00524 <span class="comment">     */</span>
00525     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>)
00526         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00527 
00528     <span class="keywordflow">if</span> (!(ppiCurrent-&gt;W32PF_Flags &amp; W32PF_IOWINSTA)) {
00529         RIPERR0(ERROR_REQUIRES_INTERACTIVE_WINDOWSTATION,
00530                 RIP_WARNING,
00531                 <span class="stringliteral">"Operation invalid on a non-interactive WindowStation."</span>);
00532 
00533         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00534     }
00535 
00536     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(ppiCurrent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o16">amwinsta</a>, WINSTA_WRITEATTRIBUTES)) {
00537         RIPERR0(ERROR_ACCESS_DENIED,
00538                 RIP_WARNING,
00539                 <span class="stringliteral">"WINSTA_WRITEATTRIBUTES access to WindowStation denied."</span>);
00540 
00541         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00542     }
00543     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00544 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="w32/ntuser/kernel/security.c::CreateSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSECURITY_DESCRIPTOR CreateSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PACCESS_ALLOWED_ACE&nbsp;</td>
          <td class="mdname" nowrap> <em>paceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cbAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>fDaclDefaulted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">91</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00718">RtlAddAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03135">RtlSetGroupSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02963">RtlSetOwnerSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02756">RtlSetSaclSecurityDescriptor()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00152">InitSecurity()</a>, <a class="el" href="../../d3/d6/service_8c-source.html#l00025">xxxConnectService()</a>, and <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>.
<p>
<pre class="fragment"><div>00095 {
00096     PSECURITY_DESCRIPTOR psd;
00097     PACL pacl;
00098     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00099 
00100     <span class="comment">/*</span>
00101 <span class="comment">     * Allocate the security descriptor</span>
00102 <span class="comment">     */</span>
00103     psd = (PSECURITY_DESCRIPTOR)UserAllocPoolWithQuota(
00104             cbAce + <span class="keyword">sizeof</span>(ACL) + SECURITY_DESCRIPTOR_MIN_LENGTH,
00105             TAG_SECURITY);
00106     <span class="keywordflow">if</span> (psd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00107         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00108     <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(psd, SECURITY_DESCRIPTOR_REVISION);
00109 
00110     <span class="comment">/*</span>
00111 <span class="comment">     * Initialize the ACL</span>
00112 <span class="comment">     */</span>
00113     pacl = (PACL)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)psd + SECURITY_DESCRIPTOR_MIN_LENGTH);
00114     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(pacl, <span class="keyword">sizeof</span>(ACL) + cbAce, ACL_REVISION);
00115     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00116 
00117         <span class="comment">/*</span>
00118 <span class="comment">         * Add the ACEs to the ACL.</span>
00119 <span class="comment">         */</span>
00120         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a>(pacl, ACL_REVISION, MAXULONG, paceList, cbAce);
00121         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00122 
00123             <span class="comment">/*</span>
00124 <span class="comment">             * Initialize the SD</span>
00125 <span class="comment">             */</span>
00126             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(psd, (BOOLEAN)TRUE,
00127                     pacl, fDaclDefaulted);
00128             <a class="code" href="../../d8/d6/sertl_8c.html#a62">RtlSetSaclSecurityDescriptor</a>(psd, (BOOLEAN)FALSE, NULL,
00129                     (BOOLEAN)FALSE);
00130             <a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a>(psd, NULL, (BOOLEAN)FALSE);
00131             <a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a>(psd, NULL, (BOOLEAN)FALSE);
00132         }
00133     }
00134 
00135     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00136         UserFreePool(psd);
00137         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00138     }
00139 
00140     <span class="keywordflow">return</span> psd;
00141 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="w32/ntuser/kernel/security.c::InitSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL InitSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00152">152</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00037">AllocAce()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00026">gpsdInitWinSta</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00377">_SE_EXPORTS::SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01589">SeEnableAccessToExports</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01590">SeExports</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00392">_SE_EXPORTS::SeRestrictedSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00360">_SE_EXPORTS::SeWorldSid</a>, and <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00805">WinStaMapping</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02249">Win32UserInitialize()</a>.
<p>
<pre class="fragment"><div>00154 {
00155     PACCESS_ALLOWED_ACE paceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pace;
00156     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLength;
00157 
00158     <span class="comment">/*</span>
00159 <span class="comment">     * Get access to exported constants</span>
00160 <span class="comment">     */</span>
00161     <a class="code" href="../../d0/d5/se_8h.html#a18">SeEnableAccessToExports</a>();
00162 
00163     <span class="comment">/*</span>
00164 <span class="comment">     * Create ACE list.</span>
00165 <span class="comment">     */</span>
00166     paceList = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(NULL,
00167             ACCESS_ALLOWED_ACE_TYPE,
00168             CONTAINER_INHERIT_ACE | INHERIT_ONLY_ACE | NO_PROPAGATE_INHERIT_ACE,
00169             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>.GenericAll,
00170             <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>,
00171             &amp;dwLength);
00172     <span class="keywordflow">if</span> (paceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00173         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00174 
00175     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList,
00176             ACCESS_ALLOWED_ACE_TYPE,
00177             CONTAINER_INHERIT_ACE | INHERIT_ONLY_ACE | NO_PROPAGATE_INHERIT_ACE,
00178             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>.GenericAll,
00179             <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o43">SeRestrictedSid</a>,
00180             &amp;dwLength);
00181     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00182         UserFreePool(paceList);
00183         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00184     }
00185     paceList = pace;
00186 
00187     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00188             OBJECT_INHERIT_ACE | INHERIT_ONLY_ACE,
00189             GENERIC_ALL, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>, &amp;dwLength);
00190     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00191         UserFreePool(paceList);
00192         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00193     }
00194     paceList = pace;
00195 
00196     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00197             OBJECT_INHERIT_ACE | INHERIT_ONLY_ACE,
00198             GENERIC_ALL, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o43">SeRestrictedSid</a>, &amp;dwLength);
00199     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200         UserFreePool(paceList);
00201         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00202     }
00203     paceList = pace;
00204 
00205     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00206             0, DIRECTORY_QUERY | DIRECTORY_CREATE_OBJECT,
00207             <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o34">SeAliasAdminsSid</a>, &amp;dwLength);
00208     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00209         UserFreePool(paceList);
00210         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00211     }
00212     paceList = pace;
00213 
00214     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00215             0, DIRECTORY_TRAVERSE, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>, &amp;dwLength);
00216     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00217         UserFreePool(paceList);
00218         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00219     }
00220     paceList = pace;
00221 
00222     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00223             0, DIRECTORY_TRAVERSE, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o43">SeRestrictedSid</a>, &amp;dwLength);
00224     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00225         UserFreePool(paceList);
00226         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227     }
00228     paceList = pace;
00229 
00230     <span class="comment">/*</span>
00231 <span class="comment">     * Create the SD</span>
00232 <span class="comment">     */</span>
00233     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1268">CreateSecurityDescriptor</a>(paceList, dwLength, FALSE);
00234     UserFreePool(paceList);
00235 
00236     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00237         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Initial windowstation security was not created!"</span>);
00238     }
00239 
00240     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00241 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="w32/ntuser/kernel/security.c::IsPrivileged" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL IsPrivileged           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ppSet</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00593">593</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
<pre class="fragment"><div>00595 {
00596     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> Context;
00597     BOOLEAN bHeld;
00598 
00599     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>(&amp;Context);
00600     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>(&amp;Context);
00601 
00602     bHeld = <a class="code" href="../../d8/d4/privileg_8c.html#a1">SePrivilegeCheck</a>(ppSet, &amp;Context, UserMode);
00603     <a class="code" href="../../d3/d5/seaudit_8c.html#a13">SePrivilegeObjectAuditAlarm</a>(NULL, &amp;Context, 0, ppSet, bHeld, UserMode);
00604 
00605     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>(&amp;Context);
00606     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>(&amp;Context);
00607 
00608     <span class="keywordflow">if</span> (!bHeld)
00609         RIPERR0(ERROR_PRIVILEGE_NOT_HELD, RIP_VERBOSE, <span class="stringliteral">""</span>);
00610 
00611     <span class="comment">/*</span>
00612 <span class="comment">     * Return result of privilege check</span>
00613 <span class="comment">     */</span>
00614     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)bHeld;
00615 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="w32/ntuser/kernel/security.c::TestForInteractiveUser" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS TestForInteractiveUser           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PLUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pluidCaller</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00255">255</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00648">grpWinStaList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02742">tagWINDOWSTATION::luidUser</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07662">NtUserTestForInteractiveUser()</a>.
<p>
<pre class="fragment"><div>00258 {
00259     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00260 
00261     UserAssert(grpWinStaList != NULL);
00262 
00263     <span class="comment">/*</span>
00264 <span class="comment">     * !!!</span>
00265 <span class="comment">     *</span>
00266 <span class="comment">     * This relies on the fact that there is only ONE interactive</span>
00267 <span class="comment">     * windowstation and that it is the first one in the list.</span>
00268 <span class="comment">     * If multiple windowstations are ever supported</span>
00269 <span class="comment">     * a lookup will have to be done here.</span>
00270 <span class="comment">     */</span>
00271     pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
00272 
00273     <span class="comment">/*</span>
00274 <span class="comment">     * Compare it with the id of the logged on user.</span>
00275 <span class="comment">     */</span>
00276     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(pluidCaller, &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>))
00277         <span class="keywordflow">return</span> STATUS_SUCCESS;
00278     <span class="keywordflow">else</span>
00279         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00280 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="w32/ntuser/kernel/security.c::UserScreenAccessCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL FASTCALL UserScreenAccessCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00863">863</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00034">FASTCALL</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00456">grpdeskRitInput</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l00059">PtiCurrentShared</a>.
<p>
<pre class="fragment"><div>00864 {
00865     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() != NULL);
00866 
00867     <span class="keywordflow">return</span> (
00868             <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;rpdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> &amp;&amp;
00869             (W32GetCurrentProcess()-&gt;W32PF_Flags &amp; (W32PF_READSCREENACCESSGRANTED | W32PF_IOWINSTA)) ==
00870                     (W32PF_READSCREENACCESSGRANTED | W32PF_IOWINSTA));
00871 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="w32/ntuser/kernel/security.c::gpsdInitWinSta" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSECURITY_DESCRIPTOR <a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a1">gpsdInitWinSta</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00022">22</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="w32/ntuser/kernel/security.c::psTcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRIVILEGE_SET <a class="el" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a2">psTcb</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> { 1, PRIVILEGE_SET_ALL_NECESSARY,
    { SE_TCB_PRIVILEGE, 0 }
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00024">24</a> of file <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html">w32/ntuser/kernel/security.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/logon_8c-source.html#l00025">_RegisterLogonProcess()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l02053">SrvRegisterServicesProcess()</a>, and <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l00781">xxxWrapSendMessageBSM()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
