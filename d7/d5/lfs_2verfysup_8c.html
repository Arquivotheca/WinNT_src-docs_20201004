<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lfs/verfysup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>verfysup.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>"</code><br>

<p>
<a href="../../d8/d4/lfs_2verfysup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/lfs_2verfysup_8c.html#a0">LfsCurrentAvailSpace</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, OUT PLONGLONG CurrentAvailSpace, OUT PULONG CurrentPageBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/lfs_2verfysup_8c.html#a1">LfsVerifyLogSpaceAvail</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch, IN ULONG RemainingLogBytes, IN LONG UndoRequirement, IN BOOLEAN ForceToDisk)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/lfs_2verfysup_8c.html#a2">LfsFindCurrentAvail</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="lfs/verfysup.c::LfsCurrentAvailSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsCurrentAvailSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentAvailSpace</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentPageBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00036">36</a> of file <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html">lfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00219">_LBCB::BufferOffset</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00286">LBCB_FLUSH_COPY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00285">LBCB_NOT_EMPTY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00134">LfsFlushToLsnPriv()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01141">LfsReadLogFileInformation()</a>, and <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00114">LfsVerifyLogSpaceAvail()</a>.
<p>
<pre class="fragment"><div>00044                    :
00045 
00046     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available log space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00047     It returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total number of free bytes and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number available on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00048     active page <span class="keywordflow">if</span> present.  The total free bytes will reflect all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> empty
00049     pages as well as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active page.
00050 
00051 Arguments:
00052 
00053     Lfcb - Lfcb <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00054 
00055     CurrentAvailSpace - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes available <span class="keywordflow">for</span> log
00056                         records.
00057 
00058     CurrentPageBytes - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes remaining on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00059                        current log page.
00060 
00061 Return Value:
00062 
00063     None.
00064 
00065 --*/
00066 
00067 {
00068     *CurrentPageBytes = 0;
00069 
00070     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00071 
00072     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsCurrentAvailSpace:  Entered\n"</span>, 0 );
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">//  Get the total number from the Lfcb.</span>
00076     <span class="comment">//</span>
00077 
00078     *CurrentAvailSpace = Lfcb-&gt;CurrentAvailable;
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">//  We now look to see if there are any bytes available on the Lbcb in</span>
00082     <span class="comment">//  the active queue.  We can add this to the bytes available in the</span>
00083     <span class="comment">//  log pages and also give this back to the caller.</span>
00084     <span class="comment">//</span>
00085 
00086     <span class="keywordflow">if</span> (!IsListEmpty( &amp;Lfcb-&gt;LbcbActive )) {
00087 
00088         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00089 
00090         ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00091                                       <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00092                                       ActiveLinks );
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">//  If the page is not empty or the page is empty but this is a</span>
00096         <span class="comment">//  restart page then add the remaining bytes on this page.</span>
00097         <span class="comment">//</span>
00098 
00099         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY | LBCB_FLUSH_COPY )) {
00100 
00101             *CurrentPageBytes = (ULONG)Lfcb-&gt;LogPageSize - (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00102 
00103             *CurrentAvailSpace = *CurrentAvailSpace + *CurrentPageBytes;                                               <span class="comment">//**** xxAdd( *CurrentAvailSpace, xxFromUlong( *CurrentPageBytes ));</span>
00104         }
00105     }
00106 
00107     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsCurrentAvailSpace:  Exit\n"</span>, 0 );
00108 
00109     <span class="keywordflow">return</span>;
00110 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lfs/verfysup.c::LfsFindCurrentAvail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFindCurrentAvail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lfcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00412">412</a> of file <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html">lfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00601">LFCB_NO_LAST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00604">LFCB_NO_OLDEST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00603">LFCB_REUSE_TAIL</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00184">LfsTruncateOffsetToLogPage</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">LfsSetBaseLsnPriv()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.
<p>
<pre class="fragment"><div>00418                    :
00419 
00420     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to calculate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes available <span class="keywordflow">for</span> log
00421     records which are in completely empty log record pages.  It ignores any
00422     partial pages in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active work queue and ignores any page which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00423     going to be reused.
00424 
00425 Arguments:
00426 
00427     Lfcb - Lfcb <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00428 
00429 Return Value:
00430 
00431     None.
00432 
00433 --*/
00434 
00435 {
00436     LONGLONG OldestPageOffset;
00437     LONGLONG NextFreePageOffset;
00438     LONGLONG FreeBytes;
00439 
00440     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00441 
00442     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFindCurrentAvail:  Entered\n"</span>, 0 );
00443     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb              -&gt; %08x\n"</span>, Lfcb );
00444 
00445     <span class="comment">//</span>
00446     <span class="comment">//  If there is a last lsn in the restart area then we know</span>
00447     <span class="comment">//  that we will have to compute the free range.</span>
00448     <span class="comment">//</span>
00449 
00450     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN )) {
00451 
00452         <span class="comment">//</span>
00453         <span class="comment">//  If there is no oldest Lsn then start at the</span>
00454         <span class="comment">//  first page of the file.</span>
00455         <span class="comment">//</span>
00456 
00457         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_NO_OLDEST_LSN )) {
00458 
00459             OldestPageOffset = Lfcb-&gt;FirstLogPage;
00460 
00461         } <span class="keywordflow">else</span> {
00462 
00463             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a6">LfsTruncateOffsetToLogPage</a>( Lfcb,
00464                                         Lfcb-&gt;OldestLsnOffset,
00465                                         &amp;OldestPageOffset );
00466         }
00467 
00468         <span class="comment">//</span>
00469         <span class="comment">//  We will use the next log page offset to compute the</span>
00470         <span class="comment">//  next free page.  If we are going to reuse this page</span>
00471         <span class="comment">//  go to the next page,  if we are at the first page then</span>
00472         <span class="comment">//  use the end of the file.</span>
00473         <span class="comment">//</span>
00474 
00475         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_REUSE_TAIL )) {
00476 
00477             NextFreePageOffset = Lfcb-&gt;NextLogPage + Lfcb-&gt;LogPageSize;                                                <span class="comment">//**** xxAdd( Lfcb-&gt;NextLogPage, Lfcb-&gt;LogPageSize );</span>
00478 
00479         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Lfcb-&gt;NextLogPage == Lfcb-&gt;FirstLogPage ) {                                                        <span class="comment">//**** xxEql( Lfcb-&gt;NextLogPage, Lfcb-&gt;FirstLogPage )</span>
00480 
00481             NextFreePageOffset = Lfcb-&gt;FileSize;
00482 
00483         } <span class="keywordflow">else</span> {
00484 
00485             NextFreePageOffset = Lfcb-&gt;NextLogPage;
00486         }
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">//  If the two offsets are the same then there is no available space.</span>
00490         <span class="comment">//</span>
00491 
00492         <span class="keywordflow">if</span> ( OldestPageOffset == NextFreePageOffset ) {                                                                <span class="comment">//**** xxEql( OldestPageOffset, NextFreePageOffset )</span>
00493 
00494             Lfcb-&gt;CurrentAvailable = 0;
00495 
00496         } <span class="keywordflow">else</span> {
00497 
00498             <span class="comment">//</span>
00499             <span class="comment">//  If the free offset follows the oldest offset then subtract</span>
00500             <span class="comment">//  this range from the total available pages.</span>
00501             <span class="comment">//</span>
00502 
00503             <span class="keywordflow">if</span> ( OldestPageOffset &lt; NextFreePageOffset ) {                                                             <span class="comment">//**** xxLtr( OldestPageOffset, NextFreePageOffset )</span>
00504 
00505                 FreeBytes = Lfcb-&gt;TotalAvailInPages - ( NextFreePageOffset - OldestPageOffset );                       <span class="comment">//**** xxSub( Lfcb-&gt;TotalAvailInPages, xxSub( NextFreePageOffset, OldestPageOffset ));</span>
00506 
00507             } <span class="keywordflow">else</span> {
00508 
00509                 FreeBytes = OldestPageOffset - NextFreePageOffset;                                                     <span class="comment">//**** xxSub( OldestPageOffset, NextFreePageOffset );</span>
00510             }
00511 
00512             <span class="comment">//</span>
00513             <span class="comment">//  We now have the total bytes in the pages available.  We</span>
00514             <span class="comment">//  now have to subtract the size of the page header to get</span>
00515             <span class="comment">//  the total available bytes.</span>
00516             <span class="comment">//</span>
00517             <span class="comment">//  We will convert the bytes to pages and then multiple</span>
00518             <span class="comment">//  by the data size of each page.</span>
00519             <span class="comment">//</span>
00520 
00521             FreeBytes = Int64ShrlMod32(((ULONGLONG)(FreeBytes)), Lfcb-&gt;LogPageShift);
00522 
00523             Lfcb-&gt;CurrentAvailable = FreeBytes * (ULONG)Lfcb-&gt;ReservedLogPageSize;                                     <span class="comment">//**** xxXMul( FreeBytes, Lfcb-&gt;ReservedLogPageSize.LowPart );</span>
00524         }
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">//  Otherwise the entire file is available.</span>
00528     <span class="comment">//</span>
00529 
00530     } <span class="keywordflow">else</span> {
00531 
00532         Lfcb-&gt;CurrentAvailable = Lfcb-&gt;MaxCurrentAvail;
00533     }
00534 
00535     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFindCurrentAvail:  Exit\n"</span>, 0 );
00536 
00537     <span class="keywordflow">return</span>;
00538 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lfs/verfysup.c::LfsVerifyLogSpaceAvail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsVerifyLogSpaceAvail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d9/struct__LCH.html">PLCH</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingLogBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoRequirement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ForceToDisk</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00114">114</a> of file <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html">lfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00036">LfsCurrentAvailSpace()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>.
<p>
<pre class="fragment"><div>00124                    :
00125 
00126     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to verify that we may write <span class="keyword">this</span> log record into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00127     log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  We want to always leave room <span class="keywordflow">for</span> each transaction to abort.
00128 
00129     We determine how much space <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current log record will take and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00130     worst <span class="keywordflow">case</span> <span class="keywordflow">for</span> its undo operation.  If <span class="keyword">this</span> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available we
00131     update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding values in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb and Lch <span class="keywordflow">for</span> bookkeeping.
00132     Otherwise we raise a status indicating that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> full.
00133 
00134     The disk usage <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> different <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packed and unpacked cases.  Make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00135     following adjustments after finding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total available and amount still
00136     remaining on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last active page,
00137 
00138     Packed Case:
00139 
00140         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> needed <span class="keywordflow">for</span> log record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> data size plus header size.
00141 
00142         Undo requirement <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo data size plus <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header size.
00143             We have already taken into account <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages
00144             except <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current page.
00145 
00146         Add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record size to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo requirement to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00147             log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> usage.  <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a> <span class="keyword">this</span> number with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual available
00148             space (Available - CommittedUndo).  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00149             available, then raise LOG_FILE_FULL.  Must take into account
00150             any unused bytes at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current page.
00151 
00152     Unpacked Case:
00153 
00154         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> needed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initially header size plus data size.
00155 
00156         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> begin on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current page then
00157             add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes being thrown away to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record size.
00158 
00159         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being forced to disk then add any remaining
00160             bytes on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last page.  To <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes being used.
00161 
00162         Undo requirement <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> twice <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sum of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header size and
00163             undo size.  We <span class="keywordtype">double</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested size since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log
00164             record will always fit on a page.  This can be a
00165             positive or negative number.
00166 
00167         Add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record usage to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo usage to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00168             usage.  <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a> <span class="keyword">this</span> number with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual available
00169             space (Available - CommittedUndo).  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00170             available, then raise LOG_FILE_FULL.
00171 
00172 Arguments:
00173 
00174     Lfcb - Lfcb <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00175 
00176     Lch - Client handle
00177 
00178     RemainingLogBytes - Number of bytes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current log record
00179 
00180     UndoRequirement - User's requirement <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo record.
00181 
00182     ForceToDisk - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> log record will be flushed to disk.
00183 
00184 Return Value:
00185 
00186     BOOLEAN - Advisory, indicates that there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> less than 1/4 of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> available.
00187 
00188 --*/
00189 
00190 {
00191     ULONG CurrentLogRecordSize;
00192     ULONG LogRecordStart;
00193     ULONG TailBytes;
00194 
00195     LONGLONG CurrentAvailSpace;
00196     ULONG CurrentPageBytes;
00197 
00198     LONGLONG LogFileUsage;
00199 
00200     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00201 
00202     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsVerifyLogSpaceAvail:  Entered\n"</span>, 0 );
00203     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb              -&gt; %08x\n"</span>, Lfcb );
00204     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lch               -&gt; %08lx\n"</span>, Lch );
00205     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RemainingLogBytes -&gt; %08lx\n"</span>, RemainingLogBytes );
00206     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoRequirement   -&gt; %08lx\n"</span>, UndoRequirement );
00207     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ForceToDisk       -&gt; %04x\n"</span>, ForceToDisk );
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">//  Start by collecting the current data on the file.</span>
00211     <span class="comment">//</span>
00212 
00213     <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a0">LfsCurrentAvailSpace</a>( Lfcb,
00214                           &amp;CurrentAvailSpace,
00215                           &amp;CurrentPageBytes );
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">//  We compute the amount of space needed for the current log record by</span>
00219     <span class="comment">//  adding up the following:</span>
00220     <span class="comment">//</span>
00221     <span class="comment">//      Space at end of current log page which won't be used.</span>
00222     <span class="comment">//      Size of header for log record.</span>
00223     <span class="comment">//      Size of client data in log record.</span>
00224     <span class="comment">//      Size of wasted portion of log page if this is forced to disk.</span>
00225     <span class="comment">//</span>
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">//  Start with the size of the header and the client data.</span>
00229     <span class="comment">//</span>
00230 
00231     CurrentLogRecordSize = RemainingLogBytes + Lfcb-&gt;RecordHeaderLength;
00232 
00233     <span class="comment">//</span>
00234     <span class="comment">//  If the log is packed and there are bytes on the current page we need</span>
00235     <span class="comment">//  to take into account any bytes at the end of the page which won't</span>
00236     <span class="comment">//  be used.  This will happen if the log record spills into the end of</span>
00237     <span class="comment">//  the log page but doesn't use up the page.  If the remaining bytes are</span>
00238     <span class="comment">//  less than a record header size we must throw them away.</span>
00239     <span class="comment">//</span>
00240 
00241     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
00242 
00243         <span class="keywordflow">if</span> (CurrentPageBytes != 0
00244             &amp;&amp; CurrentLogRecordSize &lt; CurrentPageBytes
00245             &amp;&amp; (CurrentPageBytes - CurrentLogRecordSize) &lt; Lfcb-&gt;RecordHeaderLength) {
00246 
00247             CurrentLogRecordSize += (CurrentPageBytes - CurrentLogRecordSize);
00248         }
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">//  If this is the unpacked case we need to check for bytes being thrown away</span>
00252     <span class="comment">//  on the current page or the last page.</span>
00253     <span class="comment">//</span>
00254 
00255     } <span class="keywordflow">else</span> {
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">//  If there is an active Lbcb, we need to add any bytes that</span>
00259         <span class="comment">//  would be thrown away at the end.</span>
00260         <span class="comment">//</span>
00261 
00262         <span class="keywordflow">if</span> (CurrentPageBytes != 0) {
00263 
00264             <span class="comment">//</span>
00265             <span class="comment">//  We won't use this log page unless the new log record will fit or</span>
00266             <span class="comment">//  unless this is the first log record in the page.</span>
00267             <span class="comment">//</span>
00268 
00269             <span class="keywordflow">if</span> ((CurrentPageBytes != (ULONG)Lfcb-&gt;LogPageDataSize)
00270                 &amp;&amp; (CurrentLogRecordSize &gt; CurrentPageBytes)) {
00271 
00272                 CurrentLogRecordSize += CurrentPageBytes;
00273 
00274                 <span class="comment">//</span>
00275                 <span class="comment">//  Remember that we will start this log record at the first</span>
00276                 <span class="comment">//  byte in the data portion of a page.</span>
00277                 <span class="comment">//</span>
00278 
00279                 LogRecordStart = 0;
00280 
00281             <span class="comment">//</span>
00282             <span class="comment">//  Otherwise this will start at the current offset into the</span>
00283             <span class="comment">//  data portion of the log page.</span>
00284             <span class="comment">//</span>
00285 
00286             } <span class="keywordflow">else</span> {
00287 
00288                 LogRecordStart = (ULONG)Lfcb-&gt;LogPageDataSize - CurrentPageBytes;
00289             }
00290 
00291         <span class="comment">//</span>
00292         <span class="comment">//  If there was no Lbcb, then we know that we will start at the first</span>
00293         <span class="comment">//  byte of the data portion.</span>
00294         <span class="comment">//</span>
00295 
00296         } <span class="keywordflow">else</span> {
00297 
00298             LogRecordStart = 0;
00299         }
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">//  We always assume that we will use up the rest of the bytes on the last page</span>
00303         <span class="comment">//  in computing whether the log record will fit in the available space.  We</span>
00304         <span class="comment">//  only subtract that space from the available space if this is a force write.</span>
00305         <span class="comment">//</span>
00306 
00307         <span class="keywordflow">if</span> (ForceToDisk) {
00308 
00309             <span class="comment">//</span>
00310             <span class="comment">//  We take into account where we start on a log page and continue</span>
00311             <span class="comment">//  to subtract log pages until we know the amount on the last</span>
00312             <span class="comment">//  page.</span>
00313             <span class="comment">//</span>
00314 
00315             TailBytes = RemainingLogBytes + Lfcb-&gt;RecordHeaderLength + LogRecordStart;
00316 
00317             <span class="keywordflow">while</span> (TailBytes &gt; (ULONG)Lfcb-&gt;LogPageDataSize) {
00318 
00319                 TailBytes -= (ULONG)Lfcb-&gt;LogPageDataSize;
00320             }
00321 
00322             TailBytes = (ULONG)Lfcb-&gt;LogPageDataSize - TailBytes;
00323 
00324             CurrentLogRecordSize += TailBytes;
00325         }
00326     }
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">//  We now know the number of bytes needed for the current log page.</span>
00330     <span class="comment">//  Next we compute the number of bytes being reserved by UndoRequirement.</span>
00331     <span class="comment">//  If the UndoRequirement is positive, we will add to the amount reserved</span>
00332     <span class="comment">//  in the log file.  If it is negative, we will subtract from the amount</span>
00333     <span class="comment">//  reserved in the log file.</span>
00334     <span class="comment">//</span>
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">//  When we have an actual reserve amount, we convert it to positive</span>
00338     <span class="comment">//  and then reserve twice the space required to hold the data and</span>
00339     <span class="comment">//  its header (up to the maximum of a single page.</span>
00340     <span class="comment">//</span>
00341 
00342     <span class="keywordflow">if</span> (UndoRequirement != 0) {
00343 
00344         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
00345 
00346             UndoRequirement *= 2;
00347         }
00348 
00349         <span class="keywordflow">if</span> (UndoRequirement &lt; 0) {
00350 
00351             UndoRequirement -= (2 * Lfcb-&gt;RecordHeaderLength);
00352         } <span class="keywordflow">else</span> {
00353 
00354             UndoRequirement += (2 * Lfcb-&gt;RecordHeaderLength);
00355         }
00356     }
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">//  Now compute the net log file usage.  The result may be positive or</span>
00360     <span class="comment">//  negative.</span>
00361     <span class="comment">//</span>
00362 
00363     LogFileUsage = ((LONG) CurrentLogRecordSize)  + UndoRequirement;                                                   <span class="comment">//**** xxFromLong( ((LONG) CurrentLogRecordSize)  + UndoRequirement );</span>
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  The actual available space is the CurrentAvail minus the reserved</span>
00367     <span class="comment">//  undo value in the Lfcb.</span>
00368     <span class="comment">//</span>
00369 
00370     CurrentAvailSpace = CurrentAvailSpace - Lfcb-&gt;TotalUndoCommitment;                                                 <span class="comment">//**** xxSub( CurrentAvailSpace, Lfcb-&gt;TotalUndoCommitment );</span>
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">//  If this log file usage is greater than the available log file space</span>
00374     <span class="comment">//  then we raise a status code.</span>
00375     <span class="comment">//</span>
00376 
00377 <span class="preprocessor">#ifdef LFS_RAISE</span>
00378 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (LfsRaiseFull) {
00379 
00380         LfsRaiseFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00381         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsVerifyLogSpaceAvail:  About to raise\n"</span>, 0 );
00382         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_LOG_FILE_FULL );
00383     }
00384 <span class="preprocessor">#endif</span>
00385 <span class="preprocessor"></span>
00386     <span class="keywordflow">if</span> (LogFileUsage &gt; CurrentAvailSpace) {
00387 
00388         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsVerifyLogSpaceAvail:  About to raise\n"</span>, 0 );
00389         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_LOG_FILE_FULL );
00390     }
00391 
00392     Lfcb-&gt;TotalUndoCommitment = Lfcb-&gt;TotalUndoCommitment + UndoRequirement;                                           <span class="comment">//**** xxAdd( Lfcb-&gt;TotalUndoCommitment, xxFromLong( UndoRequirement ));</span>
00393 
00394     Lch-&gt;ClientUndoCommitment = Lch-&gt;ClientUndoCommitment + UndoRequirement;                                           <span class="comment">//**** xxAdd( Lch-&gt;ClientUndoCommitment, xxFromLong( UndoRequirement ));</span>
00395 
00396     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsVerifyLogSpaceAvail:  Exit\n"</span>, 0 );
00397 
00398     <span class="comment">//</span>
00399     <span class="comment">//  Now check if the log file is almost used up.</span>
00400     <span class="comment">//</span>
00401 
00402     <span class="keywordflow">if</span> ((CurrentAvailSpace - LogFileUsage) &lt; (Lfcb-&gt;TotalAvailable &gt;&gt; 2)) {
00403 
00404         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00405     }
00406 
00407     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00408 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:07 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
