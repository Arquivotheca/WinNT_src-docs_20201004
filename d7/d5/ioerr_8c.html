<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ioerr.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ioerr.c File Reference</h1><code>#include "<a class="el" href="../../d3/d3/ioe_2pch_8h-source.html">pch.h</a>"</code><br>

<p>
<a href="../../d8/d4/ioerr_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a0">IoepInitErrLog</a> (IN ULONG KeyType, IN PVOID <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN ULONG ulFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a1">IoepFindErrThread</a> (IN ULONG KeyType, IN PVOID <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a2">IoepNewErrThread</a> (IN ULONG KeyType, IN PVOID <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a3">IoepLogErr</a> (IN ULONG KeyType, IN PVOID <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN CONST GUID *ComponentGuid, IN ULONG ErrCode, IN PWSTR TextData OPTIONAL, IN ULONG DataBlkType, IN ULONG DataBlkLen OPTIONAL, IN PVOID DataBlock OPTIONAL, IN CONST GUID *MofGuid OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a4">IoepFreeErrStack</a> (IN <a class="el" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> ErrStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d5/struct__errmodule.html">PERRMODULE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a5">IoepFindErrModule</a> (IN CONST GUID *ComponentGuid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a6">IoepExtractErrData</a> (IN <a class="el" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> ErrStack, OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG BuffSize, OUT PULONG DataSize OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a7">IoepFireWMIEvent</a> (IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo, IN PWSTR InstanceName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a8">IoepHandleErrCase</a> (IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo, IN <a class="el" href="../../d8/d4/struct__errcase.html">PERRCASE</a> ErrCase, IN ULONG Method, OUT PUNICODE_STRING unicodeMsg OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a9">IoepFindErrHandler</a> (IN CONST GUID *ComponentGuid, IN ULONG HandlerIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a10">IoepMatchErrIDPath</a> (IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo, IN <a class="el" href="../../d2/d5/struct__errid.html">PERRID</a> ErrIDPath, IN ULONG NumErrIDs)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a11">IoepGetErrMessage</a> (IN <a class="el" href="../../d8/d9/struct__msgdata.html">PMSGDATA</a> MsgData, IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo, OUT PUNICODE_STRING unicodeMsg)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a12">IoepCatMsgArg</a> (IN OUT PUNICODE_STRING unicodeMsg, IN <a class="el" href="../../d6/d9/struct__msgarg.html">PMSGARG</a> MsgArg, IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a13">IoepUnicodeStringCatN</a> (IN OUT PUNICODE_STRING unicodeStr, IN PWSTR pwstr, IN ULONG len)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a> (VOID)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a12" doxytag="ioerr.c::IoepCatMsgArg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoepCatMsgArg           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>unicodeMsg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d9/struct__msgarg.html">PMSGARG</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MsgArg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01052">1052</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d4/d3/ecdb_8h-source.html#l00069">_handlerdata::ComponentGuid</a>, <a class="el" href="../../d4/d3/ecdb_8h-source.html#l00040">_errcasedb::DataBlkOffset</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00069">_errdata::DataBlkOffset</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d4/d3/ecdb_8h-source.html#l00070">_handlerdata::HandlerIndex</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00044">IOEDATA_PRIVATE</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00047">IOEDATA_TEXT</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00045">IOEDATA_WSTRING</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00824">IoepFindErrHandler()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01200">IoepGetErrCaseDB()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d3/ecdb_8h-source.html#l00071">_handlerdata::Param</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00095">PERRHANDLER</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00036">STATUS_IOE_DATABASE_NOT_READY</a>, and <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00066">_errdata::TextDataOffset</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00936">IoepGetErrMessage()</a>.
<p>
<pre class="fragment"><div>01059                    :
01060     This routine appends <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> substituted message argument to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode
01061     string <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> enough space.  Otherwise, STATUS_BUFFER_TOO_SMALL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01062     returned.
01063 
01064 Arguments:
01065     unicodeMsg - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target unicode message
01066     MsgArg - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message argument structure
01067     ErrInfo - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error info.
01068 
01069 Return Value:
01070     Success - returns STATUS_SUCCESS
01071     Failure - returns NT status code
01072 
01073 --*/
01074 {
01075     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepCatMsgArg"</span>);
01076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01077     <a class="code" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a> ErrCaseDB;
01078 
01079     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01080     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(Msg=%S,pMsgArg=%p,ErrInfo=%p)\n"</span>,
01081               unicodeMsg-&gt;Buffer, MsgArg, ErrInfo));
01082 
01083     ErrCaseDB = <a class="code" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a>();
01084     <span class="keywordflow">if</span> (ErrCaseDB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01085     {
01086         <span class="keywordflow">if</span> (MsgArg-&gt;ErrIDIndex &lt; ErrInfo-&gt;NumErrEntries)
01087         {
01088             <a class="code" href="../../d0/d5/struct__errdata.html">PERRDATA</a> ErrData;
01089             ANSI_STRING ansiStr;
01090             UNICODE_STRING unicodeStr;
01091             <a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a> HandlerData;
01092             <a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a> ErrHandler;
01093 
01094             ErrData = &amp;ErrInfo-&gt;ErrEntries[MsgArg-&gt;ErrIDIndex];
01095             <span class="keywordflow">switch</span> (MsgArg-&gt;ArgType)
01096             {
01097                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/ioeapi_8h.html#a8">IOEDATA_TEXT</a>:
01098                     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(
01099                                 unicodeMsg,
01100                                 (PWSTR)((PUCHAR)ErrInfo +
01101                                         ErrData-&gt;<a class="code" href="../../d0/d5/struct__errdata.html#o1">TextDataOffset</a>));
01102                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01103                     {
01104                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to append unicode string (rc=%x)\n"</span>,
01105                                   status));
01106                     }
01107                     <span class="keywordflow">break</span>;
01108 
01109                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/ioeapi_8h.html#a6">IOEDATA_WSTRING</a>:
01110                     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(
01111                                 unicodeMsg,
01112                                 (PWSTR)((PUCHAR)ErrInfo +
01113                                         ErrData-&gt;<a class="code" href="../../d0/d5/struct__errdata.html#o4">DataBlkOffset</a>));
01114                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01115                     {
01116                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to append unicode string argument (rc=%x)\n"</span>,
01117                                   status));
01118                     }
01119                     <span class="keywordflow">break</span>;
01120 
01121                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/ioeapi_8h.html#a5">IOEDATA_PRIVATE</a>:
01122                     HandlerData = (<a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a>)((ULONG_PTR)ErrCaseDB +
01123                                                  ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
01124                                                  MsgArg-&gt;ArgDataOffset);
01125                     ErrHandler = <a class="code" href="../../d7/d5/ioerr_8c.html#a9">IoepFindErrHandler</a>(&amp;HandlerData-&gt;<a class="code" href="../../d5/d4/struct__handlerdata.html#o0">ComponentGuid</a>,
01126                                                     HandlerData-&gt;<a class="code" href="../../d5/d4/struct__handlerdata.html#o1">HandlerIndex</a>);
01127                     <span class="keywordflow">if</span> (ErrHandler != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01128                     {
01129                         status = ErrHandler(ErrData, HandlerData-&gt;<a class="code" href="../../d5/d4/struct__handlerdata.html#o2">Param</a>);
01130                     }
01131                     <span class="keywordflow">break</span>;
01132 
01133                 <span class="keywordflow">default</span>:
01134                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid message argument type %d\n"</span>,
01135                               MsgArg-&gt;ArgType));
01136             }
01137         }
01138         <span class="keywordflow">else</span>
01139         {
01140             status = STATUS_UNSUCCESSFUL;
01141             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to find error entry\n"</span>));
01142         }
01143     }
01144     <span class="keywordflow">else</span>
01145     {
01146         status = <a class="code" href="../../d5/d5/ioeapi_8h.html#a2">STATUS_IOE_DATABASE_NOT_READY</a>;
01147         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"error case database not ready\n"</span>));
01148     }
01149 
01150     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x(Msg=%S)\n"</span>, status, unicodeMsg-&gt;Buffer));
01151     <span class="keywordflow">return</span> status;
01152 }       <span class="comment">//IoepCatMsgArg</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ioerr.c::IoepExtractErrData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoepExtractErrData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__errentry.html">PERRENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BuffSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG DataSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00501">501</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00079">_errentry::DataBlk</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00068">_errdata::DataBlkLen</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00078">_errentry::DataBlkLen</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00069">_errdata::DataBlkOffset</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00077">_errentry::DataBlkType</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00067">_errdata::DataBlkType</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00077">_errinfo::DataTag</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00080">_errinfo::ErrEntries</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00075">_errentry::ErrID</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00065">_errdata::ErrID</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00053">IOE_ERRINFO_VERSION</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00136">IoepGetNextErrEntry</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00080">_errentry::MofGuid</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00070">_errdata::MofGuid</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00079">_errinfo::NumErrEntries</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00083">SIG_ERRINFO</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00074">_errinfo::Signature</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00076">_errinfo::Size</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00078">_errinfo::TagFlags</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00066">_errdata::TextDataOffset</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00076">_errentry::unicodeStr</a>, and <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00075">_errinfo::Version</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00452">IoErrGetErrData()</a>.
<p>
<pre class="fragment"><div>00509                    :
00510     This routine stores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error stack data into a flat buffer.
00511 
00512 Arguments:
00513     ErrStack - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error stack
00514     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data
00515     BuffSize - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer size
00516     DataSize - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual data size
00517 
00518 Return Value:
00519     Success - returns STATUS_SUCCESS
00520     Failure - returns NT status code
00521 
00522 --*/
00523 {
00524     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepExtractErrData"</span>);
00525     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00526     <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> Err;
00527     ULONG len, i;
00528 
00529     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrStack != NULL);
00530     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Buffer != NULL) &amp;&amp; (BuffSize &gt; 0) || (DataSize != NULL));
00531     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrStack=%p,Buff=%p,BuffSize=%d,pDataSize=%p)\n"</span>,
00532               ErrStack, Buffer, BuffSize, DataSize));
00533 
00534     <span class="keywordflow">for</span> (Err = ErrStack, len = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__errinfo.html">ERRINFO</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__errdata.html">ERRDATA</a>), i = 0;
00535          Err != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00536          Err = <a class="code" href="../../d6/d5/ioep_8h.html#a26">IoepGetNextErrEntry</a>(Err), i++)
00537     {
00538         len += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__errdata.html">ERRDATA</a>) +
00539                Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a> +
00540                Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.MaximumLength;
00541     }
00542 
00543     <span class="keywordflow">if</span> (len &lt;= BuffSize)
00544     {
00545         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (len &gt; 0))
00546         {
00547             <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo = (<a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00548             PUCHAR pBuff;
00549 
00550             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o0">Signature</a> = <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>;
00551             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o1">Version</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a18">IOE_ERRINFO_VERSION</a>;
00552             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o2">Size</a> = len;
00553             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o3">DataTag</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00554             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o4">TagFlags</a> = 0;
00555             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o5">NumErrEntries</a> = i;
00556             pBuff = (PUCHAR)ErrInfo + <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__errinfo.html">ERRINFO</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__errdata.html">ERRDATA</a>)*(i - 1);
00557             <span class="keywordflow">for</span> (Err = ErrStack, i = 0;
00558                  Err != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00559                  Err = <a class="code" href="../../d6/d5/ioep_8h.html#a26">IoepGetNextErrEntry</a>(Err), i++)
00560             {
00561                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o0">ErrID</a> = Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o1">ErrID</a>;
00562                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o2">DataBlkType</a> = Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o3">DataBlkType</a>;
00563                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o3">DataBlkLen</a> = Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a>;
00564                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o5">MofGuid</a> = Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o6">MofGuid</a>;
00565 
00566                 <span class="keywordflow">if</span> (Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.MaximumLength &gt; 0)
00567                 {
00568                     ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o1">TextDataOffset</a> = pBuff -
00569                                                             (PUCHAR)ErrInfo;
00570                     RtlCopyMemory(pBuff,
00571                                   Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.Buffer,
00572                                   Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.MaximumLength);
00573                     pBuff += Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.MaximumLength;
00574                 }
00575                 <span class="keywordflow">else</span>
00576                 {
00577                     ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o1">TextDataOffset</a> = 0;
00578                 }
00579 
00580                 <span class="keywordflow">if</span> (Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00581                 {
00582                     ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o4">DataBlkOffset</a> = pBuff -
00583                                                            (PUCHAR)ErrInfo;
00584                     RtlCopyMemory(pBuff, Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a>, Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a>);
00585                     pBuff += Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a>;
00586                 }
00587                 <span class="keywordflow">else</span>
00588                 {
00589                     ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o4">DataBlkOffset</a> = 0;
00590                 }
00591             }
00592         }
00593 
00594         status = STATUS_SUCCESS;
00595     }
00596     <span class="keywordflow">else</span>
00597     {
00598         status = STATUS_BUFFER_TOO_SMALL;
00599         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"buffer too small (size=%d,need=%d)\n"</span>, BuffSize, len));
00600     }
00601 
00602     <span class="keywordflow">if</span> (DataSize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00603     {
00604         *DataSize = len;
00605     }
00606 
00607     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x(len=%d)\n"</span>, status, len));
00608     <span class="keywordflow">return</span> status;
00609 }       <span class="comment">//IoepExtractErrData</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ioerr.c::IoepFindErrHandler" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a> IoepFindErrHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN CONST GUID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ComponentGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HandlerIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00824">824</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00127">_errmodule::HandlerTable</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00456">IoepFindErrModule()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00126">_errmodule::NumErrHandlers</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00095">PERRHANDLER</a>, and <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01052">IoepCatMsgArg()</a>, and <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00680">IoepHandleErrCase()</a>.
<p>
<pre class="fragment"><div>00830                    :
00831     This routine find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error handler with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given module GUID and
00832     handler index.
00833 
00834 Arguments:
00835     ComponentGuid - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handler module
00836     HandlerIndex - index into handler table
00837 
00838 Return Value:
00839     Success - returns pointer to error handler found
00840     Failure - returns <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00841 
00842 --*/
00843 {
00844     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFindErrHandler"</span>);
00845     <a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a> ErrHandler = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00846     <a class="code" href="../../d5/d5/struct__errmodule.html">PERRMODULE</a> ErrModule;
00847 
00848     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(pGuid=%p,Index=%x)\n"</span>, ComponentGuid, HandlerIndex));
00849 
00850     ErrModule = <a class="code" href="../../d7/d5/ioerr_8c.html#a5">IoepFindErrModule</a>(ComponentGuid);
00851 
00852     <span class="keywordflow">if</span> ((ErrModule != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (HandlerIndex &lt; ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o2">NumErrHandlers</a>))
00853     {
00854         ErrHandler = ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o3">HandlerTable</a>[HandlerIndex];
00855     }
00856 
00857     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrHandler));
00858     <span class="keywordflow">return</span> ErrHandler;
00859 }       <span class="comment">//IoepFindErrHandler</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ioerr.c::IoepFindErrModule" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d5/struct__errmodule.html">PERRMODULE</a> IoepFindErrModule           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN CONST GUID *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ComponentGuid</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00456">456</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ioep_8h-source.html#l00125">_errmodule::ComponentGuid</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00030">IoepErrListLock</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00032">IoepErrModuleListHead</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00824">IoepFindErrHandler()</a>, and <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00383">IoErrRegisterErrHandlers()</a>.
<p>
<pre class="fragment"><div>00461                    :
00462     This routine finds a registered error module with a given module GUID.
00463 
00464 Arguments:
00465     ComponentGuid - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error module
00466 
00467 Return Value:
00468     Success - returns pointer to error module found
00469     Failure - returns <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00470 
00471 --*/
00472 {
00473     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFindErrModule"</span>);
00474     <a class="code" href="../../d5/d5/struct__errmodule.html">PERRMODULE</a> ErrModule = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00475     PLIST_ENTRY list;
00476     KIRQL Irql;
00477 
00478     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(pGuid=%p)\n"</span>, ComponentGuid));
00479 
00480     ExAcquireSpinLock(&amp;IoepErrListLock, &amp;Irql);
00481     <span class="keywordflow">for</span> (list = <a class="code" href="../../d0/d2/data_8c.html#a3">IoepErrModuleListHead</a>.Flink;
00482          list != &amp;<a class="code" href="../../d0/d2/data_8c.html#a3">IoepErrModuleListHead</a>;
00483          list = list-&gt;Flink)
00484     {
00485         ErrModule = CONTAINING_RECORD(list, <a class="code" href="../../d5/d5/struct__errmodule.html">ERRMODULE</a>, list);
00486         <span class="keywordflow">if</span> (RtlEqualMemory(&amp;ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o1">ComponentGuid</a>,
00487                            ComponentGuid,
00488                            <span class="keyword">sizeof</span>(GUID)))
00489         {
00490             <span class="keywordflow">break</span>;
00491         }
00492         ErrModule = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00493     }
00494     ExReleaseSpinLock(&amp;IoepErrListLock, Irql);
00495 
00496     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrModule));
00497     <span class="keywordflow">return</span> ErrModule;
00498 }       <span class="comment">//IoepFindErrModule</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ioerr.c::IoepFindErrThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> IoepFindErrThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00108">108</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00030">IoepErrListLock</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00031">IoepErrThreadListHead</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d9/d5/struct__errthread.html#o11">_errthread::ThreadKey</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00045">THREADKEY_IRP</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00046">THREADKEY_THREADID</a>, and <a class="el" href="../../d7/d4/ioep_8h-source.html#l00086">_errthread::ThreadKeyType</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00039">IoepInitErrLog()</a>, and <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00255">IoepLogErr()</a>.
<p>
<pre class="fragment"><div>00114                    :
00115     This routine finds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error thread keyed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.
00116 
00117 Arguments:
00118     KeyType - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of key.
00119     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logging session.
00120 
00121 Return Value:
00122     Success - returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error thread handle found.
00123     Failure - returns <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00124 
00125 --*/
00126 {
00127     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFindErrThread"</span>);
00128     <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> ErrThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00129     PLIST_ENTRY list;
00130     KIRQL Irql;
00131 
00132     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(KeyType=%x,Key=%p)\n"</span>, KeyType, Key));
00133 
00134     ExAcquireSpinLock(&amp;IoepErrListLock, &amp;Irql);
00135     <span class="keywordflow">for</span> (list = <a class="code" href="../../d0/d2/data_8c.html#a2">IoepErrThreadListHead</a>.Flink;
00136          list != &amp;<a class="code" href="../../d0/d2/data_8c.html#a2">IoepErrThreadListHead</a>;
00137          list = list-&gt;Flink)
00138     {
00139         ErrThread = CONTAINING_RECORD(list, <a class="code" href="../../d9/d5/struct__errthread.html">ERRTHREAD</a>, list);
00140         <span class="keywordflow">if</span> (ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o2">ThreadKeyType</a> == KeyType)
00141         {
00142             <span class="keywordflow">switch</span> (KeyType)
00143             {
00144                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a12">THREADKEY_IRP</a>:
00145                     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> == ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.Irp)
00146                     {
00147                         <span class="keywordflow">break</span>;
00148                     }
00149                     <span class="keywordflow">else</span>
00150                     {
00151                         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00152 
00153                         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)Key);
00154                         <span class="keywordflow">if</span> ((IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> ==
00155                              ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.MajorFunction) &amp;&amp;
00156                             (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ==
00157                              ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.MinorFunction) &amp;&amp;
00158                             RtlEqualMemory(&amp;IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Others,
00159                                            ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.Arguments,
00160                                            <span class="keyword">sizeof</span>(PVOID)*4) &amp;&amp;
00161                             (IopDbgGetLowestDevice(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>) ==
00162                              ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.TargetDevice))
00163                         {
00164                             <span class="keywordflow">break</span>;
00165                         }
00166                     }
00167                     <span class="keywordflow">break</span>;
00168 
00169                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a13">THREADKEY_THREADID</a>:
00170                     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> == ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.ThIDKey.ThreadID)
00171                     {
00172                         <span class="keywordflow">break</span>;
00173                     }
00174                     <span class="keywordflow">break</span>;
00175             }
00176         }
00177         ErrThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00178     }
00179     ExReleaseSpinLock(&amp;IoepErrListLock, Irql);
00180 
00181     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrThread));
00182     <span class="keywordflow">return</span> ErrThread;
00183 }       <span class="comment">//IoepFindErrThread</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ioerr.c::IoepFireWMIEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoepFireWMIEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>InstanceName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00612">612</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00028">IoepGuid</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00043">IOETAG_WMIEVENT</a>, <a class="el" href="../../d0/d5/io_8h.html#a575">IoWMIWriteEvent()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00305">IoErrTerminateErrLog()</a>.
<p>
<pre class="fragment"><div>00618                    :
00619     This routine fires a WMI event notifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> availability of an error info.
00620 
00621 Arguments:
00622     ErrInfo - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error info.
00623     InstanceName - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance name string
00624 
00625 Return Value:
00626     Success - returns STATUS_SUCCESS
00627     Failure - returns NT status code
00628 
00629 --*/
00630 {
00631     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFireWMIEvent"</span>);
00632     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00633 
00634     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrInfo=%p,InstanceName=%S)\n"</span>, ErrInfo, InstanceName));
00635 
00636     <span class="keywordflow">if</span> (ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00637     {
00638         ULONG NameLen, EventSize;
00639         PWNODE_SINGLE_INSTANCE event;
00640 
00641         NameLen = wcslen(InstanceName)*<span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span>(UNICODE_NULL);
00642         EventSize = <span class="keyword">sizeof</span>(WNODE_SINGLE_INSTANCE) + NameLen + ErrInfo-&gt;Size;
00643         event = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
00644                                       EventSize,
00645                                       IOETAG_WMIEVENT);
00646         <span class="keywordflow">if</span> (event != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00647         {
00648             event-&gt;WnodeHeader.BufferSize = EventSize;
00649             event-&gt;WnodeHeader.ProviderId = 0;
00650             event-&gt;WnodeHeader.Guid = <a class="code" href="../../d0/d2/data_8c.html#a0">IoepGuid</a>;
00651             event-&gt;WnodeHeader.Flags = WNODE_FLAG_SINGLE_INSTANCE |
00652                                        WNODE_FLAG_EVENT_ITEM;
00653             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;event-&gt;WnodeHeader.TimeStamp);
00654             event-&gt;OffsetInstanceName = <span class="keyword">sizeof</span>(WNODE_SINGLE_INSTANCE);
00655             event-&gt;DataBlockOffset = <span class="keyword">sizeof</span>(WNODE_SINGLE_INSTANCE) + NameLen;
00656             event-&gt;SizeDataBlock = ErrInfo-&gt;Size;
00657             RtlCopyMemory(&amp;event-&gt;VariableData, InstanceName, NameLen);
00658             RtlCopyMemory(event-&gt;VariableData + NameLen,
00659                           ErrInfo,
00660                           ErrInfo-&gt;Size);
00661             status = <a class="code" href="../../d0/d5/io_8h.html#a575">IoWMIWriteEvent</a>(event);
00662         }
00663         <span class="keywordflow">else</span>
00664         {
00665             status = STATUS_INSUFFICIENT_RESOURCES;
00666             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate WMI event node (len=%d)\n"</span>,
00667                       EventSize));
00668         }
00669     }
00670     <span class="keywordflow">else</span>
00671     {
00672         status = STATUS_SUCCESS;
00673     }
00674 
00675     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x\n"</span>, status));
00676     <span class="keywordflow">return</span> status;
00677 }       <span class="comment">//IoepFireWMIEvent</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ioerr.c::IoepFreeErrStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IoepFreeErrStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__errentry.html">PERRENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ErrStack</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00414">414</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00079">_errentry::DataBlk</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00030">IoepErrListLock</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00136">IoepGetNextErrEntry</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00074">_errentry::slist</a>, and <a class="el" href="../../d7/d4/ioep_8h-source.html#l00076">_errentry::unicodeStr</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00305">IoErrTerminateErrLog()</a>.
<p>
<pre class="fragment"><div>00419                    :
00420     This routine frees an error stack and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated data blocks.
00421 
00422 Arguments:
00423     ErrStack - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error stack to be freed
00424 
00425 Return Value:
00426     None
00427 
00428 --*/
00429 {
00430     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFreeErrStack"</span>);
00431     <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> Err, ErrNext;
00432     KIRQL Irql;
00433 
00434     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrStack != NULL);
00435     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrStack=%p)\n"</span>, ErrStack));
00436 
00437     ExAcquireSpinLock(&amp;IoepErrListLock, &amp;Irql);
00438     <span class="keywordflow">for</span> (Err = ErrStack; Err != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; Err = ErrNext)
00439     {
00440         <span class="keywordflow">if</span> (Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00441         {
00442             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a>);
00443             Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00444         }
00445         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>);
00446         ErrNext = <a class="code" href="../../d6/d5/ioep_8h.html#a26">IoepGetNextErrEntry</a>(Err);
00447         Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o0">slist</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00448         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Err);
00449     }
00450     ExReleaseSpinLock(&amp;IoepErrListLock, Irql);
00451 
00452     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"!\n"</span>));
00453 }       <span class="comment">//IoepFreeErrStack</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ioerr.c::IoepGetErrCaseDB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a> IoepGetErrCaseDB           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01200">1200</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00035">IoepErrCaseDB</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00034">IoepRegKeyStrIoErr</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00038">IOETAG_ERRCASEDB</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d3/ecdb_8h-source.html#l00036">_errcasedb::Length</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00418">ZwCreateFile()</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01052">IoepCatMsgArg()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00936">IoepGetErrMessage()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00680">IoepHandleErrCase()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00882">IoErrFindErrCaseByID()</a>, and <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00800">IoErrMatchErrCase()</a>.
<p>
<pre class="fragment"><div>01205                    :
01206     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ErrCase database has been read into memory.
01207     If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error <span class="keywordflow">case</span> database.  Otherwise,
01208     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> tries to read <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> database in.
01209 
01210 Arguments:
01211     None
01212 
01213 Return Value:
01214     Success - returns pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error <span class="keywordflow">case</span> database
01215     Failure - returns <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01216 
01217 --*/
01218 {
01219     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepGetErrCaseDB"</span>);
01220 
01221     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01222     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"()\n"</span>));
01223 
01224     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01225     {
01226         OBJECT_ATTRIBUTES ObjAttr;
01227         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01228         HANDLE hReg, hFile;
01229 
01230         InitializeObjectAttributes(&amp;ObjAttr,
01231                                    &amp;IoepRegKeyStrIoErr,
01232                                    OBJ_CASE_INSENSITIVE,
01233                                    NULL,
01234                                    NULL);
01235         status = ZwOpenKey(&amp;hReg, KEY_READ, &amp;ObjAttr);
01236         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01237         {
01238             PKEY_VALUE_FULL_INFORMATION KeyValue;
01239 
01240             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hReg, L<span class="stringliteral">"ErrCaseDB"</span>, &amp;KeyValue);
01241             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01242             {
01243                 UNICODE_STRING unicodeStr;
01244                 IO_STATUS_BLOCK IoStatusBlk;
01245 
01246                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeStr,
01247                                      (PWSTR)((PUCHAR)KeyValue +
01248                                              KeyValue-&gt;DataOffset));
01249                 InitializeObjectAttributes(&amp;ObjAttr,
01250                                            &amp;unicodeStr,
01251                                            OBJ_CASE_INSENSITIVE,
01252                                            NULL,
01253                                            NULL);
01254                 status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(&amp;hFile,
01255                                       FILE_READ_DATA,
01256                                       &amp;ObjAttr,
01257                                       &amp;IoStatusBlk,
01258                                       NULL,
01259                                       FILE_ATTRIBUTE_NORMAL,
01260                                       FILE_SHARE_READ,
01261                                       FILE_OPEN,
01262                                       FILE_NON_DIRECTORY_FILE |
01263                                       FILE_SEQUENTIAL_ONLY |
01264                                       FILE_SYNCHRONOUS_IO_NONALERT,
01265                                       NULL,
01266                                       0);
01267 
01268                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp;
01269                     (IoStatusBlk.Information == FILE_OPENED))
01270                 {
01271                     <a class="code" href="../../d9/d4/struct__errcasedb.html">ERRCASEDB</a> DBHeader;
01272 
01273                     status = ZwReadFile(hFile,
01274                                         NULL,
01275                                         NULL,
01276                                         NULL,
01277                                         &amp;IoStatusBlk,
01278                                         &amp;DBHeader,
01279                                         <span class="keyword">sizeof</span>(DBHeader),
01280                                         NULL,
01281                                         NULL);
01282 
01283                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01284                     {
01285                         <a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
01286                                                               DBHeader.<a class="code" href="../../d9/d4/struct__errcasedb.html#o3">Length</a>,
01287                                                               IOETAG_ERRCASEDB);
01288                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01289                         {
01290                             RtlCopyMemory(IoepErrCaseDB,
01291                                           &amp;DBHeader,
01292                                           <span class="keyword">sizeof</span>(DBHeader));
01293                             status = ZwReadFile(hFile,
01294                                                 NULL,
01295                                                 NULL,
01296                                                 NULL,
01297                                                 &amp;IoStatusBlk,
01298                                                 (PUCHAR)IoepErrCaseDB +
01299                                                 <span class="keyword">sizeof</span>(DBHeader),
01300                                                 DBHeader.Length -
01301                                                 <span class="keyword">sizeof</span>(DBHeader),
01302                                                 NULL,
01303                                                 NULL);
01304 
01305                             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01306                             {
01307                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IoepErrCaseDB);
01308                                 <a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01309                                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to read error case database (rc=%x)\n"</span>,
01310                                           status));
01311                             }
01312                         }
01313                         <span class="keywordflow">else</span>
01314                         {
01315                             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate storage for error case database (len=%d)\n"</span>,
01316                                       DBHeader.<a class="code" href="../../d9/d4/struct__errcasedb.html#o3">Length</a>));
01317                         }
01318                     }
01319                     <span class="keywordflow">else</span>
01320                     {
01321                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to read database header (rc=%x)\n"</span>,
01322                                   status));
01323                     }
01324                     ZwClose(hFile);
01325                 }
01326                 <span class="keywordflow">else</span>
01327                 {
01328                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to open error case database (rc=%x)\n"</span>,
01329                               status));
01330                 }
01331                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValue);
01332             }
01333             <span class="keywordflow">else</span>
01334             {
01335                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to read registry value (rc=%x)\n"</span>, status));
01336             }
01337             ZwClose(hReg);
01338         }
01339         <span class="keywordflow">else</span>
01340         {
01341             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to open registry key (rc=%x)\n"</span>, status));
01342         }
01343     }
01344 
01345     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, IoepErrCaseDB));
01346     <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a>;
01347 }       <span class="comment">//IoepGetErrCaseDB</span>
}       <span class="comment">//IoepGetErrCaseDB</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ioerr.c::IoepGetErrMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoepGetErrMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d9/struct__msgdata.html">PMSGDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MsgData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>unicodeMsg</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00936">936</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d4/d3/ecdb_8h-source.html#l00040">_errcasedb::DataBlkOffset</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01052">IoepCatMsgArg()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01200">IoepGetErrCaseDB()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01155">IoepUnicodeStringCatN()</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00037">IOETAG_MSGBUFF</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00038">MAX_MSG_LEN</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00036">STATUS_IOE_DATABASE_NOT_READY</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00680">IoepHandleErrCase()</a>.
<p>
<pre class="fragment"><div>00943                    :
00944     This routine constructs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error message from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message method data.
00945 
00946 Arguments:
00947     MsgData - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message method data
00948     ErrInfo - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error info
00949     unicodeMsg - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> uninitialized unicode string message buffer
00950 
00951 Return Value:
00952     Success - returns STATUS_SUCCESS
00953     Failure - returns NT status code
00954 
00955 Note:
00956     This routine will allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual string buffer of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode message.
00957     Therefore, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message buffer
00958     via <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>.
00959 
00960 --*/
00961 {
00962     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepGetErrMessage"</span>);
00963     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00964     <a class="code" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a> ErrCaseDB;
00965 
00966     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00967     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(pMsgData=%p,ErrInfo=%p,pMsg=%p)\n"</span>,
00968               MsgData, ErrInfo, unicodeMsg));
00969 
00970     ErrCaseDB = <a class="code" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a>();
00971     <span class="keywordflow">if</span> (ErrCaseDB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00972     {
00973         PWSTR MsgTemplate, MsgBuff, pwstr;
00974 
00975         MsgTemplate = (PWSTR)((ULONG_PTR)ErrCaseDB +
00976                               ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
00977                               MsgData-&gt;MsgTemplateOffset);
00978 
00979         MsgBuff = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
00980                                         <span class="keyword">sizeof</span>(WCHAR)*MAX_MSG_LEN +
00981                                         <span class="keyword">sizeof</span>(UNICODE_NULL),
00982                                         IOETAG_MSGBUFF);
00983 
00984         <span class="keywordflow">if</span> (MsgBuff != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00985         {
00986             MsgBuff[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00987             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(unicodeMsg, MsgBuff);
00988             unicodeMsg-&gt;MaximumLength = <span class="keyword">sizeof</span>(WCHAR)*<a class="code" href="../../d5/d5/ioeapi_8h.html#a3">MAX_MSG_LEN</a> +
00989                                         <span class="keyword">sizeof</span>(UNICODE_NULL);
00990 
00991             <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00992             {
00993                 pwstr = wcschr(MsgTemplate, L<span class="charliteral">'%'</span>);
00994                 <span class="keywordflow">if</span> (pwstr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00995                 {
00996                     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(unicodeMsg, MsgTemplate);
00997                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00998                     {
00999                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to append unicode string (rc=%x)\n"</span>,
01000                                   status));
01001                     }
01002                     <span class="keywordflow">break</span>;
01003                 }
01004                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pwstr[1] &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>) &amp;&amp; (pwstr[1] &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>))
01005                 {
01006                     ULONG ArgIndex;
01007                     PWSTR pwstr2;
01008 
01009                     ArgIndex = wcstoul(&amp;pwstr[1], &amp;pwstr2, 10);
01010                     status = <a class="code" href="../../d7/d5/ioerr_8c.html#a13">IoepUnicodeStringCatN</a>(unicodeMsg,
01011                                                    MsgTemplate,
01012                                                    pwstr - MsgTemplate);
01013                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01014                     {
01015                         MsgTemplate = pwstr2;
01016                         status = <a class="code" href="../../d7/d5/ioerr_8c.html#a12">IoepCatMsgArg</a>(unicodeMsg,
01017                                                &amp;MsgData-&gt;Args[ArgIndex],
01018                                                ErrInfo);
01019                     }
01020                 }
01021                 <span class="keywordflow">else</span>
01022                 {
01023                     pwstr++;
01024                     status = <a class="code" href="../../d7/d5/ioerr_8c.html#a13">IoepUnicodeStringCatN</a>(unicodeMsg,
01025                                                    MsgTemplate,
01026                                                    pwstr - MsgTemplate);
01027                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01028                     {
01029                         MsgTemplate = pwstr;
01030                     }
01031                 }
01032             }
01033         }
01034         <span class="keywordflow">else</span>
01035         {
01036             status = STATUS_INSUFFICIENT_RESOURCES;
01037             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate message buffer\n"</span>));
01038         }
01039     }
01040     <span class="keywordflow">else</span>
01041     {
01042         status = <a class="code" href="../../d5/d5/ioeapi_8h.html#a2">STATUS_IOE_DATABASE_NOT_READY</a>;
01043         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"error case database not ready\n"</span>));
01044     }
01045 
01046     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x(Msg=%S)\n"</span>,
01047              status, unicodeMsg-&gt;Buffer? unicodeMsg-&gt;Buffer: L<span class="stringliteral">""</span>));
01048     <span class="keywordflow">return</span> status;
01049 }       <span class="comment">//IoepGetErrMessage</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ioerr.c::IoepHandleErrCase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoepHandleErrCase           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__errcase.html">PERRCASE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrCase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Method</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING unicodeMsg&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00680">680</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d4/d3/ecdb_8h-source.html#l00040">_errcasedb::DataBlkOffset</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00048">IOEMETHOD_ANY</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00051">IOEMETHOD_HANDLER</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00049">IOEMETHOD_LONGMSG</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00050">IOEMETHOD_SHORTMSG</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00824">IoepFindErrHandler()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01200">IoepGetErrCaseDB()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00936">IoepGetErrMessage()</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00040">IOETAG_DATAWSTR</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>, <a class="el" href="../../d4/d3/ecdb_8h-source.html#l00053">_method::MethodDataOffset</a>, <a class="el" href="../../d4/d3/ecdb_8h-source.html#l00052">_method::MethodType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00095">PERRHANDLER</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00036">STATUS_IOE_DATABASE_NOT_READY</a>, and <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00034">STATUS_IOE_MESSAGE</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00985">IoErrGetLongErrMessage()</a>, <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l01041">IoErrGetShortErrMessage()</a>, and <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00939">IoErrHandleErrCase()</a>.
<p>
<pre class="fragment"><div>00688                    :
00689     This routine handles an error <span class="keywordflow">case</span> by executing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resolution method.
00690 
00691 Arguments:
00692     ErrInfo - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error info
00693     ErrCase - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error <span class="keywordflow">case</span>
00694     Method - specifying what method to use to handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error <span class="keywordflow">case</span>
00695     unicodeMsg - point to unicodeStr to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error message
00696 
00697 Return Value:
00698     Success - returns STATUS_SUCCESS
00699     Failure - returns NT status code
00700 
00701 --*/
00702 {
00703     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepHandleErrCase"</span>);
00704     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00705     <a class="code" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a> ErrCaseDB;
00706 
00707     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00708     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrInfo=%p,ErrCase=%p,Method=%x,unicodeMsg=%p)\n"</span>,
00709               ErrInfo, ErrCase, Method, unicodeMsg));
00710 
00711     ErrCaseDB = <a class="code" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a>();
00712     <span class="keywordflow">if</span> (ErrCaseDB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00713     {
00714         <a class="code" href="../../d4/d8/struct__method.html">PMETHOD</a> MethodTable;
00715         ULONG i;
00716         PVOID MethodData;
00717         UNICODE_STRING unicodeStr;
00718         <a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a> ErrHandler;
00719         PWSTR MsgTemplate;
00720 
00721         MethodTable = (<a class="code" href="../../d4/d8/struct__method.html">PMETHOD</a>)((ULONG_PTR)ErrCaseDB +
00722                                 ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
00723                                 ErrCase-&gt;MethodOffset);
00724 
00725         <span class="keywordflow">for</span> (i = 0, status = STATUS_NOT_FOUND;
00726              (status == STATUS_NOT_FOUND) &amp;&amp; (i &lt; ErrCase-&gt;NumMethods);
00727              ++i)
00728         {
00729             <span class="keywordflow">if</span> ((Method != <a class="code" href="../../d6/d5/ioep_8h.html#a14">IOEMETHOD_ANY</a>) &amp;&amp;
00730                 (Method != MethodTable[i].<a class="code" href="../../d4/d8/struct__method.html#o0">MethodType</a>))
00731             {
00732                 <span class="keywordflow">continue</span>;
00733             }
00734 
00735             MethodData = (PVOID)((ULONG_PTR)ErrCaseDB +
00736                                  ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
00737                                  MethodTable[i].<a class="code" href="../../d4/d8/struct__method.html#o1">MethodDataOffset</a>);
00738 
00739             <span class="keywordflow">switch</span> (MethodTable[i].<a class="code" href="../../d4/d8/struct__method.html#o0">MethodType</a>)
00740             {
00741                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a15">IOEMETHOD_LONGMSG</a>:
00742                     status = <a class="code" href="../../d7/d5/ioerr_8c.html#a11">IoepGetErrMessage</a>((<a class="code" href="../../d8/d9/struct__msgdata.html">PMSGDATA</a>)MethodData,
00743                                                ErrInfo,
00744                                                unicodeMsg? unicodeMsg:
00745                                                            &amp;unicodeStr);
00746 
00747                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (unicodeMsg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00748                     {
00749                         <a class="code" href="../../d4/d6/iosubs_8c.html#a94">IoRaiseInformationalHardError</a>(STATUS_IOE_MESSAGE,
00750                                                       &amp;unicodeStr,
00751                                                       NULL);
00752                         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeStr);
00753                     }
00754                     <span class="keywordflow">break</span>;
00755 
00756                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a16">IOEMETHOD_SHORTMSG</a>:
00757                     MsgTemplate =
00758                         (PWSTR)((ULONG_PTR)ErrCaseDB +
00759                                 ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
00760                                 ((<a class="code" href="../../d8/d9/struct__msgdata.html">PMSGDATA</a>)MethodData)-&gt;MsgTemplateOffset);
00761 
00762                     <span class="keywordflow">if</span> (unicodeMsg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00763                     {
00764                         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeStr, MsgTemplate);
00765                         <a class="code" href="../../d4/d6/iosubs_8c.html#a94">IoRaiseInformationalHardError</a>(STATUS_IOE_MESSAGE,
00766                                                       &amp;unicodeStr,
00767                                                       NULL);
00768                         status = STATUS_SUCCESS;
00769                     }
00770                     <span class="keywordflow">else</span>
00771                     {
00772                         ULONG len;
00773                         PWSTR pwstr;
00774 
00775                         len = wcslen(MsgTemplate)*<span class="keyword">sizeof</span>(WCHAR) +
00776                               <span class="keyword">sizeof</span>(UNICODE_NULL);
00777                         pwstr = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
00778                                                       len,
00779                                                       IOETAG_DATAWSTR);
00780                         <span class="keywordflow">if</span> (pwstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00781                         {
00782                             RtlCopyMemory(pwstr, MsgTemplate, len);
00783                             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(unicodeMsg, pwstr);
00784                             status = STATUS_SUCCESS;
00785                         }
00786                         <span class="keywordflow">else</span>
00787                         {
00788                             status = STATUS_INSUFFICIENT_RESOURCES;
00789                             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate short message buffer (len=%d)\n"</span>,
00790                                       len));
00791                         }
00792                     }
00793                     <span class="keywordflow">break</span>;
00794 
00795                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a17">IOEMETHOD_HANDLER</a>:
00796                     ErrHandler = <a class="code" href="../../d7/d5/ioerr_8c.html#a9">IoepFindErrHandler</a>(
00797                                     &amp;((<a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a>)MethodData)-&gt;ComponentGuid,
00798                                     ((<a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a>)MethodData)-&gt;HandlerIndex);
00799 
00800                     <span class="keywordflow">if</span> (ErrHandler != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00801                     {
00802                         status = ErrHandler(ErrInfo,
00803                                             ((<a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a>)MethodData)-&gt;Param);
00804                     }
00805                     <span class="keywordflow">break</span>;
00806 
00807                 <span class="keywordflow">default</span>:
00808                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid method type %d\n"</span>,
00809                               MethodTable[i].MethodType));
00810             }
00811         }
00812     }
00813     <span class="keywordflow">else</span>
00814     {
00815         status = <a class="code" href="../../d5/d5/ioeapi_8h.html#a2">STATUS_IOE_DATABASE_NOT_READY</a>;
00816         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"error case database not ready\n"</span>));
00817     }
00818 
00819     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x\n"</span>, status));
00820     <span class="keywordflow">return</span> status;
00821 }       <span class="comment">//IoepHandleErrCase</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ioerr.c::IoepInitErrLog" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE IoepInitErrLog           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00039">39</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00109">_errlog::ErrInfo</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00085">_errthread::ErrLogListHead</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00107">_errlog::ErrStack</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00108">_errlog::ErrThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a237">ExInterlockedInsertHeadList()</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00030">IoepErrListLock</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00108">IoepFindErrThread()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00186">IoepNewErrThread()</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00032">IOETAG_ERRLOG</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00106">_errlog::list</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00113">LOGF_INITMASK</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00112">SIG_ERRLOG</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00104">_errlog::Signature</a>, and <a class="el" href="../../d7/d4/ioep_8h-source.html#l00105">_errlog::ulFlags</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00073">IoErrInitErrLogByIrp()</a>, and <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00104">IoErrInitErrLogByThreadID()</a>.
<p>
<pre class="fragment"><div>00046                    :
00047     This routine initializes an error logging session with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified key.
00048 
00049 Arguments:
00050     KeyType - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
00051     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00052     ulFlags - log session flags
00053 
00054 Return Value:
00055     Success - returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created error log handle.
00056     Failure - returns <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00057 
00058 --*/
00059 {
00060     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepInitErrLog"</span>);
00061     <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLog;
00062 
00063     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Key != NULL);
00064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ulFlags &amp; ~LOGF_INITMASK == 0);
00065     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(KeyType=%x,Key=%p,ulFlags=%x)\n"</span>, KeyType, Key, ulFlags));
00066 
00067     ErrLog = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
00068                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/struct__errlog.html">ERRLOG</a>),
00069                                    IOETAG_ERRLOG);
00070 
00071     <span class="keywordflow">if</span> (ErrLog != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00072     {
00073         <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> ErrThread;
00074 
00075         ErrThread = <a class="code" href="../../d7/d5/ioerr_8c.html#a1">IoepFindErrThread</a>(KeyType, Key);
00076         <span class="keywordflow">if</span> (ErrThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00077         {
00078             ErrThread = <a class="code" href="../../d7/d5/ioerr_8c.html#a2">IoepNewErrThread</a>(KeyType, Key);
00079         }
00080 
00081         <span class="keywordflow">if</span> (ErrThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00082         {
00083             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o0">Signature</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>;
00084             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o1">ulFlags</a> = ulFlags &amp; <a class="code" href="../../d6/d5/ioep_8h.html#a23">LOGF_INITMASK</a>;
00085             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a> = ErrThread;
00086             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o3">ErrStack</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00087             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00088             <a class="code" href="../../d5/d8/ex_8h.html#a237">ExInterlockedInsertHeadList</a>(&amp;ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>,
00089                                         &amp;ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o2">list</a>,
00090                                         &amp;IoepErrListLock);
00091         }
00092         <span class="keywordflow">else</span>
00093         {
00094             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ErrLog);
00095             ErrLog = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00096         }
00097     }
00098     <span class="keywordflow">else</span>
00099     {
00100         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate new error log\n"</span>));
00101     }
00102 
00103     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrLog));
00104     <span class="keywordflow">return</span> ErrLog;
00105 }       <span class="comment">//IoepInitErrLog</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ioerr.c::IoepLogErr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IoepLogErr           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CONST GUID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ComponentGuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR TextData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataBlkType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG DataBlkLen&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID DataBlock&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CONST GUID *MofGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00255">255</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00060">_errid::ComponentGuid</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00079">_errentry::DataBlk</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00078">_errentry::DataBlkLen</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00077">_errentry::DataBlkType</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00061">_errid::ErrCode</a>, <a class="el" href="../../d6/d5/ioep_8h.html#a27">ERRENTRY</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00075">_errentry::ErrID</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00085">_errthread::ErrLogListHead</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00107">_errlog::ErrStack</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00046">IOEDATA_MAX</a>, <a class="el" href="../../d6/d4/ioeapi_8h-source.html#l00043">IOEDATA_NONE</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00030">IoepErrListLock</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00108">IoepFindErrThread()</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00035">IOETAG_DATABLOCK</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00039">IOETAG_DATATEXT</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00034">IOETAG_ERRENTRY</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00080">_errentry::MofGuid</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00074">_errentry::slist</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d4/ioep_8h-source.html#l00076">_errentry::unicodeStr</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00135">IoErrLogErrByIrp()</a>, and <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00186">IoErrLogErrByThreadID()</a>.
<p>
<pre class="fragment"><div>00268                    :
00269     This routine logs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error data to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error log session identified by
00270     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given key.
00271 
00272 Arguments:
00273     KeyType - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of key.
00274     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logging session.
00275     ComponentGuid - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> component GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00276     ErrCode - unique error code
00277     TextData - points to an optional WSTR of <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a> data
00278     DataBlkType - data <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data block
00279     DataBlkLen - length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data block
00280     DataBlock - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data block
00281     MofGuid - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MOF GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data block <span class="keywordflow">if</span> applicable
00282 
00283 Return Value:
00284     None
00285 
00286 --*/
00287 {
00288     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepLogErr"</span>);
00289     <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> ErrThread;
00290 
00291     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Key != NULL);
00292     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ComponentGuid != NULL);
00293     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((DataBlkType == IOEDATA_NONE) ||
00294            (DataBlkLen &gt; 0) &amp;&amp; (DataBlock != NULL));
00295     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DataBlkType &lt;= IOEDATA_MAX);
00296     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(KeyType=%x,Key=%p,pGuid=%p,ErrCode=%x,Text=%S,Type=%x,Len=%d,DataBlk=%p,MofGuid=%p)\n"</span>,
00297               KeyType, Key, ComponentGuid, ErrCode, TextData? TextData: L<span class="stringliteral">""</span>,
00298               DataBlkType, DataBlkLen, DataBlock, MofGuid));
00299 
00300     ErrThread = <a class="code" href="../../d7/d5/ioerr_8c.html#a1">IoepFindErrThread</a>(KeyType, Key);
00301     <span class="keywordflow">if</span> (ErrThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00302     {
00303         <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> Err;
00304 
00305         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>));
00306         Err = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
00307                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__errentry.html">ERRENTRY</a>),
00308                                     IOETAG_ERRENTRY);
00309 
00310         <span class="keywordflow">if</span> (Err != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00311         {
00312             BOOLEAN fOK = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00313             PVOID Data = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00314             PWSTR pwstr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00315 
00316             RtlZeroMemory(Err, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__errentry.html">ERRENTRY</a>));
00317             <span class="keywordflow">if</span> (DataBlkType != <a class="code" href="../../d5/d5/ioeapi_8h.html#a4">IOEDATA_NONE</a>)
00318             {
00319                 Data = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
00320                                              DataBlkLen,
00321                                              IOETAG_DATABLOCK);
00322 
00323                 <span class="keywordflow">if</span> (Data != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00324                 {
00325                     RtlCopyMemory(Data, DataBlock, DataBlkLen);
00326                 }
00327                 <span class="keywordflow">else</span>
00328                 {
00329                     fOK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00330                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate data block (len=%d)\n"</span>,
00331                               DataBlkLen));
00332                 }
00333             }
00334             <span class="keywordflow">else</span>
00335             {
00336                 <span class="comment">//</span>
00337                 <span class="comment">// Make sure DataLen does not have garbage.</span>
00338                 <span class="comment">//</span>
00339                 DataBlkLen = 0;
00340             }
00341 
00342             <span class="keywordflow">if</span> (TextData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00343             {
00344                 ULONG len;
00345 
00346                 len = wcslen(TextData)*<span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span>(UNICODE_NULL);
00347                 pwstr = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
00348                                               len,
00349                                               IOETAG_DATATEXT);
00350 
00351                 <span class="keywordflow">if</span> (pwstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00352                 {
00353                     RtlCopyMemory(pwstr, TextData, len);
00354                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>, pwstr);
00355                 }
00356                 <span class="keywordflow">else</span>
00357                 {
00358                     fOK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00359                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate text data (len=%d)\n"</span>,
00360                               len));
00361                 }
00362             }
00363 
00364             <span class="keywordflow">if</span> (fOK)
00365             {
00366                 <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLog;
00367                 KIRQL Irql;
00368 
00369                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o1">ErrID</a>.<a class="code" href="../../d2/d5/struct__errid.html#o0">ComponentGuid</a> = *ComponentGuid;
00370                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o1">ErrID</a>.<a class="code" href="../../d2/d5/struct__errid.html#o1">ErrCode</a> = ErrCode;
00371                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o3">DataBlkType</a> = DataBlkType;
00372                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a> = DataBlkLen;
00373                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a> = Data;
00374                 <span class="keywordflow">if</span> (MofGuid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00375                 {
00376                     Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o6">MofGuid</a> = *MofGuid;
00377                 }
00378 
00379                 ExAcquireSpinLock(&amp;IoepErrListLock, &amp;Irql);
00380                 ErrLog = CONTAINING_RECORD(ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>.Flink,
00381                                            <a class="code" href="../../d4/d5/struct__errlog.html">ERRLOG</a>,
00382                                            list);
00383                 PushEntryList(&amp;ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o3">ErrStack</a>, &amp;Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o0">slist</a>);
00384                 ExReleaseSpinLock(&amp;IoepErrListLock, Irql);
00385             }
00386             <span class="keywordflow">else</span>
00387             {
00388                 <span class="keywordflow">if</span> (Data != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00389                 {
00390                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Data);
00391                 }
00392                 <span class="keywordflow">if</span> (pwstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00393                 {
00394                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pwstr);
00395                 }
00396                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Err);
00397             }
00398         }
00399         <span class="keywordflow">else</span>
00400         {
00401             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate error entry\n"</span>));
00402         }
00403     }
00404     <span class="keywordflow">else</span>
00405     {
00406         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to find associated error thread (Type=%x,Key=%p)\n"</span>,
00407                   KeyType, Key));
00408     }
00409 
00410     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"!\n"</span>));
00411 }       <span class="comment">//IoepLogErr</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ioerr.c::IoepMatchErrIDPath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IoepMatchErrIDPath           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__errid.html">PERRID</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrIDPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumErrIDs</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00862">862</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ioeapi_8c-source.html#l00800">IoErrMatchErrCase()</a>.
<p>
<pre class="fragment"><div>00869                    :
00870     This routine compares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> paths <span class="keywordflow">for</span> a match.
00871 
00872 Arguments:
00873     ErrInfo - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error info buffer
00874     ErrIDPath - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error <span class="keywordflow">case</span>
00875     NumErrIDs - number of error IDs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>
00876 
00877 Return Value:
00878     Success - returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>: matched
00879     Failure - returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>: no match
00880 
00881 --*/
00882 {
00883     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepMatchErrIDPath"</span>);
00884     BOOLEAN rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00885     BOOLEAN fWildCard = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00886     ULONG i, j;
00887 
00888     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00889     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrInfo=%p,pErrID=%p,NumIDs=%d)\n"</span>,
00890               ErrInfo, ErrIDPath, NumErrIDs));
00891 
00892     <span class="keywordflow">for</span> (i = j = 0; (i &lt; NumErrIDs) &amp;&amp; (j &lt; ErrInfo-&gt;NumErrEntries);)
00893     {
00894         <span class="keywordflow">if</span> (ErrIDPath[i].ErrCode == 0)
00895         {
00896             fWildCard = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00897             i++;
00898         }
00899         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RtlEqualMemory(&amp;ErrIDPath[i].ComponentGuid,
00900                                 &amp;ErrInfo-&gt;ErrEntries[j].ErrID.ComponentGuid,
00901                                 <span class="keyword">sizeof</span>(GUID)) &amp;&amp;
00902                  (ErrIDPath[i].ErrCode == ErrInfo-&gt;ErrEntries[j].ErrID.ErrCode))
00903         {
00904             i++;
00905             j++;
00906             fWildCard = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00907         }
00908         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fWildCard)
00909         {
00910             j++;
00911         }
00912         <span class="keywordflow">else</span>
00913         {
00914             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00915             <span class="keywordflow">break</span>;
00916         }
00917     }
00918 
00919     <span class="keywordflow">if</span> ((rc == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (i &lt; NumErrIDs))
00920     {
00921         <span class="comment">//</span>
00922         <span class="comment">// The database ID path is longer than the error stack ID path.</span>
00923         <span class="comment">// This is not a good match, so let's move on to find another match.</span>
00924         <span class="comment">// However, the reverse is OK though (i.e. error stack ID path is</span>
00925         <span class="comment">// longer than the database ID path).  In this case, the database</span>
00926         <span class="comment">// ID path has an implicit wild card at the end.</span>
00927         <span class="comment">//</span>
00928         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00929     }
00930 
00931     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x\n"</span>, rc));
00932     <span class="keywordflow">return</span> rc;
00933 }       <span class="comment">//IoepMatchErrIDPath</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ioerr.c::IoepNewErrThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> IoepNewErrThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00186">186</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00085">_errthread::ErrLogListHead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d5/d8/ex_8h.html#a237">ExInterlockedInsertHeadList()</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00030">IoepErrListLock</a>, <a class="el" href="../../d1/d1/data_8c-source.html#l00031">IoepErrThreadListHead</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00033">IOETAG_ERRTHREAD</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00084">_errthread::list</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, <a class="el" href="../../d9/d5/struct__errthread.html#o11">_errthread::ThreadKey</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00045">THREADKEY_IRP</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00046">THREADKEY_THREADID</a>, and <a class="el" href="../../d7/d4/ioep_8h-source.html#l00086">_errthread::ThreadKeyType</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00039">IoepInitErrLog()</a>.
<p>
<pre class="fragment"><div>00192                    :
00193     This routine creates a <span class="keyword">new</span> error thread with a given key.
00194 
00195 Arguments:
00196     KeyType - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of key.
00197     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> logging session.
00198 
00199 Return Value:
00200     Success - returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error thread handle created.
00201     Failure - returns <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00202 
00203 --*/
00204 {
00205     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepNewErrThread"</span>);
00206     <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> ErrThread;
00207 
00208     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(KeyType=%x,Key=%p)\n"</span>, KeyType, Key));
00209 
00210     ErrThread = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
00211                                       <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/struct__errthread.html">ERRTHREAD</a>),
00212                                       IOETAG_ERRTHREAD);
00213 
00214     <span class="keywordflow">if</span> (ErrThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00215     {
00216         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00217 
00218         InitializeListHead(&amp;ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>);
00219         ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o2">ThreadKeyType</a> = KeyType;
00220 
00221         <span class="keywordflow">switch</span> (KeyType)
00222         {
00223             <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a12">THREADKEY_IRP</a>:
00224                 IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)Key);
00225                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.Irp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00226                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.MajorFunction =
00227                     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>;
00228                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.MinorFunction =
00229                     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>;
00230                 RtlCopyMemory(ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.Arguments,
00231                               &amp;IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Others,
00232                               <span class="keyword">sizeof</span>(PVOID)*4);
00233                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.TargetDevice =
00234                     IopDbgGetLowestDevice(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>);
00235                 <span class="keywordflow">break</span>;
00236 
00237             <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a13">THREADKEY_THREADID</a>:
00238                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.ThIDKey.ThreadID = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00239                 <span class="keywordflow">break</span>;
00240         }
00241         <a class="code" href="../../d5/d8/ex_8h.html#a237">ExInterlockedInsertHeadList</a>(&amp;IoepErrThreadListHead,
00242                                     &amp;ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o0">list</a>,
00243                                     &amp;IoepErrListLock);
00244     }
00245     <span class="keywordflow">else</span>
00246     {
00247         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate error thread\n"</span>));
00248     }
00249 
00250     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrThread));
00251     <span class="keywordflow">return</span> ErrThread;
00252 }       <span class="comment">//IoepNewErrThread</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ioerr.c::IoepUnicodeStringCatN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoepUnicodeStringCatN           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>unicodeStr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>pwstr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01155">1155</a> of file <a class="el" href="../../d8/d4/ioerr_8c-source.html">ioerr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d8/d3/trace_8h-source.html#l00051">ENTER</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d4/ioep_8h-source.html#l00066">PROCNAME</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00936">IoepGetErrMessage()</a>.
<p>
<pre class="fragment"><div>01162                    :
01163     This routine appends <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wchar string to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode string <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01164     enough space.  Otherwise, STATUS_BUFFER_TOO_SMALL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01165 
01166 Arguments:
01167     unicodeStr - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target unicode string
01168     pwstr - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wchar string
01169     len - length of wstr in bytes to append
01170 
01171 Return Value:
01172     Success - returns STATUS_SUCCESS
01173     Failure - returns NT status code
01174 
01175 --*/
01176 {
01177     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepUnicodeStringCatN"</span>);
01178     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01179 
01180     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01181     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(Msg=%S,Str=%S,Len=%d)\n"</span>, unicodeStr-&gt;Buffer, pwstr, len));
01182 
01183     <span class="keywordflow">if</span> (len &lt; (ULONG)(unicodeStr-&gt;MaximumLength - unicodeStr-&gt;Length))
01184     {
01185         wcsncpy(unicodeStr-&gt;Buffer, pwstr, len/<span class="keyword">sizeof</span>(WCHAR));
01186         unicodeStr-&gt;Length += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)len;
01187         unicodeStr-&gt;Buffer[len/<span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01188     }
01189     <span class="keywordflow">else</span>
01190     {
01191         status = STATUS_BUFFER_TOO_SMALL;
01192         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"unicode string too small\n"</span>));
01193     }
01194 
01195     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x(Msg=%S)\n"</span>, status, unicodeStr-&gt;Buffer));
01196     <span class="keywordflow">return</span> status;
01197 }       <span class="comment">//IoepUnicodeStringCatN</span>

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
