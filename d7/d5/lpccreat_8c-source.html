<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpccreat.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpccreat.c</h1><a href="../../d6/d6/lpccreat_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    lpccreat.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Local Inter-Process Communication (LPC) connection system services.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 15-May-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d7/lpcp_8h.html">lpcp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  Local procedure prototype</span>
00025 <span class="comment">//</span>
00026 
00027 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00028 <a class="code" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a> (
00029     OUT PHANDLE PortHandle,
00030     IN POBJECT_ATTRIBUTES ObjectAttributes,
00031     IN ULONG MaxConnectionInfoLength,
00032     IN ULONG MaxMessageLength,
00033     IN ULONG MaxPoolUsage,
00034     IN BOOLEAN Waitable
00035     );
00036 
00037 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtCreatePort)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtCreateWaitablePort)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LpcpCreatePort)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00042 <span class="preprocessor"></span>
00043 
00044 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00045"></a><a class="code" href="../../d6/d6/lpccreat_8c.html#a1">00045</a> <a class="code" href="../../d6/d6/lpccreat_8c.html#a1">NtCreatePort</a> (
00046     OUT PHANDLE PortHandle,
00047     IN POBJECT_ATTRIBUTES ObjectAttributes,
00048     IN ULONG MaxConnectionInfoLength,
00049     IN ULONG MaxMessageLength,
00050     IN ULONG MaxPoolUsage
00051     )
00052 
00053 <span class="comment">/*++</span>
00054 <span class="comment"></span>
00055 <span class="comment">Routine Description:</span>
00056 <span class="comment"></span>
00057 <span class="comment">    See LpcpCreatePort.</span>
00058 <span class="comment"></span>
00059 <span class="comment">Arguments:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    See LpcpCreatePort.</span>
00062 <span class="comment"></span>
00063 <span class="comment">Return Value:</span>
00064 <span class="comment"></span>
00065 <span class="comment">    NTSTATUS - An appropriate status value</span>
00066 <span class="comment"></span>
00067 <span class="comment">--*/</span>
00068 
00069 {
00070     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00071 
00072     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00073 
00074     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a>( <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>,
00075                              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00076                              MaxConnectionInfoLength,
00077                              MaxMessageLength,
00078                              MaxPoolUsage,
00079                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00080 
00081     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00082 
00083 }
00084 
00085 
00086 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00087"></a><a class="code" href="../../d6/d6/lpccreat_8c.html#a2">00087</a> <a class="code" href="../../d6/d6/lpccreat_8c.html#a2">NtCreateWaitablePort</a> (
00088     OUT PHANDLE PortHandle,
00089     IN POBJECT_ATTRIBUTES ObjectAttributes,
00090     IN ULONG MaxConnectionInfoLength,
00091     IN ULONG MaxMessageLength,
00092     IN ULONG MaxPoolUsage
00093     )
00094 
00095 <span class="comment">/*++</span>
00096 <span class="comment"></span>
00097 <span class="comment">Routine Description:</span>
00098 <span class="comment"></span>
00099 <span class="comment">    Same as NtCreatePort.</span>
00100 <span class="comment"></span>
00101 <span class="comment">    The only difference between this call and NtCreatePort is that the</span>
00102 <span class="comment">    working KEVENT that can be used to wait for LPC messages to arrive</span>
00103 <span class="comment">    asynchronously.</span>
00104 <span class="comment"></span>
00105 <span class="comment">Arguments:</span>
00106 <span class="comment"></span>
00107 <span class="comment">    See LpcpCreatePort.</span>
00108 <span class="comment"></span>
00109 <span class="comment">Return Value:</span>
00110 <span class="comment"></span>
00111 <span class="comment">    NTSTATUS - An appropriate status value</span>
00112 <span class="comment"></span>
00113 <span class="comment">--*/</span>
00114 
00115 {
00116     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00117 
00118     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00119 
00120     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a>( <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>,
00121                              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00122                              MaxConnectionInfoLength,
00123                              MaxMessageLength,
00124                              MaxPoolUsage,
00125                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00126 
00127     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00128 }
00129 
00130 
00131 <span class="comment">//</span>
00132 <span class="comment">//  Local support routine</span>
00133 <span class="comment">//</span>
00134 
00135 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00136"></a><a class="code" href="../../d6/d6/lpccreat_8c.html#a0">00136</a> <a class="code" href="../../d6/d6/lpccreat_8c.html#a0">LpcpCreatePort</a> (
00137     OUT PHANDLE PortHandle,
00138     IN POBJECT_ATTRIBUTES ObjectAttributes,
00139     IN ULONG MaxConnectionInfoLength,
00140     IN ULONG MaxMessageLength,
00141     IN ULONG MaxPoolUsage,
00142     IN BOOLEAN Waitable
00143     )
00144 
00145 <span class="comment">/*++</span>
00146 <span class="comment"></span>
00147 <span class="comment">Routine Description:</span>
00148 <span class="comment"></span>
00149 <span class="comment">    A server process can create a named connection port with the NtCreatePort</span>
00150 <span class="comment">    service.</span>
00151 <span class="comment"></span>
00152 <span class="comment">    A connection port is created with the name and SECURITY_DESCRIPTOR</span>
00153 <span class="comment">    specified in the ObjectAttributes structure.  A handle to the connection</span>
00154 <span class="comment">    port object is returned in the location pointed to by the PortHandle</span>
00155 <span class="comment">    parameter.  The returned handle can then be used to listen for connection</span>
00156 <span class="comment">    requests to that port name, using the NtListenPort service.</span>
00157 <span class="comment"></span>
00158 <span class="comment">    The standard object architecture defined desired access parameter is not</span>
00159 <span class="comment">    necessary since this service can only create a new port, not access an</span>
00160 <span class="comment">    existing port.</span>
00161 <span class="comment"></span>
00162 <span class="comment">    Connection ports cannot be used to send and receive messages.  They are</span>
00163 <span class="comment">    only valid as a parameter to the NtListenPort service.</span>
00164 <span class="comment"></span>
00165 <span class="comment">Arguments:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    PortHandle - A pointer to a variable that will receive the connection port</span>
00168 <span class="comment">        object handle value.</span>
00169 <span class="comment"></span>
00170 <span class="comment">    ObjectAttributes - A pointer to a structure that specifies the name of the</span>
00171 <span class="comment">        object, an access control list (SECURITY_DESCRIPTOR) to be applied to</span>
00172 <span class="comment">        the object, and a set of object attribute flags.</span>
00173 <span class="comment"></span>
00174 <span class="comment">        PUNICODE_STRING ObjectName - An optional pointer to a null terminated</span>
00175 <span class="comment">            port name string.  The form of the name is</span>
00176 <span class="comment">            [\name...\name]\port_name.  If no name is specified then an</span>
00177 <span class="comment">            unconnected communication port is created rather than a connection</span>
00178 <span class="comment">            port.  This is useful for sending and receiving messages between</span>
00179 <span class="comment">            threads of a single process.</span>
00180 <span class="comment"></span>
00181 <span class="comment">        ULONG Attributes - A set of flags that control the port object</span>
00182 <span class="comment">            attributes.</span>
00183 <span class="comment"></span>
00184 <span class="comment">            None of the standard values are relevant for this call.</span>
00185 <span class="comment">            Connection ports cannot be inherited, are always placed in the</span>
00186 <span class="comment">            system handle table and are exclusive to the creating process.</span>
00187 <span class="comment">            This field must be zero.  Future implementations might support</span>
00188 <span class="comment">            specifying the OBJ_PERMANENT attribute.</span>
00189 <span class="comment"></span>
00190 <span class="comment">    MaxMessageLength - Specifies the maximum length of messages sent or</span>
00191 <span class="comment">        received on communication ports created from this connection</span>
00192 <span class="comment">        port.  The value of this parameter cannot exceed</span>
00193 <span class="comment">        MAX_PORTMSG_LENGTH bytes.</span>
00194 <span class="comment"></span>
00195 <span class="comment">    MaxPoolUsage - Specifies the maximum amount of NonPaged pool used for</span>
00196 <span class="comment">        message storage.</span>
00197 <span class="comment"></span>
00198 <span class="comment">    Waitable - Specifies if the event used by the port can be use to wait</span>
00199 <span class="comment">        for LPC messages to arrive asynchronously.</span>
00200 <span class="comment"></span>
00201 <span class="comment">Return Value:</span>
00202 <span class="comment"></span>
00203 <span class="comment">    NTSTATUS - An appropriate status value</span>
00204 <span class="comment"></span>
00205 <span class="comment">--*/</span>
00206 
00207 {
00208     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ConnectionPort;
00209     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00210     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00212     PUNICODE_STRING NamePtr;
00213     UNICODE_STRING CapturedObjectName;
00214 
00215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00219     <span class="comment">//</span>
00220 
00221     PreviousMode = KeGetPreviousMode();
00222     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CapturedObjectName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00223 
00224     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00225 
00226         <span class="keywordflow">try</span> {
00227 
00228             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> );
00229 
00230             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00231                           <span class="keyword">sizeof</span>( OBJECT_ATTRIBUTES ),
00232                           <span class="keyword">sizeof</span>( ULONG ));
00233 
00234             NamePtr = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName;
00235 
00236             <span class="keywordflow">if</span> (NamePtr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00237 
00238                 CapturedObjectName = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>( NamePtr,
00239                                                             UNICODE_STRING );
00240             }
00241 
00242         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00243 
00244             <span class="keywordflow">return</span>( GetExceptionCode() );
00245         }
00246 
00247     } <span class="keywordflow">else</span> {
00248 
00249         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00250 
00251             CapturedObjectName = *(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName);
00252         }
00253     }
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">//  Make the null buffer indicate an unspecified port name</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> (CapturedObjectName.Length == 0) {
00260 
00261         CapturedObjectName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00262     }
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">//  Allocate and initialize a port object.  If an object name was</span>
00266     <span class="comment">//  specified, then this is a connection port.  Otherwise this is an</span>
00267     <span class="comment">//  unconnected communication port that a process can use to communicate</span>
00268     <span class="comment">//  between threads.</span>
00269     <span class="comment">//</span>
00270 
00271     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( PreviousMode,
00272                              (Waitable ? <a class="code" href="../../d9/d8/ntos_8h.html#a6">LpcWaitablePortObjectType</a>
00273                                        : <a class="code" href="../../d9/d8/ntos_8h.html#a5">LpcPortObjectType</a>),
00274                              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00275                              PreviousMode,
00276                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00277                              (ULONG)<span class="keyword">sizeof</span>( <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">LPCP_PORT_OBJECT</a> ),
00278                              0,
00279                              0,
00280                              (PVOID *)&amp;ConnectionPort );
00281 
00282     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00283 
00284         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00285     }
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">//  Zero out the connection port object and then initialize its fields</span>
00289     <span class="comment">//</span>
00290 
00291     RtlZeroMemory( ConnectionPort, (ULONG)<span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a> ));
00292 
00293     ConnectionPort-&gt;Length = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a> );
00294     ConnectionPort-&gt;ConnectionPort = ConnectionPort;
00295     ConnectionPort-&gt;Creator = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid;
00296 
00297     InitializeListHead( &amp;ConnectionPort-&gt;LpcReplyChainHead );
00298 
00299     InitializeListHead( &amp;ConnectionPort-&gt;LpcDataInfoChainHead );
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  Named ports get a connection message queue.</span>
00303     <span class="comment">//</span>
00304 
00305     <span class="keywordflow">if</span> (CapturedObjectName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00306 
00307         ConnectionPort-&gt;Flags = <a class="code" href="../../d2/d6/lpc_8h.html#a5">UNCONNECTED_COMMUNICATION_PORT</a>;
00308         ConnectionPort-&gt;ConnectedPort = ConnectionPort;
00309         ConnectionPort-&gt;ServerProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00310 
00311     } <span class="keywordflow">else</span> {
00312 
00313         ConnectionPort-&gt;Flags = <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>;
00314 
00315         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
00316         ConnectionPort-&gt;ServerProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00317     }
00318     
00319     <span class="keywordflow">if</span> ( Waitable ) {
00320 
00321         ConnectionPort-&gt;Flags |= <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a>;
00322     }
00323     
00324     <span class="comment">//</span>
00325     <span class="comment">//  All ports get a request message queue.</span>
00326     <span class="comment">//</span>
00327 
00328     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/lpcqueue_8c.html#a0">LpcpInitializePortQueue</a>( ConnectionPort );
00329 
00330     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00331 
00332         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00333 
00334         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00335     }
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">//  For a waitable port, create the KEVENT that will</span>
00339     <span class="comment">//  be used to signal clients</span>
00340     <span class="comment">//</span>
00341 
00342     <span class="keywordflow">if</span> (ConnectionPort-&gt;Flags &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a>) {
00343 
00344         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;ConnectionPort-&gt;WaitEvent,
00345                            NotificationEvent,
00346                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00347     }
00348 
00349     <span class="comment">//</span>
00350     <span class="comment">//  Set the maximum message length and connection info length based on the</span>
00351     <span class="comment">//  zone block size less the structs overhead.</span>
00352     <span class="comment">//</span>
00353 
00354     ConnectionPort-&gt;MaxMessageLength = <a class="code" href="../../d0/d7/lpcp_8h.html#a17">LpcpZone</a>.<a class="code" href="../../d1/d5/struct__LPCP__PORT__ZONE.html#o3">Zone</a>.<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o2">BlockSize</a> -
00355                                         FIELD_OFFSET( <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">LPCP_MESSAGE</a>, <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> );
00356 
00357     ConnectionPort-&gt;MaxConnectionInfoLength = ConnectionPort-&gt;MaxMessageLength -
00358                                                 <span class="keyword">sizeof</span>( PORT_MESSAGE ) -
00359                                                 <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">LPCP_CONNECTION_MESSAGE</a> );
00360 
00361 <span class="preprocessor">#if DBG</span>
00362 <span class="preprocessor"></span>    <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"Created port %ws (%x) - MaxMsgLen == %x  MaxConnectInfoLen == %x\n"</span>,
00363                 CapturedObjectName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"** UnNamed **"</span> : <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName-&gt;Buffer,
00364                 ConnectionPort,
00365                 ConnectionPort-&gt;MaxMessageLength,
00366                 ConnectionPort-&gt;MaxConnectionInfoLength ));
00367 <span class="preprocessor">#endif</span>
00368 <span class="preprocessor"></span>
00369     <span class="comment">//</span>
00370     <span class="comment">//  Sanity check that the max message length being asked for is not</span>
00371     <span class="comment">//  greater than the max message length possible in the system</span>
00372     <span class="comment">//</span>
00373 
00374     <span class="keywordflow">if</span> (ConnectionPort-&gt;MaxMessageLength &lt; MaxMessageLength) {
00375 
00376 <span class="preprocessor">#if DBG</span>
00377 <span class="preprocessor"></span>        <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"MaxMessageLength granted is %x but requested %x\n"</span>,
00378                     ConnectionPort-&gt;MaxMessageLength,
00379                     MaxMessageLength ));
00380         DbgBreakPoint();
00381 <span class="preprocessor">#endif</span>
00382 <span class="preprocessor"></span>
00383         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00384 
00385         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00386     }
00387     
00388     <span class="comment">//</span>
00389     <span class="comment">//  Save the MaxMessageLength to the connection port</span>
00390     <span class="comment">//</span>
00391 
00392     ConnectionPort-&gt;MaxMessageLength = MaxMessageLength;
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">//  Sanity check that the max connection info length being asked for is</span>
00396     <span class="comment">//  not greater than the maximum possible in the system</span>
00397     <span class="comment">//</span>
00398 
00399     <span class="keywordflow">if</span> (ConnectionPort-&gt;MaxConnectionInfoLength &lt; MaxConnectionInfoLength) {
00400 
00401 <span class="preprocessor">#if DBG</span>
00402 <span class="preprocessor"></span>        <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"MaxConnectionInfoLength granted is %x but requested %x\n"</span>,
00403                     ConnectionPort-&gt;MaxConnectionInfoLength,
00404                     MaxConnectionInfoLength ));
00405         DbgBreakPoint();
00406 <span class="preprocessor">#endif</span>
00407 <span class="preprocessor"></span>
00408         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00409 
00410         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00411     }
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">//  Insert connection port object in specified object table.  Set port</span>
00415     <span class="comment">//  handle value if successful.  If not successful, then the port will</span>
00416     <span class="comment">//  have been dereferenced, which will cause it to be freed, after our</span>
00417     <span class="comment">//  delete procedure is called.  The delete procedure will undo the work</span>
00418     <span class="comment">//  done to initialize the port.  Finally, return the system server status.</span>
00419     <span class="comment">//</span>
00420 
00421     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( ConnectionPort,
00422                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00423                              PORT_ALL_ACCESS,
00424                              0,
00425                              (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00426                              &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00427 
00428     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00429 
00430         <span class="comment">//</span>
00431         <span class="comment">//  Set the output variable protected against access faults</span>
00432         <span class="comment">//</span>
00433 
00434         <span class="keywordflow">try</span> {
00435 
00436             *<a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00437 
00438         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00439 
00440             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00441 
00442             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00443         }
00444     }
00445 
00446     <span class="comment">//</span>
00447     <span class="comment">//  And return to our caller</span>
00448     <span class="comment">//</span>
00449 
00450     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00451 }
00452 
00453 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
