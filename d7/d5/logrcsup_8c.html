<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: logrcsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>logrcsup.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>"</code><br>

<p>
<a href="../../d8/d4/logrcsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/logrcsup_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_LOG_RECORD_SUP)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/logrcsup_8c.html#a1">LfsPrepareLfcbForLogRecord</a> (IN OUT <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN ULONG RemainingLogBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/logrcsup_8c.html#a2">LfsTransferLogBytes</a> (IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb, IN OUT <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> *ThisWriteEntry, IN OUT PCHAR *CurrentBuffer, IN OUT PULONG CurrentByteCount, IN OUT PULONG PadBytes, IN OUT PULONG RemainingPageBytes, IN OUT PULONG RemainingLogBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/logrcsup_8c.html#a3">LfsWriteLogRecordIntoLogPage</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch, IN ULONG NumberOfWriteEntries, IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> WriteEntries, IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a> RecordType, IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId OPTIONAL, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ClientUndoNextLsn OPTIONAL, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ClientPreviousLsn OPTIONAL, IN LONG UndoRequirement, IN BOOLEAN ForceToDisk, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="logrcsup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_LOG_RECORD_SUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00028">28</a> of file <a class="el" href="../../d8/d4/logrcsup_8c-source.html">logrcsup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="logrcsup.c::LfsPrepareLfcbForLogRecord" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsPrepareLfcbForLogRecord           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingLogBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00431">431</a> of file <a class="el" href="../../d8/d4/logrcsup_8c-source.html">logrcsup.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00196">_LBCB::ActiveLinks</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00219">_LBCB::BufferOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00284">LBCB_ON_ACTIVE_QUEUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>.
<p>
<pre class="fragment"><div>00438                    :
00439 
00440     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to insure that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb has a Lbcb in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00441     active queue to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next log record transfer.
00442     This condition <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> met when there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a least one buffer block and
00443     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record data will fit entirely on <span class="keyword">this</span> page or <span class="keyword">this</span> buffer
00444     block contains no other data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unpacked <span class="keywordflow">case</span>.  For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packed
00445     <span class="keywordflow">case</span> we just need to make sure that there are sufficient Lbcb's.
00446 
00447 Arguments:
00448 
00449     Lfcb - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00450 
00451     RemainingLogBytes - The number of bytes remaining <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00452 
00453 Return Value:
00454 
00455     None
00456 
00457 --*/
00458 
00459 {
00460     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00461     ULONG RemainingPageBytes;
00462     PLIST_ENTRY LbcbLinks;
00463 
00464     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00465 
00466     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsPrepareLfcbForLogRecord:  Entered\n"</span>, 0 );
00467     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb              -&gt; %08lx\n"</span>, Lfcb );
00468     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RemainingLogBytes -&gt; %08lx\n"</span>, RemainingLogBytes );
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">//  If there is no Lbcb in the active queue, we don't check it for size.</span>
00472     <span class="comment">//</span>
00473 
00474     <span class="keywordflow">if</span> (!IsListEmpty( &amp;Lfcb-&gt;LbcbActive )) {
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">//  If the log record won't fit in the remaining bytes of this page,</span>
00478         <span class="comment">//  we queue this log buffer.</span>
00479         <span class="comment">//</span>
00480 
00481         ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00482                                       <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00483                                       ActiveLinks );
00484 
00485         RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize
00486                              - (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">//  This log page won't do if the remaining bytes won't hold the data</span>
00490         <span class="comment">//  unless this is the first log record in the page or we are packing</span>
00491         <span class="comment">//  the log file.</span>
00492         <span class="comment">//</span>
00493 
00494         <span class="keywordflow">if</span> (RemainingLogBytes &gt; RemainingPageBytes
00495             &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )
00496             &amp;&amp; (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a> != (ULONG)Lfcb-&gt;LogPageDataOffset) {
00497 
00498             RemoveHeadList( &amp;Lfcb-&gt;LbcbActive );
00499             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE );
00500         }
00501     }
00502 
00503     <span class="comment">//</span>
00504     <span class="comment">//  We now make sure we can allocate enough Lbcb's for all of the log pages</span>
00505     <span class="comment">//  we will need.  We now include the bytes for the log record reader.</span>
00506     <span class="comment">//</span>
00507 
00508     LbcbLinks = Lfcb-&gt;LbcbActive.Flink;
00509 
00510     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00511 
00512         <span class="comment">//</span>
00513         <span class="comment">//  If the Lbcb link we have is the head of the list, we will need another</span>
00514         <span class="comment">//  Lbcb.</span>
00515         <span class="comment">//</span>
00516 
00517         <span class="keywordflow">if</span> (LbcbLinks == &amp;Lfcb-&gt;LbcbActive) {
00518 
00519             ThisLbcb = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a55">LfsGetLbcb</a>( Lfcb );
00520 
00521         } <span class="keywordflow">else</span> {
00522 
00523             ThisLbcb = CONTAINING_RECORD( LbcbLinks,
00524                                           <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00525                                           ActiveLinks );
00526         }
00527 
00528         <span class="comment">//</span>
00529         <span class="comment">//  Remember the bytes remaining on this page.  This will always be quad</span>
00530         <span class="comment">//  aligned.</span>
00531         <span class="comment">//</span>
00532 
00533         RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize - (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00534 
00535         <span class="keywordflow">if</span> (RemainingPageBytes &gt;= RemainingLogBytes) {
00536 
00537             <span class="keywordflow">break</span>;
00538         }
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">//  Move to the next log record.</span>
00542         <span class="comment">//</span>
00543 
00544         RemainingLogBytes -= RemainingPageBytes;
00545 
00546         LbcbLinks = ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a>.Flink;
00547     }
00548 
00549     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsPrepareLfcbForLogRecord:  Exit\n"</span>, 0 );
00550 
00551     <span class="keywordflow">return</span>;
00552 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="logrcsup.c::LfsTransferLogBytes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsTransferLogBytes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ThisWriteEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentByteCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PadBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingPageBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingLogBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00556">556</a> of file <a class="el" href="../../d8/d4/logrcsup_8c-source.html">logrcsup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>.
<p>
<pre class="fragment"><div>00568                    :
00569 
00570     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to transfer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next block of bytes into
00571     a log page.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> given a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current position in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00572     current Lfs write entry and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes remaining on that
00573     log page.  It will transfer as many of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's bytes from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00574     current buffer that will fit and update various pointers.
00575 
00576 Arguments:
00577 
00578     Lbcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer block <span class="keywordflow">for</span> <span class="keyword">this</span> log page.
00579 
00580     ThisWriteEntry - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Lfs
00581                      write entry.
00582 
00583     CurrentBuffer - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current position
00584                     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current write entry buffer.  If <span class="keyword">this</span> points to a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00585                     value <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> means to put zero bytes into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log.
00586 
00587     CurrentByteCount - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes remaining
00588                        in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current buffer.
00589 
00590     PadBytes - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of padding byes <span class="keywordflow">for</span>
00591         <span class="keyword">this</span> write entry.
00592 
00593     RemainingPageBytes - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes remaining
00594                          in <span class="keyword">this</span> page.
00595 
00596     RemainingLogBytes - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes remaining to transfer
00597                         <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00598 
00599 Return Value:
00600 
00601     None
00602 
00603 --*/
00604 
00605 {
00606     PCHAR CurrentLogPagePosition;
00607     PCHAR CurrentClientPosition;
00608 
00609     ULONG TransferBytes;
00610     ULONG ThisPadBytes;
00611 
00612     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00613 
00614     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsTransferLogBytes:  Entered\n"</span>, 0 );
00615     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lbcb                      -&gt; %08lx\n"</span>, Lbcb );
00616     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ThisWriteEntry            -&gt; %08lx\n"</span>, *ThisWriteEntry );
00617     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"CurrentBuffer             -&gt; %08lx\n"</span>, *CurrentBuffer );
00618     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"CurrentByteCount          -&gt; %08lx\n"</span>, *CurrentByteCount );
00619     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RemainingPageBytes        -&gt; %08lx\n"</span>, *RemainingPageBytes );
00620     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RemainingLogBytes         -&gt; %08lx\n"</span>, *RemainingLogBytes );
00621 
00622     <span class="comment">//</span>
00623     <span class="comment">//  Remember the current client buffer position and current position</span>
00624     <span class="comment">//  in log page.</span>
00625     <span class="comment">//</span>
00626 
00627     CurrentLogPagePosition = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lbcb-&gt;PageHeader, (ULONG)Lbcb-&gt;BufferOffset, PCHAR );
00628     CurrentClientPosition = *CurrentBuffer;
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">//  The limiting factor is either the number of bytes remaining in a</span>
00632     <span class="comment">//  write entry or the number remaining in the log page.</span>
00633     <span class="comment">//</span>
00634 
00635     <span class="keywordflow">if</span> (*CurrentByteCount &lt;= *RemainingPageBytes) {
00636 
00637         TransferBytes = *CurrentByteCount;
00638 
00639         ThisPadBytes = *PadBytes;
00640 
00641         <span class="keywordflow">if</span> (*RemainingLogBytes != (*CurrentByteCount + *PadBytes) ) {
00642 
00643             (*ThisWriteEntry)++;
00644 
00645             *CurrentBuffer = (*ThisWriteEntry)-&gt;Buffer;
00646             *CurrentByteCount = (*ThisWriteEntry)-&gt;ByteLength;
00647 
00648             *PadBytes = (8 - (*CurrentByteCount &amp; ~(0xfffffff8))) &amp; ~(0xfffffff8);
00649         }
00650 
00651     } <span class="keywordflow">else</span> {
00652 
00653         TransferBytes = *RemainingPageBytes;
00654 
00655         ThisPadBytes = 0;
00656 
00657         *CurrentByteCount -= TransferBytes;
00658 
00659         <span class="keywordflow">if</span> (*CurrentBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00660 
00661             *CurrentBuffer += TransferBytes;
00662         }
00663     }
00664 
00665     <span class="comment">//</span>
00666     <span class="comment">//  Transfer the requested bytes.</span>
00667     <span class="comment">//</span>
00668 
00669     <span class="keywordflow">if</span> (CurrentClientPosition != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00670 
00671         RtlCopyMemory( CurrentLogPagePosition, CurrentClientPosition, TransferBytes );
00672 
00673     } <span class="keywordflow">else</span> {
00674 
00675         RtlZeroMemory( CurrentLogPagePosition, TransferBytes );
00676     }
00677 
00678     <span class="comment">//</span>
00679     <span class="comment">//  Reduce the remaining page and log bytes by the transfer amount and</span>
00680     <span class="comment">//  move forward in the log page.</span>
00681     <span class="comment">//</span>
00682 
00683     *RemainingLogBytes -= (TransferBytes + ThisPadBytes);
00684     *RemainingPageBytes -= (TransferBytes + ThisPadBytes);
00685 
00686     (ULONG)Lbcb-&gt;BufferOffset += (TransferBytes + ThisPadBytes);
00687 
00688     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsTransferLogBytes:  Exit\n"</span>, 0 );
00689 
00690     <span class="keywordflow">return</span>;
00691 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="logrcsup.c::LfsWriteLogRecordIntoLogPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LfsWriteLogRecordIntoLogPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d9/struct__LCH.html">PLCH</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfWriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a13">LFS_RECORD_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RecordType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a17">TRANSACTION_ID</a> *TransactionId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ClientUndoNextLsn&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ClientPreviousLsn&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UndoRequirement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ForceToDisk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">55</a> of file <a class="el" href="../../d8/d4/logrcsup_8c-source.html">logrcsup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00210">_LFS_WRITE_ENTRY::Buffer</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00219">_LBCB::BufferOffset</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00211">_LFS_WRITE_ENTRY::ByteLength</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00092">_LFS_RECORD_HEADER::ClientDataLength</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00100">_LFS_RECORD_HEADER::ClientId</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00081">_LFS_RECORD_HEADER::ClientPreviousLsn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00082">_LFS_RECORD_HEADER::ClientUndoNextLsn</a>, <a class="el" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">_LFS_RECORD_PAGE_HEADER::Copy</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00230">_LFS_RECORD_PAGE_HEADER::Flags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00261">_LBCB::Flags</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00120">_LFS_RECORD_HEADER::Flags</a>, <a class="el" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">_LFS_RECORD_PAGE_HEADER::Header</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00249">_LBCB::LastEndLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00242">_LBCB::LastLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00285">LBCB_NOT_EMPTY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00284">LBCB_ON_ACTIVE_QUEUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00601">LFCB_NO_LAST_LSN</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00509">LfsAcquireLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00291">LfsComputeLsnFromLbcb</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00431">LfsPrepareLfcbForLogRecord()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00556">LfsTransferLogBytes()</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00114">LfsVerifyLogSpaceAvail()</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00253">LOG_PAGE_LOG_RECORD_END</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00130">LOG_RECORD_MULTI_PAGE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00235">_LBCB::LogPageBcb</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00140">LSN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00228">_LBCB::PageHeader</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00513">QuadAlign</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00107">_LFS_RECORD_HEADER::RecordType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00073">_LFS_RECORD_HEADER::ThisLsn</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00114">_LFS_RECORD_HEADER::TransactionId</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00195">_LBCB::WorkqueLinks</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00197">LfsForceWrite()</a>, <a class="el" href="../../d2/d9/lfs_2write_8c-source.html#l00039">LfsWrite()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.
<p>
<pre class="fragment"><div>00071                    :
00072 
00073     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to write a log record into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00074     <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache manager.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> room in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current log
00075     page <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added to that.  Otherwise we allocate a <span class="keyword">new</span> log page
00076     and write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record header <span class="keywordflow">for</span> <span class="keyword">this</span> log page.  We then
00077     write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining bytes of <span class="keyword">this</span> page and
00078     into any subsequent pages <span class="keywordflow">if</span> needed.
00079 
00080 Arguments:
00081 
00082     Lfcb - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <span class="keyword">this</span> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00083 
00084     Lch - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client handle, we may update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo space <span class="keywordflow">for</span> <span class="keyword">this</span>
00085           client.
00086 
00087     NumberOfWriteEntries - Number of components of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log record.
00088 
00089     WriteEntries - Pointer to an array of write entries.
00090 
00091     UndoRequirement - Signed value indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requirement to write
00092                       an abort log record <span class="keywordflow">for</span> <span class="keyword">this</span> log record.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> negative
00093                       value indicates that <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> abort record.
00094 
00095     RecordType - The Lfs-defined <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <span class="keyword">this</span> log record.
00096 
00097     TransactionId - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transaction structure containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00098                     Id <span class="keywordflow">for</span> transaction containing <span class="keyword">this</span> operation.
00099 
00100     ClientUndoNextLsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn provided by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client <span class="keywordflow">for</span> use
00101                         in his restart.  Will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zero Lsn <span class="keywordflow">for</span>
00102                         a restart log record.
00103 
00104     ClientPreviousLsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn provided by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client <span class="keywordflow">for</span> use
00105                         in his restart.  Will <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zero Lsn <span class="keywordflow">for</span> a
00106                         restart log record.
00107 
00108     UndoRequirement - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> undo record <span class="keywordflow">for</span>
00109                       <span class="keyword">this</span> log record.
00110 
00111     ForceToDisk - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> log record will be flushed immediately
00112                   to disk.
00113 
00114     Lsn - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn <span class="keywordflow">for</span> <span class="keyword">this</span> log record.
00115 
00116 Return Value:
00117 
00118     BOOLEAN - Advisory, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that less than 1/4 of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00119         available.
00120 
00121 --*/
00122 
00123 {
00124     <a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> ThisWriteEntry;
00125 
00126     ULONG RemainingLogBytes;
00127     ULONG OriginalLogBytes;
00128 
00129     ULONG RemainingPageBytes;
00130     ULONG HeaderAdjust;
00131 
00132     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00133 
00134     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> NextLsn;
00135 
00136     <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader;
00137 
00138     PCHAR CurrentBuffer;
00139     ULONG CurrentByteCount;
00140     ULONG PadBytes;
00141 
00142     BOOLEAN LogFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00143 
00144     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00145 
00146     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsWriteLogRecordIntoLogPage:  Entered\n"</span>, 0 );
00147     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb                      -&gt; %08lx\n"</span>, Lfcb );
00148     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lch                       -&gt; %08lx\n"</span>, Lch );
00149     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Number of Write Entries   -&gt; %08lx\n"</span>, NumberOfWriteEntries );
00150     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Write Entries             -&gt; %08lx\n"</span>, WriteEntries );
00151     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Record Type               -&gt; %08lx\n"</span>, RecordType );
00152     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Transaction Id            -&gt; %08lx\n"</span>, TransactionId );
00153     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ClientUndoNextLsn (Low)   -&gt; %08lx\n"</span>, ClientUndoNextLsn.LowPart );
00154     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ClientUndoNextLsn (High)  -&gt; %08lx\n"</span>, ClientUndoNextLsn.HighPart );
00155     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ClientPreviousLsn (Low)   -&gt; %08lx\n"</span>, ClientPreviousLsn.LowPart );
00156     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ClientPreviousLsn (High)  -&gt; %08lx\n"</span>, ClientPreviousLsn.HighPart );
00157     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"UndoRequirement           -&gt; %08lx\n"</span>, UndoRequirement );
00158     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"ForceToDisk               -&gt; %04x\n"</span>, ForceToDisk );
00159 
00160     <span class="comment">//</span>
00161     <span class="comment">//  We compute the size of this log record.</span>
00162     <span class="comment">//</span>
00163 
00164     ThisWriteEntry = WriteEntries;
00165 
00166     RemainingLogBytes = 0;
00167 
00168     <span class="keywordflow">while</span> (NumberOfWriteEntries--) {
00169 
00170         RemainingLogBytes += <a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( ThisWriteEntry-&gt;<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o1">ByteLength</a> );
00171 
00172         ThisWriteEntry++;
00173     }
00174 
00175     OriginalLogBytes = RemainingLogBytes;
00176 
00177     ThisWriteEntry = WriteEntries;
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">//  Loop until we have the Lbcb and we know it is not part of</span>
00181     <span class="comment">//  a partial page transfer.  We need to make sure we have</span>
00182     <span class="comment">//  a Bcb for this page.</span>
00183     <span class="comment">//</span>
00184 
00185     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00186 
00187         LogFileFull = <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a1">LfsVerifyLogSpaceAvail</a>( Lfcb,
00188                                               Lch,
00189                                               RemainingLogBytes,
00190                                               UndoRequirement,
00191                                               ForceToDisk );
00192 
00193         <span class="comment">//</span>
00194         <span class="comment">//  We update the Lfcb so that we can start putting the log record into</span>
00195         <span class="comment">//  the top of the Lbcb active list.</span>
00196         <span class="comment">//</span>
00197 
00198         <a class="code" href="../../d7/d5/logrcsup_8c.html#a1">LfsPrepareLfcbForLogRecord</a>( Lfcb,
00199                                     RemainingLogBytes + Lfcb-&gt;RecordHeaderLength );
00200 
00201         ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00202                                       <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00203                                       ActiveLinks );
00204 
00205         <span class="comment">//</span>
00206         <span class="comment">//  If there is a Bcb then we are golden.</span>
00207         <span class="comment">//</span>
00208 
00209         <span class="keywordflow">if</span> (ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <span class="keywordflow">break</span>; }
00210 
00211         <span class="comment">//</span>
00212         <span class="comment">//  Otherwise we want to drop the Lfcb and wait for the IO to complete.</span>
00213         <span class="comment">//</span>
00214 
00215         Lfcb-&gt;Waiters += 1;
00216 
00217         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00218 
00219         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Lfcb-&gt;Sync-&gt;Event,
00220                                Executive,
00221                                KernelMode,
00222                                FALSE,
00223                                NULL );
00224 
00225         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
00226         Lfcb-&gt;Waiters -= 1;
00227     }
00228 
00229     RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize - (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00230 
00231     <span class="comment">//</span>
00232     <span class="comment">//  Compute the Lsn starting in the next log buffer.</span>
00233     <span class="comment">//</span>
00234 
00235     NextLsn.QuadPart = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a10">LfsComputeLsnFromLbcb</a>( Lfcb, ThisLbcb );
00236 
00237     <span class="comment">//</span>
00238     <span class="comment">//  We get a pointer to the log record header and the start of the</span>
00239     <span class="comment">//  log record in the pinned buffer.</span>
00240     <span class="comment">//</span>
00241 
00242     RecordHeader = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>,
00243                             (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>,
00244                             <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> );
00245 
00246     <span class="comment">//</span>
00247     <span class="comment">//  We update the record header.</span>
00248     <span class="comment">//</span>
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">//  Zero out the structure initially.</span>
00252     <span class="comment">//</span>
00253 
00254     RtlZeroMemory( RecordHeader, Lfcb-&gt;RecordHeaderLength );
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">//  Update all the fields.</span>
00258     <span class="comment">//</span>
00259 
00260     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o0">ThisLsn</a> = NextLsn;
00261     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o1">ClientPreviousLsn</a> = ClientPreviousLsn;
00262     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o2">ClientUndoNextLsn</a> = ClientUndoNextLsn;
00263 
00264     <span class="keywordflow">if</span> (TransactionId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00265         RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o6">TransactionId</a> = *TransactionId;
00266     }
00267 
00268     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a> = RemainingLogBytes;
00269     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o4">ClientId</a> = Lch-&gt;ClientId;
00270     RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o5">RecordType</a> = RecordType;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  Check if this is a multi-page record.</span>
00274     <span class="comment">//</span>
00275 
00276     <span class="keywordflow">if</span> (RemainingLogBytes + Lfcb-&gt;RecordHeaderLength &gt; RemainingPageBytes) {
00277 
00278         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o7">Flags</a>, LOG_RECORD_MULTI_PAGE );
00279     }
00280 
00281     RemainingPageBytes -= Lfcb-&gt;RecordHeaderLength;
00282 
00283     <span class="comment">//</span>
00284     <span class="comment">//  Update the buffer position in the Lbcb</span>
00285     <span class="comment">//</span>
00286 
00287     (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a> += Lfcb-&gt;RecordHeaderLength;
00288     HeaderAdjust = Lfcb-&gt;RecordHeaderLength;
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">//  Remember the values in the current write entry.</span>
00292     <span class="comment">//</span>
00293 
00294     CurrentBuffer = ThisWriteEntry-&gt;<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o0">Buffer</a>;
00295     CurrentByteCount = ThisWriteEntry-&gt;<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o1">ByteLength</a>;
00296 
00297     PadBytes = (8 - (CurrentByteCount &amp; ~(0xfffffff8))) &amp; ~(0xfffffff8);
00298 
00299     <span class="comment">//</span>
00300     <span class="comment">//  Continue to transfer bytes until all the client's data has</span>
00301     <span class="comment">//  been transferred.</span>
00302     <span class="comment">//</span>
00303 
00304     <span class="keywordflow">while</span> (RemainingLogBytes != 0) {
00305 
00306         <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> PageHeader;
00307 
00308         PageHeader = (<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>;
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">//  If the Lbcb is empty and we are about to store data into it we</span>
00312         <span class="comment">//  subtract the data size of the page from the available space.</span>
00313         <span class="comment">//  Update all the information we want to put in the header.</span>
00314         <span class="comment">//</span>
00315 
00316         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY )) {
00317 
00318             <span class="comment">//</span>
00319             <span class="comment">//  We subtract this page from the available pages only if</span>
00320             <span class="comment">//  we are at the beginning of the page.  Otherwise this</span>
00321             <span class="comment">//  could be a reuse page.  In that case it has already</span>
00322             <span class="comment">//  been subtracted.</span>
00323             <span class="comment">//</span>
00324 
00325             <span class="keywordflow">if</span> ((ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a> - HeaderAdjust == (ULONG)Lfcb-&gt;LogPageDataOffset) {
00326 
00327 
00328                 Lfcb-&gt;CurrentAvailable = Lfcb-&gt;CurrentAvailable - Lfcb-&gt;ReservedLogPageSize;                           <span class="comment">//**** xxSub( Lfcb-&gt;CurrentAvailable, Lfcb-&gt;ReservedLogPageSize );</span>
00329             }
00330 
00331             InsertTailList( &amp;Lfcb-&gt;LbcbWorkque, &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
00332             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY );
00333         }
00334 
00335         HeaderAdjust = 0;
00336 
00337         <span class="comment">//</span>
00338         <span class="comment">//  Compute the number of transfer bytes.  Update the remaining</span>
00339         <span class="comment">//  page bytes, remaining log bytes and position in the write</span>
00340         <span class="comment">//  buffer array.  This routine also copies the bytes into the buffer.</span>
00341         <span class="comment">//</span>
00342 
00343         <a class="code" href="../../d7/d5/logrcsup_8c.html#a2">LfsTransferLogBytes</a>( ThisLbcb,
00344                              &amp;ThisWriteEntry,
00345                              &amp;CurrentBuffer,
00346                              &amp;CurrentByteCount,
00347                              &amp;PadBytes,
00348                              &amp;RemainingPageBytes,
00349                              &amp;RemainingLogBytes );
00350 
00351         <span class="comment">//</span>
00352         <span class="comment">//  This log record ends on this page.  Update the fields for the</span>
00353         <span class="comment">//  ending Lsn.</span>
00354         <span class="comment">//</span>
00355 
00356         <span class="keywordflow">if</span> (RemainingLogBytes == 0) {
00357 
00358             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a>, LOG_PAGE_LOG_RECORD_END );
00359             ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o11">LastEndLsn</a> = NextLsn;
00360 
00361             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )) {
00362 
00363                 PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.LastEndLsn = NextLsn;
00364                 PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o9">Header</a>.Packed.NextRecordOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00365             }
00366         }
00367 
00368         <span class="comment">//</span>
00369         <span class="comment">//  We are done with this page, update the fields in the page header.</span>
00370         <span class="comment">//</span>
00371 
00372         <span class="keywordflow">if</span> (RemainingPageBytes == 0
00373             || RemainingLogBytes == 0) {
00374 
00375             <span class="comment">//</span>
00376             <span class="comment">//  We are done with this page.  Update the Lbcb and page header.</span>
00377             <span class="comment">//</span>
00378 
00379             ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o10">LastLsn</a> = NextLsn;
00380             PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.LastLsn = NextLsn;
00381             PageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o4">Flags</a> = ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a>;
00382 
00383             <span class="comment">//</span>
00384             <span class="comment">//  We can't put any more log records on this page.  Remove</span>
00385             <span class="comment">//  it from the active queue.</span>
00386             <span class="comment">//</span>
00387 
00388             <span class="keywordflow">if</span> (RemainingPageBytes &lt; Lfcb-&gt;RecordHeaderLength) {
00389 
00390                 RemoveHeadList( &amp;Lfcb-&gt;LbcbActive );
00391                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE );
00392 
00393                 <span class="comment">//</span>
00394                 <span class="comment">//  If there are more log bytes then get the next Lbcb.</span>
00395                 <span class="comment">//</span>
00396 
00397                 <span class="keywordflow">if</span> (RemainingLogBytes != 0) {
00398 
00399                     ThisLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00400                                                   <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00401                                                   ActiveLinks );
00402 
00403                     RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize
00404                                          - (ULONG)ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a>;
00405                 }
00406             }
00407         }
00408     }
00409 
00410     *Lsn = NextLsn;
00411 
00412     Lfcb-&gt;RestartArea-&gt;CurrentLsn = NextLsn;
00413 
00414     Lfcb-&gt;RestartArea-&gt;LastLsnDataLength = OriginalLogBytes;
00415 
00416     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, LFCB_NO_LAST_LSN );
00417 
00418     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)   -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00419     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)  -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00420     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsWriteLogRecordIntoLogPage:  Exit\n"</span>, 0 );
00421 
00422     <span class="keywordflow">return</span> LogFileFull;
00423 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
