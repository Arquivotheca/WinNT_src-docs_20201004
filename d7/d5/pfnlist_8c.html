<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pfnlist.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pfnlist.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d8/d4/pfnlist_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a0">MM_LOW_LIMIT</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a1">MM_HIGH_LIMIT</a>&nbsp;&nbsp;&nbsp;19</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a2">MI_TALLY_TRANSITION_PAGE_ADDITION</a>(Pfn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a3">MI_TALLY_TRANSITION_PAGE_REMOVAL</a>(Pfn)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (IN PFN_NUMBER Page, IN ULONG PageColor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (IN <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead, IN PFN_NUMBER PageFrameIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a9">MiInsertStandbyListAtFront</a> (IN PFN_NUMBER PageFrameIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a> (IN <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a12">MiUnlinkFreeOrZeroedPage</a> (IN PFN_NUMBER Page)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (IN ULONG PageColor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (IN ULONG PageColor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a16">MiInsertFrontModifiedNoWrite</a> (IN PFN_NUMBER PageFrameIndex)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a4">MmAvailablePagesEventHigh</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a5">MmTransitionPrivatePages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d5/pfnlist_8c.html#a6">MmTransitionSharedPages</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="pfnlist.c::MI_TALLY_TRANSITION_PAGE_ADDITION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MI_TALLY_TRANSITION_PAGE_ADDITION          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Pfn&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (Pfn-&gt;u3.e1.PrototypePte) { \
        <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a> += 1; \
    } \
    <span class="keywordflow">else</span> { \
        <a class="code" href="../../d7/d5/pfnlist_8c.html#a5">MmTransitionPrivatePages</a> += 1; \
    } \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTransitionPrivatePages + MmTransitionSharedPages == <a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> + <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> + <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>);
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00032">32</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01683">MiInsertFrontModifiedNoWrite()</a>, and <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="pfnlist.c::MI_TALLY_TRANSITION_PAGE_REMOVAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MI_TALLY_TRANSITION_PAGE_REMOVAL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Pfn&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (Pfn-&gt;u3.e1.PrototypePte) { \
        <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a> -= 1; \
    } \
    <span class="keywordflow">else</span> { \
        <a class="code" href="../../d7/d5/pfnlist_8c.html#a5">MmTransitionPrivatePages</a> -= 1; \
    } \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTransitionPrivatePages + MmTransitionSharedPages == <a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> + <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> + <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>);
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00041">41</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00521">MiRemovePageFromList()</a>, and <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="pfnlist.c::MM_HIGH_LIMIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_HIGH_LIMIT&nbsp;&nbsp;&nbsp;19          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00025">25</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, and <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00388">MiInsertStandbyListAtFront()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="pfnlist.c::MM_LOW_LIMIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_LOW_LIMIT&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00024">24</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, and <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00388">MiInsertStandbyListAtFront()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a13" doxytag="pfnlist.c::MiEnsureAvailablePageOrWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiEnsureAvailablePageOrWait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">941</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00034">FASTCALL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05179">HYDRA_PROCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00133">KdDebuggerNotPresent</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01120">LOCK_WS_REGARDLESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02642">MI_IS_HYPER_SPACE_ADDRESS</a>, <a class="el" href="../../d3/d8/miia64_8h-source.html#l02947">MI_IS_SYSTEM_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00025">MM_HIGH_LIMIT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00024">MM_LOW_LIMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00098">MmAllocatedNonPagedPool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04581">MmAvailablePagesEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04583">MmAvailablePagesEventHigh</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00062">MmMaximumNonPagedPoolInBytes</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00211">MmSevenMinutes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00996">MmSystemLockOwner</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00123">MmTotalPagesForPagingFile</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01109">UNLOCK_WS_REGARDLESS</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a206">WrFreePage</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l02133">MiDoneWithThisPageGetAnother()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03484">MiFillSystemPageDirectory()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04378">MiGetPageForHeader()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04222">MiInitializeSessionPool()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01481">MiInitializeWorkingSetList()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00674">MiResolveDemandZeroFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01989">MiResolveMappedFileFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01272">MiResolvePageFileFault()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02144">MiSessionCommitImagePages()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04446">MiSessionCopyOnWrite()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03942">MmAllocateIndependentPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">MmCreateProcessAddressSpace()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l02921">MmGrowKernelStack()</a>.
<p>
<pre class="fragment"><div>00948                    :
00949 
00950     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> ensures that a physical page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available on
00951     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zeroed, free or standby list such that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove a
00952     page absolutely will not block.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary as blocking would
00953     require a wait which could cause a deadlock condition.
00954 
00955     If a page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function returns immediately with a value
00956     of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicating no wait operation was performed.  If no physical
00957     page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread enters a wait state and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
00958     returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait operation completes.
00959 
00960 Arguments:
00961 
00962     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process <span class="keywordflow">if</span>, and <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span>,
00963               <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held currently held and should
00964               be released <span class="keywordflow">if</span> a wait operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> issued.  Supplies
00965               <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> otherwise.
00966 
00967     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> faulting page.
00968                      If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> treated as a
00969                      user mode address.
00970 
00971 Return Value:
00972 
00973     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> a page was immediately available.
00974     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> a wait operation occurred before a page became available.
00975 
00976 
00977 Environment:
00978 
00979     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
00980 
00981 --*/
00982 
00983 {
00984     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00985     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00986     KIRQL OldIrql;
00987     KIRQL Ignore;
00988     ULONG Limit;
00989     ULONG Relock;
00990     PFN_NUMBER StrandedPages;
00991     LOGICAL WsHeldSafe;
00992     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00993     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> EndPfn;
00994     LARGE_INTEGER WaitBegin;
00995     LARGE_INTEGER WaitEnd;
00996 
00997     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00998 
00999     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt;= <a class="code" href="../../d7/d5/pfnlist_8c.html#a1">MM_HIGH_LIMIT</a>) {
01000 
01001         <span class="comment">//</span>
01002         <span class="comment">// Pages are available.</span>
01003         <span class="comment">//</span>
01004 
01005         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01006     }
01007 
01008     <span class="comment">//</span>
01009     <span class="comment">// If this fault is for paged pool (or pagable kernel space,</span>
01010     <span class="comment">// including page table pages), let it use the last page.</span>
01011     <span class="comment">//</span>
01012 
01013 <span class="preprocessor">#if defined(_IA64_)</span>
01014 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/miia64_8h.html#a220">MI_IS_SYSTEM_ADDRESS</a>(VirtualAddress) ||
01015         (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a193">MI_IS_HYPER_SPACE_ADDRESS</a>(VirtualAddress))) {
01016 <span class="preprocessor">#else</span>
01017 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)VirtualAddress &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(HYPER_SPACE)) ||
01018         ((VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS) &amp;&amp;
01019          (VirtualAddress &lt; (PVOID)PTE_BASE))) {
01020 <span class="preprocessor">#endif</span>
01021 <span class="preprocessor"></span>
01022         <span class="comment">//</span>
01023         <span class="comment">// This fault is in the system, use 1 page as the limit.</span>
01024         <span class="comment">//</span>
01025 
01026         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt;= <a class="code" href="../../d7/d5/pfnlist_8c.html#a0">MM_LOW_LIMIT</a>) {
01027 
01028             <span class="comment">//</span>
01029             <span class="comment">// Pages are available.</span>
01030             <span class="comment">//</span>
01031 
01032             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01033         }
01034 
01035         Limit = <a class="code" href="../../d7/d5/pfnlist_8c.html#a0">MM_LOW_LIMIT</a>;
01036         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a609">MmAvailablePagesEvent</a>;
01037     } <span class="keywordflow">else</span> {
01038         Limit = <a class="code" href="../../d7/d5/pfnlist_8c.html#a1">MM_HIGH_LIMIT</a>;
01039         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a610">MmAvailablePagesEventHigh</a>;
01040     }
01041 
01042     <span class="keywordflow">while</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; Limit) {
01043         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> ((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)Event);
01044 
01045         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (APC_LEVEL);
01046 
01047         <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
01048             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (APC_LEVEL);
01049         }
01050         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01051 
01052             <span class="comment">//</span>
01053             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
01054             <span class="comment">// by our caller.  Handle both cases here and below.</span>
01055             <span class="comment">//</span>
01056 
01057             <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a> (Process, WsHeldSafe);
01058         }
01059         <span class="keywordflow">else</span> {
01060             Relock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01061             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
01062                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (APC_LEVEL);
01063                 Relock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01064             }
01065         }
01066 
01067         KiQueryInterruptTime(&amp;WaitBegin);
01068 
01069         <span class="comment">//</span>
01070         <span class="comment">// Wait 7 minutes for pages to become available.</span>
01071         <span class="comment">//</span>
01072 
01073         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(Event,
01074                                        WrFreePage,
01075                                        KernelMode,
01076                                        FALSE,
01077                                        (PLARGE_INTEGER)&amp;MmSevenMinutes);
01078 
01079         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
01080 
01081             KiQueryInterruptTime(&amp;WaitEnd);
01082 
01083             <span class="comment">//</span>
01084             <span class="comment">// See how many transition pages have nonzero reference counts as</span>
01085             <span class="comment">// these indicate drivers that aren't unlocking the pages in their</span>
01086             <span class="comment">// MDLs.</span>
01087             <span class="comment">//</span>
01088 
01089             Limit = 0;
01090             StrandedPages = 0;
01091 
01092             <span class="keywordflow">do</span> {
01093         
01094                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[Limit].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>);
01095                 EndPfn = Pfn1 + <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[Limit].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
01096 
01097                 <span class="keywordflow">while</span> (Pfn1 &lt; EndPfn) {
01098                     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>) &amp;&amp;
01099                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0)) {
01100                             StrandedPages += 1;
01101                     }
01102                     Pfn1 += 1;
01103                 }
01104                 Limit += 1;
01105         
01106             } <span class="keywordflow">while</span> (Limit != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
01107 
01108             <span class="comment">//</span>
01109             <span class="comment">// This bugcheck can occur for the following reasons:</span>
01110             <span class="comment">//</span>
01111             <span class="comment">// A driver has blocked, deadlocking the modified or mapped</span>
01112             <span class="comment">// page writers.  Examples of this include mutex deadlocks or</span>
01113             <span class="comment">// accesses to paged out memory in filesystem drivers, filter</span>
01114             <span class="comment">// drivers, etc.  This indicates a driver bug.</span>
01115             <span class="comment">//</span>
01116             <span class="comment">// The storage driver(s) are not processing requests.  Examples</span>
01117             <span class="comment">// of this are stranded queues, non-responding drives, etc.  This</span>
01118             <span class="comment">// indicates a driver bug.</span>
01119             <span class="comment">//</span>
01120             <span class="comment">// Not enough pool is available for the storage stack to write out</span>
01121             <span class="comment">// modified pages.  This indicates a driver bug.</span>
01122             <span class="comment">//</span>
01123             <span class="comment">// A high priority realtime thread has starved the balance set</span>
01124             <span class="comment">// manager from trimming pages and/or starved the modified writer</span>
01125             <span class="comment">// from writing them out.  This indicates a bug in the component</span>
01126             <span class="comment">// that created this thread.</span>
01127             <span class="comment">//</span>
01128             <span class="comment">// All the processes have been trimmed to their minimums and all</span>
01129             <span class="comment">// modified pages written, but still no memory is available.  The</span>
01130             <span class="comment">// freed memory must be stuck in transition pages with non-zero</span>
01131             <span class="comment">// reference counts - thus they cannot be put on the freelist.</span>
01132             <span class="comment">// A driver is neglecting to unlock the pages preventing the</span>
01133             <span class="comment">// reference counts from going to zero which would free the pages.</span>
01134             <span class="comment">// This may be due to transfers that never finish and the driver</span>
01135             <span class="comment">// never aborts or other driver bugs.</span>
01136             <span class="comment">//</span>
01137 
01138             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (NO_PAGES_AVAILABLE,
01139                           <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>,
01140                           MmTotalPagesForPagingFile,
01141                           (MmMaximumNonPagedPoolInBytes &gt;&gt; PAGE_SHIFT) - MmAllocatedNonPagedPool,
01142                           StrandedPages);
01143 
01144             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a>) {
01145                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MmEnsureAvailablePageOrWait: 7 min timeout %x %x %x %x\n"</span>, WaitEnd.HighPart, WaitEnd.LowPart, WaitBegin.HighPart, WaitBegin.LowPart);
01146                 DbgBreakPoint ();
01147             }
01148         }
01149 
01150         <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
01151             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (Ignore);
01152         }
01153         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01154 
01155             <span class="comment">//</span>
01156             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
01157             <span class="comment">// by our caller.  Reacquire it in the same manner our caller did.</span>
01158             <span class="comment">//</span>
01159 
01160             <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a> (Process, WsHeldSafe);
01161         }
01162         <span class="keywordflow">else</span> {
01163             <span class="keywordflow">if</span> (Relock) {
01164                 <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (Ignore);
01165             }
01166         }
01167 
01168         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01169     }
01170 
01171     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01172 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="pfnlist.c::MiInsertFrontModifiedNoWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiInsertFrontModifiedNoWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageFrameIndex</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01683">1683</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01082">_MMPFNLIST::Blink</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00032">MI_TALLY_TRANSITION_PAGE_ADDITION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00043">MmLowestPhysicalPage</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00084">MmModifiedNoWritePageListHead</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>.
<p>
<pre class="fragment"><div>01689                    :
01690 
01691     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> inserts a page at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FRONT of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified no
01692     write list.
01693 
01694 Arguments:
01695 
01696     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number to insert in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01697                      list.
01698 
01699 Return Value:
01700 
01701     none.
01702 
01703 Environment:
01704 
01705     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
01706 
01707 --*/
01708 
01709 {
01710     PFN_NUMBER first;
01711     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01712     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01713 
01714     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01715     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex != 0) &amp;&amp; (PageFrameIndex &lt;= MmHighestPhysicalPage) &amp;&amp;
01716         (PageFrameIndex &gt;= MmLowestPhysicalPage));
01717 
01718     <span class="comment">//</span>
01719     <span class="comment">// Check to ensure the reference count for the page</span>
01720     <span class="comment">// is zero.</span>
01721     <span class="comment">//</span>
01722 
01723     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01724 
01725     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01726 
01727     <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> += 1;  <span class="comment">// One more page on the list.</span>
01728 
01729     <a class="code" href="../../d7/d5/pfnlist_8c.html#a2">MI_TALLY_TRANSITION_PAGE_ADDITION</a> (Pfn1);
01730 
01731     first = <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01732     <span class="keywordflow">if</span> (first == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01733 
01734         <span class="comment">//</span>
01735         <span class="comment">// List is empty add the page to the ListHead.</span>
01736         <span class="comment">//</span>
01737 
01738         <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = PageFrameIndex;
01739     } <span class="keywordflow">else</span> {
01740         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (first);
01741         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = PageFrameIndex;
01742     }
01743 
01744     <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = PageFrameIndex;
01745     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = first;
01746     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01747     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>;
01748     <span class="keywordflow">return</span>;
01749 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pfnlist.c::MiInsertPageInList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiInsertPageInList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ListHead</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFrameIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">59</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01893">_MMCOLOR_TABLES::Blink</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00285">KeSetTimerEx()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02799">MI_BARRIER_STAMP_ZEROED_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01167">MI_GET_COLOR_FROM_SECONDARY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01165">MI_GET_SECONDARY_COLOR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00032">MI_TALLY_TRANSITION_PAGE_ADDITION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00767">MiGetByteOffset</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05134">MiModifiedPageLife</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05142">MiModifiedPageWriterTimer</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05140">MiModifiedPageWriterTimerDpc</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01245">MiRestoreTransitionPte()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05136">MiTimerPending</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00188">MM_DBG_PAGE_REF_COUNT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00025">MM_HIGH_LIMIT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00024">MM_LOW_LIMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04581">MmAvailablePagesEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04583">MmAvailablePagesEventHigh</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00081">MmFreePageListHead</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00043">MmLowestPhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04604">MmMinimumFreePagesToZero</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00114">MmModifiedPageListByColor</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05122">MmModifiedPageMaximum</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05096">MmModifiedPageWriterEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00123">MmTotalPagesForPagingFile</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00080">MmZeroedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04589">MmZeroingPageEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04598">MmZeroingPageThreadActive</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02188">PERFINFO_INSERTINLIST</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01745">MiDecrementCloneBlockReference()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02664">MiFreeInitializationCode()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00541">MiPurgeImageSection()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01109">MiRemovePhysicalPages()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l01953">MiResetVirtualMemory()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00868">MiResolveTransitionFault()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00191">MiSegmentDelete()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">MmAddPhysicalMemory()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01398">MmDeleteProcessAddressSpace()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02005">MmFreeLoaderBlock()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">MmPurgeSection()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, and <a class="el" href="../../d8/d0/zeropage_8c-source.html#l00029">MmZeroPageThread()</a>.
<p>
<pre class="fragment"><div>00066                    :
00067 
00068     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> inserts a page at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified list (free,
00069     standby, bad, zeroed, modified).
00070 
00071 
00072 Arguments:
00073 
00074     ListHead - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list in which to insert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00075                specified physical page.
00076 
00077     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number to insert in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00078                      list.
00079 
00080 Return Value:
00081 
00082     none.
00083 
00084 Environment:
00085 
00086     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
00087 
00088 --*/
00089 
00090 {
00091     PFN_NUMBER last;
00092     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00093     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00094     ULONG Color;
00095 
00096     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00097     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex != 0) &amp;&amp;
00098             (PageFrameIndex &lt;= MmHighestPhysicalPage) &amp;&amp;
00099             (PageFrameIndex &gt;= MmLowestPhysicalPage));
00100 
00101     <span class="comment">//</span>
00102     <span class="comment">// Check to ensure the reference count for the page is zero.</span>
00103     <span class="comment">//</span>
00104 
00105     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
00106 
00107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LockCharged == 0);
00108 
00109     <a class="code" href="../../d2/d1/mm_8h.html#a67">PERFINFO_INSERTINLIST</a>(PageFrameIndex, ListHead);
00110 
00111 <span class="preprocessor">#if DBG</span>
00112 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a80">MM_DBG_PAGE_REF_COUNT</a>) {
00113 
00114         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00115         KIRQL OldIrql = 99;
00116 
00117         <span class="keywordflow">if</span> ((ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) ||
00118             (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>)) {
00119 
00120             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1)  &amp;&amp;
00121                     (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>))) {
00122                 PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
00123             } <span class="keywordflow">else</span> {
00124 
00125                 <span class="comment">//</span>
00126                 <span class="comment">// The page containing the prototype PTE is not valid,</span>
00127                 <span class="comment">// map the page into hyperspace and reference it that way.</span>
00128                 <span class="comment">//</span>
00129 
00130                 PointerPte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>, &amp;OldIrql);
00131                 PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
00132                                         <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
00133             }
00134 
00135             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE (PointerPte) == PageFrameIndex) ||
00136                     (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte) == PageFrameIndex));
00137             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Transition == 1);
00138             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Prototype == 0);
00139             <span class="keywordflow">if</span> (OldIrql != 99) {
00140                 <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql)
00141             }
00142         }
00143     }
00144 <span class="preprocessor">#endif</span>
00145 <span class="preprocessor"></span>
00146 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00147 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ListHead == &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>) {
00148         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 0) {
00149             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00150                           0x91,
00151                           PageFrameIndex,
00152                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
00153                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount);
00154         }
00155     }
00156     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ListHead == &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>) {
00157         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 0) {
00158             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00159                           0x92,
00160                           PageFrameIndex,
00161                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
00162                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount);
00163         }
00164     }
00165 <span class="preprocessor">#endif</span>
00166 <span class="preprocessor"></span>
00167 <span class="preprocessor">#if DBG</span>
00168 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) ||
00169         (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>)) {
00170         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00171            (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
00172             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT, 0x8888, 0,0,0);
00173         }
00174     }
00175 <span class="preprocessor">#endif</span>
00176 <span class="preprocessor"></span>
00177     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00178 
00179     ListHead-&gt;Total += 1;  <span class="comment">// One more page on the list.</span>
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// On MIPS R4000 modified pages destined for the paging file are</span>
00183     <span class="comment">// kept on separate lists which group pages of the same color</span>
00184     <span class="comment">// together</span>
00185     <span class="comment">//</span>
00186 
00187     <span class="keywordflow">if</span> (ListHead == &amp;<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>) {
00188 
00189 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00190 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 0) {
00191             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00192                           0x90,
00193                           PageFrameIndex,
00194                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
00195                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount);
00196         }
00197 <span class="preprocessor">#endif</span>
00198 <span class="preprocessor"></span>
00199         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
00200 
00201             <span class="comment">//</span>
00202             <span class="comment">// This page is destined for the paging file (not</span>
00203             <span class="comment">// a mapped file).  Change the list head to the</span>
00204             <span class="comment">// appropriate colored list head.</span>
00205             <span class="comment">//</span>
00206 
00207             ListHead = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a21">MmModifiedPageListByColor</a> [Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor];
00208             ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> += 1;
00209             <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> += 1;
00210         }
00211         <span class="keywordflow">else</span> {
00212 
00213             <span class="comment">//</span>
00214             <span class="comment">// This page is destined for a mapped file (not</span>
00215             <span class="comment">// the paging file).  If there are no other pages currently</span>
00216             <span class="comment">// destined for the mapped file, start our timer so that we can</span>
00217             <span class="comment">// ensure that these pages make it to disk even if we don't pile</span>
00218             <span class="comment">// up enough of them to trigger the modified page writer or need</span>
00219             <span class="comment">// the memory.  If we don't do this here, then for this scenario,</span>
00220             <span class="comment">// only an orderly system shutdown will write them out (days,</span>
00221             <span class="comment">// weeks, months or years later) and any power out in between</span>
00222             <span class="comment">// means we'll have lost the data.</span>
00223             <span class="comment">//</span>
00224 
00225             <span class="keywordflow">if</span> (ListHead-&gt;Total - <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> == 1) {
00226 
00227                 <span class="comment">//</span>
00228                 <span class="comment">// Start the DPC timer because we're the first on the list.</span>
00229                 <span class="comment">//</span>
00230 
00231                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00232                     <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00233 
00234                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>( &amp;MiModifiedPageWriterTimer, MiModifiedPageLife, 0, &amp;MiModifiedPageWriterTimerDpc );
00235                 }
00236             }
00237         }
00238     }
00239     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1) &amp;&amp;
00240              (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>)) {
00241 
00242         ListHead-&gt;Total -= 1;  <span class="comment">// Undo previous increment</span>
00243 
00244         <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00245             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00246             <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (PageFrameIndex);
00247         }
00248 
00249         ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>];
00250         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> += 1;  <span class="comment">// One more page on the list.</span>
00251     }
00252 
00253 
00254     last = ListHead-&gt;Blink;
00255     <span class="keywordflow">if</span> (last == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">// List is empty add the page to the ListHead.</span>
00259         <span class="comment">//</span>
00260 
00261         ListHead-&gt;Flink = PageFrameIndex;
00262     } <span class="keywordflow">else</span> {
00263         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (last);
00264         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = PageFrameIndex;
00265     }
00266 
00267     ListHead-&gt;Blink = PageFrameIndex;
00268     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00269     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = last;
00270     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = ListHead-&gt;ListName;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">// If the page was placed on the free, standby or zeroed list,</span>
00274     <span class="comment">// update the count of usable pages in the system.  If the count</span>
00275     <span class="comment">// transitions from 0 to 1, the event associated with available</span>
00276     <span class="comment">// pages should become true.</span>
00277     <span class="comment">//</span>
00278 
00279     <span class="keywordflow">if</span> (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00280         <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> += 1;
00281 
00282         <span class="comment">//</span>
00283         <span class="comment">// A page has just become available, check to see if the</span>
00284         <span class="comment">// page wait events should be signalled.</span>
00285         <span class="comment">//</span>
00286 
00287         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == <a class="code" href="../../d7/d5/pfnlist_8c.html#a0">MM_LOW_LIMIT</a>) {
00288             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmAvailablePagesEvent, 0, FALSE);
00289         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == <a class="code" href="../../d7/d5/pfnlist_8c.html#a1">MM_HIGH_LIMIT</a>) {
00290             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmAvailablePagesEventHigh, 0, FALSE);
00291         }
00292 
00293         <span class="keywordflow">if</span> (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>) {
00294 
00295             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError == 0);
00296 
00297             <span class="comment">//</span>
00298             <span class="comment">// We are adding a page to the free or zeroed page list.</span>
00299             <span class="comment">// Add the page to the end of the correct colored page list.</span>
00300             <span class="comment">//</span>
00301 
00302             Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (PageFrameIndex, Pfn1);
00303             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(Color));
00304 
00305             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> ==
00306                                                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00307 
00308                 <span class="comment">//</span>
00309                 <span class="comment">// This list is empty, add this as the first and last</span>
00310                 <span class="comment">// entry.</span>
00311                 <span class="comment">//</span>
00312 
00313                 <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> =
00314                                                                 PageFrameIndex;
00315                 <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> =
00316                                                                 (PVOID)Pfn1;
00317             } <span class="keywordflow">else</span> {
00318                 Pfn2 = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a>;
00319                 Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = PageFrameIndex;
00320                 <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> = (PVOID)Pfn1;
00321             }
00322             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00323 
00324             <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>) {
00325                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a198">MI_BARRIER_STAMP_ZEROED_PAGE</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00326             }
00327         }
00328         <span class="keywordflow">else</span> {
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">// Transition page list so tally it appropriately.</span>
00332             <span class="comment">//</span>
00333 
00334             <a class="code" href="../../d7/d5/pfnlist_8c.html#a2">MI_TALLY_TRANSITION_PAGE_ADDITION</a> (Pfn1);
00335         }
00336 
00337         <span class="keywordflow">if</span> ((ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>) &amp;&amp;
00338             (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a613">MmMinimumFreePagesToZero</a>) &amp;&amp;
00339             (<a class="code" href="../../d4/d8/mi_8h.html#a612">MmZeroingPageThreadActive</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00340 
00341             <span class="comment">//</span>
00342             <span class="comment">// There are enough pages on the free list, start</span>
00343             <span class="comment">// the zeroing page thread.</span>
00344             <span class="comment">//</span>
00345 
00346             <a class="code" href="../../d4/d8/mi_8h.html#a612">MmZeroingPageThreadActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00347             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmZeroingPageEvent, 0, FALSE);
00348         }
00349         <span class="keywordflow">return</span>;
00350     }
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">// Check to see if there are too many modified pages.</span>
00354     <span class="comment">//</span>
00355 
00356     <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>) {
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// Transition page list so tally it appropriately.</span>
00360         <span class="comment">//</span>
00361 
00362         <a class="code" href="../../d7/d5/pfnlist_8c.html#a2">MI_TALLY_TRANSITION_PAGE_ADDITION</a> (Pfn1);
00363 
00364         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
00365             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == 0);
00366         }
00367 
00368         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ModifiedPageCount += 1;
00369         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> ) {
00370 
00371             <span class="comment">//</span>
00372             <span class="comment">// Start the modified page writer.</span>
00373             <span class="comment">//</span>
00374 
00375             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmModifiedPageWriterEvent, 0, FALSE);
00376         }
00377     }
00378     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>) {
00379         <a class="code" href="../../d7/d5/pfnlist_8c.html#a2">MI_TALLY_TRANSITION_PAGE_ADDITION</a> (Pfn1);
00380     }
00381 
00382     <span class="keywordflow">return</span>;
00383 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="pfnlist.c::MiInsertStandbyListAtFront" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiInsertStandbyListAtFront           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageFrameIndex</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00388">388</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00767">MiGetByteOffset</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00188">MM_DBG_PAGE_REF_COUNT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00025">MM_HIGH_LIMIT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00024">MM_LOW_LIMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04581">MmAvailablePagesEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04583">MmAvailablePagesEventHigh</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00043">MmLowestPhysicalPage</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00084">MmModifiedNoWritePageListHead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00082">MmStandbyPageListHead</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00029">MmTransitionPrivatePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00065">MmTransitionSharedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02189">PERFINFO_INSERT_FRONT_STANDBY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>.
<p>
<pre class="fragment"><div>00394                    :
00395 
00396     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> inserts a page at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> front of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standby list.
00397 
00398 Arguments:
00399 
00400     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number to insert in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00401                      list.
00402 
00403 Return Value:
00404 
00405     none.
00406 
00407 Environment:
00408 
00409     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
00410 
00411 --*/
00412 
00413 {
00414     PFN_NUMBER first;
00415     IN <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
00416     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00417     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00418 
00419     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00420     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex != 0) &amp;&amp; (PageFrameIndex &lt;= MmHighestPhysicalPage) &amp;&amp;
00421         (PageFrameIndex &gt;= MmLowestPhysicalPage));
00422 
00423     <span class="comment">//</span>
00424     <span class="comment">// Check to ensure the reference count for the page</span>
00425     <span class="comment">// is zero.</span>
00426     <span class="comment">//</span>
00427 
00428     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
00429 
00430     <a class="code" href="../../d2/d1/mm_8h.html#a68">PERFINFO_INSERT_FRONT_STANDBY</a>(PageFrameIndex);
00431 
00432 <span class="preprocessor">#if DBG</span>
00433 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a80">MM_DBG_PAGE_REF_COUNT</a>) {
00434 
00435         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00436         KIRQL OldIrql = 99;
00437 
00438         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1)  &amp;&amp;
00439                 (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>))) {
00440             PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
00441         } <span class="keywordflow">else</span> {
00442 
00443             <span class="comment">//</span>
00444             <span class="comment">// The page containing the prototype PTE is not valid,</span>
00445             <span class="comment">// map the page into hyperspace and reference it that way.</span>
00446             <span class="comment">//</span>
00447 
00448             PointerPte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>, &amp;OldIrql);
00449             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
00450                                     <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
00451         }
00452 
00453         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE (PointerPte) == PageFrameIndex) ||
00454                 (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte) == PageFrameIndex));
00455         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Transition == 1);
00456         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Prototype == 0);
00457         <span class="keywordflow">if</span> (OldIrql != 99) {
00458             <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql)
00459         }
00460     }
00461 
00462     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00463        (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
00464         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT, 0x8889, 0,0,0);
00465     }
00466 <span class="preprocessor">#endif</span>
00467 <span class="preprocessor"></span>
00468     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00469     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1);
00470     <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a> += 1;
00471 
00472     <a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> += 1;  <span class="comment">// One more page on the list.</span>
00473 
00474     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTransitionPrivatePages + MmTransitionSharedPages == <a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> + <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> + <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>);
00475 
00476     ListHead = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>;
00477 
00478     first = ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
00479     <span class="keywordflow">if</span> (first == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00480 
00481         <span class="comment">//</span>
00482         <span class="comment">// List is empty add the page to the ListHead.</span>
00483         <span class="comment">//</span>
00484 
00485         ListHead-&gt;Blink = PageFrameIndex;
00486     } <span class="keywordflow">else</span> {
00487         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (first);
00488         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = PageFrameIndex;
00489     }
00490 
00491     ListHead-&gt;Flink = PageFrameIndex;
00492     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00493     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = first;
00494     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// If the page was placed on the free, standby or zeroed list,</span>
00498     <span class="comment">// update the count of usable pages in the system.  If the count</span>
00499     <span class="comment">// transitions from 0 to 1, the event associated with available</span>
00500     <span class="comment">// pages should become true.</span>
00501     <span class="comment">//</span>
00502 
00503     <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> += 1;
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// A page has just become available, check to see if the</span>
00507     <span class="comment">// page wait events should be signalled.</span>
00508     <span class="comment">//</span>
00509 
00510     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == <a class="code" href="../../d7/d5/pfnlist_8c.html#a0">MM_LOW_LIMIT</a>) {
00511         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmAvailablePagesEvent, 0, FALSE);
00512     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == <a class="code" href="../../d7/d5/pfnlist_8c.html#a1">MM_HIGH_LIMIT</a>) {
00513         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmAvailablePagesEventHigh, 0, FALSE);
00514     }
00515 
00516     <span class="keywordflow">return</span>;
00517 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="pfnlist.c::MiRemoveAnyPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER FASTCALL MiRemoveAnyPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageColor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">1395</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00964">MI_CHECK_PAGE_ALIGNMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01165">MI_GET_SECONDARY_COLOR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01219">MI_MAGIC_AWE_PTEFRAME</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01567">MiRemovePageByColor()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00521">MiRemovePageFromList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00315">MM_COLOR_MASK</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00081">MmFreePageListHead</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00082">MmStandbyPageListHead</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00080">MmZeroedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00413">ExAllocatePool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03472">MiAllocateSpecialPool()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02184">MiBuildPagedPool()</a>, <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03484">MiFillSystemPageDirectory()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04378">MiGetPageForHeader()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04222">MiInitializeSessionPool()</a>, <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00674">MiResolveDemandZeroFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01989">MiResolveMappedFileFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01272">MiResolvePageFileFault()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02144">MiSessionCommitImagePages()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04446">MiSessionCopyOnWrite()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03942">MmAllocateIndependentPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">MmCreateProcessAddressSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07930">MmGatherMemoryForHibernate()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02921">MmGrowKernelStack()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, and <a class="el" href="../../d8/d0/zeropage_8c-source.html#l00029">MmZeroPageThread()</a>.
<p>
<pre class="fragment"><div>01401                    :
01402 
01403     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> removes a page from either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free, zeroed,
01404     or standby lists (in that order).  If no pages exist on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zeroed
01405     or free list a transition page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standby list
01406     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE (may be a prototype PTE) which refers to <span class="keyword">this</span> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01407     changed from transition back to its original contents.
01408 
01409     Note pages MUST exist to satisfy <span class="keyword">this</span> request.  The caller ensures <span class="keyword">this</span>
01410     by first calling <a class="code" href="../../d4/d8/mi_8h.html#a791">MiEnsureAvailablePageOrWait</a>.
01411 
01412 Arguments:
01413 
01414     PageColor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page color <span class="keywordflow">for</span> which <span class="keyword">this</span> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> destined.
01415                 This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> checking <span class="keyword">virtual</span> address alignments to
01416                 determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/imemenu_8c.html#a0">D</a> cache needs flushing before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page
01417                 can be reused.
01418 
01419 Return Value:
01420 
01421     The physical page number removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified list.
01422 
01423 Environment:
01424 
01425     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
01426 
01427 --*/
01428 
01429 {
01430     PFN_NUMBER Page;
01431     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01432     ULONG Color;
01433 
01434     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01435     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(MmAvailablePages != 0);
01436 
01437     <span class="comment">//</span>
01438     <span class="comment">// Check the free page list, and if a page is available</span>
01439     <span class="comment">// remove it and return its value.</span>
01440     <span class="comment">//</span>
01441 
01442     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01443 
01444         <span class="comment">//</span>
01445         <span class="comment">// Remove the first entry on the free by color list.</span>
01446         <span class="comment">//</span>
01447 
01448         Page = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
01449 <span class="preprocessor">#if DBG</span>
01450 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01451         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == FreePageList);
01452         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01453         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01454 <span class="preprocessor">#endif</span>
01455 <span class="preprocessor"></span>        <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, PageColor);
01456 <span class="preprocessor">#if DBG</span>
01457 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01458         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01459         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01460         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01461 <span class="preprocessor">#endif</span>
01462 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01463 
01464     }
01465 
01466     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>
01467                                                         != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01468 
01469         <span class="comment">//</span>
01470         <span class="comment">// Remove the first entry on the zeroed by color list.</span>
01471         <span class="comment">//</span>
01472 
01473         Page = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
01474 <span class="preprocessor">#if DBG</span>
01475 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01476         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01477         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == ZeroedPageList);
01478         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01479 <span class="preprocessor">#endif</span>
01480 <span class="preprocessor"></span>
01481         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, PageColor);
01482         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01483         <span class="keywordflow">return</span> Page;
01484     }
01485 
01486     <span class="comment">//</span>
01487     <span class="comment">// Try the free page list by primary color.</span>
01488     <span class="comment">//</span>
01489 
01490     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01491         Page = <a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01492         Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page));
01493 
01494 <span class="preprocessor">#if DBG</span>
01495 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01496         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01497         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == FreePageList);
01498         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01499 <span class="preprocessor">#endif</span>
01500 <span class="preprocessor"></span>        <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, Color);
01501 <span class="preprocessor">#if DBG</span>
01502 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01503         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01504         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01505         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01506 <span class="preprocessor">#endif</span>
01507 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01508 
01509     }
01510 
01511     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01512         Page = <a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01513         Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page));
01514         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, Color);
01515 <span class="preprocessor">#if DBG</span>
01516 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01517         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01518         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01519         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01520         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01521 <span class="preprocessor">#endif</span>
01522 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01523     }
01524 
01525     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
01526 
01527         Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;MmFreePageListHead);
01528         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
01529 
01530     } <span class="keywordflow">else</span> {
01531 
01532         <span class="comment">//</span>
01533         <span class="comment">// Check the zeroed page list, and if a page is available</span>
01534         <span class="comment">// remove it and return its value.</span>
01535         <span class="comment">//</span>
01536 
01537         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
01538 
01539             Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;MmZeroedPageListHead);
01540             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
01541 
01542         } <span class="keywordflow">else</span> {
01543 
01544             <span class="comment">//</span>
01545             <span class="comment">// No pages exist on the free or zeroed list, use the</span>
01546             <span class="comment">// standby list.</span>
01547             <span class="comment">//</span>
01548 
01549             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0);
01550 
01551             Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;MmStandbyPageListHead);
01552             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
01553         }
01554     }
01555 
01556     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a122">MI_CHECK_PAGE_ALIGNMENT</a>(Page, PageColor &amp; MM_COLOR_MASK);
01557 <span class="preprocessor">#if DBG</span>
01558 <span class="preprocessor"></span>    Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
01559     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01560     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01561 <span class="preprocessor">#endif</span>
01562 <span class="preprocessor"></span>    <span class="keywordflow">return</span> Page;
01563 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="pfnlist.c::MiRemovePageByColor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiRemovePageByColor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>Page</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PageColor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01567">1567</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01082">_MMPFNLIST::Blink</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01080">_MMPFNLIST::ListName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00336">MiObtainFreePages()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05118">MmMinimumFreePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02211">PERFINFO_REMOVEPAGE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, and <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>.
<p>
<pre class="fragment"><div>01574                    :
01575 
01576     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> removes a page from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> middle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free or
01577     zeroed page list.
01578 
01579 Arguments:
01580 
01581     PageFrameIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page number to unlink from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01582                      list.
01583 
01584 Return Value:
01585 
01586     none.
01587 
01588 Environment:
01589 
01590     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
01591 
01592 --*/
01593 
01594 {
01595     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
01596     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> PrimaryListHead;
01597     PFN_NUMBER Previous;
01598     PFN_NUMBER Next;
01599     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01600     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01601     ULONG PrimaryColor;
01602 
01603     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01604 
01605     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
01606     PrimaryColor = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor;
01607 
01608     <a class="code" href="../../d2/d1/mm_8h.html#a90">PERFINFO_REMOVEPAGE</a>(Page, PERFINFO_LOG_TYPE_REMOVEPAGEBYCOLOR);
01609 
01610     ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation];
01611 
01612     ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> -= 1;
01613 
01614     PrimaryListHead = ListHead;
01615 
01616 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01617 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[PrimaryListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != Page) {
01618 
01619         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
01620                       0x9A,
01621                       Page,
01622                       Color,
01623                       (PFN_NUMBER)&amp;MmFreePagesByColor[PrimaryListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].Flink);
01624     }
01625 <span class="preprocessor">#endif</span>
01626 <span class="preprocessor"></span>
01627     Next = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
01628     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = 0;         <span class="comment">// Assumes Flink width is &gt;= WsIndex width</span>
01629     Previous = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink;
01630     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = 0;
01631 
01632     <span class="keywordflow">if</span> (Next == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01633         PrimaryListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Previous;
01634     } <span class="keywordflow">else</span> {
01635         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Next);
01636         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Previous;
01637     }
01638 
01639     <span class="keywordflow">if</span> (Previous == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01640         PrimaryListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = Next;
01641     } <span class="keywordflow">else</span> {
01642         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Previous);
01643         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Next;
01644     }
01645 
01646     <span class="comment">//</span>
01647     <span class="comment">// Zero the flags longword, but keep the color information.</span>
01648     <span class="comment">//</span>
01649 
01650     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0);
01651     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ShortFlags = 0;
01652     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = PrimaryColor;
01653 
01654     <span class="comment">//</span>
01655     <span class="comment">// Update the color lists.</span>
01656     <span class="comment">//</span>
01657 
01658     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> =
01659                                         (PFN_NUMBER) Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01660 
01661     <span class="comment">//</span>
01662     <span class="comment">// Note that we now have one less page available.</span>
01663     <span class="comment">//</span>
01664 
01665     <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> -= 1;
01666 
01667     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
01668 
01669         <span class="comment">//</span>
01670         <span class="comment">// Obtain free pages.</span>
01671         <span class="comment">//</span>
01672 
01673         <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a>();
01674 
01675     }
01676 
01677     <span class="keywordflow">return</span>;
01678 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="pfnlist.c::MiRemovePageFromList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER FASTCALL MiRemovePageFromList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ListHead</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00521">521</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01165">MI_GET_SECONDARY_COLOR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00041">MI_TALLY_TRANSITION_PAGE_REMOVAL</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00336">MiObtainFreePages()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01245">MiRestoreTransitionPte()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00043">MmLowestPhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05118">MmMinimumFreePages</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02211">PERFINFO_REMOVEPAGE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02986">MmTrimAllSystemPagableMemory()</a>.
<p>
<pre class="fragment"><div>00527                    :
00528 
00529     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> removes a page from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified list (free,
00530     standby, zeroed, modified).
00531 
00532     This routine clears <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flags word in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database, hence <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00533     PFN information <span class="keywordflow">for</span> <span class="keyword">this</span> page must be initialized.
00534 
00535 Arguments:
00536 
00537     ListHead - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list in which to remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00538                specified physical page.
00539 
00540 Return Value:
00541 
00542     The physical page number removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified list.
00543 
00544 Environment:
00545 
00546     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
00547 
00548 --*/
00549 
00550 {
00551     PFN_NUMBER PageFrameIndex;
00552     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00553     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00554     ULONG Color;
00555 
00556     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00557 
00558     <span class="comment">//</span>
00559     <span class="comment">// If the specified list is empty return MM_EMPTY_LIST.</span>
00560     <span class="comment">//</span>
00561 
00562     <span class="keywordflow">if</span> (ListHead-&gt;Total == 0) {
00563 
00564         KdPrint((<span class="stringliteral">"MM:Attempting to remove page from empty list\n"</span>));
00565         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT, 1, (ULONG_PTR)ListHead, MmAvailablePages, 0);
00566         <span class="keywordflow">return</span> 0;
00567     }
00568 
00569     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;ListName != ModifiedPageList);
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Decrement the count of pages on the list and remove the first</span>
00573     <span class="comment">// page from the list.</span>
00574     <span class="comment">//</span>
00575 
00576     ListHead-&gt;Total -= 1;
00577     PageFrameIndex = ListHead-&gt;Flink;
00578     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00579 
00580     <a class="code" href="../../d2/d1/mm_8h.html#a90">PERFINFO_REMOVEPAGE</a>(PageFrameIndex, PERFINFO_LOG_TYPE_REMOVEPAGEFROMLIST);
00581 
00582     ListHead-&gt;Flink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
00583 
00584     <span class="comment">//</span>
00585     <span class="comment">// Zero the flink and blink in the pfn database element.</span>
00586     <span class="comment">//</span>
00587 
00588     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = 0;         <span class="comment">// Assumes Flink width is &gt;= WsIndex width</span>
00589     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = 0;
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// If the last page was removed (the ListHead-&gt;Flink is now</span>
00593     <span class="comment">// MM_EMPTY_LIST) make the listhead-&gt;Blink MM_EMPTY_LIST as well.</span>
00594     <span class="comment">//</span>
00595 
00596     <span class="keywordflow">if</span> (ListHead-&gt;Flink == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00597         ListHead-&gt;Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00598     } <span class="keywordflow">else</span> {
00599 
00600         <span class="comment">//</span>
00601         <span class="comment">// Make the PFN element point to MM_EMPTY_LIST signifying this</span>
00602         <span class="comment">// is the last page in the list.</span>
00603         <span class="comment">//</span>
00604 
00605         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ListHead-&gt;Flink);
00606         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00607     }
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// Check to see if we now have one less page available.</span>
00611     <span class="comment">//</span>
00612 
00613     <span class="keywordflow">if</span> (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00614         <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> -= 1;
00615 
00616         <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// This page is currently in transition, restore the PTE to</span>
00620             <span class="comment">// its original contents so this page can be reused.</span>
00621             <span class="comment">//</span>
00622 
00623             <a class="code" href="../../d7/d5/pfnlist_8c.html#a3">MI_TALLY_TRANSITION_PAGE_REMOVAL</a> (Pfn1);
00624             <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (PageFrameIndex);
00625         }
00626 
00627         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
00628 
00629             <span class="comment">//</span>
00630             <span class="comment">// Obtain free pages.</span>
00631             <span class="comment">//</span>
00632 
00633             <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a>();
00634         }
00635     }
00636 
00637     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex != 0) &amp;&amp;
00638             (PageFrameIndex &lt;= MmHighestPhysicalPage) &amp;&amp;
00639             (PageFrameIndex &gt;= MmLowestPhysicalPage));
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">// Zero the PFN flags longword.</span>
00643     <span class="comment">//</span>
00644 
00645     Color = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor;
00646     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0);
00647     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ShortFlags = 0;
00648     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = Color;
00649     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (PageFrameIndex, Pfn1);
00650 
00651     <span class="keywordflow">if</span> (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>) {
00652 
00653         <span class="comment">//</span>
00654         <span class="comment">// Update the color lists.</span>
00655         <span class="comment">//</span>
00656 
00657         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmFreePagesByColor[ListHead-&gt;ListName][Color].Flink == PageFrameIndex);
00658         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> =
00659                                          (PFN_NUMBER) Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00660     }
00661 
00662     <span class="keywordflow">return</span> PageFrameIndex;
00663 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="pfnlist.c::MiRemoveZeroPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER FASTCALL MiRemoveZeroPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageColor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">1177</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02799">MI_BARRIER_STAMP_ZEROED_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00964">MI_CHECK_PAGE_ALIGNMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01165">MI_GET_SECONDARY_COLOR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01219">MI_MAGIC_AWE_PTEFRAME</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01567">MiRemovePageByColor()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00521">MiRemovePageFromList()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00315">MM_COLOR_MASK</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00081">MmFreePageListHead</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00082">MmStandbyPageListHead</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00080">MmZeroedPageListHead</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l02824">MiAddWorkingSetPage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03179">MiAddWsleHash()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l02133">MiDoneWithThisPageGetAnother()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00814">MiInitializeSystemCache()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01481">MiInitializeWorkingSetList()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00674">MiResolveDemandZeroFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01989">MiResolveMappedFileFault()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">MmAddPhysicalMemory()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01016">MmCheckCachedPageState()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, and <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>.
<p>
<pre class="fragment"><div>01183                    :
01184 
01185     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> removes a zero page from either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zeroed, free
01186     or standby lists (in that order).  If no pages exist on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zeroed
01187     or free list a transition page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standby list
01188     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE (may be a prototype PTE) which refers to <span class="keyword">this</span> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01189     changed from transition back to its original contents.
01190 
01191     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not obtained from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zeroed list, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zeroed.
01192 
01193 Arguments:
01194 
01195     PageColor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page color <span class="keywordflow">for</span> which <span class="keyword">this</span> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> destined.
01196                 This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> checking <span class="keyword">virtual</span> address alignments to
01197                 determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/imemenu_8c.html#a0">D</a> cache needs flushing before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page
01198                 can be reused.
01199 
01200 Return Value:
01201 
01202     The physical page number removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified list.
01203 
01204 Environment:
01205 
01206     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
01207 
01208 --*/
01209 
01210 {
01211     PFN_NUMBER Page;
01212     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01213     ULONG Color;
01214 
01215     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01216     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(MmAvailablePages != 0);
01217 
01218     <span class="comment">//</span>
01219     <span class="comment">// Attempt to remove a page from the zeroed page list. If a page</span>
01220     <span class="comment">// is available, then remove it and return its page frame index.</span>
01221     <span class="comment">// Otherwise, attempt to remove a page from the free page list or</span>
01222     <span class="comment">// the standby list.</span>
01223     <span class="comment">//</span>
01224     <span class="comment">// N.B. It is not necessary to change page colors even if the old</span>
01225     <span class="comment">//      color is not equal to the new color. The zero page thread</span>
01226     <span class="comment">//      ensures that all zeroed pages are removed from all caches.</span>
01227     <span class="comment">//</span>
01228 
01229     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01230 
01231         <span class="comment">//</span>
01232         <span class="comment">// Remove the first entry on the zeroed by color list.</span>
01233         <span class="comment">//</span>
01234 
01235         Page = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
01236 
01237 <span class="preprocessor">#if DBG</span>
01238 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01239         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == ZeroedPageList);
01240         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01241 <span class="preprocessor">#endif</span>
01242 <span class="preprocessor"></span>
01243         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, PageColor);
01244 
01245 <span class="preprocessor">#if DBG</span>
01246 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01247         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01248         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01249         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01250 <span class="preprocessor">#endif</span>
01251 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01252 
01253     }
01254 
01255     <span class="comment">//</span>
01256     <span class="comment">// No previously zeroed page with the specified secondary color exists.</span>
01257     <span class="comment">// Try a zeroed page of the primary color.</span>
01258     <span class="comment">//</span>
01259 
01260     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01261         Page = <a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01262 <span class="preprocessor">#if DBG</span>
01263 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01264         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == ZeroedPageList);
01265         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01266 <span class="preprocessor">#endif</span>
01267 <span class="preprocessor"></span>        Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page));
01268         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, Color);
01269 <span class="preprocessor">#if DBG</span>
01270 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01271         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01272         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01273         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01274         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01275 <span class="preprocessor">#endif</span>
01276 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01277     }
01278 
01279     <span class="comment">//</span>
01280     <span class="comment">// No zeroed page of the primary color exists, try a free page of the</span>
01281     <span class="comment">// secondary color.</span>
01282     <span class="comment">//</span>
01283 
01284     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01285 
01286         <span class="comment">//</span>
01287         <span class="comment">// Remove the first entry on the free list by color.</span>
01288         <span class="comment">//</span>
01289 
01290         Page = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
01291 
01292 <span class="preprocessor">#if DBG</span>
01293 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01294         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == FreePageList);
01295         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01296 <span class="preprocessor">#endif</span>
01297 <span class="preprocessor"></span>
01298         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, PageColor);
01299 <span class="preprocessor">#if DBG</span>
01300 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01301         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01302         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01303         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01304         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01305 <span class="preprocessor">#endif</span>
01306 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> ZeroPage;
01307     }
01308 
01309     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01310         Page = <a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01311 
01312         Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page));
01313         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, Color);
01314 <span class="preprocessor">#if DBG</span>
01315 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01316         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; MM_COLOR_MASK));
01317         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01318         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01319         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01320 <span class="preprocessor">#endif</span>
01321 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> ZeroPage;
01322     }
01323 
01324     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> == 0);
01325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> == 0);
01326 
01327     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
01328 
01329         Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;MmZeroedPageListHead);
01330         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a122">MI_CHECK_PAGE_ALIGNMENT</a>(Page, PageColor &amp; MM_COLOR_MASK);
01331 
01332     } <span class="keywordflow">else</span> {
01333 
01334         <span class="comment">//</span>
01335         <span class="comment">// Attempt to remove a page from the free list. If a page is</span>
01336         <span class="comment">// available, then remove  it. Otherwise, attempt to remove a</span>
01337         <span class="comment">// page from the standby list.</span>
01338         <span class="comment">//</span>
01339 
01340         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
01341             Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;MmFreePageListHead);
01342             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
01343         } <span class="keywordflow">else</span> {
01344 
01345             <span class="comment">//</span>
01346             <span class="comment">// Remove a page from the standby list and restore the original</span>
01347             <span class="comment">// contents of the PTE to free the last reference to the physical</span>
01348             <span class="comment">// page.</span>
01349             <span class="comment">//</span>
01350 
01351             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0);
01352 
01353             Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;MmStandbyPageListHead);
01354             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
01355         }
01356 
01357         <span class="comment">//</span>
01358         <span class="comment">// Zero the page removed from the free or standby list.</span>
01359         <span class="comment">//</span>
01360 
01361 ZeroPage:
01362 
01363         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01364 
01365 <span class="preprocessor">#if defined(_ALPHA_)</span>
01366 <span class="preprocessor"></span>        HalZeroPage((PVOID)ULongToPtr((PageColor &amp; MM_COLOR_MASK) &lt;&lt; PAGE_SHIFT),
01367                     (PVOID)ULongToPtr((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor) &lt;&lt; PAGE_SHIFT),
01368                     Page);
01369 <span class="preprocessor">#else</span>
01370 <span class="preprocessor"></span>        <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (Page, 0);
01371 <span class="preprocessor">#endif</span>
01372 <span class="preprocessor"></span>
01373         <span class="comment">//</span>
01374         <span class="comment">// Note the stamping must occur after the page is zeroed.</span>
01375         <span class="comment">//</span>
01376 
01377         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a198">MI_BARRIER_STAMP_ZEROED_PAGE</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01378 
01379         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>;
01380 
01381     }
01382 
01383 <span class="preprocessor">#if DBG</span>
01384 <span class="preprocessor"></span>    Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
01385     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01386     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01387     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01388 <span class="preprocessor">#endif</span>
01389 <span class="preprocessor"></span>
01390     <span class="keywordflow">return</span> Page;
01391 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="pfnlist.c::MiUnlinkFreeOrZeroedPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiUnlinkFreeOrZeroedPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Page</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00821">821</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01893">_MMCOLOR_TABLES::Blink</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01082">_MMPFNLIST::Blink</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01080">_MMPFNLIST::ListName</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01167">MI_GET_COLOR_FROM_SECONDARY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01165">MI_GET_SECONDARY_COLOR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00336">MiObtainFreePages()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05118">MmMinimumFreePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02217">PERFINFO_UNLINKFREEPAGE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01109">MiRemovePhysicalPages()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>.
<p>
<pre class="fragment"><div>00827                    :
00828 
00829     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> removes a page from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> middle of a list.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00830     designed <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> removing of free or zeroed pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> middle of
00831     their lists.
00832 
00833 Arguments:
00834 
00835     Pfn - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database element <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
00836           page to remove from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00837 
00838 Return Value:
00839 
00840     None.
00841 
00842 Environment:
00843 
00844     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
00845 
00846 --*/
00847 
00848 {
00849     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
00850     PFN_NUMBER Previous;
00851     PFN_NUMBER Next;
00852     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00853     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
00854     ULONG Color;
00855 
00856     Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
00857 
00858     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00859 
00860     ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation];
00861     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0);
00862     ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> -= 1;
00863 
00864     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> &lt;= FreePageList);
00865     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0);
00866     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
00867 
00868     <a class="code" href="../../d2/d1/mm_8h.html#a96">PERFINFO_UNLINKFREEPAGE</a>((ULONG_PTR)(Pfn - MmPfnDatabase), Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation);
00869 
00870     Next = Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
00871     Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = 0;         <span class="comment">// Assumes Flink width is &gt;= WsIndex width</span>
00872     Previous = Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink;
00873     Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = 0;
00874 
00875     <span class="keywordflow">if</span> (Next == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00876         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Previous;
00877     } <span class="keywordflow">else</span> {
00878         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Next);
00879         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Previous;
00880     }
00881 
00882     <span class="keywordflow">if</span> (Previous == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00883         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = Next;
00884     } <span class="keywordflow">else</span> {
00885         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Previous);
00886         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Next;
00887     }
00888 
00889     <span class="comment">//</span>
00890     <span class="comment">// We are removing a page from the middle of the free or zeroed page list.</span>
00891     <span class="comment">// The secondary color tables must be updated at this time.</span>
00892     <span class="comment">//</span>
00893 
00894     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, Pfn);
00895     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(Color));
00896 
00897     <span class="comment">//</span>
00898     <span class="comment">// Walk down the list and remove the page.</span>
00899     <span class="comment">//</span>
00900 
00901     Next = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
00902     <span class="keywordflow">if</span> (Next == Page) {
00903         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> =
00904                                                 (PFN_NUMBER) Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00905     } <span class="keywordflow">else</span> {
00906 
00907         <span class="comment">//</span>
00908         <span class="comment">// Walk the list to find the parent.</span>
00909         <span class="comment">//</span>
00910 
00911         <span class="keywordflow">for</span> (; ; ) {
00912             Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Next);
00913             Next = (PFN_NUMBER) Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00914             <span class="keywordflow">if</span> (Page == Next) {
00915                 Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00916                 <span class="keywordflow">if</span> ((PFN_NUMBER) Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00917                     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> = Pfn2;
00918                 }
00919                 <span class="keywordflow">break</span>;
00920             }
00921         }
00922     }
00923 
00924     <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> -= 1;
00925 
00926     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
00927 
00928         <span class="comment">//</span>
00929         <span class="comment">// Obtain free pages.</span>
00930         <span class="comment">//</span>
00931 
00932         <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a>();
00933     }
00934 
00935     <span class="keywordflow">return</span>;
00936 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="pfnlist.c::MiUnlinkPageFromList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiUnlinkPageFromList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Pfn</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">667</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01082">_MMPFNLIST::Blink</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01080">_MMPFNLIST::ListName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00041">MI_TALLY_TRANSITION_PAGE_REMOVAL</a>, <a class="el" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00336">MiObtainFreePages()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00181">MM_DBG_PAGE_IN_LIST</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05118">MmMinimumFreePages</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00114">MmModifiedPageListByColor</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00123">MmTotalPagesForPagingFile</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02218">PERFINFO_UNLINKPAGE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01745">MiDecrementCloneBlockReference()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">MiGatherPagefilePages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00541">MiPurgeImageSection()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01109">MiRemovePhysicalPages()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l01953">MiResetVirtualMemory()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00868">MiResolveTransitionFault()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00191">MiSegmentDelete()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01016">MmCheckCachedPageState()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">MmPurgeSection()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, and <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>.
<p>
<pre class="fragment"><div>00673                    :
00674 
00675     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> removes a page from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> middle of a list.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00676     designed <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> faulting of transition pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standby and
00677     modified list and making them active and valid again.
00678 
00679 Arguments:
00680 
00681     Pfn - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database element <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
00682           page to remove from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00683 
00684 Return Value:
00685 
00686     none.
00687 
00688 Environment:
00689 
00690     Must be holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database mutex with APCs disabled.
00691 
00692 --*/
00693 
00694 {
00695     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
00696     PFN_NUMBER Previous;
00697     PFN_NUMBER Next;
00698     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00699 
00700     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00701 
00702     <a class="code" href="../../d2/d1/mm_8h.html#a97">PERFINFO_UNLINKPAGE</a>((ULONG_PTR)(Pfn - MmPfnDatabase), Pfn-&gt;u3.e1.PageLocation);
00703 
00704     <span class="comment">//</span>
00705     <span class="comment">// Page not on standby or modified list, check to see if the</span>
00706     <span class="comment">// page is currently being written by the modified page</span>
00707     <span class="comment">// writer, if so, just return this page.  The reference</span>
00708     <span class="comment">// count for the page will be incremented, so when the modified</span>
00709     <span class="comment">// page write completes, the page will not be put back on</span>
00710     <span class="comment">// the list, rather, it will remain active and valid.</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">if</span> (Pfn-&gt;u3.e2.ReferenceCount &gt; 0) {
00714 
00715         <span class="comment">//</span>
00716         <span class="comment">// The page was not on any "transition lists", check to see</span>
00717         <span class="comment">// if this has I/O in progress.</span>
00718         <span class="comment">//</span>
00719 
00720         <span class="keywordflow">if</span> (Pfn-&gt;u2.ShareCount == 0) {
00721 <span class="preprocessor">#if DBG</span>
00722 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a73">MM_DBG_PAGE_IN_LIST</a>) {
00723                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unlinking page not in list...\n"</span>);
00724                 <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a>(Pfn);
00725             }
00726 <span class="preprocessor">#endif</span>
00727 <span class="preprocessor"></span>            <span class="keywordflow">return</span>;
00728         }
00729         KdPrint((<span class="stringliteral">"MM:attempt to remove page from wrong page list\n"</span>));
00730         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00731                       2,
00732                       Pfn - MmPfnDatabase,
00733                       MmHighestPhysicalPage,
00734                       Pfn-&gt;u3.e2.ReferenceCount);
00735         <span class="keywordflow">return</span>;
00736     }
00737 
00738     ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[Pfn-&gt;u3.e1.PageLocation];
00739 
00740     <span class="comment">//</span>
00741     <span class="comment">// Must not remove pages from free or zeroed without updating</span>
00742     <span class="comment">// the colored lists.</span>
00743     <span class="comment">//</span>
00744 
00745     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> &gt;= StandbyPageList);
00746 
00747     <span class="comment">//</span>
00748     <span class="comment">// On MIPS R4000 modified pages destined for the paging file are</span>
00749     <span class="comment">// kept on separate lists which group pages of the same color</span>
00750     <span class="comment">// together</span>
00751     <span class="comment">//</span>
00752 
00753     <span class="keywordflow">if</span> ((ListHead == &amp;<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>) &amp;&amp;
00754         (Pfn-&gt;OriginalPte.u.Soft.Prototype == 0)) {
00755 
00756         <span class="comment">//</span>
00757         <span class="comment">// This page is destined for the paging file (not</span>
00758         <span class="comment">// a mapped file).  Change the list head to the</span>
00759         <span class="comment">// appropriate colored list head.</span>
00760         <span class="comment">//</span>
00761 
00762         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> -= 1;
00763         <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> -= 1;
00764         ListHead = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a21">MmModifiedPageListByColor</a> [Pfn-&gt;u3.e1.PageColor];
00765     }
00766 
00767     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;u3.e1.WriteInProgress == 0);
00768     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;u3.e1.ReadInProgress == 0);
00769     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0);
00770 
00771     Next = Pfn-&gt;u1.Flink;
00772     Pfn-&gt;u1.Flink = 0;         <span class="comment">// Assumes Flink width is &gt;= WsIndex width</span>
00773     Previous = Pfn-&gt;u2.Blink;
00774     Pfn-&gt;u2.Blink = 0;
00775 
00776     <span class="keywordflow">if</span> (Next == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00777         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Previous;
00778     } <span class="keywordflow">else</span> {
00779         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Next);
00780         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Previous;
00781     }
00782 
00783     <span class="keywordflow">if</span> (Previous == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00784         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = Next;
00785     } <span class="keywordflow">else</span> {
00786         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Previous);
00787         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Next;
00788     }
00789 
00790     ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> -= 1;
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">// Check to see if we now have one less page available.</span>
00794     <span class="comment">//</span>
00795 
00796     <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00797         <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> -= 1;
00798 
00799         <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00800             <a class="code" href="../../d7/d5/pfnlist_8c.html#a3">MI_TALLY_TRANSITION_PAGE_REMOVAL</a> (Pfn);
00801         }
00802 
00803         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
00804 
00805             <span class="comment">//</span>
00806             <span class="comment">// Obtain free pages.</span>
00807             <span class="comment">//</span>
00808 
00809             <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a>();
00810 
00811         }
00812     }
00813     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a> || ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> == <a class="code" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>) {
00814         <a class="code" href="../../d7/d5/pfnlist_8c.html#a3">MI_TALLY_TRANSITION_PAGE_REMOVAL</a> (Pfn);
00815     }
00816 
00817     <span class="keywordflow">return</span>;
00818 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a4" doxytag="pfnlist.c::MmAvailablePagesEventHigh" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d7/d5/pfnlist_8c.html#a4">MmAvailablePagesEventHigh</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00027">27</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00388">MiInsertStandbyListAtFront()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="pfnlist.c::MmTransitionPrivatePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d5/pfnlist_8c.html#a5">MmTransitionPrivatePages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00029">29</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00388">MiInsertStandbyListAtFront()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pfnlist.c::MmTransitionSharedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d0/wslist_8c.html#a9">MmTransitionSharedPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00030">30</a> of file <a class="el" href="../../d8/d4/pfnlist_8c-source.html">pfnlist.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
