<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: clinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>clinit.c</h1><a href="../../d6/d8/clinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: clinit.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains all the init code for the USER.DLL. When the DLL is</span>
00007 <span class="comment">* dynlinked its initialization procedure (UserDllInitialize) is called by</span>
00008 <span class="comment">* the loader.</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">* 18-Sep-1990 DarrinM Created.</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#include &lt;conroute.h&gt;</span>
00017 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/csrhlpr_8h.html">csrhlpr.h</a>"</span>
00018 
00019 <span class="preprocessor">#include "badapps.h"</span>
00020 
00021 <span class="comment">/*</span>
00022 <span class="comment"> * Global variables local to this module (startup).</span>
00023 <span class="comment"> */</span>
<a name="l00024"></a><a class="code" href="../../d6/d8/clinit_8c.html#a1">00024</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         <a class="code" href="../../d6/d8/clinit_8c.html#a1">gfFirstThread</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
<a name="l00025"></a><a class="code" href="../../d6/d8/clinit_8c.html#a2">00025</a> <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a> <a class="code" href="../../d6/d8/clinit_8c.html#a2">pdiLocal</a>;
<a name="l00026"></a><a class="code" href="../../d6/d8/clinit_8c.html#a3">00026</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         <a class="code" href="../../d6/d8/clinit_8c.html#a3">gbIhaveBeenInited</a>;
<a name="l00027"></a><a class="code" href="../../d6/d8/clinit_8c.html#a4">00027</a> <span class="keyword">static</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d8/clinit_8c.html#a4">gdwLpkEntryPoints</a>;
00028 
<a name="l00029"></a><a class="code" href="../../d6/d8/clinit_8c.html#a5">00029</a> CONST WCHAR <a class="code" href="../../d6/d8/clinit_8c.html#a5">pwszWindowsKey</a>[]      = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows"</span>;
<a name="l00030"></a><a class="code" href="../../d6/d8/clinit_8c.html#a6">00030</a> CONST WCHAR <a class="code" href="../../d6/d8/clinit_8c.html#a6">szAppInit</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"AppInit_DLLs"</span>;
00031 
<a name="l00032"></a><a class="code" href="../../d6/d8/clinit_8c.html#a7">00032</a> CONST WCHAR <a class="code" href="../../d6/d8/clinit_8c.html#a7">gwszShimDll</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"shim.dll"</span>;
<a name="l00033"></a><a class="code" href="../../d6/d8/clinit_8c.html#a8">00033</a> CONST <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>  <a class="code" href="../../d6/d8/clinit_8c.html#a8">gszLoadPathDll</a>[] = <span class="stringliteral">"LoadPatchDll"</span>;
00034 
00035 <span class="comment">/*</span>
00036 <span class="comment"> * External declared routines needed for startup.</span>
00037 <span class="comment"> */</span>
00038 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d8/clinit_8c.html#a16">GdiProcessSetup</a>();
00039 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d8/clinit_8c.html#a17">GdiDllInitialize</a>(IN PVOID hmod, IN DWORD Reason, IN PCONTEXT pctx OPTIONAL);
00040 
<a name="l00041"></a><a class="code" href="../../d6/d8/clinit_8c.html#a9">00041</a> WCHAR <a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>[<a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a>];
00042 <span class="preprocessor">#ifdef _JANUS_</span>
00043 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> InitInstrument(LPDWORD lpEMIControl);
00044 <span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
00046 <span class="comment">* UserClientDllInitialize</span>
00047 <span class="comment">*</span>
00048 <span class="comment">* When USER.DLL is loaded by an EXE (either at EXE load or at LoadModule</span>
00049 <span class="comment">* time) this routine is called by the loader. Its purpose is to initialize</span>
00050 <span class="comment">* everything that will be needed for future User API calls by the app.</span>
00051 <span class="comment">*</span>
00052 <span class="comment">* History:</span>
00053 <span class="comment">* 19-Sep-1990 DarrinM Created.</span>
00054 <span class="comment">\***************************************************************************/</span>
00055 
<a name="l00056"></a><a class="code" href="../../d6/d8/clinit_8c.html#a10">00056</a> <span class="keyword">extern</span> CONST PCSR_CALLBACK_ROUTINE <a class="code" href="../../d6/d8/clinit_8c.html#a10">apfnDispatch</a>[];
<a name="l00057"></a><a class="code" href="../../d6/d8/clinit_8c.html#a11">00057</a> <span class="keyword">extern</span> CONST ULONG                 <a class="code" href="../../d6/d8/clinit_8c.html#a11">ulMaxApiIndex</a>;
00058 
<a name="l00059"></a><a class="code" href="../../d6/d8/clinit_8c.html#a18">00059</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d8/clinit_8c.html#a18">UserClientDllInitialize</a>(
00060     IN PVOID    hmod,
00061     IN DWORD    Reason,
00062     IN PCONTEXT pctx OPTIONAL)
00063 {
00064     SYSTEM_BASIC_INFORMATION SystemInformation;
00065     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00066 
00067     DBG_UNREFERENCED_PARAMETER(pctx);
00068 
00069 <span class="preprocessor">#if DBG</span>
00070 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a25">RtlGetNtGlobalFlags</a>() &amp; FLG_SHOW_LDR_SNAPS) {
00071         RIPMSG1(RIP_WARNING,
00072                 <span class="stringliteral">"UserClientDllInitialize: entered for reason %x"</span>,
00073                 Reason);
00074     }
00075 <span class="preprocessor">#endif</span>
00076 <span class="preprocessor"></span>
00077     <span class="keywordflow">if</span> (Reason == DLL_PROCESS_ATTACH) {
00078 
00079         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00080         <a class="code" href="../../d6/d4/struct__USERCONNECT.html">USERCONNECT</a> userconnect;
00081         ULONG       ulConnect = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__USERCONNECT.html">USERCONNECT</a>);
00082         ULONG       SessionId = NtCurrentPeb()-&gt;SessionId;
00083         WCHAR       szSessionDir[<a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a>];
00084 
00085         DisableThreadLibraryCalls(hmod);
00086 
00087         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/clinit_8c.html#a3">gbIhaveBeenInited</a>) {
00088             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00089         }
00090 
00091         <a class="code" href="../../d6/d8/clinit_8c.html#a3">gbIhaveBeenInited</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00092 
00093         status  = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00094         status |= <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a22">gcsLookaside</a>);
00095         status |= <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
00096         status |= <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
00097         status |= <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d9/d3/ddemlcli_8c.html#a1">gcsDDEML</a>);
00098 
00099 <span class="preprocessor">#ifdef WX86</span>
00100 <span class="preprocessor"></span>        status |= <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;gcsWx86Load);
00101 <span class="preprocessor">#endif</span>
00102 <span class="preprocessor"></span>
00103         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00104             RIPMSG1(RIP_WARNING,
00105                     <span class="stringliteral">"UserClientDllInitialize: Failed to create critical sections. Status %x"</span>,
00106                     status);
00107             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00108         }
00109 <span class="preprocessor">#if DBG</span>
00110 <span class="preprocessor"></span>        gpDDEMLHeap = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>(HEAP_GROWABLE | HEAP_CLASS_1
00111                               | HEAP_TAIL_CHECKING_ENABLED | HEAP_FREE_CHECKING_ENABLED
00112                               , <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 8 * 1024, 2 * 1024, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00113 
00114         <span class="keywordflow">if</span> (gpDDEMLHeap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00115             gpDDEMLHeap = RtlProcessHeap();
00116         }
00117 <span class="preprocessor">#endif</span>
00118 <span class="preprocessor"></span>
00119         status = <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a>(SystemBasicInformation,
00120                                           &amp;SystemInformation,
00121                                           <span class="keyword">sizeof</span>(SystemInformation),
00122                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00123         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00124             RIPMSG1(RIP_WARNING,
00125                     <span class="stringliteral">"UserClientDllInitialize: NtQuerySystemInformation failed with Status %x"</span>,
00126                     status);
00127             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00128         }
00129         <a class="code" href="../../d1/d8/clglobal_8c.html#a7">gHighestUserAddress</a> = SystemInformation.MaximumUserModeAddress;
00130 
00131         userconnect.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o0">ulVersion</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a409">USERCURRENTVERSION</a>;
00132 
00133         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00134 
00135             <span class="keywordflow">if</span> (SessionId == 0) {
00136                 wcscpy(szSessionDir, WINSS_OBJECT_DIRECTORY_NAME);
00137             } <span class="keywordflow">else</span> {
00138                 swprintf(szSessionDir, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws\\%ld%ws"</span>,
00139                          <a class="code" href="../../d8/d9/dllinit_8c.html#a2">SESSION_ROOT</a>,
00140                          SessionId,
00141                          WINSS_OBJECT_DIRECTORY_NAME);
00142             }
00143 
00144             status = <a class="code" href="../../d0/d0/csrhlpr_8h.html#a5">UserConnectToServer</a>(szSessionDir,
00145                                          &amp;userconnect,
00146                                          &amp;ulConnect,
00147                                          (PBOOLEAN)&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a>);
00148 
00149         } <span class="keywordflow">else</span> {
00150 
00151             status = <a class="code" href="../../d0/d0/csrhlpr_8h.html#a5">UserConnectToServer</a>(WINSS_OBJECT_DIRECTORY_NAME,
00152                                          &amp;userconnect,
00153                                          &amp;ulConnect,
00154                                          (PBOOLEAN)&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a>);
00155         }
00156 
00157         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00158             RIPMSG1(RIP_WARNING,
00159                     <span class="stringliteral">"UserClientDllInitialize: UserConnectToServer failed with status %x"</span>,
00160                     status);
00161             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00162         }
00163 
00164 
00165         <span class="comment">/*</span>
00166 <span class="comment">         * If this is the server process, the shared info is not</span>
00167 <span class="comment">         * yet valid, so don't copy out the returned info.</span>
00168 <span class="comment">         */</span>
00169         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a>) {
00170             HINSTANCE hImm32 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00171 
00172             <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a> = userconnect.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>;
00173             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o0">psi</a>;
00174 
00175             <span class="comment">// make sure the stub (dummy) routine works</span>
00176             UserAssert(<span class="keyword">sizeof</span>(LRESULT) == <span class="keyword">sizeof</span>(ULONG_PTR));
00177             UserAssert(<span class="keyword">sizeof</span>(PVOID) == <span class="keyword">sizeof</span>(ULONG_PTR));
00178             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00179                 WCHAR wszImmFile[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00180 
00181                 <a class="code" href="../../d6/d0/usercli_8h.html#a786">InitializeImmEntryTable</a>();
00182                 <a class="code" href="../../d6/d0/usercli_8h.html#a787">GetImmFileName</a>(wszImmFile);
00183                 hImm32 = GetModuleHandleW(wszImmFile);
00184             }
00185             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a315">fpImmRegisterClient</a>(&amp;userconnect.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>, hImm32)) {
00186                 RIPMSG0(RIP_WARNING,
00187                         <span class="stringliteral">"UserClientDllInitialize: ImmRegisterClient failed"</span>);
00188                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00189             }
00190         }
00191 
00192         <a class="code" href="../../d1/d8/clglobal_8c.html#a36">pfnFindResourceExA</a> = (PFNFINDA)FindResourceExA;
00193         <a class="code" href="../../d1/d8/clglobal_8c.html#a37">pfnFindResourceExW</a> = (PFNFINDW)FindResourceExW;
00194         <a class="code" href="../../d1/d8/clglobal_8c.html#a38">pfnLoadResource</a>    = (PFNLOAD)LoadResource;
00195         <a class="code" href="../../d1/d8/clglobal_8c.html#a42">pfnSizeofResource</a>  = (PFNSIZEOF)SizeofResource;
00196 
00197         <span class="comment">/*</span>
00198 <span class="comment">         * Register with the base the USER hook it should call when it</span>
00199 <span class="comment">         * does a WinExec() (this is soft-linked because some people still</span>
00200 <span class="comment">         * use charmode nt!</span>
00201 <span class="comment">         */</span>
00202         RegisterWaitForInputIdle(<a class="code" href="../../d3/d8/client_8c.html#a56">WaitForInputIdle</a>);
00203 
00204 
00205         <span class="comment">/*</span>
00206 <span class="comment">         * Remember USER.DLL's hmodule so we can grab resources from it later.</span>
00207 <span class="comment">         */</span>
00208         <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a> = hmod;
00209 
00210         <a class="code" href="../../d1/d8/clglobal_8c.html#a11">pUserHeap</a> = RtlProcessHeap();
00211 
00212         <span class="comment">/*</span>
00213 <span class="comment">         * Initialize callback table</span>
00214 <span class="comment">         */</span>
00215         NtCurrentPeb()-&gt;KernelCallbackTable = <a class="code" href="../../d6/d8/clinit_8c.html#a10">apfnDispatch</a>;
00216         NtCurrentPeb()-&gt;PostProcessInitRoutine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00217 
00218         <span class="keywordflow">if</span> (SessionId != 0) {
00219             swprintf(<a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws\\%ld%ws"</span>,<a class="code" href="../../d8/d9/dllinit_8c.html#a2">SESSION_ROOT</a>,SessionId,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a92">WINSTA_DIR</a>);
00220             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d3/d8/client_8c.html#a19">strRootDirectory</a>, <a class="code" href="../../d6/d8/clinit_8c.html#a9">szWindowStationDirectory</a>);
00221 
00222         } <span class="keywordflow">else</span> {
00223             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d3/d8/client_8c.html#a19">strRootDirectory</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a92">WINSTA_DIR</a>);
00224         }
00225 
00226 <span class="preprocessor">#ifdef _JANUS_</span>
00227 <span class="preprocessor"></span>        gfEMIEnable = InitInstrument(&amp;gdwEMIControl);
00228         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a>) {
00229             gfEMIEnable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00230         }
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Reason == DLL_PROCESS_DETACH) {
00233 
00234         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/fareast_8c.html#a6">ghImm32</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00235             <span class="comment">// IMM32.DLL is loaded by USER32, so free it.</span>
00236             FreeLibrary(<a class="code" href="../../d2/d1/fareast_8c.html#a6">ghImm32</a>);
00237         }
00238 
00239         <span class="comment">/*</span>
00240 <span class="comment">         * If we loaded OLE, tell it we're done.</span>
00241 <span class="comment">         */</span>
00242         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a61">ghinstOLE</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00243             <span class="comment">/*</span>
00244 <span class="comment">             * Later5.0 GerardoB. This causes check OLE32.DLL to fault</span>
00245 <span class="comment">             *  because they get their DLL_PROCESS_DETACH first</span>
00246 <span class="comment">             * (*(OLEUNINITIALIZEPROC)gpfnOLEOleUninitialize)();</span>
00247 <span class="comment">             */</span>
00248             RIPMSG0(RIP_WARNING, <span class="stringliteral">"OLE would fault if I call OleUninitialize now"</span>);
00249             FreeLibrary(<a class="code" href="../../d1/d8/clglobal_8c.html#a61">ghinstOLE</a>);
00250         }
00251 
00252         <span class="comment">/*</span>
00253 <span class="comment">         * If we loaded WinSta.Dll for Terminal Services, then</span>
00254 <span class="comment">         * unload it now.</span>
00255 <span class="comment">         */</span>
00256         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a69">ghinstWinStaDll</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00257             FreeLibrary(<a class="code" href="../../d1/d8/clglobal_8c.html#a69">ghinstWinStaDll</a>);
00258         }
00259 
00260 <span class="preprocessor">#ifdef _JANUS_</span>
00261 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (gfEMIEnable &amp;&amp; (ghAdvApi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00262             FreeLibrary(ghAdvApi);
00263         }
00264 <span class="preprocessor">#endif</span>
00265 <span class="preprocessor"></span>
00266         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00267         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a22">gcsLookaside</a>);
00268         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
00269         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
00270         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;<a class="code" href="../../d9/d3/ddemlcli_8c.html#a1">gcsDDEML</a>);
00271 <span class="preprocessor">#if DBG</span>
00272 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (gpDDEMLHeap != RtlProcessHeap()) {
00273             <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a16">RtlDestroyHeap</a>(gpDDEMLHeap);
00274         }
00275 <span class="preprocessor">#endif</span>
00276 <span class="preprocessor"></span>
00277 
00278 <span class="preprocessor">#ifdef WX86</span>
00279 <span class="preprocessor"></span>        <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;gcsWx86Load);
00280 <span class="preprocessor">#endif</span>
00281 <span class="preprocessor"></span>
00282     }
00283 
00284     bRet = <a class="code" href="../../d6/d8/clinit_8c.html#a17">GdiDllInitialize</a>(hmod, Reason, pctx);
00285     <span class="keywordflow">if</span> (!bRet) {
00286         RIPMSG0(RIP_WARNING,
00287                 <span class="stringliteral">"UserClientDllInitialize: GdiDllInitialize failed"</span>);
00288     }
00289 
00290     <span class="keywordflow">return</span>(bRet);
00291 }
00292 
00293 <span class="comment">/***************************************************************************\</span>
00294 <span class="comment">* LoadCursorsAndIcons</span>
00295 <span class="comment">*</span>
00296 <span class="comment">* This gets called from our initialization call from csr so they're around</span>
00297 <span class="comment">* when window classes get registered. Window classes get registered right</span>
00298 <span class="comment">* after the initial csr initialization call.</span>
00299 <span class="comment">*</span>
00300 <span class="comment">* Later on these default images will get overwritten by custom</span>
00301 <span class="comment">* registry entries.  See UpdateCursors/IconsFromRegistry().</span>
00302 <span class="comment">*</span>
00303 <span class="comment">* 27-Sep-1992 ScottLu      Created.</span>
00304 <span class="comment">* 14-Oct-1995 SanfordS     Rewrote.</span>
00305 <span class="comment">\***************************************************************************/</span>
00306 
<a name="l00307"></a><a class="code" href="../../d6/d8/clinit_8c.html#a19">00307</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d8/clinit_8c.html#a19">LoadCursorsAndIcons</a>(VOID)
00308 {
00309     <span class="keywordtype">int</span>    i;
00310     HANDLE h;
00311     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00312 
00313     <span class="keywordflow">for</span> (i = 0; i &lt; COIC_CONFIGURABLE; i++) {
00314         <span class="comment">/*</span>
00315 <span class="comment">         * load the small version of WINLOGO which will be set into</span>
00316 <span class="comment">         * gpsi-&gt;hIconSmWindows on the kernel side.</span>
00317 <span class="comment">         */</span>
00318         <span class="keywordflow">if</span> (i == OIC_WINLOGO_DEFAULT - OIC_FIRST_DEFAULT) {
00319             h = <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00320                            (LPCWSTR)UIntToPtr( (OIC_FIRST_DEFAULT + i) ),
00321                            RT_ICON,
00322                            <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSMICON),
00323                            <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSMICON),
00324                            LR_GLOBAL);
00325 
00326             fSuccess &amp;= !!h;
00327         }
00328         h = <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00329                        (LPCWSTR)UIntToPtr( (OIC_FIRST_DEFAULT + i) ),
00330                        RT_ICON,
00331                        0,
00332                        0,
00333                        LR_SHARED | LR_GLOBAL);
00334 
00335         fSuccess &amp;= !!h;
00336     }
00337 
00338     <span class="keywordflow">for</span> (i = 0; i &lt; COCR_CONFIGURABLE; i++) {
00339         h = <a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00340                        (LPCWSTR)UIntToPtr( (OCR_FIRST_DEFAULT + i) ),
00341                        RT_CURSOR,
00342                        0,
00343                        0,
00344                        LR_SHARED | LR_GLOBAL);
00345 
00346         fSuccess &amp;= !!h;
00347     }
00348 
00349     <span class="keywordflow">if</span> (!fSuccess) {
00350         RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadCursorsAndIcons failed to load cursors"</span>);
00351     }
00352 
00353     <span class="comment">/*</span>
00354 <span class="comment">     * Now go to the kernel and fixup the IDs from DEFAULT values</span>
00355 <span class="comment">     * to standard values.</span>
00356 <span class="comment">     */</span>
00357     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI__LOADCURSORSANDICONS);
00358 
00359     <span class="keywordflow">return</span> fSuccess;
00360 }
00361 
00362 <span class="comment">/***************************************************************************\</span>
00363 <span class="comment">* RW_RegisterControls</span>
00364 <span class="comment">*</span>
00365 <span class="comment">* Register the control classes. This function must be called for each</span>
00366 <span class="comment">* client process.</span>
00367 <span class="comment">*</span>
00368 <span class="comment">* History:</span>
00369 <span class="comment">* ??-??-?? DarrinM Ported.</span>
00370 <span class="comment">* ??-??-?? MikeKe Moved here from server.</span>
00371 <span class="comment">\***************************************************************************/</span>
00372 
00373 <span class="comment">/*</span>
00374 <span class="comment"> * NOTE -- the class names must stay in the RegisterClass exactly as they are, since</span>
00375 <span class="comment"> * MS-TEST assumes these names exist as strings.</span>
00376 <span class="comment"> */</span>
00377 
<a name="l00378"></a><a class="code" href="../../d6/d8/clinit_8c.html#a20">00378</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d8/clinit_8c.html#a20">RW_RegisterControls</a>(VOID)
00379 {
00380     <span class="keywordtype">int</span>        i;
00381     WNDCLASSEX wndcls;
00382     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>       fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00383 
00384     <span class="keyword">static</span> CONST <span class="keyword">struct </span>{
00385         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    style;
00386         WNDPROC lpfnWndProcW;
00387         <span class="keywordtype">int</span>     cbWndExtra;
00388         LPCTSTR lpszCursor;
00389         HBRUSH  hbrBackground;
00390         LPCTSTR lpszClassName;
00391         WORD    fnid;
00392     } rc[] = {
00393 
00394         {CS_GLOBALCLASS | CS_PARENTDC | CS_DBLCLKS | CS_HREDRAW | CS_VREDRAW,
00395          <a class="code" href="../../d8/d1/btnctl_8c.html#a34">ButtonWndProcW</a>,
00396          <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/structtagBUTNWND.html">BUTNWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
00397          IDC_ARROW,
00398          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00399          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Button"</span>,
00400          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a200">FNID_BUTTON</a>
00401         },
00402 
00403         {CS_GLOBALCLASS | CS_DBLCLKS | CS_PARENTDC | CS_VREDRAW | CS_HREDRAW,
00404          <a class="code" href="../../d1/d4/combo_8c.html#a9">ComboBoxWndProcW</a>,
00405          <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/structtagCOMBOWND.html">COMBOWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
00406          IDC_ARROW,
00407          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00408          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ComboBox"</span>,
00409          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>
00410         },
00411 
00412         {CS_GLOBALCLASS | CS_DBLCLKS | CS_SAVEBITS,
00413          <a class="code" href="../../d6/d1/lb1_8c.html#a5">ComboListBoxWndProcW</a>,
00414          <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d9/structtagLBWND.html">LBWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
00415          IDC_ARROW,
00416          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00417          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ComboLBox"</span>,
00418          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a202">FNID_COMBOLISTBOX</a>
00419         },
00420 
00421         {CS_GLOBALCLASS | CS_DBLCLKS | CS_SAVEBITS,
00422          <a class="code" href="../../d3/d9/dlgmgr_8c.html#a18">DefDlgProcW</a>,
00423          DLGWINDOWEXTRA,
00424          IDC_ARROW,
00425          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00426          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a40">DIALOGCLASS</a>,
00427          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a203">FNID_DIALOG</a>
00428         },
00429 
00430         {CS_GLOBALCLASS | CS_PARENTDC | CS_DBLCLKS,
00431          <a class="code" href="../../d8/d4/editec_8c.html#a43">EditWndProcW</a>,
00432          <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>((<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/structtagEDITWND.html">EDITWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>)), <a class="code" href="../../d6/d0/usercli_8h.html#a70">CBEDITEXTRA</a>),
00433          IDC_IBEAM,
00434          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00435          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Edit"</span>,
00436          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a204">FNID_EDIT</a>
00437         },
00438 
00439         {CS_GLOBALCLASS | CS_PARENTDC | CS_DBLCLKS,
00440          <a class="code" href="../../d6/d1/lb1_8c.html#a3">ListBoxWndProcW</a>,
00441          <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d9/structtagLBWND.html">LBWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
00442          IDC_ARROW,
00443          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00444          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ListBox"</span>,
00445          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a205">FNID_LISTBOX</a>
00446         },
00447 
00448         {CS_GLOBALCLASS,
00449          <a class="code" href="../../d6/d5/mdiwin_8c.html#a31">MDIClientWndProcW</a>,
00450          <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/structtagMDIWND.html">MDIWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
00451          IDC_ARROW,
00452          (HBRUSH)(COLOR_APPWORKSPACE + 1),
00453          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MDIClient"</span>,
00454          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a206">FNID_MDICLIENT</a>
00455         },
00456 
00457         {CS_GLOBALCLASS,
00458          <a class="code" href="../../d9/d9/imectl_8c.html#a33">ImeWndProcW</a>,
00459          <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/structtagIMEWND.html">IMEWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
00460          IDC_ARROW,
00461          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00462          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IME"</span>,
00463          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a208">FNID_IME</a>
00464         },
00465 
00466         {CS_GLOBALCLASS | CS_PARENTDC | CS_DBLCLKS,
00467          <a class="code" href="../../d5/d5/statctl_8c.html#a22">StaticWndProcW</a>,
00468          <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/structtagSTATWND.html">STATWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
00469          IDC_ARROW,
00470          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00471          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Static"</span>,
00472          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a207">FNID_STATIC</a>
00473         }
00474     };
00475 
00476 
00477     <span class="comment">/*</span>
00478 <span class="comment">     * Classes are registered via the table.</span>
00479 <span class="comment">     */</span>
00480     RtlZeroMemory(&amp;wndcls, <span class="keyword">sizeof</span>(wndcls));
00481     wndcls.cbSize       = <span class="keyword">sizeof</span>(wndcls);
00482     wndcls.hInstance    = <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>;
00483 
00484     <span class="keywordflow">for</span> (i = 0; i &lt; (<span class="keyword">sizeof</span>(rc)/<span class="keyword">sizeof</span>(rc[0])); i++) {
00485         wndcls.style        = rc[i].style;
00486         wndcls.lpfnWndProc  = rc[i].lpfnWndProcW;
00487         wndcls.cbWndExtra   = rc[i].cbWndExtra;
00488         wndcls.hCursor      = LoadCursor(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, rc[i].lpszCursor);
00489         wndcls.hbrBackground= rc[i].hbrBackground;
00490         wndcls.lpszClassName= rc[i].lpszClassName;
00491 
00492         fSuccess &amp;= !!<a class="code" href="../../d6/d0/usercli_8h.html#a636">RegisterClassExWOWW</a>(&amp;wndcls, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, rc[i].fnid);
00493     }
00494 
00495     <span class="keywordflow">if</span> (!fSuccess) {
00496         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RW_RegisterControls failed to register classes"</span>);
00497     }
00498 
00499     <span class="keywordflow">return</span> fSuccess;
00500 }
00501 
00502 <span class="comment">/***************************************************************************\</span>
00503 <span class="comment">* RW_RegisterDDEML</span>
00504 <span class="comment">*</span>
00505 <span class="comment">* Register all the DDEML classes</span>
00506 <span class="comment">*</span>
00507 <span class="comment">* History:</span>
00508 <span class="comment">* 01-Dec-1991 Sanfords Created.</span>
00509 <span class="comment">\***************************************************************************/</span>
00510 
<a name="l00511"></a><a class="code" href="../../d6/d8/clinit_8c.html#a21">00511</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d4/ddemlcli_8h.html#a94">RW_RegisterDDEML</a>(VOID)
00512 {
00513     WNDCLASSEXA wndclsa;
00514     WNDCLASSEXW wndclsw;
00515     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00516 
00517     RtlZeroMemory(&amp;wndclsw, <span class="keyword">sizeof</span>(wndclsw));
00518     wndclsw.cbSize        = <span class="keyword">sizeof</span>(wndclsw);
00519     wndclsw.lpfnWndProc   = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a133">DDEMLMotherWndProc</a>;
00520     wndclsw.cbWndExtra    = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a>);
00521     wndclsw.hInstance     = <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>;
00522     wndclsw.lpszClassName = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLMom"</span>;
00523 
00524     fSuccess &amp;= !!<a class="code" href="../../d6/d0/usercli_8h.html#a636">RegisterClassExWOWW</a>(&amp;wndclsw, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a225">FNID_DDE_BIT</a>);
00525 
00526     RtlZeroMemory(&amp;wndclsa, <span class="keyword">sizeof</span>(wndclsa));
00527     wndclsa.cbSize        = <span class="keyword">sizeof</span>(wndclsa);
00528     wndclsa.lpfnWndProc   = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a134">DDEMLClientWndProc</a>;
00529     wndclsa.cbWndExtra    =
00530             <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>) +     <span class="comment">// GWL_PCI</span>
00531             <span class="keyword">sizeof</span>(CONVCONTEXT)   +     <span class="comment">// GWL_CONVCONTEXT</span>
00532             <span class="keyword">sizeof</span>(LONG)          +     <span class="comment">// GWL_CONVSTATE</span>
00533             <span class="keyword">sizeof</span>(HANDLE)        +     <span class="comment">// GWL_CHINST</span>
00534             <span class="keyword">sizeof</span>(HANDLE);             <span class="comment">// GWL_SHINST</span>
00535     wndclsa.hInstance     = <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>;
00536     wndclsa.lpszClassName = <span class="stringliteral">"DDEMLAnsiClient"</span>;
00537 
00538     fSuccess &amp;= !!<a class="code" href="../../d6/d0/usercli_8h.html#a635">RegisterClassExWOWA</a>(&amp;wndclsa, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a225">FNID_DDE_BIT</a>);
00539 
00540     wndclsw.cbSize        = <span class="keyword">sizeof</span>(wndclsw);
00541     wndclsw.lpfnWndProc   = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a134">DDEMLClientWndProc</a>;
00542     wndclsw.cbWndExtra    =
00543             <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>) +     <span class="comment">// GWL_PCI</span>
00544             <span class="keyword">sizeof</span>(CONVCONTEXT)   +     <span class="comment">// GWL_CONVCONTEXT</span>
00545             <span class="keyword">sizeof</span>(LONG)          +     <span class="comment">// GWL_CONVSTATE</span>
00546             <span class="keyword">sizeof</span>(HANDLE)        +     <span class="comment">// GWL_CHINST</span>
00547             <span class="keyword">sizeof</span>(HANDLE);             <span class="comment">// GWL_SHINST</span>
00548     wndclsw.hInstance     = <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>;
00549     wndclsw.lpszClassName = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLUnicodeClient"</span>;
00550 
00551     fSuccess &amp;= !!<a class="code" href="../../d6/d0/usercli_8h.html#a636">RegisterClassExWOWW</a>(&amp;wndclsw, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a225">FNID_DDE_BIT</a>);
00552 
00553     wndclsa.cbSize        = <span class="keyword">sizeof</span>(wndclsa);
00554     wndclsa.lpfnWndProc   = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a135">DDEMLServerWndProc</a>;
00555     wndclsa.cbWndExtra    = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>);     <span class="comment">// GWL_PSI</span>
00556     wndclsa.hInstance     = <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>;
00557     wndclsa.lpszClassName = <span class="stringliteral">"DDEMLAnsiServer"</span>;
00558 
00559     fSuccess &amp;= !!<a class="code" href="../../d6/d0/usercli_8h.html#a635">RegisterClassExWOWA</a>(&amp;wndclsa, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a225">FNID_DDE_BIT</a>);
00560 
00561     wndclsw.cbSize        = <span class="keyword">sizeof</span>(wndclsw);
00562     wndclsw.lpfnWndProc   = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a135">DDEMLServerWndProc</a>;
00563     wndclsw.cbWndExtra    = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>);     <span class="comment">// GWL_PSI</span>
00564     wndclsw.hInstance     = <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>;
00565     wndclsw.lpszClassName = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLUnicodeServer"</span>;
00566 
00567     fSuccess &amp;= !!<a class="code" href="../../d6/d0/usercli_8h.html#a636">RegisterClassExWOWW</a>(&amp;wndclsw, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a225">FNID_DDE_BIT</a>);
00568 
00569     <span class="keywordflow">if</span> (!fSuccess) {
00570         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RW_RegisterDDEML failed to register classes"</span>);
00571     }
00572 
00573     <span class="keywordflow">return</span> fSuccess;
00574 }
00575 
00576 <span class="comment">/***************************************************************************\</span>
00577 <span class="comment">* GetBadAppCmdLine()</span>
00578 <span class="comment">*</span>
00579 <span class="comment">*   This routine checks if the app specified by 'lpApplicationName'</span>
00580 <span class="comment">*   needs patching.</span>
00581 <span class="comment">*</span>
00582 <span class="comment">* Arguments:</span>
00583 <span class="comment">*</span>
00584 <span class="comment">*   lpApplicationName - contains the full path and application name</span>
00585 <span class="comment">*       for the binary that needs to be identified for patching</span>
00586 <span class="comment">*</span>
00587 <span class="comment">* Return Value:</span>
00588 <span class="comment">*</span>
00589 <span class="comment">*   Returns a pointer to the command line for the patch DLL.</span>
00590 <span class="comment">*</span>
00591 <span class="comment">*   NOTE: The caller needs to free the pointer returned by this function</span>
00592 <span class="comment">*</span>
00593 <span class="comment">* History:</span>
00594 <span class="comment">*</span>
00595 <span class="comment">* 27-Jul-1998  clupu   Created.</span>
00596 <span class="comment">\***************************************************************************/</span>
00597 LPSTR
<a name="l00598"></a><a class="code" href="../../d6/d8/clinit_8c.html#a22">00598</a> <a class="code" href="../../d6/d8/clinit_8c.html#a22">GetBadAppCmdLine</a>(
00599     IN LPCWSTR lpApplicationName)
00600 {
00601 
00602 <span class="preprocessor">#define DLLPATCH_NAME       L"DllPatch"</span>
00603 <span class="preprocessor"></span>
00604     UNICODE_STRING      strKeyPath;
00605     UNICODE_STRING      strDllPatchName;
00606     OBJECT_ATTRIBUTES   objA;
00607     WCHAR               strBuffer[256];
00608     WCHAR               strDllPatch[64];
00609     WCHAR               strName[32];
00610     HANDLE              hkey;
00611     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00612     WCHAR*              lpShortName;
00613     BADAPP_DATA         badAppData;
00614     BADAPP_PROP         badAppProp;
00615     ULONG               iValue, cbSize, cbCrtSize;
00616     LPSTR               pszCmdLine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00617     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                bRet;
00618     
00619     PKEY_VALUE_FULL_INFORMATION pKeyValueInformation;
00620 
00621 <span class="preprocessor">#if DBG</span>
00622 <span class="preprocessor"></span>    <span class="comment">/*</span>
00623 <span class="comment">     * Assert that there is at least one path separator</span>
00624 <span class="comment">     */</span>
00625     
00626     lpShortName = (LPWSTR)lpApplicationName;
00627     
00628     <span class="keywordflow">while</span> (*lpShortName != 0) {
00629         <span class="keywordflow">if</span> (*lpShortName == OBJ_NAME_PATH_SEPARATOR) {
00630             <span class="keywordflow">break</span>;
00631         }
00632         lpShortName++;
00633     }
00634 
00635     UserAssert(*lpShortName == OBJ_NAME_PATH_SEPARATOR);
00636 <span class="preprocessor">#endif // DBG</span>
00637 <span class="preprocessor"></span>
00638     <span class="comment">/*</span>
00639 <span class="comment">     * Get the short name of the file</span>
00640 <span class="comment">     */</span>
00641     lpShortName = (WCHAR*)lpApplicationName + wcslen(lpApplicationName) - 1;
00642 
00643     
00644     <span class="keywordflow">while</span> (*lpShortName != OBJ_NAME_PATH_SEPARATOR) {
00645         lpShortName--;
00646     }
00647 
00648     <span class="comment">/*</span>
00649 <span class="comment">     * Prepare the registry key</span>
00650 <span class="comment">     */</span>
00651     wcscpy(strBuffer,
00652            <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Session Manager\\AppCompatibility"</span>);
00653     
00654     wcscat(strBuffer, lpShortName);
00655     
00656     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strKeyPath, strBuffer);
00657     
00658     InitializeObjectAttributes(&amp;objA,
00659                                &amp;strKeyPath,
00660                                OBJ_CASE_INSENSITIVE,
00661                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00662                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00663     
00664     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkey, GENERIC_READ, &amp;objA);
00665 
00666     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00667         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00668     }
00669     
00670     <span class="comment">/*</span>
00671 <span class="comment">     * Now verify that this is the actual version of the app</span>
00672 <span class="comment">     */</span>
00673     
00674     pKeyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00675     cbCrtSize = 0;
00676 
00677     badAppProp.Size     = <span class="keyword">sizeof</span>(BADAPP_PROP);
00678     badAppData.Size     = <span class="keyword">sizeof</span>(BADAPP_DATA);
00679     badAppData.FilePath = (LPCWSTR)lpApplicationName;
00680 
00681     <span class="comment">/*</span>
00682 <span class="comment">     * Presume innocent</span>
00683 <span class="comment">     */</span>
00684     bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00685     
00686     <span class="keywordflow">for</span> (iValue = 0; ; iValue++) {
00687         
00688         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(hkey,
00689                                      iValue,
00690                                      KeyValueFullInformation,
00691                                      pKeyValueInformation,
00692                                      cbCrtSize,
00693                                      &amp;cbSize);
00694 
00695         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
00696             <span class="keywordflow">break</span>;
00697         }
00698 
00699         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ||
00700             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
00701             
00702             <span class="keywordflow">if</span> (pKeyValueInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00703                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, pKeyValueInformation);
00704             }
00705 
00706             pKeyValueInformation = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),
00707                                                    0,
00708                                                    cbSize);
00709 
00710             <span class="keywordflow">if</span> (pKeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00711                 
00712                 <span class="comment">/*</span>
00713 <span class="comment">                 * Print some memory allocation error message</span>
00714 <span class="comment">                 */</span>
00715                 TAGMSG0(DBGTAG_Shim, <span class="stringliteral">"Memory allocation error"</span>);
00716                 <span class="keywordflow">break</span>;
00717             }
00718             
00719             cbCrtSize = cbSize;
00720             
00721             <span class="comment">/*</span>
00722 <span class="comment">             * Enumerate the key again. This time it should have</span>
00723 <span class="comment">             * a big enough buffer.</span>
00724 <span class="comment">             */</span>
00725             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(hkey,
00726                                          iValue,
00727                                          KeyValueFullInformation,
00728                                          pKeyValueInformation,
00729                                          cbCrtSize,
00730                                          &amp;cbSize);
00731         
00732             UserAssert(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || (cbCrtSize == cbSize));
00733         }
00734 
00735 
00736         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; pKeyValueInformation-&gt;Type == REG_BINARY) {
00737             
00738             RtlCopyMemory(strName,
00739                           pKeyValueInformation-&gt;Name,
00740                           pKeyValueInformation-&gt;NameLength);
00741             
00742             strName[pKeyValueInformation-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR)] = 0;
00743             
00744             badAppData.Blob = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pKeyValueInformation + 
00745                               pKeyValueInformation-&gt;DataOffset;
00746             
00747             badAppData.BlobSize = pKeyValueInformation-&gt;DataLength;
00748 
00749             <span class="keywordflow">if</span> (SHIsBadApp(&amp;badAppData, &amp;badAppProp)) {
00750                 
00751                 TAGMSG0(DBGTAG_Shim, <span class="stringliteral">"SHIsBadApp returned TRUE"</span>);
00752                 
00753                 bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00754                 <span class="keywordflow">break</span>;
00755             } <span class="keywordflow">else</span> {
00756                 TAGMSG0(DBGTAG_Shim, <span class="stringliteral">"SHIsBadApp returned FALSE"</span>);
00757             }
00758         } <span class="keywordflow">else</span> {
00759             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00760                 TAGMSG1(DBGTAG_Shim, <span class="stringliteral">"failed reading key. Status 0x%x"</span>,
00761                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00762             }
00763         }
00764     }
00765 
00766     <span class="keywordflow">if</span> (pKeyValueInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00767         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, pKeyValueInformation);
00768         pKeyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00769     }
00770 
00771 
00772     <span class="keywordflow">if</span> (bRet) {
00773         
00774         <span class="comment">/*</span>
00775 <span class="comment">         * Read the REG_SZ for 'DllPatch-name'</span>
00776 <span class="comment">         */</span>
00777         wsprintf(strDllPatch, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws-%ws"</span>, <a class="code" href="../../d6/d8/clinit_8c.html#a0">DLLPATCH_NAME</a>, strName);
00778         
00779         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDllPatchName, strDllPatch);
00780 
00781         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hkey,
00782                                  &amp;strDllPatchName,
00783                                  KeyValueFullInformation,
00784                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00785                                  0,
00786                                  &amp;cbSize);
00787         
00788         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ||
00789             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
00790             
00791             LPWSTR pwszCmdLine;
00792             
00793             pKeyValueInformation = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),
00794                                                    0,
00795                                                    cbSize);
00796 
00797             <span class="keywordflow">if</span> (pKeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00798                 
00799                 <span class="comment">/*</span>
00800 <span class="comment">                 * Print some memory allocation error message</span>
00801 <span class="comment">                 */</span>
00802                 TAGMSG0(DBGTAG_Shim, <span class="stringliteral">"Memory allocation error"</span>);
00803                 <span class="keywordflow">goto</span> Exit;
00804             }
00805             
00806             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hkey,
00807                                      &amp;strDllPatchName,
00808                                      KeyValueFullInformation,
00809                                      pKeyValueInformation,
00810                                      cbSize,
00811                                      &amp;cbCrtSize);
00812             
00813             <span class="comment">/*</span>
00814 <span class="comment">             * Bail out if this is not of the type we expect</span>
00815 <span class="comment">             */</span>
00816             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || pKeyValueInformation-&gt;Type != REG_SZ) {
00817                 TAGMSG1(DBGTAG_Shim, <span class="stringliteral">"The key '%s' is not of REG_SZ type"</span>,
00818                         strDllPatch);
00819                 <span class="keywordflow">goto</span> Exit;
00820             }
00821 
00822             pwszCmdLine = (PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pKeyValueInformation +
00823                                    pKeyValueInformation-&gt;DataOffset +
00824                                    pKeyValueInformation-&gt;DataLength);
00825 
00826             <span class="comment">/*</span>
00827 <span class="comment">             * NULL terminate the string</span>
00828 <span class="comment">             */</span>
00829             *(pwszCmdLine - 1) = 0;
00830 
00831             pwszCmdLine = (LPWSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pKeyValueInformation +
00832                                    pKeyValueInformation-&gt;DataOffset);
00833             
00834             TAGMSG2(DBGTAG_Shim, <span class="stringliteral">"The app '%ws' has a patch DLL '%ws'"</span>,
00835                     lpApplicationName,
00836                     pwszCmdLine);
00837 
00838             cbSize = wcslen(pwszCmdLine);
00839 
00840             pszCmdLine = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),
00841                                          0,
00842                                          cbSize + 1);
00843             
00844             <span class="keywordflow">if</span> (pszCmdLine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00845                 TAGMSG0(DBGTAG_Shim, <span class="stringliteral">"Memory allocation error"</span>);
00846                 <span class="keywordflow">goto</span> Exit;
00847             }
00848             
00849             WideCharToMultiByte(CP_OEMCP,
00850                                 0,
00851                                 pwszCmdLine,
00852                                 cbSize + 1,
00853                                 pszCmdLine,
00854                                 cbSize + 1,
00855                                 (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00856                                 (LPBOOL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00857         }
00858     }
00859 
00860 Exit:    
00861     
00862     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkey);
00863     
00864     <span class="keywordflow">return</span> pszCmdLine;
00865 }
00866 
00867 <span class="comment">/***************************************************************************\</span>
00868 <span class="comment">* CheckBadApp()</span>
00869 <span class="comment">*</span>
00870 <span class="comment">* History:</span>
00871 <span class="comment">*</span>
00872 <span class="comment">* 27-Jul-1998  clupu   Created.</span>
00873 <span class="comment">\***************************************************************************/</span>
00874 
<a name="l00875"></a><a class="code" href="../../d6/d8/clinit_8c.html#a12">00875</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (*<a class="code" href="../../d6/d8/clinit_8c.html#a12">PFNLOADPATCHDLL</a>)(LPSTR pwszPatchDll);
00876 
<a name="l00877"></a><a class="code" href="../../d6/d8/clinit_8c.html#a23">00877</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d8/clinit_8c.html#a23">CheckBadApp</a>(VOID)
00878 {
00879     WCHAR           wszAppName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00880     <a class="code" href="../../d6/d8/clinit_8c.html#a12">PFNLOADPATCHDLL</a> pfnLoadPatchDll;
00881     LPSTR           pszCmdLine;
00882     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            bRet;
00883     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwSize;
00884     HMODULE         hMod;
00885 
00886     dwSize = GetModuleFileNameW(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, wszAppName, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00887 
00888     UserAssert(dwSize &gt; 0);
00889     
00890     pszCmdLine = <a class="code" href="../../d6/d8/clinit_8c.html#a22">GetBadAppCmdLine</a>(wszAppName);
00891 
00892     <span class="keywordflow">if</span> (pszCmdLine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00893         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00894     }
00895     
00896     <span class="keywordflow">if</span> ( _stricmp( pszCmdLine, <span class="stringliteral">"disable"</span> ) == 0 ) {
00897        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00898     }
00899 
00900     hMod = LoadLibraryW(<a class="code" href="../../d6/d8/clinit_8c.html#a7">gwszShimDll</a>);
00901 
00902     <span class="keywordflow">if</span> (hMod == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00903         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Couldn't load SHIM.DLL"</span>);
00904         <span class="keywordflow">goto</span> Exit;
00905     }
00906     pfnLoadPatchDll = (<a class="code" href="../../d6/d8/clinit_8c.html#a12">PFNLOADPATCHDLL</a>)GetProcAddress(hMod, <a class="code" href="../../d6/d8/clinit_8c.html#a8">gszLoadPathDll</a>);
00907 
00908     <span class="keywordflow">if</span> (pfnLoadPatchDll == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00909         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Couldn't find '%s' in SHIM.DLL"</span>,
00910                 <a class="code" href="../../d6/d8/clinit_8c.html#a8">gszLoadPathDll</a>);
00911         
00912         FreeLibrary(hMod);
00913         <span class="keywordflow">goto</span> Exit;
00914     }
00915 
00916     bRet = (*pfnLoadPatchDll)(pszCmdLine);
00917 
00918     UserAssert(bRet);
00919 
00920 Exit:
00921     
00922     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, pszCmdLine);
00923     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00924 }
00925 
00926 <span class="comment">/***************************************************************************\</span>
00927 <span class="comment">* LoadAppDlls()</span>
00928 <span class="comment">*</span>
00929 <span class="comment">* History:</span>
00930 <span class="comment">*</span>
00931 <span class="comment">* 10-Apr-1992  sanfords   Birthed.</span>
00932 <span class="comment">\***************************************************************************/</span>
<a name="l00933"></a><a class="code" href="../../d6/d8/clinit_8c.html#a24">00933</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/clinit_8c.html#a24">LoadAppDlls</a>(VOID)
00934 {
00935     <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a18">gfLogonProcess</a>;
00936     UNICODE_STRING UnicodeString;
00937     OBJECT_ATTRIBUTES ObjA;
00938     HKEY hKeyWindows;
00939     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00940     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
00941     <span class="keyword">struct </span>{
00942         KEY_VALUE_PARTIAL_INFORMATION KeyInfo;
00943         WCHAR awch[24];
00944     } KeyFile;
00945     PKEY_VALUE_PARTIAL_INFORMATION  lpKeyFile = (PKEY_VALUE_PARTIAL_INFORMATION)&amp;KeyFile;
00946     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSizeCurrent = <span class="keyword">sizeof</span>(KeyFile);
00947     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAlloc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00948 
00949     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/client_8c.html#a18">gfLogonProcess</a> || <a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a>) {
00950 
00951         <span class="comment">/*</span>
00952 <span class="comment">         * Don't let the logon process load appdlls because if the dll</span>
00953 <span class="comment">         * sets any hooks or creates any windows, the logon process</span>
00954 <span class="comment">         * will fail SetThreadDesktop().  This hack fixes that. (SAS)</span>
00955 <span class="comment">         */</span>
00956         <span class="keywordflow">return</span>;
00957     }
00958 
00959     <span class="comment">/*</span>
00960 <span class="comment">     * If the image is an NT Native image, we are running in the</span>
00961 <span class="comment">     * context of the server.</span>
00962 <span class="comment">     */</span>
00963     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress)-&gt;
00964         OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_NATIVE) {
00965         <span class="keywordflow">return</span>;
00966     }
00967 
00968     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d6/d8/clinit_8c.html#a5">pwszWindowsKey</a>);
00969     InitializeObjectAttributes(&amp;ObjA,
00970             &amp;UnicodeString,
00971             OBJ_CASE_INSENSITIVE,
00972             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00973             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00974 
00975 
00976     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKeyWindows,
00977                     KEY_READ,
00978                     &amp;ObjA);
00979 
00980 
00981     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00982         <span class="keywordflow">return</span>;
00983 
00984     <span class="comment">/*</span>
00985 <span class="comment">     * Read the "AppInit_Dlls" value.</span>
00986 <span class="comment">     */</span>
00987     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d6/d8/clinit_8c.html#a6">szAppInit</a>);
00988 
00989     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00990         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKeyWindows,
00991             &amp;UnicodeString,
00992             KeyValuePartialInformation,
00993             lpKeyFile,
00994             cbSizeCurrent,
00995             &amp;cbSize);
00996 
00997         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
00998             <span class="keywordflow">if</span> (bAlloc) {
00999                 <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(lpKeyFile);
01000             }
01001             lpKeyFile = GlobalAlloc(LPTR, cbSize);
01002             <span class="keywordflow">if</span> (!lpKeyFile) {
01003                 RIPERR0(ERROR_OUTOFMEMORY,
01004                     RIP_WARNING,
01005                     <span class="stringliteral">"LoadAppDlls failed"</span>);
01006                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKeyWindows);
01007                 <span class="keywordflow">return</span>;
01008             }
01009             bAlloc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01010             cbSizeCurrent = cbSize;
01011             <span class="keywordflow">continue</span>;
01012         }
01013         <span class="keywordflow">break</span>;
01014     }
01015     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01016         LPWSTR pszSrc;
01017         LPWSTR pszDst;
01018         LPWSTR pszBase;
01019         WCHAR  ch;
01020 
01021     <span class="comment">/*</span>
01022 <span class="comment">     * Process the DLL data.</span>
01023 <span class="comment">     */</span>
01024         pszBase = pszDst = pszSrc = (LPWSTR)lpKeyFile-&gt;Data;
01025         <span class="keywordflow">while</span> (*pszSrc != TEXT(<span class="charliteral">'\0'</span>)) {
01026 
01027             <span class="keywordflow">while</span> (*pszSrc == TEXT(<span class="charliteral">' '</span>) || *pszSrc  == TEXT(<span class="charliteral">','</span>))
01028                 pszSrc++;
01029 
01030             <span class="keywordflow">if</span> (*pszSrc == TEXT(<span class="charliteral">'\0'</span>))
01031                 <span class="keywordflow">break</span>;
01032 
01033             <span class="keywordflow">while</span> (*pszSrc != TEXT(<span class="charliteral">','</span>)  &amp;&amp;
01034                    *pszSrc != TEXT(<span class="charliteral">'\0'</span>) &amp;&amp;
01035                    *pszSrc != TEXT(<span class="charliteral">' '</span>)) {
01036                 *pszDst++ = *pszSrc++;
01037             }
01038 
01039             ch = *pszSrc;               <span class="comment">// get it here cuz its being done in-place.</span>
01040             *pszDst++ = TEXT(<span class="charliteral">'\0'</span>);     <span class="comment">// '\0' is dll name delimiter</span>
01041 
01042             LoadLibrary(pszBase);
01043             pszBase = pszDst;
01044 
01045             pszSrc++;
01046 
01047             <span class="keywordflow">if</span> (ch == TEXT(<span class="charliteral">'\0'</span>))
01048                 <span class="keywordflow">break</span>;
01049         }
01050 
01051     }
01052 
01053 
01054     <span class="keywordflow">if</span> (bAlloc) {
01055         <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(lpKeyFile);
01056     }
01057     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKeyWindows);
01058 
01059 }
01060 
01061 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01062"></a><a class="code" href="../../d6/d8/clinit_8c.html#a25">01062</a> <a class="code" href="../../d6/d8/clinit_8c.html#a25">InitOemXlateTables</a>()
01063 {
01064     <span class="keywordtype">char</span> ach[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>];
01065     WCHAR awch[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>];
01066     WCHAR awchCtrl[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a363">NCTRLS</a>];
01067     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
01068     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cch;
01069     <span class="keywordtype">char</span> OemToAnsi[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>];
01070     <span class="keywordtype">char</span> AnsiToOem[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>];
01071 
01072     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>; i++) {
01073         ach[i] = (<span class="keywordtype">char</span>)i;
01074     }
01075 
01076     <span class="comment">/*</span>
01077 <span class="comment">     * First generate pAnsiToOem table.</span>
01078 <span class="comment">     */</span>
01079 
01080     <span class="keywordflow">if</span> (GetOEMCP() == GetACP()) {
01081         <span class="comment">/*</span>
01082 <span class="comment">         * For far east code pages using MultiByteToWideChar below</span>
01083 <span class="comment">         * won't work.  Conveniently for these code pages the OEM</span>
01084 <span class="comment">         * CP equals the ANSI codepage making it trivial to compute</span>
01085 <span class="comment">         * pOemToAnsi and pAnsiToOem arrays</span>
01086 <span class="comment">         *</span>
01087 <span class="comment">         */</span>
01088 
01089         RtlCopyMemory(OemToAnsi, ach, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>);
01090         RtlCopyMemory(AnsiToOem, ach, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>);
01091 
01092     }
01093     <span class="keywordflow">else</span>
01094     {
01095         cch = MultiByteToWideChar(
01096             CP_ACP,                           <span class="comment">// ANSI -&gt; Unicode</span>
01097             MB_PRECOMPOSED,                   <span class="comment">// map to precomposed</span>
01098             ach, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>,                      <span class="comment">// source &amp; length</span>
01099             awch, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>);                    <span class="comment">// destination &amp; length</span>
01100 
01101         UserAssert(cch == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>);
01102 
01103         WideCharToMultiByte(
01104             CP_OEMCP,                         <span class="comment">// Unicode -&gt; OEM</span>
01105             0,                                <span class="comment">// gives best visual match</span>
01106             awch, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>,                     <span class="comment">// source &amp; length</span>
01107             AnsiToOem, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>,               <span class="comment">// dest &amp; max poss. length</span>
01108             <span class="stringliteral">"_"</span>,                              <span class="comment">// default char</span>
01109             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);                            <span class="comment">// (don't care whether defaulted)</span>
01110         <span class="comment">/*</span>
01111 <span class="comment">         * Now generate pOemToAnsi table.</span>
01112 <span class="comment">         */</span>
01113         cch = MultiByteToWideChar(
01114             CP_OEMCP,                         <span class="comment">// OEM -&gt; Unicode</span>
01115             MB_PRECOMPOSED | MB_USEGLYPHCHARS,<span class="comment">// visual map to precomposed</span>
01116             ach, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>,                      <span class="comment">// source &amp; length</span>
01117             awch, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>);                    <span class="comment">// destination</span>
01118 
01119         UserAssert(cch == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>);
01120 
01121         <span class="comment">/*</span>
01122 <span class="comment">         * Now patch special cases for Win3.1 compatibility</span>
01123 <span class="comment">         *</span>
01124 <span class="comment">         * 0x07 BULLET              (glyph 0x2022) must become 0x0007 BELL</span>
01125 <span class="comment">         * 0x0F WHITE STAR WITH SUN (glyph 0x263C) must become 0x00A4 CURRENCY SIGN</span>
01126 <span class="comment">         * 0x7F HOUSE               (glyph 0x2302) must become 0x007f DELETE</span>
01127 <span class="comment">         */</span>
01128         awch[0x07] = 0x0007;
01129         awch[0x0F] = 0x00a4;
01130         awch[0x7f] = 0x007f;
01131 
01132         WideCharToMultiByte(
01133             CP_ACP,                           <span class="comment">// Unicode -&gt; ANSI</span>
01134             0,                                <span class="comment">// gives best visual match</span>
01135             awch, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>,                     <span class="comment">// source &amp; length</span>
01136             OemToAnsi, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>,               <span class="comment">// dest &amp; max poss. length</span>
01137             <span class="stringliteral">"_"</span>,                              <span class="comment">// default char</span>
01138             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);                            <span class="comment">// (don't care whether defaulted)</span>
01139 
01140         <span class="comment">/*</span>
01141 <span class="comment">         * Now for all OEM chars &lt; 0x20 (control chars), test whether the glyph</span>
01142 <span class="comment">         * we have is really in CP_ACP or not.  If not, then restore the</span>
01143 <span class="comment">         * original control character. Note: 0x00 remains 0x00.</span>
01144 <span class="comment">         */</span>
01145         MultiByteToWideChar(CP_ACP, 0, OemToAnsi, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a363">NCTRLS</a>, awchCtrl, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a363">NCTRLS</a>);
01146 
01147         <span class="keywordflow">for</span> (i = 1; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a363">NCTRLS</a>; i++) {
01148             <span class="keywordflow">if</span> (awchCtrl[i] != awch[i]) {
01149                 OemToAnsi[i] = (<span class="keywordtype">char</span>)i;
01150             }
01151         }
01152     }
01153     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>((ULONG_PTR)OemToAnsi, (ULONG_PTR)AnsiToOem, SFI_INITANSIOEM);
01154 }
01155 
<a name="l01156"></a><a class="code" href="../../d6/d8/clinit_8c.html#a13">01156</a> <span class="keyword">const</span> <a class="code" href="../../d0/d5/struct__PFNCLIENT.html">PFNCLIENT</a>   <a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a> = {
01157         (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a17">ScrollBarWndProcA</a>,
01158         (KPROC)DefWindowProcA,
01159         (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a14">MenuWndProcA</a>,
01160         (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a11">DesktopWndProcA</a>,
01161         (KPROC)DefWindowProcA,
01162         (KPROC)<a class="code" href="../../d8/d1/btnctl_8c.html#a33">ButtonWndProcA</a>,
01163         (KPROC)<a class="code" href="../../d1/d4/combo_8c.html#a8">ComboBoxWndProcA</a>,
01164         (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a4">ComboListBoxWndProcA</a>,
01165         (KPROC)<a class="code" href="../../d3/d9/dlgmgr_8c.html#a19">DefDlgProcA</a>,
01166         (KPROC)<a class="code" href="../../d8/d4/editec_8c.html#a42">EditWndProcA</a>,
01167         (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a2">ListBoxWndProcA</a>,
01168         (KPROC)<a class="code" href="../../d6/d5/mdiwin_8c.html#a30">MDIClientWndProcA</a>,
01169         (KPROC)<a class="code" href="../../d5/d5/statctl_8c.html#a21">StaticWndProcA</a>,
01170         (KPROC)<a class="code" href="../../d9/d9/imectl_8c.html#a32">ImeWndProcA</a>,
01171         (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a569">fnHkINLPCWPSTRUCTA</a>,
01172         (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a571">fnHkINLPCWPRETSTRUCTA</a>,
01173         (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a573">DispatchHookA</a>,
01174         (KPROC)<a class="code" href="../../d3/d8/client_8c.html#a87">DispatchClientMessage</a>,
01175         (KPROC)<a class="code" href="../../d6/d4/msgbox_8c.html#a32">MB_DlgProcA</a>,
01176         (KPROC)<a class="code" href="../../d5/d5/mdimenu_8c.html#a13">MDIActivateDlgProcA</a>};
01177 
<a name="l01178"></a><a class="code" href="../../d6/d8/clinit_8c.html#a14">01178</a> <span class="keyword">const</span>   <a class="code" href="../../d0/d5/struct__PFNCLIENT.html">PFNCLIENT</a>   <a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a> = {
01179         (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a18">ScrollBarWndProcW</a>,
01180         (KPROC)DefWindowProcW,
01181         (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a15">MenuWndProcW</a>,
01182         (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a12">DesktopWndProcW</a>,
01183         (KPROC)DefWindowProcW,
01184         (KPROC)<a class="code" href="../../d8/d1/btnctl_8c.html#a34">ButtonWndProcW</a>,
01185         (KPROC)<a class="code" href="../../d1/d4/combo_8c.html#a9">ComboBoxWndProcW</a>,
01186         (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a5">ComboListBoxWndProcW</a>,
01187         (KPROC)<a class="code" href="../../d3/d9/dlgmgr_8c.html#a18">DefDlgProcW</a>,
01188         (KPROC)<a class="code" href="../../d8/d4/editec_8c.html#a43">EditWndProcW</a>,
01189         (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a3">ListBoxWndProcW</a>,
01190         (KPROC)<a class="code" href="../../d6/d5/mdiwin_8c.html#a31">MDIClientWndProcW</a>,
01191         (KPROC)<a class="code" href="../../d5/d5/statctl_8c.html#a22">StaticWndProcW</a>,
01192         (KPROC)<a class="code" href="../../d9/d9/imectl_8c.html#a33">ImeWndProcW</a>,
01193         (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a568">fnHkINLPCWPSTRUCTW</a>,
01194         (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a570">fnHkINLPCWPRETSTRUCTW</a>,
01195         (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a572">DispatchHookW</a>,
01196         (KPROC)<a class="code" href="../../d3/d8/client_8c.html#a87">DispatchClientMessage</a>,
01197         (KPROC)<a class="code" href="../../d6/d4/msgbox_8c.html#a33">MB_DlgProcW</a>,
01198         (KPROC)<a class="code" href="../../d5/d5/mdimenu_8c.html#a14">MDIActivateDlgProcW</a>};
01199 
<a name="l01200"></a><a class="code" href="../../d6/d8/clinit_8c.html#a15">01200</a> <span class="keyword">const</span> <a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html">PFNCLIENTWORKER</a>   <a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a> = {
01201         (KPROC)<a class="code" href="../../d8/d1/btnctl_8c.html#a32">ButtonWndProcWorker</a>,
01202         (KPROC)<a class="code" href="../../d1/d4/combo_8c.html#a7">ComboBoxWndProcWorker</a>,
01203         (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a1">ListBoxWndProcWorker</a>,
01204         (KPROC)<a class="code" href="../../d3/d9/dlgmgr_8c.html#a17">DefDlgProcWorker</a>,
01205         (KPROC)<a class="code" href="../../d8/d4/editec_8c.html#a44">EditWndProcWorker</a>,
01206         (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a1">ListBoxWndProcWorker</a>,
01207         (KPROC)<a class="code" href="../../d6/d5/mdiwin_8c.html#a29">MDIClientWndProcWorker</a>,
01208         (KPROC)<a class="code" href="../../d5/d5/statctl_8c.html#a20">StaticWndProcWorker</a>,
01209         (KPROC)<a class="code" href="../../d9/d9/imectl_8c.html#a31">ImeWndProcWorker</a>};
01210 
01211 
01212 <span class="comment">/***************************************************************************\</span>
01213 <span class="comment">* ClientThreadSetup</span>
01214 <span class="comment">*</span>
01215 <span class="comment">*</span>
01216 <span class="comment">*</span>
01217 <span class="comment">\***************************************************************************/</span>
01218 
<a name="l01219"></a><a class="code" href="../../d4/d1/userk_8h.html#a1927">01219</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1927">ClientThreadSetup</a>(VOID)
01220 {
01221     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
01222     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fFirstThread;
01223     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       ConnectState;
01224 
01225 <span class="preprocessor">#ifdef TRACE_THREAD_INIT</span>
01226 <span class="preprocessor"></span>    KdPrint((<span class="stringliteral">"USER32: ClientThreadSetup (pteb: %#p)\n"</span>, NtCurrentTeb()));
01227 <span class="preprocessor">#endif</span>
01228 <span class="preprocessor"></span>
01229     <span class="comment">/*</span>
01230 <span class="comment">     * BUG 268642: Only the first thread calls GdiProcessSetup but all the other</span>
01231 <span class="comment">     * threads must wait until the setup for GDI is finished.</span>
01232 <span class="comment">     *</span>
01233 <span class="comment">     * We can safely use gcsAccelCache critical section to protect this (even</span>
01234 <span class="comment">     * though the name is not intuitive at all)</span>
01235 <span class="comment">     */</span>
01236 
01237     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
01238 
01239     fFirstThread = <a class="code" href="../../d6/d8/clinit_8c.html#a1">gfFirstThread</a>;
01240 
01241     <span class="comment">/*</span>
01242 <span class="comment">     * setup GDI before continuing</span>
01243 <span class="comment">     */</span>
01244     <span class="keywordflow">if</span> (fFirstThread) {
01245         <a class="code" href="../../d6/d8/clinit_8c.html#a1">gfFirstThread</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01246         <a class="code" href="../../d6/d8/clinit_8c.html#a16">GdiProcessSetup</a>();
01247     }
01248 
01249     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a25">gcsAccelCache</a>);
01250 
01251     <span class="comment">/*</span>
01252 <span class="comment">     * We've already checked to see if we need to connect</span>
01253 <span class="comment">     * (i.e. NtCurrentTeb()-&gt;Win32ThreadInfo == NULL)  This routine</span>
01254 <span class="comment">     * just does the connecting.  If we've already been through here</span>
01255 <span class="comment">     * once, don't do it again.</span>
01256 <span class="comment">     */</span>
01257     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
01258     <span class="keywordflow">if</span> (pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a115">CI_INITIALIZED</a>) {
01259         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Already initialized!"</span>);
01260         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01261     }
01262 
01263     <span class="comment">/*</span>
01264 <span class="comment">     * Create the queue info and thread info. Only once for this process do</span>
01265 <span class="comment">     * we pass client side addresses to the server (for server callbacks).</span>
01266 <span class="comment">     */</span>
01267     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a> &amp;&amp; fFirstThread) {
01268 
01269         <a class="code" href="../../d6/d4/struct__USERCONNECT.html">USERCONNECT</a> userconnect;
01270         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01271 
01272         <span class="comment">/*</span>
01273 <span class="comment">         * We know that the shared info is now available in</span>
01274 <span class="comment">         * the kernel.  Map it into the server process.</span>
01275 <span class="comment">         */</span>
01276         userconnect.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o0">ulVersion</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a409">USERCURRENTVERSION</a>;
01277         userconnect.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o2">dwDispatchCount</a> = <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a11">gDispatchTableValues</a>;
01278         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a84">NtUserProcessConnect</a>(NtCurrentProcess(),
01279                                       &amp;userconnect,
01280                                       <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__USERCONNECT.html">USERCONNECT</a>));
01281         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
01282             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01283 
01284         <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a> = userconnect.<a class="code" href="../../d6/d4/struct__USERCONNECT.html#o3">siClient</a>;
01285         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o0">psi</a>;
01286         UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>);
01287 
01288         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o0">pfnScrollBarWndProc</a>   == (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a17">ScrollBarWndProcA</a>);
01289         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o1">pfnTitleWndProc</a>       == (KPROC)DefWindowProcA);
01290         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o2">pfnMenuWndProc</a>        == (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a14">MenuWndProcA</a>);
01291         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o3">pfnDesktopWndProc</a>     == (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a11">DesktopWndProcA</a>);
01292         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o4">pfnDefWindowProc</a>      == (KPROC)DefWindowProcA);
01293         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o14">pfnHkINLPCWPSTRUCT</a>    == (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a569">fnHkINLPCWPSTRUCTA</a>);
01294         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o15">pfnHkINLPCWPRETSTRUCT</a> == (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a571">fnHkINLPCWPRETSTRUCTA</a>);
01295         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o5">pfnButtonWndProc</a>      == (KPROC)<a class="code" href="../../d8/d1/btnctl_8c.html#a33">ButtonWndProcA</a>);
01296         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o6">pfnComboBoxWndProc</a>    == (KPROC)<a class="code" href="../../d1/d4/combo_8c.html#a8">ComboBoxWndProcA</a>);
01297         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o7">pfnComboListBoxProc</a>   == (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a4">ComboListBoxWndProcA</a>);
01298         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o8">pfnDialogWndProc</a>      == (KPROC)<a class="code" href="../../d3/d9/dlgmgr_8c.html#a19">DefDlgProcA</a>);
01299         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o9">pfnEditWndProc</a>        == (KPROC)<a class="code" href="../../d8/d4/editec_8c.html#a42">EditWndProcA</a>);
01300         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o10">pfnListBoxWndProc</a>     == (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a2">ListBoxWndProcA</a>);
01301         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o18">pfnMB_DlgProc</a>         == (KPROC)<a class="code" href="../../d6/d4/msgbox_8c.html#a32">MB_DlgProcA</a>);
01302         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o19">pfnMDIActivateDlgProc</a> == (KPROC)<a class="code" href="../../d5/d5/mdimenu_8c.html#a13">MDIActivateDlgProcA</a>);
01303         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o11">pfnMDIClientWndProc</a>   == (KPROC)<a class="code" href="../../d6/d5/mdiwin_8c.html#a30">MDIClientWndProcA</a>);
01304         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o12">pfnStaticWndProc</a>      == (KPROC)<a class="code" href="../../d5/d5/statctl_8c.html#a21">StaticWndProcA</a>);
01305         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>       == (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a573">DispatchHookA</a>);
01306         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o17">pfnDispatchMessage</a>    == (KPROC)<a class="code" href="../../d3/d8/client_8c.html#a87">DispatchClientMessage</a>);
01307         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o13">pfnImeWndProc</a>         == (KPROC)<a class="code" href="../../d9/d9/imectl_8c.html#a32">ImeWndProcA</a>);
01308 
01309         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o0">pfnScrollBarWndProc</a>   == (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a18">ScrollBarWndProcW</a>);
01310         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o1">pfnTitleWndProc</a>       == (KPROC)DefWindowProcW);
01311         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o2">pfnMenuWndProc</a>        == (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a15">MenuWndProcW</a>);
01312         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o3">pfnDesktopWndProc</a>     == (KPROC)<a class="code" href="../../d0/d9/clmsg_8c.html#a12">DesktopWndProcW</a>);
01313         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o4">pfnDefWindowProc</a>      == (KPROC)DefWindowProcW);
01314         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o14">pfnHkINLPCWPSTRUCT</a>    == (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a568">fnHkINLPCWPSTRUCTW</a>);
01315         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o15">pfnHkINLPCWPRETSTRUCT</a> == (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a570">fnHkINLPCWPRETSTRUCTW</a>);
01316         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o5">pfnButtonWndProc</a>      == (KPROC)<a class="code" href="../../d8/d1/btnctl_8c.html#a34">ButtonWndProcW</a>);
01317         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o6">pfnComboBoxWndProc</a>    == (KPROC)<a class="code" href="../../d1/d4/combo_8c.html#a9">ComboBoxWndProcW</a>);
01318         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o7">pfnComboListBoxProc</a>   == (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a5">ComboListBoxWndProcW</a>);
01319         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o8">pfnDialogWndProc</a>      == (KPROC)<a class="code" href="../../d3/d9/dlgmgr_8c.html#a18">DefDlgProcW</a>);
01320         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o9">pfnEditWndProc</a>        == (KPROC)<a class="code" href="../../d8/d4/editec_8c.html#a43">EditWndProcW</a>);
01321         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o10">pfnListBoxWndProc</a>     == (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a3">ListBoxWndProcW</a>);
01322         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o18">pfnMB_DlgProc</a>         == (KPROC)<a class="code" href="../../d6/d4/msgbox_8c.html#a33">MB_DlgProcW</a>);
01323         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o19">pfnMDIActivateDlgProc</a> == (KPROC)<a class="code" href="../../d5/d5/mdimenu_8c.html#a14">MDIActivateDlgProcW</a>);
01324         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o11">pfnMDIClientWndProc</a>   == (KPROC)<a class="code" href="../../d6/d5/mdiwin_8c.html#a31">MDIClientWndProcW</a>);
01325         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o12">pfnStaticWndProc</a>      == (KPROC)<a class="code" href="../../d5/d5/statctl_8c.html#a22">StaticWndProcW</a>);
01326         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o16">pfnDispatchHook</a>       == (KPROC)<a class="code" href="../../d6/d0/usercli_8h.html#a572">DispatchHookW</a>);
01327         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o17">pfnDispatchMessage</a>    == (KPROC)<a class="code" href="../../d3/d8/client_8c.html#a87">DispatchClientMessage</a>);
01328         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o13">pfnImeWndProc</a>         == (KPROC)<a class="code" href="../../d9/d9/imectl_8c.html#a33">ImeWndProcW</a>);
01329 
01330         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>.<a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html#o0">pfnButtonWndProc</a>      == (KPROC)<a class="code" href="../../d8/d1/btnctl_8c.html#a32">ButtonWndProcWorker</a>);
01331         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>.<a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html#o1">pfnComboBoxWndProc</a>    == (KPROC)<a class="code" href="../../d1/d4/combo_8c.html#a7">ComboBoxWndProcWorker</a>);
01332         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>.<a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html#o2">pfnComboListBoxProc</a>   == (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a1">ListBoxWndProcWorker</a>);
01333         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>.<a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html#o3">pfnDialogWndProc</a>      == (KPROC)<a class="code" href="../../d3/d9/dlgmgr_8c.html#a17">DefDlgProcWorker</a>);
01334         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>.<a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html#o4">pfnEditWndProc</a>        == (KPROC)<a class="code" href="../../d8/d4/editec_8c.html#a44">EditWndProcWorker</a>);
01335         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>.<a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html#o5">pfnListBoxWndProc</a>     == (KPROC)<a class="code" href="../../d6/d1/lb1_8c.html#a1">ListBoxWndProcWorker</a>);
01336         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>.<a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html#o6">pfnMDIClientWndProc</a>   == (KPROC)<a class="code" href="../../d6/d5/mdiwin_8c.html#a29">MDIClientWndProcWorker</a>);
01337         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>.<a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html#o7">pfnStaticWndProc</a>      == (KPROC)<a class="code" href="../../d5/d5/statctl_8c.html#a20">StaticWndProcWorker</a>);
01338         UserAssert(<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>.<a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html#o8">pfnImeWndProc</a>         == (KPROC)<a class="code" href="../../d9/d9/imectl_8c.html#a31">ImeWndProcWorker</a>);
01339 
01340 <span class="preprocessor">#if DBG</span>
01341 <span class="preprocessor"></span>        {
01342             PULONG_PTR pdw;
01343 
01344             <span class="comment">/*</span>
01345 <span class="comment">             * Make sure that everyone got initialized</span>
01346 <span class="comment">             */</span>
01347             <span class="keywordflow">for</span> (pdw = (PULONG_PTR)&amp;<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>;
01348                  (ULONG_PTR)pdw&lt;(ULONG_PTR)(&amp;<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>);
01349                  pdw++) {
01350                 UserAssert(*pdw);
01351             }
01352 
01353             <span class="keywordflow">for</span> (pdw = (PULONG_PTR)&amp;<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>;
01354                  (ULONG_PTR)pdw&lt;(ULONG_PTR)(&amp;<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>);
01355                  pdw++) {
01356                 UserAssert(*pdw);
01357             }
01358         }
01359 <span class="preprocessor">#endif</span>
01360 <span class="preprocessor"></span>
01361 <span class="preprocessor">#if DBG</span>
01362 <span class="preprocessor"></span>    {
01363         <span class="keyword">extern</span> CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> gcapfnScSendMessage;
01364         BOOLEAN apfnCheckMessage[64];
01365         <span class="keywordtype">int</span> i;
01366 
01367         <span class="comment">/*</span>
01368 <span class="comment">         * Do some verification of the message table. Since we only have</span>
01369 <span class="comment">         * 6 bits to store the function index, the function table can have</span>
01370 <span class="comment">         * at most 64 entries. Also verify that none of the indexes point</span>
01371 <span class="comment">         * past the end of the table and that all the function entries</span>
01372 <span class="comment">         * are used.</span>
01373 <span class="comment">         */</span>
01374         UserAssert(gcapfnScSendMessage &lt;= 64);
01375         RtlZeroMemory(apfnCheckMessage, <span class="keyword">sizeof</span>(apfnCheckMessage));
01376         <span class="keywordflow">for</span> (i = 0; i &lt; WM_USER; i++) {
01377             UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[i].iFunction &lt; gcapfnScSendMessage);
01378             apfnCheckMessage[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1144">MessageTable</a>[i].<a class="code" href="../../d6/d2/structtagMSG__TABLE__ENTRY.html#o0">iFunction</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01379         }
01380 
01381         <span class="keywordflow">for</span> (i = 0; i &lt; gcapfnScSendMessage; i++) {
01382             UserAssert(apfnCheckMessage[i]);
01383         }
01384     }
01385 <span class="preprocessor">#endif</span>
01386 <span class="preprocessor"></span>
01387     }
01388 
01389     <span class="comment">/*</span>
01390 <span class="comment">     * Pass the function pointer arrays to the kernel.  This also establishes</span>
01391 <span class="comment">     * the kernel state for the thread.  If ClientThreadSetup is called from</span>
01392 <span class="comment">     * CsrConnectToUser this call will raise an exception if the thread</span>
01393 <span class="comment">     * cannot be converted to a gui thread.  The exception is handled in</span>
01394 <span class="comment">     * CsrConnectToUser.</span>
01395 <span class="comment">     */</span>
01396 <span class="preprocessor">#if DBG &amp;&amp; !defined(BUILD_WOW6432)</span>
01397 <span class="preprocessor"></span>    <span class="comment">/*</span>
01398 <span class="comment">     * On debug systems, go to the kernel for all processes to verify we're</span>
01399 <span class="comment">     * loading user32.dll at the right address.</span>
01400 <span class="comment">     */</span>
01401     <span class="keywordflow">if</span> (fFirstThread) {
01402 <span class="preprocessor">#elif defined(BUILD_WOW6432)</span>
01403 <span class="preprocessor"></span>    <span class="comment">/*</span>
01404 <span class="comment">     * On WOW64 allways register the client fns</span>
01405 <span class="comment">     */</span>
01406     {
01407 <span class="preprocessor">#else</span>
01408 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a> &amp;&amp; fFirstThread) {
01409 <span class="preprocessor">#endif</span>
01410 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a102">NtUserInitializeClientPfnArrays</a>(&amp;<a class="code" href="../../d6/d8/clinit_8c.html#a13">pfnClientA</a>, &amp;<a class="code" href="../../d6/d8/clinit_8c.html#a14">pfnClientW</a>, &amp;<a class="code" href="../../d6/d8/clinit_8c.html#a15">pfnClientWorker</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>))) {
01411 
01412             RIPERR0(ERROR_OUTOFMEMORY,
01413                     RIP_WARNING,
01414                     <span class="stringliteral">"NtUserInitializeClientPfnArrays failed"</span>);
01415 
01416             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01417         }
01418     }
01419 
01420     <span class="comment">/*</span>
01421 <span class="comment">     * Mark this thread as being initialized.  If the connection to</span>
01422 <span class="comment">     * the server fails, NtCurrentTeb()-&gt;Win32ThreadInfo will remain</span>
01423 <span class="comment">     * NULL.</span>
01424 <span class="comment">     */</span>
01425     pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a115">CI_INITIALIZED</a>;
01426 
01427     <span class="comment">/*</span>
01428 <span class="comment">     * Some initialization only has to occur once per process</span>
01429 <span class="comment">     */</span>
01430     <span class="keywordflow">if</span> (fFirstThread) {
01431 
01432         ConnectState = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_REMOTECONNECTSTATE);
01433 
01434         <span class="comment">/*</span>
01435 <span class="comment">         * Winstation Winlogon and CSR must do graphics initialization</span>
01436 <span class="comment">         * after the connect.</span>
01437 <span class="comment">         */</span>
01438 
01439         <span class="keywordflow">if</span> (ConnectState != CTX_W32_CONNECT_STATE_IDLE) {
01440 
01441             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a> = CreateCompatibleDC(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01442                 RIPERR0(ERROR_OUTOFMEMORY, RIP_WARNING, <span class="stringliteral">"ghdcBits2 creation failed"</span>);
01443                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01444             }
01445 
01446             <span class="comment">/*</span>
01447 <span class="comment">             * Get things we need from Gdi.</span>
01448 <span class="comment">             */</span>
01449             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1134">ghbrWhite</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01450                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1134">ghbrWhite</a> = GetStockObject(WHITE_BRUSH);
01451 
01452             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01453                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a> = GetStockObject(BLACK_BRUSH);
01454 
01455             <a class="code" href="../../d6/d0/usercli_8h.html#a545">InitClientDrawing</a>();
01456         }
01457 
01458         <a class="code" href="../../d1/d8/clglobal_8c.html#a9">gfSystemInitialized</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a100">NtUserGetThreadDesktop</a>(GetCurrentThreadId(),
01459                                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01460 
01461         <span class="comment">/*</span>
01462 <span class="comment">         * If an lpk is loaded for this process notify the kernel</span>
01463 <span class="comment">         */</span>
01464         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/clinit_8c.html#a4">gdwLpkEntryPoints</a>) {
01465             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(<a class="code" href="../../d6/d8/clinit_8c.html#a4">gdwLpkEntryPoints</a>, SFI_REGISTERLPK);
01466         }
01467 
01468         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a> || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;pDeskInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01469 
01470             <span class="comment">/*</span>
01471 <span class="comment">             * Perform any server initialization.</span>
01472 <span class="comment">             */</span>
01473             UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>);
01474 
01475             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/clinit_8c.html#a2">pdiLocal</a> = LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">DESKTOPINFO</a>))) {
01476 
01477                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;pDeskInfo = <a class="code" href="../../d6/d8/clinit_8c.html#a2">pdiLocal</a>;
01478 
01479             } <span class="keywordflow">else</span> {
01480 
01481                 RIPERR0(ERROR_OUTOFMEMORY, RIP_WARNING, <span class="stringliteral">"pdiLocal creation failed"</span>);
01482 
01483                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01484             }
01485         }
01486 
01487         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a>) {
01488             <span class="comment">/*</span>
01489 <span class="comment">             * Winstation Winlogon and CSR must do graphics initialization</span>
01490 <span class="comment">             * after the connect.</span>
01491 <span class="comment">             */</span>
01492             <span class="keywordflow">if</span> (ConnectState != CTX_W32_CONNECT_STATE_IDLE) {
01493                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d8/clinit_8c.html#a19">LoadCursorsAndIcons</a>()) {
01494                     RIPERR0(ERROR_OUTOFMEMORY, RIP_WARNING, <span class="stringliteral">"LoadCursorsAndIcons failed"</span>);
01495                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01496                 }
01497             }
01498 
01499             <a class="code" href="../../d6/d8/clinit_8c.html#a25">InitOemXlateTables</a>();
01500         }
01501 
01502         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d8/clinit_8c.html#a23">CheckBadApp</a>() ) {
01503             RIPERR0(ERROR_OUTOFMEMORY, RIP_WARNING, <span class="stringliteral">"Don't start app for server appliance"</span>);
01504             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01505         }
01506 
01507         <a class="code" href="../../d6/d8/clinit_8c.html#a24">LoadAppDlls</a>();
01508     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a>) {
01509         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;pDeskInfo = <a class="code" href="../../d6/d8/clinit_8c.html#a2">pdiLocal</a>;
01510     }
01511 
01512     <span class="comment">/*</span>
01513 <span class="comment">     * Kernel sets CI_REGISTERCLASSES when appropriate (i.e. always</span>
01514 <span class="comment">     * for the first thread and for other threads if the last GUI</span>
01515 <span class="comment">     * thread for a process has exited) except for the CSR proces.</span>
01516 <span class="comment">     * For the CSR process, you must register the classes on the</span>
01517 <span class="comment">     * first thread anyways.</span>
01518 <span class="comment">     */</span>
01519 
01520     <span class="keywordflow">if</span> (fFirstThread || (pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a117">CI_REGISTERCLASSES</a>)) {
01521 
01522         <span class="comment">/*</span>
01523 <span class="comment">         * If it's the first thread we already made it to the kernel</span>
01524 <span class="comment">         * to get the ConnectState...</span>
01525 <span class="comment">         */</span>
01526         <span class="keywordflow">if</span> (!fFirstThread) {
01527             ConnectState = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_REMOTECONNECTSTATE);
01528         }
01529         
01530         <span class="keywordflow">if</span> (ConnectState != CTX_W32_CONNECT_STATE_IDLE) {
01531 
01532             <span class="comment">/*</span>
01533 <span class="comment">             * Register the control classes.</span>
01534 <span class="comment">             */</span>
01535             <a class="code" href="../../d6/d8/clinit_8c.html#a20">RW_RegisterControls</a>();
01536             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a94">RW_RegisterDDEML</a>();
01537         }
01538     }
01539 
01540     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01541 }
01542 
01543 <span class="comment">/***************************************************************************\</span>
01544 <span class="comment">* Dispatch routines.</span>
01545 <span class="comment">*</span>
01546 <span class="comment">*</span>
01547 <span class="comment">\***************************************************************************/</span>
01548 
<a name="l01549"></a><a class="code" href="../../d6/d0/usercli_8h.html#a416">01549</a> HLOCAL WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a416">DispatchLocalAlloc</a>(
01550     UINT   uFlags,
01551     UINT   uBytes,
01552     HANDLE hInstance)
01553 {
01554     UNREFERENCED_PARAMETER(hInstance);
01555 
01556     <span class="keywordflow">return</span> LocalAlloc(uFlags, uBytes);
01557 }
01558 
<a name="l01559"></a><a class="code" href="../../d6/d0/usercli_8h.html#a417">01559</a> HLOCAL WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a417">DispatchLocalReAlloc</a>(
01560     HLOCAL hMem,
01561     UINT   uBytes,
01562     UINT   uFlags,
01563     HANDLE hInstance,
01564     PVOID* ppv)
01565 {
01566     UNREFERENCED_PARAMETER(hInstance);
01567     UNREFERENCED_PARAMETER(ppv);
01568 
01569     <span class="keywordflow">return</span> LocalReAlloc(hMem, uBytes, uFlags);
01570 }
01571 
<a name="l01572"></a><a class="code" href="../../d6/d0/usercli_8h.html#a418">01572</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a418">DispatchLocalLock</a>(
01573     HLOCAL hMem,
01574     HANDLE hInstance)
01575 {
01576     UNREFERENCED_PARAMETER(hInstance);
01577 
01578     <span class="keywordflow">return</span> LocalLock(hMem);
01579 }
01580 
<a name="l01581"></a><a class="code" href="../../d6/d0/usercli_8h.html#a419">01581</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a419">DispatchLocalUnlock</a>(
01582     HLOCAL hMem,
01583     HANDLE hInstance)
01584 {
01585     UNREFERENCED_PARAMETER(hInstance);
01586 
01587     <span class="keywordflow">return</span> LocalUnlock(hMem);
01588 }
01589 
<a name="l01590"></a><a class="code" href="../../d6/d0/usercli_8h.html#a420">01590</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a420">DispatchLocalSize</a>(
01591     HLOCAL hMem,
01592     HANDLE hInstance)
01593 {
01594     UNREFERENCED_PARAMETER(hInstance);
01595 
01596     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)LocalSize(hMem);
01597 }
01598 
<a name="l01599"></a><a class="code" href="../../d6/d0/usercli_8h.html#a421">01599</a> HLOCAL WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a421">DispatchLocalFree</a>(
01600     HLOCAL hMem,
01601     HANDLE hInstance)
01602 {
01603     UNREFERENCED_PARAMETER(hInstance);
01604 
01605     <span class="keywordflow">return</span> LocalFree(hMem);
01606 }
01607 
01608 <span class="comment">/***************************************************************************\</span>
01609 <span class="comment">* Allocation routines for RTL functions.</span>
01610 <span class="comment">*</span>
01611 <span class="comment">*</span>
01612 <span class="comment">\***************************************************************************/</span>
01613 
<a name="l01614"></a><a class="code" href="../../d6/d1/userrtl_8h.html#a31">01614</a> PVOID <a class="code" href="../../d6/d1/userrtl_8h.html#a31">UserRtlAllocMem</a>(
01615     ULONG uBytes)
01616 {
01617     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, uBytes);
01618 }
01619 
<a name="l01620"></a><a class="code" href="../../d6/d1/userrtl_8h.html#a32">01620</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d1/userrtl_8h.html#a32">UserRtlFreeMem</a>(
01621     PVOID pMem)
01622 {
01623     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pMem);
01624 }
01625 
<a name="l01626"></a><a class="code" href="../../d6/d8/clinit_8c.html#a35">01626</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a61">UserRtlRaiseStatus</a>(
01627     NTSTATUS Status)
01628 {
01629     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01630 }
01631 
01632 <span class="comment">/***************************************************************************\</span>
01633 <span class="comment">* InitClientDrawing</span>
01634 <span class="comment">*</span>
01635 <span class="comment">* History:</span>
01636 <span class="comment">* 20-Aug-1992 mikeke    Created</span>
01637 <span class="comment">\***************************************************************************/</span>
01638 
<a name="l01639"></a><a class="code" href="../../d6/d8/clinit_8c.html#a36">01639</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a545">InitClientDrawing</a>(VOID)
01640 {
01641     <span class="keyword">static</span> CONST WORD patGray[8] = {0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa};
01642     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01643 
01644     HBITMAP hbmGray = CreateBitmap(8, 8, 1, 1, (LPBYTE)patGray);;
01645 
01646     fSuccess &amp;= !!hbmGray;
01647 
01648     <span class="comment">/*</span>
01649 <span class="comment">     * Create the global-objects for client drawing.</span>
01650 <span class="comment">     */</span>
01651     <a class="code" href="../../d1/d8/clglobal_8c.html#a29">ghbrWindowText</a> = CreateSolidBrush(<a class="code" href="../../d3/d9/client_2wow_8c.html#a15">GetSysColor</a>(COLOR_WINDOWTEXT));
01652     fSuccess &amp;= !!<a class="code" href="../../d1/d8/clglobal_8c.html#a29">ghbrWindowText</a>;
01653 
01654     <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a> = GetStockObject(SYSTEM_FONT);
01655     fSuccess &amp;= !!<a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>;
01656 
01657     <a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a> = CreateCompatibleDC(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01658     fSuccess &amp;= !!<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>;
01659 
01660     <span class="keywordflow">if</span> (!fSuccess) {
01661         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitClientDrawing failed to allocate resources"</span>);
01662         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01663     }
01664 
01665     <span class="comment">/*</span>
01666 <span class="comment">     * Setup the gray surface.</span>
01667 <span class="comment">     */</span>
01668     SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, hbmGray);
01669     SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>);
01670     SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hbrGray);
01671 
01672     <span class="comment">/*</span>
01673 <span class="comment">     * Setup the gray attributes.</span>
01674 <span class="comment">     */</span>
01675     SetBkMode(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, OPAQUE);
01676     SetTextColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, 0x00000000L);
01677     SetBkColor(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, 0x00FFFFFFL);
01678 
01679     <a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a> = 8;
01680     <a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a> = 8;
01681 
01682     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01683 }
01684 
01685 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01686"></a><a class="code" href="../../d6/d8/clinit_8c.html#a37">01686</a> <a class="code" href="../../d6/d8/clinit_8c.html#a37">InitializeLpkHooks</a>(
01687     CONST FARPROC *lpfpLpkHooks
01688     )
01689 {
01690     <span class="comment">/*</span>
01691 <span class="comment">     * Called from GdiInitializeLanguagePack().  Remember what entry points</span>
01692 <span class="comment">     * are supported.  Pass the information to the kernel the first time</span>
01693 <span class="comment">     * this process connects in ClientThreadSetup().</span>
01694 <span class="comment">     */</span>
01695     <span class="keywordflow">if</span> (lpfpLpkHooks[LPK_TABBED_TEXT_OUT]) {
01696         <a class="code" href="../../d1/d8/clglobal_8c.html#a32">fpLpkTabbedTextOut</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1110">FPLPKTABBEDTEXTOUT</a>)lpfpLpkHooks[LPK_TABBED_TEXT_OUT];
01697         <a class="code" href="../../d6/d8/clinit_8c.html#a4">gdwLpkEntryPoints</a> |= (1 &lt;&lt; LPK_TABBED_TEXT_OUT);
01698     }
01699     <span class="keywordflow">if</span> (lpfpLpkHooks[LPK_PSM_TEXT_OUT]) {
01700         <a class="code" href="../../d1/d8/clglobal_8c.html#a33">fpLpkPSMTextOut</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1111">FPLPKPSMTEXTOUT</a>)lpfpLpkHooks[LPK_PSM_TEXT_OUT];
01701         <a class="code" href="../../d6/d8/clinit_8c.html#a4">gdwLpkEntryPoints</a> |= (1 &lt;&lt; LPK_PSM_TEXT_OUT);
01702     }
01703     <span class="keywordflow">if</span> (lpfpLpkHooks[LPK_DRAW_TEXT_EX]) {
01704         <a class="code" href="../../d1/d8/clglobal_8c.html#a34">fpLpkDrawTextEx</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1112">FPLPKDRAWTEXTEX</a>)lpfpLpkHooks[LPK_DRAW_TEXT_EX];
01705         <a class="code" href="../../d6/d8/clinit_8c.html#a4">gdwLpkEntryPoints</a> |= (1 &lt;&lt; LPK_DRAW_TEXT_EX);
01706     }
01707     <span class="keywordflow">if</span> (lpfpLpkHooks[LPK_EDIT_CONTROL]) {
01708         <a class="code" href="../../d1/d8/clglobal_8c.html#a35">fpLpkEditControl</a> = (<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html">PLPKEDITCALLOUT</a>)lpfpLpkHooks[LPK_EDIT_CONTROL];
01709         <a class="code" href="../../d6/d8/clinit_8c.html#a4">gdwLpkEntryPoints</a> |= (1 &lt;&lt; LPK_EDIT_CONTROL);
01710     }
01711 }
01712 
01713 <span class="comment">/***************************************************************************\</span>
01714 <span class="comment">*</span>
01715 <span class="comment">* CtxInitUser32</span>
01716 <span class="comment">*</span>
01717 <span class="comment">* Called by CreateWindowStation() and winsrv.dll DoConnect routine.</span>
01718 <span class="comment">*</span>
01719 <span class="comment">* Winstation Winlogon and CSR must do graphics initialization</span>
01720 <span class="comment">* after the connect.  This is because no video driver is loaded</span>
01721 <span class="comment">* until then.</span>
01722 <span class="comment">*</span>
01723 <span class="comment">* This routine must contain everything that was skipped before.</span>
01724 <span class="comment">*</span>
01725 <span class="comment">* History:</span>
01726 <span class="comment">* Dec-11-1997 clupu    Ported from Citrix</span>
01727 <span class="comment">\***************************************************************************/</span>
01728 
<a name="l01729"></a><a class="code" href="../../d2/d8/api_8c.html#a24">01729</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/api_8c.html#a24">CtxInitUser32</a>(
01730     VOID)
01731 {
01732     <span class="comment">/*</span>
01733 <span class="comment">     * Only do once.</span>
01734 <span class="comment">     */</span>
01735     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>())
01736         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01737 
01738     <a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a> = CreateCompatibleDC(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01739 
01740     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01741         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Could not allocate ghdcBits2"</span>);
01742         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01743     }
01744 
01745     <span class="comment">/*</span>
01746 <span class="comment">     * Get things we need from Gdi.</span>
01747 <span class="comment">     */</span>
01748     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1134">ghbrWhite</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01749         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1134">ghbrWhite</a> = GetStockObject(WHITE_BRUSH);
01750 
01751     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01752         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a> = GetStockObject(BLACK_BRUSH);
01753 
01754     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1134">ghbrWhite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01755 
01756     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a545">InitClientDrawing</a>()) {
01757         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitClientDrawing failed"</span>);
01758         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01759     }
01760 
01761     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a8">gfServerProcess</a>) {
01762         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d8/clinit_8c.html#a19">LoadCursorsAndIcons</a>()) {
01763             RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadCursorsAndIcons failed"</span>);
01764             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01765         }
01766     }
01767 
01768     <span class="comment">/*</span>
01769 <span class="comment">     * Register the control classes.</span>
01770 <span class="comment">     */</span>
01771     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d8/clinit_8c.html#a20">RW_RegisterControls</a>())
01772         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01773 
01774     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d4/ddemlcli_8h.html#a94">RW_RegisterDDEML</a>())
01775         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01776 
01777     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01778 }
01779 
<a name="l01780"></a><a class="code" href="../../d6/d8/clinit_8c.html#a39">01780</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a55">GetRipComponent</a>(VOID) { <span class="keywordflow">return</span> RIP_USER; }
01781 
<a name="l01782"></a><a class="code" href="../../d6/d8/clinit_8c.html#a40">01782</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a56">GetDbgTagFlags</a>(<span class="keywordtype">int</span> tag)
01783 {
01784 <span class="preprocessor">#if DEBUGTAGS</span>
01785 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;adwDBGTAGFlags[tag] : 0);
01786 <span class="preprocessor">#else</span>
01787 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
01788     UNREFERENCED_PARAMETER(tag);
01789 <span class="preprocessor">#endif // DEBUGTAGS</span>
01790 <span class="preprocessor"></span>}
01791 
<a name="l01792"></a><a class="code" href="../../d6/d8/clinit_8c.html#a41">01792</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a57">GetRipPID</a>(VOID) { <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o2">wRIPPID</a> : 0); }
<a name="l01793"></a><a class="code" href="../../d6/d8/clinit_8c.html#a42">01793</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a58">GetRipFlags</a>(VOID) { <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o0">wRIPFlags</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a393">RIPF_DEFAULT</a>); }
01794 
<a name="l01795"></a><a class="code" href="../../d6/d8/clinit_8c.html#a43">01795</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a59">SetRipFlags</a>(DWORD dwRipFlags, DWORD dwRipPID)
01796 {
01797     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a171">NtUserSetRipFlags</a>(dwRipFlags, dwRipPID);
01798 }
01799 
<a name="l01800"></a><a class="code" href="../../d6/d8/clinit_8c.html#a44">01800</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a60">SetDbgTag</a>(<span class="keywordtype">int</span> tag, DWORD dwBitFlags)
01801 {
01802     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a172">NtUserSetDbgTag</a>(tag, dwBitFlags);
01803 }
01804 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
