<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mi386.h Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mi386.h</h1><a href="../../d6/d8/mi386_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    mi386.h</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the private data structures and procedure</span>
00012 <span class="comment">    prototypes for the hardware dependent portion of the</span>
00013 <span class="comment">    memory management system.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    This module is specifically tailored for the Intel 386,</span>
00016 <span class="comment"></span>
00017 <span class="comment">Author:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Lou Perazzoli (loup) 6-Jan-1990</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 
00026 <span class="comment">/*++</span>
00027 <span class="comment"></span>
00028 <span class="comment">    Virtual Memory Layout on the i386 is:</span>
00029 <span class="comment"></span>
00030 <span class="comment">                 +------------------------------------+</span>
00031 <span class="comment">        00000000 |                                    |</span>
00032 <span class="comment">                 |                                    |</span>
00033 <span class="comment">                 |                                    |</span>
00034 <span class="comment">                 | User Mode Addresses                |</span>
00035 <span class="comment">                 |                                    |</span>
00036 <span class="comment">                 |   All pages within this range      |</span>
00037 <span class="comment">                 |   are potentially accessible while |</span>
00038 <span class="comment">                 |   the CPU is in USER mode.         |</span>
00039 <span class="comment">                 |                                    |</span>
00040 <span class="comment">                 |                                    |</span>
00041 <span class="comment">                 +------------------------------------+</span>
00042 <span class="comment">        7ffff000 | 64k No Access Area                 |</span>
00043 <span class="comment">                 +------------------------------------+</span>
00044 <span class="comment">        80000000 |                                    |</span>
00045 <span class="comment">                 | HAL loads kernel and initial       |</span>
00046 <span class="comment">                 | boot drivers in first 16mb         |</span>
00047 <span class="comment">                 | of this region.                    |</span>
00048 <span class="comment">                 | Kernel mode access only.           |</span>
00049 <span class="comment">                 |                                    |</span>
00050 <span class="comment">                 | If large pages are enabled, the    |</span>
00051 <span class="comment">                 | initial non paged pool is relocated|</span>
00052 <span class="comment">                 | to here during system startup.     |</span>
00053 <span class="comment">                 |                                    |</span>
00054 <span class="comment">                 +------------------------------------+</span>
00055 <span class="comment">        81000000 |                                    |</span>
00056 <span class="comment">                 | Unused  NO ACCESS                  |</span>
00057 <span class="comment">                 |                                    |</span>
00058 <span class="comment">                 +------------------------------------+</span>
00059 <span class="comment">        A0000000 |                                    |</span>
00060 <span class="comment">                 |         System mapped views        |</span>
00061 <span class="comment">                 |                OR                  |</span>
00062 <span class="comment">                 |           Session space            |</span>
00063 <span class="comment">                 |                                    |</span>
00064 <span class="comment">                 +------------------------------------+</span>
00065 <span class="comment">        A4000000 |                                    |</span>
00066 <span class="comment">                 | Additional System PTEs             |</span>
00067 <span class="comment">                 |                                    |</span>
00068 <span class="comment">                 +------------------------------------+</span>
00069 <span class="comment">        C0000000 | Page Table Pages mapped through    |</span>
00070 <span class="comment">                 |   this 4mb region                  |</span>
00071 <span class="comment">                 |   Kernel mode access only.         |</span>
00072 <span class="comment">                 |                                    |</span>
00073 <span class="comment">                 +------------------------------------+</span>
00074 <span class="comment">        C0400000 | HyperSpace - working set lists     |</span>
00075 <span class="comment">                 |  and per process memory management |</span>
00076 <span class="comment">                 |  structures mapped in this 4mb     |</span>
00077 <span class="comment">                 |  region.                           |</span>
00078 <span class="comment">                 |  Kernel mode access only.          |</span>
00079 <span class="comment">                 +------------------------------------+</span>
00080 <span class="comment">        C0800000 | NO ACCESS AREA (4MB)               |</span>
00081 <span class="comment">                 |                                    |</span>
00082 <span class="comment">                 +------------------------------------+</span>
00083 <span class="comment">        C0C00000 | System Cache Structures            |</span>
00084 <span class="comment">                 |   reside in this 4mb region        |</span>
00085 <span class="comment">                 |   Kernel mode access only.         |</span>
00086 <span class="comment">                 +------------------------------------+</span>
00087 <span class="comment">        C1000000 | System cache resides here.         |</span>
00088 <span class="comment">                 |   Kernel mode access only.         |</span>
00089 <span class="comment">                 |                                    |</span>
00090 <span class="comment">                 |                                    |</span>
00091 <span class="comment">                 +------------------------------------+</span>
00092 <span class="comment">        E1000000 | Start of paged system area         |</span>
00093 <span class="comment">                 |   Kernel mode access only.         |</span>
00094 <span class="comment">                 |                                    |</span>
00095 <span class="comment">                 |                                    |</span>
00096 <span class="comment">                 +------------------------------------+</span>
00097 <span class="comment">                 |                                    |</span>
00098 <span class="comment">                 | System Pte area - for mapping      |</span>
00099 <span class="comment">                 |   kernel thread stacks and MDLs    |</span>
00100 <span class="comment">                 |   that require system VAs.         |</span>
00101 <span class="comment">                 |   Kernel mode access only.         |</span>
00102 <span class="comment">                 |                                    |</span>
00103 <span class="comment">                 +------------------------------------+</span>
00104 <span class="comment">                 |                                    |</span>
00105 <span class="comment">                 | NonPaged System area               |</span>
00106 <span class="comment">                 |   Kernel mode access only.         |</span>
00107 <span class="comment">                 |                                    |</span>
00108 <span class="comment">                 +------------------------------------+</span>
00109 <span class="comment">        FFBE0000 | Crash Dump Driver area             |</span>
00110 <span class="comment">                 |   Kernel mode access only.         |</span>
00111 <span class="comment">                 +------------------------------------+</span>
00112 <span class="comment">        FFC00000 | Last 4mb reserved for HAL usage    |</span>
00113 <span class="comment">                 +------------------------------------+</span>
00114 <span class="comment"></span>
00115 <span class="comment"></span>
00116 <span class="comment">  Virtual Memory Layout of the (48MB) Session Space (on 2GB user systems) is:</span>
00117 <span class="comment"></span>
00118 <span class="comment">                 +------------------------------------+</span>
00119 <span class="comment">        A0000000 |                                    |</span>
00120 <span class="comment">                 | win32k.sys and rebased NT4 printer |</span>
00121 <span class="comment">                 |            drivers.                |</span>
00122 <span class="comment">                 |                                    |</span>
00123 <span class="comment">                 |             (8MB)                  |</span>
00124 <span class="comment">                 |                                    |</span>
00125 <span class="comment">                 +------------------------------------+</span>
00126 <span class="comment">        A0800000 |                                    |</span>
00127 <span class="comment">                 |   MM_SESSION_SPACE &amp; Session WSLs  |</span>
00128 <span class="comment">                 |              (4MB)                 |</span>
00129 <span class="comment">                 |                                    |</span>
00130 <span class="comment">                 +------------------------------------+</span>
00131 <span class="comment">        A0C00000 |                                    |</span>
00132 <span class="comment">                 |   Mapped Views for this session    |</span>
00133 <span class="comment">                 |              (20MB)                |</span>
00134 <span class="comment">                 |                                    |</span>
00135 <span class="comment">                 +------------------------------------+</span>
00136 <span class="comment">        A2000000 |                                    |</span>
00137 <span class="comment">                 |   Paged Pool for this session      |</span>
00138 <span class="comment">                 |              (16MB)                |</span>
00139 <span class="comment">                 |                                    |</span>
00140 <span class="comment">        A3000000 +------------------------------------+</span>
00141 <span class="comment">                 |   System Mapped Views (not session)|</span>
00142 <span class="comment">                 |              (16MB)                |</span>
00143 <span class="comment">                 |                                    |</span>
00144 <span class="comment">        A4000000 +------------------------------------+</span>
00145 <span class="comment"></span>
00146 <span class="comment">--*/</span>
00147 
00148 <span class="preprocessor">#if !defined(_X86PAE_)</span>
00149 <span class="preprocessor"></span><span class="preprocessor">#if defined(NT_UP)</span>
00150 <span class="preprocessor"></span><span class="preprocessor">#define _MI_USE_CLAIMS_ 1</span>
00151 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00152 <span class="preprocessor"></span>
00153 <span class="comment">//</span>
00154 <span class="comment">// Define empty list markers.</span>
00155 <span class="comment">//</span>
00156 
<a name="l00157"></a><a class="code" href="../../d6/d8/mi386_8h.html#a0">00157</a> <span class="preprocessor">#define MM_EMPTY_LIST ((ULONG)0xFFFFFFFF) //</span>
<a name="l00158"></a><a class="code" href="../../d6/d8/mi386_8h.html#a1">00158</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_EMPTY_PTE_LIST ((ULONG)0xFFFFF) // N.B. tied to MMPTE definition</span>
00159 <span class="preprocessor"></span>
<a name="l00160"></a><a class="code" href="../../d6/d8/mi386_8h.html#a2">00160</a> <span class="preprocessor">#define MI_PTE_BASE_FOR_LOWEST_KERNEL_ADDRESS (MiGetPteAddress (0x80000000))</span>
00161 <span class="preprocessor"></span>
<a name="l00162"></a><a class="code" href="../../d6/d8/mi386_8h.html#a3">00162</a> <span class="preprocessor">#define MM_SESSION_SPACE_DEFAULT        (0xA0000000)</span>
00163 <span class="preprocessor"></span>
<a name="l00164"></a><a class="code" href="../../d6/d8/mi386_8h.html#a4">00164</a> <span class="preprocessor">#define MM_BOOT_IMAGE_SIZE              (16 * 1024 * 1024)</span>
00165 <span class="preprocessor"></span>
00166 <span class="comment">//</span>
00167 <span class="comment">// Additional system PTEs are allocated out of this virtual address range.</span>
00168 <span class="comment">//</span>
00169 
<a name="l00170"></a><a class="code" href="../../d6/d8/mi386_8h.html#a5">00170</a> <span class="preprocessor">#define KSTACK_POOL_START                (0xA4000000)</span>
00171 <span class="preprocessor"></span>
<a name="l00172"></a><a class="code" href="../../d6/d8/mi386_8h.html#a6">00172</a> <span class="preprocessor">#define KSTACK_POOL_END                  (0xBFFFFFFF)</span>
00173 <span class="preprocessor"></span>
<a name="l00174"></a><a class="code" href="../../d6/d8/mi386_8h.html#a7">00174</a> <span class="preprocessor">#define KSTACK_POOL_SIZE                 ((KSTACK_POOL_END-KSTACK_POOL_START) \</span>
00175 <span class="preprocessor">                                          &amp; ~(PAGE_SIZE-1))</span>
00176 <span class="preprocessor"></span>
<a name="l00177"></a><a class="code" href="../../d6/d8/mi386_8h.html#a199">00177</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a>;
00178 
<a name="l00179"></a><a class="code" href="../../d6/d8/mi386_8h.html#a200">00179</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d2/d2/data386_8c.html#a28">MiMaximumSystemCacheSizeExtra</a>;
00180 
<a name="l00181"></a><a class="code" href="../../d6/d8/mi386_8h.html#a201">00181</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d2/d2/data386_8c.html#a29">MiSystemCacheStartExtra</a>;
00182 
<a name="l00183"></a><a class="code" href="../../d6/d8/mi386_8h.html#a202">00183</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a>;
00184 
00185 <span class="comment">//</span>
00186 <span class="comment">// PAGE_SIZE for Intel i386 is 4k, virtual page is 20 bits with a PAGE_SHIFT</span>
00187 <span class="comment">// byte offset.</span>
00188 <span class="comment">//</span>
00189 
<a name="l00190"></a><a class="code" href="../../d6/d8/mi386_8h.html#a8">00190</a> <span class="preprocessor">#define MM_VIRTUAL_PAGE_FILLER 0</span>
<a name="l00191"></a><a class="code" href="../../d6/d8/mi386_8h.html#a9">00191</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_VIRTUAL_PAGE_SIZE 20</span>
00192 <span class="preprocessor"></span>
00193 <span class="comment">//</span>
00194 <span class="comment">// Address space layout definitions.</span>
00195 <span class="comment">//</span>
00196 
<a name="l00197"></a><a class="code" href="../../d6/d8/mi386_8h.html#a10">00197</a> <span class="preprocessor">#define MM_KSEG0_BASE ((ULONG)0x80000000)</span>
00198 <span class="preprocessor"></span>
<a name="l00199"></a><a class="code" href="../../d6/d8/mi386_8h.html#a11">00199</a> <span class="preprocessor">#define MM_KSEG2_BASE ((ULONG)0xA0000000)</span>
00200 <span class="preprocessor"></span>
<a name="l00201"></a><a class="code" href="../../d6/d8/mi386_8h.html#a12">00201</a> <span class="preprocessor">#define MM_PAGES_IN_KSEG0 ((MM_KSEG2_BASE - MM_KSEG0_BASE) &gt;&gt; PAGE_SHIFT)</span>
00202 <span class="preprocessor"></span>
<a name="l00203"></a><a class="code" href="../../d6/d8/mi386_8h.html#a203">00203</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d2/d2/data386_8c.html#a19">MmKseg2Frame</a>;
00204 
<a name="l00205"></a><a class="code" href="../../d6/d8/mi386_8h.html#a13">00205</a> <span class="preprocessor">#define CODE_START MM_KSEG0_BASE</span>
00206 <span class="preprocessor"></span>
<a name="l00207"></a><a class="code" href="../../d6/d8/mi386_8h.html#a14">00207</a> <span class="preprocessor">#define CODE_END   MM_KSEG2_BASE</span>
00208 <span class="preprocessor"></span>
<a name="l00209"></a><a class="code" href="../../d6/d8/mi386_8h.html#a15">00209</a> <span class="preprocessor">#define MM_SYSTEM_SPACE_START (0xC0800000)</span>
00210 <span class="preprocessor"></span>
<a name="l00211"></a><a class="code" href="../../d6/d8/mi386_8h.html#a16">00211</a> <span class="preprocessor">#define MM_SYSTEM_SPACE_END (0xFFFFFFFF)</span>
00212 <span class="preprocessor"></span>
<a name="l00213"></a><a class="code" href="../../d6/d8/mi386_8h.html#a17">00213</a> <span class="preprocessor">#define PTE_TOP 0xC03FFFFF</span>
<a name="l00214"></a><a class="code" href="../../d6/d8/mi386_8h.html#a18">00214</a> <span class="preprocessor"></span><span class="preprocessor">#define PDE_TOP 0xC03FFFFF</span>
00215 <span class="preprocessor"></span>
<a name="l00216"></a><a class="code" href="../../d6/d8/mi386_8h.html#a19">00216</a> <span class="preprocessor">#define HYPER_SPACE ((PVOID)0xC0400000)</span>
00217 <span class="preprocessor"></span>
<a name="l00218"></a><a class="code" href="../../d6/d8/mi386_8h.html#a20">00218</a> <span class="preprocessor">#define HYPER_SPACE_END (0xC07fffff)</span>
00219 <span class="preprocessor"></span>
<a name="l00220"></a><a class="code" href="../../d6/d8/mi386_8h.html#a21">00220</a> <span class="preprocessor">#define MM_SYSTEM_VIEW_START (0xA0000000)</span>
00221 <span class="preprocessor"></span>
<a name="l00222"></a><a class="code" href="../../d6/d8/mi386_8h.html#a22">00222</a> <span class="preprocessor">#define MM_SYSTEM_VIEW_SIZE (48*1024*1024)</span>
00223 <span class="preprocessor"></span>
<a name="l00224"></a><a class="code" href="../../d6/d8/mi386_8h.html#a23">00224</a> <span class="preprocessor">#define MM_SYSTEM_VIEW_START_IF_HYDRA (0xA3000000)</span>
00225 <span class="preprocessor"></span>
<a name="l00226"></a><a class="code" href="../../d6/d8/mi386_8h.html#a24">00226</a> <span class="preprocessor">#define MM_SYSTEM_VIEW_SIZE_IF_HYDRA (16*1024*1024)</span>
00227 <span class="preprocessor"></span>
<a name="l00228"></a><a class="code" href="../../d6/d8/mi386_8h.html#a25">00228</a> <span class="preprocessor">#define MM_LOWEST_4MB_START ((32*1024*1024)/PAGE_SIZE) //32mb</span>
00229 <span class="preprocessor"></span>
<a name="l00230"></a><a class="code" href="../../d6/d8/mi386_8h.html#a26">00230</a> <span class="preprocessor">#define MM_DEFAULT_4MB_START (((1024*1024)/PAGE_SIZE)*4096) //4gb</span>
00231 <span class="preprocessor"></span>
<a name="l00232"></a><a class="code" href="../../d6/d8/mi386_8h.html#a27">00232</a> <span class="preprocessor">#define MM_HIGHEST_4MB_START (((1024*1024)/PAGE_SIZE)*4096) //4gb</span>
00233 <span class="preprocessor"></span>
<a name="l00234"></a><a class="code" href="../../d6/d8/mi386_8h.html#a28">00234</a> <span class="preprocessor">#define MM_USER_ADDRESS_RANGE_LIMIT 0xFFFFFFFF // user address range limit</span>
<a name="l00235"></a><a class="code" href="../../d6/d8/mi386_8h.html#a29">00235</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_MAXIMUM_ZERO_BITS 21         // maximum number of zero bits</span>
00236 <span class="preprocessor"></span>
00237 <span class="comment">//</span>
00238 <span class="comment">// Define the start and maximum size for the system cache.</span>
00239 <span class="comment">// Maximum size is normally 512MB, but can be up to 512MB + 448MB = 960MB for</span>
00240 <span class="comment">// large system cache machines.</span>
00241 <span class="comment">//</span>
00242 
<a name="l00243"></a><a class="code" href="../../d6/d8/mi386_8h.html#a30">00243</a> <span class="preprocessor">#define MM_SYSTEM_CACHE_WORKING_SET (0xC0C00000)</span>
00244 <span class="preprocessor"></span>
<a name="l00245"></a><a class="code" href="../../d6/d8/mi386_8h.html#a31">00245</a> <span class="preprocessor">#define MM_SYSTEM_CACHE_START (0xC1000000)</span>
00246 <span class="preprocessor"></span>
<a name="l00247"></a><a class="code" href="../../d6/d8/mi386_8h.html#a32">00247</a> <span class="preprocessor">#define MM_SYSTEM_CACHE_END (0xE1000000)</span>
00248 <span class="preprocessor"></span>
<a name="l00249"></a><a class="code" href="../../d6/d8/mi386_8h.html#a33">00249</a> <span class="preprocessor">#define MM_SYSTEM_CACHE_START_EXTRA (0xA4000000)</span>
00250 <span class="preprocessor"></span>
<a name="l00251"></a><a class="code" href="../../d6/d8/mi386_8h.html#a34">00251</a> <span class="preprocessor">#define MM_SYSTEM_CACHE_END_EXTRA (0xC0000000)</span>
00252 <span class="preprocessor"></span>
<a name="l00253"></a><a class="code" href="../../d6/d8/mi386_8h.html#a35">00253</a> <span class="preprocessor">#define MM_PAGED_POOL_START ((PVOID)(0xE1000000))</span>
00254 <span class="preprocessor"></span>
<a name="l00255"></a><a class="code" href="../../d6/d8/mi386_8h.html#a36">00255</a> <span class="preprocessor">#define MM_LOWEST_NONPAGED_SYSTEM_START ((PVOID)(0xEB000000))</span>
00256 <span class="preprocessor"></span>
<a name="l00257"></a><a class="code" href="../../d6/d8/mi386_8h.html#a37">00257</a> <span class="preprocessor">#define MmProtopte_Base ((ULONG)0xE1000000)</span>
00258 <span class="preprocessor"></span>
<a name="l00259"></a><a class="code" href="../../d6/d8/mi386_8h.html#a38">00259</a> <span class="preprocessor">#define MM_NONPAGED_POOL_END ((PVOID)(0xFFBE0000))</span>
00260 <span class="preprocessor"></span>
<a name="l00261"></a><a class="code" href="../../d6/d8/mi386_8h.html#a39">00261</a> <span class="preprocessor">#define MM_CRASH_DUMP_VA ((PVOID)(0xFFBE0000))</span>
00262 <span class="preprocessor"></span>
<a name="l00263"></a><a class="code" href="../../d6/d8/mi386_8h.html#a40">00263</a> <span class="preprocessor">#define MM_DEBUG_VA  ((PVOID)0xFFBFF000)</span>
00264 <span class="preprocessor"></span>
<a name="l00265"></a><a class="code" href="../../d6/d8/mi386_8h.html#a41">00265</a> <span class="preprocessor">#define NON_PAGED_SYSTEM_END   ((ULONG)0xFFFFFFF0)  //quadword aligned.</span>
00266 <span class="preprocessor"></span>
<a name="l00267"></a><a class="code" href="../../d6/d8/mi386_8h.html#a204">00267</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a>;
00268 
00269 <span class="comment">//</span>
00270 <span class="comment">// Define absolute minimum and maximum count for system PTEs.</span>
00271 <span class="comment">//</span>
00272 
<a name="l00273"></a><a class="code" href="../../d6/d8/mi386_8h.html#a42">00273</a> <span class="preprocessor">#define MM_MINIMUM_SYSTEM_PTES 7000</span>
00274 <span class="preprocessor"></span>
<a name="l00275"></a><a class="code" href="../../d6/d8/mi386_8h.html#a43">00275</a> <span class="preprocessor">#define MM_MAXIMUM_SYSTEM_PTES 50000</span>
00276 <span class="preprocessor"></span>
<a name="l00277"></a><a class="code" href="../../d6/d8/mi386_8h.html#a44">00277</a> <span class="preprocessor">#define MM_DEFAULT_SYSTEM_PTES 11000</span>
00278 <span class="preprocessor"></span>
00279 <span class="comment">//</span>
00280 <span class="comment">// Pool limits</span>
00281 <span class="comment">//</span>
00282 
00283 <span class="comment">//</span>
00284 <span class="comment">// The maximum amount of nonpaged pool that can be initially created.</span>
00285 <span class="comment">//</span>
00286 
<a name="l00287"></a><a class="code" href="../../d6/d8/mi386_8h.html#a45">00287</a> <span class="preprocessor">#define MM_MAX_INITIAL_NONPAGED_POOL ((ULONG)(128*1024*1024))</span>
00288 <span class="preprocessor"></span>
00289 <span class="comment">//</span>
00290 <span class="comment">// The total amount of nonpaged pool (initial pool + expansion).</span>
00291 <span class="comment">//</span>
00292 
<a name="l00293"></a><a class="code" href="../../d6/d8/mi386_8h.html#a46">00293</a> <span class="preprocessor">#define MM_MAX_ADDITIONAL_NONPAGED_POOL ((ULONG)(128*1024*1024))</span>
00294 <span class="preprocessor"></span>
00295 <span class="comment">//</span>
00296 <span class="comment">// The maximum amount of paged pool that can be created.</span>
00297 <span class="comment">//</span>
00298 
<a name="l00299"></a><a class="code" href="../../d6/d8/mi386_8h.html#a47">00299</a> <span class="preprocessor">#define MM_MAX_PAGED_POOL ((ULONG)MM_NONPAGED_POOL_END - (ULONG)MM_PAGED_POOL_START)</span>
00300 <span class="preprocessor"></span>
<a name="l00301"></a><a class="code" href="../../d6/d8/mi386_8h.html#a48">00301</a> <span class="preprocessor">#define MM_MAX_TOTAL_POOL (((ULONG)MM_NONPAGED_POOL_END) - ((ULONG)(MM_PAGED_POOL_START)))</span>
00302 <span class="preprocessor"></span>
00303 
00304 <span class="comment">//</span>
00305 <span class="comment">// Structure layout definitions.</span>
00306 <span class="comment">//</span>
00307 
<a name="l00308"></a><a class="code" href="../../d6/d8/mi386_8h.html#a49">00308</a> <span class="preprocessor">#define MM_PROTO_PTE_ALIGNMENT ((ULONG)PAGE_SIZE)</span>
00309 <span class="preprocessor"></span>
<a name="l00310"></a><a class="code" href="../../d6/d8/mi386_8h.html#a50">00310</a> <span class="preprocessor">#define PAGE_DIRECTORY_MASK    ((ULONG)0x003FFFFF)</span>
00311 <span class="preprocessor"></span>
<a name="l00312"></a><a class="code" href="../../d6/d8/mi386_8h.html#a51">00312</a> <span class="preprocessor">#define MM_VA_MAPPED_BY_PDE (0x400000)</span>
00313 <span class="preprocessor"></span>
<a name="l00314"></a><a class="code" href="../../d6/d8/mi386_8h.html#a52">00314</a> <span class="preprocessor">#define LOWEST_IO_ADDRESS 0xa0000</span>
00315 <span class="preprocessor"></span>
<a name="l00316"></a><a class="code" href="../../d6/d8/mi386_8h.html#a53">00316</a> <span class="preprocessor">#define PTE_SHIFT 2</span>
00317 <span class="preprocessor"></span>
00318 <span class="comment">//</span>
00319 <span class="comment">// The number of bits in a physical address.</span>
00320 <span class="comment">//</span>
00321 
<a name="l00322"></a><a class="code" href="../../d6/d8/mi386_8h.html#a54">00322</a> <span class="preprocessor">#define PHYSICAL_ADDRESS_BITS 32</span>
00323 <span class="preprocessor"></span>
<a name="l00324"></a><a class="code" href="../../d6/d8/mi386_8h.html#a55">00324</a> <span class="preprocessor">#define MM_MAXIMUM_NUMBER_OF_COLORS (1)</span>
00325 <span class="preprocessor"></span>
00326 <span class="comment">//</span>
00327 <span class="comment">// i386 does not require support for colored pages.</span>
00328 <span class="comment">//</span>
00329 
<a name="l00330"></a><a class="code" href="../../d6/d8/mi386_8h.html#a56">00330</a> <span class="preprocessor">#define MM_NUMBER_OF_COLORS (1)</span>
00331 <span class="preprocessor"></span>
00332 <span class="comment">//</span>
00333 <span class="comment">// Mask for obtaining color from a physical page number.</span>
00334 <span class="comment">//</span>
00335 
<a name="l00336"></a><a class="code" href="../../d6/d8/mi386_8h.html#a57">00336</a> <span class="preprocessor">#define MM_COLOR_MASK (0)</span>
00337 <span class="preprocessor"></span>
00338 <span class="comment">//</span>
00339 <span class="comment">// Boundary for aligned pages of like color upon.</span>
00340 <span class="comment">//</span>
00341 
<a name="l00342"></a><a class="code" href="../../d6/d8/mi386_8h.html#a58">00342</a> <span class="preprocessor">#define MM_COLOR_ALIGNMENT (0)</span>
00343 <span class="preprocessor"></span>
00344 <span class="comment">//</span>
00345 <span class="comment">// Mask for isolating color from virtual address.</span>
00346 <span class="comment">//</span>
00347 
<a name="l00348"></a><a class="code" href="../../d6/d8/mi386_8h.html#a59">00348</a> <span class="preprocessor">#define MM_COLOR_MASK_VIRTUAL (0)</span>
00349 <span class="preprocessor"></span>
00350 <span class="comment">//</span>
00351 <span class="comment">//  Define 256k worth of secondary colors.</span>
00352 <span class="comment">//</span>
00353 
<a name="l00354"></a><a class="code" href="../../d6/d8/mi386_8h.html#a60">00354</a> <span class="preprocessor">#define MM_SECONDARY_COLORS_DEFAULT (64)</span>
00355 <span class="preprocessor"></span>
<a name="l00356"></a><a class="code" href="../../d6/d8/mi386_8h.html#a61">00356</a> <span class="preprocessor">#define MM_SECONDARY_COLORS_MIN (2)</span>
00357 <span class="preprocessor"></span>
<a name="l00358"></a><a class="code" href="../../d6/d8/mi386_8h.html#a62">00358</a> <span class="preprocessor">#define MM_SECONDARY_COLORS_MAX (1024)</span>
00359 <span class="preprocessor"></span>
00360 <span class="comment">//</span>
00361 <span class="comment">// Mask for isolating secondary color from physical page number;</span>
00362 <span class="comment">//</span>
00363 
<a name="l00364"></a><a class="code" href="../../d6/d8/mi386_8h.html#a205">00364</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d2/datalpha_8c.html#a22">MmSecondaryColorMask</a>;
00365 
00366 <span class="comment">//</span>
00367 <span class="comment">// Maximum number of paging files.</span>
00368 <span class="comment">//</span>
00369 
<a name="l00370"></a><a class="code" href="../../d6/d8/mi386_8h.html#a63">00370</a> <span class="preprocessor">#define MAX_PAGE_FILES 16</span>
00371 <span class="preprocessor"></span>
00372 
00373 <span class="comment">//</span>
00374 <span class="comment">// Hyper space definitions.</span>
00375 <span class="comment">//</span>
00376 
<a name="l00377"></a><a class="code" href="../../d6/d8/mi386_8h.html#a64">00377</a> <span class="preprocessor">#define FIRST_MAPPING_PTE   ((ULONG)0xC0400000)</span>
00378 <span class="preprocessor"></span>
<a name="l00379"></a><a class="code" href="../../d6/d8/mi386_8h.html#a65">00379</a> <span class="preprocessor">#define NUMBER_OF_MAPPING_PTES 255</span>
<a name="l00380"></a><a class="code" href="../../d6/d8/mi386_8h.html#a66">00380</a> <span class="preprocessor"></span><span class="preprocessor">#define LAST_MAPPING_PTE   \</span>
00381 <span class="preprocessor">     ((ULONG)((ULONG)FIRST_MAPPING_PTE + (NUMBER_OF_MAPPING_PTES * PAGE_SIZE)))</span>
00382 <span class="preprocessor"></span>
<a name="l00383"></a><a class="code" href="../../d6/d8/mi386_8h.html#a67">00383</a> <span class="preprocessor">#define IMAGE_MAPPING_PTE   ((PMMPTE)((ULONG)LAST_MAPPING_PTE + PAGE_SIZE))</span>
00384 <span class="preprocessor"></span>
<a name="l00385"></a><a class="code" href="../../d6/d8/mi386_8h.html#a68">00385</a> <span class="preprocessor">#define ZEROING_PAGE_PTE    ((PMMPTE)((ULONG)IMAGE_MAPPING_PTE + PAGE_SIZE))</span>
00386 <span class="preprocessor"></span>
<a name="l00387"></a><a class="code" href="../../d6/d8/mi386_8h.html#a69">00387</a> <span class="preprocessor">#define WORKING_SET_LIST   ((PVOID)((ULONG)ZEROING_PAGE_PTE + PAGE_SIZE))</span>
00388 <span class="preprocessor"></span>
<a name="l00389"></a><a class="code" href="../../d6/d8/mi386_8h.html#a70">00389</a> <span class="preprocessor">#define MM_MAXIMUM_WORKING_SET MiMaximumWorkingSet</span>
00390 <span class="preprocessor"></span>
<a name="l00391"></a><a class="code" href="../../d6/d8/mi386_8h.html#a206">00391</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d2/d2/data386_8c.html#a20">MiMaximumWorkingSet</a>;
00392 
00393 
<a name="l00394"></a><a class="code" href="../../d6/d8/mi386_8h.html#a71">00394</a> <span class="preprocessor">#define MM_WORKING_SET_END ((ULONG)0xC07FF000)</span>
00395 <span class="preprocessor"></span>
00396 
00397 <span class="comment">//</span>
00398 <span class="comment">// Define masks for fields within the PTE.</span>
00400 <span class="comment"></span>
<a name="l00401"></a><a class="code" href="../../d6/d8/mi386_8h.html#a72">00401</a> <span class="preprocessor">#define MM_PTE_VALID_MASK         0x1</span>
00402 <span class="preprocessor"></span><span class="preprocessor">#if defined(NT_UP)</span>
00403 <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_WRITE_MASK         0x2</span>
00404 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00405"></a><a class="code" href="../../d6/d8/mi386_8h.html#a73">00405</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_WRITE_MASK         0x800</span>
00406 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00407"></a><a class="code" href="../../d6/d8/mi386_8h.html#a74">00407</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_OWNER_MASK         0x4</span>
<a name="l00408"></a><a class="code" href="../../d6/d8/mi386_8h.html#a75">00408</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_WRITE_THROUGH_MASK 0x8</span>
<a name="l00409"></a><a class="code" href="../../d6/d8/mi386_8h.html#a76">00409</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_CACHE_DISABLE_MASK 0x10</span>
<a name="l00410"></a><a class="code" href="../../d6/d8/mi386_8h.html#a77">00410</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_ACCESS_MASK        0x20</span>
00411 <span class="preprocessor"></span><span class="preprocessor">#if defined(NT_UP)</span>
00412 <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_DIRTY_MASK         0x40</span>
00413 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00414"></a><a class="code" href="../../d6/d8/mi386_8h.html#a78">00414</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_DIRTY_MASK         0x42</span>
00415 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00416"></a><a class="code" href="../../d6/d8/mi386_8h.html#a79">00416</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_LARGE_PAGE_MASK    0x80</span>
<a name="l00417"></a><a class="code" href="../../d6/d8/mi386_8h.html#a80">00417</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_GLOBAL_MASK        0x100</span>
<a name="l00418"></a><a class="code" href="../../d6/d8/mi386_8h.html#a81">00418</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_COPY_ON_WRITE_MASK 0x200</span>
<a name="l00419"></a><a class="code" href="../../d6/d8/mi386_8h.html#a82">00419</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_PROTOTYPE_MASK     0x400</span>
<a name="l00420"></a><a class="code" href="../../d6/d8/mi386_8h.html#a83">00420</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TRANSITION_MASK    0x800</span>
00421 <span class="preprocessor"></span>
00422 <span class="comment">//</span>
00423 <span class="comment">// Bit fields to or into PTE to make a PTE valid based on the</span>
00424 <span class="comment">// protection field of the invalid PTE.</span>
00425 <span class="comment">//</span>
00426 
<a name="l00427"></a><a class="code" href="../../d6/d8/mi386_8h.html#a84">00427</a> <span class="preprocessor">#define MM_PTE_NOACCESS          0x0   // not expressable on i386</span>
<a name="l00428"></a><a class="code" href="../../d6/d8/mi386_8h.html#a85">00428</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_READONLY          0x0</span>
<a name="l00429"></a><a class="code" href="../../d6/d8/mi386_8h.html#a86">00429</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_READWRITE         MM_PTE_WRITE_MASK</span>
<a name="l00430"></a><a class="code" href="../../d6/d8/mi386_8h.html#a87">00430</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_WRITECOPY         0x200 // read-only copy on write bit set.</span>
<a name="l00431"></a><a class="code" href="../../d6/d8/mi386_8h.html#a88">00431</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXECUTE           0x0   // read-only on i386</span>
<a name="l00432"></a><a class="code" href="../../d6/d8/mi386_8h.html#a89">00432</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXECUTE_READ      0x0</span>
<a name="l00433"></a><a class="code" href="../../d6/d8/mi386_8h.html#a90">00433</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXECUTE_READWRITE MM_PTE_WRITE_MASK</span>
<a name="l00434"></a><a class="code" href="../../d6/d8/mi386_8h.html#a91">00434</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXECUTE_WRITECOPY 0x200 // read-only copy on write bit set.</span>
<a name="l00435"></a><a class="code" href="../../d6/d8/mi386_8h.html#a92">00435</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_NOCACHE           0x010</span>
<a name="l00436"></a><a class="code" href="../../d6/d8/mi386_8h.html#a93">00436</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_GUARD             0x0  // not expressable on i386</span>
<a name="l00437"></a><a class="code" href="../../d6/d8/mi386_8h.html#a94">00437</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_CACHE             0x0</span>
00438 <span class="preprocessor"></span>
<a name="l00439"></a><a class="code" href="../../d6/d8/mi386_8h.html#a95">00439</a> <span class="preprocessor">#define MM_PROTECT_FIELD_SHIFT 5</span>
00440 <span class="preprocessor"></span>
00441 <span class="comment">//</span>
00442 <span class="comment">// Bits available for the software working set index within the hardware PTE.</span>
00443 <span class="comment">//</span>
00444 
<a name="l00445"></a><a class="code" href="../../d6/d8/mi386_8h.html#a96">00445</a> <span class="preprocessor">#define MI_MAXIMUM_PTE_WORKING_SET_INDEX 0</span>
00446 <span class="preprocessor"></span>
00447 <span class="comment">//</span>
00448 <span class="comment">// Zero PTE</span>
00449 <span class="comment">//</span>
00450 
<a name="l00451"></a><a class="code" href="../../d6/d8/mi386_8h.html#a97">00451</a> <span class="preprocessor">#define MM_ZERO_PTE 0</span>
00452 <span class="preprocessor"></span>
00453 <span class="comment">//</span>
00454 <span class="comment">// Zero Kernel PTE</span>
00455 <span class="comment">//</span>
00456 
<a name="l00457"></a><a class="code" href="../../d6/d8/mi386_8h.html#a98">00457</a> <span class="preprocessor">#define MM_ZERO_KERNEL_PTE 0</span>
00458 <span class="preprocessor"></span>
00459 <span class="comment">//</span>
00460 <span class="comment">// A demand zero PTE with a protection or PAGE_READWRITE.</span>
00461 <span class="comment">//</span>
00462 
<a name="l00463"></a><a class="code" href="../../d6/d8/mi386_8h.html#a99">00463</a> <span class="preprocessor">#define MM_DEMAND_ZERO_WRITE_PTE (MM_READWRITE &lt;&lt; MM_PROTECT_FIELD_SHIFT)</span>
00464 <span class="preprocessor"></span>
00465 
00466 <span class="comment">//</span>
00467 <span class="comment">// A demand zero PTE with a protection or PAGE_READWRITE for system space.</span>
00468 <span class="comment">//</span>
00469 
<a name="l00470"></a><a class="code" href="../../d6/d8/mi386_8h.html#a100">00470</a> <span class="preprocessor">#define MM_KERNEL_DEMAND_ZERO_PTE (MM_READWRITE &lt;&lt; MM_PROTECT_FIELD_SHIFT)</span>
00471 <span class="preprocessor"></span>
00472 <span class="comment">//</span>
00473 <span class="comment">// A no access PTE for system space.</span>
00474 <span class="comment">//</span>
00475 
<a name="l00476"></a><a class="code" href="../../d6/d8/mi386_8h.html#a101">00476</a> <span class="preprocessor">#define MM_KERNEL_NOACCESS_PTE (MM_NOACCESS &lt;&lt; MM_PROTECT_FIELD_SHIFT)</span>
00477 <span class="preprocessor"></span>
00478 <span class="comment">//</span>
00479 <span class="comment">// Kernel stack alignment requirements.</span>
00480 <span class="comment">//</span>
00481 
<a name="l00482"></a><a class="code" href="../../d6/d8/mi386_8h.html#a102">00482</a> <span class="preprocessor">#define MM_STACK_ALIGNMENT 0x0</span>
00483 <span class="preprocessor"></span>
<a name="l00484"></a><a class="code" href="../../d6/d8/mi386_8h.html#a103">00484</a> <span class="preprocessor">#define MM_STACK_OFFSET 0x0</span>
00485 <span class="preprocessor"></span>
00486 <span class="comment">//</span>
00487 <span class="comment">// System process definitions</span>
00488 <span class="comment">//</span>
00489 
<a name="l00490"></a><a class="code" href="../../d6/d8/mi386_8h.html#a104">00490</a> <span class="preprocessor">#define PDE_PER_PAGE ((ULONG)1024)</span>
00491 <span class="preprocessor"></span>
<a name="l00492"></a><a class="code" href="../../d6/d8/mi386_8h.html#a105">00492</a> <span class="preprocessor">#define PTE_PER_PAGE ((ULONG)1024)</span>
00493 <span class="preprocessor"></span>
00494 <span class="comment">//</span>
00495 <span class="comment">// Number of page table pages for user addresses.</span>
00496 <span class="comment">//</span>
00497 
<a name="l00498"></a><a class="code" href="../../d6/d8/mi386_8h.html#a106">00498</a> <span class="preprocessor">#define MM_USER_PAGE_TABLE_PAGES (768)</span>
00499 <span class="preprocessor"></span>
00500 
00501 <span class="comment">//++</span>
00502 <span class="comment">//VOID</span>
00503 <span class="comment">//MI_MAKE_VALID_PTE (</span>
00504 <span class="comment">//    OUT OUTPTE,</span>
00505 <span class="comment">//    IN FRAME,</span>
00506 <span class="comment">//    IN PMASK,</span>
00507 <span class="comment">//    IN PPTE</span>
00508 <span class="comment">//    );</span>
00509 <span class="comment">//</span>
00510 <span class="comment">// Routine Description:</span>
00511 <span class="comment">//</span>
00512 <span class="comment">//    This macro makes a valid PTE from a page frame number, protection mask,</span>
00513 <span class="comment">//    and owner.</span>
00514 <span class="comment">//</span>
00515 <span class="comment">// Arguments</span>
00516 <span class="comment">//</span>
00517 <span class="comment">//    OUTPTE - Supplies the PTE in which to build the transition PTE.</span>
00518 <span class="comment">//</span>
00519 <span class="comment">//    FRAME - Supplies the page frame number for the PTE.</span>
00520 <span class="comment">//</span>
00521 <span class="comment">//    PMASK - Supplies the protection to set in the transition PTE.</span>
00522 <span class="comment">//</span>
00523 <span class="comment">//    PPTE - Supplies a pointer to the PTE which is being made valid.</span>
00524 <span class="comment">//           For prototype PTEs NULL should be specified.</span>
00525 <span class="comment">//</span>
00526 <span class="comment">// Return Value:</span>
00527 <span class="comment">//</span>
00528 <span class="comment">//     None.</span>
00529 <span class="comment">//</span>
00530 <span class="comment">//--</span>
00531 
<a name="l00532"></a><a class="code" href="../../d6/d8/mi386_8h.html#a107">00532</a> <span class="preprocessor">#define MI_MAKE_VALID_PTE(OUTPTE,FRAME,PMASK,PPTE)                            \</span>
00533 <span class="preprocessor">       (OUTPTE).u.Long = ((FRAME &lt;&lt; 12) |                                     \</span>
00534 <span class="preprocessor">                         (MmProtectToPteMask[PMASK]) |                        \</span>
00535 <span class="preprocessor">                          MiDetermineUserGlobalPteMask ((PMMPTE)PPTE));</span>
00536 <span class="preprocessor"></span>
00537 <span class="comment">//++</span>
00538 <span class="comment">//VOID</span>
00539 <span class="comment">//MI_MAKE_VALID_PTE_TRANSITION (</span>
00540 <span class="comment">//    IN OUT OUTPTE</span>
00541 <span class="comment">//    IN PROTECT</span>
00542 <span class="comment">//    );</span>
00543 <span class="comment">//</span>
00544 <span class="comment">// Routine Description:</span>
00545 <span class="comment">//</span>
00546 <span class="comment">//    This macro takes a valid pte and turns it into a transition PTE.</span>
00547 <span class="comment">//</span>
00548 <span class="comment">// Arguments</span>
00549 <span class="comment">//</span>
00550 <span class="comment">//    OUTPTE - Supplies the current valid PTE.  This PTE is then</span>
00551 <span class="comment">//             modified to become a transition PTE.</span>
00552 <span class="comment">//</span>
00553 <span class="comment">//    PROTECT - Supplies the protection to set in the transition PTE.</span>
00554 <span class="comment">//</span>
00555 <span class="comment">// Return Value:</span>
00556 <span class="comment">//</span>
00557 <span class="comment">//     None.</span>
00558 <span class="comment">//</span>
00559 <span class="comment">//--</span>
00560 
<a name="l00561"></a><a class="code" href="../../d6/d8/mi386_8h.html#a108">00561</a> <span class="preprocessor">#define MI_MAKE_VALID_PTE_TRANSITION(OUTPTE,PROTECT) \</span>
00562 <span class="preprocessor">                (OUTPTE).u.Soft.Transition = 1;           \</span>
00563 <span class="preprocessor">                (OUTPTE).u.Soft.Valid = 0;                \</span>
00564 <span class="preprocessor">                (OUTPTE).u.Soft.Prototype = 0;            \</span>
00565 <span class="preprocessor">                (OUTPTE).u.Soft.Protection = PROTECT;</span>
00566 <span class="preprocessor"></span>
00567 <span class="comment">//++</span>
00568 <span class="comment">//VOID</span>
00569 <span class="comment">//MI_MAKE_TRANSITION_PTE (</span>
00570 <span class="comment">//    OUT OUTPTE,</span>
00571 <span class="comment">//    IN PAGE,</span>
00572 <span class="comment">//    IN PROTECT,</span>
00573 <span class="comment">//    IN PPTE</span>
00574 <span class="comment">//    );</span>
00575 <span class="comment">//</span>
00576 <span class="comment">// Routine Description:</span>
00577 <span class="comment">//</span>
00578 <span class="comment">//    This macro takes a valid pte and turns it into a transition PTE.</span>
00579 <span class="comment">//</span>
00580 <span class="comment">// Arguments</span>
00581 <span class="comment">//</span>
00582 <span class="comment">//    OUTPTE - Supplies the PTE in which to build the transition PTE.</span>
00583 <span class="comment">//</span>
00584 <span class="comment">//    PAGE - Supplies the page frame number for the PTE.</span>
00585 <span class="comment">//</span>
00586 <span class="comment">//    PROTECT - Supplies the protection to set in the transition PTE.</span>
00587 <span class="comment">//</span>
00588 <span class="comment">//    PPTE - Supplies a pointer to the PTE, this is used to determine</span>
00589 <span class="comment">//           the owner of the PTE.</span>
00590 <span class="comment">//</span>
00591 <span class="comment">// Return Value:</span>
00592 <span class="comment">//</span>
00593 <span class="comment">//     None.</span>
00594 <span class="comment">//</span>
00595 <span class="comment">//--</span>
00596 
<a name="l00597"></a><a class="code" href="../../d6/d8/mi386_8h.html#a109">00597</a> <span class="preprocessor">#define MI_MAKE_TRANSITION_PTE(OUTPTE,PAGE,PROTECT,PPTE)   \</span>
00598 <span class="preprocessor">                (OUTPTE).u.Long = 0;                       \</span>
00599 <span class="preprocessor">                (OUTPTE).u.Trans.PageFrameNumber = PAGE;   \</span>
00600 <span class="preprocessor">                (OUTPTE).u.Trans.Transition = 1;           \</span>
00601 <span class="preprocessor">                (OUTPTE).u.Trans.Protection = PROTECT;     \</span>
00602 <span class="preprocessor">                (OUTPTE).u.Trans.Owner = MI_DETERMINE_OWNER(PPTE);</span>
00603 <span class="preprocessor"></span>
00604 
00605 <span class="comment">//++</span>
00606 <span class="comment">//VOID</span>
00607 <span class="comment">//MI_MAKE_TRANSITION_PTE_VALID (</span>
00608 <span class="comment">//    OUT OUTPTE,</span>
00609 <span class="comment">//    IN PPTE</span>
00610 <span class="comment">//    );</span>
00611 <span class="comment">//</span>
00612 <span class="comment">// Routine Description:</span>
00613 <span class="comment">//</span>
00614 <span class="comment">//    This macro takes a transition pte and makes it a valid PTE.</span>
00615 <span class="comment">//</span>
00616 <span class="comment">// Arguments</span>
00617 <span class="comment">//</span>
00618 <span class="comment">//    OUTPTE - Supplies the PTE in which to build the valid PTE.</span>
00619 <span class="comment">//</span>
00620 <span class="comment">//    PPTE - Supplies a pointer to the transition PTE.</span>
00621 <span class="comment">//</span>
00622 <span class="comment">// Return Value:</span>
00623 <span class="comment">//</span>
00624 <span class="comment">//     None.</span>
00625 <span class="comment">//</span>
00626 <span class="comment">//--</span>
00627 
<a name="l00628"></a><a class="code" href="../../d6/d8/mi386_8h.html#a110">00628</a> <span class="preprocessor">#define MI_MAKE_TRANSITION_PTE_VALID(OUTPTE,PPTE)                             \</span>
00629 <span class="preprocessor">        ASSERT (((PPTE)-&gt;u.Hard.Valid == 0) &amp;&amp;                                \</span>
00630 <span class="preprocessor">                ((PPTE)-&gt;u.Trans.Prototype == 0) &amp;&amp;                           \</span>
00631 <span class="preprocessor">                ((PPTE)-&gt;u.Trans.Transition == 1));                           \</span>
00632 <span class="preprocessor">       (OUTPTE).u.Long = (((PPTE)-&gt;u.Long &amp; 0xFFFFF000) |                     \</span>
00633 <span class="preprocessor">                         (MmProtectToPteMask[(PPTE)-&gt;u.Trans.Protection]) |   \</span>
00634 <span class="preprocessor">                          MiDetermineUserGlobalPteMask ((PMMPTE)PPTE));</span>
00635 <span class="preprocessor"></span>
00636 <span class="comment">//++</span>
00637 <span class="comment">//VOID</span>
00638 <span class="comment">//MI_SET_PTE_IN_WORKING_SET (</span>
00639 <span class="comment">//    OUT PMMPTE PTE,</span>
00640 <span class="comment">//    IN ULONG WSINDEX</span>
00641 <span class="comment">//    );</span>
00642 <span class="comment">//</span>
00643 <span class="comment">// Routine Description:</span>
00644 <span class="comment">//</span>
00645 <span class="comment">//    This macro inserts the specified working set index into the argument PTE.</span>
00646 <span class="comment">//    Since the i386 PTE has no free bits nothing needs to be done on this</span>
00647 <span class="comment">//    architecture.</span>
00648 <span class="comment">//</span>
00649 <span class="comment">// Arguments</span>
00650 <span class="comment">//</span>
00651 <span class="comment">//    OUTPTE - Supplies the PTE in which to insert the working set index.</span>
00652 <span class="comment">//</span>
00653 <span class="comment">//    WSINDEX - Supplies the working set index for the PTE.</span>
00654 <span class="comment">//</span>
00655 <span class="comment">// Return Value:</span>
00656 <span class="comment">//</span>
00657 <span class="comment">//     None.</span>
00658 <span class="comment">//</span>
00659 <span class="comment">//--</span>
00660 
<a name="l00661"></a><a class="code" href="../../d6/d8/mi386_8h.html#a111">00661</a> <span class="preprocessor">#define MI_SET_PTE_IN_WORKING_SET(PTE, WSINDEX)</span>
00662 <span class="preprocessor"></span>
00663 <span class="comment">//++</span>
00664 <span class="comment">//ULONG WsIndex</span>
00665 <span class="comment">//MI_GET_WORKING_SET_FROM_PTE(</span>
00666 <span class="comment">//    IN PMMPTE PTE</span>
00667 <span class="comment">//    );</span>
00668 <span class="comment">//</span>
00669 <span class="comment">// Routine Description:</span>
00670 <span class="comment">//</span>
00671 <span class="comment">//    This macro returns the working set index from the argument PTE.</span>
00672 <span class="comment">//    Since the i386 PTE has no free bits nothing needs to be done on this</span>
00673 <span class="comment">//    architecture.</span>
00674 <span class="comment">//</span>
00675 <span class="comment">// Arguments</span>
00676 <span class="comment">//</span>
00677 <span class="comment">//    PTE - Supplies the PTE to extract the working set index from.</span>
00678 <span class="comment">//</span>
00679 <span class="comment">// Return Value:</span>
00680 <span class="comment">//</span>
00681 <span class="comment">//    This macro returns the working set index for the argument PTE.</span>
00682 <span class="comment">//</span>
00683 <span class="comment">//--</span>
00684 
<a name="l00685"></a><a class="code" href="../../d6/d8/mi386_8h.html#a112">00685</a> <span class="preprocessor">#define MI_GET_WORKING_SET_FROM_PTE(PTE)  0</span>
00686 <span class="preprocessor"></span>
00687 <span class="comment">//++</span>
00688 <span class="comment">//VOID</span>
00689 <span class="comment">//MI_SET_PTE_WRITE_COMBINE (</span>
00690 <span class="comment">//    IN MMPTE PTE</span>
00691 <span class="comment">//    );</span>
00692 <span class="comment">//</span>
00693 <span class="comment">// Routine Description:</span>
00694 <span class="comment">//</span>
00695 <span class="comment">//    This macro takes a valid PTE and enables WriteCombining as the</span>
00696 <span class="comment">//    caching state.  Note that the PTE bits may only be set this way</span>
00697 <span class="comment">//    if the Page Attribute Table is present and the PAT has been</span>
00698 <span class="comment">//    initialized to provide Write Combining.</span>
00699 <span class="comment">//</span>
00700 <span class="comment">//    If either of the above conditions is not satisfied, then</span>
00701 <span class="comment">//    the macro enables WEAK UC (PCD = 1, PWT = 0) in the PTE.</span>
00702 <span class="comment">//</span>
00703 <span class="comment">// Arguments</span>
00704 <span class="comment">//</span>
00705 <span class="comment">//    PTE - Supplies a valid PTE.</span>
00706 <span class="comment">//</span>
00707 <span class="comment">// Return Value:</span>
00708 <span class="comment">//</span>
00709 <span class="comment">//     None.</span>
00710 <span class="comment">//</span>
00711 <span class="comment">//--</span>
00712 <span class="comment">//</span>
00713 
<a name="l00714"></a><a class="code" href="../../d6/d8/mi386_8h.html#a113">00714</a> <span class="preprocessor">#define MI_SET_PTE_WRITE_COMBINE(PTE) \</span>
00715 <span class="preprocessor">            {                                                               \</span>
00716 <span class="preprocessor">                if (MiWriteCombiningPtes == TRUE) {                         \</span>
00717 <span class="preprocessor">                    ((PTE).u.Hard.CacheDisable = 0);                        \</span>
00718 <span class="preprocessor">                    ((PTE).u.Hard.WriteThrough = 1);                        \</span>
00719 <span class="preprocessor">                } else {                                                    \</span>
00720 <span class="preprocessor">                    ((PTE).u.Hard.CacheDisable = 1);                        \</span>
00721 <span class="preprocessor">                    ((PTE).u.Hard.WriteThrough = 0);                        \</span>
00722 <span class="preprocessor">                }                                                           \</span>
00723 <span class="preprocessor">            }</span>
00724 <span class="preprocessor"></span>
00725 <span class="comment">//++</span>
00726 <span class="comment">//VOID</span>
00727 <span class="comment">//MI_SET_PTE_DIRTY (</span>
00728 <span class="comment">//    IN MMPTE PTE</span>
00729 <span class="comment">//    );</span>
00730 <span class="comment">//</span>
00731 <span class="comment">// Routine Description:</span>
00732 <span class="comment">//</span>
00733 <span class="comment">//    This macro sets the dirty bit(s) in the specified PTE.</span>
00734 <span class="comment">//</span>
00735 <span class="comment">// Arguments</span>
00736 <span class="comment">//</span>
00737 <span class="comment">//    PTE - Supplies the PTE to set dirty.</span>
00738 <span class="comment">//</span>
00739 <span class="comment">// Return Value:</span>
00740 <span class="comment">//</span>
00741 <span class="comment">//     None.</span>
00742 <span class="comment">//</span>
00743 <span class="comment">//--</span>
00744 
<a name="l00745"></a><a class="code" href="../../d6/d8/mi386_8h.html#a114">00745</a> <span class="preprocessor">#define MI_SET_PTE_DIRTY(PTE) (PTE).u.Long |= HARDWARE_PTE_DIRTY_MASK</span>
00746 <span class="preprocessor"></span>
00747 
00748 <span class="comment">//++</span>
00749 <span class="comment">//VOID</span>
00750 <span class="comment">//MI_SET_PTE_CLEAN (</span>
00751 <span class="comment">//    IN MMPTE PTE</span>
00752 <span class="comment">//    );</span>
00753 <span class="comment">//</span>
00754 <span class="comment">// Routine Description:</span>
00755 <span class="comment">//</span>
00756 <span class="comment">//    This macro clears the dirty bit(s) in the specified PTE.</span>
00757 <span class="comment">//</span>
00758 <span class="comment">// Arguments</span>
00759 <span class="comment">//</span>
00760 <span class="comment">//    PTE - Supplies the PTE to set clear.</span>
00761 <span class="comment">//</span>
00762 <span class="comment">// Return Value:</span>
00763 <span class="comment">//</span>
00764 <span class="comment">//     None.</span>
00765 <span class="comment">//</span>
00766 <span class="comment">//--</span>
00767 
<a name="l00768"></a><a class="code" href="../../d6/d8/mi386_8h.html#a115">00768</a> <span class="preprocessor">#define MI_SET_PTE_CLEAN(PTE) (PTE).u.Long &amp;= ~HARDWARE_PTE_DIRTY_MASK</span>
00769 <span class="preprocessor"></span>
00770 
00771 
00772 <span class="comment">//++</span>
00773 <span class="comment">//VOID</span>
00774 <span class="comment">//MI_IS_PTE_DIRTY (</span>
00775 <span class="comment">//    IN MMPTE PTE</span>
00776 <span class="comment">//    );</span>
00777 <span class="comment">//</span>
00778 <span class="comment">// Routine Description:</span>
00779 <span class="comment">//</span>
00780 <span class="comment">//    This macro checks the dirty bit(s) in the specified PTE.</span>
00781 <span class="comment">//</span>
00782 <span class="comment">// Arguments</span>
00783 <span class="comment">//</span>
00784 <span class="comment">//    PTE - Supplies the PTE to check.</span>
00785 <span class="comment">//</span>
00786 <span class="comment">// Return Value:</span>
00787 <span class="comment">//</span>
00788 <span class="comment">//    TRUE if the page is dirty (modified), FALSE otherwise.</span>
00789 <span class="comment">//</span>
00790 <span class="comment">//--</span>
00791 
<a name="l00792"></a><a class="code" href="../../d6/d8/mi386_8h.html#a116">00792</a> <span class="preprocessor">#define MI_IS_PTE_DIRTY(PTE) ((PTE).u.Hard.Dirty != 0)</span>
00793 <span class="preprocessor"></span>
00794 
00795 
00796 <span class="comment">//++</span>
00797 <span class="comment">//VOID</span>
00798 <span class="comment">//MI_SET_GLOBAL_BIT_IF_SYSTEM (</span>
00799 <span class="comment">//    OUT OUTPTE,</span>
00800 <span class="comment">//    IN PPTE</span>
00801 <span class="comment">//    );</span>
00802 <span class="comment">//</span>
00803 <span class="comment">// Routine Description:</span>
00804 <span class="comment">//</span>
00805 <span class="comment">//    This macro sets the global bit if the pointer PTE is within</span>
00806 <span class="comment">//    system space.</span>
00807 <span class="comment">//</span>
00808 <span class="comment">// Arguments</span>
00809 <span class="comment">//</span>
00810 <span class="comment">//    OUTPTE - Supplies the PTE in which to build the valid PTE.</span>
00811 <span class="comment">//</span>
00812 <span class="comment">//    PPTE - Supplies a pointer to the PTE becoming valid.</span>
00813 <span class="comment">//</span>
00814 <span class="comment">// Return Value:</span>
00815 <span class="comment">//</span>
00816 <span class="comment">//     None.</span>
00817 <span class="comment">//</span>
00818 <span class="comment">//--</span>
00819 
<a name="l00820"></a><a class="code" href="../../d6/d8/mi386_8h.html#a117">00820</a> <span class="preprocessor">#define MI_SET_GLOBAL_BIT_IF_SYSTEM(OUTPTE,PPTE)                             \</span>
00821 <span class="preprocessor">   if ((((PMMPTE)PPTE) &gt; MiHighestUserPte) &amp;&amp;                                \</span>
00822 <span class="preprocessor">       ((((PMMPTE)PPTE) &lt;= MiGetPteAddress (PTE_BASE)) ||                    \</span>
00823 <span class="preprocessor">       (((PMMPTE)PPTE) &gt;= MiGetPteAddress (MM_SYSTEM_CACHE_WORKING_SET)))) { \</span>
00824 <span class="preprocessor">           (OUTPTE).u.Long |= MmPteGlobal.u.Long;                            \</span>
00825 <span class="preprocessor">   }                                                                         \</span>
00826 <span class="preprocessor">   else {                                                                    \</span>
00827 <span class="preprocessor">           (OUTPTE).u.Long &amp;= ~MmPteGlobal.u.Long;                           \</span>
00828 <span class="preprocessor">   }</span>
00829 <span class="preprocessor"></span>
00830 
00831 <span class="comment">//++</span>
00832 <span class="comment">//VOID</span>
00833 <span class="comment">//MI_SET_GLOBAL_STATE (</span>
00834 <span class="comment">//    IN MMPTE PTE,</span>
00835 <span class="comment">//    IN ULONG STATE</span>
00836 <span class="comment">//    );</span>
00837 <span class="comment">//</span>
00838 <span class="comment">// Routine Description:</span>
00839 <span class="comment">//</span>
00840 <span class="comment">//    This macro sets the global bit in the PTE. if the pointer PTE is within</span>
00841 <span class="comment">//</span>
00842 <span class="comment">// Arguments</span>
00843 <span class="comment">//</span>
00844 <span class="comment">//    PTE - Supplies the PTE to set global state into.</span>
00845 <span class="comment">//</span>
00846 <span class="comment">//    STATE - Supplies 1 if global, 0 if not.</span>
00847 <span class="comment">//</span>
00848 <span class="comment">// Return Value:</span>
00849 <span class="comment">//</span>
00850 <span class="comment">//     None.</span>
00851 <span class="comment">//</span>
00852 <span class="comment">//--</span>
00853 
<a name="l00854"></a><a class="code" href="../../d6/d8/mi386_8h.html#a118">00854</a> <span class="preprocessor">#define MI_SET_GLOBAL_STATE(PTE,STATE)                              \</span>
00855 <span class="preprocessor">           if (STATE) {                                             \</span>
00856 <span class="preprocessor">               (PTE).u.Long |= MmPteGlobal.u.Long;                  \</span>
00857 <span class="preprocessor">           }                                                        \</span>
00858 <span class="preprocessor">           else {                                                   \</span>
00859 <span class="preprocessor">               (PTE).u.Long &amp;= ~MmPteGlobal.u.Long;                 \</span>
00860 <span class="preprocessor">           }</span>
00861 <span class="preprocessor"></span>
00862 
00863 
00864 
00865 
00866 <span class="comment">//++</span>
00867 <span class="comment">//VOID</span>
00868 <span class="comment">//MI_ENABLE_CACHING (</span>
00869 <span class="comment">//    IN MMPTE PTE</span>
00870 <span class="comment">//    );</span>
00871 <span class="comment">//</span>
00872 <span class="comment">// Routine Description:</span>
00873 <span class="comment">//</span>
00874 <span class="comment">//    This macro takes a valid PTE and sets the caching state to be</span>
00875 <span class="comment">//    enabled.  This is performed by clearing the PCD and PWT bits in the PTE.</span>
00876 <span class="comment">//</span>
00877 <span class="comment">//    Semantics of the overlap between PCD, PWT, and the</span>
00878 <span class="comment">//    USWC memory type in the MTRR are:</span>
00879 <span class="comment">//</span>
00880 <span class="comment">//    PCD   PWT   Mtrr Mem Type      Effective Memory Type</span>
00881 <span class="comment">//     1     0    USWC               USWC</span>
00882 <span class="comment">//     1     1    USWC               UC</span>
00883 <span class="comment">//</span>
00884 <span class="comment">// Arguments</span>
00885 <span class="comment">//</span>
00886 <span class="comment">//    PTE - Supplies a valid PTE.</span>
00887 <span class="comment">//</span>
00888 <span class="comment">// Return Value:</span>
00889 <span class="comment">//</span>
00890 <span class="comment">//     None.</span>
00891 <span class="comment">//</span>
00892 <span class="comment">//--</span>
00893 
<a name="l00894"></a><a class="code" href="../../d6/d8/mi386_8h.html#a119">00894</a> <span class="preprocessor">#define MI_ENABLE_CACHING(PTE) \</span>
00895 <span class="preprocessor">            {                                                                \</span>
00896 <span class="preprocessor">                ((PTE).u.Hard.CacheDisable = 0);                             \</span>
00897 <span class="preprocessor">                ((PTE).u.Hard.WriteThrough = 0);                             \</span>
00898 <span class="preprocessor">            }</span>
00899 <span class="preprocessor"></span>
00900 
00901 
00902 <span class="comment">//++</span>
00903 <span class="comment">//VOID</span>
00904 <span class="comment">//MI_DISABLE_CACHING (</span>
00905 <span class="comment">//    IN MMPTE PTE</span>
00906 <span class="comment">//    );</span>
00907 <span class="comment">//</span>
00908 <span class="comment">// Routine Description:</span>
00909 <span class="comment">//</span>
00910 <span class="comment">//    This macro takes a valid PTE and sets the caching state to be</span>
00911 <span class="comment">//    disabled.  This is performed by setting the PCD and PWT bits in the PTE.</span>
00912 <span class="comment">//</span>
00913 <span class="comment">//    Semantics of the overlap between PCD, PWT, and the</span>
00914 <span class="comment">//    USWC memory type in the MTRR are:</span>
00915 <span class="comment">//</span>
00916 <span class="comment">//    PCD   PWT   Mtrr Mem Type      Effective Memory Type</span>
00917 <span class="comment">//     1     0    USWC               USWC</span>
00918 <span class="comment">//     1     1    USWC               UC</span>
00919 <span class="comment">//</span>
00920 <span class="comment">//    Since an effective memory type of UC is desired here,</span>
00921 <span class="comment">//    the WT bit is set.</span>
00922 <span class="comment">//</span>
00923 <span class="comment">// Arguments</span>
00924 <span class="comment">//</span>
00925 <span class="comment">//    PTE - Supplies a pointer to the valid PTE.</span>
00926 <span class="comment">//</span>
00927 <span class="comment">// Return Value:</span>
00928 <span class="comment">//</span>
00929 <span class="comment">//     None.</span>
00930 <span class="comment">//</span>
00931 <span class="comment">//--</span>
00932 
00933 
<a name="l00934"></a><a class="code" href="../../d6/d8/mi386_8h.html#a120">00934</a> <span class="preprocessor">#define MI_DISABLE_CACHING(PTE) \</span>
00935 <span class="preprocessor">            {                                                                \</span>
00936 <span class="preprocessor">                ((PTE).u.Hard.CacheDisable = 1);                             \</span>
00937 <span class="preprocessor">                ((PTE).u.Hard.WriteThrough = 1);                             \</span>
00938 <span class="preprocessor">            }</span>
00939 <span class="preprocessor"></span>
00940 
00941 
00942 
00943 <span class="comment">//++</span>
00944 <span class="comment">//BOOLEAN</span>
00945 <span class="comment">//MI_IS_CACHING_DISABLED (</span>
00946 <span class="comment">//    IN PMMPTE PPTE</span>
00947 <span class="comment">//    );</span>
00948 <span class="comment">//</span>
00949 <span class="comment">// Routine Description:</span>
00950 <span class="comment">//</span>
00951 <span class="comment">//    This macro takes a valid PTE and returns TRUE if caching is</span>
00952 <span class="comment">//    disabled.</span>
00953 <span class="comment">//</span>
00954 <span class="comment">// Arguments</span>
00955 <span class="comment">//</span>
00956 <span class="comment">//    PPTE - Supplies a pointer to the valid PTE.</span>
00957 <span class="comment">//</span>
00958 <span class="comment">// Return Value:</span>
00959 <span class="comment">//</span>
00960 <span class="comment">//     TRUE if caching is disabled, FALSE if it is enabled.</span>
00961 <span class="comment">//</span>
00962 <span class="comment">//--</span>
00963 
<a name="l00964"></a><a class="code" href="../../d6/d8/mi386_8h.html#a121">00964</a> <span class="preprocessor">#define MI_IS_CACHING_DISABLED(PPTE)   \</span>
00965 <span class="preprocessor">            ((PPTE)-&gt;u.Hard.CacheDisable == 1)</span>
00966 <span class="preprocessor"></span>
00967 
00968 
00969 <span class="comment">//++</span>
00970 <span class="comment">//VOID</span>
00971 <span class="comment">//MI_SET_PFN_DELETED (</span>
00972 <span class="comment">//    IN PMMPFN PPFN</span>
00973 <span class="comment">//    );</span>
00974 <span class="comment">//</span>
00975 <span class="comment">// Routine Description:</span>
00976 <span class="comment">//</span>
00977 <span class="comment">//    This macro takes a pointer to a PFN element and indicates that</span>
00978 <span class="comment">//    the PFN is no longer in use.</span>
00979 <span class="comment">//</span>
00980 <span class="comment">// Arguments</span>
00981 <span class="comment">//</span>
00982 <span class="comment">//    PPTE - Supplies a pointer to the PFN element.</span>
00983 <span class="comment">//</span>
00984 <span class="comment">// Return Value:</span>
00985 <span class="comment">//</span>
00986 <span class="comment">//    none.</span>
00987 <span class="comment">//</span>
00988 <span class="comment">//--</span>
00989 
<a name="l00990"></a><a class="code" href="../../d6/d8/mi386_8h.html#a122">00990</a> <span class="preprocessor">#define MI_SET_PFN_DELETED(PPFN) \</span>
00991 <span class="preprocessor">    PERFINFO_DELETE_PAGE(PPFN); \</span>
00992 <span class="preprocessor">    PPFN-&gt;PteAddress = (PMMPTE)0xFFFFFFFF;</span>
00993 <span class="preprocessor"></span>
00994 
00995 
00996 
00997 <span class="comment">//++</span>
00998 <span class="comment">//BOOLEAN</span>
00999 <span class="comment">//MI_IS_PFN_DELETED (</span>
01000 <span class="comment">//    IN PMMPFN PPFN</span>
01001 <span class="comment">//    );</span>
01002 <span class="comment">//</span>
01003 <span class="comment">// Routine Description:</span>
01004 <span class="comment">//</span>
01005 <span class="comment">//    This macro takes a pointer to a PFN element and determines if</span>
01006 <span class="comment">//    the PFN is no longer in use.</span>
01007 <span class="comment">//</span>
01008 <span class="comment">// Arguments</span>
01009 <span class="comment">//</span>
01010 <span class="comment">//    PPTE - Supplies a pointer to the PFN element.</span>
01011 <span class="comment">//</span>
01012 <span class="comment">// Return Value:</span>
01013 <span class="comment">//</span>
01014 <span class="comment">//     TRUE if PFN is no longer used, FALSE if it is still being used.</span>
01015 <span class="comment">//</span>
01016 <span class="comment">//--</span>
01017 
<a name="l01018"></a><a class="code" href="../../d6/d8/mi386_8h.html#a123">01018</a> <span class="preprocessor">#define MI_IS_PFN_DELETED(PPFN)   \</span>
01019 <span class="preprocessor">            ((PPFN)-&gt;PteAddress == (PMMPTE)(ULONG_PTR)0xFFFFFFFF)</span>
01020 <span class="preprocessor"></span>
01021 
01022 <span class="comment">//++</span>
01023 <span class="comment">//VOID</span>
01024 <span class="comment">//MI_CHECK_PAGE_ALIGNMENT (</span>
01025 <span class="comment">//    IN ULONG PAGE,</span>
01026 <span class="comment">//    IN PMMPTE PPTE</span>
01027 <span class="comment">//    );</span>
01028 <span class="comment">//</span>
01029 <span class="comment">// Routine Description:</span>
01030 <span class="comment">//</span>
01031 <span class="comment">//    This macro takes a PFN element number (Page) and checks to see</span>
01032 <span class="comment">//    if the virtual alignment for the previous address of the page</span>
01033 <span class="comment">//    is compatible with the new address of the page.  If they are</span>
01034 <span class="comment">//    not compatible, the D cache is flushed.</span>
01035 <span class="comment">//</span>
01036 <span class="comment">// Arguments</span>
01037 <span class="comment">//</span>
01038 <span class="comment">//    PAGE - Supplies the PFN element.</span>
01039 <span class="comment">//    PPTE - Supplies a pointer to the new PTE which will contain the page.</span>
01040 <span class="comment">//</span>
01041 <span class="comment">// Return Value:</span>
01042 <span class="comment">//</span>
01043 <span class="comment">//    none.</span>
01044 <span class="comment">//</span>
01045 <span class="comment">//--</span>
01046 
01047 <span class="comment">// does nothing on i386.</span>
01048 
<a name="l01049"></a><a class="code" href="../../d6/d8/mi386_8h.html#a124">01049</a> <span class="preprocessor">#define MI_CHECK_PAGE_ALIGNMENT(PAGE,PPTE)</span>
01050 <span class="preprocessor"></span>
01051 
01052 
01053 
01054 <span class="comment">//++</span>
01055 <span class="comment">//VOID</span>
01056 <span class="comment">//MI_INITIALIZE_HYPERSPACE_MAP (</span>
01057 <span class="comment">//    VOID</span>
01058 <span class="comment">//    );</span>
01059 <span class="comment">//</span>
01060 <span class="comment">// Routine Description:</span>
01061 <span class="comment">//</span>
01062 <span class="comment">//    This macro initializes the PTEs reserved for double mapping within</span>
01063 <span class="comment">//    hyperspace.</span>
01064 <span class="comment">//</span>
01065 <span class="comment">// Arguments</span>
01066 <span class="comment">//</span>
01067 <span class="comment">//    None.</span>
01068 <span class="comment">//</span>
01069 <span class="comment">// Return Value:</span>
01070 <span class="comment">//</span>
01071 <span class="comment">//    None.</span>
01072 <span class="comment">//</span>
01073 <span class="comment">//--</span>
01074 
01075 <span class="comment">// does nothing on i386.</span>
01076 
<a name="l01077"></a><a class="code" href="../../d6/d8/mi386_8h.html#a125">01077</a> <span class="preprocessor">#define MI_INITIALIZE_HYPERSPACE_MAP(INDEX)</span>
01078 <span class="preprocessor"></span>
01079 
01080 <span class="comment">//++</span>
01081 <span class="comment">//ULONG</span>
01082 <span class="comment">//MI_GET_PAGE_COLOR_FROM_PTE (</span>
01083 <span class="comment">//    IN PMMPTE PTEADDRESS</span>
01084 <span class="comment">//    );</span>
01085 <span class="comment">//</span>
01086 <span class="comment">// Routine Description:</span>
01087 <span class="comment">//</span>
01088 <span class="comment">//    This macro determines the page's color based on the PTE address</span>
01089 <span class="comment">//    that maps the page.</span>
01090 <span class="comment">//</span>
01091 <span class="comment">// Arguments</span>
01092 <span class="comment">//</span>
01093 <span class="comment">//    PTEADDRESS - Supplies the PTE address the page is (or was) mapped at.</span>
01094 <span class="comment">//</span>
01095 <span class="comment">// Return Value:</span>
01096 <span class="comment">//</span>
01097 <span class="comment">//    The page's color.</span>
01098 <span class="comment">//</span>
01099 <span class="comment">//--</span>
01100 
<a name="l01101"></a><a class="code" href="../../d6/d8/mi386_8h.html#a126">01101</a> <span class="preprocessor">#define MI_GET_PAGE_COLOR_FROM_PTE(PTEADDRESS)  \</span>
01102 <span class="preprocessor">         ((ULONG)((MmSystemPageColor++) &amp; MmSecondaryColorMask))</span>
01103 <span class="preprocessor"></span>
01104 
01105 
01106 <span class="comment">//++</span>
01107 <span class="comment">//ULONG</span>
01108 <span class="comment">//MI_GET_PAGE_COLOR_FROM_VA (</span>
01109 <span class="comment">//    IN PVOID ADDRESS</span>
01110 <span class="comment">//    );</span>
01111 <span class="comment">//</span>
01112 <span class="comment">// Routine Description:</span>
01113 <span class="comment">//</span>
01114 <span class="comment">//    This macro determines the page's color based on the PTE address</span>
01115 <span class="comment">//    that maps the page.</span>
01116 <span class="comment">//</span>
01117 <span class="comment">// Arguments</span>
01118 <span class="comment">//</span>
01119 <span class="comment">//    ADDRESS - Supplies the address the page is (or was) mapped at.</span>
01120 <span class="comment">//</span>
01121 <span class="comment">// Return Value:</span>
01122 <span class="comment">//</span>
01123 <span class="comment">//    The page's color.</span>
01124 <span class="comment">//</span>
01125 <span class="comment">//--</span>
01126 
01127 
<a name="l01128"></a><a class="code" href="../../d6/d8/mi386_8h.html#a127">01128</a> <span class="preprocessor">#define MI_GET_PAGE_COLOR_FROM_VA(ADDRESS)  \</span>
01129 <span class="preprocessor">         ((ULONG)((MmSystemPageColor++) &amp; MmSecondaryColorMask))</span>
01130 <span class="preprocessor"></span>
01131 <span class="comment">//++</span>
01132 <span class="comment">//ULONG</span>
01133 <span class="comment">//MI_GET_PAGE_COLOR_FROM_SESSION (</span>
01134 <span class="comment">//    IN PMM_SESSION_SPACE SessionSpace</span>
01135 <span class="comment">//    );</span>
01136 <span class="comment">//</span>
01137 <span class="comment">// Routine Description:</span>
01138 <span class="comment">//</span>
01139 <span class="comment">//    This macro determines the page's color based on the PTE address</span>
01140 <span class="comment">//    that maps the page.</span>
01141 <span class="comment">//</span>
01142 <span class="comment">// Arguments</span>
01143 <span class="comment">//</span>
01144 <span class="comment">//    SessionSpace - Supplies the session space the page will be mapped into.</span>
01145 <span class="comment">//</span>
01146 <span class="comment">// Return Value:</span>
01147 <span class="comment">//</span>
01148 <span class="comment">//    The page's color.</span>
01149 <span class="comment">//</span>
01150 <span class="comment">//--</span>
01151 
01152 
<a name="l01153"></a><a class="code" href="../../d6/d8/mi386_8h.html#a128">01153</a> <span class="preprocessor">#define MI_GET_PAGE_COLOR_FROM_SESSION(_SessionSpace)  \</span>
01154 <span class="preprocessor">         ((ULONG)((_SessionSpace-&gt;Color++) &amp; MmSecondaryColorMask))</span>
01155 <span class="preprocessor"></span>
01156 
01157 
01158 <span class="comment">//++</span>
01159 <span class="comment">//ULONG</span>
01160 <span class="comment">//MI_PAGE_COLOR_PTE_PROCESS (</span>
01161 <span class="comment">//    IN PCHAR COLOR,</span>
01162 <span class="comment">//    IN PMMPTE PTE</span>
01163 <span class="comment">//    );</span>
01164 <span class="comment">//</span>
01165 <span class="comment">// Routine Description:</span>
01166 <span class="comment">//</span>
01167 <span class="comment">//    This macro determines the page's color based on the PTE address</span>
01168 <span class="comment">//    that maps the page.</span>
01169 <span class="comment">//</span>
01170 <span class="comment">// Arguments</span>
01171 <span class="comment">//</span>
01172 <span class="comment">//</span>
01173 <span class="comment">// Return Value:</span>
01174 <span class="comment">//</span>
01175 <span class="comment">//    The page's color.</span>
01176 <span class="comment">//</span>
01177 <span class="comment">//--</span>
01178 
01179 
<a name="l01180"></a><a class="code" href="../../d6/d8/mi386_8h.html#a129">01180</a> <span class="preprocessor">#define MI_PAGE_COLOR_PTE_PROCESS(PTE,COLOR)  \</span>
01181 <span class="preprocessor">         ((ULONG)((*(COLOR))++) &amp; MmSecondaryColorMask)</span>
01182 <span class="preprocessor"></span>
01183 
01184 <span class="comment">//++</span>
01185 <span class="comment">//ULONG</span>
01186 <span class="comment">//MI_PAGE_COLOR_VA_PROCESS (</span>
01187 <span class="comment">//    IN PVOID ADDRESS,</span>
01188 <span class="comment">//    IN PEPROCESS COLOR</span>
01189 <span class="comment">//    );</span>
01190 <span class="comment">//</span>
01191 <span class="comment">// Routine Description:</span>
01192 <span class="comment">//</span>
01193 <span class="comment">//    This macro determines the page's color based on the PTE address</span>
01194 <span class="comment">//    that maps the page.</span>
01195 <span class="comment">//</span>
01196 <span class="comment">// Arguments</span>
01197 <span class="comment">//</span>
01198 <span class="comment">//    ADDRESS - Supplies the address the page is (or was) mapped at.</span>
01199 <span class="comment">//</span>
01200 <span class="comment">// Return Value:</span>
01201 <span class="comment">//</span>
01202 <span class="comment">//    The page's color.</span>
01203 <span class="comment">//</span>
01204 <span class="comment">//--</span>
01205 
<a name="l01206"></a><a class="code" href="../../d6/d8/mi386_8h.html#a130">01206</a> <span class="preprocessor">#define MI_PAGE_COLOR_VA_PROCESS(ADDRESS,COLOR) \</span>
01207 <span class="preprocessor">         ((ULONG)((*(COLOR))++) &amp; MmSecondaryColorMask)</span>
01208 <span class="preprocessor"></span>
01209 
01210 
01211 <span class="comment">//++</span>
01212 <span class="comment">//ULONG</span>
01213 <span class="comment">//MI_GET_NEXT_COLOR (</span>
01214 <span class="comment">//    IN ULONG COLOR</span>
01215 <span class="comment">//    );</span>
01216 <span class="comment">//</span>
01217 <span class="comment">// Routine Description:</span>
01218 <span class="comment">//</span>
01219 <span class="comment">//    This macro returns the next color in the sequence.</span>
01220 <span class="comment">//</span>
01221 <span class="comment">// Arguments</span>
01222 <span class="comment">//</span>
01223 <span class="comment">//    COLOR - Supplies the color to return the next of.</span>
01224 <span class="comment">//</span>
01225 <span class="comment">// Return Value:</span>
01226 <span class="comment">//</span>
01227 <span class="comment">//    Next color in sequence.</span>
01228 <span class="comment">//</span>
01229 <span class="comment">//--</span>
01230 
<a name="l01231"></a><a class="code" href="../../d6/d8/mi386_8h.html#a131">01231</a> <span class="preprocessor">#define MI_GET_NEXT_COLOR(COLOR)  ((COLOR + 1) &amp; MM_COLOR_MASK)</span>
01232 <span class="preprocessor"></span>
01233 
01234 <span class="comment">//++</span>
01235 <span class="comment">//ULONG</span>
01236 <span class="comment">//MI_GET_PREVIOUS_COLOR (</span>
01237 <span class="comment">//    IN ULONG COLOR</span>
01238 <span class="comment">//    );</span>
01239 <span class="comment">//</span>
01240 <span class="comment">// Routine Description:</span>
01241 <span class="comment">//</span>
01242 <span class="comment">//    This macro returns the previous color in the sequence.</span>
01243 <span class="comment">//</span>
01244 <span class="comment">// Arguments</span>
01245 <span class="comment">//</span>
01246 <span class="comment">//    COLOR - Supplies the color to return the previous of.</span>
01247 <span class="comment">//</span>
01248 <span class="comment">// Return Value:</span>
01249 <span class="comment">//</span>
01250 <span class="comment">//    Previous color in sequence.</span>
01251 <span class="comment">//</span>
01252 <span class="comment">//--</span>
01253 
<a name="l01254"></a><a class="code" href="../../d6/d8/mi386_8h.html#a132">01254</a> <span class="preprocessor">#define MI_GET_PREVIOUS_COLOR(COLOR)  (0)</span>
01255 <span class="preprocessor"></span>
01256 
<a name="l01257"></a><a class="code" href="../../d6/d8/mi386_8h.html#a133">01257</a> <span class="preprocessor">#define MI_GET_SECONDARY_COLOR(PAGE,PFN) (PAGE &amp; MmSecondaryColorMask)</span>
01258 <span class="preprocessor"></span>
01259 
<a name="l01260"></a><a class="code" href="../../d6/d8/mi386_8h.html#a134">01260</a> <span class="preprocessor">#define MI_GET_COLOR_FROM_SECONDARY(SECONDARY_COLOR) (0)</span>
01261 <span class="preprocessor"></span>
01262 
01263 <span class="comment">//++</span>
01264 <span class="comment">//VOID</span>
01265 <span class="comment">//MI_GET_MODIFIED_PAGE_BY_COLOR (</span>
01266 <span class="comment">//    OUT ULONG PAGE,</span>
01267 <span class="comment">//    IN ULONG COLOR</span>
01268 <span class="comment">//    );</span>
01269 <span class="comment">//</span>
01270 <span class="comment">// Routine Description:</span>
01271 <span class="comment">//</span>
01272 <span class="comment">//    This macro returns the first page destined for a paging</span>
01273 <span class="comment">//    file with the desired color.  It does NOT remove the page</span>
01274 <span class="comment">//    from its list.</span>
01275 <span class="comment">//</span>
01276 <span class="comment">// Arguments</span>
01277 <span class="comment">//</span>
01278 <span class="comment">//    PAGE - Returns the page located, the value MM_EMPTY_LIST is</span>
01279 <span class="comment">//           returned if there is no page of the specified color.</span>
01280 <span class="comment">//</span>
01281 <span class="comment">//    COLOR - Supplies the color of page to locate.</span>
01282 <span class="comment">//</span>
01283 <span class="comment">// Return Value:</span>
01284 <span class="comment">//</span>
01285 <span class="comment">//    none.</span>
01286 <span class="comment">//</span>
01287 <span class="comment">//--</span>
01288 
<a name="l01289"></a><a class="code" href="../../d6/d8/mi386_8h.html#a135">01289</a> <span class="preprocessor">#define MI_GET_MODIFIED_PAGE_BY_COLOR(PAGE,COLOR) \</span>
01290 <span class="preprocessor">            PAGE = MmModifiedPageListByColor[COLOR].Flink</span>
01291 <span class="preprocessor"></span>
01292 
01293 <span class="comment">//++</span>
01294 <span class="comment">//VOID</span>
01295 <span class="comment">//MI_GET_MODIFIED_PAGE_ANY_COLOR (</span>
01296 <span class="comment">//    OUT ULONG PAGE,</span>
01297 <span class="comment">//    IN OUT ULONG COLOR</span>
01298 <span class="comment">//    );</span>
01299 <span class="comment">//</span>
01300 <span class="comment">// Routine Description:</span>
01301 <span class="comment">//</span>
01302 <span class="comment">//    This macro returns the first page destined for a paging</span>
01303 <span class="comment">//    file with the desired color.  If not page of the desired</span>
01304 <span class="comment">//    color exists, all colored lists are searched for a page.</span>
01305 <span class="comment">//    It does NOT remove the page from its list.</span>
01306 <span class="comment">//</span>
01307 <span class="comment">// Arguments</span>
01308 <span class="comment">//</span>
01309 <span class="comment">//    PAGE - Returns the page located, the value MM_EMPTY_LIST is</span>
01310 <span class="comment">//           returned if there is no page of the specified color.</span>
01311 <span class="comment">//</span>
01312 <span class="comment">//    COLOR - Supplies the color of page to locate and returns the</span>
01313 <span class="comment">//            color of the page located.</span>
01314 <span class="comment">//</span>
01315 <span class="comment">// Return Value:</span>
01316 <span class="comment">//</span>
01317 <span class="comment">//    none.</span>
01318 <span class="comment">//</span>
01319 <span class="comment">//--</span>
01320 
<a name="l01321"></a><a class="code" href="../../d6/d8/mi386_8h.html#a136">01321</a> <span class="preprocessor">#define MI_GET_MODIFIED_PAGE_ANY_COLOR(PAGE,COLOR) \</span>
01322 <span class="preprocessor">            {                                                                \</span>
01323 <span class="preprocessor">                if (MmTotalPagesForPagingFile == 0) {                        \</span>
01324 <span class="preprocessor">                    PAGE = MM_EMPTY_LIST;                                    \</span>
01325 <span class="preprocessor">                } else {                                                     \</span>
01326 <span class="preprocessor">                    PAGE = MmModifiedPageListByColor[COLOR].Flink;           \</span>
01327 <span class="preprocessor">                }                                                            \</span>
01328 <span class="preprocessor">            }</span>
01329 <span class="preprocessor"></span>
01330 
01331 
01332 <span class="comment">//++</span>
01333 <span class="comment">//VOID</span>
01334 <span class="comment">//MI_MAKE_VALID_PTE_WRITE_COPY (</span>
01335 <span class="comment">//    IN OUT PMMPTE PTE</span>
01336 <span class="comment">//    );</span>
01337 <span class="comment">//</span>
01338 <span class="comment">// Routine Description:</span>
01339 <span class="comment">//</span>
01340 <span class="comment">//    This macro checks to see if the PTE indicates that the</span>
01341 <span class="comment">//    page is writable and if so it clears the write bit and</span>
01342 <span class="comment">//    sets the copy-on-write bit.</span>
01343 <span class="comment">//</span>
01344 <span class="comment">// Arguments</span>
01345 <span class="comment">//</span>
01346 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01347 <span class="comment">//</span>
01348 <span class="comment">// Return Value:</span>
01349 <span class="comment">//</span>
01350 <span class="comment">//     None.</span>
01351 <span class="comment">//</span>
01352 <span class="comment">//--</span>
01353 
01354 <span class="preprocessor">#if defined(NT_UP)</span>
01355 <span class="preprocessor"></span><span class="preprocessor">#define MI_MAKE_VALID_PTE_WRITE_COPY(PPTE) \</span>
01356 <span class="preprocessor">                    if ((PPTE)-&gt;u.Hard.Write == 1) {    \</span>
01357 <span class="preprocessor">                        (PPTE)-&gt;u.Hard.CopyOnWrite = 1; \</span>
01358 <span class="preprocessor">                        (PPTE)-&gt;u.Hard.Write = 0;       \</span>
01359 <span class="preprocessor">                    }</span>
01360 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01361"></a><a class="code" href="../../d6/d8/mi386_8h.html#a137">01361</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_MAKE_VALID_PTE_WRITE_COPY(PPTE) \</span>
01362 <span class="preprocessor">                    if ((PPTE)-&gt;u.Hard.Write == 1) {    \</span>
01363 <span class="preprocessor">                        (PPTE)-&gt;u.Hard.CopyOnWrite = 1; \</span>
01364 <span class="preprocessor">                        (PPTE)-&gt;u.Hard.Write = 0;       \</span>
01365 <span class="preprocessor">                        (PPTE)-&gt;u.Hard.Writable = 0;    \</span>
01366 <span class="preprocessor">                    }</span>
01367 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01368 <span class="preprocessor"></span>
01369 
01370 
01371 <span class="comment">//++</span>
01372 <span class="comment">//ULONG</span>
01373 <span class="comment">//MI_DETERMINE_OWNER (</span>
01374 <span class="comment">//    IN MMPTE PPTE</span>
01375 <span class="comment">//    );</span>
01376 <span class="comment">//</span>
01377 <span class="comment">// Routine Description:</span>
01378 <span class="comment">//</span>
01379 <span class="comment">//    This macro examines the virtual address of the PTE and determines</span>
01380 <span class="comment">//    if the PTE resides in system space or user space.</span>
01381 <span class="comment">//</span>
01382 <span class="comment">// Arguments</span>
01383 <span class="comment">//</span>
01384 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01385 <span class="comment">//</span>
01386 <span class="comment">// Return Value:</span>
01387 <span class="comment">//</span>
01388 <span class="comment">//     1 if the owner is USER_MODE, 0 if the owner is KERNEL_MODE.</span>
01389 <span class="comment">//</span>
01390 <span class="comment">//--</span>
01391 
<a name="l01392"></a><a class="code" href="../../d6/d8/mi386_8h.html#a138">01392</a> <span class="preprocessor">#define MI_DETERMINE_OWNER(PPTE)   \</span>
01393 <span class="preprocessor">    ((((PPTE) &lt;= MiHighestUserPte) ||                                       \</span>
01394 <span class="preprocessor">      ((PPTE) &gt;= MiGetPdeAddress(NULL) &amp;&amp;                                   \</span>
01395 <span class="preprocessor">      ((PPTE) &lt;= MiHighestUserPde))) ? 1 : 0)</span>
01396 <span class="preprocessor"></span>
01397 
01398 
01399 <span class="comment">//++</span>
01400 <span class="comment">//VOID</span>
01401 <span class="comment">//MI_SET_ACCESSED_IN_PTE (</span>
01402 <span class="comment">//    IN OUT MMPTE PPTE</span>
01403 <span class="comment">//    );</span>
01404 <span class="comment">//</span>
01405 <span class="comment">// Routine Description:</span>
01406 <span class="comment">//</span>
01407 <span class="comment">//    This macro sets the ACCESSED field in the PTE.</span>
01408 <span class="comment">//</span>
01409 <span class="comment">// Arguments</span>
01410 <span class="comment">//</span>
01411 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01412 <span class="comment">//</span>
01413 <span class="comment">// Return Value:</span>
01414 <span class="comment">//</span>
01415 <span class="comment">//     None</span>
01416 <span class="comment">//</span>
01417 <span class="comment">//--</span>
01418 
01419 <span class="preprocessor">#if defined(NT_UP)</span>
01420 <span class="preprocessor"></span><span class="preprocessor">#define MI_SET_ACCESSED_IN_PTE(PPTE,ACCESSED) \</span>
01421 <span class="preprocessor">                    ((PPTE)-&gt;u.Hard.Accessed = ACCESSED)</span>
01422 <span class="preprocessor"></span><span class="preprocessor">#else</span>
01423 <span class="preprocessor"></span>
01424 <span class="comment">//</span>
01425 <span class="comment">// Don't do anything on MP systems.</span>
01426 <span class="comment">//</span>
01427 
<a name="l01428"></a><a class="code" href="../../d6/d8/mi386_8h.html#a139">01428</a> <span class="preprocessor">#define MI_SET_ACCESSED_IN_PTE(PPTE,ACCESSED)</span>
01429 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01430 <span class="preprocessor"></span>
01431 
01432 <span class="comment">//++</span>
01433 <span class="comment">//ULONG</span>
01434 <span class="comment">//MI_GET_ACCESSED_IN_PTE (</span>
01435 <span class="comment">//    IN OUT MMPTE PPTE</span>
01436 <span class="comment">//    );</span>
01437 <span class="comment">//</span>
01438 <span class="comment">// Routine Description:</span>
01439 <span class="comment">//</span>
01440 <span class="comment">//    This macro returns the state of the ACCESSED field in the PTE.</span>
01441 <span class="comment">//</span>
01442 <span class="comment">// Arguments</span>
01443 <span class="comment">//</span>
01444 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01445 <span class="comment">//</span>
01446 <span class="comment">// Return Value:</span>
01447 <span class="comment">//</span>
01448 <span class="comment">//     The state of the ACCESSED field.</span>
01449 <span class="comment">//</span>
01450 <span class="comment">//--</span>
01451 
01452 <span class="preprocessor">#if defined(NT_UP)</span>
01453 <span class="preprocessor"></span><span class="preprocessor">#define MI_GET_ACCESSED_IN_PTE(PPTE) ((PPTE)-&gt;u.Hard.Accessed)</span>
01454 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01455"></a><a class="code" href="../../d6/d8/mi386_8h.html#a140">01455</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_GET_ACCESSED_IN_PTE(PPTE) 0</span>
01456 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01457 <span class="preprocessor"></span>
01458 
01459 <span class="comment">//++</span>
01460 <span class="comment">//VOID</span>
01461 <span class="comment">//MI_SET_OWNER_IN_PTE (</span>
01462 <span class="comment">//    IN PMMPTE PPTE</span>
01463 <span class="comment">//    IN ULONG OWNER</span>
01464 <span class="comment">//    );</span>
01465 <span class="comment">//</span>
01466 <span class="comment">// Routine Description:</span>
01467 <span class="comment">//</span>
01468 <span class="comment">//    This macro sets the owner field in the PTE.</span>
01469 <span class="comment">//</span>
01470 <span class="comment">// Arguments</span>
01471 <span class="comment">//</span>
01472 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01473 <span class="comment">//</span>
01474 <span class="comment">// Return Value:</span>
01475 <span class="comment">//</span>
01476 <span class="comment">//    None.</span>
01477 <span class="comment">//</span>
01478 <span class="comment">//--</span>
01479 
<a name="l01480"></a><a class="code" href="../../d6/d8/mi386_8h.html#a141">01480</a> <span class="preprocessor">#define MI_SET_OWNER_IN_PTE(PPTE,OWNER) ((PPTE)-&gt;u.Hard.Owner = OWNER)</span>
01481 <span class="preprocessor"></span>
01482 
01483 
01484 
01485 <span class="comment">//++</span>
01486 <span class="comment">//ULONG</span>
01487 <span class="comment">//MI_GET_OWNER_IN_PTE (</span>
01488 <span class="comment">//    IN PMMPTE PPTE</span>
01489 <span class="comment">//    );</span>
01490 <span class="comment">//</span>
01491 <span class="comment">// Routine Description:</span>
01492 <span class="comment">//</span>
01493 <span class="comment">//    This macro gets the owner field from the PTE.</span>
01494 <span class="comment">//</span>
01495 <span class="comment">// Arguments</span>
01496 <span class="comment">//</span>
01497 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01498 <span class="comment">//</span>
01499 <span class="comment">// Return Value:</span>
01500 <span class="comment">//</span>
01501 <span class="comment">//     The state of the OWNER field.</span>
01502 <span class="comment">//</span>
01503 <span class="comment">//--</span>
01504 
<a name="l01505"></a><a class="code" href="../../d6/d8/mi386_8h.html#a142">01505</a> <span class="preprocessor">#define MI_GET_OWNER_IN_PTE(PPTE) ((PPTE)-&gt;u.Hard.Owner)</span>
01506 <span class="preprocessor"></span>
01507 
01508 
01509 <span class="comment">//</span>
01510 <span class="comment">// bit mask to clear out fields in a PTE to or in prototype pte offset.</span>
01511 <span class="comment">//</span>
01512 
<a name="l01513"></a><a class="code" href="../../d6/d8/mi386_8h.html#a143">01513</a> <span class="preprocessor">#define CLEAR_FOR_PROTO_PTE_ADDRESS ((ULONG)0x701)</span>
01514 <span class="preprocessor"></span>
01515 <span class="comment">//</span>
01516 <span class="comment">// bit mask to clear out fields in a PTE to or in paging file location.</span>
01517 <span class="comment">//</span>
01518 
<a name="l01519"></a><a class="code" href="../../d6/d8/mi386_8h.html#a144">01519</a> <span class="preprocessor">#define CLEAR_FOR_PAGE_FILE 0x000003E0</span>
01520 <span class="preprocessor"></span>
01521 
01522 <span class="comment">//++</span>
01523 <span class="comment">//VOID</span>
01524 <span class="comment">//MI_SET_PAGING_FILE_INFO (</span>
01525 <span class="comment">//    OUT MMPTE OUTPTE,</span>
01526 <span class="comment">//    IN MMPTE PPTE,</span>
01527 <span class="comment">//    IN ULONG FILEINFO,</span>
01528 <span class="comment">//    IN ULONG OFFSET</span>
01529 <span class="comment">//    );</span>
01530 <span class="comment">//</span>
01531 <span class="comment">// Routine Description:</span>
01532 <span class="comment">//</span>
01533 <span class="comment">//    This macro sets into the specified PTE the supplied information</span>
01534 <span class="comment">//    to indicate where the backing store for the page is located.</span>
01535 <span class="comment">//</span>
01536 <span class="comment">// Arguments</span>
01537 <span class="comment">//</span>
01538 <span class="comment">//    OUTPTE - Supplies the PTE in which to store the result.</span>
01539 <span class="comment">//</span>
01540 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01541 <span class="comment">//</span>
01542 <span class="comment">//    FILEINFO - Supplies the number of the paging file.</span>
01543 <span class="comment">//</span>
01544 <span class="comment">//    OFFSET - Supplies the offset into the paging file.</span>
01545 <span class="comment">//</span>
01546 <span class="comment">// Return Value:</span>
01547 <span class="comment">//</span>
01548 <span class="comment">//    None.</span>
01549 <span class="comment">//</span>
01550 <span class="comment">//--</span>
01551 
<a name="l01552"></a><a class="code" href="../../d6/d8/mi386_8h.html#a145">01552</a> <span class="preprocessor">#define MI_SET_PAGING_FILE_INFO(OUTPTE,PPTE,FILEINFO,OFFSET)            \</span>
01553 <span class="preprocessor">       (OUTPTE).u.Long = (PPTE).u.Long;                                 \</span>
01554 <span class="preprocessor">       (OUTPTE).u.Long &amp;= CLEAR_FOR_PAGE_FILE;                          \</span>
01555 <span class="preprocessor">       (OUTPTE).u.Long |= ((FILEINFO &lt;&lt; 1) | (OFFSET &lt;&lt; 12));</span>
01556 <span class="preprocessor"></span>
01557 
01558 <span class="comment">//++</span>
01559 <span class="comment">//PMMPTE</span>
01560 <span class="comment">//MiPteToProto (</span>
01561 <span class="comment">//    IN OUT MMPTE PPTE,</span>
01562 <span class="comment">//    IN ULONG FILEINFO,</span>
01563 <span class="comment">//    IN ULONG OFFSET</span>
01564 <span class="comment">//    );</span>
01565 <span class="comment">//</span>
01566 <span class="comment">// Routine Description:</span>
01567 <span class="comment">//</span>
01568 <span class="comment">//   This macro returns the address of the corresponding prototype which</span>
01569 <span class="comment">//   was encoded earlier into the supplied PTE.</span>
01570 <span class="comment">//</span>
01571 <span class="comment">//    NOTE THAT A PROTOPTE CAN ONLY RESIDE IN PAGED POOL!!!!!!</span>
01572 <span class="comment">//</span>
01573 <span class="comment">//    MAX SIZE = 2^(2+7+21) = 2^30 = 1GB.</span>
01574 <span class="comment">//</span>
01575 <span class="comment">//    NOTE that the valid bit must be zero!</span>
01576 <span class="comment">//</span>
01577 <span class="comment">// Arguments</span>
01578 <span class="comment">//</span>
01579 <span class="comment">//    lpte - Supplies the PTE to operate upon.</span>
01580 <span class="comment">//</span>
01581 <span class="comment">// Return Value:</span>
01582 <span class="comment">//</span>
01583 <span class="comment">//    Pointer to the prototype PTE that backs this PTE.</span>
01584 <span class="comment">//</span>
01585 <span class="comment">//--</span>
01586 
01587 
<a name="l01588"></a><a class="code" href="../../d6/d8/mi386_8h.html#a146">01588</a> <span class="preprocessor">#define MiPteToProto(lpte) ((PMMPTE)(((((lpte)-&gt;u.Long) &gt;&gt; 11) &lt;&lt; 9) +  \</span>
01589 <span class="preprocessor">                (((((lpte)-&gt;u.Long)) &lt;&lt; 24) &gt;&gt; 23) \</span>
01590 <span class="preprocessor">                + MmProtopte_Base))</span>
01591 <span class="preprocessor"></span>
01592 
01593 <span class="comment">//++</span>
01594 <span class="comment">//ULONG</span>
01595 <span class="comment">//MiProtoAddressForPte (</span>
01596 <span class="comment">//    IN PMMPTE proto_va</span>
01597 <span class="comment">//    );</span>
01598 <span class="comment">//</span>
01599 <span class="comment">// Routine Description:</span>
01600 <span class="comment">//</span>
01601 <span class="comment">//    This macro sets into the specified PTE the supplied information</span>
01602 <span class="comment">//    to indicate where the backing store for the page is located.</span>
01603 <span class="comment">//    MiProtoAddressForPte returns the bit field to OR into the PTE to</span>
01604 <span class="comment">//    reference a prototype PTE.  And set the protoPTE bit,</span>
01605 <span class="comment">//    MM_PTE_PROTOTYPE_MASK.</span>
01606 <span class="comment">//</span>
01607 <span class="comment">// Arguments</span>
01608 <span class="comment">//</span>
01609 <span class="comment">//    proto_va - Supplies the address of the prototype PTE.</span>
01610 <span class="comment">//</span>
01611 <span class="comment">// Return Value:</span>
01612 <span class="comment">//</span>
01613 <span class="comment">//    Mask to set into the PTE.</span>
01614 <span class="comment">//</span>
01615 <span class="comment">//--</span>
01616 
<a name="l01617"></a><a class="code" href="../../d6/d8/mi386_8h.html#a147">01617</a> <span class="preprocessor">#define MiProtoAddressForPte(proto_va)  \</span>
01618 <span class="preprocessor">   ((((((ULONG)proto_va - MmProtopte_Base) &gt;&gt; 1) &amp; (ULONG)0x000000FE)   | \</span>
01619 <span class="preprocessor">    (((((ULONG)proto_va - MmProtopte_Base) &lt;&lt; 2) &amp; (ULONG)0xfffff800))) | \</span>
01620 <span class="preprocessor">    MM_PTE_PROTOTYPE_MASK)</span>
01621 <span class="preprocessor"></span>
01622 
01623 
01624 
01625 <span class="comment">//++</span>
01626 <span class="comment">//ULONG</span>
01627 <span class="comment">//MiProtoAddressForKernelPte (</span>
01628 <span class="comment">//    IN PMMPTE proto_va</span>
01629 <span class="comment">//    );</span>
01630 <span class="comment">//</span>
01631 <span class="comment">// Routine Description:</span>
01632 <span class="comment">//</span>
01633 <span class="comment">//    This macro sets into the specified PTE the supplied information</span>
01634 <span class="comment">//    to indicate where the backing store for the page is located.</span>
01635 <span class="comment">//    MiProtoAddressForPte returns the bit field to OR into the PTE to</span>
01636 <span class="comment">//    reference a prototype PTE.  And set the protoPTE bit,</span>
01637 <span class="comment">//    MM_PTE_PROTOTYPE_MASK.</span>
01638 <span class="comment">//</span>
01639 <span class="comment">//    This macro also sets any other information (such as global bits)</span>
01640 <span class="comment">//    required for kernel mode PTEs.</span>
01641 <span class="comment">//</span>
01642 <span class="comment">// Arguments</span>
01643 <span class="comment">//</span>
01644 <span class="comment">//    proto_va - Supplies the address of the prototype PTE.</span>
01645 <span class="comment">//</span>
01646 <span class="comment">// Return Value:</span>
01647 <span class="comment">//</span>
01648 <span class="comment">//    Mask to set into the PTE.</span>
01649 <span class="comment">//</span>
01650 <span class="comment">//--</span>
01651 
01652 <span class="comment">//  not different on x86.</span>
01653 
<a name="l01654"></a><a class="code" href="../../d6/d8/mi386_8h.html#a148">01654</a> <span class="preprocessor">#define MiProtoAddressForKernelPte(proto_va)  MiProtoAddressForPte(proto_va)</span>
01655 <span class="preprocessor"></span>
01656 
<a name="l01657"></a><a class="code" href="../../d6/d8/mi386_8h.html#a149">01657</a> <span class="preprocessor">#define MM_SUBSECTION_MAP (128*1024*1024)</span>
01658 <span class="preprocessor"></span>
01659 <span class="comment">//++</span>
01660 <span class="comment">//PSUBSECTION</span>
01661 <span class="comment">//MiGetSubsectionAddress (</span>
01662 <span class="comment">//    IN PMMPTE lpte</span>
01663 <span class="comment">//    );</span>
01664 <span class="comment">//</span>
01665 <span class="comment">// Routine Description:</span>
01666 <span class="comment">//</span>
01667 <span class="comment">//   This macro takes a PTE and returns the address of the subsection that</span>
01668 <span class="comment">//   the PTE refers to.  Subsections are quadword structures allocated</span>
01669 <span class="comment">//   from nonpaged pool.</span>
01670 <span class="comment">//</span>
01671 <span class="comment">//   NOTE THIS MACRO LIMITS THE SIZE OF NONPAGED POOL!</span>
01672 <span class="comment">//    MAXIMUM NONPAGED POOL = 2^(3+4+21) = 2^28 = 256mb.</span>
01673 <span class="comment">//</span>
01674 <span class="comment">//</span>
01675 <span class="comment">// Arguments</span>
01676 <span class="comment">//</span>
01677 <span class="comment">//    lpte - Supplies the PTE to operate upon.</span>
01678 <span class="comment">//</span>
01679 <span class="comment">// Return Value:</span>
01680 <span class="comment">//</span>
01681 <span class="comment">//    A pointer to the subsection referred to by the supplied PTE.</span>
01682 <span class="comment">//</span>
01683 <span class="comment">//--</span>
01684 
01685 <span class="comment">//#define MiGetSubsectionAddress(lpte)                        \</span>
01686 <span class="comment">//            ((PSUBSECTION)((ULONG)MM_NONPAGED_POOL_END -    \</span>
01687 <span class="comment">//                (((((lpte)-&gt;u.Long)&gt;&gt;11)&lt;&lt;7) |              \</span>
01688 <span class="comment">//                (((lpte)-&gt;u.Long&lt;&lt;2) &amp; 0x78))))</span>
01689 
<a name="l01690"></a><a class="code" href="../../d6/d8/mi386_8h.html#a150">01690</a> <span class="preprocessor">#define MiGetSubsectionAddress(lpte)                              \</span>
01691 <span class="preprocessor">    (((lpte)-&gt;u.Long &amp; 0x80000000) ?                              \</span>
01692 <span class="preprocessor">            ((PSUBSECTION)((ULONG)MmSubsectionBase +    \</span>
01693 <span class="preprocessor">                ((((lpte)-&gt;u.Long &amp; 0x7ffff800) &gt;&gt; 4) |              \</span>
01694 <span class="preprocessor">                (((lpte)-&gt;u.Long&lt;&lt;2) &amp; 0x78)))) \</span>
01695 <span class="preprocessor">      : \</span>
01696 <span class="preprocessor">            ((PSUBSECTION)((ULONG)MmNonPagedPoolEnd -    \</span>
01697 <span class="preprocessor">                (((((lpte)-&gt;u.Long)&gt;&gt;11)&lt;&lt;7) |              \</span>
01698 <span class="preprocessor">                (((lpte)-&gt;u.Long&lt;&lt;2) &amp; 0x78)))))</span>
01699 <span class="preprocessor"></span>
01700 
01701 
01702 <span class="comment">//++</span>
01703 <span class="comment">//ULONG</span>
01704 <span class="comment">//MiGetSubsectionAddressForPte (</span>
01705 <span class="comment">//    IN PSUBSECTION VA</span>
01706 <span class="comment">//    );</span>
01707 <span class="comment">//</span>
01708 <span class="comment">// Routine Description:</span>
01709 <span class="comment">//</span>
01710 <span class="comment">//    This macro takes the address of a subsection and encodes it for use</span>
01711 <span class="comment">//    in a PTE.</span>
01712 <span class="comment">//</span>
01713 <span class="comment">//    NOTE - THE SUBSECTION ADDRESS MUST BE QUADWORD ALIGNED!</span>
01714 <span class="comment">//</span>
01715 <span class="comment">// Arguments</span>
01716 <span class="comment">//</span>
01717 <span class="comment">//    VA - Supplies a pointer to the subsection to encode.</span>
01718 <span class="comment">//</span>
01719 <span class="comment">// Return Value:</span>
01720 <span class="comment">//</span>
01721 <span class="comment">//     The mask to set into the PTE to make it reference the supplied</span>
01722 <span class="comment">//     subsection.</span>
01723 <span class="comment">//</span>
01724 <span class="comment">//--</span>
01725 
01726 <span class="comment">//#define MiGetSubsectionAddressForPte(VA)  \</span>
01727 <span class="comment">//   (((((ULONG)MM_NONPAGED_POOL_END - (ULONG)VA)&gt;&gt;2) &amp; (ULONG)0x0000001E) |  \</span>
01728 <span class="comment">//   ((((((ULONG)MM_NONPAGED_POOL_END - (ULONG)VA)&lt;&lt;4) &amp; (ULONG)0xfffff800))))</span>
01729 
<a name="l01730"></a><a class="code" href="../../d6/d8/mi386_8h.html#a151">01730</a> <span class="preprocessor">#define MiGetSubsectionAddressForPte(VA)                   \</span>
01731 <span class="preprocessor">            (((ULONG)(VA) &lt; (ULONG)MM_KSEG2_BASE) ?                  \</span>
01732 <span class="preprocessor">   (((((ULONG)VA - (ULONG)MmSubsectionBase)&gt;&gt;2) &amp; (ULONG)0x0000001E) |  \</span>
01733 <span class="preprocessor">   ((((((ULONG)VA - (ULONG)MmSubsectionBase)&lt;&lt;4) &amp; (ULONG)0x7ffff800)))| \</span>
01734 <span class="preprocessor">   0x80000000) \</span>
01735 <span class="preprocessor">            : \</span>
01736 <span class="preprocessor">   (((((ULONG)MmNonPagedPoolEnd - (ULONG)VA)&gt;&gt;2) &amp; (ULONG)0x0000001E) |  \</span>
01737 <span class="preprocessor">   ((((((ULONG)MmNonPagedPoolEnd - (ULONG)VA)&lt;&lt;4) &amp; (ULONG)0x7ffff800)))))</span>
01738 <span class="preprocessor"></span>
01739 
01740 
01741 
01742 <span class="comment">//++</span>
01743 <span class="comment">//PMMPTE</span>
01744 <span class="comment">//MiGetPpeAddress (</span>
01745 <span class="comment">//    IN PVOID va</span>
01746 <span class="comment">//    );</span>
01747 <span class="comment">//</span>
01748 <span class="comment">// Routine Description:</span>
01749 <span class="comment">//</span>
01750 <span class="comment">//    MiGetPpeAddress returns the address of the page directory parent entry</span>
01751 <span class="comment">//    which maps the given virtual address.  This is one level above the</span>
01752 <span class="comment">//    page directory.</span>
01753 <span class="comment">//</span>
01754 <span class="comment">// Arguments</span>
01755 <span class="comment">//</span>
01756 <span class="comment">//    Va - Supplies the virtual address to locate the PPE for.</span>
01757 <span class="comment">//</span>
01758 <span class="comment">// Return Value:</span>
01759 <span class="comment">//</span>
01760 <span class="comment">//    The address of the PPE.</span>
01761 <span class="comment">//</span>
01762 <span class="comment">//--</span>
01763 
<a name="l01764"></a><a class="code" href="../../d6/d8/mi386_8h.html#a152">01764</a> <span class="preprocessor">#define MiGetPpeAddress(va)  ((PMMPTE)0)</span>
01765 <span class="preprocessor"></span>
01766 
01767 <span class="comment">//++</span>
01768 <span class="comment">//PMMPTE</span>
01769 <span class="comment">//MiGetPdeAddress (</span>
01770 <span class="comment">//    IN PVOID va</span>
01771 <span class="comment">//    );</span>
01772 <span class="comment">//</span>
01773 <span class="comment">// Routine Description:</span>
01774 <span class="comment">//</span>
01775 <span class="comment">//    MiGetPdeAddress returns the address of the PDE which maps the</span>
01776 <span class="comment">//    given virtual address.</span>
01777 <span class="comment">//</span>
01778 <span class="comment">// Arguments</span>
01779 <span class="comment">//</span>
01780 <span class="comment">//    Va - Supplies the virtual address to locate the PDE for.</span>
01781 <span class="comment">//</span>
01782 <span class="comment">// Return Value:</span>
01783 <span class="comment">//</span>
01784 <span class="comment">//    The address of the PDE.</span>
01785 <span class="comment">//</span>
01786 <span class="comment">//--</span>
01787 
<a name="l01788"></a><a class="code" href="../../d6/d8/mi386_8h.html#a153">01788</a> <span class="preprocessor">#define MiGetPdeAddress(va)  ((PMMPTE)(((((ULONG)(va)) &gt;&gt; 22) &lt;&lt; 2) + PDE_BASE))</span>
01789 <span class="preprocessor"></span>
01790 
01791 <span class="comment">//++</span>
01792 <span class="comment">//PMMPTE</span>
01793 <span class="comment">//MiGetPteAddress (</span>
01794 <span class="comment">//    IN PVOID va</span>
01795 <span class="comment">//    );</span>
01796 <span class="comment">//</span>
01797 <span class="comment">// Routine Description:</span>
01798 <span class="comment">//</span>
01799 <span class="comment">//    MiGetPteAddress returns the address of the PTE which maps the</span>
01800 <span class="comment">//    given virtual address.</span>
01801 <span class="comment">//</span>
01802 <span class="comment">// Arguments</span>
01803 <span class="comment">//</span>
01804 <span class="comment">//    Va - Supplies the virtual address to locate the PTE for.</span>
01805 <span class="comment">//</span>
01806 <span class="comment">// Return Value:</span>
01807 <span class="comment">//</span>
01808 <span class="comment">//    The address of the PTE.</span>
01809 <span class="comment">//</span>
01810 <span class="comment">//--</span>
01811 
<a name="l01812"></a><a class="code" href="../../d6/d8/mi386_8h.html#a154">01812</a> <span class="preprocessor">#define MiGetPteAddress(va) ((PMMPTE)(((((ULONG)(va)) &gt;&gt; 12) &lt;&lt; 2) + PTE_BASE))</span>
01813 <span class="preprocessor"></span>
01814 
01815 <span class="comment">//++</span>
01816 <span class="comment">//ULONG</span>
01817 <span class="comment">//MiGetPpeOffset (</span>
01818 <span class="comment">//    IN PVOID va</span>
01819 <span class="comment">//    );</span>
01820 <span class="comment">//</span>
01821 <span class="comment">// Routine Description:</span>
01822 <span class="comment">//</span>
01823 <span class="comment">//    MiGetPpeOffset returns the offset into a page root</span>
01824 <span class="comment">//    for a given virtual address.</span>
01825 <span class="comment">//</span>
01826 <span class="comment">// Arguments</span>
01827 <span class="comment">//</span>
01828 <span class="comment">//    Va - Supplies the virtual address to locate the offset for.</span>
01829 <span class="comment">//</span>
01830 <span class="comment">// Return Value:</span>
01831 <span class="comment">//</span>
01832 <span class="comment">//    The offset into the page root table the corresponding PPE is at.</span>
01833 <span class="comment">//</span>
01834 <span class="comment">//--</span>
01835 
<a name="l01836"></a><a class="code" href="../../d6/d8/mi386_8h.html#a155">01836</a> <span class="preprocessor">#define MiGetPpeOffset(va) (0)</span>
01837 <span class="preprocessor"></span>
01838 <span class="comment">//++</span>
01839 <span class="comment">//ULONG</span>
01840 <span class="comment">//MiGetPdeOffset (</span>
01841 <span class="comment">//    IN PVOID va</span>
01842 <span class="comment">//    );</span>
01843 <span class="comment">//</span>
01844 <span class="comment">// Routine Description:</span>
01845 <span class="comment">//</span>
01846 <span class="comment">//    MiGetPdeOffset returns the offset into a page directory</span>
01847 <span class="comment">//    for a given virtual address.</span>
01848 <span class="comment">//</span>
01849 <span class="comment">// Arguments</span>
01850 <span class="comment">//</span>
01851 <span class="comment">//    Va - Supplies the virtual address to locate the offset for.</span>
01852 <span class="comment">//</span>
01853 <span class="comment">// Return Value:</span>
01854 <span class="comment">//</span>
01855 <span class="comment">//    The offset into the page directory table the corresponding PDE is at.</span>
01856 <span class="comment">//</span>
01857 <span class="comment">//--</span>
01858 
<a name="l01859"></a><a class="code" href="../../d6/d8/mi386_8h.html#a156">01859</a> <span class="preprocessor">#define MiGetPdeOffset(va) (((ULONG)(va)) &gt;&gt; 22)</span>
01860 <span class="preprocessor"></span>
01861 <span class="comment">//++</span>
01862 <span class="comment">//ULONG</span>
01863 <span class="comment">//MiGetPpePdeOffset (</span>
01864 <span class="comment">//    IN PVOID va</span>
01865 <span class="comment">//    );</span>
01866 <span class="comment">//</span>
01867 <span class="comment">// Routine Description:</span>
01868 <span class="comment">//</span>
01869 <span class="comment">//    MiGetPdeOffset returns the offset into a page directory</span>
01870 <span class="comment">//    for a given virtual address.</span>
01871 <span class="comment">//</span>
01872 <span class="comment">// Arguments</span>
01873 <span class="comment">//</span>
01874 <span class="comment">//    Va - Supplies the virtual address to locate the offset for.</span>
01875 <span class="comment">//</span>
01876 <span class="comment">// Return Value:</span>
01877 <span class="comment">//</span>
01878 <span class="comment">//    The offset into the page directory (and parent) table the</span>
01879 <span class="comment">//    corresponding PDE is at.</span>
01880 <span class="comment">//</span>
01881 <span class="comment">//--</span>
01882 
<a name="l01883"></a><a class="code" href="../../d6/d8/mi386_8h.html#a157">01883</a> <span class="preprocessor">#define MiGetPpePdeOffset MiGetPdeOffset</span>
01884 <span class="preprocessor"></span>
01885 
01886 
01887 <span class="comment">//++</span>
01888 <span class="comment">//ULONG</span>
01889 <span class="comment">//MiGetPteOffset (</span>
01890 <span class="comment">//    IN PVOID va</span>
01891 <span class="comment">//    );</span>
01892 <span class="comment">//</span>
01893 <span class="comment">// Routine Description:</span>
01894 <span class="comment">//</span>
01895 <span class="comment">//    MiGetPteOffset returns the offset into a page table page</span>
01896 <span class="comment">//    for a given virtual address.</span>
01897 <span class="comment">//</span>
01898 <span class="comment">// Arguments</span>
01899 <span class="comment">//</span>
01900 <span class="comment">//    Va - Supplies the virtual address to locate the offset for.</span>
01901 <span class="comment">//</span>
01902 <span class="comment">// Return Value:</span>
01903 <span class="comment">//</span>
01904 <span class="comment">//    The offset into the page table page table the corresponding PTE is at.</span>
01905 <span class="comment">//</span>
01906 <span class="comment">//--</span>
01907 
<a name="l01908"></a><a class="code" href="../../d6/d8/mi386_8h.html#a158">01908</a> <span class="preprocessor">#define MiGetPteOffset(va) ((((ULONG)(va)) &lt;&lt; 10) &gt;&gt; 22)</span>
01909 <span class="preprocessor"></span>
01910 
01911 
01912 <span class="comment">//++</span>
01913 <span class="comment">//PVOID</span>
01914 <span class="comment">//MiGetVirtualAddressMappedByPpe (</span>
01915 <span class="comment">//    IN PMMPTE PTE</span>
01916 <span class="comment">//    );</span>
01917 <span class="comment">//</span>
01918 <span class="comment">// Routine Description:</span>
01919 <span class="comment">//</span>
01920 <span class="comment">//    MiGetVirtualAddressMappedByPpe returns the virtual address</span>
01921 <span class="comment">//    which is mapped by a given PPE address.</span>
01922 <span class="comment">//</span>
01923 <span class="comment">// Arguments</span>
01924 <span class="comment">//</span>
01925 <span class="comment">//    PPE - Supplies the PPE to get the virtual address for.</span>
01926 <span class="comment">//</span>
01927 <span class="comment">// Return Value:</span>
01928 <span class="comment">//</span>
01929 <span class="comment">//    Virtual address mapped by the PPE.</span>
01930 <span class="comment">//</span>
01931 <span class="comment">//--</span>
01932 
<a name="l01933"></a><a class="code" href="../../d6/d8/mi386_8h.html#a159">01933</a> <span class="preprocessor">#define MiGetVirtualAddressMappedByPpe(PPE) (NULL)</span>
01934 <span class="preprocessor"></span>
01935 <span class="comment">//++</span>
01936 <span class="comment">//PVOID</span>
01937 <span class="comment">//MiGetVirtualAddressMappedByPde (</span>
01938 <span class="comment">//    IN PMMPTE PTE</span>
01939 <span class="comment">//    );</span>
01940 <span class="comment">//</span>
01941 <span class="comment">// Routine Description:</span>
01942 <span class="comment">//</span>
01943 <span class="comment">//    MiGetVirtualAddressMappedByPde returns the virtual address</span>
01944 <span class="comment">//    which is mapped by a given PDE address.</span>
01945 <span class="comment">//</span>
01946 <span class="comment">// Arguments</span>
01947 <span class="comment">//</span>
01948 <span class="comment">//    PDE - Supplies the PDE to get the virtual address for.</span>
01949 <span class="comment">//</span>
01950 <span class="comment">// Return Value:</span>
01951 <span class="comment">//</span>
01952 <span class="comment">//    Virtual address mapped by the PDE.</span>
01953 <span class="comment">//</span>
01954 <span class="comment">//--</span>
01955 
<a name="l01956"></a><a class="code" href="../../d6/d8/mi386_8h.html#a160">01956</a> <span class="preprocessor">#define MiGetVirtualAddressMappedByPde(PDE) ((PVOID)((ULONG)(PDE) &lt;&lt; 20))</span>
01957 <span class="preprocessor"></span>
01958 
01959 <span class="comment">//++</span>
01960 <span class="comment">//PVOID</span>
01961 <span class="comment">//MiGetVirtualAddressMappedByPte (</span>
01962 <span class="comment">//    IN PMMPTE PTE</span>
01963 <span class="comment">//    );</span>
01964 <span class="comment">//</span>
01965 <span class="comment">// Routine Description:</span>
01966 <span class="comment">//</span>
01967 <span class="comment">//    MiGetVirtualAddressMappedByPte returns the virtual address</span>
01968 <span class="comment">//    which is mapped by a given PTE address.</span>
01969 <span class="comment">//</span>
01970 <span class="comment">// Arguments</span>
01971 <span class="comment">//</span>
01972 <span class="comment">//    PTE - Supplies the PTE to get the virtual address for.</span>
01973 <span class="comment">//</span>
01974 <span class="comment">// Return Value:</span>
01975 <span class="comment">//</span>
01976 <span class="comment">//    Virtual address mapped by the PTE.</span>
01977 <span class="comment">//</span>
01978 <span class="comment">//--</span>
01979 
<a name="l01980"></a><a class="code" href="../../d6/d8/mi386_8h.html#a161">01980</a> <span class="preprocessor">#define MiGetVirtualAddressMappedByPte(PTE) ((PVOID)((ULONG)(PTE) &lt;&lt; 10))</span>
01981 <span class="preprocessor"></span>
01982 
01983 <span class="comment">//++</span>
01984 <span class="comment">//LOGICAL</span>
01985 <span class="comment">//MiIsVirtualAddressOnPpeBoundary (</span>
01986 <span class="comment">//    IN PVOID VA</span>
01987 <span class="comment">//    );</span>
01988 <span class="comment">//</span>
01989 <span class="comment">// Routine Description:</span>
01990 <span class="comment">//</span>
01991 <span class="comment">//    MiIsVirtualAddressOnPpeBoundary returns TRUE if the virtual address is</span>
01992 <span class="comment">//    on a page directory entry boundary.</span>
01993 <span class="comment">//</span>
01994 <span class="comment">// Arguments</span>
01995 <span class="comment">//</span>
01996 <span class="comment">//    VA - Supplies the virtual address to check.</span>
01997 <span class="comment">//</span>
01998 <span class="comment">// Return Value:</span>
01999 <span class="comment">//</span>
02000 <span class="comment">//    TRUE if on a boundary, FALSE if not.</span>
02001 <span class="comment">//</span>
02002 <span class="comment">//--</span>
02003 
<a name="l02004"></a><a class="code" href="../../d6/d8/mi386_8h.html#a162">02004</a> <span class="preprocessor">#define MiIsVirtualAddressOnPpeBoundary(VA) (FALSE)</span>
02005 <span class="preprocessor"></span>
02006 
02007 <span class="comment">//++</span>
02008 <span class="comment">//LOGICAL</span>
02009 <span class="comment">//MiIsVirtualAddressOnPdeBoundary (</span>
02010 <span class="comment">//    IN PVOID VA</span>
02011 <span class="comment">//    );</span>
02012 <span class="comment">//</span>
02013 <span class="comment">// Routine Description:</span>
02014 <span class="comment">//</span>
02015 <span class="comment">//    MiIsVirtualAddressOnPdeBoundary returns TRUE if the virtual address is</span>
02016 <span class="comment">//    on a page directory entry boundary.</span>
02017 <span class="comment">//</span>
02018 <span class="comment">// Arguments</span>
02019 <span class="comment">//</span>
02020 <span class="comment">//    VA - Supplies the virtual address to check.</span>
02021 <span class="comment">//</span>
02022 <span class="comment">// Return Value:</span>
02023 <span class="comment">//</span>
02024 <span class="comment">//    TRUE if on a 4MB PDE boundary, FALSE if not.</span>
02025 <span class="comment">//</span>
02026 <span class="comment">//--</span>
02027 
<a name="l02028"></a><a class="code" href="../../d6/d8/mi386_8h.html#a163">02028</a> <span class="preprocessor">#define MiIsVirtualAddressOnPdeBoundary(VA) (((ULONG_PTR)(VA) &amp; PAGE_DIRECTORY_MASK) == 0)</span>
02029 <span class="preprocessor"></span>
02030 
02031 <span class="comment">//++</span>
02032 <span class="comment">//LOGICAL</span>
02033 <span class="comment">//MiIsPteOnPpeBoundary (</span>
02034 <span class="comment">//    IN PVOID PTE</span>
02035 <span class="comment">//    );</span>
02036 <span class="comment">//</span>
02037 <span class="comment">// Routine Description:</span>
02038 <span class="comment">//</span>
02039 <span class="comment">//    MiIsPteOnPpeBoundary returns TRUE if the PTE is</span>
02040 <span class="comment">//    on a page directory parent entry boundary.</span>
02041 <span class="comment">//</span>
02042 <span class="comment">// Arguments</span>
02043 <span class="comment">//</span>
02044 <span class="comment">//    PTE - Supplies the PTE to check.</span>
02045 <span class="comment">//</span>
02046 <span class="comment">// Return Value:</span>
02047 <span class="comment">//</span>
02048 <span class="comment">//    TRUE if on a boundary, FALSE if not.</span>
02049 <span class="comment">//</span>
02050 <span class="comment">//--</span>
02051 
<a name="l02052"></a><a class="code" href="../../d6/d8/mi386_8h.html#a164">02052</a> <span class="preprocessor">#define MiIsPteOnPpeBoundary(PTE) (FALSE)</span>
02053 <span class="preprocessor"></span>
02054 
02055 <span class="comment">//++</span>
02056 <span class="comment">//LOGICAL</span>
02057 <span class="comment">//MiIsPteOnPdeBoundary (</span>
02058 <span class="comment">//    IN PVOID PTE</span>
02059 <span class="comment">//    );</span>
02060 <span class="comment">//</span>
02061 <span class="comment">// Routine Description:</span>
02062 <span class="comment">//</span>
02063 <span class="comment">//    MiIsPteOnPdeBoundary returns TRUE if the PTE is</span>
02064 <span class="comment">//    on a page directory entry boundary.</span>
02065 <span class="comment">//</span>
02066 <span class="comment">// Arguments</span>
02067 <span class="comment">//</span>
02068 <span class="comment">//    PTE - Supplies the PTE to check.</span>
02069 <span class="comment">//</span>
02070 <span class="comment">// Return Value:</span>
02071 <span class="comment">//</span>
02072 <span class="comment">//    TRUE if on a 4MB PDE boundary, FALSE if not.</span>
02073 <span class="comment">//</span>
02074 <span class="comment">//--</span>
02075 
<a name="l02076"></a><a class="code" href="../../d6/d8/mi386_8h.html#a165">02076</a> <span class="preprocessor">#define MiIsPteOnPdeBoundary(PTE) (((ULONG_PTR)(PTE) &amp; (PAGE_SIZE - 1)) == 0)</span>
02077 <span class="preprocessor"></span>
02078 
02079 <span class="comment">//++</span>
02080 <span class="comment">//LOGICAL</span>
02081 <span class="comment">//MiDoesPpeExistAndMakeValid (</span>
02082 <span class="comment">//    IN PMMPTE PointerPpe,</span>
02083 <span class="comment">//    IN PEPROCESS TargetProcess,</span>
02084 <span class="comment">//    IN ULONG PfnMutexHeld</span>
02085 <span class="comment">//    OUT PULONG Waited</span>
02086 <span class="comment">//    );</span>
02087 <span class="comment">//</span>
02088 <span class="comment">// Routine Description:</span>
02089 <span class="comment">//</span>
02090 <span class="comment">//    MiDoesPpeExistAndMakeValid returns TRUE if the specified PPE entry</span>
02091 <span class="comment">//    exists and can be made valid.</span>
02092 <span class="comment">//</span>
02093 <span class="comment">// Arguments</span>
02094 <span class="comment">//</span>
02095 <span class="comment">//    PointerPpe - Supplies the PPE entry to check.</span>
02096 <span class="comment">//</span>
02097 <span class="comment">//    TargetProcess - Supplies a pointer to the current process.</span>
02098 <span class="comment">//</span>
02099 <span class="comment">//    PfnMutexHeld - Supplies the value TRUE if the PFN mutex is held, FALSE</span>
02100 <span class="comment">//                   otherwise.</span>
02101 <span class="comment">//</span>
02102 <span class="comment">//    Waited - Supplies a pointer to increment if the mutex was released and</span>
02103 <span class="comment">//             reacquired.</span>
02104 <span class="comment">//</span>
02105 <span class="comment">// Return Value:</span>
02106 <span class="comment">//</span>
02107 <span class="comment">//    TRUE if valid, FALSE if not.  Always TRUE on x86.</span>
02108 <span class="comment">//</span>
02109 <span class="comment">//--</span>
02110 
<a name="l02111"></a><a class="code" href="../../d6/d8/mi386_8h.html#a166">02111</a> <span class="preprocessor">#define MiDoesPpeExistAndMakeValid(PPE, TARGETPROCESS, PFNMUTEXHELD, WAITED) (1)</span>
02112 <span class="preprocessor"></span>
02113 
02114 <span class="comment">//++</span>
02115 <span class="comment">//ULONG</span>
02116 <span class="comment">//GET_PAGING_FILE_NUMBER (</span>
02117 <span class="comment">//    IN MMPTE PTE</span>
02118 <span class="comment">//    );</span>
02119 <span class="comment">//</span>
02120 <span class="comment">// Routine Description:</span>
02121 <span class="comment">//</span>
02122 <span class="comment">//    This macro extracts the paging file number from a PTE.</span>
02123 <span class="comment">//</span>
02124 <span class="comment">// Arguments</span>
02125 <span class="comment">//</span>
02126 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
02127 <span class="comment">//</span>
02128 <span class="comment">// Return Value:</span>
02129 <span class="comment">//</span>
02130 <span class="comment">//    The paging file number.</span>
02131 <span class="comment">//</span>
02132 <span class="comment">//--</span>
02133 
<a name="l02134"></a><a class="code" href="../../d6/d8/mi386_8h.html#a167">02134</a> <span class="preprocessor">#define GET_PAGING_FILE_NUMBER(PTE) ((((PTE).u.Long) &gt;&gt; 1) &amp; 0x0000000F)</span>
02135 <span class="preprocessor"></span>
02136 
02137 
02138 <span class="comment">//++</span>
02139 <span class="comment">//ULONG</span>
02140 <span class="comment">//GET_PAGING_FILE_OFFSET (</span>
02141 <span class="comment">//    IN MMPTE PTE</span>
02142 <span class="comment">//    );</span>
02143 <span class="comment">//</span>
02144 <span class="comment">// Routine Description:</span>
02145 <span class="comment">//</span>
02146 <span class="comment">//    This macro extracts the offset into the paging file from a PTE.</span>
02147 <span class="comment">//</span>
02148 <span class="comment">// Arguments</span>
02149 <span class="comment">//</span>
02150 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
02151 <span class="comment">//</span>
02152 <span class="comment">// Return Value:</span>
02153 <span class="comment">//</span>
02154 <span class="comment">//    The paging file offset.</span>
02155 <span class="comment">//</span>
02156 <span class="comment">//--</span>
02157 
<a name="l02158"></a><a class="code" href="../../d6/d8/mi386_8h.html#a168">02158</a> <span class="preprocessor">#define GET_PAGING_FILE_OFFSET(PTE) ((((PTE).u.Long) &gt;&gt; 12) &amp; 0x000FFFFF)</span>
02159 <span class="preprocessor"></span>
02160 
02161 
02162 
02163 <span class="comment">//++</span>
02164 <span class="comment">//ULONG</span>
02165 <span class="comment">//IS_PTE_NOT_DEMAND_ZERO (</span>
02166 <span class="comment">//    IN PMMPTE PPTE</span>
02167 <span class="comment">//    );</span>
02168 <span class="comment">//</span>
02169 <span class="comment">// Routine Description:</span>
02170 <span class="comment">//</span>
02171 <span class="comment">//    This macro checks to see if a given PTE is NOT a demand zero PTE.</span>
02172 <span class="comment">//</span>
02173 <span class="comment">// Arguments</span>
02174 <span class="comment">//</span>
02175 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
02176 <span class="comment">//</span>
02177 <span class="comment">// Return Value:</span>
02178 <span class="comment">//</span>
02179 <span class="comment">//     Returns 0 if the PTE is demand zero, non-zero otherwise.</span>
02180 <span class="comment">//</span>
02181 <span class="comment">//--</span>
02182 
<a name="l02183"></a><a class="code" href="../../d6/d8/mi386_8h.html#a169">02183</a> <span class="preprocessor">#define IS_PTE_NOT_DEMAND_ZERO(PTE) ((PTE).u.Long &amp; (ULONG)0xFFFFFC01)</span>
02184 <span class="preprocessor"></span>
02185 
02186 
02187 
02188 <span class="comment">//++</span>
02189 <span class="comment">//VOID</span>
02190 <span class="comment">//MI_MAKING_VALID_PTE_INVALID(</span>
02191 <span class="comment">//    IN PMMPTE PPTE</span>
02192 <span class="comment">//    );</span>
02193 <span class="comment">//</span>
02194 <span class="comment">// Routine Description:</span>
02195 <span class="comment">//</span>
02196 <span class="comment">//    Prepare to make a single valid PTE invalid.</span>
02197 <span class="comment">//    No action is required on x86.</span>
02198 <span class="comment">//</span>
02199 <span class="comment">// Arguments</span>
02200 <span class="comment">//</span>
02201 <span class="comment">//    SYSTEM_WIDE - Supplies TRUE if this will happen on all processors.</span>
02202 <span class="comment">//</span>
02203 <span class="comment">// Return Value:</span>
02204 <span class="comment">//</span>
02205 <span class="comment">//    None.</span>
02206 <span class="comment">//</span>
02207 <span class="comment">//--</span>
02208 
<a name="l02209"></a><a class="code" href="../../d6/d8/mi386_8h.html#a170">02209</a> <span class="preprocessor">#define MI_MAKING_VALID_PTE_INVALID(SYSTEM_WIDE)</span>
02210 <span class="preprocessor"></span>
02211 
02212 <span class="comment">//++</span>
02213 <span class="comment">//VOID</span>
02214 <span class="comment">//MI_MAKING_VALID_MULTIPLE_PTES_INVALID(</span>
02215 <span class="comment">//    IN PMMPTE PPTE</span>
02216 <span class="comment">//    );</span>
02217 <span class="comment">//</span>
02218 <span class="comment">// Routine Description:</span>
02219 <span class="comment">//</span>
02220 <span class="comment">//    Prepare to make multiple valid PTEs invalid.</span>
02221 <span class="comment">//    No action is required on x86.</span>
02222 <span class="comment">//</span>
02223 <span class="comment">// Arguments</span>
02224 <span class="comment">//</span>
02225 <span class="comment">//    SYSTEM_WIDE - Supplies TRUE if this will happen on all processors.</span>
02226 <span class="comment">//</span>
02227 <span class="comment">// Return Value:</span>
02228 <span class="comment">//</span>
02229 <span class="comment">//    None.</span>
02230 <span class="comment">//</span>
02231 <span class="comment">//--</span>
02232 
<a name="l02233"></a><a class="code" href="../../d6/d8/mi386_8h.html#a171">02233</a> <span class="preprocessor">#define MI_MAKING_MULTIPLE_PTES_INVALID(SYSTEM_WIDE)</span>
02234 <span class="preprocessor"></span>
02235 
02236 
02237 <span class="comment">//++</span>
02238 <span class="comment">//VOID</span>
02239 <span class="comment">//MI_MAKE_PROTECT_WRITE_COPY (</span>
02240 <span class="comment">//    IN OUT MMPTE PPTE</span>
02241 <span class="comment">//    );</span>
02242 <span class="comment">//</span>
02243 <span class="comment">// Routine Description:</span>
02244 <span class="comment">//</span>
02245 <span class="comment">//    This macro makes a writable PTE a writable-copy PTE.</span>
02246 <span class="comment">//</span>
02247 <span class="comment">// Arguments</span>
02248 <span class="comment">//</span>
02249 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
02250 <span class="comment">//</span>
02251 <span class="comment">// Return Value:</span>
02252 <span class="comment">//</span>
02253 <span class="comment">//    NONE</span>
02254 <span class="comment">//</span>
02255 <span class="comment">//--</span>
02256 
<a name="l02257"></a><a class="code" href="../../d6/d8/mi386_8h.html#a172">02257</a> <span class="preprocessor">#define MI_MAKE_PROTECT_WRITE_COPY(PTE) \</span>
02258 <span class="preprocessor">        if ((PTE).u.Soft.Protection &amp; MM_PROTECTION_WRITE_MASK) {      \</span>
02259 <span class="preprocessor">            (PTE).u.Long |= MM_PROTECTION_COPY_MASK &lt;&lt; MM_PROTECT_FIELD_SHIFT;      \</span>
02260 <span class="preprocessor">        }</span>
02261 <span class="preprocessor"></span>
02262 
02263 <span class="comment">//++</span>
02264 <span class="comment">//VOID</span>
02265 <span class="comment">//MI_SET_PAGE_DIRTY(</span>
02266 <span class="comment">//    IN PMMPTE PPTE,</span>
02267 <span class="comment">//    IN PVOID VA,</span>
02268 <span class="comment">//    IN PVOID PFNHELD</span>
02269 <span class="comment">//    );</span>
02270 <span class="comment">//</span>
02271 <span class="comment">// Routine Description:</span>
02272 <span class="comment">//</span>
02273 <span class="comment">//    This macro sets the dirty bit (and release page file space).</span>
02274 <span class="comment">//</span>
02275 <span class="comment">// Arguments</span>
02276 <span class="comment">//</span>
02277 <span class="comment">//    TEMP - Supplies a temporary for usage.</span>
02278 <span class="comment">//</span>
02279 <span class="comment">//    PPTE - Supplies a pointer to the PTE that corresponds to VA.</span>
02280 <span class="comment">//</span>
02281 <span class="comment">//    VA - Supplies a the virtual address of the page fault.</span>
02282 <span class="comment">//</span>
02283 <span class="comment">//    PFNHELD - Supplies TRUE if the PFN lock is held.</span>
02284 <span class="comment">//</span>
02285 <span class="comment">// Return Value:</span>
02286 <span class="comment">//</span>
02287 <span class="comment">//    None.</span>
02288 <span class="comment">//</span>
02289 <span class="comment">//--</span>
02290 
02291 <span class="preprocessor">#if defined(NT_UP)</span>
02292 <span class="preprocessor"></span><span class="preprocessor">#define MI_SET_PAGE_DIRTY(PPTE,VA,PFNHELD)</span>
02293 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l02294"></a><a class="code" href="../../d6/d8/mi386_8h.html#a173">02294</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_SET_PAGE_DIRTY(PPTE,VA,PFNHELD)                          \</span>
02295 <span class="preprocessor">            if ((PPTE)-&gt;u.Hard.Dirty == 1) {                        \</span>
02296 <span class="preprocessor">                MiSetDirtyBit ((VA),(PPTE),(PFNHELD));              \</span>
02297 <span class="preprocessor">            }</span>
02298 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02299 <span class="preprocessor"></span>
02300 
02301 
02302 
02303 <span class="comment">//++</span>
02304 <span class="comment">//VOID</span>
02305 <span class="comment">//MI_NO_FAULT_FOUND(</span>
02306 <span class="comment">//    IN TEMP,</span>
02307 <span class="comment">//    IN PMMPTE PPTE,</span>
02308 <span class="comment">//    IN PVOID VA,</span>
02309 <span class="comment">//    IN PVOID PFNHELD</span>
02310 <span class="comment">//    );</span>
02311 <span class="comment">//</span>
02312 <span class="comment">// Routine Description:</span>
02313 <span class="comment">//</span>
02314 <span class="comment">//    This macro handles the case when a page fault is taken and no</span>
02315 <span class="comment">//    PTE with the valid bit clear is found.</span>
02316 <span class="comment">//</span>
02317 <span class="comment">// Arguments</span>
02318 <span class="comment">//</span>
02319 <span class="comment">//    TEMP - Supplies a temporary for usage.</span>
02320 <span class="comment">//</span>
02321 <span class="comment">//    PPTE - Supplies a pointer to the PTE that corresponds to VA.</span>
02322 <span class="comment">//</span>
02323 <span class="comment">//    VA - Supplies a the virtual address of the page fault.</span>
02324 <span class="comment">//</span>
02325 <span class="comment">//    PFNHELD - Supplies TRUE if the PFN lock is held.</span>
02326 <span class="comment">//</span>
02327 <span class="comment">// Return Value:</span>
02328 <span class="comment">//</span>
02329 <span class="comment">//    None.</span>
02330 <span class="comment">//</span>
02331 <span class="comment">//--</span>
02332 
02333 <span class="preprocessor">#if defined(NT_UP)</span>
02334 <span class="preprocessor"></span><span class="preprocessor">#define MI_NO_FAULT_FOUND(TEMP,PPTE,VA,PFNHELD)</span>
02335 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l02336"></a><a class="code" href="../../d6/d8/mi386_8h.html#a174">02336</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_NO_FAULT_FOUND(TEMP,PPTE,VA,PFNHELD) \</span>
02337 <span class="preprocessor">        if (StoreInstruction &amp;&amp; ((PPTE)-&gt;u.Hard.Dirty == 0)) {  \</span>
02338 <span class="preprocessor">            MiSetDirtyBit ((VA),(PPTE),(PFNHELD));     \</span>
02339 <span class="preprocessor">        }</span>
02340 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02341 <span class="preprocessor"></span>
02342 
02343 
02344 
02345 <span class="comment">//++</span>
02346 <span class="comment">//ULONG</span>
02347 <span class="comment">//MI_CAPTURE_DIRTY_BIT_TO_PFN (</span>
02348 <span class="comment">//    IN PMMPTE PPTE,</span>
02349 <span class="comment">//    IN PMMPFN PPFN</span>
02350 <span class="comment">//    );</span>
02351 <span class="comment">//</span>
02352 <span class="comment">// Routine Description:</span>
02353 <span class="comment">//</span>
02354 <span class="comment">//    This macro gets captures the state of the dirty bit to the PFN</span>
02355 <span class="comment">//    and frees any associated page file space if the PTE has been</span>
02356 <span class="comment">//    modified element.</span>
02357 <span class="comment">//</span>
02358 <span class="comment">//    NOTE - THE PFN LOCK MUST BE HELD!</span>
02359 <span class="comment">//</span>
02360 <span class="comment">// Arguments</span>
02361 <span class="comment">//</span>
02362 <span class="comment">//    PPTE - Supplies the PTE to operate upon.</span>
02363 <span class="comment">//</span>
02364 <span class="comment">//    PPFN - Supplies a pointer to the PFN database element that corresponds</span>
02365 <span class="comment">//           to the page mapped by the PTE.</span>
02366 <span class="comment">//</span>
02367 <span class="comment">// Return Value:</span>
02368 <span class="comment">//</span>
02369 <span class="comment">//    None.</span>
02370 <span class="comment">//</span>
02371 <span class="comment">//--</span>
02372 
<a name="l02373"></a><a class="code" href="../../d6/d8/mi386_8h.html#a175">02373</a> <span class="preprocessor">#define MI_CAPTURE_DIRTY_BIT_TO_PFN(PPTE,PPFN)                      \</span>
02374 <span class="preprocessor">         ASSERT (KeGetCurrentIrql() &gt; APC_LEVEL);                   \</span>
02375 <span class="preprocessor">         if (((PPFN)-&gt;u3.e1.Modified == 0) &amp;&amp;                       \</span>
02376 <span class="preprocessor">            ((PPTE)-&gt;u.Hard.Dirty != 0)) {               \</span>
02377 <span class="preprocessor">             (PPFN)-&gt;u3.e1.Modified = 1;                            \</span>
02378 <span class="preprocessor">             if (((PPFN)-&gt;OriginalPte.u.Soft.Prototype == 0) &amp;&amp;     \</span>
02379 <span class="preprocessor">                          ((PPFN)-&gt;u3.e1.WriteInProgress == 0)) {   \</span>
02380 <span class="preprocessor">                 MiReleasePageFileSpace ((PPFN)-&gt;OriginalPte);      \</span>
02381 <span class="preprocessor">                 (PPFN)-&gt;OriginalPte.u.Soft.PageFileHigh = 0;       \</span>
02382 <span class="preprocessor">             }                                                      \</span>
02383 <span class="preprocessor">         }</span>
02384 <span class="preprocessor"></span>
02385 
02386 <span class="comment">//++</span>
02387 <span class="comment">//BOOLEAN</span>
02388 <span class="comment">//MI_IS_PHYSICAL_ADDRESS (</span>
02389 <span class="comment">//    IN PVOID VA</span>
02390 <span class="comment">//    );</span>
02391 <span class="comment">//</span>
02392 <span class="comment">// Routine Description:</span>
02393 <span class="comment">//</span>
02394 <span class="comment">//    This macro determines if a given virtual address is really a</span>
02395 <span class="comment">//    physical address.</span>
02396 <span class="comment">//</span>
02397 <span class="comment">// Arguments</span>
02398 <span class="comment">//</span>
02399 <span class="comment">//    VA - Supplies the virtual address.</span>
02400 <span class="comment">//</span>
02401 <span class="comment">// Return Value:</span>
02402 <span class="comment">//</span>
02403 <span class="comment">//    FALSE if it is not a physical address, TRUE if it is.</span>
02404 <span class="comment">//</span>
02405 <span class="comment">//--</span>
02406 
02407 
<a name="l02408"></a><a class="code" href="../../d6/d8/mi386_8h.html#a176">02408</a> <span class="preprocessor">#define MI_IS_PHYSICAL_ADDRESS(Va) \</span>
02409 <span class="preprocessor">     (((ULONG)Va &gt;= MM_KSEG0_BASE) &amp;&amp; ((ULONG)Va &lt; MM_KSEG2_BASE) &amp;&amp; (MmKseg2Frame))</span>
02410 <span class="preprocessor"></span>
02411 
02412 <span class="comment">//++</span>
02413 <span class="comment">//ULONG</span>
02414 <span class="comment">//MI_CONVERT_PHYSICAL_TO_PFN (</span>
02415 <span class="comment">//    IN PVOID VA</span>
02416 <span class="comment">//    );</span>
02417 <span class="comment">//</span>
02418 <span class="comment">// Routine Description:</span>
02419 <span class="comment">//</span>
02420 <span class="comment">//    This macro converts a physical address (see MI_IS_PHYSICAL_ADDRESS)</span>
02421 <span class="comment">//    to its corresponding physical frame number.</span>
02422 <span class="comment">//</span>
02423 <span class="comment">// Arguments</span>
02424 <span class="comment">//</span>
02425 <span class="comment">//    VA - Supplies a pointer to the physical address.</span>
02426 <span class="comment">//</span>
02427 <span class="comment">// Return Value:</span>
02428 <span class="comment">//</span>
02429 <span class="comment">//    Returns the PFN for the page.</span>
02430 <span class="comment">//</span>
02431 <span class="comment">//--</span>
02432 
02433 
<a name="l02434"></a><a class="code" href="../../d6/d8/mi386_8h.html#a177">02434</a> <span class="preprocessor">#define MI_CONVERT_PHYSICAL_TO_PFN(Va)    (((ULONG)Va &lt;&lt; 3) &gt;&gt; 15)</span>
02435 <span class="preprocessor"></span>
02436 
02437 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">_MMCOLOR_TABLES</a> {
02438     ULONG Flink;
02439     PVOID Blink;
02440 } <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>, *<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a>;
02441 
02442 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d4/struct__MMPRIMARY__COLOR__TABLES.html">_MMPRIMARY_COLOR_TABLES</a> {
02443     LIST_ENTRY ListHead;
02444 } <a class="code" href="../../d1/d4/struct__MMPRIMARY__COLOR__TABLES.html">MMPRIMARY_COLOR_TABLES</a>, *<a class="code" href="../../d1/d4/struct__MMPRIMARY__COLOR__TABLES.html">PMMPRIMARY_COLOR_TABLES</a>;
02445 
<a name="l02446"></a><a class="code" href="../../d6/d8/mi386_8h.html#a211">02446</a> <span class="keyword">extern</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a203">PMMCOLOR_TABLES</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[2];
02447 
<a name="l02448"></a><a class="code" href="../../d6/d8/mi386_8h.html#a212">02448</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a>;
02449 
02450 
02451 <span class="comment">//</span>
02452 <span class="comment">// A VALID Page Table Entry on an Intel 386/486 has the following definition.</span>
02453 <span class="comment">//</span>
02454 
<a name="l02455"></a><a class="code" href="../../d6/d8/mi386_8h.html#a178">02455</a> <span class="preprocessor">#define MI_PTE_LOOKUP_NEEDED (0xfffff)</span>
02456 <span class="preprocessor"></span>
02457 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html">_MMPTE_SOFTWARE</a> {
02458     ULONG Valid : 1;
02459     ULONG PageFileLow : 4;
02460     ULONG Protection : 5;
02461     ULONG Prototype : 1;
02462     ULONG Transition : 1;
02463     ULONG PageFileHigh : 20;
02464 } <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html">MMPTE_SOFTWARE</a>;
02465 
02466 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html">_MMPTE_TRANSITION</a> {
02467     ULONG Valid : 1;
<a name="l02468"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o12">02468</a>     ULONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o12">Write</a> : 1;
<a name="l02469"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o13">02469</a>     ULONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o13">Owner</a> : 1;
<a name="l02470"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o14">02470</a>     ULONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o14">WriteThrough</a> : 1;
<a name="l02471"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o15">02471</a>     ULONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o15">CacheDisable</a> : 1;
02472     ULONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o3">Protection</a> : 5;
02473     ULONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o1">Prototype</a> : 1;
02474     ULONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o2">Transition</a> : 1;
02475     ULONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o5">PageFrameNumber</a> : 20;
02476 } <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html">MMPTE_TRANSITION</a>;
02477 
02478 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html">_MMPTE_PROTOTYPE</a> {
02479     ULONG Valid : 1;
02480     ULONG ProtoAddressLow : 7;
02481     ULONG ReadOnly : 1;  <span class="comment">// if set allow read only access.</span>
<a name="l02482"></a><a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o12">02482</a>     ULONG <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o12">WhichPool</a> : 1;
02483     ULONG <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o1">Prototype</a> : 1;
02484     ULONG <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o13">ProtoAddressHigh</a> : 21;
02485 } <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html">MMPTE_PROTOTYPE</a>;
02486 
02487 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html">_MMPTE_SUBSECTION</a> {
02488     ULONG Valid : 1;
02489     ULONG SubsectionAddressLow : 4;
02490     ULONG Protection : 5;
02491     ULONG Prototype : 1;
02492     ULONG SubsectionAddressHigh : 20;
02493     ULONG WhichPool : 1;
02494 } <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html">MMPTE_SUBSECTION</a>;
02495 
02496 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d5/struct__MMPTE__LIST.html">_MMPTE_LIST</a> {
02497     ULONG <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o0">Valid</a> : 1;
02498     ULONG <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o2">OneEntry</a> : 1;
<a name="l02499"></a><a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o10">02499</a>     ULONG <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o10">filler10</a> : 10;
02500     ULONG <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o4">NextEntry</a> : 20;
02501 } <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html">MMPTE_LIST</a>;
02502 
02503 <span class="comment">//</span>
02504 <span class="comment">// A Page Table Entry on an Intel 386/486 has the following definition.</span>
02505 <span class="comment">//</span>
02506 
02507 <span class="preprocessor">#if defined(NT_UP)</span>
02508 <span class="preprocessor"></span>
02509 <span class="comment">//</span>
02510 <span class="comment">// Uniprocessor version.</span>
02511 <span class="comment">//</span>
02512 
02513 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">_MMPTE_HARDWARE</a> {
02514     ULONG Valid : 1;
02515     ULONG Write : 1;  <span class="comment">// UP version</span>
02516     ULONG Owner : 1;
02517     ULONG WriteThrough : 1;
02518     ULONG CacheDisable : 1;
02519     ULONG Accessed : 1;
02520     ULONG Dirty : 1;
02521     ULONG LargePage : 1;
02522     ULONG Global : 1;
02523     ULONG CopyOnWrite : 1; <span class="comment">// software field</span>
02524     ULONG Prototype : 1;   <span class="comment">// software field</span>
02525     ULONG reserved : 1;  <span class="comment">// software field</span>
02526     ULONG PageFrameNumber : 20;
02527 } <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">MMPTE_HARDWARE</a>, *<a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">PMMPTE_HARDWARE</a>;
02528 
02529 <span class="preprocessor">#define HARDWARE_PTE_DIRTY_MASK     0x40</span>
02530 <span class="preprocessor"></span>
02531 <span class="preprocessor">#else</span>
02532 <span class="preprocessor"></span>
02533 <span class="comment">//</span>
02534 <span class="comment">// MP version to avoid stalls when flushing TBs across processors.</span>
02535 <span class="comment">//</span>
02536 
<a name="l02537"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">02537</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">_MMPTE_HARDWARE</a> {
<a name="l02538"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o0">02538</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o0">Valid</a> : 1;
<a name="l02539"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o1">02539</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o1">Writable</a> : 1;      <span class="comment">//changed for MP version</span>
<a name="l02540"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o2">02540</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o2">Owner</a> : 1;
<a name="l02541"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o3">02541</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o3">WriteThrough</a> : 1;
<a name="l02542"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o4">02542</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o4">CacheDisable</a> : 1;
<a name="l02543"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o5">02543</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o5">Accessed</a> : 1;
<a name="l02544"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o6">02544</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o6">Dirty</a> : 1;
<a name="l02545"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o7">02545</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o7">LargePage</a> : 1;
<a name="l02546"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o8">02546</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o8">Global</a> : 1;
<a name="l02547"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o9">02547</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o9">CopyOnWrite</a> : 1; <span class="comment">// software field</span>
<a name="l02548"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o10">02548</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o10">Prototype</a> : 1;   <span class="comment">// software field</span>
<a name="l02549"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o11">02549</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o11">Write</a> : 1;       <span class="comment">// software field - MP change</span>
<a name="l02550"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o12">02550</a>     ULONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o12">PageFrameNumber</a> : 20;
02551 } <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">MMPTE_HARDWARE</a>, *<a class="code" href="../../d6/d8/mi386_8h.html#a219">PMMPTE_HARDWARE</a>;
02552 
<a name="l02553"></a><a class="code" href="../../d6/d8/mi386_8h.html#a179">02553</a> <span class="preprocessor">#define HARDWARE_PTE_DIRTY_MASK     0x42</span>
02554 <span class="preprocessor"></span>
02555 <span class="preprocessor">#endif //NT_UP</span>
02556 <span class="preprocessor"></span>
<a name="l02557"></a><a class="code" href="../../d6/d8/mi386_8h.html#a180">02557</a> <span class="preprocessor">#define MI_GET_PAGE_FRAME_FROM_PTE(PTE) ((PTE)-&gt;u.Hard.PageFrameNumber)</span>
<a name="l02558"></a><a class="code" href="../../d6/d8/mi386_8h.html#a181">02558</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE(PTE) ((PTE)-&gt;u.Trans.PageFrameNumber)</span>
<a name="l02559"></a><a class="code" href="../../d6/d8/mi386_8h.html#a182">02559</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_GET_PROTECTION_FROM_SOFT_PTE(PTE) ((PTE)-&gt;u.Soft.Protection)</span>
<a name="l02560"></a><a class="code" href="../../d6/d8/mi386_8h.html#a183">02560</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_GET_PROTECTION_FROM_TRANSITION_PTE(PTE) ((PTE)-&gt;u.Trans.Protection)</span>
02561 <span class="preprocessor"></span>
02562 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d4/struct__MMPTE.html">_MMPTE</a> {
02563     <span class="keyword">union  </span>{
02564         ULONG Long;
02565         <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">MMPTE_HARDWARE</a> Hard;
02566         HARDWARE_PTE Flush;
02567         <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html">MMPTE_PROTOTYPE</a> Proto;
02568         <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html">MMPTE_SOFTWARE</a> Soft;
02569         <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html">MMPTE_TRANSITION</a> Trans;
02570         <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html">MMPTE_SUBSECTION</a> Subsect;
02571         <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html">MMPTE_LIST</a> List;
02572         } u;
02573 } <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>;
02574 
<a name="l02575"></a><a class="code" href="../../d6/d8/mi386_8h.html#a221">02575</a> <span class="keyword">typedef</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>;
02576 
<a name="l02577"></a><a class="code" href="../../d6/d8/mi386_8h.html#a222">02577</a> <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d2/d2/data386_8c.html#a2">MmPteGlobal</a>; <span class="comment">// Set if processor supports Global Page, else zero.</span>
02578 
02579 <span class="comment">//++</span>
02580 <span class="comment">//VOID</span>
02581 <span class="comment">//MI_WRITE_VALID_PTE (</span>
02582 <span class="comment">//    IN PMMPTE PointerPte,</span>
02583 <span class="comment">//    IN MMPTE PteContents</span>
02584 <span class="comment">//    );</span>
02585 <span class="comment">//</span>
02586 <span class="comment">// Routine Description:</span>
02587 <span class="comment">//</span>
02588 <span class="comment">//    MI_WRITE_VALID_PTE fills in the specified PTE making it valid with the</span>
02589 <span class="comment">//    specified contents.</span>
02590 <span class="comment">//</span>
02591 <span class="comment">// Arguments</span>
02592 <span class="comment">//</span>
02593 <span class="comment">//    PointerPte - Supplies a PTE to fill.</span>
02594 <span class="comment">//</span>
02595 <span class="comment">//    PteContents - Supplies the contents to put in the PTE.</span>
02596 <span class="comment">//</span>
02597 <span class="comment">// Return Value:</span>
02598 <span class="comment">//</span>
02599 <span class="comment">//    None.</span>
02600 <span class="comment">//</span>
02601 <span class="comment">//--</span>
02602 
<a name="l02603"></a><a class="code" href="../../d6/d8/mi386_8h.html#a184">02603</a> <span class="preprocessor">#define MI_WRITE_VALID_PTE(_PointerPte, _PteContents)    \</span>
02604 <span class="preprocessor">            (*(_PointerPte) = (_PteContents))</span>
02605 <span class="preprocessor"></span>
02606 <span class="comment">//++</span>
02607 <span class="comment">//VOID</span>
02608 <span class="comment">//MI_WRITE_INVALID_PTE (</span>
02609 <span class="comment">//    IN PMMPTE PointerPte,</span>
02610 <span class="comment">//    IN MMPTE PteContents</span>
02611 <span class="comment">//    );</span>
02612 <span class="comment">//</span>
02613 <span class="comment">// Routine Description:</span>
02614 <span class="comment">//</span>
02615 <span class="comment">//    MI_WRITE_INVALID_PTE fills in the specified PTE making it invalid with the</span>
02616 <span class="comment">//    specified contents.</span>
02617 <span class="comment">//</span>
02618 <span class="comment">// Arguments</span>
02619 <span class="comment">//</span>
02620 <span class="comment">//    PointerPte - Supplies a PTE to fill.</span>
02621 <span class="comment">//</span>
02622 <span class="comment">//    PteContents - Supplies the contents to put in the PTE.</span>
02623 <span class="comment">//</span>
02624 <span class="comment">// Return Value:</span>
02625 <span class="comment">//</span>
02626 <span class="comment">//    None.</span>
02627 <span class="comment">//</span>
02628 <span class="comment">//--</span>
02629 
<a name="l02630"></a><a class="code" href="../../d6/d8/mi386_8h.html#a185">02630</a> <span class="preprocessor">#define MI_WRITE_INVALID_PTE(_PointerPte, _PteContents)  \</span>
02631 <span class="preprocessor">            (*(_PointerPte) = (_PteContents))</span>
02632 <span class="preprocessor"></span>
02633 <span class="comment">//++</span>
02634 <span class="comment">//VOID</span>
02635 <span class="comment">//MI_WRITE_VALID_PTE_NEW_PROTECTION (</span>
02636 <span class="comment">//    IN PMMPTE PointerPte,</span>
02637 <span class="comment">//    IN MMPTE PteContents</span>
02638 <span class="comment">//    );</span>
02639 <span class="comment">//</span>
02640 <span class="comment">// Routine Description:</span>
02641 <span class="comment">//</span>
02642 <span class="comment">//    MI_WRITE_VALID_PTE_NEW_PROTECTION fills in the specified PTE (which was</span>
02643 <span class="comment">//    already valid) changing only the protection or the dirty bit.</span>
02644 <span class="comment">//</span>
02645 <span class="comment">// Arguments</span>
02646 <span class="comment">//</span>
02647 <span class="comment">//    PointerPte - Supplies a PTE to fill.</span>
02648 <span class="comment">//</span>
02649 <span class="comment">//    PteContents - Supplies the contents to put in the PTE.</span>
02650 <span class="comment">//</span>
02651 <span class="comment">// Return Value:</span>
02652 <span class="comment">//</span>
02653 <span class="comment">//    None.</span>
02654 <span class="comment">//</span>
02655 <span class="comment">//--</span>
02656 
<a name="l02657"></a><a class="code" href="../../d6/d8/mi386_8h.html#a186">02657</a> <span class="preprocessor">#define MI_WRITE_VALID_PTE_NEW_PROTECTION(_PointerPte, _PteContents)    \</span>
02658 <span class="preprocessor">            (*(_PointerPte) = (_PteContents))</span>
02659 <span class="preprocessor"></span>
02660 <span class="comment">//++</span>
02661 <span class="comment">//VOID</span>
02662 <span class="comment">//MiFillMemoryPte (</span>
02663 <span class="comment">//    IN PMMPTE Destination,</span>
02664 <span class="comment">//    IN ULONG  Length,</span>
02665 <span class="comment">//    IN MMPTE  Pattern,</span>
02666 <span class="comment">//    };</span>
02667 <span class="comment">//</span>
02668 <span class="comment">// Routine Description:</span>
02669 <span class="comment">//</span>
02670 <span class="comment">//    This function fills memory with the specified PTE pattern.</span>
02671 <span class="comment">//</span>
02672 <span class="comment">// Arguments</span>
02673 <span class="comment">//</span>
02674 <span class="comment">//    Destination - Supplies a pointer to the memory to fill.</span>
02675 <span class="comment">//</span>
02676 <span class="comment">//    Length      - Supplies the length, in bytes, of the memory to be</span>
02677 <span class="comment">//                  filled.</span>
02678 <span class="comment">//</span>
02679 <span class="comment">//    Pattern     - Supplies the PTE fill pattern.</span>
02680 <span class="comment">//</span>
02681 <span class="comment">// Return Value:</span>
02682 <span class="comment">//</span>
02683 <span class="comment">//    None.</span>
02684 <span class="comment">//</span>
02685 <span class="comment">//--</span>
02686 
<a name="l02687"></a><a class="code" href="../../d6/d8/mi386_8h.html#a187">02687</a> <span class="preprocessor">#define MiFillMemoryPte(Destination, Length, Pattern) \</span>
02688 <span class="preprocessor">             RtlFillMemoryUlong ((Destination), (Length), (Pattern))</span>
02689 <span class="preprocessor"></span>
02690 ULONG
02691 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02692 <a class="code" href="../../d2/d8/setmodfy_8c.html#a1">MiDetermineUserGlobalPteMask</a> (
02693     IN PMMPTE Pte
02694     );
02695 
02696 <span class="comment">//++</span>
02697 <span class="comment">//BOOLEAN</span>
02698 <span class="comment">//MI_IS_PAGE_TABLE_ADDRESS (</span>
02699 <span class="comment">//    IN PVOID VA</span>
02700 <span class="comment">//    );</span>
02701 <span class="comment">//</span>
02702 <span class="comment">// Routine Description:</span>
02703 <span class="comment">//</span>
02704 <span class="comment">//    This macro takes a virtual address and determines if</span>
02705 <span class="comment">//    it is a page table address.</span>
02706 <span class="comment">//</span>
02707 <span class="comment">// Arguments</span>
02708 <span class="comment">//</span>
02709 <span class="comment">//    VA - Supplies a virtual address.</span>
02710 <span class="comment">//</span>
02711 <span class="comment">// Return Value:</span>
02712 <span class="comment">//</span>
02713 <span class="comment">//    TRUE if the address is a page table address, FALSE if not.</span>
02714 <span class="comment">//</span>
02715 <span class="comment">//--</span>
02716 
<a name="l02717"></a><a class="code" href="../../d6/d8/mi386_8h.html#a188">02717</a> <span class="preprocessor">#define MI_IS_PAGE_TABLE_ADDRESS(VA)   \</span>
02718 <span class="preprocessor">            ((PVOID)(VA) &gt;= (PVOID)PTE_BASE &amp;&amp; (PVOID)(VA) &lt;= (PVOID)PDE_TOP)</span>
02719 <span class="preprocessor"></span>
02720 <span class="comment">//++</span>
02721 <span class="comment">//BOOLEAN</span>
02722 <span class="comment">//MI_IS_KERNEL_PAGE_TABLE_ADDRESS (</span>
02723 <span class="comment">//    IN PVOID VA</span>
02724 <span class="comment">//    );</span>
02725 <span class="comment">//</span>
02726 <span class="comment">// Routine Description:</span>
02727 <span class="comment">//</span>
02728 <span class="comment">//    This macro takes a virtual address and determines if</span>
02729 <span class="comment">//    it is a page table address for a kernel address.</span>
02730 <span class="comment">//</span>
02731 <span class="comment">// Arguments</span>
02732 <span class="comment">//</span>
02733 <span class="comment">//    VA - Supplies a virtual address.</span>
02734 <span class="comment">//</span>
02735 <span class="comment">// Return Value:</span>
02736 <span class="comment">//</span>
02737 <span class="comment">//    TRUE if the address is a kernel page table address, FALSE if not.</span>
02738 <span class="comment">//</span>
02739 <span class="comment">//--</span>
02740 
<a name="l02741"></a><a class="code" href="../../d6/d8/mi386_8h.html#a189">02741</a> <span class="preprocessor">#define MI_IS_KERNEL_PAGE_TABLE_ADDRESS(VA)   \</span>
02742 <span class="preprocessor">            ((PVOID)(VA) &gt;= (PVOID)MiGetPteAddress(MmSystemRangeStart) &amp;&amp; (PVOID)(VA) &lt;= (PVOID)PDE_TOP)</span>
02743 <span class="preprocessor"></span>
02744 
02745 <span class="comment">//++</span>
02746 <span class="comment">//BOOLEAN</span>
02747 <span class="comment">//MI_IS_PAGE_DIRECTORY_ADDRESS (</span>
02748 <span class="comment">//    IN PVOID VA</span>
02749 <span class="comment">//    );</span>
02750 <span class="comment">//</span>
02751 <span class="comment">// Routine Description:</span>
02752 <span class="comment">//</span>
02753 <span class="comment">//    This macro takes a virtual address and determines if</span>
02754 <span class="comment">//    it is a page directory address.</span>
02755 <span class="comment">//</span>
02756 <span class="comment">// Arguments</span>
02757 <span class="comment">//</span>
02758 <span class="comment">//    VA - Supplies a virtual address.</span>
02759 <span class="comment">//</span>
02760 <span class="comment">// Return Value:</span>
02761 <span class="comment">//</span>
02762 <span class="comment">//    TRUE if the address is a page directory address, FALSE if not.</span>
02763 <span class="comment">//</span>
02764 <span class="comment">//--</span>
02765 
<a name="l02766"></a><a class="code" href="../../d6/d8/mi386_8h.html#a190">02766</a> <span class="preprocessor">#define MI_IS_PAGE_DIRECTORY_ADDRESS(VA)   \</span>
02767 <span class="preprocessor">            ((PVOID)(VA) &gt;= (PVOID)PDE_BASE &amp;&amp; (PVOID)(VA) &lt;= (PVOID)PDE_TOP)</span>
02768 <span class="preprocessor"></span>
02769 
02770 <span class="comment">//++</span>
02771 <span class="comment">//BOOLEAN</span>
02772 <span class="comment">//MI_IS_HYPER_SPACE_ADDRESS (</span>
02773 <span class="comment">//    IN PVOID VA</span>
02774 <span class="comment">//    );</span>
02775 <span class="comment">//</span>
02776 <span class="comment">// Routine Description:</span>
02777 <span class="comment">//</span>
02778 <span class="comment">//    This macro takes a virtual address and determines if</span>
02779 <span class="comment">//    it is a hyper space address.</span>
02780 <span class="comment">//</span>
02781 <span class="comment">// Arguments</span>
02782 <span class="comment">//</span>
02783 <span class="comment">//    VA - Supplies a virtual address.</span>
02784 <span class="comment">//</span>
02785 <span class="comment">// Return Value:</span>
02786 <span class="comment">//</span>
02787 <span class="comment">//    TRUE if the address is a hyper space address, FALSE if not.</span>
02788 <span class="comment">//</span>
02789 <span class="comment">//--</span>
02790 
<a name="l02791"></a><a class="code" href="../../d6/d8/mi386_8h.html#a191">02791</a> <span class="preprocessor">#define MI_IS_HYPER_SPACE_ADDRESS(VA)   \</span>
02792 <span class="preprocessor">            ((PVOID)(VA) &gt;= (PVOID)HYPER_SPACE &amp;&amp; (PVOID)(VA) &lt;= (PVOID)HYPER_SPACE_END)</span>
02793 <span class="preprocessor"></span>
02794 
02795 <span class="comment">//++</span>
02796 <span class="comment">//BOOLEAN</span>
02797 <span class="comment">//MI_IS_PROCESS_SPACE_ADDRESS (</span>
02798 <span class="comment">//    IN PVOID VA</span>
02799 <span class="comment">//    );</span>
02800 <span class="comment">//</span>
02801 <span class="comment">// Routine Description:</span>
02802 <span class="comment">//</span>
02803 <span class="comment">//    This macro takes a virtual address and determines if</span>
02804 <span class="comment">//    it is a process-specific address.  This is an address in user space</span>
02805 <span class="comment">//    or page table pages or hyper space.</span>
02806 <span class="comment">//</span>
02807 <span class="comment">// Arguments</span>
02808 <span class="comment">//</span>
02809 <span class="comment">//    VA - Supplies a virtual address.</span>
02810 <span class="comment">//</span>
02811 <span class="comment">// Return Value:</span>
02812 <span class="comment">//</span>
02813 <span class="comment">//    TRUE if the address is a process-specific address, FALSE if not.</span>
02814 <span class="comment">//</span>
02815 <span class="comment">//--</span>
02816 
<a name="l02817"></a><a class="code" href="../../d6/d8/mi386_8h.html#a192">02817</a> <span class="preprocessor">#define MI_IS_PROCESS_SPACE_ADDRESS(VA)   \</span>
02818 <span class="preprocessor">            (((PVOID)(VA) &lt;= (PVOID)MM_HIGHEST_USER_ADDRESS) || \</span>
02819 <span class="preprocessor">             ((PVOID)(VA) &gt;= (PVOID)PTE_BASE &amp;&amp; (PVOID)(VA) &lt;= (PVOID)HYPER_SPACE_END))</span>
02820 <span class="preprocessor"></span>
02821 
02822 <span class="comment">//++</span>
02823 <span class="comment">//BOOLEAN</span>
02824 <span class="comment">//MI_IS_PTE_PROTOTYPE (</span>
02825 <span class="comment">//    IN PMMPTE PTE</span>
02826 <span class="comment">//    );</span>
02827 <span class="comment">//</span>
02828 <span class="comment">// Routine Description:</span>
02829 <span class="comment">//</span>
02830 <span class="comment">//    This macro takes a PTE address and determines if it is a prototype PTE.</span>
02831 <span class="comment">//</span>
02832 <span class="comment">// Arguments</span>
02833 <span class="comment">//</span>
02834 <span class="comment">//    PTE - Supplies the virtual address of the PTE to check.</span>
02835 <span class="comment">//</span>
02836 <span class="comment">// Return Value:</span>
02837 <span class="comment">//</span>
02838 <span class="comment">//    TRUE if the PTE is in a segment (ie, a prototype PTE), FALSE if not.</span>
02839 <span class="comment">//</span>
02840 <span class="comment">//--</span>
02841 
<a name="l02842"></a><a class="code" href="../../d6/d8/mi386_8h.html#a193">02842</a> <span class="preprocessor">#define MI_IS_PTE_PROTOTYPE(PTE)   \</span>
02843 <span class="preprocessor">            ((PTE) &gt; (PMMPTE)PDE_TOP)</span>
02844 <span class="preprocessor"></span>
02845 <span class="comment">//++</span>
02846 <span class="comment">//BOOLEAN</span>
02847 <span class="comment">//MI_IS_SYSTEM_CACHE_ADDRESS (</span>
02848 <span class="comment">//    IN PVOID VA</span>
02849 <span class="comment">//    );</span>
02850 <span class="comment">//</span>
02851 <span class="comment">// Routine Description:</span>
02852 <span class="comment">//</span>
02853 <span class="comment">//    This macro takes a virtual address and determines if</span>
02854 <span class="comment">//    it is a system cache address.</span>
02855 <span class="comment">//</span>
02856 <span class="comment">// Arguments</span>
02857 <span class="comment">//</span>
02858 <span class="comment">//    VA - Supplies a virtual address.</span>
02859 <span class="comment">//</span>
02860 <span class="comment">// Return Value:</span>
02861 <span class="comment">//</span>
02862 <span class="comment">//    TRUE if the address is in the system cache, FALSE if not.</span>
02863 <span class="comment">//</span>
02864 <span class="comment">//--</span>
02865 
<a name="l02866"></a><a class="code" href="../../d6/d8/mi386_8h.html#a194">02866</a> <span class="preprocessor">#define MI_IS_SYSTEM_CACHE_ADDRESS(VA)                            \</span>
02867 <span class="preprocessor">         (((PVOID)(VA) &gt;= (PVOID)MmSystemCacheStart &amp;&amp;            \</span>
02868 <span class="preprocessor">                     (PVOID)(VA) &lt;= (PVOID)MmSystemCacheEnd)  ||          \</span>
02869 <span class="preprocessor">          ((PVOID)(VA) &gt;= (PVOID)MiSystemCacheStartExtra &amp;&amp;       \</span>
02870 <span class="preprocessor">                          (PVOID)(VA) &lt;= (PVOID)MiSystemCacheEndExtra))</span>
02871 <span class="preprocessor"></span>
02872 <span class="comment">//++</span>
02873 <span class="comment">//VOID</span>
02874 <span class="comment">//MI_BARRIER_SYNCHRONIZE (</span>
02875 <span class="comment">//    IN ULONG TimeStamp</span>
02876 <span class="comment">//    );</span>
02877 <span class="comment">//</span>
02878 <span class="comment">// Routine Description:</span>
02879 <span class="comment">//</span>
02880 <span class="comment">//    MI_BARRIER_SYNCHRONIZE compares the argument timestamp against the</span>
02881 <span class="comment">//    current IPI barrier sequence stamp.  When equal, all processors will</span>
02882 <span class="comment">//    issue memory barriers to ensure that newly created pages remain coherent.</span>
02883 <span class="comment">//</span>
02884 <span class="comment">//    When a page is put in the zeroed or free page list the current</span>
02885 <span class="comment">//    barrier sequence stamp is read (interlocked - this is necessary</span>
02886 <span class="comment">//    to get the correct value - memory barriers won't do the trick)</span>
02887 <span class="comment">//    and stored in the pfn entry for the page. The current barrier</span>
02888 <span class="comment">//    sequence stamp is maintained by the IPI send logic and is</span>
02889 <span class="comment">//    incremented (interlocked) when the target set of an IPI send</span>
02890 <span class="comment">//    includes all processors, but the one doing the send. When a page</span>
02891 <span class="comment">//    is needed its sequence number is compared against the current</span>
02892 <span class="comment">//    barrier sequence number.  If it is equal, then the contents of</span>
02893 <span class="comment">//    the page may not be coherent on all processors, and an IPI must</span>
02894 <span class="comment">//    be sent to all processors to ensure a memory barrier is</span>
02895 <span class="comment">//    executed (generic call can be used for this). Sending the IPI</span>
02896 <span class="comment">//    automatically updates the barrier sequence number. The compare</span>
02897 <span class="comment">//    is for equality as this is the only value that requires the IPI</span>
02898 <span class="comment">//    (i.e., the sequence number wraps, values in both directions are</span>
02899 <span class="comment">//    older). When a page is removed in this fashion and either found</span>
02900 <span class="comment">//    to be coherent or made coherent, it cannot be modified between</span>
02901 <span class="comment">//    that time and writing the PTE. If the page is modified between</span>
02902 <span class="comment">//    these times, then an IPI must be sent.</span>
02903 <span class="comment">//</span>
02904 <span class="comment">// Arguments</span>
02905 <span class="comment">//</span>
02906 <span class="comment">//    TimeStamp - Supplies the timestamp at the time when the page was zeroed.</span>
02907 <span class="comment">//</span>
02908 <span class="comment">// Return Value:</span>
02909 <span class="comment">//</span>
02910 <span class="comment">//    None.</span>
02911 <span class="comment">//</span>
02912 <span class="comment">//--</span>
02913 
02914 <span class="comment">// does nothing on i386.</span>
02915 
<a name="l02916"></a><a class="code" href="../../d6/d8/mi386_8h.html#a195">02916</a> <span class="preprocessor">#define MI_BARRIER_SYNCHRONIZE(TimeStamp)</span>
02917 <span class="preprocessor"></span>
02918 <span class="comment">//++</span>
02919 <span class="comment">//VOID</span>
02920 <span class="comment">//MI_BARRIER_STAMP_ZEROED_PAGE (</span>
02921 <span class="comment">//    IN PULONG PointerTimeStamp</span>
02922 <span class="comment">//    );</span>
02923 <span class="comment">//</span>
02924 <span class="comment">// Routine Description:</span>
02925 <span class="comment">//</span>
02926 <span class="comment">//    MI_BARRIER_STAMP_ZEROED_PAGE issues an interlocked read to get the</span>
02927 <span class="comment">//    current IPI barrier sequence stamp.  This is called AFTER a page is</span>
02928 <span class="comment">//    zeroed.</span>
02929 <span class="comment">//</span>
02930 <span class="comment">// Arguments</span>
02931 <span class="comment">//</span>
02932 <span class="comment">//    PointerTimeStamp - Supplies a timestamp pointer to fill with the</span>
02933 <span class="comment">//                       current IPI barrier sequence stamp.</span>
02934 <span class="comment">//</span>
02935 <span class="comment">// Return Value:</span>
02936 <span class="comment">//</span>
02937 <span class="comment">//    None.</span>
02938 <span class="comment">//</span>
02939 <span class="comment">//--</span>
02940 
02941 <span class="comment">// does nothing on i386.</span>
02942 
<a name="l02943"></a><a class="code" href="../../d6/d8/mi386_8h.html#a196">02943</a> <span class="preprocessor">#define MI_BARRIER_STAMP_ZEROED_PAGE(PointerTimeStamp)</span>
02944 <span class="preprocessor"></span>
02945 <span class="comment">//++</span>
02946 <span class="comment">//VOID</span>
02947 <span class="comment">//MI_FLUSH_SINGLE_SESSION_TB (</span>
02948 <span class="comment">//    IN PVOID Virtual,</span>
02949 <span class="comment">//    IN ULONG Invalid,</span>
02950 <span class="comment">//    IN LOGICAL AllProcessors,</span>
02951 <span class="comment">//    IN PMMPTE PtePointer,</span>
02952 <span class="comment">//    IN MMPTE PteValue,</span>
02953 <span class="comment">//    IN MMPTE PreviousPte</span>
02954 <span class="comment">//    );</span>
02955 <span class="comment">//</span>
02956 <span class="comment">// Routine Description:</span>
02957 <span class="comment">//</span>
02958 <span class="comment">//    MI_FLUSH_SINGLE_SESSION_TB flushes the requested single address</span>
02959 <span class="comment">//    translation from the TB.  </span>
02960 <span class="comment">//</span>
02961 <span class="comment">//    Since there are no ASNs on the x86, this routine becomes a single</span>
02962 <span class="comment">//    TB invalidate.</span>
02963 <span class="comment">//</span>
02964 <span class="comment">// Arguments</span>
02965 <span class="comment">//</span>
02966 <span class="comment">//    Virtual - Supplies the virtual address to invalidate.</span>
02967 <span class="comment">//</span>
02968 <span class="comment">//    Invalid - TRUE if invalidating.</span>
02969 <span class="comment">//</span>
02970 <span class="comment">//    AllProcessors - TRUE if all processors need to be IPI'd.</span>
02971 <span class="comment">//</span>
02972 <span class="comment">//    PtePointer - Supplies the PTE to invalidate.</span>
02973 <span class="comment">//</span>
02974 <span class="comment">//    PteValue - Supplies the new PTE value.</span>
02975 <span class="comment">//</span>
02976 <span class="comment">//    PreviousPte - The previous PTE value is returned here.</span>
02977 <span class="comment">//</span>
02978 <span class="comment">// Return Value:</span>
02979 <span class="comment">//</span>
02980 <span class="comment">//    None.</span>
02981 <span class="comment">//</span>
02982 <span class="comment">//--</span>
02983 
<a name="l02984"></a><a class="code" href="../../d6/d8/mi386_8h.html#a197">02984</a> <span class="preprocessor">#define MI_FLUSH_SINGLE_SESSION_TB(Virtual, Invalid, AllProcessors, PtePointer, PteValue, PreviousPte) \</span>
02985 <span class="preprocessor">    PreviousPte.u.Flush = KeFlushSingleTb (Virtual,      \</span>
02986 <span class="preprocessor">                                           TRUE,         \</span>
02987 <span class="preprocessor">                                           TRUE,         \</span>
02988 <span class="preprocessor">                                           PtePointer,   \</span>
02989 <span class="preprocessor">                                           PteValue);</span>
02990 <span class="preprocessor"></span>
02991 <span class="comment">//++</span>
02992 <span class="comment">//VOID</span>
02993 <span class="comment">//MI_FLUSH_ENTIRE_SESSION_TB (</span>
02994 <span class="comment">//    IN ULONG Invalid,</span>
02995 <span class="comment">//    IN LOGICAL AllProcessors</span>
02996 <span class="comment">//    );</span>
02997 <span class="comment">//</span>
02998 <span class="comment">// Routine Description:</span>
02999 <span class="comment">//</span>
03000 <span class="comment">//    MI_FLUSH_ENTIRE_SESSION_TB flushes the entire TB on processors which</span>
03001 <span class="comment">//    support ASNs.</span>
03002 <span class="comment">//</span>
03003 <span class="comment">//    Since there are no ASNs on the x86, this routine does nothing.</span>
03004 <span class="comment">//</span>
03005 <span class="comment">// Arguments</span>
03006 <span class="comment">//</span>
03007 <span class="comment">//    Invalid - TRUE if invalidating.</span>
03008 <span class="comment">//</span>
03009 <span class="comment">//    AllProcessors - TRUE if all processors need to be IPI'd.</span>
03010 <span class="comment">//</span>
03011 <span class="comment">// Return Value:</span>
03012 <span class="comment">//</span>
03013 <span class="comment">//    None.</span>
03014 <span class="comment">//</span>
03015 
<a name="l03016"></a><a class="code" href="../../d6/d8/mi386_8h.html#a198">03016</a> <span class="preprocessor">#define MI_FLUSH_ENTIRE_SESSION_TB(Invalid, AllProcessors) \</span>
03017 <span class="preprocessor">    NOTHING;</span>
03018 <span class="preprocessor"></span>
03019 <span class="preprocessor">#else</span>
03020 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d5/d9/mipae_8h.html">i386\mipae.h</a>"</span>
03021 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
