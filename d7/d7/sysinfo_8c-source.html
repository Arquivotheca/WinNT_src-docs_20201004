<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sysinfo.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sysinfo.c</h1><a href="../../d6/d8/sysinfo_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    sysinfo.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the NT set and query system information services.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 21-Aug-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00026 <span class="preprocessor">#pragma hdrstop</span>
00027 <span class="preprocessor"></span>
00028 <span class="preprocessor">#include "stdlib.h"</span>
00029 <span class="preprocessor">#include "string.h"</span>
00030 <span class="preprocessor">#include "<a class="code" href="../../d1/d5/vdmntos_8h.html">vdmntos.h</a>"</span>
00031 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d4/d2/pool_8h.html">pool.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="../../d8/d6/stktrace_8h.html">stktrace.h</a>"</span>
00034 <span class="preprocessor">#include "align.h"</span>
00035 <span class="preprocessor">#include "..\..\..\inc\alpha.h"</span>
00036 
<a name="l00037"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a1">00037</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>;       <span class="comment">// BUGBUG - Copied from ps\psp.h</span>
00038 
<a name="l00039"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a2">00039</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a>;
<a name="l00040"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a3">00040</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
<a name="l00041"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a4">00041</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
<a name="l00042"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a5">00042</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a>;
<a name="l00043"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a6">00043</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>;
<a name="l00044"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a7">00044</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
<a name="l00045"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a8">00045</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[1];
<a name="l00046"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a9">00046</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a9">MmSystemCodePage</a>;
<a name="l00047"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a10">00047</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a10">MmSystemCachePage</a>;
<a name="l00048"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a11">00048</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a11">MmPagedPoolPage</a>;
<a name="l00049"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a12">00049</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a12">MmSystemDriverPage</a>;
<a name="l00050"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a13">00050</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a13">MmTotalSystemCodePages</a>;
<a name="l00051"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a14">00051</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a>;
<a name="l00052"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a15">00052</a> <span class="keyword">extern</span> RTL_TIME_ZONE_INFORMATION <a class="code" href="../../d6/d8/sysinfo_8c.html#a15">ExpTimeZoneInformation</a>;
00053 
00054 <span class="comment">//</span>
00055 <span class="comment">// For SystemDpcBehaviorInformation</span>
00056 <span class="comment">//</span>
<a name="l00057"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a16">00057</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
<a name="l00058"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a17">00058</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
<a name="l00059"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a18">00059</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
<a name="l00060"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a19">00060</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a67">KiIdealDpcRate</a>;
00061 
<a name="l00062"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a20">00062</a> <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d6/d8/sysinfo_8c.html#a20">MmLoadedUserImageList</a>;
00063 
<a name="l00064"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a21">00064</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
<a name="l00065"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a22">00065</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a>;
<a name="l00066"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a23">00066</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a23">MmTransitionSharedPagesPeak</a>;
00067 
<a name="l00068"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a0">00068</a> <span class="preprocessor">#define ROUND_UP(VALUE,ROUND) ((ULONG)(((ULONG)VALUE + \</span>
00069 <span class="preprocessor">                               ((ULONG)ROUND - 1L)) &amp; (~((ULONG)ROUND - 1L))))</span>
00070 <span class="preprocessor"></span>
00071 <span class="comment">//</span>
00072 <span class="comment">// For referencing a user-supplied event handle</span>
00073 <span class="comment">//</span>
<a name="l00074"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a24">00074</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>;
00075 
00076 
00077 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00078 <a class="code" href="../../d6/d8/sysinfo_8c.html#a28">ExpValidateLocale</a>(
00079     IN LCID LocaleId
00080     );
00081 
00082 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00083 <a class="code" href="../../d6/d8/sysinfo_8c.html#a29">ExpGetCurrentUserUILanguage</a>(
00084     IN WCHAR *ValueName,
00085     OUT LANGID *CurrentUserUILanguageId
00086     );
00087 
00088 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00089 <a class="code" href="../../d6/d8/sysinfo_8c.html#a30">ExpSetCurrentUserUILanguage</a>(
00090     IN WCHAR *ValueName,
00091     IN LANGID DefaultUILanguageId
00092     );
00093 
00094 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00095 <a class="code" href="../../d6/d8/sysinfo_8c.html#a31">ExpGetUILanguagePolicy</a>(
00096     IN HANDLE CurrentUserKey,
00097     OUT LANGID *PolicyUILanguageId
00098     );
00099 
00100 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00101 <a class="code" href="../../d6/d8/sysinfo_8c.html#a32">ExpGetProcessInformation</a> (
00102     OUT PVOID SystemInformation,
00103     IN ULONG SystemInformationLength,
00104     OUT PULONG Length,
00105     IN PULONG SessionId OPTIONAL
00106     );
00107 
00108 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00109 <a class="code" href="../../d6/d8/sysinfo_8c.html#a33">ExpCopyProcessInfo</a> (
00110     IN PSYSTEM_PROCESS_INFORMATION ProcessInfo,
00111     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00112     );
00113 
00114 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00115 <a class="code" href="../../d6/d8/sysinfo_8c.html#a34">ExpCopyThreadInfo</a> (
00116     IN PSYSTEM_THREAD_INFORMATION ThreadInfo,
00117     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread
00118     );
00119 
00120 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00121 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00122 ExpGetStackTraceInformation (
00123     OUT PVOID SystemInformation,
00124     IN ULONG SystemInformationLength,
00125     OUT PULONG Length
00126     );
00127 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00128 <span class="preprocessor"></span>
00129 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00130 <a class="code" href="../../d6/d8/sysinfo_8c.html#a35">ExpGetLockInformation</a> (
00131     OUT PVOID SystemInformation,
00132     IN ULONG SystemInformationLength,
00133     OUT PULONG Length
00134     );
00135 
00136 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00137 <a class="code" href="../../d6/d8/sysinfo_8c.html#a36">ExpGetLookasideInformation</a> (
00138     OUT PVOID Buffer,
00139     IN ULONG BufferLength,
00140     OUT PULONG Length
00141     );
00142 
00143 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00144 <a class="code" href="../../d6/d8/sysinfo_8c.html#a37">ExpGetPoolInformation</a>(
00145     IN POOL_TYPE PoolType,
00146     OUT PVOID SystemInformation,
00147     IN ULONG SystemInformationLength,
00148     OUT PULONG Length
00149     );
00150 
00151 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00152 <a class="code" href="../../d6/d8/sysinfo_8c.html#a38">ExpGetHandleInformation</a>(
00153     OUT PVOID SystemInformation,
00154     IN ULONG SystemInformationLength,
00155     OUT PULONG Length
00156     );
00157 
00158 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00159 <a class="code" href="../../d6/d8/sysinfo_8c.html#a39">ExpGetObjectInformation</a>(
00160     OUT PVOID SystemInformation,
00161     IN ULONG SystemInformationLength,
00162     OUT PULONG Length
00163     );
00164 
00165 
00166 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00167 <a class="code" href="../../d6/d8/sysinfo_8c.html#a40">ExpGetInstemulInformation</a>(
00168     OUT PSYSTEM_VDM_INSTEMUL_INFO Info
00169     );
00170 
00171 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00172 <a class="code" href="../../d6/d8/sysinfo_8c.html#a41">ExpGetPoolTagInfo</a> (
00173     IN PVOID SystemInformation,
00174     IN ULONG SystemInformationLength,
00175     IN OUT PULONG ReturnLength OPTIONAL
00176     );
00177 
00178 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00179 <a class="code" href="../../d6/d8/sysinfo_8c.html#a42">ExpQueryModuleInformation</a>(
00180     IN PLIST_ENTRY LoadOrderListHead,
00181     IN PLIST_ENTRY UserModeLoadOrderListHead,
00182     OUT PRTL_PROCESS_MODULES ModuleInformation,
00183     IN ULONG ModuleInformationLength,
00184     OUT PULONG ReturnLength OPTIONAL
00185     );
00186 
00187 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00188 <a class="code" href="../../d6/d8/sysinfo_8c.html#a43">ExpQueryLegacyDriverInformation</a>(
00189     IN PSYSTEM_LEGACY_DRIVER_INFORMATION LegacyInfo,
00190     IN PULONG Length
00191     );
00192 
00193 <span class="preprocessor">#if defined(ALLOC_PRAGMA)</span>
00194 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryDefaultLocale)</span>
00195 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetDefaultLocale)</span>
00196 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryInstallUILanguage)</span>
00197 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryDefaultUILanguage)</span>
00198 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpGetCurrentUserUILanguage)</span>
00199 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetDefaultUILanguage)</span>
00200 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpSetCurrentUserUILanguage)</span>
00201 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpValidateLocale)</span>
00202 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpGetUILanguagePolicy)</span>
00203 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQuerySystemInformation)</span>
00204 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetSystemInformation)</span>
00205 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpGetHandleInformation)</span>
00206 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpGetObjectInformation)</span>
00207 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpQueryModuleInformation)</span>
00208 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpCopyProcessInfo)</span>
00209 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpQueryLegacyDriverInformation)</span>
00210 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExpGetProcessInformation)</span>
00211 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExpCopyThreadInfo)</span>
00212 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExpGetLockInformation)</span>
00213 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExpGetLookasideInformation)</span>
00214 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExpGetPoolInformation)</span>
00215 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00216 <span class="preprocessor"></span>
00217 
00218 
00219 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00220"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a44">00220</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a44">NtQueryDefaultLocale</a>(
00221     IN BOOLEAN UserProfile,
00222     OUT PLCID DefaultLocaleId
00223     )
00224 {
00225     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00226     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00227 
00228     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00229 
00230     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00231     <span class="keywordflow">try</span> {
00232 
00233         <span class="comment">//</span>
00234         <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
00235         <span class="comment">//</span>
00236 
00237         PreviousMode = KeGetPreviousMode();
00238         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00239             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( (PULONG)DefaultLocaleId );
00240             }
00241 
00242         <span class="keywordflow">if</span> (UserProfile) {
00243             *DefaultLocaleId = <a class="code" href="../../d1/d9/ps_8h.html#a59">PsDefaultThreadLocaleId</a>;
00244             }
00245         <span class="keywordflow">else</span> {
00246             *DefaultLocaleId = <a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a>;
00247             }
00248         }
00249     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00250         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00251         }
00252 
00253     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00254 }
00255 
00256 
00257 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00258"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a45">00258</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a45">NtSetDefaultLocale</a>(
00259     IN BOOLEAN UserProfile,
00260     IN LCID DefaultLocaleId
00261     )
00262 {
00263     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00264     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00265     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, KeyValueName;
00266     HANDLE CurrentUserKey, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00267     WCHAR KeyValueBuffer[ 128 ];
00268     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
00269     ULONG ResultLength;
00270     PWSTR s;
00271     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>, i, Digit;
00272     WCHAR <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00273 
00274     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00275 
00276     <span class="keywordflow">if</span> (DefaultLocaleId &amp; 0xFFFF0000) {
00277         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00278         }
00279 
00280     KeyValueInformation = (PKEY_VALUE_PARTIAL_INFORMATION)KeyValueBuffer;
00281     <span class="keywordflow">if</span> (UserProfile) {
00282         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">RtlOpenCurrentUser</a>( MAXIMUM_ALLOWED, &amp;CurrentUserKey );
00283         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00284             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00285             }
00286 
00287         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Locale"</span> );
00288         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control Panel\\International"</span> );
00289         }
00290     <span class="keywordflow">else</span> {
00291         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Default"</span> );
00292         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Nls\\Language"</span> );
00293         CurrentUserKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00294         }
00295 
00296     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00297                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00298                                 (OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE),
00299                                 CurrentUserKey,
00300                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00301                               );
00302     <span class="keywordflow">if</span> (DefaultLocaleId == 0) {
00303         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00304                             GENERIC_READ,
00305                             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00306                           );
00307         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00308             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00309                                       &amp;KeyValueName,
00310                                       KeyValuePartialInformation,
00311                                       KeyValueInformation,
00312                                       <span class="keyword">sizeof</span>( KeyValueBuffer ),
00313                                       &amp;ResultLength
00314                                     );
00315             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00316                 <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type == REG_SZ) {
00317                     s = (PWSTR)KeyValueInformation-&gt;Data;
00318                     <span class="keywordflow">for</span> (i=0; i&lt;KeyValueInformation-&gt;DataLength; i += <span class="keyword">sizeof</span>( WCHAR )) {
00319                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = *s++;
00320                         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span> &amp;&amp; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>) {
00321                             Digit = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>;
00322                             }
00323                         <span class="keywordflow">else</span>
00324                         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span> &amp;&amp; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'F'</span>) {
00325                             Digit = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span> + 10;
00326                             }
00327                         <span class="keywordflow">else</span>
00328                         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span> &amp;&amp; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'f'</span>) {
00329                             Digit = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span> + 10;
00330                             }
00331                         <span class="keywordflow">else</span> {
00332                             <span class="keywordflow">break</span>;
00333                             }
00334 
00335                         <span class="keywordflow">if</span> (Digit &gt;= 16) {
00336                             <span class="keywordflow">break</span>;
00337                             }
00338 
00339                         DefaultLocaleId = (DefaultLocaleId &lt;&lt; 4) | Digit;
00340                         }
00341                     }
00342                 <span class="keywordflow">else</span>
00343                 <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type == REG_DWORD &amp;&amp;
00344                     KeyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>( ULONG )
00345                    ) {
00346                     DefaultLocaleId = *(PLCID)KeyValueInformation-&gt;Data;
00347                     }
00348                 <span class="keywordflow">else</span> {
00349                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00350                     }
00351                 }
00352 
00353             ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
00354             }
00355         }
00356     <span class="keywordflow">else</span> {
00357 
00358         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a28">ExpValidateLocale</a>( DefaultLocaleId );
00359 
00360         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00361 
00362             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00363                                 GENERIC_WRITE,
00364                                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00365                               );
00366 
00367             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00368                 <span class="keywordflow">if</span> (UserProfile) {
00369                     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 8;
00370                     }
00371                 <span class="keywordflow">else</span> {
00372                     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 4;
00373                     }
00374                 s = &amp;KeyValueBuffer[ <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> ];
00375                 *s-- = UNICODE_NULL;
00376                 i = (ULONG)DefaultLocaleId;
00377                 <span class="keywordflow">while</span> (s &gt;= KeyValueBuffer) {
00378                     Digit = i &amp; 0x0000000F;
00379                     <span class="keywordflow">if</span> (Digit &lt;= 9) {
00380                         *s-- = (WCHAR)(Digit + <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
00381                         }
00382                     <span class="keywordflow">else</span> {
00383                         *s-- = (WCHAR)((Digit - 10) + <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>);
00384                         }
00385 
00386                     i = i &gt;&gt; 4;
00387                     }
00388 
00389                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetValueKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00390                                         &amp;KeyValueName,
00391                                         0,
00392                                         REG_SZ,
00393                                         KeyValueBuffer,
00394                                         (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>+1) * <span class="keyword">sizeof</span>( WCHAR )
00395                                       );
00396                 ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
00397                 }
00398             }
00399         }
00400 
00401     ZwClose( CurrentUserKey );
00402 
00403     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00404         <span class="keywordflow">if</span> (UserProfile) {
00405             <a class="code" href="../../d1/d9/ps_8h.html#a59">PsDefaultThreadLocaleId</a> = DefaultLocaleId;
00406             }
00407         <span class="keywordflow">else</span> {
00408             <a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a> = DefaultLocaleId;
00409             }
00410         }
00411 
00412     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00413 }
00414 
00415 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00416"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a46">00416</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a46">NtQueryInstallUILanguage</a>(
00417     OUT LANGID *InstallUILanguageId
00418     )
00419 {
00420     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00421     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00422 
00423     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00424 
00425     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00426     <span class="keywordflow">try</span> {
00427 
00428         <span class="comment">//</span>
00429         <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
00430         <span class="comment">//</span>
00431 
00432         PreviousMode = KeGetPreviousMode();
00433         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00434             <a class="code" href="../../d5/d8/ex_8h.html#a34">ProbeForWriteUshort</a>( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *)InstallUILanguageId );
00435             }
00436 
00437         *InstallUILanguageId = <a class="code" href="../../d1/d9/ps_8h.html#a61">PsInstallUILanguageId</a>;
00438         }
00439     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00440         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00441         }
00442 
00443     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00444 }
00445 
00446 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00447"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a47">00447</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a47">NtQueryDefaultUILanguage</a>(
00448     OUT LANGID *DefaultUILanguageId
00449     )
00450 {
00451     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00452     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00453 
00454     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00455 
00456     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00457     <span class="keywordflow">try</span> {
00458 
00459         <span class="comment">//</span>
00460         <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
00461         <span class="comment">//</span>
00462 
00463         PreviousMode = KeGetPreviousMode();
00464         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00465             <a class="code" href="../../d5/d8/ex_8h.html#a34">ProbeForWriteUshort</a>( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *)DefaultUILanguageId );
00466             }
00467 
00468         <span class="comment">//</span>
00469         <span class="comment">// Read the UI language from the current security context.</span>
00470         <span class="comment">//</span>
00471         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a29">ExpGetCurrentUserUILanguage</a>( <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MultiUILanguageId"</span>, 
00472                                                      DefaultUILanguageId))) {
00473             *DefaultUILanguageId = <a class="code" href="../../d1/d9/ps_8h.html#a61">PsInstallUILanguageId</a>;
00474             }
00475         }
00476     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00477         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00478         }
00479 
00480     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00481 }
00482 
00483 
00484 
00485 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00486"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a31">00486</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a31">ExpGetUILanguagePolicy</a>(
00487     IN HANDLE CurrentUserKey,
00488     OUT LANGID *PolicyUILanguageId
00489     )
00490 {
00491     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00492     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, MuiObjectAttributes;
00493     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, KeyValueName, MuiLanguagesKeyPath;
00494     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, KeyMui;
00495     WCHAR KeyValueBuffer[ 128 ];
00496     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
00497     ULONG ResultLength;
00498     ULONG Language;
00499 
00500     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00501 
00502 
00503     <span class="comment">//</span>
00504     <span class="comment">// Let's verify that this is an MUI system first</span>
00505     <span class="comment">//</span>
00506     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;MuiLanguagesKeyPath, 
00507                           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Nls\\MUILanguages"</span> );
00508     InitializeObjectAttributes( &amp;MuiObjectAttributes,
00509                                 &amp;MuiLanguagesKeyPath,
00510                                 (OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE),
00511                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00512                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00513                               );
00514 
00515     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( &amp;KeyMui,
00516                         GENERIC_READ,
00517                         &amp;MuiObjectAttributes
00518                       );
00519     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00520         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00521         }
00522 
00523     ZwClose( KeyMui );
00524 
00525 
00526 
00527     KeyValueInformation = (PKEY_VALUE_PARTIAL_INFORMATION)KeyValueBuffer;
00528     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MultiUILanguageId"</span> );
00529     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Software\\Policies\\Microsoft\\Control Panel\\Desktop"</span> );
00530 
00531     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00532                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00533                                 (OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE),
00534                                 CurrentUserKey,
00535                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00536                               );
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// Check if there is a Policy key</span>
00540     <span class="comment">//</span>
00541     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00542                         GENERIC_READ,
00543                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00544                       );
00545 
00546     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00547 
00548         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00549                                   &amp;KeyValueName,
00550                                   KeyValuePartialInformation,
00551                                   KeyValueInformation,
00552                                   <span class="keyword">sizeof</span>( KeyValueBuffer ),
00553                                   &amp;ResultLength
00554                                 );
00555 
00556         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00557             <span class="keywordflow">if</span> ((KeyValueInformation-&gt;DataLength &gt; 2) &amp;&amp;
00558                 (KeyValueInformation-&gt;Type == REG_SZ)) {
00559 
00560                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, (PWSTR) KeyValueInformation-&gt;Data );
00561                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>( &amp;KeyValueName,
00562                                                     (ULONG)16,
00563                                                     &amp;Language
00564                                                   );
00565                 <span class="comment">//</span>
00566                 <span class="comment">// Final check to make sure this is an MUI system</span>
00567                 <span class="comment">//</span>
00568                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00569                     *PolicyUILanguageId = (LANGID)Language;
00570                     }
00571                 }
00572             <span class="keywordflow">else</span> {
00573                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00574                 }
00575             }
00576             ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
00577         }
00578 
00579     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00580 }
00581 
00582 
00583 
00584 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00585"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a30">00585</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a30">ExpSetCurrentUserUILanguage</a>(
00586     IN WCHAR *ValueName,
00587     IN LANGID CurrentUserUILanguage
00588     )
00589 {
00590     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00591     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00592     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, KeyValueName, UILanguage;
00593     HANDLE CurrentUserKey, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;       
00594     WCHAR KeyValueBuffer[ 128 ];
00595     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
00596     PWSTR s;
00597     ULONG i, Digit;
00598     WCHAR <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00599 
00600     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00601 
00602     <span class="keywordflow">if</span> (CurrentUserUILanguage &amp; 0xFFFF0000) {
00603         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00604         }
00605 
00606     KeyValueInformation = (PKEY_VALUE_PARTIAL_INFORMATION)KeyValueBuffer;
00607     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">RtlOpenCurrentUser</a>( MAXIMUM_ALLOWED, &amp;CurrentUserKey );
00608     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00609         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00610         }
00611 
00612     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> );
00613     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control Panel\\Desktop"</span> );
00614     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00615                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00616                                 (OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE),
00617                                 CurrentUserKey,
00618                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00619                               );
00620 
00621 
00622     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a28">ExpValidateLocale</a>( MAKELCID( CurrentUserUILanguage, SORT_DEFAULT ) );
00623     
00624     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00625 
00626         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00627                             GENERIC_WRITE,
00628                             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00629                           );
00630         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00631 
00632             s = &amp;KeyValueBuffer[ 8 ];
00633             *s-- = UNICODE_NULL;
00634             i = (ULONG)CurrentUserUILanguage;
00635 
00636             <span class="keywordflow">while</span> (s &gt;= KeyValueBuffer) {
00637                 Digit = i &amp; 0x0000000F;
00638                 <span class="keywordflow">if</span> (Digit &lt;= 9) {
00639                     *s-- = (WCHAR)(Digit + <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
00640                     }
00641                 <span class="keywordflow">else</span> {
00642                     *s-- = (WCHAR)((Digit - 10) + <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>);
00643                     }
00644 
00645                 i = i &gt;&gt; 4;
00646                 }
00647 
00648             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetValueKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00649                                     &amp;KeyValueName,
00650                                     0,
00651                                     REG_SZ,
00652                                     KeyValueBuffer,
00653                                     9 * <span class="keyword">sizeof</span>( WCHAR )
00654                                   );
00655             ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
00656             }
00657         }
00658 
00659     ZwClose( CurrentUserKey );
00660 
00661     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00662 }
00663 
00664 
00665 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00666"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a29">00666</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a29">ExpGetCurrentUserUILanguage</a>(
00667     IN WCHAR *ValueName,
00668     OUT LANGID *CurrentUserUILanguageId
00669     )
00670 {
00671     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00672     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00673     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, KeyValueName, UILanguage;
00674     HANDLE CurrentUserKey, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;       
00675     WCHAR KeyValueBuffer[ 128 ];
00676     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
00677     ULONG ResultLength;
00678     ULONG Digit;
00679 
00680     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00681 
00682     KeyValueInformation = (PKEY_VALUE_PARTIAL_INFORMATION)KeyValueBuffer;
00683     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">RtlOpenCurrentUser</a>( MAXIMUM_ALLOWED, &amp;CurrentUserKey );
00684     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00685         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00686         }
00687 
00688     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> );
00689     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control Panel\\Desktop"</span> );
00690     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00691                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00692                                 (OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE),
00693                                 CurrentUserKey,
00694                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00695                               );
00696 
00697     <span class="comment">//</span>
00698     <span class="comment">// Let's check if there is a policy installed for the UI language,</span>
00699     <span class="comment">// and if so, let's use it.</span>
00700     <span class="comment">//</span>
00701     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d6/d8/sysinfo_8c.html#a31">ExpGetUILanguagePolicy</a>( CurrentUserKey, CurrentUserUILanguageId ))) {
00702         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00703                             GENERIC_READ,
00704                             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00705                           );
00706         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00707             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00708                                       &amp;KeyValueName,
00709                                       KeyValuePartialInformation,
00710                                       KeyValueInformation,
00711                                       <span class="keyword">sizeof</span>( KeyValueBuffer ),
00712                                       &amp;ResultLength
00713                                     );
00714             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00715                 <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type == REG_SZ) {
00716 
00717                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UILanguage, (PWSTR) KeyValueInformation-&gt;Data);
00718                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>( &amp;UILanguage,
00719                                                         (ULONG) 16,
00720                                                         &amp;Digit
00721                                                       );
00722                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00723                         *CurrentUserUILanguageId = (LANGID) Digit;
00724                         }
00725                     }
00726                 <span class="keywordflow">else</span> {
00727                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00728                     }
00729                 }
00730             ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
00731             }
00732         }
00733 
00734     ZwClose( CurrentUserKey );
00735 
00736     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00737 }
00738 
00739 
00740 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00741"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a48">00741</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a48">NtSetDefaultUILanguage</a>(
00742     IN LANGID DefaultUILanguageId
00743     )
00744 {
00745     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00746     LANGID LangId;
00747 
00748     <span class="comment">//</span>
00749     <span class="comment">//  if this is called during user logon, then we need to update the user's registry.</span>
00750     <span class="comment">//</span>
00751     <span class="keywordflow">if</span> (DefaultUILanguageId == 0) {
00752         
00753           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a29">ExpGetCurrentUserUILanguage</a>( <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MUILanguagePending"</span> , 
00754                                                 &amp;LangId 
00755                                               );
00756           <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00757             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a30">ExpSetCurrentUserUILanguage</a>( <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MultiUILanguageId"</span> ,
00758                                                   LangId
00759                                                 );
00760             }
00761           
00762           <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00763         }
00764     
00765     <span class="keywordflow">return</span> <a class="code" href="../../d6/d8/sysinfo_8c.html#a30">ExpSetCurrentUserUILanguage</a>( <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MUILanguagePending"</span>, DefaultUILanguageId );
00766 }
00767 
00768 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00769"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a28">00769</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a28">ExpValidateLocale</a>(
00770     IN LCID LocaleId
00771     )
00772 {
00773     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER, ReturnStatus;
00774     UNICODE_STRING LocaleName, KeyValueName;
00775     UNICODE_STRING NlsLocaleKeyPath, NlsSortKeyPath, NlsLangGroupKeyPath;
00776     WCHAR LocaleNameBuffer[ 32 ];
00777     WCHAR KeyValueNameBuffer[ 32 ];
00778     WCHAR KeyValueBuffer[ 128 ];
00779     WCHAR *<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>;
00780     HANDLE LocaleKey, SortKey, LangGroupKey;
00781     OBJECT_ATTRIBUTES NlsLocaleObjA, NlsSortObjA, NlsLangGroupObjA;
00782     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
00783     ULONG i, ResultLength;
00784 
00785 
00786     <span class="comment">//</span>
00787     <span class="comment">//  Convert the LCID to the form %08x (e.g. 00000409)</span>
00788     <span class="comment">//</span>
00789     LocaleName.Length = <span class="keyword">sizeof</span>( LocaleNameBuffer ) / <span class="keyword">sizeof</span>( WCHAR );
00790     LocaleName.MaximumLength = LocaleName.Length;
00791     LocaleName.Buffer = LocaleNameBuffer;
00792 
00793     <span class="comment">//</span>
00794     <span class="comment">//  Convert LCID to a string</span>
00795     <span class="comment">//</span>
00796     ReturnStatus = <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>( LocaleId, 16, &amp;LocaleName );
00797     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnStatus))
00798         <span class="keywordflow">goto</span> Failed1;
00799 
00800     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> = KeyValueNameBuffer;
00801     <span class="keywordflow">for</span> (i = ((LocaleName.Length)/<span class="keyword">sizeof</span>(WCHAR));
00802          i &lt; 8;
00803          i++, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>++) {
00804         *<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>;
00805         }
00806     *<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> = UNICODE_NULL;
00807 
00808     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;KeyValueName, KeyValueNameBuffer);
00809     KeyValueName.MaximumLength = <span class="keyword">sizeof</span>( KeyValueNameBuffer ) / <span class="keyword">sizeof</span>( WCHAR );
00810     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;KeyValueName, LocaleName.Buffer);
00811 
00812 
00813     <span class="comment">//</span>
00814     <span class="comment">// Open Registry Keys : Locale, Sort and LanguageGroup</span>
00815     <span class="comment">//</span>
00816     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NlsLocaleKeyPath, 
00817                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Nls\\Locale"</span>);
00818 
00819     InitializeObjectAttributes( &amp;NlsLocaleObjA,
00820                                 &amp;NlsLocaleKeyPath,
00821                                 (OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE),
00822                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00823                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00824                               );
00825 
00826     ReturnStatus = ZwOpenKey( &amp;LocaleKey,
00827                               GENERIC_READ,
00828                               &amp;NlsLocaleObjA 
00829                             );
00830     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnStatus))
00831          <span class="keywordflow">goto</span> Failed1;
00832 
00833     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NlsSortKeyPath, 
00834                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Nls\\Locale\\Alternate Sorts"</span>);
00835 
00836     InitializeObjectAttributes( &amp;NlsSortObjA,
00837                                 &amp;NlsSortKeyPath,
00838                                 (OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE),
00839                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00840                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00841                               );
00842 
00843     ReturnStatus = ZwOpenKey( &amp;SortKey,
00844                               GENERIC_READ,
00845                               &amp;NlsSortObjA 
00846                             );
00847     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnStatus))
00848          <span class="keywordflow">goto</span> Failed2;
00849 
00850     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NlsLangGroupKeyPath, 
00851                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Nls\\Language Groups"</span>);
00852 
00853     InitializeObjectAttributes( &amp;NlsLangGroupObjA,
00854                                 &amp;NlsLangGroupKeyPath,
00855                                 (OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE),
00856                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00857                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00858                               );
00859 
00860 
00861     ReturnStatus = ZwOpenKey( &amp;LangGroupKey,
00862                               GENERIC_READ,
00863                               &amp;NlsLangGroupObjA 
00864                             );
00865     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnStatus))
00866          <span class="keywordflow">goto</span> Failed3;
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">// Validate Locale : Lookup the Locale's Language group, and make sure it is there.</span>
00870     <span class="comment">//</span>
00871     KeyValueInformation = (PKEY_VALUE_PARTIAL_INFORMATION) KeyValueBuffer;
00872     ReturnStatus = ZwQueryValueKey( LocaleKey,
00873                                     &amp;KeyValueName,
00874                                     KeyValuePartialInformation,
00875                                     KeyValueInformation,
00876                                     <span class="keyword">sizeof</span>( KeyValueBuffer ),
00877                                     &amp;ResultLength
00878                                   );
00879 
00880     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnStatus)) {
00881         ReturnStatus = ZwQueryValueKey( SortKey,
00882                                         &amp;KeyValueName,
00883                                         KeyValuePartialInformation,
00884                                         KeyValueInformation,
00885                                         <span class="keyword">sizeof</span>( KeyValueBuffer ),
00886                                         &amp;ResultLength
00887                                       );
00888         }
00889 
00890     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnStatus)) &amp;&amp;
00891         (KeyValueInformation-&gt;DataLength &gt; 2)
00892        ) {
00893 
00894         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, (PWSTR) KeyValueInformation-&gt;Data );
00895 
00896         ReturnStatus = ZwQueryValueKey( LangGroupKey,
00897                                         &amp;KeyValueName,
00898                                         KeyValuePartialInformation,
00899                                         KeyValueInformation,
00900                                         <span class="keyword">sizeof</span>( KeyValueBuffer ),
00901                                         &amp;ResultLength
00902                                       );
00903         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnStatus)) &amp;&amp;
00904             (KeyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
00905             (KeyValueInformation-&gt;DataLength &gt; 2)
00906            ) {
00907             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> = (PWSTR) KeyValueInformation-&gt;Data;
00908             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'1'</span> &amp;&amp; <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>[1] == UNICODE_NULL) {
00909                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00910                 }
00911             }
00912         }
00913 
00914     <span class="comment">//</span>
00915     <span class="comment">// Close opened keys</span>
00916     <span class="comment">//</span>
00917 
00918     ZwClose( LangGroupKey );
00919 
00920 Failed3:
00921     ZwClose( SortKey );
00922 
00923 Failed2:
00924     ZwClose( LocaleKey );
00925 
00926 Failed1:
00927 
00928     <span class="comment">//</span>
00929     <span class="comment">// If an error happens, let's record it.</span>
00930     <span class="comment">//</span>
00931     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnStatus)) {
00932         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ReturnStatus;
00933         }
00934 
00935     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00936 }
00937 
00938 
00939 
00940 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00941"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a49">00941</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a> (
00942     IN SYSTEM_INFORMATION_CLASS SystemInformationClass,
00943     OUT PVOID SystemInformation,
00944     IN ULONG SystemInformationLength,
00945     OUT PULONG ReturnLength OPTIONAL
00946     )
00947 
00948 <span class="comment">/*++</span>
00949 <span class="comment"></span>
00950 <span class="comment">Routine Description:</span>
00951 <span class="comment"></span>
00952 <span class="comment">    This function queries information about the system.</span>
00953 <span class="comment"></span>
00954 <span class="comment">Arguments:</span>
00955 <span class="comment"></span>
00956 <span class="comment">    SystemInformationClass - The system information class about which</span>
00957 <span class="comment">        to retrieve information.</span>
00958 <span class="comment"></span>
00959 <span class="comment">    SystemInformation - A pointer to a buffer which receives the specified</span>
00960 <span class="comment">        information.  The format and content of the buffer depend on the</span>
00961 <span class="comment">        specified system information class.</span>
00962 <span class="comment"></span>
00963 <span class="comment">        SystemInformation Format by Information Class:</span>
00964 <span class="comment"></span>
00965 <span class="comment">        SystemBasicInformation - Data type is SYSTEM_BASIC_INFORMATION</span>
00966 <span class="comment"></span>
00967 <span class="comment">            SYSTEM_BASIC_INFORMATION Structure</span>
00968 <span class="comment"></span>
00969 <span class="comment">                ULONG Reserved - Always zero.</span>
00970 <span class="comment"></span>
00971 <span class="comment">                ULONG TimerResolutionInMicroSeconds - The resolution of</span>
00972 <span class="comment">                    the hardware time.  All time values in NT are</span>
00973 <span class="comment">                    specified as 64-bit LARGE_INTEGER values in units of</span>
00974 <span class="comment">                    100 nanoseconds.  This field allows an application to</span>
00975 <span class="comment">                    understand how many of the low order bits of a system</span>
00976 <span class="comment">                    time value are insignificant.</span>
00977 <span class="comment"></span>
00978 <span class="comment">                ULONG PageSize - The physical page size for virtual memory</span>
00979 <span class="comment">                    objects.  Physical memory is committed in PageSize</span>
00980 <span class="comment">                    chunks.</span>
00981 <span class="comment"></span>
00982 <span class="comment">                ULONG AllocationGranularity - The logical page size for</span>
00983 <span class="comment">                    virtual memory objects.  Allocating 1 byte of virtual</span>
00984 <span class="comment">                    memory will actually allocate AllocationGranularity</span>
00985 <span class="comment">                    bytes of virtual memory.  Storing into that byte will</span>
00986 <span class="comment">                    commit the first physical page of the virtual memory.</span>
00987 <span class="comment"></span>
00988 <span class="comment">                ULONG MinimumUserModeAddress - The smallest valid user mode</span>
00989 <span class="comment">                    address.  The first AllocationGranularity bytes of</span>
00990 <span class="comment">                    the virtual address space are reserved.  This forces</span>
00991 <span class="comment">                    access violations for code the dereferences a zero</span>
00992 <span class="comment">                    pointer.</span>
00993 <span class="comment"></span>
00994 <span class="comment">                ULONG MaximumUserModeAddress -  The largest valid user mode</span>
00995 <span class="comment">                    address.  The next AllocationGranularity bytes of</span>
00996 <span class="comment">                    the virtual address space are reserved.  This allows</span>
00997 <span class="comment">                    system service routines to validate user mode pointer</span>
00998 <span class="comment">                    parameters quickly.</span>
00999 <span class="comment"></span>
01000 <span class="comment">                KAFFINITY ActiveProcessorsAffinityMask - The affinity mask</span>
01001 <span class="comment">                    for the current hardware configuration.</span>
01002 <span class="comment"></span>
01003 <span class="comment">                CCHAR NumberOfProcessors - The number of processors</span>
01004 <span class="comment">                    in the current hardware configuration.</span>
01005 <span class="comment"></span>
01006 <span class="comment">        SystemProcessorInformation - Data type is SYSTEM_PROCESSOR_INFORMATION</span>
01007 <span class="comment"></span>
01008 <span class="comment">            SYSTEM_PROCESSOR_INFORMATION Structure</span>
01009 <span class="comment"></span>
01010 <span class="comment">                USHORT ProcessorArchitecture - The processor architecture:</span>
01011 <span class="comment">                    PROCESSOR_ARCHITECTURE_INTEL</span>
01012 <span class="comment">                    PROCESSOR_ARCHITECTURE_MIPS</span>
01013 <span class="comment">                    PROCESSOR_ARCHITECTURE_ALPHA</span>
01014 <span class="comment">                    PROCESSOR_ARCHITECTURE_PPC</span>
01015 <span class="comment"></span>
01016 <span class="comment">                USHORT ProcessorLevel - architecture dependent processor level.</span>
01017 <span class="comment">                    This is the least common denominator for an MP system:</span>
01018 <span class="comment"></span>
01019 <span class="comment">                    For PROCESSOR_ARCHITECTURE_INTEL:</span>
01020 <span class="comment">                        3 - 386</span>
01021 <span class="comment">                        4 - 486</span>
01022 <span class="comment">                        5 - 586 or Pentium</span>
01023 <span class="comment"></span>
01024 <span class="comment">                    For PROCESSOR_ARCHITECTURE_MIPS:</span>
01025 <span class="comment">                        00xx - where xx is 8-bit implementation number (bits 8-15 of</span>
01026 <span class="comment">                            PRId register.</span>
01027 <span class="comment">                        0004 - R4000</span>
01028 <span class="comment"></span>
01029 <span class="comment">                    For PROCESSOR_ARCHITECTURE_ALPHA:</span>
01030 <span class="comment">                        xxxx - where xxxx is 16-bit processor version number (low</span>
01031 <span class="comment">                            order 16 bits of processor version number from firmware)</span>
01032 <span class="comment"></span>
01033 <span class="comment">                        21064 - 21064</span>
01034 <span class="comment">                        21066 - 21066</span>
01035 <span class="comment">                        21164 - 21164</span>
01036 <span class="comment"></span>
01037 <span class="comment">                    For PROCESSOR_ARCHITECTURE_PPC:</span>
01038 <span class="comment">                        xxxx - where xxxx is 16-bit processor version number (high</span>
01039 <span class="comment">                            order 16 bits of Processor Version Register).</span>
01040 <span class="comment">                        1 - 601</span>
01041 <span class="comment">                        3 - 603</span>
01042 <span class="comment">                        4 - 604</span>
01043 <span class="comment">                        6 - 603+</span>
01044 <span class="comment">                        9 - 604+</span>
01045 <span class="comment">                        20 - 620</span>
01046 <span class="comment"></span>
01047 <span class="comment">                USHORT ProcessorRevision - architecture dependent processor revision.</span>
01048 <span class="comment">                    This is the least common denominator for an MP system:</span>
01049 <span class="comment"></span>
01050 <span class="comment">                    For PROCESSOR_ARCHITECTURE_INTEL:</span>
01051 <span class="comment">                        For Old Intel 386 or 486:</span>
01052 <span class="comment">                            FFxx - where xx is displayed as a hexadecimal CPU stepping</span>
01053 <span class="comment">                            (e.g. FFD0 is D0 stepping)</span>
01054 <span class="comment"></span>
01055 <span class="comment">                        For Intel Pentium or Cyrix/NexGen 486</span>
01056 <span class="comment">                            xxyy - where xx is model number and yy is stepping, so</span>
01057 <span class="comment">                            0201 is Model 2, Stepping 1</span>
01058 <span class="comment"></span>
01059 <span class="comment">                    For PROCESSOR_ARCHITECTURE_MIPS:</span>
01060 <span class="comment">                        00xx is 8-bit revision number of processor (low order 8 bits</span>
01061 <span class="comment">                            of PRId Register</span>
01062 <span class="comment"></span>
01063 <span class="comment">                    For PROCESSOR_ARCHITECTURE_ALPHA:</span>
01064 <span class="comment">                        xxyy - where xxyy is 16-bit processor revision number (low</span>
01065 <span class="comment">                            order 16 bits of processor revision number from firmware).</span>
01066 <span class="comment">                            Displayed as Model 'A'+xx, Pass yy</span>
01067 <span class="comment"></span>
01068 <span class="comment">                    For PROCESSOR_ARCHITECTURE_PPC:</span>
01069 <span class="comment">                        xxyy - where xxyy is 16-bit processor revision number (low</span>
01070 <span class="comment">                            order 16 bits of Processor Version Register).  Displayed</span>
01071 <span class="comment">                            as a fixed point number xx.yy</span>
01072 <span class="comment"></span>
01073 <span class="comment">                USHORT Reserved - Always zero.</span>
01074 <span class="comment"></span>
01075 <span class="comment">                ULONG ProcessorFeatureBits - architecture dependent processor feature bits.</span>
01076 <span class="comment">                    This is the least common denominator for an MP system.</span>
01077 <span class="comment"></span>
01078 <span class="comment">        SystemPerformanceInformation - Data type is SYSTEM_PERFORMANCE_INFORMATION</span>
01079 <span class="comment"></span>
01080 <span class="comment">            SYSTEM_PERFORMANCE_INFORMATION Structure</span>
01081 <span class="comment"></span>
01082 <span class="comment">                LARGE_INTEGER IdleProcessTime - Returns the kernel time of the idle</span>
01083 <span class="comment">                    process.</span>
01084 <span class="comment">        BUGBUG complete comment.</span>
01085 <span class="comment">            LARGE_INTEGER IoReadTransferCount;</span>
01086 <span class="comment">            LARGE_INTEGER IoWriteTransferCount;</span>
01087 <span class="comment">            LARGE_INTEGER IoOtherTransferCount;</span>
01088 <span class="comment">            LARGE_INTEGER KernelTime;</span>
01089 <span class="comment">            LARGE_INTEGER UserTime;</span>
01090 <span class="comment">            ULONG IoReadOperationCount;</span>
01091 <span class="comment">            ULONG IoWriteOperationCount;</span>
01092 <span class="comment">            ULONG IoOtherOperationCount;</span>
01093 <span class="comment">            ULONG AvailablePages;</span>
01094 <span class="comment">            ULONG CommittedPages;</span>
01095 <span class="comment">            ULONG PageFaultCount;</span>
01096 <span class="comment">            ULONG CopyOnWriteCount;</span>
01097 <span class="comment">            ULONG TransitionCount;</span>
01098 <span class="comment">            ULONG CacheTransitionCount;</span>
01099 <span class="comment">            ULONG DemandZeroCount;</span>
01100 <span class="comment">            ULONG PageReadCount;</span>
01101 <span class="comment">            ULONG PageReadIoCount;</span>
01102 <span class="comment">            ULONG CacheReadCount;</span>
01103 <span class="comment">            ULONG CacheIoCount;</span>
01104 <span class="comment">            ULONG DirtyPagesWriteCount;</span>
01105 <span class="comment">            ULONG DirtyWriteIoCount;</span>
01106 <span class="comment">            ULONG MappedPagesWriteCount;</span>
01107 <span class="comment">            ULONG MappedWriteIoCount;</span>
01108 <span class="comment">            ULONG PagedPoolPages;</span>
01109 <span class="comment">            ULONG NonPagedPoolPages;</span>
01110 <span class="comment">            ULONG PagedPoolAllocs;</span>
01111 <span class="comment">            ULONG PagedPoolFrees;</span>
01112 <span class="comment">            ULONG NonPagedPoolAllocs;</span>
01113 <span class="comment">            ULONG NonPagedPoolFrees;</span>
01114 <span class="comment">            ULONG LpcThreadsWaitingInReceive;</span>
01115 <span class="comment">            ULONG LpcThreadsWaitingForReply;</span>
01116 <span class="comment"></span>
01117 <span class="comment">        SystemProcessInformation - Data type is SYSTEM_PROCESS_INFORMATION</span>
01118 <span class="comment"></span>
01119 <span class="comment">            SYSTEM_PROCESSOR_INFORMATION Structure</span>
01120 <span class="comment">                BUGBUG - add here when done.</span>
01121 <span class="comment"></span>
01122 <span class="comment">        SystemDockInformation - Data type is SYSTEM_DOCK_INFORMATION</span>
01123 <span class="comment"></span>
01124 <span class="comment">             SYSTEM_DOCK_INFORMATION Structure</span>
01125 <span class="comment"></span>
01126 <span class="comment">                 SYSTEM_DOCKED_STATE DockState - Ordinal specifying the current docking state. Possible values:</span>
01127 <span class="comment">                     SystemDockStateUnknown - The docking state of the system could not be determined.</span>
01128 <span class="comment">                     SystemUndocked - The system is undocked.</span>
01129 <span class="comment">                     SystemDocked - The system is docked.</span>
01130 <span class="comment"></span>
01131 <span class="comment">                 ULONG DockIdLength - Specifies the length in characters of the Dock ID string</span>
01132 <span class="comment">                                      (not including terminating NULL).</span>
01133 <span class="comment"></span>
01134 <span class="comment">                 ULONG SerialNumberOffset - Specifies the character offset of the Serial Number within</span>
01135 <span class="comment">                                            the DockId buffer.</span>
01136 <span class="comment"></span>
01137 <span class="comment">                 ULONG SerialNumberLength - Specifies the length in characters of the Serial Number</span>
01138 <span class="comment">                                            string (not including terminating NULL).</span>
01139 <span class="comment"></span>
01140 <span class="comment">                 WCHAR DockId - Character buffer containing two null-terminated strings.  The first</span>
01141 <span class="comment">                                string is a character representation of the dock ID number, starting</span>
01142 <span class="comment">                                at the beginning of the buffer.  The second string is a character</span>
01143 <span class="comment">                                representation of the machine's serial number, starting at character</span>
01144 <span class="comment">                                offset SerialNumberOffset in the buffer.</span>
01145 <span class="comment"></span>
01146 <span class="comment"></span>
01147 <span class="comment">        SystemPowerSettings - Data type is SYSTEM_POWER_SETTINGS</span>
01148 <span class="comment">            SYSTEM_POWER_INFORMATION Structure</span>
01149 <span class="comment">                BOOLEAN SystemSuspendSupported - Supplies a BOOLEAN as to</span>
01150 <span class="comment">                    whether the system suspend is enabled or not.</span>
01151 <span class="comment">                BOOLEAN SystemHibernateSupported - Supplies a BOOLEAN as to</span>
01152 <span class="comment">                    whether the system hibernate is enabled or not.</span>
01153 <span class="comment">                BOOLEAN ResumeTimerSupportsSuspend - Supplies a BOOLEAN as to</span>
01154 <span class="comment">                    whether the resuming from an external programmed timer</span>
01155 <span class="comment">                    from within a system suspend is enabled or not.</span>
01156 <span class="comment">                BOOLEAN ResumeTimerSupportsHibernate - Supplies a BOOLEAN as to</span>
01157 <span class="comment">                    whether or resuming from an external programmed timer</span>
01158 <span class="comment">                    from within a system hibernate is enabled or not.</span>
01159 <span class="comment">                BOOLEAN LidSupported - Supplies a BOOLEAN as to whether or not</span>
01160 <span class="comment">                    the suspending and resuming by Lid are enabled or not.</span>
01161 <span class="comment">                BOOLEAN TurboSettingSupported - Supplies a BOOLEAN as to whether</span>
01162 <span class="comment">                    or not the system supports a turbo mode setting.</span>
01163 <span class="comment">                BOOLEAN TurboMode - Supplies a BOOLEAN as to whether or not</span>
01164 <span class="comment">                    the system is in turbo mode.</span>
01165 <span class="comment">                BOOLEAN SystemAcOrDc - Supplies a BOOLEAN as to whether or not</span>
01166 <span class="comment">                    the system is in AC mode.</span>
01167 <span class="comment">                BOOLEAN DisablePowerDown - If TRUE, signifies that all requests to</span>
01168 <span class="comment">                    PoRequestPowerChange for a SET_POWER-PowerDown irp are to</span>
01169 <span class="comment">                    be ignored.</span>
01170 <span class="comment">                LARGE_INTEGER SpindownDrives - If non-zero, signifies to the</span>
01171 <span class="comment">                    cache manager (or the IO subsystem) to optimize drive</span>
01172 <span class="comment">                    accesses based upon power saves, are that drives are to</span>
01173 <span class="comment">                    be spun down as appropriate. The value represents to user's</span>
01174 <span class="comment">                    requested disk spin down timeout.</span>
01175 <span class="comment"></span>
01176 <span class="comment">        SystemProcessorSpeedInformation - Data type is SYSTEM_PROCESSOR_SPEED_INFORMATION</span>
01177 <span class="comment">            SYSTEM_PROCESSOR_SPEED_INFORMATION Structure (same as HalProcessorSpeedInformation)</span>
01178 <span class="comment">                ULONG MaximumProcessorSpeed - The maximum hertz the processor is</span>
01179 <span class="comment">                    capable of. This information is used by the UI to draw the</span>
01180 <span class="comment">                    appropriate scale. This field is read-only and cannot be</span>
01181 <span class="comment">                    set.</span>
01182 <span class="comment">                ULONG CurrentAvailableSpeed - The hertz for which the processor</span>
01183 <span class="comment">                    runs at when not idle. This field is read-only and cannot</span>
01184 <span class="comment">                    be set.</span>
01185 <span class="comment">                ULONG ConfiguredSpeedLimit - The hertz for which the processor</span>
01186 <span class="comment">                    is limited to due to the current configuration.</span>
01187 <span class="comment">                UCHAR PowerState</span>
01188 <span class="comment">                    0 - Normal</span>
01189 <span class="comment">                    1 - The processor speed is being limited due to available</span>
01190 <span class="comment">                    power restrictions. This field id read-only by the system.</span>
01191 <span class="comment">                UCHAR ThermalState</span>
01192 <span class="comment">                    0 - Normal</span>
01193 <span class="comment">                    1 - The processors speed is being limited due to thermal</span>
01194 <span class="comment">                    restrictions. This field is read-only by the system.</span>
01195 <span class="comment">                UCHAR TurboState</span>
01196 <span class="comment">                    0 - Normal</span>
01197 <span class="comment">                    1 - The processors speed is being limited by the fact that</span>
01198 <span class="comment">                    the system turbo mode is currently disabled which is</span>
01199 <span class="comment">                    requested to obtain more processor speed.</span>
01200 <span class="comment"></span>
01201 <span class="comment">    SystemInformationLength - Specifies the length in bytes of the system</span>
01202 <span class="comment">        information buffer.</span>
01203 <span class="comment"></span>
01204 <span class="comment">    ReturnLength - An optional pointer which, if specified, receives the</span>
01205 <span class="comment">        number of bytes placed in the system information buffer.</span>
01206 <span class="comment"></span>
01207 <span class="comment">Return Value:</span>
01208 <span class="comment"></span>
01209 <span class="comment">    Returns one of the following status codes:</span>
01210 <span class="comment"></span>
01211 <span class="comment">        STATUS_SUCCESS - normal, successful completion.</span>
01212 <span class="comment"></span>
01213 <span class="comment">        STATUS_INVALID_INFO_CLASS - The SystemInformationClass parameter</span>
01214 <span class="comment">            did not specify a valid value.</span>
01215 <span class="comment"></span>
01216 <span class="comment">        STATUS_INFO_LENGTH_MISMATCH - The value of the SystemInformationLength</span>
01217 <span class="comment">            parameter did not match the length required for the information</span>
01218 <span class="comment">            class requested by the SystemInformationClass parameter.</span>
01219 <span class="comment"></span>
01220 <span class="comment">        STATUS_ACCESS_VIOLATION - Either the SystemInformation buffer pointer</span>
01221 <span class="comment">            or the ReturnLength pointer value specified an invalid address.</span>
01222 <span class="comment"></span>
01223 <span class="comment">        STATUS_WORKING_SET_QUOTA - The process does not have sufficient</span>
01224 <span class="comment">            working set to lock the specified output structure in memory.</span>
01225 <span class="comment"></span>
01226 <span class="comment">        STATUS_INSUFFICIENT_RESOURCES - Insufficient system resources exist</span>
01227 <span class="comment">            for this request to complete.</span>
01228 <span class="comment"></span>
01229 <span class="comment">--*/</span>
01230 
01231 {
01232 
01233     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01234     PSYSTEM_BASIC_INFORMATION BasicInfo;
01235     PSYSTEM_PROCESSOR_INFORMATION ProcessorInfo;
01236     SYSTEM_TIMEOFDAY_INFORMATION LocalTimeOfDayInfo;
01237     SYSTEM_PERFORMANCE_INFORMATION LocalPerformanceInfo;
01238     PSYSTEM_PERFORMANCE_INFORMATION PerformanceInfo;
01239     PSYSTEM_PROCESSOR_PERFORMANCE_INFORMATION ProcessorPerformanceInfo;
01240     PSYSTEM_CALL_COUNT_INFORMATION CallCountInformation;
01241     PSYSTEM_DEVICE_INFORMATION DeviceInformation;
01242     <a class="code" href="../../d6/d8/struct__CONFIGURATION__INFORMATION.html">PCONFIGURATION_INFORMATION</a> ConfigInfo;
01243     PSYSTEM_EXCEPTION_INFORMATION ExceptionInformation;
01244     PSYSTEM_FILECACHE_INFORMATION FileCache;
01245     PSYSTEM_QUERY_TIME_ADJUST_INFORMATION TimeAdjustmentInformation;
01246     PSYSTEM_KERNEL_DEBUGGER_INFORMATION KernelDebuggerInformation;
01247     PSYSTEM_CONTEXT_SWITCH_INFORMATION ContextSwitchInformation;
01248     PSYSTEM_INTERRUPT_INFORMATION InterruptInformation;
01249     PSYSTEM_SESSION_PROCESS_INFORMATION SessionProcessInformation;
01250     PVOID ProcessInformation;
01251     ULONG ProcessInformationLength;
01252 
01253     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01254     BOOLEAN ReleaseModuleResoure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01255     PKPRCB Prcb;
01256     ULONG Length = 0;
01257     ULONG i;
01258     ULONG ContextSwitches;
01259     PULONG TableLimit, TableCounts;
01260     <a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html">PKSERVICE_TABLE_DESCRIPTOR</a> Table;
01261     ULONG SessionId;
01262 
01263     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01264 
01265     <span class="comment">//</span>
01266     <span class="comment">// Assume successful completion.</span>
01267     <span class="comment">//</span>
01268 
01269     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01270     <span class="keywordflow">try</span> {
01271 
01272         <span class="comment">//</span>
01273         <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
01274         <span class="comment">//</span>
01275 
01276         PreviousMode = KeGetPreviousMode();
01277         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01278             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(SystemInformation,
01279                           SystemInformationLength,
01280                           SystemInformationClass == SystemKernelDebuggerInformation ? <span class="keyword">sizeof</span>(BOOLEAN)
01281                                                                                     : <span class="keyword">sizeof</span>(ULONG));
01282 
01283             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
01284                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
01285             }
01286         }
01287 
01288         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
01289             *ReturnLength = 0;
01290         }
01291 
01292         <span class="keywordflow">switch</span> (SystemInformationClass) {
01293 
01294         <span class="keywordflow">case</span> SystemBasicInformation:
01295 
01296             <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( SYSTEM_BASIC_INFORMATION )) {
01297                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01298                 }
01299 
01300             BasicInfo = (PSYSTEM_BASIC_INFORMATION)SystemInformation;
01301             BasicInfo-&gt;NumberOfProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
01302             BasicInfo-&gt;ActiveProcessorsAffinityMask = (ULONG_PTR)<a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
01303             BasicInfo-&gt;Reserved = 0;
01304             BasicInfo-&gt;TimerResolution = <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>;
01305             BasicInfo-&gt;NumberOfPhysicalPages = <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>;
01306             BasicInfo-&gt;LowestPhysicalPageNumber = <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>;
01307             BasicInfo-&gt;HighestPhysicalPageNumber = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
01308             BasicInfo-&gt;PageSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01309             BasicInfo-&gt;AllocationGranularity = <a class="code" href="../../d2/d1/mm_8h.html#a1">MM_ALLOCATION_GRANULARITY</a>;
01310             BasicInfo-&gt;MinimumUserModeAddress = (ULONG_PTR)MM_LOWEST_USER_ADDRESS;
01311             BasicInfo-&gt;MaximumUserModeAddress = (ULONG_PTR)MM_HIGHEST_USER_ADDRESS;
01312 
01313             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01314                 *ReturnLength = <span class="keyword">sizeof</span>( SYSTEM_BASIC_INFORMATION );
01315                 }
01316             <span class="keywordflow">break</span>;
01317 
01318         <span class="keywordflow">case</span> SystemProcessorInformation:
01319             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_PROCESSOR_INFORMATION )) {
01320                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01321                 }
01322 
01323             ProcessorInfo = (PSYSTEM_PROCESSOR_INFORMATION)SystemInformation;
01324 
01325             ProcessorInfo-&gt;ProcessorArchitecture = <a class="code" href="../../d4/d9/ke_8h.html#a134">KeProcessorArchitecture</a>;
01326             ProcessorInfo-&gt;ProcessorLevel = <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a>;
01327             ProcessorInfo-&gt;ProcessorRevision = <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a>;
01328             ProcessorInfo-&gt;Reserved = 0;
01329             ProcessorInfo-&gt;ProcessorFeatureBits = <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a>;
01330 
01331             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01332                 *ReturnLength = <span class="keyword">sizeof</span>( SYSTEM_PROCESSOR_INFORMATION );
01333                 }
01334 
01335             <span class="keywordflow">break</span>;
01336 
01337         <span class="keywordflow">case</span> SystemPerformanceInformation:
01338             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_PERFORMANCE_INFORMATION )) {
01339                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01340                 }
01341 
01342             PerformanceInfo = (PSYSTEM_PERFORMANCE_INFORMATION)SystemInformation;
01343 
01344             <span class="comment">//</span>
01345             <span class="comment">// Io information.</span>
01346             <span class="comment">//</span>
01347 
01348             LocalPerformanceInfo.IoReadTransferCount = <a class="code" href="../../d0/d5/io_8h.html#a383">IoReadTransferCount</a>;
01349             LocalPerformanceInfo.IoWriteTransferCount = <a class="code" href="../../d0/d5/io_8h.html#a384">IoWriteTransferCount</a>;
01350             LocalPerformanceInfo.IoOtherTransferCount = <a class="code" href="../../d0/d5/io_8h.html#a385">IoOtherTransferCount</a>;
01351             LocalPerformanceInfo.IoReadOperationCount = <a class="code" href="../../d0/d5/io_8h.html#a380">IoReadOperationCount</a>;
01352             LocalPerformanceInfo.IoWriteOperationCount = <a class="code" href="../../d0/d5/io_8h.html#a381">IoWriteOperationCount</a>;
01353             LocalPerformanceInfo.IoOtherOperationCount = <a class="code" href="../../d0/d5/io_8h.html#a382">IoOtherOperationCount</a>;
01354 
01355             <span class="comment">//</span>
01356             <span class="comment">// Ke information.</span>
01357             <span class="comment">//</span>
01358             <span class="comment">// These counters are kept on a per processor basis and must</span>
01359             <span class="comment">// be totaled.</span>
01360             <span class="comment">//</span>
01361 
01362             {
01363                 ULONG FirstLevelTbFills = 0;
01364                 ULONG SecondLevelTbFills = 0;
01365                 ULONG SystemCalls = 0;
01366 <span class="comment">//                ULONG InterruptCount = 0;</span>
01367 
01368                 ContextSwitches = 0;
01369                 <span class="keywordflow">for</span> (i = 0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i += 1) {
01370                     Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[i];
01371                     <span class="keywordflow">if</span> (Prcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01372                         ContextSwitches += Prcb-&gt;KeContextSwitches;
01373                         FirstLevelTbFills += Prcb-&gt;KeFirstLevelTbFills;
01374 <span class="comment">//                        InterruptCount += Prcb-&gt;KeInterruptCount;</span>
01375                         SecondLevelTbFills += Prcb-&gt;KeSecondLevelTbFills;
01376                         SystemCalls += Prcb-&gt;KeSystemCalls;
01377                     }
01378                 }
01379 
01380                 LocalPerformanceInfo.ContextSwitches = ContextSwitches;
01381                 LocalPerformanceInfo.FirstLevelTbFills = FirstLevelTbFills;
01382 <span class="comment">//                LocalPerformanceInfo.InterruptCount = KeInterruptCount;</span>
01383                 LocalPerformanceInfo.SecondLevelTbFills = SecondLevelTbFills;
01384                 LocalPerformanceInfo.SystemCalls = SystemCalls;
01385             }
01386 
01387             <span class="comment">//</span>
01388             <span class="comment">// Mm information.</span>
01389             <span class="comment">//</span>
01390 
01391             LocalPerformanceInfo.AvailablePages = <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a>;
01392             LocalPerformanceInfo.CommittedPages = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
01393             LocalPerformanceInfo.CommitLimit = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
01394             LocalPerformanceInfo.PeakCommitment = <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a>;
01395             LocalPerformanceInfo.PageFaultCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o0">PageFaultCount</a>;
01396             LocalPerformanceInfo.CopyOnWriteCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o1">CopyOnWriteCount</a>;
01397             LocalPerformanceInfo.TransitionCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o2">TransitionCount</a>;
01398             LocalPerformanceInfo.CacheTransitionCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o3">CacheTransitionCount</a>;
01399             LocalPerformanceInfo.DemandZeroCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o4">DemandZeroCount</a>;
01400             LocalPerformanceInfo.PageReadCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o5">PageReadCount</a>;
01401             LocalPerformanceInfo.PageReadIoCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o6">PageReadIoCount</a>;
01402             LocalPerformanceInfo.CacheReadCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o7">CacheReadCount</a>;
01403             LocalPerformanceInfo.CacheIoCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o8">CacheIoCount</a>;
01404             LocalPerformanceInfo.DirtyPagesWriteCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o9">DirtyPagesWriteCount</a>;
01405             LocalPerformanceInfo.DirtyWriteIoCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o10">DirtyWriteIoCount</a>;
01406             LocalPerformanceInfo.MappedPagesWriteCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o11">MappedPagesWriteCount</a>;
01407             LocalPerformanceInfo.MappedWriteIoCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o12">MappedWriteIoCount</a>;
01408             LocalPerformanceInfo.FreeSystemPtes = <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[0];
01409 
01410             LocalPerformanceInfo.ResidentSystemCodePage = <a class="code" href="../../d6/d8/sysinfo_8c.html#a9">MmSystemCodePage</a>;
01411             LocalPerformanceInfo.ResidentSystemCachePage = <a class="code" href="../../d6/d8/sysinfo_8c.html#a10">MmSystemCachePage</a>;
01412             LocalPerformanceInfo.ResidentPagedPoolPage = <a class="code" href="../../d6/d8/sysinfo_8c.html#a11">MmPagedPoolPage</a>;
01413             LocalPerformanceInfo.ResidentSystemDriverPage = <a class="code" href="../../d6/d8/sysinfo_8c.html#a12">MmSystemDriverPage</a>;
01414             LocalPerformanceInfo.TotalSystemCodePages = <a class="code" href="../../d6/d8/sysinfo_8c.html#a13">MmTotalSystemCodePages</a>;
01415             LocalPerformanceInfo.TotalSystemDriverPages = <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a>;
01416 
01417             <span class="comment">//</span>
01418             <span class="comment">// Process information.</span>
01419             <span class="comment">//</span>
01420 
01421             LocalPerformanceInfo.IdleProcessTime.QuadPart =
01422                                     UInt32x32To64(<a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a>,
01423                                                   <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
01424 
01425             <span class="comment">//</span>
01426             <span class="comment">// Pool information.</span>
01427             <span class="comment">//</span>
01428 
01429             LocalPerformanceInfo.PagedPoolPages = 0;
01430             LocalPerformanceInfo.NonPagedPoolPages = 0;
01431             LocalPerformanceInfo.PagedPoolAllocs = 0;
01432             LocalPerformanceInfo.PagedPoolFrees = 0;
01433             LocalPerformanceInfo.PagedPoolLookasideHits = 0;
01434             LocalPerformanceInfo.NonPagedPoolAllocs = 0;
01435             LocalPerformanceInfo.NonPagedPoolFrees = 0;
01436             LocalPerformanceInfo.NonPagedPoolLookasideHits = 0;
01437             <a class="code" href="../../d5/d8/ex_8h.html#a229">ExQueryPoolUsage</a>( &amp;LocalPerformanceInfo.PagedPoolPages,
01438                               &amp;LocalPerformanceInfo.NonPagedPoolPages,
01439                               &amp;LocalPerformanceInfo.PagedPoolAllocs,
01440                               &amp;LocalPerformanceInfo.PagedPoolFrees,
01441                               &amp;LocalPerformanceInfo.PagedPoolLookasideHits,
01442                               &amp;LocalPerformanceInfo.NonPagedPoolAllocs,
01443                               &amp;LocalPerformanceInfo.NonPagedPoolFrees,
01444                               &amp;LocalPerformanceInfo.NonPagedPoolLookasideHits
01445                             );
01446 
01447             <span class="comment">//</span>
01448             <span class="comment">// Cache Manager information.</span>
01449             <span class="comment">//</span>
01450 
01451             LocalPerformanceInfo.CcFastReadNoWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a44">CcFastReadNoWait</a>;
01452             LocalPerformanceInfo.CcFastReadWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a45">CcFastReadWait</a>;
01453             LocalPerformanceInfo.CcFastReadResourceMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a46">CcFastReadResourceMiss</a>;
01454             LocalPerformanceInfo.CcFastReadNotPossible = <a class="code" href="../../d5/d2/cachedat_8c.html#a47">CcFastReadNotPossible</a>;
01455             LocalPerformanceInfo.CcFastMdlReadNoWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a48">CcFastMdlReadNoWait</a>;
01456             LocalPerformanceInfo.CcFastMdlReadWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a49">CcFastMdlReadWait</a>;
01457             LocalPerformanceInfo.CcFastMdlReadResourceMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a50">CcFastMdlReadResourceMiss</a>;
01458             LocalPerformanceInfo.CcFastMdlReadNotPossible = <a class="code" href="../../d5/d2/cachedat_8c.html#a51">CcFastMdlReadNotPossible</a>;
01459             LocalPerformanceInfo.CcMapDataNoWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a52">CcMapDataNoWait</a>;
01460             LocalPerformanceInfo.CcMapDataWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a53">CcMapDataWait</a>;
01461             LocalPerformanceInfo.CcMapDataNoWaitMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a54">CcMapDataNoWaitMiss</a>;
01462             LocalPerformanceInfo.CcMapDataWaitMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a55">CcMapDataWaitMiss</a>;
01463             LocalPerformanceInfo.CcPinMappedDataCount = <a class="code" href="../../d5/d2/cachedat_8c.html#a56">CcPinMappedDataCount</a>;
01464             LocalPerformanceInfo.CcPinReadNoWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a57">CcPinReadNoWait</a>;
01465             LocalPerformanceInfo.CcPinReadWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a58">CcPinReadWait</a>;
01466             LocalPerformanceInfo.CcPinReadNoWaitMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a59">CcPinReadNoWaitMiss</a>;
01467             LocalPerformanceInfo.CcPinReadWaitMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a60">CcPinReadWaitMiss</a>;
01468             LocalPerformanceInfo.CcCopyReadNoWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a61">CcCopyReadNoWait</a>;
01469             LocalPerformanceInfo.CcCopyReadWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a62">CcCopyReadWait</a>;
01470             LocalPerformanceInfo.CcCopyReadNoWaitMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a63">CcCopyReadNoWaitMiss</a>;
01471             LocalPerformanceInfo.CcCopyReadWaitMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a64">CcCopyReadWaitMiss</a>;
01472             LocalPerformanceInfo.CcMdlReadNoWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a65">CcMdlReadNoWait</a>;
01473             LocalPerformanceInfo.CcMdlReadWait = <a class="code" href="../../d5/d2/cachedat_8c.html#a66">CcMdlReadWait</a>;
01474             LocalPerformanceInfo.CcMdlReadNoWaitMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a67">CcMdlReadNoWaitMiss</a>;
01475             LocalPerformanceInfo.CcMdlReadWaitMiss = <a class="code" href="../../d5/d2/cachedat_8c.html#a68">CcMdlReadWaitMiss</a>;
01476             LocalPerformanceInfo.CcReadAheadIos = <a class="code" href="../../d5/d2/cachedat_8c.html#a69">CcReadAheadIos</a>;
01477             LocalPerformanceInfo.CcLazyWriteIos = <a class="code" href="../../d5/d2/cachedat_8c.html#a71">CcLazyWriteIos</a>;
01478             LocalPerformanceInfo.CcLazyWritePages = <a class="code" href="../../d5/d2/cachedat_8c.html#a72">CcLazyWritePages</a>;
01479             LocalPerformanceInfo.CcDataFlushes = <a class="code" href="../../d5/d2/cachedat_8c.html#a73">CcDataFlushes</a>;
01480             LocalPerformanceInfo.CcDataPages = <a class="code" href="../../d5/d2/cachedat_8c.html#a74">CcDataPages</a>;
01481 
01482 <span class="preprocessor">#if !defined(NT_UP)</span>
01483 <span class="preprocessor"></span>            <span class="comment">//</span>
01484             <span class="comment">// On an MP machines go sum up some other 'hot' cache manager</span>
01485             <span class="comment">// statistics.</span>
01486             <span class="comment">//</span>
01487 
01488             <span class="keywordflow">for</span> (i = 0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i++) {
01489                 Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[i];
01490 
01491                 LocalPerformanceInfo.CcFastReadNoWait += Prcb-&gt;CcFastReadNoWait;
01492                 LocalPerformanceInfo.CcFastReadWait += Prcb-&gt;CcFastReadWait;
01493                 LocalPerformanceInfo.CcFastReadNotPossible += Prcb-&gt;CcFastReadNotPossible;
01494                 LocalPerformanceInfo.CcCopyReadNoWait += Prcb-&gt;CcCopyReadNoWait;
01495                 LocalPerformanceInfo.CcCopyReadWait += Prcb-&gt;CcCopyReadWait;
01496                 LocalPerformanceInfo.CcCopyReadNoWaitMiss += Prcb-&gt;CcCopyReadNoWaitMiss;
01497             }
01498 <span class="preprocessor">#endif</span>
01499 <span class="preprocessor"></span>            *PerformanceInfo = LocalPerformanceInfo;
01500             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01501                 *ReturnLength = <span class="keyword">sizeof</span>(LocalPerformanceInfo);
01502                 }
01503 
01504             <span class="keywordflow">break</span>;
01505 
01506         <span class="keywordflow">case</span> SystemProcessorPerformanceInformation:
01507             <span class="keywordflow">if</span> (SystemInformationLength &lt;
01508                 <span class="keyword">sizeof</span>( SYSTEM_PROCESSOR_PERFORMANCE_INFORMATION )) {
01509                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01510                 }
01511 
01512             ProcessorPerformanceInfo =
01513                 (PSYSTEM_PROCESSOR_PERFORMANCE_INFORMATION) SystemInformation;
01514 
01515             Length = 0;
01516             <span class="keywordflow">for</span> (i = 0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i++) {
01517                 Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[i];
01518                 <span class="keywordflow">if</span> (Prcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01519                     <span class="keywordflow">if</span> (SystemInformationLength &lt; Length + <span class="keyword">sizeof</span>(SYSTEM_PROCESSOR_PERFORMANCE_INFORMATION))
01520                         <span class="keywordflow">break</span>;
01521 
01522                     Length += <span class="keyword">sizeof</span>(SYSTEM_PROCESSOR_PERFORMANCE_INFORMATION);
01523 
01524                     ProcessorPerformanceInfo-&gt;UserTime.QuadPart =
01525                                                 UInt32x32To64(Prcb-&gt;UserTime,
01526                                                               <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
01527 
01528                     ProcessorPerformanceInfo-&gt;KernelTime.QuadPart =
01529                                                 UInt32x32To64(Prcb-&gt;KernelTime,
01530                                                               <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
01531 
01532                     ProcessorPerformanceInfo-&gt;DpcTime.QuadPart =
01533                                                 UInt32x32To64(Prcb-&gt;DpcTime,
01534                                                               <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
01535 
01536                     ProcessorPerformanceInfo-&gt;InterruptTime.QuadPart =
01537                                                 UInt32x32To64(Prcb-&gt;InterruptTime,
01538                                                               <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
01539 
01540                     ProcessorPerformanceInfo-&gt;IdleTime.QuadPart =
01541                                                 UInt32x32To64(Prcb-&gt;IdleThread-&gt;KernelTime,
01542                                                               <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
01543 
01544                     ProcessorPerformanceInfo-&gt;InterruptCount = Prcb-&gt;InterruptCount;
01545 
01546                     ProcessorPerformanceInfo++;
01547                 }
01548             }
01549 
01550             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01551                 *ReturnLength = Length;
01552                 }
01553 
01554             <span class="keywordflow">break</span>;
01555 
01556         <span class="keywordflow">case</span> SystemTimeOfDayInformation:
01557             <span class="keywordflow">if</span> (SystemInformationLength &gt; <span class="keyword">sizeof</span> (SYSTEM_TIMEOFDAY_INFORMATION)) {
01558                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01559             }
01560 
01561             RtlZeroMemory (&amp;LocalTimeOfDayInfo, <span class="keyword">sizeof</span>(LocalTimeOfDayInfo));
01562             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;LocalTimeOfDayInfo.CurrentTime);
01563             LocalTimeOfDayInfo.BootTime = <a class="code" href="../../d4/d9/ke_8h.html#a124">KeBootTime</a>;
01564             LocalTimeOfDayInfo.TimeZoneBias = <a class="code" href="../../d5/d8/ex_8h.html#a158">ExpTimeZoneBias</a>;
01565             LocalTimeOfDayInfo.TimeZoneId = <a class="code" href="../../d5/d8/ex_8h.html#a161">ExpCurrentTimeZoneId</a>;
01566             LocalTimeOfDayInfo.BootTimeBias = <a class="code" href="../../d4/d9/ke_8h.html#a125">KeBootTimeBias</a>;
01567             LocalTimeOfDayInfo.SleepTimeBias = <a class="code" href="../../d4/d9/ke_8h.html#a126">KeInterruptTimeBias</a>;
01568 
01569             <span class="keywordflow">try</span> {
01570                 RtlCopyMemory (
01571                     SystemInformation,
01572                     &amp;LocalTimeOfDayInfo,
01573                     SystemInformationLength
01574                     );
01575 
01576                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
01577                     *ReturnLength = SystemInformationLength;
01578                 }
01579             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01580                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01581             }
01582 
01583             <span class="keywordflow">break</span>;
01584 
01585             <span class="comment">//</span>
01586             <span class="comment">// Query system time adjustment information.</span>
01587             <span class="comment">//</span>
01588 
01589         <span class="keywordflow">case</span> SystemTimeAdjustmentInformation:
01590             <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( SYSTEM_QUERY_TIME_ADJUST_INFORMATION )) {
01591                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01592             }
01593 
01594             TimeAdjustmentInformation =
01595                     (PSYSTEM_QUERY_TIME_ADJUST_INFORMATION)SystemInformation;
01596 
01597             TimeAdjustmentInformation-&gt;TimeAdjustment = <a class="code" href="../../d4/d9/ke_8h.html#a152">KeTimeAdjustment</a>;
01598             TimeAdjustmentInformation-&gt;TimeIncrement = <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>;
01599             TimeAdjustmentInformation-&gt;Enable = <a class="code" href="../../d4/d9/ke_8h.html#a154">KeTimeSynchronization</a>;
01600             <span class="keywordflow">break</span>;
01601 
01602         <span class="keywordflow">case</span> SystemSummaryMemoryInformation:
01603         <span class="keywordflow">case</span> SystemFullMemoryInformation:
01604 
01605             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_MEMORY_INFORMATION )) {
01606                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01607             }
01608 
01609             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/dmpaddr_8c.html#a0">MmMemoryUsage</a> (SystemInformation,
01610                                     SystemInformationLength,
01611              (SystemInformationClass == SystemFullMemoryInformation) ? 0 : 1,
01612                                     &amp;Length);
01613 
01614             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; ARGUMENT_PRESENT( ReturnLength )) {
01615                 *ReturnLength = Length;
01616             }
01617             <span class="keywordflow">break</span>;
01618 
01619         <span class="keywordflow">case</span> SystemPathInformation:
01620             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: SystemPathInformation now available via SharedUserData\n"</span> );
01621             DbgBreakPoint();
01622             <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
01623             <span class="keywordflow">break</span>;
01624 
01625         <span class="keywordflow">case</span> SystemProcessInformation:
01626             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_PROCESS_INFORMATION)) {
01627                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01628                 }
01629 
01630             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a32">ExpGetProcessInformation</a> (SystemInformation,
01631                                                SystemInformationLength,
01632                                                &amp;Length,
01633                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01634 
01635             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; ARGUMENT_PRESENT( ReturnLength )) {
01636                 *ReturnLength = Length;
01637             }
01638 
01639             <span class="keywordflow">break</span>;
01640 
01641         <span class="keywordflow">case</span> SystemSessionProcessInformation:
01642 
01643             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_SESSION_PROCESS_INFORMATION)) {
01644                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01645                 }
01646 
01647             SessionProcessInformation =
01648                         (PSYSTEM_SESSION_PROCESS_INFORMATION)SystemInformation;
01649 
01650             <span class="comment">//</span>
01651             <span class="comment">// The lower level locks the buffer specified below into memory using MmProbeAndLockPages.</span>
01652             <span class="comment">// We don't need to probe the buffers here.</span>
01653             <span class="comment">//</span>
01654             SessionId = SessionProcessInformation-&gt;SessionId;
01655             ProcessInformation = SessionProcessInformation-&gt;Buffer;
01656             ProcessInformationLength = SessionProcessInformation-&gt;SizeOfBuf;
01657 
01658             <span class="keywordflow">if</span> (ProcessInformationLength &lt; <span class="keyword">sizeof</span>(SYSTEM_PROCESS_INFORMATION)) {
01659                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01660             }
01661 
01662             <span class="keywordflow">if</span> (!POINTER_IS_ALIGNED (ProcessInformation, <span class="keyword">sizeof</span> (ULONG))) {
01663                 <span class="keywordflow">return</span> STATUS_DATATYPE_MISALIGNMENT;
01664             }
01665 
01666             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a32">ExpGetProcessInformation</a> (ProcessInformation,
01667                                                ProcessInformationLength,
01668                                                &amp;Length,
01669                                                &amp;SessionId);
01670 
01671             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; ARGUMENT_PRESENT( ReturnLength )) {
01672                 *ReturnLength = Length;
01673             }
01674 
01675             <span class="keywordflow">break</span>;
01676 
01677         <span class="keywordflow">case</span> SystemCallCountInformation:
01678 
01679             Length = <span class="keyword">sizeof</span>(SYSTEM_CALL_COUNT_INFORMATION) +
01680                         (<a class="code" href="../../d4/d9/ke_8h.html#a13">NUMBER_SERVICE_TABLES</a> * <span class="keyword">sizeof</span>(ULONG));
01681             <span class="keywordflow">for</span> ( i = 0, Table = <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>;
01682                   i &lt; <a class="code" href="../../d4/d9/ke_8h.html#a13">NUMBER_SERVICE_TABLES</a>;
01683                   i++, Table++ ) {
01684                 <span class="keywordflow">if</span> ( (Table-&gt;Limit != 0) &amp;&amp; (Table-&gt;Count != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01685                     Length += Table-&gt;Limit * <span class="keyword">sizeof</span>(ULONG);
01686                 }
01687             }
01688 
01689             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01690                 *ReturnLength = Length;
01691             }
01692 
01693             <span class="keywordflow">if</span> (SystemInformationLength &lt; Length) {
01694                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01695             }
01696 
01697             CallCountInformation = (PSYSTEM_CALL_COUNT_INFORMATION)SystemInformation;
01698             CallCountInformation-&gt;Length = Length;
01699             CallCountInformation-&gt;NumberOfTables = <a class="code" href="../../d4/d9/ke_8h.html#a13">NUMBER_SERVICE_TABLES</a>;
01700 
01701             TableLimit = (PULONG)(CallCountInformation + 1);
01702             TableCounts = TableLimit + <a class="code" href="../../d4/d9/ke_8h.html#a13">NUMBER_SERVICE_TABLES</a>;
01703             <span class="keywordflow">for</span> ( i = 0, Table = <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>;
01704                   i &lt; <a class="code" href="../../d4/d9/ke_8h.html#a13">NUMBER_SERVICE_TABLES</a>;
01705                   i++, Table++ ) {
01706                 <span class="keywordflow">if</span> ((Table-&gt;Limit == 0) || (Table-&gt;Count == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01707                     *TableLimit++ = 0;
01708                 } <span class="keywordflow">else</span> {
01709                     *TableLimit++ = Table-&gt;Limit;
01710                     RtlMoveMemory((PVOID)TableCounts,
01711                                   (PVOID)Table-&gt;Count,
01712                                   Table-&gt;Limit * <span class="keyword">sizeof</span>(ULONG));
01713                     TableCounts += Table-&gt;Limit;
01714                 }
01715             }
01716 
01717             <span class="keywordflow">break</span>;
01718 
01719         <span class="keywordflow">case</span> SystemDeviceInformation:
01720             <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( SYSTEM_DEVICE_INFORMATION )) {
01721                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01722                 }
01723 
01724             ConfigInfo = <a class="code" href="../../d4/d6/iosubs_8c.html#a69">IoGetConfigurationInformation</a>();
01725             DeviceInformation = (PSYSTEM_DEVICE_INFORMATION)SystemInformation;
01726             DeviceInformation-&gt;NumberOfDisks = ConfigInfo-&gt;<a class="code" href="../../d6/d8/struct__CONFIGURATION__INFORMATION.html#o0">DiskCount</a>;
01727             DeviceInformation-&gt;NumberOfFloppies = ConfigInfo-&gt;<a class="code" href="../../d6/d8/struct__CONFIGURATION__INFORMATION.html#o1">FloppyCount</a>;
01728             DeviceInformation-&gt;NumberOfCdRoms = ConfigInfo-&gt;<a class="code" href="../../d6/d8/struct__CONFIGURATION__INFORMATION.html#o2">CdRomCount</a>;
01729             DeviceInformation-&gt;NumberOfTapes = ConfigInfo-&gt;<a class="code" href="../../d6/d8/struct__CONFIGURATION__INFORMATION.html#o3">TapeCount</a>;
01730             DeviceInformation-&gt;NumberOfSerialPorts = ConfigInfo-&gt;<a class="code" href="../../d6/d8/struct__CONFIGURATION__INFORMATION.html#o5">SerialCount</a>;
01731             DeviceInformation-&gt;NumberOfParallelPorts = ConfigInfo-&gt;<a class="code" href="../../d6/d8/struct__CONFIGURATION__INFORMATION.html#o6">ParallelCount</a>;
01732 
01733             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01734                 *ReturnLength = <span class="keyword">sizeof</span>( SYSTEM_DEVICE_INFORMATION );
01735                 }
01736             <span class="keywordflow">break</span>;
01737 
01738         <span class="keywordflow">case</span> SystemFlagsInformation:
01739             <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( SYSTEM_FLAGS_INFORMATION )) {
01740                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01741                 }
01742 
01743             ((PSYSTEM_FLAGS_INFORMATION)SystemInformation)-&gt;Flags = <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a>;
01744 
01745             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01746                 *ReturnLength = <span class="keyword">sizeof</span>( SYSTEM_FLAGS_INFORMATION );
01747                 }
01748             <span class="keywordflow">break</span>;
01749 
01750         <span class="keywordflow">case</span> SystemCallTimeInformation:
01751             <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
01752 
01753         <span class="keywordflow">case</span> SystemModuleInformation:
01754             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01755             <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01756             ReleaseModuleResoure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01757             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a42">ExpQueryModuleInformation</a>( &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>,
01758                                                 &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a20">MmLoadedUserImageList</a>,
01759                                                 (PRTL_PROCESS_MODULES)SystemInformation,
01760                                                 SystemInformationLength,
01761                                                 ReturnLength
01762                                               );
01763             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
01764             ReleaseModuleResoure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01765             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01766             <span class="keywordflow">break</span>;
01767 
01768         <span class="keywordflow">case</span> SystemLocksInformation:
01769             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( RTL_PROCESS_LOCKS )) {
01770                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01771                 }
01772 
01773             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a35">ExpGetLockInformation</a> (SystemInformation,
01774                                             SystemInformationLength,
01775                                             &amp;Length);
01776 
01777             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01778                 *ReturnLength = Length;
01779                 }
01780 
01781             <span class="keywordflow">break</span>;
01782 
01783         <span class="keywordflow">case</span> SystemStackTraceInformation:
01784             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( RTL_PROCESS_BACKTRACES )) {
01785                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01786                 }
01787 
01788 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
01789 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ExpGetStackTraceInformation (SystemInformation,
01790                                                   SystemInformationLength,
01791                                                   &amp;Length);
01792 <span class="preprocessor">#else</span>
01793 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_IMPLEMENTED;
01794 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
01795 <span class="preprocessor"></span>
01796             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01797                 *ReturnLength = Length;
01798                 }
01799 
01800             <span class="keywordflow">break</span>;
01801 
01802         <span class="keywordflow">case</span> SystemPagedPoolInformation:
01803             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_POOL_INFORMATION )) {
01804                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01805                 }
01806 
01807             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a37">ExpGetPoolInformation</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01808                                             SystemInformation,
01809                                             SystemInformationLength,
01810                                             &amp;Length
01811                                           );
01812 
01813             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01814                 *ReturnLength = Length;
01815                 }
01816             <span class="keywordflow">break</span>;
01817 
01818         <span class="keywordflow">case</span> SystemNonPagedPoolInformation:
01819             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_POOL_INFORMATION )) {
01820                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01821                 }
01822 
01823             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a37">ExpGetPoolInformation</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01824                                             SystemInformation,
01825                                             SystemInformationLength,
01826                                             &amp;Length
01827                                           );
01828 
01829             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01830                 *ReturnLength = Length;
01831                 }
01832             <span class="keywordflow">break</span>;
01833 
01834         <span class="keywordflow">case</span> SystemHandleInformation:
01835             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_HANDLE_INFORMATION )) {
01836                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01837                 }
01838 
01839             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a38">ExpGetHandleInformation</a>( SystemInformation,
01840                                               SystemInformationLength,
01841                                               &amp;Length
01842                                             );
01843 
01844             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01845                 *ReturnLength = Length;
01846                 }
01847             <span class="keywordflow">break</span>;
01848 
01849         <span class="keywordflow">case</span> SystemObjectInformation:
01850             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_OBJECTTYPE_INFORMATION )) {
01851                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01852                 }
01853 
01854             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a39">ExpGetObjectInformation</a>( SystemInformation,
01855                                               SystemInformationLength,
01856                                               &amp;Length
01857                                             );
01858 
01859             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01860                 *ReturnLength = Length;
01861                 }
01862             <span class="keywordflow">break</span>;
01863 
01864         <span class="keywordflow">case</span> SystemPageFileInformation:
01865 
01866             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_PAGEFILE_INFORMATION )) {
01867                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01868                 }
01869 
01870             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/modwrite_8c.html#a55">MmGetPageFileInformation</a>( SystemInformation,
01871                                                SystemInformationLength,
01872                                                &amp;Length
01873                                               );
01874 
01875             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01876                 *ReturnLength = Length;
01877                 }
01878             <span class="keywordflow">break</span>;
01879 
01880 
01881         <span class="keywordflow">case</span> SystemFileCacheInformation:
01882 
01883             <span class="comment">//</span>
01884             <span class="comment">// This structure was extended in NT 4.0 from 12 bytes.</span>
01885             <span class="comment">// Use the previous size of 12 bytes for versioning info.</span>
01886             <span class="comment">//</span>
01887 
01888             <span class="keywordflow">if</span> (SystemInformationLength &lt; 12) {
01889                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01890             }
01891 
01892             FileCache = (PSYSTEM_FILECACHE_INFORMATION)SystemInformation;
01893             FileCache-&gt;CurrentSize = <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01894             FileCache-&gt;PeakSize = <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o3">PeakWorkingSetSize</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01895             FileCache-&gt;CurrentSizeIncludingTransitionInPages = <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> + <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a>;
01896             FileCache-&gt;PeakSizeIncludingTransitionInPages = <a class="code" href="../../d6/d8/sysinfo_8c.html#a23">MmTransitionSharedPagesPeak</a>;
01897             FileCache-&gt;PageFaultCount = <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
01898 
01899             i = 12;
01900             <span class="keywordflow">if</span> (SystemInformationLength &gt;= <span class="keyword">sizeof</span>( SYSTEM_FILECACHE_INFORMATION )) {
01901                 i = <span class="keyword">sizeof</span> (SYSTEM_FILECACHE_INFORMATION);
01902                 FileCache-&gt;MinimumWorkingSet =
01903                                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
01904                 FileCache-&gt;MaximumWorkingSet =
01905                                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>;
01906             }
01907 
01908             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01909                 *ReturnLength = i;
01910             }
01911             <span class="keywordflow">break</span>;
01912 
01913         <span class="keywordflow">case</span> SystemPoolTagInformation:
01914 
01915 <span class="preprocessor">#ifdef POOL_TAGGING</span>
01916 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_POOLTAG_INFORMATION )) {
01917                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01918             }
01919 
01920             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a41">ExpGetPoolTagInfo</a> (SystemInformation,
01921                                         SystemInformationLength,
01922                                         ReturnLength);
01923 <span class="preprocessor">#else</span>
01924 <span class="preprocessor"></span>            <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
01925 <span class="preprocessor">#endif //POOL_TAGGING</span>
01926 <span class="preprocessor"></span>
01927             <span class="keywordflow">break</span>;
01928 
01929         <span class="keywordflow">case</span> SystemVdmInstemulInformation:
01930 <span class="preprocessor">#ifdef i386</span>
01931 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_VDM_INSTEMUL_INFO )) {
01932                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01933             }
01934 
01935             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a40">ExpGetInstemulInformation</a>(
01936                                             (PSYSTEM_VDM_INSTEMUL_INFO)SystemInformation
01937                                             );
01938 
01939             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01940                 *ReturnLength = <span class="keyword">sizeof</span>(SYSTEM_VDM_INSTEMUL_INFO);
01941             }
01942 <span class="preprocessor">#else</span>
01943 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_IMPLEMENTED;
01944 <span class="preprocessor">#endif</span>
01945 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
01946 
01947         <span class="keywordflow">case</span> SystemCrashDumpInformation:
01948 
01949             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_CRASH_DUMP_INFORMATION)) {
01950                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01951             }
01952 
01953             <span class="comment">// Only allow callers that have create page file privilege</span>
01954             <span class="comment">// to access crash dump information</span>
01955             <span class="comment">//</span>
01956 
01957             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a88">SeCreatePagefilePrivilege</a>,PreviousMode)) {
01958                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01959             }
01960 
01961             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/modwrite_8c.html#a44">MmGetCrashDumpInformation</a> (
01962                            (PSYSTEM_CRASH_DUMP_INFORMATION)SystemInformation);
01963 
01964 
01965             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01966                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a46">IoGetCrashDumpInformation</a> (
01967                             (PSYSTEM_CRASH_DUMP_INFORMATION)SystemInformation);
01968             }
01969 
01970             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01971                 *ReturnLength = <span class="keyword">sizeof</span>(SYSTEM_CRASH_DUMP_INFORMATION);
01972             }
01973 
01974             <span class="keywordflow">break</span>;
01975 
01976             <span class="comment">//</span>
01977             <span class="comment">// Get system exception information which includes the number</span>
01978             <span class="comment">// of exceptions that have dispatched, the number of alignment</span>
01979             <span class="comment">// fixups, and the number of floating emulations that have been</span>
01980             <span class="comment">// performed.</span>
01981             <span class="comment">//</span>
01982 
01983         <span class="keywordflow">case</span> SystemExceptionInformation:
01984             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_EXCEPTION_INFORMATION)) {
01985                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01986             }
01987 
01988             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01989                 *ReturnLength = <span class="keyword">sizeof</span>(SYSTEM_EXCEPTION_INFORMATION);
01990             }
01991 
01992             ExceptionInformation = (PSYSTEM_EXCEPTION_INFORMATION)SystemInformation;
01993 
01994             <span class="comment">//</span>
01995             <span class="comment">// Ke information.</span>
01996             <span class="comment">//</span>
01997             <span class="comment">// These counters are kept on a per processor basis and must</span>
01998             <span class="comment">// be totaled.</span>
01999             <span class="comment">//</span>
02000 
02001             {
02002                 ULONG AlignmentFixupCount = 0;
02003                 ULONG ExceptionDispatchCount = 0;
02004                 ULONG FloatingEmulationCount = 0;
02005                 ULONG ByteWordEmulationCount = 0;
02006 
02007                 <span class="keywordflow">for</span> (i = 0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i += 1) {
02008                     Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[i];
02009                     <span class="keywordflow">if</span> (Prcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02010                         AlignmentFixupCount += Prcb-&gt;KeAlignmentFixupCount;
02011                         ExceptionDispatchCount += Prcb-&gt;KeExceptionDispatchCount;
02012                         FloatingEmulationCount += Prcb-&gt;KeFloatingEmulationCount;
02013 <span class="preprocessor">#if defined(_ALPHA_)</span>
02014 <span class="preprocessor"></span>                        AlignmentFixupCount +=
02015                             (ULONG)Prcb-&gt;Pcr-&gt;PalAlignmentFixupCount;
02016 
02017                         ByteWordEmulationCount += Prcb-&gt;KeByteWordEmulationCount;
02018 <span class="preprocessor">#endif // defined(_ALPHA_)</span>
02019 <span class="preprocessor"></span>                    }
02020                 }
02021 
02022                 ExceptionInformation-&gt;AlignmentFixupCount = AlignmentFixupCount;
02023                 ExceptionInformation-&gt;ExceptionDispatchCount = ExceptionDispatchCount;
02024                 ExceptionInformation-&gt;FloatingEmulationCount = FloatingEmulationCount;
02025                 ExceptionInformation-&gt;ByteWordEmulationCount = ByteWordEmulationCount;
02026             }
02027 
02028             <span class="keywordflow">break</span>;
02029 
02030         <span class="keywordflow">case</span> SystemCrashDumpStateInformation:
02031 
02032             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_CRASH_STATE_INFORMATION)) {
02033                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02034             }
02035 
02036             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/modwrite_8c.html#a45">MmGetCrashDumpStateInformation</a> (
02037                            (PSYSTEM_CRASH_STATE_INFORMATION)SystemInformation);
02038 
02039             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
02040                 <span class="keywordflow">if</span> (SystemInformationLength &gt;= <span class="keyword">sizeof</span> (SYSTEM_CRASH_STATE_INFORMATION) ) {
02041                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a47">IoGetCrashDumpStateInformation</a> (
02042                                    (PSYSTEM_CRASH_STATE_INFORMATION)SystemInformation);
02043                 }
02044             }
02045 
02046             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
02047                 *ReturnLength = <span class="keyword">sizeof</span>(SYSTEM_CRASH_STATE_INFORMATION);
02048             }
02049 
02050             <span class="keywordflow">break</span>;
02051 
02052         <span class="keywordflow">case</span> SystemKernelDebuggerInformation:
02053 
02054             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_KERNEL_DEBUGGER_INFORMATION)) {
02055                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02056             }
02057 
02058             KernelDebuggerInformation =
02059                 (PSYSTEM_KERNEL_DEBUGGER_INFORMATION)SystemInformation;
02060             KernelDebuggerInformation-&gt;KernelDebuggerEnabled = <a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a>;
02061             KernelDebuggerInformation-&gt;KernelDebuggerNotPresent = <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a>;
02062 
02063             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
02064                 *ReturnLength = <span class="keyword">sizeof</span>(SYSTEM_KERNEL_DEBUGGER_INFORMATION);
02065             }
02066 
02067             <span class="keywordflow">break</span>;
02068 
02069         <span class="keywordflow">case</span> SystemContextSwitchInformation:
02070 
02071             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_CONTEXT_SWITCH_INFORMATION)) {
02072                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02073             }
02074 
02075             ContextSwitchInformation =
02076                 (PSYSTEM_CONTEXT_SWITCH_INFORMATION)SystemInformation;
02077 
02078             <span class="comment">//</span>
02079             <span class="comment">// Compute the total number of context switches and fill in the</span>
02080             <span class="comment">// remainder of the context switch information.</span>
02081             <span class="comment">//</span>
02082 
02083             ContextSwitches = 0;
02084             <span class="keywordflow">for</span> (i = 0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i += 1) {
02085                 Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[i];
02086                 <span class="keywordflow">if</span> (Prcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02087                     ContextSwitches += Prcb-&gt;KeContextSwitches;
02088                 }
02089 
02090             }
02091 
02092             ContextSwitchInformation-&gt;ContextSwitches = ContextSwitches;
02093             ContextSwitchInformation-&gt;FindAny = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o0">FindAny</a>;
02094             ContextSwitchInformation-&gt;FindLast = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o2">FindLast</a>;
02095             ContextSwitchInformation-&gt;FindIdeal = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o1">FindIdeal</a>;
02096             ContextSwitchInformation-&gt;IdleAny = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o3">IdleAny</a>;
02097             ContextSwitchInformation-&gt;IdleCurrent = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o4">IdleCurrent</a>;
02098             ContextSwitchInformation-&gt;IdleLast = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o6">IdleLast</a>;
02099             ContextSwitchInformation-&gt;IdleIdeal = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o5">IdleIdeal</a>;
02100             ContextSwitchInformation-&gt;PreemptAny = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o7">PreemptAny</a>;
02101             ContextSwitchInformation-&gt;PreemptCurrent = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o8">PreemptCurrent</a>;
02102             ContextSwitchInformation-&gt;PreemptLast = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o9">PreemptLast</a>;
02103             ContextSwitchInformation-&gt;SwitchToIdle = <a class="code" href="../../d4/d9/ke_8h.html#a141">KeThreadSwitchCounters</a>.<a class="code" href="../../d2/d8/struct__KTHREAD__SWITCH__COUNTERS.html#o10">SwitchToIdle</a>;
02104 
02105             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
02106                 *ReturnLength = <span class="keyword">sizeof</span>(SYSTEM_CONTEXT_SWITCH_INFORMATION);
02107             }
02108 
02109             <span class="keywordflow">break</span>;
02110 
02111         <span class="keywordflow">case</span> SystemRegistryQuotaInformation:
02112 
02113             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_REGISTRY_QUOTA_INFORMATION)) {
02114                 <span class="keywordflow">return</span>(STATUS_INFO_LENGTH_MISMATCH);
02115             }
02116             <a class="code" href="../../d7/d9/cm_8h.html#a36">CmQueryRegistryQuotaInformation</a>((PSYSTEM_REGISTRY_QUOTA_INFORMATION)SystemInformation);
02117 
02118             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
02119                 *ReturnLength = <span class="keyword">sizeof</span>(SYSTEM_REGISTRY_QUOTA_INFORMATION);
02120             }
02121             <span class="keywordflow">break</span>;
02122 
02123         <span class="keywordflow">case</span> SystemDpcBehaviorInformation:
02124             {
02125                 PSYSTEM_DPC_BEHAVIOR_INFORMATION DpcInfo;
02126                 <span class="comment">//</span>
02127                 <span class="comment">// If the system information buffer is not the correct length,</span>
02128                 <span class="comment">// then return an error.</span>
02129                 <span class="comment">//</span>
02130                 <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>(SYSTEM_DPC_BEHAVIOR_INFORMATION)) {
02131                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02132                 }
02133 
02134                 DpcInfo = (PSYSTEM_DPC_BEHAVIOR_INFORMATION)SystemInformation;
02135 
02136                 <span class="comment">//</span>
02137                 <span class="comment">// Exception handler for this routine will return the correct</span>
02138                 <span class="comment">// error if any of these accesses fail.</span>
02139                 <span class="comment">//</span>
02140                 <span class="comment">//</span>
02141                 <span class="comment">// Return the current DPC behavior variables</span>
02142                 <span class="comment">//</span>
02143                 DpcInfo-&gt;DpcQueueDepth = <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
02144                 DpcInfo-&gt;MinimumDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
02145                 DpcInfo-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
02146                 DpcInfo-&gt;IdealDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a67">KiIdealDpcRate</a>;
02147             }
02148             <span class="keywordflow">break</span>;
02149 
02150         <span class="keywordflow">case</span> SystemInterruptInformation:
02151 
02152             <span class="keywordflow">if</span> (SystemInformationLength &lt; (<span class="keyword">sizeof</span>(SYSTEM_INTERRUPT_INFORMATION) * <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>)) {
02153                 <span class="keywordflow">return</span>(STATUS_INFO_LENGTH_MISMATCH);
02154             }
02155 
02156             InterruptInformation = (PSYSTEM_INTERRUPT_INFORMATION)SystemInformation;
02157             <span class="keywordflow">for</span> (i=0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i++) {
02158                 Prcb = <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[i];
02159                 InterruptInformation-&gt;ContextSwitches = Prcb-&gt;KeContextSwitches;
02160                 InterruptInformation-&gt;DpcCount = Prcb-&gt;DpcCount;
02161                 InterruptInformation-&gt;DpcRate = Prcb-&gt;DpcRequestRate;
02162                 InterruptInformation-&gt;TimeIncrement = <a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a>;
02163                 InterruptInformation-&gt;DpcBypassCount = Prcb-&gt;DpcBypassCount;
02164                 InterruptInformation-&gt;ApcBypassCount = Prcb-&gt;ApcBypassCount;
02165 
02166                 ++InterruptInformation;
02167             }
02168 
02169             <span class="keywordflow">break</span>;
02170 
02171         <span class="keywordflow">case</span> SystemCurrentTimeZoneInformation:
02172             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( RTL_TIME_ZONE_INFORMATION )) {
02173                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02174                 }
02175 
02176             RtlCopyMemory(SystemInformation,&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a15">ExpTimeZoneInformation</a>,<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a15">ExpTimeZoneInformation</a>));
02177             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
02178                 *ReturnLength = <span class="keyword">sizeof</span>( RTL_TIME_ZONE_INFORMATION );
02179                 }
02180 
02181             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02182             <span class="keywordflow">break</span>;
02183 
02184             <span class="comment">//</span>
02185             <span class="comment">// Query pool lookaside list and general lookaside list</span>
02186             <span class="comment">// information.</span>
02187             <span class="comment">//</span>
02188 
02189         <span class="keywordflow">case</span> SystemLookasideInformation:
02190             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a36">ExpGetLookasideInformation</a>(SystemInformation,
02191                                                 SystemInformationLength,
02192                                                 &amp;Length);
02193 
02194             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
02195                 *ReturnLength = Length;
02196             }
02197 
02198             <span class="keywordflow">break</span>;
02199 
02200         <span class="keywordflow">case</span> SystemRangeStartInformation:
02201 
02202             <span class="keywordflow">if</span> ( SystemInformationLength != <span class="keyword">sizeof</span>(ULONG_PTR) ) {
02203                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02204             }
02205 
02206             *(PULONG_PTR)SystemInformation = (ULONG_PTR)<a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a>;
02207 
02208             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
02209                 *ReturnLength = <span class="keyword">sizeof</span>(ULONG_PTR);
02210             }
02211 
02212             <span class="keywordflow">break</span>;
02213 
02214         <span class="keywordflow">case</span> SystemVerifierInformation:
02215 
02216             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_VERIFIER_INFORMATION )) {
02217                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02218                 }
02219 
02220             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/verifier_8c.html#a114">MmGetVerifierInformation</a>( SystemInformation,
02221                                                SystemInformationLength,
02222                                                &amp;Length
02223                                               );
02224 
02225             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
02226                 *ReturnLength = Length;
02227                 }
02228             <span class="keywordflow">break</span>;
02229 
02230         <span class="keywordflow">case</span> SystemLegacyDriverInformation:
02231             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>(SYSTEM_LEGACY_DRIVER_INFORMATION)) {
02232                 <span class="keywordflow">return</span>(STATUS_INFO_LENGTH_MISMATCH);
02233             }
02234             Length = SystemInformationLength;
02235             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a43">ExpQueryLegacyDriverInformation</a>((PSYSTEM_LEGACY_DRIVER_INFORMATION)SystemInformation, &amp;Length);
02236             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
02237                 *ReturnLength = Length;
02238             }
02239             <span class="keywordflow">break</span>;
02240 
02241         <span class="keywordflow">default</span>:
02242 
02243             <span class="comment">//</span>
02244             <span class="comment">// Invalid argument.</span>
02245             <span class="comment">//</span>
02246 
02247             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
02248         }
02249 
02250     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02251         <span class="keywordflow">if</span> (ReleaseModuleResoure) {
02252             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
02253             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02254         }
02255 
02256         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02257     }
02258 
02259     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02260 }
02261 
02262 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02263 NTAPI
<a name="l02264"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a50">02264</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a50">NtSetSystemInformation</a> (
02265     IN SYSTEM_INFORMATION_CLASS SystemInformationClass,
02266     IN PVOID SystemInformation,
02267     IN ULONG SystemInformationLength
02268     )
02269 
02270 <span class="comment">/*++</span>
02271 <span class="comment"></span>
02272 <span class="comment">Routine Description:</span>
02273 <span class="comment"></span>
02274 <span class="comment">    This function set information about the system.</span>
02275 <span class="comment"></span>
02276 <span class="comment">Arguments:</span>
02277 <span class="comment"></span>
02278 <span class="comment">    SystemInformationClass - The system information class which is to</span>
02279 <span class="comment">        be modified.</span>
02280 <span class="comment"></span>
02281 <span class="comment">    SystemInformation - A pointer to a buffer which contains the specified</span>
02282 <span class="comment">        information. The format and content of the buffer depend on the</span>
02283 <span class="comment">        specified system information class.</span>
02284 <span class="comment"></span>
02285 <span class="comment"></span>
02286 <span class="comment">    SystemInformationLength - Specifies the length in bytes of the system</span>
02287 <span class="comment">        information buffer.</span>
02288 <span class="comment"></span>
02289 <span class="comment">Return Value:</span>
02290 <span class="comment"></span>
02291 <span class="comment">    Returns one of the following status codes:</span>
02292 <span class="comment"></span>
02293 <span class="comment">        STATUS_SUCCESS - Normal, successful completion.</span>
02294 <span class="comment"></span>
02295 <span class="comment">        STATUS_ACCESS_VIOLATION - The specified system information buffer</span>
02296 <span class="comment">            is not accessible.</span>
02297 <span class="comment"></span>
02298 <span class="comment">        STATUS_INVALID_INFO_CLASS - The SystemInformationClass parameter</span>
02299 <span class="comment">            did not specify a valid value.</span>
02300 <span class="comment"></span>
02301 <span class="comment">        STATUS_INFO_LENGTH_MISMATCH - The value of the SystemInformationLength</span>
02302 <span class="comment">            parameter did not match the length required for the information</span>
02303 <span class="comment">            class requested by the SystemInformationClass parameter.</span>
02304 <span class="comment"></span>
02305 <span class="comment">        STATUS_PRIVILEGE_NOT_HELD is returned if the caller does not have the</span>
02306 <span class="comment">            privilege to set the system time.</span>
02307 <span class="comment"></span>
02308 <span class="comment">--*/</span>
02309 
02310 {
02311 
02312     BOOLEAN Enable;
02313     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02314     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02315     ULONG TimeAdjustment;
02316     PSYSTEM_SET_TIME_ADJUST_INFORMATION TimeAdjustmentInformation;
02317     HANDLE <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>;
02318     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02319 
02320     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02321 
02322     <span class="comment">//</span>
02323     <span class="comment">// Establish an exception handle in case the system information buffer</span>
02324     <span class="comment">// is not accessible.</span>
02325     <span class="comment">//</span>
02326 
02327     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02328 
02329     <span class="keywordflow">try</span> {
02330 
02331         <span class="comment">//</span>
02332         <span class="comment">// Get the previous processor mode and probe the input buffer for</span>
02333         <span class="comment">// read access if necessary.</span>
02334         <span class="comment">//</span>
02335 
02336         PreviousMode = KeGetPreviousMode();
02337         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02338             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((PVOID)SystemInformation,
02339                          SystemInformationLength,
02340                          <span class="keyword">sizeof</span>(ULONG));
02341         }
02342 
02343         <span class="comment">//</span>
02344         <span class="comment">// Dispatch on the system information class.</span>
02345         <span class="comment">//</span>
02346 
02347         <span class="keywordflow">switch</span> (SystemInformationClass) {
02348         <span class="keywordflow">case</span> SystemFlagsInformation:
02349             <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( SYSTEM_FLAGS_INFORMATION )) {
02350                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02351                 }
02352 
02353             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a97">SeDebugPrivilege</a>, PreviousMode )) {
02354                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
02355                 }
02356             <span class="keywordflow">else</span> {
02357                 <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> = ((PSYSTEM_FLAGS_INFORMATION)SystemInformation)-&gt;Flags &amp; FLG_KERNELMODE_VALID_BITS;
02358                 ((PSYSTEM_FLAGS_INFORMATION)SystemInformation)-&gt;Flags = <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a>;
02359                 }
02360             <span class="keywordflow">break</span>;
02361 
02362             <span class="comment">//</span>
02363             <span class="comment">// Set system time adjustment information.</span>
02364             <span class="comment">//</span>
02365             <span class="comment">// N.B. The caller must have the SeSystemTime privilege.</span>
02366             <span class="comment">//</span>
02367 
02368         <span class="keywordflow">case</span> SystemTimeAdjustmentInformation:
02369 
02370             <span class="comment">//</span>
02371             <span class="comment">// If the system information buffer is not the correct length,</span>
02372             <span class="comment">// then return an error.</span>
02373             <span class="comment">//</span>
02374 
02375             <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( SYSTEM_SET_TIME_ADJUST_INFORMATION )) {
02376                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02377             }
02378 
02379             <span class="comment">//</span>
02380             <span class="comment">// If the current thread does not have the privilege to set the</span>
02381             <span class="comment">// time adjustment variables, then return an error.</span>
02382             <span class="comment">//</span>
02383 
02384             <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
02385                 (<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a91">SeSystemtimePrivilege</a>, PreviousMode) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02386                 <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02387             }
02388 
02389             <span class="comment">//</span>
02390             <span class="comment">// Set system time adjustment parameters.</span>
02391             <span class="comment">//</span>
02392 
02393             TimeAdjustmentInformation =
02394                     (PSYSTEM_SET_TIME_ADJUST_INFORMATION)SystemInformation;
02395 
02396             Enable = TimeAdjustmentInformation-&gt;Enable;
02397             TimeAdjustment = TimeAdjustmentInformation-&gt;TimeAdjustment;
02398 
02399             <span class="keywordflow">if</span> (Enable == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02400                 <a class="code" href="../../d4/d9/ke_8h.html#a152">KeTimeAdjustment</a> = <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>;
02401             } <span class="keywordflow">else</span> {
02402                 <span class="keywordflow">if</span> (TimeAdjustment == 0) {
02403                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
02404                 }
02405                 <a class="code" href="../../d4/d9/ke_8h.html#a152">KeTimeAdjustment</a> = TimeAdjustment;
02406             }
02407 
02408             <a class="code" href="../../d4/d9/ke_8h.html#a154">KeTimeSynchronization</a> = Enable;
02409             <span class="keywordflow">break</span>;
02410 
02411             <span class="comment">//</span>
02412             <span class="comment">// Set an event to signal when the clock interrupt has been</span>
02413             <span class="comment">// masked for too long, causing the time to slip.</span>
02414             <span class="comment">// The event will be referenced to prevent it from being</span>
02415             <span class="comment">// deleted.  If the new event handle is valid or NULL, the</span>
02416             <span class="comment">// old event will be dereferenced and forgotten.  If the</span>
02417             <span class="comment">// event handle is non-NULL but invalid, the old event will</span>
02418             <span class="comment">// be remembered and a failure status will be returned.</span>
02419             <span class="comment">//</span>
02420             <span class="comment">// N.B. The caller must have the SeSystemTime privilege.</span>
02421             <span class="comment">//</span>
02422         <span class="keywordflow">case</span> SystemTimeSlipNotification:
02423 
02424             <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>(HANDLE)) {
02425                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02426             }
02427 
02428             <span class="comment">//</span>
02429             <span class="comment">// If the current thread does not have the privilege to set the</span>
02430             <span class="comment">// time adjustment variables, then return an error.</span>
02431             <span class="comment">//</span>
02432 
02433             <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
02434                 (<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a91">SeSystemtimePrivilege</a>, PreviousMode) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02435                 <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02436             }
02437 
02438             <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> = *(PHANDLE)SystemInformation;
02439 
02440             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02441 
02442                 <span class="comment">//</span>
02443                 <span class="comment">// Dereference the old event and don't signal anything</span>
02444                 <span class="comment">// for time slips.</span>
02445                 <span class="comment">//</span>
02446 
02447                 <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02448                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02449 
02450             } <span class="keywordflow">else</span> {
02451 
02452                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>,
02453                                                    EVENT_MODIFY_STATE,
02454                                                    <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
02455                                                    PreviousMode,
02456                                                    &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
02457                                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02458             }
02459 
02460             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02461                 <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a19">KdUpdateTimeSlipEvent</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
02462             }
02463 
02464             <span class="keywordflow">break</span>;
02465 
02466             <span class="comment">//</span>
02467             <span class="comment">// Set registry quota limit.</span>
02468             <span class="comment">//</span>
02469             <span class="comment">// N.B. The caller must have SeIncreaseQuotaPrivilege</span>
02470             <span class="comment">//</span>
02471         <span class="keywordflow">case</span> SystemRegistryQuotaInformation:
02472 
02473             <span class="comment">//</span>
02474             <span class="comment">// If the system information buffer is not the correct length,</span>
02475             <span class="comment">// then return an error.</span>
02476             <span class="comment">//</span>
02477 
02478             <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( SYSTEM_REGISTRY_QUOTA_INFORMATION )) {
02479                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02480             }
02481 
02482             <span class="comment">//</span>
02483             <span class="comment">// If the current thread does not have the privilege to create</span>
02484             <span class="comment">// a pagefile, then return an error.</span>
02485             <span class="comment">//</span>
02486 
02487             <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
02488                 (<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a82">SeIncreaseQuotaPrivilege</a>, PreviousMode) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02489                 <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02490             }
02491 
02492             <span class="comment">//</span>
02493             <span class="comment">// Set registry quota parameters.</span>
02494             <span class="comment">//</span>
02495             <a class="code" href="../../d7/d9/cm_8h.html#a37">CmSetRegistryQuotaInformation</a>((PSYSTEM_REGISTRY_QUOTA_INFORMATION)SystemInformation);
02496 
02497             <span class="keywordflow">break</span>;
02498 
02499         <span class="keywordflow">case</span> SystemPrioritySeperation:
02500             {
02501                 ULONG PrioritySeparation;
02502 
02503                 <span class="comment">//</span>
02504                 <span class="comment">// If the system information buffer is not the correct length,</span>
02505                 <span class="comment">// then return an error.</span>
02506                 <span class="comment">//</span>
02507 
02508                 <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( ULONG )) {
02509                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02510                     }
02511 
02512                 <span class="keywordflow">try</span> {
02513                     PrioritySeparation = *(PULONG)SystemInformation;
02514                     }
02515                 except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02516                     <span class="keywordflow">return</span> GetExceptionCode();
02517                     }
02518 
02519                 <a class="code" href="../../d0/d1/psinit_8c.html#a48">PsChangeQuantumTable</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,PrioritySeparation);
02520                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02521             }
02522             <span class="keywordflow">break</span>;
02523 
02524         <span class="keywordflow">case</span> SystemExtendServiceTableInformation:
02525             {
02526 
02527                 UNICODE_STRING Image;
02528                 PWSTR  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02529                 PVOID ImageBaseAddress;
02530                 ULONG_PTR EntryPoint;
02531                 PVOID SectionPointer;
02532                 PIMAGE_NT_HEADERS NtHeaders;
02533                 <a class="code" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a> InitRoutine;
02534                 <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> Win32KDevice;
02535 
02536                 <span class="comment">//</span>
02537                 <span class="comment">// If the system information buffer is not the correct length,</span>
02538                 <span class="comment">// then return an error.</span>
02539                 <span class="comment">//</span>
02540 
02541                 <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( UNICODE_STRING ) ) {
02542                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02543                 }
02544 
02545                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02546 
02547                     <span class="comment">//</span>
02548                     <span class="comment">// The caller's access mode is not kernel so check to ensure that</span>
02549                     <span class="comment">// the caller has the privilege to load a driver.</span>
02550                     <span class="comment">//</span>
02551 
02552                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a87">SeLoadDriverPrivilege</a>, PreviousMode )) {
02553                         <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02554                     }
02555 
02556                     <span class="keywordflow">try</span> {
02557                         UNICODE_STRING tImage;
02558                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> maxLength;
02559 
02560                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02561                         tImage = *(PUNICODE_STRING)SystemInformation;
02562 
02563                         <span class="comment">//</span>
02564                         <span class="comment">// Leave room for the NUL, if possible.</span>
02565                         <span class="comment">// Guard against overflow.</span>
02566                         <span class="comment">//</span>
02567                         maxLength = tImage.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
02568                         <span class="keywordflow">if</span> (maxLength &lt; tImage.Length || maxLength &gt; tImage.MaximumLength) {
02569                             maxLength = tImage.Length;
02570                         }
02571 
02572                         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(tImage.Buffer, maxLength, <span class="keyword">sizeof</span>(UCHAR));
02573 
02574                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, maxLength, 'ofnI');
02575                         <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> ) {
02576                             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02577                         }
02578 
02579                         RtlCopyMemory(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, tImage.Buffer, tImage.Length);
02580                         Image.Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02581                         Image.Length = tImage.Length;
02582                         Image.MaximumLength = maxLength;
02583                     }
02584                     except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02585                         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> ) {
02586                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
02587                         }
02588                         <span class="keywordflow">return</span> GetExceptionCode();
02589                     }
02590 
02591                     <span class="comment">//</span>
02592                     <span class="comment">// Call MmLoadSystemImage with previous mode of kernel.</span>
02593                     <span class="comment">//</span>
02594 
02595                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetSystemInformation(
02596                                 SystemExtendServiceTableInformation,
02597                                 (PVOID)&amp;Image,
02598                                 <span class="keyword">sizeof</span>(Image)
02599                                 );
02600 
02601                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
02602 
02603                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02604 
02605                 }
02606 
02607                 Image = *(PUNICODE_STRING)SystemInformation;
02608 
02609                 <span class="comment">//</span>
02610                 <span class="comment">// Now in kernelmode, so load the driver.</span>
02611                 <span class="comment">//</span>
02612 
02613                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a53">MmLoadSystemImage</a> (&amp;Image,
02614                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02615                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02616                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02617                                             &amp;SectionPointer,
02618                                             (PVOID *) &amp;ImageBaseAddress);
02619                 
02620                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02621                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02622                 }
02623 
02624                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( ImageBaseAddress );
02625                 EntryPoint = NtHeaders-&gt;OptionalHeader.AddressOfEntryPoint;
02626                 EntryPoint += (ULONG_PTR) ImageBaseAddress;
02627                 InitRoutine = (<a class="code" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a>) EntryPoint;
02628 
02629                 RtlZeroMemory (&amp;Win32KDevice, <span class="keyword">sizeof</span>(Win32KDevice));
02630                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == 0);
02631 
02632                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (InitRoutine)(&amp;Win32KDevice,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02633 
02634                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == 0);
02635 
02636                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02637                     <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> (SectionPointer);
02638                 }
02639                 <span class="keywordflow">else</span> {
02640 
02641                     <span class="comment">//</span>
02642                     <span class="comment">// Pass the driver object to memory management so the</span>
02643                     <span class="comment">// session can be unloaded cleanly.</span>
02644                     <span class="comment">//</span>
02645 
02646                     <a class="code" href="../../d3/d7/session_8c.html#a13">MmSessionSetUnloadAddress</a> (&amp;Win32KDevice);
02647                 }
02648             }
02649             <span class="keywordflow">break</span>;
02650 
02651 
02652         <span class="keywordflow">case</span> SystemUnloadGdiDriverInformation:
02653             {
02654 
02655                 <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( PVOID ) ) {
02656                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02657                     }
02658 
02659                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02660 
02661                     <span class="comment">//</span>
02662                     <span class="comment">// The caller's access mode is not kernel so fail.</span>
02663                     <span class="comment">// Only GDI from the kernel can call this.</span>
02664                     <span class="comment">//</span>
02665 
02666                     <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02667 
02668                     }
02669 
02670                 <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a>( *((PVOID *)SystemInformation) );
02671 
02672                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02673 
02674                 }
02675                 <span class="keywordflow">break</span>;
02676 
02677 
02678         <span class="keywordflow">case</span> SystemLoadGdiDriverInformation:
02679             {
02680 
02681                 UNICODE_STRING Image;
02682                 PVOID ImageBaseAddress;
02683                 ULONG_PTR EntryPoint;
02684                 PVOID SectionPointer;
02685 
02686                 PIMAGE_NT_HEADERS NtHeaders;
02687 
02688                 <span class="comment">//</span>
02689                 <span class="comment">// If the system information buffer is not the correct length,</span>
02690                 <span class="comment">// then return an error.</span>
02691                 <span class="comment">//</span>
02692 
02693                 <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>( SYSTEM_GDI_DRIVER_INFORMATION ) ) {
02694                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02695                 }
02696 
02697                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02698 
02699                     <span class="comment">//</span>
02700                     <span class="comment">// The caller's access mode is not kernel so fail.</span>
02701                     <span class="comment">// Only GDI from the kernel can call this.</span>
02702                     <span class="comment">//</span>
02703 
02704                     <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02705                 }
02706 
02707                 Image = ((PSYSTEM_GDI_DRIVER_INFORMATION)SystemInformation)-&gt;DriverName;
02708                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a53">MmLoadSystemImage</a> (&amp;Image,
02709                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02710                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02711                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02712                                             &amp;SectionPointer,
02713                                             (PVOID *) &amp;ImageBaseAddress);
02714 
02715                 <span class="comment">//</span>
02716                 <span class="comment">// Some drivers (like dxapi.sys) may be already loaded by a</span>
02717                 <span class="comment">// minidriver that links to it - allow these to re-succeed.</span>
02718                 <span class="comment">//</span>
02719 
02720                 <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) ||
02721                     (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_IMAGE_ALREADY_LOADED)) {
02722 
02723                     PSYSTEM_GDI_DRIVER_INFORMATION GdiDriverInfo =
02724                         (PSYSTEM_GDI_DRIVER_INFORMATION) SystemInformation;
02725 
02726                     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02727                     PVOID BaseAddress;
02728 
02729                     GdiDriverInfo-&gt;ExportSectionPointer =
02730                         <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(ImageBaseAddress,
02731                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02732                                                      IMAGE_DIRECTORY_ENTRY_EXPORT,
02733                                                      &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02734 
02735                     <span class="comment">//</span>
02736                     <span class="comment">// Capture the entry point.</span>
02737                     <span class="comment">//</span>
02738 
02739                     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( ImageBaseAddress );
02740                     EntryPoint = NtHeaders-&gt;OptionalHeader.AddressOfEntryPoint;
02741                     EntryPoint += (ULONG_PTR) ImageBaseAddress;
02742 
02743                     GdiDriverInfo-&gt;ImageAddress = (PVOID) ImageBaseAddress;
02744                     GdiDriverInfo-&gt;SectionPointer = SectionPointer;
02745                     GdiDriverInfo-&gt;EntryPoint = (PVOID) EntryPoint;
02746 
02747                     <span class="comment">//</span>
02748                     <span class="comment">// GDI drivers are always completely pagable.</span>
02749                     <span class="comment">//</span>
02750 
02751                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02752                         BaseAddress = <a class="code" href="../../d8/d8/sysload_8c.html#a56">MmPageEntireDriver</a>((PVOID)ImageBaseAddress);
02753                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BaseAddress == ImageBaseAddress);
02754                     }
02755                 }
02756             }
02757             <span class="keywordflow">break</span>;
02758 
02759         <span class="keywordflow">case</span> SystemFileCacheInformation:
02760 
02761             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_FILECACHE_INFORMATION )) {
02762                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02763             }
02764 
02765             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a82">SeIncreaseQuotaPrivilege</a>, PreviousMode )) {
02766                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
02767             }
02768 
02769             <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/wslist_8c.html#a31">MmAdjustWorkingSetSize</a> (
02770                         ((PSYSTEM_FILECACHE_INFORMATION)SystemInformation)-&gt;MinimumWorkingSet,
02771                         ((PSYSTEM_FILECACHE_INFORMATION)SystemInformation)-&gt;MaximumWorkingSet,
02772                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02773 
02774             <span class="keywordflow">break</span>;
02775 
02776         <span class="keywordflow">case</span> SystemDpcBehaviorInformation:
02777             {
02778                 SYSTEM_DPC_BEHAVIOR_INFORMATION DpcInfo;
02779                 <span class="comment">//</span>
02780                 <span class="comment">// If the system information buffer is not the correct length,</span>
02781                 <span class="comment">// then return an error.</span>
02782                 <span class="comment">//</span>
02783                 <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>(SYSTEM_DPC_BEHAVIOR_INFORMATION)) {
02784                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02785                 }
02786 
02787                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02788                     <span class="comment">//</span>
02789                     <span class="comment">// The caller's access mode is not kernel so check to ensure that</span>
02790                     <span class="comment">// the caller has the privilege to load a driver.</span>
02791                     <span class="comment">//</span>
02792 
02793                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a87">SeLoadDriverPrivilege</a>, PreviousMode )) {
02794                         <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02795                     }
02796                 }
02797 
02798                 <span class="comment">//</span>
02799                 <span class="comment">// Exception handler for this routine will return the correct</span>
02800                 <span class="comment">// error if this access fails.</span>
02801                 <span class="comment">//</span>
02802                 DpcInfo = *(PSYSTEM_DPC_BEHAVIOR_INFORMATION)SystemInformation;
02803 
02804                 <span class="comment">//</span>
02805                 <span class="comment">// Set the new DPC behavior variables</span>
02806                 <span class="comment">//</span>
02807                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a> = DpcInfo.DpcQueueDepth;
02808                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a> = DpcInfo.MinimumDpcRate;
02809                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a> = DpcInfo.AdjustDpcThreshold;
02810                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a67">KiIdealDpcRate</a> = DpcInfo.IdealDpcRate;
02811             }
02812             <span class="keywordflow">break</span>;
02813 
02814         <span class="keywordflow">case</span> SystemSessionCreate:
02815             {
02816 
02817                 <span class="comment">//</span>
02818                 <span class="comment">// Creation of a session space.</span>
02819                 <span class="comment">//</span>
02820 
02821                 ULONG SessionId;
02822 
02823                 <span class="comment">//</span>
02824                 <span class="comment">// If the system information buffer is not the correct length,</span>
02825                 <span class="comment">// then return an error.</span>
02826                 <span class="comment">//</span>
02827 
02828                 <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>(ULONG)) {
02829                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02830                 }
02831 
02832                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02833 
02834                     <span class="comment">//</span>
02835                     <span class="comment">// The caller's access mode is not kernel so check to</span>
02836                     <span class="comment">// ensure that the caller has the privilege to load</span>
02837                     <span class="comment">// a driver.</span>
02838                     <span class="comment">//</span>
02839 
02840                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a> (<a class="code" href="../../d0/d5/se_8h.html#a87">SeLoadDriverPrivilege</a>, PreviousMode)) {
02841                         <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02842                     }
02843 
02844                     <span class="keywordflow">try</span> {
02845                         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)SystemInformation);
02846                     }
02847                     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02848                         <span class="keywordflow">return</span> GetExceptionCode();
02849                     }
02850                 }
02851 
02852                 <span class="comment">//</span>
02853                 <span class="comment">// Create a session space in the current process.</span>
02854                 <span class="comment">//</span>
02855 
02856                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a14">MmSessionCreate</a> (&amp;SessionId);
02857 
02858                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02859                     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02860                         <span class="keywordflow">try</span> {
02861                             *(PULONG)SystemInformation = SessionId;
02862                         }
02863                         except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02864                             <span class="keywordflow">return</span> GetExceptionCode();
02865                         }
02866                     }
02867                     <span class="keywordflow">else</span> {
02868                         *(PULONG)SystemInformation = SessionId;
02869                     }
02870                 }
02871 
02872                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02873             }
02874             <span class="keywordflow">break</span>;
02875 
02876         <span class="keywordflow">case</span> SystemSessionDetach:
02877             {
02878                 ULONG SessionId;
02879 
02880                 <span class="comment">//</span>
02881                 <span class="comment">// If the system information buffer is not the correct length,</span>
02882                 <span class="comment">// then return an error.</span>
02883                 <span class="comment">//</span>
02884 
02885                 <span class="keywordflow">if</span> (SystemInformationLength != <span class="keyword">sizeof</span>(ULONG)) {
02886                     <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02887                 }
02888 
02889                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02890 
02891                     <span class="comment">//</span>
02892                     <span class="comment">// The caller's access mode is not kernel so check to</span>
02893                     <span class="comment">// ensure that the caller has the privilege to load</span>
02894                     <span class="comment">// a driver.</span>
02895                     <span class="comment">//</span>
02896 
02897                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a87">SeLoadDriverPrivilege</a>, PreviousMode )) {
02898                         <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02899                     }
02900 
02901                     <span class="keywordflow">try</span> {
02902                         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a> ((PVOID)SystemInformation,
02903                                       <span class="keyword">sizeof</span>(ULONG),
02904                                       <span class="keyword">sizeof</span>(ULONG));
02905 
02906                         SessionId = *(PULONG)SystemInformation;
02907                     }
02908                     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02909                         <span class="keywordflow">return</span> GetExceptionCode();
02910                     }
02911                 }
02912                 <span class="keywordflow">else</span> {
02913                     SessionId = *(PULONG)SystemInformation;
02914                 }
02915 
02916                 <span class="comment">//</span>
02917                 <span class="comment">// Detach the current process from a session space</span>
02918                 <span class="comment">// if it has one.</span>
02919                 <span class="comment">//</span>
02920 
02921                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a15">MmSessionDelete</a> (SessionId);
02922 
02923                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02924             }
02925             <span class="keywordflow">break</span>;
02926 
02927         <span class="keywordflow">case</span> SystemCrashDumpStateInformation:
02928 
02929 
02930             <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span>( SYSTEM_CRASH_STATE_INFORMATION)) {
02931                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02932             }
02933 
02934             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a88">SeCreatePagefilePrivilege</a>, PreviousMode )) {
02935                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
02936             }
02937 
02938             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a25">IoSetCrashDumpState</a>( (SYSTEM_CRASH_STATE_INFORMATION *)SystemInformation);
02939 
02940             <span class="keywordflow">break</span>;
02941 
02942         <span class="keywordflow">case</span> SystemPerformanceTraceInformation:
02943 <span class="preprocessor">#ifdef NTPERF</span>
02944 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = PerformanceTraceInformation(SystemInformationClass,
02945                                                  SystemInformation,
02946                                                  SystemInformationLength
02947                                                  );
02948 <span class="preprocessor">#else</span>
02949 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_INFO_CLASS;
02950 <span class="preprocessor">#endif</span>
02951 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
02952             
02953         <span class="keywordflow">case</span> SystemVerifierThunkExtend:
02954 
02955             <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02956 
02957                 <span class="comment">//</span>
02958                 <span class="comment">// The caller's access mode is not kernel so fail.</span>
02959                 <span class="comment">// Only device drivers can call this.</span>
02960                 <span class="comment">//</span>
02961 
02962                 <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02963             }
02964 
02965             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/verifier_8c.html#a113">MmAddVerifierThunks</a> (SystemInformation,
02966                                           SystemInformationLength);
02967 
02968             <span class="keywordflow">break</span>;
02969 
02970         <span class="keywordflow">case</span> SystemVerifierInformation:
02971 
02972             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a> (<a class="code" href="../../d0/d5/se_8h.html#a97">SeDebugPrivilege</a>, PreviousMode)) {
02973                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
02974             }
02975 
02976             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/verifier_8c.html#a115">MmSetVerifierInformation</a> (SystemInformation,
02977                                                SystemInformationLength);
02978 
02979             <span class="keywordflow">break</span>;
02980 
02981         <span class="keywordflow">default</span>:
02982             <span class="comment">//KeBugCheckEx(SystemInformationClass,KdPitchDebugger,0,0,0);</span>
02983             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_INFO_CLASS;
02984             <span class="keywordflow">break</span>;
02985         }
02986 
02987     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02988         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02989     }
02990 
02991     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02992 }
02993 
02994 PVOID
<a name="l02995"></a><a class="code" href="../../d5/d8/ex_8h.html#a256">02995</a> <a class="code" href="../../d5/d8/ex_8h.html#a256">ExLockUserBuffer</a>(
02996     IN PVOID Buffer,
02997     IN ULONG Length,
02998     OUT PVOID *LockVariable
02999     )
03000 
03001 {
03002     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
03003     PVOID Address;
03004     SIZE_T MdlSize;
03005 
03006     <span class="comment">//</span>
03007     <span class="comment">// Allocate an MDL to map the request.</span>
03008     <span class="comment">//</span>
03009 
03010     MdlSize = <a class="code" href="../../d5/d6/iosup_8c.html#a72">MmSizeOfMdl</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, Length );
03011     Mdl = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
03012                                       MdlSize,
03013                                       'ofnI');
03014     <span class="keywordflow">if</span> (Mdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03015         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03016     }
03017 
03018     <span class="comment">//</span>
03019     <span class="comment">// Initialize MDL for request.</span>
03020     <span class="comment">//</span>
03021 
03022     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(Mdl, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, Length);
03023 
03024     <span class="keywordflow">try</span> {
03025 
03026         <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (Mdl, KeGetPreviousMode(), <a class="code" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>);
03027 
03028     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03029 
03030         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Mdl);
03031 
03032         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03033     }
03034 
03035     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a25">MDL_MAPPING_CAN_FAIL</a>;
03036     Address =  <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a> (Mdl);
03037     *LockVariable = Mdl;
03038     <span class="keywordflow">if</span> (Address == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03039         <a class="code" href="../../d5/d8/ex_8h.html#a257">ExUnlockUserBuffer</a> (Mdl);
03040         *LockVariable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03041     }
03042 
03043     <span class="keywordflow">return</span> Address;
03044 }
03045 
03046 
03047 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03048"></a><a class="code" href="../../d5/d8/ex_8h.html#a257">03048</a> <a class="code" href="../../d5/d8/ex_8h.html#a257">ExUnlockUserBuffer</a>(
03049     IN PVOID LockVariable
03050     )
03051 
03052 {
03053     <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> ((<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)LockVariable);
03054     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)LockVariable);
03055     <span class="keywordflow">return</span>;
03056 }
03057 
<a name="l03058"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a25">03058</a> <span class="keyword">extern</span> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>;
03059 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03060"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a32">03060</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a32">ExpGetProcessInformation</a> (
03061     OUT PVOID SystemInformation,
03062     IN ULONG SystemInformationLength,
03063     OUT PULONG Length,
03064     IN PULONG SessionId OPTIONAL
03065     )
03066 <span class="comment">/*++</span>
03067 <span class="comment"></span>
03068 <span class="comment">Routine Description:</span>
03069 <span class="comment"></span>
03070 <span class="comment">    This function returns information about all the processes and</span>
03071 <span class="comment">    threads in the system.</span>
03072 <span class="comment"></span>
03073 <span class="comment">Arguments:</span>
03074 <span class="comment"></span>
03075 <span class="comment">    SystemInformation - A pointer to a buffer which receives the specified</span>
03076 <span class="comment">        information.</span>
03077 <span class="comment"></span>
03078 <span class="comment">    SystemInformationLength - Specifies the length in bytes of the system</span>
03079 <span class="comment">        information buffer.</span>
03080 <span class="comment"></span>
03081 <span class="comment">    Length - An optional pointer which, if specified, receives the</span>
03082 <span class="comment">        number of bytes placed in the system information buffer.</span>
03083 <span class="comment"></span>
03084 <span class="comment"></span>
03085 <span class="comment">Return Value:</span>
03086 <span class="comment"></span>
03087 <span class="comment">    Returns one of the following status codes:</span>
03088 <span class="comment"></span>
03089 <span class="comment">        STATUS_SUCCESS - normal, successful completion.</span>
03090 <span class="comment"></span>
03091 <span class="comment">        STATUS_INVALID_INFO_CLASS - The SystemInformationClass parameter</span>
03092 <span class="comment">            did not specify a valid value.</span>
03093 <span class="comment"></span>
03094 <span class="comment">        STATUS_INFO_LENGTH_MISMATCH - The value of the SystemInformationLength</span>
03095 <span class="comment">            parameter did not match the length required for the information</span>
03096 <span class="comment">            class requested by the SystemInformationClass parameter.</span>
03097 <span class="comment"></span>
03098 <span class="comment">        STATUS_ACCESS_VIOLATION - Either the SystemInformation buffer pointer</span>
03099 <span class="comment">            or the Length pointer value specified an invalid address.</span>
03100 <span class="comment"></span>
03101 <span class="comment">        STATUS_WORKING_SET_QUOTA - The process does not have sufficient</span>
03102 <span class="comment">            working set to lock the specified output structure in memory.</span>
03103 <span class="comment"></span>
03104 <span class="comment">        STATUS_INSUFFICIENT_RESOURCES - Insufficient system resources exist</span>
03105 <span class="comment">            for this request to complete.</span>
03106 <span class="comment"></span>
03107 <span class="comment">--*/</span>
03108 
03109 {
03110     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
03111     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
03112     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
03113     PSYSTEM_PROCESS_INFORMATION ProcessInfo;
03114     PSYSTEM_THREAD_INFORMATION ThreadInfo;
03115     PLIST_ENTRY NextProcess;
03116     PLIST_ENTRY NextThread;
03117     PVOID MappedAddress;
03118     PVOID LockVariable;
03119     ULONG TotalSize = 0;
03120     ULONG NextEntryOffset = 0;
03121     PUCHAR Src;
03122     PWSTR Dst;
03123     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
03124     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
03125 
03126     *Length = 0;
03127 
03128     MappedAddress = <a class="code" href="../../d5/d8/ex_8h.html#a256">ExLockUserBuffer</a>( SystemInformation,
03129                                       SystemInformationLength,
03130                                       &amp;LockVariable
03131                                     );
03132     <span class="keywordflow">if</span> (MappedAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03133         <span class="keywordflow">return</span>( STATUS_ACCESS_VIOLATION );
03134     }
03135     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03136     ExAcquireFastMutex(&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>);
03137 
03138     
03139     <span class="comment">//</span>
03140     <span class="comment">// Initialize an event object and then set the event with the wait</span>
03141     <span class="comment">// parameter TRUE. This causes the event to be set and control is</span>
03142     <span class="comment">// returned with the dispatcher database locked at dispatch IRQL.</span>
03143     <span class="comment">//</span>
03144 
03145     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03146     <span class="keywordflow">try</span> {
03147       
03148 
03149         ProcessInfo = (PSYSTEM_PROCESS_INFORMATION)MappedAddress;
03150    
03151 
03152         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(SessionId)) {
03153    
03154            NextEntryOffset = <span class="keyword">sizeof</span>(SYSTEM_PROCESS_INFORMATION);
03155 
03156            TotalSize = <span class="keyword">sizeof</span>(SYSTEM_PROCESS_INFORMATION);
03157    
03158            <a class="code" href="../../d6/d8/sysinfo_8c.html#a33">ExpCopyProcessInfo</a> (ProcessInfo, <a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a>);
03159    
03160            <span class="comment">//</span>
03161            <span class="comment">// Since Idle process and system process share the same</span>
03162            <span class="comment">// object table, zero out idle processes handle count to</span>
03163            <span class="comment">// reduce confusion</span>
03164            <span class="comment">//</span>
03165    
03166            ProcessInfo-&gt;HandleCount = 0;
03167    
03168            <span class="comment">// Idle Process always has SessionId 0</span>
03169            ProcessInfo-&gt;SessionId = 0;
03170            <span class="comment">//</span>
03171            <span class="comment">// Set the event with the wait</span>
03172            <span class="comment">// parameter TRUE. This causes the event to be set and control is</span>
03173            <span class="comment">// returned with the dispatcher database locked at dispatch IRQL.</span>
03174            <span class="comment">//</span>
03175            <span class="comment">// WARNING - The following code assumes that the process structure</span>
03176            <span class="comment">//      uses kernel objects to synchronize access to the thread and</span>
03177            <span class="comment">//      process lists.</span>
03178            <span class="comment">//</span>
03179    
03180            <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03181    
03182            <span class="comment">//</span>
03183            <span class="comment">// WARNING - The following code runs with the kernel dispatch database</span>
03184            <span class="comment">//      locked. EXTREME caution should be taken when modifying this</span>
03185            <span class="comment">//      code. Extended execution will ADVERSELY affect system operation</span>
03186            <span class="comment">//      and integrity.</span>
03187            <span class="comment">//</span>
03188            <span class="comment">// Get info for idle process's threads</span>
03189            <span class="comment">//</span>
03190            <span class="comment">//</span>
03191            <span class="comment">// Get information for each thread.</span>
03192            <span class="comment">//</span>
03193    
03194            ThreadInfo = (PSYSTEM_THREAD_INFORMATION)(ProcessInfo + 1);
03195            ProcessInfo-&gt;NumberOfThreads = 0;
03196            NextThread = <a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>.Flink;
03197            <span class="keywordflow">while</span> (NextThread != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>) {
03198                NextEntryOffset += <span class="keyword">sizeof</span>(SYSTEM_THREAD_INFORMATION);
03199                TotalSize += <span class="keyword">sizeof</span>(SYSTEM_THREAD_INFORMATION);
03200    
03201                <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
03202                    status = STATUS_INFO_LENGTH_MISMATCH;
03203                    <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03204                    <span class="keywordflow">goto</span> Failed;
03205                }
03206                Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(NextThread,
03207                                                      <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>,
03208                                                      ThreadListEntry));
03209                <a class="code" href="../../d6/d8/sysinfo_8c.html#a34">ExpCopyThreadInfo</a> (ThreadInfo,Thread);
03210    
03211                ProcessInfo-&gt;NumberOfThreads += 1;
03212                NextThread = NextThread-&gt;Flink;
03213                ThreadInfo += 1;
03214            }
03215            
03216            <span class="comment">//</span>
03217            <span class="comment">// Unlock the dispatch database by waiting on the event that was</span>
03218            <span class="comment">// previously set with the wait parameter TRUE.</span>
03219            <span class="comment">//</span>
03220    
03221            <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03222 
03223            ProcessInfo-&gt;ImageName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03224            ProcessInfo-&gt;ImageName.Length = 0;
03225            ProcessInfo-&gt;NextEntryOffset = NextEntryOffset;
03226         }
03227 
03228         NextProcess = <a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>.Flink;
03229 
03230         <span class="keywordflow">while</span> (NextProcess != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>) {
03231             Process = CONTAINING_RECORD(NextProcess,
03232                                         <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
03233                                         ActiveProcessLinks);
03234 
03235             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SessionId) &amp;&amp; (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o60">SessionId</a> != *SessionId)) {
03236                NextProcess = NextProcess-&gt;Flink;
03237                <span class="keywordflow">continue</span>;
03238             }
03239 
03240             ProcessInfo = (PSYSTEM_PROCESS_INFORMATION)
03241                             ((PUCHAR)MappedAddress + TotalSize);
03242 
03243             NextEntryOffset = <span class="keyword">sizeof</span>(SYSTEM_PROCESS_INFORMATION);
03244             TotalSize += <span class="keyword">sizeof</span>(SYSTEM_PROCESS_INFORMATION);
03245             <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
03246                 status = STATUS_INFO_LENGTH_MISMATCH;
03247                 <span class="keywordflow">goto</span> Failed;
03248             }
03249 
03250             <span class="comment">//</span>
03251             <span class="comment">// Get information for each process.</span>
03252             <span class="comment">//</span>
03253 
03254             <a class="code" href="../../d6/d8/sysinfo_8c.html#a33">ExpCopyProcessInfo</a> (ProcessInfo, Process);
03255 
03256 
03257             <span class="comment">//</span>
03258             <span class="comment">// Set the event with the wait</span>
03259             <span class="comment">// parameter TRUE. This causes the event to be set and control is</span>
03260             <span class="comment">// returned with the dispatcher database locked at dispatch IRQL.</span>
03261             <span class="comment">//</span>
03262             <span class="comment">// WARNING - The following code assumes that the process structure</span>
03263             <span class="comment">//      uses kernel objects to synchronize access to the thread and</span>
03264             <span class="comment">//      process lists.</span>
03265             <span class="comment">//</span>
03266    
03267             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03268    
03269             <span class="comment">//</span>
03270             <span class="comment">// WARNING - The following code runs with the kernel dispatch database</span>
03271             <span class="comment">//      locked. EXTREME caution should be taken when modifying this</span>
03272             <span class="comment">//      code. Extended execution will ADVERSELY affect system operation</span>
03273             <span class="comment">//      and integrity.</span>
03274             <span class="comment">//</span>
03275    
03276             <span class="comment">//</span>
03277             <span class="comment">// Get information for each thread.</span>
03278             <span class="comment">//</span>
03279    
03280             ThreadInfo = (PSYSTEM_THREAD_INFORMATION)(ProcessInfo + 1);
03281             ProcessInfo-&gt;NumberOfThreads = 0;
03282             NextThread = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>.Flink;
03283             <span class="keywordflow">while</span> (NextThread != &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>) {
03284                 NextEntryOffset += <span class="keyword">sizeof</span>(SYSTEM_THREAD_INFORMATION);
03285                 TotalSize += <span class="keyword">sizeof</span>(SYSTEM_THREAD_INFORMATION);
03286    
03287                 <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
03288                     status = STATUS_INFO_LENGTH_MISMATCH;
03289                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03290                     <span class="keywordflow">goto</span> Failed;
03291                 }
03292                 Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(NextThread,
03293                                                       <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>,
03294                                                       ThreadListEntry));
03295                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a34">ExpCopyThreadInfo</a> (ThreadInfo,Thread);
03296    
03297                 ProcessInfo-&gt;NumberOfThreads += 1;
03298                 NextThread = NextThread-&gt;Flink;
03299                 ThreadInfo += 1;
03300             }
03301    
03302             <span class="comment">//</span>
03303             <span class="comment">// Store the Remote Terminal SessionId</span>
03304             <span class="comment">//</span>
03305             ProcessInfo-&gt;SessionId = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o60">SessionId</a>;
03306 
03307    
03308             <span class="comment">//</span>
03309             <span class="comment">// Unlock the dispatch database by waiting on the event that was</span>
03310             <span class="comment">// previously set with the wait parameter TRUE.</span>
03311             <span class="comment">//</span>
03312    
03313             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03314             <span class="comment">//</span>
03315             <span class="comment">// Get the image name.</span>
03316             <span class="comment">//</span>
03317 
03318             ProcessInfo-&gt;ImageName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03319             ProcessInfo-&gt;ImageName.Length = 0;
03320             ProcessInfo-&gt;ImageName.MaximumLength = 0;
03321 
03322             <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>( Src = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o65">ImageFileName</a> ))) {
03323                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>( ((<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> + 1) * <span class="keyword">sizeof</span>( WCHAR )), <span class="keyword">sizeof</span>(LARGE_INTEGER) );
03324                 TotalSize += <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
03325                 NextEntryOffset += <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
03326                 <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
03327                     status = STATUS_INFO_LENGTH_MISMATCH;
03328                 } <span class="keywordflow">else</span> {
03329                     Dst = (PWSTR)(ThreadInfo);
03330                     <span class="keywordflow">while</span> (*Dst++ = (WCHAR)*Src++) {
03331                         ;
03332                         }
03333                     ProcessInfo-&gt;ImageName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PCHAR)Dst - (PCHAR)ThreadInfo - <span class="keyword">sizeof</span>( UNICODE_NULL ));
03334                     ProcessInfo-&gt;ImageName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
03335 
03336                     <span class="comment">//</span>
03337                     <span class="comment">// Set the image name to point into the user's memory.</span>
03338                     <span class="comment">//</span>
03339 
03340                     ProcessInfo-&gt;ImageName.Buffer = (PWSTR)
03341                                 ((PCHAR)SystemInformation +
03342                                  ((PCHAR)(ThreadInfo) - (PCHAR)MappedAddress));
03343                 }
03344 
03345                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03346                     <span class="keywordflow">goto</span> Failed;
03347                 }
03348             }
03349 
03350             <span class="comment">//</span>
03351             <span class="comment">// Point to next process.</span>
03352             <span class="comment">//</span>
03353 
03354             ProcessInfo-&gt;NextEntryOffset = NextEntryOffset;
03355             NextProcess = NextProcess-&gt;Flink;
03356         }
03357 
03358         ProcessInfo-&gt;NextEntryOffset = 0;
03359         status = STATUS_SUCCESS;
03360         *Length = TotalSize;
03361 
03362 Failed:
03363         ;
03364 
03365     } finally {
03366         ExReleaseFastMutex(&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>);
03367         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03368         <a class="code" href="../../d5/d8/ex_8h.html#a257">ExUnlockUserBuffer</a>( LockVariable );
03369     }
03370 
03371     <span class="keywordflow">return</span>(status);
03372 }
03373 
03374 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03375"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a33">03375</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a33">ExpCopyProcessInfo</a> (
03376     IN PSYSTEM_PROCESS_INFORMATION ProcessInfo,
03377     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03378     )
03379 
03380 {
03381     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> Ht;
03382 
03383     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03384 
03385     Ht = (<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>)Process-&gt;ObjectTable;
03386     <span class="keywordflow">if</span> ( Ht ) {
03387         ProcessInfo-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o1">HandleCount</a> = Ht-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o1">HandleCount</a>;
03388         }
03389     <span class="keywordflow">else</span> {
03390         ProcessInfo-&gt;HandleCount = 0;
03391         }
03392     ProcessInfo-&gt;CreateTime = Process-&gt;CreateTime;
03393     ProcessInfo-&gt;UserTime.QuadPart = UInt32x32To64(Process-&gt;Pcb.UserTime,
03394                                                    <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
03395 
03396     ProcessInfo-&gt;KernelTime.QuadPart = UInt32x32To64(Process-&gt;Pcb.KernelTime,
03397                                                      <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
03398 
03399     ProcessInfo-&gt;BasePriority = Process-&gt;Pcb.BasePriority;
03400     ProcessInfo-&gt;UniqueProcessId = Process-&gt;UniqueProcessId;
03401     ProcessInfo-&gt;InheritedFromUniqueProcessId = Process-&gt;InheritedFromUniqueProcessId;
03402     ProcessInfo-&gt;PeakVirtualSize = Process-&gt;PeakVirtualSize;
03403     ProcessInfo-&gt;VirtualSize = Process-&gt;VirtualSize;
03404     ProcessInfo-&gt;PageFaultCount = Process-&gt;Vm.PageFaultCount;
03405     ProcessInfo-&gt;PeakWorkingSetSize = Process-&gt;Vm.PeakWorkingSetSize &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03406     ProcessInfo-&gt;WorkingSetSize = Process-&gt;Vm.WorkingSetSize &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03407     ProcessInfo-&gt;QuotaPeakPagedPoolUsage =
03408                             Process-&gt;QuotaPeakPoolUsage[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
03409     ProcessInfo-&gt;QuotaPagedPoolUsage = Process-&gt;QuotaPoolUsage[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
03410     ProcessInfo-&gt;QuotaPeakNonPagedPoolUsage =
03411                             Process-&gt;QuotaPeakPoolUsage[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
03412     ProcessInfo-&gt;QuotaNonPagedPoolUsage =
03413                             Process-&gt;QuotaPoolUsage[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
03414     ProcessInfo-&gt;PagefileUsage = Process-&gt;PagefileUsage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03415     ProcessInfo-&gt;PeakPagefileUsage = Process-&gt;PeakPagefileUsage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03416     ProcessInfo-&gt;PrivatePageCount = Process-&gt;CommitCharge &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03417 
03418     ProcessInfo-&gt;ReadOperationCount = Process-&gt;ReadOperationCount;
03419     ProcessInfo-&gt;WriteOperationCount = Process-&gt;WriteOperationCount;
03420     ProcessInfo-&gt;OtherOperationCount = Process-&gt;OtherOperationCount;
03421     ProcessInfo-&gt;ReadTransferCount = Process-&gt;ReadTransferCount;
03422     ProcessInfo-&gt;WriteTransferCount = Process-&gt;WriteTransferCount;
03423     ProcessInfo-&gt;OtherTransferCount = Process-&gt;OtherTransferCount;
03424 }
03425 
03426 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03427"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a34">03427</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a34">ExpCopyThreadInfo</a> (
03428     IN PSYSTEM_THREAD_INFORMATION ThreadInfo,
03429     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread
03430     )
03431 
03432 {
03433 
03434     ThreadInfo-&gt;KernelTime.QuadPart = UInt32x32To64(Thread-&gt;Tcb.KernelTime,
03435                                                     <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
03436 
03437     ThreadInfo-&gt;UserTime.QuadPart = UInt32x32To64(Thread-&gt;Tcb.UserTime,
03438                                                   <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
03439 
03440     ThreadInfo-&gt;CreateTime.QuadPart = <a class="code" href="../../d1/d9/ps_8h.html#a15">PS_GET_THREAD_CREATE_TIME</a> (Thread);
03441     ThreadInfo-&gt;WaitTime = Thread-&gt;Tcb.WaitTime;
03442     ThreadInfo-&gt;ClientId = Thread-&gt;Cid;
03443     ThreadInfo-&gt;ThreadState = Thread-&gt;Tcb.State;
03444     ThreadInfo-&gt;WaitReason = Thread-&gt;Tcb.WaitReason;
03445     ThreadInfo-&gt;Priority = Thread-&gt;Tcb.Priority;
03446     ThreadInfo-&gt;BasePriority = Thread-&gt;Tcb.BasePriority;
03447     ThreadInfo-&gt;ContextSwitches = Thread-&gt;Tcb.ContextSwitches;
03448     ThreadInfo-&gt;StartAddress = Thread-&gt;StartAddress;
03449 }
03450 
03451 <span class="preprocessor">#ifdef i386</span>
03452 <span class="preprocessor"></span><span class="keyword">extern</span> ULONG ExVdmOpcodeDispatchCounts[256];
03453 <span class="keyword">extern</span> ULONG VdmBopCount;
03454 <span class="keyword">extern</span> ULONG ExVdmSegmentNotPresent;
03455 
03456 <span class="preprocessor">#if defined(ALLOC_PRAGMA)</span>
03457 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpGetInstemulInformation)</span>
03458 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03459 <span class="preprocessor"></span>
03460 
03461 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03462 <a class="code" href="../../d6/d8/sysinfo_8c.html#a40">ExpGetInstemulInformation</a>(
03463     OUT PSYSTEM_VDM_INSTEMUL_INFO Info
03464     )
03465 {
03466     SYSTEM_VDM_INSTEMUL_INFO LocalInfo;
03467 
03468     LocalInfo.VdmOpcode0F       = ExVdmOpcodeDispatchCounts[VDM_INDEX_0F];
03469     LocalInfo.OpcodeESPrefix    = ExVdmOpcodeDispatchCounts[VDM_INDEX_ESPrefix];
03470     LocalInfo.OpcodeCSPrefix    = ExVdmOpcodeDispatchCounts[VDM_INDEX_CSPrefix];
03471     LocalInfo.OpcodeSSPrefix    = ExVdmOpcodeDispatchCounts[VDM_INDEX_SSPrefix];
03472     LocalInfo.OpcodeDSPrefix    = ExVdmOpcodeDispatchCounts[VDM_INDEX_DSPrefix];
03473     LocalInfo.OpcodeFSPrefix    = ExVdmOpcodeDispatchCounts[VDM_INDEX_FSPrefix];
03474     LocalInfo.OpcodeGSPrefix    = ExVdmOpcodeDispatchCounts[VDM_INDEX_GSPrefix];
03475     LocalInfo.OpcodeOPER32Prefix= ExVdmOpcodeDispatchCounts[VDM_INDEX_OPER32Prefix];
03476     LocalInfo.OpcodeADDR32Prefix= ExVdmOpcodeDispatchCounts[VDM_INDEX_ADDR32Prefix];
03477     LocalInfo.OpcodeINSB        = ExVdmOpcodeDispatchCounts[VDM_INDEX_INSB];
03478     LocalInfo.OpcodeINSW        = ExVdmOpcodeDispatchCounts[VDM_INDEX_INSW];
03479     LocalInfo.OpcodeOUTSB       = ExVdmOpcodeDispatchCounts[VDM_INDEX_OUTSB];
03480     LocalInfo.OpcodeOUTSW       = ExVdmOpcodeDispatchCounts[VDM_INDEX_OUTSW];
03481     LocalInfo.OpcodePUSHF       = ExVdmOpcodeDispatchCounts[VDM_INDEX_PUSHF];
03482     LocalInfo.OpcodePOPF        = ExVdmOpcodeDispatchCounts[VDM_INDEX_POPF];
03483     LocalInfo.OpcodeINTnn       = ExVdmOpcodeDispatchCounts[VDM_INDEX_INTnn];
03484     LocalInfo.OpcodeINTO        = ExVdmOpcodeDispatchCounts[VDM_INDEX_INTO];
03485     LocalInfo.OpcodeIRET        = ExVdmOpcodeDispatchCounts[VDM_INDEX_IRET];
03486     LocalInfo.OpcodeINBimm      = ExVdmOpcodeDispatchCounts[VDM_INDEX_INBimm];
03487     LocalInfo.OpcodeINWimm      = ExVdmOpcodeDispatchCounts[VDM_INDEX_INWimm];
03488     LocalInfo.OpcodeOUTBimm     = ExVdmOpcodeDispatchCounts[VDM_INDEX_OUTBimm];
03489     LocalInfo.OpcodeOUTWimm     = ExVdmOpcodeDispatchCounts[VDM_INDEX_OUTWimm];
03490     LocalInfo.OpcodeINB         = ExVdmOpcodeDispatchCounts[VDM_INDEX_INB];
03491     LocalInfo.OpcodeINW         = ExVdmOpcodeDispatchCounts[VDM_INDEX_INW];
03492     LocalInfo.OpcodeOUTB        = ExVdmOpcodeDispatchCounts[VDM_INDEX_OUTB];
03493     LocalInfo.OpcodeOUTW        = ExVdmOpcodeDispatchCounts[VDM_INDEX_OUTW];
03494     LocalInfo.OpcodeLOCKPrefix  = ExVdmOpcodeDispatchCounts[VDM_INDEX_LOCKPrefix];
03495     LocalInfo.OpcodeREPNEPrefix = ExVdmOpcodeDispatchCounts[VDM_INDEX_REPNEPrefix];
03496     LocalInfo.OpcodeREPPrefix   = ExVdmOpcodeDispatchCounts[VDM_INDEX_REPPrefix];
03497     LocalInfo.OpcodeHLT         = ExVdmOpcodeDispatchCounts[VDM_INDEX_HLT];
03498     LocalInfo.OpcodeCLI         = ExVdmOpcodeDispatchCounts[VDM_INDEX_CLI];
03499     LocalInfo.OpcodeSTI         = ExVdmOpcodeDispatchCounts[VDM_INDEX_STI];
03500     LocalInfo.BopCount          = VdmBopCount;
03501     LocalInfo.SegmentNotPresent = ExVdmSegmentNotPresent;
03502 
03503     RtlMoveMemory(Info,&amp;LocalInfo,<span class="keyword">sizeof</span>(LocalInfo));
03504 
03505     <span class="keywordflow">return</span> STATUS_SUCCESS;
03506 }
03507 <span class="preprocessor">#endif</span>
03508 <span class="preprocessor"></span>
03509 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
03510 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03511 ExpGetStackTraceInformation (
03512     OUT PVOID SystemInformation,
03513     IN ULONG SystemInformationLength,
03514     OUT PULONG ReturnLength OPTIONAL
03515     )
03516 {
03517     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03518     PRTL_PROCESS_BACKTRACES BackTraceInformation = (PRTL_PROCESS_BACKTRACES)SystemInformation;
03519     PRTL_PROCESS_BACKTRACE_INFORMATION BackTraceInfo;
03520     <a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html">PSTACK_TRACE_DATABASE</a> DataBase;
03521     <a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html">PRTL_STACK_TRACE_ENTRY</a> p, *pp;
03522     ULONG RequiredLength, <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
03523 
03524     DataBase = <a class="code" href="../../d8/d6/stktrace_8h.html#a4">RtlpAcquireStackTraceDataBase</a>();
03525     <span class="keywordflow">if</span> (DataBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03526         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03527         }
03528     DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o7">DumpInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03529     <a class="code" href="../../d8/d6/stktrace_8h.html#a5">RtlpReleaseStackTraceDataBase</a>();
03530     <span class="keywordflow">try</span> {
03531         RequiredLength = FIELD_OFFSET( RTL_PROCESS_BACKTRACES, BackTraces );
03532         <span class="keywordflow">if</span> (SystemInformationLength &lt; RequiredLength) {
03533             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
03534             }
03535         <span class="keywordflow">else</span> {
03536             BackTraceInformation-&gt;CommittedMemory =
03537                 (ULONG)DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o10">CurrentUpperCommitLimit</a> - (ULONG)DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o8">CommitBase</a>;
03538             BackTraceInformation-&gt;ReservedMemory =
03539                 (ULONG)DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o15">EntryIndexArray</a> - (ULONG)DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o8">CommitBase</a>;
03540             BackTraceInformation-&gt;NumberOfBackTraceLookups = DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o13">NumberOfEntriesLookedUp</a>;
03541             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o14">NumberOfEntriesAdded</a>;
03542             BackTraceInformation-&gt;NumberOfBackTraces = <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
03543             }
03544 
03545         RequiredLength += (<span class="keyword">sizeof</span>( *BackTraceInfo ) * <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>);
03546         <span class="keywordflow">if</span> (SystemInformationLength &lt; RequiredLength) {
03547             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
03548             }
03549         <span class="keywordflow">else</span> {
03550             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03551             BackTraceInfo = &amp;BackTraceInformation-&gt;BackTraces[ 0 ];
03552             pp = DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o15">EntryIndexArray</a>;
03553             <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>--) {
03554                 p = *--pp;
03555                 BackTraceInfo-&gt;SymbolicBackTrace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03556                 BackTraceInfo-&gt;TraceCount = p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o1">TraceCount</a>;
03557                 BackTraceInfo-&gt;Index = p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o2">Index</a>;
03558                 BackTraceInfo-&gt;Depth = p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o3">Depth</a>;
03559                 RtlMoveMemory( BackTraceInfo-&gt;BackTrace,
03560                                p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o4">BackTrace</a>,
03561                                p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o3">Depth</a> * <span class="keyword">sizeof</span>( PVOID )
03562                              );
03563                 BackTraceInfo++;
03564                 }
03565             }
03566         }
03567     finally {
03568         DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o7">DumpInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03569         }
03570 
03571     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
03572         *ReturnLength = RequiredLength;
03573     }
03574     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03575 }
03576 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
03577 <span class="preprocessor"></span>
03578 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03579"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a35">03579</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a35">ExpGetLockInformation</a> (
03580     OUT PVOID SystemInformation,
03581     IN ULONG SystemInformationLength,
03582     OUT PULONG Length
03583     )
03584 <span class="comment">/*++</span>
03585 <span class="comment"></span>
03586 <span class="comment">Routine Description:</span>
03587 <span class="comment"></span>
03588 <span class="comment">    This function returns information about all the ERESOURCE locks</span>
03589 <span class="comment">    in the system.</span>
03590 <span class="comment"></span>
03591 <span class="comment">Arguments:</span>
03592 <span class="comment"></span>
03593 <span class="comment">    SystemInformation - A pointer to a buffer which receives the specified</span>
03594 <span class="comment">        information.</span>
03595 <span class="comment"></span>
03596 <span class="comment">    SystemInformationLength - Specifies the length in bytes of the system</span>
03597 <span class="comment">        information buffer.</span>
03598 <span class="comment"></span>
03599 <span class="comment">    Length - An optional pointer which, if specified, receives the</span>
03600 <span class="comment">        number of bytes placed in the system information buffer.</span>
03601 <span class="comment"></span>
03602 <span class="comment"></span>
03603 <span class="comment">Return Value:</span>
03604 <span class="comment"></span>
03605 <span class="comment">    Returns one of the following status codes:</span>
03606 <span class="comment"></span>
03607 <span class="comment">        STATUS_SUCCESS - normal, successful completion.</span>
03608 <span class="comment"></span>
03609 <span class="comment">        STATUS_INVALID_INFO_CLASS - The SystemInformationClass parameter</span>
03610 <span class="comment">            did not specify a valid value.</span>
03611 <span class="comment"></span>
03612 <span class="comment">        STATUS_INFO_LENGTH_MISMATCH - The value of the SystemInformationLength</span>
03613 <span class="comment">            parameter did not match the length required for the information</span>
03614 <span class="comment">            class requested by the SystemInformationClass parameter.</span>
03615 <span class="comment"></span>
03616 <span class="comment">        STATUS_ACCESS_VIOLATION - Either the SystemInformation buffer pointer</span>
03617 <span class="comment">            or the Length pointer value specified an invalid address.</span>
03618 <span class="comment"></span>
03619 <span class="comment">        STATUS_WORKING_SET_QUOTA - The process does not have sufficient</span>
03620 <span class="comment">            working set to lock the specified output structure in memory.</span>
03621 <span class="comment"></span>
03622 <span class="comment">        STATUS_INSUFFICIENT_RESOURCES - Insufficient system resources exist</span>
03623 <span class="comment">            for this request to complete.</span>
03624 <span class="comment"></span>
03625 <span class="comment">--*/</span>
03626 
03627 {
03628     PRTL_PROCESS_LOCKS LockInfo;
03629     PVOID LockVariable;
03630     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03631 
03632 
03633     *Length = 0;
03634 
03635     LockInfo = (PRTL_PROCESS_LOCKS)
03636         <a class="code" href="../../d5/d8/ex_8h.html#a256">ExLockUserBuffer</a>( SystemInformation,
03637                           SystemInformationLength,
03638                           &amp;LockVariable
03639                         );
03640     <span class="keywordflow">if</span> (LockInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03641         <span class="keywordflow">return</span>( STATUS_ACCESS_VIOLATION );
03642         }
03643 
03644     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03645     <span class="keywordflow">try</span> {
03646 
03647         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a32">ExQuerySystemLockInformation</a>( LockInfo,
03648                                                SystemInformationLength,
03649                                                Length
03650                                              );
03651         }
03652     finally {
03653         <a class="code" href="../../d5/d8/ex_8h.html#a257">ExUnlockUserBuffer</a>( LockVariable );
03654         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03655         }
03656 
03657     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
03658 }
03659 
03660 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03661"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a36">03661</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a36">ExpGetLookasideInformation</a> (
03662     OUT PVOID Buffer,
03663     IN ULONG BufferLength,
03664     OUT PULONG Length
03665     )
03666 
03667 <span class="comment">/*++</span>
03668 <span class="comment"></span>
03669 <span class="comment">Routine Description:</span>
03670 <span class="comment"></span>
03671 <span class="comment">    This function returns pool lookaside list and general lookaside</span>
03672 <span class="comment">    list information.</span>
03673 <span class="comment"></span>
03674 <span class="comment">Arguments:</span>
03675 <span class="comment"></span>
03676 <span class="comment">    Buffer - Supplies a pointer to the buffer which receives the lookaside</span>
03677 <span class="comment">        list information.</span>
03678 <span class="comment"></span>
03679 <span class="comment">    BufferLength - Supplies the length of the information buffer in bytes.</span>
03680 <span class="comment"></span>
03681 <span class="comment">    Length - Supplies a pointer to a variable that receives the length of</span>
03682 <span class="comment">        lookaside information returned.</span>
03683 <span class="comment"></span>
03684 <span class="comment">Return Value:</span>
03685 <span class="comment"></span>
03686 <span class="comment">    Returns one of the following status codes:</span>
03687 <span class="comment"></span>
03688 <span class="comment">        STATUS_SUCCESS - Normal, successful completion.</span>
03689 <span class="comment"></span>
03690 <span class="comment">        STATUS_ACCESS_VIOLATION - The buffer could not be locked in memory.</span>
03691 <span class="comment"></span>
03692 <span class="comment">--*/</span>
03693 
03694 {
03695 
03696     PVOID BufferLock;
03697     PLIST_ENTRY Entry;
03698     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03699     KIRQL OldIrql;
03700     ULONG Limit;
03701     PSYSTEM_LOOKASIDE_INFORMATION Lookaside;
03702     ULONG Number;
03703     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> NPagedLookaside;
03704     <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> PagedLookaside;
03705     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> PoolLookaside;
03706     PKSPIN_LOCK SpinLock;
03707     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03708 
03709     <span class="comment">//</span>
03710     <span class="comment">// Compute the number of lookaside entries and set the return status to</span>
03711     <span class="comment">// success.</span>
03712     <span class="comment">//</span>
03713 
03714     Limit = BufferLength / <span class="keyword">sizeof</span>(SYSTEM_LOOKASIDE_INFORMATION);
03715     Number = 0;
03716     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03717 
03718     <span class="comment">//</span>
03719     <span class="comment">// If the number of lookaside entries to return is not zero, then collect</span>
03720     <span class="comment">// the lookaside information.</span>
03721     <span class="comment">//</span>
03722 
03723     <span class="keywordflow">if</span> (Limit != 0) {
03724         <span class="keywordflow">if</span> ((Lookaside =
03725                 (PSYSTEM_LOOKASIDE_INFORMATION)<a class="code" href="../../d5/d8/ex_8h.html#a256">ExLockUserBuffer</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
03726                                                                 BufferLength,
03727                                                                 &amp;BufferLock)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03728             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_VIOLATION;
03729 
03730         } <span class="keywordflow">else</span> {
03731             <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03732 
03733             <span class="comment">//</span>
03734             <span class="comment">// Copy nonpaged and paged pool lookaside information to</span>
03735             <span class="comment">// information buffer.</span>
03736             <span class="comment">//</span>
03737 
03738             Entry = <a class="code" href="../../d4/d0/exp_8h.html#a17">ExPoolLookasideListHead</a>.Flink;
03739             <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d4/d0/exp_8h.html#a17">ExPoolLookasideListHead</a>) {
03740                 PoolLookaside = CONTAINING_RECORD(Entry,
03741                                                   <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>,
03742                                                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>.ListEntry);
03743 
03744                 Lookaside-&gt;CurrentDepth = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>.<a class="code" href="../../d9/d3/union__SLIST__HEADER.html#o2">Depth</a>;
03745                 Lookaside-&gt;MaximumDepth = PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>;
03746                 Lookaside-&gt;TotalAllocates = PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a>;
03747                 Lookaside-&gt;AllocateMisses =
03748                         PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> - PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a>;
03749 
03750                 Lookaside-&gt;TotalFrees = PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a>;
03751                 Lookaside-&gt;FreeMisses =
03752                         PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> - PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o8">FreeHits</a>;
03753 
03754                 Lookaside-&gt;Type = PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o9">Type</a>;
03755                 Lookaside-&gt;Tag = PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o10">Tag</a>;
03756                 Lookaside-&gt;Size = PoolLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o11">Size</a>;
03757                 Number += 1;
03758                 <span class="keywordflow">if</span> (Number == Limit) {
03759                     <span class="keywordflow">goto</span> Finish2;
03760                 }
03761 
03762                 Entry = Entry-&gt;Flink;
03763                 Lookaside += 1;
03764             }
03765 
03766             <span class="comment">//</span>
03767             <span class="comment">// Copy nonpaged general lookaside information to buffer.</span>
03768             <span class="comment">//</span>
03769 
03770             SpinLock = &amp;<a class="code" href="../../d4/d0/exp_8h.html#a14">ExNPagedLookasideLock</a>;
03771             ExAcquireSpinLock(SpinLock, &amp;OldIrql);
03772             Entry = <a class="code" href="../../d4/d0/exp_8h.html#a13">ExNPagedLookasideListHead</a>.Flink;
03773             <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d4/d0/exp_8h.html#a13">ExNPagedLookasideListHead</a>) {
03774                 NPagedLookaside = CONTAINING_RECORD(Entry,
03775                                                     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>,
03776                                                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>.ListEntry);
03777 
03778                 Lookaside-&gt;CurrentDepth = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NPagedLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>.<a class="code" href="../../d9/d3/union__SLIST__HEADER.html#o2">Depth</a>;
03779                 Lookaside-&gt;MaximumDepth = NPagedLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>;
03780                 Lookaside-&gt;TotalAllocates = NPagedLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a>;
03781                 Lookaside-&gt;AllocateMisses = NPagedLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o4">AllocateMisses</a>;
03782                 Lookaside-&gt;TotalFrees = NPagedLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a>;
03783                 Lookaside-&gt;FreeMisses = NPagedLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o7">FreeMisses</a>;
03784                 Lookaside-&gt;Type = 0;
03785                 Lookaside-&gt;Tag = NPagedLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o10">Tag</a>;
03786                 Lookaside-&gt;Size = NPagedLookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o11">Size</a>;
03787                 Number += 1;
03788                 <span class="keywordflow">if</span> (Number == Limit) {
03789                     <span class="keywordflow">goto</span> Finish1;
03790                 }
03791 
03792                 Entry = Entry-&gt;Flink;
03793                 Lookaside += 1;
03794             }
03795 
03796             ExReleaseSpinLock(SpinLock, OldIrql);
03797 
03798             <span class="comment">//</span>
03799             <span class="comment">// Copy paged general lookaside information to buffer.</span>
03800             <span class="comment">//</span>
03801 
03802             SpinLock = &amp;<a class="code" href="../../d4/d0/exp_8h.html#a16">ExPagedLookasideLock</a>;
03803             ExAcquireSpinLock(SpinLock, &amp;OldIrql);
03804             Entry = <a class="code" href="../../d4/d0/exp_8h.html#a15">ExPagedLookasideListHead</a>.Flink;
03805             <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d4/d0/exp_8h.html#a15">ExPagedLookasideListHead</a>) {
03806                 PagedLookaside = CONTAINING_RECORD(Entry,
03807                                                    <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a>,
03808                                                    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>.ListEntry);
03809 
03810                 Lookaside-&gt;CurrentDepth = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PagedLookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>.<a class="code" href="../../d9/d3/union__SLIST__HEADER.html#o2">Depth</a>;
03811                 Lookaside-&gt;MaximumDepth = PagedLookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>;
03812                 Lookaside-&gt;TotalAllocates = PagedLookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a>;
03813                 Lookaside-&gt;AllocateMisses = PagedLookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o4">AllocateMisses</a>;
03814                 Lookaside-&gt;TotalFrees = PagedLookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a>;
03815                 Lookaside-&gt;FreeMisses = PagedLookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o7">FreeMisses</a>;
03816                 Lookaside-&gt;Type = 1;
03817                 Lookaside-&gt;Tag = PagedLookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o10">Tag</a>;
03818                 Lookaside-&gt;Size = PagedLookaside-&gt;<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o11">Size</a>;
03819                 Number += 1;
03820                 <span class="keywordflow">if</span> (Number == Limit) {
03821                     <span class="keywordflow">goto</span> Finish1;
03822                 }
03823 
03824                 Entry = Entry-&gt;Flink;
03825                 Lookaside += 1;
03826             }
03827 
03828         Finish1:
03829             ExReleaseSpinLock(SpinLock, OldIrql);
03830 
03831             <span class="comment">//</span>
03832             <span class="comment">// Unlock user buffer and page lock image section.</span>
03833             <span class="comment">//</span>
03834 
03835         Finish2:
03836             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03837             <a class="code" href="../../d5/d8/ex_8h.html#a257">ExUnlockUserBuffer</a>(BufferLock);
03838         }
03839     }
03840 
03841     *Length = Number * <span class="keyword">sizeof</span>(SYSTEM_LOOKASIDE_INFORMATION);
03842     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03843 }
03844 
03845 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03846"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a37">03846</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a37">ExpGetPoolInformation</a>(
03847     IN POOL_TYPE PoolType,
03848     OUT PVOID SystemInformation,
03849     IN ULONG SystemInformationLength,
03850     OUT PULONG Length
03851     )
03852 <span class="comment">/*++</span>
03853 <span class="comment"></span>
03854 <span class="comment">Routine Description:</span>
03855 <span class="comment"></span>
03856 <span class="comment">    This function returns information about the specified type of pool memory.</span>
03857 <span class="comment"></span>
03858 <span class="comment">Arguments:</span>
03859 <span class="comment"></span>
03860 <span class="comment">    SystemInformation - A pointer to a buffer which receives the specified</span>
03861 <span class="comment">        information.</span>
03862 <span class="comment"></span>
03863 <span class="comment">    SystemInformationLength - Specifies the length in bytes of the system</span>
03864 <span class="comment">        information buffer.</span>
03865 <span class="comment"></span>
03866 <span class="comment">    Length - An optional pointer which, if specified, receives the</span>
03867 <span class="comment">        number of bytes placed in the system information buffer.</span>
03868 <span class="comment"></span>
03869 <span class="comment"></span>
03870 <span class="comment">Return Value:</span>
03871 <span class="comment"></span>
03872 <span class="comment">    Returns one of the following status codes:</span>
03873 <span class="comment"></span>
03874 <span class="comment">        STATUS_SUCCESS - normal, successful completion.</span>
03875 <span class="comment"></span>
03876 <span class="comment">        STATUS_INVALID_INFO_CLASS - The SystemInformationClass parameter</span>
03877 <span class="comment">            did not specify a valid value.</span>
03878 <span class="comment"></span>
03879 <span class="comment">        STATUS_INFO_LENGTH_MISMATCH - The value of the SystemInformationLength</span>
03880 <span class="comment">            parameter did not match the length required for the information</span>
03881 <span class="comment">            class requested by the SystemInformationClass parameter.</span>
03882 <span class="comment"></span>
03883 <span class="comment">        STATUS_ACCESS_VIOLATION - Either the SystemInformation buffer pointer</span>
03884 <span class="comment">            or the Length pointer value specified an invalid address.</span>
03885 <span class="comment"></span>
03886 <span class="comment">        STATUS_WORKING_SET_QUOTA - The process does not have sufficient</span>
03887 <span class="comment">            working set to lock the specified output structure in memory.</span>
03888 <span class="comment"></span>
03889 <span class="comment">        STATUS_INSUFFICIENT_RESOURCES - Insufficient system resources exist</span>
03890 <span class="comment">            for this request to complete.</span>
03891 <span class="comment"></span>
03892 <span class="comment">--*/</span>
03893 
03894 {
03895 <span class="preprocessor">#if DBG || (i386 &amp;&amp; !FPO)</span>
03896 <span class="preprocessor"></span>
03897 <span class="comment">//</span>
03898 <span class="comment">// Only works on checked builds or free x86 builds with FPO turned off</span>
03899 <span class="comment">// See comment in mm\allocpag.c</span>
03900 <span class="comment">//</span>
03901 
03902     PSYSTEM_POOL_INFORMATION PoolInfo;
03903     PVOID LockVariable;
03904     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03905 
03906 
03907     *Length = 0;
03908 
03909     PoolInfo = (PSYSTEM_POOL_INFORMATION)
03910         <a class="code" href="../../d5/d8/ex_8h.html#a256">ExLockUserBuffer</a>( SystemInformation,
03911                           SystemInformationLength,
03912                           &amp;LockVariable
03913                         );
03914     <span class="keywordflow">if</span> (PoolInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03915         <span class="keywordflow">return</span>( STATUS_ACCESS_VIOLATION );
03916         }
03917 
03918     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03919     <span class="keywordflow">try</span> {
03920         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ExSnapShotPool( PoolType,
03921                                  PoolInfo,
03922                                  SystemInformationLength,
03923                                  Length
03924                                );
03925 
03926         }
03927     finally {
03928         <a class="code" href="../../d5/d8/ex_8h.html#a257">ExUnlockUserBuffer</a>( LockVariable );
03929         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03930         }
03931 
03932     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
03933 <span class="preprocessor">#else</span>
03934 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
03935 <span class="preprocessor">#endif // DBG || (i386 &amp;&amp; !FPO)</span>
03936 <span class="preprocessor"></span>}
03937 
03938 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03939"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a38">03939</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a38">ExpGetHandleInformation</a>(
03940     OUT PVOID SystemInformation,
03941     IN ULONG SystemInformationLength,
03942     OUT PULONG Length
03943     )
03944 <span class="comment">/*++</span>
03945 <span class="comment"></span>
03946 <span class="comment">Routine Description:</span>
03947 <span class="comment"></span>
03948 <span class="comment">    This function returns information about the open handles in the system.</span>
03949 <span class="comment"></span>
03950 <span class="comment">Arguments:</span>
03951 <span class="comment"></span>
03952 <span class="comment">    SystemInformation - A pointer to a buffer which receives the specified</span>
03953 <span class="comment">        information.</span>
03954 <span class="comment"></span>
03955 <span class="comment">    SystemInformationLength - Specifies the length in bytes of the system</span>
03956 <span class="comment">        information buffer.</span>
03957 <span class="comment"></span>
03958 <span class="comment">    Length - An optional pointer which, if specified, receives the</span>
03959 <span class="comment">        number of bytes placed in the system information buffer.</span>
03960 <span class="comment"></span>
03961 <span class="comment"></span>
03962 <span class="comment">Return Value:</span>
03963 <span class="comment"></span>
03964 <span class="comment">    Returns one of the following status codes:</span>
03965 <span class="comment"></span>
03966 <span class="comment">        STATUS_SUCCESS - normal, successful completion.</span>
03967 <span class="comment"></span>
03968 <span class="comment">        STATUS_INVALID_INFO_CLASS - The SystemInformationClass parameter</span>
03969 <span class="comment">            did not specify a valid value.</span>
03970 <span class="comment"></span>
03971 <span class="comment">        STATUS_INFO_LENGTH_MISMATCH - The value of the SystemInformationLength</span>
03972 <span class="comment">            parameter did not match the length required for the information</span>
03973 <span class="comment">            class requested by the SystemInformationClass parameter.</span>
03974 <span class="comment"></span>
03975 <span class="comment">        STATUS_ACCESS_VIOLATION - Either the SystemInformation buffer pointer</span>
03976 <span class="comment">            or the Length pointer value specified an invalid address.</span>
03977 <span class="comment"></span>
03978 <span class="comment">        STATUS_WORKING_SET_QUOTA - The process does not have sufficient</span>
03979 <span class="comment">            working set to lock the specified output structure in memory.</span>
03980 <span class="comment"></span>
03981 <span class="comment">        STATUS_INSUFFICIENT_RESOURCES - Insufficient system resources exist</span>
03982 <span class="comment">            for this request to complete.</span>
03983 <span class="comment"></span>
03984 <span class="comment">--*/</span>
03985 
03986 {
03987     PSYSTEM_HANDLE_INFORMATION HandleInfo;
03988     PVOID LockVariable;
03989     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03990 
03991     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03992 
03993     *Length = 0;
03994 
03995     HandleInfo = (PSYSTEM_HANDLE_INFORMATION)
03996         <a class="code" href="../../d5/d8/ex_8h.html#a256">ExLockUserBuffer</a>( SystemInformation,
03997                           SystemInformationLength,
03998                           &amp;LockVariable
03999                         );
04000     <span class="keywordflow">if</span> (HandleInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04001         <span class="keywordflow">return</span>( STATUS_ACCESS_VIOLATION );
04002         }
04003 
04004     <span class="keywordflow">try</span> {
04005         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a5">ObGetHandleInformation</a>( HandleInfo,
04006                                          SystemInformationLength,
04007                                          Length
04008                                        );
04009 
04010         }
04011     finally {
04012         <a class="code" href="../../d5/d8/ex_8h.html#a257">ExUnlockUserBuffer</a>( LockVariable );
04013         }
04014 
04015     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
04016 }
04017 
04018 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04019"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a39">04019</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a39">ExpGetObjectInformation</a>(
04020     OUT PVOID SystemInformation,
04021     IN ULONG SystemInformationLength,
04022     OUT PULONG Length
04023     )
04024 
04025 <span class="comment">/*++</span>
04026 <span class="comment"></span>
04027 <span class="comment">Routine Description:</span>
04028 <span class="comment"></span>
04029 <span class="comment">    This function returns information about the objects in the system.</span>
04030 <span class="comment"></span>
04031 <span class="comment">Arguments:</span>
04032 <span class="comment"></span>
04033 <span class="comment">    SystemInformation - A pointer to a buffer which receives the specified</span>
04034 <span class="comment">        information.</span>
04035 <span class="comment"></span>
04036 <span class="comment">    SystemInformationLength - Specifies the length in bytes of the system</span>
04037 <span class="comment">        information buffer.</span>
04038 <span class="comment"></span>
04039 <span class="comment">    Length - An optional pointer which, if specified, receives the</span>
04040 <span class="comment">        number of bytes placed in the system information buffer.</span>
04041 <span class="comment"></span>
04042 <span class="comment"></span>
04043 <span class="comment">Return Value:</span>
04044 <span class="comment"></span>
04045 <span class="comment">    Returns one of the following status codes:</span>
04046 <span class="comment"></span>
04047 <span class="comment">        STATUS_SUCCESS - normal, successful completion.</span>
04048 <span class="comment"></span>
04049 <span class="comment">        STATUS_INVALID_INFO_CLASS - The SystemInformationClass parameter</span>
04050 <span class="comment">            did not specify a valid value.</span>
04051 <span class="comment"></span>
04052 <span class="comment">        STATUS_INFO_LENGTH_MISMATCH - The value of the SystemInformationLength</span>
04053 <span class="comment">            parameter did not match the length required for the information</span>
04054 <span class="comment">            class requested by the SystemInformationClass parameter.</span>
04055 <span class="comment"></span>
04056 <span class="comment">        STATUS_ACCESS_VIOLATION - Either the SystemInformation buffer pointer</span>
04057 <span class="comment">            or the Length pointer value specified an invalid address.</span>
04058 <span class="comment"></span>
04059 <span class="comment">        STATUS_WORKING_SET_QUOTA - The process does not have sufficient</span>
04060 <span class="comment">            working set to lock the specified output structure in memory.</span>
04061 <span class="comment"></span>
04062 <span class="comment">        STATUS_INSUFFICIENT_RESOURCES - Insufficient system resources exist</span>
04063 <span class="comment">            for this request to complete.</span>
04064 <span class="comment"></span>
04065 <span class="comment">--*/</span>
04066 
04067 {
04068     PSYSTEM_OBJECTTYPE_INFORMATION ObjectInfo;
04069     PVOID LockVariable;
04070     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04071 
04072     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04073 
04074     *Length = 0;
04075 
04076     ObjectInfo = (PSYSTEM_OBJECTTYPE_INFORMATION)
04077         <a class="code" href="../../d5/d8/ex_8h.html#a256">ExLockUserBuffer</a>( SystemInformation,
04078                           SystemInformationLength,
04079                           &amp;LockVariable
04080                         );
04081     <span class="keywordflow">if</span> (ObjectInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04082         <span class="keywordflow">return</span>( STATUS_ACCESS_VIOLATION );
04083         }
04084 
04085     <span class="keywordflow">try</span> {
04086         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a6">ObGetObjectInformation</a>( SystemInformation,
04087                                          ObjectInfo,
04088                                          SystemInformationLength,
04089                                          Length
04090                                        );
04091 
04092         }
04093     finally {
04094         <a class="code" href="../../d5/d8/ex_8h.html#a257">ExUnlockUserBuffer</a>( LockVariable );
04095         }
04096 
04097     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
04098 }
04099 
<a name="l04100"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a26">04100</a> <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a>;
<a name="l04101"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a27">04101</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>;
04102 
04103 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04104"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a41">04104</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a41">ExpGetPoolTagInfo</a> (
04105     IN PVOID SystemInformation,
04106     IN ULONG SystemInformationLength,
04107     IN OUT PULONG ReturnLength OPTIONAL
04108     )
04109 
04110 {
04111     SIZE_T NumberOfBytes;
04112     ULONG totalBytes;
04113     ULONG i;
04114     KIRQL OldIrql;
04115     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04116     PSYSTEM_POOLTAG_INFORMATION taginfo;
04117     PSYSTEM_POOLTAG poolTag;
04118     <a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">PPOOL_TRACKER_TABLE</a> PoolTrackInfo;
04119 
04120     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04121     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>) {
04122         <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
04123     }
04124 
04125     totalBytes = 0;
04126     status = STATUS_SUCCESS;
04127 
04128     taginfo = (PSYSTEM_POOLTAG_INFORMATION)SystemInformation;
04129     poolTag = &amp;taginfo-&gt;TagInfo[0];
04130     totalBytes = FIELD_OFFSET(SYSTEM_POOLTAG_INFORMATION, TagInfo);
04131     taginfo-&gt;Count = 0;
04132 
04133     <span class="comment">//</span>
04134     <span class="comment">// Synchronize access to PoolTrackTable as it can move.</span>
04135     <span class="comment">//</span>
04136 
04137     NumberOfBytes = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>);
04138 
04139     PoolTrackInfo = (<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">PPOOL_TRACKER_TABLE</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04140                                                                  NumberOfBytes,
04141                                                                  'ofnI');
04142 
04143     <span class="keywordflow">if</span> (PoolTrackInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04144         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04145     }
04146 
04147     ExAcquireSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, &amp;OldIrql);
04148 
04149     RtlCopyMemory ((PVOID)PoolTrackInfo,
04150                    (PVOID)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>,
04151                    NumberOfBytes);
04152 
04153     ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
04154 
04155     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfBytes / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>); i += 1) {
04156         <span class="keywordflow">if</span> (PoolTrackInfo[i].Key != 0) {
04157             taginfo-&gt;Count += 1;
04158             totalBytes += <span class="keyword">sizeof</span> (SYSTEM_POOLTAG);
04159             <span class="keywordflow">if</span> (SystemInformationLength &lt; totalBytes) {
04160                 status = STATUS_INFO_LENGTH_MISMATCH;
04161             } <span class="keywordflow">else</span> {
04162                 poolTag-&gt;TagUlong = PoolTrackInfo[i].Key;
04163                 poolTag-&gt;PagedAllocs = PoolTrackInfo[i].PagedAllocs;
04164                 poolTag-&gt;PagedFrees = PoolTrackInfo[i].PagedFrees;
04165                 poolTag-&gt;PagedUsed = PoolTrackInfo[i].PagedBytes;
04166                 poolTag-&gt;NonPagedAllocs = PoolTrackInfo[i].NonPagedAllocs;
04167                 poolTag-&gt;NonPagedFrees = PoolTrackInfo[i].NonPagedFrees;
04168                 poolTag-&gt;NonPagedUsed = PoolTrackInfo[i].NonPagedBytes;
04169                 poolTag += 1;
04170             }
04171         }
04172     }
04173 
04174     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PoolTrackInfo);
04175 
04176     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
04177         *ReturnLength = totalBytes;
04178     }
04179 
04180     <span class="keywordflow">return</span> status;
04181 }
04182 
04183 
04184 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04185"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a42">04185</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a42">ExpQueryModuleInformation</a>(
04186     IN PLIST_ENTRY LoadOrderListHead,
04187     IN PLIST_ENTRY UserModeLoadOrderListHead,
04188     OUT PRTL_PROCESS_MODULES ModuleInformation,
04189     IN ULONG ModuleInformationLength,
04190     OUT PULONG ReturnLength OPTIONAL
04191     )
04192 {
04193     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04194     ULONG RequiredLength;
04195     PLIST_ENTRY Next;
04196     PLIST_ENTRY Next1;
04197     PRTL_PROCESS_MODULE_INFORMATION ModuleInfo;
04198     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
04199     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry1;
04200     ANSI_STRING AnsiString;
04201     PUCHAR s;
04202 
04203     RequiredLength = FIELD_OFFSET( RTL_PROCESS_MODULES, Modules );
04204     <span class="keywordflow">if</span> (ModuleInformationLength &lt; RequiredLength) {
04205         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
04206         }
04207     <span class="keywordflow">else</span> {
04208         ModuleInformation-&gt;NumberOfModules = 0;
04209         ModuleInfo = &amp;ModuleInformation-&gt;Modules[ 0 ];
04210         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04211         }
04212 
04213     Next = LoadOrderListHead-&gt;Flink;
04214     <span class="keywordflow">while</span> ( Next != LoadOrderListHead ) {
04215         LdrDataTableEntry = CONTAINING_RECORD( Next,
04216                                                LDR_DATA_TABLE_ENTRY,
04217                                                InLoadOrderLinks
04218                                              );
04219 
04220         RequiredLength += <span class="keyword">sizeof</span>( RTL_PROCESS_MODULE_INFORMATION );
04221         <span class="keywordflow">if</span> (ModuleInformationLength &lt; RequiredLength) {
04222             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
04223             }
04224         <span class="keywordflow">else</span> {
04225 
04226             ModuleInfo-&gt;MappedBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04227             ModuleInfo-&gt;ImageBase = LdrDataTableEntry-&gt;DllBase;
04228             ModuleInfo-&gt;ImageSize = LdrDataTableEntry-&gt;SizeOfImage;
04229             ModuleInfo-&gt;Flags = LdrDataTableEntry-&gt;Flags;
04230             ModuleInfo-&gt;LoadCount = LdrDataTableEntry-&gt;LoadCount;
04231 
04232             ModuleInfo-&gt;LoadOrderIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ModuleInformation-&gt;NumberOfModules);
04233             ModuleInfo-&gt;InitOrderIndex = 0;
04234             AnsiString.Buffer = ModuleInfo-&gt;FullPathName;
04235             AnsiString.Length = 0;
04236             AnsiString.MaximumLength = <span class="keyword">sizeof</span>( ModuleInfo-&gt;FullPathName );
04237             <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiString,
04238                                           &amp;LdrDataTableEntry-&gt;FullDllName,
04239                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
04240                                         );
04241             s = AnsiString.Buffer + AnsiString.Length;
04242             <span class="keywordflow">while</span> (s &gt; AnsiString.Buffer &amp;&amp; *--s) {
04243                 <span class="keywordflow">if</span> (*s == (UCHAR)OBJ_NAME_PATH_SEPARATOR) {
04244                     s++;
04245                     <span class="keywordflow">break</span>;
04246                     }
04247                 }
04248             ModuleInfo-&gt;OffsetToFileName = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(s - AnsiString.Buffer);
04249 
04250             ModuleInfo++;
04251             }
04252 
04253         ModuleInformation-&gt;NumberOfModules++;
04254         Next = Next-&gt;Flink;
04255         }
04256 
04257     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( UserModeLoadOrderListHead )) {
04258         Next = UserModeLoadOrderListHead-&gt;Flink;
04259         <span class="keywordflow">while</span> ( Next != UserModeLoadOrderListHead ) {
04260             LdrDataTableEntry = CONTAINING_RECORD( Next,
04261                                                    LDR_DATA_TABLE_ENTRY,
04262                                                    InLoadOrderLinks
04263                                                  );
04264 
04265             RequiredLength += <span class="keyword">sizeof</span>( RTL_PROCESS_MODULE_INFORMATION );
04266             <span class="keywordflow">if</span> (ModuleInformationLength &lt; RequiredLength) {
04267                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
04268                 }
04269             <span class="keywordflow">else</span> {
04270                 ModuleInfo-&gt;MappedBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04271                 ModuleInfo-&gt;ImageBase = LdrDataTableEntry-&gt;DllBase;
04272                 ModuleInfo-&gt;ImageSize = LdrDataTableEntry-&gt;SizeOfImage;
04273                 ModuleInfo-&gt;Flags = LdrDataTableEntry-&gt;Flags;
04274                 ModuleInfo-&gt;LoadCount = LdrDataTableEntry-&gt;LoadCount;
04275 
04276                 ModuleInfo-&gt;LoadOrderIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ModuleInformation-&gt;NumberOfModules);
04277 
04278                 ModuleInfo-&gt;InitOrderIndex = ModuleInfo-&gt;LoadOrderIndex;
04279 
04280                 AnsiString.Buffer = ModuleInfo-&gt;FullPathName;
04281                 AnsiString.Length = 0;
04282                 AnsiString.MaximumLength = <span class="keyword">sizeof</span>( ModuleInfo-&gt;FullPathName );
04283                 <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiString,
04284                                               &amp;LdrDataTableEntry-&gt;FullDllName,
04285                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
04286                                             );
04287                 s = AnsiString.Buffer + AnsiString.Length;
04288                 <span class="keywordflow">while</span> (s &gt; AnsiString.Buffer &amp;&amp; *--s) {
04289                     <span class="keywordflow">if</span> (*s == (UCHAR)OBJ_NAME_PATH_SEPARATOR) {
04290                         s++;
04291                         <span class="keywordflow">break</span>;
04292                         }
04293                     }
04294                 ModuleInfo-&gt;OffsetToFileName = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(s - AnsiString.Buffer);
04295 
04296                 ModuleInfo++;
04297                 }
04298 
04299             ModuleInformation-&gt;NumberOfModules++;
04300             Next = Next-&gt;Flink;
04301             }
04302         }
04303 
04304     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
04305         *ReturnLength = RequiredLength;
04306     }
04307     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
04308 }
04309 
04310 BOOLEAN
<a name="l04311"></a><a class="code" href="../../d5/d8/ex_8h.html#a262">04311</a> <a class="code" href="../../d5/d8/ex_8h.html#a262">ExIsProcessorFeaturePresent</a>(
04312     ULONG ProcessorFeature
04313     )
04314 {
04315     BOOLEAN rv;
04316 
04317     <span class="keywordflow">if</span> ( ProcessorFeature &lt; PROCESSOR_FEATURE_MAX ) {
04318         rv = SharedUserData-&gt;ProcessorFeatures[ProcessorFeature];
04319         }
04320     <span class="keywordflow">else</span> {
04321         rv = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04322         }
04323     <span class="keywordflow">return</span> rv;
04324 }
04325 
04326 
04327 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04328"></a><a class="code" href="../../d6/d8/sysinfo_8c.html#a43">04328</a> <a class="code" href="../../d6/d8/sysinfo_8c.html#a43">ExpQueryLegacyDriverInformation</a>(
04329     IN PSYSTEM_LEGACY_DRIVER_INFORMATION LegacyInfo,
04330     IN PULONG Length
04331     )
04332 <span class="comment">/*++</span>
04333 <span class="comment"></span>
04334 <span class="comment">Routine Description:</span>
04335 <span class="comment"></span>
04336 <span class="comment">    Returns legacy driver information for figuring out why PNP/Power functionality</span>
04337 <span class="comment">    is disabled.</span>
04338 <span class="comment"></span>
04339 <span class="comment">Arguments:</span>
04340 <span class="comment"></span>
04341 <span class="comment">    LegacyInfo - Returns the legacy driver information</span>
04342 <span class="comment"></span>
04343 <span class="comment">    Length - Supplies the length of the LegacyInfo buffer</span>
04344 <span class="comment">             Returns the amount of data written</span>
04345 <span class="comment"></span>
04346 <span class="comment">Return Value:</span>
04347 <span class="comment"></span>
04348 <span class="comment">    NTSTATUS</span>
04349 <span class="comment"></span>
04350 <span class="comment">--*/</span>
04351 
04352 {
04353     PNP_VETO_TYPE VetoType;
04354     PWSTR VetoList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04355     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04356     UNICODE_STRING <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
04357     ULONG ReturnLength;
04358 
04359     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a120">IoGetLegacyVetoList</a>(&amp;VetoList, &amp;VetoType);
04360     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04361         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04362     }
04363 
04364     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, VetoList);
04365     ReturnLength = <span class="keyword">sizeof</span>(SYSTEM_LEGACY_DRIVER_INFORMATION) + <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length;
04366     <span class="keywordflow">if</span> (ReturnLength &gt; *Length) {
04367         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
04368     } <span class="keywordflow">else</span> {
04369         <span class="keywordflow">try</span> {
04370             LegacyInfo-&gt;VetoType = VetoType;
04371             LegacyInfo-&gt;VetoList.Length = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length;
04372             LegacyInfo-&gt;VetoList.Buffer = (PWSTR)(LegacyInfo+1);
04373             RtlCopyMemory(LegacyInfo+1, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length);
04374         } finally {
04375             <span class="keywordflow">if</span> (VetoList) {
04376                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(VetoList);
04377             }
04378         }
04379     }
04380 
04381     *Length = ReturnLength;
04382     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04383 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:56 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
