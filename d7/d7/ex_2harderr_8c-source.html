<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: harderr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>harderr.c</h1><a href="../../d6/d8/ex_2harderr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    harderr.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements NT Hard Error APIs</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky (markl) 04-Jul-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00022 
<a name="l00023"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a2">00023</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a2">KiBugCheckData</a>[5];
<a name="l00024"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a3">00024</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a3">KeBugCheckCount</a>;
00025 
00026 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00027 <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a9">ExpRaiseHardError</a>(
00028     IN NTSTATUS ErrorStatus,
00029     IN ULONG NumberOfParameters,
00030     IN ULONG UnicodeStringParameterMask,
00031     IN PULONG_PTR Parameters,
00032     IN ULONG ValidResponseOptions,
00033     OUT PULONG Response
00034     );
00035 
00036 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00037 <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a10">ExpSystemErrorHandler</a>(
00038     IN NTSTATUS ErrorStatus,
00039     IN ULONG NumberOfParameters,
00040     IN ULONG UnicodeStringParameterMask,
00041     IN PULONG_PTR Parameters,
00042     IN BOOLEAN CallShutdown
00043     );
00044 
00045 <span class="preprocessor">#if defined(ALLOC_PRAGMA)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtRaiseHardError)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetDefaultHardErrorPort)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExRaiseHardError)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpRaiseHardError)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExpSystemErrorHandler)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a0">00053</a> <span class="preprocessor">#define HARDERROR_MSG_OVERHEAD (sizeof(HARDERROR_MSG) - sizeof(PORT_MESSAGE))</span>
<a name="l00054"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a1">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define HARDERROR_API_MSG_LENGTH \</span>
00055 <span class="preprocessor">            sizeof(HARDERROR_MSG)&lt;&lt;16 | (HARDERROR_MSG_OVERHEAD)</span>
00056 <span class="preprocessor"></span>
<a name="l00057"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">00057</a> <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a>;
<a name="l00058"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">00058</a> BOOLEAN <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00059"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a6">00059</a> BOOLEAN <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a6">ExpTooLateForErrors</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00060"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a7">00060</a> HANDLE <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a7">ExpDefaultErrorPort</a>;
<a name="l00061"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a8">00061</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a8">PsSystemDllDllBase</a>;
00062 
00063 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00064"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a10">00064</a> <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a10">ExpSystemErrorHandler</a>(
00065     IN NTSTATUS ErrorStatus,
00066     IN ULONG NumberOfParameters,
00067     IN ULONG UnicodeStringParameterMask,
00068     IN PULONG_PTR Parameters,
00069     IN BOOLEAN CallShutdown
00070     )
00071 {
00072 
00073     ULONG Counter;
00074     ANSI_STRING AnsiString;
00075     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00076     ULONG_PTR ParameterVector[MAXIMUM_HARDERROR_PARAMETERS];
00077     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> DefaultFormatBuffer[32];
00078     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ExpSystemErrorBuffer[256];
00079     PMESSAGE_RESOURCE_ENTRY MessageEntry;
00080     PSZ ErrorCaption;
00081     PSZ ErrorFormatString;
00082     ANSI_STRING Astr;
00083     UNICODE_STRING Ustr;
00084     OEM_STRING Ostr;
00085     PSZ OemCaption;
00086     PSZ OemMessage;
00087     PSZ UnknownHardError = <span class="stringliteral">"Unknown Hard Error"</span>;
00088     PVOID UnlockHandle;
00089     CONTEXT ContextSave;
00090 
00091     <span class="comment">//</span>
00092     <span class="comment">// This handler is called whenever a hard error occurs before the</span>
00093     <span class="comment">// default handler has been installed.</span>
00094     <span class="comment">//</span>
00095     <span class="comment">// This is done regardless of whether or not the process has chosen</span>
00096     <span class="comment">// default hard error processing.</span>
00097     <span class="comment">//</span>
00098 
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">// Capture the callers context as closely as possible into the debugger's</span>
00102     <span class="comment">// processor state area of the Prcb</span>
00103     <span class="comment">//</span>
00104     <span class="comment">// N.B. There may be some prologue code that shuffles registers such that</span>
00105     <span class="comment">//      they get destroyed.</span>
00106     <span class="comment">//</span>
00107     <span class="comment">// this code is here only for crash dumps</span>
00108     RtlCaptureContext(&amp;<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;ProcessorState.ContextFrame);
00109     <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;ProcessorState);
00110     ContextSave = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;ProcessorState.ContextFrame;
00111 
00112 
00113     DefaultFormatBuffer[0] = <span class="charliteral">'\0'</span>;
00114     RtlZeroMemory(ParameterVector,<span class="keyword">sizeof</span>(ParameterVector));
00115     <span class="keywordflow">for</span>(Counter=0;Counter &lt; NumberOfParameters;Counter++){
00116         ParameterVector[Counter] = Parameters[Counter];
00117         }
00118 
00119     <span class="keywordflow">for</span>(Counter=0;Counter &lt; NumberOfParameters;Counter++){
00120         <span class="keywordflow">if</span> ( UnicodeStringParameterMask &amp; 1&lt;&lt;Counter ) {
00121             strcat(DefaultFormatBuffer,<span class="stringliteral">" %s"</span>);
00122             <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>(&amp;AnsiString,(PUNICODE_STRING)Parameters[Counter],<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00123             ParameterVector[Counter] = (ULONG_PTR)AnsiString.Buffer;
00124             }
00125         <span class="keywordflow">else</span> {
00126             strcat(DefaultFormatBuffer,<span class="stringliteral">" %x"</span>);
00127             }
00128         }
00129     strcat(DefaultFormatBuffer,<span class="stringliteral">"\n"</span>);
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// HELP where do I get the resource from !</span>
00133     <span class="comment">//</span>
00134 
00135     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a8">PsSystemDllDllBase</a> ) {
00136 
00137         <span class="keywordflow">try</span> {
00138 
00139             <span class="comment">//</span>
00140             <span class="comment">// If we are on a DBCS code page, we have to use ENGLISH resource</span>
00141             <span class="comment">// instead of default resource because HalDisplayString() can only</span>
00142             <span class="comment">// display ASCII characters on the blue screen.</span>
00143             <span class="comment">//</span>
00144 
00145             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a>(<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a8">PsSystemDllDllBase</a>,
00146                                     11,
00147                                     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a19">NlsMbCodePageTag</a> ?
00148                                     MAKELANGID(LANG_ENGLISH,SUBLANG_ENGLISH_US) :
00149                                     0,
00150                                     ErrorStatus,
00151                                     &amp;MessageEntry);
00152 
00153             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00154                 ErrorCaption = ErrorFormatString = UnknownHardError;
00155                 }
00156             <span class="keywordflow">else</span> {
00157                 <span class="keywordflow">if</span> (MessageEntry-&gt;Flags &amp; MESSAGE_RESOURCE_UNICODE) {
00158 
00159                     <span class="comment">//</span>
00160                     <span class="comment">// Message resource is Unicode.  Convert to ANSI</span>
00161                     <span class="comment">//</span>
00162 
00163                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Ustr, (PCWSTR)MessageEntry-&gt;Text);
00164                     Astr.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) RtlUnicodeStringToAnsiSize(&amp;Ustr);
00165                     ErrorCaption = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,Astr.Length+16, ' rrE');
00166 
00167                     <span class="keywordflow">if</span> (ErrorCaption) {
00168                         Astr.MaximumLength = Astr.Length + 16;
00169                         Astr.Buffer = ErrorCaption;
00170                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>(&amp;Astr, &amp;Ustr, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00171                         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00172                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ErrorCaption);
00173                             ErrorCaption = ErrorFormatString = UnknownHardError;
00174                             }
00175                         }
00176                     <span class="keywordflow">else</span> {
00177                         ErrorCaption = ErrorFormatString = UnknownHardError;
00178                         }
00179 
00180                     }
00181                 <span class="keywordflow">else</span> {
00182                     ErrorCaption = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(MessageEntry-&gt;Text)+16, ' rrE');
00183                     <span class="keywordflow">if</span> ( ErrorCaption ) {
00184                         strcpy(ErrorCaption,MessageEntry-&gt;Text);
00185                         }
00186                     <span class="keywordflow">else</span> {
00187                         ErrorCaption = ErrorFormatString = UnknownHardError;
00188                         }
00189                     }
00190 
00191                 <span class="keywordflow">if</span> (ErrorCaption != UnknownHardError) {
00192                     <span class="comment">//</span>
00193                     <span class="comment">// It's assumed the Error String from the message table is in the format:</span>
00194                     <span class="comment">// {ErrorCaption}\r\n\0ErrorFormatString\0.  Parse out the caption.</span>
00195                     <span class="comment">//</span>
00196                     ErrorFormatString = ErrorCaption;
00197                     Counter = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(ErrorCaption);
00198                     <span class="keywordflow">while</span> ( Counter &amp;&amp; *ErrorFormatString &gt;= <span class="charliteral">' '</span> ) {
00199                         ErrorFormatString++;
00200                         Counter--;
00201                         }
00202 
00203                     *ErrorFormatString++ = <span class="charliteral">'\0'</span>;
00204                     Counter--;
00205 
00206                     <span class="keywordflow">while</span> ( Counter &amp;&amp; *ErrorFormatString &amp;&amp; *ErrorFormatString &lt;= <span class="charliteral">' '</span>) {
00207                         ErrorFormatString++;
00208                         Counter--;
00209                         }
00210                     }
00211 
00212                     <span class="keywordflow">if</span> (!Counter) {
00213                         <span class="comment">// Oops - Bad Format String.</span>
00214                         ErrorFormatString = <span class="stringliteral">""</span>;
00215                     }
00216                 }
00217             }
00218         except ( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00219             ErrorFormatString = UnknownHardError;
00220             ErrorCaption = UnknownHardError;
00221             }
00222         }
00223     <span class="keywordflow">else</span> {
00224         ErrorFormatString = DefaultFormatBuffer;
00225         ErrorCaption = UnknownHardError;
00226         }
00227 
00228     <span class="keywordflow">try</span> {
00229         _snprintf( ExpSystemErrorBuffer, <span class="keyword">sizeof</span>( ExpSystemErrorBuffer ),
00230                    <span class="stringliteral">"\nSTOP: %lx %s\n"</span>, ErrorStatus,ErrorCaption);
00231         }
00232     except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00233         _snprintf( ExpSystemErrorBuffer, <span class="keyword">sizeof</span>( ExpSystemErrorBuffer ),
00234                    <span class="stringliteral">"\nHardError %lx\n"</span>, ErrorStatus);
00235         }
00236 
00237     UnlockHandle = MmLockPagableCodeSection((PVOID)<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a10">ExpSystemErrorHandler</a>);
00238     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(UnlockHandle);
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// take the caption and convert it to OEM</span>
00242     <span class="comment">//</span>
00243 
00244     OemCaption = UnknownHardError;
00245     OemMessage = UnknownHardError;
00246 
00247     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;Astr,ExpSystemErrorBuffer);
00248     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;Ustr,&amp;Astr,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00249     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00250         <span class="keywordflow">goto</span> punt1;
00251         }
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">// Allocate the OEM string out of nonpaged pool so that bugcheck</span>
00255     <span class="comment">// can read it.</span>
00256     <span class="comment">//</span>
00257     Ostr.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)RtlUnicodeStringToOemSize(&amp;Ustr);
00258     Ostr.MaximumLength = Ostr.Length;
00259     Ostr.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, Ostr.Length, ' rrE');
00260     OemCaption = Ostr.Buffer;
00261     <span class="keywordflow">if</span> (Ostr.Buffer) {
00262         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a26">RtlUnicodeStringToOemString</a>(&amp;Ostr,&amp;Ustr,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00263         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00264             <span class="keywordflow">goto</span> punt1;
00265             }
00266         }
00267 
00268     <span class="comment">//</span>
00269     <span class="comment">// Can't do much of anything after calling HalDisplayString...</span>
00270     <span class="comment">//</span>
00271 
00272 punt1:;
00273     <span class="keywordflow">try</span> {
00274         _snprintf( ExpSystemErrorBuffer, <span class="keyword">sizeof</span>( ExpSystemErrorBuffer ),
00275                    ErrorFormatString,
00276                    ParameterVector[0],
00277                    ParameterVector[1],
00278                    ParameterVector[2],
00279                    ParameterVector[3]
00280                  );
00281         }
00282     except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00283         _snprintf( ExpSystemErrorBuffer, <span class="keyword">sizeof</span>( ExpSystemErrorBuffer ),
00284                    <span class="stringliteral">"Exception Processing Message %lx Parameters %lx %lx %lx %lx"</span>,
00285                    ErrorStatus,
00286                    ParameterVector[0],
00287                    ParameterVector[1],
00288                    ParameterVector[2],
00289                    ParameterVector[3]
00290                  );
00291         }
00292 
00293 
00294     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;Astr,ExpSystemErrorBuffer);
00295     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;Ustr,&amp;Astr,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00296     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00297         <span class="keywordflow">goto</span> punt2;
00298         }
00299     <span class="comment">//</span>
00300     <span class="comment">// Allocate the OEM string out of nonpaged pool so that bugcheck</span>
00301     <span class="comment">// can read it.</span>
00302     <span class="comment">//</span>
00303     Ostr.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)RtlUnicodeStringToOemSize(&amp;Ustr);
00304     Ostr.MaximumLength = Ostr.Length;
00305     Ostr.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, Ostr.Length, ' rrE');
00306     OemMessage = Ostr.Buffer;
00307     <span class="keywordflow">if</span> (Ostr.Buffer) {
00308         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a26">RtlUnicodeStringToOemString</a>(&amp;Ostr,&amp;Ustr,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00309         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00310             <span class="keywordflow">goto</span> punt2;
00311             }
00312         }
00313 
00314 punt2:;
00315     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(PVOID) == <span class="keyword">sizeof</span>(ULONG_PTR));
00316     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(ULONG) == <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>));
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// We don't come back from here.</span>
00320     <span class="comment">//</span>
00321 
00322     <span class="keywordflow">if</span> (CallShutdown) {
00323 
00324         <a class="code" href="../../d1/d2/po_8h.html#a66">PoShutdownBugCheck</a>(
00325             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00326             FATAL_UNHANDLED_HARD_ERROR,
00327             (ULONG)ErrorStatus,
00328             (ULONG_PTR)&amp;(ParameterVector[0]),
00329             (ULONG_PTR)OemCaption,
00330             (ULONG_PTR)OemMessage
00331             );
00332 
00333         }
00334     <span class="keywordflow">else</span> {
00335 
00336         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
00337             FATAL_UNHANDLED_HARD_ERROR,
00338             (ULONG)ErrorStatus,
00339             (ULONG_PTR)&amp;(ParameterVector[0]),
00340             (ULONG_PTR)OemCaption,
00341             (ULONG_PTR)OemMessage
00342             );
00343 
00344         }
00345 
00346 }
00347 
00348 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00349"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a9">00349</a> <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a9">ExpRaiseHardError</a>(
00350     IN NTSTATUS ErrorStatus,
00351     IN ULONG NumberOfParameters,
00352     IN ULONG UnicodeStringParameterMask,
00353     IN PULONG_PTR Parameters,
00354     IN ULONG ValidResponseOptions,
00355     OUT PULONG Response
00356     )
00357 {
00358 
00359     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00360     ULONG_PTR MessageBuffer[PORT_MAXIMUM_MESSAGE_LENGTH/<span class="keyword">sizeof</span>(ULONG_PTR)];
00361     PHARDERROR_MSG m;
00362     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00363     HANDLE ErrorPort;
00364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00365 
00366     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00367 
00368     m = (PHARDERROR_MSG)&amp;MessageBuffer[0];
00369     PreviousMode = KeGetPreviousMode();
00370 
00371     <span class="keywordflow">if</span> (ValidResponseOptions == OptionShutdownSystem) {
00372         <span class="comment">//</span>
00373         <span class="comment">// Check to see if the caller has the privilege to make this</span>
00374         <span class="comment">// call.</span>
00375         <span class="comment">//</span>
00376 
00377 
00378         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a96">SeShutdownPrivilege</a>, PreviousMode )) {
00379             <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
00380             }
00381 
00382         <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00383         }
00384 
00385     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// If the default handler is not installed, then</span>
00389     <span class="comment">// call the fatal hard error handler if the error</span>
00390     <span class="comment">// status is error</span>
00391     <span class="comment">//</span>
00392     <span class="comment">// Let GDI override this since it does not want to crash the machine</span>
00393     <span class="comment">// when a bad driver was loaded via MmLoadSystemImage.</span>
00394     <span class="comment">//</span>
00395 
00396     <span class="keywordflow">if</span> ( !(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HardErrorsAreDisabled) ) {
00397 
00398         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(ErrorStatus)){
00399             <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a10">ExpSystemErrorHandler</a>(
00400                 ErrorStatus,
00401                 NumberOfParameters,
00402                 UnicodeStringParameterMask,
00403                 Parameters,
00404                 (BOOLEAN)((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00405                 );
00406             }
00407         }
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// If the process has an error port, then if it wants default</span>
00411     <span class="comment">// handling, use its port. If it disabled default handling, then</span>
00412     <span class="comment">// return the error to the caller. If the process does not</span>
00413     <span class="comment">// have a port, then use the registered default handler.</span>
00414     <span class="comment">//</span>
00415 
00416     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o19">ExceptionPort</a> ) {
00417         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o55">DefaultHardErrorProcessing</a> &amp; 1 ) {
00418             ErrorPort = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o19">ExceptionPort</a>;
00419             }
00420         <span class="keywordflow">else</span> {
00421 
00422             <span class="comment">//</span>
00423             <span class="comment">// if error processing is disabled, check the error override</span>
00424             <span class="comment">// status</span>
00425             <span class="comment">//</span>
00426             <span class="keywordflow">if</span> ( ErrorStatus &amp; HARDERROR_OVERRIDE_ERRORMODE ) {
00427                 ErrorPort = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o19">ExceptionPort</a>;
00428                 }
00429             <span class="keywordflow">else</span> {
00430                 ErrorPort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00431                 }
00432             }
00433         }
00434     <span class="keywordflow">else</span> {
00435         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o55">DefaultHardErrorProcessing</a> &amp; 1 ) {
00436             ErrorPort = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a7">ExpDefaultErrorPort</a>;
00437             }
00438         <span class="keywordflow">else</span> {
00439 
00440             <span class="comment">//</span>
00441             <span class="comment">// if error processing is disabled, check the error override</span>
00442             <span class="comment">// status</span>
00443             <span class="comment">//</span>
00444 
00445             <span class="keywordflow">if</span> ( ErrorStatus &amp; HARDERROR_OVERRIDE_ERRORMODE ) {
00446                 ErrorPort = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a7">ExpDefaultErrorPort</a>;
00447                 }
00448             <span class="keywordflow">else</span> {
00449                 ErrorPort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00450                 }
00451             ErrorPort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00452             }
00453         }
00454 
00455     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HardErrorsAreDisabled ) {
00456         ErrorPort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00457         }
00458 
00459     <span class="keywordflow">if</span> ( !<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) ) {
00460         <span class="keywordflow">try</span> {
00461             PTEB Teb;
00462             Teb = (PTEB)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb.Teb;
00463             <span class="keywordflow">if</span> ( Teb-&gt;HardErrorsAreDisabled ) {
00464                 ErrorPort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00465                 }
00466             }
00467         except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00468             ;
00469             }
00470         }
00471 
00472     <span class="keywordflow">if</span> ( ErrorPort ) {
00473         <span class="keywordflow">if</span> ( Process == <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a> ) {
00474             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(ErrorStatus) ) {
00475                 <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a10">ExpSystemErrorHandler</a>(
00476                     ErrorStatus,
00477                     NumberOfParameters,
00478                     UnicodeStringParameterMask,
00479                     Parameters,
00480                     (BOOLEAN)((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00481                     );
00482                 }
00483             *Response = (ULONG)ResponseReturnToCaller;
00484             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00485             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00486             }
00487         m-&gt;h.u1.Length = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a1">HARDERROR_API_MSG_LENGTH</a>;
00488         m-&gt;h.u2.ZeroInit = LPC_ERROR_EVENT;
00489         m-&gt;Status = ErrorStatus &amp; ~HARDERROR_OVERRIDE_ERRORMODE;
00490         m-&gt;ValidResponseOptions = ValidResponseOptions;
00491         m-&gt;UnicodeStringParameterMask = UnicodeStringParameterMask;
00492         m-&gt;NumberOfParameters = NumberOfParameters;
00493         <span class="keywordflow">if</span> ( Parameters ) {
00494             RtlMoveMemory(&amp;m-&gt;Parameters,Parameters, <span class="keyword">sizeof</span>(ULONG_PTR)*NumberOfParameters);
00495             }
00496         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;m-&gt;ErrorTime);
00497 
00498         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/lpcsend_8c.html#a3">LpcRequestWaitReplyPort</a>(
00499                     ErrorPort,
00500                     (PPORT_MESSAGE) m,
00501                     (PPORT_MESSAGE) m
00502                     );
00503         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00504             <span class="keywordflow">switch</span> ( m-&gt;Response ) {
00505                 <span class="keywordflow">case</span> ResponseReturnToCaller :
00506                 <span class="keywordflow">case</span> ResponseNotHandled :
00507                 <span class="keywordflow">case</span> ResponseAbort :
00508                 <span class="keywordflow">case</span> ResponseCancel :
00509                 <span class="keywordflow">case</span> ResponseIgnore :
00510                 <span class="keywordflow">case</span> ResponseNo :
00511                 <span class="keywordflow">case</span> ResponseOk :
00512                 <span class="keywordflow">case</span> ResponseRetry :
00513                 <span class="keywordflow">case</span> ResponseYes :
00514                 <span class="keywordflow">case</span> ResponseTryAgain :
00515                 <span class="keywordflow">case</span> ResponseContinue :
00516                     <span class="keywordflow">break</span>;
00517                 <span class="keywordflow">default</span>:
00518                     m-&gt;Response = (ULONG)ResponseReturnToCaller;
00519                     <span class="keywordflow">break</span>;
00520                 }
00521             *Response = m-&gt;Response;
00522             }
00523         }
00524     <span class="keywordflow">else</span> {
00525         *Response = (ULONG)ResponseReturnToCaller;
00526         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00527         }
00528     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00529 }
00530 
00531 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00532"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">00532</a> <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
00533     IN NTSTATUS ErrorStatus,
00534     IN ULONG NumberOfParameters,
00535     IN ULONG UnicodeStringParameterMask,
00536     IN PULONG_PTR Parameters,
00537     IN ULONG ValidResponseOptions,
00538     OUT PULONG Response
00539     )
00540 {
00541     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00542     PULONG_PTR CapturedParameters;
00543     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00544     ULONG LocalResponse;
00545     UNICODE_STRING CapturedString;
00546     ULONG Counter;
00547 
00548     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00549 
00550     <span class="keywordflow">if</span> ( NumberOfParameters &gt; MAXIMUM_HARDERROR_PARAMETERS ) {
00551         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00552     }
00553 
00554     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(Parameters) &amp;&amp; NumberOfParameters == 0 ) {
00555         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00556     }
00557 
00558     PreviousMode = KeGetPreviousMode();
00559     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00560         <span class="keywordflow">switch</span> ( ValidResponseOptions ) {
00561             <span class="keywordflow">case</span> OptionAbortRetryIgnore :
00562             <span class="keywordflow">case</span> OptionOk :
00563             <span class="keywordflow">case</span> OptionOkCancel :
00564             <span class="keywordflow">case</span> OptionRetryCancel :
00565             <span class="keywordflow">case</span> OptionYesNo :
00566             <span class="keywordflow">case</span> OptionYesNoCancel :
00567             <span class="keywordflow">case</span> OptionShutdownSystem :
00568             <span class="keywordflow">case</span> OptionOkNoWait :
00569             <span class="keywordflow">case</span> OptionCancelTryContinue:
00570                 <span class="keywordflow">break</span>;
00571             <span class="keywordflow">default</span> :
00572                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00573             }
00574 
00575         CapturedParameters = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00576         <span class="keywordflow">try</span> {
00577             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(Response);
00578 
00579             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(Parameters) ) {
00580                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00581                     Parameters,
00582                     <span class="keyword">sizeof</span>(ULONG_PTR)*NumberOfParameters,
00583                     <span class="keyword">sizeof</span>(ULONG_PTR)
00584                     );
00585                 CapturedParameters = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,<span class="keyword">sizeof</span>(ULONG_PTR)*NumberOfParameters, ' rrE');
00586                 <span class="keywordflow">if</span> ( !CapturedParameters ) {
00587                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00588                     }
00589                 RtlMoveMemory(CapturedParameters,Parameters,<span class="keyword">sizeof</span>(ULONG_PTR)*NumberOfParameters);
00590 
00591                 <span class="comment">//</span>
00592                 <span class="comment">// probe all strings</span>
00593                 <span class="comment">//</span>
00594 
00595                 <span class="keywordflow">if</span> ( UnicodeStringParameterMask ) {
00596                     <span class="keywordflow">for</span>(Counter=0;Counter &lt; NumberOfParameters;Counter++){
00597 
00598                         <span class="comment">//</span>
00599                         <span class="comment">// if there is a string in this position,</span>
00600                         <span class="comment">// then probe and capture the string</span>
00601                         <span class="comment">//</span>
00602 
00603                         <span class="keywordflow">if</span> ( UnicodeStringParameterMask &amp; (1&lt;&lt;Counter) ) {
00604                             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00605                                 (PVOID)CapturedParameters[Counter],
00606                                 <span class="keyword">sizeof</span>(UNICODE_STRING),
00607                                 <span class="keyword">sizeof</span>(ULONG_PTR)
00608                                 );
00609                             RtlMoveMemory(
00610                                 &amp;CapturedString,
00611                                 (PVOID)CapturedParameters[Counter],
00612                                 <span class="keyword">sizeof</span>(UNICODE_STRING)
00613                                 );
00614 
00615                             <span class="comment">//</span>
00616                             <span class="comment">// Now probe the string</span>
00617                             <span class="comment">//</span>
00618 
00619                             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00620                                 CapturedString.Buffer,
00621                                 CapturedString.MaximumLength,
00622                                 <span class="keyword">sizeof</span>(UCHAR)
00623                                 );
00624 
00625                             }
00626                         }
00627                     }
00628                 }
00629             <span class="keywordflow">else</span> {
00630                 CapturedParameters = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00631                 }
00632             }
00633         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00634             <span class="keywordflow">if</span> ( CapturedParameters ) {
00635                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CapturedParameters);
00636                 }
00637             <span class="keywordflow">return</span> GetExceptionCode();
00638             }
00639 
00640         <span class="keywordflow">if</span> (ErrorStatus == STATUS_SYSTEM_IMAGE_BAD_SIGNATURE &amp;&amp; <a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a>) {
00641             <span class="keywordflow">if</span> (NumberOfParameters &amp;&amp; CapturedParameters) {
00642                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"****************************************************************\n"</span>);
00643                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"* The system detected a bad signature on file %wZ\n"</span>,(PUNICODE_STRING)CapturedParameters[0]);
00644                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"****************************************************************\n"</span>);
00645             }
00646             <span class="keywordflow">if</span> (CapturedParameters) {
00647                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CapturedParameters);
00648             }
00649             <span class="keywordflow">return</span> STATUS_SUCCESS;
00650         }
00651 
00652         <span class="comment">//</span>
00653         <span class="comment">// Call ExpRaiseHardError. All parameters are probed and everything</span>
00654         <span class="comment">// should be user-mode.</span>
00655         <span class="comment">// ExRaiseHardError will squirt all strings into user-mode</span>
00656         <span class="comment">// without any probing</span>
00657         <span class="comment">//</span>
00658 
00659         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a9">ExpRaiseHardError</a>(
00660                     ErrorStatus,
00661                     NumberOfParameters,
00662                     UnicodeStringParameterMask,
00663                     CapturedParameters,
00664                     ValidResponseOptions,
00665                     &amp;LocalResponse
00666                     );
00667         }
00668     <span class="keywordflow">else</span> {
00669         CapturedParameters = Parameters;
00670 
00671         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>(
00672                     ErrorStatus,
00673                     NumberOfParameters,
00674                     UnicodeStringParameterMask,
00675                     CapturedParameters,
00676                     ValidResponseOptions,
00677                     &amp;LocalResponse
00678                     );
00679         }
00680 
00681     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00682         <span class="keywordflow">if</span> ( CapturedParameters ) {
00683             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CapturedParameters);
00684             }
00685         <span class="keywordflow">try</span> {
00686             *Response = LocalResponse;
00687             }
00688         except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00689             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00690             }
00691         }
00692     <span class="keywordflow">else</span> {
00693         *Response = LocalResponse;
00694         }
00695 
00696     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00697 }
00698 
00699 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00700"></a><a class="code" href="../../d5/d8/ex_8h.html#a306">00700</a> <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>(
00701     IN NTSTATUS ErrorStatus,
00702     IN ULONG NumberOfParameters,
00703     IN ULONG UnicodeStringParameterMask,
00704     IN PULONG_PTR Parameters,
00705     IN ULONG ValidResponseOptions,
00706     OUT PULONG Response
00707     )
00708 {
00709     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00710     PULONG_PTR ParameterBlock;
00711     PULONG_PTR UserModeParameterBase;
00712     PUNICODE_STRING UserModeStringsBase;
00713     PUCHAR UserModeStringDataBase;
00714     UNICODE_STRING CapturedStrings[MAXIMUM_HARDERROR_PARAMETERS];
00715     ULONG LocalResponse;
00716     ULONG Counter;
00717     SIZE_T UserModeSize;
00718 
00719     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00720 
00721     <span class="comment">//</span>
00722     <span class="comment">//  If we are in the process of shuting down the system, do not allow</span>
00723     <span class="comment">//  hard errors.</span>
00724     <span class="comment">//</span>
00725 
00726     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a6">ExpTooLateForErrors</a> ) {
00727 
00728         *Response = ResponseNotHandled;
00729 
00730         <span class="keywordflow">return</span> STATUS_SUCCESS;
00731     }
00732 
00733     <span class="comment">//</span>
00734     <span class="comment">// If the parameters contain strings, we need to capture</span>
00735     <span class="comment">// the strings and the string descriptors and push them into</span>
00736     <span class="comment">// user-mode.</span>
00737     <span class="comment">//</span>
00738 
00739     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(Parameters) ) {
00740         <span class="keywordflow">if</span> ( UnicodeStringParameterMask ) {
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">// We have strings. The parameter block and all strings</span>
00744             <span class="comment">// must be pushed into usermode.</span>
00745             <span class="comment">//</span>
00746 
00747             UserModeSize = (<span class="keyword">sizeof</span>(ULONG_PTR)+<span class="keyword">sizeof</span>(UNICODE_STRING))*MAXIMUM_HARDERROR_PARAMETERS;
00748             UserModeSize += <span class="keyword">sizeof</span>(UNICODE_STRING);
00749 
00750             <span class="keywordflow">for</span>(Counter=0;Counter &lt; NumberOfParameters;Counter++){
00751 
00752                 <span class="comment">//</span>
00753                 <span class="comment">// if there is a string in this position,</span>
00754                 <span class="comment">// then probe and capture the string</span>
00755                 <span class="comment">//</span>
00756 
00757                 <span class="keywordflow">if</span> ( UnicodeStringParameterMask &amp; 1&lt;&lt;Counter ) {
00758 
00759                     RtlMoveMemory(
00760                         &amp;CapturedStrings[Counter],
00761                         (PVOID)Parameters[Counter],
00762                         <span class="keyword">sizeof</span>(UNICODE_STRING)
00763                         );
00764 
00765                     UserModeSize += CapturedStrings[Counter].MaximumLength;
00766 
00767                     }
00768                 }
00769 
00770             <span class="comment">//</span>
00771             <span class="comment">// Now we have the user-mode size all figured out.</span>
00772             <span class="comment">// Allocate some memory and point to it with the</span>
00773             <span class="comment">// parameter block. Then go through and copy all</span>
00774             <span class="comment">// of the parameters, string descriptors, and</span>
00775             <span class="comment">// string data into the memory</span>
00776             <span class="comment">//</span>
00777 
00778             ParameterBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00779             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(
00780                         NtCurrentProcess(),
00781                         (PVOID *)&amp;ParameterBlock,
00782                         0,
00783                         &amp;UserModeSize,
00784                         MEM_COMMIT,
00785                         PAGE_READWRITE
00786                         );
00787 
00788             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00789                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00790                 }
00791 
00792             UserModeParameterBase = ParameterBlock;
00793             UserModeStringsBase = (PUNICODE_STRING)((PUCHAR)ParameterBlock + <span class="keyword">sizeof</span>(ULONG)*MAXIMUM_HARDERROR_PARAMETERS);
00794             UserModeStringDataBase = (PUCHAR)UserModeStringsBase + <span class="keyword">sizeof</span>(UNICODE_STRING)*MAXIMUM_HARDERROR_PARAMETERS;
00795 
00796             <span class="keywordflow">for</span>(Counter=0;Counter &lt; NumberOfParameters;Counter++){
00797 
00798                 <span class="comment">//</span>
00799                 <span class="comment">// move parameters to user-mode portion of the</span>
00800                 <span class="comment">// address space.</span>
00801                 <span class="comment">//</span>
00802 
00803                 <span class="keywordflow">if</span> ( UnicodeStringParameterMask &amp; 1&lt;&lt;Counter ) {
00804 
00805                     <span class="comment">//</span>
00806                     <span class="comment">// fix the parameter to point at the string descriptor slot</span>
00807                     <span class="comment">// in the user-mode buffer.</span>
00808                     <span class="comment">//</span>
00809 
00810                     UserModeParameterBase[Counter] = (ULONG_PTR)&amp;UserModeStringsBase[Counter];
00811 
00812                     <span class="comment">//</span>
00813                     <span class="comment">// Copy the string data to user-mode</span>
00814                     <span class="comment">//</span>
00815 
00816                     RtlMoveMemory(
00817                         UserModeStringDataBase,
00818                         CapturedStrings[Counter].<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00819                         CapturedStrings[Counter].MaximumLength
00820                         );
00821 
00822                     CapturedStrings[Counter].Buffer = (PWSTR)UserModeStringDataBase;
00823 
00824                     <span class="comment">//</span>
00825                     <span class="comment">// copy the string descriptor</span>
00826                     <span class="comment">//</span>
00827 
00828                     RtlMoveMemory(
00829                         &amp;UserModeStringsBase[Counter],
00830                         &amp;CapturedStrings[Counter],
00831                         <span class="keyword">sizeof</span>(UNICODE_STRING)
00832                         );
00833 
00834                     <span class="comment">//</span>
00835                     <span class="comment">// Adjust the string data base</span>
00836                     <span class="comment">//</span>
00837 
00838                     UserModeStringDataBase += CapturedStrings[Counter].MaximumLength;
00839 
00840                     }
00841                 <span class="keywordflow">else</span> {
00842                     UserModeParameterBase[Counter] = Parameters[Counter];
00843                     }
00844                 }
00845             }
00846         <span class="keywordflow">else</span> {
00847             ParameterBlock = Parameters;
00848             }
00849         }
00850     <span class="keywordflow">else</span> {
00851         ParameterBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00852         }
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">// Call the hard error sender.</span>
00856     <span class="comment">//</span>
00857 
00858     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a9">ExpRaiseHardError</a>(
00859                 ErrorStatus,
00860                 NumberOfParameters,
00861                 UnicodeStringParameterMask,
00862                 ParameterBlock,
00863                 ValidResponseOptions,
00864                 &amp;LocalResponse
00865                 );
00866     <span class="comment">//</span>
00867     <span class="comment">// If the parameter block was allocated, it needs to be</span>
00868     <span class="comment">// freed</span>
00869     <span class="comment">//</span>
00870 
00871     <span class="keywordflow">if</span> ( ParameterBlock &amp;&amp; ParameterBlock != Parameters ) {
00872         UserModeSize = 0;
00873         ZwFreeVirtualMemory(
00874               NtCurrentProcess(),
00875               (PVOID *)&amp;ParameterBlock,
00876               &amp;UserModeSize,
00877               MEM_RELEASE
00878               );
00879         }
00880     *Response = LocalResponse;
00881 
00882     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00883 }
00884 
00885 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00886"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a13">00886</a> <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a13">NtSetDefaultHardErrorPort</a>(
00887     IN HANDLE DefaultHardErrorPort
00888     )
00889 {
00890     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00891 
00892     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00893 
00894     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>, KeGetPreviousMode() )) {
00895         <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
00896         }
00897 
00898     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a> ) {
00899         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00900         }
00901 
00902     <span class="comment">//</span>
00903     <span class="comment">// Priv check ?</span>
00904     <span class="comment">//</span>
00905 
00906     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
00907                 DefaultHardErrorPort,
00908                 0,
00909                 <a class="code" href="../../d9/d8/ntos_8h.html#a5">LpcPortObjectType</a>,
00910                 KeGetPreviousMode(),
00911                 (PVOID *)&amp;<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a7">ExpDefaultErrorPort</a>,
00912                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00913                 );
00914     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00915         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00916         }
00917 
00918     <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00919     <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00920 
00921     <span class="keywordflow">return</span> STATUS_SUCCESS;
00922 }
00923 
00924 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00925 __cdecl
<a name="l00926"></a><a class="code" href="../../d6/d8/ex_2harderr_8c.html#a14">00926</a> <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a14">_purecall</a>()
00927 {
00928     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"_purecall() was called"</span>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00929     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_NOT_IMPLEMENTED);
00930 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
