<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntapi.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntapi.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>
<code>#include "safeboot.h"</code><br>
<code>#include &lt;evntrace.h&gt;</code><br>

<p>
<a href="../../d8/d6/ntapi_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(a, b, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>)&nbsp;&nbsp;&nbsp;ExAllocatePoolWithQuota((a)|POOL_QUOTA_FAIL_INSTEAD_OF_RAISE,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a1">CmpExceptionFilter</a>(x)&nbsp;&nbsp;&nbsp;EXCEPTION_EXECUTE_HANDLER</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>&nbsp;&nbsp;&nbsp;0x00000004L</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a10">CmpNameFromAttributes</a> (IN POBJECT_ATTRIBUTES Attributes, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PUNICODE_STRING FullName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a11">CmpCheckLockExceptionFilter</a> (IN PEXCEPTION_POINTERS ExceptionPointers)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a12">CmpEnumKeyObjectCallback</a> (IN PVOID Object, IN PUNICODE_STRING ObjectName, IN ULONG HandleCount, IN ULONG PointerCount, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a13">CmpDummyApc</a> (struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc, PVOID *SystemArgument1, PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (OUT PHANDLE KeyHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, IN ULONG TitleIndex, IN PUNICODE_STRING Class OPTIONAL, IN ULONG CreateOptions, OUT PULONG Disposition OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a15">NtDeleteKey</a> (IN HANDLE KeyHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a> (IN HANDLE KeyHandle, IN PUNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a17">NtEnumerateKey</a> (IN HANDLE KeyHandle, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, IN KEY_INFORMATION_CLASS KeyInformationClass, IN PVOID KeyInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a> (IN HANDLE KeyHandle, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, IN PVOID KeyValueInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a19">NtFlushKey</a> (IN HANDLE KeyHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a20">NtInitializeRegistry</a> (IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> BootCondition)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a21">NtNotifyChangeKey</a> (IN HANDLE KeyHandle, IN HANDLE Event OPTIONAL, IN PIO_APC_ROUTINE ApcRoutine OPTIONAL, IN PVOID ApcContext OPTIONAL, OUT PIO_STATUS_BLOCK IoStatusBlock, IN ULONG CompletionFilter, IN BOOLEAN <a class="el" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>, OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN BOOLEAN Asynchronous)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a22">NtNotifyChangeMultipleKeys</a> (IN HANDLE MasterKeyHandle, IN ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>, IN OBJECT_ATTRIBUTES SlaveObjects[], IN HANDLE Event OPTIONAL, IN PIO_APC_ROUTINE ApcRoutine OPTIONAL, IN PVOID ApcContext OPTIONAL, OUT PIO_STATUS_BLOCK IoStatusBlock, IN ULONG CompletionFilter, IN BOOLEAN <a class="el" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>, OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN BOOLEAN Asynchronous)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (OUT PHANDLE KeyHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a> (IN HANDLE KeyHandle, IN KEY_INFORMATION_CLASS KeyInformationClass, IN PVOID KeyInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a> (IN HANDLE KeyHandle, IN PUNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, IN PVOID KeyValueInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a26">NtRestoreKey</a> (IN HANDLE KeyHandle, IN HANDLE FileHandle, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a27">NtSaveKey</a> (IN HANDLE KeyHandle, IN HANDLE FileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a28">NtSaveMergedKeys</a> (IN HANDLE HighPrecedenceKeyHandle, IN HANDLE LowPrecedenceKeyHandle, IN HANDLE FileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IN HANDLE KeyHandle, IN PUNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN ULONG TitleIndex OPTIONAL, IN ULONG Type, IN PVOID Data, IN ULONG DataSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a30">NtLoadKey</a> (IN POBJECT_ATTRIBUTES TargetKey, IN POBJECT_ATTRIBUTES SourceFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a31">NtLoadKey2</a> (IN POBJECT_ATTRIBUTES TargetKey, IN POBJECT_ATTRIBUTES SourceFile, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a32">NtUnloadKey</a> (IN POBJECT_ATTRIBUTES TargetKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a33">NtSetInformationKey</a> (IN HANDLE KeyHandle, IN KEY_SET_INFORMATION_CLASS KeySetInformationClass, IN PVOID KeySetInformation, IN ULONG KeySetInformationLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a34">NtReplaceKey</a> (IN POBJECT_ATTRIBUTES NewFile, IN HANDLE TargetHandle, IN POBJECT_ATTRIBUTES OldFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSYSAPI NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a35">NtQueryMultipleValueKey</a> (IN HANDLE KeyHandle, IN PKEY_VALUE_ENTRY ValueEntries, IN ULONG EntryCount, OUT PVOID <a class="el" href="../../d2/d7/regtest_8c.html#a1">ValueBuffer</a>, IN OUT PULONG BufferLength, OUT OPTIONAL PULONG RequiredBufferLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a> (IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a37">CmpAllocatePostBlock</a> (IN <a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a> BlockType, IN ULONG PostFlags, IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody, IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> MasterBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a38">NtQueryOpenSubKeys</a> (IN POBJECT_ATTRIBUTES TargetKey, OUT PULONG HandleCount)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a4">CmpKeyObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a5">CmFirstTime</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a6">CmBootAcceptFirstTime</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a7">CmpTraceFlag</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a> [2]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ntapi.c::ALLOCATE_WITH_QUOTA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALLOCATE_WITH_QUOTA          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePoolWithQuota((a)|POOL_QUOTA_FAIL_INSTEAD_OF_RAISE,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00055">55</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03883">CmpAllocatePostBlock()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03603">CmpNameFromAttributes()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ntapi.c::CmpExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpExceptionFilter          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;EXCEPTION_EXECUTE_HANDLER</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00071">71</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ntapi.c::OBJ_AUDIT_OBJECT_CLOSE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBJ_AUDIT_OBJECT_CLOSE&nbsp;&nbsp;&nbsp;0x00000004L          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00408">408</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00414">NtMakeTemporaryObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00759">ObAuditInheritedHandleProcedure()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, and <a class="el" href="../../d7/d0/obquery_8c-source.html#l01319">ObQueryObjectAuditingByHandle()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a37" doxytag="ntapi.c::CmpAllocatePostBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> CmpAllocatePostBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BlockType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PostFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyBody</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MasterBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03883">3883</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00055">ALLOCATE_WITH_QUOTA</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a175">CM_POST_BLOCK</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a173">CM_POST_BLOCK_UNION</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a162">CM_POST_KEY_BODY</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, and <a class="el" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>.
<p>
<pre class="fragment"><div>03892                    :
03893 
03894     Allocates a post block from <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  The non-pagable stuff comes from
03895     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pagable stuff from paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  Quota will be
03896     charged.
03897 
03898 Arguments:
03899 
03900     BlockType  - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block to be allocated
03901                 i.e. : PostSyncrhronous, <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>
03902 
03903     PostFlags      - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flags to be set on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated post block
03904                 vallid flags:
03905                     - <a class="code" href="../../d1/d2/cmp_8h.html#a87">REG_NOTIFY_MASTER_POST</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block to be allocated
03906                       <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a master post block.
03907     KeyBody     - The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> object to whom <span class="keyword">this</span> post block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attached. On master blocks
03908                   <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>. When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KeyBody object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03909                   dereferenced (<span class="keywordflow">if</span> not NULL - i.e. <span class="keywordflow">for</span> slave blocks). This allow us to
03910                   perform back-end cleanup <span class="keywordflow">for</span> <span class="stringliteral">"fake-slave"</span> keys opened by NtNotifyMultipleKeys
03911     MasterBlock - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> post block to be allocated <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a slave of <span class="keyword">this</span> master block.
03912                   valid <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> when PostFlags ==  <a class="code" href="../../d1/d2/cmp_8h.html#a87">REG_NOTIFY_MASTER_POST</a>
03913 
03914 
03915 Obs: The <a class="code" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a>.SystemEvent and AsyncUser.Apc members are allocated <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">for</span> master post blocks
03916 
03917 Return Value:
03918 
03919     Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a> <span class="keywordflow">if</span> successful
03920 
03921     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> there were not enough resources available.
03922 
03923 --*/
03924 
03925 {
03926     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock;
03927 
03928     <span class="comment">// protection against outrageous calls</span>
03929     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !PostFlags || (!MasterBlock &amp;&amp; !KeyBody) );
03930 
03931     PostBlock = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>),CM_POSTBLOCK_TAG);
03932     <span class="keywordflow">if</span> (PostBlock==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03933         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03934     }
03935 
03936 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
03937 <span class="preprocessor"></span>    RtlZeroMemory((PVOID)PostBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>));
03938 <span class="preprocessor">#endif</span>
03939 <span class="preprocessor"></span>
03940 <span class="preprocessor">#if DBG</span>
03941 <span class="preprocessor"></span>    PostBlock-&gt;TraceIntoDebugger = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03942 <span class="preprocessor">#endif</span>
03943 <span class="preprocessor"></span>
03944     PostBlock-&gt;NotifyType = (ULONG)BlockType;
03945     PostBlock-&gt;NotifyType |= PostFlags;
03946 
03947     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock)) {
03948         PostBlock-&gt;PostKeyBody = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03949         <span class="comment">//</span>
03950         <span class="comment">// master post block ==&gt; allocate the storage</span>
03951         <span class="comment">//</span>
03952         PostBlock-&gt;u = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(NonPagedPool,
03953                                            <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">CM_POST_BLOCK_UNION</a>),
03954                                            CM_POSTBLOCK_TAG);
03955         <span class="keywordflow">if</span> (PostBlock-&gt;u == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03956             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03957             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03958         }
03959 
03960          <span class="keywordflow">switch</span> (BlockType) {
03961             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>:
03962                 PostBlock-&gt;u-&gt;Sync.SystemEvent = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(NonPagedPool,
03963                                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>),
03964                                                                     CM_POSTEVENT_TAG);
03965                 <span class="keywordflow">if</span> (PostBlock-&gt;u-&gt;Sync.SystemEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03966                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u);
03967                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03968                     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03969                 }
03970                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(PostBlock-&gt;u-&gt;Sync.SystemEvent,
03971                                   SynchronizationEvent,
03972                                   FALSE);
03973                 <span class="keywordflow">break</span>;
03974             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>:
03975                 PostBlock-&gt;u-&gt;AsyncUser.Apc = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(NonPagedPool,
03976                                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>),
03977                                                              CM_POSTAPC_TAG);
03978                 <span class="keywordflow">if</span> (PostBlock-&gt;u-&gt;AsyncUser.Apc==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03979                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u);
03980                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03981                     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03982                 }
03983                 <span class="keywordflow">break</span>;
03984             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>:
03985                 RtlZeroMemory(&amp;PostBlock-&gt;u-&gt;AsyncKernel, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">CM_ASYNC_KERNEL_POST_BLOCK</a>));
03986                 <span class="keywordflow">break</span>;
03987         }
03988     } <span class="keywordflow">else</span> {
03989         <span class="comment">//</span>
03990         <span class="comment">// Slave post block ==&gt; copy storage allocated for the master post block</span>
03991         <span class="comment">//</span>
03992         PostBlock-&gt;u = MasterBlock-&gt;u;
03993 
03994         <span class="comment">//</span>
03995         <span class="comment">// allocate a PostKeyBody which will hold this KeyBody, and initialize the head of its KeyBodyList</span>
03996         <span class="comment">//</span>
03997         PostBlock-&gt;PostKeyBody = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">CM_POST_KEY_BODY</a>),CM_POSTBLOCK_TAG);
03998         <span class="keywordflow">if</span> (PostBlock-&gt;PostKeyBody == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03999             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
04000             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04001         }
04002         PostBlock-&gt;PostKeyBody-&gt;KeyBody = KeyBody;
04003         InitializeListHead(&amp;(PostBlock-&gt;PostKeyBody-&gt;KeyBodyList));
04004     }
04005 
04006     <span class="keywordflow">return</span>(PostBlock);
04007 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ntapi.c::CmpCheckLockExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpCheckLockExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionPointers</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00081">81</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, and <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>.
<p>
<pre class="fragment"><div>00084 {
00085     KdPrint((<span class="stringliteral">"CM: Registry exception %lx, ExceptionPointers = %lx\n"</span>,
00086             ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00087             ExceptionPointers));
00088 
00089     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,12,
00090         (ULONG_PTR)ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00091         (ULONG_PTR)ExceptionPointers-&gt;ExceptionRecord,
00092         (ULONG_PTR)ExceptionPointers-&gt;ContextRecord);
00093 
00094     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00095 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ntapi.c::CmpDummyApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDummyApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">struct <a class="el" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ntapi.c::CmpEnumKeyObjectCallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpEnumKeyObjectCallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04059">4059</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04054">CmpOpenSubKeys</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00494">_CM_KEY_BODY::Process</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>.
<p>
<pre class="fragment"><div>04066 {
04067     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>    KeyBody;
04068     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
04069 
04070     KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object;
04071     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)Context;
04072 
04073     <span class="keywordflow">if</span>( KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> == <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> ) {
04074         <span class="comment">//</span>
04075         <span class="comment">// that's and open subkey inside of the hive</span>
04076         <span class="comment">//</span>
04077         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Key %wZ (HandleCount = %lu PointerCount = %lu) is opened by process %lx\n"</span>,
04078                         ObjectName,HandleCount,PointerCount,KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o3">Process</a>);
04079 
04080         <span class="comment">// count it</span>
04081         <a class="code" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a>++;
04082     }
04083 
04084     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04085 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="ntapi.c::CmpFreePostBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreePostBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PostBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">3764</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a175">CM_POST_BLOCK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00054">CmpClearListEntry</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00266">CMS_NOTIFY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00632">IsMasterPostBlock</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00630">PostBlockType</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00625">REG_NOTIFY_MASTER_POST</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01634">CmpFreeSlavePost()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">CmpPostApcRunDown()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>.
<p>
<pre class="fragment"><div>03770                    :
03771 
03772     Frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> various bits of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> that were allocated <span class="keywordflow">for</span> a postblock
03773 
03774 Arguments:
03775 
03776     None
03777 
03778 Return Value:
03779 
03780     None.
03781 
03782 --*/
03783 
03784 {
03785 
03786     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) {
03787 <span class="preprocessor">#if DBG</span>
03788 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
03789             KdPrint((<span class="stringliteral">"[CM]CmpFreePostBlock: PostBlock:%08lx\t"</span>, PostBlock));
03790             <span class="keywordflow">if</span>( PostBlock-&gt;NotifyType&amp;<a class="code" href="../../d1/d2/cmp_8h.html#a87">REG_NOTIFY_MASTER_POST</a>) {
03791                 KdPrint((<span class="stringliteral">"--MasterBlock\n"</span>));
03792             } <span class="keywordflow">else</span> {
03793                 KdPrint((<span class="stringliteral">"--SlaveBlock\n"</span>));
03794             }
03795         }
03796 <span class="preprocessor">#endif</span>
03797 <span class="preprocessor"></span>    }
03798 
03799 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
03800 <span class="preprocessor"></span>    <span class="comment">// check if the post block has been removed from the notify and thread list(s)</span>
03801     <span class="keywordflow">if</span>((PostBlock-&gt;NotifyList.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PostBlock-&gt;NotifyList.Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03802         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFreePostBlock: Attempt to free post block %08lx not removed from notify list\n"</span>,PostBlock);
03803         DbgBreakPoint();
03804     }
03805     <span class="keywordflow">if</span>((PostBlock-&gt;ThreadList.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PostBlock-&gt;ThreadList.Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03806         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFreePostBlock: Attempt to free post block %08lx not removed from thread list\n"</span>,PostBlock);
03807         DbgBreakPoint();
03808     }
03809 
03810 <span class="preprocessor">#endif</span>
03811 <span class="preprocessor"></span>
03812     <span class="comment">// Protect for multiple deletion of the same object</span>
03813     <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(PostBlock-&gt;CancelPostList));
03814 
03815     <span class="comment">//</span>
03816     <span class="comment">// Cleanup for objects referenced by NtNotifyMultipleKeys</span>
03817     <span class="comment">//</span>
03818     <span class="keywordflow">if</span>( PostBlock-&gt;PostKeyBody) {
03819 
03820         <span class="comment">//</span>
03821         <span class="comment">// If we have a PostKeyBody, the attached key body must not be NULL</span>
03822         <span class="comment">//</span>
03823         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostBlock-&gt;PostKeyBody-&gt;KeyBody);
03824 
03825         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_NOTIFY) {
03826 <span class="preprocessor">#if DBG</span>
03827 <span class="preprocessor"></span>            WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03828             UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
03829 
03830             KdPrint((<span class="stringliteral">"[CM]\tCmpFreePostBlock: Dereferencing KeyBody:%08lx\n"</span>, PostBlock-&gt;PostKeyBody-&gt;KeyBody));
03831             NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
03832             <span class="keywordflow">if</span>(NameBuffer) {
03833                <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(PostBlock-&gt;PostKeyBody-&gt;KeyBody-&gt;KeyControlBlock-&gt;KeyNode,&amp;KeyName,NameBuffer);
03834                KdPrint((<span class="stringliteral">"[CM]\tCmpFreePostBlock: KeyName:tKey = %.*S\n"</span>,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
03835                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
03836             }
03837 <span class="preprocessor">#endif</span>
03838 <span class="preprocessor"></span>        }
03839 
03840         <span class="comment">//</span>
03841         <span class="comment">// KeyBodyList must be used only in CmpPostBlock implementation for the delayed dereferencing mechanism.</span>
03842         <span class="comment">//</span>
03843         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;(PostBlock-&gt;PostKeyBody-&gt;KeyBodyList)));
03844 
03845         <span class="comment">//</span>
03846         <span class="comment">// dereference the actual keybody</span>
03847         <span class="comment">//</span>
03848         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;PostKeyBody-&gt;KeyBody);
03849 
03850         <span class="comment">//</span>
03851         <span class="comment">// Free the PostKeyBody structure</span>
03852         <span class="comment">//</span>
03853         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;PostKeyBody);
03854     }
03855 
03856     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock) ) {
03857         <span class="comment">//</span>
03858         <span class="comment">// this members are allocated only for master post blocks</span>
03859         <span class="comment">//</span>
03860         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock)) {
03861             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>:
03862                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u-&gt;Sync.SystemEvent);
03863                 <span class="keywordflow">break</span>;
03864             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>:
03865                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u-&gt;AsyncUser.Apc);
03866                 <span class="keywordflow">break</span>;
03867             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>:
03868                 <span class="keywordflow">break</span>;
03869         }
03870         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u);
03871     }
03872 
03873 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
03874 <span class="preprocessor"></span>    RtlZeroMemory((PVOID)PostBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>));
03875 <span class="preprocessor">#endif</span>
03876 <span class="preprocessor"></span>
03877     <span class="comment">// and the storage for the Post object</span>
03878     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03879 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ntapi.c::CmpNameFromAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpNameFromAttributes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03603">3603</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00055">ALLOCATE_WITH_QUOTA</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>.
<p>
<pre class="fragment"><div>03611                    :
03612 
03613     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a helper routine that converts OBJECT_ATTRIBUTES into a
03614     full object pathname.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed because we cannot pass handles
03615     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker thread, since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> runs in a different process.
03616 
03617     This routine will also probe and capture <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes based on
03618     PreviousMode.
03619 
03620     Storage <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated from paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, and should
03621     be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
03622 
03623 Arguments:
03624 
03625     Attributes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object attributes to be converted to a pathname
03626 
03627     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode.
03628 
03629     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object pathname.
03630 
03631 Return Value:
03632 
03633     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03634 
03635 --*/
03636 
03637 {
03638     OBJECT_ATTRIBUTES CapturedAttributes;
03639     UNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
03640     UNICODE_STRING RootName;
03641     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03642     ULONG ObjectNameLength;
03643     UCHAR ObjectNameInfo[512];
03644     POBJECT_NAME_INFORMATION ObjectName;
03645     PWSTR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
03646     PUNICODE_STRING CapturedObjectName;
03647     ULONG   Length;
03648 
03649     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03650     FullName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;            <span class="comment">// so we know whether to free it in our exception handler</span>
03651     <span class="keywordflow">try</span> {
03652 
03653         <span class="comment">//</span>
03654         <span class="comment">// Probe the object attributes if necessary.</span>
03655         <span class="comment">//</span>
03656         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03657             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Attributes,
03658                          <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES),
03659                          PROBE_ALIGNMENT(OBJECT_ATTRIBUTES) );
03660             CapturedObjectName = Attributes-&gt;ObjectName;
03661             <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(CapturedObjectName);
03662             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer,
03663                          <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length,
03664                          <span class="keyword">sizeof</span>(WCHAR));
03665         } <span class="keywordflow">else</span> {
03666             <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = *(Attributes-&gt;ObjectName);
03667         }
03668 
03669         CapturedAttributes = *Attributes;
03670 
03671         <span class="keywordflow">if</span> (CapturedAttributes.RootDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03672 
03673             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03674                 (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length &gt;= <span class="keyword">sizeof</span>(WCHAR)) &amp;&amp;
03675                 (*(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer) == OBJ_NAME_PATH_SEPARATOR)) {
03676                 <span class="keywordflow">return</span>(STATUS_OBJECT_PATH_SYNTAX_BAD);
03677             }
03678 
03679             <span class="comment">//</span>
03680             <span class="comment">// Find the name of the root directory and append the</span>
03681             <span class="comment">// name of the relative object to it.</span>
03682             <span class="comment">//</span>
03683 
03684             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryObject(CapturedAttributes.RootDirectory,
03685                                    ObjectNameInformation,
03686                                    &amp;ObjectNameInfo,
03687                                    <span class="keyword">sizeof</span>(ObjectNameInfo),
03688                                    &amp;ObjectNameLength);
03689 
03690             ObjectName = (POBJECT_NAME_INFORMATION)ObjectNameInfo;
03691             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03692                 <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03693             }
03694             RootName = ObjectName-&gt;Name;
03695 
03696             FullName-&gt;Length = 0;
03697             Length = RootName.Length+<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length+<span class="keyword">sizeof</span>(WCHAR);
03698             <span class="comment">//</span>
03699             <span class="comment">// Overflow test: If Length overflows the USHRT_MAX value</span>
03700             <span class="comment">//                cleanup and return STATUS_OBJECT_PATH_INVALID</span>
03701             <span class="comment">//</span>
03702             <span class="keywordflow">if</span>( Length&gt;0xFFFF ) {
03703                 <span class="keywordflow">return</span> STATUS_OBJECT_PATH_INVALID;
03704             }
03705 
03706             FullName-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
03707             
03708             FullName-&gt;Buffer = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(PagedPool, FullName-&gt;MaximumLength, CM_POOL_TAG);
03709             <span class="keywordflow">if</span> (FullName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03710                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03711             }
03712 
03713             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(FullName, &amp;RootName);
03714             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
03715 
03716             <span class="comment">//</span>
03717             <span class="comment">// Append a trailing separator if necessary.</span>
03718             <span class="comment">//</span>
03719                         <span class="keywordflow">if</span>( FullName-&gt;Length != 0 ) {
03720                                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PWSTR)((PUCHAR)FullName-&gt;Buffer + FullName-&gt;Length) - 1;
03721                                 <span class="keywordflow">if</span> (*<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> != OBJ_NAME_PATH_SEPARATOR) {
03722                                         ++<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
03723                                         *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = OBJ_NAME_PATH_SEPARATOR;
03724                                         FullName-&gt;Length += <span class="keyword">sizeof</span>(WCHAR);
03725                                 }
03726                         }
03727 
03728             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(FullName, &amp;FileName);
03729             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
03730 
03731         } <span class="keywordflow">else</span> {
03732 
03733             <span class="comment">//</span>
03734             <span class="comment">// RootDirectory is NULL, so just use the name.</span>
03735             <span class="comment">//</span>
03736             FullName-&gt;Length = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length;
03737             FullName-&gt;MaximumLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length;
03738             FullName-&gt;Buffer = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(PagedPool, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length, CM_POOL_TAG);
03739             <span class="keywordflow">if</span> (FullName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03740                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
03741             } <span class="keywordflow">else</span> {
03742                 RtlMoveMemory(FullName-&gt;Buffer,
03743                               <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer,
03744                               <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length);
03745                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03746             }
03747         }
03748 
03749 
03750     } except (EXCEPTION_EXECUTE_HANDLER) {
03751         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03752         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
03753             KdPrint((<span class="stringliteral">"!!CmpNameFromAttributes: code %08lx\n"</span>, Status));
03754         }
03755         <span class="keywordflow">if</span> (FullName-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03756             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FullName-&gt;Buffer);
03757         }
03758     }
03759 
03760     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03761 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ntapi.c::NtCreateKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreateKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TitleIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING Class&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateOptions</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG Disposition&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">166</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00771">_CM_PARSE_CONTEXT::Class</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a182">CM_PARSE_CONTEXT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00071">CmpExceptionFilter</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00774">_CM_PARSE_CONTEXT::CreateLink</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00772">_CM_PARSE_CONTEXT::CreateOptions</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00773">_CM_PARSE_CONTEXT::Disposition</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00776">_CM_PARSE_CONTEXT::PredefinedHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01581">ProbeAndZeroHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00770">_CM_PARSE_CONTEXT::TitleIndex</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00087">CmpInitializeHardwareConfiguration()</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00465">CmpInitializeMachineDependentConfiguration()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00458">CmpInitializeRegistryNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l01264">CmpOpenRegKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>, <a class="el" href="../../d7/d2/rttrecpy_8c-source.html#l00114">Copy()</a>, <a class="el" href="../../d3/d6/regtest_8c-source.html#l00045">DoTest()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00453">FtCreateKey()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03729">GetActiveKeyboardName()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00071">main()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l00341">RtlInitializeRXact()</a>, <a class="el" href="../../d2/d6/rtl_2registry_8c-source.html#l00139">RtlpNtCreateKey()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01717">RXactpOpenTargetKey()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.
<p>
<pre class="fragment"><div>00177                    :
00178 
00179     An existing registry key may be opened, or a <span class="keyword">new</span> one created,
00180     with <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>.
00181 
00182     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified key does not exist, an attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to create <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00183     For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> create attempt to succeed, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> node must be a direct
00184     child of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node referred to by KeyHandle.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node exists,
00185     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened.  Its value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not affected in any way.
00186 
00187     Share access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> computed from desired access.
00188 
00189     NOTE:
00190 
00191         If CreateOptions has REG_OPTION_BACKUP_RESTORE set, then
00192         DesiredAccess will be ignored.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00193         privilege <a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a> asserted, a handle with
00194         KEY_READ | ACCESS_SYSTEM_SECURITY will be returned.
00195         If <a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>, then same but KEY_WRITE rather
00196         than KEY_READ.  If both, then both access sets.  If neither
00197         privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> asserted, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call will fail.
00198 
00199 Arguments:
00200 
00201     KeyHandle - Receives a <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to access <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00202         specified key in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Registration Database.
00203 
00204     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access rights desired.
00205 
00206     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key being opened.
00207         Note that a key name must be specified.  If a Root <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00208         specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root.  The name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00209         object must be within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name space allocated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Registry,
00210         that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, all names beginning <span class="stringliteral">"\Registry"</span>.  RootHandle, <span class="keywordflow">if</span>
00211         present, must be a handle to <span class="stringliteral">"\", or "</span>\Registry<span class="stringliteral">", or a key</span>
00212 <span class="stringliteral">        under "</span>\Registry<span class="stringliteral">".</span>
00213 <span class="stringliteral"></span>
00214 <span class="stringliteral">        RootHandle must have been opened for KEY_CREATE_SUB_KEY access</span>
00215 <span class="stringliteral">        if a new node is to be created.</span>
00216 <span class="stringliteral"></span>
00217 <span class="stringliteral">        NOTE:   Object manager will capture and probe this argument.</span>
00218 <span class="stringliteral"></span>
00219 <span class="stringliteral">    TitleIndex - Specifies the index of the localized alias for</span>
00220 <span class="stringliteral">        the name of the key.  The title index specifies the index of</span>
00221 <span class="stringliteral">        the localized alias for the name.  Ignored if the key</span>
00222 <span class="stringliteral">        already exists.</span>
00223 <span class="stringliteral"></span>
00224 <span class="stringliteral">    Class - Specifies the object class of the key.  (To the registry</span>
00225 <span class="stringliteral">        this is just a string.)  Ignored if NULL.</span>
00226 <span class="stringliteral"></span>
00227 <span class="stringliteral">    CreateOptions - Optional control values:</span>
00228 <span class="stringliteral"></span>
00229 <span class="stringliteral">        REG_OPTION_VOLATILE - Object is not to be stored across boots.</span>
00230 <span class="stringliteral"></span>
00231 <span class="stringliteral">    Disposition - This optional parameter is a pointer to a variable</span>
00232 <span class="stringliteral">        that will receive a value indicating whether a new Registry</span>
00233 <span class="stringliteral">        key was created or an existing one opened:</span>
00234 <span class="stringliteral"></span>
00235 <span class="stringliteral">        REG_CREATED_NEW_KEY - A new Registry Key was created</span>
00236 <span class="stringliteral">        REG_OPENED_EXISTING_KEY - An existing Registry Key was opened</span>
00237 <span class="stringliteral"></span>
00238 <span class="stringliteral">Return Value:</span>
00239 <span class="stringliteral"></span>
00240 <span class="stringliteral">    NTSTATUS - Result code from call, among the following:</span>
00241 <span class="stringliteral"></span>
00242 <span class="stringliteral">        &lt;TBS&gt;</span>
00243 <span class="stringliteral"></span>
00244 <span class="stringliteral">--*/</span>
00245 <span class="stringliteral">{</span>
00246 <span class="stringliteral">    NTSTATUS    status;</span>
00247 <span class="stringliteral">    KPROCESSOR_MODE mode;</span>
00248 <span class="stringliteral">    CM_PARSE_CONTEXT ParseContext;</span>
00249 <span class="stringliteral">    PCM_KEY_BODY KeyBody;</span>
00250 <span class="stringliteral">    HANDLE Handle = 0;</span>
00251 <span class="stringliteral">    UNICODE_STRING CapturedObjectName = {0};</span>
00252 <span class="stringliteral"></span>
00253 <span class="stringliteral">    // Start registry call tracing</span>
00254 <span class="stringliteral">    StartWmiCmTrace();</span>
00255 <span class="stringliteral"></span>
00256 <span class="stringliteral">    PAGED_CODE();</span>
00257 <span class="stringliteral"></span>
00258 <span class="stringliteral">    BEGIN_LOCK_CHECKPOINT;</span>
00259 <span class="stringliteral"></span>
00260 <span class="stringliteral">    CMLOG(CML_API, CMS_NTAPI) KdPrint(("</span><a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">"));</span>
00261 <span class="stringliteral">    CMLOG(CML_API_ARGS, CMS_NTAPI) {</span>
00262 <span class="stringliteral">        KdPrint(("</span>\tDesiredAccess=%08lx <span class="stringliteral">", DesiredAccess));</span>
00263 <span class="stringliteral">        KdPrint(("</span>\tCreateOptions=%08lx\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">", CreateOptions));</span>
00264 <span class="stringliteral">        KdPrint(("</span>\tRootHandle=%08lx\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">", ObjectAttributes-&gt;RootDirectory));</span>
00265 <span class="stringliteral">        KdPrint(("</span>\tName='%wZ'\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">", ObjectAttributes-&gt;ObjectName));</span>
00266 <span class="stringliteral">    }</span>
00267 <span class="stringliteral"></span>
00268 <span class="stringliteral">    mode = KeGetPreviousMode();</span>
00269 <span class="stringliteral">    CmpLockRegistryExclusive();</span>
00270 <span class="stringliteral">    </span>
00271 <span class="stringliteral">#ifdef LOG_NT_API</span>
00272 <span class="stringliteral">    if (CmpLogApi) {</span>
00273 <span class="stringliteral">        KdPrint(("</span><a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> %wZ relative to %d...<span class="stringliteral">",</span>
00274 <span class="stringliteral">                 ObjectAttributes-&gt;ObjectName,</span>
00275 <span class="stringliteral">                 ObjectAttributes-&gt;RootDirectory));</span>
00276 <span class="stringliteral">    }</span>
00277 <span class="stringliteral">#endif</span>
00278 <span class="stringliteral"></span>
00279 <span class="stringliteral">    try {</span>
00280 <span class="stringliteral"></span>
00281 <span class="stringliteral">        ParseContext.Class.Length = 0;</span>
00282 <span class="stringliteral">        ParseContext.Class.Buffer = NULL;</span>
00283 <span class="stringliteral"></span>
00284 <span class="stringliteral">        if (mode == UserMode) {</span>
00285 <span class="stringliteral"></span>
00286 <span class="stringliteral">            if (ARGUMENT_PRESENT(Class)) {</span>
00287 <span class="stringliteral">                ParseContext.Class = ProbeAndReadUnicodeString(Class);</span>
00288 <span class="stringliteral">                ProbeForRead(</span>
00289 <span class="stringliteral">                    ParseContext.Class.Buffer,</span>
00290 <span class="stringliteral">                    ParseContext.Class.Length,</span>
00291 <span class="stringliteral">                    sizeof(WCHAR)</span>
00292 <span class="stringliteral">                    );</span>
00293 <span class="stringliteral">            }</span>
00294 <span class="stringliteral">            ProbeAndZeroHandle(KeyHandle);</span>
00295 <span class="stringliteral"></span>
00296 <span class="stringliteral">            if (ARGUMENT_PRESENT(Disposition)) {</span>
00297 <span class="stringliteral">                ProbeForWriteUlong(Disposition);</span>
00298 <span class="stringliteral">            }</span>
00299 <span class="stringliteral"></span>
00300 <span class="stringliteral">            //</span>
00301 <span class="stringliteral">            // probe the ObjectAttributes as we shall use it for tracing</span>
00302 <span class="stringliteral">            //</span>
00303 <span class="stringliteral">            ProbeForRead( ObjectAttributes,</span>
00304 <span class="stringliteral">                          sizeof(OBJECT_ATTRIBUTES),</span>
00305 <span class="stringliteral">                          PROBE_ALIGNMENT(OBJECT_ATTRIBUTES) );</span>
00306 <span class="stringliteral">            CapturedObjectName = ProbeAndReadUnicodeString(ObjectAttributes-&gt;ObjectName);</span>
00307 <span class="stringliteral">            ProbeForRead(</span>
00308 <span class="stringliteral">                CapturedObjectName.Buffer,</span>
00309 <span class="stringliteral">                CapturedObjectName.Length,</span>
00310 <span class="stringliteral">                sizeof(WCHAR)</span>
00311 <span class="stringliteral">                );</span>
00312 <span class="stringliteral"></span>
00313 <span class="stringliteral">        } else {</span>
00314 <span class="stringliteral">            if (ARGUMENT_PRESENT(Class)) {</span>
00315 <span class="stringliteral">                ParseContext.Class = *Class;</span>
00316 <span class="stringliteral">            }</span>
00317 <span class="stringliteral">            CapturedObjectName = *(ObjectAttributes-&gt;ObjectName);</span>
00318 <span class="stringliteral">        }</span>
00319 <span class="stringliteral"></span>
00320 <span class="stringliteral">        if ((CreateOptions &amp; REG_LEGAL_OPTION) != CreateOptions) {</span>
00321 <span class="stringliteral">            CmpUnlockRegistry();</span>
00322 <span class="stringliteral"></span>
00323 <span class="stringliteral">            // End registry call tracing</span>
00324 <span class="stringliteral">            EndWmiCmTrace(STATUS_INVALID_PARAMETER,0,&amp;CapturedObjectName,EVENT_TRACE_TYPE_REGCREATE);</span>
00325 <span class="stringliteral"></span>
00326 <span class="stringliteral">            return STATUS_INVALID_PARAMETER;</span>
00327 <span class="stringliteral">        }</span>
00328 <span class="stringliteral"></span>
00329 <span class="stringliteral">        ParseContext.TitleIndex = 0;</span>
00330 <span class="stringliteral">        ParseContext.CreateOptions = CreateOptions;</span>
00331 <span class="stringliteral">        ParseContext.Disposition = 0L;</span>
00332 <span class="stringliteral">        ParseContext.CreateLink = FALSE;</span>
00333 <span class="stringliteral">        ParseContext.PredefinedHandle = NULL;</span>
00334 <span class="stringliteral"></span>
00335 <span class="stringliteral">        status = ObOpenObjectByName(</span>
00336 <span class="stringliteral">                    ObjectAttributes,</span>
00337 <span class="stringliteral">                    CmpKeyObjectType,</span>
00338 <span class="stringliteral">                    mode,</span>
00339 <span class="stringliteral">                    NULL,</span>
00340 <span class="stringliteral">                    DesiredAccess,</span>
00341 <span class="stringliteral">                    (PVOID)&amp;ParseContext,</span>
00342 <span class="stringliteral">                    &amp;Handle</span>
00343 <span class="stringliteral">                    );</span>
00344 <span class="stringliteral"></span>
00345 <span class="stringliteral">        if (status==STATUS_PREDEFINED_HANDLE) {</span>
00346 <span class="stringliteral">            status = ObReferenceObjectByHandle(Handle,</span>
00347 <span class="stringliteral">                                               0,</span>
00348 <span class="stringliteral">                                               CmpKeyObjectType,</span>
00349 <span class="stringliteral">                                               KernelMode,</span>
00350 <span class="stringliteral">                                               (PVOID *)(&amp;KeyBody),</span>
00351 <span class="stringliteral">                                               NULL);</span>
00352 <span class="stringliteral">            if (NT_SUCCESS(status)) {</span>
00353 <span class="stringliteral">                HANDLE TempHandle;</span>
00354 <span class="stringliteral"></span>
00355 <span class="stringliteral">                //</span>
00356 <span class="stringliteral">                // Make sure we do the dereference and close before accessing</span>
00357 <span class="stringliteral">                // user space as the reference might fault.</span>
00358 <span class="stringliteral">                //</span>
00359 <span class="stringliteral">                TempHandle = (HANDLE)LongToHandle(KeyBody-&gt;Type);</span>
00360 <span class="stringliteral">                ObDereferenceObject((PVOID)KeyBody);</span>
00361 <span class="stringliteral">                NtClose(Handle);</span>
00362 <span class="stringliteral">                Handle = *KeyHandle = TempHandle;</span>
00363 <span class="stringliteral">                status = STATUS_SUCCESS;</span>
00364 <span class="stringliteral">            }</span>
00365 <span class="stringliteral">        } else</span>
00366 <span class="stringliteral">        if (NT_SUCCESS(status)) {</span>
00367 <span class="stringliteral">            *KeyHandle = Handle;</span>
00368 <span class="stringliteral">        }</span>
00369 <span class="stringliteral"></span>
00370 <span class="stringliteral">        if (ARGUMENT_PRESENT(Disposition)) {</span>
00371 <span class="stringliteral">            *Disposition = ParseContext.Disposition;</span>
00372 <span class="stringliteral">        }</span>
00373 <span class="stringliteral"></span>
00374 <span class="stringliteral">    } except (CmpExceptionFilter(GetExceptionInformation())) {</span>
00375 <span class="stringliteral">        CMLOG(CML_API, CMS_EXCEPTION) {</span>
00376 <span class="stringliteral">            KdPrint(("</span>!!<a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>: code:%08lx\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">", GetExceptionCode()));</span>
00377 <span class="stringliteral">        }</span>
00378 <span class="stringliteral">        status = GetExceptionCode();</span>
00379 <span class="stringliteral">    }</span>
00380 <span class="stringliteral">#ifdef LOG_NT_API</span>
00381 <span class="stringliteral">    if (CmpLogApi) {</span>
00382 <span class="stringliteral">        if (NT_SUCCESS(status)) {</span>
00383 <span class="stringliteral">            KdPrint(("</span>succeeded %d\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">",Handle));</span>
00384 <span class="stringliteral">        } else {</span>
00385 <span class="stringliteral">            KdPrint(("</span>failed %08lx\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">",status));</span>
00386 <span class="stringliteral">        }</span>
00387 <span class="stringliteral">    }</span>
00388 <span class="stringliteral">#endif</span>
00389 <span class="stringliteral"></span>
00390 <span class="stringliteral"></span>
00391 <span class="stringliteral">    CmpUnlockRegistry();</span>
00392 <span class="stringliteral"></span>
00393 <span class="stringliteral">    END_LOCK_CHECKPOINT;</span>
00394 <span class="stringliteral"></span>
00395 <span class="stringliteral">    // End registry call tracing</span>
00396 <span class="stringliteral">    EndWmiCmTrace(status,Handle,&amp;CapturedObjectName,EVENT_TRACE_TYPE_REGCREATE);</span>
00397 <span class="stringliteral"></span>
00398 <span class="stringliteral">    return  status;</span>
00399 <span class="stringliteral">}</span>
</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="ntapi.c::NtDeleteKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtDeleteKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">411</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00401">ExpControlKey</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00056">_OBJECT_HANDLE_INFORMATION::HandleAttributes</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00408">OBJ_AUDIT_OBJECT_CLOSE</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03892">SeDeleteObjectAuditAlarm()</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/geninst_8c-source.html#l00658">CmpProcessDelRegLine()</a>, <a class="el" href="../../d1/d0/rtdeltre_8c-source.html#l00103">Delete()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00411">FtDeleteKey()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02297">KiMoveRegTree()</a>, <a class="el" href="../../d0/d0/rtdelkey_8c-source.html#l00048">main()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l00341">RtlInitializeRXact()</a>, <a class="el" href="../../d2/d6/rtl_2registry_8c-source.html#l00430">RtlpNtMakeTemporaryKey()</a>, and <a class="el" href="../../d6/d3/rxact_8c-source.html#l01461">RXactpCommit()</a>.
<p>
<pre class="fragment"><div>00416                    :
00417 
00418     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> registry key may be marked <span class="keywordflow">for</span> <span class="keyword">delete</span>, causing <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to be removed
00419     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.  It will remain in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name space until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last
00420     handle to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed.
00421 
00422 Arguments:
00423 
00424     KeyHandle - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> to <span class="keyword">delete</span>, must have
00425         been opened <span class="keywordflow">for</span> DELETE access.
00426 
00427 Return Value:
00428 
00429     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00430 
00431         &lt;TBS&gt;
00432 
00433 --*/
00434 {
00435     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>                KeyBody;
00436     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
00437     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a>   HandleInfo;
00438 
00439     <span class="comment">// Start registry call tracing</span>
00440     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00441 
00442     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00443 
00444     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00445 
00446     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtDeleteKey\n"));
00447     CMLOG(CML_API_ARGS, CMS_NTAPI) {
00448         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
00449     }
00450 <span class="preprocessor">#ifdef LOG_NT_API</span>
00451 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00452         KdPrint((<span class="stringliteral">"NtDeleteKey %d\n"</span>,KeyHandle));
00453     }
00454 <span class="preprocessor">#endif</span>
00455 <span class="preprocessor"></span>
00456     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
00457                                        DELETE,
00458                                        CmpKeyObjectType,
00459                                        KeGetPreviousMode(),
00460                                        (PVOID *)(&amp;KeyBody),
00461                                        &amp;HandleInfo);
00462 
00463     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00464 
00465         <span class="comment">//</span>
00466         <span class="comment">// Silently fail deletes of setup key and productoptions key</span>
00467         <span class="comment">//</span>
00468 
00469         <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[0] &amp;&amp; KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> == <a class="code" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[0]-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>) ||
00470              (<a class="code" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[1] &amp;&amp; KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> == <a class="code" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[1]-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>) ) {
00471             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00472 
00473             <span class="comment">// End registry call tracing</span>
00474             <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_SUCCESS,KeyHandle,NULL,EVENT_TRACE_TYPE_REGDELETE);
00475 
00476             <span class="keywordflow">return</span> STATUS_SUCCESS;
00477         }
00478 
00479         status = <a class="code" href="../../d1/d2/cmp_8h.html#a224">CmDeleteKey</a>(KeyBody);
00480 
00481         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00482             <span class="comment">//</span>
00483             <span class="comment">// Audit the deletion</span>
00484             <span class="comment">//</span>
00485 
00486             <span class="keywordflow">if</span> ( HandleInfo.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a> ) {
00487                 <a class="code" href="../../d3/d5/seaudit_8c.html#a30">SeDeleteObjectAuditAlarm</a>(KeyBody,
00488                                          KeyHandle );
00489             }
00490         }
00491         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00492     }
00493 
00494     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00495 
00496     <span class="comment">// End registry call tracing</span>
00497     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,NULL,EVENT_TRACE_TYPE_REGDELETE);
00498 
00499     <span class="keywordflow">return</span> status;
00500 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="ntapi.c::NtDeleteValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtDeleteValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">504</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00882">bCheckAndDeleteTTF()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00311">CmpProcessAddRegLine()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00658">CmpProcessDelRegLine()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00557">FtDeleteValue()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03729">GetActiveKeyboardName()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>, <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00051">main()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01240">RtlApplyRXact()</a>, and <a class="el" href="../../d6/d3/rxact_8c-source.html#l00341">RtlInitializeRXact()</a>.
<p>
<pre class="fragment"><div>00510                    :
00511 
00512     One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entries of a registry key may be removed with <span class="keyword">this</span>
00513     call.  To remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire key, call <a class="code" href="../../d7/d7/ntapi_8c.html#a15">NtDeleteKey</a>.
00514 
00515     The value entry with <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
00516     If no such entry exists, an error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00517 
00518 Arguments:
00519 
00520     KeyHandle - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
00521         entry of interest.  Must have been opend <span class="keywordflow">for</span> KEY_SET_VALUE access.
00522 
00523     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - The name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value to be deleted.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a legal name.
00524 
00525 Return Value:
00526 
00527     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00528 
00529         &lt;TBS&gt;
00530 
00531 --*/
00532 {
00533     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00534     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
00535     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
00536     UNICODE_STRING LocalValueName;
00537 
00538     <span class="comment">// Start registry call tracing</span>
00539     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00540 
00541     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00542 
00543     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00544 
00545     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtDeleteValueKey\n"));
00546     CMLOG(CML_API_ARGS, CMS_NTAPI) {
00547         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
00548         KdPrint((<span class="stringliteral">"\tValueName='%wZ'\n"</span>, ValueName));
00549     }
00550 <span class="preprocessor">#ifdef LOG_NT_API</span>
00551 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00552         KdPrint((<span class="stringliteral">"NtDeleteValueKey %d %wZ\n"</span>,KeyHandle,ValueName));
00553     }
00554 <span class="preprocessor">#endif</span>
00555 <span class="preprocessor"></span>    mode = KeGetPreviousMode();
00556 
00557     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00558                 KeyHandle,
00559                 KEY_SET_VALUE,
00560                 CmpKeyObjectType,
00561                 mode,
00562                 (PVOID *)(&amp;KeyBody),
00563                 NULL
00564                 );
00565 
00566     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00567 
00568 
00569         <span class="keywordflow">try</span> {
00570             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00571                 LocalValueName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(ValueName);
00572                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00573                     LocalValueName.Buffer,
00574                     LocalValueName.Length,
00575                     <span class="keyword">sizeof</span>(WCHAR)
00576                     );
00577             } <span class="keywordflow">else</span> {
00578                 LocalValueName = *<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00579             }
00580 
00581             status = <a class="code" href="../../d1/d2/cmp_8h.html#a225">CmDeleteValueKey</a>(
00582                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
00583                         LocalValueName
00584                         );
00585 
00586         } except (EXCEPTION_EXECUTE_HANDLER) {
00587             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
00588                KdPrint((<span class="stringliteral">"!!NtDeleteValueKey: code:%08lx\n"</span>, GetExceptionCode()));
00589             }
00590             status = GetExceptionCode();
00591         }
00592 
00593 
00594         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00595     } <span class="keywordflow">else</span> {
00596         LocalValueName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00597         LocalValueName.Length = 0;
00598     }
00599 
00600     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00601 
00602     <span class="comment">// End registry call tracing</span>
00603     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,&amp;LocalValueName,EVENT_TRACE_TYPE_REGDELETEVALUE);
00604 
00605     <span class="keywordflow">return</span> status;
00606 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="ntapi.c::NtEnumerateKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtEnumerateKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">610</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00260">CliGetImeHotKeysFromRegistry()</a>, <a class="el" href="../../d7/d2/rttrecpy_8c-source.html#l00114">Copy()</a>, <a class="el" href="../../d1/d0/rtdeltre_8c-source.html#l00103">Delete()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00903">Directory()</a>, <a class="el" href="../../d3/d0/rtdmp_8c-source.html#l00126">Dump()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01983">GetServerIMEKeyboardLayout()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l02369">ListDrivers()</a>, <a class="el" href="../../d5/d1/rtmisc1_8c-source.html#l00075">main()</a>, and <a class="el" href="../../d2/d6/rtl_2registry_8c-source.html#l00465">RtlpNtEnumerateSubKey()</a>.
<p>
<pre class="fragment"><div>00620                    :
00621 
00622     The sub keys of an open key may be enumerated with <a class="code" href="../../d7/d7/ntapi_8c.html#a17">NtEnumerateKey</a>.
00623 
00624     <a class="code" href="../../d7/d7/ntapi_8c.html#a17">NtEnumerateKey</a> returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>'th sub key of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open
00625     key specified by KeyHandle.  The value STATUS_NO_MORE_ENTRIES will be
00626     returned <span class="keywordflow">if</span> value of <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> larger than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sub keys.
00627 
00628     Note that <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply a way to select among child keys.  Two calls
00629     to <a class="code" href="../../d7/d7/ntapi_8c.html#a17">NtEnumerateKey</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> are NOT guaranteed to <span class="keywordflow">return</span>
00630     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same results.
00631 
00632     If KeyInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00633     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00634     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00635 
00636 Arguments:
00637 
00638     KeyHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key whose sub keys are to be enumerated.  Must
00639         be open <span class="keywordflow">for</span> KEY_ENUMERATE_SUB_KEY access.
00640 
00641     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (0-based) number of the sub key to be returned.
00642 
00643     KeyInformationClass - Specifies the type of information returned in
00644         Buffer.  One of the following types:
00645 
00646         KeyBasicInformation - return last write time, title index, and name.
00647             (see KEY_BASIC_INFORMATION structure)
00648 
00649         KeyNodeInformation - return last write time, title index, name, class.
00650             (see KEY_NODE_INFORMATION structure)
00651 
00652     KeyInformation -Supplies pointer to buffer to receive the data.
00653 
00654     Length - Length of KeyInformation in bytes.
00655 
00656     ResultLength - Number of bytes actually written into KeyInformation.
00657 
00658 Return Value:
00659 
00660     NTSTATUS - Result code from call, among the following:
00661 
00662         &lt;TBS&gt;
00663 
00664 --*/
00665 {
00666     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00667     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
00668     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
00669 
00670     <span class="comment">// Start registry call tracing</span>
00671     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00672 
00673     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00674 
00675     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00676 
00677     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtEnumerateKey\n"));
00678     CMLOG(CML_API_ARGS, CMS_NTAPI) {
00679         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx Index=%08lx\n"</span>, KeyHandle, Index));
00680     }
00681 
00682 <span class="preprocessor">#ifdef LOG_NT_API</span>
00683 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00684         KdPrint((<span class="stringliteral">"NtEnumerateKey %d %d %d\n"</span>,KeyHandle,Index,KeyInformationClass));
00685     }
00686 <span class="preprocessor">#endif</span>
00687 <span class="preprocessor"></span>
00688     <span class="keywordflow">if</span> ((KeyInformationClass != KeyBasicInformation) &amp;&amp;
00689         (KeyInformationClass != KeyNodeInformation)  &amp;&amp;
00690         (KeyInformationClass != KeyFullInformation))
00691     {
00692         <span class="comment">// End registry call tracing</span>
00693         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_PARAMETER,KeyHandle,NULL,EVENT_TRACE_TYPE_REGENUMERATEKEY);
00694 
00695         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00696     }
00697 
00698     mode = KeGetPreviousMode();
00699 
00700     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00701                 KeyHandle,
00702                 KEY_ENUMERATE_SUB_KEYS,
00703                 CmpKeyObjectType,
00704                 mode,
00705                 (PVOID *)(&amp;KeyBody),
00706                 NULL
00707                 );
00708 
00709     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00710 
00711         <span class="keywordflow">try</span> {
00712             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00713                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00714                     KeyInformation,
00715                     Length,
00716                     <span class="keyword">sizeof</span>(ULONG)
00717                     );
00718                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ResultLength);
00719             }
00720 
00721         } except (EXCEPTION_EXECUTE_HANDLER) {
00722             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
00723                 KdPrint((<span class="stringliteral">"!!NtEnumerateKey: code:%08lx\n"</span>, GetExceptionCode()));
00724             }
00725             status = GetExceptionCode();
00726         }
00727 
00728         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00729             <span class="comment">//</span>
00730             <span class="comment">// CmEnumerateKey is protected to user mode buffer exceptions</span>
00731             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
00732             <span class="comment">//</span>
00733             status = <a class="code" href="../../d1/d2/cmp_8h.html#a226">CmEnumerateKey</a>(
00734                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
00735                         Index,
00736                         KeyInformationClass,
00737                         KeyInformation,
00738                         Length,
00739                         ResultLength
00740                         );
00741         }
00742 
00743         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00744     }
00745 
00746     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00747 
00748     <span class="comment">// End registry call tracing</span>
00749     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,NULL,EVENT_TRACE_TYPE_REGENUMERATEKEY);
00750 
00751     <span class="keywordflow">return</span> status;
00752 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="ntapi.c::NtEnumerateValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtEnumerateValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_VALUE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">756</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00882">bCheckAndDeleteTTF()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>, <a class="el" href="../../d7/d2/rttrecpy_8c-source.html#l00114">Copy()</a>, <a class="el" href="../../d3/d0/rtdmp_8c-source.html#l00223">DumpValues()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00598">GetBadAppCmdLine()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00966">List()</a>, <a class="el" href="../../d5/d1/rtmisc1_8c-source.html#l00075">main()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.
<p>
<pre class="fragment"><div>00766                    :
00767 
00768     The value entries of an open key may be enumerated
00769     with <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>.
00770 
00771     <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a> returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>'th value
00772     entry of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open key specified by KeyHandle.  The value
00773     STATUS_NO_MORE_ENTRIES will be returned <span class="keywordflow">if</span> value of <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00774     larger than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sub keys.
00775 
00776     Note that <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply a way to select among value
00777     entries.  Two calls to <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>
00778     are NOT guaranteed to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same results.
00779 
00780     If KeyValueInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00781     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00782     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00783 
00784 Arguments:
00785 
00786     KeyHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key whose value entries are to be enumerated.
00787         Must have been opened with KEY_QUERY_VALUE access.
00788 
00789     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (0-based) number of the sub key to be returned.
00790 
00791     KeyValueInformationClass - Specifies the type of information returned
00792     in Buffer. One of the following types:
00793 
00794         KeyValueBasicInformation - return time of last write,
00795             title index, and name.  (See KEY_VALUE_BASIC_INFORMATION)
00796 
00797         KeyValueFullInformation - return time of last write,
00798             title index, name, class.  (See KEY_VALUE_FULL_INFORMATION)
00799 
00800     KeyValueInformation -Supplies pointer to buffer to receive the data.
00801 
00802     Length - Length of KeyValueInformation in bytes.
00803 
00804     ResultLength - Number of bytes actually written into KeyValueInformation.
00805 
00806 Return Value:
00807 
00808     NTSTATUS - Result code from call, among the following:
00809 
00810         &lt;TBS&gt;
00811 
00812 --*/
00813 {
00814     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00815     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
00816     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
00817 
00818     <span class="comment">// Start registry call tracing</span>
00819     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00820 
00821     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00822 
00823     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00824 
00825     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtEnumerateValueKey\n"));
00826     CMLOG(CML_API_ARGS, CMS_NTAPI) {
00827         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx Index=%08lx\n"</span>, KeyHandle, Index));
00828     }
00829 
00830 <span class="preprocessor">#ifdef LOG_NT_API</span>
00831 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00832         KdPrint((<span class="stringliteral">"NtEnumerateValueKey %d %d %d\n"</span>,KeyHandle,Index,KeyValueInformationClass));
00833     }
00834 <span class="preprocessor">#endif</span>
00835 <span class="preprocessor"></span>
00836     <span class="keywordflow">if</span> ((KeyValueInformationClass != KeyValueBasicInformation) &amp;&amp;
00837         (KeyValueInformationClass != KeyValueFullInformation)  &amp;&amp;
00838         (KeyValueInformationClass != KeyValuePartialInformation))
00839     {
00840         <span class="comment">// End registry call tracing</span>
00841         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_PARAMETER,KeyHandle,NULL,EVENT_TRACE_TYPE_REGENUMERATEVALUEKEY);
00842 
00843         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00844     }
00845 
00846     mode = KeGetPreviousMode();
00847 
00848     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00849                 KeyHandle,
00850                 KEY_QUERY_VALUE,
00851                 CmpKeyObjectType,
00852                 mode,
00853                 (PVOID *)(&amp;KeyBody),
00854                 NULL
00855                 );
00856 
00857     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00858 
00859         <span class="keywordflow">try</span> {
00860             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00861                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00862                     KeyValueInformation,
00863                     Length,
00864                     <span class="keyword">sizeof</span>(ULONG)
00865                     );
00866                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ResultLength);
00867             }
00868 
00869         } except (EXCEPTION_EXECUTE_HANDLER) {
00870             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
00871                 KdPrint((<span class="stringliteral">"!!NtEnumerateValueKey: code:%08lx\n"</span>, GetExceptionCode()));
00872             }
00873             status = GetExceptionCode();
00874         }
00875 
00876         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00877             <span class="comment">//</span>
00878             <span class="comment">// CmEnumerateValueKey is protected to user mode buffer exceptions</span>
00879             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
00880             <span class="comment">//</span>
00881             status = <a class="code" href="../../d1/d2/cmp_8h.html#a227">CmEnumerateValueKey</a>(
00882                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
00883                         Index,
00884                         KeyValueInformationClass,
00885                         KeyValueInformation,
00886                         Length,
00887                         ResultLength
00888                         );
00889         }
00890 
00891         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00892     }
00893 
00894     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00895 
00896     <span class="comment">// End registry call tracing</span>
00897     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,NULL,EVENT_TRACE_TYPE_REGENUMERATEVALUEKEY);
00898 
00899     <span class="keywordflow">return</span> status;
00900 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="ntapi.c::NtFlushKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtFlushKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">904</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00740">_REGISTRY_COMMAND::Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00739">_REGISTRY_COMMAND::Hive</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00720">REG_CMD_FLUSH_KEY</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a180">REGISTRY_COMMAND</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00743">_REGISTRY_COMMAND::Status</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">CmpInterlockedFunction()</a>, <a class="el" href="../../d7/d0/rtflush_8c-source.html#l00045">main()</a>, and <a class="el" href="../../d6/d3/rxact_8c-source.html#l01240">RtlApplyRXact()</a>.
<p>
<pre class="fragment"><div>00909                    :
00910 
00911     Changes <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> by <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> or NtSetKey may be flushed to disk with
00912     <a class="code" href="../../d7/d7/ntapi_8c.html#a19">NtFlushKey</a>.
00913 
00914     <a class="code" href="../../d7/d7/ntapi_8c.html#a19">NtFlushKey</a> will not <span class="keywordflow">return</span> to its caller until any changed data
00915     associated with KeyHandle has been written to permanent store.
00916 
00917     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>: <a class="code" href="../../d7/d7/ntapi_8c.html#a19">NtFlushKey</a> will flush <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire registry tree, and thus will
00918     burn cycles and I/O.
00919 
00920 Arguments:
00921 
00922     KeyHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of open key to be flushed.
00923 
00924 Return Value:
00925 
00926     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00927 
00928         &lt;TBS&gt;
00929 
00930 --*/
00931 {
00932     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
00933     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00934     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
00935 
00936     <span class="comment">// Start registry call tracing</span>
00937     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00938 
00939     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00940 
00941     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00942 
00943     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtFlushKey\n"));
00944 
00945 #ifdef LOG_NT_API
00946     if (CmpLogApi) {
00947         KdPrint((<span class="stringliteral">"NtFlushKey(%d)\n"</span>,KeyHandle));
00948     }
00949 <span class="preprocessor">#endif</span>
00950 <span class="preprocessor"></span>
00951     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00952                 KeyHandle,
00953                 0,
00954                 CmpKeyObjectType,
00955                 KeGetPreviousMode(),
00956                 (PVOID *)(&amp;KeyBody),
00957                 NULL
00958                 );
00959 
00960     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00961 
00962         <span class="comment">//</span>
00963         <span class="comment">// Need the exclusive lock so we can call the registry worker thread.</span>
00964         <span class="comment">//</span>
00965         <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00966 
00967         <span class="keywordflow">if</span> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>) {
00968             status = STATUS_KEY_DELETED;
00969         } <span class="keywordflow">else</span> {
00970             <span class="comment">//</span>
00971             <span class="comment">// Wake up worker thread to do real work for us</span>
00972             <span class="comment">//</span>
00973 
00974             Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a102">REG_CMD_FLUSH_KEY</a>;
00975             Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
00976             Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o2">Cell</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
00977 
00978             <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
00979             status = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
00980         }
00981 
00982         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00983 
00984         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00985     }
00986 
00987     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00988 
00989     <span class="comment">// End registry call tracing</span>
00990     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,NULL,EVENT_TRACE_TYPE_REGFLUSH);
00991 
00992     <span class="keywordflow">return</span> status;
00993 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="ntapi.c::NtInitializeRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtInitializeRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BootCondition</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">997</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00319">CmBootAcceptFirstTime</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00311">CmFirstTime</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d4/internal_8c.html#a18">IopCopyBootLogRegistryToFile()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d2/po_8h.html#a60">PoInitHiberServices()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00719">REG_CMD_INIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00749">_REGISTRY_COMMAND::SetupBoot</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>01002                    :
01003 
01004     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in 2 situations:
01005 
01006     1) It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from SM after autocheck (chkdsk) has
01007     run and the paging files have been opened.  It's function is
01008     to bind in memory hives to their files, and to open any other
01009     files yet to be used.
01010 
01011     2) It is called from SC after the current boot has been accepted
01012     and the control set used for the boot process should be saved
01013     as the LKG control set.
01014 
01015     After this routine accomplishes the work of situation #1 and
01016       #2, further requests for such work will not be carried out.
01017 
01018 Arguments:
01019 
01020     BootCondition -
01021 
01022          REG_INIT_BOOT_SM -     The routine has been called from SM
01023                                 in situation #1.
01024 
01025          REG_INIT_BOOT_SETUP -  The routine has been called to perform
01026                                 situation #1 work but has been called
01027                                 from setup and needs to do some special
01028                                 work.
01029 
01030         REG_INIT_BOOT_ACCEPTED_BASE + Num
01031                         (where 0 &lt; Num &lt; 1000) - The routine has been called
01032                                                  in situation #2. "Num" is the
01033                                                  number of the control set
01034                                                  to which the boot control set
01035                                                  should be saved.
01036 
01037 Return Value:
01038 
01039     NTSTATUS - Result code from call, among the following:
01040 
01041         STATUS_SUCCESS - it worked
01042         STATUS_ACCESS_DENIED - the routine has already done the work
01043                                requested and will not do it again.
01044 
01045 --*/
01046 {
01047     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
01048     BOOLEAN SetupBoot;
01049 
01050     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01051 <span class="preprocessor">#ifdef LOG_NT_API</span>
01052 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
01053         KdPrint((<span class="stringliteral">"NtInitializeRegistry()\n"</span>));
01054     }
01055 <span class="preprocessor">#endif</span>
01056 <span class="preprocessor"></span>
01057     <span class="comment">//</span>
01058     <span class="comment">// Force previous mode to be KernelMode</span>
01059     <span class="comment">//</span>
01060     <span class="keywordflow">if</span> (KeGetPreviousMode() == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
01061         <span class="keywordflow">return</span> ZwInitializeRegistry(BootCondition);
01062     } <span class="keywordflow">else</span> {
01063 
01064         <span class="comment">//</span>
01065         <span class="comment">// Check for a valid BootCondition value</span>
01066         <span class="comment">//</span>
01067 
01068         <span class="keywordflow">if</span>(BootCondition &gt; REG_INIT_MAX_VALID_CONDITION)
01069            <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01070 
01071         <span class="comment">//</span>
01072         <span class="comment">// Check for a Boot acceptance</span>
01073         <span class="comment">//</span>
01074 
01075         <span class="keywordflow">if</span>((BootCondition &gt;= REG_INIT_BOOT_ACCEPTED_BASE) &amp;&amp;
01076            (BootCondition &lt;= REG_INIT_BOOT_ACCEPTED_MAX))
01077         {
01078            <span class="comment">//</span>
01079            <span class="comment">// Make sure the Boot can be accepted only once</span>
01080            <span class="comment">//</span>
01081 
01082            <span class="keywordflow">if</span>(!<a class="code" href="../../d6/d0/cmdat_8c.html#a69">CmBootAcceptFirstTime</a>)
01083               <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01084 
01085            <a class="code" href="../../d6/d0/cmdat_8c.html#a69">CmBootAcceptFirstTime</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01086 
01087            <span class="comment">//</span>
01088            <span class="comment">// Calculate the control set we want to save</span>
01089            <span class="comment">// the boot control set to</span>
01090            <span class="comment">//</span>
01091 
01092            BootCondition -= REG_INIT_BOOT_ACCEPTED_BASE;
01093 
01094            <span class="keywordflow">if</span>(BootCondition)
01095            {
01096               <span class="comment">//</span>
01097               <span class="comment">// Valid control set number passed in.</span>
01098               <span class="comment">// Do the save.</span>
01099               <span class="comment">//</span>
01100 
01101               <span class="keywordflow">return</span> <a class="code" href="../../d1/d3/cmsysini_8c.html#a54">CmpSaveBootControlSet</a>(BootCondition);
01102            }
01103            <span class="keywordflow">else</span>
01104            {
01105               <span class="comment">//</span>
01106               <span class="comment">// 0 passed in as a control set number.</span>
01107               <span class="comment">// That is not valid, fail.</span>
01108               <span class="comment">//</span>
01109 
01110               <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01111            }
01112         }
01113 
01114         <span class="comment">// called from setup?</span>
01115 
01116         SetupBoot = (BootCondition == REG_INIT_BOOT_SETUP ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01117 
01118         <span class="comment">//</span>
01119         <span class="comment">// Fail if not first time called for situation #1 work.</span>
01120         <span class="comment">//</span>
01121 
01122         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/cmdat_8c.html#a68">CmFirstTime</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01123             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01124         }
01125         <a class="code" href="../../d6/d0/cmdat_8c.html#a68">CmFirstTime</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01126 
01127         <span class="comment">//</span>
01128         <span class="comment">// Wake up worker thread to do real work for us</span>
01129         <span class="comment">//</span>
01130 
01131         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a101">REG_CMD_INIT</a>;
01132         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o11">SetupBoot</a> = SetupBoot;
01133 
01134         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01135 
01136         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
01137         <a class="code" href="../../d1/d3/cmsysini_8c.html#a50">CmpSetVersionData</a>();
01138 
01139         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01140 
01141         <span class="comment">//</span>
01142         <span class="comment">// Notify PO that the volumes are usabled</span>
01143         <span class="comment">//</span>
01144         <a class="code" href="../../d1/d2/po_8h.html#a60">PoInitHiberServices</a>(SetupBoot);
01145 
01146         <span class="keywordflow">if</span> (!SetupBoot) {
01147             <a class="code" href="../../d2/d4/internal_8c.html#a18">IopCopyBootLogRegistryToFile</a>();
01148         }
01149 
01150         <span class="keywordflow">return</span> STATUS_SUCCESS;
01151     }
01152 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="ntapi.c::NtLoadKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtLoadKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02832">2832</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/rtload_8c-source.html#l00055">main()</a>.
<p>
<pre class="fragment"><div>02839                    :
02840 
02841     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> hive (file in the format created by NtSaveKey) may be linked
02842     into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active registry with <span class="keyword">this</span> call.  UNLIKE <a class="code" href="../../d7/d7/ntapi_8c.html#a26">NtRestoreKey</a>,
02843     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> specified to <a class="code" href="../../d7/d7/ntapi_8c.html#a30">NtLoadKey</a> will become <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual backing
02844     store of part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry (that is, it will NOT be copied.)
02845 
02846     The file may have an associated .log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02847 
02848     If the hive file is marked as needing a .log file, and one is
02849     not present, the call will fail.
02850 
02851     The name specified by SourceFile must be such that <span class="stringliteral">".log"</span> can
02852     be appended to it to generate the name of the log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Thus,
02853     on FAT file systems, the hive file may not have an <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
02854 
02855     Caller must have SeRestorePrivilege privilege.
02856 
02857     This call is used by logon to make the user's profile available
02858     in the registry.  It is not intended <span class="keywordflow">for</span> use doing backup,
02859     restore, etc.  Use NtRestoreKey <span class="keywordflow">for</span> that.
02860 
02861 Arguments:
02862 
02863     TargetKey - specifies the path to a key to link the hive to.
02864                 path must be of the form <span class="stringliteral">"\registry\user&lt;username&gt;"</span>
02865 
02866     SourceFile - specifies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  <span class="keywordflow">while</span> file could be remote,
02867                 that is strongly discouraged.
02868 
02869 Return Value:
02870 
02871     NTSTATUS - values TBS.
02872 
02873 --*/
02874 
02875 {
02876     <span class="keywordflow">return</span>(<a class="code" href="../../d7/d7/ntapi_8c.html#a31">NtLoadKey2</a>(TargetKey, SourceFile, 0));
02877 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="ntapi.c::NtLoadKey2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtLoadKey2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">2881</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00055">ALLOCATE_WITH_QUOTA</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03603">CmpNameFromAttributes()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00053">SeCaptureSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01686">SeRestorePrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02832">NtLoadKey()</a>.
<p>
<pre class="fragment"><div>02889                    :
02890 
02891     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> hive (file in the format created by NtSaveKey) may be linked
02892     into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active registry with <span class="keyword">this</span> call.  UNLIKE <a class="code" href="../../d7/d7/ntapi_8c.html#a26">NtRestoreKey</a>,
02893     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> specified to <a class="code" href="../../d7/d7/ntapi_8c.html#a30">NtLoadKey</a> will become <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual backing
02894     store of part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry (that is, it will NOT be copied.)
02895 
02896     The file may have an associated .log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02897 
02898     If the hive file is marked as needing a .log file, and one is
02899     not present, the call will fail.
02900 
02901     The name specified by SourceFile must be such that <span class="stringliteral">".log"</span> can
02902     be appended to it to generate the name of the log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Thus,
02903     on FAT file systems, the hive file may not have an <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
02904 
02905     Caller must have SeRestorePrivilege privilege.
02906 
02907     This call is used by logon to make the user's profile available
02908     in the registry.  It is not intended <span class="keywordflow">for</span> use doing backup,
02909     restore, etc.  Use NtRestoreKey <span class="keywordflow">for</span> that.
02910 
02911 Arguments:
02912 
02913     TargetKey - specifies the path to a key to link the hive to.
02914                 path must be of the form <span class="stringliteral">"\registry\user&lt;username&gt;"</span>
02915 
02916     SourceFile - specifies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  <span class="keywordflow">while</span> file could be remote,
02917                 that is strongly discouraged.
02918 
02919     Flags - specifies any flags that should be used <span class="keywordflow">for</span> the load operation.
02920             The only valid flag is REG_NO_LAZY_FLUSH.
02921 
02922 
02923 Return Value:
02924 
02925     NTSTATUS - values TBS.
02926 
02927 --*/
02928 
02929 {
02930     OBJECT_ATTRIBUTES File;
02931     OBJECT_ATTRIBUTES Key;
02932     KPROCESSOR_MODE PreviousMode;
02933     UNICODE_STRING CapturedKeyName;
02934     UNICODE_STRING FileName;
02935     USHORT Maximum;
02936     NTSTATUS Status;
02937     PWSTR KeyBuffer;
02938     PSECURITY_DESCRIPTOR CapturedDescriptor;
02939 
02940     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02941 
02942     BEGIN_LOCK_CHECKPOINT;
02943 
02944     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint((<span class="stringliteral">"NtLoadKey\n"</span>));
02945     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API_ARGS, CMS_NTAPI) {
02946         KdPrint((<span class="stringliteral">"\tTargetKey ='%wZ'\n"</span>, TargetKey-&gt;ObjectName));
02947         KdPrint((<span class="stringliteral">"\tSourceFile='%wZ'\n"</span>, SourceFile-&gt;ObjectName));
02948     }
02949 <span class="preprocessor">#ifdef LOG_NT_API</span>
02950 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02951         KdPrint((<span class="stringliteral">"NtLoadKey\n"</span>));
02952     }
02953 <span class="preprocessor">#endif</span>
02954 <span class="preprocessor"></span>    <span class="comment">//</span>
02955     <span class="comment">// Check for illegal flags</span>
02956     <span class="comment">//</span>
02957     <span class="keywordflow">if</span> (Flags &amp; ~REG_NO_LAZY_FLUSH) {
02958         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
02959     }
02960 
02961     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02962     KeyBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02963 
02964     <span class="comment">//</span>
02965     <span class="comment">// The way we do this is a cronk, but at least it's the same cronk we</span>
02966     <span class="comment">// use for all the registry I/O.</span>
02967     <span class="comment">//</span>
02968     <span class="comment">// The file needs to be opened in the worker thread's context, since</span>
02969     <span class="comment">// the resulting handle must be valid when we poke him to go read/write</span>
02970     <span class="comment">// from.  So we just capture the object attributes for the hive file</span>
02971     <span class="comment">// here, then poke the worker thread to go do the rest of the work.</span>
02972     <span class="comment">//</span>
02973 
02974     PreviousMode = KeGetPreviousMode();
02975 
02976     <span class="comment">//</span>
02977     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
02978     <span class="comment">//</span>
02979     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeRestorePrivilege, PreviousMode)) {
02980         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02981     }
02982 
02983     <span class="comment">//</span>
02984     <span class="comment">// CmpNameFromAttributes will probe and capture as necessary.</span>
02985     <span class="comment">//</span>
02986     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02987     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a10">CmpNameFromAttributes</a>(SourceFile,
02988                                    PreviousMode,
02989                                    &amp;FileName);
02990     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02991         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02992         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02993     }
02994 
02995     <span class="keywordflow">try</span> {
02996 
02997         <span class="comment">//</span>
02998         <span class="comment">// Probe the object attributes if necessary.</span>
02999         <span class="comment">//</span>
03000         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03001             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(TargetKey,
03002                          <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES),
03003                          PROBE_ALIGNMENT(OBJECT_ATTRIBUTES) );
03004         }
03005 
03006         <span class="comment">//</span>
03007         <span class="comment">// Capture the object attributes.</span>
03008         <span class="comment">//</span>
03009         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>  = *TargetKey;
03010 
03011         <span class="comment">//</span>
03012         <span class="comment">// Capture the object name.</span>
03013         <span class="comment">//</span>
03014 
03015         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03016             CapturedKeyName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.ObjectName);
03017             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(CapturedKeyName.Buffer,
03018                          CapturedKeyName.Length,
03019                          <span class="keyword">sizeof</span>(WCHAR));
03020         } <span class="keywordflow">else</span> {
03021             CapturedKeyName = *(TargetKey-&gt;ObjectName);
03022         }
03023 
03024         <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>.ObjectName = &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
03025         <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>.SecurityDescriptor = SourceFile-&gt;SecurityDescriptor;
03026 
03027         Maximum = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(CapturedKeyName.Length);
03028 
03029         KeyBuffer = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(PagedPool, Maximum, CM_POOL_TAG);
03030 
03031         <span class="keywordflow">if</span> (KeyBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03032             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
03033             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03034             <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
03035         }
03036 
03037         RtlMoveMemory(KeyBuffer, CapturedKeyName.Buffer, Maximum);
03038         CapturedKeyName.Length = Maximum;
03039         CapturedKeyName.Buffer = KeyBuffer;
03040 
03041         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.ObjectName = &amp;CapturedKeyName;
03042         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03043 
03044         <span class="comment">//</span>
03045         <span class="comment">// Capture the security descriptor.</span>
03046         <span class="comment">//</span>
03047         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>.SecurityDescriptor,
03048                                              PreviousMode,
03049                                              PagedPool,
03050                                              TRUE,
03051                                              &amp;CapturedDescriptor);
03052         <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>.SecurityDescriptor = CapturedDescriptor;
03053 
03054     } except (EXCEPTION_EXECUTE_HANDLER) {
03055         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
03056             KdPrint((<span class="stringliteral">"!!NtLoadKey: code:%08lx\n"</span>, GetExceptionCode()));
03057         }
03058         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03059 
03060     }
03061 
03062     <span class="comment">//</span>
03063     <span class="comment">// Clean up if there was an exception or SeCaptureSD failed.</span>
03064     <span class="comment">//</span>
03065     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03066         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03067             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
03068         }
03069         <span class="keywordflow">if</span> (KeyBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03070             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyBuffer);
03071         }
03072         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03073         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03074     }
03075 
03076     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a240">CmLoadKey</a>(&amp;Key, &amp;File, Flags);
03077 
03078     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
03079     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyBuffer);
03080     <span class="keywordflow">if</span> (CapturedDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03081         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CapturedDescriptor);
03082     }
03083 
03084     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03085 
03086     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03087 
03088     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03089 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="ntapi.c::NtNotifyChangeKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtNotifyChangeKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE Event&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_APC_ROUTINE ApcRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID ApcContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WatchTree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Asynchronous</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01156">1156</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00070">WatchTree</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00080">main()</a>, and <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00387">RegReadApcProcedure()</a>.
<p>
<pre class="fragment"><div>01170                    :
01171 
01172     Notification of key creation, deletion, and modification may be
01173     obtained by calling <a class="code" href="../../d7/d7/ntapi_8c.html#a21">NtNotifyChangeKey</a>.
01174 
01175     <a class="code" href="../../d7/d7/ntapi_8c.html#a21">NtNotifyChangeKey</a> monitors changes to a key - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key or
01176     subtree specified by KeyHandle are modified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service notifies
01177     its caller.  It also returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name(s) of the key(s) that changed.
01178     All names are specified relative to the key that the handle represents
01179     (therefore a NULL name represents that key).  The service completes
01180     once the key or subtree has been modified based on the supplied
01181     CompletionFilter.  The service is a "single shot" and therefore
01182     needs to be reinvoked to watch the key for further changes.
01183 
01184     The operation of this service begins by opening a key for KEY_NOTIFY
01185     access.  Once the handle is returned, the NtNotifyChangeKey service
01186     may be invoked to begin watching the values and subkeys of the
01187     specified key for changes.  The first time the service is invoked,
01188     the BufferSize parameter supplies not only the size of the user's
01189     Buffer, but also the size of the buffer that will be used by the
01190     Registry to store names of keys that have changed.  Likewise, the
01191     CompletionFilter and WatchTree parameters on the first call indicate
01192     how notification should operate for all calls using the supplied
01193     KeyHandle.   These two parameters are ignored on subsequent calls
01194     to the API with the same instance of KeyHandle.
01195 
01196     Once a modification is made that should be reported, the Registry will
01197     complete the service.  The names of the files that have changed since
01198     the last time the service was called will be placed into the caller's
01199     output Buffer.  The Information field of IoStatusBlock will contain
01200     the number of bytes placed in Buffer, or zero if too many keys have
01201     changed since the last time the service was called, in which case
01202     the application must Query and Enumerate the key and sub keys to
01203     discover changes.  The Status field of IoStatusBlock will contain
01204     the actual status of the call.
01205 
01206     If Asynchronous is TRUE, then Event, if specified, will be set to
01207     the Signaled state.  If no Event parameter was specified, then
01208     KeyHandle will be set to the Signaled state.  If an ApcRoutine
01209     was specified, it is invoked with the ApcContext and the address of the
01210     IoStatusBlock as its arguments.  If Asynchronous is FALSE, Event,
01211     ApcRoutine, and ApcContext are ignored.
01212 
01213     This service requires KEY_NOTIFY access to the key that was
01214     actually modified
01215 
01216     The notify "session" is terminated by closing KeyHandle.
01217 
01218 Arguments:
01219 
01220     KeyHandle-- Supplies a handle to an open key.  This handle is
01221         effectively the notify handle, because only one set of
01222         notify parameters may be set against it.
01223 
01224     Event - An optional handle to an event to be set to the
01225         Signaled state when the operation completes.
01226 
01227     ApcRoutine - An optional procedure to be invoked once the
01228         operation completes.  For more information about this
01229         parameter see the NtReadFile system service description.
01230 
01231         If PreviousMode == Kernel, this parameter is an optional
01232         pointer to a <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> to be queued when the notify
01233         is signaled.
01234 
01235     ApcContext - A pointer to pass as an argument to the ApcRoutine,
01236         if one was specified, when the operation completes.  This
01237         argument is required if an ApcRoutine was specified.
01238 
01239         If PreviousMode == Kernel, this parameter is an optional
01240         WORK_QUEUE_TYPE describing the queue to be used. This argument
01241         is required if an ApcRoutine was specified.
01242 
01243     IoStatusBlock - A variable to receive the final completion status.
01244         For more information about this parameter see the NtCreateFile
01245         system service description.
01246 
01247     CompletionFilter -- Specifies a set of flags that indicate the
01248         types of operations on the key or its value that cause the
01249         call to complete.  The following are valid flags for this parameter:
01250 
01251         REG_NOTIFY_CHANGE_NAME -- Specifies that the call should be
01252             completed if a subkey is added or deleted.
01253 
01254         REG_NOTIFY_CHANGE_ATTRIBUTES -- Specifies that the call should
01255             be completed if the attributes (e.g.: ACL) of the key or
01256             any subkey are changed.
01257 
01258         REG_NOTIFY_CHANGE_LAST_SET -- Specifies that the call should be
01259             completed if the lastWriteTime of the key or any of its
01260             subkeys is changed.  (Ie. if the value of the key or any
01261             subkey is changed).
01262 
01263         REG_NOTIFY_CHANGE_SECURITY -- Specifies that the call should be
01264             completed if the security information (e.g. ACL) on the key
01265             or any subkey is changed.
01266 
01267     WatchTree -- A BOOLEAN value that, if TRUE, specifies that all
01268         changes in the subtree of this key should also be reported.
01269         If FALSE, only changes to this key, its value, and its immediate
01270         subkeys (but not their values nor their subkeys) are reported.
01271 
01272     Buffer -- A variable to receive the name(s) of the key(s) that
01273         changed.  See REG_NOTIFY_INFORMATION.
01274 
01275     BufferSize -- Specifies the length of Buffer.
01276 
01277     Asynchronous  -- If FALSE, call will not return until
01278         complete (synchronous) if TRUE, call may return STATUS_PENDING.
01279 
01280 Obs:
01281     Since NtNotifyChangeMultipleKeys, this routine is kept only for bacwards compatibility
01282 
01283 Return Value:
01284 
01285     NTSTATUS - Result code from call, among the following:
01286 
01287         &lt;TBS&gt;
01288 
01289 --*/
01290 {
01291     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01292 
01293     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtNotifyChangeKey\n"));
01294 #ifdef LOG_NT_API
01295     if (CmpLogApi) {
01296         KdPrint((<span class="stringliteral">"NtNotifyChangeKey(%d)\n"</span>,KeyHandle));
01297     }
01298 <span class="preprocessor">#endif</span>
01299 <span class="preprocessor"></span>
01300     <span class="comment">// Just call the wiser routine</span>
01301     <span class="keywordflow">return</span> <a class="code" href="../../d7/d7/ntapi_8c.html#a22">NtNotifyChangeMultipleKeys</a>(
01302                                         KeyHandle,          
01303                                         0,
01304                                         NULL,
01305                                         Event,
01306                                         ApcRoutine,
01307                                         ApcContext,
01308                                         IoStatusBlock,
01309                                         CompletionFilter,
01310                                         WatchTree,
01311                                         Buffer,
01312                                         BufferSize,
01313                                         Asynchronous
01314                                     );
01315 
01316 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="ntapi.c::NtNotifyChangeMultipleKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtNotifyChangeMultipleKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>MasterKeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>SlaveObjects</em>[], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE Event&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_APC_ROUTINE ApcRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID ApcContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WatchTree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Asynchronous</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">1319</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00595">_CM_ASYNC_USER_POST_BLOCK::Apc</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00608">_CM_POST_BLOCK_UNION::AsyncKernel</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00607">_CM_POST_BLOCK_UNION::AsyncUser</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01471">CmpAllocateMasterPostBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01481">CmpAllocateSlavePostBlock</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00159">CmpDummyApc()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00071">CmpExceptionFilter</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00804">CmpPostApc()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00922">CmpPostApcRunDown()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00048">CmpRemoveEntryList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l02019">CmpSetIoStatus</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00600">_CM_ASYNC_KERNEL_POST_BLOCK::Event</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00596">_CM_ASYNC_USER_POST_BLOCK::IoStatusBlock</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01302">KeIsAttachedProcess</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00615">_CM_POST_BLOCK::NotifyList</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a176">PCM_POST_BLOCK</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00204">PKKERNEL_ROUTINE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00214">PKRUNDOWN_ROUTINE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00602">_CM_ASYNC_KERNEL_POST_BLOCK::QueueType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00590">_CM_SYNC_POST_BLOCK::Status</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00606">_CM_POST_BLOCK_UNION::Sync</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00589">_CM_SYNC_POST_BLOCK::SystemEvent</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00616">_CM_POST_BLOCK::ThreadList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00620">_CM_POST_BLOCK::u</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00594">_CM_ASYNC_USER_POST_BLOCK::UserEvent</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00070">WatchTree</a>, <a class="el" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00601">_CM_ASYNC_KERNEL_POST_BLOCK::WorkItem</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01156">NtNotifyChangeKey()</a>.
<p>
<pre class="fragment"><div>01335                    :
01336 
01337     Notificaion of creation, deletion and modification on multiple keys
01338     may be obtained with <a class="code" href="../../d7/d7/ntapi_8c.html#a22">NtNotifyChangeMultipleKeys</a>.
01339 
01340     NtNotifyMultipleKeys monitors changes to any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MasterKeyHandle
01341     or one of SlaveObjects and/or their subtrees, whichever occurs first.
01342     When an event on these keys <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> triggered, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notification <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> considered
01343     fulfilled, and has to be <span class="stringliteral">"armed"</span> again, in order to watch <span class="keywordflow">for</span> further
01344     changes.
01345 
01346     The mechanism <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> similar to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one described in <a class="code" href="../../d7/d7/ntapi_8c.html#a21">NtNotifyChangeKey</a>.
01347 
01348     The MasterKeyHandle key, give <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> over <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lifetime
01349     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notification. The notification will live as <span class="keywordtype">long</span> as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
01350     keeps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MasterKeyHandle open, or an event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> triggered.
01351 
01352     The caller doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> have to open <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SlaveKeys. He will provide <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01353     routine with an array of OBJECT_ATTRIBUTES, describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> slave objects.
01354     The routine will open <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects, and ensure keep a reference on them
01355     untill <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> back-end side will close them.
01356 
01357     The notify <span class="stringliteral">"session"</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> terminated by closing MasterKeyHandle.
01358 
01359 Obs:
01360     For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time being, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine supports <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> one slave object. When more
01361     than one slave object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine will signal an error of
01362     STATUS_INVALID_PARAMETER.
01363     However, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed <span class="keywordflow">for</span> future enhancements (taking an
01364     array of slave objects), that may be provided with future versions(w2001).
01365 
01366     When no slave object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied (i.e. Count == 0) we have the identical
01367     behavior as for NtNotifyChangeKey.
01368 
01369 Arguments:
01370 
01371     MasterKeyHandle - Supplies a handle to an open key.  This handle is
01372         the "master handle". It has control overthe lifetime of the
01373         notification.
01374 
01375     Count - Number of slave objects. For the time being, this should be 1
01376 
01377     SlaveObjects - Array of slave objects. Only the attributes of the
01378         objects are provided, so the caller doesn't have to take care
01379         of them.
01380 
01381     Event,ApcRoutine,ApcContext,IoStatusBlock,CompletionFilter,WatchTree,
01382     Buffer,BufferSize,Asynchronous - same as for NtNotifyChangeKey
01383 
01384 Return Value:
01385 
01386     NTSTATUS - Result code from call, among the following:
01387 
01388         &lt;TBS&gt;
01389 
01390 --*/
01391 {
01392     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
01393     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            WaitStatus;
01394     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>     PreviousMode;
01395     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>        MasterKeyBody;
01396     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>        SlaveKeyBody;
01397     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>             UserEvent=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01398     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      MasterPostBlock;
01399     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      SlavePostBlock;
01400     KIRQL               OldIrql;
01401     HANDLE              SlaveKeyHandle;
01402     <a class="code" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>     PostType = <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>;
01403     BOOLEAN             SlavePresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// assume that we are in the NtNotifyChangeKey case</span>
01404 <span class="preprocessor">#if defined(_WIN64)</span>
01405 <span class="preprocessor"></span>    BOOLEAN             UseIosb32=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">// If the caller is a 32bit process on sundown and previous mode</span>
01406                                          <span class="comment">// is user mode, use a 32bit IoSb.</span>
01407 <span class="preprocessor">#endif</span>
01408 <span class="preprocessor"></span>
01409     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01410 
01411     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
01412 
01413     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtNotifyChangeMultipleKeys\n"));
01414 
01415     if(Count &gt; 1) {
01416         <span class="comment">//</span>
01417         <span class="comment">// This version supports only one slave object</span>
01418         <span class="comment">//</span>
01419         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01420     }
01421 
01422     <span class="keywordflow">if</span>(<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 1) {
01423         <span class="comment">//</span>
01424         <span class="comment">// We have one slave, so we are in the NtNotifyChangeMultipleKeys case</span>
01425         <span class="comment">//</span>
01426         SlavePresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01427     }
01428 
01429 <span class="preprocessor">#ifdef LOG_NT_API</span>
01430 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi &amp;&amp; SlavePresent) {
01431         KdPrint((<span class="stringliteral">"NtNotifyChangeMultipleKeys(%d,%wZ relative to %d, Asynchronous = %d)\n"</span>,MasterKeyHandle,SlaveObjects-&gt;ObjectName,SlaveObjects-&gt;RootDirectory,(<span class="keywordtype">int</span>)Asynchronous));
01432     }
01433 <span class="preprocessor">#endif</span>
01434 <span class="preprocessor"></span>
01435     <span class="comment">//</span>
01436     <span class="comment">// Threads that are attached give us real grief, so disallow it.</span>
01437     <span class="comment">//</span>
01438     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a25">KeIsAttachedProcess</a>()) {
01439         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,8,1,0,0);
01440     }
01441 
01442     <span class="comment">//</span>
01443     <span class="comment">// Probe user buffer parameters.</span>
01444     <span class="comment">//</span>
01445     PreviousMode = KeGetPreviousMode();
01446     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01447 
01448 <span class="preprocessor">#if defined(_WIN64)</span>
01449 <span class="preprocessor"></span>        <span class="comment">// Process is 32bit if Wow64 is not NULL.</span>
01450         UseIosb32 = (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01451 <span class="preprocessor">#endif</span>
01452 <span class="preprocessor"></span>
01453         <span class="keywordflow">try</span> {
01454 
01455             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
01456                 IoStatusBlock,
01457 #<span class="keywordflow">if</span> defined(_WIN64)
01458                 UseIosb32 ? <span class="keyword">sizeof</span>(IO_STATUS_BLOCK32) : <span class="keyword">sizeof</span>(IO_STATUS_BLOCK),
01459 #<span class="keywordflow">else</span>
01460                 <span class="keyword">sizeof</span>(IO_STATUS_BLOCK),
01461 #endif
01462                 <span class="keyword">sizeof</span>(ULONG)
01463                 );
01464 
01465 
01466             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(Buffer, BufferSize, <span class="keyword">sizeof</span>(ULONG));
01467 
01468             <span class="comment">//</span>
01469             <span class="comment">// Initialize IOSB</span>
01470             <span class="comment">//</span>
01471 
01472             <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(IoStatusBlock, STATUS_PENDING, 0, UseIosb32);
01473         } except(EXCEPTION_EXECUTE_HANDLER) {
01474             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01475                 KdPrint((<span class="stringliteral">"!!NtChangeNotifyMultipleKeys: code:%08lx\n"</span>, GetExceptionCode()));
01476             }
01477             <span class="keywordflow">return</span> GetExceptionCode();
01478         }
01479         <span class="keywordflow">if</span> (Asynchronous) {
01480             PostType = <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>;
01481         }
01482     } <span class="keywordflow">else</span> {
01483         <span class="keywordflow">if</span> (Asynchronous) {
01484             PostType = <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>;
01485                         <span class="keywordflow">if</span>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; 0 ) {
01486                 <span class="comment">//</span>
01487                 <span class="comment">// we don't allow multiple asyncronous kernel notifications</span>
01488                 <span class="comment">//</span>
01489                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01490                         }
01491         }
01492     }
01493 
01494     <span class="comment">//</span>
01495     <span class="comment">// Check filter</span>
01496     <span class="comment">//</span>
01497     <span class="keywordflow">if</span> (CompletionFilter != (CompletionFilter &amp; REG_LEGAL_CHANGE_FILTER)) {
01498         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01499     }
01500 
01501     <span class="comment">//</span>
01502     <span class="comment">// Reference the Master Key handle</span>
01503     <span class="comment">//</span>
01504     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01505                 MasterKeyHandle,
01506                 KEY_NOTIFY,
01507                 CmpKeyObjectType,
01508                 PreviousMode,
01509                 (PVOID *)(&amp;MasterKeyBody),
01510                 NULL
01511                 );
01512     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01513         <span class="keywordflow">return</span> status;
01514     }
01515 
01516     <span class="keywordflow">if</span>(SlavePresent) {
01517         <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
01518         <span class="comment">//</span>
01519         <span class="comment">// Open the slave object and add a reference to it.</span>
01520         <span class="comment">//</span>
01521         <span class="keywordflow">try</span> {
01522 
01523             status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(SlaveObjects,
01524                                         CmpKeyObjectType,
01525                                         PreviousMode,
01526                                         NULL,
01527                                         KEY_NOTIFY,
01528                                         NULL,
01529                                         &amp;SlaveKeyHandle);
01530             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01531                 status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(SlaveKeyHandle,
01532                                                    KEY_NOTIFY,
01533                                                    CmpKeyObjectType,
01534                                                    PreviousMode,
01535                                                    (PVOID *)&amp;SlaveKeyBody,
01536                                                    NULL);
01537                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SlaveKeyHandle);
01538 
01539             }
01540 
01541         } except (<a class="code" href="../../d7/d7/ntapi_8c.html#a1">CmpExceptionFilter</a>(GetExceptionInformation())) {
01542             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01543                 KdPrint((<span class="stringliteral">"!!NtNotifyChangeMultipleKeys: code:%08lx\n"</span>, GetExceptionCode()));
01544             }
01545             status = GetExceptionCode();
01546         }
01547 
01548         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01549 
01550         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01551             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01552             <span class="keywordflow">return</span> status;
01553         }
01554 
01555         <span class="comment">//</span>
01556         <span class="comment">// Reject calls setting with keys on the same hive as they could lead to obscure deadlocks</span>
01557         <span class="comment">//</span>
01558         <span class="keywordflow">if</span>( MasterKeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> == SlaveKeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> ) {
01559             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SlaveKeyBody);
01560             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01561             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01562         }
01563     }
01564 
01565 
01566     <span class="comment">//</span>
01567     <span class="comment">// Allocate master and slave post blocks, and init it.  Do NOT put it on the chain,</span>
01568     <span class="comment">// CmNotifyChangeKey will do that while holding a mutex.</span>
01569     <span class="comment">//</span>
01570     <span class="comment">// WARNING: PostBlocks MUST BE ALLOCATED from Pool, since back side</span>
01571     <span class="comment">//          of Notify will free it!</span>
01572     <span class="comment">//</span>
01573     <span class="comment">//</span>
01574     <span class="comment">// Exclusively lock the registry; We want nobody to mess with it while we are doing the</span>
01575     <span class="comment">// post/notify list manipulation; what else could be safer than that :-)</span>
01576     <span class="comment">//</span>
01577     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01578     MasterPostBlock = <a class="code" href="../../d1/d2/cmp_8h.html#a122">CmpAllocateMasterPostBlock</a>(PostType);
01579     <span class="keywordflow">if</span> (MasterPostBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01580         <span class="keywordflow">if</span>(SlavePresent) {
01581             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SlaveKeyBody);
01582         }
01583         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01584         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01585         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01586     }
01587 
01588 <span class="preprocessor">#if DBG</span>
01589 <span class="preprocessor"></span>    MasterPostBlock-&gt;TraceIntoDebugger = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01590 <span class="preprocessor">#endif</span>
01591 <span class="preprocessor"></span>
01592     <span class="keywordflow">if</span>(SlavePresent) {
01593         SlavePostBlock = <a class="code" href="../../d1/d2/cmp_8h.html#a123">CmpAllocateSlavePostBlock</a>(PostType,SlaveKeyBody,MasterPostBlock);
01594         <span class="keywordflow">if</span> (SlavePostBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01595             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SlaveKeyBody);
01596             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01597             <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01598             <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01599             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01600         }
01601 
01602 <span class="preprocessor">#if DBG</span>
01603 <span class="preprocessor"></span>        SlavePostBlock-&gt;TraceIntoDebugger = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01604 <span class="preprocessor">#endif</span>
01605 <span class="preprocessor"></span>    }
01606 
01607     <span class="keywordflow">if</span> ((PostType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>) ||
01608         (PostType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>)) {
01609 
01610         <span class="comment">//</span>
01611         <span class="comment">// If event is present, reference it, save its address, and set</span>
01612         <span class="comment">// it to the not signaled state.</span>
01613         <span class="comment">//</span>
01614         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Event)) {
01615             status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01616                             Event,
01617                             EVENT_MODIFY_STATE,
01618                             ExEventObjectType,
01619                             PreviousMode,
01620                             (PVOID *)(&amp;UserEvent),
01621                             NULL
01622                             );
01623             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01624                 <span class="keywordflow">if</span>(SlavePresent) {
01625                     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01626                     <span class="comment">// SlaveKeyBody is dereferenced in CmpFreePostBlock(SlavePostBlock)</span>
01627                 }
01628                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01629                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01630                 <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01631                 <span class="keywordflow">return</span> status;
01632             } <span class="keywordflow">else</span> {
01633                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(UserEvent);
01634             }
01635         }
01636 
01637         <span class="keywordflow">if</span> (PostType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>) {
01638             <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>     ApcMode;
01639 
01640             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a> = IoStatusBlock;
01641             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> = UserEvent;
01642             <span class="comment">//</span>
01643             <span class="comment">// Initialize APC.  May or may not be a user apc, will always</span>
01644             <span class="comment">// be a kernel apc.</span>
01645             <span class="comment">//</span>
01646             ApcMode = PreviousMode;
01647             <span class="keywordflow">if</span>( ApcRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01648                 ApcRoutine = (PIO_APC_ROUTINE)<a class="code" href="../../d0/d2/cmnotify_8c.html#a8">CmpDummyApc</a>;
01649                 ApcMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
01650             }
01651             <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o1">Apc</a>,
01652                             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(),
01653                             CurrentApcEnvironment,
01654                             (PKKERNEL_ROUTINE)CmpPostApc,
01655                             (PKRUNDOWN_ROUTINE)CmpPostApcRunDown,
01656                             (PKNORMAL_ROUTINE)ApcRoutine,
01657                             ApcMode,
01658                             ApcContext);
01659 
01660         } <span class="keywordflow">else</span> {
01661             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o0">Event</a> = UserEvent;
01662             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o1">WorkItem</a> = (<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>)ApcRoutine;
01663             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o2">QueueType</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a>)((ULONG_PTR)ApcContext);
01664         }
01665     }
01666 
01667 
01668     <span class="comment">//</span>
01669     <span class="comment">// Call worker for master</span>
01670     <span class="comment">//</span>
01671     status = <a class="code" href="../../d1/d2/cmp_8h.html#a239">CmpNotifyChangeKey</a>(
01672                 MasterKeyBody,
01673                 MasterPostBlock,
01674                 CompletionFilter,
01675                 WatchTree,
01676                 Buffer,
01677                 BufferSize,
01678                 MasterPostBlock
01679                 );
01680     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01681         <span class="comment">//</span>
01682         <span class="comment">// it didn't work, clean up for error path</span>
01683         <span class="comment">//</span>
01684         <span class="keywordflow">if</span> (UserEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01685             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(UserEvent);
01686         }
01687 
01688         <span class="keywordflow">if</span>(SlavePresent) {
01689             <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01690             <span class="comment">// SlaveKeyBody is dereferenced in CmpFreePostBlock(SlavePostBlock)</span>
01691         }
01692         <span class="comment">// MasterPostBlock if freed by CmpNotifyChangeKey !!!</span>
01693         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01694         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01695         <span class="keywordflow">return</span> status;
01696 
01697     }
01698 
01699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_PENDING || status == STATUS_SUCCESS);
01700 
01701     <span class="keywordflow">if</span>(SlavePresent) {
01702         <span class="keywordflow">if</span>( status == STATUS_SUCCESS ) {
01703             <span class="comment">//</span>
01704             <span class="comment">// The notify has already been triggered for the master, there is no point to set one for the slave too</span>
01705             <span class="comment">// Clean up the mess we made for the slave object and signal as there is no slave present</span>
01706             <span class="comment">//</span>
01707             <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01708             SlavePresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01709         } <span class="keywordflow">else</span> {
01710             <span class="comment">//</span>
01711             <span class="comment">// Call worker for slave</span>
01712             <span class="comment">//</span>
01713             status = <a class="code" href="../../d1/d2/cmp_8h.html#a239">CmpNotifyChangeKey</a>(
01714                         SlaveKeyBody,
01715                         SlavePostBlock,
01716                         CompletionFilter,
01717                         WatchTree,
01718                         Buffer,
01719                         BufferSize,
01720                         MasterPostBlock
01721                         );
01722             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01723                 <span class="comment">//</span>
01724                 <span class="comment">// if we are here, the slave key has been deleted in between or there was no memory available to allocate</span>
01725                 <span class="comment">// a notify block for the slave key. We do the cleanup here since we already hold the registry lock</span>
01726                 <span class="comment">// exclusively and we don't want to give a anybody else a chance to trigger the notification on master post</span>
01727                 <span class="comment">// (otherwise we could end up freeing it twice). The master post block and the user event are cleaned later,</span>
01728                 <span class="comment">// covering both single and multiple notifications cases</span>
01729                 <span class="comment">//</span>
01730 
01731                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01732                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01733 
01734                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
01735                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01736                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01737                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01738             }
01739         }
01740     }
01741 
01742     <span class="comment">//</span>
01743     <span class="comment">// postblocks are now on various lists, so we can die without losing them</span>
01744     <span class="comment">//</span>
01745     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01746 
01747     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01748         <span class="comment">//</span>
01749         <span class="comment">// success.  wait for event if sync.</span>
01750         <span class="comment">// do NOT deref User event, back side of notify will do that.</span>
01751         <span class="comment">//</span>
01752         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_PENDING || status == STATUS_SUCCESS);
01753 
01754         <span class="keywordflow">if</span> (PostType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>) {
01755             WaitStatus = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o0">SystemEvent</a>,
01756                                                Executive,
01757                                                PreviousMode,
01758                                                TRUE,
01759                                                NULL);
01760 
01761 
01762             <span class="keywordflow">if</span> ((WaitStatus==STATUS_ALERTED) || (WaitStatus == STATUS_USER_APC)) {
01763 
01764                 <span class="comment">//</span>
01765                 <span class="comment">// The wait was aborted, clean up and return.</span>
01766                 <span class="comment">//</span>
01767                 <span class="comment">// 1. Remove the PostBlocks from the notify list.  This</span>
01768                 <span class="comment">//    is normally done by the back end of notify, but</span>
01769                 <span class="comment">//    we have to do it here since the back end is not</span>
01770                 <span class="comment">//    involved.</span>
01771                 <span class="comment">// 2. Delist and free the post blocks</span>
01772                 <span class="comment">//</span>
01773                 <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01774 
01775                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
01776                 <span class="keywordflow">if</span>(SlavePresent) {
01777                     <span class="keywordflow">if</span> (SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01778                         <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01779                         <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01780                     }
01781                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01782                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01783                 }
01784 
01785                 <span class="keywordflow">if</span> (MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01786                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01787                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01788                 }
01789                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01790                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01791                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01792 
01793                 <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01794 
01795                 <span class="keywordflow">if</span>(SlavePresent) {
01796                     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01797                 }
01798                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01799 
01800                 status = WaitStatus;
01801 
01802             } <span class="keywordflow">else</span> {
01803                 <span class="comment">//</span>
01804                 <span class="comment">// The wait was satisfied, which means the back end has</span>
01805                 <span class="comment">// already removed the postblock from the notify list.</span>
01806                 <span class="comment">// We just have to delist and free the post block.</span>
01807                 <span class="comment">//</span>
01808 
01809                 <span class="comment">//</span>
01810                 <span class="comment">// Aquire the registry lock exclusive to enter the post block rule prerequisites</span>
01811                 <span class="comment">//</span>
01812                 <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01813 
01814                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;OldIrql);
01815                 <span class="keywordflow">if</span>(SlavePresent) {
01816                     <span class="keywordflow">if</span> (SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01817                         <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01818                         <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01819                     }
01820                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01821                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01822                 }
01823 
01824                 <span class="keywordflow">if</span> (MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01825                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01826                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01827                 }
01828                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01829                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01830                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01831 
01832                 <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01833 
01834                 status = MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o1">Status</a>;
01835 
01836                 <span class="keywordflow">try</span> {
01837                     <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(IoStatusBlock, status, 0, UseIosb32);
01838                 } except (EXCEPTION_EXECUTE_HANDLER) {
01839                     status = GetExceptionCode();
01840                 }
01841 
01842                 <span class="keywordflow">if</span>(SlavePresent) {
01843                     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01844                 }
01845                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01846             }
01847         }
01848 
01849     } <span class="keywordflow">else</span> {
01850         <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01851         <span class="comment">//</span>
01852         <span class="comment">// it didn't work, clean up for error path</span>
01853         <span class="comment">//</span>
01854         <span class="keywordflow">if</span> (UserEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01855             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(UserEvent);
01856         }
01857     }
01858 
01859     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01860     <span class="comment">//</span>
01861     <span class="comment">// Don't dereference SlaveKeyBody!!! =&gt; Back-end routine will do that !!!</span>
01862     <span class="comment">//</span>
01863 
01864     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
01865 
01866     <span class="keywordflow">return</span> status;
01867 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="ntapi.c::NtOpenKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtOpenKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">1870</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00071">CmpExceptionFilter</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01581">ProbeAndZeroHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00818">bLoadableFontDrivers()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">CheckRestricted()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04516">CheckValidLayoutName()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00260">CliGetImeHotKeysFromRegistry()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00353">CliSetSingleHotKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04155">CmpCreatePerfKeys()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00037">CmpInitializeMachineDependentConfiguration()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">CmpInterlockedFunction()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l01264">CmpOpenRegKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d7/d2/rttrecpy_8c-source.html#l00114">Copy()</a>, <a class="el" href="../../d1/d0/rtdeltre_8c-source.html#l00103">Delete()</a>, <a class="el" href="../../d3/d6/regtest_8c-source.html#l00045">DoTest()</a>, <a class="el" href="../../d3/d0/rtdmp_8c-source.html#l00126">Dump()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00357">FtOpenKey()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03729">GetActiveKeyboardName()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00598">GetBadAppCmdLine()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00255">GetErrorMode()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00118">GetRealDllFileNameWorker()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01983">GetServerIMEKeyboardLayout()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00053">IopProtectSystemPartition()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00199">KbdLayerRealDllFileForWBT()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00933">LoadAppDlls()</a>, <a class="el" href="../../d0/d0/rtdelkey_8c-source.html#l00048">main()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01635">MyRegOpenKey()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04019">OpenKeyboardLayoutFile()</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00099">processargs()</a>, <a class="el" href="../../d6/d4/prodtype_8c-source.html#l00030">RtlGetNtProductType()</a>, <a class="el" href="../../d2/d6/rtl_2registry_8c-source.html#l00070">RtlpNtOpenKey()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01717">RXactpOpenTargetKey()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00425">SepAdtInitializeAuditingOptions()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00117">SepAdtInitializeBounds()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00242">SepAdtInitializeCrashOnFail()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00329">SepAdtInitializePrivilegeAuditing()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00431">StartRegReadRead()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.
<p>
<pre class="fragment"><div>01877                    :
01878 
01879     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> registry key which already exists may be opened with <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>.
01880 
01881     Share access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> computed from desired access.
01882 
01883 Arguments:
01884 
01885     KeyHandle - Receives a  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to access <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01886         specified key in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Registration Database.
01887 
01888     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access rights desired.
01889 
01890     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key being opened.
01891         Note that a key name must be specified.  If a Root <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>
01892         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root.  The name of
01893         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object must be within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name space allocated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01894         Registry, that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, all names beginning <span class="stringliteral">"\Registry"</span>.  RootHandle,
01895         <span class="keywordflow">if</span> present, must be a handle to <span class="stringliteral">"\", or "</span>\Registry<span class="stringliteral">", or a</span>
01896 <span class="stringliteral">        key under "</span>\Registry<span class="stringliteral">".  If the specified key does not exist, or</span>
01897 <span class="stringliteral">        access requested is not allowed, the operation will fail.</span>
01898 <span class="stringliteral"></span>
01899 <span class="stringliteral">        NOTE:   Object manager will capture and probe this argument.</span>
01900 <span class="stringliteral"></span>
01901 <span class="stringliteral">Return Value:</span>
01902 <span class="stringliteral"></span>
01903 <span class="stringliteral">    NTSTATUS - Result code from call, among the following:</span>
01904 <span class="stringliteral"></span>
01905 <span class="stringliteral">        &lt;TBS&gt;</span>
01906 <span class="stringliteral"></span>
01907 <span class="stringliteral">--*/</span>
01908 <span class="stringliteral">{</span>
01909 <span class="stringliteral">    NTSTATUS    status;</span>
01910 <span class="stringliteral">    KPROCESSOR_MODE mode;</span>
01911 <span class="stringliteral">    PCM_KEY_BODY KeyBody;</span>
01912 <span class="stringliteral">    HANDLE Handle =0;</span>
01913 <span class="stringliteral">    UNICODE_STRING CapturedObjectName = {0};</span>
01914 <span class="stringliteral"></span>
01915 <span class="stringliteral">    // Start registry call tracing</span>
01916 <span class="stringliteral">    StartWmiCmTrace();</span>
01917 <span class="stringliteral"></span>
01918 <span class="stringliteral">    PAGED_CODE();</span>
01919 <span class="stringliteral"></span>
01920 <span class="stringliteral">    BEGIN_LOCK_CHECKPOINT;</span>
01921 <span class="stringliteral"></span>
01922 <span class="stringliteral">    CMLOG(CML_API, CMS_NTAPI) KdPrint(("</span><a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">"));</span>
01923 <span class="stringliteral">    CMLOG(CML_API_ARGS, CMS_NTAPI) {</span>
01924 <span class="stringliteral">        KdPrint(("</span>\tDesiredAccess=%08lx <span class="stringliteral">", DesiredAccess));</span>
01925 <span class="stringliteral">        KdPrint(("</span>\tRootHandle=%08lx\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">", ObjectAttributes-&gt;RootDirectory));</span>
01926 <span class="stringliteral">        KdPrint(("</span>\tName='%wZ'\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">", ObjectAttributes-&gt;ObjectName));</span>
01927 <span class="stringliteral">    }</span>
01928 <span class="stringliteral"></span>
01929 <span class="stringliteral">    mode = KeGetPreviousMode();</span>
01930 <span class="stringliteral"></span>
01931 <span class="stringliteral">    CmpLockRegistry();</span>
01932 <span class="stringliteral"></span>
01933 <span class="stringliteral">#ifdef LOG_NT_API</span>
01934 <span class="stringliteral">    if (CmpLogApi) {</span>
01935 <span class="stringliteral">        KdPrint(("</span><a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> %wZ relative to %d...<span class="stringliteral">",</span>
01936 <span class="stringliteral">                 ObjectAttributes-&gt;ObjectName,</span>
01937 <span class="stringliteral">                 ObjectAttributes-&gt;RootDirectory));</span>
01938 <span class="stringliteral">    }</span>
01939 <span class="stringliteral">#endif</span>
01940 <span class="stringliteral"></span>
01941 <span class="stringliteral">    try {</span>
01942 <span class="stringliteral"></span>
01943 <span class="stringliteral">        if (mode == UserMode) {</span>
01944 <span class="stringliteral">            ProbeAndZeroHandle(KeyHandle);</span>
01945 <span class="stringliteral">            //</span>
01946 <span class="stringliteral">            // probe the ObjectAttributes as we shall use it for tracing</span>
01947 <span class="stringliteral">            //</span>
01948 <span class="stringliteral">            ProbeForRead( ObjectAttributes,</span>
01949 <span class="stringliteral">                          sizeof(OBJECT_ATTRIBUTES),</span>
01950 <span class="stringliteral">                          PROBE_ALIGNMENT(OBJECT_ATTRIBUTES) );</span>
01951 <span class="stringliteral">            CapturedObjectName = ProbeAndReadUnicodeString(ObjectAttributes-&gt;ObjectName);</span>
01952 <span class="stringliteral">            ProbeForRead(</span>
01953 <span class="stringliteral">                CapturedObjectName.Buffer,</span>
01954 <span class="stringliteral">                CapturedObjectName.Length,</span>
01955 <span class="stringliteral">                sizeof(WCHAR)</span>
01956 <span class="stringliteral">                );</span>
01957 <span class="stringliteral"></span>
01958 <span class="stringliteral">        } else {</span>
01959 <span class="stringliteral">            CapturedObjectName = *(ObjectAttributes-&gt;ObjectName);</span>
01960 <span class="stringliteral">        }</span>
01961 <span class="stringliteral"></span>
01962 <span class="stringliteral">        status = ObOpenObjectByName(</span>
01963 <span class="stringliteral">                    ObjectAttributes,</span>
01964 <span class="stringliteral">                    CmpKeyObjectType,</span>
01965 <span class="stringliteral">                    mode,</span>
01966 <span class="stringliteral">                    NULL,</span>
01967 <span class="stringliteral">                    DesiredAccess,</span>
01968 <span class="stringliteral">                    NULL,</span>
01969 <span class="stringliteral">                    &amp;Handle</span>
01970 <span class="stringliteral">                    );</span>
01971 <span class="stringliteral">        if (status==STATUS_PREDEFINED_HANDLE) {</span>
01972 <span class="stringliteral">            status = ObReferenceObjectByHandle(Handle,</span>
01973 <span class="stringliteral">                                               0,</span>
01974 <span class="stringliteral">                                               CmpKeyObjectType,</span>
01975 <span class="stringliteral">                                               KernelMode,</span>
01976 <span class="stringliteral">                                               (PVOID *)(&amp;KeyBody),</span>
01977 <span class="stringliteral">                                               NULL);</span>
01978 <span class="stringliteral">            if (NT_SUCCESS(status)) {</span>
01979 <span class="stringliteral">                *KeyHandle = (HANDLE)LongToHandle(KeyBody-&gt;Type);</span>
01980 <span class="stringliteral">                ObDereferenceObject((PVOID)KeyBody);</span>
01981 <span class="stringliteral">                status = STATUS_SUCCESS;</span>
01982 <span class="stringliteral">            }</span>
01983 <span class="stringliteral">            NtClose(Handle);</span>
01984 <span class="stringliteral">            Handle = *KeyHandle;</span>
01985 <span class="stringliteral">        } else</span>
01986 <span class="stringliteral">        if (NT_SUCCESS(status)) {</span>
01987 <span class="stringliteral">            *KeyHandle = Handle;</span>
01988 <span class="stringliteral">        }</span>
01989 <span class="stringliteral"></span>
01990 <span class="stringliteral">    } except (CmpExceptionFilter(GetExceptionInformation())) {</span>
01991 <span class="stringliteral">        CMLOG(CML_API, CMS_EXCEPTION) {</span>
01992 <span class="stringliteral">            KdPrint(("</span>!!<a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>: code:%08lx\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">", GetExceptionCode()));</span>
01993 <span class="stringliteral">        }</span>
01994 <span class="stringliteral">        status = GetExceptionCode();</span>
01995 <span class="stringliteral">    }</span>
01996 <span class="stringliteral">#ifdef LOG_NT_API</span>
01997 <span class="stringliteral">    if (CmpLogApi) {</span>
01998 <span class="stringliteral">        if (NT_SUCCESS(status)) {</span>
01999 <span class="stringliteral">            KdPrint(("</span>succeeded %d\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">",Handle));</span>
02000 <span class="stringliteral">        } else {</span>
02001 <span class="stringliteral">            KdPrint(("</span>failed %08lx\<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a><span class="stringliteral">",status));</span>
02002 <span class="stringliteral">        }</span>
02003 <span class="stringliteral">    }</span>
02004 <span class="stringliteral">#endif</span>
02005 <span class="stringliteral"></span>
02006 <span class="stringliteral">    CmpUnlockRegistry();</span>
02007 <span class="stringliteral"></span>
02008 <span class="stringliteral">    END_LOCK_CHECKPOINT;</span>
02009 <span class="stringliteral"></span>
02010 <span class="stringliteral">        // End registry call tracing</span>
02011 <span class="stringliteral">        EndWmiCmTrace(status,Handle,&amp;CapturedObjectName,EVENT_TRACE_TYPE_REGOPEN);</span>
02012 <span class="stringliteral"></span>
02013 <span class="stringliteral">    return  status;</span>
02014 <span class="stringliteral">}</span>
</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="ntapi.c::NtQueryKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">2018</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00818">bLoadableFontDrivers()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d5/d1/rtmisc1_8c-source.html#l00075">main()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.
<p>
<pre class="fragment"><div>02027                    :
02028 
02029     Data about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of a key, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> numbers and sizes of its
02030     children and value entries may be queried with <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>.
02031 
02032     If KeyValueInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not long enough to hold all requested data,
02033     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
02034     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
02035 
02036     NOTE: The returned lengths are guaranteed to be at least as
02037           long as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> described values, but may be longer in
02038           some circumstances.
02039 
02040 Arguments:
02041 
02042     KeyHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to query data for.  Must have been
02043         opened for KEY_QUERY_KEY access.
02044 
02045     KeyInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information
02046         returned in <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following types:
02047 
02048         KeyBasicInformation - return last write time, title index, and name.
02049             (See KEY_BASIC_INFORMATION)
02050 
02051         KeyNodeInformation - return last write time, title index, name, class.
02052             (See KEY_NODE_INFORMATION)
02053 
02054         KeyFullInformation - return all data except for name and security.
02055             (See KEY_FULL_INFORMATION)
02056 
02057     KeyInformation -Supplies pointer to buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
02058 
02059     Length - Length of KeyInformation in bytes.
02060 
02061     ResultLength - Number of bytes actually written into KeyInformation.
02062 
02063 Return Value:
02064 
02065     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
02066 
02067         &lt;TBS&gt;
02068 
02069 --*/
02070 {
02071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02072     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02073     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02074 
02075     <span class="comment">// Start registry call tracing</span>
02076     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
02077 
02078     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02079 
02080     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02081 
02082     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtQueryKey\n"));
02083 #ifdef LOG_NT_API
02084     if (CmpLogApi) {
02085         KdPrint((<span class="stringliteral">"NtQueryKey %d %d\n"</span>,KeyHandle,KeyInformationClass));
02086     }
02087 <span class="preprocessor">#endif</span>
02088 <span class="preprocessor"></span>
02089     <span class="keywordflow">if</span> ((KeyInformationClass != KeyBasicInformation) &amp;&amp;
02090         (KeyInformationClass != KeyNodeInformation)  &amp;&amp;
02091         (KeyInformationClass != KeyFullInformation)  &amp;&amp;
02092         (KeyInformationClass != KeyNameInformation) )
02093     {
02094 
02095         <span class="comment">// End registry call tracing</span>
02096         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_PARAMETER,KeyHandle,NULL,EVENT_TRACE_TYPE_REGQUERY);
02097 
02098         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02099     }
02100 
02101     mode = KeGetPreviousMode();
02102 
02103     <span class="keywordflow">if</span>( KeyInformationClass == KeyNameInformation ){
02104         <span class="comment">//</span>
02105         <span class="comment">// special case: name information is available regardless of the access level</span>
02106         <span class="comment">// you have on the key  (provided that you have some ...)</span>
02107         <span class="comment">//</span>
02108 
02109         <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInfo;
02110 
02111         <span class="comment">// reference with "no access required"</span>
02112         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02113                 KeyHandle,
02114                 0,
02115                 CmpKeyObjectType,
02116                 mode,
02117                 (PVOID *)(&amp;KeyBody),
02118                 &amp;HandleInfo
02119                 );
02120         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
02121             <span class="keywordflow">if</span>( HandleInfo.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a> == 0 ) {
02122                 <span class="comment">//</span>
02123                 <span class="comment">// no access is granted on the handle; bad luck!</span>
02124                 <span class="comment">//</span>
02125                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02126 
02127                 status = STATUS_ACCESS_DENIED;
02128             }
02129         }
02130     } <span class="keywordflow">else</span> {
02131         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02132                 KeyHandle,
02133                 KEY_QUERY_VALUE,
02134                 CmpKeyObjectType,
02135                 mode,
02136                 (PVOID *)(&amp;KeyBody),
02137                 NULL
02138                 );
02139     }
02140 
02141     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02142 
02143         <span class="keywordflow">try</span> {
02144             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02145                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
02146                     KeyInformation,
02147                     Length,
02148                     <span class="keyword">sizeof</span>(ULONG)
02149                     );
02150                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ResultLength);
02151             }
02152 
02153         } except (EXCEPTION_EXECUTE_HANDLER) {
02154             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
02155                 KdPrint((<span class="stringliteral">"!!NtQueryKey: code:%08lx\n"</span>, GetExceptionCode()));
02156             }
02157             status = GetExceptionCode();
02158         }
02159 
02160         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02161             <span class="comment">//</span>
02162             <span class="comment">// CmQueryKey is protected to user mode buffer exceptions</span>
02163             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
02164             <span class="comment">//</span>
02165             status = <a class="code" href="../../d1/d2/cmp_8h.html#a229">CmQueryKey</a>(
02166                         KeyBody-&gt;KeyControlBlock,
02167                         KeyInformationClass,
02168                         KeyInformation,
02169                         Length,
02170                         ResultLength
02171                         );
02172         }
02173 
02174         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02175     }
02176 
02177     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02178 
02179     <span class="comment">// End registry call tracing</span>
02180     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,NULL,EVENT_TRACE_TYPE_REGQUERY);
02181 
02182     <span class="keywordflow">return</span> status;
02183 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="ntapi.c::NtQueryMultipleValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSYSAPI NTSTATUS NTAPI NtQueryMultipleValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEY_VALUE_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>EntryCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT OPTIONAL PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RequiredBufferLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">3461</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">CmQueryMultipleValueKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01339">ProbeAndReadUlong</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d2/d0/hivedmp_8c-source.html#l00060">ValueBuffer</a>.
<p>
<pre class="fragment"><div>03471                    :
03472 
03473     Multiple values of any key may be queried atomically with
03474     <span class="keyword">this</span> api.
03475 
03476 Arguments:
03477 
03478     KeyHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to be queried.
03479 
03480     ValueNames - Supplies an array of value names to be queried
03481 
03482     ValueEntries - Returns an array of KEY_VALUE_ENTRY structures, one <span class="keywordflow">for</span> each value.
03483 
03484     EntryCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ValueNames and ValueEntries arrays
03485 
03486     <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value data <span class="keywordflow">for</span> each value.
03487 
03488     BufferLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> array in bytes.
03489                    Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> array that was filled in.
03490 
03491     RequiredBufferLength - <span class="keywordflow">if</span> present, Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>
03492                     array required to <span class="keywordflow">return</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values of <span class="keyword">this</span> key.
03493 
03494 Return Value:
03495 
03496     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03497 
03498 --*/
03499 
03500 {
03501     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
03502     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03503     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
03504     ULONG i;
03505     ULONG LocalBufferLength;
03506 
03507     <span class="comment">// Start registry call tracing</span>
03508     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
03509 
03510     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03511 
03512     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
03513 
03514     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtQueryMultipleValueKey\n"));
03515     CMLOG(CML_API_ARGS, CMS_NTAPI) {
03516         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
03517     }
03518 <span class="preprocessor">#ifdef LOG_NT_API</span>
03519 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
03520         KdPrint((<span class="stringliteral">"NtQueryMultipleValueKey\n"</span>));
03521     }
03522 <span class="preprocessor">#endif</span>
03523 <span class="preprocessor"></span>
03524     PreviousMode = KeGetPreviousMode();
03525     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
03526                                        KEY_QUERY_VALUE,
03527                                        CmpKeyObjectType,
03528                                        PreviousMode,
03529                                        (PVOID *)(&amp;KeyBody),
03530                                        NULL);
03531     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03532         <span class="keywordflow">try</span> {
03533             <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03534                 LocalBufferLength = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>(BufferLength);
03535 
03536                 <span class="comment">//</span>
03537                 <span class="comment">// Probe the output buffers</span>
03538                 <span class="comment">//</span>
03539                 <span class="comment">// Put an arbitrary 64K limit on the number of entries to</span>
03540                 <span class="comment">// prevent bogus apps from passing an EntryCount large enough</span>
03541                 <span class="comment">// to overflow the EntryCount * sizeof(KEY_VALUE_ENTRY) calculation.</span>
03542                 <span class="comment">//</span>
03543                 <span class="keywordflow">if</span> (EntryCount &gt; 0x10000) {
03544                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
03545                 }
03546                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ValueEntries,
03547                               EntryCount * <span class="keyword">sizeof</span>(KEY_VALUE_ENTRY),
03548                               <span class="keyword">sizeof</span>(ULONG));
03549                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RequiredBufferLength)) {
03550                     <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(RequiredBufferLength);
03551                 }
03552 
03553                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ValueBuffer,
03554                               LocalBufferLength,
03555                               <span class="keyword">sizeof</span>(ULONG));
03556 
03557             } <span class="keywordflow">else</span> {
03558                 LocalBufferLength = *BufferLength;
03559             }
03560 
03561         } except(EXCEPTION_EXECUTE_HANDLER) {
03562             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
03563                 KdPrint((<span class="stringliteral">"!!NtQueryMultipleValueKey: code:%08lx\n"</span>,GetExceptionCode()));
03564             }
03565             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03566         }
03567 
03568         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03569             <span class="comment">//</span>
03570             <span class="comment">// CmQueryMultipleValueKey is protected to user mode buffer exceptions</span>
03571             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
03572             <span class="comment">//</span>
03573             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a231">CmQueryMultipleValueKey</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
03574                                              ValueEntries,
03575                                              EntryCount,
03576                                              ValueBuffer,
03577                                              &amp;LocalBufferLength,
03578                                              RequiredBufferLength);
03579             <span class="keywordflow">try</span> {
03580                 <span class="comment">// anybody messed with BufferLength in between?</span>
03581                 *BufferLength = LocalBufferLength;
03582             } except(EXCEPTION_EXECUTE_HANDLER) {
03583                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
03584                     KdPrint((<span class="stringliteral">"!!NtQueryMultipleValueKey: code:%08lx\n"</span>,GetExceptionCode()));
03585                 }
03586                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03587             }
03588         }
03589         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
03590     }
03591 
03592     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03593 
03594     <span class="comment">// End registry call tracing</span>
03595     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(Status,KeyHandle,NULL,EVENT_TRACE_TYPE_REGQUERYMULTIPLEVALUE);
03596 
03597     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03598 
03599 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="ntapi.c::NtQueryOpenSubKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryOpenSubKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">4090</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04059">CmpEnumKeyObjectCallback()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04054">CmpOpenSubKeys</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00346">_HBASE_BLOCK::FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00280">_CM_KEY_CONTROL_BLOCK::KeyCell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00478">ObEnumerateObjectsByType()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a105a102">SearchAndCount</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>04096                    :
04097 
04098     Dumps all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target key that are kept open by some other
04099     process; Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of open subkeys
04100 
04101 
04102 Arguments:
04103 
04104     TargetKey - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to a key to link <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to.
04105                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> must be of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> form <span class="stringliteral">"\registry\user&lt;username&gt;"</span>
04106 
04107 Return Value:
04108 
04109     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - values TBS.
04110 
04111 --*/
04112 {
04113     HANDLE KeyHandle;
04114     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04115     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
04116     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
04117     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
04118     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
04119     UNICODE_STRING  HiveName;
04120 
04121     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04122 
04123     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
04124 
04125     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtQueryOpenSubKeys\n"));
04126     CMLOG(CML_API_ARGS, CMS_NTAPI) {
04127         KdPrint((<span class="stringliteral">"\tTargetKey ='%wZ'\n"</span>, TargetKey-&gt;ObjectName));
04128     }
04129 <span class="preprocessor">#ifdef LOG_NT_API</span>
04130 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
04131         KdPrint((<span class="stringliteral">"NtQueryOpenSubKeys\n"</span>));
04132     }
04133 <span class="preprocessor">#endif</span>
04134 <span class="preprocessor"></span>
04135     PreviousMode = KeGetPreviousMode();
04136 
04137     <span class="comment">//</span>
04138     <span class="comment">// lock registry exclusive so nobody messes with it while we're around</span>
04139     <span class="comment">//</span>
04140     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
04141 
04142     <span class="keywordflow">try</span> {
04143 
04144         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
04145             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(HandleCount);
04146         }
04147 
04148         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(TargetKey,
04149                                     CmpKeyObjectType,
04150                                     PreviousMode,
04151                                     NULL,
04152                                     KEY_READ,
04153                                     NULL,
04154                                     &amp;KeyHandle);
04155         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04156             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
04157                                                KEY_READ,
04158                                                CmpKeyObjectType,
04159                                                PreviousMode,
04160                                                (PVOID *)&amp;KeyBody,
04161                                                NULL);
04162             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
04163         }
04164 
04165     } except (EXCEPTION_EXECUTE_HANDLER) {
04166         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04167         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
04168             KdPrint((<span class="stringliteral">"!!NtQueryOpenSubKeys: code:%08lx\n"</span>, Status));
04169         }
04170     }
04171 
04172     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04173         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
04174         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
04175 
04176 
04177         <span class="comment">//</span>
04178         <span class="comment">// Make sure the cell passed in is the root cell of the hive.</span>
04179         <span class="comment">//</span>
04180         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> != <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>) {
04181             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
04182             <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
04183             <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
04184         }
04185 
04186         <span class="comment">//</span>
04187         <span class="comment">// Dump the hive name and hive address</span>
04188         <span class="comment">//</span>
04189         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;HiveName, (PCWSTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>);
04190         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n Subkeys open inside the hive (%lx) (%.*S) :\n\n"</span>,Hive,HiveName.Length / <span class="keyword">sizeof</span>(WCHAR),HiveName.Buffer);
04191 
04192         <span class="comment">//</span>
04193         <span class="comment">// dump open subkeys (if any)</span>
04194         <span class="comment">//</span>
04195 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
04196 <span class="preprocessor"></span>        <a class="code" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,SearchAndCount);
04197 <span class="preprocessor">#else</span>
04198 <span class="preprocessor"></span>        <span class="comment">//</span>
04199         <span class="comment">// use a global var to count the number of subkeys, as this is the only</span>
04200         <span class="comment">// way interfere with the Enum callback; It is safe to use as this will</span>
04201         <span class="comment">// be the only thread working on this global var (registry is locked exclusively)</span>
04202         <span class="comment">//</span>
04203         <a class="code" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a> = 0;
04204         <a class="code" href="../../d0/d2/obtype_8c.html#a3">ObEnumerateObjectsByType</a>(
04205             CmpKeyObjectType,
04206             CmpEnumKeyObjectCallback,
04207             Hive
04208             );
04209 <span class="preprocessor">#endif</span>
04210 <span class="preprocessor"></span>        <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
04211         <span class="keywordflow">try</span> {
04212             <span class="comment">// </span>
04213             <span class="comment">// protect user mode memory</span>
04214             <span class="comment">//</span>
04215             *HandleCount = <a class="code" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a>;
04216         } except (EXCEPTION_EXECUTE_HANDLER) {
04217             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04218         }
04219     }
04220 
04221     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
04222 
04223     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
04224 
04225     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04226 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="ntapi.c::NtQueryValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_VALUE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">2187</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">CheckRestricted()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00324">CliReadRegistryValue()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l01392">CmpAppendStringToMultiSz()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">CmpInterlockedFunction()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00311">CmpProcessAddRegLine()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00776">CmpProcessBitRegLine()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>, <a class="el" href="../../d3/d6/regtest_8c-source.html#l00045">DoTest()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l01534">FtReturnValue()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03729">GetActiveKeyboardName()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00598">GetBadAppCmdLine()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00255">GetErrorMode()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00118">GetRealDllFileNameWorker()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01029">GetRegIntFromID()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01983">GetServerIMEKeyboardLayout()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00053">IopProtectSystemPartition()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00199">KbdLayerRealDllFileForWBT()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00933">LoadAppDlls()</a>, <a class="el" href="../../d6/d0/rtdmpval_8c-source.html#l00052">main()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01670">MyRegQueryValue()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04019">OpenKeyboardLayoutFile()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00387">RegReadApcProcedure()</a>, <a class="el" href="../../d6/d4/prodtype_8c-source.html#l00030">RtlGetNtProductType()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l00341">RtlInitializeRXact()</a>, <a class="el" href="../../d2/d6/rtl_2registry_8c-source.html#l00226">RtlpNtQueryValueKey()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00425">SepAdtInitializeAuditingOptions()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00117">SepAdtInitializeBounds()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00242">SepAdtInitializeCrashOnFail()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00329">SepAdtInitializePrivilegeAuditing()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.
<p>
<pre class="fragment"><div>02197                    :
02198 
02199     The <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, TitleIndex, Type, and Data <span class="keywordflow">for</span> any one of a key's
02200     value entries may be queried with <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>.
02201 
02202     If KeyValueInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
02203     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
02204     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
02205 
02206 Arguments:
02207 
02208     KeyHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key whose value entries are to be
02209         enumerated.  Must be open <span class="keywordflow">for</span> KEY_QUERY_VALUE access.
02210 
02211     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (0-based) number of the sub key to be returned.
02212 
02213     ValueName  - The name of the value entry to return data for.
02214 
02215     KeyValueInformationClass - Specifies the type of information
02216         returned in KeyValueInformation.  One of the following types:
02217 
02218         KeyValueBasicInformation - return time of last write, title
02219             index, and name.  (See KEY_VALUE_BASIC_INFORMATION)
02220 
02221         KeyValueFullInformation - return time of last write, title
02222             index, name, class.  (See KEY_VALUE_FULL_INFORMATION)
02223 
02224     KeyValueInformation -Supplies pointer to buffer to receive the data.
02225 
02226     Length - Length of KeyValueInformation in bytes.
02227 
02228     ResultLength - Number of bytes actually written into KeyValueInformation.
02229 
02230 Return Value:
02231 
02232     NTSTATUS - Result code from call, among the following:
02233 
02234         &lt;TBS&gt;
02235 
02236     TMP: The IopQueryRegsitryValues() routine in the IO system assumes
02237          STATUS_OBJECT_NAME_NOT_FOUND is returned if the value being queried
02238          for does not exist.
02239 
02240 --*/
02241 {
02242     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02243     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02244     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02245     UNICODE_STRING LocalValueName;
02246 
02247     <span class="comment">// Start registry call tracing</span>
02248     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
02249 
02250     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02251 
02252     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02253 
02254     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtQueryValueKey\n"));
02255     CMLOG(CML_API_ARGS, CMS_NTAPI) {
02256         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
02257         KdPrint((<span class="stringliteral">"\tValueName='%wZ'\n"</span>, ValueName));
02258     }
02259 <span class="preprocessor">#ifdef LOG_NT_API</span>
02260 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02261         KdPrint((<span class="stringliteral">"NtQueryValueKey %d %wZ %d\n"</span>,KeyHandle,ValueName,KeyValueInformationClass));
02262     }
02263 <span class="preprocessor">#endif</span>
02264 <span class="preprocessor"></span>
02265     <span class="keywordflow">if</span> ((KeyValueInformationClass != KeyValueBasicInformation) &amp;&amp;
02266         (KeyValueInformationClass != KeyValueFullInformation)  &amp;&amp;
02267         (KeyValueInformationClass != KeyValueFullInformationAlign64)  &amp;&amp;
02268         (KeyValueInformationClass != KeyValuePartialInformationAlign64)  &amp;&amp;
02269         (KeyValueInformationClass != KeyValuePartialInformation))
02270     {
02271         <span class="comment">// End registry call tracing</span>
02272         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_PARAMETER,KeyHandle,NULL,EVENT_TRACE_TYPE_REGQUERYVALUE);
02273 
02274         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02275     }
02276 
02277     mode = KeGetPreviousMode();
02278 
02279     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02280                 KeyHandle,
02281                 KEY_QUERY_VALUE,
02282                 CmpKeyObjectType,
02283                 mode,
02284                 (PVOID *)(&amp;KeyBody),
02285                 NULL
02286                 );
02287 
02288     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02289 
02290         <span class="keywordflow">try</span> {
02291             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02292                 LocalValueName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(ValueName);
02293                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(LocalValueName.Buffer,
02294                              LocalValueName.Length,
02295                              <span class="keyword">sizeof</span>(WCHAR));
02296 
02297                 <span class="comment">//</span>
02298                 <span class="comment">// We only probe the output buffer for Read to avoid touching</span>
02299                 <span class="comment">// all the pages. Some people like to pass in gigantic buffers</span>
02300                 <span class="comment">// Just In Case. The actual copy into the buffer is done under</span>
02301                 <span class="comment">// an exception handler.</span>
02302                 <span class="comment">//</span>
02303 
02304                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(KeyValueInformation,
02305                              Length,
02306                              <span class="keyword">sizeof</span>(ULONG));
02307                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ResultLength);
02308             } <span class="keywordflow">else</span> {
02309                 LocalValueName = *<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
02310             }
02311 
02312         } except (EXCEPTION_EXECUTE_HANDLER) {
02313             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
02314                 KdPrint((<span class="stringliteral">"!!NtQueryValueKey: code:%08lx\n"</span>, GetExceptionCode()));
02315             }
02316             status = GetExceptionCode();
02317         }
02318 
02319         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02320             <span class="comment">//</span>
02321             <span class="comment">// CmQueryValueKey is protected to user mode buffer exceptions</span>
02322             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
02323             <span class="comment">//</span>
02324             status = <a class="code" href="../../d1/d2/cmp_8h.html#a230">CmQueryValueKey</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
02325                                      LocalValueName,
02326                                      KeyValueInformationClass,
02327                                      KeyValueInformation,
02328                                      Length,
02329                                      ResultLength);
02330         }
02331 
02332         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02333     } <span class="keywordflow">else</span> {
02334         LocalValueName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02335         LocalValueName.Length = 0;
02336     }
02337 
02338     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02339 
02340     <span class="comment">// End registry call tracing</span>
02341     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,&amp;LocalValueName,EVENT_TRACE_TYPE_REGQUERYVALUE);
02342 
02343     <span class="keywordflow">return</span> status;
02344 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="ntapi.c::NtReplaceKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtReplaceKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>NewFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>OldFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">3336</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03603">CmpNameFromAttributes()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01686">SeRestorePrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00051">main()</a>.
<p>
<pre class="fragment"><div>03343                    :
03344 
03345     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> may be <span class="stringliteral">"replaced"</span> under a running system, such
03346     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one actually used at next
03347     boot, with <span class="keyword">this</span> call.
03348 
03349     This routine will:
03350 
03351         Open newfile, and verify that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a valid <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03352 
03353         Rename <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> backing TargetHandle to OldFile.
03354         All handles will remain open, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system will <span class="keywordflow">continue</span>
03355         to use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> until rebooted.
03356 
03357         Rename newfile to match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
03358         backing TargetHandle.
03359 
03360     .log and .alt files are ignored
03361 
03362     The system must be rebooted <span class="keywordflow">for</span> any useful effect to be seen.
03363 
03364     Caller must have <a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>.
03365 
03366 Arguments:
03367 
03368     NewFile - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use.  must not be just
03369               a handle, since <a class="code" href="../../d7/d7/ntapi_8c.html#a34">NtReplaceKey</a> will insist on
03370               opening <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> exclusive access (which it
03371               will hold until the system is rebooted.)
03372 
03373     TargetHandle - handle to a registry hive root
03374 
03375     OldFile - name of file to apply to current hive, which will
03376               become old hive
03377 
03378 Return Value:
03379 
03380     NTSTATUS - values TBS.
03381 
03382 --*/
03383 {
03384     KPROCESSOR_MODE PreviousMode;
03385     UNICODE_STRING NewHiveName;
03386     UNICODE_STRING OldFileName;
03387     NTSTATUS Status;
03388     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
03389 
03390     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03391 
03392     BEGIN_LOCK_CHECKPOINT;
03393 
03394     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint((<span class="stringliteral">"NtReplaceKey\n"</span>));
03395     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API_ARGS, CMS_NTAPI) {
03396         KdPrint((<span class="stringliteral">"\tNewFile ='%wZ'\n"</span>, NewFile-&gt;ObjectName));
03397         KdPrint((<span class="stringliteral">"\tOldFile ='%wZ'\n"</span>, OldFile-&gt;ObjectName));
03398     }
03399 <span class="preprocessor">#ifdef LOG_NT_API</span>
03400 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
03401         KdPrint((<span class="stringliteral">"NtReplaceKey\n"</span>));
03402     }
03403 <span class="preprocessor">#endif</span>
03404 <span class="preprocessor"></span>
03405     PreviousMode = KeGetPreviousMode();
03406 
03407     <span class="comment">//</span>
03408     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
03409     <span class="comment">//</span>
03410     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeRestorePrivilege, PreviousMode)) {
03411         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
03412     }
03413 
03414     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03415     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a10">CmpNameFromAttributes</a>(NewFile,
03416                                    PreviousMode,
03417                                    &amp;NewHiveName);
03418     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03419         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03420         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03421     }
03422 
03423     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a10">CmpNameFromAttributes</a>(OldFile,
03424                                    PreviousMode,
03425                                    &amp;OldFileName);
03426     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03427         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewHiveName.Buffer);
03428         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03429         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03430     }
03431 
03432     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(TargetHandle,
03433                                        0,
03434                                        CmpKeyObjectType,
03435                                        PreviousMode,
03436                                        (PVOID *)&amp;KeyBody,
03437                                        NULL);
03438     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03439 
03440         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a233">CmReplaceKey</a>(KeyBody-&gt;KeyControlBlock-&gt;KeyHive,
03441                               KeyBody-&gt;KeyControlBlock-&gt;KeyCell,
03442                               &amp;NewHiveName,
03443                               &amp;OldFileName);
03444 
03445         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
03446     }
03447 
03448     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OldFileName.Buffer);
03449     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewHiveName.Buffer);
03450     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03451 
03452     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03453 
03454     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03455 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="ntapi.c::NtRestoreKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtRestoreKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">2348</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01686">SeRestorePrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/rtrest2_8c-source.html#l00049">main()</a>.
<p>
<pre class="fragment"><div>02355                    :
02356 
02357     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> created by <a class="code" href="../../d7/d7/ntapi_8c.html#a27">NtSaveKey</a> may be loaded into
02358     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's active registry with <a class="code" href="../../d7/d7/ntapi_8c.html#a26">NtRestoreKey</a>.  An entire subtree
02359     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active registry as a result.  All of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02360     data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> sub-tree, including such things as security
02361     descriptors, will be read from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The data will
02362     not be interpreted in any way.
02363 
02364     This call (unlike NtLoadKey, see below) copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.  The
02365     system will NOT be <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call returns.
02366 
02367     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_WHOLE_HIVE_VOLATILE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, a <span class="keyword">new</span> hive
02368     can be created.  It will be a memory <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> copy.  The restore
02369     must be done to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of a hive (e.g. \registry\user\&lt;name&gt;)
02370 
02371     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT set, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restore must
02372     be an existing hive.  The restore can be done to an arbitrary
02373     location within an existing hive.
02374 
02375     Caller must have <a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a> privilege.
02376 
02377     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_REFRESH_HIVE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set (must be only flag) then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02378     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> will be restored to its state as of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last flush.
02379 
02380     The hive must be marked NOLAZY_FLUSH, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must have
02381     TCB privilege, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle must point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
02382     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> refresh fails, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive will be corrupt, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
02383     will bugcheck.  Notifies are flushed.  The hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> will be resized,
02384     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log will not.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> any <span class="keyword">volatile</span> space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
02385     being refreshed, STATUS_UNSUCCESSFUL will be returned.  (It's much
02386     too obscure a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> to warrant a <span class="keyword">new</span> error code.)
02387 
02388     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag REG_FORCE_RESTORE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restore operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done
02389     even <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KeyHandle has open subkeys by other applications
02390 
02391 Arguments:
02392 
02393     KeyHandle - refers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02394                 root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> tree read from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.  This key
02395                 will be replaced.
02396 
02397     FileHandle - refers to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to restore from, must have read access.
02398 
02399     Flags   - If REG_WHOLE_HIVE_VOLATILE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> copy will
02400               exist <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> in memory, and disappear when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> machine
02401               <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rebooted.  No hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> will be created on disk.
02402 
02403               Normally, a hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> will be created on disk.
02404 
02405 Return Value:
02406 
02407     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - values TBS.
02408 
02409 
02410 --*/
02411 {
02412     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02413     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02414     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02415 
02416     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02417 
02418     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02419 
02420     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtRestoreKey\n"));
02421 #ifdef LOG_NT_API
02422     if (CmpLogApi) {
02423         KdPrint((<span class="stringliteral">"NtRestoreKey\n"</span>));
02424     }
02425 <span class="preprocessor">#endif</span>
02426 <span class="preprocessor"></span>
02427     mode = KeGetPreviousMode();
02428     <span class="comment">//</span>
02429     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
02430     <span class="comment">//</span>
02431     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeRestorePrivilege, mode)) {
02432         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02433     }
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">// Force previous mode to be KernelMode so we can call filesystems</span>
02437     <span class="comment">//</span>
02438 
02439     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02440         <span class="keywordflow">return</span> ZwRestoreKey(KeyHandle, FileHandle, Flags);
02441     } <span class="keywordflow">else</span> {
02442 
02443         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02444                     KeyHandle,
02445                     0,
02446                     CmpKeyObjectType,
02447                     mode,
02448                     (PVOID *)(&amp;KeyBody),
02449                     NULL
02450                     );
02451 
02452         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02453 
02454             status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a14">CmRestoreKey</a>(
02455                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
02456                         FileHandle,
02457                         Flags
02458                         );
02459 
02460             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02461         }
02462     }
02463 
02464     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02465 
02466     <span class="keywordflow">return</span> status;
02467 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="ntapi.c::NtSaveKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSaveKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">2471</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01685">SeBackupPrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>02477                    :
02478 
02479     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> subtree of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active registry may be written to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in a
02480     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> suitable <span class="keywordflow">for</span> use with <a class="code" href="../../d7/d7/ntapi_8c.html#a26">NtRestoreKey</a>.  All of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02481     subtree, including such things as security descriptors will be written
02482     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
02483 
02484     Caller must have <a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a> privilege.
02485 
02486 Arguments:
02487 
02488     KeyHandle - refers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02489                 root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree to be written to disk.  The specified
02490                 node will be included in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data written <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
02491 
02492     FileHandle - a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handle with write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
02493                  of interest.
02494 
02495 Return Value:
02496 
02497     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - values TBS
02498 
02499 --*/
02500 {
02501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02502     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02503     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02504 
02505     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02506 
02507     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02508 
02509     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtSaveKey\n"));
02510 #ifdef LOG_NT_API
02511     if (CmpLogApi) {
02512         KdPrint((<span class="stringliteral">"NtSaveKey\n"</span>));
02513     }
02514 <span class="preprocessor">#endif</span>
02515 <span class="preprocessor"></span>
02516     mode = KeGetPreviousMode();
02517 
02518     <span class="comment">//</span>
02519     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
02520     <span class="comment">//</span>
02521     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeBackupPrivilege, mode)) {
02522         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02523     }
02524 
02525     <span class="comment">//</span>
02526     <span class="comment">// Force previous mode to be KernelMode</span>
02527     <span class="comment">//</span>
02528 
02529     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02530         <span class="keywordflow">return</span> ZwSaveKey(KeyHandle, FileHandle);
02531     } <span class="keywordflow">else</span> {
02532 
02533         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02534                     KeyHandle,
02535                     0,
02536                     CmpKeyObjectType,
02537                     mode,
02538                     (PVOID *)(&amp;KeyBody),
02539                     NULL
02540                     );
02541 
02542         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02543 
02544             status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a15">CmSaveKey</a>(
02545                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
02546                         FileHandle
02547                         );
02548 
02549             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02550         }
02551     }
02552 
02553     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02554 
02555     <span class="keywordflow">return</span> status;
02556 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="ntapi.c::NtSaveMergedKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSaveMergedKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>HighPrecedenceKeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>LowPrecedenceKeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">2559</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01685">SeBackupPrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>02566                    :
02567 
02568     Two subtrees of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry can be merged. The resulting subtree may
02569     be written to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> suitable <span class="keywordflow">for</span> use with <a class="code" href="../../d7/d7/ntapi_8c.html#a26">NtRestoreKey</a>.
02570     All of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subtree, including such things as security
02571     descriptors will be written <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
02572 
02573     Caller must have <a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a> privilege.
02574 
02575 Arguments:
02576 
02577     HighPrecedenceKeyHandle - refers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02578                 root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HighPrecedence tree. I.e., when a key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present in
02579                 both trees headded by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two keys, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key underneath HighPrecedence
02580                 tree will always prevail. The specified
02581                 node will be included in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data written <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
02582 
02583     LowPrecedenceKeyHandle - referrs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02584                 root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"second choice"</span> tree. Keys from <span class="keyword">this</span> trees get saved
02585                 when there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no equivalent key in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree headded by HighPrecedenceKey
02586 
02587     FileHandle - a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handle with write access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
02588                  of interest.
02589 
02590 Return Value:
02591 
02592     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - values TBS
02593 
02594 --*/
02595 {
02596     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02597     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   HighKeyBody;
02598     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   LowKeyBody;
02599     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02600 
02601     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02602 
02603     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02604 
02605     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtSaveMergedKeys\n"));
02606 #ifdef LOG_NT_API
02607     if (CmpLogApi) {
02608         KdPrint((<span class="stringliteral">"NtSaveMergedKeys\n"</span>));
02609     }
02610 <span class="preprocessor">#endif</span>
02611 <span class="preprocessor"></span>
02612     mode = KeGetPreviousMode();
02613 
02614     <span class="comment">//</span>
02615     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
02616     <span class="comment">//</span>
02617     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeBackupPrivilege, mode)) {
02618         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02619     }
02620 
02621     <span class="comment">//</span>
02622     <span class="comment">// Force previous mode to be KernelMode</span>
02623     <span class="comment">//</span>
02624 
02625     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02626         <span class="keywordflow">return</span> ZwSaveMergedKeys(HighPrecedenceKeyHandle, LowPrecedenceKeyHandle, FileHandle);
02627     } <span class="keywordflow">else</span> {
02628 
02629         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02630                     HighPrecedenceKeyHandle,
02631                     0,
02632                     CmpKeyObjectType,
02633                     mode,
02634                     (PVOID *)(&amp;HighKeyBody),
02635                     NULL
02636                     );
02637 
02638         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02639 
02640             status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02641                         LowPrecedenceKeyHandle,
02642                         0,
02643                         CmpKeyObjectType,
02644                         mode,
02645                         (PVOID *)(&amp;LowKeyBody),
02646                         NULL
02647                         );
02648 
02649             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02650 
02651                 status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a16">CmSaveMergedKeys</a>(
02652                             HighKeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
02653                             LowKeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
02654                             FileHandle
02655                             );
02656 
02657                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)LowKeyBody);
02658             }
02659 
02660             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)HighKeyBody);
02661         }
02662 
02663     }
02664 
02665     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02666 
02667     <span class="keywordflow">return</span> status;
02668 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="ntapi.c::NtSetInformationKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetInformationKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_SET_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeySetInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeySetInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>KeySetInformationLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">3235</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">CmSetLastWriteTimeKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01391">ProbeAndReadLargeInteger</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>03241 {
03242     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
03243     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
03244     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
03245     LARGE_INTEGER LocalWriteTime;
03246 
03247     <span class="comment">// Start registry call tracing</span>
03248     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
03249 
03250     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03251 
03252     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
03253 
03254     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtSetInformationKey\n"));
03255     CMLOG(CML_API_ARGS, CMS_NTAPI) {
03256         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
03257         KdPrint((<span class="stringliteral">"\tInfoClass=%08x\n"</span>, KeySetInformationClass));
03258     }
03259 <span class="preprocessor">#ifdef LOG_NT_API</span>
03260 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
03261         KdPrint((<span class="stringliteral">"NtSetInformationKey %d %d\n"</span>,KeyHandle,KeySetInformationClass));
03262     }
03263 <span class="preprocessor">#endif</span>
03264 <span class="preprocessor"></span>
03265     <span class="keywordflow">switch</span> (KeySetInformationClass) {
03266     <span class="keywordflow">case</span> KeyWriteTimeInformation:
03267         <span class="keywordflow">if</span> (KeySetInformationLength != <span class="keyword">sizeof</span>( KEY_WRITE_TIME_INFORMATION )) {
03268 
03269             <span class="comment">// End registry call tracing</span>
03270             <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INFO_LENGTH_MISMATCH,KeyHandle,NULL,EVENT_TRACE_TYPE_REGSETINFORMATION);
03271 
03272             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03273         }
03274         <span class="keywordflow">break</span>;
03275 
03276     <span class="keywordflow">default</span>:
03277 
03278         <span class="comment">// End registry call tracing</span>
03279         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_INFO_CLASS,KeyHandle,NULL,EVENT_TRACE_TYPE_REGSETINFORMATION);
03280 
03281         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
03282     }
03283 
03284     mode = KeGetPreviousMode();
03285 
03286     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03287                 KeyHandle,
03288                 KEY_SET_VALUE,
03289                 CmpKeyObjectType,
03290                 mode,
03291                 (PVOID *)(&amp;KeyBody),
03292                 NULL
03293                 );
03294 
03295     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03296 
03297         <span class="keywordflow">try</span> {
03298 
03299             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03300                 LocalWriteTime = <a class="code" href="../../d5/d8/ex_8h.html#a24">ProbeAndReadLargeInteger</a>(
03301                     (PLARGE_INTEGER) KeySetInformation );
03302             } <span class="keywordflow">else</span> {
03303                 LocalWriteTime = *(PLARGE_INTEGER)KeySetInformation;
03304             }
03305 
03306         } except (EXCEPTION_EXECUTE_HANDLER) {
03307             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
03308                 KdPrint((<span class="stringliteral">"!!NtSetInformationKey: code:%08lx\n"</span>, GetExceptionCode()));
03309             }
03310             status = GetExceptionCode();
03311         }
03312 
03313         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03314             <span class="comment">//</span>
03315             <span class="comment">// not in try ... except! we want bugcheck here if something wrong in the registry</span>
03316             <span class="comment">//</span>
03317             status = <a class="code" href="../../d1/d2/cmp_8h.html#a238">CmSetLastWriteTimeKey</a>(
03318                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
03319                         &amp;LocalWriteTime
03320                         );
03321         }
03322 
03323         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
03324     }
03325 
03326     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03327 
03328     <span class="comment">// End registry call tracing</span>
03329     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,NULL,EVENT_TRACE_TYPE_REGSETINFORMATION);
03330 
03331     <span class="keywordflow">return</span> status;
03332 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="ntapi.c::NtSetValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG TitleIndex&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Data</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">2672</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00071">CmpExceptionFilter</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00097">EndWmiCmTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00265">ExAllocatePoolWithQuotaTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00036">MAX_KEY_VALUE_NAME_LENGTH</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00084">StartWmiCmTrace</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02532">CmpAddDockingInfo()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00037">CmpInitializeMachineDependentConfiguration()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00458">CmpInitializeRegistryNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">CmpInterlockedFunction()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01513">CmpMoveBiosAliasTable()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00311">CmpProcessAddRegLine()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00776">CmpProcessBitRegLine()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>, <a class="el" href="../../d7/d2/rttrecpy_8c-source.html#l00114">Copy()</a>, <a class="el" href="../../d3/d6/regtest_8c-source.html#l00045">DoTest()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00602">FtSetValue()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03729">GetActiveKeyboardName()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03862">IopStoreSystemPartitionInformation()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l03974">IopWriteIpAddressToRegistry()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00071">main()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01240">RtlApplyRXact()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l00341">RtlInitializeRXact()</a>, <a class="el" href="../../d2/d6/rtl_2registry_8c-source.html#l00372">RtlpNtSetValueKey()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01461">RXactpCommit()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.
<p>
<pre class="fragment"><div>02682                    :
02683 
02684     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value entry may be created or replaced with <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>.
02685 
02686     If a value entry with a Value <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> (i.e. name) matching the
02687     one specified by ValueName exists, it is deleted and replaced
02688     with the one specified.  If no such value entry exists, a new
02689     one is created.  NULL is a legal Value ID.  While Value IDs must
02690     be unique within any given key, the same Value ID may appear
02691     in many different keys.
02692 
02693 Arguments:
02694 
02695     KeyHandle - Handle of the key whose for which a value entry is
02696         to be set.  Must be opened for KEY_SET_VALUE access.
02697 
02698     ValueName - The unique (relative to the containing key) name
02699         of the value entry.  May be NULL.
02700 
02701     TitleIndex - Supplies the title index for ValueName.  The title
02702         index specifies the index of the localized alias for the ValueName.
02703 
02704     Type - The integer type number of the value entry.
02705 
02706     Data - Pointer to buffer with actual data for the value entry.
02707 
02708     DataSize - Size of Data buffer.
02709 
02710 
02711 Return Value:
02712 
02713     NTSTATUS - Result code from call, among the following:
02714 
02715         &lt;TBS&gt;
02716 
02717 --*/
02718 {
02719     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02720     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02721     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02722     UNICODE_STRING LocalValueName;
02723     PWSTR CapturedName=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02724 
02725     <span class="comment">// Start registry call tracing</span>
02726     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
02727 
02728     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02729 
02730     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02731 
02732     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtSetValueKey\n"));
02733     CMLOG(CML_API_ARGS, CMS_NTAPI) {
02734         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
02735         KdPrint((<span class="stringliteral">"\tValueName='%wZ'n"</span>, ValueName));
02736     }
02737 <span class="preprocessor">#ifdef LOG_NT_API</span>
02738 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02739         KdPrint((<span class="stringliteral">"NtSetValueKey %d %wZ\n"</span>,KeyHandle,ValueName));
02740     }
02741 <span class="preprocessor">#endif</span>
02742 <span class="preprocessor"></span>
02743     mode = KeGetPreviousMode();
02744 
02745     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02746                 KeyHandle,
02747                 KEY_SET_VALUE,
02748                 CmpKeyObjectType,
02749                 mode,
02750                 (PVOID *)(&amp;KeyBody),
02751                 NULL
02752                 );
02753 
02754     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02755 
02756         <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02757             <span class="keywordflow">try</span> {
02758                 LocalValueName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(ValueName);
02759                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Data,
02760                              DataSize,
02761                              <span class="keyword">sizeof</span>(UCHAR));
02762 
02763                 <span class="comment">//</span>
02764                 <span class="comment">// Sanity check for ValueName length</span>
02765                 <span class="comment">//</span>
02766                 <span class="keywordflow">if</span>(LocalValueName.Length &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a3">MAX_KEY_VALUE_NAME_LENGTH</a>) {
02767                     status = STATUS_INVALID_PARAMETER;
02768                     <span class="keywordflow">goto</span> Exit;
02769                 }
02770 
02771                 <span class="comment">//</span>
02772                 <span class="comment">// Capture the name buffer. Note that a zero-length name is valid, that is the</span>
02773                 <span class="comment">// "Default" value.</span>
02774                 <span class="comment">//</span>
02775                 <span class="keywordflow">if</span> (LocalValueName.Length &gt; 0) {
02776                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(LocalValueName.Buffer,
02777                                  LocalValueName.Length,
02778                                  <span class="keyword">sizeof</span>(WCHAR));
02779                     CapturedName = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(PagedPool, LocalValueName.Length, 'nVmC');
02780                     <span class="keywordflow">if</span> (CapturedName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02781                         status = STATUS_INSUFFICIENT_RESOURCES;
02782                         <span class="keywordflow">goto</span> Exit;
02783                     }
02784                     RtlCopyMemory(CapturedName, LocalValueName.Buffer, LocalValueName.Length);
02785                 } <span class="keywordflow">else</span> {
02786                     CapturedName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02787                 }
02788                 LocalValueName.Buffer = CapturedName;
02789 
02790             } except (<a class="code" href="../../d7/d7/ntapi_8c.html#a1">CmpExceptionFilter</a>(GetExceptionInformation())) {
02791                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
02792                     KdPrint((<span class="stringliteral">"!!NtSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
02793                 }
02794                 status = GetExceptionCode();
02795                 <span class="keywordflow">goto</span> Exit;
02796             }
02797         } <span class="keywordflow">else</span> {
02798             LocalValueName = *<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
02799             CapturedName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02800 
02801             <span class="comment">//</span>
02802             <span class="comment">// Sanity check for ValueName length</span>
02803             <span class="comment">//</span>
02804             <span class="keywordflow">if</span>(LocalValueName.Length &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a3">MAX_KEY_VALUE_NAME_LENGTH</a>) {
02805                 status = STATUS_INVALID_PARAMETER;
02806                 <span class="keywordflow">goto</span> Exit;
02807             }
02808         }
02809 
02810         status = <a class="code" href="../../d1/d2/cmp_8h.html#a237">CmSetValueKey</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
02811                                &amp;LocalValueName,
02812                                Type,
02813                                Data,
02814                                DataSize);
02815 
02816 Exit:
02817         <span class="comment">// End registry call tracing</span>
02818         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,&amp;LocalValueName,EVENT_TRACE_TYPE_REGSETVALUE);
02819 
02820         <span class="keywordflow">if</span> (CapturedName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02821             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CapturedName);
02822         }
02823         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02824     }
02825 
02826     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02827 
02828     <span class="keywordflow">return</span> status;
02829 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="ntapi.c::NtUnloadKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtUnloadKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TargetKey</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">3093</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00319">BEGIN_LOCK_CHECKPOINT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00771">_CM_PARSE_CONTEXT::Class</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00244">CML_API_ARGS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00537">CmpCleanUpSubKeyInfo()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00257">CMS_NTAPI</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00774">_CM_PARSE_CONTEXT::CreateLink</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00772">_CM_PARSE_CONTEXT::CreateOptions</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00773">_CM_PARSE_CONTEXT::Disposition</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00325">END_LOCK_CHECKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00280">_CM_KEY_CONTROL_BLOCK::KeyCell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00776">_CM_PARSE_CONTEXT::PredefinedHandle</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01686">SeRestorePrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00770">_CM_PARSE_CONTEXT::TitleIndex</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03747">CmpDeleteCloneTree()</a>, and <a class="el" href="../../d8/d2/rtunload_8c-source.html#l00045">main()</a>.
<p>
<pre class="fragment"><div>03098                    :
03099 
03100     Drop a subtree (hive) out of the registry.
03101 
03102     Will fail if applied to anything other than the root of a hive.
03103 
03104     Cannot be applied to core system hives (HARDWARE, SYSTEM, etc.)
03105 
03106     Can be applied to user hives loaded via NtRestoreKey or NtLoadKey.
03107 
03108     If there are handles open to the hive being dropped, this call
03109     will fail.  Terminate relevent processes so that handles are
03110     closed.
03111 
03112     This call will flush the hive being dropped.
03113 
03114     Caller must have SeRestorePrivilege privilege.
03115 
03116 Arguments:
03117 
03118     TargetKey - specifies the path to a key to link the hive to.
03119                 path must be of the form "\registry\user\&lt;username&gt;"
03120 
03121 Return Value:
03122 
03123     NTSTATUS - values TBS.
03124 
03125 --*/
03126 {
03127     HANDLE KeyHandle;
03128     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03129     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
03130     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
03131     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
03132     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
03133     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> ParseContext;
03134 
03135     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03136 
03137     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
03138 
03139     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_NTAPI) KdPrint(("NtUnloadKey\n"));
03140     CMLOG(CML_API_ARGS, CMS_NTAPI) {
03141         KdPrint((<span class="stringliteral">"\tTargetKey ='%wZ'\n"</span>, TargetKey-&gt;ObjectName));
03142     }
03143 <span class="preprocessor">#ifdef LOG_NT_API</span>
03144 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
03145         KdPrint((<span class="stringliteral">"NtUnloadKey\n"</span>));
03146     }
03147 <span class="preprocessor">#endif</span>
03148 <span class="preprocessor"></span>
03149     PreviousMode = KeGetPreviousMode();
03150 
03151     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeRestorePrivilege, PreviousMode)) {
03152         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
03153     }
03154 
03155     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
03156 
03157     <span class="keywordflow">try</span> {
03158 
03159         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o0">TitleIndex</a> = 0;
03160         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Length = 0;
03161         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03162         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o2">CreateOptions</a> = REG_OPTION_BACKUP_RESTORE;
03163         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o3">Disposition</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03164         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03165         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o6">PredefinedHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03166 
03167         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(TargetKey,
03168                                     CmpKeyObjectType,
03169                                     PreviousMode,
03170                                     NULL,
03171                                     KEY_WRITE,
03172                                     &amp;ParseContext,
03173                                     &amp;KeyHandle);
03174         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03175             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
03176                                                KEY_WRITE,
03177                                                CmpKeyObjectType,
03178                                                PreviousMode,
03179                                                (PVOID *)&amp;KeyBody,
03180                                                NULL);
03181             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
03182         }
03183 
03184     } except (EXCEPTION_EXECUTE_HANDLER) {
03185         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03186         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
03187             KdPrint((<span class="stringliteral">"!!NtUnloadKey: code:%08lx\n"</span>, Status));
03188         }
03189     }
03190 
03191     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03192         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
03193         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
03194 
03195         <span class="comment">//</span>
03196         <span class="comment">// Report the notify here, because the KCB won't be around later.</span>
03197         <span class="comment">//</span>
03198 
03199         <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
03200                         Hive,
03201                         Cell,
03202                         REG_NOTIFY_CHANGE_LAST_SET);
03203 
03204 
03205         <span class="comment">//</span>
03206         <span class="comment">// post any waiting notifies</span>
03207         <span class="comment">//</span>
03208         <a class="code" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a>(KeyBody);
03209 
03210         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a241">CmUnloadKey</a>(Hive, Cell, KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>);
03211         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03212             <span class="comment">//</span>
03213             <span class="comment">// Mark this kcb as deleted so that it won't get put on the delayed close list.</span>
03214             <span class="comment">//</span>
03215             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03216             <span class="comment">//</span>
03217             <span class="comment">// If the parent has the subkey info or hint cached, free it.</span>
03218             <span class="comment">//</span>
03219             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
03220             <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>);
03221             <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>);
03222         } 
03223 
03224         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
03225     }
03226 
03227     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
03228 
03229     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03230 
03231     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03232 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="ntapi.c::CmBootAcceptFirstTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d7/d7/ntapi_8c.html#a6">CmBootAcceptFirstTime</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00035">35</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">NtInitializeRegistry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ntapi.c::CmFirstTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d7/d7/ntapi_8c.html#a5">CmFirstTime</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00034">34</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03778">CmBootLastKnownGood()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">NtInitializeRegistry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ntapi.c::CmpKeyObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d7/d7/ntapi_8c.html#a4">CmpKeyObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00032">32</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">CmpCheckCreateAccess()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04234">CmpCreatePredefined()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01421">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ntapi.c::CmpOpenSubKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04054">4054</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04059">CmpEnumKeyObjectCallback()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ntapi.c::CmpTraceFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d7/d7/ntapi_8c.html#a7">CmpTraceFlag</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00037">37</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ntapi.c::ExEventObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d4/d1/userk_8h.html#a786">ExEventObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">30</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00067">ExpEventInitialization()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00119">InitializeMediaChange()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00180">InitializePowerRequestList()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05299">IoCreateNotificationEvent()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05733">IoCreateSynchronizationEvent()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00126">NtClearEvent()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">NtCreateEvent()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00313">NtOpenEvent()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00412">NtPulseEvent()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00514">NtQueryEvent()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00648">NtResetEvent()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00038">NtSignalAndWaitForSingleObject()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03858">RawInputThread()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00408">VdmpQueueIntNormalRoutine()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05671">WaitOnPseudoEvent()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l01501">xxxCreateThreadInfo()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00114">xxxDesktopThread()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00026">xxxInitTerminal()</a>, and <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00565">xxxRegisterUserHungAppHandlers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ntapi.c::ExpControlKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> <a class="el" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[2]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00401">401</a> of file <a class="el" href="../../d8/d6/ntapi_8c-source.html">ntapi.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
