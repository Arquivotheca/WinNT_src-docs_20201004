<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntinput.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntinput.c</h1><a href="../../d6/d8/ntinput_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: ntinput.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains low-level input code specific to the NT</span>
00007 <span class="comment">* implementation of Win32 USER, which is mostly the interfaces to the</span>
00008 <span class="comment">* keyboard and mouse device drivers.</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">* 11-26-90 DavidPe      Created</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ntddmou.h&gt;</span>
00016 
00017 
<a name="l00018"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a17">00018</a> <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a>  <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a5">gWaitBlockArray</a>;
00019 
<a name="l00020"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a18">00020</a> KEYBOARD_UNIT_ID_PARAMETER <a class="code" href="../../d6/d8/ntinput_8c.html#a18">kuid</a>;
<a name="l00021"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a19">00021</a> MOUSE_UNIT_ID_PARAMETER <a class="code" href="../../d6/d8/ntinput_8c.html#a19">muid</a>;
00022 
<a name="l00023"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a0">00023</a> <span class="preprocessor">#define UPDATE_KBD_TYPEMATIC 1</span>
<a name="l00024"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a1">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define UPDATE_KBD_LEDS      2</span>
00025 <span class="preprocessor"></span>
00026 <span class="keywordtype">void</span> <a class="code" href="../../d6/d8/ntinput_8c.html#a29">ProcessQueuedMouseEvents</a>(<span class="keywordtype">void</span>);
00027 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a69">RawInputThread</a>(PVOID pVoid);
00028 LONG <a class="code" href="../../d6/d8/ntinput_8c.html#a31">DoMouseAccel</a>(LONG delta);
00029 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a32">GetMouseCoord</a>(LONG dx, LONG dy, DWORD dwFlags, LONG time, ULONG_PTR ExtraInfo, PPOINT ppt);
00030 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a33">xxxMoveEventAbsolute</a>(LONG x, LONG y, ULONG_PTR dwExtraInfo, DWORD time,
00031             BOOL bInjected);
<a name="l00032"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a21">00032</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>  <a class="code" href="../../d6/d8/ntinput_8c.html#a20">idxRemainder</a>, <a class="code" href="../../d6/d8/ntinput_8c.html#a21">idyRemainder</a> ;
00033 
00034 <span class="comment">/*</span>
00035 <span class="comment"> * Mouse/Kbd diagnostics for #136483 etc. Remove when PNP is stable (IanJa)</span>
00036 <span class="comment"> */</span>
00037 <span class="preprocessor">#ifdef DIAGNOSE_IO</span>
<a name="l00038"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a22">00038</a> <span class="preprocessor"></span>ULONG    <a class="code" href="../../d6/d8/ntinput_8c.html#a22">gMouseProcessMiceInputTime</a> = 0;  <span class="comment">// tick at start of ProcessMiceInput</span>
<a name="l00039"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a23">00039</a> ULONG    <a class="code" href="../../d6/d8/ntinput_8c.html#a23">gMouseQueueMouseEventTime</a> = 0;   <span class="comment">// tick at start of QueueMouseEvent</span>
<a name="l00040"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a24">00040</a> ULONG    <a class="code" href="../../d6/d8/ntinput_8c.html#a24">gMouseUnqueueMouseEventTime</a> = 0; <span class="comment">// tick at start of UnqueueMouseEvent</span>
00041 
00042 <span class="comment">// Return a value as close as possible to the system's tick count,</span>
00043 <span class="comment">// yet guaranteed to be larger than the value returned last time.</span>
00044 <span class="comment">// (useful for sequencing events)</span>
00045 <span class="comment">// BUG: when NtGetTickCount overflows, the value returned by MonotonicTick</span>
00046 <span class="comment">// will not track system tick count well: instead it will increase by one</span>
00047 <span class="comment">// each time until it too overflows. (considerd harmless for IO DIAGNOSTICS)</span>
<a name="l00048"></a><a class="code" href="../../d4/d1/userk_8h.html#a989">00048</a> ULONG <a class="code" href="../../d6/d8/ntinput_8c.html#a34">MonotonicTick</a>()
00049 {
00050     <span class="keyword">static</span> ULONG lasttick = 0;
00051     ULONG newtick;
00052 
00053     newtick = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00054     <span class="keywordflow">if</span> (newtick &gt; lasttick) {
00055         lasttick = newtick;  <span class="comment">// use the new tick since it is larger</span>
00056     } <span class="keywordflow">else</span> {
00057         lasttick++;          <span class="comment">// artificially bump the tick up one.</span>
00058     }
00059     <span class="keywordflow">return</span> lasttick;
00060 }
00061 
00062 <span class="preprocessor">#endif</span>
00063 <span class="preprocessor"></span>
00064 <span class="comment">/*</span>
00065 <span class="comment"> * Parameter Constants for xxxButtonEvent()</span>
00066 <span class="comment"> */</span>
<a name="l00067"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a2">00067</a> <span class="preprocessor">#define MOUSE_BUTTON_LEFT   0x0001</span>
<a name="l00068"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a3">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define MOUSE_BUTTON_RIGHT  0x0002</span>
<a name="l00069"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a4">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define MOUSE_BUTTON_MIDDLE 0x0004</span>
<a name="l00070"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a5">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define MOUSE_BUTTON_X1     0x0008</span>
<a name="l00071"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a6">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define MOUSE_BUTTON_X2     0x0010</span>
00072 <span class="preprocessor"></span>
<a name="l00073"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a7">00073</a> <span class="preprocessor">#define ID_INPUT       0</span>
<a name="l00074"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a8">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_MOUSE       1</span>
00075 <span class="preprocessor"></span>
<a name="l00076"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a9">00076</a> <span class="preprocessor">#define ID_TIMER       2</span>
<a name="l00077"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a10">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_HIDCHANGE   3</span>
<a name="l00078"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a11">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_NUMBER_NON_HYDRA_HANDLES 4</span>
00079 <span class="preprocessor"></span>
<a name="l00080"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a12">00080</a> <span class="preprocessor">#define ID_SHUTDOWN    4</span>
<a name="l00081"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a13">00081</a> <span class="preprocessor"></span><span class="preprocessor">#define ID_WDTIMER     5</span>
<a name="l00082"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a25">00082</a> <span class="preprocessor"></span><a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a>;
00083 
<a name="l00084"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a26">00084</a> PVOID *<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>;
00085 
<a name="l00086"></a><a class="code" href="../../d7/d4/struct__RIT__INIT.html">00086</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d4/struct__RIT__INIT.html">_RIT_INIT</a> {
<a name="l00087"></a><a class="code" href="../../d7/d4/struct__RIT__INIT.html#o0">00087</a>     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> <a class="code" href="../../d7/d4/struct__RIT__INIT.html#o0">pTerm</a>;
<a name="l00088"></a><a class="code" href="../../d7/d4/struct__RIT__INIT.html#o1">00088</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>   <a class="code" href="../../d7/d4/struct__RIT__INIT.html#o1">pRitReadyEvent</a>;
00089 } <a class="code" href="../../d7/d4/struct__RIT__INIT.html">RIT_INIT</a>, *<a class="code" href="../../d7/d4/struct__RIT__INIT.html">PRIT_INIT</a>;
00090 
00091 <span class="comment">/***************************************************************************\</span>
00092 <span class="comment">* fAbsoluteMouse</span>
00093 <span class="comment">*</span>
00094 <span class="comment">* Returns TRUE if the mouse event has absolute coordinates (as apposed to the</span>
00095 <span class="comment">* standard delta values we get from MS and PS2 mice)</span>
00096 <span class="comment">*</span>
00097 <span class="comment">* History:</span>
00098 <span class="comment">* 23-Jul-1992 JonPa     Created.</span>
00099 <span class="comment">\***************************************************************************/</span>
<a name="l00100"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a14">00100</a> <span class="preprocessor">#define fAbsoluteMouse( pmei )      \</span>
00101 <span class="preprocessor">        (((pmei)-&gt;Flags &amp; MOUSE_MOVE_ABSOLUTE) != 0)</span>
00102 <span class="preprocessor"></span>
00103 <span class="comment">/***************************************************************************\</span>
00104 <span class="comment">* ConvertToMouseDriverFlags</span>
00105 <span class="comment">*</span>
00106 <span class="comment">* Converts SendInput kind of flags to mouse driver flags as GetMouseCoord</span>
00107 <span class="comment">* needs them.</span>
00108 <span class="comment">* As mouse inputs are more frequent than send inputs, we penalize the later.</span>
00109 <span class="comment">*</span>
00110 <span class="comment">* History:</span>
00111 <span class="comment">* 17-dec-1997 MCostea     Created.</span>
00112 <span class="comment">\***************************************************************************/</span>
00113 <span class="preprocessor">#if ((MOUSEEVENTF_ABSOLUTE &gt;&gt; 15) ^ MOUSE_MOVE_ABSOLUTE) || \</span>
00114 <span class="preprocessor">    ((MOUSEEVENTF_VIRTUALDESK &gt;&gt; 13) ^ MOUSE_VIRTUAL_DESKTOP)</span>
00115 <span class="preprocessor"></span><span class="preprocessor">#   error("Bit mapping broken: fix ConvertToMouseDriverFlags")</span>
00116 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00117 <span class="preprocessor"></span>
<a name="l00118"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a15">00118</a> <span class="preprocessor">#define ConvertToMouseDriverFlags( Flags )      \</span>
00119 <span class="preprocessor">        (((Flags) &amp; MOUSEEVENTF_ABSOLUTE) &gt;&gt; 15 | \</span>
00120 <span class="preprocessor">         ((Flags) &amp; MOUSEEVENTF_VIRTUALDESK) &gt;&gt; 13)</span>
00121 <span class="preprocessor"></span>
<a name="l00122"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a16">00122</a> <span class="preprocessor">#define VKTOMODIFIERS(Vk) ((((Vk) &gt;= VK_SHIFT) &amp;&amp; ((Vk) &lt;= VK_MENU)) ? \</span>
00123 <span class="preprocessor">                           (MOD_SHIFT &gt;&gt; ((Vk) - VK_SHIFT)) :           \</span>
00124 <span class="preprocessor">                           0)</span>
00125 <span class="preprocessor"></span><span class="preprocessor">#if (VKTOMODIFIERS(VK_SHIFT) != MOD_SHIFT) || \</span>
00126 <span class="preprocessor">    (VKTOMODIFIERS(VK_CONTROL) != MOD_CONTROL) || \</span>
00127 <span class="preprocessor">    (VKTOMODIFIERS(VK_MENU) != MOD_ALT)</span>
00128 <span class="preprocessor"></span><span class="preprocessor">#   error("VKTOMODIFIERS broken")</span>
00129 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00130 <span class="preprocessor"></span>
00131 
00132 <span class="comment">/***************************************************************************\</span>
00133 <span class="comment">* xxxInitInput</span>
00134 <span class="comment">*</span>
00135 <span class="comment">* This function is called from CreateTerminalInput() and gets USER setup to</span>
00136 <span class="comment">* process keyboard and mouse input.  It starts the RIT for that terminal.</span>
00137 <span class="comment">* History:</span>
00138 <span class="comment">* 11-26-90 DavidPe      Created.</span>
00139 <span class="comment">\***************************************************************************/</span>
<a name="l00140"></a><a class="code" href="../../d4/d1/userk_8h.html#a1168">00140</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1168">xxxInitInput</a>(
00141     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm)
00142 {
00143     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00144     HANDLE   hThreadRawInput;
00145     <a class="code" href="../../d7/d4/struct__RIT__INIT.html">RIT_INIT</a> initData;
00146 UserAssert(pTerm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00147 
00148 <span class="preprocessor">#ifdef MOUSE_LOCK_CODE</span>
00149 <span class="preprocessor"></span>    <span class="comment">/*</span>
00150 <span class="comment">     * Lock RIT pages into memory</span>
00151 <span class="comment">     */</span>
00152     LockMouseInputCodePages();
00153 <span class="preprocessor">#endif</span>
00154 <span class="preprocessor"></span>
00155     initData.<a class="code" href="../../d7/d4/struct__RIT__INIT.html#o0">pTerm</a> = pTerm;
00156     initData.<a class="code" href="../../d7/d4/struct__RIT__INIT.html#o1">pRitReadyEvent</a> = <a class="code" href="../../d4/d1/userk_8h.html#a965">CreateKernelEvent</a>(SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00157     <span class="keywordflow">if</span> (initData.<a class="code" href="../../d7/d4/struct__RIT__INIT.html#o1">pRitReadyEvent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00158         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00159     }
00160     <span class="comment">/*</span>
00161 <span class="comment">     * Create the RIT and let it run.</span>
00162 <span class="comment">     */</span>
00163     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00164     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a963">CreateSystemThread</a>((<a class="code" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a>)<a class="code" href="../../d6/d8/ntinput_8c.html#a30">RawInputThread</a>, &amp;initData,
00165             &amp;hThreadRawInput);
00166     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00167         <span class="keywordflow">goto</span> Exit;
00168     }
00169     ZwClose(hThreadRawInput);
00170 
00171     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(initData.<a class="code" href="../../d7/d4/struct__RIT__INIT.html#o1">pRitReadyEvent</a>, <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
00172             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00173 Exit:
00174     <a class="code" href="../../d4/d1/userk_8h.html#a967">FreeKernelEvent</a>(&amp;initData.<a class="code" href="../../d7/d4/struct__RIT__INIT.html#o1">pRitReadyEvent</a>);
00175     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00176 
00177     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00178 }
00179 
00180 
00181 <span class="comment">/***************************************************************************\</span>
00182 <span class="comment">* InitScancodeMap</span>
00183 <span class="comment">*</span>
00184 <span class="comment">* Fetches the scancode map from the registry, allocating space as required.</span>
00185 <span class="comment">*</span>
00186 <span class="comment">* A scancode map is used to convert unusual OEM scancodes into standard</span>
00187 <span class="comment">* "Scan Code Set 1" values.  This is to support KB3270 keyboards, but can</span>
00188 <span class="comment">* be used for other types too.</span>
00189 <span class="comment">*</span>
00190 <span class="comment">* History:</span>
00191 <span class="comment">* 96-04-18 IanJa      Created.</span>
00192 <span class="comment">\***************************************************************************/</span>
00193 <a class="code" href="../../d4/d1/userk_8h.html#a906">PSCANCODEMAP</a>
<a name="l00194"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a36">00194</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a36">InitScancodeMap</a>()
00195 {
00196     LPBYTE pb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00197     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwBytes;
00198 
00199     <span class="comment">/*</span>
00200 <span class="comment">     * Find the size of the scancode map</span>
00201 <span class="comment">     */</span>
00202     dwBytes = <a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a702">PMAP_KBDLAYOUT</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Scancode Map"</span>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00203 
00204     <span class="comment">/*</span>
00205 <span class="comment">     * Allocate space for the scancode map, and fetch it from the registry</span>
00206 <span class="comment">     */</span>
00207     <span class="keywordflow">if</span> (dwBytes &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d7/structSCANCODEMAP.html">SCANCODEMAP</a>)) {
00208         <span class="keywordflow">if</span> ((pb = UserAllocPoolZInit(dwBytes, TAG_SCANCODEMAP)) != 0) {
00209             dwBytes = <a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a702">PMAP_KBDLAYOUT</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Scancode Map"</span>,
00210                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pb, dwBytes);
00211         }
00212     }
00213 
00214 <span class="preprocessor">#ifdef LATER</span>
00215 <span class="preprocessor"></span>    <span class="comment">/*</span>
00216 <span class="comment">     * For shadow the WD has it's own keyboard scan code interpreter.</span>
00217 <span class="comment">     * It needs to know the keyboard type.</span>
00218 <span class="comment">     *</span>
00219 <span class="comment">     * The keyboard comments say these are asynchronous commands so only</span>
00220 <span class="comment">     * use globals.</span>
00221 <span class="comment">     */</span>
00222     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> &amp;&amp; dwBytes) {
00223 
00224         ZwDeviceIoControlFile(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a337">ghRemoteKeyboardChannel</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00225             &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a220">giosbKbdControl</a>, IOCTL_KEYBOARD_ICA_SCANMAP, pb, dwBytes,
00226             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00227 
00228      }
00229 <span class="preprocessor">#endif // LATER</span>
00230 <span class="preprocessor"></span>
00231     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d1/userk_8h.html#a906">PSCANCODEMAP</a>)pb;
00232 }
00233 
00234 <span class="comment">/***************************************************************************\</span>
00235 <span class="comment">* MapScancode</span>
00236 <span class="comment">*</span>
00237 <span class="comment">* Converts a scancode (and it's prefix, if any) to a different scancode</span>
00238 <span class="comment">* and prefix.</span>
00239 <span class="comment">*</span>
00240 <span class="comment">* Parameters:</span>
00241 <span class="comment">*   pbScanCode = address of Scancode byte, the scancode may be changed</span>
00242 <span class="comment">*   pbPrefix   = address of Prefix byte, The prefix may be changed</span>
00243 <span class="comment">*</span>
00244 <span class="comment">* Return value:</span>
00245 <span class="comment">*   TRUE  - mapping was found, scancode was altered.</span>
00246 <span class="comment">*   FALSE - no mapping found, scancode was not altered.</span>
00247 <span class="comment">*</span>
00248 <span class="comment">* Note on scancode map table format:</span>
00249 <span class="comment">*     A table entry DWORD of 0xE0450075 means scancode 0x45, prefix 0xE0</span>
00250 <span class="comment">*     gets mapped to scancode 0x75, no prefix</span>
00251 <span class="comment">*</span>
00252 <span class="comment">* History:</span>
00253 <span class="comment">* 96-04-18 IanJa      Created.</span>
00254 <span class="comment">\***************************************************************************/</span>
00255 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00256"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a37">00256</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a37">MapScancode</a>(
00257     PBYTE pbScanCode,
00258     PBYTE pbPrefix
00259     )
00260 {
00261     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *pdw;
00262     WORD wT = MAKEWORD(*pbScanCode, *pbPrefix);
00263 
00264     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00265     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a171">gpScancodeMap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00266 
00267     <span class="keywordflow">for</span> (pdw = &amp;(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a171">gpScancodeMap</a>-&gt;dwMap[0]); *pdw; pdw++) {
00268         <span class="keywordflow">if</span> (HIWORD(*pdw) == wT) {
00269             wT = LOWORD(*pdw);
00270             *pbScanCode = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(wT);
00271             *pbPrefix = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(wT);
00272             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00273         }
00274     }
00275     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00276 }
00277 
00278 
00279 <span class="comment">/***************************************************************************\</span>
00280 <span class="comment">* InitMice</span>
00281 <span class="comment">*</span>
00282 <span class="comment">* This function initializes the data and settings before we start enumerating</span>
00283 <span class="comment">* the mice.</span>
00284 <span class="comment">*</span>
00285 <span class="comment">* History:</span>
00286 <span class="comment">* 11-18-97 IanJa      Created.</span>
00287 <span class="comment">\***************************************************************************/</span>
00288 
<a name="l00289"></a><a class="code" href="../../d4/d1/userk_8h.html#a1169">00289</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a38">InitMice</a>()
00290 {
00291     <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a632">ACCF_MKVIRTUALMOUSE</a>);
00292     <a class="code" href="../../d4/d1/userk_8h.html#a196">CLEAR_GTERMF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a199">GTERMF_MOUSE</a>);
00293     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MOUSEPRESENT) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00294     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CMOUSEBUTTONS) = 0;
00295     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MOUSEWHEELPRESENT) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00296 }
00297 
00298 <span class="comment">/***************************************************************************\</span>
00299 <span class="comment">* FreeDeviceInfo</span>
00300 <span class="comment">*</span>
00301 <span class="comment">* Unlinks a DEVICEINFO struct from the gpDeviceInfoList list and frees the</span>
00302 <span class="comment">* allocated memory UNLESS the device is actively being read (GDIF_READING) or</span>
00303 <span class="comment">* has a PnP thread waiting for it in RequestDeviceChange() (GDIAF_PNPWAITING)</span>
00304 <span class="comment">* If the latter, then wake the PnP thread via pkeHidChangeCompleted so that it</span>
00305 <span class="comment">* can free the structure itself.</span>
00306 <span class="comment">*</span>
00307 <span class="comment">* Returns a pointer to the next DEVICEINFO struct, or NULL if the device was</span>
00308 <span class="comment">* not found in the gpDeviceInfoList.</span>
00309 <span class="comment">*</span>
00310 <span class="comment">* History:</span>
00311 <span class="comment">* 11-18-97 IanJa      Created.</span>
00312 <span class="comment">\***************************************************************************/</span>
<a name="l00313"></a><a class="code" href="../../d4/d1/userk_8h.html#a1032">00313</a> <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> <a class="code" href="../../d4/d1/userk_8h.html#a1032">FreeDeviceInfo</a>(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo)
00314 {
00315     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> *ppDeviceInfo;
00316 
00317     <a class="code" href="../../d4/d1/userk_8h.html#a155">CheckDeviceInfoListCritIn</a>();
00318 
00319     TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"FreeDeviceInfo(%#p)"</span>, pDeviceInfo);
00320 
00321     <span class="comment">/*</span>
00322 <span class="comment">     * We cannot free the device since we still have a read pending.</span>
00323 <span class="comment">     * Mark it GDIAF_FREEME so that it will be freed when the APC is made</span>
00324 <span class="comment">     * (see InputApc), or when the next read request is about to be issued</span>
00325 <span class="comment">     * (see StartDeviceRead).</span>
00326 <span class="comment">     */</span>
00327     <span class="keywordflow">if</span> (pDeviceInfo-&gt;bFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a189">GDIF_READING</a>) {
00328 <span class="preprocessor">#if DIAGNOSE_IO</span>
00329 <span class="preprocessor"></span>        pDeviceInfo-&gt;bFlags |= <a class="code" href="../../d4/d1/userk_8h.html#a190">GDIF_READERMUSTFREE</a>;
00330 <span class="preprocessor">#endif</span>
00331 <span class="preprocessor"></span>        TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"** FreeDeviceInfo(%#p) DEFERRED : reader must free"</span>, pDeviceInfo);
00332         pDeviceInfo-&gt;usActions |= <a class="code" href="../../d4/d1/userk_8h.html#a184">GDIAF_FREEME</a>;
00333         <span class="keywordflow">return</span> pDeviceInfo-&gt;pNext;
00334     }
00335 
00336     <span class="comment">/*</span>
00337 <span class="comment">     * If a PnP thread is waiting in RequestDeviceChange for some action to be</span>
00338 <span class="comment">     * performed on this device, just mark it for freeing and signal that PnP</span>
00339 <span class="comment">     * thread with the pkeHidChangeCompleted so that it will free it</span>
00340 <span class="comment">     */</span>
00341     <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>) {
00342 <span class="preprocessor">#if DIAGNOSE_IO</span>
00343 <span class="preprocessor"></span>        pDeviceInfo-&gt;bFlags |= <a class="code" href="../../d4/d1/userk_8h.html#a191">GDIF_PNPMUSTFREE</a>;
00344 <span class="preprocessor">#endif</span>
00345 <span class="preprocessor"></span>        TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"** FreeDeviceInfo(%#p) DEFERRED : PnP must free"</span>, pDeviceInfo);
00346         pDeviceInfo-&gt;usActions |= <a class="code" href="../../d4/d1/userk_8h.html#a184">GDIAF_FREEME</a>;
00347         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pDeviceInfo-&gt;pkeHidChangeCompleted, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00348         <span class="keywordflow">return</span> pDeviceInfo-&gt;pNext;
00349     }
00350 
00351     ppDeviceInfo = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>;
00352 
00353     <span class="keywordflow">while</span> (*ppDeviceInfo) {
00354         <span class="keywordflow">if</span> (*ppDeviceInfo == pDeviceInfo) {
00355             <span class="comment">/*</span>
00356 <span class="comment">             * Found the DEVICEINFO struct, so free it and its members.</span>
00357 <span class="comment">             */</span>
00358             <span class="keywordflow">if</span> (pDeviceInfo-&gt;pkeHidChangeCompleted != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00359                 <a class="code" href="../../d4/d1/userk_8h.html#a967">FreeKernelEvent</a>(&amp;pDeviceInfo-&gt;pkeHidChangeCompleted); <span class="comment">// BUG BUG</span>
00360             }
00361             <span class="keywordflow">if</span> (pDeviceInfo-&gt;ustrName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00362                 UserFreePool(pDeviceInfo-&gt;ustrName.Buffer);
00363             }
00364             *ppDeviceInfo = pDeviceInfo-&gt;pNext;
00365             UserFreePool(pDeviceInfo);
00366 
00367             <span class="keywordflow">return</span> *ppDeviceInfo;
00368         }
00369         ppDeviceInfo = &amp;(*ppDeviceInfo)-&gt;pNext;
00370     }
00371     RIPMSG1(RIP_ERROR, <span class="stringliteral">"pDeviceInfo %#p not found in gpDeviceInfoList"</span>, pDeviceInfo);
00372 
00373     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00374 }
00375 
00376 <span class="comment">/***************************************************************************\</span>
00377 <span class="comment">* UpdateMouseInfo</span>
00378 <span class="comment">*</span>
00379 <span class="comment">* This function updates mouse information for a remote session.</span>
00380 <span class="comment">*</span>
00381 <span class="comment">* History:</span>
00382 <span class="comment">* 05-22-98 clupu      Created.</span>
00383 <span class="comment">\***************************************************************************/</span>
00384 
<a name="l00385"></a><a class="code" href="../../d4/d1/userk_8h.html#a1170">00385</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d8/ntinput_8c.html#a40">UpdateMouseInfo</a>(<span class="keywordtype">void</span>)
00386 {
00387     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">DEVICEINFO</a> *pDeviceInfo;
00388     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();               <span class="comment">// expect no surprises</span>
00389 
00390     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>);
00391 
00392     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a334">ghRemoteMouseChannel</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00393         <span class="keywordflow">return</span>;
00394     }
00395 
00396     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a213">gnMice</a> == 1);
00397 
00398     <span class="comment">/*</span>
00399 <span class="comment">     * Mark the mice and signal the RIT to do the work asynchronously</span>
00400 <span class="comment">     */</span>
00401     <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
00402     <span class="keywordflow">for</span> (pDeviceInfo = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>; pDeviceInfo; pDeviceInfo = pDeviceInfo-&gt;pNext) {
00403         <span class="keywordflow">if</span> (pDeviceInfo-&gt;type == <a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>) {
00404             TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"UpdateMouseInfo(): pDeviceInfo %#p ARRIVED"</span>, pDeviceInfo);
00405             <a class="code" href="../../d4/d1/userk_8h.html#a992">RequestDeviceChange</a>(pDeviceInfo, <a class="code" href="../../d4/d1/userk_8h.html#a178">GDIAF_ARRIVED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a187">GDIAF_RECONNECT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00406         }
00407     }
00408     <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
00409 }
00410 
00411 
00412 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1030">DeviceNotify</a>(IN PPLUGPLAY_NOTIFY_HDR, IN <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a>);
00413 
00414 
00415 <span class="comment">/***************************************************************************\</span>
00416 <span class="comment">* InitKeyboard</span>
00417 <span class="comment">*</span>
00418 <span class="comment">* This function opens the keyboard driver for USER.  It does this by opening</span>
00419 <span class="comment">* the keyboard driver 'file'.  It also gets information about the keyboard</span>
00420 <span class="comment">* driver such as the minimum and maximum repeat rate/delay.  This is necessary</span>
00421 <span class="comment">* because the keyboard driver will return an error if you give it values</span>
00422 <span class="comment">* outside those ranges.</span>
00423 <span class="comment">*</span>
00424 <span class="comment">* History:</span>
00425 <span class="comment">* 11-26-90 DavidPe      Created.</span>
00426 <span class="comment">\***************************************************************************/</span>
00427 
<a name="l00428"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a42">00428</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1174">InitKeyboard</a>(VOID)
00429 {
00430     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00431         <span class="comment">/*</span>
00432 <span class="comment">         * Get the Scancode Mapping, if any.</span>
00433 <span class="comment">         */</span>
00434         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a171">gpScancodeMap</a> = <a class="code" href="../../d6/d8/ntinput_8c.html#a36">InitScancodeMap</a>();
00435     }
00436 }
00437 
00438 
<a name="l00439"></a><a class="code" href="../../d4/d1/userk_8h.html#a1314">00439</a> HKL <a class="code" href="../../d6/d8/ntinput_8c.html#a43">GetActiveHKL</a>()
00440 {
00441     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00442     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>) {
00443         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiForeground = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
00444         <span class="keywordflow">if</span> (ptiForeground &amp;&amp; ptiForeground-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>) {
00445             <span class="keywordflow">return</span> ptiForeground-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
00446         }
00447     }
00448     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1308">_GetKeyboardLayout</a>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00449 }
00450 
00451 
00452 <span class="comment">/***************************************************************************\</span>
00453 <span class="comment">* xxxButtonEvent (RIT)</span>
00454 <span class="comment">*</span>
00455 <span class="comment">* Button events from the mouse driver go here.  Based on the location of</span>
00456 <span class="comment">* the cursor the event is directed to specific window.  When a button down</span>
00457 <span class="comment">* occurs, a mouse owner window is established.  All mouse events up to and</span>
00458 <span class="comment">* including the corresponding button up go to the mouse owner window.  This</span>
00459 <span class="comment">* is done to best simulate what applications want when doing mouse capturing.</span>
00460 <span class="comment">* Since we're processing these events asynchronously, but the application</span>
00461 <span class="comment">* calls SetCapture() in response to it's synchronized processing of input</span>
00462 <span class="comment">* we have no other way to get this functionality.</span>
00463 <span class="comment">*</span>
00464 <span class="comment">* The async keystate table for VK_*BUTTON is updated here.</span>
00465 <span class="comment">*</span>
00466 <span class="comment">* History:</span>
00467 <span class="comment">* 10-18-90 DavidPe     Created.</span>
00468 <span class="comment">* 01-25-91 IanJa       xxxWindowHitTest change</span>
00469 <span class="comment">* 03-12-92 JonPa       Make caller enter crit instead of this function</span>
00470 <span class="comment">\***************************************************************************/</span>
00471 
<a name="l00472"></a><a class="code" href="../../d4/d1/userk_8h.html#a1027">00472</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1027">xxxButtonEvent</a>(
00473     DWORD ButtonNumber,
00474     POINT ptPointer,
00475     BOOL  fBreak,
00476     DWORD time,
00477     ULONG_PTR ExtraInfo,
00478     BOOL  bInjected,
00479     BOOL  fDblClk)
00480 {
00481     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    message, usVK, usOtherVK, wHardwareButton;
00482     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwnd;
00483     LPARAM  lParam;
00484     WPARAM  wParam;
00485     <span class="keywordtype">int</span>     xbutton;
00486     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwnd;
00487     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>   pHook;
00488 
00489 <span class="preprocessor">#ifdef REDIRECTION</span>
00490 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndStart;
00491 <span class="preprocessor">#endif // REDIRECTION</span>
00492 <span class="preprocessor"></span>
00493     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00494 
00495 
00496     <span class="comment">/*</span>
00497 <span class="comment">     * Cancel Alt-Tab if the user presses a mouse button</span>
00498 <span class="comment">     */</span>
00499     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00500         <a class="code" href="../../d1/d3/tmswitch_8c.html#a29">xxxCancelCoolSwitch</a>();
00501     }
00502 
00503     <span class="comment">/*</span>
00504 <span class="comment">     * Grab the mouse button before we process any button swapping.</span>
00505 <span class="comment">     * This is so we won't get confused if someone calls</span>
00506 <span class="comment">     * SwapMouseButtons() inside a down-click/up-click.</span>
00507 <span class="comment">     */</span>
00508     wHardwareButton = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)ButtonNumber;
00509 
00510     <span class="comment">/*</span>
00511 <span class="comment">     * If this is the left or right mouse button, we have to handle mouse</span>
00512 <span class="comment">     * button swapping.</span>
00513 <span class="comment">     */</span>
00514     <span class="keywordflow">if</span> (ButtonNumber &amp; (<a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a> | <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>)) {
00515         <span class="comment">/*</span>
00516 <span class="comment">         * If button swapping is on, swap the mouse buttons</span>
00517 <span class="comment">         */</span>
00518         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SWAPBUTTON)) {
00519             ButtonNumber ^= (<a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a> | <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>);
00520         }
00521 
00522         <span class="comment">/*</span>
00523 <span class="comment">         * Figure out VK</span>
00524 <span class="comment">         */</span>
00525         <span class="keywordflow">if</span> (ButtonNumber == <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>) {
00526             usVK = VK_RBUTTON;
00527             usOtherVK = VK_LBUTTON;
00528         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ButtonNumber == <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a>) {
00529             usVK = VK_LBUTTON;
00530             usOtherVK = VK_RBUTTON;
00531         } <span class="keywordflow">else</span> {
00532             RIPMSG1(RIP_ERROR, <span class="stringliteral">"Unexpected Button number %d"</span>, ButtonNumber);
00533         }
00534 
00535         <span class="comment">/*</span>
00536 <span class="comment">         * If the mouse buttons have recently been swapped AND the button</span>
00537 <span class="comment">         * transition doesn't match what we have in our keystate, then swap the</span>
00538 <span class="comment">         * button to match.</span>
00539 <span class="comment">         * This is to fix the ruler (tabs and margins) in Word 97 SR1, which</span>
00540 <span class="comment">         * calls SwapMouseButtons(0) to determine if button swapping is on, and</span>
00541 <span class="comment">         * if so then calls SwapMouseButtons(1) to restore it: if we receive a</span>
00542 <span class="comment">         * button event between these two calls, we may swap incorrectly, and</span>
00543 <span class="comment">         * be left with a mouse button stuck down or see the wrong button going</span>
00544 <span class="comment">         * down. This really messed up single/double button tab/margin setting!</span>
00545 <span class="comment">         * The same bug shows up under Windows '95, although very infrequently:</span>
00546 <span class="comment">         * Word 9 will use GetSystemMetrics(SM_SWAPBUTTON) instead according to</span>
00547 <span class="comment">         * to Mark Walker (MarkWal).                            (IanJa) #165157</span>
00548 <span class="comment">         */</span>
00549         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a93">gbMouseButtonsRecentlySwapped</a>) {
00550             <span class="keywordflow">if</span> ((!fBreak == !!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(usVK)) &amp;&amp;
00551                     (fBreak == !!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(usOtherVK))) {
00552                 RIPMSG4(RIP_WARNING, <span class="stringliteral">"Correct %s %s to %s %s"</span>,
00553                          ButtonNumber == <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a> ? <span class="stringliteral">"Left"</span> : <span class="stringliteral">"Right"</span>,
00554                          fBreak ? <span class="stringliteral">"Up"</span> : <span class="stringliteral">"Down"</span>,
00555                          ButtonNumber == <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a> ? <span class="stringliteral">"Right"</span> : <span class="stringliteral">"Left"</span>,
00556                          fBreak ? <span class="stringliteral">"Up"</span> : <span class="stringliteral">"Down"</span>);
00557                 ButtonNumber ^= (<a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a> | <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>);
00558                 usVK = usOtherVK;
00559             }
00560             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a93">gbMouseButtonsRecentlySwapped</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00561         }
00562     }
00563 
00564     xbutton = 0;
00565     <span class="keywordflow">switch</span> (ButtonNumber) {
00566     <span class="keywordflow">case</span> <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>:
00567         <span class="keywordflow">if</span> (fBreak) {
00568             message = WM_RBUTTONUP;
00569         } <span class="keywordflow">else</span> {
00570             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; fDblClk)
00571                 message = WM_RBUTTONDBLCLK;
00572             <span class="keywordflow">else</span>
00573                 message = WM_RBUTTONDOWN;
00574         }
00575         <span class="keywordflow">break</span>;
00576 
00577     <span class="keywordflow">case</span> <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a>:
00578         <span class="keywordflow">if</span> (fBreak) {
00579             message = WM_LBUTTONUP;
00580         } <span class="keywordflow">else</span> {
00581             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; fDblClk)
00582                 message = WM_LBUTTONDBLCLK;
00583             <span class="keywordflow">else</span>
00584                 message = WM_LBUTTONDOWN;
00585         }
00586         <span class="keywordflow">break</span>;
00587 
00588     <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/ntinput_8c.html#a4">MOUSE_BUTTON_MIDDLE</a>:
00589         <span class="keywordflow">if</span> (fBreak) {
00590             message = WM_MBUTTONUP;
00591         } <span class="keywordflow">else</span> {
00592             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; fDblClk)
00593                 message = WM_MBUTTONDBLCLK;
00594             <span class="keywordflow">else</span>
00595                 message = WM_MBUTTONDOWN;
00596         }
00597         usVK = VK_MBUTTON;
00598         <span class="keywordflow">break</span>;
00599 
00600     <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/ntinput_8c.html#a5">MOUSE_BUTTON_X1</a>:
00601     <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/ntinput_8c.html#a6">MOUSE_BUTTON_X2</a>:
00602         <span class="keywordflow">if</span> (fBreak) {
00603             message = WM_XBUTTONUP;
00604         } <span class="keywordflow">else</span> {
00605             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; fDblClk)
00606                 message = WM_XBUTTONDBLCLK;
00607             <span class="keywordflow">else</span>
00608                 message = WM_XBUTTONDOWN;
00609         }
00610 
00611         <span class="keywordflow">if</span> (ButtonNumber == <a class="code" href="../../d6/d8/ntinput_8c.html#a5">MOUSE_BUTTON_X1</a>) {
00612             usVK = VK_XBUTTON1;
00613             xbutton = XBUTTON1;
00614         } <span class="keywordflow">else</span> {
00615             usVK = VK_XBUTTON2;
00616             xbutton = XBUTTON2;
00617         }
00618         <span class="keywordflow">break</span>;
00619 
00620     <span class="keywordflow">default</span>:
00621         <span class="comment">/*</span>
00622 <span class="comment">         * Unknown button.  Since we don't</span>
00623 <span class="comment">         * have messages for these buttons, ignore them.</span>
00624 <span class="comment">         */</span>
00625         <span class="keywordflow">return</span>;
00626     }
00627     UserAssert(usVK != 0);
00628 
00629     wParam = MAKEWPARAM(0, xbutton);
00630 
00631     <span class="comment">/*</span>
00632 <span class="comment">     * Call low level mouse hooks to see if they allow this message</span>
00633 <span class="comment">     * to pass through USER</span>
00634 <span class="comment">     */</span>
00635     <span class="keywordflow">if</span> ((pHook = <a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), WH_MOUSE_LL)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00636         MSLLHOOKSTRUCT mslls;
00637         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           bAnsiHook;
00638 
00639         mslls.pt          = ptPointer;
00640         mslls.mouseData   = (LONG)wParam;
00641         mslls.flags       = bInjected;
00642         mslls.time        = time;
00643         mslls.dwExtraInfo = ExtraInfo;
00644 
00645         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(pHook, HC_ACTION, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)message, (LPARAM)&amp;mslls, &amp;bAnsiHook)) {
00646             <span class="keywordflow">return</span>;
00647         }
00648     }
00649 
00650     <span class="comment">/*</span>
00651 <span class="comment">     * This is from HYDRA</span>
00652 <span class="comment">     */</span>
00653     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00654 
00655 <span class="preprocessor">#ifdef REDIRECTION</span>
00656 <span class="preprocessor"></span>    <span class="comment">/*</span>
00657 <span class="comment">     * Call the speed hit test hook</span>
00658 <span class="comment">     */</span>
00659     pwndStart = xxxCallSpeedHitTestHook(&amp;ptPointer);
00660     <span class="keywordflow">if</span> (pwndStart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00661         pwndStart = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
00662     }
00663 
00664     pwnd = <a class="code" href="../../d9/d8/winwhere_8c.html#a3">SpeedHitTest</a>(pwndStart, ptPointer);
00665 <span class="preprocessor">#else</span>
00666 <span class="preprocessor"></span>    pwnd = <a class="code" href="../../d9/d8/winwhere_8c.html#a3">SpeedHitTest</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, ptPointer);
00667 <span class="preprocessor">#endif // REDIRECTION</span>
00668 <span class="preprocessor"></span>
00669     <span class="comment">/*</span>
00670 <span class="comment">     * Only post the message if we actually hit a window.</span>
00671 <span class="comment">     */</span>
00672     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00673         <span class="keywordflow">return</span>;
00674 
00675     <span class="comment">/*</span>
00676 <span class="comment">     * Assign the message to a window.</span>
00677 <span class="comment">     */</span>
00678     lParam = MAKELONG((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)ptPointer.x, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)ptPointer.y);
00679 
00680     <span class="comment">/*</span>
00681 <span class="comment">     * KOREAN:</span>
00682 <span class="comment">     *  Send VK_PROCESSKEY to finalize current composition string (NT4 behavior)</span>
00683 <span class="comment">     *  Post private message to let IMM finalize the composition string (NT5)</span>
00684 <span class="comment">     */</span>
00685     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>() &amp;&amp;
00686             !fBreak &amp;&amp;
00687             KOREAN_KBD_LAYOUT(<a class="code" href="../../d6/d8/ntinput_8c.html#a43">GetActiveHKL</a>()) &amp;&amp;
00688             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a482">CFIME</a>) &amp;&amp;
00689             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00690 
00691         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiWnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00692 
00693         <span class="comment">/*</span>
00694 <span class="comment">         * 274007: MFC flushes mouse related messages if keyup is posted</span>
00695 <span class="comment">         * while it's in context help mode.</span>
00696 <span class="comment">         */</span>
00697         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00698                 <span class="comment">/*</span>
00699 <span class="comment">                 * Hack for OnScreen Keyboard: no finalization on button event.</span>
00700 <span class="comment">                 */</span>
00701                 (<a class="code" href="../../d6/d3/queue_8c.html#a36">GetAppImeCompatFlags</a>(ptiWnd) &amp; IMECOMPAT_NOFINALIZECOMPSTR) == 0) {
00702 
00703             <span class="keywordflow">if</span> (ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
00704                 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIme = ptiWnd-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>;
00705 
00706                 <span class="keywordflow">if</span> (pwndIme &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndIme, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
00707                     <span class="comment">/*</span>
00708 <span class="comment">                     * For new applications, we no longer post hacky WM_KEYUP.</span>
00709 <span class="comment">                     * Instead, we use private IME_SYSTEM message.</span>
00710 <span class="comment">                     */</span>
00711                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndIme, WM_IME_SYSTEM, IMS_FINALIZE_COMPSTR, 0);
00712                 }
00713             } <span class="keywordflow">else</span> {
00714                 <span class="comment">/*</span>
00715 <span class="comment">                 * For the backward compatibility w/NT4, we post WM_KEYUP to finalize</span>
00716 <span class="comment">                 * the composition string.</span>
00717 <span class="comment">                 */</span>
00718                 <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_KEYUP, VK_PROCESSKEY, 0, 0, 0);
00719             }
00720         }
00721     }
00722 
00723     <span class="comment">/*</span>
00724 <span class="comment">     * If screen capture is active do it</span>
00725 <span class="comment">     */</span>
00726     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a13">gspwndScreenCapture</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00727         pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a13">gspwndScreenCapture</a>;
00728 
00729     <span class="comment">/*</span>
00730 <span class="comment">     * If this is a button down event and there isn't already</span>
00731 <span class="comment">     * a mouse owner, setup the mouse ownership globals.</span>
00732 <span class="comment">     */</span>
00733     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a90">gspwndMouseOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00734         <span class="keywordflow">if</span> (!fBreak) {
00735             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndCapture;
00736 
00737             <span class="comment">/*</span>
00738 <span class="comment">             * BIG HACK: If the foreground window has the capture</span>
00739 <span class="comment">             * and the mouse is outside the foreground queue then</span>
00740 <span class="comment">             * send a buttondown/up pair to that queue so it'll</span>
00741 <span class="comment">             * cancel it's modal loop.</span>
00742 <span class="comment">             */</span>
00743             <span class="keywordflow">if</span> (pwndCapture = <a class="code" href="../../d6/d8/ntinput_8c.html#a59">PwndForegroundCapture</a>()) {
00744 
00745                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndCapture)-&gt;pq) {
00746                     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqCapture;
00747 
00748                     pqCapture = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndCapture)-&gt;pq;
00749                     <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(pqCapture, pwndCapture, message,
00750                             0, lParam, 0, 0);
00751                     <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(pqCapture, pwndCapture, message + 1,
00752                             0, lParam, 0, 0);
00753 
00754                     <span class="comment">/*</span>
00755 <span class="comment">                     * EVEN BIGGER HACK: To maintain compatibility</span>
00756 <span class="comment">                     * with how tracking deals with this, we don't</span>
00757 <span class="comment">                     * pass this event along.  This prevents mouse</span>
00758 <span class="comment">                     * clicks in other windows from causing them to</span>
00759 <span class="comment">                     * become foreground while tracking.  The exception</span>
00760 <span class="comment">                     * to this is when we have the sysmenu up on</span>
00761 <span class="comment">                     * an iconic window.</span>
00762 <span class="comment">                     */</span>
00763                     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndCapture)-&gt;pmsd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00764                             !<a class="code" href="../../d4/d1/userk_8h.html#a1323">IsMenuStarted</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndCapture))) {
00765                         <span class="keywordflow">return</span>;
00766                     }
00767                 }
00768             }
00769 
00770             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a90">gspwndMouseOwner</a>), pwnd);
00771             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> |= wHardwareButton;
00772             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o3">ptLastClick</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
00773         } <span class="keywordflow">else</span> {
00774 
00775             <span class="comment">/*</span>
00776 <span class="comment">             * The mouse owner must have been destroyed or unlocked</span>
00777 <span class="comment">             * by a fullscreen switch.  Keep the button state in sync.</span>
00778 <span class="comment">             */</span>
00779             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> &amp;= ~wHardwareButton;
00780         }
00781 
00782     } <span class="keywordflow">else</span> {
00783 
00784         <span class="comment">/*</span>
00785 <span class="comment">         * Give any other button events to the mouse-owner window</span>
00786 <span class="comment">         * to be consistent with old capture semantics.</span>
00787 <span class="comment">         */</span>
00788         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a13">gspwndScreenCapture</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00789             <span class="comment">/*</span>
00790 <span class="comment">             * NT5 Foreground and Drag Drop.</span>
00791 <span class="comment">             * If the mouse goes up on a different thread</span>
00792 <span class="comment">             * make the mouse up thread the owner of this click</span>
00793 <span class="comment">             */</span>
00794             <span class="keywordflow">if</span> (fBreak &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a90">gspwndMouseOwner</a>))) {
00795                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00796                 TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxButtonEvent. ptiLastWoken %#p"</span>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a>);
00797             }
00798             pwnd = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a90">gspwndMouseOwner</a>;
00799         }
00800 
00801         <span class="comment">/*</span>
00802 <span class="comment">         * If this is the button-up event for the mouse-owner</span>
00803 <span class="comment">         * clear gspwndMouseOwner.</span>
00804 <span class="comment">         */</span>
00805         <span class="keywordflow">if</span> (fBreak) {
00806             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> &amp;= ~wHardwareButton;
00807             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a>)
00808                 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a90">gspwndMouseOwner</a>);
00809         } <span class="keywordflow">else</span> {
00810             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> |= wHardwareButton;
00811         }
00812     }
00813 
00814     <span class="comment">/*</span>
00815 <span class="comment">     * Only update the async keystate when we know which window this</span>
00816 <span class="comment">     * event goes to (or else we can't keep the thread specific key</span>
00817 <span class="comment">     * state in sync).</span>
00818 <span class="comment">     */</span>
00819     UserAssert(usVK != 0);
00820     <a class="code" href="../../d4/d1/userk_8h.html#a1234">UpdateAsyncKeyState</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq, usVK, fBreak);
00821 
00822     <span class="comment">/*</span>
00823 <span class="comment">     * Put pwnd into the foreground if this is a button down event</span>
00824 <span class="comment">     * and it isn't already the foreground window.</span>
00825 <span class="comment">     */</span>
00826     <span class="keywordflow">if</span> (!fBreak &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
00827         <span class="comment">/*</span>
00828 <span class="comment">         * If this is an WM_*BUTTONDOWN on a desktop window just do</span>
00829 <span class="comment">         * cancel-mode processing.  Check to make sure that there</span>
00830 <span class="comment">         * wasn't already a mouse owner window.  See comments below.</span>
00831 <span class="comment">         */</span>
00832         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pwnd == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>) &amp;&amp;
00833                 ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> &amp; wHardwareButton) ||
00834                 (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> == 0))) {
00835             <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>,
00836                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, <a class="code" href="../../d4/d1/userk_8h.html#a335">QEVENT_CANCELMODE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0);
00837 
00838         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> &amp; wHardwareButton) ||
00839                 (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> == 0)) {
00840 
00841             <span class="comment">/*</span>
00842 <span class="comment">             * Don't bother setting the foreground window if there's</span>
00843 <span class="comment">             * already mouse owner window from a button-down different</span>
00844 <span class="comment">             * than this event.  This prevents weird things from happening</span>
00845 <span class="comment">             * when the user starts a tracking operation with the left</span>
00846 <span class="comment">             * button and clicks the right button during the tracking</span>
00847 <span class="comment">             * operation.</span>
00848 <span class="comment">             */</span>
00849             <span class="comment">/*</span>
00850 <span class="comment">             * If pwnd is a descendent of a WS_EX_NOACTIVATE window, then we</span>
00851 <span class="comment">             * won't set it to the  foreground</span>
00852 <span class="comment">             */</span>
00853             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTopLevel = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwnd);
00854             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndTopLevel, <a class="code" href="../../d1/d0/inc_2user_8h.html#a624">WEFNOACTIVATE</a>)) {
00855                 <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
00856                 <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00857                 <span class="comment">/*</span>
00858 <span class="comment">                 * Ok to unlock right away: the above didn't really leave the crit sec.</span>
00859 <span class="comment">                 * We lock here for consistency so the debug macros work ok.</span>
00860 <span class="comment">                 */</span>
00861                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00862 
00863             }
00864         }
00865     }
00866 
00867     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq-&gt;QF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a860">QF_MOUSEMOVED</a>) {
00868         <a class="code" href="../../d4/d1/userk_8h.html#a1478">PostMove</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq);
00869     }
00870 
00871     <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq, pwnd, message, wParam, lParam, time, ExtraInfo);
00872 
00873     <span class="comment">/*</span>
00874 <span class="comment">     * If this is a mouse up event and stickykeys is enabled all latched</span>
00875 <span class="comment">     * keys will be released.</span>
00876 <span class="comment">     */</span>
00877     <span class="keywordflow">if</span> (fBreak &amp;&amp; (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON) ||
00878                    <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON))) {
00879         <a class="code" href="../../d9/d3/access_8h.html#a61">xxxHardwareMouseKeyUp</a>(ButtonNumber);
00880     }
00881 
00882     <span class="keywordflow">if</span> (message == WM_LBUTTONDOWN) {
00883         <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;rpdesk;
00884         <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00885 
00886             UserAssert(!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>));
00887 
00888 <span class="preprocessor">#ifdef HUNGAPP_GHOSTING</span>
00889 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>)) {
00890                 SignalGhost(pwnd);
00891             }
00892 <span class="preprocessor">#else // HUNGAPP_GHOSTING</span>
00893 <span class="preprocessor"></span>            <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a18">gpEventHungThread</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00894 <span class="preprocessor">#endif // HUNGAPP_GHOSTING</span>
00895 <span class="preprocessor"></span>        }
00896     }
00897 }
00898 
00899 <span class="comment">/***************************************************************************\</span>
00900 <span class="comment">*</span>
00901 <span class="comment">* The Button-Click Queue is protected by the semaphore gcsMouseEventQueue</span>
00902 <span class="comment">*</span>
00903 <span class="comment">\***************************************************************************/</span>
00904 <span class="preprocessor">#ifdef LOCK_MOUSE_CODE</span>
00905 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MOUSE, QueueMouseEvent)</span>
00906 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00907 <span class="preprocessor"></span>
00908 <span class="comment">/***************************************************************************\</span>
00909 <span class="comment">* QueueMouseEvent</span>
00910 <span class="comment">*</span>
00911 <span class="comment">* Params:</span>
00912 <span class="comment">*     ButtonFlags - button flags from the driver in MOUSE_INPUT_DATA.ButtonFlags</span>
00913 <span class="comment">*</span>
00914 <span class="comment">*     ButtonData  - data from the driver in MOUSE_INPUT_DATA.ButtonData</span>
00915 <span class="comment">*                   Stores the wheel delta</span>
00916 <span class="comment">*</span>
00917 <span class="comment">*     ExtraInfo - extra information from the driver in MOUSE_INPUT_DATA.ExtraInfo</span>
00918 <span class="comment">*     ptMouse - mouse delta</span>
00919 <span class="comment">*     time - tick count at time of event</span>
00920 <span class="comment">*     bInjected - injected by SendInput?</span>
00921 <span class="comment">*     bWakeRIT - wake the RIT?</span>
00922 <span class="comment">*</span>
00923 <span class="comment">\***************************************************************************/</span>
00924 
<a name="l00925"></a><a class="code" href="../../d4/d1/userk_8h.html#a1033">00925</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1033">QueueMouseEvent</a>(
00926     USHORT  ButtonFlags,
00927     USHORT  ButtonData,
00928     ULONG_PTR ExtraInfo,
00929     POINT   ptMouse,
00930     LONG    time,
00931     BOOL    bInjected,
00932     BOOL    bWakeRIT
00933     )
00934 {
00935     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
00936 
00937     <a class="code" href="../../d4/d1/userk_8h.html#a2063">EnterMouseCrit</a>();
00938 
00939     <a class="code" href="../../d4/d1/userk_8h.html#a171">LOGTIME</a>(<a class="code" href="../../d6/d8/ntinput_8c.html#a23">gMouseQueueMouseEventTime</a>);
00940 
00941     <span class="comment">/*</span>
00942 <span class="comment">     * Button data must always be accompanied by a flag to interpret it.</span>
00943 <span class="comment">     */</span>
00944     UserAssert(ButtonData == 0 || ButtonFlags != 0);
00945 
00946     <span class="comment">/*</span>
00947 <span class="comment">     * We can coalesce this mouse event with the previous event if there is a</span>
00948 <span class="comment">     * previous event, and if the previous event and this event involve no</span>
00949 <span class="comment">     * key transitions.</span>
00950 <span class="comment">     */</span>
00951     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a211">gdwMouseEvents</a> == 0) ||
00952             (ButtonFlags != 0) ||
00953             (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a209">gMouseEventQueue</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a>].<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o0">ButtonFlags</a> != 0)) {
00954         <span class="comment">/*</span>
00955 <span class="comment">         * Can't coalesce: must add a new mouse event</span>
00956 <span class="comment">         */</span>
00957         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a211">gdwMouseEvents</a> &gt;= <a class="code" href="../../d4/d1/userk_8h.html#a173">NELEM_BUTTONQUEUE</a>) {
00958             <span class="comment">/*</span>
00959 <span class="comment">             * But no more room!</span>
00960 <span class="comment">             */</span>
00961             <a class="code" href="../../d4/d1/userk_8h.html#a2064">LeaveMouseCrit</a>();
00962             <a class="code" href="../../d4/d1/userk_8h.html#a1295">UserBeep</a>(440, 125);
00963             <span class="keywordflow">return</span>;
00964         }
00965 
00966         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a> = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a> + 1) % <a class="code" href="../../d4/d1/userk_8h.html#a173">NELEM_BUTTONQUEUE</a>;
00967         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a209">gMouseEventQueue</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a>].<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o0">ButtonFlags</a> = ButtonFlags;
00968         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a209">gMouseEventQueue</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a>].<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o1">ButtonData</a>  = ButtonData;
00969         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a211">gdwMouseEvents</a>++;
00970     }
00971 
00972     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a209">gMouseEventQueue</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a>].<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o2">ExtraInfo</a> = ExtraInfo;
00973     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a209">gMouseEventQueue</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a>].<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o3">ptPointer</a> = ptMouse;
00974     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a209">gMouseEventQueue</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a>].<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o4">time</a>      = time;
00975     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a209">gMouseEventQueue</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a>].<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o5">bInjected</a> = bInjected;
00976 
00977     <a class="code" href="../../d4/d1/userk_8h.html#a2064">LeaveMouseCrit</a>();
00978 
00979     <span class="keywordflow">if</span> (bWakeRIT) {
00980         <span class="comment">/*</span>
00981 <span class="comment">         * Signal RIT to complete the mouse input processing</span>
00982 <span class="comment">         */</span>
00983         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a177">gpkeMouseData</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00984     }
00985 }
00986 
00987 <span class="comment">/*****************************************************************************\</span>
00988 <span class="comment">*</span>
00989 <span class="comment">* Gets mouse events out of the queue</span>
00990 <span class="comment">*</span>
00991 <span class="comment">* Returns:</span>
00992 <span class="comment">*   TRUE  - a mouse event is obtained in *pme</span>
00993 <span class="comment">*   FALSE - no mouse event available</span>
00994 <span class="comment">*</span>
00995 <span class="comment">\*****************************************************************************/</span>
00996 
<a name="l00997"></a><a class="code" href="../../d4/d1/userk_8h.html#a1034">00997</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1034">UnqueueMouseEvent</a>(
00998     <a class="code" href="../../d5/d2/structtagMOUSEEVENT.html">PMOUSEEVENT</a> pme
00999     )
01000 {
01001     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTail;
01002 
01003     <a class="code" href="../../d4/d1/userk_8h.html#a2063">EnterMouseCrit</a>();
01004 
01005     <a class="code" href="../../d4/d1/userk_8h.html#a171">LOGTIME</a>(<a class="code" href="../../d6/d8/ntinput_8c.html#a24">gMouseUnqueueMouseEventTime</a>);
01006 
01007     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a211">gdwMouseEvents</a> == 0) {
01008         <a class="code" href="../../d4/d1/userk_8h.html#a2064">LeaveMouseCrit</a>();
01009         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01010     } <span class="keywordflow">else</span> {
01011         dwTail = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a210">gdwMouseQueueHead</a> - <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a211">gdwMouseEvents</a> + 1) % <a class="code" href="../../d4/d1/userk_8h.html#a173">NELEM_BUTTONQUEUE</a>;
01012         *pme = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a209">gMouseEventQueue</a>[dwTail];
01013         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a211">gdwMouseEvents</a>--;
01014     }
01015 
01016     <a class="code" href="../../d4/d1/userk_8h.html#a2064">LeaveMouseCrit</a>();
01017     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01018 }
01019 
<a name="l01020"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a47">01020</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a47">xxxDoButtonEvent</a>(<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html">PMOUSEEVENT</a> pme)
01021 {
01022     ULONG   dwButtonMask;
01023     ULONG   dwButtonState;
01024     LPARAM  lParam;
01025     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fWheel;
01026     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>   pHook;
01027     ULONG   dwButtonData = (ULONG) pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o1">ButtonData</a>;
01028 
01029     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01030 
01031     dwButtonState = (ULONG) pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o0">ButtonFlags</a>;
01032     fWheel = dwButtonState &amp; MOUSE_WHEEL;
01033     dwButtonState &amp;= ~MOUSE_WHEEL;
01034 
01035     <span class="keywordflow">for</span>(    dwButtonMask = 1;
01036             dwButtonState != 0;
01037             dwButtonData &gt;&gt;= 2, dwButtonState &gt;&gt;= 2, dwButtonMask &lt;&lt;= 1) {
01038 
01039         <span class="keywordflow">if</span> (dwButtonState &amp; 1) {
01040             <a class="code" href="../../d4/d1/userk_8h.html#a1027">xxxButtonEvent</a>(dwButtonMask, pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o3">ptPointer</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01041                 pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o4">time</a>, pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o2">ExtraInfo</a>, pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o5">bInjected</a>,
01042                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a343">gbClientDoubleClickSupport</a> &amp;&amp; (dwButtonData &amp; 1));
01043         }
01044 
01045         <span class="keywordflow">if</span> (dwButtonState &amp; 2) {
01046             <a class="code" href="../../d4/d1/userk_8h.html#a1027">xxxButtonEvent</a>(dwButtonMask, pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o3">ptPointer</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01047                 pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o4">time</a>, pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o2">ExtraInfo</a>, pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o5">bInjected</a> ,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01048         }
01049     }
01050 
01051     <span class="comment">/*</span>
01052 <span class="comment">     * Handle the wheel msg.</span>
01053 <span class="comment">     */</span>
01054     <span class="keywordflow">if</span> (fWheel &amp;&amp; pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o1">ButtonData</a> != 0 &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
01055 
01056         lParam = MAKELONG((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o3">ptPointer</a>.x, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o3">ptPointer</a>.y);
01057 
01058         <span class="comment">/*</span>
01059 <span class="comment">         * Call low level mouse hooks to see if they allow this message</span>
01060 <span class="comment">         * to pass through USER</span>
01061 <span class="comment">         */</span>
01062         <span class="keywordflow">if</span> ((pHook = <a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), WH_MOUSE_LL)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01063             MSLLHOOKSTRUCT mslls;
01064             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           bAnsiHook;
01065 
01066             mslls.pt          = pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o3">ptPointer</a>;
01067             mslls.mouseData   = MAKELONG(0, pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o1">ButtonData</a>);
01068             mslls.flags       = pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o5">bInjected</a>;
01069             mslls.time        = pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o4">time</a>;
01070             mslls.dwExtraInfo = pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o2">ExtraInfo</a>;
01071 
01072             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(pHook, HC_ACTION, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)WM_MOUSEWHEEL,
01073                     (LPARAM)&amp;mslls, &amp;bAnsiHook)) {
01074                 <span class="keywordflow">return</span>;
01075             }
01076         }
01077 
01078         <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(
01079                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>,
01080                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01081                 WM_MOUSEWHEEL,
01082                 MAKELONG(0, pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o1">ButtonData</a>),
01083                 lParam, pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o4">time</a>,
01084                 pme-&gt;<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o2">ExtraInfo</a>);
01085 
01086         <span class="keywordflow">return</span>;
01087     }
01088 }
01089 
<a name="l01090"></a><a class="code" href="../../d4/d1/userk_8h.html#a994">01090</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> NTAPI <a class="code" href="../../d4/d1/userk_8h.html#a994">InputApc</a>(
01091     IN PVOID ApcContext,
01092     IN PIO_STATUS_BLOCK IoStatusBlock,
01093     IN ULONG Reserved
01094     )
01095 {
01096     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo = (<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a>)ApcContext;
01097     UNREFERENCED_PARAMETER(Reserved);
01098 
01099 <span class="preprocessor">#ifdef DIAGNOSE_IO</span>
01100 <span class="preprocessor"></span>    pDeviceInfo-&gt;nReadsOutstanding--;
01101 <span class="preprocessor">#endif</span>
01102 <span class="preprocessor"></span>
01103     <span class="comment">/*</span>
01104 <span class="comment">     * If this device needs freeing, abandon reading now and request the free.</span>
01105 <span class="comment">     * (Don't even process the input that we received in this APC)</span>
01106 <span class="comment">     */</span>
01107     <span class="keywordflow">if</span> (pDeviceInfo-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a184">GDIAF_FREEME</a>) {
01108         <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
01109         pDeviceInfo-&gt;bFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a189">GDIF_READING</a>;
01110         <a class="code" href="../../d4/d1/userk_8h.html#a1032">FreeDeviceInfo</a>(pDeviceInfo);
01111         <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
01112         <span class="keywordflow">return</span>;
01113     }
01114 
01115     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatusBlock-&gt;Status)) {
01116         <a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html">PDEVICE_TEMPLATE</a> pDevTpl = &amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[pDeviceInfo-&gt;type];
01117         pDevTpl-&gt;<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o11">DeviceRead</a>(pDeviceInfo);
01118     }
01119     <a class="code" href="../../d4/d1/userk_8h.html#a1029">StartDeviceRead</a>(pDeviceInfo);
01120 }
01121 
01122 <span class="comment">/***************************************************************************\</span>
01123 <span class="comment">* ProcessMouseInput</span>
01124 <span class="comment">*</span>
01125 <span class="comment">* This function is called whenever a mouse event occurs.  Once the event</span>
01126 <span class="comment">* has been processed by USER, StartDeviceRead() is called again to request</span>
01127 <span class="comment">* the next mouse event.</span>
01128 <span class="comment">*</span>
01129 <span class="comment">* When this routin returns, InputApc will start another read.</span>
01130 <span class="comment">*</span>
01131 <span class="comment">* History:</span>
01132 <span class="comment">* 11-26-90 DavidPe      Created.</span>
01133 <span class="comment">* 07-23-92 Mikehar      Moved most of the processing to _InternalMouseEvent()</span>
01134 <span class="comment">* 11-08-92 JonPa        Rewrote button code to work with new mouse drivers</span>
01135 <span class="comment">* 11-18-97 IanJa        Renamed from MouseApcProcedure etc, for multiple mice</span>
01136 <span class="comment">\***************************************************************************/</span>
<a name="l01137"></a><a class="code" href="../../d4/d1/userk_8h.html#a991">01137</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a991">ProcessMouseInput</a>(
01138     <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pMouseInfo)
01139 {
01140     PMOUSE_INPUT_DATA pmei, pmeiNext;
01141     LONG              time;
01142     POINT             ptLastMove;
01143 
01144     <span class="comment">/*</span>
01145 <span class="comment">     * This is an APC, so we don't need the DeviceInfoList Critical Section</span>
01146 <span class="comment">     * In fact, we don't want it either. We will not remove the device until</span>
01147 <span class="comment">     * ProcessMouseInput has signalled that it is OK to do so. (TBD)</span>
01148 <span class="comment">     */</span>
01149     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
01150     <a class="code" href="../../d4/d1/userk_8h.html#a158">CheckDeviceInfoListCritOut</a>();
01151 
01152     UserAssert(pMouseInfo);
01153     UserAssert((<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>) ||
01154                (<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a240">gTermNOIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>));
01155 
01156     <a class="code" href="../../d4/d1/userk_8h.html#a171">LOGTIME</a>(<a class="code" href="../../d6/d8/ntinput_8c.html#a22">gMouseProcessMiceInputTime</a>);
01157 
01158     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01159         <span class="keywordflow">return</span>;
01160     }
01161 
01162     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a629">ACCF_ACCESSENABLED</a>)) {
01163         <span class="comment">/*</span>
01164 <span class="comment">         * Any mouse movement resets the count of consecutive shift key</span>
01165 <span class="comment">         * presses.  The shift key is used to enable &amp; disable the</span>
01166 <span class="comment">         * stickykeys accessibility functionality.</span>
01167 <span class="comment">         */</span>
01168         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a172">gStickyKeysLeftShiftCount</a> = 0;
01169         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a173">gStickyKeysRightShiftCount</a> = 0;
01170 
01171         <span class="comment">/*</span>
01172 <span class="comment">         * Any mouse movement also cancels the FilterKeys activation timer.</span>
01173 <span class="comment">         * Entering critsect here breaks non-jerky mouse movement</span>
01174 <span class="comment">         */</span>
01175         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a> != 0) {
01176             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01177             <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a>);
01178             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a> = 0;
01179             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a44">gFilterKeysState</a> = <a class="code" href="../../d9/d3/access_8h.html#a17">FKMOUSEMOVE</a>;
01180             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01181             <span class="keywordflow">return</span>;
01182         }
01183     }
01184 
01185     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(pMouseInfo-&gt;iosb.Status)) {
01186         <span class="comment">/*</span>
01187 <span class="comment">         * If we get a bad status, we abandon reading this mouse.</span>
01188 <span class="comment">         */</span>
01189         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>)
01190             <span class="keywordflow">if</span> (pMouseInfo-&gt;iosb.Status != STATUS_DELETE_PENDING) {
01191                 RIPMSG3(RIP_ERROR, <span class="stringliteral">"iosb.Status %lx for mouse %#p (id %x) tell IanJa x63321"</span>,
01192                         pMouseInfo-&gt;iosb.Status,
01193                         pMouseInfo, pMouseInfo-&gt;<a class="code" href="../../d5/d3/structtagDEVICEINFO.html#o1">mouse</a>.<a class="code" href="../../d4/d2/structtagMOUSE__DEVICE__INFO.html#o0">Attr</a>.MouseIdentifier);
01194             }
01195         <span class="keywordflow">return</span>;
01196     }
01197 
01198     <span class="comment">/*</span>
01199 <span class="comment">     * get the last move point from ptCursorAsync</span>
01200 <span class="comment">     */</span>
01201     ptLastMove = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>;
01202 
01203     pmei = pMouseInfo-&gt;<a class="code" href="../../d5/d3/structtagDEVICEINFO.html#o1">mouse</a>.<a class="code" href="../../d4/d2/structtagMOUSE__DEVICE__INFO.html#o1">Data</a>;
01204     <span class="keywordflow">while</span> (pmei != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01205 
01206         time = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
01207 
01208         <span class="comment">/*</span>
01209 <span class="comment">         * Figure out where the next event is.</span>
01210 <span class="comment">         */</span>
01211         pmeiNext = pmei + 1;
01212         <span class="keywordflow">if</span> ((PUCHAR)pmeiNext &gt;=
01213             (PUCHAR)(((PUCHAR)pMouseInfo-&gt;<a class="code" href="../../d5/d3/structtagDEVICEINFO.html#o1">mouse</a>.<a class="code" href="../../d4/d2/structtagMOUSE__DEVICE__INFO.html#o1">Data</a>) + pMouseInfo-&gt;iosb.Information)) {
01214 
01215             <span class="comment">/*</span>
01216 <span class="comment">             * If there isn't another event set pmeiNext to</span>
01217 <span class="comment">             * NULL so we exit the loop and don't get confused.</span>
01218 <span class="comment">             */</span>
01219             pmeiNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01220         }
01221 
01222         <span class="comment">/*</span>
01223 <span class="comment">         * If a PS/2 mouse was plugged in, evaluate the (new) mouse and</span>
01224 <span class="comment">         * the skip the input record.</span>
01225 <span class="comment">         */</span>
01226         <span class="keywordflow">if</span> (pmei-&gt;Flags &amp; MOUSE_ATTRIBUTES_CHANGED) {
01227             <a class="code" href="../../d4/d1/userk_8h.html#a992">RequestDeviceChange</a>(pMouseInfo, <a class="code" href="../../d4/d1/userk_8h.html#a183">GDIAF_REFRESH_MOUSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01228             <span class="keywordflow">goto</span> NextMouseInputRecord;
01229         }
01230 
01231         <span class="comment">/*</span>
01232 <span class="comment">         * First process any mouse movement that occured.</span>
01233 <span class="comment">         * It is important to process movement before button events, otherwise</span>
01234 <span class="comment">         * absolute coordinate pointing devices like touch-screens and tablets</span>
01235 <span class="comment">         * will produce button clicks at old coordinates.</span>
01236 <span class="comment">         */</span>
01237         <span class="keywordflow">if</span> (pmei-&gt;LastX || pmei-&gt;LastY) {
01238 
01239             <span class="comment">/*</span>
01240 <span class="comment">             * Get the actual point that will be injected.</span>
01241 <span class="comment">             */</span>
01242             <a class="code" href="../../d6/d8/ntinput_8c.html#a32">GetMouseCoord</a>(pmei-&gt;LastX,
01243                           pmei-&gt;LastY,
01244                           pmei-&gt;Flags,
01245                           time,
01246                           pmei-&gt;ExtraInformation,
01247                           &amp;ptLastMove);
01248 
01249             <span class="comment">/*</span>
01250 <span class="comment">             * If this is a move-only event, and the next one is also a</span>
01251 <span class="comment">             * move-only event, skip/coalesce it.</span>
01252 <span class="comment">             */</span>
01253             <span class="keywordflow">if</span> (    (pmeiNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01254                     (pmei-&gt;ButtonFlags == 0) &amp;&amp;
01255                     (pmeiNext-&gt;ButtonFlags == 0) &amp;&amp;
01256                     (<a class="code" href="../../d6/d8/ntinput_8c.html#a14">fAbsoluteMouse</a>(pmei) == <a class="code" href="../../d6/d8/ntinput_8c.html#a14">fAbsoluteMouse</a>(pmeiNext))) {
01257 
01258                 pmei = pmeiNext;
01259 
01260                 <span class="keywordflow">continue</span>;
01261             }
01262 
01263             <span class="comment">/*</span>
01264 <span class="comment">             * Moves the cursor on the screen and updates gptCursorAsync</span>
01265 <span class="comment">             * Call directly xxxMoveEventAbsolute because we already did the</span>
01266 <span class="comment">             * acceleration sensitivity and clipping.</span>
01267 <span class="comment">             */</span>
01268             <a class="code" href="../../d6/d8/ntinput_8c.html#a33">xxxMoveEventAbsolute</a>(
01269                     ptLastMove.x,
01270                     ptLastMove.y,
01271                     pmei-&gt;ExtraInformation,
01272                     time,
01273                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01274                     );
01275 
01276             <span class="comment">/*</span>
01277 <span class="comment">             * Now update ptLastMove with ptCursorAsync because ptLastMove</span>
01278 <span class="comment">             * doesn't reflect the clipping.</span>
01279 <span class="comment">             */</span>
01280             ptLastMove = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>;
01281         }
01282 
01283         <span class="comment">/*</span>
01284 <span class="comment">         * Queue mouse event for the other thread to pick up when it finishes</span>
01285 <span class="comment">         * with the USER critical section.</span>
01286 <span class="comment">         * If pmeiNext == NULL, there is no more mouse input yet, so wake RIT.</span>
01287 <span class="comment">         */</span>
01288         <a class="code" href="../../d4/d1/userk_8h.html#a1033">QueueMouseEvent</a>(
01289                 pmei-&gt;ButtonFlags,
01290                 pmei-&gt;ButtonData,
01291                 pmei-&gt;ExtraInformation,
01292                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>,
01293                 time,
01294                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01295                 (pmeiNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
01296 
01297 NextMouseInputRecord:
01298         pmei = pmeiNext;
01299     }
01300 
01301     <span class="keywordflow">return</span>;
01302 }
01303 
01304 
01305 <span class="comment">/***************************************************************************\</span>
01306 <span class="comment">* IsHexNumpadKeys (RIT) inline</span>
01307 <span class="comment">*</span>
01308 <span class="comment">* If you change this code, you may need to change</span>
01309 <span class="comment">* xxxInternalToUnicode() as well.</span>
01310 <span class="comment">\***************************************************************************/</span>
<a name="l01311"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a50">01311</a> __inline <a class="code" href="../../d6/d8/ntinput_8c.html#a50">IsHexNumpadKeys</a>(BYTE Vk, WORD wScanCode)
01312 {
01313     <span class="keywordflow">return</span> (wScanCode &gt;= SCANCODE_NUMPAD_FIRST &amp;&amp; wScanCode &lt;= SCANCODE_NUMPAD_LAST &amp;&amp; <a class="code" href="../../d7/d8/kbd_8c.html#a1">aVkNumpad</a>[wScanCode - SCANCODE_NUMPAD_FIRST] != 0xff) ||
01314         (Vk &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span> &amp;&amp; Vk &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'F'</span>) ||
01315         (Vk &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span> &amp;&amp; Vk &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>);
01316 }
01317 
01318 <span class="comment">/***************************************************************************\</span>
01319 <span class="comment">* xxxKeyEvent (RIT)</span>
01320 <span class="comment">*</span>
01321 <span class="comment">* All events from the keyboard driver go here.  We receive a scan code</span>
01322 <span class="comment">* from the driver and convert it to a virtual scan code and virtual</span>
01323 <span class="comment">* key.</span>
01324 <span class="comment">*</span>
01325 <span class="comment">* The async keystate table and keylights are also updated here.  Based</span>
01326 <span class="comment">* on the 'focus' window we direct the input to a specific window.  If</span>
01327 <span class="comment">* the ALT key is down we send the events as WM_SYSKEY* messages.</span>
01328 <span class="comment">*</span>
01329 <span class="comment">* History:</span>
01330 <span class="comment">* 10-18-90 DavidPe      Created.</span>
01331 <span class="comment">* 11-13-90 DavidPe      WM_SYSKEY* support.</span>
01332 <span class="comment">* 11-30-90 DavidPe      Added keylight updating support.</span>
01333 <span class="comment">* 12-05-90 DavidPe      Added hotkey support.</span>
01334 <span class="comment">* 03-14-91 DavidPe      Moved most lParam flag support to xxxCookMessage().</span>
01335 <span class="comment">* 06-07-91 DavidPe      Changed to use gpqForeground rather than pwndFocus.</span>
01336 <span class="comment">\***************************************************************************/</span>
01337 
<a name="l01338"></a><a class="code" href="../../d4/d1/userk_8h.html#a1039">01338</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1039">xxxKeyEvent</a>(
01339     USHORT    usFlaggedVk,
01340     WORD      wScanCode,
01341     DWORD     time,
01342     ULONG_PTR ExtraInfo,
01343     BOOL      bInjected)
01344 {
01345     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>        message, usExtraStuff;
01346     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fBreak;
01347     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>          VkHanded;
01348     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>          Vk;
01349     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>            tlpwndActivate;
01350     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         fsReserveKeys;
01351     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fMakeAltUpASysKey;
01352     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>         pHook;
01353     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>   ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01354 
01355     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01356 
01357     fBreak = usFlaggedVk &amp; KBDBREAK;
01358     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;bLastRITWasKeyboard = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01359 
01360     <span class="comment">/*</span>
01361 <span class="comment">     * Is this a keyup or keydown event?</span>
01362 <span class="comment">     */</span>
01363     message = fBreak ? WM_KEYUP : WM_KEYDOWN;
01364 
01365     VkHanded = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)usFlaggedVk;    <span class="comment">// get rid of state bits - no longer needed</span>
01366     usExtraStuff = usFlaggedVk &amp; KBDEXT;
01367 
01368     <span class="comment">/*</span>
01369 <span class="comment">     * Convert Left/Right Ctrl/Shift/Alt key to "unhanded" key.</span>
01370 <span class="comment">     * ie: if VK_LCONTROL or VK_RCONTROL, convert to VK_CONTROL etc.</span>
01371 <span class="comment">     * Update this "unhanded" key's state if necessary.</span>
01372 <span class="comment">     */</span>
01373     <span class="keywordflow">if</span> ((VkHanded &gt;= VK_LSHIFT) &amp;&amp; (VkHanded &lt;= VK_RMENU)) {
01374         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> VkOtherHand = VkHanded ^ 1;
01375 
01376         Vk = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((VkHanded - VK_LSHIFT) / 2 + VK_SHIFT);
01377         <span class="keywordflow">if</span> (!fBreak || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VkOtherHand)) {
01378             <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> != ptiCurrent)) {
01379                 <a class="code" href="../../d4/d1/userk_8h.html#a1234">UpdateAsyncKeyState</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, Vk, fBreak);
01380             }
01381         }
01382     } <span class="keywordflow">else</span> {
01383         Vk = VkHanded;
01384     }
01385 
01386     <span class="comment">/*</span>
01387 <span class="comment">     * Maintain gfsSASModifiersDown to indicate which of Ctrl/Shift/Alt</span>
01388 <span class="comment">     * are really truly physically down</span>
01389 <span class="comment">     */</span>
01390     <span class="keywordflow">if</span> (!bInjected &amp;&amp; ((wScanCode &amp; SCANCODE_SIMULATED) == 0)) {
01391         <span class="keywordflow">if</span> (fBreak) {
01392             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a229">gfsSASModifiersDown</a> &amp;= ~<a class="code" href="../../d6/d8/ntinput_8c.html#a16">VKTOMODIFIERS</a>(Vk);
01393         } <span class="keywordflow">else</span> {
01394             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a229">gfsSASModifiersDown</a> |= <a class="code" href="../../d6/d8/ntinput_8c.html#a16">VKTOMODIFIERS</a>(Vk);
01395         }
01396     }
01397 
01398     <span class="comment">/*</span>
01399 <span class="comment">     * Call low level keyboard hook to see if it allows this</span>
01400 <span class="comment">     * message to pass</span>
01401 <span class="comment">     */</span>
01402     <span class="keywordflow">if</span> ((pHook = <a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(ptiCurrent, WH_KEYBOARD_LL)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01403         KBDLLHOOKSTRUCT kbds;
01404         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            bAnsiHook;
01405         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>          <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = message;
01406 
01407         <span class="comment">/*</span>
01408 <span class="comment">         * Check if this is a WM_SYS* message</span>
01409 <span class="comment">         */</span>
01410         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a579">TestRawKeyDown</a>(VK_MENU) &amp;&amp;
01411             !<a class="code" href="../../d4/d1/userk_8h.html#a579">TestRawKeyDown</a>(VK_CONTROL)) {
01412 
01413             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> += (WM_SYSKEYDOWN - WM_KEYDOWN);
01414             usExtraStuff |= 0x2000;  <span class="comment">// ALT key down</span>
01415         }
01416         kbds.vkCode      = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)VkHanded;
01417         kbds.scanCode    = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)wScanCode;
01418         kbds.flags       = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(usExtraStuff | (bInjected ? (LLKHF_INJECTED &lt;&lt; 8) : 0));
01419         kbds.flags      |= (fBreak ? (KBDBREAK &gt;&gt; 8) : 0);
01420         kbds.time        = time;
01421         kbds.dwExtraInfo = ExtraInfo;
01422 
01423         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(pHook, HC_ACTION, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, (LPARAM)&amp;kbds, &amp;bAnsiHook)) {
01424 
01425             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsModifiers;
01426 
01427             <span class="comment">/*</span>
01428 <span class="comment">             * We can't let low level hooks or BlockInput() eat SAS</span>
01429 <span class="comment">             * or someone could write a trojan winlogon look alike.</span>
01430 <span class="comment">             */</span>
01431             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1260">IsSAS</a>(VkHanded, &amp;fsModifiers)) {
01432                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxKeyEvent: SAS ignore bad response from low level hook"</span>);
01433             } <span class="keywordflow">else</span> {
01434                 <span class="keywordflow">return</span>;
01435             }
01436         }
01437     }
01438 
01439     <span class="comment">/*</span>
01440 <span class="comment">     * If someone is blocking input and it's not us, don't allow this input</span>
01441 <span class="comment">     */</span>
01442     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> != ptiCurrent)) {
01443         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsModifiers;
01444         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1260">IsSAS</a>(VkHanded, &amp;fsModifiers)) {
01445             RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxKeyEvent: SAS unblocks BlockInput"</span>);
01446             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01447         } <span class="keywordflow">else</span> {
01448             <span class="keywordflow">return</span>;
01449         }
01450     }
01451 
01452     <a class="code" href="../../d4/d1/userk_8h.html#a1234">UpdateAsyncKeyState</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, VkHanded, fBreak);
01453 
01454     <span class="comment">/*</span>
01455 <span class="comment">     * Clear gfInNumpadHexInput if Menu key is up.</span>
01456 <span class="comment">     */</span>
01457     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a68">gfEnableHexNumpad</a>) {
01458         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_MENU)) {
01459             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>) {
01460                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>;
01461             }
01462         } <span class="keywordflow">else</span> {
01463             <span class="keywordflow">if</span> (!fBreak) {  <span class="comment">// if it's key down</span>
01464                 <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>) ||
01465                         wScanCode == <a class="code" href="../../d4/d1/userk_8h.html#a486">SCANCODE_NUMPAD_PLUS</a> || wScanCode == <a class="code" href="../../d4/d1/userk_8h.html#a487">SCANCODE_NUMPAD_DOT</a>) {
01466                     <span class="keywordflow">if</span> ((usExtraStuff &amp; KBDEXT) == 0) {
01467                         <span class="comment">/*</span>
01468 <span class="comment">                         * We need to check whether the input is escape character</span>
01469 <span class="comment">                         * of hex input mode.</span>
01470 <span class="comment">                         * This should be equivalent code as in xxxInternalToUnicode().</span>
01471 <span class="comment">                         * If you change this code, you may need to change</span>
01472 <span class="comment">                         * xxxInternalToUnicode() as well.</span>
01473 <span class="comment">                         */</span>
01474                         WORD wModBits = 0;
01475 
01476                         wModBits |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_MENU) ? KBDALT : 0;
01477                         wModBits |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_SHIFT) ? KBDSHIFT : 0;
01478                         wModBits |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_KANA) ? KBDKANA : 0;
01479 
01480                         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/tounicod_8c.html#a5">MODIFIER_FOR_ALT_NUMPAD</a>(wModBits)) {
01481                             <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>) == 0) {
01482                                 <span class="comment">/*</span>
01483 <span class="comment">                                 * Only if it's not a hotkey, we enter hex Alt+Numpad mode.</span>
01484 <span class="comment">                                 */</span>
01485                                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wHotKeyMod = 0;
01486 
01487                                 wHotKeyMod |= (wModBits &amp; KBDSHIFT) ? MOD_SHIFT : 0;
01488                                 wHotKeyMod |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_CONTROL) ? MOD_CONTROL : 0;
01489                                 UserAssert(wModBits &amp; KBDALT);
01490                                 wHotKeyMod |= MOD_ALT;
01491                                 wHotKeyMod |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_LWIN) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_RWIN) ?
01492                                                 MOD_WIN : 0;
01493 
01494                                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1262">IsHotKey</a>(wHotKeyMod, Vk) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01495                                     UserAssert(wScanCode == <a class="code" href="../../d4/d1/userk_8h.html#a486">SCANCODE_NUMPAD_PLUS</a> || wScanCode == <a class="code" href="../../d4/d1/userk_8h.html#a487">SCANCODE_NUMPAD_DOT</a>);
01496                                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>;
01497                                 }
01498                             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d8/ntinput_8c.html#a50">IsHexNumpadKeys</a>(Vk, wScanCode)) {
01499                                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>;
01500                             }
01501                         } <span class="keywordflow">else</span> {
01502                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>;
01503                         }
01504                     } <span class="keywordflow">else</span> {
01505                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>;
01506                     }
01507                 } <span class="keywordflow">else</span> {
01508                     UserAssert((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a488">NUMPAD_HEXMODE_LL</a>) == 0);
01509                 }
01510             }
01511         }
01512     }
01513 
01514     <span class="comment">/*</span>
01515 <span class="comment">     * If this is a make and the key is one linked to the keyboard LEDs,</span>
01516 <span class="comment">     * update their state.</span>
01517 <span class="comment">     */</span>
01518 
01519     <span class="keywordflow">if</span> (!fBreak &amp;&amp;
01520             ((Vk == VK_CAPITAL) || (Vk == VK_NUMLOCK) || (Vk == VK_SCROLL) ||
01521              (Vk == VK_KANA &amp;&amp; JAPANESE_KBD_LAYOUT(<a class="code" href="../../d6/d8/ntinput_8c.html#a43">GetActiveHKL</a>())))) {
01522         <span class="comment">/*</span>
01523 <span class="comment">         * Only Japanese keyboard layout could generate VK_KANA.</span>
01524 <span class="comment">         *</span>
01525 <span class="comment">         * [Comments for before]</span>
01526 <span class="comment">         *  Since NT 3.x, UpdatesKeyLisghts() had been called for VK_KANA</span>
01527 <span class="comment">         * at both of 'make' and 'break' to support NEC PC-9800 Series</span>
01528 <span class="comment">         * keyboard hardware, but for NT 4.0, thier keyboard driver emurate</span>
01529 <span class="comment">         * PC/AT keyboard hardware, then this is changed to</span>
01530 <span class="comment">         * "Call UpdateKeyLights() only at 'make' for VK_KANA"</span>
01531 <span class="comment">         */</span>
01532         <a class="code" href="../../d4/d1/userk_8h.html#a1180">UpdateKeyLights</a>(bInjected);
01533     }
01534 
01535     <span class="comment">/*</span>
01536 <span class="comment">     * check for reserved keys</span>
01537 <span class="comment">     */</span>
01538     fsReserveKeys = 0;
01539     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01540         fsReserveKeys = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o46">fsReserveKeys</a>;
01541 
01542     <span class="comment">/*</span>
01543 <span class="comment">     *  Check the RIT's queue to see if it's doing the cool switch thing.</span>
01544 <span class="comment">     *  Cancel if the user presses any other key.</span>
01545 <span class="comment">     */</span>
01546     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (!fBreak) &amp;&amp;
01547             Vk != VK_TAB &amp;&amp; Vk != VK_SHIFT &amp;&amp; Vk != VK_MENU) {
01548 
01549         <span class="comment">/*</span>
01550 <span class="comment">         * Remove the Alt-tab window</span>
01551 <span class="comment">         */</span>
01552         <a class="code" href="../../d1/d3/tmswitch_8c.html#a29">xxxCancelCoolSwitch</a>();
01553 
01554         <span class="comment">/*</span>
01555 <span class="comment">         * eat VK_ESCAPE if the app doesn't want it</span>
01556 <span class="comment">         */</span>
01557         <span class="keywordflow">if</span> ((Vk == VK_ESCAPE) &amp;&amp; !(fsReserveKeys &amp; CONSOLE_ALTESC)) {
01558             <span class="keywordflow">return</span>;
01559         }
01560     }
01561 
01562     <span class="comment">/*</span>
01563 <span class="comment">     * Check for hotkeys.</span>
01564 <span class="comment">     */</span>
01565     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1261">xxxDoHotKeyStuff</a>(Vk, fBreak, fsReserveKeys)) {
01566 
01567         <span class="comment">/*</span>
01568 <span class="comment">         * The hotkey was processed so don't pass on the event.</span>
01569 <span class="comment">         */</span>
01570         <span class="keywordflow">return</span>;
01571     }
01572 
01573     <span class="comment">/*</span>
01574 <span class="comment">     * If the ALT key is down and the CTRL key</span>
01575 <span class="comment">     * isn't, this is a WM_SYS* message.</span>
01576 <span class="comment">     */</span>
01577     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_MENU) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_CONTROL) &amp;&amp; Vk != VK_JUNJA) {
01578         <span class="comment">// VK_JUNJA is ALT+'+'. Since all KOR VKs are not converted to IME hotkey IDs and</span>
01579         <span class="comment">// should be passed directly to IME, KOR related VKs are not treated as SYSKEYDOWN.</span>
01580         message += (WM_SYSKEYDOWN - WM_KEYDOWN);
01581         usExtraStuff |= 0x2000;
01582 
01583         <span class="comment">/*</span>
01584 <span class="comment">         * If this is the ALT-down set this flag, otherwise</span>
01585 <span class="comment">         * clear it since we got a key inbetween the ALT-down</span>
01586 <span class="comment">         * and ALT-up.  (see comment below)</span>
01587 <span class="comment">         */</span>
01588         <span class="keywordflow">if</span> (Vk == VK_MENU) {
01589             fMakeAltUpASysKey = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01590             <span class="comment">/*</span>
01591 <span class="comment">             * Unlock SetForegroundWindow (if locked) when the ALT key went down.</span>
01592 <span class="comment">             */</span>
01593             <span class="keywordflow">if</span> (!fBreak) {
01594                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01595             }
01596         } <span class="keywordflow">else</span> {
01597             fMakeAltUpASysKey = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01598         }
01599 
01600     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vk == VK_MENU) {
01601         <span class="keywordflow">if</span> (fBreak) {
01602             <span class="comment">/*</span>
01603 <span class="comment">             * End our switch if we are in the middle of one.</span>
01604 <span class="comment">             */</span>
01605             <span class="keywordflow">if</span> (fMakeAltUpASysKey) {
01606 
01607                <span class="comment">/*</span>
01608 <span class="comment">                * We don't make the keyup of the ALT key a WM_SYSKEYUP if any</span>
01609 <span class="comment">                * other key is typed while the ALT key was down.  I don't know</span>
01610 <span class="comment">                * why we do this, but it's been here since version 1 and any</span>
01611 <span class="comment">                * app that uses SDM relies on it (eg - opus).</span>
01612 <span class="comment">                *</span>
01613 <span class="comment">                * The Alt bit is not set for the KEYUP message either.</span>
01614 <span class="comment">                */</span>
01615                message += (WM_SYSKEYDOWN - WM_KEYDOWN);
01616            }
01617 
01618            <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01619 
01620                <span class="comment">/*</span>
01621 <span class="comment">                * Send the alt up message before we change queues</span>
01622 <span class="comment">                */</span>
01623                <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01624 
01625                    <span class="comment">/*</span>
01626 <span class="comment">                    * Set this flag so that we know we're doing a tab-switch.</span>
01627 <span class="comment">                    * This makes sure that both cases where the ALT-KEY is released</span>
01628 <span class="comment">                    * before or after the TAB-KEY is handled.  It is checked in</span>
01629 <span class="comment">                    * xxxDefWindowProc().</span>
01630 <span class="comment">                    */</span>
01631                    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a862">QF_TABSWITCHING</a>;
01632 
01633                    <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, message, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)Vk,
01634                            MAKELONG(1, (wScanCode | usExtraStuff)),
01635                            time, ExtraInfo);
01636                }
01637 
01638                <span class="comment">/*</span>
01639 <span class="comment">                * Remove the Alt-tab window</span>
01640 <span class="comment">                */</span>
01641                <a class="code" href="../../d1/d3/tmswitch_8c.html#a29">xxxCancelCoolSwitch</a>();
01642 
01643                <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01644                    <span class="comment">/*</span>
01645 <span class="comment">                    * Make our selected window active and destroy our</span>
01646 <span class="comment">                    * switch window.  If the new window is minmized,</span>
01647 <span class="comment">                    * restore it.  If we are switching in the same</span>
01648 <span class="comment">                    * queue, we clear out gpqForeground to make</span>
01649 <span class="comment">                    * xxxSetForegroundWindow2 to change the pwnd</span>
01650 <span class="comment">                    * and make the switch.  This case will happen</span>
01651 <span class="comment">                    * with WOW and Console apps.</span>
01652 <span class="comment">                    */</span>
01653                    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>)-&gt;pq) {
01654                        <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01655                    }
01656 
01657                    <span class="comment">/*</span>
01658 <span class="comment">                    * Make the selected window thread the owner of the last input;</span>
01659 <span class="comment">                    *  since the user has selected him, he owns the ALT-TAB.</span>
01660 <span class="comment">                    */</span>
01661                    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>);
01662 
01663 
01664                    <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>, &amp;tlpwndActivate);
01665                    <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01666                            <a class="code" href="../../d4/d1/userk_8h.html#a507">SFW_SWITCH</a> | <a class="code" href="../../d4/d1/userk_8h.html#a510">SFW_ACTIVATERESTORE</a>);
01667                    <span class="comment">/*</span>
01668 <span class="comment">                    * Win3.1 calls SetWindowPos() with activate, which z-orders</span>
01669 <span class="comment">                    * first regardless, then activates. Our code relies on</span>
01670 <span class="comment">                    * xxxActivateThisWindow() to z-order, and it'll only do</span>
01671 <span class="comment">                    * it if the window does not have the child bit set (regardless</span>
01672 <span class="comment">                    * that the window is a child of the desktop).</span>
01673 <span class="comment">                    *</span>
01674 <span class="comment">                    * To be compatible, we'll just force z-order here if the</span>
01675 <span class="comment">                    * window has the child bit set. This z-order is asynchronous,</span>
01676 <span class="comment">                    * so this'll z-order after the activate event is processed.</span>
01677 <span class="comment">                    * That'll allow it to come on top because it'll be foreground</span>
01678 <span class="comment">                    * then. (Grammatik has a top level window with the child</span>
01679 <span class="comment">                    * bit set that wants to be come the active window).</span>
01680 <span class="comment">                    */</span>
01681                    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>)) {
01682                        <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>, (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)HWND_TOP, 0, 0, 0, 0,
01683                                SWP_NOSIZE | SWP_NOMOVE | SWP_ASYNCWINDOWPOS);
01684                    }
01685                    <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActivate);
01686 
01687                    <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>);
01688                }
01689                <span class="keywordflow">return</span>;
01690            }
01691         } <span class="keywordflow">else</span> {
01692             <span class="comment">/*</span>
01693 <span class="comment">             * The ALT key is down, unlock SetForegroundWindow (if locked)</span>
01694 <span class="comment">             */</span>
01695             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01696         }
01697     }
01698 
01699     <span class="comment">/*</span>
01700 <span class="comment">     * Handle switching.  Eat the Key if we are doing switching.</span>
01701 <span class="comment">     */</span>
01702     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a419">FJOURNALPLAYBACK</a>() &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a418">FJOURNALRECORD</a>() &amp;&amp; (!fBreak) &amp;&amp;
01703             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_MENU)) &amp;&amp;
01704             (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(VK_CONTROL)) &amp;&amp; <span class="comment">//gpqForeground &amp;&amp;</span>
01705             (((Vk == VK_TAB) &amp;&amp; !(fsReserveKeys &amp; CONSOLE_ALTTAB)) ||
01706             ((Vk == VK_ESCAPE) &amp;&amp; !(fsReserveKeys &amp; CONSOLE_ALTESC)))) {
01707 
01708             <a class="code" href="../../d4/d1/userk_8h.html#a1511">xxxNextWindow</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> ? <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> : <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, Vk);
01709 
01710     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01711         <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgPrev = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>;
01712         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> wParam = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)Vk;
01713         LONG lParam;
01714 
01715         <span class="comment">/*</span>
01716 <span class="comment">         * We have a packet containing a Unicode character</span>
01717 <span class="comment">         * This is injected by Pen via SendInput</span>
01718 <span class="comment">         */</span>
01719         <span class="keywordflow">if</span> ((Vk == VK_PACKET) &amp;&amp; (usFlaggedVk &amp; KBDUNICODE)) {
01720             wParam |= (wScanCode &lt;&lt; 16);
01721             wScanCode = 0;
01722         }
01723         lParam = MAKELONG(1, (wScanCode | usExtraStuff));
01724 
01725         <span class="comment">/*</span>
01726 <span class="comment">         * WM_*KEYDOWN messages are left unchanged on the queue except the</span>
01727 <span class="comment">         * repeat count field (LOWORD(lParam)) is incremented.</span>
01728 <span class="comment">         */</span>
01729         <span class="keywordflow">if</span> (pqmsgPrev != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01730                 pqmsgPrev-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message == message &amp;&amp;
01731                 (message == WM_KEYDOWN || message == WM_SYSKEYDOWN) &amp;&amp;
01732                 pqmsgPrev-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam == wParam &amp;&amp;
01733                 HIWORD(pqmsgPrev-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam) == HIWORD(lParam)) {
01734             <span class="comment">/*</span>
01735 <span class="comment">             * Increment the queued message's repeat count.  This could</span>
01736 <span class="comment">             * conceivably overflow but Win 3.0 doesn't deal with it</span>
01737 <span class="comment">             * and anyone who buffers up 65536 keystrokes is a chimp</span>
01738 <span class="comment">             * and deserves to have it wrap anyway.</span>
01739 <span class="comment">             */</span>
01740             pqmsgPrev-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam = MAKELONG(LOWORD(pqmsgPrev-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam) + 1,
01741                     HIWORD(lParam));
01742 
01743             <a class="code" href="../../d4/d1/userk_8h.html#a1198">WakeSomeone</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, message, pqmsgPrev);
01744 
01745         } <span class="keywordflow">else</span> {
01746             <span class="comment">/*</span>
01747 <span class="comment">             * check if these are speedracer keys - bug 339877</span>
01748 <span class="comment">             * for the speedracer keys we want to post an event message and generate the</span>
01749 <span class="comment">             * wm_appcommand in xxxprocesseventmessage</span>
01750 <span class="comment">             * Since SpeedRacer software looks for the hotkeys we want to let those through</span>
01751 <span class="comment">             * It is going in here since we don't want the ability to eat up tons of pool memory</span>
01752 <span class="comment">             * so we post the event message here and then post the input message for the wm_keydown</span>
01753 <span class="comment">             * below - that way if the key is repeated then there is coalescing done above and no more</span>
01754 <span class="comment">             * qevent_appcommands are posted to the input queue.</span>
01755 <span class="comment">             */</span>
01756             <span class="keywordflow">if</span> (VK_APPCOMMAND_FIRST &lt;= Vk &amp;&amp; Vk &lt;= VK_APPCOMMAND_LAST) {
01757                 <span class="comment">/*</span>
01758 <span class="comment">                 * Only send wm_appcommands for wm_keydown (&amp; wm_syskeydown) messages -</span>
01759 <span class="comment">                 * essentially we ignore wm_keyup for those vk's defined for wm_appcommand messages</span>
01760 <span class="comment">                 */</span>
01761                 <span class="keywordflow">if</span> (!fBreak &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
01762                     <span class="comment">/*</span>
01763 <span class="comment">                     * post an event message so we can syncronize with normal types of input</span>
01764 <span class="comment">                     * send through the vk - we will construct the message in xxxProcessEventMessage</span>
01765 <span class="comment">                     */</span>
01766                     <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, <a class="code" href="../../d4/d1/userk_8h.html#a350">QEVENT_APPCOMMAND</a>,
01767                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, (WPARAM)0, Vk);
01768                 }
01769             }
01770             <span class="comment">/*</span>
01771 <span class="comment">             * We let the key go through since we want wm_keydowns/ups to get generated for these</span>
01772 <span class="comment">             * SpeedRacer keys</span>
01773 <span class="comment">             */</span>
01774 
01775             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a860">QF_MOUSEMOVED</a>) {
01776                 <a class="code" href="../../d4/d1/userk_8h.html#a1478">PostMove</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>);
01777             }
01778 
01779             <a class="code" href="../../d4/d1/userk_8h.html#a1195">PostInputMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, message, wParam,
01780                     lParam, time, ExtraInfo);
01781         }
01782     }
01783 }
01784 
01785 <span class="comment">/**************************************************************************\</span>
01786 <span class="comment">* GetMouseCoord</span>
01787 <span class="comment">*</span>
01788 <span class="comment">* Calculates the coordinates of the point that will be injected.</span>
01789 <span class="comment">*</span>
01790 <span class="comment">* History:</span>
01791 <span class="comment">* 11-01-96 CLupu     Created.</span>
01792 <span class="comment">* 12-18-97 MCostea   MOUSE_VIRTUAL_DESKTOP support</span>
01793 <span class="comment">\**************************************************************************/</span>
<a name="l01794"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a32">01794</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a32">GetMouseCoord</a>(
01795     LONG   dx,
01796     LONG   dy,
01797     DWORD  dwFlags,
01798     LONG   time,
01799     ULONG_PTR  ExtraInfo,
01800     PPOINT ppt)
01801 {
01802     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; MOUSE_MOVE_ABSOLUTE) {
01803 
01804         LONG cxMetric, cyMetric;
01805 
01806         <span class="comment">/*</span>
01807 <span class="comment">         * If MOUSE_VIRTUAL_DESKTOP was specified, map to entire virtual screen</span>
01808 <span class="comment">         */</span>
01809         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; MOUSE_VIRTUAL_DESKTOP) {
01810             cxMetric = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXVIRTUALSCREEN);
01811             cyMetric = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYVIRTUALSCREEN);
01812         } <span class="keywordflow">else</span> {
01813             cxMetric = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSCREEN);
01814             cyMetric = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSCREEN);
01815         }
01816 
01817         <span class="comment">/*</span>
01818 <span class="comment">         * Absolute pointing device used: deltas are actually the current</span>
01819 <span class="comment">         * position.  Update the global mouse position.</span>
01820 <span class="comment">         *</span>
01821 <span class="comment">         * Note that the position is always reported in units of</span>
01822 <span class="comment">         * (0,0)-(0xFFFF,0xFFFF) which corresponds to</span>
01823 <span class="comment">         * (0,0)-(SYSMET(CXSCREEN), SYSMET(CYSCREEN)) in pixels.</span>
01824 <span class="comment">         * We must first scale it to fit on the screen using the formula:</span>
01825 <span class="comment">         *     ptScreen = ptMouse * resPrimaryMonitor / 64K</span>
01826 <span class="comment">         *</span>
01827 <span class="comment">         * The straightforward algorithm coding of this algorithm is:</span>
01828 <span class="comment">         *</span>
01829 <span class="comment">         *     ppt-&gt;x = (dx * SYSMET(CXSCREEN)) / (long)0x0000FFFF;</span>
01830 <span class="comment">         *     ppt-&gt;y = (dy * SYSMET(CYSCREEN)) / (long)0x0000FFFF;</span>
01831 <span class="comment">         *</span>
01832 <span class="comment">         * On x86, with 14 more bytes we can avoid the division function with</span>
01833 <span class="comment">         * the following code.</span>
01834 <span class="comment">         */</span>
01835 
01836         ppt-&gt;x = dx * cxMetric;
01837         <span class="keywordflow">if</span> (ppt-&gt;x &gt;= 0) {
01838             ppt-&gt;x = HIWORD(ppt-&gt;x);
01839         } <span class="keywordflow">else</span> {
01840             ppt-&gt;x = - (<span class="keywordtype">long</span>) HIWORD(-ppt-&gt;x);
01841         }
01842 
01843         ppt-&gt;y = dy * cyMetric;
01844         <span class="keywordflow">if</span> (ppt-&gt;y &gt;= 0) {
01845             ppt-&gt;y = HIWORD(ppt-&gt;y);
01846         } <span class="keywordflow">else</span> {
01847             ppt-&gt;y = - (<span class="keywordtype">long</span>) HIWORD(-ppt-&gt;y);
01848         }
01849 
01850         <span class="comment">/*</span>
01851 <span class="comment">         * (0, 0) must map to the leftmost point on the desktop</span>
01852 <span class="comment">         */</span>
01853         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; MOUSE_VIRTUAL_DESKTOP) {
01854             ppt-&gt;x +=  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(XVIRTUALSCREEN);
01855             ppt-&gt;y +=  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(YVIRTUALSCREEN);
01856         }
01857 
01858         <span class="comment">/*</span>
01859 <span class="comment">         * Reset the mouse sensitivity remainder.</span>
01860 <span class="comment">         */</span>
01861         <a class="code" href="../../d6/d8/ntinput_8c.html#a20">idxRemainder</a> = <a class="code" href="../../d6/d8/ntinput_8c.html#a21">idyRemainder</a> = 0;
01862 
01863         <span class="comment">/*</span>
01864 <span class="comment">         * Save the absolute coordinates in the global array</span>
01865 <span class="comment">         * for GetMouseMovePointsEx.</span>
01866 <span class="comment">         */</span>
01867         <a class="code" href="../../d4/d1/userk_8h.html#a152">SAVEPOINT</a>(dx, dy, 0xFFFF, 0xFFFF, time, ExtraInfo);
01868     } <span class="keywordflow">else</span> {
01869         <span class="comment">/*</span>
01870 <span class="comment">         * Is there any mouse acceleration to do?</span>
01871 <span class="comment">         */</span>
01872         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a120">gMouseSpeed</a> != 0) {
01873             dx = <a class="code" href="../../d6/d8/ntinput_8c.html#a31">DoMouseAccel</a>(dx);
01874             dy = <a class="code" href="../../d6/d8/ntinput_8c.html#a31">DoMouseAccel</a>(dy);
01875         }
01876 
01877         <span class="comment">/*</span>
01878 <span class="comment">         * Does the mouse sensitivity need to be adjusted?</span>
01879 <span class="comment">         */</span>
01880         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a124">gMouseSensitivity</a> != <a class="code" href="../../d4/d1/userk_8h.html#a484">MOUSE_SENSITIVITY_DEFAULT</a>) {
01881             <span class="keywordtype">int</span> iNumerator;
01882 
01883             <span class="keywordflow">if</span> (dx) {
01884                 iNumerator   = dx * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a123">gMouseSensitivityFactor</a> + <a class="code" href="../../d6/d8/ntinput_8c.html#a20">idxRemainder</a>;
01885                 dx           = iNumerator / 256 ;
01886                 <a class="code" href="../../d6/d8/ntinput_8c.html#a20">idxRemainder</a> = iNumerator % 256 ;
01887                 <span class="keywordflow">if</span> ((iNumerator &lt; 0) &amp;&amp; (idxRemainder &gt; 0)) {
01888                     dx++ ;
01889                     <a class="code" href="../../d6/d8/ntinput_8c.html#a20">idxRemainder</a> -= 256 ;
01890                 }
01891             }
01892             <span class="keywordflow">if</span> (dy) {
01893                 iNumerator   = dy * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a123">gMouseSensitivityFactor</a> + <a class="code" href="../../d6/d8/ntinput_8c.html#a21">idyRemainder</a> ;
01894                 dy           = iNumerator / 256 ;
01895                 <a class="code" href="../../d6/d8/ntinput_8c.html#a21">idyRemainder</a> = iNumerator % 256 ;
01896                 <span class="keywordflow">if</span> ((iNumerator &lt; 0) &amp;&amp; (idyRemainder &gt; 0)) {
01897                     dy++ ;
01898                     <a class="code" href="../../d6/d8/ntinput_8c.html#a21">idyRemainder</a> -= 256 ;
01899                 }
01900             }
01901         }
01902 
01903         ppt-&gt;x += dx;
01904         ppt-&gt;y += dy;
01905 
01906         <span class="comment">/*</span>
01907 <span class="comment">         * Save the absolute coordinates in the global array</span>
01908 <span class="comment">         * for GetMouseMovePointsEx.</span>
01909 <span class="comment">         */</span>
01910         <a class="code" href="../../d4/d1/userk_8h.html#a152">SAVEPOINT</a>(ppt-&gt;x, ppt-&gt;y,
01911                   <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXVIRTUALSCREEN) - 1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYVIRTUALSCREEN) - 1,
01912                   time, ExtraInfo);
01913     }
01914 }
01915 
01916 <span class="comment">/***************************************************************************\</span>
01917 <span class="comment">* xxxMoveEventAbsolute (RIT)</span>
01918 <span class="comment">*</span>
01919 <span class="comment">* Mouse move events from the mouse driver are processed here.  If there is a</span>
01920 <span class="comment">* mouse owner window setup from xxxButtonEvent() the event is automatically</span>
01921 <span class="comment">* sent there, otherwise it's sent to the window the mouse is over.</span>
01922 <span class="comment">*</span>
01923 <span class="comment">* Mouse acceleration happens here as well as cursor clipping (as a result of</span>
01924 <span class="comment">* the ClipCursor() API).</span>
01925 <span class="comment">*</span>
01926 <span class="comment">* History:</span>
01927 <span class="comment">* 10-18-90 DavidPe     Created.</span>
01928 <span class="comment">* 11-29-90 DavidPe     Added mouse acceleration support.</span>
01929 <span class="comment">* 01-25-91 IanJa       xxxWindowHitTest change</span>
01930 <span class="comment">*          IanJa       non-jerky mouse moves</span>
01931 <span class="comment">\***************************************************************************/</span>
01932 <span class="preprocessor">#ifdef LOCK_MOUSE_CODE</span>
01933 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MOUSE, xxxMoveEventAbsolute)</span>
01934 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01935 <span class="preprocessor"></span>
<a name="l01936"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a33">01936</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a33">xxxMoveEventAbsolute</a>(
01937     LONG         x,
01938     LONG         y,
01939     ULONG_PTR    dwExtraInfo,
01940     DWORD        time,
01941     BOOL         bInjected
01942     )
01943 {
01944     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
01945 
01946     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(WH_MOUSE_LL))) {
01947         MSLLHOOKSTRUCT mslls;
01948         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           bEatEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01949         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           bAnsiHook;
01950         <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> pHook;
01951 
01952         mslls.pt.x        = x;
01953         mslls.pt.y        = y;
01954         mslls.mouseData   = 0;
01955         mslls.flags       = bInjected;
01956         mslls.time        = time;
01957         mslls.dwExtraInfo = dwExtraInfo;
01958 
01959         <span class="comment">/*</span>
01960 <span class="comment">         * Call low level mouse hooks to see if they allow this message</span>
01961 <span class="comment">         * to pass through USER</span>
01962 <span class="comment">         */</span>
01963 
01964         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01965 
01966         <span class="comment">/*</span>
01967 <span class="comment">         * Check again to see if we still have the hook installed. Fix for 80477.</span>
01968 <span class="comment">         */</span>
01969         <span class="keywordflow">if</span> ((pHook = <a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>, WH_MOUSE_LL)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01970             bEatEvent = (<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(pHook, HC_ACTION, WM_MOUSEMOVE, (LPARAM)&amp;mslls, &amp;bAnsiHook) != 0);
01971         }
01972 
01973         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01974 
01975         <span class="keywordflow">if</span> (bEatEvent) {
01976             <span class="keywordflow">return</span>;
01977         }
01978     }
01979 
01980     <span class="comment">/*</span>
01981 <span class="comment">     * Blow off the event if WH_JOURNALPLAYBACK is installed.  Do not</span>
01982 <span class="comment">     * use FJOURNALPLAYBACK() because this routine may be called from</span>
01983 <span class="comment">     * multiple desktop threads and the hook check must be done</span>
01984 <span class="comment">     * for the rit thread, not the calling thread.</span>
01985 <span class="comment">     */</span>
01986     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a442">IsGlobalHooked</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(WH_JOURNALPLAYBACK))) {
01987         <span class="keywordflow">return</span>;
01988     }
01989 
01990     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>.x = x;
01991     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>.y = y;
01992 
01993     <a class="code" href="../../d4/d1/userk_8h.html#a1182">BoundCursor</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>);
01994 
01995     <span class="comment">/*</span>
01996 <span class="comment">     * Move the screen pointer.</span>
01997 <span class="comment">     */</span>
01998     GreMovePointer(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>.x, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>.y);
01999 
02000     <span class="comment">/*</span>
02001 <span class="comment">     * Save the time stamp in a global so we can use it in PostMove</span>
02002 <span class="comment">     */</span>
02003     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a77">gdwMouseMoveTimeStamp</a> = time;
02004 }
02005 
02006 <span class="comment">/***************************************************************************\</span>
02007 <span class="comment">* xxxMoveEvent (RIT)</span>
02008 <span class="comment">*</span>
02009 <span class="comment">* The dwFlags can be</span>
02010 <span class="comment">*   0 relative move</span>
02011 <span class="comment">*   MOUSEEVENTF_ABSOLUTE absolute move</span>
02012 <span class="comment">*   MOUSEEVENTF_VIRTUALDESK the absolute coordinates will be maped</span>
02013 <span class="comment">*   to the entire virtual desktop.  This flag makes sense only with MOUSEEVENTF_ABSOLUTE</span>
02014 <span class="comment">*</span>
02015 <span class="comment">\***************************************************************************/</span>
02016 <span class="preprocessor">#ifdef LOCK_MOUSE_CODE</span>
02017 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MOUSE, xxxMoveEvent)</span>
02018 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02019 <span class="preprocessor"></span>
<a name="l02020"></a><a class="code" href="../../d4/d1/userk_8h.html#a1028">02020</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1028">xxxMoveEvent</a>(
02021     LONG         dx,
02022     LONG         dy,
02023     DWORD        dwFlags,
02024     ULONG_PTR    dwExtraInfo,
02025     DWORD        time,
02026     BOOL         bInjected)
02027 {
02028     POINT ptLastMove = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>;
02029 
02030     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
02031 
02032     <span class="comment">/*</span>
02033 <span class="comment">     * Get the actual point that will be injected.</span>
02034 <span class="comment">     */</span>
02035     <a class="code" href="../../d6/d8/ntinput_8c.html#a32">GetMouseCoord</a>(dx, dy, <a class="code" href="../../d6/d8/ntinput_8c.html#a15">ConvertToMouseDriverFlags</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>),
02036                   time, dwExtraInfo, &amp;ptLastMove);
02037 
02038     <span class="comment">/*</span>
02039 <span class="comment">     * move the mouse</span>
02040 <span class="comment">     */</span>
02041     <a class="code" href="../../d6/d8/ntinput_8c.html#a33">xxxMoveEventAbsolute</a>(
02042             ptLastMove.x,
02043             ptLastMove.y,
02044             dwExtraInfo,
02045             time,
02046             bInjected);
02047 }
02048 
02049 
02050 <span class="comment">/***************************************************************************\</span>
02051 <span class="comment">* UpdateRawKeyState</span>
02052 <span class="comment">*</span>
02053 <span class="comment">* A helper routine for ProcessKeyboardInput.</span>
02054 <span class="comment">* Based on a VK and a make/break flag, this function will update the physical</span>
02055 <span class="comment">* keystate table.</span>
02056 <span class="comment">*</span>
02057 <span class="comment">* History:</span>
02058 <span class="comment">* 10-13-91 IanJa        Created.</span>
02059 <span class="comment">\***************************************************************************/</span>
02060 
<a name="l02061"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a53">02061</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d8/ntinput_8c.html#a53">UpdateRawKeyState</a>(
02062     BYTE Vk,
02063     BOOL fBreak)
02064 {
02065     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02066 
02067     <span class="keywordflow">if</span> (fBreak) {
02068         <a class="code" href="../../d4/d1/userk_8h.html#a581">ClearRawKeyDown</a>(Vk);
02069     } <span class="keywordflow">else</span> {
02070 
02071         <span class="comment">/*</span>
02072 <span class="comment">         * This is a key make.  If the key was not already down, update the</span>
02073 <span class="comment">         * physical toggle bit.</span>
02074 <span class="comment">         */</span>
02075         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a579">TestRawKeyDown</a>(Vk)) {
02076             <a class="code" href="../../d4/d1/userk_8h.html#a585">ToggleRawKeyToggle</a>(Vk);
02077         }
02078 
02079         <span class="comment">/*</span>
02080 <span class="comment">         * This is a make, so turn on the physical key down bit.</span>
02081 <span class="comment">         */</span>
02082         <a class="code" href="../../d4/d1/userk_8h.html#a580">SetRawKeyDown</a>(Vk);
02083     }
02084 }
02085 
02086 
<a name="l02087"></a><a class="code" href="../../d4/d1/userk_8h.html#a1208">02087</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1208">CleanupResources</a>(
02088     VOID)
02089 {
02090     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a>       ppcls;
02091     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
02092 
02093     UserAssert(!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a325">gbCleanedUpResources</a>);
02094 
02095     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a325">gbCleanedUpResources</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02096 
02097     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a770">HH_CLEANUPRESOURCES</a>);
02098 
02099     <span class="comment">/*</span>
02100 <span class="comment">     * Prevent power callouts.</span>
02101 <span class="comment">     */</span>
02102     <a class="code" href="../../d4/d1/userk_8h.html#a1967">CleanupPowerRequestList</a>();
02103 
02104     <span class="comment">/*</span>
02105 <span class="comment">     * Destroy the system classes also</span>
02106 <span class="comment">     */</span>
02107     ppcls = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a154">gpclsList</a>;
02108     <span class="keywordflow">while</span> (*ppcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02109         <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(ppcls);
02110     }
02111 
02112     <span class="comment">/*</span>
02113 <span class="comment">     * Unlock the cursor from all the CSRSS's threads.</span>
02114 <span class="comment">     * We do this here because RIT might not be the only</span>
02115 <span class="comment">     * CSRSS process running at this time and we want</span>
02116 <span class="comment">     * to prevent the change of thread ownership</span>
02117 <span class="comment">     * after RIT is gone.</span>
02118 <span class="comment">     */</span>
02119     pti = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;ptiList;
02120 
02121     <span class="keywordflow">while</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02122 
02123         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02124             <a class="code" href="../../d4/d1/userk_8h.html#a599">LockQCursor</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02125         }
02126         pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>;
02127     }
02128 
02129     <a class="code" href="../../d4/d1/userk_8h.html#a1847">UnloadCursorsAndIcons</a>();
02130 
02131     <span class="comment">/*</span>
02132 <span class="comment">     * Cleanup the GDI globals in USERK</span>
02133 <span class="comment">     */</span>
02134     <a class="code" href="../../d4/d1/userk_8h.html#a1207">CleanupGDI</a>();
02135 }
02136 
02137 
02138 <span class="comment">/***************************************************************************\</span>
02139 <span class="comment">* InitiateWin32kCleanup (RIT)</span>
02140 <span class="comment">*</span>
02141 <span class="comment">* This function starts the cleanup of a win32k</span>
02142 <span class="comment">*</span>
02143 <span class="comment">* History:</span>
02144 <span class="comment">* 04-Dec-97 clupu      Created.</span>
02145 <span class="comment">\***************************************************************************/</span>
<a name="l02146"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a55">02146</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a55">InitiateWin32kCleanup</a>(
02147     VOID)
02148 {
02149     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent;
02150     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>  pwinsta;
02151     BOOLEAN         fWait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02152     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
02153     UNICODE_STRING  ustrName;
02154     WCHAR           <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>[<a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a>];
02155     HANDLE          hevtRitExited;
02156     OBJECT_ATTRIBUTES obja;
02157     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02158     LARGE_INTEGER   timeout;
02159     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        Reason;
02160     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fFirstTimeout = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02161 
02162     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
02163         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02164     }
02165 
02166     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"InitiateWin32kCleanup\n"</span>));
02167 
02168     <a class="code" href="../../d4/d1/userk_8h.html#a779">TRACE_RIT</a>((<span class="stringliteral">"Exiting Win32k ...\n"</span>));
02169 
02170     <span class="comment">/*</span>
02171 <span class="comment">     * Prevent power callouts.</span>
02172 <span class="comment">     */</span>
02173     <a class="code" href="../../d4/d1/userk_8h.html#a1967">CleanupPowerRequestList</a>();
02174 
02175     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02176 
02177     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a763">HH_INITIATEWIN32KCLEANUP</a>);
02178 
02179     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02180 
02181     UserAssert(ptiCurrent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02182 
02183     pwinsta = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o23">pwinsta</a>;
02184 
02185     <span class="comment">/*</span>
02186 <span class="comment">     * Give DTs 5 minutes to go away</span>
02187 <span class="comment">     */</span>
02188     timeout.QuadPart = Int32x32To64(-10000, 300000);
02189 
02190     <span class="comment">/*</span>
02191 <span class="comment">     * Wait for all desktops to exit other than the disconnected desktop.</span>
02192 <span class="comment">     */</span>
02193     <span class="keywordflow">while</span> (fWait) {
02194 
02195         <span class="comment">/*</span>
02196 <span class="comment">         * If things are left on the destroy list or the disconnected desktop is</span>
02197 <span class="comment">         * not the current desktop (at the end we should always switch to the</span>
02198 <span class="comment">         * disconnected desktop), then wait.</span>
02199 <span class="comment">         */</span>
02200         pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
02201 
02202         <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02203             <span class="keywordflow">break</span>;
02204         }
02205 
02206         fWait = pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>
02207                  || pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02208                  || pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o6">rpdeskDestroy</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02209 
02210         <span class="keywordflow">if</span> (fWait) {
02211 
02212             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02213 
02214             Reason = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a346">gpevtDesktopDestroyed</a>, <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
02215                                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;timeout);
02216 
02217             <span class="keywordflow">if</span> (Reason == STATUS_TIMEOUT) {
02218 
02219                 <span class="comment">/*</span>
02220 <span class="comment">                 * The first time we timeout might be because winlogon died</span>
02221 <span class="comment">                 * before calling ExitWindowsEx. In that case there may be processes</span>
02222 <span class="comment">                 * w/ GUI threads running and those threads will have an hdesk</span>
02223 <span class="comment">                 * in the THREADINFO structure. Thus the desktop threads will not exit.</span>
02224 <span class="comment">                 * In this situation we signal the event 'EventRitStuck' so that</span>
02225 <span class="comment">                 * csrss can tell termsrv to start killing the remaining processes</span>
02226 <span class="comment">                 * calling NtTerminateProcess on them. csrss signals that to termsrv</span>
02227 <span class="comment">                 * by closing the LPC port in ntuser\server\api.c (W32WinStationTerminate)</span>
02228 <span class="comment">                 */</span>
02229 
02230                 <span class="keywordflow">if</span> (fFirstTimeout) {
02231 
02232                     HANDLE hevtRitStuck;
02233 
02234                     RIPMSG0(RIP_WARNING,
02235                             <span class="stringliteral">"Timeout in RIT waiting for gpevtDesktopDestroyed. Signal EventRitStuck..."</span>);
02236 
02237                     swprintf(<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Sessions\\%ld\\BaseNamedObjects\\EventRitStuck"</span>,
02238                              <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>);
02239 
02240                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ustrName, <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>);
02241 
02242                     InitializeObjectAttributes(&amp;obja,
02243                                                &amp;ustrName,
02244                                                OBJ_CASE_INSENSITIVE | OBJ_OPENIF,
02245                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02246                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02247 
02248                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(&amp;hevtRitStuck,
02249                                            EVENT_ALL_ACCESS,
02250                                            &amp;obja,
02251                                            SynchronizationEvent,
02252                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02253 
02254                     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02255 
02256                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02257                         ZwSetEvent(hevtRitStuck, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02258                         ZwClose(hevtRitStuck);
02259 
02260                         fFirstTimeout = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02261                     }
02262 
02263                 } <span class="keywordflow">else</span> {
02264                     RIPMSG0(RIP_ERROR,
02265                             <span class="stringliteral">"Timeout in RIT waiting for gpevtDesktopDestroyed.\n"</span>
02266                             <span class="stringliteral">"There are still GUI threads (assigned to a desktop) running !"</span>);
02267                 }
02268             }
02269 
02270             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02271         }
02272     }
02273     <a class="code" href="../../d4/d1/userk_8h.html#a779">TRACE_RIT</a>((<span class="stringliteral">"All other desktops exited...\n"</span>));
02274 
02275     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>);
02276 
02277     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02278 
02279     <a class="code" href="../../d4/d1/userk_8h.html#a779">TRACE_RIT</a>((<span class="stringliteral">"Shutting down ptiCurrent %lx cWindows %d\n"</span>,
02280            ptiCurrent, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a>));
02281 
02282     <span class="comment">/*</span>
02283 <span class="comment">     * Clear out some values so some operations won't be possible</span>
02284 <span class="comment">     */</span>
02285     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a13">gspwndScreenCapture</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02286     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a90">gspwndMouseOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02287     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a14">gspwndInternalCapture</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02288 
02289     <span class="comment">/*</span>
02290 <span class="comment">     * Free any SPB's (Taken from wallpaper change code)</span>
02291 <span class="comment">     */</span>
02292 
02293     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>) <span class="comment">// If this wasn't allocated, never mind</span>
02294         <a class="code" href="../../d1/d4/spb_8c.html#a12">FreeAllSpbs</a>();
02295 
02296     <span class="comment">/*</span>
02297 <span class="comment">     * Close the disconnected desktop.</span>
02298 <span class="comment">     */</span>
02299     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a348">ghDisconnectWinSta</a>) {
02300         UserVerify(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ZwClose(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a348">ghDisconnectWinSta</a>)));
02301         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a348">ghDisconnectWinSta</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02302     }
02303 
02304     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a347">ghDisconnectDesk</a>) {
02305         <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a347">ghDisconnectDesk</a>);
02306         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a347">ghDisconnectDesk</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02307     }
02308 
02309     UserAssert(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02310 
02311     <span class="comment">/*</span>
02312 <span class="comment">     * Unlock the logon desktop from the global variable</span>
02313 <span class="comment">     */</span>
02314     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a>, LDU_DESKLOGON, 0);
02315 
02316     <span class="comment">/*</span>
02317 <span class="comment">     * Unlock the disconnect logon</span>
02318 <span class="comment">     *</span>
02319 <span class="comment">     * This was referenced when we created it, so free it now.</span>
02320 <span class="comment">     * This is also a flag since the disconnect code checks to see if</span>
02321 <span class="comment">     * the disconnected desktop is still around.</span>
02322 <span class="comment">     */</span>
02323     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>, LDU_DESKDISCONNECT, 0);
02324 
02325     <span class="comment">/*</span>
02326 <span class="comment">     * Unlock any windows still locked in the SMS list. We need to do</span>
02327 <span class="comment">     * this here because if we don't, we end up with zombie windows in the</span>
02328 <span class="comment">     * desktop thread that we'll try to assign to RIT but RIT will be gone.</span>
02329 <span class="comment">     */</span>
02330     {
02331         <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psms = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>;
02332 
02333         <span class="keywordflow">while</span> (psms != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02334             <span class="keywordflow">if</span> (psms-&gt;spwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02335                 UserAssert(psms-&gt;message == WM_CLIENTSHUTDOWN);
02336 
02337                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"Window %x locked in the SMS list"</span>,
02338                         psms-&gt;spwnd);
02339 
02340                 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;psms-&gt;spwnd);
02341             }
02342             psms = psms-&gt;psmsNext;
02343         }
02344     }
02345 
02346     <a class="code" href="../../d4/d1/userk_8h.html#a779">TRACE_RIT</a>((<span class="stringliteral">"posting WM_QUIT to the IO DT\n"</span>));
02347 
02348     UserAssert(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02349 
02350     UserVerify(<a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>, WM_QUIT, 0, 0));
02351 
02352     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a772">HH_DTQUITPOSTED</a>);
02353 
02354     <span class="comment">/*</span>
02355 <span class="comment">     * Wait for desktop thread(s) to exit.</span>
02356 <span class="comment">     * This thread (RIT) is used to assign</span>
02357 <span class="comment">     * objects if the orginal thread leaves.  So it should be</span>
02358 <span class="comment">     * the last one to go.  Hopefully, if the desktop thread</span>
02359 <span class="comment">     * exits, there shouldn't be any objects in use.</span>
02360 <span class="comment">     */</span>
02361     {
02362         PVOID  aDT[2];
02363         ULONG  objects = 1;
02364 
02365         aDT[0] = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;pEThread;
02366 
02367         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(aDT[0]);
02368 
02369         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a240">gTermNOIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02370             aDT[1] = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a240">gTermNOIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;pEThread;
02371             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(aDT[1]);
02372             objects++;
02373         }
02374 
02375         <a class="code" href="../../d4/d1/userk_8h.html#a779">TRACE_RIT</a>((<span class="stringliteral">"waiting on desktop thread(s) destruction ...\n"</span>));
02376 
02377         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02378 
02379         <span class="comment">/*</span>
02380 <span class="comment">         * Give DTs 5 minutes to go away</span>
02381 <span class="comment">         */</span>
02382         timeout.QuadPart = Int32x32To64(-10000, 300000);
02383 WaitAgain:
02384 
02385         Reason =
02386 
02387         <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(objects,
02388                                  aDT,
02389                                  WaitAll,
02390                                  <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
02391                                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02392                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02393                                  &amp;timeout,
02394                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02395 
02396         <span class="keywordflow">if</span> (Reason == STATUS_TIMEOUT) {
02397             RIPMSG0(RIP_ERROR,
02398                     <span class="stringliteral">"Timeout in RIT waiting for desktop threads to go away."</span>);
02399             <span class="keywordflow">goto</span> WaitAgain;
02400         }
02401 
02402         <a class="code" href="../../d4/d1/userk_8h.html#a779">TRACE_RIT</a>((<span class="stringliteral">"desktop thread(s) destroyed\n"</span>));
02403 
02404         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(aDT[0]);
02405 
02406         <span class="keywordflow">if</span> (objects &gt; 1) {
02407             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(aDT[1]);
02408         }
02409 
02410         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02411     }
02412 
02413     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a764">HH_ALLDTGONE</a>);
02414 
02415     <span class="comment">/*</span>
02416 <span class="comment">     * If still connected, tell the miniport driver to disconnect</span>
02417 <span class="comment">     */</span>
02418     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a>) {
02419         bDrvDisconnect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a338">ghRemoteThinwireChannel</a>,
02420                        <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>);
02421     }
02422 
02423     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>, LDU_DESKRITINPUT, 0);
02424     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a330">gspdeskShouldBeForeground</a>, LDU_DESKSHOULDBEFOREGROUND, 0);
02425 
02426     <span class="comment">/*</span>
02427 <span class="comment">     * Free outstanding timers</span>
02428 <span class="comment">     */</span>
02429     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02430         <a class="code" href="../../d4/d1/userk_8h.html#a1045">FreeTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>);
02431     }
02432 
02433     <span class="comment">/*</span>
02434 <span class="comment">     * Kill the csr port so no hard errors are services after this point</span>
02435 <span class="comment">     */</span>
02436     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02437         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a>);
02438         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02439     }
02440 
02441     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a108">gspwndCursor</a>);
02442 
02443     <span class="comment">/*</span>
02444 <span class="comment">     * set this to NULL</span>
02445 <span class="comment">     */</span>
02446     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02447 
02448     <a class="code" href="../../d4/d1/userk_8h.html#a779">TRACE_RIT</a>((<span class="stringliteral">"TERMINATING !!!\n"</span>));
02449 
02450 <span class="preprocessor">#if DBG</span>
02451 <span class="preprocessor"></span>    {
02452         <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a110">gppiList</a>;
02453 
02454         KdPrint((<span class="stringliteral">"Processes still running:\n"</span>));
02455         KdPrint((<span class="stringliteral">"-------------------------\n"</span>));
02456 
02457         <span class="keywordflow">while</span> (ppi) {
02458 
02459             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
02460 
02461             KdPrint((<span class="stringliteral">"ppi '%s' 0x%x threads: %d\n"</span>,
02462                      ppi-&gt;Process-&gt;ImageFileName,
02463                      ppi,
02464                      ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o9">cThreads</a>));
02465 
02466             KdPrint((<span class="stringliteral">"\tGUI threads\n"</span>));
02467 
02468             pti = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>;
02469 
02470             <span class="keywordflow">while</span> (pti) {
02471                 KdPrint((<span class="stringliteral">"\t%#p\n"</span>, pti));
02472                 pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>;
02473             }
02474 
02475             ppi = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o8">ppiNextRunning</a>;
02476         }
02477         KdPrint((<span class="stringliteral">"-------------------------\n"</span>));
02478     }
02479 <span class="preprocessor">#endif // DBG</span>
02480 <span class="preprocessor"></span>
02481     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02482 
02483     swprintf(<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Sessions\\%ld\\BaseNamedObjects\\EventRitExited"</span>,
02484              <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>);
02485 
02486     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ustrName, <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>);
02487 
02488     InitializeObjectAttributes(&amp;obja,
02489                                &amp;ustrName,
02490                                OBJ_CASE_INSENSITIVE | OBJ_OPENIF,
02491                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02492                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02493 
02494     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(&amp;hevtRitExited,
02495                            EVENT_ALL_ACCESS,
02496                            &amp;obja,
02497                            SynchronizationEvent,
02498                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02499 
02500     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02501 
02502     ZwSetEvent(hevtRitExited, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02503 
02504     ZwClose(hevtRitExited);
02505     <span class="comment">/*</span>
02506 <span class="comment">     * Clear TIF_PALETTEAWARE or else we will AV in xxxDestroyThreadInfo</span>
02507 <span class="comment">     * MCostea #412136</span>
02508 <span class="comment">     */</span>
02509     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a805">TIF_PALETTEAWARE</a>;
02510 
02511     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a765">HH_RITGONE</a>);
02512 
02513     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02514 }
02515 
02516 
02517 <span class="comment">/***************************************************************************\</span>
02518 <span class="comment">* RemoteSyncToggleKeys (RIT)</span>
02519 <span class="comment">*</span>
02520 <span class="comment">* This function is called whenever a remote client needs to synchronize the</span>
02521 <span class="comment">* current toggle key state of the server.  If the keys are out of sync, it</span>
02522 <span class="comment">* injects the correct toggle key sequences.</span>
02523 <span class="comment">*</span>
02524 <span class="comment">* History:</span>
02525 <span class="comment">* 11-12-98 JParsons     Created.</span>
02526 <span class="comment">\***************************************************************************/</span>
<a name="l02527"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a56">02527</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d8/ntinput_8c.html#a56">RemoteSyncToggleKeys</a>(ULONG toggleKeys)
02528 {
02529     KE ke;
02530 
02531     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02532     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> = toggleKeys | KEYBOARD_LED_INJECTED;
02533 
02534     <span class="comment">// Key injection only works if there is a ready application queue.</span>
02535     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02536 
02537         <span class="keywordflow">if</span> (((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> &amp; KEYBOARD_CAPS_LOCK_ON) &amp;&amp;
02538              !<a class="code" href="../../d4/d1/userk_8h.html#a582">TestRawKeyToggle</a>(VK_CAPITAL)) ||
02539              (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> &amp; KEYBOARD_CAPS_LOCK_ON) &amp;&amp;
02540               <a class="code" href="../../d4/d1/userk_8h.html#a582">TestRawKeyToggle</a>(VK_CAPITAL))) {
02541 
02542             ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(0x3a);
02543             ke.usFlaggedVk = VK_CAPITAL;
02544             <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02545 
02546             ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(0xba);
02547             ke.usFlaggedVk = VK_CAPITAL | KBDBREAK;
02548             <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02549         }
02550 
02551         <span class="keywordflow">if</span> (((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> &amp; KEYBOARD_NUM_LOCK_ON) &amp;&amp;
02552              !<a class="code" href="../../d4/d1/userk_8h.html#a582">TestRawKeyToggle</a>(VK_NUMLOCK)) ||
02553              (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> &amp; KEYBOARD_NUM_LOCK_ON) &amp;&amp;
02554               <a class="code" href="../../d4/d1/userk_8h.html#a582">TestRawKeyToggle</a>(VK_NUMLOCK))) {
02555 
02556             ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(0x45);
02557             ke.usFlaggedVk = VK_NUMLOCK;
02558             <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02559 
02560             ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(0xc5);
02561             ke.usFlaggedVk = VK_NUMLOCK | KBDBREAK;
02562             <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02563         }
02564 
02565         <span class="keywordflow">if</span> (((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> &amp; KEYBOARD_SCROLL_LOCK_ON) &amp;&amp;
02566              !<a class="code" href="../../d4/d1/userk_8h.html#a582">TestRawKeyToggle</a>(VK_SCROLL)) ||
02567              (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> &amp; KEYBOARD_SCROLL_LOCK_ON) &amp;&amp;
02568                 <a class="code" href="../../d4/d1/userk_8h.html#a582">TestRawKeyToggle</a>(VK_SCROLL))) {
02569 
02570             ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(0x46);
02571             ke.usFlaggedVk = VK_SCROLL;
02572             <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02573 
02574             ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(0xc6);
02575             ke.usFlaggedVk = VK_SCROLL | KBDBREAK;
02576             <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02577         }
02578 
02579         <span class="keywordflow">if</span> (JAPANESE_KBD_LAYOUT(<a class="code" href="../../d6/d8/ntinput_8c.html#a43">GetActiveHKL</a>())) {
02580             <span class="keywordflow">if</span> (((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> &amp; KEYBOARD_KANA_LOCK_ON) &amp;&amp;
02581                  !<a class="code" href="../../d4/d1/userk_8h.html#a582">TestRawKeyToggle</a>(VK_KANA)) ||
02582                  (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> &amp; KEYBOARD_KANA_LOCK_ON) &amp;&amp;
02583                     <a class="code" href="../../d4/d1/userk_8h.html#a582">TestRawKeyToggle</a>(VK_KANA))) {
02584 
02585                 ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(0x70);
02586                 ke.usFlaggedVk = VK_KANA;
02587                 <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02588 
02589                 ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(0xf0);
02590                 ke.usFlaggedVk = VK_KANA | KBDBREAK;
02591                 <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02592             }
02593         }
02594 
02595         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> = 0;
02596     }
02597 }
02598 
02599 
02600 <span class="comment">/***************************************************************************\</span>
02601 <span class="comment">* ProcessKeyboardInput (RIT)</span>
02602 <span class="comment">*</span>
02603 <span class="comment">* This function is called whenever a keyboard input is ready to be consumed.</span>
02604 <span class="comment">* It calls xxxProcessKeyEvent() for every input event, and once all the events</span>
02605 <span class="comment">* have been consumed, calls StartDeviceRead() to request more keyboard events.</span>
02606 <span class="comment">*</span>
02607 <span class="comment">* Return value: "OK to continue walking gpDeviceInfoList"</span>
02608 <span class="comment">* TRUE  - processed input without leaving gpresDeviceInfoList critical section</span>
02609 <span class="comment">* FALSE - had to leave the gpresDeviceInfoList critical section</span>
02610 <span class="comment">*</span>
02611 <span class="comment">* History:</span>
02612 <span class="comment">* 11-26-90 DavidPe      Created.</span>
02613 <span class="comment">\***************************************************************************/</span>
02614 
<a name="l02615"></a><a class="code" href="../../d4/d1/userk_8h.html#a990">02615</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a990">ProcessKeyboardInput</a>(<a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo)
02616 {
02617     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Vk;
02618     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bPrefix;
02619     KE ke;
02620     PKEYBOARD_INPUT_DATA pkei;
02621     PKEYBOARD_INPUT_DATA pkeiStart, pkeiEnd;
02622 
02623     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02624     UserAssert(pDeviceInfo-&gt;type == <a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>);
02625 
02626     pkeiStart = pDeviceInfo-&gt;<a class="code" href="../../d5/d3/structtagDEVICEINFO.html#o2">keyboard</a>.<a class="code" href="../../d3/d9/structtagKEYBOARD__DEVICE__INFO.html#o1">Data</a>;
02627     pkeiEnd   = (PKEYBOARD_INPUT_DATA)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pkeiStart + pDeviceInfo-&gt;iosb.Information);
02628     <span class="keywordflow">for</span> (pkei = pkeiStart; pkei &lt; pkeiEnd; pkei++) {
02629 
02630         <span class="comment">/*</span>
02631 <span class="comment">         * Remote terminal server clients occationally need to be able to set</span>
02632 <span class="comment">         * the server's toggle key state to match the client.  All other</span>
02633 <span class="comment">         * standard keyboard inputs are processed below since this is the most</span>
02634 <span class="comment">         * frequent code path.</span>
02635 <span class="comment">         */</span>
02636         <span class="keywordflow">if</span> (!(pkei-&gt;Flags &amp; KEY_TERMSRV_SET_LED)) {
02637 
02638             <span class="comment">// Process any deferred remote key sync requests</span>
02639             <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a> &amp; KEYBOARD_LED_INJECTED))
02640                 <span class="keywordflow">goto</span> ProcessKeys;
02641             <span class="keywordflow">else</span>
02642                 <a class="code" href="../../d6/d8/ntinput_8c.html#a56">RemoteSyncToggleKeys</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a342">gSetLedReceived</a>);
02643 
02644 ProcessKeys:
02645             <span class="keywordflow">if</span> (pkei-&gt;Flags &amp; KEY_E0) {
02646                 bPrefix = 0xE0;
02647             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pkei-&gt;Flags &amp; KEY_E1) {
02648                 bPrefix = 0xE1;
02649             } <span class="keywordflow">else</span> {
02650                 bPrefix = 0;
02651             }
02652 
02653             <span class="keywordflow">if</span> (pkei-&gt;MakeCode == 0xFF) {
02654                 <span class="comment">/*</span>
02655 <span class="comment">                 * Kbd overrun (kbd hardware and/or keyboard driver) : Beep!</span>
02656 <span class="comment">                 * (some DELL keyboards send 0xFF if keys are hit hard enough,</span>
02657 <span class="comment">                 * presumably due to keybounce)</span>
02658 <span class="comment">                 */</span>
02659                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02660                 <a class="code" href="../../d4/d1/userk_8h.html#a1295">UserBeep</a>(440, 125);
02661                 <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02662                 <span class="keywordflow">continue</span>;
02663             }
02664 
02665             ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(pkei-&gt;MakeCode &amp; 0x7F);
02666             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a171">gpScancodeMap</a>) {
02667                 <a class="code" href="../../d6/d8/ntinput_8c.html#a37">MapScancode</a>(&amp;ke.bScanCode, &amp;bPrefix);
02668             }
02669 
02670             Vk = <a class="code" href="../../d3/d1/xlate_8c.html#a3">VKFromVSC</a>(&amp;ke, bPrefix, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a224">gafRawKeyState</a>);
02671 
02672             <span class="keywordflow">if</span> (Vk == 0) {
02673                 <span class="keywordflow">continue</span>;
02674             }
02675 
02676             <span class="keywordflow">if</span> (pkei-&gt;Flags &amp; KEY_BREAK) {
02677                 ke.usFlaggedVk |= KBDBREAK;
02678             }
02679 
02680 
02681             <span class="comment">/*</span>
02682 <span class="comment">             * We don't know if the client system or the host should get the</span>
02683 <span class="comment">             * windows key, so the choice is to not support it on the host.</span>
02684 <span class="comment">             * (The windows key is a local key.)</span>
02685 <span class="comment">             *</span>
02686 <span class="comment">             * The other practical problem is that the local shell intercepts</span>
02687 <span class="comment">             * the "break" of the windows key and switches to the start menu.</span>
02688 <span class="comment">             * The client never sees the "break" so the host thinks the</span>
02689 <span class="comment">             * windows key is always depressed.</span>
02690 <span class="comment">             *</span>
02691 <span class="comment">             * Newer clients may indicate they support the windows key.</span>
02692 <span class="comment">             * If the client has indicated this through the gfEnableWindowsKey,</span>
02693 <span class="comment">             * then we allow it to be processed here on the host.</span>
02694 <span class="comment">             */</span>
02695             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
02696                 <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> CheckVk = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)ke.usFlaggedVk;
02697 
02698                 <span class="keywordflow">if</span> (CheckVk == VK_LWIN || CheckVk == VK_RWIN)
02699                    <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a344">gfEnableWindowsKey</a> )
02700                     <span class="keywordflow">continue</span>;
02701             }
02702 
02703             <span class="comment">//</span>
02704             <span class="comment">// Keep track of real modifier key state.  Conveniently, the values for</span>
02705             <span class="comment">// VK_LSHIFT, VK_RSHIFT, VK_LCONTROL, VK_RCONTROL, VK_LMENU and</span>
02706             <span class="comment">// VK_RMENU are contiguous.  We'll construct a bit field to keep track</span>
02707             <span class="comment">// of the current modifier key state.  If a bit is set, the corresponding</span>
02708             <span class="comment">// modifier key is down.  The bit field has the following format:</span>
02709             <span class="comment">//</span>
02710             <span class="comment">//     +---------------------------------------------------+</span>
02711             <span class="comment">//     | Right | Left  |  Right  |  Left   | Right | Left  |</span>
02712             <span class="comment">//     |  Alt  |  Alt  | Control | Control | Shift | Shift |</span>
02713             <span class="comment">//     +---------------------------------------------------+</span>
02714             <span class="comment">//         5       4        3         2        1       0     Bit</span>
02715             <span class="comment">//</span>
02716             <span class="comment">// Add bit 7 -- VK_RWIN</span>
02717             <span class="comment">//     bit 6 -- VK_LWIN</span>
02718 
02719             <span class="keywordflow">switch</span> (Vk) {
02720             <span class="keywordflow">case</span> VK_LSHIFT:
02721             <span class="keywordflow">case</span> VK_RSHIFT:
02722             <span class="keywordflow">case</span> VK_LCONTROL:
02723             <span class="keywordflow">case</span> VK_RCONTROL:
02724             <span class="keywordflow">case</span> VK_LMENU:
02725             <span class="keywordflow">case</span> VK_RMENU:
02726                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a> = 1 &lt;&lt; (Vk &amp; 0xf);
02727                 <span class="keywordflow">break</span>;
02728             <span class="keywordflow">case</span> VK_LWIN:
02729                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a> = 0x40;
02730                 <span class="keywordflow">break</span>;
02731             <span class="keywordflow">case</span> VK_RWIN:
02732                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a> = 0x80;
02733                 <span class="keywordflow">break</span>;
02734             <span class="keywordflow">default</span>:
02735                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a> = 0;
02736             }
02737             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>) {
02738                 <span class="comment">/*</span>
02739 <span class="comment">                 * If this is a break of a modifier key then clear the bit value.</span>
02740 <span class="comment">                 * Otherwise, set it.</span>
02741 <span class="comment">                 */</span>
02742                 <span class="keywordflow">if</span> (pkei-&gt;Flags &amp; KEY_BREAK) {
02743                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a> &amp;= ~<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>;
02744                 } <span class="keywordflow">else</span> {
02745                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a> |= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>;
02746                 }
02747             }
02748 
02749             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a629">ACCF_ACCESSENABLED</a>)) {
02750                 <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, (ULONG_PTR)pkei-&gt;ExtraInformation, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02751             } <span class="keywordflow">else</span> {
02752                 <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a52">gtmridAccessTimeOut</a> != 0) &amp;&amp; <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(AccessTimeOut, ATF_TIMEOUTON)) {
02753                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a52">gtmridAccessTimeOut</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
02754                                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02755                                                      <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a52">gtmridAccessTimeOut</a>,
02756                                                      (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a>.iTimeOutMSec,
02757                                                      <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a41">xxxAccessTimeOutTimer</a>,
02758                                                      TMRF_RIT | TMRF_ONESHOT
02759                                                      );
02760                 }
02761                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a48">AccessProceduresStream</a>(&amp;ke, pkei-&gt;ExtraInformation, 0)) {
02762                     <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, (ULONG_PTR)pkei-&gt;ExtraInformation, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02763                 }
02764             }
02765         }
02766 
02767         <span class="comment">// Special toggle key synchronization for Terminal Server</span>
02768         <span class="keywordflow">else</span> {
02769             <a class="code" href="../../d6/d8/ntinput_8c.html#a56">RemoteSyncToggleKeys</a>(pkei-&gt;ExtraInformation);
02770         }
02771     }
02772 
02773     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02774 }
02775 
02776 
02777 <span class="comment">/***************************************************************************\</span>
02778 <span class="comment">* xxxProcessKeyEvent (RIT)</span>
02779 <span class="comment">*</span>
02780 <span class="comment">* This function is called to process an individual keystroke (up or down).</span>
02781 <span class="comment">* It performs some OEM, language and layout specific processing which</span>
02782 <span class="comment">* discards or modifies the keystroke or introduces additional keystrokes.</span>
02783 <span class="comment">* The RawKeyState is updated here, also termination of screen saver and video</span>
02784 <span class="comment">* power down is initiated here.</span>
02785 <span class="comment">* xxxKeyEvent() is called for each resulting keystroke.</span>
02786 <span class="comment">*</span>
02787 <span class="comment">* History:</span>
02788 <span class="comment">* 11-26-90 DavidPe      Created.</span>
02789 <span class="comment">\***************************************************************************/</span>
02790 
<a name="l02791"></a><a class="code" href="../../d4/d1/userk_8h.html#a1026">02791</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(
02792     PKE pke,
02793     ULONG_PTR ExtraInformation,
02794     BOOL bInjected)
02795 {
02796     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Vk;
02797 
02798     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02799 
02800     Vk = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)pke-&gt;usFlaggedVk;
02801 
02802     <span class="comment">/*</span>
02803 <span class="comment">     * KOREAN:</span>
02804 <span class="comment">     * Check this is Korean keyboard layout, or not..</span>
02805 <span class="comment">     *</span>
02806 <span class="comment">     * NOTE:</span>
02807 <span class="comment">     *  It would be better check this by "keyboard hardware" or</span>
02808 <span class="comment">     * "keyboard layout" ???</span>
02809 <span class="comment">     *</span>
02810 <span class="comment">     * 1. Check by hardware :</span>
02811 <span class="comment">     *</span>
02812 <span class="comment">     *   if (KOREAN_KEYBOARD(gKeyboardInfo.KeyboardIdentifier)) {</span>
02813 <span class="comment">     *</span>
02814 <span class="comment">     * 2. Check by layout :</span>
02815 <span class="comment">     *</span>
02816 <span class="comment">     *   if (KOREAN_KBD_LAYOUT(_GetKeyboardLayout(0L))) {</span>
02817 <span class="comment">     */</span>
02818     <span class="keywordflow">if</span> (KOREAN_KBD_LAYOUT(<a class="code" href="../../d6/d8/ntinput_8c.html#a43">GetActiveHKL</a>())) {
02819         <span class="keywordflow">if</span> ((pke-&gt;usFlaggedVk &amp; KBDBREAK) &amp;&amp;
02820             !(pke-&gt;usFlaggedVk &amp; KBDUNICODE) &amp;&amp;
02821             (pke-&gt;bScanCode == 0xF1 || pke-&gt;bScanCode == 0xF2) &amp;&amp;
02822             !<a class="code" href="../../d4/d1/userk_8h.html#a579">TestRawKeyDown</a>(Vk)) {
02823             <span class="comment">/*</span>
02824 <span class="comment">             * This is actually a keydown with a scancode of 0xF1 or 0xF2 from a</span>
02825 <span class="comment">             * Korean keyboard. Korean IMEs and apps want a WM_KEYDOWN with a</span>
02826 <span class="comment">             * scancode of 0xF1 or 0xF2. They don't mind not getting the WM_KEYUP.</span>
02827 <span class="comment">             * Don't update physical keystate to allow a real 0x71/0x72 keydown.</span>
02828 <span class="comment">             */</span>
02829             pke-&gt;usFlaggedVk &amp;= ~KBDBREAK;
02830         } <span class="keywordflow">else</span> {
02831             <a class="code" href="../../d6/d8/ntinput_8c.html#a53">UpdateRawKeyState</a>(Vk, pke-&gt;usFlaggedVk &amp; KBDBREAK);
02832         }
02833     } <span class="keywordflow">else</span> {
02834         <a class="code" href="../../d6/d8/ntinput_8c.html#a53">UpdateRawKeyState</a>(Vk, pke-&gt;usFlaggedVk &amp; KBDBREAK);
02835     }
02836 
02837     <span class="comment">/*</span>
02838 <span class="comment">     * Convert Left/Right Ctrl/Shift/Alt key to "unhanded" key.</span>
02839 <span class="comment">     * ie: if VK_LCONTROL or VK_RCONTROL, convert to VK_CONTROL etc.</span>
02840 <span class="comment">     */</span>
02841     <span class="keywordflow">if</span> ((Vk &gt;= VK_LSHIFT) &amp;&amp; (Vk &lt;= VK_RMENU)) {
02842         Vk = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((Vk - VK_LSHIFT) / 2 + VK_SHIFT);
02843         <a class="code" href="../../d6/d8/ntinput_8c.html#a53">UpdateRawKeyState</a>(Vk, pke-&gt;usFlaggedVk &amp; KBDBREAK);
02844     }
02845 
02846     <span class="comment">/*</span>
02847 <span class="comment">     * Setup to shutdown screen saver and exit video power down mode.</span>
02848 <span class="comment">     */</span>
02849     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a380">LINP_POWERTIMEOUTS</a>) {
02850         <span class="comment">/*</span>
02851 <span class="comment">         * Call video driver here to exit power down mode.</span>
02852 <span class="comment">         */</span>
02853         KdPrint((<span class="stringliteral">"Exit video power down mode\n"</span>));
02854         DrvSetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD0);
02855     }
02856     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; ~<a class="code" href="../../d4/d1/userk_8h.html#a381">LINP_INPUTTIMEOUTS</a>) | <a class="code" href="../../d4/d1/userk_8h.html#a376">LINP_KEYBOARD</a>;
02857     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o0">timeLastInputMessage</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwLastRITEventTickCount = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
02858     <span class="keywordflow">if</span> (!bInjected || (pke-&gt;dwTime == 0)) {
02859         pke-&gt;dwTime = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o0">timeLastInputMessage</a>;
02860     }
02861 
02862     <span class="comment">/*</span>
02863 <span class="comment">     * Now call all the OEM- and Locale- specific KEProcs.</span>
02864 <span class="comment">     * If KEProcs return FALSE, the keystroke has been discarded, in</span>
02865 <span class="comment">     * which case don't pass the key event on to xxxKeyEvent().</span>
02866 <span class="comment">     */</span>
02867     <span class="keywordflow">if</span> (pke-&gt;usFlaggedVk &amp; KBDUNICODE) {
02868         <a class="code" href="../../d4/d1/userk_8h.html#a1039">xxxKeyEvent</a>(pke-&gt;usFlaggedVk, pke-&gt;wchInjected,
02869                     pke-&gt;dwTime, ExtraInformation, bInjected);
02870     } <span class="keywordflow">else</span> {
02871         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/xlate_8c.html#a8">KEOEMProcs</a>(pke) &amp;&amp; <a class="code" href="../../d3/d1/xlate_8c.html#a9">xxxKELocaleProcs</a>(pke) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1038">xxxKENLSProcs</a>(pke,ExtraInformation)) {
02872             <a class="code" href="../../d4/d1/userk_8h.html#a1039">xxxKeyEvent</a>(pke-&gt;usFlaggedVk, pke-&gt;bScanCode,
02873                         pke-&gt;dwTime, ExtraInformation, bInjected);
02874         }
02875     }
02876 }
02877 
02878 <span class="comment">/***************************************************************************\</span>
02879 <span class="comment">* DoMouseAccel (RIT)</span>
02880 <span class="comment">*</span>
02881 <span class="comment">* History:</span>
02882 <span class="comment">* 11-29-90 DavidPe      Created.</span>
02883 <span class="comment">\***************************************************************************/</span>
02884 <span class="preprocessor">#ifdef LOCK_MOUSE_CODE</span>
02885 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MOUSE, DoMouseAccel)</span>
02886 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02887 <span class="preprocessor"></span>
<a name="l02888"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a31">02888</a> LONG <a class="code" href="../../d6/d8/ntinput_8c.html#a31">DoMouseAccel</a>(
02889     LONG Delta)
02890 {
02891     LONG newDelta = Delta;
02892 
02893     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(Delta) &gt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a121">gMouseThresh1</a>) {
02894         newDelta *= 2;
02895 
02896         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(Delta) &gt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a122">gMouseThresh2</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a120">gMouseSpeed</a> == 2)) {
02897             newDelta *= 2;
02898         }
02899     }
02900 
02901     <span class="keywordflow">return</span> newDelta;
02902 }
02903 
02904 
02905 <span class="comment">/***************************************************************************\</span>
02906 <span class="comment">* PwndForegroundCapture</span>
02907 <span class="comment">*</span>
02908 <span class="comment">* History:</span>
02909 <span class="comment">* 10-23-91 DavidPe      Created.</span>
02910 <span class="comment">\***************************************************************************/</span>
02911 
<a name="l02912"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a59">02912</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a59">PwndForegroundCapture</a>(VOID)
02913 {
02914     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02915         <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>;
02916     }
02917 
02918     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02919 }
02920 
02921 
02922 <span class="comment">/***************************************************************************\</span>
02923 <span class="comment">* SetKeyboardRate</span>
02924 <span class="comment">*</span>
02925 <span class="comment">* This function calls the keyboard driver to set a new keyboard repeat</span>
02926 <span class="comment">* rate and delay.  It limits the values to the min and max given by</span>
02927 <span class="comment">* the driver so it won't return an error when we call it.</span>
02928 <span class="comment">*</span>
02929 <span class="comment">* History:</span>
02930 <span class="comment">* 11-29-90 DavidPe      Created.</span>
02931 <span class="comment">\***************************************************************************/</span>
<a name="l02932"></a><a class="code" href="../../d4/d1/userk_8h.html#a1176">02932</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1176">SetKeyboardRate</a>(
02933     UINT                nKeySpeedAndDelay
02934     )
02935 {
02936     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> nKeyDelay;
02937     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> nKeySpeed;
02938 
02939     nKeyDelay = (nKeySpeedAndDelay &amp; <a class="code" href="../../d4/d1/userk_8h.html#a473">KDELAY_MASK</a>) &gt;&gt; <a class="code" href="../../d4/d1/userk_8h.html#a474">KDELAY_SHIFT</a>;
02940 
02941     nKeySpeed = <a class="code" href="../../d4/d1/userk_8h.html#a472">KSPEED_MASK</a> &amp; nKeySpeedAndDelay;
02942 
02943     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a218">gktp</a>.Rate = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)( ( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyRepeatMaximum.Rate -
02944                    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyRepeatMinimum.Rate
02945                  ) * nKeySpeed / <a class="code" href="../../d4/d1/userk_8h.html#a472">KSPEED_MASK</a>
02946                ) +
02947                <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyRepeatMinimum.Rate;
02948 
02949     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a218">gktp</a>.Delay = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)( ( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyRepeatMaximum.Delay -
02950                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyRepeatMinimum.Delay
02951                   ) * nKeyDelay / (<a class="code" href="../../d4/d1/userk_8h.html#a473">KDELAY_MASK</a> &gt;&gt; <a class="code" href="../../d4/d1/userk_8h.html#a474">KDELAY_SHIFT</a>)
02952                 ) +
02953                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyRepeatMinimum.Delay;
02954 
02955     <span class="comment">/*</span>
02956 <span class="comment">     * Hand off the IOCTL to the RIT, since only the system process can</span>
02957 <span class="comment">     * access keyboard handles</span>
02958 <span class="comment">     */</span>
02959     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a226">gdwUpdateKeyboard</a> |= <a class="code" href="../../d6/d8/ntinput_8c.html#a0">UPDATE_KBD_TYPEMATIC</a>;
02960 }
02961 
02962 
02963 <span class="comment">/***************************************************************************\</span>
02964 <span class="comment">* UpdateKeyLights</span>
02965 <span class="comment">*</span>
02966 <span class="comment">* This function calls the keyboard driver to set the keylights into the</span>
02967 <span class="comment">* current state specified by the async keystate table.</span>
02968 <span class="comment">*</span>
02969 <span class="comment">* bInjected: (explanation from John Parsons via email)</span>
02970 <span class="comment">* Set this TRUE if you do something on the server to asynchronously change the</span>
02971 <span class="comment">* indicators behind the TS client's back, to get this reflected back to the</span>
02972 <span class="comment">* client.  Examples are toggling num lock or caps lock programatically, or our</span>
02973 <span class="comment">* favorite example is the automatic spelling correction on Word: if you type</span>
02974 <span class="comment">* "tHE mouse went up the clock", Word will fix it by automagically pressing</span>
02975 <span class="comment">* CAPS LOCK, then retyping the T  -- if the client is not informed, the keys</span>
02976 <span class="comment">* get out of sync.</span>
02977 <span class="comment">* Set this to FALSE for indicator changes initiated by the client (let's say by</span>
02978 <span class="comment">* pressing CAPS LOCK) in which case we don't loop back the indicator change</span>
02979 <span class="comment">* since the client has already changed state locally.</span>
02980 <span class="comment">*</span>
02981 <span class="comment">* History:</span>
02982 <span class="comment">* 11-29-90 DavidPe      Created.</span>
02983 <span class="comment">\***************************************************************************/</span>
02984 
<a name="l02985"></a><a class="code" href="../../d4/d1/userk_8h.html#a1180">02985</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1180">UpdateKeyLights</a>(BOOL bInjected)
02986 {
02987     <span class="comment">/*</span>
02988 <span class="comment">     * Looking at async keystate.  Must be in critical section.</span>
02989 <span class="comment">     */</span>
02990     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02991 
02992     <span class="comment">/*</span>
02993 <span class="comment">     * Based on the toggle bits in the async keystate table,</span>
02994 <span class="comment">     * set the key lights.</span>
02995 <span class="comment">     */</span>
02996     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>.LedFlags = 0;
02997     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(VK_CAPITAL)) {
02998         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>.LedFlags |= KEYBOARD_CAPS_LOCK_ON;
02999         <a class="code" href="../../d4/d1/userk_8h.html#a583">SetRawKeyToggle</a>(VK_CAPITAL);
03000     } <span class="keywordflow">else</span> {
03001         <a class="code" href="../../d4/d1/userk_8h.html#a584">ClearRawKeyToggle</a>(VK_CAPITAL);
03002     }
03003 
03004     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(VK_NUMLOCK)) {
03005         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>.LedFlags |= KEYBOARD_NUM_LOCK_ON;
03006         <a class="code" href="../../d4/d1/userk_8h.html#a583">SetRawKeyToggle</a>(VK_NUMLOCK);
03007     } <span class="keywordflow">else</span> {
03008         <a class="code" href="../../d4/d1/userk_8h.html#a584">ClearRawKeyToggle</a>(VK_NUMLOCK);
03009     }
03010 
03011     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(VK_SCROLL)) {
03012         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>.LedFlags |= KEYBOARD_SCROLL_LOCK_ON;
03013         <a class="code" href="../../d4/d1/userk_8h.html#a583">SetRawKeyToggle</a>(VK_SCROLL);
03014     } <span class="keywordflow">else</span> {
03015         <a class="code" href="../../d4/d1/userk_8h.html#a584">ClearRawKeyToggle</a>(VK_SCROLL);
03016     }
03017 
03018     <span class="comment">/*</span>
03019 <span class="comment">     * Only "Japanese keyboard hardware" has "KANA" LEDs, and switch to</span>
03020 <span class="comment">     * "KANA" state.</span>
03021 <span class="comment">     */</span>
03022     <span class="keywordflow">if</span> (JAPANESE_KEYBOARD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyboardIdentifier)) {
03023         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(VK_KANA)) {
03024             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>.LedFlags |= KEYBOARD_KANA_LOCK_ON;
03025             <a class="code" href="../../d4/d1/userk_8h.html#a583">SetRawKeyToggle</a>(VK_KANA);
03026         } <span class="keywordflow">else</span> {
03027             <a class="code" href="../../d4/d1/userk_8h.html#a584">ClearRawKeyToggle</a>(VK_KANA);
03028         }
03029     }
03030 
03031     <span class="comment">/*</span>
03032 <span class="comment">     * On terminal server, we need to tell the WD about application injected</span>
03033 <span class="comment">     * toggle keys so it can update the client accordingly.</span>
03034 <span class="comment">     */</span>
03035     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
03036         <span class="keywordflow">if</span> (bInjected)
03037             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>.LedFlags |= KEYBOARD_LED_INJECTED;
03038         <span class="keywordflow">else</span>
03039             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>.LedFlags &amp;= ~KEYBOARD_LED_INJECTED;
03040     }
03041 
03042 
03043     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) {
03044         <span class="comment">/*</span>
03045 <span class="comment">         * Hand off the IOCTL to the RIT, since only the system process can</span>
03046 <span class="comment">         * access the keyboard handles.  Happens when applying user's profile.</span>
03047 <span class="comment">         * IanJa: Should we check PpiCurrent() == gptiRit-&gt;ppi instead?</span>
03048 <span class="comment">         */</span>
03049         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a226">gdwUpdateKeyboard</a> |= <a class="code" href="../../d6/d8/ntinput_8c.html#a1">UPDATE_KBD_LEDS</a>;
03050     } <span class="keywordflow">else</span> {
03051         <span class="comment">/*</span>
03052 <span class="comment">         * Do it immediately (avoids a small delay between keydown and LED</span>
03053 <span class="comment">         * on when typing)</span>
03054 <span class="comment">         */</span>
03055         <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo;
03056 
03057         <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
03058         <span class="keywordflow">for</span> (pDeviceInfo = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>; pDeviceInfo; pDeviceInfo = pDeviceInfo-&gt;pNext) {
03059             <span class="keywordflow">if</span> ((pDeviceInfo-&gt;type == <a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>) &amp;&amp; (pDeviceInfo-&gt;handle)) {
03060                 ZwDeviceIoControlFile(pDeviceInfo-&gt;handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03061                         &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a220">giosbKbdControl</a>, IOCTL_KEYBOARD_SET_INDICATORS,
03062                         (PVOID)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
03063             }
03064         }
03065         <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
03066     }
03067 }
03068 
03069 
<a name="l03070"></a><a class="code" href="../../d4/d1/userk_8h.html#a1716">03070</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1716">_GetKeyboardType</a>(<span class="keywordtype">int</span> nTypeFlag)
03071 {
03072 
03073     <span class="keywordflow">switch</span> (nTypeFlag) {
03074     <span class="keywordflow">case</span> 0:
03075         <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyboardIdentifier.Type;
03076 
03077     <span class="keywordflow">case</span> 1:
03078     <span class="comment">// FE_SB</span>
03079     {
03080         <span class="keywordtype">int</span> OEMId = 0;
03081         <span class="comment">//</span>
03082         <span class="comment">// If this keyboard layout is compatible with 101 or 106</span>
03083         <span class="comment">// Japanese keyboard, we just return 101 or 106's keyboard</span>
03084         <span class="comment">// id, not this keyboard's one to let application handle</span>
03085         <span class="comment">// this keyboard as 101 or 106 Japanese keyboard.</span>
03086         <span class="comment">//</span>
03087         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03088             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a>-&gt;LayoutInformation &amp; NLSKBD_INFO_EMURATE_101_KEYBOARD) {
03089                 <span class="keywordflow">return</span> (MICROSOFT_KBD_101_TYPE);
03090             }
03091             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a>-&gt;LayoutInformation &amp; NLSKBD_INFO_EMURATE_106_KEYBOARD) {
03092                 <span class="keywordflow">return</span> (MICROSOFT_KBD_106_TYPE);
03093             }
03094         }
03095 
03096         <span class="comment">//</span>
03097         <span class="comment">// PSS ID Number: Q130054</span>
03098         <span class="comment">// Article last modified on 05-16-1995</span>
03099         <span class="comment">//</span>
03100         <span class="comment">// 3.10 1.20 | 3.50 1.20</span>
03101         <span class="comment">// WINDOWS   | WINDOWS NT</span>
03102         <span class="comment">//</span>
03103         <span class="comment">// ---------------------------------------------------------------------</span>
03104         <span class="comment">// The information in this article applies to:</span>
03105         <span class="comment">// - Microsoft Windows Software Development Kit (SDK) for Windows</span>
03106         <span class="comment">//   version 3.1</span>
03107         <span class="comment">// - Microsoft Win32 Software Development Kit (SDK) version 3.5</span>
03108         <span class="comment">// - Microsoft Win32s version 1.2</span>
03109         <span class="comment">// ---------------------------------------------------------------------</span>
03110         <span class="comment">// SUMMARY</span>
03111         <span class="comment">// =======</span>
03112         <span class="comment">// Because of the variety of computer manufacturers (NEC, Fujitsu, IBMJ, and</span>
03113         <span class="comment">// so on) in Japan, sometimes Windows-based applications need to know which</span>
03114         <span class="comment">// OEM (original equipment manufacturer) manufactured the computer that is</span>
03115         <span class="comment">// running the application. This article explains how.</span>
03116         <span class="comment">//</span>
03117         <span class="comment">// MORE INFORMATION</span>
03118         <span class="comment">// ================</span>
03119         <span class="comment">// There is no documented way to detect the manufacturer of the computer that</span>
03120         <span class="comment">// is currently running an application. However, a Windows-based application</span>
03121         <span class="comment">// can detect the type of OEM Windows by using the return value of the</span>
03122         <span class="comment">// GetKeyboardType() function.</span>
03123         <span class="comment">//</span>
03124         <span class="comment">// If an application uses the GetKeyboardType API, it can get OEM ID by</span>
03125         <span class="comment">// specifying "1" (keyboard subtype) as argument of the function. Each OEM ID</span>
03126         <span class="comment">// is listed here:</span>
03127         <span class="comment">//</span>
03128         <span class="comment">// OEM Windows       OEM ID</span>
03129         <span class="comment">// ------------------------------</span>
03130         <span class="comment">// Microsoft         00H (DOS/V)</span>
03131         <span class="comment">// all AX            01H</span>
03132         <span class="comment">// EPSON             04H</span>
03133         <span class="comment">// Fujitsu           05H</span>
03134         <span class="comment">// IBMJ              07H</span>
03135         <span class="comment">// Matsushita        0AH</span>
03136         <span class="comment">// NEC               0DH</span>
03137         <span class="comment">// Toshiba           12H</span>
03138         <span class="comment">//</span>
03139         <span class="comment">// Application programs can use these OEM IDs to distinguish the type of OEM</span>
03140         <span class="comment">// Windows. Note, however, that this method is not documented, so Microsoft</span>
03141         <span class="comment">// may not support it in the future version of Windows.</span>
03142         <span class="comment">//</span>
03143         <span class="comment">// As a rule, application developers should write hardware-independent code,</span>
03144         <span class="comment">// especially when making Windows-based applications. If they need to make a</span>
03145         <span class="comment">// hardware-dependent application, they must prepare the separated program</span>
03146         <span class="comment">// file for each different hardware architecture.</span>
03147         <span class="comment">//</span>
03148         <span class="comment">// Additional reference words: 3.10 1.20 3.50 1.20 kbinf</span>
03149         <span class="comment">// KBCategory: kbhw</span>
03150         <span class="comment">// KBSubcategory: wintldev</span>
03151         <span class="comment">// =============================================================================</span>
03152         <span class="comment">// Copyright Microsoft Corporation 1995.</span>
03153 
03154         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03155             <span class="comment">//</span>
03156             <span class="comment">// Get OEM (Windows) ID.</span>
03157             <span class="comment">//</span>
03158             OEMId = ((<span class="keywordtype">int</span>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a>-&gt;OEMIdentifier) &lt;&lt; 8;
03159         }
03160         <span class="comment">//</span>
03161         <span class="comment">// The format of KeyboardIdentifier.Subtype :</span>
03162         <span class="comment">//</span>
03163         <span class="comment">// 0 - 3 bits = keyboard subtype</span>
03164         <span class="comment">// 4 - 7 bits = kernel mode kerboard driver provider id.</span>
03165         <span class="comment">//</span>
03166         <span class="comment">// Kernel mode keyboard dirver provier | ID</span>
03167         <span class="comment">// ------------------------------------+-----</span>
03168         <span class="comment">// Microsoft                           | 00H</span>
03169         <span class="comment">// all AX                              | 01H</span>
03170         <span class="comment">// Toshiba                             | 02H</span>
03171         <span class="comment">// EPSON                               | 04H</span>
03172         <span class="comment">// Fujitsu                             | 05H</span>
03173         <span class="comment">// IBMJ                                | 07H</span>
03174         <span class="comment">// Matsushita                          | 0AH</span>
03175         <span class="comment">// NEC                                 | 0DH</span>
03176         <span class="comment">//</span>
03177 
03178         <span class="comment">//</span>
03179         <span class="comment">// And here is the format of return value.</span>
03180         <span class="comment">//</span>
03181         <span class="comment">// 0  -  7 bits = Keyboard Subtype.</span>
03182         <span class="comment">// 8  - 15 bits = OEM (Windows) Id.</span>
03183         <span class="comment">// 16 - 31 bits = not used.</span>
03184         <span class="comment">//</span>
03185         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(OEMId | (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyboardIdentifier.Subtype &amp; 0x0F));
03186     }
03187 
03188     <span class="keywordflow">case</span> 2:
03189         <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.NumberOfFunctionKeys;
03190     }
03191     <span class="keywordflow">return</span> 0;
03192 }
03193 
03194 <span class="comment">/**************************************************************************\</span>
03195 <span class="comment">* xxxMouseEventDirect</span>
03196 <span class="comment">*</span>
03197 <span class="comment">* Mouse event inserts a mouse event into the input stream.</span>
03198 <span class="comment">*</span>
03199 <span class="comment">* The parameters are the same as the fields of the MOUSEINPUT structure</span>
03200 <span class="comment">* used in SendInput.</span>
03201 <span class="comment">*</span>
03202 <span class="comment">*    dx           Delta x</span>
03203 <span class="comment">*    dy           Delta y</span>
03204 <span class="comment">*    mouseData    Mouse wheel movement or xbuttons</span>
03205 <span class="comment">*    dwMEFlags    Mouse event flags</span>
03206 <span class="comment">*    dwExtraInfo  Extra info from driver.</span>
03207 <span class="comment">*</span>
03208 <span class="comment">* History:</span>
03209 <span class="comment">* 07-23-92 Mikehar      Created.</span>
03210 <span class="comment">* 01-08-93 JonPa        Made it work with new mouse drivers</span>
03211 <span class="comment">\**************************************************************************/</span>
03212 
<a name="l03213"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a63">03213</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a63">xxxMouseEventDirect</a>(
03214    DWORD dx,
03215    DWORD dy,
03216    DWORD mouseData,
03217    DWORD dwMEFlags,
03218    DWORD dwTime,
03219    ULONG_PTR dwExtraInfo)
03220 {
03221     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwDriverMouseFlags;
03222     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwDriverMouseData;
03223 
03224     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
03225     <span class="keywordflow">if</span> (dwTime == 0) {
03226         dwTime = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
03227     }
03228 
03229     <span class="comment">/*</span>
03230 <span class="comment">     * The calling thread must be on the active desktop</span>
03231 <span class="comment">     * and have journal playback access to that desktop.</span>
03232 <span class="comment">     */</span>
03233     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
03234         UserAssert(!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>));
03235         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1270">CheckGrantedAccess</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a>, DESKTOP_JOURNALPLAYBACK)) {
03236            RIPMSG0(RIP_ERROR, <span class="stringliteral">"mouse_event(): No DESKTOP_JOURNALPLAYBACK access to input desktop."</span> );
03237            <span class="keywordflow">return</span>;
03238         }
03239     } <span class="keywordflow">else</span> {
03240         <span class="comment">/*</span>
03241 <span class="comment">         * 3/22/95 BradG - Only allow below HACK for pre 4.0 applications</span>
03242 <span class="comment">         */</span>
03243         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a> &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
03244             RIPMSG0(RIP_VERBOSE,<span class="stringliteral">"mouse_event(): Calls not forwarded for 4.0 or greater apps."</span>);
03245             <span class="keywordflow">return</span>;
03246         } <span class="keywordflow">else</span> {
03247             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAccessToDesktop;
03248 
03249             <span class="comment">/*</span>
03250 <span class="comment">             * 3/22/95 BradG - Bug #9314: Screensavers are not deactivated by mouse_event()</span>
03251 <span class="comment">             *    The main problem is the check above, since screensavers run on their own</span>
03252 <span class="comment">             *    desktop.  This causes the above check to fail because the process using</span>
03253 <span class="comment">             *    mouse_event() is running on another desktop.  The solution is to determine</span>
03254 <span class="comment">             *    if we have access to the input desktop by calling xxxOpenDesktop for the</span>
03255 <span class="comment">             *    current input desktop, grpdeskRitInput, with a request for DESKTOP_JOURNALPLAYBACK</span>
03256 <span class="comment">             *    access.  If this succeeds, we can allow this mouse_event() request to pass</span>
03257 <span class="comment">             *    through, otherwise return.</span>
03258 <span class="comment">             */</span>
03259             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03260 
03261             UserAssert(!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>));
03262             fAccessToDesktop = <a class="code" href="../../d4/d1/userk_8h.html#a1271">AccessCheckObject</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>,
03263                     DESKTOP_READOBJECTS | DESKTOP_WRITEOBJECTS | DESKTOP_JOURNALPLAYBACK,
03264                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03265                     &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a305">DesktopMapping</a>);
03266             <span class="keywordflow">if</span> (!fAccessToDesktop) {
03267                 RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"mouse_event(): Call NOT forwarded to input desktop"</span> );
03268                 <span class="keywordflow">return</span>;
03269             }
03270 
03271             <span class="comment">/*</span>
03272 <span class="comment">             * We do have access to the desktop, so</span>
03273 <span class="comment">             * let this mouse_event() call go through.</span>
03274 <span class="comment">             */</span>
03275             RIPMSG0( RIP_VERBOSE, <span class="stringliteral">"mouse_event(): Call forwarded to input desktop"</span> );
03276         }
03277     }
03278 
03279     <span class="comment">/*</span>
03280 <span class="comment">     * This process is providing input so it gets the right to</span>
03281 <span class="comment">     *  call SetForegroundWindow</span>
03282 <span class="comment">     */</span>
03283     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a80">gppiInputProvider</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
03284 
03285     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
03286 
03287     <span class="comment">/*</span>
03288 <span class="comment">     * Process coordinates first.  This is especially useful for absolute</span>
03289 <span class="comment">     * pointing devices like touch-screens and tablets.</span>
03290 <span class="comment">     */</span>
03291     <span class="keywordflow">if</span> (dwMEFlags &amp; MOUSEEVENTF_MOVE) {
03292         <a class="code" href="../../d4/d1/userk_8h.html#a1028">xxxMoveEvent</a>(dx, dy, dwMEFlags, dwExtraInfo, dwTime, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03293     }
03294 
03295     <span class="comment">/*</span>
03296 <span class="comment">     * The following code assumes that MOUSEEVENTF_MOVE == 1,</span>
03297 <span class="comment">     * that MOUSEEVENTF_ABSOLUTE &gt; all button flags, and that the</span>
03298 <span class="comment">     * mouse_event button flags are defined in the same order as the</span>
03299 <span class="comment">     * MOUSE_INPUT_DATA button bits.</span>
03300 <span class="comment">     */</span>
03301 <span class="preprocessor">#if MOUSEEVENTF_MOVE != 1</span>
03302 <span class="preprocessor"></span><span class="preprocessor">#   error("MOUSEEVENTF_MOVE != 1")</span>
03303 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03304 <span class="preprocessor"></span><span class="preprocessor">#if MOUSEEVENTF_LEFTDOWN != MOUSE_LEFT_BUTTON_DOWN * 2</span>
03305 <span class="preprocessor"></span><span class="preprocessor">#   error("MOUSEEVENTF_LEFTDOWN != MOUSE_LEFT_BUTTON_DOWN * 2")</span>
03306 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03307 <span class="preprocessor"></span><span class="preprocessor">#if MOUSEEVENTF_LEFTUP != MOUSE_LEFT_BUTTON_UP * 2</span>
03308 <span class="preprocessor"></span><span class="preprocessor">#   error("MOUSEEVENTF_LEFTUP != MOUSE_LEFT_BUTTON_UP * 2")</span>
03309 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03310 <span class="preprocessor"></span><span class="preprocessor">#if MOUSEEVENTF_RIGHTDOWN != MOUSE_RIGHT_BUTTON_DOWN * 2</span>
03311 <span class="preprocessor"></span><span class="preprocessor">#   error("MOUSEEVENTF_RIGHTDOWN != MOUSE_RIGHT_BUTTON_DOWN * 2")</span>
03312 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03313 <span class="preprocessor"></span><span class="preprocessor">#if MOUSEEVENTF_RIGHTUP != MOUSE_RIGHT_BUTTON_UP * 2</span>
03314 <span class="preprocessor"></span><span class="preprocessor">#   error("MOUSEEVENTF_RIGHTUP != MOUSE_RIGHT_BUTTON_UP * 2")</span>
03315 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03316 <span class="preprocessor"></span><span class="preprocessor">#if MOUSEEVENTF_MIDDLEDOWN != MOUSE_MIDDLE_BUTTON_DOWN * 2</span>
03317 <span class="preprocessor"></span><span class="preprocessor">#   error("MOUSEEVENTF_MIDDLEDOWN != MOUSE_MIDDLE_BUTTON_DOWN * 2")</span>
03318 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03319 <span class="preprocessor"></span><span class="preprocessor">#if MOUSEEVENTF_MIDDLEUP != MOUSE_MIDDLE_BUTTON_UP * 2</span>
03320 <span class="preprocessor"></span><span class="preprocessor">#   error("MOUSEEVENTF_MIDDLEUP != MOUSE_MIDDLE_BUTTON_UP * 2")</span>
03321 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03322 <span class="preprocessor"></span><span class="preprocessor">#if MOUSEEVENTF_WHEEL != MOUSE_WHEEL * 2</span>
03323 <span class="preprocessor"></span><span class="preprocessor">#   error("MOUSEEVENTF_WHEEL != MOUSE_WHEEL * 2")</span>
03324 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03325 <span class="preprocessor"></span>
03326     <span class="comment">/* set legal values */</span>
03327     dwDriverMouseFlags = dwMEFlags &amp; MOUSEEVENTF_BUTTONMASK;
03328 
03329     <span class="comment">/* remove MOUSEEVENTF_XDOWN/UP because we are going to add</span>
03330 <span class="comment">       MOUSEEVENTF_DRIVER_X1/2DOWN/UP later */</span>
03331     dwDriverMouseFlags &amp;= ~(MOUSEEVENTF_XDOWN | MOUSEEVENTF_XUP);
03332 
03333     dwDriverMouseData = 0;
03334 
03335     <span class="comment">/*</span>
03336 <span class="comment">     * Handle mouse wheel and xbutton inputs.</span>
03337 <span class="comment">     *</span>
03338 <span class="comment">     * Note that MOUSEEVENTF_XDOWN/UP and MOUSEEVENTF_MOUSEWHEEL cannot both</span>
03339 <span class="comment">     * be specified since they share the mouseData field</span>
03340 <span class="comment">     */</span>
03341     <span class="keywordflow">if</span> (    ((dwMEFlags &amp; (MOUSEEVENTF_XDOWN | MOUSEEVENTF_WHEEL)) == (MOUSEEVENTF_XDOWN | MOUSEEVENTF_WHEEL)) ||
03342             ((dwMEFlags &amp; (MOUSEEVENTF_XUP   | MOUSEEVENTF_WHEEL)) == (MOUSEEVENTF_XUP | MOUSEEVENTF_WHEEL))) {
03343 
03344         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Can't specify both MOUSEEVENTF_XDOWN/UP and MOUSEEVENTF_WHEEL in call to SendInput, dwFlags=0x%.8X"</span>, dwMEFlags);
03345         dwDriverMouseFlags &amp;= ~(MOUSEEVENTF_XDOWN | MOUSEEVENTF_XUP | MOUSEEVENTF_WHEEL);
03346     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwMEFlags &amp; MOUSEEVENTF_WHEEL) {
03347         <span class="comment">/*</span>
03348 <span class="comment">         * Force the value to a short. We cannot fail if it is out of range</span>
03349 <span class="comment">         * because we accepted a 32 bit value in NT 4.</span>
03350 <span class="comment">         */</span>
03351         dwDriverMouseData = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(SHRT_MIN, (LONG)mouseData), SHRT_MAX);
03352     } <span class="keywordflow">else</span> {
03353         <span class="comment">/* don't process xbuttons if mousedata has invalid buttons */</span>
03354         <span class="keywordflow">if</span> (~XBUTTON_MASK &amp; mouseData) {
03355             RIPMSG1(RIP_WARNING, <span class="stringliteral">"Invalid xbutton specified in SendInput, mouseData=0x%.8X"</span>, mouseData);
03356         } <span class="keywordflow">else</span> {
03357             <span class="keywordflow">if</span> (dwMEFlags &amp; MOUSEEVENTF_XDOWN) {
03358                 <span class="keywordflow">if</span> (mouseData &amp; XBUTTON1) {
03359                     dwDriverMouseFlags |= MOUSEEVENTF_DRIVER_X1DOWN;
03360                 }
03361                 <span class="keywordflow">if</span> (mouseData &amp; XBUTTON2) {
03362                     dwDriverMouseFlags |= MOUSEEVENTF_DRIVER_X2DOWN;
03363                 }
03364             }
03365             <span class="keywordflow">if</span> (dwMEFlags &amp; MOUSEEVENTF_XUP) {
03366                 <span class="keywordflow">if</span> (mouseData &amp; XBUTTON1) {
03367                     dwDriverMouseFlags |= MOUSEEVENTF_DRIVER_X1UP;
03368                 }
03369                 <span class="keywordflow">if</span> (mouseData &amp; XBUTTON2) {
03370                     dwDriverMouseFlags |= MOUSEEVENTF_DRIVER_X2UP;
03371                 }
03372             }
03373         }
03374     }
03375 
03376     <span class="comment">/* Convert the MOUSEEVENTF_ flags to MOUSE_BUTTON flags sent by the driver */</span>
03377     dwDriverMouseFlags &gt;&gt;= 1;
03378 
03379     <a class="code" href="../../d4/d1/userk_8h.html#a1033">QueueMouseEvent</a>(
03380             (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) dwDriverMouseFlags,
03381             (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) dwDriverMouseData,
03382             dwExtraInfo,
03383             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>,
03384             dwTime,
03385             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03386             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03387             );
03388 
03389     <a class="code" href="../../d6/d8/ntinput_8c.html#a29">ProcessQueuedMouseEvents</a>();
03390 
03391     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
03392 }
03393 
03394 <span class="comment">/**************************************************************************\</span>
03395 <span class="comment">* xxxInternalKeyEventDirect</span>
03396 <span class="comment">*</span>
03397 <span class="comment">* key event inserts a key event into the input stream.</span>
03398 <span class="comment">*</span>
03399 <span class="comment">* History:</span>
03400 <span class="comment">* 07-23-92 Mikehar      Created.</span>
03401 <span class="comment">\**************************************************************************/</span>
03402 
<a name="l03403"></a><a class="code" href="../../d4/d1/userk_8h.html#a1022">03403</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1022">xxxInternalKeyEventDirect</a>(
03404    BYTE  bVk,
03405    WORD  wScan,
03406    DWORD dwFlags,
03407    DWORD dwTime,
03408    ULONG_PTR dwExtraInfo)
03409 {
03410     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
03411     KE KeyEvent;
03412 
03413     <span class="comment">/*</span>
03414 <span class="comment">     * The calling thread must be on the active desktop</span>
03415 <span class="comment">     * and have journal playback access to that desktop.</span>
03416 <span class="comment">     */</span>
03417     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> ||
03418             !<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a>, DESKTOP_JOURNALPLAYBACK)) {
03419 
03420         RIPNTERR0(STATUS_ACCESS_DENIED, RIP_WARNING,
03421                   <span class="stringliteral">"Injecting key failed: Non active desktop or access denied"</span>);
03422 
03423         <span class="keywordflow">return</span>;
03424     }
03425     UserAssert(!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>));
03426 
03427     KeyEvent.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)wScan;
03428     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; KEYEVENTF_SCANCODE) {
03429         bVk = <a class="code" href="../../d3/d1/xlate_8c.html#a3">VKFromVSC</a>(&amp;KeyEvent,
03430                         (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; KEYEVENTF_EXTENDEDKEY ? 0xE0 : 0),
03431                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a224">gafRawKeyState</a>);
03432         KeyEvent.usFlaggedVk = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)bVk;
03433     } <span class="keywordflow">else</span> {
03434         KeyEvent.usFlaggedVk = bVk | KBDINJECTEDVK;
03435     }
03436 
03437     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; KEYEVENTF_KEYUP)
03438         KeyEvent.usFlaggedVk |= KBDBREAK;
03439 
03440     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; KEYEVENTF_UNICODE) {
03441         KeyEvent.usFlaggedVk |= KBDUNICODE;
03442         KeyEvent.wchInjected = wScan;
03443     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; KEYEVENTF_EXTENDEDKEY) {
03444         KeyEvent.usFlaggedVk |= KBDEXT;
03445     } <span class="keywordflow">else</span> {
03446         <span class="comment">// Is it from the numeric keypad?</span>
03447         <span class="keywordflow">if</span> (((bVk &gt;= VK_NUMPAD0) &amp;&amp; (bVk &lt;= VK_NUMPAD9)) || (bVk == VK_DECIMAL)) {
03448             KeyEvent.usFlaggedVk |= KBDNUMPAD;
03449         } <span class="keywordflow">else</span> {
03450             <span class="keywordtype">int</span> i;
03451             <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a74">ausNumPadCvt</a>[i] != 0; i++) {
03452                 <span class="keywordflow">if</span> (bVk == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a74">ausNumPadCvt</a>[i])) {
03453                     KeyEvent.usFlaggedVk |= KBDNUMPAD;
03454                     <span class="keywordflow">break</span>;
03455                 }
03456             }
03457         }
03458     }
03459 
03460     <span class="comment">/*</span>
03461 <span class="comment">     * This process is providing input so it gets the right to</span>
03462 <span class="comment">     *  call SetForegroundWindow</span>
03463 <span class="comment">     */</span>
03464     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a80">gppiInputProvider</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
03465 
03466     KeyEvent.dwTime = dwTime;
03467     <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;KeyEvent, dwExtraInfo, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03468 }
03469 
03470 
03471 <span class="comment">/*****************************************************************************\</span>
03472 <span class="comment">*</span>
03473 <span class="comment">*  _BlockInput()</span>
03474 <span class="comment">*</span>
03475 <span class="comment">*  This disables/enables input into USER via keyboard or mouse</span>
03476 <span class="comment">*  If input is enabled and the caller</span>
03477 <span class="comment">*  is disabling it, the caller gets the 'input cookie.'  This means two</span>
03478 <span class="comment">*  things:</span>
03479 <span class="comment">*      (a) Only the caller's thread can reenable input</span>
03480 <span class="comment">*      (b) Only the caller's thread can fake input messages by calling</span>
03481 <span class="comment">*          SendInput().</span>
03482 <span class="comment">*</span>
03483 <span class="comment">*  This guarantees a sequential uninterrupted input stream.</span>
03484 <span class="comment">*</span>
03485 <span class="comment">*  It can be used in conjunction with a journal playback hook however,</span>
03486 <span class="comment">*  since USER still does some processing in *_event functions before</span>
03487 <span class="comment">*  noticing a journal playback hook is around.</span>
03488 <span class="comment">*</span>
03489 <span class="comment">*  Note that the disabled state can be suspended, and will be, when the</span>
03490 <span class="comment">*  fault dialog comes up.  ForceInputState() will save away the enabled</span>
03491 <span class="comment">*  status, so input is cleared, then whack back the old stuff when done.</span>
03492 <span class="comment">*  We do the same thing for capture, modality, blah blah.  This makes sure</span>
03493 <span class="comment">*  that if somebody is hung, the end user can still type Ctrl+Alt+Del and</span>
03494 <span class="comment">*  interact with the dialog.</span>
03495 <span class="comment">*</span>
03496 <span class="comment">\*****************************************************************************/</span>
03497 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l03498"></a><a class="code" href="../../d4/d1/userk_8h.html#a1024">03498</a> <a class="code" href="../../d4/d1/userk_8h.html#a1024">_BlockInput</a>(BOOL fBlockIt)
03499 {
03500     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
03501 
03502     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
03503 
03504     <span class="comment">/*</span>
03505 <span class="comment">     * The calling thread must be on the active desktop and have journal</span>
03506 <span class="comment">     * playback access to that desktop if it wants to block input.</span>
03507 <span class="comment">     * (Unblocking is less restricted)</span>
03508 <span class="comment">     */</span>
03509     <span class="keywordflow">if</span> (fBlockIt &amp;&amp;
03510             (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> ||
03511             !<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a>, DESKTOP_JOURNALPLAYBACK))) {
03512 
03513         RIPNTERR0(STATUS_ACCESS_DENIED, RIP_WARNING,
03514                   <span class="stringliteral">"BlockInput failed: Non active desktop or access denied"</span>);
03515         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03516     }
03517     UserAssert(!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>));
03518 
03519     <span class="comment">/*</span>
03520 <span class="comment">     * If we are enabling input</span>
03521 <span class="comment">     *      * Is it disabled?  No, then fail the call</span>
03522 <span class="comment">     *      * Is it disabled but we aren't the dude in control?  Yes, then</span>
03523 <span class="comment">     *              fail the call.</span>
03524 <span class="comment">     * If we are disabling input</span>
03525 <span class="comment">     *      * Is it enabled?  No, then fail the call</span>
03526 <span class="comment">     *      * Set us up as the dude in control</span>
03527 <span class="comment">     */</span>
03528 
03529     <span class="keywordflow">if</span> (fBlockIt) {
03530         <span class="comment">/*</span>
03531 <span class="comment">         * Is input blocked right now?</span>
03532 <span class="comment">         */</span>
03533         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03534             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03535         }
03536 
03537         <span class="comment">/*</span>
03538 <span class="comment">         * Is this thread exiting?  If so, fail the call now.  User's</span>
03539 <span class="comment">         * cleanup code won't get a chance to whack this back if so.</span>
03540 <span class="comment">         */</span>
03541         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) {
03542             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03543         }
03544 
03545         <span class="comment">/*</span>
03546 <span class="comment">         * Set blocking on.</span>
03547 <span class="comment">         */</span>
03548         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> = ptiCurrent;
03549     } <span class="keywordflow">else</span> {
03550         <span class="comment">/*</span>
03551 <span class="comment">         * Fail if input is not blocked, or blocked by another thread</span>
03552 <span class="comment">         */</span>
03553         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> != ptiCurrent) {
03554             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03555         }
03556 
03557         <span class="comment">/*</span>
03558 <span class="comment">         * This thread was blocking input, so now clear the block.</span>
03559 <span class="comment">         */</span>
03560         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03561     }
03562 
03563     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03564 }
03565 
03566 
03567 <span class="comment">/**************************************************************************\</span>
03568 <span class="comment">* xxxSendInput</span>
03569 <span class="comment">*</span>
03570 <span class="comment">* input injection</span>
03571 <span class="comment">*</span>
03572 <span class="comment">* History:</span>
03573 <span class="comment">* 11-01-96 CLupu      Created.</span>
03574 <span class="comment">\**************************************************************************/</span>
<a name="l03575"></a><a class="code" href="../../d4/d1/userk_8h.html#a1023">03575</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a1023">xxxSendInput</a>(
03576    UINT    nInputs,
03577    LPINPUT pInputs)
03578 {
03579     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    nEv;
03580     LPINPUT pEvent;
03581     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwExpWinVer = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;dwExpWinVer;
03582 
03583     <span class="keywordflow">for</span> (nEv = 0, pEvent = pInputs; nEv &lt; nInputs; nEv++) {
03584 
03585         <span class="keywordflow">switch</span> (pEvent-&gt;type) {
03586         <span class="keywordflow">case</span> INPUT_MOUSE:
03587             <a class="code" href="../../d6/d8/ntinput_8c.html#a63">xxxMouseEventDirect</a>(
03588                         pEvent-&gt;mi.dx,
03589                         pEvent-&gt;mi.dy,
03590                         pEvent-&gt;mi.mouseData,
03591                         pEvent-&gt;mi.dwFlags,
03592                         pEvent-&gt;mi.time,
03593                         pEvent-&gt;mi.dwExtraInfo);
03594             <span class="keywordflow">break</span>;
03595 
03596         <span class="keywordflow">case</span> INPUT_KEYBOARD:
03597             <span class="keywordflow">if</span> ((pEvent-&gt;ki.dwFlags &amp; KEYEVENTF_UNICODE) &amp;&amp;
03598                     (pEvent-&gt;ki.wVk == 0) &amp;&amp;
03599                     ((pEvent-&gt;ki.dwFlags &amp; ~(KEYEVENTF_KEYUP | KEYEVENTF_UNICODE)) == 0)) {
03600                 <a class="code" href="../../d4/d1/userk_8h.html#a1022">xxxInternalKeyEventDirect</a>(
03601                         VK_PACKET,
03602                         pEvent-&gt;ki.wScan,   <span class="comment">// actually a Unicode character</span>
03603                         pEvent-&gt;ki.dwFlags,
03604                         pEvent-&gt;ki.time,
03605                         pEvent-&gt;ki.dwExtraInfo);
03606             } <span class="keywordflow">else</span> {
03607                 <a class="code" href="../../d4/d1/userk_8h.html#a1022">xxxInternalKeyEventDirect</a>(
03608                         <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(pEvent-&gt;ki.wVk),
03609                         <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(pEvent-&gt;ki.wScan),
03610                         pEvent-&gt;ki.dwFlags,
03611                         pEvent-&gt;ki.time,
03612                         pEvent-&gt;ki.dwExtraInfo);
03613             }
03614             <span class="keywordflow">break</span>;
03615 
03616         <span class="keywordflow">case</span> INPUT_HARDWARE:
03617             <span class="keywordflow">break</span>;
03618         }
03619 
03620         pEvent++;
03621     }
03622     <span class="keywordflow">return</span> nInputs;
03623 }
03624 
03625 <span class="comment">/**************************************************************************\</span>
03626 <span class="comment">* _SetConsoleReserveKeys</span>
03627 <span class="comment">*</span>
03628 <span class="comment">* Sets the reserved keys field in the console's pti.</span>
03629 <span class="comment">*</span>
03630 <span class="comment">* History:</span>
03631 <span class="comment">* 02-17-93 JimA         Created.</span>
03632 <span class="comment">\**************************************************************************/</span>
03633 
<a name="l03634"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a67">03634</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a67">_SetConsoleReserveKeys</a>(
03635     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
03636     DWORD fsReserveKeys)
03637 {
03638     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;fsReserveKeys = fsReserveKeys;
03639     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03640 }
03641 
03642 <span class="comment">/**************************************************************************\</span>
03643 <span class="comment">* _GetMouseMovePointsEx</span>
03644 <span class="comment">*</span>
03645 <span class="comment">* Gets the last nPoints mouse moves from the global buffer starting with</span>
03646 <span class="comment">* ppt. Returns -1 if it doesn't find it. It uses the timestamp if it was</span>
03647 <span class="comment">* provided to differentiate between mouse points with the same coordinates.</span>
03648 <span class="comment">*</span>
03649 <span class="comment">* History:</span>
03650 <span class="comment">* 03-17-97 CLupu        Created.</span>
03651 <span class="comment">\**************************************************************************/</span>
<a name="l03652"></a><a class="code" href="../../d4/d1/userk_8h.html#a1025">03652</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1025">_GetMouseMovePointsEx</a>(
03653     CONST MOUSEMOVEPOINT* ppt,
03654     MOUSEMOVEPOINT*       ccxpptBuf,
03655     UINT                  nPoints,
03656     DWORD                 resolution)
03657 {
03658     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  uInd, uStart, nPointsRetrieved, i;
03659     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03660     <span class="keywordtype">int</span>   x, y;
03661     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> resX, resY;
03662 
03663     uStart = <a class="code" href="../../d4/d1/userk_8h.html#a149">PREVPOINT</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a236">gptInd</a>);
03664 
03665     <span class="comment">/*</span>
03666 <span class="comment">     * Search the point in the global buffer and get the first occurance.</span>
03667 <span class="comment">     */</span>
03668     uInd = uStart;
03669 
03670     <span class="keywordflow">do</span> {
03671         <span class="comment">/*</span>
03672 <span class="comment">         * The resolutions can be zero only if the buffer is still not full</span>
03673 <span class="comment">         */</span>
03674         <span class="keywordflow">if</span> (HIWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].x) == 0 || HIWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].y) == 0) {
03675             <span class="keywordflow">break</span>;
03676         }
03677 
03678         resX = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)HIWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].x) + 1;
03679         resY = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)HIWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].y) + 1;
03680 
03681         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)resX != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXVIRTUALSCREEN)) {
03682             UserAssert(resX == 0x10000);
03683             x = (LOWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].x) * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXVIRTUALSCREEN)) / resX;
03684         } <span class="keywordflow">else</span> {
03685             x = LOWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].x);
03686         }
03687 
03688         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)resY != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYVIRTUALSCREEN)) {
03689             UserAssert(resY == 0x10000);
03690             y = (LOWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].y) * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYVIRTUALSCREEN)) / resY;
03691         } <span class="keywordflow">else</span> {
03692             y = LOWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].y);
03693         }
03694 
03695         <span class="keywordflow">if</span> (x == ppt-&gt;x &amp;&amp; y == ppt-&gt;y) {
03696 
03697             <span class="comment">/*</span>
03698 <span class="comment">             * If the timestamp was provided check to see if it's the right</span>
03699 <span class="comment">             * timestamp.</span>
03700 <span class="comment">             */</span>
03701             <span class="keywordflow">if</span> (ppt-&gt;time != 0 &amp;&amp; ppt-&gt;time != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].time) {
03702                 uInd = <a class="code" href="../../d4/d1/userk_8h.html#a149">PREVPOINT</a>(uInd);
03703                 RIPMSG4(RIP_VERBOSE,
03704                         <span class="stringliteral">"GetMouseMovePointsEx: Found point (%x, %y) but timestamp %x diff from %x"</span>,
03705                         x, y, ppt-&gt;time, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].time);
03706                 <span class="keywordflow">continue</span>;
03707             }
03708 
03709             bFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03710             <span class="keywordflow">break</span>;
03711         }
03712         uInd = <a class="code" href="../../d4/d1/userk_8h.html#a149">PREVPOINT</a>(uInd);
03713 
03714     } <span class="keywordflow">while</span> (uInd != uStart);
03715 
03716     <span class="comment">/*</span>
03717 <span class="comment">     * The point might not be in the buffer anymore.</span>
03718 <span class="comment">     */</span>
03719     <span class="keywordflow">if</span> (!bFound) {
03720         RIPERR2(ERROR_POINT_NOT_FOUND, RIP_VERBOSE,
03721                   <span class="stringliteral">"GetMouseMovePointsEx: point not found (%x, %y)"</span>, ppt-&gt;x, ppt-&gt;y);
03722         <span class="keywordflow">return</span> -1;
03723     }
03724 
03725     <span class="comment">/*</span>
03726 <span class="comment">     * See how many points we can retrieve.</span>
03727 <span class="comment">     */</span>
03728     nPointsRetrieved = (uInd &lt;= uStart ? uInd + <a class="code" href="../../d4/d1/userk_8h.html#a148">MAX_MOUSEPOINTS</a> - uStart : uInd - uStart);
03729 
03730     nPointsRetrieved = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(nPointsRetrieved, nPoints);
03731 
03732     <span class="comment">/*</span>
03733 <span class="comment">     * Copy the points to the app buffer</span>
03734 <span class="comment">     */</span>
03735     <span class="keywordflow">try</span> {
03736         <span class="keywordflow">for</span> (i = 0; i &lt; nPointsRetrieved; i++) {
03737 
03738             resX = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)HIWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].x) + 1;
03739             resY = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)HIWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].y) + 1;
03740 
03741             <span class="comment">/*</span>
03742 <span class="comment">             * If one of the resolution is 0 then we're done</span>
03743 <span class="comment">             */</span>
03744             <span class="keywordflow">if</span> (HIWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].x) == 0 || HIWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].y) == 0) {
03745                 <span class="keywordflow">break</span>;
03746             }
03747 
03748             <span class="comment">/*</span>
03749 <span class="comment">             * LOWORD(gaptMouse[uInd].x) contains the x point on the</span>
03750 <span class="comment">             * scale specified by HIWORD(gaptMouse[uInd].x)</span>
03751 <span class="comment">             */</span>
03752             <span class="keywordflow">if</span> (resolution == GMMP_USE_HIGH_RESOLUTION_POINTS) {
03753                 ccxpptBuf[i].x = ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)LOWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].x) * 0xFFFF) / (resX - 1);
03754 
03755                 ccxpptBuf[i].y = ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)LOWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].y) * 0xFFFF) / (resY - 1);
03756 
03757             } <span class="keywordflow">else</span> {
03758                 UserAssert(resolution == GMMP_USE_DISPLAY_POINTS);
03759 
03760                 ccxpptBuf[i].x = (LOWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].x) * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXVIRTUALSCREEN)) / resX;
03761 
03762                 ccxpptBuf[i].y = (LOWORD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].y) * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYVIRTUALSCREEN)) / resY;
03763             }
03764             ccxpptBuf[i].time = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].time;
03765             ccxpptBuf[i].dwExtraInfo = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a235">gaptMouse</a>[uInd].dwExtraInfo;
03766 
03767 
03768             uInd = <a class="code" href="../../d4/d1/userk_8h.html#a149">PREVPOINT</a>(uInd);
03769         }
03770     } except(W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
03771     }
03772     <span class="keywordflow">return</span> i;
03773 }
03774 
03775 
03776 <span class="comment">/**************************************************************************\</span>
03777 <span class="comment">* ProcessQueuedMouseEvents</span>
03778 <span class="comment">*</span>
03779 <span class="comment">* Process mouse events.</span>
03780 <span class="comment">*</span>
03781 <span class="comment">* History:</span>
03782 <span class="comment">* 11-01-96 CLupu        Created.</span>
03783 <span class="comment">\**************************************************************************/</span>
<a name="l03784"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a29">03784</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d8/ntinput_8c.html#a29">ProcessQueuedMouseEvents</a>(
03785     <span class="keywordtype">void</span>)
03786 {
03787     <a class="code" href="../../d5/d2/structtagMOUSEEVENT.html">MOUSEEVENT</a> MouseEvent;
03788     <span class="keyword">static</span> POINT ptCursorLast = {0,0};
03789 
03790     <span class="keywordflow">while</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1034">UnqueueMouseEvent</a>(&amp;MouseEvent)) {
03791 
03792         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
03793 
03794         <span class="comment">// Setup to shutdown screen saver and exit video power down mode.</span>
03795         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a380">LINP_POWERTIMEOUTS</a>) {
03796             <span class="comment">// Call video driver here to exit power down mode.</span>
03797             KdPrint((<span class="stringliteral">"Exit video power down mode\n"</span>));
03798             DrvSetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD0);
03799         }
03800         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp;= ~(<a class="code" href="../../d4/d1/userk_8h.html#a381">LINP_INPUTTIMEOUTS</a> | <a class="code" href="../../d4/d1/userk_8h.html#a376">LINP_KEYBOARD</a>);
03801         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o0">timeLastInputMessage</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwLastRITEventTickCount = MouseEvent.<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o4">time</a>;
03802         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;bLastRITWasKeyboard = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03803 
03804         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor = MouseEvent.<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o3">ptPointer</a>;
03805 
03806         <span class="keywordflow">if</span> ((ptCursorLast.x != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x) ||
03807             (ptCursorLast.y != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y)) {
03808 
03809             <span class="comment">/*</span>
03810 <span class="comment">             * This mouse move ExtraInfo is global (as ptCursor</span>
03811 <span class="comment">             * was) and is associated with the current ptCursor</span>
03812 <span class="comment">             * position. ExtraInfo is sent from the driver - pen</span>
03813 <span class="comment">             * win people use it.</span>
03814 <span class="comment">             */</span>
03815             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a76">gdwMouseMoveExtraInfo</a> = MouseEvent.<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o2">ExtraInfo</a>;
03816 
03817             ptCursorLast = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
03818 
03819             <span class="comment">/*</span>
03820 <span class="comment">             * Wake up someone. xxxSetFMouseMoved() clears</span>
03821 <span class="comment">             * dwMouseMoveExtraInfo, so we must then restore it.</span>
03822 <span class="comment">             */</span>
03823             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>();
03824 
03825             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a76">gdwMouseMoveExtraInfo</a> = MouseEvent.<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o2">ExtraInfo</a>;
03826         }
03827 
03828         <span class="keywordflow">if</span> (MouseEvent.<a class="code" href="../../d5/d2/structtagMOUSEEVENT.html#o0">ButtonFlags</a> != 0) {
03829             <a class="code" href="../../d6/d8/ntinput_8c.html#a47">xxxDoButtonEvent</a>(&amp;MouseEvent);
03830         }
03831 
03832         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
03833     }
03834 }
03835 
03836 <span class="comment">/***************************************************************************\</span>
03837 <span class="comment">* RawInputThread (RIT)</span>
03838 <span class="comment">*</span>
03839 <span class="comment">* This is the RIT.  It gets low-level/raw input from the device drivers</span>
03840 <span class="comment">* and posts messages the appropriate queue.  It gets the input via APC</span>
03841 <span class="comment">* calls requested by calling NtReadFile() for the keyboard and mouse</span>
03842 <span class="comment">* drivers.  Basically it makes the first calls to Start*Read() and then</span>
03843 <span class="comment">* sits in an NtWaitForSingleObject() loop which allows the APC calls to</span>
03844 <span class="comment">* occur.</span>
03845 <span class="comment">*</span>
03846 <span class="comment">* All functions called exclusively on the RIT will have (RIT) next to</span>
03847 <span class="comment">* the name in the header.</span>
03848 <span class="comment">*</span>
03849 <span class="comment">* History:</span>
03850 <span class="comment">* 10-18-90 DavidPe      Created.</span>
03851 <span class="comment">* 11-26-90 DavidPe      Rewrote to stop using POS layer.</span>
03852 <span class="comment">\***************************************************************************/</span>
03853 <span class="preprocessor">#if DBG</span>
03854 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> gBlockDelay = 0;
03855 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> gBlockSleep = 0;
03856 <span class="preprocessor">#endif</span>
03857 <span class="preprocessor"></span>
<a name="l03858"></a><a class="code" href="../../d6/d8/ntinput_8c.html#a69">03858</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d8/ntinput_8c.html#a69">RawInputThread</a>(
03859     PRIT_INIT pInitData)
03860 {
03861     KPRIORITY      Priority;
03862     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03863     UNICODE_STRING strRIT;
03864     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>        pEvent;
03865     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>           NumberOfHandles = <a class="code" href="../../d6/d8/ntinput_8c.html#a11">ID_NUMBER_NON_HYDRA_HANDLES</a>;
03866     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a>      pTerm;
03867     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>       pMonitorPrimary;
03868     HANDLE         hevtShutDown;
03869     <span class="keyword">static</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   nLastRetryReadInput = 0;
03870 
03871     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
03872         NumberOfHandles += 2;
03873     }
03874 
03875     pTerm = pInitData-&gt;<a class="code" href="../../d7/d4/struct__RIT__INIT.html#o0">pTerm</a>;
03876 
03877     <span class="comment">/*</span>
03878 <span class="comment">     * Initialize GDI accelerators.  Identify this thread as a server thread.</span>
03879 <span class="comment">     */</span>
03880     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a> = UserAllocPoolNonPaged(NumberOfHandles * <span class="keyword">sizeof</span>(PVOID), TAG_SYSTEM);
03881 
03882     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a5">gWaitBlockArray</a> = UserAllocPoolNonPaged(NumberOfHandles * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a>),
03883                                            TAG_SYSTEM);
03884 
03885     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a5">gWaitBlockArray</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03886         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RIT failed to allocate memory"</span>);
03887         <span class="keywordflow">goto</span> Exit;
03888     }
03889 
03890     <span class="comment">/*</span>
03891 <span class="comment">     * Set the priority of the RIT to 19.</span>
03892 <span class="comment">     */</span>
03893     Priority = LOW_REALTIME_PRIORITY + 3;
03894 
03895     ZwSetInformationThread(NtCurrentThread(),
03896                            ThreadPriority,
03897                            &amp;Priority,
03898                            <span class="keyword">sizeof</span>(KPRIORITY));
03899 
03900     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strRIT, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"WinSta0_RIT"</span>);
03901 
03902     <span class="comment">/*</span>
03903 <span class="comment">     * Create an event for signalling mouse/kbd attach/detach and device-change</span>
03904 <span class="comment">     * notifications such as QueryRemove, RemoveCancelled etc.</span>
03905 <span class="comment">     */</span>
03906     <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[<a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>].<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o12">pkeHidChange</a> =
03907             <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>[<a class="code" href="../../d6/d8/ntinput_8c.html#a10">ID_HIDCHANGE</a>] =
03908             <a class="code" href="../../d4/d1/userk_8h.html#a965">CreateKernelEvent</a>(SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03909     <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[<a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>].<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o12">pkeHidChange</a> =
03910             <a class="code" href="../../d4/d1/userk_8h.html#a965">CreateKernelEvent</a>(SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03911 
03912     <span class="comment">/*</span>
03913 <span class="comment">     * Create an event for desktop threads to pass mouse input to RIT</span>
03914 <span class="comment">     */</span>
03915     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>[<a class="code" href="../../d6/d8/ntinput_8c.html#a8">ID_MOUSE</a>] = <a class="code" href="../../d4/d1/userk_8h.html#a965">CreateKernelEvent</a>(SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03916     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a177">gpkeMouseData</a> = <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>[<a class="code" href="../../d6/d8/ntinput_8c.html#a8">ID_MOUSE</a>];
03917 
03918     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[<a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>].<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o12">pkeHidChange</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
03919             <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>[<a class="code" href="../../d6/d8/ntinput_8c.html#a10">ID_HIDCHANGE</a>] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
03920             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a177">gpkeMouseData</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03921         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RIT failed to create a required input event"</span>);
03922         <span class="keywordflow">goto</span> Exit;
03923     }
03924 
03925     <span class="comment">/*</span>
03926 <span class="comment">     * Initialize keyboard device driver.</span>
03927 <span class="comment">     */</span>
03928     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
03929     <a class="code" href="../../d4/d1/userk_8h.html#a1174">InitKeyboard</a>();
03930     <a class="code" href="../../d6/d8/ntinput_8c.html#a38">InitMice</a>();
03931     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
03932 
03933     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a964">InitSystemThread</a>(&amp;strRIT);
03934 
03935     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03936         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RIT failed InitSystemThread"</span>);
03937         <span class="keywordflow">goto</span> Exit;
03938     }
03939 
03940     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03941 
03942     <span class="comment">/*</span>
03943 <span class="comment">     * Allow the system to read the screen</span>
03944 <span class="comment">     */</span>
03945     ((PW32PROCESS)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>)-&gt;W32PF_Flags |= (W32PF_READSCREENACCESSGRANTED|W32PF_IOWINSTA);
03946 
03947     <span class="comment">/*</span>
03948 <span class="comment">     * Initialize the cursor clipping rectangle to the screen rectangle.</span>
03949 <span class="comment">     */</span>
03950     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03951     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>;
03952 
03953     <span class="comment">/*</span>
03954 <span class="comment">     * Initialize gpsi-&gt;ptCursor and gptCursorAsync</span>
03955 <span class="comment">     */</span>
03956     pMonitorPrimary = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
03957 
03958     UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03959 
03960     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x = pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right / 2;
03961     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y = pMonitorPrimary-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom / 2;
03962     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
03963 
03964     <span class="comment">/*</span>
03965 <span class="comment">     * The hung redraw list should already be set to NULL by the compiler,</span>
03966 <span class="comment">     * linker &amp; loader since it is an uninitialized global variable. Memory will</span>
03967 <span class="comment">     * be allocated the first time a pwnd is added to this list (hungapp.c)</span>
03968 <span class="comment">     */</span>
03969     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a182">gpvwplHungRedraw</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03970 
03971     <span class="comment">/*</span>
03972 <span class="comment">     * Initialize the pre-defined hotkeys</span>
03973 <span class="comment">     */</span>
03974     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
03975     <a class="code" href="../../d4/d1/userk_8h.html#a1660">_RegisterHotKey</a>(<a class="code" href="../../d4/d1/userk_8h.html#a449">PWND_INPUTOWNER</a>, <a class="code" href="../../d4/d1/userk_8h.html#a460">IDHOT_WINDOWS</a>, MOD_WIN, VK_NONE);
03976     <a class="code" href="../../d3/d2/hotkeys_8c.html#a0">SetDebugHotKeys</a>();
03977     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
03978 
03979     <span class="comment">/*</span>
03980 <span class="comment">     * Create a timer for timers.</span>
03981 <span class="comment">     */</span>
03982     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a> = UserAllocPoolNonPaged(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>),
03983                                         TAG_SYSTEM);
03984     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03985         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RIT failed to create gptmrMaster"</span>);
03986         <span class="keywordflow">goto</span> Exit;
03987     }
03988 
03989     <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a>);
03990     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>[<a class="code" href="../../d6/d8/ntinput_8c.html#a9">ID_TIMER</a>] = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a>;
03991 
03992     <span class="comment">/*</span>
03993 <span class="comment">     * Create an event for mouse device reads to signal the desktop thread to</span>
03994 <span class="comment">     * move the pointer and QueueMouseEvent().</span>
03995 <span class="comment">     * We should do this *before* we have any devices.</span>
03996 <span class="comment">     */</span>
03997     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03998 
03999     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
04000 
04001         OBJECT_ATTRIBUTES obja;
04002         UNICODE_STRING    ustrName;
04003         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>              fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04004         WCHAR             <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>[<a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a>];
04005 
04006         <span class="comment">/*</span>
04007 <span class="comment">         * Create and initialize a timer object</span>
04008 <span class="comment">         * and pass a pointer to this object via the display driver to the WD.</span>
04009 <span class="comment">         * The RIT will do a KeWaitForObject() on this timer object.</span>
04010 <span class="comment">         * When the WD calls KeSetTimer() it will NOT specify a DPC routine.</span>
04011 <span class="comment">         * When the timer goes off the RIT will get signaled and will make the</span>
04012 <span class="comment">         * appropriate call to the display driver to flush the frame buffer.</span>
04013 <span class="comment">         */</span>
04014         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a> = UserAllocPoolNonPaged(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/ke_8h.html#a96">KTIMER</a>), TAG_SYSTEM);
04015 
04016         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04017             RIPMSG0(RIP_WARNING, <span class="stringliteral">"RIT failed to create gptmrWD"</span>);
04018             <span class="keywordflow">goto</span> Exit;
04019         }
04020 
04021         <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a>, SynchronizationTimer);
04022         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>[<a class="code" href="../../d6/d8/ntinput_8c.html#a13">ID_WDTIMER</a>] = <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a>;
04023 
04024         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ustrName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04025 
04026         <span class="comment">/*</span>
04027 <span class="comment">         * Pass a pointer to the timer to the WD via the display driver</span>
04028 <span class="comment">         */</span>
04029         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04030         fSuccess &amp;= !!HDXDrvEscape(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>,
04031                                    ESC_SET_WD_TIMEROBJ,
04032                                    (PVOID)<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a>,
04033                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a>));
04034 
04035         fSuccess &amp;= !!<a class="code" href="../../d4/d1/userk_8h.html#a1173">CreateDeviceInfo</a>(<a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>, &amp;ustrName, 0);
04036         fSuccess &amp;= !!<a class="code" href="../../d4/d1/userk_8h.html#a1173">CreateDeviceInfo</a>(<a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>, &amp;ustrName, 0);
04037 
04038         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04039 
04040         <span class="keywordflow">if</span> (!fSuccess) {
04041             RIPMSG0(RIP_WARNING,
04042                     <span class="stringliteral">"RIT failed HDXDrvEscape or the creation of input devices"</span>);
04043             <span class="keywordflow">goto</span> Exit;
04044         }
04045 
04046         <span class="comment">/*</span>
04047 <span class="comment">         * Create the shutdown event. This event will be signaled</span>
04048 <span class="comment">         * from W32WinStationTerminate.</span>
04049 <span class="comment">         * This is a named event opend by CSR to signal that win32k should</span>
04050 <span class="comment">         * go away. It's used in ntuser\server\api.c</span>
04051 <span class="comment">         */</span>
04052         swprintf(<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Sessions\\%ld\\BaseNamedObjects\\EventShutDownCSRSS"</span>,
04053                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>);
04054         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ustrName, <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>);
04055 
04056         InitializeObjectAttributes(&amp;obja,
04057                                    &amp;ustrName,
04058                                    OBJ_CASE_INSENSITIVE,
04059                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04060                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04061 
04062         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(&amp;hevtShutDown,
04063                                EVENT_ALL_ACCESS,
04064                                &amp;obja,
04065                                SynchronizationEvent,
04066                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04067 
04068         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04069             RIPMSG0(RIP_WARNING, <span class="stringliteral">"RIT failed to create EventShutDownCSRSS"</span>);
04070             <span class="keywordflow">goto</span> Exit;
04071         }
04072 
04073         <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hevtShutDown,
04074                                   EVENT_ALL_ACCESS,
04075                                   *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
04076                                   <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04077                                   &amp;<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>[<a class="code" href="../../d6/d8/ntinput_8c.html#a12">ID_SHUTDOWN</a>],
04078                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04079     } <span class="keywordflow">else</span> {
04080         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04081 
04082         <span class="comment">/*</span>
04083 <span class="comment">         * Register for Plug and Play devices.</span>
04084 <span class="comment">         * If any PnP devices are already attached, these will be opened and</span>
04085 <span class="comment">         * we will start reading them at this time.</span>
04086 <span class="comment">         */</span>
04087         <a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a20">xxxRegisterForDeviceClassNotifications</a>();
04088 
04089         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04090     }
04091 
04092     <span class="comment">/*</span>
04093 <span class="comment">     * Get the rit-thread.</span>
04094 <span class="comment">     */</span>
04095     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a> = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
04096 
04097     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a766">HH_RITCREATED</a>);
04098 
04099     <span class="comment">/*</span>
04100 <span class="comment">     * Don't allow this thread to get involved with journal synchronization.</span>
04101 <span class="comment">     */</span>
04102     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a802">TIF_DONTJOURNALATTACH</a>;
04103 
04104     <span class="comment">/*</span>
04105 <span class="comment">     * Also wait on our input event so the cool switch window can</span>
04106 <span class="comment">     * receive messages.</span>
04107 <span class="comment">     */</span>
04108     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>[<a class="code" href="../../d6/d8/ntinput_8c.html#a7">ID_INPUT</a>] = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>;
04109 
04110     <span class="comment">/*</span>
04111 <span class="comment">     * Signal that the rit has been initialized</span>
04112 <span class="comment">     */</span>
04113     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pInitData-&gt;<a class="code" href="../../d7/d4/struct__RIT__INIT.html#o1">pRitReadyEvent</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04114 
04115     <span class="comment">/*</span>
04116 <span class="comment">     * Since this is a SYSTEM-THREAD, we should set the pwinsta</span>
04117 <span class="comment">     * pointer in the SystemInfoThread to assure that if any</span>
04118 <span class="comment">     * paints occur from the input-thread, we can process them</span>
04119 <span class="comment">     * in DoPaint().</span>
04120 <span class="comment">     *</span>
04121 <span class="comment">     * Set the winsta after the first desktop is created.</span>
04122 <span class="comment">     */</span>
04123     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o23">pwinsta</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04124 
04125     pEvent = pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>;
04126 
04127     <span class="comment">/*</span>
04128 <span class="comment">     * Wait until the first desktop is created.</span>
04129 <span class="comment">     */</span>
04130     <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>(pEvent,
04131                                EVENT_ALL_ACCESS,
04132                                *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
04133                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
04134 
04135     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent, <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04136     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
04137 
04138     <span class="comment">/*</span>
04139 <span class="comment">     * Switch to the first desktop if no switch has been</span>
04140 <span class="comment">     * performed.</span>
04141 <span class="comment">     */</span>
04142     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04143 
04144     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04145         UserVerify(<a class="code" href="../../d4/d1/userk_8h.html#a1798">xxxSwitchDesktop</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o23">pwinsta</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o23">pwinsta</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
04146     }
04147 
04148     <span class="comment">/*</span>
04149 <span class="comment">     * Create a timer for hung app detection/redrawing.</span>
04150 <span class="comment">     */</span>
04151     <a class="code" href="../../d4/d1/userk_8h.html#a1480">StartTimers</a>();
04152 
04153     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04154 
04155     <span class="comment">/*</span>
04156 <span class="comment">     * Go into a wait loop so we can process input events and APCs as</span>
04157 <span class="comment">     * they occur.</span>
04158 <span class="comment">     */</span>
04159     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04160 
04161         <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
04162 
04163         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(NumberOfHandles,
04164                                           <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>,
04165                                           WaitAny,
04166                                           <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
04167                                           <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04168                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04169                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04170                                           <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a5">gWaitBlockArray</a>);
04171 
04172         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04173 
04174         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a226">gdwUpdateKeyboard</a> != 0) {
04175             <span class="comment">/*</span>
04176 <span class="comment">             * Here's our opportunity to process pending IOCTLs for the kbds:</span>
04177 <span class="comment">             * These are asynchronous IOCTLS, so be sure any buffers passed</span>
04178 <span class="comment">             * in to ZwDeviceIoControlFile are not in the stack!</span>
04179 <span class="comment">             * Using gdwUpdateKeyboard to tell the RIT to issue these IOCTLS</span>
04180 <span class="comment">             * renders the action asynchronous (delayed until next apObjects</span>
04181 <span class="comment">             * event), but the IOCTL was asynch anyway</span>
04182 <span class="comment">             */</span>
04183             <a class="code" href="../../d5/d3/structtagDEVICEINFO.html">PDEVICEINFO</a> pDeviceInfo;
04184             <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
04185             <span class="keywordflow">for</span> (pDeviceInfo = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>; pDeviceInfo; pDeviceInfo = pDeviceInfo-&gt;pNext) {
04186                 <span class="keywordflow">if</span> ((pDeviceInfo-&gt;type == <a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>) &amp;&amp; (pDeviceInfo-&gt;handle)) {
04187                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a226">gdwUpdateKeyboard</a> &amp; <a class="code" href="../../d6/d8/ntinput_8c.html#a0">UPDATE_KBD_TYPEMATIC</a>) {
04188                         ZwDeviceIoControlFile(pDeviceInfo-&gt;handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04189                                 &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a220">giosbKbdControl</a>, IOCTL_KEYBOARD_SET_TYPEMATIC,
04190                                 (PVOID)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a218">gktp</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a218">gktp</a>), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
04191                     }
04192                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a226">gdwUpdateKeyboard</a> &amp; <a class="code" href="../../d6/d8/ntinput_8c.html#a1">UPDATE_KBD_LEDS</a>) {
04193                         ZwDeviceIoControlFile(pDeviceInfo-&gt;handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04194                                 &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a220">giosbKbdControl</a>, IOCTL_KEYBOARD_SET_INDICATORS,
04195                                 (PVOID)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a216">gklp</a>), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
04196                     }
04197                 }
04198             }
04199             <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
04200             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a226">gdwUpdateKeyboard</a> &amp;= ~(<a class="code" href="../../d6/d8/ntinput_8c.html#a0">UPDATE_KBD_TYPEMATIC</a> | <a class="code" href="../../d6/d8/ntinput_8c.html#a1">UPDATE_KBD_LEDS</a>);
04201         }
04202 
04203         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d6/d8/ntinput_8c.html#a8">ID_MOUSE</a>) {
04204             <span class="comment">/*</span>
04205 <span class="comment">             * A desktop thread got some Mouse input for us. Process it.</span>
04206 <span class="comment">             */</span>
04207             <a class="code" href="../../d6/d8/ntinput_8c.html#a29">ProcessQueuedMouseEvents</a>();
04208 
04209         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d6/d8/ntinput_8c.html#a10">ID_HIDCHANGE</a>) {
04210             TAGMSG0(DBGTAG_PNP | RIP_THERESMORE, <span class="stringliteral">"RIT wakes for HID Change"</span>);
04211             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04212             <a class="code" href="../../d4/d1/userk_8h.html#a1172">ProcessDeviceChanges</a>(<a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>);
04213             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04214         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d6/d8/ntinput_8c.html#a12">ID_SHUTDOWN</a>) {
04215 
04216             <a class="code" href="../../d6/d8/ntinput_8c.html#a55">InitiateWin32kCleanup</a>();
04217 
04218             ZwClose(hevtShutDown);
04219 
04220             <span class="keywordflow">break</span>;
04221 
04222         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d6/d8/ntinput_8c.html#a13">ID_WDTIMER</a>) {
04223             <span class="comment">//LARGE_INTEGER liTemp;</span>
04224 
04225             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04226 
04227             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>);
04228 
04229             <span class="comment">/*</span>
04230 <span class="comment">             * Call the TShare display driver to flush the frame buffer</span>
04231 <span class="comment">             */</span>
04232 
04233             <span class="keywordflow">if</span> (!HDXDrvEscape(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, ESC_TIMEROBJ_SIGNALED, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0)) {
04234                 UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04235             }
04236             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04237 
04238         } <span class="keywordflow">else</span> {
04239             <span class="comment">/*</span>
04240 <span class="comment">             * If the master timer has expired, then process the timer</span>
04241 <span class="comment">             * list. Otherwise, an APC caused the raw input thread to be</span>
04242 <span class="comment">             * awakened.</span>
04243 <span class="comment">             */</span>
04244             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d6/d8/ntinput_8c.html#a9">ID_TIMER</a>) {
04245                 <a class="code" href="../../d4/d1/userk_8h.html#a1477">TimersProc</a>();
04246                 <span class="comment">/*</span>
04247 <span class="comment">                 * If an input degvice read failed due to insufficient resources,</span>
04248 <span class="comment">                 * we retry by signalling the proper thread: ProcessDeviceChanges</span>
04249 <span class="comment">                 * will call RetryReadInput().</span>
04250 <span class="comment">                 */</span>
04251                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a208">gnRetryReadInput</a> != nLastRetryReadInput) {
04252                     nLastRetryReadInput = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a208">gnRetryReadInput</a>;
04253                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[<a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>].pkeHidChange, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04254                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[<a class="code" href="../../d4/d1/userk_8h.html#a176">DEVICE_TYPE_KEYBOARD</a>].pkeHidChange, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04255                 }
04256             }
04257 
04258 <span class="preprocessor">#if DBG</span>
04259 <span class="preprocessor"></span>            <span class="comment">/*</span>
04260 <span class="comment">             * In the debugger set gBlockSleep to n:</span>
04261 <span class="comment">             * The RIT will sleep n millicseconds, then n timer ticks later</span>
04262 <span class="comment">             * will sleep n milliseconds again.</span>
04263 <span class="comment">             */</span>
04264             <span class="keywordflow">if</span> (gBlockDelay) {
04265                 gBlockDelay--;
04266             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((gBlockDelay == 0) &amp;&amp; (gBlockSleep != 0)) {
04267                 <a class="code" href="../../d4/d1/userk_8h.html#a1294">UserSleep</a>(gBlockSleep);
04268                 gBlockDelay = 100 * gBlockSleep;
04269             }
04270 <span class="preprocessor">#endif</span>
04271 <span class="preprocessor"></span>
04272             <span class="comment">/*</span>
04273 <span class="comment">             * if in cool task switcher window, dispose of the messages</span>
04274 <span class="comment">             * on the queue</span>
04275 <span class="comment">             */</span>
04276             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04277                 <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04278                 <a class="code" href="../../d4/d1/userk_8h.html#a502">xxxReceiveMessages</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>);
04279                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04280             }
04281         }
04282     }
04283 
04284     <span class="keywordflow">return</span>;
04285 
04286 Exit:
04287 
04288     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04289 
04290     <span class="comment">/*</span>
04291 <span class="comment">     * Signal that the rit has been initialized</span>
04292 <span class="comment">     */</span>
04293     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pInitData-&gt;<a class="code" href="../../d7/d4/struct__RIT__INIT.html#o1">pRitReadyEvent</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04294 
04295     RIPMSG0(RIP_WARNING, <span class="stringliteral">"RIT initialization failure"</span>);
04296     <span class="keywordflow">return</span>;
04297 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
