<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fsvga.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fsvga.c</h1><a href="../../d6/d8/fsvga_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    fsvga.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This is the console fullscreen driver for the VGA card.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Environment:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    kernel mode only</span>
00016 <span class="comment"></span>
00017 <span class="comment">Notes:</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "stdarg.h"</span>
00024 <span class="preprocessor">#include "stdio.h"</span>
00025 <span class="preprocessor">#include "ntddk.h"</span>
00026 <span class="preprocessor">#include "<a class="code" href="../../d7/d8/fsvga_8h.html">fsvga.h</a>"</span>
00027 <span class="preprocessor">#include "fsvgalog.h"</span>
00028 
00029 <span class="comment">//</span>
00030 <span class="comment">// Use the alloc_text pragma to specify the driver initialization routines</span>
00031 <span class="comment">// (they can be paged out).</span>
00032 <span class="comment">//</span>
00033 
00034 <span class="preprocessor">#if defined(ALLOC_PRAGMA)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,DriverEntry)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,FsVgaConfiguration)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,FsVgaPeripheralCallout)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,FsVgaServiceParameters)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,FsVgaBuildResourceList)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 
00043 <span class="comment">//</span>
00044 <span class="comment">// Declare the global debug flag for this driver.</span>
00045 <span class="comment">//</span>
00046 
00047 <span class="preprocessor">#if DBG</span>
00048 <span class="preprocessor"></span>ULONG FsVgaDebug = 0;
00049 <span class="preprocessor">#endif</span>
00050 <span class="preprocessor"></span>
00051 
00052 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00053"></a><a class="code" href="../../d6/d8/fsvga_8c.html#a5">00053</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a22">DriverEntry</a>(
00054     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00055     IN PUNICODE_STRING RegistryPath
00056     )
00057 
00058 <span class="comment">/*++</span>
00059 <span class="comment"></span>
00060 <span class="comment">Routine Description:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    Installable driver initialization entry point.</span>
00063 <span class="comment">    This entry point is called directly by the I/O system.</span>
00064 <span class="comment"></span>
00065 <span class="comment">Arguments:</span>
00066 <span class="comment"></span>
00067 <span class="comment">    DriverObject - Pointer to driver object created by system.</span>
00068 <span class="comment"></span>
00069 <span class="comment">    RegistryPath - Pointer to the Unicode name of the registry path</span>
00070 <span class="comment">        for this driver.</span>
00071 <span class="comment"></span>
00072 <span class="comment">Return Value:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    The function value is the final status from the initialization operation.</span>
00075 <span class="comment"></span>
00076 <span class="comment">--*/</span>
00077 
00078 {
00079     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00080     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00081     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">DEVICE_EXTENSION</a> tmpDeviceExtension;
00082     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00083     PCM_RESOURCE_LIST resources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00084     ULONG resourceListSize = 0;
00085     BOOLEAN overrideConflict;
00086     BOOLEAN conflictDetected;
00087     ULONG addressSpace;
00088     PHYSICAL_ADDRESS cardAddress;
00089     ULONG i;
00090     UNICODE_STRING fullFsVgaName;
00091     UNICODE_STRING baseFsVgaName;
00092     UNICODE_STRING deviceNameSuffix;
00093     UNICODE_STRING resourceDeviceClass;
00094     UNICODE_STRING registryPath;
00095 
00096 <span class="preprocessor">#define NAME_MAX 256</span>
00097 <span class="preprocessor"></span>    WCHAR FsVgaBuffer[<a class="code" href="../../d6/d8/fsvga_8c.html#a0">NAME_MAX</a>];
00098 
00099     ULONG uniqueErrorValue;
00100     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> errorCode = STATUS_SUCCESS;
00101     ULONG dumpCount = 0;
00102 
00103 <span class="preprocessor">#define DUMP_COUNT 4</span>
00104 <span class="preprocessor"></span>    ULONG dumpData[<a class="code" href="../../d6/d8/fsvga_8c.html#a1">DUMP_COUNT</a>];
00105 
00106     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00107                 <span class="stringliteral">"\n\nFSVGA-FSVGAInitialize: enter\n"</span>));
00108 
00109     <span class="comment">//</span>
00110     <span class="comment">// Zero-initialize various structures.</span>
00111     <span class="comment">//</span>
00112     RtlZeroMemory(&amp;tmpDeviceExtension, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">DEVICE_EXTENSION</a>));
00113 
00114     fullFsVgaName.MaximumLength = 0;
00115     fullFsVgaName.Length = 0;
00116     deviceNameSuffix.MaximumLength = 0;
00117     deviceNameSuffix.Length = 0;
00118     resourceDeviceClass.MaximumLength = 0;
00119     resourceDeviceClass.Length = 0;
00120     registryPath.MaximumLength = 0;
00121     registryPath.Length = 0;
00122 
00123     RtlZeroMemory(FsVgaBuffer, <a class="code" href="../../d6/d8/fsvga_8c.html#a0">NAME_MAX</a> * <span class="keyword">sizeof</span>(WCHAR));
00124     baseFsVgaName.Buffer = FsVgaBuffer;
00125     baseFsVgaName.Length = 0;
00126     baseFsVgaName.MaximumLength = <a class="code" href="../../d6/d8/fsvga_8c.html#a0">NAME_MAX</a> * <span class="keyword">sizeof</span>(WCHAR);
00127 
00128     RtlZeroMemory(dumpData, <span class="keyword">sizeof</span>(dumpData));
00129 
00130     <span class="comment">//</span>
00131     <span class="comment">// Need to ensure that the registry path is null-terminated.</span>
00132     <span class="comment">// Allocate pool to hold a null-terminated copy of the path.</span>
00133     <span class="comment">//</span>
00134     registryPath.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00135                                          RegistryPath-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00136     <span class="keywordflow">if</span> (!registryPath.Buffer)
00137     {
00138         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00139                     <span class="stringliteral">"FSVGA-FSVGAInitialize: Couldn't allocate pool for registry path\n"</span>));
00140         status = STATUS_UNSUCCESSFUL;
00141         errorCode = FSVGA_INSUFFICIENT_RESOURCES;
00142         uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 2;
00143         dumpData[0] = (ULONG) RegistryPath-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00144         dumpCount = 1;
00145         <span class="keywordflow">goto</span> FsVgaInitializeExit;
00146     }
00147     <span class="keywordflow">else</span>
00148     {
00149         registryPath.Length = RegistryPath-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00150         registryPath.MaximumLength = registryPath.Length;
00151 
00152         RtlZeroMemory(registryPath.Buffer,
00153                       registryPath.Length);
00154         RtlMoveMemory(registryPath.Buffer,
00155                       RegistryPath-&gt;Buffer,
00156                       RegistryPath-&gt;Length);
00157     }
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// Get the configuration information for this driver.</span>
00161     <span class="comment">//</span>
00162 
00163     <a class="code" href="../../d7/d8/fsvga_8h.html#a24">FsVgaConfiguration</a>(&amp;tmpDeviceExtension,
00164                        &amp;registryPath,
00165                        &amp;baseFsVgaName);
00166 
00167     <span class="keywordflow">if</span> (!(tmpDeviceExtension.<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o47">HardwarePresent</a> &amp; <a class="code" href="../../d7/d8/fsvga_8h.html#a9">FSVGA_HARDWARE_PRESENT</a>)) {
00168 
00169         <span class="comment">//</span>
00170         <span class="comment">// There is neither a Full Screen Video attached.  Free</span>
00171         <span class="comment">// resources and return with unsuccessful status.</span>
00172         <span class="comment">//</span>
00173 
00174         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00175                     <span class="stringliteral">"FSVGA-FsVgaInitialize: No Full Screen Video attached.\n"</span>));
00176         status = STATUS_NO_SUCH_DEVICE;
00177         errorCode = FSVGA_NO_SUCH_DEVICE;
00178         uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 4;
00179         <span class="keywordflow">goto</span> FsVgaInitializeExit;
00180 
00181     }
00182 
00183     <span class="comment">//</span>
00184     <span class="comment">// Set up space for the port's device object suffix.  Note that</span>
00185     <span class="comment">// we overallocate space for the suffix string because it is much</span>
00186     <span class="comment">// easier than figuring out exactly how much space is required.</span>
00187     <span class="comment">// The storage gets freed at the end of driver initialization, so</span>
00188     <span class="comment">// who cares...</span>
00189     <span class="comment">//</span>
00190 
00191     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceNameSuffix,
00192                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00193 
00194     deviceNameSuffix.MaximumLength = FULLSCREEN_VIDEO_SUFFIX_MAXIMUM * <span class="keyword">sizeof</span>(WCHAR);
00195     deviceNameSuffix.MaximumLength += <span class="keyword">sizeof</span>(UNICODE_NULL);
00196 
00197     deviceNameSuffix.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00198                                              deviceNameSuffix.MaximumLength);
00199     <span class="keywordflow">if</span> (!deviceNameSuffix.Buffer) {
00200         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00201                     <span class="stringliteral">"FSVGA-FsVgaInitialize: Couldn't allocate string for device object suffix\n"</span>));
00202 
00203         status = STATUS_UNSUCCESSFUL;
00204         errorCode = FSVGA_INSUFFICIENT_RESOURCES;
00205         uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 8;
00206         dumpData[0] = (ULONG) deviceNameSuffix.MaximumLength;
00207         dumpCount = 1;
00208         <span class="keywordflow">goto</span> FsVgaInitializeExit;
00209     }
00210 
00211     RtlZeroMemory(deviceNameSuffix.Buffer,
00212                   deviceNameSuffix.MaximumLength);
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// Set up space for the port's Full Screen Video device object name.</span>
00216     <span class="comment">//</span>
00217 
00218     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;fullFsVgaName,
00219                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00220 
00221     fullFsVgaName.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\"</span>) +
00222                                       baseFsVgaName.Length +
00223                                       deviceNameSuffix.MaximumLength;
00224 
00225     fullFsVgaName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00226                                           fullFsVgaName.MaximumLength);
00227     <span class="keywordflow">if</span> (!fullFsVgaName.Buffer) {
00228         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00229                     <span class="stringliteral">"FSVGA-FsVgaInitialize: Couldn't allocate string for Full Screen Video device object name\n"</span>));
00230 
00231         status = STATUS_UNSUCCESSFUL;
00232         errorCode = FSVGA_INSUFFICIENT_RESOURCES;
00233         uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 10;
00234         dumpData[0] = (ULONG) fullFsVgaName.MaximumLength;
00235         dumpCount = 1;
00236         <span class="keywordflow">goto</span> FsVgaInitializeExit;
00237 
00238     }
00239 
00240     RtlZeroMemory(fullFsVgaName.Buffer,
00241                   fullFsVgaName.MaximumLength);
00242     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;fullFsVgaName,
00243                              <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\"</span>);
00244     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;fullFsVgaName,
00245                              baseFsVgaName.Buffer);
00246 
00247     <span class="comment">//</span>
00248     <span class="comment">// Append the suffix to the device object name string.  E.g., turn</span>
00249     <span class="comment">// \Device\FullScreenVideo into \Device\FullScreenVideo0.  Then we attempt</span>
00250     <span class="comment">// to create the device object.  If the device object already</span>
00251     <span class="comment">// exists (because it was already created by another port driver),</span>
00252     <span class="comment">// increment the suffix and try again.</span>
00253     <span class="comment">//</span>
00254 
00255     status = <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>( 0,  <span class="comment">// suffix number = 0</span>
00256                                        10,
00257                                        &amp;deviceNameSuffix);
00258     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00259     {
00260         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00261                     <span class="stringliteral">"FSVGA-FsVgaInitialize: Could not create suffix number\n"</span>));
00262         errorCode = FSVGA_INSUFFICIENT_RESOURCES;
00263         uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 12;
00264         dumpData[0] = (ULONG) 0; <span class="comment">// suffix number = 0</span>
00265         dumpCount = 1;
00266         <span class="keywordflow">goto</span> FsVgaInitializeExit;
00267     }
00268 
00269     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;fullFsVgaName,
00270                                    &amp;deviceNameSuffix);
00271 
00272     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00273                 <span class="stringliteral">"FSVGA-FSVGAInitialize: Creating device object named %ws\n"</span>,
00274                 fullFsVgaName.Buffer));
00275 
00276     <span class="comment">//</span>
00277     <span class="comment">// Create device object for the FsVga device.</span>
00278     <span class="comment">// Note that we specify that this is a exclusive device.</span>
00279     <span class="comment">//</span>
00280 
00281     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>(DriverObject,
00282                             <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/fs__rec_8h.html#a13">DEVICE_EXTENSION</a>),
00283                             &amp;fullFsVgaName,
00284                             FILE_DEVICE_FULLSCREEN_VIDEO,
00285                             0,
00286                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00287                             &amp;DeviceObject);
00288     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00289     {
00290         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00291                     <span class="stringliteral">"FSVGA-FSVGAInitialize: Couldn't create device object = %ws\n"</span>));
00292         status = STATUS_UNSUCCESSFUL;
00293         errorCode = FSVGA_INSUFFICIENT_RESOURCES;
00294         uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 2;
00295         dumpData[0] = (ULONG) RegistryPath-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00296         dumpCount = 1;
00297         <span class="keywordflow">goto</span> FsVgaInitializeExit;
00298     }
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">// Set up the device extension.</span>
00302     <span class="comment">//</span>
00303 
00304     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>)DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o11">DeviceExtension</a>;
00305     *deviceExtension = tmpDeviceExtension;
00306     deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o3">DeviceObject</a> = DeviceObject;
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// Set up the resource list prior to reporting resource usage.</span>
00310     <span class="comment">//</span>
00311 
00312     <a class="code" href="../../d7/d8/fsvga_8h.html#a27">FsVgaBuildResourceList</a>(deviceExtension, &amp;resources, &amp;resourceListSize);
00313 
00314     <span class="comment">//</span>
00315     <span class="comment">// Set up space for the resource device class name.</span>
00316     <span class="comment">//</span>
00317 
00318     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;resourceDeviceClass,
00319                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00320 
00321     resourceDeviceClass.MaximumLength = baseFsVgaName.Length;
00322 
00323     resourceDeviceClass.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00324                                                 resourceDeviceClass.MaximumLength);
00325 
00326     <span class="keywordflow">if</span> (!resourceDeviceClass.Buffer) {
00327 
00328         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00329                     <span class="stringliteral">"FSVGA-FsVgaInitialize: Couldn't allocate string for resource device class name\n"</span>));
00330 
00331         status = STATUS_UNSUCCESSFUL;
00332         errorCode = FSVGA_INSUFFICIENT_RESOURCES;
00333         uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 15;
00334         dumpData[0] = (ULONG) resourceDeviceClass.MaximumLength;
00335         dumpCount = 1;
00336         <span class="keywordflow">goto</span> FsVgaInitializeExit;
00337 
00338     }
00339 
00340     <span class="comment">//</span>
00341     <span class="comment">// Form the resource device class name from the Full Screen Video</span>
00342     <span class="comment">// device names.</span>
00343     <span class="comment">//</span>
00344 
00345     RtlZeroMemory(resourceDeviceClass.Buffer,
00346                   resourceDeviceClass.MaximumLength);
00347     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;resourceDeviceClass,
00348                                    &amp;baseFsVgaName);
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// Report resource usage for the registry.</span>
00352     <span class="comment">//</span>
00353 
00354         <span class="comment">//</span>
00355         <span class="comment">// If we are loading the VGA, do not generate an error if it conflicts</span>
00356         <span class="comment">// with another driver.</span>
00357         <span class="comment">//</span>
00358         <span class="comment">// overrideConflict = pOverrideConflict(DeviceExtension, TRUE);</span>
00359         overrideConflict = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00360 <span class="preprocessor">#if DBG</span>
00361 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (overrideConflict) {
00362             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2, <span class="stringliteral">"We are checking the vga driver resources\n"</span>));
00363         } <span class="keywordflow">else</span> {
00364             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2, <span class="stringliteral">"We are NOT checking vga driver resources\n"</span>));
00365         }
00366 <span class="preprocessor">#endif</span>
00367 <span class="preprocessor"></span>
00368     status = <a class="code" href="../../d1/d8/report_8c.html#a13">IoReportResourceUsage</a>(&amp;resourceDeviceClass,
00369                                    DriverObject,
00370                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00371                                    0,
00372                                    DeviceObject,
00373                                    resources,
00374                                    resourceListSize,
00375                                    overrideConflict,
00376                                    &amp;conflictDetected
00377                                    );
00378 
00379         <span class="comment">//</span>
00380         <span class="comment">// If we tried to override the conflict, let's take a look a what</span>
00381         <span class="comment">// we want to do with the result</span>
00382         <span class="comment">//</span>
00383 
00384         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) &amp;&amp;
00385             overrideConflict &amp;&amp;
00386             conflictDetected) {
00387 
00388             <span class="comment">//</span>
00389             <span class="comment">// For cases like DetectDisplay, a conflict is bad and we do</span>
00390             <span class="comment">// want to fail.</span>
00391             <span class="comment">//</span>
00392             <span class="comment">// In the case of Basevideo, a conflict is possible.  But we still</span>
00393             <span class="comment">// want to load the VGA anyways. Return success and reset the</span>
00394             <span class="comment">// conflict flag !</span>
00395             <span class="comment">//</span>
00396             <span class="comment">// pOverrideConflict with the FALSE flag will check that.</span>
00397             <span class="comment">//</span>
00398             <span class="comment">//</span>
00399             <span class="comment">// if (pOverrideConflict(DeviceExtension, FALSE)) {</span>
00400             <span class="comment">//     error</span>
00401             <span class="comment">// }</span>
00402             <span class="comment">// else {</span>
00403 
00404                 conflictDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00405 
00406             <span class="comment">// }</span>
00407         }
00408 
00409 
00410     <span class="keywordflow">if</span> (conflictDetected) {
00411 
00412         <span class="comment">//</span>
00413         <span class="comment">// Some other device already owns the Full Screen Video ports.</span>
00414         <span class="comment">// Fatal error.</span>
00415         <span class="comment">//</span>
00416 
00417         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00418                     <span class="stringliteral">"FSVGA-FsVgaInitialize: Resource usage conflict\n"</span>));
00419 
00420         <span class="comment">//</span>
00421         <span class="comment">// Set up error log info.</span>
00422         <span class="comment">//</span>
00423 
00424         status = STATUS_INSUFFICIENT_RESOURCES;
00425         errorCode = FSVGA_RESOURCE_CONFLICT;
00426         uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 20;
00427         dumpData[0] =  (ULONG)
00428             resources-&gt;List[0].PartialResourceList.PartialDescriptors[0].u.Port.Start.LowPart;
00429         dumpData[1] =  (ULONG)
00430             resources-&gt;List[0].PartialResourceList.PartialDescriptors[1].u.Port.Start.LowPart;
00431         dumpData[2] =  (ULONG)
00432             resources-&gt;List[0].PartialResourceList.PartialDescriptors[2].u.Port.Start.LowPart;
00433         dumpCount = 3;
00434 
00435         <span class="keywordflow">goto</span> FsVgaInitializeExit;
00436 
00437     }
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">// Map the VGA controller registers.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">for</span> (i = 0; i &lt; deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o49">Configuration</a>.<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a>; i++) {
00444 
00445         addressSpace = (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o49">Configuration</a>.<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o5">PortList</a>[i].Flags
00446                            &amp; CM_RESOURCE_PORT_IO) == CM_RESOURCE_PORT_IO? 1:0;
00447 
00448         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o49">Configuration</a>.<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o3">InterfaceType</a>,
00449                                     deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o49">Configuration</a>.<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o4">BusNumber</a>,
00450                                     deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o49">Configuration</a>.<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o5">PortList</a>[i].u.Port.Start,
00451                                     &amp;addressSpace,
00452                                     &amp;cardAddress
00453                                    )) {
00454 
00455             addressSpace = 1;
00456             cardAddress.QuadPart = 0;
00457         }
00458 
00459         <span class="keywordflow">if</span> (!addressSpace) {
00460 
00461             deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o53">UnmapRegistersRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00462             deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o48">DeviceRegisters</a>[i] =
00463                 <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a>(
00464                     cardAddress,
00465                     deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o49">Configuration</a>.<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o5">PortList</a>[i].u.Port.Length,
00466                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00467                     );
00468 
00469         } <span class="keywordflow">else</span> {
00470 
00471             deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o53">UnmapRegistersRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00472             deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o48">DeviceRegisters</a>[i] = (PVOID)cardAddress.LowPart;
00473 
00474         }
00475 
00476         <span class="keywordflow">if</span> (!deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o48">DeviceRegisters</a>[i]) {
00477 
00478             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00479                         <span class="stringliteral">"FSVGA-FsVgaInitialize: Couldn't map the device registers.\n"</span>));
00480             status = STATUS_NONE_MAPPED;
00481 
00482             <span class="comment">//</span>
00483             <span class="comment">// Set up error log info.</span>
00484             <span class="comment">//</span>
00485 
00486             errorCode = FSVGA_REGISTERS_NOT_MAPPED;
00487             uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 30;
00488             dumpData[0] = cardAddress.LowPart;
00489             dumpCount = 1;
00490 
00491             <span class="keywordflow">goto</span> FsVgaInitializeExit;
00492 
00493         }
00494     }
00495 
00496 
00497 
00498     <span class="comment">//</span>
00499     <span class="comment">// Once initialization is finished, load the device map information</span>
00500     <span class="comment">// into the registry so that setup can determine which full screen</span>
00501     <span class="comment">// port are active.</span>
00502     <span class="comment">//</span>
00503 
00504     <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o47">HardwarePresent</a> &amp; <a class="code" href="../../d7/d8/fsvga_8h.html#a9">FSVGA_HARDWARE_PRESENT</a>) {
00505 
00506         status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>(RTL_REGISTRY_DEVICEMAP,
00507                                        baseFsVgaName.Buffer,
00508                                        fullFsVgaName.Buffer,
00509                                        REG_SZ,
00510                                        registryPath.Buffer,
00511                                        registryPath.Length);
00512 
00513         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00514         {
00515             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00516                        <span class="stringliteral">"FSVGA-FSVGAInitialize: Could not store keyboard name in DeviceMap\n"</span>));
00517             errorCode = FSVGA_NO_DEVICEMAP_CREATED;
00518             uniqueErrorValue = <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 90;
00519             dumpCount = 0;
00520             <span class="keywordflow">goto</span> FsVgaInitializeExit;
00521         }
00522         <span class="keywordflow">else</span>
00523         {
00524             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00525                        <span class="stringliteral">"FSVGA-FSVGAInitialize: Stored pointer name in DeviceMap\n"</span>));
00526         }
00527     }
00528 
00529     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Set up the device driver entry points.</span>
00533     <span class="comment">//</span>
00534     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>] = <a class="code" href="../../d6/d8/fsvga_8c.html#a10">FsVgaOpenCloseDispatch</a>;
00535     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a>]  = <a class="code" href="../../d6/d8/fsvga_8c.html#a10">FsVgaOpenCloseDispatch</a>;
00536     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a27">IRP_MJ_DEVICE_CONTROL</a>] = <a class="code" href="../../d6/d8/fsvga_8c.html#a11">FsVgaDeviceControl</a>;
00537 
00538 FsVgaInitializeExit:
00539 
00540     <span class="keywordflow">if</span> (errorCode != STATUS_SUCCESS)
00541     {
00542         PIO_ERROR_LOG_PACKET errorLogEntry;
00543         ULONG i;
00544 
00545         <span class="comment">//</span>
00546         <span class="comment">// Log an error/warning message.</span>
00547         <span class="comment">//</span>
00548         errorLogEntry = (PIO_ERROR_LOG_PACKET)<a class="code" href="../../d4/d6/iosubs_8c.html#a14">IoAllocateErrorLogEntry</a>(
00549                 (DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? (PVOID) DriverObject : (PVOID) DeviceObject,
00550                 (UCHAR) (<span class="keyword">sizeof</span>(IO_ERROR_LOG_PACKET)
00551                          + (dumpCount * <span class="keyword">sizeof</span>(ULONG)))
00552                 );
00553 
00554         <span class="keywordflow">if</span> (errorLogEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00555         {
00556             errorLogEntry-&gt;ErrorCode = errorCode;
00557             errorLogEntry-&gt;DumpDataSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) dumpCount * <span class="keyword">sizeof</span>(ULONG);
00558             errorLogEntry-&gt;SequenceNumber = 0;
00559             errorLogEntry-&gt;MajorFunctionCode = 0;
00560             errorLogEntry-&gt;IoControlCode = 0;
00561             errorLogEntry-&gt;RetryCount = 0;
00562             errorLogEntry-&gt;UniqueErrorValue = uniqueErrorValue;
00563             errorLogEntry-&gt;FinalStatus = status;
00564             <span class="keywordflow">for</span> (i = 0; i &lt; dumpCount; i++)
00565                 errorLogEntry-&gt;DumpData[i] = dumpData[i];
00566 
00567             <a class="code" href="../../d4/d6/iosubs_8c.html#a123">IoWriteErrorLogEntry</a>(errorLogEntry);
00568         }
00569     }
00570 
00571     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00572     {
00573         <span class="comment">//</span>
00574         <span class="comment">// The initialization failed.  Cleanup resources before exiting.</span>
00575         <span class="comment">//</span>
00576 
00577         <span class="keywordflow">if</span> (resources) {
00578 
00579             <span class="comment">//</span>
00580             <span class="comment">// Call IoReportResourceUsage to remove the resources from</span>
00581             <span class="comment">// the map.</span>
00582             <span class="comment">//</span>
00583 
00584             resources-&gt;Count = 0;
00585 
00586             <a class="code" href="../../d1/d8/report_8c.html#a13">IoReportResourceUsage</a>(&amp;resourceDeviceClass,
00587                                   DriverObject,
00588                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00589                                   0,
00590                                   DeviceObject,
00591                                   resources,
00592                                   resourceListSize,
00593                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00594                                   &amp;conflictDetected
00595                                  );
00596 
00597         }
00598 
00599         <span class="keywordflow">if</span> (deviceExtension) {
00600 
00601             <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o53">UnmapRegistersRequired</a>) {
00602                 <span class="keywordflow">for</span> (i = 0;
00603                      i &lt; deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o49">Configuration</a>.<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a>; i++){
00604                     <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o48">DeviceRegisters</a>[i]) {
00605                         <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a>(
00606                             deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o48">DeviceRegisters</a>[i],
00607                             deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o49">Configuration</a>.<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o5">PortList</a>[i].u.Port.Length);
00608                     }
00609                 }
00610             }
00611         }
00612 
00613         <span class="keywordflow">if</span> (DeviceObject) {
00614             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(DeviceObject);
00615         }
00616     }
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Free the resource list.</span>
00620     <span class="comment">//</span>
00621     <span class="comment">// N.B.  If we ever decide to hang on to the resource list instead,</span>
00622     <span class="comment">//       we need to allocate it from non-paged pool (it is now paged pool).</span>
00623     <span class="comment">//</span>
00624 
00625     <span class="keywordflow">if</span> (resources) {
00626         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resources);
00627     }
00628 
00629     <span class="comment">//</span>
00630     <span class="comment">// Free the unicode strings for device names.</span>
00631     <span class="comment">//</span>
00632     <span class="keywordflow">if</span> (deviceNameSuffix.MaximumLength != 0)
00633         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNameSuffix.Buffer);
00634     <span class="keywordflow">if</span> (fullFsVgaName.MaximumLength != 0)
00635         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(fullFsVgaName.Buffer);
00636     <span class="keywordflow">if</span> (resourceDeviceClass.MaximumLength != 0)
00637         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceDeviceClass.Buffer);
00638     <span class="keywordflow">if</span> (registryPath.MaximumLength != 0)
00639         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(registryPath.Buffer);
00640 
00641     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00642                 <span class="stringliteral">"FSVGA-FsVgaInitialize: exit\n"</span>));
00643 
00644     <span class="keywordflow">return</span>(status);
00645 }
00646 
00647 
00648 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00649"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a24">00649</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a24">FsVgaConfiguration</a>(
00650     IN <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
00651     IN PUNICODE_STRING RegistryPath,
00652     IN PUNICODE_STRING FsVgaDeviceName
00653     )
00654 
00655 <span class="comment">/*++</span>
00656 <span class="comment"></span>
00657 <span class="comment">Routine Description:</span>
00658 <span class="comment"></span>
00659 <span class="comment">    This routine retrieves the configuration information for the keyboard.</span>
00660 <span class="comment"></span>
00661 <span class="comment">Arguments:</span>
00662 <span class="comment"></span>
00663 <span class="comment">    DeviceExtension - Pointer to the device extension.</span>
00664 <span class="comment"></span>
00665 <span class="comment">    RegistryPath - Pointer to the null-terminated Unicode name of the</span>
00666 <span class="comment">        registry path for this driver.</span>
00667 <span class="comment"></span>
00668 <span class="comment">    FsVgaDeviceName - Pointer to the Unicode string that will receive</span>
00669 <span class="comment">        the Full Screen Video port device name.</span>
00670 <span class="comment"></span>
00671 <span class="comment">Return Value:</span>
00672 <span class="comment"></span>
00673 <span class="comment">    None.  As a side-effect, may set DeviceExtension-&gt;HardwarePresent.</span>
00674 <span class="comment"></span>
00675 <span class="comment">--*/</span>
00676 {
00677     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00678     <a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html">PFSVGA_CONFIGURATION_INFORMATION</a> configuration;
00679     INTERFACE_TYPE interfaceType;
00680     ULONG i;
00681 
00682     <span class="keywordflow">for</span> (i = 0; i &lt; MaximumInterfaceType; i++)
00683     {
00684 
00685         <span class="comment">//</span>
00686         <span class="comment">// Get the registry information for this device.</span>
00687         <span class="comment">//</span>
00688 
00689         interfaceType = i;
00690         status = <a class="code" href="../../d2/d3/io_2query_8c.html#a6">IoQueryDeviceDescription</a>(&amp;interfaceType,
00691                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00692                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00693                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00694                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00695                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00696                                           <a class="code" href="../../d6/d8/fsvga_8c.html#a7">FsVgaPeripheralCallout</a>,
00697                                           (PVOID) DeviceExtension);
00698 
00699         <span class="keywordflow">if</span> (DeviceExtension-&gt;HardwarePresent &amp; <a class="code" href="../../d7/d8/fsvga_8h.html#a9">FSVGA_HARDWARE_PRESENT</a>)
00700         {
00701             <span class="comment">//</span>
00702             <span class="comment">// Get the service parameters (e.g., user-configurable number</span>
00703             <span class="comment">// of resends, polling iterations, etc.).</span>
00704             <span class="comment">//</span>
00705 
00706             <a class="code" href="../../d7/d8/fsvga_8h.html#a26">FsVgaServiceParameters</a>(DeviceExtension,
00707                                    RegistryPath,
00708                                    FsVgaDeviceName);
00709 
00710             <span class="keywordflow">break</span>;
00711         }
00712         <span class="keywordflow">else</span>
00713         {
00714             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00715                         <span class="stringliteral">"FSVGA-FsVgaConfiguration: IoQueryDeviceDescription for bus type %d failed\n"</span>,
00716                         interfaceType));
00717         }
00718     }
00719 }
00720 
00721 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00722"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a25">00722</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a25">FsVgaPeripheralCallout</a>(
00723     IN PVOID Context,
00724     IN PUNICODE_STRING PathName,
00725     IN INTERFACE_TYPE BusType,
00726     IN ULONG BusNumber,
00727     IN PKEY_VALUE_FULL_INFORMATION *BusInformation,
00728     IN CONFIGURATION_TYPE ControllerType,
00729     IN ULONG ControllerNumber,
00730     IN PKEY_VALUE_FULL_INFORMATION *ControllerInformation,
00731     IN CONFIGURATION_TYPE PeripheralType,
00732     IN ULONG PeripheralNumber,
00733     IN PKEY_VALUE_FULL_INFORMATION *PeripheralInformation
00734     )
00735 
00736 <span class="comment">/*++</span>
00737 <span class="comment"></span>
00738 <span class="comment">Routine Description:</span>
00739 <span class="comment"></span>
00740 <span class="comment">    This is the callout routine sent as a parameter to</span>
00741 <span class="comment">    IoQueryDeviceDescription.  It grabs the Display controller</span>
00742 <span class="comment">    configuration information.</span>
00743 <span class="comment"></span>
00744 <span class="comment">Arguments:</span>
00745 <span class="comment"></span>
00746 <span class="comment">    Context - Context parameter that was passed in by the routine</span>
00747 <span class="comment">        that called IoQueryDeviceDescription.</span>
00748 <span class="comment"></span>
00749 <span class="comment">    PathName - The full pathname for the registry key.</span>
00750 <span class="comment"></span>
00751 <span class="comment">    BusType - Bus interface type (Isa, Eisa, Mca, etc.).</span>
00752 <span class="comment"></span>
00753 <span class="comment">    BusNumber - The bus sub-key (0, 1, etc.).</span>
00754 <span class="comment"></span>
00755 <span class="comment">    BusInformation - Pointer to the array of pointers to the full value</span>
00756 <span class="comment">        information for the bus.</span>
00757 <span class="comment"></span>
00758 <span class="comment">    ControllerType - The controller type (should be DisplayController).</span>
00759 <span class="comment"></span>
00760 <span class="comment">    ControllerNumber - The controller sub-key (0, 1, etc.).</span>
00761 <span class="comment"></span>
00762 <span class="comment">    ControllerInformation - Pointer to the array of pointers to the full</span>
00763 <span class="comment">        value information for the controller key.</span>
00764 <span class="comment"></span>
00765 <span class="comment">    PeripheralType - The peripheral type (should be MonitorPeripheral).</span>
00766 <span class="comment"></span>
00767 <span class="comment">    PeripheralNumber - The peripheral sub-key.</span>
00768 <span class="comment"></span>
00769 <span class="comment">    PeripheralInformation - Pointer to the array of pointers to the full</span>
00770 <span class="comment">        value information for the peripheral key.</span>
00771 <span class="comment"></span>
00772 <span class="comment"></span>
00773 <span class="comment">Return Value:</span>
00774 <span class="comment"></span>
00775 <span class="comment">    None.  If successful, will have the following side-effects:</span>
00776 <span class="comment"></span>
00777 <span class="comment">        - Sets DeviceObject-&gt;DeviceExtension-&gt;HardwarePresent.</span>
00778 <span class="comment">        - Sets configuration fields in</span>
00779 <span class="comment">          DeviceObject-&gt;DeviceExtension-&gt;Configuration.</span>
00780 <span class="comment"></span>
00781 <span class="comment">--*/</span>
00782 
00783 {
00784     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00785     <a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html">PFSVGA_CONFIGURATION_INFORMATION</a> configuration;
00786     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00787     CM_PARTIAL_RESOURCE_DESCRIPTOR ResourceDescriptor;
00788 
00789     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00790                 <span class="stringliteral">"FSVGA-FsVgaPeripheralCallout: Path @ 0x%x, Bus Type 0x%x, Bus Number 0x%x\n"</span>,
00791                 PathName, BusType, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>));
00792     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00793                 <span class="stringliteral">"    Controller Type 0x%x, Controller Number 0x%x, Controller info @ 0x%x\n"</span>,
00794                 <a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a>, ControllerNumber, ControllerInformation));
00795     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00796                 <span class="stringliteral">"    Peripheral Type 0x%x, Peripheral Number 0x%x, Peripheral info @ 0x%x\n"</span>,
00797                 <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>, PeripheralNumber, PeripheralInformation));
00798 
00799     <span class="comment">//</span>
00800     <span class="comment">// If we already have the configuration information for the</span>
00801     <span class="comment">// keyboard peripheral, or if the peripheral identifier is missing,</span>
00802     <span class="comment">// just return.</span>
00803     <span class="comment">//</span>
00804 
00805     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) Context;
00806     <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o47">HardwarePresent</a> &amp; <a class="code" href="../../d7/d8/fsvga_8h.html#a9">FSVGA_HARDWARE_PRESENT</a>)
00807     {
00808         <span class="keywordflow">return</span> (status);
00809     }
00810 
00811     configuration = &amp;deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o49">Configuration</a>;
00812 
00813     deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o47">HardwarePresent</a> |= <a class="code" href="../../d7/d8/fsvga_8h.html#a9">FSVGA_HARDWARE_PRESENT</a>;
00814 
00815     <span class="comment">//</span>
00816     <span class="comment">// Get the bus information.</span>
00817     <span class="comment">//</span>
00818 
00819     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o3">InterfaceType</a> = BusType;
00820     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o4">BusNumber</a> = <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00821 
00822     <span class="comment">//</span>
00823     <span class="comment">// Get logical IO port addresses.</span>
00824     <span class="comment">//</span>
00825     ResourceDescriptor.Type = CmResourceTypePort;
00826     ResourceDescriptor.ShareDisposition = CmResourceShareShared;
00827     ResourceDescriptor.Flags = CM_RESOURCE_PORT_IO;
00828 
00829     ResourceDescriptor.u.Port.Start.LowPart = <a class="code" href="../../d1/d6/vga_8h.html#a3">VGA_BASE_IO_PORT</a>+<a class="code" href="../../d1/d6/vga_8h.html#a29">CRTC_ADDRESS_PORT_COLOR</a>;
00830     ResourceDescriptor.u.Port.Start.HighPart = 0;
00831     ResourceDescriptor.u.Port.Length = 1;
00832     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o5">PortList</a>[configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a>] = ResourceDescriptor;
00833     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a> += 1;
00834 
00835     ResourceDescriptor.u.Port.Start.LowPart = <a class="code" href="../../d1/d6/vga_8h.html#a3">VGA_BASE_IO_PORT</a>+<a class="code" href="../../d1/d6/vga_8h.html#a30">CRTC_DATA_PORT_COLOR</a>;
00836     ResourceDescriptor.u.Port.Start.HighPart = 0;
00837     ResourceDescriptor.u.Port.Length = 1;
00838     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o5">PortList</a>[configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a>] = ResourceDescriptor;
00839     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a> += 1;
00840 
00841     ResourceDescriptor.u.Port.Start.LowPart = <a class="code" href="../../d1/d6/vga_8h.html#a3">VGA_BASE_IO_PORT</a>+<a class="code" href="../../d1/d6/vga_8h.html#a27">GRAPH_ADDRESS_PORT</a>;
00842     ResourceDescriptor.u.Port.Start.HighPart = 0;
00843     ResourceDescriptor.u.Port.Length = 2;
00844     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o5">PortList</a>[configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a>] = ResourceDescriptor;
00845     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a> += 1;
00846 
00847     ResourceDescriptor.u.Port.Start.LowPart = <a class="code" href="../../d1/d6/vga_8h.html#a3">VGA_BASE_IO_PORT</a>+<a class="code" href="../../d1/d6/vga_8h.html#a18">SEQ_ADDRESS_PORT</a>;
00848     ResourceDescriptor.u.Port.Start.HighPart = 0;
00849     ResourceDescriptor.u.Port.Length = 2;
00850     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o5">PortList</a>[configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a>] = ResourceDescriptor;
00851     configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o6">PortListCount</a> += 1;
00852 
00853     <span class="keywordflow">return</span>(status);
00854 }
00855 
00856 
00857 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00858"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a26">00858</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a26">FsVgaServiceParameters</a>(
00859     IN <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
00860     IN PUNICODE_STRING RegistryPath,
00861     IN PUNICODE_STRING FsVgaDeviceName
00862     )
00863 
00864 <span class="comment">/*++</span>
00865 <span class="comment"></span>
00866 <span class="comment">Routine Description:</span>
00867 <span class="comment"></span>
00868 <span class="comment">    This routine retrieves this driver's service parameters information</span>
00869 <span class="comment">    from the registry.</span>
00870 <span class="comment"></span>
00871 <span class="comment">Arguments:</span>
00872 <span class="comment"></span>
00873 <span class="comment">    DeviceExtension - Pointer to the device extension.</span>
00874 <span class="comment"></span>
00875 <span class="comment">    RegistryPath - Pointer to the null-terminated Unicode name of the</span>
00876 <span class="comment">        registry path for this driver.</span>
00877 <span class="comment"></span>
00878 <span class="comment">    FsVgaDeviceName - Pointer to the Unicode string that will receive</span>
00879 <span class="comment">        the Full Screen Video port device name.</span>
00880 <span class="comment"></span>
00881 <span class="comment">Return Value:</span>
00882 <span class="comment"></span>
00883 <span class="comment">    None.  As a side-effect, sets fields in DeviceExtension-&gt;Configuration.</span>
00884 <span class="comment"></span>
00885 <span class="comment">--*/</span>
00886 
00887 {
00888     <a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html">PFSVGA_CONFIGURATION_INFORMATION</a> configuration;
00889     UNICODE_STRING parametersPath;
00890     PWSTR <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>;
00891     PRTL_QUERY_REGISTRY_TABLE parameters = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00892     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> queriesPlusOne = 4;
00893     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00894 <span class="preprocessor">#define PARAMETER_MAX 256</span>
00895 <span class="preprocessor"></span>    ULONG EmulationMode;
00896     ULONG HardwareCursor;
00897     ULONG HardwareScroll;
00898     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> defaultEmulationMode = 0;
00899     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> defaultHardwareCursor = <a class="code" href="../../d7/d8/fsvga_8h.html#a1">NO_HARDWARE_CURSOR</a>;
00900     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> defaultHardwareScroll = <a class="code" href="../../d7/d8/fsvga_8h.html#a3">NO_HARDWARE_SCROLL</a>;
00901     UNICODE_STRING defaultFsVgaName;
00902 
00903     configuration = &amp;DeviceExtension-&gt;Configuration;
00904     parametersPath.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00905 
00906     <span class="comment">//</span>
00907     <span class="comment">// Registry path is already null-terminated, so just use it.</span>
00908     <span class="comment">//</span>
00909 
00910     <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> = RegistryPath-&gt;Buffer;
00911 
00912     <span class="comment">//</span>
00913     <span class="comment">// Allocate the Rtl query table.</span>
00914     <span class="comment">//</span>
00915 
00916     parameters = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00917                                 <span class="keyword">sizeof</span>(RTL_QUERY_REGISTRY_TABLE) * queriesPlusOne);
00918     <span class="keywordflow">if</span> (!parameters)
00919     {
00920         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00921                     <span class="stringliteral">"FSVGA-FsVgaServiceParameters: Couldn't allocate table for Rtl query to parameters for %ws\n"</span>,
00922                     <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>));
00923         status = STATUS_UNSUCCESSFUL;
00924     }
00925     <span class="keywordflow">else</span>
00926     {
00927         RtlZeroMemory(parameters,
00928                       <span class="keyword">sizeof</span>(RTL_QUERY_REGISTRY_TABLE) * queriesPlusOne);
00929 
00930         <span class="comment">//</span>
00931         <span class="comment">// Form a path to this driver's Parameters subkey.</span>
00932         <span class="comment">//</span>
00933 
00934         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;parametersPath,
00935                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00936 
00937         parametersPath.MaximumLength = RegistryPath-&gt;Length +
00938                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Parameters"</span>);
00939         parametersPath.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00940                                                parametersPath.MaximumLength);
00941         <span class="keywordflow">if</span> (!parametersPath.Buffer)
00942         {
00943             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00944                         <span class="stringliteral">"FSVGA-FsVgaServiceParameters: Couldn't allocate string for path to parameters for %ws\n"</span>,
00945                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>));
00946             status = STATUS_UNSUCCESSFUL;
00947         }
00948     }
00949 
00950     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00951     {
00952         <span class="comment">//</span>
00953         <span class="comment">// Form the parameters path.</span>
00954         <span class="comment">//</span>
00955         RtlZeroMemory(parametersPath.Buffer,
00956                       parametersPath.MaximumLength);
00957         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;parametersPath,
00958                                  <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>);
00959         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;parametersPath,
00960                                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Parameters"</span>);
00961 
00962         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00963                     <span class="stringliteral">"FsVga-FsVgaServiceParameters: parameters path is %ws\n"</span>,
00964                     parametersPath.Buffer));
00965 
00966         <span class="comment">//</span>
00967         <span class="comment">// Gather all of the "user specified" information from</span>
00968         <span class="comment">// the registry.</span>
00969         <span class="comment">//</span>
00970         parameters[0].Flags = RTL_QUERY_REGISTRY_DIRECT;
00971         parameters[0].Name = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ConsoleFullScreen.EmulationMode"</span>;
00972         parameters[0].EntryContext = &amp;EmulationMode;
00973         parameters[0].DefaultType = REG_DWORD;
00974         parameters[0].DefaultData = &amp;defaultEmulationMode;
00975         parameters[0].DefaultLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>);
00976 
00977         parameters[1].Flags = RTL_QUERY_REGISTRY_DIRECT;
00978         parameters[1].Name = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ConsoleFullScreen.HardwareCursor"</span>;
00979         parameters[1].EntryContext = &amp;HardwareCursor;
00980         parameters[1].DefaultType = REG_DWORD;
00981         parameters[1].DefaultData = &amp;defaultHardwareCursor;
00982         parameters[1].DefaultLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>);
00983 
00984         parameters[2].Flags = RTL_QUERY_REGISTRY_DIRECT;
00985         parameters[2].Name = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ConsoleFullScreen.HardwareScroll"</span>;
00986         parameters[2].EntryContext = &amp;HardwareScroll;
00987         parameters[2].DefaultType = REG_DWORD;
00988         parameters[2].DefaultData = &amp;defaultHardwareScroll;
00989         parameters[2].DefaultLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>);
00990 
00991         status = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_ABSOLUTE | RTL_REGISTRY_OPTIONAL,
00992                                         parametersPath.Buffer,
00993                                         parameters,
00994                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00995                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00996         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00997         {
00998             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
00999                         <span class="stringliteral">"FsVga-FsVgaServiceParameters: RtlQueryRegistryValues failed with 0x%x\n"</span>,
01000                         status));
01001         }
01002     }
01003 
01004     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01005     {
01006         <span class="comment">//</span>
01007         <span class="comment">// Go ahead and assign driver defaults.</span>
01008         <span class="comment">//</span>
01009         configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o0">EmulationMode</a> = defaultEmulationMode;
01010         configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o1">HardwareCursor</a> = defaultHardwareCursor;
01011         configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o2">HardwareScroll</a> = defaultHardwareScroll;
01012     }
01013     <span class="keywordflow">else</span>
01014     {
01015         configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o0">EmulationMode</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)EmulationMode;
01016         configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o1">HardwareCursor</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)HardwareCursor;
01017         configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o2">HardwareScroll</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)HardwareScroll;
01018     }
01019 
01020     <span class="comment">//</span>
01021     <span class="comment">// Form the default port device names, in case they are not</span>
01022     <span class="comment">// specified in the registry.</span>
01023     <span class="comment">//</span>
01024 
01025     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;defaultFsVgaName,
01026                          DD_FULLSCREEN_PORT_BASE_NAME_U);
01027     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(FsVgaDeviceName, &amp;defaultFsVgaName);
01028 
01029     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
01030                 <span class="stringliteral">"FsVga-FsVgaServiceParameters: Full Screen Video port base name = %ws\n"</span>,
01031                 FsVgaDeviceName-&gt;Buffer));
01032 
01033     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
01034                 <span class="stringliteral">"FsVga-FsVgaServiceParameters: Emulation Mode = %d\n"</span>,
01035                 configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o0">EmulationMode</a>));
01036 
01037     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
01038                 <span class="stringliteral">"FsVga-FsVgaServiceParameters: Hardware Cursor = %d\n"</span>,
01039                 configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o1">HardwareCursor</a>));
01040 
01041     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
01042                 <span class="stringliteral">"FsVga-FsVgaServiceParameters: Hardware Scroll = %d\n"</span>,
01043                 configuration-&gt;<a class="code" href="../../d3/d1/struct__FSVGA__CONFIGURATION__INFORMATION.html#o2">HardwareScroll</a>));
01044 
01045     <span class="comment">//</span>
01046     <span class="comment">// Free the allocated memory before returning.</span>
01047     <span class="comment">//</span>
01048 
01049     <span class="keywordflow">if</span> (parametersPath.Buffer)
01050         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(parametersPath.Buffer);
01051     <span class="keywordflow">if</span> (parameters)
01052         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(parameters);
01053 }
01054 
01055 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01056"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a27">01056</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a27">FsVgaBuildResourceList</a>(
01057     IN <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
01058     OUT PCM_RESOURCE_LIST *ResourceList,
01059     OUT PULONG ResourceListSize
01060     )
01061 
01062 <span class="comment">/*++</span>
01063 <span class="comment"></span>
01064 <span class="comment">Routine Description:</span>
01065 <span class="comment"></span>
01066 <span class="comment">    Creates a resource list that is used to query or report resource usage.</span>
01067 <span class="comment"></span>
01068 <span class="comment">Arguments:</span>
01069 <span class="comment"></span>
01070 <span class="comment">    DeviceExtension - Pointer to the port's device extension.</span>
01071 <span class="comment"></span>
01072 <span class="comment">    ResourceList - Pointer to a pointer to the resource list to be allocated</span>
01073 <span class="comment">        and filled.</span>
01074 <span class="comment"></span>
01075 <span class="comment">    ResourceListSize - Pointer to the returned size of the resource</span>
01076 <span class="comment">        list (in bytes).</span>
01077 <span class="comment"></span>
01078 <span class="comment">Return Value:</span>
01079 <span class="comment"></span>
01080 <span class="comment">    None.  If the call succeeded, *ResourceList points to the built</span>
01081 <span class="comment">    resource list and *ResourceListSize is set to the size (in bytes)</span>
01082 <span class="comment">    of the resource list; otherwise, *ResourceList is NULL.</span>
01083 <span class="comment"></span>
01084 <span class="comment">Note:</span>
01085 <span class="comment"></span>
01086 <span class="comment">    Memory may be allocated here for *ResourceList. It must be</span>
01087 <span class="comment">    freed up by the caller, by calling ExFreePool();</span>
01088 <span class="comment"></span>
01089 <span class="comment">--*/</span>
01090 
01091 {
01092     ULONG count = 0;
01093     ULONG i = 0;
01094     ULONG j = 0;
01095 <span class="preprocessor">#define DUMP_COUNT 4</span>
01096 <span class="preprocessor"></span>    ULONG dumpData[<a class="code" href="../../d6/d8/fsvga_8c.html#a1">DUMP_COUNT</a>];
01097 
01098     count += DeviceExtension-&gt;Configuration.PortListCount;
01099 
01100     *ResourceListSize = <span class="keyword">sizeof</span>(CM_RESOURCE_LIST) +
01101                        ((count - 1) * <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR));
01102 
01103     *ResourceList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01104                                                        *ResourceListSize);
01105 
01106     <span class="comment">//</span>
01107     <span class="comment">// Return NULL if the structure could not be allocated.</span>
01108     <span class="comment">// Otherwise, fill in the resource list.</span>
01109     <span class="comment">//</span>
01110 
01111     <span class="keywordflow">if</span> (!*ResourceList) {
01112 
01113         <span class="comment">//</span>
01114         <span class="comment">// Could not allocate memory for the resource list.</span>
01115         <span class="comment">//</span>
01116 
01117         <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
01118                     <span class="stringliteral">"FSVGA-FsVgaBuildResourceList: Could not allocate resource list\n"</span>));
01119 
01120         <span class="comment">//</span>
01121         <span class="comment">// Log an error.</span>
01122         <span class="comment">//</span>
01123 
01124         dumpData[0] = *ResourceListSize;
01125         *ResourceListSize = 0;
01126 
01127         <a class="code" href="../../d7/d8/fsvga_8h.html#a37">FsVgaLogError</a>(DeviceExtension-&gt;DeviceObject,
01128                       FSVGA_INSUFFICIENT_RESOURCES,
01129                       <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 110,
01130                       STATUS_INSUFFICIENT_RESOURCES,
01131                       dumpData,
01132                       1
01133                      );
01134 
01135         <span class="keywordflow">return</span>;
01136     }
01137 
01138     RtlZeroMemory(*ResourceList,
01139                   *ResourceListSize);
01140 
01141     <span class="comment">//</span>
01142     <span class="comment">// Concoct one full resource descriptor.</span>
01143     <span class="comment">//</span>
01144 
01145     (*ResourceList)-&gt;Count = 1;
01146 
01147     (*ResourceList)-&gt;List[0].InterfaceType =
01148         DeviceExtension-&gt;Configuration.InterfaceType;
01149     (*ResourceList)-&gt;List[0].BusNumber =
01150         DeviceExtension-&gt;Configuration.BusNumber;
01151 
01152     <span class="comment">//</span>
01153     <span class="comment">// Build the partial resource descriptors for port</span>
01154     <span class="comment">// resources from the saved values.</span>
01155     <span class="comment">//</span>
01156 
01157     (*ResourceList)-&gt;List[0].PartialResourceList.Count = count;
01158 
01159     <span class="keywordflow">for</span> (j = 0; j &lt; DeviceExtension-&gt;Configuration.PortListCount; j++) {
01160         (*ResourceList)-&gt;List[0].PartialResourceList.PartialDescriptors[i++] =
01161             DeviceExtension-&gt;Configuration.PortList[j];
01162     }
01163 
01164 }
01165 
01166 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01167"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a28">01167</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a28">FsVgaOpenCloseDispatch</a>(
01168     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
01169     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
01170     )
01171 
01172 <span class="comment">/*++</span>
01173 <span class="comment"></span>
01174 <span class="comment">Routine Description:</span>
01175 <span class="comment"></span>
01176 <span class="comment">    This is the dispatch routine for create/open and close requests.</span>
01177 <span class="comment">    These requests complete successfully.</span>
01178 <span class="comment"></span>
01179 <span class="comment">Arguments:</span>
01180 <span class="comment"></span>
01181 <span class="comment">    DeviceObject - Pointer to the device object.</span>
01182 <span class="comment"></span>
01183 <span class="comment">    Irp - Pointer to the request packet.</span>
01184 <span class="comment"></span>
01185 <span class="comment">Return Value:</span>
01186 <span class="comment"></span>
01187 <span class="comment">    Status is returned.</span>
01188 <span class="comment"></span>
01189 <span class="comment">--*/</span>
01190 
01191 {
01192     UNREFERENCED_PARAMETER(DeviceObject);
01193 
01194     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((3,<span class="stringliteral">"FSVGA-FsVgaOpenCloseDispatch: enter\n"</span>));
01195 
01196     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01197 
01198     <span class="comment">//</span>
01199     <span class="comment">// Complete the request with successful status.</span>
01200     <span class="comment">//</span>
01201 
01202     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
01203     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
01204     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a>);
01205 
01206     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((3,<span class="stringliteral">"FSVGA-FsVgaOpenCloseDispatch: exit\n"</span>));
01207 
01208     <span class="keywordflow">return</span>(STATUS_SUCCESS);
01209 
01210 }
01211 
01212 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01213"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a29">01213</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a29">FsVgaDeviceControl</a>(
01214     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
01215     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
01216     )
01217 
01218 <span class="comment">/*++</span>
01219 <span class="comment"></span>
01220 <span class="comment">Routine Description:</span>
01221 <span class="comment"></span>
01222 <span class="comment">    This routine is the dispatch routine for device control requests.</span>
01223 <span class="comment"></span>
01224 <span class="comment">Arguments:</span>
01225 <span class="comment"></span>
01226 <span class="comment">    DeviceObject - Pointer to the device object.</span>
01227 <span class="comment"></span>
01228 <span class="comment">    Irp - Pointer to the request packet.</span>
01229 <span class="comment"></span>
01230 <span class="comment">Return Value:</span>
01231 <span class="comment"></span>
01232 <span class="comment">    Status is returned.</span>
01233 <span class="comment"></span>
01234 <span class="comment">--*/</span>
01235 
01236 {
01237     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
01238     PVOID ioBuffer;
01239     ULONG inputBufferLength;
01240     ULONG outputBufferLength;
01241     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
01242     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01243 
01244     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2,<span class="stringliteral">"FSVGA-FsVgaDeviceControl: enter\n"</span>));
01245 
01246     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01247 
01248     <span class="comment">//</span>
01249     <span class="comment">// Get a pointer to the device extension.</span>
01250     <span class="comment">//</span>
01251 
01252     deviceExtension = DeviceObject-&gt;DeviceExtension;
01253 
01254     <span class="comment">//</span>
01255     <span class="comment">// Initialize the returned Information field.</span>
01256     <span class="comment">//</span>
01257 
01258     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
01259 
01260     <span class="comment">//</span>
01261     <span class="comment">// Get a pointer to the current parameters for this request.  The</span>
01262     <span class="comment">// information is contained in the current stack location.</span>
01263     <span class="comment">//</span>
01264 
01265     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>);
01266 
01267     <span class="comment">//</span>
01268     <span class="comment">// Get the pointer to the input/output buffer and it's length</span>
01269     <span class="comment">//</span>
01270 
01271     ioBuffer = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
01272     inputBufferLength = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.InputBufferLength;
01273     outputBufferLength = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.OutputBufferLength;
01274 
01275     <span class="comment">//</span>
01276     <span class="comment">// Case on the device control subfunction that is being performed by the</span>
01277     <span class="comment">// requestor.</span>
01278     <span class="comment">//</span>
01279 
01280     <span class="keywordflow">switch</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode)
01281     {
01282         <span class="keywordflow">case</span> IOCTL_FSVIDEO_COPY_FRAME_BUFFER:
01283             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2, <span class="stringliteral">"FsVgaDeviceControl - CopyFrameBuffer\n"</span>));
01284             status = <a class="code" href="../../d7/d8/fsvga_8h.html#a30">FsVgaCopyFrameBuffer</a>(deviceExtension,
01285                                           (PFSVIDEO_COPY_FRAME_BUFFER) ioBuffer,
01286                                           inputBufferLength);
01287             <span class="keywordflow">break</span>;
01288 
01289         <span class="keywordflow">case</span> IOCTL_FSVIDEO_WRITE_TO_FRAME_BUFFER:
01290             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2, <span class="stringliteral">"FsVgaDeviceControl - WriteToFrameBuffer\n"</span>));
01291             status = <a class="code" href="../../d7/d8/fsvga_8h.html#a31">FsVgaWriteToFrameBuffer</a>(deviceExtension,
01292                                              (PFSVIDEO_WRITE_TO_FRAME_BUFFER) ioBuffer,
01293                                              inputBufferLength);
01294             <span class="keywordflow">break</span>;
01295 
01296         <span class="keywordflow">case</span> IOCTL_FSVIDEO_REVERSE_MOUSE_POINTER:
01297             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2, <span class="stringliteral">"FsVgaDeviceControl - ReverseMousePointer\n"</span>));
01298             status = <a class="code" href="../../d7/d8/fsvga_8h.html#a32">FsVgaReverseMousePointer</a>(deviceExtension,
01299                                               (PFSVIDEO_REVERSE_MOUSE_POINTER) ioBuffer,
01300                                               inputBufferLength);
01301             <span class="keywordflow">break</span>;
01302 
01303         <span class="keywordflow">case</span> IOCTL_FSVIDEO_SET_CURRENT_MODE:
01304             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2, <span class="stringliteral">"FsVgaDeviceControl - SetCurrentModes\n"</span>));
01305             status = <a class="code" href="../../d7/d8/fsvga_8h.html#a33">FsVgaSetMode</a>(deviceExtension,
01306                                   (PFSVIDEO_MODE_INFORMATION) ioBuffer,
01307                                   inputBufferLength);
01308             <span class="keywordflow">break</span>;
01309 
01310         <span class="keywordflow">case</span> IOCTL_FSVIDEO_SET_SCREEN_INFORMATION:
01311             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2, <span class="stringliteral">"FsVgaDeviceControl - SetScreenInformation\n"</span>));
01312             status = <a class="code" href="../../d7/d8/fsvga_8h.html#a34">FsVgaSetScreenInformation</a>(deviceExtension,
01313                                                (PFSVIDEO_SCREEN_INFORMATION) ioBuffer,
01314                                                inputBufferLength);
01315             <span class="keywordflow">break</span>;
01316 
01317         <span class="keywordflow">case</span> IOCTL_FSVIDEO_SET_CURSOR_POSITION:
01318             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2, <span class="stringliteral">"FsVgaDeviceControl - SetCursorPosition\n"</span>));
01319             status = <a class="code" href="../../d7/d8/fsvga_8h.html#a35">FsVgaSetCursorPosition</a>(deviceExtension,
01320                                             (PFSVIDEO_CURSOR_POSITION) ioBuffer,
01321                                             inputBufferLength);
01322             <span class="keywordflow">break</span>;
01323 
01324         <span class="keywordflow">case</span> IOCTL_VIDEO_SET_CURSOR_ATTR:
01325             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2, <span class="stringliteral">"FsVgaDeviceControl - SetCursorAttribute\n"</span>));
01326             status = <a class="code" href="../../d7/d8/fsvga_8h.html#a36">FsVgaSetCursorAttribute</a>(deviceExtension,
01327                                              (PVIDEO_CURSOR_ATTRIBUTES) ioBuffer,
01328                                              inputBufferLength);
01329             <span class="keywordflow">break</span>;
01330 
01331         <span class="keywordflow">default</span>:
01332             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
01333                         <span class="stringliteral">"FSVGA-FsVgaDeviceControl: INVALID REQUEST (0x%x)\n"</span>,
01334                         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode));
01335 
01336             status = STATUS_INVALID_DEVICE_REQUEST;
01337             <span class="keywordflow">break</span>;
01338     }
01339 
01340     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
01341     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a>);
01342 
01343     <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((2,<span class="stringliteral">"FSVGA-FsVgaDeviceControl: exit\n"</span>));
01344 
01345     <span class="keywordflow">return</span>(status);
01346 }
01347 
01348 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01349"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a30">01349</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a30">FsVgaCopyFrameBuffer</a>(
01350     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
01351     PFSVIDEO_COPY_FRAME_BUFFER CopyFrameBuffer,
01352     ULONG inputBufferLength
01353     )
01354 
01355 <span class="comment">/*++</span>
01356 <span class="comment"></span>
01357 <span class="comment">Routine Description:</span>
01358 <span class="comment"></span>
01359 <span class="comment">    This routine copy the frame buffer.</span>
01360 <span class="comment"></span>
01361 <span class="comment">Arguments:</span>
01362 <span class="comment"></span>
01363 <span class="comment">    DeviceExtension - Pointer to the miniport driver's device extension.</span>
01364 <span class="comment"></span>
01365 <span class="comment">    CopyFrameBuffer - Pointer to the structure containing the information about the copy frame buffer.</span>
01366 <span class="comment"></span>
01367 <span class="comment">    inputBufferLength - Length of the input buffer supplied by the user.</span>
01368 <span class="comment"></span>
01369 <span class="comment">Return Value:</span>
01370 <span class="comment"></span>
01371 <span class="comment">    STATUS_INSUFFICIENT_BUFFER if the input buffer was not large enough</span>
01372 <span class="comment">        for the input data.</span>
01373 <span class="comment"></span>
01374 <span class="comment">    STATUS_SUCCESS if the operation completed successfully.</span>
01375 <span class="comment"></span>
01376 <span class="comment">--*/</span>
01377 
01378 {
01379     <span class="comment">//</span>
01380     <span class="comment">// Check if the size of the data in the input buffer is large enough.</span>
01381     <span class="comment">//</span>
01382 
01383     <span class="keywordflow">if</span> (inputBufferLength &lt; <span class="keyword">sizeof</span>(FSVIDEO_COPY_FRAME_BUFFER)) {
01384         <span class="keywordflow">return</span> STATUS_INVALID_BUFFER_SIZE;
01385     }
01386 
01387     <span class="keywordflow">if</span> (CopyFrameBuffer-&gt;SrcScreen.nNumberOfChars != CopyFrameBuffer-&gt;DestScreen.nNumberOfChars) {
01388         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01389     }
01390 
01391     <span class="keywordflow">if</span> (! (DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMode.AttributeFlags &amp; VIDEO_MODE_GRAPHICS))
01392     {
01393         <span class="comment">/*</span>
01394 <span class="comment">         * This is the TEXT frame buffer.</span>
01395 <span class="comment">         */</span>
01396 
01397         ULONG OffsSrc;
01398         ULONG OffsDest;
01399         PUCHAR pFrameBuf = DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMemory.FrameBufferBase;
01400 
01401         OffsSrc = <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(CopyFrameBuffer-&gt;SrcScreen.Position.X,
01402                                         CopyFrameBuffer-&gt;SrcScreen.Position.Y,
01403                                         CopyFrameBuffer-&gt;SrcScreen.ScreenSize.X,
01404                                         <span class="keyword">sizeof</span>(VGA_CHAR));
01405 
01406         OffsDest = <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(CopyFrameBuffer-&gt;DestScreen.Position.X,
01407                                          CopyFrameBuffer-&gt;DestScreen.Position.Y,
01408                                          CopyFrameBuffer-&gt;DestScreen.ScreenSize.X,
01409                                          <span class="keyword">sizeof</span>(VGA_CHAR));
01410 
01411         RtlMoveMemory(pFrameBuf + OffsDest,
01412                       pFrameBuf + OffsSrc,
01413                       CopyFrameBuffer-&gt;SrcScreen.nNumberOfChars * <span class="keyword">sizeof</span>(VGA_CHAR));
01414     }
01415     <span class="keywordflow">else</span>
01416     {
01417         <span class="comment">/*</span>
01418 <span class="comment">         * This is the GRAPHICS frame buffer.</span>
01419 <span class="comment">         */</span>
01420         <span class="keywordflow">return</span> <a class="code" href="../../d7/d8/fsvga_8h.html#a46">FsgCopyFrameBuffer</a>(DeviceExtension,
01421                                   CopyFrameBuffer,
01422                                   inputBufferLength);
01423     }
01424 
01425     <span class="keywordflow">return</span> STATUS_SUCCESS;
01426 }
01427 
01428 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01429"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a31">01429</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a31">FsVgaWriteToFrameBuffer</a>(
01430     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
01431     PFSVIDEO_WRITE_TO_FRAME_BUFFER WriteFrameBuffer,
01432     ULONG inputBufferLength
01433     )
01434 
01435 <span class="comment">/*++</span>
01436 <span class="comment"></span>
01437 <span class="comment">Routine Description:</span>
01438 <span class="comment"></span>
01439 <span class="comment">    This routine write the frame buffer.</span>
01440 <span class="comment"></span>
01441 <span class="comment">Arguments:</span>
01442 <span class="comment"></span>
01443 <span class="comment">    DeviceExtension - Pointer to the miniport driver's device extension.</span>
01444 <span class="comment"></span>
01445 <span class="comment">    WriteFrameBuffer - Pointer to the structure containing the information about the write frame buffer.</span>
01446 <span class="comment"></span>
01447 <span class="comment">    inputBufferLength - Length of the input buffer supplied by the user.</span>
01448 <span class="comment"></span>
01449 <span class="comment">Return Value:</span>
01450 <span class="comment"></span>
01451 <span class="comment">    STATUS_INSUFFICIENT_BUFFER if the input buffer was not large enough</span>
01452 <span class="comment">        for the input data.</span>
01453 <span class="comment"></span>
01454 <span class="comment">    STATUS_SUCCESS if the operation completed successfully.</span>
01455 <span class="comment"></span>
01456 <span class="comment">--*/</span>
01457 
01458 {
01459     <span class="comment">//</span>
01460     <span class="comment">// Check if the size of the data in the input buffer is large enough.</span>
01461     <span class="comment">//</span>
01462 
01463     <span class="keywordflow">if</span> (inputBufferLength &lt; <span class="keyword">sizeof</span>(FSVIDEO_WRITE_TO_FRAME_BUFFER)) {
01464         <span class="keywordflow">return</span> STATUS_INVALID_BUFFER_SIZE;
01465     }
01466 
01467     <span class="keywordflow">if</span> (WriteFrameBuffer-&gt;DestScreen.Position.X &lt; 0 ||
01468         WriteFrameBuffer-&gt;DestScreen.Position.X &gt; DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o51">ScreenAndFont</a>.ScreenSize.X ||
01469         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(WriteFrameBuffer-&gt;DestScreen.Position.X +
01470                 WriteFrameBuffer-&gt;DestScreen.nNumberOfChars)
01471                                                 &gt; DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o51">ScreenAndFont</a>.ScreenSize.X ||
01472         WriteFrameBuffer-&gt;DestScreen.Position.Y &lt; 0 ||
01473         WriteFrameBuffer-&gt;DestScreen.Position.Y &gt; DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o51">ScreenAndFont</a>.ScreenSize.Y) {
01474         <span class="keywordflow">return</span> STATUS_INVALID_BUFFER_SIZE;
01475     }
01476 
01477     <span class="keywordflow">if</span> (! (DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMode.AttributeFlags &amp; VIDEO_MODE_GRAPHICS))
01478     {
01479         <span class="comment">/*</span>
01480 <span class="comment">         * This is the TEXT frame buffer.</span>
01481 <span class="comment">         */</span>
01482 
01483         ULONG Offs;
01484         PUCHAR pFrameBuf = DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMemory.FrameBufferBase;
01485         PCHAR_IMAGE_INFO pCharInfoUni = WriteFrameBuffer-&gt;SrcBuffer;
01486         PCHAR_IMAGE_INFO pCharInfoAsc;
01487         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length = WriteFrameBuffer-&gt;DestScreen.nNumberOfChars;
01488         PVOID pCapBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01489         ULONG cCapBuffer = 0;
01490 
01491         Offs = <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(WriteFrameBuffer-&gt;DestScreen.Position.X,
01492                                      WriteFrameBuffer-&gt;DestScreen.Position.Y,
01493                                      WriteFrameBuffer-&gt;DestScreen.ScreenSize.X,
01494                                      <span class="keyword">sizeof</span>(VGA_CHAR));
01495 
01496         cCapBuffer = Length * <span class="keyword">sizeof</span>(CHAR_IMAGE_INFO);
01497         pCapBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, cCapBuffer);
01498 
01499         <span class="keywordflow">if</span> (!pCapBuffer) {
01500 <span class="preprocessor">            #define DUMP_COUNT 4</span>
01501 <span class="preprocessor"></span>            ULONG dumpData[<a class="code" href="../../d6/d8/fsvga_8c.html#a1">DUMP_COUNT</a>];
01502 
01503             <a class="code" href="../../d7/d8/fsvga_8h.html#a10">FsVgaPrint</a>((1,
01504                         <span class="stringliteral">"FSVGA-FsVgaWriteToFrameBuffer: Could not allocate resource list\n"</span>));
01505             <span class="comment">//</span>
01506             <span class="comment">// Log an error.</span>
01507             <span class="comment">//</span>
01508             dumpData[0] = cCapBuffer;
01509             <a class="code" href="../../d7/d8/fsvga_8h.html#a37">FsVgaLogError</a>(DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o3">DeviceObject</a>,
01510                           FSVGA_INSUFFICIENT_RESOURCES,
01511                           <a class="code" href="../../d7/d8/fsvga_8h.html#a8">FSVGA_ERROR_VALUE_BASE</a> + 200,
01512                           STATUS_INSUFFICIENT_RESOURCES,
01513                           dumpData,
01514                           1
01515                          );
01516             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01517         }
01518 
01519         <a class="code" href="../../d3/d0/w32_2ntcon_2fullscr_2vga_2misc_8c.html#a1">TranslateOutputToOem</a>(pCapBuffer, pCharInfoUni, Length);
01520 
01521         pCharInfoAsc = pCapBuffer;
01522         pFrameBuf += Offs;
01523         <span class="keywordflow">while</span> (Length--)
01524         {
01525             *pFrameBuf++ = pCharInfoAsc-&gt;CharInfo.Char.AsciiChar;
01526             *pFrameBuf++ = (UCHAR) (pCharInfoAsc-&gt;CharInfo.Attributes);
01527             pCharInfoAsc++;
01528         }
01529 
01530         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pCapBuffer);
01531     }
01532     <span class="keywordflow">else</span>
01533     {
01534         <span class="comment">/*</span>
01535 <span class="comment">         * This is the GRAPHICS frame buffer.</span>
01536 <span class="comment">         */</span>
01537         <span class="keywordflow">return</span> <a class="code" href="../../d7/d8/fsvga_8h.html#a47">FsgWriteToFrameBuffer</a>(DeviceExtension,
01538                                      WriteFrameBuffer,
01539                                      inputBufferLength);
01540     }
01541 
01542     <span class="keywordflow">return</span> STATUS_SUCCESS;
01543 }
01544 
01545 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01546"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a32">01546</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a32">FsVgaReverseMousePointer</a>(
01547     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
01548     PFSVIDEO_REVERSE_MOUSE_POINTER MouseBuffer,
01549     ULONG inputBufferLength
01550     )
01551 
01552 <span class="comment">/*++</span>
01553 <span class="comment"></span>
01554 <span class="comment">Routine Description:</span>
01555 <span class="comment"></span>
01556 <span class="comment">    This routine reverse the frame buffer for mouse pointer.</span>
01557 <span class="comment"></span>
01558 <span class="comment">Arguments:</span>
01559 <span class="comment"></span>
01560 <span class="comment">    DeviceExtension - Pointer to the miniport driver's device extension.</span>
01561 <span class="comment"></span>
01562 <span class="comment">    MouseBuffer - Pointer to the structure containing the information about the mouse frame buffer.</span>
01563 <span class="comment"></span>
01564 <span class="comment">    inputBufferLength - Length of the input buffer supplied by the user.</span>
01565 <span class="comment"></span>
01566 <span class="comment">Return Value:</span>
01567 <span class="comment"></span>
01568 <span class="comment">    STATUS_INSUFFICIENT_BUFFER if the input buffer was not large enough</span>
01569 <span class="comment">        for the input data.</span>
01570 <span class="comment"></span>
01571 <span class="comment">    STATUS_SUCCESS if the operation completed successfully.</span>
01572 <span class="comment"></span>
01573 <span class="comment">--*/</span>
01574 
01575 {
01576     <span class="comment">//</span>
01577     <span class="comment">// Check if the size of the data in the input buffer is large enough.</span>
01578     <span class="comment">//</span>
01579 
01580     <span class="keywordflow">if</span> (inputBufferLength &lt; <span class="keyword">sizeof</span>(FSVIDEO_REVERSE_MOUSE_POINTER)) {
01581         <span class="keywordflow">return</span> STATUS_INVALID_BUFFER_SIZE;
01582     }
01583 
01584     <span class="keywordflow">if</span> (! (DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMode.AttributeFlags &amp; VIDEO_MODE_GRAPHICS))
01585     {
01586         <span class="comment">/*</span>
01587 <span class="comment">         * This is the TEXT frame buffer.</span>
01588 <span class="comment">         */</span>
01589 
01590         ULONG Offs;
01591         PUCHAR pFrameBuf = DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMemory.FrameBufferBase;
01592         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Attribute;
01593 
01594         Offs = <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(MouseBuffer-&gt;Screen.Position.X,
01595                                      MouseBuffer-&gt;Screen.Position.Y,
01596                                      MouseBuffer-&gt;Screen.ScreenSize.X,
01597                                      <span class="keyword">sizeof</span>(VGA_CHAR));
01598         pFrameBuf += Offs;
01599 
01600         Attribute =  (*(pFrameBuf + 1) &amp; 0xF0) &gt;&gt; 4;
01601         Attribute |= (*(pFrameBuf + 1) &amp; 0x0F) &lt;&lt; 4;
01602         *(pFrameBuf + 1) = Attribute;
01603     }
01604     <span class="keywordflow">else</span>
01605     {
01606         <span class="comment">/*</span>
01607 <span class="comment">         * This is the GRAPHICS frame buffer.</span>
01608 <span class="comment">         */</span>
01609         <span class="keywordflow">return</span> <a class="code" href="../../d7/d8/fsvga_8h.html#a48">FsgReverseMousePointer</a>(DeviceExtension,
01610                                       MouseBuffer,
01611                                       inputBufferLength);
01612     }
01613 
01614     <span class="keywordflow">return</span> STATUS_SUCCESS;
01615 }
01616 
01617 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01618"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a33">01618</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a33">FsVgaSetMode</a>(
01619     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
01620     PFSVIDEO_MODE_INFORMATION ModeInformation,
01621     ULONG inputBufferLength
01622     )
01623 
01624 <span class="comment">/*++</span>
01625 <span class="comment"></span>
01626 <span class="comment">Routine Description:</span>
01627 <span class="comment"></span>
01628 <span class="comment">    This routine sets the current video information.</span>
01629 <span class="comment"></span>
01630 <span class="comment">Arguments:</span>
01631 <span class="comment"></span>
01632 <span class="comment">    DeviceExtension - Pointer to the miniport driver's device extension.</span>
01633 <span class="comment"></span>
01634 <span class="comment">    ModeInformation - Pointer to the structure containing the information about the</span>
01635 <span class="comment">                      full screen video.</span>
01636 <span class="comment"></span>
01637 <span class="comment">    inputBufferLength - Length of the input buffer supplied by the user.</span>
01638 <span class="comment"></span>
01639 <span class="comment">Return Value:</span>
01640 <span class="comment"></span>
01641 <span class="comment">    STATUS_INSUFFICIENT_BUFFER if the input buffer was not large enough</span>
01642 <span class="comment">        for the input data.</span>
01643 <span class="comment"></span>
01644 <span class="comment">    STATUS_SUCCESS if the operation completed successfully.</span>
01645 <span class="comment"></span>
01646 <span class="comment">--*/</span>
01647 
01648 {
01649     <span class="comment">//</span>
01650     <span class="comment">// Check if the size of the data in the input buffer is large enough.</span>
01651     <span class="comment">//</span>
01652 
01653     <span class="keywordflow">if</span> (inputBufferLength &lt; <span class="keyword">sizeof</span>(FSVIDEO_MODE_INFORMATION)) {
01654         <span class="keywordflow">return</span> STATUS_INVALID_BUFFER_SIZE;
01655     }
01656 
01657     DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a> = *ModeInformation;
01658 
01659     <span class="keywordflow">return</span> STATUS_SUCCESS;
01660 }
01661 
01662 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01663"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a34">01663</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a34">FsVgaSetScreenInformation</a>(
01664     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
01665     PFSVIDEO_SCREEN_INFORMATION ScreenInformation,
01666     ULONG inputBufferLength
01667     )
01668 
01669 <span class="comment">/*++</span>
01670 <span class="comment"></span>
01671 <span class="comment">Routine Description:</span>
01672 <span class="comment"></span>
01673 <span class="comment">    This routine sets the screen and font information.</span>
01674 <span class="comment"></span>
01675 <span class="comment">Arguments:</span>
01676 <span class="comment"></span>
01677 <span class="comment">    DeviceExtension - Pointer to the miniport driver's device extension.</span>
01678 <span class="comment"></span>
01679 <span class="comment">    ScreenInformation - Pointer to the structure containing the information about the</span>
01680 <span class="comment">                        screen anf font.</span>
01681 <span class="comment"></span>
01682 <span class="comment">    inputBufferLength - Length of the input buffer supplied by the user.</span>
01683 <span class="comment"></span>
01684 <span class="comment">Return Value:</span>
01685 <span class="comment"></span>
01686 <span class="comment">    STATUS_INSUFFICIENT_BUFFER if the input buffer was not large enough</span>
01687 <span class="comment">        for the input data.</span>
01688 <span class="comment"></span>
01689 <span class="comment">    STATUS_SUCCESS if the operation completed successfully.</span>
01690 <span class="comment"></span>
01691 <span class="comment">--*/</span>
01692 
01693 {
01694     <span class="comment">//</span>
01695     <span class="comment">// Check if the size of the data in the input buffer is large enough.</span>
01696     <span class="comment">//</span>
01697 
01698     <span class="keywordflow">if</span> (inputBufferLength &lt; <span class="keyword">sizeof</span>(FSVIDEO_SCREEN_INFORMATION)) {
01699         <span class="keywordflow">return</span> STATUS_INVALID_BUFFER_SIZE;
01700     }
01701 
01702     DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o51">ScreenAndFont</a> = *ScreenInformation;
01703 
01704     <a class="code" href="../../d7/d8/fsvga_8h.html#a45">FsgVgaInitializeHWFlags</a>(DeviceExtension);
01705 
01706     <span class="keywordflow">return</span> STATUS_SUCCESS;
01707 }
01708 
01709 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01710"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a35">01710</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a35">FsVgaSetCursorPosition</a>(
01711     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
01712     PFSVIDEO_CURSOR_POSITION CursorPosition,
01713     ULONG inputBufferLength
01714     )
01715 
01716 <span class="comment">/*++</span>
01717 <span class="comment"></span>
01718 <span class="comment">Routine Description:</span>
01719 <span class="comment"></span>
01720 <span class="comment">    This routine sets the cursor position.</span>
01721 <span class="comment"></span>
01722 <span class="comment">Arguments:</span>
01723 <span class="comment"></span>
01724 <span class="comment">    DeviceExtension - Pointer to the miniport driver's device extension.</span>
01725 <span class="comment"></span>
01726 <span class="comment">    CursorPosition - Pointer to the structure containing the information about the</span>
01727 <span class="comment">                     cursor position.</span>
01728 <span class="comment"></span>
01729 <span class="comment">    inputBufferLength - Length of the input buffer supplied by the user.</span>
01730 <span class="comment"></span>
01731 <span class="comment">Return Value:</span>
01732 <span class="comment"></span>
01733 <span class="comment">    STATUS_INSUFFICIENT_BUFFER if the input buffer was not large enough</span>
01734 <span class="comment">        for the input data.</span>
01735 <span class="comment"></span>
01736 <span class="comment">    STATUS_SUCCESS if the operation completed successfully.</span>
01737 <span class="comment"></span>
01738 <span class="comment">--*/</span>
01739 
01740 {
01741     <span class="comment">//</span>
01742     <span class="comment">// Check if the size of the data in the input buffer is large enough.</span>
01743     <span class="comment">//</span>
01744 
01745     <span class="keywordflow">if</span> (inputBufferLength &lt; <span class="keyword">sizeof</span>(VIDEO_CURSOR_POSITION)) {
01746         <span class="keywordflow">return</span> STATUS_INVALID_BUFFER_SIZE;
01747     }
01748 
01749     <span class="keywordflow">if</span> (DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMode.AttributeFlags &amp; VIDEO_MODE_GRAPHICS)
01750     {
01751         <a class="code" href="../../d7/d8/fsvga_8h.html#a49">FsgInvertCursor</a>(DeviceExtension,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01752     }
01753 
01754     DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o52">EmulateInfo</a>.<a class="code" href="../../d1/d3/struct__EMULATE__BUFFER__INFORMATION.html#o10">CursorPosition</a> = *CursorPosition;
01755 
01756     <span class="keywordflow">if</span> (DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMode.AttributeFlags &amp; VIDEO_MODE_GRAPHICS)
01757     {
01758         <a class="code" href="../../d7/d8/fsvga_8h.html#a49">FsgInvertCursor</a>(DeviceExtension,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01759         <span class="keywordflow">return</span> STATUS_SUCCESS;
01760     }
01761     <span class="keywordflow">else</span>
01762     {
01763         <span class="comment">/*</span>
01764 <span class="comment">         * If current video mode is a TEXT MODE.</span>
01765 <span class="comment">         * FSVGA.SYS didn't handling hardware cursor</span>
01766 <span class="comment">         * because I don't know device of VGA.SYS or others.</span>
01767 <span class="comment">         *</span>
01768 <span class="comment">         * In this case, by returns STATUS_UNSUCCESSFUL, caller </span>
01769 <span class="comment">         * do DeviceIoControl to VGA miniport driver.</span>
01770 <span class="comment">         */</span>
01771         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01772     }
01773 }
01774 
01775 
01776 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01777"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a36">01777</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a36">FsVgaSetCursorAttribute</a>(
01778     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> DeviceExtension,
01779     PVIDEO_CURSOR_ATTRIBUTES CursorAttributes,
01780     ULONG inputBufferLength
01781     )
01782 
01783 <span class="comment">/*++</span>
01784 <span class="comment"></span>
01785 <span class="comment">Routine Description:</span>
01786 <span class="comment"></span>
01787 <span class="comment">    This routine sets the cursor attributes.</span>
01788 <span class="comment"></span>
01789 <span class="comment">Arguments:</span>
01790 <span class="comment"></span>
01791 <span class="comment">    DeviceExtension - Pointer to the miniport driver's device extension.</span>
01792 <span class="comment"></span>
01793 <span class="comment">    CursorAttributes - Pointer to the structure containing the information about the</span>
01794 <span class="comment">                       cursor attributes.</span>
01795 <span class="comment"></span>
01796 <span class="comment">    inputBufferLength - Length of the input buffer supplied by the user.</span>
01797 <span class="comment"></span>
01798 <span class="comment">Return Value:</span>
01799 <span class="comment"></span>
01800 <span class="comment">    STATUS_INSUFFICIENT_BUFFER if the input buffer was not large enough</span>
01801 <span class="comment">        for the input data.</span>
01802 <span class="comment"></span>
01803 <span class="comment">    STATUS_SUCCESS if the operation completed successfully.</span>
01804 <span class="comment"></span>
01805 <span class="comment">--*/</span>
01806 
01807 {
01808     <span class="comment">//</span>
01809     <span class="comment">// Check if the size of the data in the input buffer is large enough.</span>
01810     <span class="comment">//</span>
01811 
01812     <span class="keywordflow">if</span> (inputBufferLength &lt; <span class="keyword">sizeof</span>(VIDEO_CURSOR_ATTRIBUTES)) {
01813         <span class="keywordflow">return</span> STATUS_INVALID_BUFFER_SIZE;
01814     }
01815 
01816     <span class="keywordflow">if</span> (DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMode.AttributeFlags &amp; VIDEO_MODE_GRAPHICS)
01817     {
01818         <a class="code" href="../../d7/d8/fsvga_8h.html#a49">FsgInvertCursor</a>(DeviceExtension,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01819     }
01820 
01821     DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o52">EmulateInfo</a>.<a class="code" href="../../d1/d3/struct__EMULATE__BUFFER__INFORMATION.html#o9">CursorAttributes</a> = *CursorAttributes;
01822 
01823     <span class="keywordflow">if</span> (DeviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o50">CurrentMode</a>.VideoMode.AttributeFlags &amp; VIDEO_MODE_GRAPHICS)
01824     {
01825         <a class="code" href="../../d7/d8/fsvga_8h.html#a49">FsgInvertCursor</a>(DeviceExtension,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01826         <span class="keywordflow">return</span> STATUS_SUCCESS;
01827     }
01828     <span class="keywordflow">else</span>
01829     {
01830         <span class="comment">/*</span>
01831 <span class="comment">         * If current video mode is a TEXT MODE.</span>
01832 <span class="comment">         * FSVGA.SYS didn't handling hardware cursor</span>
01833 <span class="comment">         * because I don't know device of VGA.SYS or others.</span>
01834 <span class="comment">         *</span>
01835 <span class="comment">         * In this case, by returns STATUS_UNSUCCESSFUL, caller </span>
01836 <span class="comment">         * do DeviceIoControl to VGA miniport driver.</span>
01837 <span class="comment">         */</span>
01838         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01839     }
01840 }
01841 
01842 
01843 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01844"></a><a class="code" href="../../d7/d8/fsvga_8h.html#a37">01844</a> <a class="code" href="../../d7/d8/fsvga_8h.html#a37">FsVgaLogError</a>(
01845     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
01846     IN NTSTATUS ErrorCode,
01847     IN ULONG UniqueErrorValue,
01848     IN NTSTATUS FinalStatus,
01849     IN PULONG DumpData,
01850     IN ULONG DumpCount
01851     )
01852 
01853 <span class="comment">/*++</span>
01854 <span class="comment"></span>
01855 <span class="comment">Routine Description:</span>
01856 <span class="comment"></span>
01857 <span class="comment">    This routine contains common code to write an error log entry.  It is</span>
01858 <span class="comment">    called from other routines, especially FsVgaInitialize, to avoid</span>
01859 <span class="comment">    duplication of code.  Note that some routines continue to have their</span>
01860 <span class="comment">    own error logging code (especially in the case where the error logging</span>
01861 <span class="comment">    can be localized and/or the routine has more data because there is</span>
01862 <span class="comment">    and IRP).</span>
01863 <span class="comment"></span>
01864 <span class="comment">Arguments:</span>
01865 <span class="comment"></span>
01866 <span class="comment">    DeviceObject - Pointer to the device object.</span>
01867 <span class="comment"></span>
01868 <span class="comment">    ErrorCode - The error code for the error log packet.</span>
01869 <span class="comment"></span>
01870 <span class="comment">    UniqueErrorValue - The unique error value for the error log packet.</span>
01871 <span class="comment"></span>
01872 <span class="comment">    FinalStatus - The final status of the operation for the error log packet.</span>
01873 <span class="comment"></span>
01874 <span class="comment">    DumpData - Pointer to an array of dump data for the error log packet.</span>
01875 <span class="comment"></span>
01876 <span class="comment">    DumpCount - The number of entries in the dump data array.</span>
01877 <span class="comment"></span>
01878 <span class="comment"></span>
01879 <span class="comment">Return Value:</span>
01880 <span class="comment"></span>
01881 <span class="comment">    None.</span>
01882 <span class="comment"></span>
01883 <span class="comment">--*/</span>
01884 
01885 {
01886     PIO_ERROR_LOG_PACKET errorLogEntry;
01887     ULONG i;
01888 
01889     errorLogEntry = (PIO_ERROR_LOG_PACKET) <a class="code" href="../../d4/d6/iosubs_8c.html#a14">IoAllocateErrorLogEntry</a>(
01890                                                DeviceObject,
01891                                                (UCHAR)
01892                                                (<span class="keyword">sizeof</span>(IO_ERROR_LOG_PACKET)
01893                                                + (DumpCount * <span class="keyword">sizeof</span>(ULONG)))
01894                                                );
01895 
01896     <span class="keywordflow">if</span> (errorLogEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01897 
01898         errorLogEntry-&gt;ErrorCode = ErrorCode;
01899         errorLogEntry-&gt;DumpDataSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (DumpCount * <span class="keyword">sizeof</span>(ULONG));
01900         errorLogEntry-&gt;SequenceNumber = 0;
01901         errorLogEntry-&gt;MajorFunctionCode = 0;
01902         errorLogEntry-&gt;IoControlCode = 0;
01903         errorLogEntry-&gt;RetryCount = 0;
01904         errorLogEntry-&gt;UniqueErrorValue = UniqueErrorValue;
01905         errorLogEntry-&gt;FinalStatus = FinalStatus;
01906         <span class="keywordflow">for</span> (i = 0; i &lt; DumpCount; i++)
01907             errorLogEntry-&gt;DumpData[i] = DumpData[i];
01908 
01909         <a class="code" href="../../d4/d6/iosubs_8c.html#a123">IoWriteErrorLogEntry</a>(errorLogEntry);
01910     }
01911 }
01912 
01913 
01914 <span class="preprocessor">#if DBG</span>
01915 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01916 FsVgaDebugPrint(
01917     ULONG DebugPrintLevel,
01918     PCCHAR DebugMessage,
01919     ...
01920     )
01921 
01922 <span class="comment">/*++</span>
01923 <span class="comment"></span>
01924 <span class="comment">Routine Description:</span>
01925 <span class="comment"></span>
01926 <span class="comment">    Debug print routine.</span>
01927 <span class="comment"></span>
01928 <span class="comment">Arguments:</span>
01929 <span class="comment"></span>
01930 <span class="comment">    Debug print level between 0 and 3, with 3 being the most verbose.</span>
01931 <span class="comment"></span>
01932 <span class="comment">Return Value:</span>
01933 <span class="comment"></span>
01934 <span class="comment">    None.</span>
01935 <span class="comment"></span>
01936 <span class="comment">--*/</span>
01937 
01938 {
01939     va_list ap;
01940 
01941     va_start(ap, DebugMessage);
01942 
01943     <span class="keywordflow">if</span> (DebugPrintLevel &lt;= FsVgaDebug) {
01944 
01945         <span class="keywordtype">char</span> buffer[128];
01946 
01947         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) vsprintf(buffer, DebugMessage, ap);
01948 
01949         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(buffer);
01950     }
01951 
01952     va_end(ap);
01953 
01954 }
01955 <span class="preprocessor">#endif</span>
01956 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
