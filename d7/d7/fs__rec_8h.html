<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fs_rec.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fs_rec.h File Reference</h1><code>#include "ntifs.h"</code><br>
<code>#include "ntdddisk.h"</code><br>
<code>#include "ntddcdrm.h"</code><br>

<p>
<a href="../../d8/d6/fs__rec_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/struct__DEVICE__EXTENSION.html">_DEVICE_EXTENSION</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a0">FSREC_DEBUG_LEVEL_FSREC</a>&nbsp;&nbsp;&nbsp;0x00000001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a1">FSREC_DEBUG_LEVEL_NTFS</a>&nbsp;&nbsp;&nbsp;0x00000002</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a2">FSREC_DEBUG_LEVEL_CDFS</a>&nbsp;&nbsp;&nbsp;0x00000004</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a3">FSREC_DEBUG_LEVEL_UDFS</a>&nbsp;&nbsp;&nbsp;0x00000008</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a4">FSREC_DEBUG_LEVEL_FAT</a>&nbsp;&nbsp;&nbsp;0x00000010</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a5">FSREC_POOL_TAG</a>&nbsp;&nbsp;&nbsp;'crsF'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a6">SetFlag</a>(Flags, SingleFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a7">ClearFlag</a>(Flags, SingleFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a8">DebugTrace</a>(M)&nbsp;&nbsp;&nbsp;TRUE</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a38">_FILE_SYSTEM_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a9">FILE_SYSTEM_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a38">_FILE_SYSTEM_TYPE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a10">PFILE_SYSTEM_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a39">_RECOGNIZER_STATE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a11">RECOGNIZER_STATE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a39">_RECOGNIZER_STATE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a12">PRECOGNIZER_STATE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d3/struct__DEVICE__EXTENSION.html">_DEVICE_EXTENSION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a13">DEVICE_EXTENSION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d3/struct__DEVICE__EXTENSION.html">_DEVICE_EXTENSION</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a14">PDEVICE_EXTENSION</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a38">_FILE_SYSTEM_TYPE</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d7/d7/fs__rec_8h.html#a38a15">CdfsFileSystem</a> =  1, 
<a class="el" href="../../d7/d7/fs__rec_8h.html#a38a16">FatFileSystem</a>, 
<a class="el" href="../../d7/d7/fs__rec_8h.html#a38a17">HpfsFileSystem</a>, 
<a class="el" href="../../d7/d7/fs__rec_8h.html#a38a18">NtfsFileSystem</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d7/d7/fs__rec_8h.html#a38a19">UdfsFileSystem</a>
<br>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a39">_RECOGNIZER_STATE</a> { <a class="el" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>, 
<a class="el" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>, 
<a class="el" href="../../d7/d7/fs__rec_8h.html#a39a22">FastUnload</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a23">DriverEntry</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN PUNICODE_STRING RegistryPath)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a24">FsRecCleanupClose</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a25">FsRecCreate</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> HeadRecognizer OPTIONAL, OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *NewRecognizer OPTIONAL, IN PWCHAR RecFileSystem, IN PWCHAR FileSystemName, IN <a class="el" href="../../d7/d7/fs__rec_8h.html#a9">FILE_SYSTEM_TYPE</a> FileSystemType, IN DEVICE_TYPE DeviceType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a27">FsRecFsControl</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a28">FsRecUnload</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a29">FsRecLoadFileSystem</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PWCHAR DriverServiceKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a30">FsRecGetDeviceSectorSize</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT PULONG BytesPerSector)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a31">FsRecGetDeviceSectors</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG BytesPerSector, OUT PLARGE_INTEGER NumberOfSectors)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a32">FsRecReadBlock</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PLARGE_INTEGER ByteOffset, IN ULONG MinimumBytes, IN ULONG BytesPerSector, OUT PVOID *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT PBOOLEAN IsDeviceFailure OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a33">CdfsRecFsControl</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a34">UdfsRecFsControl</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a35">FatRecFsControl</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a36">NtfsRecFsControl</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver</a> (IN PUNICODE_STRING DriverServiceName)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a7" doxytag="fs_rec.h::ClearFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ClearFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Flags,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SingleFlag&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(   \
    (Flags) &amp;= ~(SingleFlag)            \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00047">47</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="fs_rec.h::DebugTrace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DebugTrace          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">M&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;TRUE</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00169">169</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="fs_rec.h::FSREC_DEBUG_LEVEL_CDFS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSREC_DEBUG_LEVEL_CDFS&nbsp;&nbsp;&nbsp;0x00000004          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00037">37</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="fs_rec.h::FSREC_DEBUG_LEVEL_FAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSREC_DEBUG_LEVEL_FAT&nbsp;&nbsp;&nbsp;0x00000010          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00039">39</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="fs_rec.h::FSREC_DEBUG_LEVEL_FSREC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSREC_DEBUG_LEVEL_FSREC&nbsp;&nbsp;&nbsp;0x00000001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00035">35</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="fs_rec.h::FSREC_DEBUG_LEVEL_NTFS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSREC_DEBUG_LEVEL_NTFS&nbsp;&nbsp;&nbsp;0x00000002          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00036">36</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="fs_rec.h::FSREC_DEBUG_LEVEL_UDFS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSREC_DEBUG_LEVEL_UDFS&nbsp;&nbsp;&nbsp;0x00000008          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00038">38</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="fs_rec.h::FSREC_POOL_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSREC_POOL_TAG&nbsp;&nbsp;&nbsp;'crsF'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00041">41</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, and <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00907">FsRecReadBlock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="fs_rec.h::SetFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SetFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Flags,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SingleFlag&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(     \
    (Flags) |= (SingleFlag)             \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00043">43</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a13" doxytag="fs_rec.h::DEVICE_EXTENSION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d3/struct__DEVICE__EXTENSION.html">_DEVICE_EXTENSION</a>  <a class="el" href="../../d8/d3/struct__DEVICE__EXTENSION.html">DEVICE_EXTENSION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d7/fsvga_8c-source.html#l00053">DriverEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="fs_rec.h::FILE_SYSTEM_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a38">_FILE_SYSTEM_TYPE</a>  <a class="el" href="../../d7/d7/fs__rec_8h.html#a9">FILE_SYSTEM_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00282">FsRecCreateAndRegisterDO()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="fs_rec.h::PDEVICE_EXTENSION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d3/struct__DEVICE__EXTENSION.html">_DEVICE_EXTENSION</a> * <a class="el" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00040">CdfsRecFsControl()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00658">MapperCallback()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01600">MapperConstructRootEnumTree()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01549">MapperFreeList()</a>, and <a class="el" href="../../d3/d4/mapper_8c-source.html#l02060">MapperPhantomizeDetectedComPorts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="fs_rec.h::PFILE_SYSTEM_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a38">_FILE_SYSTEM_TYPE</a> * <a class="el" href="../../d7/d7/fs__rec_8h.html#a10">PFILE_SYSTEM_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="fs_rec.h::PRECOGNIZER_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a39">_RECOGNIZER_STATE</a> * <a class="el" href="../../d7/d7/fs__rec_8h.html#a12">PRECOGNIZER_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="fs_rec.h::RECOGNIZER_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a39">_RECOGNIZER_STATE</a>  <a class="el" href="../../d7/d7/fs__rec_8h.html#a11">RECOGNIZER_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a38" doxytag="fs_rec.h::_FILE_SYSTEM_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a38">_FILE_SYSTEM_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a38a15" doxytag="CdfsFileSystem" ></a>CdfsFileSystem</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a38a16" doxytag="FatFileSystem" ></a>FatFileSystem</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a38a17" doxytag="HpfsFileSystem" ></a>HpfsFileSystem</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a38a18" doxytag="NtfsFileSystem" ></a>NtfsFileSystem</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a38a19" doxytag="UdfsFileSystem" ></a>UdfsFileSystem</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00055">55</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.
<p>
<pre class="fragment"><div>00055                                {
00056     <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a15">CdfsFileSystem</a> = 1,
00057     <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a16">FatFileSystem</a>,
00058     <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a17">HpfsFileSystem</a>,
00059     <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a18">NtfsFileSystem</a>,
00060     <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a19">UdfsFileSystem</a>
00061 } <a class="code" href="../../d7/d7/fs__rec_8h.html#a9">FILE_SYSTEM_TYPE</a>, *<a class="code" href="../../d7/d7/fs__rec_8h.html#a10">PFILE_SYSTEM_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="fs_rec.h::_RECOGNIZER_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d7/d7/fs__rec_8h.html#a39">_RECOGNIZER_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a39a20" doxytag="Active" ></a>Active</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a39a21" doxytag="Transparent" ></a>Transparent</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a39a22" doxytag="FastUnload" ></a>FastUnload</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00067">67</a> of file <a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>.
<p>
<pre class="fragment"><div>00067                                {
00068     <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>,
00069     <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>,
00070     <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a22">FastUnload</a>
00071 } <a class="code" href="../../d7/d7/fs__rec_8h.html#a11">RECOGNIZER_STATE</a>, *<a class="code" href="../../d7/d7/fs__rec_8h.html#a12">PRECOGNIZER_STATE</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a33" doxytag="fs_rec.h::CdfsRecFsControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CdfsRecFsControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00040">40</a> of file <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html">cdfs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">FsRecLoadFileSystem()</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00115">IRP_MN_LOAD_FILE_SYSTEM</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d7/fs__rec_8h.html#a14">PDEVICE_EXTENSION</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00446">FsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00047                    :
00048 
00049     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mount and driver reload <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <span class="keywordflow">for</span> <span class="keyword">this</span> mini-
00050     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer driver.
00051 
00052 Arguments:
00053 
00054     DeviceObject - Pointer to <span class="keyword">this</span> driver's device object.
00055 
00056     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the function to
00057         be performed.
00058 
00059 Return Value:
00060 
00061     The function value is the final status of the operation.
00062 
00063 
00064  -*/
00065 
00066 {
00067     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00068     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00069     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00070 
00071     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00072 
00073     <span class="comment">//</span>
00074     <span class="comment">// Begin by determining what function that is to be performed.</span>
00075     <span class="comment">//</span>
00076 
00077     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00078     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00079 
00080     <span class="keywordflow">switch</span> ( irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ) {
00081 
00082     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>:
00083 
00084         <span class="comment">//</span>
00085         <span class="comment">//  Always request the filesystem driver.</span>
00086         <span class="comment">//</span>
00087         
00088         status = STATUS_FS_DRIVER_REQUIRED;
00089         <span class="keywordflow">break</span>;
00090 
00091     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a49">IRP_MN_LOAD_FILE_SYSTEM</a>:
00092 
00093         status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a29">FsRecLoadFileSystem</a>( DeviceObject,
00094                                       L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Cdfs"</span> );
00095         <span class="keywordflow">break</span>;
00096 
00097     <span class="keywordflow">default</span>:
00098         
00099         status = STATUS_INVALID_DEVICE_REQUEST;
00100         <span class="keywordflow">break</span>;
00101     }
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">// Finally, complete the request and return the same status code to the</span>
00105     <span class="comment">// caller.</span>
00106     <span class="comment">//</span>
00107 
00108     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00109     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00110 
00111     <span class="keywordflow">return</span> status;
00112 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="fs_rec.h::DriverEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS DriverEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RegistryPath</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">67</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
<pre class="fragment"><div>00074                    :
00075 
00076     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked once when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> loaded to allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver
00077     to initialize itself.  The initialization <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver consists of simply
00078     creating a device object <span class="keywordflow">for</span> each <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognized by <span class="keyword">this</span>
00079     driver, and then registering each as active <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> systems.
00080 
00081 Arguments:
00082 
00083     DriverObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object <span class="keywordflow">for</span> <span class="keyword">this</span> driver.
00084 
00085     RegistryPath - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry service node <span class="keywordflow">for</span> <span class="keyword">this</span> driver.
00086 
00087 Return Value:
00088 
00089     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
00090 
00091 --*/
00092 
00093 {
00094     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> UdfsMainRecognizerDeviceObject;
00095     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00096     ULONG count = 0;
00097 
00098     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">// Mark the entire driver as pagable.</span>
00102     <span class="comment">//</span>
00103 
00104     <a class="code" href="../../d8/d8/sysload_8c.html#a56">MmPageEntireDriver</a> ((PVOID)DriverEntry);
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">// Begin by initializing the driver object so that it the driver is</span>
00108     <span class="comment">// prepared to provide services.</span>
00109     <span class="comment">//</span>
00110 
00111     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>] = <a class="code" href="../../d6/d7/fs__rec_8c.html#a7">FsRecFsControl</a>;
00112     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>] = <a class="code" href="../../d6/d7/fs__rec_8c.html#a5">FsRecCreate</a>;
00113     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a>] = <a class="code" href="../../d6/d7/fs__rec_8c.html#a4">FsRecCleanupClose</a>;
00114     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a>] = <a class="code" href="../../d6/d7/fs__rec_8c.html#a4">FsRecCleanupClose</a>;
00115     DriverObject-&gt;DriverUnload = <a class="code" href="../../d6/d7/fs__rec_8c.html#a8">FsRecUnload</a>;
00116 
00117     <a class="code" href="../../d6/d7/fs__rec_8c.html#a2">FsRecLoadSync</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>), FSREC_POOL_TAG );
00118 
00119     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a2">FsRecLoadSync</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00120 
00121         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00122     }
00123 
00124     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( FsRecLoadSync, SynchronizationEvent, TRUE );
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">// Create and initialize each of the file system driver type device</span>
00128     <span class="comment">// objects.</span>
00129     <span class="comment">//</span>
00130 
00131     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00132                                        NULL,
00133                                        NULL,
00134                                        L<span class="stringliteral">"\\Cdfs"</span>,
00135                                        L<span class="stringliteral">"\\FileSystem\\CdfsRecognizer"</span>,
00136                                        CdfsFileSystem,
00137                                        FILE_DEVICE_CD_ROM_FILE_SYSTEM );
00138     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00139         count++;
00140     }
00141 
00142     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00143                                        NULL,
00144                                        &amp;UdfsMainRecognizerDeviceObject,
00145                                        L<span class="stringliteral">"\\UdfsCdRom"</span>,
00146                                        L<span class="stringliteral">"\\FileSystem\\UdfsCdRomRecognizer"</span>,
00147                                        UdfsFileSystem,
00148                                        FILE_DEVICE_CD_ROM_FILE_SYSTEM );
00149     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00150         count++;
00151     }
00152 
00153     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00154                                        UdfsMainRecognizerDeviceObject,
00155                                        NULL,
00156                                        L<span class="stringliteral">"\\UdfsDisk"</span>,
00157                                        L<span class="stringliteral">"\\FileSystem\\UdfsDiskRecognizer"</span>,
00158                                        UdfsFileSystem,
00159                                        FILE_DEVICE_DISK_FILE_SYSTEM );
00160     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00161         count++;
00162     }
00163 
00164     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00165                                        NULL,
00166                                        NULL,
00167                                        L<span class="stringliteral">"\\Fat"</span>,
00168                                        L<span class="stringliteral">"\\FileSystem\\FatRecognizer"</span>,
00169                                        FatFileSystem,
00170                                        FILE_DEVICE_DISK_FILE_SYSTEM );
00171     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00172         count++;
00173     }
00174 
00175     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00176                                        NULL,
00177                                        NULL,
00178                                        L<span class="stringliteral">"\\Ntfs"</span>,
00179                                        L<span class="stringliteral">"\\FileSystem\\NtfsRecognizer"</span>,
00180                                        NtfsFileSystem,
00181                                        FILE_DEVICE_DISK_FILE_SYSTEM );
00182     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00183         count++;
00184     }
00185 
00186     <span class="keywordflow">if</span> (count) {
00187         <span class="keywordflow">return</span> STATUS_SUCCESS;
00188     } <span class="keywordflow">else</span> {
00189         <span class="keywordflow">return</span> STATUS_IMAGE_ALREADY_LOADED;
00190     }
00191 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="fs_rec.h::FatRecFsControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FatRecFsControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00043">43</a> of file <a class="el" href="../../d6/d0/fat__rec_8c-source.html">fat_rec.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01185">_DEVICE_OBJECT::Characteristics</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00800">FsRecGetDeviceSectorSize()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">FsRecLoadFileSystem()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00907">FsRecReadBlock()</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00115">IRP_MN_LOAD_FILE_SYSTEM</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00184">IsFatVolume()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00122">PPACKED_BOOT_SECTOR</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00446">FsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00050                    :
00051 
00052     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mount and driver reload <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <span class="keywordflow">for</span> <span class="keyword">this</span> mini-
00053     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer driver.
00054 
00055 Arguments:
00056 
00057     DeviceObject - Pointer to <span class="keyword">this</span> driver's device object.
00058 
00059     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the function to
00060         be performed.
00061 
00062 Return Value:
00063 
00064     The function value is the final status of the operation.
00065 
00066 
00067 --*/
00068 
00069 {
00070     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00071     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00072     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00073     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetDevice;
00074     <a class="code" href="../../d9/d7/struct__PACKED__BOOT__SECTOR.html">PPACKED_BOOT_SECTOR</a> buffer;
00075     LARGE_INTEGER byteOffset;
00076     UNICODE_STRING driverName;
00077     ULONG bytesPerSector;
00078     BOOLEAN isDeviceFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00079 
00080     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00081 
00082     <span class="comment">//</span>
00083     <span class="comment">// Begin by determining what function that is to be performed.</span>
00084     <span class="comment">//</span>
00085 
00086     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00087     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00088 
00089     <span class="keywordflow">switch</span> ( irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ) {
00090 
00091     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>:
00092 
00093         <span class="comment">//</span>
00094         <span class="comment">// Attempt to mount a volume:  Determine whether or not the volume in</span>
00095         <span class="comment">// question is a FAT volume and, if so, let the I/O system know that it</span>
00096         <span class="comment">// is by returning a special status code so that this driver can get</span>
00097         <span class="comment">// called back to load the FAT file system.</span>
00098         <span class="comment">//</span>
00099 
00100         status = STATUS_UNRECOGNIZED_VOLUME;
00101 
00102         <span class="comment">//</span>
00103         <span class="comment">// Attempt to determine whether or not the target volume being mounted</span>
00104         <span class="comment">// is a FAT volume.  Note that if an error occurs, and this is a floppy</span>
00105         <span class="comment">// drive, and the error occurred on the actual read from the device,</span>
00106         <span class="comment">// then the FAT file system will actually be loaded to handle the</span>
00107         <span class="comment">// problem since this driver is a place holder and does not need to</span>
00108         <span class="comment">// know all of the protocols for handling floppy errors.</span>
00109         <span class="comment">//</span>
00110 
00111         targetDevice = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.MountVolume.DeviceObject;
00112 
00113         <span class="comment">//</span>
00114         <span class="comment">//  First retrieve the sector size for this media.</span>
00115         <span class="comment">//</span>
00116 
00117         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a30">FsRecGetDeviceSectorSize</a>( targetDevice,
00118                                       &amp;bytesPerSector )) {
00119 
00120             byteOffset.QuadPart = 0;
00121             buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00122 
00123             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a32">FsRecReadBlock</a>( targetDevice,
00124                                 &amp;byteOffset,
00125                                 512,
00126                                 bytesPerSector,
00127                                 &amp;buffer,
00128                                 &amp;isDeviceFailure ) &amp;&amp;
00129                 <a class="code" href="../../d6/d1/fat__rec_8h.html#a15">IsFatVolume</a>( buffer )) {
00130                     
00131                 status = STATUS_FS_DRIVER_REQUIRED;
00132                 
00133             }
00134 
00135             <span class="keywordflow">if</span> (buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00136                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( buffer );
00137             }
00138             
00139          } <span class="keywordflow">else</span> {
00140 
00141              <span class="comment">//</span>
00142              <span class="comment">//  Devices that can't get us this much ...</span>
00143              <span class="comment">//</span>
00144 
00145              isDeviceFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00146          }
00147             
00148          <span class="comment">//</span>
00149          <span class="comment">//  See if we should make the real filesystem take a shot at a wacky floppy.</span>
00150          <span class="comment">//</span>
00151          
00152          <span class="keywordflow">if</span> (isDeviceFailure) {
00153              <span class="keywordflow">if</span> (targetDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o9">Characteristics</a> &amp; FILE_FLOPPY_DISKETTE) {
00154                  status = STATUS_FS_DRIVER_REQUIRED;
00155              }
00156          }
00157 
00158          <span class="keywordflow">break</span>;
00159 
00160     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a49">IRP_MN_LOAD_FILE_SYSTEM</a>:
00161 
00162         status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a29">FsRecLoadFileSystem</a>( DeviceObject,
00163                                       L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Fastfat"</span> );
00164         <span class="keywordflow">break</span>;
00165 
00166     <span class="keywordflow">default</span>:
00167         status = STATUS_INVALID_DEVICE_REQUEST;
00168 
00169     }
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">// Finally, complete the request and return the same status code to the</span>
00173     <span class="comment">// caller.</span>
00174     <span class="comment">//</span>
00175 
00176     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00177     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00178 
00179     <span class="keywordflow">return</span> status;
00180 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="fs_rec.h::FsRecCleanupClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRecCleanupClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00195">195</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
References <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>.
<p>
<pre class="fragment"><div>00202                    :
00203 
00204     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when someone attempts to cleanup or close one of
00205     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system recognizer's registered device objects.
00206 
00207 Arguments:
00208 
00209     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object being closed.
00210 
00211     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cleanup/close <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
00212 
00213 Return Value:
00214 
00215     The <span class="keyword">final</span> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> STATUS_SUCCESS.
00216 
00217 --*/
00218 
00219 {
00220     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">// Simply complete the request successfully (note that IoStatus.Status in</span>
00224     <span class="comment">// Irp is already initialized to STATUS_SUCCESS).</span>
00225     <span class="comment">//</span>
00226 
00227     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00228     <span class="keywordflow">return</span> STATUS_SUCCESS;
00229 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="fs_rec.h::FsRecCreate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRecCreate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00233">233</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>.
<p>
<pre class="fragment"><div>00240                    :
00241 
00242     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when someone attempts to open one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00243     system recognizer's registered device objects.
00244 
00245 Arguments:
00246 
00247     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object being opened.
00248 
00249     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> create <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
00250 
00251 Return Value:
00252 
00253     The <span class="keyword">final</span> function value indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open was successful.
00254 
00255 --*/
00256 
00257 {
00258     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00259     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00260 
00261     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// Simply ensure that the name of the "file" being opened is NULL, and</span>
00265     <span class="comment">// complete the request accordingly.</span>
00266     <span class="comment">//</span>
00267 
00268     <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length) {
00269         status = STATUS_OBJECT_PATH_NOT_FOUND;
00270     } <span class="keywordflow">else</span> {
00271         status = STATUS_SUCCESS;
00272     }
00273 
00274     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00275     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPENED;
00276     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00277     <span class="keywordflow">return</span> status;
00278 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="fs_rec.h::FsRecCreateAndRegisterDO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRecCreateAndRegisterDO           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> HeadRecognizer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *NewRecognizer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>RecFileSystem</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/fs__rec_8h.html#a9">FILE_SYSTEM_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSystemType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN DEVICE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00282">282</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>, <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00074">_DEVICE_EXTENSION::CoRecognizer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01187">_DEVICE_OBJECT::DeviceExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a9">FILE_SYSTEM_TYPE</a>, <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00075">_DEVICE_EXTENSION::FileSystemType</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09324">IoRegisterFileSystem()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00076">_DEVICE_EXTENSION::State</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00418">ZwCreateFile()</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>.
<p>
<pre class="fragment"><div>00294                    :
00295 
00296     This routine creates a device object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> and
00297     registers <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> as an active <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.
00298 
00299 Arguments:
00300 
00301     DriverObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object <span class="keywordflow">for</span> <span class="keyword">this</span> driver.
00302     
00303     HeadRecognizer - Optionally supplies a pre-existing recognizer that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00304         newly created DO should be jointly serialized and unregistered with.
00305         This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> useful <span class="keywordflow">if</span> a given filesystem exists on multiple device types
00306         and thus requires multiple recognizers.
00307     
00308     NewDeviceObject - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created DO on success..
00309 
00310     RecFileSystem - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system to be recognized.
00311 
00312     FileSystemName - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system device object to be registered.
00313 
00314     FileSystemType - Type of <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer device object.
00315     
00316     DeviceType - Type of media <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer device object will inspect.
00317 
00318 Return Value:
00319 
00320     The <span class="keyword">final</span> function value indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object was
00321     successfully created and registered.
00322 
00323 --*/
00324 
00325 {
00326     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00327     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00328     UNICODE_STRING nameString;
00329     OBJECT_ATTRIBUTES objectAttributes;
00330     HANDLE fsHandle;
00331     IO_STATUS_BLOCK ioStatus;
00332     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00333 
00334     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00335 
00336     <span class="keywordflow">if</span> (NewRecognizer) {
00337 
00338         *NewRecognizer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00339     }
00340 
00341     <span class="comment">//</span>
00342     <span class="comment">// Begin by attempting to open the file system driver's device object.  If</span>
00343     <span class="comment">// it works, then the file system is already loaded, so don't load this</span>
00344     <span class="comment">// driver.  Otherwise, this mini-driver is the one that should be loaded.</span>
00345     <span class="comment">//</span>
00346 
00347     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, RecFileSystem );
00348     InitializeObjectAttributes( &amp;objectAttributes,
00349                                 &amp;nameString,
00350                                 OBJ_CASE_INSENSITIVE,
00351                                 (HANDLE) NULL,
00352                                 (PSECURITY_DESCRIPTOR) NULL );
00353 
00354     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>( &amp;fsHandle,
00355                            SYNCHRONIZE,
00356                            &amp;objectAttributes,
00357                            &amp;ioStatus,
00358                            (PLARGE_INTEGER) NULL,
00359                            0,
00360                            FILE_SHARE_READ | FILE_SHARE_WRITE,
00361                            FILE_OPEN,
00362                            0,
00363                            (PVOID) NULL,
00364                            0 );
00365 
00366     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00367         ZwClose( fsHandle );
00368     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != STATUS_OBJECT_NAME_NOT_FOUND) {
00369         status = STATUS_SUCCESS;
00370     }
00371 
00372     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00373         <span class="keywordflow">return</span> STATUS_IMAGE_ALREADY_LOADED;
00374     }
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Attempt to create a device object for this driver.  This device object</span>
00378     <span class="comment">// will be used to represent the driver as an active file system in the</span>
00379     <span class="comment">// system.</span>
00380     <span class="comment">//</span>
00381 
00382     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, FileSystemName );
00383 
00384     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( DriverObject,
00385                              <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">DEVICE_EXTENSION</a> ),
00386                              &amp;nameString,
00387                              DeviceType,
00388                              0,
00389                              FALSE,
00390                              &amp;deviceObject );
00391     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00392         <span class="keywordflow">return</span> status;
00393     }
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Initialize the device extension for this device object.</span>
00397     <span class="comment">//</span>
00398 
00399     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o11">DeviceExtension</a>;
00400     deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o1">FileSystemType</a> = FileSystemType;
00401     deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> = <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>;
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  Is this a filesystem being jointly recognized by recognizers for</span>
00405     <span class="comment">//  different device types?</span>
00406     <span class="comment">//</span>
00407     
00408     <span class="keywordflow">if</span> (HeadRecognizer) {
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">//  Link into the list.</span>
00412         <span class="comment">//</span>
00413         
00414         deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o0">CoRecognizer</a> = ((<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>)HeadRecognizer-&gt;DeviceExtension)-&gt;CoRecognizer;
00415         ((<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>)HeadRecognizer-&gt;DeviceExtension)-&gt;CoRecognizer = deviceObject;
00416     
00417     } <span class="keywordflow">else</span> {
00418 
00419         <span class="comment">//</span>
00420         <span class="comment">//  Initialize the list of codependant recognizer objects.</span>
00421         <span class="comment">//</span>
00422         
00423         deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o0">CoRecognizer</a> = deviceObject;
00424     }
00425     
00426 <span class="preprocessor">#if _PNP_POWER_</span>
00427 <span class="preprocessor"></span>    deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;PowerControlNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00428 <span class="preprocessor">#endif</span>
00429 <span class="preprocessor"></span>
00430     <span class="comment">//</span>
00431     <span class="comment">// Finally, register this driver as an active, loaded file system and</span>
00432     <span class="comment">// return to the caller.</span>
00433     <span class="comment">//</span>
00434 
00435     <span class="keywordflow">if</span> (NewRecognizer) {
00436 
00437         *NewRecognizer = deviceObject;
00438     }
00439 
00440     <a class="code" href="../../d4/d6/iosubs_8c.html#a97">IoRegisterFileSystem</a>( deviceObject );
00441     <span class="keywordflow">return</span> STATUS_SUCCESS;
00442 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="fs_rec.h::FsRecFsControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRecFsControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00446">446</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a38a15">CdfsFileSystem</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00040">CdfsRecFsControl()</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a38a16">FatFileSystem</a>, <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00043">FatRecFsControl()</a>, <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00075">_DEVICE_EXTENSION::FileSystemType</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a38a18">NtfsFileSystem</a>, <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html#l00042">NtfsRecFsControl()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00076">_DEVICE_EXTENSION::State</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a38a19">UdfsFileSystem</a>, and <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00060">UdfsRecFsControl()</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>.
<p>
<pre class="fragment"><div>00453                    :
00454 
00455     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mount and driver reload <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <span class="keywordflow">for</span> <span class="keyword">this</span> mini-
00456     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer driver.
00457 
00458 Arguments:
00459 
00460     DeviceObject - Pointer to <span class="keyword">this</span> driver's device object.
00461 
00462     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the function to
00463         be performed.
00464 
00465 Return Value:
00466 
00467     The function value is the final status of the operation.
00468 
00469 
00470 --*/
00471 
00472 {
00473     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00474     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00475     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00476 
00477     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// Simply vector to the appropriate FS control function given the type</span>
00481     <span class="comment">// of file system being interrogated.</span>
00482     <span class="comment">//</span>
00483 
00484     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00485     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00486 
00487     <span class="comment">//</span>
00488     <span class="comment">//  Handle the inactive recognizer states directly.</span>
00489     <span class="comment">//</span>
00490     
00491     <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> != <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a> &amp;&amp; irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>) {
00492         
00493         <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> == <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>) {
00494 
00495             status = STATUS_UNRECOGNIZED_VOLUME;
00496         
00497         } <span class="keywordflow">else</span> {
00498         
00499             status = STATUS_FS_DRIVER_REQUIRED;
00500         }
00501 
00502         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00503         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00504         <span class="keywordflow">return</span> status;
00505     }
00506 
00507     <span class="keywordflow">switch</span> ( deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o1">FileSystemType</a> ) {
00508 
00509         <span class="keywordflow">case</span> <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a16">FatFileSystem</a>:
00510 
00511             status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a35">FatRecFsControl</a>( DeviceObject, Irp );
00512             <span class="keywordflow">break</span>;
00513 
00514         <span class="keywordflow">case</span> <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a18">NtfsFileSystem</a>:
00515 
00516             status = <a class="code" href="../../d2/d8/ntfs__rec_8c.html#a1">NtfsRecFsControl</a>( DeviceObject, Irp );
00517             <span class="keywordflow">break</span>;
00518 
00519         <span class="keywordflow">case</span> <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a15">CdfsFileSystem</a>:
00520 
00521             status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a33">CdfsRecFsControl</a>( DeviceObject, Irp );
00522             <span class="keywordflow">break</span>;
00523 
00524         <span class="keywordflow">case</span> <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a19">UdfsFileSystem</a>:
00525 
00526             status = <a class="code" href="../../d4/d8/udfs__rec_8c.html#a2">UdfsRecFsControl</a>( DeviceObject, Irp );
00527             <span class="keywordflow">break</span>;
00528 
00529         <span class="keywordflow">default</span>:
00530 
00531             status = STATUS_INVALID_DEVICE_REQUEST;
00532     }
00533 
00534     <span class="keywordflow">return</span> status;
00535 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="fs_rec.h::FsRecGetDeviceSectors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRecGetDeviceSectors           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BytesPerSector</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfSectors</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00703">703</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/largeic_8c-source.html#l00040">RtlExtendedLargeIntegerDivide()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01874">SL_OVERRIDE_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html#l00042">NtfsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00711                    :
00712 
00713     This routine returns information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition represented by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00714     device object.
00715 
00716 Arguments:
00717 
00718     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object from which to read.
00719 
00720     BytesPerSector - The number of bytes per sector <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being read.
00721 
00722     NumberOfSectors - Variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors <span class="keywordflow">for</span> <span class="keyword">this</span>
00723         partition.
00724 
00725 Return Value:
00726 
00727     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information was found, otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00728 
00729 --*/
00730 
00731 {
00732     PARTITION_INFORMATION partitionInfo;
00733     IO_STATUS_BLOCK ioStatus;
00734     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00735     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00736     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00737     ULONG remainder;
00738 
00739     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00740 
00741     <span class="comment">//</span>
00742     <span class="comment">//  We only do this for disks right now. This is likely to change when we</span>
00743     <span class="comment">//  have to recognize CDUDF media.</span>
00744     <span class="comment">//</span>
00745 
00746     <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType != FILE_DEVICE_DISK) {
00747 
00748         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00749     }
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// Get the number of sectors on this partition.</span>
00753     <span class="comment">//</span>
00754 
00755     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
00756 
00757     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IOCTL_DISK_GET_PARTITION_INFO,
00758                                          DeviceObject,
00759                                          (PVOID) NULL,
00760                                          0,
00761                                          &amp;partitionInfo,
00762                                          <span class="keyword">sizeof</span>( partitionInfo ),
00763                                          FALSE,
00764                                          &amp;event,
00765                                          &amp;ioStatus );
00766     <span class="keywordflow">if</span> (!irp) {
00767         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00768     }
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">//  Override verify logic - we don't care. The fact we're in the picture means</span>
00772     <span class="comment">//  someone is trying to mount new/changed media in the first place.</span>
00773     <span class="comment">//</span>
00774     
00775     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp )-&gt;Flags, SL_OVERRIDE_VERIFY_VOLUME );
00776 
00777     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, irp );
00778     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00779         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00780                                       Executive,
00781                                       KernelMode,
00782                                       FALSE,
00783                                       (PLARGE_INTEGER) NULL );
00784         status = ioStatus.Status;
00785     }
00786 
00787     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00788         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00789     }
00790 
00791     *NumberOfSectors = <a class="code" href="../../d0/d1/largeic_8c.html#a0">RtlExtendedLargeIntegerDivide</a>( partitionInfo.PartitionLength,
00792                                                       BytesPerSector,
00793                                                       &amp;remainder );
00794 
00795     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00796 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="fs_rec.h::FsRecGetDeviceSectorSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRecGetDeviceSectorSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BytesPerSector</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00800">800</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01874">SL_OVERRIDE_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00043">FatRecFsControl()</a>, <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html#l00042">NtfsRecFsControl()</a>, and <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00060">UdfsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00807                    :
00808 
00809     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sector size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying device.
00810 
00811 Arguments:
00812 
00813     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object from which to read.
00814 
00815     BytesPerSector - Variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes per sector <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00816         device being read.
00817 
00818 Return Value:
00819 
00820     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information was found, otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00821 
00822 --*/
00823 
00824 {
00825     DISK_GEOMETRY diskGeometry;
00826     IO_STATUS_BLOCK ioStatus;
00827     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00828     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00829     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00830     ULONG ControlCode;
00831 
00832     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00833 
00834     <span class="comment">//</span>
00835     <span class="comment">//  Figure out what kind of device we have so we can use the right IOCTL.</span>
00836     <span class="comment">//</span>
00837 
00838     <span class="keywordflow">switch</span> (DeviceObject-&gt;DeviceType) {
00839         <span class="keywordflow">case</span> FILE_DEVICE_CD_ROM:
00840             ControlCode = IOCTL_CDROM_GET_DRIVE_GEOMETRY;
00841             <span class="keywordflow">break</span>;
00842 
00843         <span class="keywordflow">case</span> FILE_DEVICE_DISK:
00844             ControlCode = IOCTL_DISK_GET_DRIVE_GEOMETRY;
00845             <span class="keywordflow">break</span>;
00846 
00847         <span class="keywordflow">default</span>:
00848             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00849     }
00850 
00851     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
00852     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( ControlCode,
00853                                          DeviceObject,
00854                                          (PVOID) NULL,
00855                                          0,
00856                                          &amp;diskGeometry,
00857                                          <span class="keyword">sizeof</span>( diskGeometry ),
00858                                          FALSE,
00859                                          &amp;event,
00860                                          &amp;ioStatus );
00861 
00862     <span class="keywordflow">if</span> (!irp) {
00863         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00864     }
00865 
00866     <span class="comment">//</span>
00867     <span class="comment">//  Override verify logic - we don't care. The fact we're in the picture means</span>
00868     <span class="comment">//  someone is trying to mount new/changed media in the first place.</span>
00869     <span class="comment">//</span>
00870     
00871     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp )-&gt;Flags, SL_OVERRIDE_VERIFY_VOLUME );
00872     
00873     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, irp );
00874     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00875         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00876                                       Executive,
00877                                       KernelMode,
00878                                       FALSE,
00879                                       (PLARGE_INTEGER) NULL );
00880         status = ioStatus.Status;
00881     }
00882 
00883     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00884         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00885     }
00886 
00887     <span class="comment">//</span>
00888     <span class="comment">// Ensure that the drive actually knows how many bytes there are per</span>
00889     <span class="comment">// sector.  Floppy drives do not know if the media is unformatted.</span>
00890     <span class="comment">//</span>
00891 
00892     <span class="keywordflow">if</span> (!diskGeometry.BytesPerSector) {
00893         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00894     }
00895 
00896     <span class="comment">//</span>
00897     <span class="comment">// Store the return values for the caller.</span>
00898     <span class="comment">//</span>
00899 
00900     *BytesPerSector = diskGeometry.BytesPerSector;
00901 
00902     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00903 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="fs_rec.h::FsRecLoadFileSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRecLoadFileSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverServiceKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">579</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>, <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00074">_DEVICE_EXTENSION::CoRecognizer</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a39a22">FastUnload</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00063">FsRecLoadSync</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11106">IoUnregisterFileSystem()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00076">_DEVICE_EXTENSION::State</a>, <a class="el" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>, and <a class="el" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver()</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00040">CdfsRecFsControl()</a>, <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00043">FatRecFsControl()</a>, <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html#l00042">NtfsRecFsControl()</a>, and <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00060">UdfsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00587                    :
00588 
00589     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common work of loading a filesystem on behalf
00590     of one of our recognizers.
00591 
00592 Arguments:
00593 
00594     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> recognizer.
00595 
00596     DriverServiceName - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
00597         associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to be loaded.
00598 
00599 Return Value:
00600 
00601     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.  The recognizer will be set into a transparent mode on <span class="keywordflow">return</span>.
00602     
00603 --*/
00604 
00605 {
00606     UNICODE_STRING driverName;
00607     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00608     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_IMAGE_ALREADY_LOADED;
00609 
00610     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00611 
00612     <span class="comment">//</span>
00613     <span class="comment">//  Quickly check if the recognizer has already fired.</span>
00614     <span class="comment">//</span>
00615     
00616     <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> != <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>) {
00617     
00618         <span class="comment">//</span>
00619         <span class="comment">//  Serialize all threads trying to load this filesystem.</span>
00620         <span class="comment">//</span>
00621         <span class="comment">//  We need to do this for several reasons.  With the new behavior in</span>
00622         <span class="comment">//  IoRegisterFileSystem, we do not know ahead of time whether the</span>
00623         <span class="comment">//  filesystem has been loaded ahead or behind this recognizer in the</span>
00624         <span class="comment">//  scan queue.  This means that we cannot make this recognizer transparent</span>
00625         <span class="comment">//  before the real filesystem has become registered, or else if the</span>
00626         <span class="comment">//  filesystem loads behind us we may let threads go through that will</span>
00627         <span class="comment">//  not find it in that window of time.</span>
00628         <span class="comment">//</span>
00629         <span class="comment">//  The reason this is possible is that NtLoadDriver does not guarantee</span>
00630         <span class="comment">//  that if it returns STATUS_IMAGE_ALREADY_LOADED, that the driver in</span>
00631         <span class="comment">//  question has actually initialized itself, which *is* guaranteed if</span>
00632         <span class="comment">//  it returns STATUS_SUCCESS.  We have to keep these threads bottled</span>
00633         <span class="comment">//  up until they can rescan with the promise that what they need is there.</span>
00634         <span class="comment">//</span>
00635         <span class="comment">//  As a bonus, we can now guarantee that the recognizer goes away in</span>
00636         <span class="comment">//  all cases, not just when the driver successfully loads itself.</span>
00637         <span class="comment">//</span>
00638         
00639         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( FsRecLoadSync,
00640                                Executive,
00641                                KernelMode,
00642                                FALSE,
00643                                NULL );
00644         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00645     
00646         <span class="comment">//</span>
00647         <span class="comment">//  Attempt the filesystem load precisely once for all recognizers</span>
00648         <span class="comment">//  of a given filesystem.</span>
00649         <span class="comment">//</span>
00650         
00651         <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> == <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>) {
00652 
00653             <span class="comment">//</span>
00654             <span class="comment">//  For bonus points, in the future we may want to log an event</span>
00655             <span class="comment">//  on failure.</span>
00656             <span class="comment">//</span>
00657 
00658             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;driverName, DriverServiceName );
00659             status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver</a>( &amp;driverName );
00660 
00661             <span class="comment">//</span>
00662             <span class="comment">//  Now walk all codependant recognizers and instruct them to go</span>
00663             <span class="comment">//  into the fast unload state.  Since IO only expects the fsDO</span>
00664             <span class="comment">//  it is asking to load a filesystem to to unregister itself, if</span>
00665             <span class="comment">//  we unregistered all of the co-recognizers they would dangle.</span>
00666             <span class="comment">//  Unfortunately, this means that fsrec may wind up hanging around</span>
00667             <span class="comment">//  quite a bit longer than strictly neccesary.</span>
00668             <span class="comment">//</span>
00669             <span class="comment">//  Note: we come right back to the original DeviceObject at the</span>
00670             <span class="comment">//  end of this loop (important).  It is also very important that</span>
00671             <span class="comment">//  we only did this once since after we release the mutex the co-</span>
00672             <span class="comment">//  recognizers may begin going away in any order.</span>
00673             <span class="comment">//</span>
00674 
00675             <span class="keywordflow">while</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> != <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a22">FastUnload</a>) {
00676 
00677                 deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> = <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a22">FastUnload</a>;
00678 
00679                 DeviceObject = deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o0">CoRecognizer</a>;
00680                 deviceExtension = DeviceObject-&gt;DeviceExtension;
00681             } 
00682         }
00683         
00684         <span class="comment">//</span>
00685         <span class="comment">//  Unregister this recognizer precisely once.</span>
00686         <span class="comment">//</span>
00687 
00688         <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> != <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>) {
00689             
00690             <a class="code" href="../../d4/d6/iosubs_8c.html#a118">IoUnregisterFileSystem</a>( DeviceObject );
00691             deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> = <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>;
00692         }
00693         
00694         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( FsRecLoadSync, 0, FALSE );
00695         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00696     }
00697     
00698     <span class="keywordflow">return</span> status;
00699 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="fs_rec.h::FsRecReadBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRecReadBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MinimumBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BytesPerSector</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN IsDeviceFailure&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00907">907</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d6/fs__rec_8h-source.html#l00041">FSREC_POOL_TAG</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01933">IoBuildSynchronousFsdRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/fs__rec_8c.html#a1">RoundUp</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01874">SL_OVERRIDE_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00043">FatRecFsControl()</a>, <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00157">IsUdfsVolume()</a>, and <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html#l00042">NtfsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00918                    :
00919 
00920     This routine reads a <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> numbers of bytes into a buffer starting at
00921     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> byte offset from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device represented by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
00922     object.
00923 
00924 Arguments:
00925 
00926     DeviceObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object from which to read.
00927 
00928     ByteOffset - Pointer to a 64-bit byte offset from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
00929         from which to start <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read.
00930 
00931     MinimumBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> number of bytes to be read.
00932 
00933     BytesPerSector - The number of bytes per sector <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being read.
00934 
00935     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Variable to receive a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated buffer containing
00936         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes read.
00937         
00938     IsDeviceFailure - Variable to receive an indication whether a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00939         was a result of talking to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device.
00940 
00941 Return Value:
00942 
00943     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes were read, otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00944 
00945 --*/
00946 
00947 {
00948 <span class="preprocessor">    #define RoundUp( x, y ) ( ((x + (y-1)) / y) * y )</span>
00949 <span class="preprocessor"></span>
00950     IO_STATUS_BLOCK ioStatus;
00951     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00952     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00953     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00954 
00955     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00956 
00957     <span class="keywordflow">if</span> (IsDeviceFailure) {
00958         *IsDeviceFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00959     }
00960     
00961     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
00962 
00963     <span class="comment">//</span>
00964     <span class="comment">// Set the minimum number of bytes to read to the maximum of the bytes that</span>
00965     <span class="comment">// the caller wants to read, and the number of bytes in a sector.</span>
00966     <span class="comment">//</span>
00967 
00968     <span class="keywordflow">if</span> (MinimumBytes &lt; BytesPerSector) {
00969         MinimumBytes = BytesPerSector;
00970     } <span class="keywordflow">else</span> {
00971         MinimumBytes = <a class="code" href="../../d6/d7/fs__rec_8c.html#a1">RoundUp</a>( MinimumBytes, BytesPerSector );
00972     }
00973 
00974     <span class="comment">//</span>
00975     <span class="comment">// Allocate a buffer large enough to contain the bytes required, round the</span>
00976     <span class="comment">// request to a page boundary to solve any alignment requirements.</span>
00977     <span class="comment">//</span>
00978 
00979     <span class="keywordflow">if</span> (!*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00980 
00981         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
00982                                          (MinimumBytes + PAGE_SIZE - 1) &amp; ~(PAGE_SIZE - 1),
00983                                          FSREC_POOL_TAG );
00984         <span class="keywordflow">if</span> (!*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00985             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00986         }
00987     }
00988 
00989     <span class="comment">//</span>
00990     <span class="comment">// Read the actual bytes off of the media.</span>
00991     <span class="comment">//</span>
00992 
00993     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( IRP_MJ_READ,
00994                                         DeviceObject,
00995                                         *Buffer,
00996                                         MinimumBytes,
00997                                         ByteOffset,
00998                                         &amp;event,
00999                                         &amp;ioStatus );
01000     <span class="keywordflow">if</span> (!irp) {
01001         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01002     }
01003     
01004     <span class="comment">//</span>
01005     <span class="comment">//  Override verify logic - we don't care. The fact we're in the picture means</span>
01006     <span class="comment">//  someone is trying to mount new/changed media in the first place.</span>
01007     <span class="comment">//</span>
01008     
01009     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp )-&gt;Flags, SL_OVERRIDE_VERIFY_VOLUME );
01010 
01011     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, irp );
01012     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01013         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01014                                       Executive,
01015                                       KernelMode,
01016                                       FALSE,
01017                                       (PLARGE_INTEGER) NULL );
01018         status = ioStatus.Status;
01019     }
01020 
01021     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01022 
01023         <span class="keywordflow">if</span> (IsDeviceFailure) {
01024             *IsDeviceFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01025         }
01026         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01027     }
01028 
01029     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01030 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="fs_rec.h::FsRecUnload" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRecUnload           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00539">539</a> of file <a class="el" href="../../d7/d6/fs__rec_8c-source.html">fs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00063">FsRecLoadSync</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>.
<p>
<pre class="fragment"><div>00545                    :
00546 
00547     This routine cleans up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's data structures so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be
00548     unloaded.
00549 
00550 Arguments:
00551 
00552     DriverObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object <span class="keywordflow">for</span> <span class="keyword">this</span> driver.
00553 
00554 Return Value:
00555 
00556     None.
00557 
00558 --*/
00559 
00560 {
00561     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">// Simply delete all of the device objects that this driver has created, the</span>
00565     <span class="comment">// load event, and return.</span>
00566     <span class="comment">//</span>
00567 
00568     <span class="keywordflow">while</span> (DriverObject-&gt;DeviceObject) {
00569         <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>( DriverObject-&gt;DeviceObject );
00570     }
00571 
00572     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( FsRecLoadSync );
00573 
00574     <span class="keywordflow">return</span>;
00575 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="fs_rec.h::NtfsRecFsControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtfsRecFsControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html#l00042">42</a> of file <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html">ntfs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00703">FsRecGetDeviceSectors()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00800">FsRecGetDeviceSectorSize()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">FsRecLoadFileSystem()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00907">FsRecReadBlock()</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00115">IRP_MN_LOAD_FILE_SYSTEM</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d3/d7/ntfs__rec_8c-source.html#l00190">IsNtfsVolume()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/fat__rec_8h.html#a13">PACKED_BOOT_SECTOR</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00446">FsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mount and driver reload <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <span class="keywordflow">for</span> <span class="keyword">this</span> mini-
00052     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer driver.
00053 
00054 Arguments:
00055 
00056     DeviceObject - Pointer to <span class="keyword">this</span> driver's device object.
00057 
00058     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the function to
00059         be performed.
00060 
00061 Return Value:
00062 
00063     The function value is the final status of the operation.
00064 
00065 
00066 --*/
00067 
00068 {
00069     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00070     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00071     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00072     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetDevice;
00073     <a class="code" href="../../d9/d7/struct__PACKED__BOOT__SECTOR.html">PPACKED_BOOT_SECTOR</a> buffer;
00074     LARGE_INTEGER byteOffset;
00075     LARGE_INTEGER secondByteOffset;
00076     LARGE_INTEGER lastByteOffset;
00077     UNICODE_STRING driverName;
00078     ULONG bytesPerSector;
00079     LARGE_INTEGER numberOfSectors;
00080 
00081     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00082 
00083     <span class="comment">//</span>
00084     <span class="comment">// Begin by determining what function that is to be performed.</span>
00085     <span class="comment">//</span>
00086 
00087     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00088     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00089 
00090     <span class="keywordflow">switch</span> ( irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ) {
00091 
00092     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>:
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">// Attempt to mount a volume:  Determine whether or not the volume in</span>
00096         <span class="comment">// question is an NTFS volume and, if so, let the I/O system know that it</span>
00097         <span class="comment">// is by returning a special status code so that this driver can get</span>
00098         <span class="comment">// called back to load the NTFS file system.</span>
00099         <span class="comment">//</span>
00100 
00101         status = STATUS_UNRECOGNIZED_VOLUME;
00102         
00103         <span class="comment">//</span>
00104         <span class="comment">// Attempt to determine whether or not the target volume being mounted</span>
00105         <span class="comment">// is an NTFS volume.</span>
00106         <span class="comment">//</span>
00107 
00108         targetDevice = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.MountVolume.DeviceObject;
00109 
00110         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a30">FsRecGetDeviceSectorSize</a>( targetDevice,
00111                                       &amp;bytesPerSector ) &amp;&amp;
00112             <a class="code" href="../../d7/d7/fs__rec_8h.html#a31">FsRecGetDeviceSectors</a>( targetDevice,
00113                                    bytesPerSector,
00114                                    &amp;numberOfSectors )) {
00115 
00116             byteOffset.QuadPart = 0;
00117             buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00118             secondByteOffset.QuadPart = numberOfSectors.QuadPart &gt;&gt; 1;
00119             secondByteOffset.QuadPart *= (LONG) bytesPerSector;
00120             lastByteOffset.QuadPart = (numberOfSectors.QuadPart - 1) * (LONG) bytesPerSector;
00121 
00122             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a32">FsRecReadBlock</a>( targetDevice,
00123                                 &amp;byteOffset,
00124                                 <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d7/struct__PACKED__BOOT__SECTOR.html">PACKED_BOOT_SECTOR</a> ),
00125                                 bytesPerSector,
00126                                 (PVOID *)&amp;buffer,
00127                                 NULL ) &amp;&amp;
00128                 <a class="code" href="../../d3/d8/ntfs__rec_8h.html#a12">IsNtfsVolume</a>( buffer, bytesPerSector, &amp;numberOfSectors )) {
00129                     
00130                 status = STATUS_FS_DRIVER_REQUIRED;
00131             
00132             } <span class="keywordflow">else</span> {
00133 
00134                 <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a32">FsRecReadBlock</a>( targetDevice,
00135                                     &amp;secondByteOffset,
00136                                     <span class="keyword">sizeof</span>( PACKED_BOOT_SECTOR ),
00137                                     bytesPerSector,
00138                                     (PVOID *)&amp;buffer,
00139                                     NULL ) &amp;&amp;
00140                     <a class="code" href="../../d3/d8/ntfs__rec_8h.html#a12">IsNtfsVolume</a>( buffer, bytesPerSector, &amp;numberOfSectors )) {
00141 
00142                     status = STATUS_FS_DRIVER_REQUIRED;
00143 
00144                 } <span class="keywordflow">else</span> {
00145                     
00146                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a32">FsRecReadBlock</a>( targetDevice,
00147                                         &amp;lastByteOffset,
00148                                         <span class="keyword">sizeof</span>( PACKED_BOOT_SECTOR ),
00149                                         bytesPerSector,
00150                                         (PVOID *)&amp;buffer,
00151                                         NULL ) &amp;&amp;
00152                         <a class="code" href="../../d3/d8/ntfs__rec_8h.html#a12">IsNtfsVolume</a>( buffer, bytesPerSector, &amp;numberOfSectors )) {
00153                         
00154                         status = STATUS_FS_DRIVER_REQUIRED;
00155                     }
00156                 }
00157             }
00158             
00159             <span class="keywordflow">if</span> (buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00160                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( buffer );
00161             }
00162         }
00163 
00164         <span class="keywordflow">break</span>;
00165 
00166     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a49">IRP_MN_LOAD_FILE_SYSTEM</a>:
00167 
00168         status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a29">FsRecLoadFileSystem</a>( DeviceObject,
00169                                       L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Ntfs"</span> );
00170         <span class="keywordflow">break</span>;
00171 
00172     <span class="keywordflow">default</span>:
00173         status = STATUS_INVALID_DEVICE_REQUEST;
00174 
00175     }
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">// Finally, complete the request and return the same status code to the</span>
00179     <span class="comment">// caller.</span>
00180     <span class="comment">//</span>
00181 
00182     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00183     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00184 
00185     <span class="keywordflow">return</span> status;
00186 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="fs_rec.h::UdfsRecFsControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfsRecFsControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00060">60</a> of file <a class="el" href="../../d5/d7/udfs__rec_8c-source.html">udfs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00800">FsRecGetDeviceSectorSize()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">FsRecLoadFileSystem()</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00115">IRP_MN_LOAD_FILE_SYSTEM</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00157">IsUdfsVolume()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00446">FsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00067                    :
00068 
00069     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mount and driver reload <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <span class="keywordflow">for</span> <span class="keyword">this</span> mini-
00070     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer driver.
00071 
00072 Arguments:
00073 
00074     DeviceObject - Pointer to <span class="keyword">this</span> driver's device object.
00075 
00076     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the function to
00077         be performed.
00078 
00079 Return Value:
00080 
00081     The function value is the final status of the operation.
00082 
00083 
00084  -*/
00085 
00086 {
00087     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00088     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00089     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00090     UNICODE_STRING driverName;
00091     ULONG bytesPerSector;
00092     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetDevice;
00093 
00094     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">// Begin by determining what function that is to be performed.</span>
00098     <span class="comment">//</span>
00099 
00100     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00101     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00102 
00103     <span class="keywordflow">switch</span> ( irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ) {
00104 
00105     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>:
00106 
00107         <span class="comment">//</span>
00108         <span class="comment">// Attempt to mount a volume:  There are two different cases here:</span>
00109         <span class="comment">//</span>
00110         <span class="comment">//     1)  The device is being opened for DASD access, that is, no</span>
00111         <span class="comment">//         file system is required, thus it is OK to allow RAW to</span>
00112         <span class="comment">//         to open it.</span>
00113         <span class="comment">//</span>
00114         <span class="comment">//     2)  We need to rummage the media to see if this is a UDF volume.</span>
00115         <span class="comment">//</span>
00116 
00117         status = STATUS_UNRECOGNIZED_VOLUME;
00118 
00119         targetDevice = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.MountVolume.DeviceObject;
00120 
00121         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a30">FsRecGetDeviceSectorSize</a>( targetDevice,
00122                                       &amp;bytesPerSector )) {
00123         
00124             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/udfs__rec_8h.html#a28">IsUdfsVolume</a>( targetDevice,
00125                               bytesPerSector )) {
00126 
00127                 status = STATUS_FS_DRIVER_REQUIRED;
00128             }
00129         }
00130 
00131         <span class="keywordflow">break</span>;
00132 
00133     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a49">IRP_MN_LOAD_FILE_SYSTEM</a>:
00134 
00135         status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a29">FsRecLoadFileSystem</a>( DeviceObject,
00136                                       L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Udfs"</span> );
00137         <span class="keywordflow">break</span>;
00138 
00139     <span class="keywordflow">default</span>:
00140         status = STATUS_INVALID_DEVICE_REQUEST;
00141 
00142     }
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// Finally, complete the request and return the same status code to the</span>
00146     <span class="comment">// caller.</span>
00147     <span class="comment">//</span>
00148 
00149     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00150     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00151 
00152     <span class="keywordflow">return</span> status;
00153 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="fs_rec.h::ZwLoadDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ZwLoadDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverServiceName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">FsRecLoadFileSystem()</a>, and <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
