<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dmpaddr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dmpaddr.c</h1><a href="../../d6/d0/dmpaddr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dmpaddr.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Temporary routine to print valid addresses within an</span>
00012 <span class="comment">    address space.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 20-Mar-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel Mode.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00027 
00028 <span class="preprocessor">#if DBG</span>
00029 <span class="preprocessor"></span>
00030 BOOLEAN
00031 MiFlushUnusedSectionInternal (
00032     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
00033     );
00034 
00035 <span class="preprocessor">#endif //DBG</span>
00036 <span class="preprocessor"></span>
00037 <span class="preprocessor">#if DBG</span>
00038 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00039 <a class="code" href="../../d4/d8/mi_8h.html#a965">MiDumpValidAddresses</a> (
00040     )
00041 
00042 {
00043     ULONG va = 0;
00044     ULONG i,j;
00045     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00046     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00047 
00048     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (va);
00049 
00050 
00051     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>; i++) {
00052         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid) {
00053             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  **valid PDE, element %ld  %lx %lx\n"</span>,i,i,
00054                           PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00055             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (va);
00056             <span class="keywordflow">for</span> (j = 0 ; j &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; j++) {
00057                 <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid) {
00058                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Valid address at %lx pte %lx\n"</span>, (ULONG)va,
00059                           PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00060                 }
00061                 va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00062                 PointerPte++;
00063             }
00064         } <span class="keywordflow">else</span> {
00065             va += (ULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a> * (ULONG)<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00066         }
00067 
00068         PointerPde++;
00069     }
00070 
00071     <span class="keywordflow">return</span>;
00072 
00073 }
00074 
00075 <span class="preprocessor">#endif //DBG</span>
00076 <span class="preprocessor"></span>
00077 <span class="preprocessor">#if DBG</span>
00078 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00079 <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a> (
00080     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
00081     )
00082 
00083 {
00084 
00085 <span class="comment">//       int j;</span>
00086 <span class="comment">//       unsigned long pte;</span>
00087        <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> proto_pte;
00088        <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> subsect;
00089 
00090 <span class="comment">//   struct a_bit {</span>
00091 <span class="comment">//       unsigned long biggies : 31;</span>
00092 <span class="comment">//       unsigned long bitties : 1;</span>
00093 <span class="comment">//       };</span>
00094 <span class="comment">//</span>
00095 <span class="comment">//      struct a_bit print_pte;</span>
00096 
00097 
00098     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (PointerPte) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00099         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"   cannot dump PTE %p - it's not valid\n\n"</span>,
00100                  (ULONG_PTR)PointerPte);
00101         <span class="keywordflow">return</span>;
00102     }
00103 
00104     proto_pte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(PointerPte);
00105     subsect = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a>(PointerPte);
00106 
00107     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"***DumpPTE at %p contains %p\n"</span>,
00108              (ULONG_PTR)PointerPte,
00109              PointerPte-&gt;u.Long);
00110 
00111     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"   protoaddr %p subsectaddr %p\n\n"</span>,
00112              (ULONG_PTR)proto_pte,
00113              (ULONG_PTR)subsect);
00114 
00115     <span class="keywordflow">return</span>;
00116 
00117 <span class="comment">//      DbgPrint("page frame number 0x%lx  proto PTE address 0x%lx\n",</span>
00118 <span class="comment">//</span>
00119 <span class="comment">//      DbgPrint("PTE is 0x%lx\n", PTETOULONG(the_pte));</span>
00120 <span class="comment">//</span>
00121 <span class="comment">//      proto_pte = MiPteToProto(PointerPte);</span>
00122 <span class="comment">//</span>
00123 <span class="comment">//      DbgPrint("page frame number 0x%lx  proto PTE address 0x%lx\n",</span>
00124 <span class="comment">//            PointerPte-&gt;u.Hard.PageFrameNumber,*(PULONG)&amp;proto_pte);</span>
00125 <span class="comment">//</span>
00126 <span class="comment">//      DbgPrint("  1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0  \n");</span>
00127 <span class="comment">//      DbgPrint(" +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ \n");</span>
00128 <span class="comment">//      DbgPrint(" |      pfn                              |c|p|t|r|r|d|a|c|p|o|w|v| \n");</span>
00129 <span class="comment">//      DbgPrint(" |                                       |o|r|r|s|s|t|c|a|b|w|r|l| \n");</span>
00130 <span class="comment">//      DbgPrint(" |                                       |w|o|n|v|v|y|c|c|o|n|t|d| \n");</span>
00131 <span class="comment">//      DbgPrint(" +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ \n ");</span>
00132 <span class="comment">//      pte = PTETOULONG(the_pte);</span>
00133 <span class="comment">//</span>
00134 <span class="comment">//      for (j = 0; j &lt; 32; j++) {</span>
00135 <span class="comment">//         *(PULONG)&amp; print_pte =  pte;</span>
00136 <span class="comment">//         DbgPrint(" %lx",print_pte.bitties);</span>
00137 <span class="comment">//         pte = pte &lt;&lt; 1;</span>
00138 <span class="comment">//      }</span>
00139 <span class="comment">//       DbgPrint("\n");</span>
00140 <span class="comment">//</span>
00141 
00142 }
00143 <span class="preprocessor">#endif //DBG</span>
00144 <span class="preprocessor"></span>
00145 <span class="preprocessor">#if DBG</span>
00146 <span class="preprocessor"></span>
00147 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00148 <a class="code" href="../../d4/d8/mi_8h.html#a967">MiDumpWsl</a> ( )
00149 
00150 {
00151     ULONG i;
00152     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> wsle;
00153 
00154     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"***WSLE cursize %lx frstfree %lx  Min %lx  Max %lx\n"</span>,
00155         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.WorkingSetSize,
00156         <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>,
00157         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.MinimumWorkingSetSize,
00158         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.MaximumWorkingSetSize);
00159 
00160     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"   quota %lx   firstdyn %lx  last ent %lx  next slot %lx\n"</span>,
00161         <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>,
00162         <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>,
00163         <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>,
00164         <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a>);
00165 
00166     wsle = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>;
00167 
00168     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>; i++) {
00169         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" index %lx  %lx\n"</span>,i,wsle-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long);
00170         wsle++;
00171     }
00172     <span class="keywordflow">return</span>;
00173 
00174 }
00175 
00176 <span class="preprocessor">#endif //DBG</span>
00177 <span class="preprocessor"></span>
00178 <span class="preprocessor">#if 0 //COMMENTED OUT!!!</span>
00179 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00180 MiFlushUnusedSections (
00181     VOID
00182     )
00183 
00184 <span class="comment">/*++</span>
00185 <span class="comment"></span>
00186 <span class="comment">Routine Description:</span>
00187 <span class="comment"></span>
00188 <span class="comment">    This routine rumages through the PFN database and attempts</span>
00189 <span class="comment">    to close any unused sections.</span>
00190 <span class="comment"></span>
00191 <span class="comment">Arguments:</span>
00192 <span class="comment"></span>
00193 <span class="comment">    None.</span>
00194 <span class="comment"></span>
00195 <span class="comment">Return Value:</span>
00196 <span class="comment"></span>
00197 <span class="comment">    None.</span>
00198 <span class="comment"></span>
00199 <span class="comment">--*/</span>
00200 
00201 {
00202     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> LastPfn;
00203     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00204     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00205     KIRQL OldIrql;
00206 
00207     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00208     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MmLowestPhysicalPage + 1);
00209     LastPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(MmHighestPhysicalPage);
00210 
00211     <span class="keywordflow">while</span> (Pfn1 &lt; LastPfn) {
00212         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00213             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>) ||
00214                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>)) {
00215 
00216                 <span class="comment">//</span>
00217                 <span class="comment">// Make sure the PTE is not waiting for I/O to complete.</span>
00218                 <span class="comment">//</span>
00219 
00220                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a121">MI_IS_PFN_DELETED</a> (Pfn1)) {
00221 
00222                     Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00223                     MiFlushUnusedSectionInternal (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>);
00224                 }
00225             }
00226         }
00227         Pfn1++;
00228     }
00229 
00230     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00231     <span class="keywordflow">return</span>;
00232 }
00233 
00234 BOOLEAN
00235 MiFlushUnusedSectionInternal (
00236     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
00237     )
00238 
00239 {
00240     BOOLEAN result;
00241     KIRQL OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00242 
00243     <span class="keywordflow">if</span> ((ControlArea-&gt;NumberOfMappedViews != 0) ||
00244         (ControlArea-&gt;NumberOfSectionReferences != 0)) {
00245 
00246         <span class="comment">//</span>
00247         <span class="comment">// The segment is currently in use.</span>
00248         <span class="comment">//</span>
00249 
00250         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00251     }
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">// The segment has no references, delete it.  If the segment</span>
00255     <span class="comment">// is already being deleted, set the event field in the control</span>
00256     <span class="comment">// area and wait on the event.</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> ((ControlArea-&gt;u.Flags.BeingDeleted) ||
00260         (ControlArea-&gt;u.Flags.BeingCreated)) {
00261 
00262         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00263     }
00264 
00265     <span class="comment">//</span>
00266     <span class="comment">// Set the being deleted flag and up the number of mapped views</span>
00267     <span class="comment">// for the segment.  Upping the number of mapped views prevents</span>
00268     <span class="comment">// the segment from being deleted and passed to the deletion thread</span>
00269     <span class="comment">// while we are forcing a delete.</span>
00270     <span class="comment">//</span>
00271 
00272     ControlArea-&gt;u.Flags.BeingDeleted = 1;
00273     ControlArea-&gt;NumberOfMappedViews = 1;
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// This is a page file backed or image Segment.  The Segment is being</span>
00277     <span class="comment">// deleted, remove all references to the paging file and physical memory.</span>
00278     <span class="comment">//</span>
00279 
00280     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00281 
00282     <a class="code" href="../../d5/d5/sectsup_8c.html#a22">MiCleanSection</a> (ControlArea);
00283 
00284     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00285     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00286 }
00287 <span class="preprocessor">#endif //0</span>
00288 <span class="preprocessor"></span>
00289 
00290 <span class="preprocessor">#if DBG</span>
00291 <span class="preprocessor"></span>
00292 <span class="preprocessor">#define ALLOC_SIZE ((ULONG)8*1024)</span>
00293 <span class="preprocessor"></span><span class="preprocessor">#define MM_SAVED_CONTROL 64</span>
00294 <span class="preprocessor"></span><span class="preprocessor">#define MM_KERN_MAP_SIZE 64</span>
00295 <span class="preprocessor"></span>
00296 <span class="preprocessor">#define MM_NONPAGED_POOL_MARK ((PUCHAR)(ULONG_PTR)0xfffff123)</span>
00297 <span class="preprocessor"></span><span class="preprocessor">#define MM_PAGED_POOL_MARK    ((PUCHAR)(ULONG_PTR)0xfffff124)</span>
00298 <span class="preprocessor"></span><span class="preprocessor">#define MM_KERNEL_STACK_MARK  ((PUCHAR)(ULONG_PTR)0xfffff125)</span>
00299 <span class="preprocessor"></span>
00300 <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a771">MaximumPtePoolTypes</a>];
00301 <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a771">MaximumPtePoolTypes</a>];
00302 
00303 <span class="keyword">typedef</span> <span class="keyword">struct </span>_KERN_MAP {
00304     ULONG_PTR StartVa;
00305     ULONG_PTR EndVa;
00306     PLDR_DATA_TABLE_ENTRY Entry;
00307 } KERN_MAP, *PKERN_MAP;
00308 
00309 ULONG
00310 MiBuildKernelMap (
00311     IN ULONG NumberOfElements,
00312     IN OUT PKERN_MAP KernelMap
00313     );
00314 
00315 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00316 <a class="code" href="../../d6/d0/dmpaddr_8c.html#a0">MmMemoryUsage</a> (
00317     IN PVOID Buffer,
00318     IN ULONG Size,
00319     IN ULONG Type,
00320     OUT PULONG OutLength
00321     )
00322 
00323 <span class="comment">/*++</span>
00324 <span class="comment"></span>
00325 <span class="comment">Routine Description:</span>
00326 <span class="comment"></span>
00327 <span class="comment">    This routine (debugging only) dumps the current memory usage by</span>
00328 <span class="comment">    walking the PFN database.</span>
00329 <span class="comment"></span>
00330 <span class="comment">Arguments:</span>
00331 <span class="comment"></span>
00332 <span class="comment">    Buffer - Supplies a buffer in which to copy the data.</span>
00333 <span class="comment"></span>
00334 <span class="comment">    Size - Supplies the size of the buffer.</span>
00335 <span class="comment"></span>
00336 <span class="comment">    Type - Supplies a value of 0 to dump everything,</span>
00337 <span class="comment">           a value of 1 to dump only valid pages.</span>
00338 <span class="comment"></span>
00339 <span class="comment">    OutLength - Returns how much data was written into the buffer.</span>
00340 <span class="comment"></span>
00341 <span class="comment">Return Value:</span>
00342 <span class="comment"></span>
00343 <span class="comment">    None.</span>
00344 <span class="comment"></span>
00345 <span class="comment">--*/</span>
00346 
00347 {
00348     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> LastPfn;
00349     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00350     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00351     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00352     KIRQL OldIrql;
00353     PSYSTEM_MEMORY_INFORMATION MemInfo;
00354     PSYSTEM_MEMORY_INFO Info;
00355     PSYSTEM_MEMORY_INFO InfoStart;
00356     PSYSTEM_MEMORY_INFO InfoEnd;
00357     PUCHAR <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00358     PUCHAR Master;
00359     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00360     BOOLEAN Found;
00361     BOOLEAN FoundMap;
00362     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00363     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00364     ULONG Length;
00365     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00366     PUCHAR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00367     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> SavedControl[MM_SAVED_CONTROL];
00368     PSYSTEM_MEMORY_INFO  SavedInfo[MM_SAVED_CONTROL];
00369     ULONG j;
00370     ULONG ControlCount = 0;
00371     PUCHAR PagedSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00372     ULONG Failed;
00373     UCHAR PageFileMapped[] = <span class="stringliteral">"PageFile Mapped"</span>;
00374     UCHAR MetaFile[] =       <span class="stringliteral">"Fs Meta File"</span>;
00375     UCHAR NoName[] =         <span class="stringliteral">"No File Name"</span>;
00376     UCHAR <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>[] =   <span class="stringliteral">"NonPagedPool"</span>;
00377     UCHAR <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>[] =      <span class="stringliteral">"PagedPool"</span>;
00378     UCHAR KernelStack[] =    <span class="stringliteral">"Kernel Stack"</span>;
00379     PUCHAR NameString;
00380     KERN_MAP KernMap[MM_KERN_MAP_SIZE];
00381     ULONG KernSize;
00382     ULONG_PTR VirtualAddress;
00383     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00384 
00385     Mdl = <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a> (NULL, Buffer, Size);
00386     <span class="keywordflow">try</span> {
00387 
00388         <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (Mdl, KeGetPreviousMode(), IoWriteAccess);
00389 
00390     } except (EXCEPTION_EXECUTE_HANDLER) {
00391 
00392         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Mdl);
00393         <span class="keywordflow">return</span> GetExceptionCode();
00394     }
00395 
00396     MemInfo = <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a> (Mdl);
00397     InfoStart = &amp;MemInfo-&gt;Memory[0];
00398     InfoEnd = InfoStart;
00399     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PUCHAR)MemInfo + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00400 
00401     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MmLowestPhysicalPage + 1);
00402     LastPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(MmHighestPhysicalPage);
00403 
00404     KernSize = MiBuildKernelMap (MM_KERN_MAP_SIZE, &amp;KernMap[0]);
00405 
00406     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00407 
00408     <span class="keywordflow">while</span> (Pfn1 &lt; LastPfn) {
00409 
00410         Info = InfoStart;
00411         FoundMap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00412 
00413         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>) &amp;&amp;
00414             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>) &amp;&amp;
00415             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>)) {
00416 
00417             <span class="keywordflow">if</span> (Type == 1) {
00418                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>) {
00419                     Pfn1++;
00420                     <span class="keywordflow">continue</span>;
00421                 }
00422             }
00423             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00424                 Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00425                 Master = (PUCHAR)Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
00426                 ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
00427                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(ControlArea)) {
00428                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Pfnp %lx not found %lx\n"</span>,Pfn1 - MmPfnDatabase,
00429                                                     (ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00430                     Pfn1++;
00431                     <span class="keywordflow">continue</span>;
00432                 }
00433                 <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00434                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>)) {
00435                         Pfn1++;
00436                         <span class="keywordflow">continue</span>;
00437                     }
00438                 }
00439 
00440             } <span class="keywordflow">else</span> {
00441 
00442                 FoundMap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00443                 VirtualAddress = (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00444 
00445                 <span class="keywordflow">if</span> ((VirtualAddress &gt;= (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>) &amp;&amp;
00446                     (VirtualAddress &lt;= (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>)) {
00447 
00448                     <span class="comment">//</span>
00449                     <span class="comment">// This is paged pool, put it in the paged pool cell.</span>
00450                     <span class="comment">//</span>
00451 
00452                     Master = MM_PAGED_POOL_MARK;
00453 
00454                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((VirtualAddress &gt;= (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>) &amp;&amp;
00455                     (VirtualAddress &lt;= (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a>)) {
00456 
00457                     <span class="comment">//</span>
00458                     <span class="comment">// This is nonpaged pool, put it in the nonpaged pool cell.</span>
00459                     <span class="comment">//</span>
00460 
00461                     Master = MM_NONPAGED_POOL_MARK;
00462 
00463                 } <span class="keywordflow">else</span> {
00464                     FoundMap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00465                     <span class="keywordflow">for</span> (j=0; j &lt; KernSize; j++) {
00466                         <span class="keywordflow">if</span> ((VirtualAddress &gt;= KernMap[j].StartVa) &amp;&amp;
00467                             (VirtualAddress &lt; KernMap[j].EndVa)) {
00468                             Master = (PUCHAR)&amp;KernMap[j];
00469                             FoundMap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00470                             <span class="keywordflow">break</span>;
00471                         }
00472                     }
00473                 }
00474 
00475                 <span class="keywordflow">if</span> (!FoundMap) {
00476                     <span class="keywordflow">if</span> (((ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a14">MmSystemPtesStart</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>]) &amp;&amp;
00477                            ((ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a15">MmSystemPtesEnd</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>])) {
00478 
00479                         <span class="comment">//</span>
00480                         <span class="comment">// This is kernel stack.</span>
00481                         <span class="comment">//</span>
00482 
00483                         Master = MM_KERNEL_STACK_MARK;
00484                     } <span class="keywordflow">else</span> {
00485                         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00486                         Master = (PUCHAR)Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
00487                         <span class="keywordflow">if</span> (((ULONG_PTR)Master == 0) || ((ULONG_PTR)Master &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>)) {
00488                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Pfn %lx not found %lx\n"</span>,Pfn1 - MmPfnDatabase,
00489                                                     (ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00490                             Pfn1++;
00491                             <span class="keywordflow">continue</span>;
00492                         }
00493                     }
00494                 }
00495             }
00496 
00497             <span class="comment">//</span>
00498             <span class="comment">// See if there is already a master info block.</span>
00499             <span class="comment">//</span>
00500 
00501             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00502             <span class="keywordflow">while</span> (Info &lt; InfoEnd) {
00503                 <span class="keywordflow">if</span> (Info-&gt;StringOffset == Master) {
00504                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00505                     <span class="keywordflow">break</span>;
00506                 }
00507                 Info += 1;
00508             }
00509 
00510             <span class="keywordflow">if</span> (!Found) {
00511 
00512                 Info = InfoEnd;
00513                 InfoEnd += 1;
00514                 <span class="keywordflow">if</span> ((PUCHAR)Info &gt;= ((PUCHAR)InfoStart + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) - <span class="keyword">sizeof</span>(SYSTEM_MEMORY_INFO)) {
00515                     status = STATUS_DATA_OVERRUN;
00516                     <span class="keywordflow">goto</span> Done;
00517                 }
00518 
00519                 RtlZeroMemory (Info, <span class="keyword">sizeof</span>(*Info));
00520                 Info-&gt;StringOffset = Master;
00521             }
00522 
00523             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) ||
00524                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>)) {
00525 
00526                 Info-&gt;TransitionCount += 1;
00527 
00528             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>) ||
00529                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>)) {
00530                 Info-&gt;ModifiedCount += 1;
00531 
00532             } <span class="keywordflow">else</span> {
00533                 Info-&gt;ValidCount += 1;
00534                 <span class="keywordflow">if</span> (Type == 1) {
00535                     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (0x0)) &amp;&amp;
00536                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (0xFFFFFFFF))) {
00537                         Info-&gt;PageTableCount += 1;
00538                     }
00539                 }
00540             }
00541             <span class="keywordflow">if</span> (Type != 1) {
00542                 <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (0x0)) &amp;&amp;
00543                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (0xFFFFFFFF))) {
00544                     Info-&gt;PageTableCount += 1;
00545                 }
00546             }
00547         }
00548         Pfn1++;
00549     }
00550 
00551     MemInfo-&gt;StringStart = (ULONG)((PUCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + (ULONG_PTR)InfoEnd - (PUCHAR)MemInfo);
00552     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = (PUCHAR)InfoEnd;
00553 
00554     <span class="comment">//</span>
00555     <span class="comment">// Process strings...</span>
00556     <span class="comment">//</span>
00557 
00558     Info = InfoStart;
00559     <span class="keywordflow">while</span> (Info &lt; InfoEnd) {
00560         <span class="keywordflow">if</span> (Info-&gt;StringOffset &gt; (PUCHAR)MM_HIGHEST_USER_ADDRESS) {
00561 
00562             <span class="comment">//</span>
00563             <span class="comment">// Make sure this is not stacks or other areas.</span>
00564             <span class="comment">//</span>
00565 
00566             Length = 0;
00567             ControlArea = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00568 
00569             <span class="keywordflow">if</span> (Info-&gt;StringOffset == MM_NONPAGED_POOL_MARK) {
00570                 Length = 14;
00571                 NameString = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00572             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Info-&gt;StringOffset == MM_PAGED_POOL_MARK) {
00573                 Length = 14;
00574                 NameString = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00575             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Info-&gt;StringOffset == MM_KERNEL_STACK_MARK) {
00576                 Length = 14;
00577                 NameString = KernelStack;
00578             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((PUCHAR)Info-&gt;StringOffset &gt;= (PUCHAR)&amp;KernMap[0]) &amp;&amp;
00579                        ((PUCHAR)Info-&gt;StringOffset &lt;= (PUCHAR)&amp;KernMap[MM_KERN_MAP_SIZE])) {
00580 
00581                 DataTableEntry = ((PKERN_MAP)Info-&gt;StringOffset)-&gt;Entry;
00582                 NameString = (PUCHAR)DataTableEntry-&gt;BaseDllName.Buffer;
00583                 Length = DataTableEntry-&gt;BaseDllName.Length;
00584             } <span class="keywordflow">else</span> {
00585                 <span class="comment">//</span>
00586                 <span class="comment">// This points to a control area.</span>
00587                 <span class="comment">// Get the file name.</span>
00588                 <span class="comment">//</span>
00589 
00590                 ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(Info-&gt;StringOffset);
00591                 NameString = (PUCHAR)&amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer[0];
00592             }
00593 
00594             Info-&gt;StringOffset = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00595             Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00596             <span class="keywordflow">if</span> (Length == 0) {
00597                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (&amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length)) {
00598                     Length = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length;
00599                     <span class="keywordflow">if</span> (Length == 0) {
00600                         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting) {
00601                             Length = 14;
00602                             NameString = MetaFile;
00603                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.File == 0) {
00604                             NameString = PageFileMapped;
00605                             Length = 16;
00606 
00607                         } <span class="keywordflow">else</span> {
00608                             NameString = NoName;
00609                             Length = 14;
00610                         }
00611                     }
00612                 }
00613             }
00614 
00615             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>+Length+2) &gt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00616                 status = STATUS_DATA_OVERRUN;
00617                 <span class="keywordflow">goto</span> Done;
00618             }
00619             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (&amp;NameString[0]) &amp;&amp;
00620                 <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (&amp;NameString[Length - 1])) {
00621                 RtlMoveMemory (String,
00622                                NameString,
00623                                Length );
00624                 Info-&gt;StringOffset = (PUCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + ((PUCHAR)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - (PUCHAR)MemInfo);
00625                 <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[Length] = 0;
00626                 <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[Length + 1] = 0;
00627                 <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> += Length + 2;
00628                 Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00629             }
00630             <span class="keywordflow">if</span> (Failed &amp;&amp; ControlArea) {
00631                 <span class="keywordflow">if</span> (!(ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated ||
00632                       ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted) &amp;&amp;
00633                       (ControlCount &lt; MM_SAVED_CONTROL)) {
00634                     SavedControl[ControlCount] = ControlArea;
00635                     SavedInfo[ControlCount] = Info;
00636                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> += 1;
00637                     ControlCount += 1;
00638                 }
00639             }
00640 
00641         } <span class="keywordflow">else</span> {
00642 
00643             <span class="comment">//</span>
00644             <span class="comment">// Process...</span>
00645             <span class="comment">//</span>
00646 
00647             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PtrToUlong(Info-&gt;StringOffset));
00648             Info-&gt;StringOffset = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00649             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>+16) &gt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00650                 status = STATUS_DATA_OVERRUN;
00651                 <span class="keywordflow">goto</span> Done;
00652             }
00653 
00654             Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event;
00655             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_BASE)) {
00656                 Info-&gt;StringOffset = (PUCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + ((PUCHAR)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - (PUCHAR)MemInfo);
00657                 RtlMoveMemory (String,
00658                                &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o65">ImageFileName</a>[0],
00659                                16);
00660                 <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> += 16;
00661             } <span class="keywordflow">else</span> {
00662 
00663                 Info-&gt;StringOffset = PagedSection;
00664                 <span class="keywordflow">if</span> (PagedSection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00665                     Info-&gt;StringOffset = (PUCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + ((PUCHAR)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - (PUCHAR)MemInfo);
00666                     RtlMoveMemory (String,
00667                                    &amp;PageFileMapped,
00668                                    16);
00669                     PagedSection = Info-&gt;StringOffset;
00670                     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> += 16;
00671                 }
00672             }
00673         }
00674 
00675         Info += 1;
00676     }
00677 
00678 Done:
00679     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00680     <span class="keywordflow">while</span> (ControlCount != 0) {
00681 
00682         <span class="comment">//</span>
00683         <span class="comment">// Process all the pagable name strings.</span>
00684         <span class="comment">//</span>
00685 
00686         ControlCount -= 1;
00687         ControlArea = SavedControl[ControlCount];
00688         Info = SavedInfo[ControlCount];
00689         NameString = (PUCHAR)&amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer[0];
00690         Length = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length;
00691         <span class="keywordflow">if</span> (Length == 0) {
00692             <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting) {
00693                 Length = 12;
00694                 NameString = MetaFile;
00695             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.File == 0) {
00696                 NameString = PageFileMapped;
00697                 Length = 16;
00698 
00699             } <span class="keywordflow">else</span> {
00700                 NameString = NoName;
00701                 Length = 12;
00702             }
00703         }
00704         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>+Length+2) &gt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) {
00705             status = STATUS_DATA_OVERRUN;
00706         }
00707         <span class="keywordflow">if</span> (status != STATUS_DATA_OVERRUN) {
00708             RtlMoveMemory (String,
00709                            NameString,
00710                            Length );
00711             Info-&gt;StringOffset = (PUCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + ((PUCHAR)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - (PUCHAR)MemInfo);
00712             <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[Length] = 0;
00713             <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[Length + 1] = 0;
00714             <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> += Length + 2;
00715         }
00716 
00717         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00718         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> -= 1;
00719         <a class="code" href="../../d5/d5/sectsup_8c.html#a25">MiCheckForControlAreaDeletion</a> (ControlArea);
00720         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00721     }
00722     *OutLength = (ULONG)((PUCHAR)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - (PUCHAR)MemInfo);
00723     <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Mdl);
00724     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Mdl);;
00725     <span class="keywordflow">return</span> status;
00726 }
00727 <span class="preprocessor">#else //DBG</span>
00728 <span class="preprocessor"></span>
00729 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00730"></a><a class="code" href="../../d6/d0/dmpaddr_8c.html#a0">00730</a> <a class="code" href="../../d6/d0/dmpaddr_8c.html#a0">MmMemoryUsage</a> (
00731     IN PVOID Buffer,
00732     IN ULONG Size,
00733     IN ULONG Type,
00734     OUT PULONG OutLength
00735     )
00736 {
00737     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00738 }
00739 
00740 <span class="preprocessor">#endif //DBG</span>
00741 <span class="preprocessor"></span>
00742 
00743 <span class="preprocessor">#if DBG</span>
00744 <span class="preprocessor"></span>ULONG
00745 MiBuildKernelMap (
00746     IN ULONG NumberOfElements,
00747     IN OUT PKERN_MAP KernelMap
00748     )
00749 
00750 {
00751     PLIST_ENTRY Next;
00752     PLIST_ENTRY NextEntry;
00753     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00754     ULONG i = 0;
00755 
00756     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00757     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a> (&amp;PsLoadedModuleResource, TRUE);
00758 
00759     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
00760     <span class="keywordflow">do</span> {
00761 
00762         DataTableEntry = CONTAINING_RECORD(NextEntry,
00763                                            LDR_DATA_TABLE_ENTRY,
00764                                            InLoadOrderLinks);
00765 
00766         KernelMap[i].Entry = DataTableEntry;
00767         KernelMap[i].StartVa = (ULONG_PTR)DataTableEntry-&gt;DllBase;
00768         KernelMap[i].EndVa = KernelMap[i].StartVa +
00769                                          (ULONG_PTR)DataTableEntry-&gt;SizeOfImage;
00770         i += 1;
00771         <span class="keywordflow">if</span> (i == NumberOfElements) {
00772             <span class="keywordflow">break</span>;
00773         }
00774         Next = DataTableEntry-&gt;InLoadOrderLinks.Flink;
00775 
00776         NextEntry = NextEntry-&gt;Flink;
00777     } <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>);
00778 
00779     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
00780     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00781 
00782     <span class="keywordflow">return</span> i;
00783 }
00784 <span class="preprocessor">#endif //DBG</span>
00785 <span class="preprocessor"></span>
00786 
00787 
00788 <span class="preprocessor">#if DBG</span>
00789 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00790 MiFlushCache (
00791     VOID
00792     )
00793 
00794 <span class="comment">/*++</span>
00795 <span class="comment"></span>
00796 <span class="comment">Routine Description:</span>
00797 <span class="comment"></span>
00798 <span class="comment">    This routine (debugging only) flushes the "cache" by moving</span>
00799 <span class="comment">    all pages from the standby list to the free list.  Modified</span>
00800 <span class="comment">    pages are not affected.</span>
00801 <span class="comment"></span>
00802 <span class="comment">Arguments:</span>
00803 <span class="comment"></span>
00804 <span class="comment">    None.</span>
00805 <span class="comment"></span>
00806 <span class="comment">Return Value:</span>
00807 <span class="comment"></span>
00808 <span class="comment">    None.</span>
00809 <span class="comment"></span>
00810 <span class="comment">--*/</span>
00811 
00812 {
00813     KIRQL OldIrql;
00814     PFN_NUMBER Page;
00815 
00816     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00817 
00818     <span class="keywordflow">while</span> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>]-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
00819 
00820         Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a> (MmPageLocationList[StandbyPageList]);
00821 
00822         <span class="comment">//</span>
00823         <span class="comment">// A page has been removed from the standby list.  The</span>
00824         <span class="comment">// PTE which refers to this page is currently in the transition</span>
00825         <span class="comment">// state and must have its original contents restored to free</span>
00826         <span class="comment">// the last reference to this physical page.</span>
00827         <span class="comment">//</span>
00828 
00829         <span class="comment">// MiRestoreTransitionPte (Page);  &lt;-- Done by MiRemove above</span>
00830 
00831         <span class="comment">//</span>
00832         <span class="comment">// Put the page into the free list.</span>
00833         <span class="comment">//</span>
00834 
00835         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList], Page);
00836     }
00837 
00838     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00839     <span class="keywordflow">return</span>;
00840 }
00841 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00842 MiDumpReferencedPages (
00843     VOID
00844     )
00845 
00846 <span class="comment">/*++</span>
00847 <span class="comment"></span>
00848 <span class="comment">Routine Description:</span>
00849 <span class="comment"></span>
00850 <span class="comment">    This routine (debugging only) dumps all PFN entries which appear</span>
00851 <span class="comment">    to be locked in memory for i/o.</span>
00852 <span class="comment"></span>
00853 <span class="comment">Arguments:</span>
00854 <span class="comment"></span>
00855 <span class="comment">    None.</span>
00856 <span class="comment"></span>
00857 <span class="comment">Return Value:</span>
00858 <span class="comment"></span>
00859 <span class="comment">    None.</span>
00860 <span class="comment"></span>
00861 <span class="comment">--*/</span>
00862 
00863 {
00864     KIRQL OldIrql;
00865     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00866     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnLast;
00867 
00868     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00869 
00870     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MmLowestPhysicalPage);
00871     PfnLast = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MmHighestPhysicalPage);
00872 
00873     <span class="keywordflow">while</span> (Pfn1 &lt;= PfnLast) {
00874 
00875         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0) &amp;&amp; (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0)) {
00876             <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a> (Pfn1);
00877         }
00878 
00879         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) {
00880             <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a> (Pfn1);
00881         }
00882 
00883         Pfn1 += 1;
00884     }
00885 
00886     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00887     <span class="keywordflow">return</span>;
00888 }
00889 
00890 <span class="preprocessor">#endif //DBG</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
