<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wsprintf.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wsprintf.c</h1><a href="../../d6/d0/wsprintf_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: wsprintf.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*  sprintf.c</span>
00006 <span class="comment">*</span>
00007 <span class="comment">*  Implements Windows friendly versions of sprintf and vsprintf</span>
00008 <span class="comment">*</span>
00009 <span class="comment">*  History:</span>
00010 <span class="comment">*   2-15-89  craigc     Initial</span>
00011 <span class="comment">*  11-12-90  MikeHar    Ported from windows 3</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a0">00017</a> <span class="preprocessor">#define out(c) if (cchLimit) {*lpOut++=(c); cchLimit--;} else goto errorout</span>
00018 <span class="preprocessor"></span>
00019 <span class="comment">/***************************************************************************\</span>
00020 <span class="comment">* SP_PutNumber</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* Takes an unsigned long integer and places it into a buffer, respecting</span>
00023 <span class="comment">* a buffer limit, a radix, and a case select (upper or lower, for hex).</span>
00024 <span class="comment">*</span>
00025 <span class="comment">*</span>
00026 <span class="comment">* History:</span>
00027 <span class="comment">*  11-12-90  MikeHar    Ported from windows 3 asm --&gt; C</span>
00028 <span class="comment">*  12-11-90  GregoryW   need to increment lpstr after assignment of mod</span>
00029 <span class="comment">\***************************************************************************/</span>
00030 
<a name="l00031"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a1">00031</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/wsprintf_8c.html#a1">SP_PutNumber</a>(
00032     LPSTR lpstr,
00033     ULONG_PTR n,
00034     <span class="keywordtype">int</span>   limit,
00035     DWORD radix,
00036     <span class="keywordtype">int</span>   uppercase)
00037 {
00038     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> mod;
00039     <span class="keywordtype">int</span> count = 0;
00040 
00041     <span class="comment">/* It might not work for some locales or digit sets */</span>
00042     <span class="keywordflow">if</span>(uppercase)
00043         uppercase =  <span class="charliteral">'A'</span>-<span class="charliteral">'0'</span>-10;
00044     <span class="keywordflow">else</span>
00045         uppercase = <span class="charliteral">'a'</span>-<span class="charliteral">'0'</span>-10;
00046 
00047     <span class="keywordflow">if</span> (count &lt; limit) {
00048         <span class="keywordflow">do</span>  {
00049             mod =  (ULONG)(<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> % radix);
00050             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> /= radix;
00051 
00052             mod += <span class="charliteral">'0'</span>;
00053             <span class="keywordflow">if</span> (mod &gt; <span class="charliteral">'9'</span>)
00054                 mod += uppercase;
00055             *lpstr++ = (<span class="keywordtype">char</span>)mod;
00056             count++;
00057         } <span class="keywordflow">while</span>((count &lt; limit) &amp;&amp; <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>);
00058     }
00059 
00060     <span class="keywordflow">return</span> count;
00061 }
00062 
00063 <span class="comment">/***************************************************************************\</span>
00064 <span class="comment">* SP_Reverse</span>
00065 <span class="comment">*</span>
00066 <span class="comment">*  reverses a string in place</span>
00067 <span class="comment">*</span>
00068 <span class="comment">* History:</span>
00069 <span class="comment">*  11-12-90  MikeHar    Ported from windows 3 asm --&gt; C</span>
00070 <span class="comment">*  12-11-90  GregoryW   fixed boundary conditions; removed count</span>
00071 <span class="comment">\***************************************************************************/</span>
00072 
<a name="l00073"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a2">00073</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/wsprintf_8c.html#a2">SP_Reverse</a>(
00074     LPSTR lpFirst,
00075     LPSTR lpLast)
00076 {
00077     <span class="keywordtype">char</span> ch;
00078 
00079     <span class="keywordflow">while</span>(lpLast &gt; lpFirst){
00080         ch = *lpFirst;
00081         *lpFirst++ = *lpLast;
00082         *lpLast-- = ch;
00083     }
00084 }
00085 
00086 <span class="comment">/***************************************************************************\</span>
00087 <span class="comment">* SP_GetFmtValue</span>
00088 <span class="comment">*</span>
00089 <span class="comment">*  reads a width or precision value from the format string</span>
00090 <span class="comment">*</span>
00091 <span class="comment">* History:</span>
00092 <span class="comment">*  11-12-90  MikeHar    Ported from windows 3</span>
00093 <span class="comment">\***************************************************************************/</span>
00094 
<a name="l00095"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a3">00095</a> LPCSTR <a class="code" href="../../d6/d0/wsprintf_8c.html#a3">SP_GetFmtValue</a>(
00096     LPCSTR lpch,
00097     <span class="keywordtype">int</span> *lpw)
00098 {
00099     <span class="keywordtype">int</span> ii = 0;
00100 
00101     <span class="comment">/* It might not work for some locales or digit sets */</span>
00102     <span class="keywordflow">while</span> (*lpch &gt;= <span class="charliteral">'0'</span> &amp;&amp; *lpch &lt;= <span class="charliteral">'9'</span>) {
00103         ii *= 10;
00104         ii += (<span class="keywordtype">int</span>)(*lpch - <span class="charliteral">'0'</span>);
00105         lpch++;
00106     }
00107 
00108     *lpw = ii;
00109 
00110     <span class="comment">/*</span>
00111 <span class="comment">     * return the address of the first non-digit character</span>
00112 <span class="comment">     */</span>
00113     <span class="keywordflow">return</span> lpch;
00114 }
00115 
00116 <span class="comment">/***************************************************************************\</span>
00117 <span class="comment">* SP_GetFmtValueW</span>
00118 <span class="comment">*</span>
00119 <span class="comment">*  reads a width or precision value from the format string</span>
00120 <span class="comment">*</span>
00121 <span class="comment">* History:</span>
00122 <span class="comment">*  11-12-90  MikeHar    Ported from windows 3</span>
00123 <span class="comment">*  07-27-92  GregoryW   Created Unicode version (copied from SP_GetFmtValue)</span>
00124 <span class="comment">\***************************************************************************/</span>
00125 
<a name="l00126"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a4">00126</a> LPCWSTR <a class="code" href="../../d6/d0/wsprintf_8c.html#a4">SP_GetFmtValueW</a>(
00127     LPCWSTR lpch,
00128     <span class="keywordtype">int</span> *lpw)
00129 {
00130     <span class="keywordtype">int</span> ii = 0;
00131 
00132     <span class="comment">/* It might not work for some locales or digit sets */</span>
00133     <span class="keywordflow">while</span> (*lpch &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span> &amp;&amp; *lpch &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>) {
00134         ii *= 10;
00135         ii += (<span class="keywordtype">int</span>)(*lpch - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
00136         lpch++;
00137     }
00138 
00139     *lpw = ii;
00140 
00141     <span class="comment">/*</span>
00142 <span class="comment">     * return the address of the first non-digit character</span>
00143 <span class="comment">     */</span>
00144     <span class="keywordflow">return</span> lpch;
00145 }
00146 
00147 <span class="comment">/***************************************************************************\</span>
00148 <span class="comment">* wvsprintfA (API)</span>
00149 <span class="comment">*</span>
00150 <span class="comment">* Windows version of vsprintf().  Does not support floating point or</span>
00151 <span class="comment">* pointer types, and all strings are assumed to be FAR.  Supports only</span>
00152 <span class="comment">* the left alignment flag.</span>
00153 <span class="comment">*</span>
00154 <span class="comment">* Takes pointers to an output buffer, where the string is built, a</span>
00155 <span class="comment">* pointer to an input buffer, and a pointer to a list of parameters.</span>
00156 <span class="comment">*</span>
00157 <span class="comment">* The cdecl function wsprintf() calls this function.</span>
00158 <span class="comment">*</span>
00159 <span class="comment">* History:</span>
00160 <span class="comment">* 11-12-90 MikeHar      Ported from windows 3</span>
00161 <span class="comment">* 12-11-90 GregoryW     after %d format is parsed lpParms needs to be aligned</span>
00162 <span class="comment">*                       to a dword boundary.</span>
00163 <span class="comment">* 09-Aug-1991 mikeke    no it doesn't</span>
00164 <span class="comment">* 11-19-91 DarrinM      Now wvsprintf and wsprintf treat parameters the same</span>
00165 <span class="comment">*                       (as if they originated from a DWORD-aligned stack).</span>
00166 <span class="comment">\***************************************************************************/</span>
00167 
<a name="l00168"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a5">00168</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/wsprintf_8c.html#a5">wvsprintfA</a>(
00169     LPSTR lpOut,
00170     LPCSTR lpFmt,
00171     va_list arglist)
00172 {
00173     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAllocateMem;
00174     <span class="keywordtype">char</span> prefix, fillch;
00175     <span class="keywordtype">int</span> left, width, prec, size, sign, radix, upper, hprefix;
00176     <span class="keywordtype">int</span> cchLimit = WSPRINTF_LIMIT, cch;
00177     LPSTR lpT, lpTMB;
00178     LPWSTR pwsz;
00179     va_list varglist = arglist;
00180     <span class="keyword">union </span>{
00181         LONG_PTR l;
00182         ULONG_PTR ul;
00183         <span class="keywordtype">char</span> sz[2];
00184         WCHAR wsz[2];
00185     } val;
00186 
00187     <span class="keywordflow">while</span> (*lpFmt != 0) {
00188         <span class="keywordflow">if</span> (*lpFmt == <span class="charliteral">'%'</span>) {
00189 
00190             <span class="comment">/*</span>
00191 <span class="comment">             * read the flags.  These can be in any order</span>
00192 <span class="comment">             */</span>
00193             left = 0;
00194             prefix = 0;
00195             <span class="keywordflow">while</span> (*++lpFmt) {
00196                 <span class="keywordflow">if</span> (*lpFmt == <span class="charliteral">'-'</span>)
00197                     left++;
00198                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*lpFmt == <span class="charliteral">'#'</span>)
00199                     prefix++;
00200                 <span class="keywordflow">else</span>
00201                     <span class="keywordflow">break</span>;
00202             }
00203 
00204             <span class="comment">/*</span>
00205 <span class="comment">             * find fill character</span>
00206 <span class="comment">             */</span>
00207             <span class="keywordflow">if</span> (*lpFmt == <span class="charliteral">'0'</span>) {
00208                 fillch = <span class="charliteral">'0'</span>;
00209                 lpFmt++;
00210             } <span class="keywordflow">else</span>
00211                 fillch = <span class="charliteral">' '</span>;
00212 
00213             <span class="comment">/*</span>
00214 <span class="comment">             * read the width specification</span>
00215 <span class="comment">             */</span>
00216             lpFmt = <a class="code" href="../../d6/d0/wsprintf_8c.html#a3">SP_GetFmtValue</a>((LPCSTR)lpFmt, &amp;cch);
00217             width = cch;
00218 
00219             <span class="comment">/*</span>
00220 <span class="comment">             * read the precision</span>
00221 <span class="comment">             */</span>
00222             <span class="keywordflow">if</span> (*lpFmt == <span class="charliteral">'.'</span>) {
00223                 lpFmt = <a class="code" href="../../d6/d0/wsprintf_8c.html#a3">SP_GetFmtValue</a>((LPCSTR)++lpFmt, &amp;cch);
00224                 prec = cch;
00225             } <span class="keywordflow">else</span>
00226                 prec = -1;
00227 
00228             <span class="comment">/*</span>
00229 <span class="comment">             * get the operand size</span>
00230 <span class="comment">             * default size: size == 0</span>
00231 <span class="comment">             * long number:  size == 1</span>
00232 <span class="comment">             * wide chars:   size == 2</span>
00233 <span class="comment">             * It may be a good idea to check the value of size when it</span>
00234 <span class="comment">             * is tested for non-zero below (IanJa)</span>
00235 <span class="comment">             */</span>
00236             hprefix = 0;
00237             <span class="keywordflow">if</span> (*lpFmt == <span class="charliteral">'w'</span>) {
00238                 size = 2;
00239                 lpFmt++;
00240             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*lpFmt == <span class="charliteral">'l'</span>) {
00241                 size = 1;
00242                 lpFmt++;
00243             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*lpFmt == <span class="charliteral">'t'</span>) {
00244                 size = 0;
00245                 lpFmt++;
00246             } <span class="keywordflow">else</span> {
00247                 size = 0;
00248                 <span class="keywordflow">if</span> (*lpFmt == <span class="charliteral">'h'</span>) {
00249                     lpFmt++;
00250                     hprefix = 1;
00251                 }
00252             }
00253 
00254             upper = 0;
00255             sign = 0;
00256             radix = 10;
00257 
00258             <span class="keywordflow">switch</span> (*lpFmt) {
00259             <span class="keywordflow">case</span> 0:
00260                 <span class="keywordflow">goto</span> errorout;
00261 
00262             <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00263             <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00264                 size=1;
00265                 sign++;
00266 
00267                 <span class="comment">/*** FALL THROUGH to case 'u' ***/</span>
00268 
00269             <span class="keywordflow">case</span> <span class="charliteral">'u'</span>:
00270                 <span class="comment">/* turn off prefix if decimal */</span>
00271                 prefix = 0;
00272 donumeric:
00273                 <span class="comment">/* special cases to act like MSC v5.10 */</span>
00274                 <span class="keywordflow">if</span> (left || prec &gt;= 0)
00275                     fillch = <span class="charliteral">' '</span>;
00276 
00277                 <span class="comment">/*</span>
00278 <span class="comment">                 * if size == 1, "%lu" was specified (good);</span>
00279 <span class="comment">                 * if size == 2, "%wu" was specified (bad)</span>
00280 <span class="comment">                 * if size == 3, "%p" was specified</span>
00281 <span class="comment">                 */</span>
00282                 <span class="keywordflow">if</span> (size == 3) {
00283                     val.l = va_arg(varglist, LONG_PTR);
00284                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size) {
00285                     val.l = va_arg(varglist, <span class="keywordtype">long</span>);
00286                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sign) {
00287                     val.l = (<span class="keywordtype">long</span>)va_arg(varglist, <span class="keywordtype">short</span>);
00288                 } <span class="keywordflow">else</span> {
00289                     val.ul = va_arg(varglist, <span class="keywordtype">unsigned</span>);
00290                 }
00291 
00292                 <span class="keywordflow">if</span> (sign &amp;&amp; val.l &lt; 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)
00293                     val.l = -val.l;
00294                 <span class="keywordflow">else</span>
00295                     sign = 0;
00296 
00297                 <span class="comment">/*</span>
00298 <span class="comment">                 * Unless printing a full 64-bit value, ensure values</span>
00299 <span class="comment">                 * here are not in canonical longword format to prevent</span>
00300 <span class="comment">                 * the sign extended upper 32-bits from being printed.</span>
00301 <span class="comment">                 */</span>
00302                 <span class="keywordflow">if</span> (size != 3) {
00303                     val.l &amp;= MAXULONG;
00304                 }
00305 
00306                 lpT = lpOut;
00307 
00308                 <span class="comment">/*</span>
00309 <span class="comment">                 * blast the number backwards into the user buffer</span>
00310 <span class="comment">                 */</span>
00311                 cch = <a class="code" href="../../d6/d0/wsprintf_8c.html#a1">SP_PutNumber</a>(lpOut, val.l, cchLimit, radix, upper);
00312                 <span class="keywordflow">if</span> (!(cchLimit -= cch))
00313                     <span class="keywordflow">goto</span> errorout;
00314 
00315                 lpOut += cch;
00316                 width -= cch;
00317                 prec -= cch;
00318                 <span class="keywordflow">if</span> (prec &gt; 0)
00319                     width -= prec;
00320 
00321                 <span class="comment">/*</span>
00322 <span class="comment">                 * fill to the field precision</span>
00323 <span class="comment">                 */</span>
00324                 <span class="keywordflow">while</span> (prec-- &gt; 0)
00325                     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<span class="charliteral">'0'</span>);
00326 
00327                 <span class="keywordflow">if</span> (width &gt; 0 &amp;&amp; !left) {
00328                     <span class="comment">/*</span>
00329 <span class="comment">                     * if we're filling with spaces, put sign first</span>
00330 <span class="comment">                     */</span>
00331                     <span class="keywordflow">if</span> (fillch != <span class="charliteral">'0'</span>) {
00332                         <span class="keywordflow">if</span> (sign) {
00333                             sign = 0;
00334                             <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<span class="charliteral">'-'</span>);
00335                             width--;
00336                         }
00337 
00338                         <span class="keywordflow">if</span> (prefix) {
00339                             <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(prefix);
00340                             <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<span class="charliteral">'0'</span>);
00341                             prefix = 0;
00342                         }
00343                     }
00344 
00345                     <span class="keywordflow">if</span> (sign)
00346                         width--;
00347 
00348                     <span class="comment">/*</span>
00349 <span class="comment">                     * fill to the field width</span>
00350 <span class="comment">                     */</span>
00351                     <span class="keywordflow">while</span> (width-- &gt; 0)
00352                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(fillch);
00353 
00354                     <span class="comment">/*</span>
00355 <span class="comment">                     * still have a sign?</span>
00356 <span class="comment">                     */</span>
00357                     <span class="keywordflow">if</span> (sign)
00358                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<span class="charliteral">'-'</span>);
00359 
00360                     <span class="keywordflow">if</span> (prefix) {
00361                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(prefix);
00362                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<span class="charliteral">'0'</span>);
00363                     }
00364 
00365                     <span class="comment">/*</span>
00366 <span class="comment">                     * now reverse the string in place</span>
00367 <span class="comment">                     */</span>
00368                     <a class="code" href="../../d6/d0/wsprintf_8c.html#a2">SP_Reverse</a>(lpT, lpOut - 1);
00369                 } <span class="keywordflow">else</span> {
00370                     <span class="comment">/*</span>
00371 <span class="comment">                     * add the sign character</span>
00372 <span class="comment">                     */</span>
00373                     <span class="keywordflow">if</span> (sign) {
00374                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<span class="charliteral">'-'</span>);
00375                         width--;
00376                     }
00377 
00378                     <span class="keywordflow">if</span> (prefix) {
00379                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(prefix);
00380                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<span class="charliteral">'0'</span>);
00381                     }
00382 
00383                     <span class="comment">/*</span>
00384 <span class="comment">                     * reverse the string in place</span>
00385 <span class="comment">                     */</span>
00386                     <a class="code" href="../../d6/d0/wsprintf_8c.html#a2">SP_Reverse</a>(lpT, lpOut - 1);
00387 
00388                     <span class="comment">/*</span>
00389 <span class="comment">                     * pad to the right of the string in case left aligned</span>
00390 <span class="comment">                     */</span>
00391                     <span class="keywordflow">while</span> (width-- &gt; 0)
00392                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(fillch);
00393                 }
00394                 <span class="keywordflow">break</span>;
00395 
00396             <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
00397                 size = 3;
00398                 <span class="keywordflow">if</span> (prec == -1) {
00399                     prec = 2 * <span class="keyword">sizeof</span>(LONG_PTR);
00400                 }
00401 
00402                 <span class="comment">/*** FALL THROUGH to case 'X' ***/</span>
00403 
00404             <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
00405                 upper++;
00406 
00407                 <span class="comment">/*** FALL THROUGH to case 'x' ***/</span>
00408 
00409             <span class="keywordflow">case</span> <span class="charliteral">'x'</span>:
00410                 radix = 16;
00411                 <span class="keywordflow">if</span> (prefix)
00412                     <span class="keywordflow">if</span> (upper)
00413                         prefix = <span class="charliteral">'X'</span>;
00414                     <span class="keywordflow">else</span>
00415                         prefix = <span class="charliteral">'x'</span>;
00416                 <span class="keywordflow">goto</span> donumeric;
00417 
00418             <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
00419                 <span class="comment">/*</span>
00420 <span class="comment">                 * explicit size specifier overrides case</span>
00421 <span class="comment">                 */</span>
00422                 <span class="keywordflow">if</span> (!size &amp;&amp; !hprefix) {
00423                     size = 1;           <span class="comment">// force WCHAR</span>
00424                 }
00425 
00426                 <span class="comment">/*** FALL THROUGH to case 'c' ***/</span>
00427 
00428             <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
00429                 <span class="comment">/*</span>
00430 <span class="comment">                 * if size == 0, "%c" or "%hc" or "%tc" was specified (CHAR)</span>
00431 <span class="comment">                 * if size == 1, "%C" or "%lc" was specified (WCHAR);</span>
00432 <span class="comment">                 * if size == 2, "%wc" was specified (WCHAR)</span>
00433 <span class="comment">                 */</span>
00434                 cch = 1; <span class="comment">/* One character must be copied to the output buffer */</span>
00435                 <span class="keywordflow">if</span> (size) {
00436                     val.wsz[0] = va_arg(varglist, WCHAR);
00437                     val.wsz[1] = 0x0000;
00438                     pwsz = val.wsz;
00439                     <span class="keywordflow">goto</span> putwstring;
00440                 } <span class="keywordflow">else</span> {
00441                     val.sz[0] = va_arg(varglist, <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
00442                     val.sz[1] = 0;
00443                     lpT = val.sz;
00444                     <span class="keywordflow">goto</span> putstring;
00445                 }
00446 
00447             <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00448                 <span class="comment">/*</span>
00449 <span class="comment">                 * explicit size specifier overrides case</span>
00450 <span class="comment">                 */</span>
00451                 <span class="keywordflow">if</span> (!size &amp;&amp; !hprefix) {
00452                     size = 1;           <span class="comment">// force LPWSTR</span>
00453                 }
00454 
00455                 <span class="comment">/*** FALL THROUGH to case 's' ***/</span>
00456 
00457             <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00458                 <span class="comment">/*</span>
00459 <span class="comment">                 * if size == 0, "%s" or "%hs" or "%ts" was specified (LPSTR);</span>
00460 <span class="comment">                 * if size == 1, "%S" or "%ls" was specified (LPWSTR);</span>
00461 <span class="comment">                 * if size == 2, "%ws" was specified (LPWSTR)</span>
00462 <span class="comment">                 */</span>
00463                 <span class="keywordflow">if</span> (size) {
00464                     pwsz = va_arg(varglist, LPWSTR);
00465                     <span class="keywordflow">if</span> (pwsz == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00466                         cch = 0;
00467                     } <span class="keywordflow">else</span> {
00468                         cch = wcslen(pwsz);
00469                     }
00470 putwstring:
00471                     cch = WCSToMB(pwsz, cch, &amp;lpTMB, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00472                     fAllocateMem = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) cch;
00473                     lpT = lpTMB;
00474                 } <span class="keywordflow">else</span> {
00475                     lpT = va_arg(varglist, LPSTR);
00476                     <span class="keywordflow">if</span> (lpT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00477                         cch = 0;
00478                     } <span class="keywordflow">else</span> {
00479                         cch = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpT);
00480                     }
00481 
00482 putstring:
00483                     fAllocateMem = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00484                 }
00485 
00486                 <span class="keywordflow">if</span> (prec &gt;= 0 &amp;&amp; cch &gt; prec)
00487                     cch = prec;
00488                 width -= cch;
00489 
00490                 <span class="keywordflow">if</span> (fAllocateMem) {
00491                     <span class="keywordflow">if</span> (cch + (width &lt; 0 ? 0 : width) &gt;= cchLimit) {
00492                         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpTMB);
00493                         <span class="keywordflow">goto</span> errorout;
00494                     }
00495                 }
00496 
00497                 <span class="keywordflow">if</span> (left) {
00498                     <span class="keywordflow">while</span> (cch--)
00499                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(*lpT++);
00500                     <span class="keywordflow">while</span> (width-- &gt; 0)
00501                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(fillch);
00502                 } <span class="keywordflow">else</span> {
00503                     <span class="keywordflow">while</span> (width-- &gt; 0)
00504                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(fillch);
00505                     <span class="keywordflow">while</span> (cch--)
00506                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(*lpT++);
00507                 }
00508 
00509                 <span class="keywordflow">if</span> (fAllocateMem) {
00510                      <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpTMB);
00511                 }
00512                 <span class="keywordflow">break</span>;
00513 
00514             <span class="keywordflow">default</span>:
00515 normalch:
00516                 <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(*lpFmt);
00517                 <span class="keywordflow">break</span>;
00518             }  <span class="comment">/* END OF SWITCH(*lpFmt) */</span>
00519         }  <span class="comment">/* END OF IF(%) */</span> <span class="keywordflow">else</span>
00520             <span class="keywordflow">goto</span> normalch;  <span class="comment">/* character not a '%', just do it */</span>
00521 
00522         <span class="comment">/*</span>
00523 <span class="comment">         * advance to next format string character</span>
00524 <span class="comment">         */</span>
00525         lpFmt++;
00526     }  <span class="comment">/* END OF OUTER WHILE LOOP */</span>
00527 
00528 errorout:
00529     *lpOut = 0;
00530 
00531     <span class="keywordflow">return</span> WSPRINTF_LIMIT - cchLimit;
00532 }
00533 
00534 <span class="comment">/***************************************************************************\</span>
00535 <span class="comment">* StringPrintfA (API)</span>
00536 <span class="comment">*</span>
00537 <span class="comment">* Windows version of sprintf</span>
00538 <span class="comment">*</span>
00539 <span class="comment">* History:</span>
00540 <span class="comment">* 11-12-90 MikeHar      Ported from windows 3</span>
00541 <span class="comment">* 02-05-90 DarrinM      Cleaned up with STDARG.h vararg stuff.</span>
00542 <span class="comment">\***************************************************************************/</span>
00543 
<a name="l00544"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a6">00544</a> <span class="keywordtype">int</span> WINAPIV <a class="code" href="../../d6/d0/wsprintf_8c.html#a6">wsprintfA</a>(
00545     LPSTR lpOut,
00546     LPCSTR lpFmt,
00547     ...)
00548 {
00549     va_list arglist;
00550     <span class="keywordtype">int</span> ret;
00551 
00552     va_start(arglist, lpFmt);
00553     ret = <a class="code" href="../../d6/d0/wsprintf_8c.html#a5">wvsprintfA</a>(lpOut, lpFmt, arglist);
00554     va_end(arglist);
00555     <span class="keywordflow">return</span> ret;
00556 }
00557 
00558 <span class="comment">/***************************************************************************\</span>
00559 <span class="comment">* SP_PutNumberW</span>
00560 <span class="comment">*</span>
00561 <span class="comment">* Takes an unsigned long integer and places it into a buffer, respecting</span>
00562 <span class="comment">* a buffer limit, a radix, and a case select (upper or lower, for hex).</span>
00563 <span class="comment">*</span>
00564 <span class="comment">*</span>
00565 <span class="comment">* History:</span>
00566 <span class="comment">*  11-12-90  MikeHar    Ported from windows 3 asm --&gt; C</span>
00567 <span class="comment">*  12-11-90  GregoryW   need to increment lpstr after assignment of mod</span>
00568 <span class="comment">*  02-11-92  GregoryW   temporary version until we have C runtime support</span>
00569 <span class="comment">\***************************************************************************/</span>
00570 
<a name="l00571"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a7">00571</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/wsprintf_8c.html#a7">SP_PutNumberW</a>(
00572     LPWSTR lpstr,
00573     ULONG_PTR n,
00574     <span class="keywordtype">int</span>   limit,
00575     DWORD radix,
00576     <span class="keywordtype">int</span>   uppercase)
00577 {
00578     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> mod;
00579     <span class="keywordtype">int</span> count = 0;
00580 
00581     <span class="comment">/* It might not work for some locales or digit sets */</span>
00582     <span class="keywordflow">if</span>(uppercase)
00583         uppercase =  <span class="charliteral">'A'</span>-<span class="charliteral">'0'</span>-10;
00584     <span class="keywordflow">else</span>
00585         uppercase = <span class="charliteral">'a'</span>-<span class="charliteral">'0'</span>-10;
00586 
00587     <span class="keywordflow">if</span> (count &lt; limit) {
00588         <span class="keywordflow">do</span>  {
00589             mod =  (ULONG)(<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> % radix);
00590             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> /= radix;
00591 
00592             mod += <span class="charliteral">'0'</span>;
00593             <span class="keywordflow">if</span> (mod &gt; <span class="charliteral">'9'</span>)
00594             mod += uppercase;
00595             *lpstr++ = (WCHAR)mod;
00596             count++;
00597         } <span class="keywordflow">while</span>((count &lt; limit) &amp;&amp; <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>);
00598     }
00599 
00600     <span class="keywordflow">return</span> count;
00601 }
00602 
00603 <span class="comment">/***************************************************************************\</span>
00604 <span class="comment">* SP_ReverseW</span>
00605 <span class="comment">*</span>
00606 <span class="comment">*  reverses a string in place</span>
00607 <span class="comment">*</span>
00608 <span class="comment">* History:</span>
00609 <span class="comment">*  11-12-90  MikeHar    Ported from windows 3 asm --&gt; C</span>
00610 <span class="comment">*  12-11-90  GregoryW   fixed boundary conditions; removed count</span>
00611 <span class="comment">*  02-11-92  GregoryW   temporary version until we have C runtime support</span>
00612 <span class="comment">\***************************************************************************/</span>
00613 
<a name="l00614"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a8">00614</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/wsprintf_8c.html#a8">SP_ReverseW</a>(
00615     LPWSTR lpFirst,
00616     LPWSTR lpLast)
00617 {
00618     WCHAR ch;
00619 
00620     <span class="keywordflow">while</span>(lpLast &gt; lpFirst){
00621         ch = *lpFirst;
00622         *lpFirst++ = *lpLast;
00623         *lpLast-- = ch;
00624     }
00625 }
00626 
00627 
00628 <span class="comment">/***************************************************************************\</span>
00629 <span class="comment">* wvsprintfW (API)</span>
00630 <span class="comment">*</span>
00631 <span class="comment">* wsprintfW() calls this function.</span>
00632 <span class="comment">*</span>
00633 <span class="comment">* History:</span>
00634 <span class="comment">*    11-Feb-1992 GregoryW copied xwvsprintf</span>
00635 <span class="comment">*         Temporary hack until we have C runtime support</span>
00636 <span class="comment">\***************************************************************************/</span>
00637 
<a name="l00638"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a9">00638</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/wsprintf_8c.html#a9">wvsprintfW</a>(
00639     LPWSTR lpOut,
00640     LPCWSTR lpFmt,
00641     va_list arglist)
00642 {
00643     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAllocateMem;
00644     WCHAR prefix, fillch;
00645     <span class="keywordtype">int</span> left, width, prec, size, sign, radix, upper, hprefix;
00646     <span class="keywordtype">int</span> cchLimit = WSPRINTF_LIMIT, cch;
00647     LPWSTR lpT, lpTWC;
00648     LPBYTE psz;
00649     va_list varglist = arglist;
00650     <span class="keyword">union </span>{
00651         LONG_PTR l;
00652         ULONG_PTR ul;
00653         <span class="keywordtype">char</span> sz[2];
00654         WCHAR wsz[2];
00655     } val;
00656 
00657     <span class="keywordflow">while</span> (*lpFmt != 0) {
00658         <span class="keywordflow">if</span> (*lpFmt == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'%'</span>) {
00659 
00660             <span class="comment">/*</span>
00661 <span class="comment">             * read the flags.  These can be in any order</span>
00662 <span class="comment">             */</span>
00663             left = 0;
00664             prefix = 0;
00665             <span class="keywordflow">while</span> (*++lpFmt) {
00666                 <span class="keywordflow">if</span> (*lpFmt == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'-'</span>)
00667                     left++;
00668                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*lpFmt == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'#'</span>)
00669                     prefix++;
00670                 <span class="keywordflow">else</span>
00671                     <span class="keywordflow">break</span>;
00672             }
00673 
00674             <span class="comment">/*</span>
00675 <span class="comment">             * find fill character</span>
00676 <span class="comment">             */</span>
00677             <span class="keywordflow">if</span> (*lpFmt == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>) {
00678                 fillch = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>;
00679                 lpFmt++;
00680             } <span class="keywordflow">else</span>
00681                 fillch = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>;
00682 
00683             <span class="comment">/*</span>
00684 <span class="comment">             * read the width specification</span>
00685 <span class="comment">             */</span>
00686             lpFmt = <a class="code" href="../../d6/d0/wsprintf_8c.html#a4">SP_GetFmtValueW</a>(lpFmt, &amp;cch);
00687             width = cch;
00688 
00689             <span class="comment">/*</span>
00690 <span class="comment">             * read the precision</span>
00691 <span class="comment">             */</span>
00692             <span class="keywordflow">if</span> (*lpFmt == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>) {
00693                 lpFmt = <a class="code" href="../../d6/d0/wsprintf_8c.html#a4">SP_GetFmtValueW</a>(++lpFmt, &amp;cch);
00694                 prec = cch;
00695             } <span class="keywordflow">else</span>
00696                 prec = -1;
00697 
00698             <span class="comment">/*</span>
00699 <span class="comment">             * get the operand size</span>
00700 <span class="comment">             * default size: size == 0</span>
00701 <span class="comment">             * long number:  size == 1</span>
00702 <span class="comment">             * wide chars:   size == 2</span>
00703 <span class="comment">             * It may be a good idea to check the value of size when it</span>
00704 <span class="comment">             * is tested for non-zero below (IanJa)</span>
00705 <span class="comment">             */</span>
00706             hprefix = 0;
00707             <span class="keywordflow">if</span> ((*lpFmt == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'w'</span>) || (*lpFmt == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'t'</span>)) {
00708                 size = 2;
00709                 lpFmt++;
00710             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*lpFmt == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'l'</span>) {
00711                 size = 1;
00712                 lpFmt++;
00713             } <span class="keywordflow">else</span> {
00714                 size = 0;
00715                 <span class="keywordflow">if</span> (*lpFmt == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'h'</span>) {
00716                     lpFmt++;
00717                     hprefix = 1;
00718                 }
00719             }
00720 
00721             upper = 0;
00722             sign = 0;
00723             radix = 10;
00724 
00725             <span class="keywordflow">switch</span> (*lpFmt) {
00726             <span class="keywordflow">case</span> 0:
00727                 <span class="keywordflow">goto</span> errorout;
00728 
00729             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'i'</span>:
00730             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'d'</span>:
00731                 size=1;
00732                 sign++;
00733 
00734                 <span class="comment">/*** FALL THROUGH to case 'u' ***/</span>
00735 
00736             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'u'</span>:
00737                 <span class="comment">/* turn off prefix if decimal */</span>
00738                 prefix = 0;
00739 donumeric:
00740                 <span class="comment">/* special cases to act like MSC v5.10 */</span>
00741                 <span class="keywordflow">if</span> (left || prec &gt;= 0)
00742                     fillch = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>;
00743 
00744                 <span class="comment">/*</span>
00745 <span class="comment">                 * if size == 1, "%lu" was specified (good);</span>
00746 <span class="comment">                 * if size == 2, "%wu" was specified (bad)</span>
00747 <span class="comment">                 * if size == 3, "%p" was specified</span>
00748 <span class="comment">                 */</span>
00749                 <span class="keywordflow">if</span> (size == 3) {
00750                     val.l = va_arg(varglist, LONG_PTR);
00751                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size) {
00752                     val.l = va_arg(varglist, LONG);
00753                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sign) {
00754                     val.l = va_arg(varglist, <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>);
00755                 } <span class="keywordflow">else</span> {
00756                     val.ul = va_arg(varglist, <span class="keywordtype">unsigned</span>);
00757                 }
00758 
00759                 <span class="keywordflow">if</span> (sign &amp;&amp; val.l &lt; 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)
00760                     val.l = -val.l;
00761                 <span class="keywordflow">else</span>
00762                     sign = 0;
00763 
00764                 <span class="comment">/*</span>
00765 <span class="comment">                 * Unless printing a full 64-bit value, ensure values</span>
00766 <span class="comment">                 * here are not in canonical longword format to prevent</span>
00767 <span class="comment">                 * the sign extended upper 32-bits from being printed.</span>
00768 <span class="comment">                 */</span>
00769                 <span class="keywordflow">if</span> (size != 3) {
00770                     val.l &amp;= MAXULONG;
00771                 }
00772 
00773                 lpT = lpOut;
00774 
00775                 <span class="comment">/*</span>
00776 <span class="comment">                 * blast the number backwards into the user buffer</span>
00777 <span class="comment">                 */</span>
00778                 cch = <a class="code" href="../../d6/d0/wsprintf_8c.html#a7">SP_PutNumberW</a>(lpOut, val.l, cchLimit, radix, upper);
00779                 <span class="keywordflow">if</span> (!(cchLimit -= cch))
00780                     <span class="keywordflow">goto</span> errorout;
00781 
00782                 lpOut += cch;
00783                 width -= cch;
00784                 prec -= cch;
00785                 <span class="keywordflow">if</span> (prec &gt; 0)
00786                     width -= prec;
00787 
00788                 <span class="comment">/*</span>
00789 <span class="comment">                 * fill to the field precision</span>
00790 <span class="comment">                 */</span>
00791                 <span class="keywordflow">while</span> (prec-- &gt; 0)
00792                     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
00793 
00794                 <span class="keywordflow">if</span> (width &gt; 0 &amp;&amp; !left) {
00795                     <span class="comment">/*</span>
00796 <span class="comment">                     * if we're filling with spaces, put sign first</span>
00797 <span class="comment">                     */</span>
00798                     <span class="keywordflow">if</span> (fillch != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>) {
00799                         <span class="keywordflow">if</span> (sign) {
00800                             sign = 0;
00801                             <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'-'</span>);
00802                             width--;
00803                         }
00804 
00805                         <span class="keywordflow">if</span> (prefix) {
00806                             <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(prefix);
00807                             <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
00808                             prefix = 0;
00809                         }
00810                     }
00811 
00812                     <span class="keywordflow">if</span> (sign)
00813                         width--;
00814 
00815                     <span class="comment">/*</span>
00816 <span class="comment">                     * fill to the field width</span>
00817 <span class="comment">                     */</span>
00818                     <span class="keywordflow">while</span> (width-- &gt; 0)
00819                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(fillch);
00820 
00821                     <span class="comment">/*</span>
00822 <span class="comment">                     * still have a sign?</span>
00823 <span class="comment">                     */</span>
00824                     <span class="keywordflow">if</span> (sign)
00825                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'-'</span>);
00826 
00827                     <span class="keywordflow">if</span> (prefix) {
00828                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(prefix);
00829                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
00830                     }
00831 
00832                     <span class="comment">/*</span>
00833 <span class="comment">                     * now reverse the string in place</span>
00834 <span class="comment">                     */</span>
00835                     <a class="code" href="../../d6/d0/wsprintf_8c.html#a8">SP_ReverseW</a>(lpT, lpOut - 1);
00836                 } <span class="keywordflow">else</span> {
00837                     <span class="comment">/*</span>
00838 <span class="comment">                     * add the sign character</span>
00839 <span class="comment">                     */</span>
00840                     <span class="keywordflow">if</span> (sign) {
00841                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'-'</span>);
00842                         width--;
00843                     }
00844 
00845                     <span class="keywordflow">if</span> (prefix) {
00846                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(prefix);
00847                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
00848                     }
00849 
00850                     <span class="comment">/*</span>
00851 <span class="comment">                     * reverse the string in place</span>
00852 <span class="comment">                     */</span>
00853                     <a class="code" href="../../d6/d0/wsprintf_8c.html#a8">SP_ReverseW</a>(lpT, lpOut - 1);
00854 
00855                     <span class="comment">/*</span>
00856 <span class="comment">                     * pad to the right of the string in case left aligned</span>
00857 <span class="comment">                     */</span>
00858                     <span class="keywordflow">while</span> (width-- &gt; 0)
00859                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(fillch);
00860                 }
00861                 <span class="keywordflow">break</span>;
00862 
00863             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'p'</span>:
00864                 size = 3;
00865                 <span class="keywordflow">if</span> (prec == -1) {
00866                     prec = 2 * <span class="keyword">sizeof</span>(LONG_PTR);
00867                 }
00868 
00869                 <span class="comment">/*** FALL THROUGH to case 'X' ***/</span>
00870 
00871             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'X'</span>:
00872                 upper++;
00873 
00874                 <span class="comment">/*** FALL THROUGH to case 'x' ***/</span>
00875 
00876             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'x'</span>:
00877                 radix = 16;
00878                 <span class="keywordflow">if</span> (prefix)
00879                     <span class="keywordflow">if</span> (upper)
00880                         prefix = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'X'</span>;
00881                     <span class="keywordflow">else</span>
00882                         prefix = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'x'</span>;
00883                 <span class="keywordflow">goto</span> donumeric;
00884 
00885             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'c'</span>:
00886                 <span class="keywordflow">if</span> (!size &amp;&amp; !hprefix) {
00887                     size = 1;           <span class="comment">// force WCHAR</span>
00888                 }
00889 
00890                 <span class="comment">/*** FALL THROUGH to case 'C' ***/</span>
00891 
00892             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'C'</span>:
00893                 <span class="comment">/*</span>
00894 <span class="comment">                 * if size == 0, "%C" or "%hc" was specified (CHAR);</span>
00895 <span class="comment">                 * if size == 1, "%c" or "%lc" was specified (WCHAR);</span>
00896 <span class="comment">                 * if size == 2, "%wc" or "%tc" was specified (WCHAR)</span>
00897 <span class="comment">                 */</span>
00898                 cch = 1; <span class="comment">/* One character must be copied to the output buffer */</span>
00899                 <span class="keywordflow">if</span> (size) {
00900                     val.wsz[0] = va_arg(varglist, WCHAR);
00901                     val.wsz[1] = 0;
00902                     lpT = val.wsz;
00903                     <span class="keywordflow">goto</span> putwstring;
00904                 } <span class="keywordflow">else</span> {
00905                     val.sz[0] = va_arg(varglist, <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
00906                     val.sz[1] = 0;
00907                     psz = val.sz;
00908                     <span class="keywordflow">goto</span> putstring;
00909                 }
00910 
00911             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'s'</span>:
00912                 <span class="keywordflow">if</span> (!size &amp;&amp; !hprefix) {
00913                     size = 1;           <span class="comment">// force LPWSTR</span>
00914                 }
00915 
00916                 <span class="comment">/*** FALL THROUGH to case 'S' ***/</span>
00917 
00918             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'S'</span>:
00919                 <span class="comment">/*</span>
00920 <span class="comment">                 * if size == 0, "%S" or "%hs" was specified (LPSTR)</span>
00921 <span class="comment">                 * if size == 1, "%s" or "%ls" was specified (LPWSTR);</span>
00922 <span class="comment">                 * if size == 2, "%ws" or "%ts" was specified (LPWSTR)</span>
00923 <span class="comment">                 */</span>
00924                 <span class="keywordflow">if</span> (size) {
00925                     lpT = va_arg(varglist, LPWSTR);
00926                     <span class="keywordflow">if</span> (lpT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00927                         cch = 0;
00928                     } <span class="keywordflow">else</span> {
00929                         cch = wcslen(lpT);
00930                     }
00931 putwstring:
00932                     fAllocateMem = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00933                 } <span class="keywordflow">else</span> {
00934                     psz = va_arg(varglist, LPBYTE);
00935                     <span class="keywordflow">if</span> (psz == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00936                         cch = 0;
00937                     } <span class="keywordflow">else</span> {
00938                         cch = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(psz);
00939                     }
00940 putstring:
00941                     cch = MBToWCS(psz, cch, &amp;lpTWC, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00942                     fAllocateMem = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) cch;
00943                     lpT = lpTWC;
00944                 }
00945 
00946                 <span class="keywordflow">if</span> (prec &gt;= 0 &amp;&amp; cch &gt; prec)
00947                     cch = prec;
00948                 width -= cch;
00949 
00950                 <span class="keywordflow">if</span> (fAllocateMem) {
00951                     <span class="keywordflow">if</span> (cch + (width &lt; 0 ? 0 : width) &gt;= cchLimit) {
00952                         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpTWC);
00953                         <span class="keywordflow">goto</span> errorout;
00954                     }
00955                 }
00956 
00957                 <span class="keywordflow">if</span> (left) {
00958                     <span class="keywordflow">while</span> (cch--)
00959                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(*lpT++);
00960                     <span class="keywordflow">while</span> (width-- &gt; 0)
00961                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(fillch);
00962                 } <span class="keywordflow">else</span> {
00963                     <span class="keywordflow">while</span> (width-- &gt; 0)
00964                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(fillch);
00965                     <span class="keywordflow">while</span> (cch--)
00966                         <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>(*lpT++);
00967                 }
00968 
00969                 <span class="keywordflow">if</span> (fAllocateMem) {
00970                      <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpTWC);
00971                 }
00972 
00973                 <span class="keywordflow">break</span>;
00974 
00975             <span class="keywordflow">default</span>:
00976 normalch:
00977                 <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>((WCHAR)*lpFmt);
00978                 <span class="keywordflow">break</span>;
00979             }  <span class="comment">/* END OF SWITCH(*lpFmt) */</span>
00980         }  <span class="comment">/* END OF IF(%) */</span> <span class="keywordflow">else</span>
00981             <span class="keywordflow">goto</span> normalch;  <span class="comment">/* character not a '%', just do it */</span>
00982 
00983         <span class="comment">/*</span>
00984 <span class="comment">         * advance to next format string character</span>
00985 <span class="comment">         */</span>
00986         lpFmt++;
00987     }  <span class="comment">/* END OF OUTER WHILE LOOP */</span>
00988 
00989 errorout:
00990     *lpOut = 0;
00991 
00992     <span class="keywordflow">return</span> WSPRINTF_LIMIT - cchLimit;
00993 }
00994 
<a name="l00995"></a><a class="code" href="../../d6/d0/wsprintf_8c.html#a10">00995</a> <span class="keywordtype">int</span> WINAPIV <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(
00996     LPWSTR lpOut,
00997     LPCWSTR lpFmt,
00998     ...)
00999 {
01000     va_list arglist;
01001     <span class="keywordtype">int</span> ret;
01002 
01003     va_start(arglist, lpFmt);
01004     ret = <a class="code" href="../../d6/d0/wsprintf_8c.html#a9">wvsprintfW</a>(lpOut, lpFmt, arglist);
01005     va_end(arglist);
01006     <span class="keywordflow">return</span> ret;
01007 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
