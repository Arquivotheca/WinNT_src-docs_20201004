<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ctaccess.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ctaccess.c</h1><a href="../../d6/d0/ctaccess_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ctaccess.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Common access validation test routines</span>
00012 <span class="comment"></span>
00013 <span class="comment">    These routines are used in both kernel and user mode tests.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    This test assumes the security runtime library routines are</span>
00016 <span class="comment">    functioning correctly.</span>
00017 <span class="comment"></span>
00018 <span class="comment"></span>
00019 <span class="comment">Author:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Robert Reichel      (robertre)      12/14/90</span>
00022 <span class="comment"></span>
00023 <span class="comment">Environment:</span>
00024 <span class="comment"></span>
00025 <span class="comment">    Test of access validation routines</span>
00026 <span class="comment"></span>
00027 <span class="comment">Revision History:</span>
00028 <span class="comment"></span>
00029 <span class="comment">    v1: robertre</span>
00030 <span class="comment">        Created</span>
00031 <span class="comment"></span>
00032 <span class="comment">--*/</span>
00033 
00034 <span class="preprocessor">#include "<a class="code" href="../../d2/d6/tsecomm_8c.html">tsecomm.c</a>"</span>    <span class="comment">// Mode dependent macros and routines.</span>
00035 
00036 
00037 
00038 <span class="comment">//</span>
00039 <span class="comment">//  Define the local macros and procedure for this module</span>
00040 <span class="comment">//</span>
00041 
00042 <span class="comment">//</span>
00043 <span class="comment">//  Return a pointer to the first Ace in an Acl (even if the Acl is empty).</span>
00044 <span class="comment">//</span>
00045 <span class="comment">//      PACE_HEADER</span>
00046 <span class="comment">//      FirstAce (</span>
00047 <span class="comment">//          IN PACL Acl</span>
00048 <span class="comment">//          );</span>
00049 <span class="comment">//</span>
00050 
<a name="l00051"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a0">00051</a> <span class="preprocessor">#define FirstAce(Acl) ((PVOID)((PUCHAR)(Acl) + sizeof(ACL)))</span>
00052 <span class="preprocessor"></span>
00053 <span class="comment">//</span>
00054 <span class="comment">//  Return a pointer to the next Ace in a sequence (even if the input</span>
00055 <span class="comment">//  Ace is the one in the sequence).</span>
00056 <span class="comment">//</span>
00057 <span class="comment">//      PACE_HEADER</span>
00058 <span class="comment">//      NextAce (</span>
00059 <span class="comment">//          IN PACE_HEADER Ace</span>
00060 <span class="comment">//          );</span>
00061 <span class="comment">//</span>
00062 
<a name="l00063"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a1">00063</a> <span class="preprocessor">#define NextAce(Ace) ((PVOID)((PUCHAR)(Ace) + ((PACE_HEADER)(Ace))-&gt;AceSize))</span>
00064 <span class="preprocessor"></span>
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 <a class="code" href="../../d6/d0/ctaccess_8c.html#a61">DumpAcl</a> (
00067     IN PACL Acl
00068     );
00069 
00071 <span class="comment">//                                                            //</span>
00072 <span class="comment">// Module wide variables                                      //</span>
00073 <span class="comment">//                                                            //</span>
00075 <span class="comment"></span>
<a name="l00076"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a2">00076</a> <span class="preprocessor">#define DEFAULT_DACL_LENGTH (1024L)</span>
<a name="l00077"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a3">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define GROUP_IDS_LENGTH (1024L)</span>
<a name="l00078"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a4">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define NEW_GROUP_STATE_LENGTH (1024L)</span>
<a name="l00079"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a5">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define PRIVILEGES_LENGTH (128L)</span>
<a name="l00080"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a6">00080</a> <span class="preprocessor"></span><span class="preprocessor">#define TOO_BIG_ACL_SIZE (2048L)</span>
00081 <span class="preprocessor"></span>
00082 <span class="comment">//</span>
00083 <span class="comment">// definitions related to TokenWithGroups</span>
00084 <span class="comment">//</span>
00085 
<a name="l00086"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a7">00086</a> <span class="preprocessor">#define FLINTSTONE_INDEX  (0L)</span>
<a name="l00087"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a8">00087</a> <span class="preprocessor"></span><span class="preprocessor">#define CHILD_INDEX       (1L)</span>
<a name="l00088"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a9">00088</a> <span class="preprocessor"></span><span class="preprocessor">#define NEANDERTHOL_INDEX (2L)</span>
<a name="l00089"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a10">00089</a> <span class="preprocessor"></span><span class="preprocessor">#define WORLD_INDEX       (3L)</span>
<a name="l00090"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a11">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define GROUP_COUNT       (4L)</span>
00091 <span class="preprocessor"></span>
00092 
00093 <span class="comment">//</span>
00094 <span class="comment">// Definitions related to TokenWithPrivileges</span>
00095 <span class="comment">//</span>
00096 
<a name="l00097"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a12">00097</a> <span class="preprocessor">#define UNSOLICITED_INDEX  (0L)</span>
<a name="l00098"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a13">00098</a> <span class="preprocessor"></span><span class="preprocessor">#define SECURITY_INDEX     (1L)</span>
<a name="l00099"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a14">00099</a> <span class="preprocessor"></span><span class="preprocessor">#define PRIVILEGE_COUNT    (2L)</span>
00100 <span class="preprocessor"></span>
00101 <span class="comment">//</span>
00102 <span class="comment">//    Access types</span>
00103 <span class="comment">//</span>
00104 
<a name="l00105"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a15">00105</a> <span class="preprocessor">#define SET_WIDGET_COLOR        0x00000001</span>
<a name="l00106"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a16">00106</a> <span class="preprocessor"></span><span class="preprocessor">#define SET_WIDGET_SIZE         0x00000002</span>
<a name="l00107"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a17">00107</a> <span class="preprocessor"></span><span class="preprocessor">#define GET_WIDGET_COLOR        0x00000004</span>
<a name="l00108"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a18">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define GET_WIDGET_SIZE         0x00000008</span>
<a name="l00109"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a19">00109</a> <span class="preprocessor"></span><span class="preprocessor">#define START_WIDGET            0x00000010</span>
<a name="l00110"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a20">00110</a> <span class="preprocessor"></span><span class="preprocessor">#define STOP_WIDGET             0x00000020</span>
<a name="l00111"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a21">00111</a> <span class="preprocessor"></span><span class="preprocessor">#define GIVE_WIDGET             0x00000040</span>
<a name="l00112"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a22">00112</a> <span class="preprocessor"></span><span class="preprocessor">#define TAKE_WIDGET             0x00000080</span>
00113 <span class="preprocessor"></span>
00114 
<a name="l00115"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a23">00115</a>     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00116 
<a name="l00117"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a24">00117</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a24">SimpleToken</a>;
<a name="l00118"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a25">00118</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a25">TokenWithGroups</a>;
<a name="l00119"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a26">00119</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a26">TokenWithDefaultOwner</a>;
<a name="l00120"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a27">00120</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a27">TokenWithPrivileges</a>;
<a name="l00121"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a28">00121</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a28">TokenWithDefaultDacl</a>;
00122 
<a name="l00123"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a29">00123</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
<a name="l00124"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a30">00124</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>;
00125 
<a name="l00126"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a31">00126</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
00127 
<a name="l00128"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a32">00128</a>     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a32">AnonymousToken</a>;
00129 
<a name="l00130"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a33">00130</a>     OBJECT_ATTRIBUTES <a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>;
<a name="l00131"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a34">00131</a>     PSECURITY_DESCRIPTOR <a class="code" href="../../d6/d0/ctaccess_8c.html#a34">PrimarySecurityDescriptor</a>;
<a name="l00132"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a35">00132</a>     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d6/d0/ctaccess_8c.html#a35">PrimarySecurityQos</a>;
00133 
<a name="l00134"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a36">00134</a>     OBJECT_ATTRIBUTES <a class="code" href="../../d6/d0/ctaccess_8c.html#a36">ImpersonationTokenAttributes</a>;
<a name="l00135"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a37">00135</a>     PSECURITY_DESCRIPTOR <a class="code" href="../../d6/d0/ctaccess_8c.html#a37">ImpersonationSecurityDescriptor</a>;
<a name="l00136"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a38">00136</a>     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>;
00137 
<a name="l00138"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a39">00138</a>     OBJECT_ATTRIBUTES <a class="code" href="../../d6/d0/ctaccess_8c.html#a39">AnonymousTokenAttributes</a>;
<a name="l00139"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a40">00139</a>     PSECURITY_DESCRIPTOR <a class="code" href="../../d6/d0/ctaccess_8c.html#a40">AnonymousSecurityDescriptor</a>;
<a name="l00140"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a41">00140</a>     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>;
00141 
<a name="l00142"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a42">00142</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a>;
<a name="l00143"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a43">00143</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
<a name="l00144"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a44">00144</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
<a name="l00145"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a45">00145</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00146 
<a name="l00147"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a46">00147</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a46">LengthAvailable</a>;
<a name="l00148"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a47">00148</a>     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>;
00149 
00150 
<a name="l00151"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a48">00151</a>     TIME_FIELDS <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a> = {3000, 1, 1, 1, 1, 1, 1, 1};
<a name="l00152"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a49">00152</a>     LARGE_INTEGER <a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>;
00153 
<a name="l00154"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a50">00154</a>     LUID <a class="code" href="../../d6/d0/ctaccess_8c.html#a50">DummyAuthenticationId</a>;
<a name="l00155"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a51">00155</a>     LUID <a class="code" href="../../d6/d0/ctaccess_8c.html#a51">SystemAuthenticationId</a> = SYSTEM_LUID;
00156 
<a name="l00157"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a52">00157</a>     TOKEN_SOURCE <a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a> = {<span class="stringliteral">"SE: TEST"</span>, 0};
00158 
<a name="l00159"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a53">00159</a>     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
<a name="l00160"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a54">00160</a>     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>;
<a name="l00161"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a55">00161</a>     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
00162 
<a name="l00163"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a56">00163</a>     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a56">TempOwner</a>;
<a name="l00164"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a57">00164</a>     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a57">TempGroup</a>;
<a name="l00165"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a58">00165</a>     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a58">TempDacl</a>;
00166 
00167 
00168 
00169 
00170 
00172 <span class="comment">//                                                            //</span>
00173 <span class="comment">// Initialization Routine                                     //</span>
00174 <span class="comment">//                                                            //</span>
00176 <span class="comment"></span>
00177 BOOLEAN
<a name="l00178"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a62">00178</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a62">TestTokenInitialize</a>()
00179 {
00180 
00181     <a class="code" href="../../d4/d6/tsevars_8c.html#a65">TSeVariableInitialization</a>();    <span class="comment">// Initialize global variables</span>
00182 
00183 
00184     <a class="code" href="../../d6/d0/ctaccess_8c.html#a42">DisabledGroupAttributes</a> =  (SE_GROUP_ENABLED_BY_DEFAULT);
00185 
00186     <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a> =  (SE_GROUP_ENABLED_BY_DEFAULT |
00187                                 SE_GROUP_ENABLED
00188                                 );
00189     <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a> =    (SE_GROUP_MANDATORY          |
00190                                 SE_GROUP_ENABLED_BY_DEFAULT |
00191                                 SE_GROUP_ENABLED
00192                                 );
00193     <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>  =    (SE_GROUP_MANDATORY          |
00194                                 SE_GROUP_ENABLED_BY_DEFAULT |
00195                                 SE_GROUP_ENABLED            |
00196                                 SE_GROUP_OWNER
00197                                 );
00198 
00199 
00200     <a class="code" href="../../d6/d0/ctaccess_8c.html#a34">PrimarySecurityDescriptor</a> =
00201         (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00202 
00203     InitializeObjectAttributes(
00204         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,
00205         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00206         OBJ_INHERIT,
00207         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00208         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00209         );
00210 
00211 
00212     <a class="code" href="../../d6/d0/ctaccess_8c.html#a37">ImpersonationSecurityDescriptor</a> =
00213         (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00214 
00215     <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>.Length = (ULONG)<span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
00216     <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>.ImpersonationLevel = SecurityImpersonation;
00217     <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
00218     <a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00219 
00220     InitializeObjectAttributes(
00221         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a36">ImpersonationTokenAttributes</a>,
00222         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00223         OBJ_INHERIT,
00224         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00225         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00226         );
00227     <a class="code" href="../../d6/d0/ctaccess_8c.html#a36">ImpersonationTokenAttributes</a>.SecurityQualityOfService =
00228         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a38">ImpersonationSecurityQos</a>;
00229 
00230 
00231     <a class="code" href="../../d6/d0/ctaccess_8c.html#a40">AnonymousSecurityDescriptor</a> =
00232         (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00233 
00234     <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>.Length = (ULONG)<span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
00235     <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>.ImpersonationLevel = SecurityAnonymous;
00236     <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
00237     <a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00238 
00239     InitializeObjectAttributes(
00240         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a39">AnonymousTokenAttributes</a>,
00241         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00242         OBJ_INHERIT,
00243         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00244         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00245         );
00246     <a class="code" href="../../d6/d0/ctaccess_8c.html#a39">AnonymousTokenAttributes</a>.SecurityQualityOfService =
00247         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a41">AnonymousSecurityQos</a>;
00248 
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">// Build an ACL for use.</span>
00252     <span class="comment">//</span>
00253 
00254     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>        = (PACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00255 
00256     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AclRevision=ACL_REVISION;
00257     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;Sbz1=0;
00258     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;Sbz2=0;
00259     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AclSize=256;
00260     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount=0;
00261 
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// Set up expiration times</span>
00265     <span class="comment">//</span>
00266 
00267     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Year = 3000;
00268     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Month = 1;
00269     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Day = 1;
00270     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Hour = 1;
00271     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Minute = 1;
00272     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Second = 1;
00273     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Milliseconds = 1;
00274     <a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>.Weekday = 1;
00275 
00276     <a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>( &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a48">TempTimeFields</a>, &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a> );
00277 
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// Use a dummy authentication ID for a while.</span>
00281     <span class="comment">//</span>
00282 
00283     <a class="code" href="../../d6/d0/ctaccess_8c.html#a50">DummyAuthenticationId</a> = FredLuid;
00284 
00285 
00286     <span class="comment">//</span>
00287     <span class="comment">// Use a token source specific to security test</span>
00288     <span class="comment">//</span>
00289 
00290     <a class="code" href="../../d0/d8/luid_8c.html#a4">NtAllocateLocallyUniqueId</a>( &amp;(<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>.SourceIdentifier) );
00291 
00292     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Done.\n"</span>);
00293 
00294     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00295 }
00296 
00297 
00298 BOOLEAN
<a name="l00299"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a63">00299</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a63">CreateDAclToken</a>()
00300 {
00301 
00302     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00303 
00304     TOKEN_USER UserId;
00305     TOKEN_PRIMARY_GROUP PrimaryGroup;
00306     PTOKEN_GROUPS GroupIds;
00307     PTOKEN_PRIVILEGES Privileges;
00308     TOKEN_DEFAULT_DACL DefaultDacl;
00309     TOKEN_OWNER <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00310 
00311     PSECURITY_DESCRIPTOR Widget1SecurityDescriptor;
00312 
00313     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> AccessStatus;
00314 
00315     ACCESS_MASK GrantedAccess;
00316 
00317     PACCESS_ALLOWED_ACE AllowBarneySetColor;
00318     PACCESS_ALLOWED_ACE AllowFredSetColor;
00319 
00320     PACCESS_DENIED_ACE  DenyPebblesSetColor;
00321 
00322     PACCESS_ALLOWED_ACE AllowPebblesSetColor;
00323     PACCESS_DENIED_ACE  DenyFredSetColor;
00324     PACCESS_ALLOWED_ACE AllowBarneySetSize;
00325     PACCESS_ALLOWED_ACE AllowPebblesSetSize;
00326 
00327     PACCESS_ALLOWED_ACE AllowPebblesGetColor;
00328     PACCESS_ALLOWED_ACE AllowPebblesGetSize;
00329 
00330     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AllowBarneySetColorLength;
00331     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AllowFredSetColorLength;
00332     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> DenyPebblesSetColorLength;
00333 
00334     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AllowPebblesSetColorLength;
00335     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> DenyFredSetColorLength;
00336     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AllowBarneySetSizeLength;
00337     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AllowPebblesSetSizeLength;
00338 
00339     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AllowPebblesGetColorLength;
00340     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AllowPebblesGetSizeLength;
00341 
00342 
00343     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00344 
00345     GroupIds = (PTOKEN_GROUPS)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00346                                                <a class="code" href="../../d6/d0/ctaccess_8c.html#a3">GROUP_IDS_LENGTH</a>
00347                                                );
00348 
00349     Privileges = (PTOKEN_PRIVILEGES)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00350                                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a5">PRIVILEGES_LENGTH</a>
00351                                                      );
00352 
00353     DefaultDacl.DefaultDacl = (PACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00354                                                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>
00355                                                      );
00356 
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">// Create a token with default DACL</span>
00360     <span class="comment">//</span>
00361 
00362     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create Token With Default Dacl ...                     "</span>);
00363 
00364     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
00365 
00366     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00367     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00368     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00369     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00370 
00371     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00372     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00373     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00374     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00375 
00376     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00377     UserId.User.Attributes = 0;
00378 
00379     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00380 
00381     Privileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>;
00382 
00383     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
00384     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
00385     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
00386     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
00387 
00388     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00389 
00390     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( DefaultDacl.DefaultDacl, <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>, ACL_REVISION);
00391 
00392     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00393 
00394     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00395                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,            <span class="comment">// Handle</span>
00396                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
00397                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00398                  TokenPrimary,             <span class="comment">// TokenType</span>
00399                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a50">DummyAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
00400                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
00401                  &amp;UserId,                  <span class="comment">// Owner ID</span>
00402                  GroupIds,                 <span class="comment">// Group IDs</span>
00403                  Privileges,               <span class="comment">// Privileges</span>
00404                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                   <span class="comment">// Owner</span>
00405                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
00406                  &amp;DefaultDacl,             <span class="comment">// Default Dacl</span>
00407                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
00408                  );
00409 
00410     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00411         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
00412     } <span class="keywordflow">else</span> {
00413         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
00414         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00415         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00416     }
00417 
00418     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00419 
00420 
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// Create an impersonation token, Impersonation level = Impersonation</span>
00424     <span class="comment">//</span>
00425 
00426     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:     Create an impersonation token ...                      "</span>);
00427 
00428     GroupIds-&gt;GroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a11">GROUP_COUNT</a>;
00429 
00430     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Sid  = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00431     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Sid       = <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00432     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00433     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Sid       = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00434 
00435     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a7">FLINTSTONE_INDEX</a>].Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00436     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a8">CHILD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00437     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a9">NEANDERTHOL_INDEX</a>].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a43">OptionalGroupAttributes</a>;
00438     GroupIds-&gt;Groups[<a class="code" href="../../d6/d0/ctaccess_8c.html#a10">WORLD_INDEX</a>].Attributes       = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00439 
00440     UserId.User.Sid = <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00441     UserId.User.Attributes = 0;
00442 
00443     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.Owner = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00444 
00445     Privileges-&gt;PrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a14">PRIVILEGE_COUNT</a>;
00446 
00447     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>;
00448     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
00449     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a12">UNSOLICITED_INDEX</a>].Attributes = 0;
00450     Privileges-&gt;Privileges[<a class="code" href="../../d6/d0/ctaccess_8c.html#a13">SECURITY_INDEX</a>].Attributes = 0;
00451 
00452     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00453 
00454     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( DefaultDacl.DefaultDacl, <a class="code" href="../../d6/d0/ctaccess_8c.html#a2">DEFAULT_DACL_LENGTH</a>, ACL_REVISION);
00455 
00456     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00457 
00458     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>(
00459                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>,      <span class="comment">// Handle</span>
00460                  (TOKEN_ALL_ACCESS),       <span class="comment">// DesiredAccess</span>
00461                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a36">ImpersonationTokenAttributes</a>,  <span class="comment">// ObjectAttributes</span>
00462                  TokenImpersonation,       <span class="comment">// TokenType</span>
00463                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a50">DummyAuthenticationId</a>,   <span class="comment">// Authentication LUID</span>
00464                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>,            <span class="comment">// Expiration Time</span>
00465                  &amp;UserId,                  <span class="comment">// Owner ID</span>
00466                  GroupIds,                 <span class="comment">// Group IDs</span>
00467                  Privileges,               <span class="comment">// Privileges</span>
00468                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,                   <span class="comment">// Owner</span>
00469                  &amp;PrimaryGroup,            <span class="comment">// Primary Group</span>
00470                  &amp;DefaultDacl,             <span class="comment">// Default Dacl</span>
00471                  &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a52">TestSource</a>               <span class="comment">// TokenSource</span>
00472                  );
00473 
00474     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00475         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
00476     } <span class="keywordflow">else</span> {
00477         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"********** Failed ************\n"</span>);
00478         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00479         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00480     }
00481 
00482     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00483 
00484 <span class="comment">//</span>
00485 <span class="comment">//    Attach tokens to process</span>
00486 <span class="comment">//</span>
00487 
00488     <a class="code" href="../../d9/d1/psquery_8c.html#a19">NtSetInformationProcess</a>(
00489         NtCurrentProcess(),
00490         ProcessAccessToken,
00491         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
00492         <span class="keyword">sizeof</span>( PHANDLE ));
00493 
00494 
00495     <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
00496         NtCurrentThread(),
00497         ThreadImpersonationToken,
00498         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a30">ImpersonationToken</a>,
00499         <span class="keyword">sizeof</span>( PHANDLE ));
00500 
00501 
00502 
00503 <span class="comment">//  Create some ACEs</span>
00504 
00505 <span class="comment">//    AllowBarneySetColor</span>
00506 
00507     AllowBarneySetColorLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG ) +
00508                                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a22">BarneySid</a> ));
00509 
00510     AllowBarneySetColor = (PVOID) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AllowBarneySetColorLength );
00511 
00512     AllowBarneySetColor-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00513     AllowBarneySetColor-&gt;Header.AceSize = AllowBarneySetColorLength;
00514     AllowBarneySetColor-&gt;Header.AceFlags = 0;
00515 
00516     AllowBarneySetColor-&gt;Mask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a>;
00517 
00518     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00519             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a22">BarneySid</a> ),
00520             &amp;(AllowBarneySetColor-&gt;SidStart),
00521             <a class="code" href="../../d4/d6/tsevars_8c.html#a22">BarneySid</a> );
00522 
00523 
00524 <span class="comment">//    DenyPebblesSetColor</span>
00525 
00526     DenyPebblesSetColorLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>( ACCESS_DENIED_ACE ) - <span class="keyword">sizeof</span>( ULONG ) +
00527                                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a22">BarneySid</a> ));
00528 
00529     DenyPebblesSetColor = (PVOID) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, DenyPebblesSetColorLength );
00530 
00531     DenyPebblesSetColor-&gt;Header.AceType = ACCESS_DENIED_ACE_TYPE;
00532     DenyPebblesSetColor-&gt;Header.AceSize = DenyPebblesSetColorLength;
00533     DenyPebblesSetColor-&gt;Header.AceFlags = 0;
00534 
00535     DenyPebblesSetColor-&gt;Mask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a>;
00536 
00537     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00538             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> ),
00539             &amp;(DenyPebblesSetColor-&gt;SidStart),
00540             <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> );
00541 
00542 
00543 <span class="comment">//    AllowFredSetColor</span>
00544 
00545     AllowFredSetColorLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG ) +
00546                                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a18">FredSid</a> ));
00547 
00548     AllowFredSetColor = (PVOID) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AllowFredSetColorLength );
00549 
00550     AllowFredSetColor-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00551     AllowFredSetColor-&gt;Header.AceSize = AllowFredSetColorLength;
00552     AllowFredSetColor-&gt;Header.AceFlags = 0;
00553 
00554     AllowFredSetColor-&gt;Mask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a>;
00555 
00556     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00557             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a18">FredSid</a> ),
00558             &amp;(AllowFredSetColor-&gt;SidStart),
00559             <a class="code" href="../../d4/d6/tsevars_8c.html#a18">FredSid</a> );
00560 
00561 
00562 
00563 
00564 <span class="comment">//    AllowPebblesSetColor</span>
00565 
00566 
00567     AllowPebblesSetColorLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG ) +
00568                                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> ));
00569 
00570     AllowPebblesSetColor = (PVOID) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AllowPebblesSetColorLength );
00571 
00572     AllowPebblesSetColor-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00573     AllowPebblesSetColor-&gt;Header.AceSize = AllowPebblesSetColorLength;
00574     AllowPebblesSetColor-&gt;Header.AceFlags = 0;
00575 
00576     AllowPebblesSetColor-&gt;Mask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a>;
00577 
00578     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00579             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> ),
00580             &amp;(AllowPebblesSetColor-&gt;SidStart),
00581             <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> );
00582 
00583 
00584 <span class="comment">//    DenyFredSetColor</span>
00585 
00586     DenyFredSetColorLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>( ACCESS_DENIED_ACE ) - <span class="keyword">sizeof</span>( ULONG ) +
00587                                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a18">FredSid</a> ));
00588 
00589     DenyFredSetColor = (PVOID) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, DenyFredSetColorLength );
00590 
00591     DenyFredSetColor-&gt;Header.AceType = ACCESS_DENIED_ACE_TYPE;
00592     DenyFredSetColor-&gt;Header.AceSize = DenyFredSetColorLength;
00593     DenyFredSetColor-&gt;Header.AceFlags = 0;
00594 
00595     DenyFredSetColor-&gt;Mask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a>;
00596 
00597     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00598             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a18">FredSid</a> ),
00599             &amp;(DenyFredSetColor-&gt;SidStart),
00600             <a class="code" href="../../d4/d6/tsevars_8c.html#a18">FredSid</a> );
00601 
00602 <span class="comment">//    AllowBarneySetSize</span>
00603 
00604     AllowBarneySetSizeLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG ) +
00605                                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a22">BarneySid</a> ));
00606 
00607     AllowBarneySetSize = (PVOID) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AllowBarneySetSizeLength );
00608 
00609     AllowBarneySetSize-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00610     AllowBarneySetSize-&gt;Header.AceSize = AllowBarneySetSizeLength;
00611     AllowBarneySetSize-&gt;Header.AceFlags = 0;
00612 
00613     AllowBarneySetSize-&gt;Mask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a16">SET_WIDGET_SIZE</a>;
00614 
00615     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00616             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a22">BarneySid</a> ),
00617             &amp;(AllowBarneySetSize-&gt;SidStart),
00618             <a class="code" href="../../d4/d6/tsevars_8c.html#a22">BarneySid</a> );
00619 
00620 <span class="comment">//    AllowPebblesSetSize</span>
00621 
00622     AllowPebblesSetSizeLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG ) +
00623                                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> ));
00624 
00625     AllowPebblesSetSize = (PVOID) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AllowPebblesSetSizeLength );
00626 
00627     AllowPebblesSetSize-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00628     AllowPebblesSetSize-&gt;Header.AceSize = AllowPebblesSetSizeLength;
00629     AllowPebblesSetSize-&gt;Header.AceFlags = 0;
00630 
00631     AllowPebblesSetSize-&gt;Mask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a16">SET_WIDGET_SIZE</a>;
00632 
00633     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00634             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> ),
00635             &amp;(AllowPebblesSetSize-&gt;SidStart),
00636             <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> );
00637 
00638 
00639 <span class="comment">//    AllowPebblesGetSize</span>
00640 
00641     AllowPebblesGetSizeLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG ) +
00642                                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> ));
00643 
00644     AllowPebblesGetSize = (PVOID) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AllowPebblesGetSizeLength );
00645 
00646     AllowPebblesGetSize-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00647     AllowPebblesGetSize-&gt;Header.AceSize = AllowPebblesGetSizeLength;
00648     AllowPebblesGetSize-&gt;Header.AceFlags = 0;
00649 
00650     AllowPebblesGetSize-&gt;Mask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a16">SET_WIDGET_SIZE</a>;
00651 
00652     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00653             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> ),
00654             &amp;(AllowPebblesGetSize-&gt;SidStart),
00655             <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> );
00656 
00657 
00658 <span class="comment">//    AllowPebblesGetColor</span>
00659 
00660     AllowPebblesGetColorLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG ) +
00661                                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> ));
00662 
00663     AllowPebblesGetColor = (PVOID) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AllowPebblesGetColorLength );
00664 
00665     AllowPebblesGetColor-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00666     AllowPebblesGetColor-&gt;Header.AceSize = AllowPebblesGetColorLength;
00667     AllowPebblesGetColor-&gt;Header.AceFlags = 0;
00668 
00669     AllowPebblesGetColor-&gt;Mask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a>;
00670 
00671     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
00672             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> ),
00673             &amp;(AllowPebblesGetColor-&gt;SidStart),
00674             <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> );
00675 
00676 <span class="comment">//</span>
00677 <span class="comment">//    Create some ACLs that we can put into a Security Descriptor</span>
00678 <span class="comment">//</span>
00679     DbgBreakPoint();
00680 
00681 <span class="comment">//</span>
00682 <span class="comment">//    Dacl</span>
00683 <span class="comment">//</span>
00684 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00685 <span class="comment">//  |  1st ACE       |    |  2nd ACE       |   |  3rd ACE       |</span>
00686 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00687 <span class="comment">//  |  AccessAllowed |    |  AccessDenied  |   |  AccessAllowed |</span>
00688 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00689 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |   |  FRED          |</span>
00690 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00691 <span class="comment">//  |  SetWidgeColor |    |  SetWidgeColor |   |  SetWidgeColor |</span>
00692 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00693 <span class="comment">//</span>
00694 
00695     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = (PACL) TstAllocatePool ( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,  2048 );
00696 
00697     <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, 2048, ACL_REVISION);
00698 
00699 
00700     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00701                 ACL_REVISION,
00702                 0,
00703                 AllowBarneySetColor,
00704                 AllowBarneySetColorLength );
00705 
00706     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00707                 ACL_REVISION,
00708                 1,
00709                 DenyPebblesSetColor,
00710                 DenyPebblesSetColorLength );
00711 
00712     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00713                 ACL_REVISION,
00714                 2,
00715                 DenyFredSetColor,
00716                 AllowFredSetColorLength );
00717 
00718     <a class="code" href="../../d6/d0/ctaccess_8c.html#a61">DumpAcl</a> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>);
00719 
00720 
00721 
00722 
00723 
00724 <span class="comment">//  Create a security descriptor</span>
00725 <span class="comment">//</span>
00726 <span class="comment">//  Owner = Pebbles</span>
00727 <span class="comment">//  Group = Flintstone</span>
00728 <span class="comment">//  Dacl  = Dacl</span>
00729 <span class="comment">//  Sacl  = NULL</span>
00730 <span class="comment">//</span>
00731 
00732     Widget1SecurityDescriptor =
00733         (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00734 
00735     <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( Widget1SecurityDescriptor,
00736                                  1 );
00737 
00738 
00739     <a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a>( Widget1SecurityDescriptor,
00740                                    <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>,
00741                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00742 
00743     <a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a>( Widget1SecurityDescriptor,
00744                                    <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>,
00745                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00746 
00747     <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( Widget1SecurityDescriptor,
00748                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00749                                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00750                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00751 
00752     <a class="code" href="../../d8/d6/sertl_8c.html#a62">RtlSetSaclSecurityDescriptor</a>( Widget1SecurityDescriptor,
00753                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00754                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00755                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00756 
00757 <span class="comment">//  See if Pebbles is allowed SET_WIDGET_COLOR (should be denied)</span>
00758 
00759     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a>( Widget1SecurityDescriptor,
00760                    <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
00761                    (ACCESS_MASK) <a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a>,
00762                    &amp;GrantedAccess,
00763                    &amp;AccessStatus );
00764 
00765 <span class="comment">//    DbgBreakPoint();</span>
00766 
00767     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00768 
00769     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus));
00770 
00771     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(GrantedAccess == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00772 
00773 
00774 <span class="comment">//  Update Dacl to be the following:</span>
00775 <span class="comment">//</span>
00776 <span class="comment">//    Dacl2</span>
00777 <span class="comment">//</span>
00778 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00779 <span class="comment">//  |  1st ACE       |    |  2nd ACE       |   |  3rd ACE       |</span>
00780 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00781 <span class="comment">//  |  AccessAllowed |    |  AccessAllowed |   |  AccessDenied  |</span>
00782 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00783 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |   |  FRED          |</span>
00784 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00785 <span class="comment">//  |  SetWidgeColor |    |  SetWidgeColor |   |  SetWidgeColor |</span>
00786 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00787 <span class="comment">//</span>
00788 
00789 <span class="comment">//  Delete 2nd Ace</span>
00790 
00791     <a class="code" href="../../d2/d4/acledit_8c.html#a11">RtlDeleteAce</a> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, 1);
00792 
00793     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00794                 ACL_REVISION,
00795                 1,
00796                 AllowPebblesSetColor,
00797                 AllowPebblesSetColorLength );
00798 
00799     <a class="code" href="../../d2/d4/acledit_8c.html#a11">RtlDeleteAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, 2 );
00800 
00801     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00802                 ACL_REVISION,
00803                 1,
00804                 DenyFredSetColor,
00805                 DenyFredSetColorLength );
00806 
00807 
00808 
00809 
00810 <span class="comment">//  Change the security descriptor to use updated Dacl</span>
00811 <span class="comment">//</span>
00812 <span class="comment">//  Owner = Pebbles</span>
00813 <span class="comment">//  Group = Flintstone</span>
00814 <span class="comment">//  Dacl  = Dacl2</span>
00815 <span class="comment">//  Sacl  = NULL</span>
00816 <span class="comment">//</span>
00817 
00818     <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( Widget1SecurityDescriptor,
00819                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00820                                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00821                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00822 
00823 <span class="comment">//  See if Pebbles is allowed SET_WIDGET_COLOR (should be permitted)</span>
00824 
00825     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a>( Widget1SecurityDescriptor,
00826                             <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
00827                             (ACCESS_MASK) <a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a>,
00828                             &amp;GrantedAccess,
00829                             &amp;AccessStatus );
00830 
00831 
00832     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00833 
00834     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus));
00835 
00836     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(GrantedAccess == (ACCESS_MASK)<a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a>);
00837 
00838 <span class="comment">//</span>
00839 <span class="comment">//    Dacl3</span>
00840 <span class="comment">//</span>
00841 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00842 <span class="comment">//  |  1st ACE       |    |  2nd ACE       |   |  3rd ACE       |</span>
00843 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00844 <span class="comment">//  |  AccessAllowed |    |  AccessAllowed |   |  AccessDenied  |</span>
00845 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00846 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |   |  FRED          |</span>
00847 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00848 <span class="comment">//  |  SetWidgeColor |    |  SetWidgeColor |   |  SetWidgeColor |</span>
00849 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00850 <span class="comment">//</span>
00851 <span class="comment">//  +----------------+    +----------------+</span>
00852 <span class="comment">//  |  4th ACE       |    |  5th ACE       |</span>
00853 <span class="comment">//  +----------------+    +----------------+</span>
00854 <span class="comment">//  |  AccessAllowed |    |  AccessAllowed |</span>
00855 <span class="comment">//  +----------------+    +----------------+</span>
00856 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |</span>
00857 <span class="comment">//  +----------------+    +----------------+</span>
00858 <span class="comment">//  |  SetWidgeSize  |    |  SetWidgeSize  |</span>
00859 <span class="comment">//  +----------------+    +----------------+</span>
00860 <span class="comment">//</span>
00861 
00862 
00863     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00864                 ACL_REVISION,
00865                 MAXULONG,
00866                 AllowBarneySetSize,
00867                 AllowBarneySetSizeLength );
00868 
00869     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00870                 ACL_REVISION,
00871                 MAXULONG,
00872                 AllowPebblesSetSize,
00873                 AllowPebblesSetSizeLength );
00874 
00875 <span class="comment">//  Change the security descriptor to use Dacl3</span>
00876 <span class="comment">//</span>
00877 <span class="comment">//  Owner = Pebbles</span>
00878 <span class="comment">//  Group = Flintstone</span>
00879 <span class="comment">//  Dacl  = Dacl3</span>
00880 <span class="comment">//  Sacl  = NULL</span>
00881 <span class="comment">//</span>
00882 
00883     <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( Widget1SecurityDescriptor,
00884                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00885                                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00886                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00887 
00888 <span class="comment">//  Request MAXIMUM_ACCESS for Pebbles.  Should get back SetWidgetSize</span>
00889 <span class="comment">//  and SetWidgetColor</span>
00890 
00891     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a>( Widget1SecurityDescriptor,
00892                             <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
00893                             (ACCESS_MASK) MAXIMUM_ALLOWED,
00894                             &amp;GrantedAccess,
00895                             &amp;AccessStatus );
00896 
00897 
00898     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00899 
00900     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus));
00901 
00902     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(GrantedAccess == (ACCESS_MASK) (<a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a> | <a class="code" href="../../d6/d0/ctaccess_8c.html#a16">SET_WIDGET_SIZE</a>));
00903 
00904 
00905 <span class="comment">//</span>
00906 <span class="comment">//    Dacl4</span>
00907 <span class="comment">//</span>
00908 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00909 <span class="comment">//  |  1st ACE       |    |  2nd ACE       |   |  3rd ACE       |</span>
00910 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00911 <span class="comment">//  |  AccessAllowed |    |  AccessAllowed |   |  AccessDenied  |</span>
00912 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00913 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |   |  FRED          |</span>
00914 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00915 <span class="comment">//  |  SetWidgeColor |    |  SetWidgeColor |   |  SetWidgeColor |</span>
00916 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00917 <span class="comment">//</span>
00918 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00919 <span class="comment">//  |  4th ACE       |    |  5th ACE       |   |  6th ACE       |</span>
00920 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00921 <span class="comment">//  |  AccessAllowed |    |  AccessAllowed |   |  AccessDenied  |</span>
00922 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00923 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |   |  PEBBLES       |</span>
00924 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00925 <span class="comment">//  |  SetWidgeSize  |    |  SetWidgeSize  |   |  SetWidgeColor |</span>
00926 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00927 <span class="comment">//</span>
00928 
00929     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00930                 ACL_REVISION,
00931                 MAXULONG,
00932                 DenyPebblesSetColor,
00933                 DenyPebblesSetColorLength );
00934 
00935     <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( Widget1SecurityDescriptor,
00936                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00937                                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00938                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00939 
00940 <span class="comment">//  Request MAXIMUM_ACCESS for Pebbles.  Should get back SetWidgetSize</span>
00941 <span class="comment">//  and SetWidgetColor</span>
00942 
00943     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a>( Widget1SecurityDescriptor,
00944                             <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
00945                             (ACCESS_MASK) MAXIMUM_ALLOWED,
00946                             &amp;GrantedAccess,
00947                             &amp;AccessStatus );
00948 
00949 
00950     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00951 
00952     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus));
00953 
00954     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(GrantedAccess == (ACCESS_MASK) (<a class="code" href="../../d6/d0/ctaccess_8c.html#a15">SET_WIDGET_COLOR</a> | <a class="code" href="../../d6/d0/ctaccess_8c.html#a16">SET_WIDGET_SIZE</a>));
00955 
00956 
00957 <span class="comment">//</span>
00958 <span class="comment">//    Dacl5</span>
00959 <span class="comment">//</span>
00960 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00961 <span class="comment">//  |  1st ACE       |    |  2nd ACE       |   |  3rd ACE       |</span>
00962 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00963 <span class="comment">//  |  AccessAllowed |    |  AccessDenied  |   |  AccessDenied  |</span>
00964 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00965 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |   |  FRED          |</span>
00966 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00967 <span class="comment">//  |  SetWidgeColor |    |  SetWidgeColor |   |  SetWidgeColor |</span>
00968 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00969 <span class="comment">//</span>
00970 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00971 <span class="comment">//  |  4th ACE       |    |  5th ACE       |   |  6th ACE       |</span>
00972 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00973 <span class="comment">//  |  AccessAllowed |    |  AccessAllowed |   |  AccessAllowed |</span>
00974 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00975 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |   |  PEBBLES       |</span>
00976 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00977 <span class="comment">//  |  SetWidgeSize  |    |  SetWidgeSize  |   |  SetWidgeColor |</span>
00978 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
00979 <span class="comment">//</span>
00980 
00981     <a class="code" href="../../d2/d4/acledit_8c.html#a11">RtlDeleteAce</a> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, 1);
00982 
00983     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00984                 ACL_REVISION,
00985                 1,
00986                 DenyPebblesSetColor,
00987                 DenyPebblesSetColorLength );
00988 
00989     <a class="code" href="../../d2/d4/acledit_8c.html#a11">RtlDeleteAce</a> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, 5);
00990 
00991     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00992                 ACL_REVISION,
00993                 MAXULONG,
00994                 AllowPebblesSetColor,
00995                 AllowPebblesSetColorLength );
00996 
00997 
00998     <a class="code" href="../../d6/d0/ctaccess_8c.html#a61">DumpAcl</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> );
00999 
01000     <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( Widget1SecurityDescriptor,
01001                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01002                                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
01003                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01004 
01005 <span class="comment">//  Request MAXIMUM_ACCESS for Pebbles.  Should get back SetWidgetSize</span>
01006 
01007     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a>( Widget1SecurityDescriptor,
01008                             <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
01009                             (ACCESS_MASK) MAXIMUM_ALLOWED,
01010                             &amp;GrantedAccess,
01011                             &amp;AccessStatus );
01012 
01013 
01014     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01015 
01016     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus));
01017 
01018     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(GrantedAccess == (ACCESS_MASK) <a class="code" href="../../d6/d0/ctaccess_8c.html#a16">SET_WIDGET_SIZE</a>);
01019 
01020 
01021 <span class="comment">//</span>
01022 <span class="comment">//    Dacl6</span>
01023 <span class="comment">//</span>
01024 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01025 <span class="comment">//  |  1st ACE       |    |  2nd ACE       |   |  3rd ACE       |</span>
01026 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01027 <span class="comment">//  |  AccessAllowed |    |  AccessDenied  |   |  AccessDenied  |</span>
01028 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01029 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |   |  FRED          |</span>
01030 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01031 <span class="comment">//  |  SetWidgeColor |    |  SetWidgeColor |   |  SetWidgeColor |</span>
01032 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01033 <span class="comment">//</span>
01034 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01035 <span class="comment">//  |  4th ACE       |    |  5th ACE       |   |  6th ACE       |</span>
01036 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01037 <span class="comment">//  |  AccessAllowed |    |  AccessAllowed |   |  AccessAllowed |</span>
01038 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01039 <span class="comment">//  |  BARNEY        |    |  PEBBLES       |   |  PEBBLES       |</span>
01040 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01041 <span class="comment">//  |  SetWidgeSize  |    |  SetWidgeSize  |   |  SetWidgeColor |</span>
01042 <span class="comment">//  +----------------+    +----------------+   +----------------+</span>
01043 <span class="comment">//</span>
01044 <span class="comment">//  +----------------+    +----------------+</span>
01045 <span class="comment">//  |  7th ACE       |    |  8th ACE       |</span>
01046 <span class="comment">//  +----------------+    +----------------+</span>
01047 <span class="comment">//  |  AccessAllowed |    |  AccessAllowed |</span>
01048 <span class="comment">//  +----------------+    +----------------+</span>
01049 <span class="comment">//  |  PEBBLES       |    |  PEBBLES       |</span>
01050 <span class="comment">//  +----------------+    +----------------+</span>
01051 <span class="comment">//  |  GetWidgeSize  |    |  GetWidgeColor |</span>
01052 <span class="comment">//  +----------------+    +----------------+</span>
01053 <span class="comment">//</span>
01054 
01055     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
01056                 ACL_REVISION,
01057                 MAXULONG,
01058                 AllowPebblesGetSize,
01059                 AllowPebblesGetSizeLength );
01060 
01061     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
01062                 ACL_REVISION,
01063                 MAXULONG,
01064                 AllowPebblesGetColor,
01065                 AllowPebblesGetColorLength );
01066 
01067     <a class="code" href="../../d6/d0/ctaccess_8c.html#a61">DumpAcl</a> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> );
01068 
01069     <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( Widget1SecurityDescriptor,
01070                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01071                                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
01072                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01073 
01074 <span class="comment">//  Request MAXIMUM_ACCESS for Pebbles.  Should get back SetWidgetSize</span>
01075 
01076     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a>( Widget1SecurityDescriptor,
01077                             <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
01078                             (ACCESS_MASK) MAXIMUM_ALLOWED,
01079                             &amp;GrantedAccess,
01080                             &amp;AccessStatus );
01081 
01082 
01083     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01084 
01085     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus));
01086 
01087     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(GrantedAccess == (ACCESS_MASK) <a class="code" href="../../d6/d0/ctaccess_8c.html#a16">SET_WIDGET_SIZE</a>);
01088 
01089 
01090 
01091     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01092 
01093 
01094 }
01095 
01096 
01098 <span class="comment">//                                                                 //</span>
01099 <span class="comment">//                                                                 //</span>
01100 <span class="comment">//    Main test entry point                                        //</span>
01101 <span class="comment">//                                                                 //</span>
01102 <span class="comment">//                                                                 //</span>
01104 <span class="comment"></span>
01105 
01106 BOOLEAN
<a name="l01107"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a64">01107</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a64">CTAccess</a>()
01108 {
01109 
01110     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01111 
01112     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d6/tsevars_8c.html#a65">TSeVariableInitialization</a>()) {
01113         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:    Failed to initialize global test variables.\n"</span>);
01114         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01115     }
01116 
01117     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Initialization..."</span>);
01118     <a class="code" href="../../d6/d0/ctaccess_8c.html#a62">TestTokenInitialize</a>();
01119     <a class="code" href="../../d6/d0/ctaccess_8c.html#a63">CreateDAclToken</a>();
01120 
01121 }
01122 
01123 
01124 <span class="comment">//</span>
01125 <span class="comment">//  Debug support routine</span>
01126 <span class="comment">//</span>
01127 
01128 
<a name="l01129"></a><a class="code" href="../../d9/d5/struct__STANDARD__ACE.html">01129</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d5/struct__STANDARD__ACE.html">_STANDARD_ACE</a> {
<a name="l01130"></a><a class="code" href="../../d9/d5/struct__STANDARD__ACE.html#o0">01130</a>     ACE_HEADER <a class="code" href="../../d9/d5/struct__STANDARD__ACE.html#o0">Header</a>;
<a name="l01131"></a><a class="code" href="../../d9/d5/struct__STANDARD__ACE.html#o1">01131</a>     ACCESS_MASK <a class="code" href="../../d9/d5/struct__STANDARD__ACE.html#o1">Mask</a>;
<a name="l01132"></a><a class="code" href="../../d9/d5/struct__STANDARD__ACE.html#o2">01132</a>     PSID <a class="code" href="../../d9/d5/struct__STANDARD__ACE.html#o2">Sid</a>;
01133 } <a class="code" href="../../d9/d5/struct__STANDARD__ACE.html">STANDARD_ACE</a>;
<a name="l01134"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a60">01134</a> <span class="keyword">typedef</span> <a class="code" href="../../d9/d5/struct__STANDARD__ACE.html">STANDARD_ACE</a> *<a class="code" href="../../d9/d5/struct__STANDARD__ACE.html">PSTANDARD_ACE</a>;
01135 
01136 
01137 
01138 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01139"></a><a class="code" href="../../d6/d0/ctaccess_8c.html#a61">01139</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a61">DumpAcl</a> (
01140     IN PACL Acl
01141     )
01142 
01143 <span class="comment">/*++</span>
01144 <span class="comment"></span>
01145 <span class="comment">Routine Description:</span>
01146 <span class="comment"></span>
01147 <span class="comment">    This routine dumps via (DbgPrint) an Acl for debug purposes.  It is</span>
01148 <span class="comment">    specialized to dump standard aces.</span>
01149 <span class="comment"></span>
01150 <span class="comment">Arguments:</span>
01151 <span class="comment"></span>
01152 <span class="comment">    Acl - Supplies the Acl to dump</span>
01153 <span class="comment"></span>
01154 <span class="comment">Return Value:</span>
01155 <span class="comment"></span>
01156 <span class="comment">    None</span>
01157 <span class="comment"></span>
01158 <span class="comment">--*/</span>
01159 
01160 
01161 {
01162     ULONG i;
01163     <a class="code" href="../../d6/d0/ctaccess_8c.html#a60">PSTANDARD_ACE</a> Ace;
01164 
01165     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"DumpAcl @ %8lx"</span>, Acl);
01166 
01167     <span class="comment">//</span>
01168     <span class="comment">//  Check if the Acl is null</span>
01169     <span class="comment">//</span>
01170 
01171     <span class="keywordflow">if</span> (Acl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01172 
01173         <span class="keywordflow">return</span>;
01174 
01175     }
01176 
01177     <span class="comment">//</span>
01178     <span class="comment">//  Dump the Acl header</span>
01179     <span class="comment">//</span>
01180 
01181     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" Revision: %02x"</span>, Acl-&gt;AclRevision);
01182     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" Size: %04x"</span>, Acl-&gt;AclSize);
01183     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" AceCount: %04x\n"</span>, Acl-&gt;AceCount);
01184 
01185     <span class="comment">//</span>
01186     <span class="comment">//  Now for each Ace we want do dump it</span>
01187     <span class="comment">//</span>
01188 
01189     <span class="keywordflow">for</span> (i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(Acl);
01190          i &lt; Acl-&gt;AceCount;
01191          i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(Ace) ) {
01192 
01193         <span class="comment">//</span>
01194         <span class="comment">//  print out the ace header</span>
01195         <span class="comment">//</span>
01196 
01197         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" AceHeader: %08lx "</span>, *(PULONG)Ace);
01198 
01199         <span class="comment">//</span>
01200         <span class="comment">//  special case on the standard ace types</span>
01201         <span class="comment">//</span>
01202 
01203         <span class="keywordflow">if</span> ((Ace-&gt;Header.AceType == ACCESS_ALLOWED_ACE_TYPE) ||
01204             (Ace-&gt;Header.AceType == ACCESS_DENIED_ACE_TYPE) ||
01205             (Ace-&gt;Header.AceType == SYSTEM_AUDIT_ACE_TYPE) ||
01206             (Ace-&gt;Header.AceType == SYSTEM_ALARM_ACE_TYPE)) {
01207 
01208             <span class="comment">//</span>
01209             <span class="comment">//  The following array is indexed by ace types and must</span>
01210             <span class="comment">//  follow the allowed, denied, audit, alarm seqeuence</span>
01211             <span class="comment">//</span>
01212 
01213             <span class="keyword">static</span> PCHAR AceTypes[] = { <span class="stringliteral">"Access Allowed"</span>,
01214                                         <span class="stringliteral">"Access Denied "</span>,
01215                                         <span class="stringliteral">"System Audit  "</span>,
01216                                         <span class="stringliteral">"System Alarm  "</span>
01217                                       };
01218 
01219             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(AceTypes[Ace-&gt;Header.AceType]);
01220             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nAccess Mask: %08lx "</span>, Ace-&gt;Mask);
01221 
01222         } <span class="keywordflow">else</span> {
01223 
01224             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unknown Ace Type\n"</span>);
01225 
01226         }
01227 
01228         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01229 
01230         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"AceSize = %d\n"</span>,Ace-&gt;Header.AceSize);
01231         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Ace Flags = "</span>);
01232         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; OBJECT_INHERIT_ACE) {
01233             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"OBJECT_INHERIT_ACE\n"</span>);
01234             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                   "</span>);
01235         }
01236         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; CONTAINER_INHERIT_ACE) {
01237             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CONTAINER_INHERIT_ACE\n"</span>);
01238             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                   "</span>);
01239         }
01240 
01241         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; NO_PROPAGATE_INHERIT_ACE) {
01242             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NO_PROPAGATE_INHERIT_ACE\n"</span>);
01243             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                   "</span>);
01244         }
01245 
01246         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; INHERIT_ONLY_ACE) {
01247             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"INHERIT_ONLY_ACE\n"</span>);
01248             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                   "</span>);
01249         }
01250 
01251 
01252         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; SUCCESSFUL_ACCESS_ACE_FLAG) {
01253             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SUCCESSFUL_ACCESS_ACE_FLAG\n"</span>);
01254             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"            "</span>);
01255         }
01256 
01257         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; FAILED_ACCESS_ACE_FLAG) {
01258             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"FAILED_ACCESS_ACE_FLAG\n"</span>);
01259             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"            "</span>);
01260         }
01261 
01262         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01263 
01264 
01265     }
01266 
01267 }
01268 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
