<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obcreate.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obcreate.c</h1><a href="../../d6/d0/obcreate_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    obcreate.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Object creation</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 31-Mar-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00022 
00023 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ObCreateObject)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ObDeleteCapturedInsertInfo)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ObpCaptureObjectCreateInformation)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ObpCaptureObjectName)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ObpAllocateObject)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ObpFreeObject)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span>
00032 <span class="preprocessor">#if DBG</span>
00033 <span class="preprocessor"></span>
00034 <span class="comment">//</span>
00035 <span class="comment">//  The following variable is only used on a checked build to control</span>
00036 <span class="comment">//  echoing out the allocs and frees of objects</span>
00037 <span class="comment">//</span>
00038 
00039 BOOLEAN ObpShowAllocAndFree;
00040 
00041 <span class="preprocessor">#endif</span>
00042 <span class="preprocessor"></span>
00043 <span class="comment">//</span>
00044 <span class="comment">//  Local performance counters</span>
00045 <span class="comment">//</span>
00046 
<a name="l00047"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a0">00047</a> ULONG <a class="code" href="../../d6/d0/obcreate_8c.html#a0">ObpObjectsCreated</a>;
<a name="l00048"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a1">00048</a> ULONG <a class="code" href="../../d6/d0/obcreate_8c.html#a1">ObpObjectsWithPoolQuota</a>;
<a name="l00049"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a2">00049</a> ULONG <a class="code" href="../../d6/d0/obcreate_8c.html#a2">ObpObjectsWithHandleDB</a>;
<a name="l00050"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a3">00050</a> ULONG <a class="code" href="../../d6/d0/obcreate_8c.html#a3">ObpObjectsWithName</a>;
<a name="l00051"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a4">00051</a> ULONG <a class="code" href="../../d6/d0/obcreate_8c.html#a4">ObpObjectsWithCreatorInfo</a>;
00052 
00053 
00054 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00055"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a5">00055</a> <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a> (
00056     IN KPROCESSOR_MODE ProbeMode,
00057     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType,
00058     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00059     IN KPROCESSOR_MODE OwnershipMode,
00060     IN OUT PVOID ParseContext OPTIONAL,
00061     IN ULONG ObjectBodySize,
00062     IN ULONG PagedPoolCharge,
00063     IN ULONG NonPagedPoolCharge,
00064     OUT PVOID *Object
00065     )
00066 
00067 <span class="comment">/*++</span>
00068 <span class="comment"></span>
00069 <span class="comment">Routine Description:</span>
00070 <span class="comment"></span>
00071 <span class="comment">    This functions allocates space for an NT Object from either</span>
00072 <span class="comment">    Paged or NonPaged pool. It captures the optional name and</span>
00073 <span class="comment">    SECURITY_DESCRIPTOR parameters for later use when the object is</span>
00074 <span class="comment">    inserted into an object table.  No quota is charged at this time.</span>
00075 <span class="comment">    That occurs when the object is inserted into an object table.</span>
00076 <span class="comment"></span>
00077 <span class="comment">Arguments:</span>
00078 <span class="comment"></span>
00079 <span class="comment">    ProbeMode - The processor mode to consider when doing a probe</span>
00080 <span class="comment">        of the input parameters</span>
00081 <span class="comment"></span>
00082 <span class="comment">    ObjectType - A pointer of the type returned by ObCreateObjectType</span>
00083 <span class="comment">        that gives the type of object being created.</span>
00084 <span class="comment"></span>
00085 <span class="comment">    ObjectAttributes - Optionally supplies the attributes of the object</span>
00086 <span class="comment">        being created (such as its name)</span>
00087 <span class="comment"></span>
00088 <span class="comment">    OwnershipMode - The processor mode of who is going to own the object</span>
00089 <span class="comment"></span>
00090 <span class="comment">    ParseContext - Ignored</span>
00091 <span class="comment"></span>
00092 <span class="comment">    ObjectBodySize - Number of bytes to allocate for the object body.  The</span>
00093 <span class="comment">        object body immediately follows the object header in memory and are</span>
00094 <span class="comment">        part of a single allocation.</span>
00095 <span class="comment"></span>
00096 <span class="comment">    PagedPoolCharge - Supplies the amount of paged pool to charge for the</span>
00097 <span class="comment">        object.  If zero is specified then the default charge for the object</span>
00098 <span class="comment">        type is used.</span>
00099 <span class="comment"></span>
00100 <span class="comment">    NonPagedPoolCharge - Supplies the amount of nonpaged pool to charge for</span>
00101 <span class="comment">        the object.  If zero is specified then the default charge for the</span>
00102 <span class="comment">        object type is used.</span>
00103 <span class="comment"></span>
00104 <span class="comment">    Object - Receives a pointer to the newly created object</span>
00105 <span class="comment"></span>
00106 <span class="comment">Return Value:</span>
00107 <span class="comment"></span>
00108 <span class="comment">    Following errors can occur:</span>
00109 <span class="comment"></span>
00110 <span class="comment">        - invalid object type</span>
00111 <span class="comment">        - insufficient memory</span>
00112 <span class="comment"></span>
00113 <span class="comment">--*/</span>
00114 
00115 {
00116     UNICODE_STRING CapturedObjectName;
00117     <a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a> ObjectCreateInfo;
00118     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00119     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00120 
00121     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">//  Allocate a buffer to capture the object creation information.</span>
00125     <span class="comment">//</span>
00126 
00127     ObjectCreateInfo = <a class="code" href="../../d5/d1/obp_8h.html#a31">ObpAllocateObjectCreateInfoBuffer</a>();
00128 
00129     <span class="keywordflow">if</span> (ObjectCreateInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00130 
00131         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00132 
00133     } <span class="keywordflow">else</span> {
00134 
00135         <span class="comment">//</span>
00136         <span class="comment">//  Capture the object attributes, quality of service, and object</span>
00137         <span class="comment">//  name, if specified. Otherwise, initialize the captured object</span>
00138         <span class="comment">//  name, the security quality of service, and the create attributes</span>
00139         <span class="comment">//  to default values.</span>
00140         <span class="comment">//</span>
00141 
00142         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a58">ObpCaptureObjectCreateInformation</a>( ObjectType,
00143                                                     ProbeMode,
00144                                                     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00145                                                     &amp;CapturedObjectName,
00146                                                     ObjectCreateInfo,
00147                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00148 
00149         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00150 
00151             <span class="comment">//</span>
00152             <span class="comment">//  If the creation attributes are invalid, then return an error</span>
00153             <span class="comment">//  status.</span>
00154             <span class="comment">//</span>
00155 
00156             <span class="keywordflow">if</span> (ObjectType-&gt;TypeInfo.InvalidAttributes &amp; ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>) {
00157 
00158                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00159 
00160             } <span class="keywordflow">else</span> {
00161 
00162                 <span class="comment">//</span>
00163                 <span class="comment">//  Set the paged and nonpaged pool quota charges for the</span>
00164                 <span class="comment">//  object allocation.</span>
00165                 <span class="comment">//</span>
00166 
00167                 <span class="keywordflow">if</span> (PagedPoolCharge == 0) {
00168 
00169                     PagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultPagedPoolCharge;
00170                 }
00171 
00172                 <span class="keywordflow">if</span> (NonPagedPoolCharge == 0) {
00173 
00174                     NonPagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultNonPagedPoolCharge;
00175                 }
00176 
00177                 ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o4">PagedPoolCharge</a> = PagedPoolCharge;
00178                 ObjectCreateInfo-&gt;<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o5">NonPagedPoolCharge</a> = NonPagedPoolCharge;
00179 
00180                 <span class="comment">//</span>
00181                 <span class="comment">//  Allocate and initialize the object.</span>
00182                 <span class="comment">//</span>
00183 
00184                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a62">ObpAllocateObject</a>( ObjectCreateInfo,
00185                                             OwnershipMode,
00186                                             ObjectType,
00187                                             &amp;CapturedObjectName,
00188                                             ObjectBodySize,
00189                                             &amp;ObjectHeader );
00190 
00191                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00192 
00193                     <span class="comment">//</span>
00194                     <span class="comment">//  If a permanent object is being created, then check if</span>
00195                     <span class="comment">//  the caller has the appropriate privilege.</span>
00196                     <span class="comment">//</span>
00197 
00198                     *Object = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00199 
00200                     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a5">OB_FLAG_PERMANENT_OBJECT</a>) {
00201 
00202                         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>( <a class="code" href="../../d0/d5/se_8h.html#a93">SeCreatePermanentPrivilege</a>,
00203                                                      ProbeMode)) {
00204 
00205                             <a class="code" href="../../d5/d1/obp_8h.html#a63">ObpFreeObject</a>(*Object);
00206 
00207                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
00208                         }
00209                     }
00210 
00211                     <span class="comment">//</span>
00212                     <span class="comment">//  Here is the only successful path out of this module but</span>
00213                     <span class="comment">//  this path can also return privilege not held.</span>
00214                     <span class="comment">//</span>
00215 
00216                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00217                 }
00218             }
00219 
00220             <span class="comment">//</span>
00221             <span class="comment">//  An error path, free the create information.</span>
00222             <span class="comment">//</span>
00223 
00224             <a class="code" href="../../d5/d1/obp_8h.html#a30">ObpReleaseObjectCreateInformation</a>(ObjectCreateInfo);
00225 
00226             <span class="keywordflow">if</span> (CapturedObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00227 
00228                 <a class="code" href="../../d5/d1/obp_8h.html#a61">ObpFreeObjectNameBuffer</a>(&amp;CapturedObjectName);
00229             }
00230         }
00231 
00232         <span class="comment">//</span>
00233         <span class="comment">//  An error path, free object creation information buffer.</span>
00234         <span class="comment">//</span>
00235 
00236         <a class="code" href="../../d5/d1/obp_8h.html#a32">ObpFreeObjectCreateInfoBuffer</a>(ObjectCreateInfo);
00237     }
00238 
00239     <span class="comment">//</span>
00240     <span class="comment">//  An error path</span>
00241     <span class="comment">//</span>
00242 
00243     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00244 }
00245 
00246 
00247 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00248"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a6">00248</a> <a class="code" href="../../d5/d1/obp_8h.html#a58">ObpCaptureObjectCreateInformation</a> (
00249     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL,
00250     IN KPROCESSOR_MODE ProbeMode,
00251     IN POBJECT_ATTRIBUTES ObjectAttributes,
00252     IN OUT PUNICODE_STRING CapturedObjectName,
00253     IN <a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a> ObjectCreateInfo,
00254     IN LOGICAL UseLookaside
00255     )
00256 
00257 <span class="comment">/*++</span>
00258 <span class="comment"></span>
00259 <span class="comment">Routine Description:</span>
00260 <span class="comment"></span>
00261 <span class="comment">    This function captures the object creation information and stuff</span>
00262 <span class="comment">    it into the input variable ObjectCreateInfo</span>
00263 <span class="comment"></span>
00264 <span class="comment">Arguments:</span>
00265 <span class="comment"></span>
00266 <span class="comment">    ObjectType - Specifies the type of object we expect to capture,</span>
00267 <span class="comment">        currently ignored.</span>
00268 <span class="comment"></span>
00269 <span class="comment">    ProbeMode - Specifies the processor mode for doing our parameter</span>
00270 <span class="comment">        probes</span>
00271 <span class="comment"></span>
00272 <span class="comment">    ObjectAttributes - Supplies the object attributes we are trying</span>
00273 <span class="comment">        to capture</span>
00274 <span class="comment"></span>
00275 <span class="comment">    CapturedObjectName - Recieves the name of the object being created</span>
00276 <span class="comment"></span>
00277 <span class="comment">    ObjectCreateInfo - Receives the create information for the object</span>
00278 <span class="comment">        like its root, attributes, and security information</span>
00279 <span class="comment"></span>
00280 <span class="comment">    UseLookaside - Specifies if we are to allocate the captured name</span>
00281 <span class="comment">        buffer from the lookaside list or from straight pool.</span>
00282 <span class="comment"></span>
00283 <span class="comment">Return Value:</span>
00284 <span class="comment"></span>
00285 <span class="comment">    An appropriate status value</span>
00286 <span class="comment"></span>
00287 <span class="comment">--*/</span>
00288 
00289 {
00290     PUNICODE_STRING ObjectName;
00291     PSECURITY_DESCRIPTOR SecurityDescriptor;
00292     PSECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>;
00293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00294     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00295 
00296     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00297 
00298     <span class="comment">//</span>
00299     <span class="comment">//  Capture the object attributes, the security quality of service, if</span>
00300     <span class="comment">//  specified, and object name, if specified.</span>
00301     <span class="comment">//</span>
00302 
00303     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00304 
00305     RtlZeroMemory(ObjectCreateInfo, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">OBJECT_CREATE_INFORMATION</a>));
00306 
00307     <span class="keywordflow">try</span> {
00308 
00309         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>)) {
00310 
00311             <span class="comment">//</span>
00312             <span class="comment">//  Probe the object attributes if necessary.</span>
00313             <span class="comment">//</span>
00314 
00315             <span class="keywordflow">if</span> (ProbeMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00316 
00317                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00318                               <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES),
00319                               <span class="keyword">sizeof</span>(ULONG) );
00320             }
00321 
00322             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;Length != <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES) ||
00323                 (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;Attributes &amp; ~OBJ_VALID_ATTRIBUTES)) {
00324 
00325                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00326 
00327                 <span class="keywordflow">goto</span> failureExit;
00328             }
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">//  Capture the object attributes.</span>
00332             <span class="comment">//</span>
00333 
00334             ObjectCreateInfo-&gt;RootDirectory = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;RootDirectory;
00335             ObjectCreateInfo-&gt;Attributes = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;Attributes &amp; OBJ_VALID_ATTRIBUTES;
00336             ObjectName = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName;
00337             SecurityDescriptor = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;SecurityDescriptor;
00338             <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a> = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;SecurityQualityOfService;
00339 
00340             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SecurityDescriptor)) {
00341 
00342                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a>( SecurityDescriptor,
00343                                                       ProbeMode,
00344                                                       <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00345                                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00346                                                       &amp;ObjectCreateInfo-&gt;SecurityDescriptor );
00347 
00348                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00349 
00350                     KdPrint(( <span class="stringliteral">"OB: Failed to capture security descriptor at %08x - Status == %08x\n"</span>,
00351                               SecurityDescriptor,
00352                               <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00353 
00354                     <span class="comment">//</span>
00355                     <span class="comment">//  The cleanup routine depends on this being NULL if it isn't</span>
00356                     <span class="comment">//  allocated.  SeCaptureSecurityDescriptor may modify this</span>
00357                     <span class="comment">//  parameter even if it fails.</span>
00358                     <span class="comment">//</span>
00359 
00360                     ObjectCreateInfo-&gt;SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361 
00362                     <span class="keywordflow">goto</span> failureExit;
00363                 }
00364 
00365                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a16">SeComputeQuotaInformationSize</a>(  ObjectCreateInfo-&gt;SecurityDescriptor,
00366                                                 &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00367 
00368                 ObjectCreateInfo-&gt;SecurityDescriptorCharge = <a class="code" href="../../d0/d5/se_8h.html#a15">SeComputeSecurityQuota</a>( <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00369                 ObjectCreateInfo-&gt;ProbeMode = ProbeMode;
00370             }
00371 
00372             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>)) {
00373 
00374                 <span class="keywordflow">if</span> (ProbeMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00375 
00376                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>, <span class="keyword">sizeof</span>(*<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>), <span class="keyword">sizeof</span>(ULONG));
00377                 }
00378 
00379                 ObjectCreateInfo-&gt;SecurityQualityOfService = *<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>;
00380                 ObjectCreateInfo-&gt;SecurityQos = &amp;ObjectCreateInfo-&gt;SecurityQualityOfService;
00381             }
00382 
00383         } <span class="keywordflow">else</span> {
00384 
00385             ObjectName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00386         }
00387 
00388     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00389 
00390         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00391 
00392         <span class="keywordflow">goto</span> failureExit;
00393     }
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">//  If an object name is specified, then capture the object name.</span>
00397     <span class="comment">//  Otherwise, initialize the object name descriptor and check for</span>
00398     <span class="comment">//  an incorrectly specified root directory.</span>
00399     <span class="comment">//</span>
00400 
00401     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ObjectName)) {
00402 
00403         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a59">ObpCaptureObjectName</a>( ProbeMode,
00404                                        ObjectName,
00405                                        CapturedObjectName,
00406                                        UseLookaside );
00407 
00408     } <span class="keywordflow">else</span> {
00409 
00410         CapturedObjectName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00411         CapturedObjectName-&gt;Length = 0;
00412         CapturedObjectName-&gt;MaximumLength = 0;
00413 
00414         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ObjectCreateInfo-&gt;RootDirectory)) {
00415 
00416             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_INVALID;
00417         }
00418     }
00419 
00420     <span class="comment">//</span>
00421     <span class="comment">//  If the completion status is not successful, and a security quality</span>
00422     <span class="comment">//  of service parameter was specified, then free the security quality</span>
00423     <span class="comment">//  of service memory.</span>
00424     <span class="comment">//</span>
00425 
00426 failureExit:
00427 
00428     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00429 
00430         <a class="code" href="../../d5/d1/obp_8h.html#a30">ObpReleaseObjectCreateInformation</a>(ObjectCreateInfo);
00431     }
00432 
00433     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00434 }
00435 
00436 
00437 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00438"></a><a class="code" href="../../d5/d1/obp_8h.html#a59">00438</a> <a class="code" href="../../d5/d1/obp_8h.html#a59">ObpCaptureObjectName</a> (
00439     IN KPROCESSOR_MODE ProbeMode,
00440     IN PUNICODE_STRING ObjectName,
00441     IN OUT PUNICODE_STRING CapturedObjectName,
00442     IN LOGICAL UseLookaside
00443     )
00444 
00445 <span class="comment">/*++</span>
00446 <span class="comment"></span>
00447 <span class="comment">Routine Description:</span>
00448 <span class="comment"></span>
00449 <span class="comment">    This function captures the object name but first verifies that</span>
00450 <span class="comment">    it is at least properly sized.</span>
00451 <span class="comment"></span>
00452 <span class="comment">Arguments:</span>
00453 <span class="comment"></span>
00454 <span class="comment">    ProbeMode - Supplies the processor mode to use when probing</span>
00455 <span class="comment">        the object name</span>
00456 <span class="comment"></span>
00457 <span class="comment">    ObjectName - Supplies the caller's version of the object name</span>
00458 <span class="comment"></span>
00459 <span class="comment">    CapturedObjectName - Receives the captured verified version</span>
00460 <span class="comment">        of the object name</span>
00461 <span class="comment"></span>
00462 <span class="comment">    UseLookaside - Indicates if the captured name buffer should be</span>
00463 <span class="comment">        allocated from the lookaside list or from straight pool</span>
00464 <span class="comment"></span>
00465 <span class="comment">Return Value:</span>
00466 <span class="comment"></span>
00467 <span class="comment">    An appropriate status value</span>
00468 <span class="comment"></span>
00469 <span class="comment">--*/</span>
00470 
00471 {
00472     PWCH FreeBuffer;
00473     UNICODE_STRING InputObjectName;
00474     ULONG Length;
00475     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00476 
00477     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">//  Initialize the object name descriptor and capture the specified name</span>
00481     <span class="comment">//  string.</span>
00482     <span class="comment">//</span>
00483 
00484     CapturedObjectName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00485     CapturedObjectName-&gt;Length = 0;
00486     CapturedObjectName-&gt;MaximumLength = 0;
00487 
00488     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00489 
00490     <span class="keywordflow">try</span> {
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">//  Probe and capture the name string descriptor and probe the</span>
00494         <span class="comment">//  name string, if necessary.</span>
00495         <span class="comment">//</span>
00496 
00497         FreeBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00498 
00499         <span class="keywordflow">if</span> (ProbeMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00500 
00501             InputObjectName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(ObjectName);
00502 
00503             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( InputObjectName.Buffer,
00504                           InputObjectName.Length,
00505                           <span class="keyword">sizeof</span>(WCHAR) );
00506 
00507         } <span class="keywordflow">else</span> {
00508 
00509             InputObjectName = *ObjectName;
00510         }
00511 
00512         <span class="comment">//</span>
00513         <span class="comment">//  If the length of the string is not zero, then capture the string.</span>
00514         <span class="comment">//</span>
00515 
00516         <span class="keywordflow">if</span> (InputObjectName.Length != 0) {
00517 
00518             <span class="comment">//</span>
00519             <span class="comment">//  If the length of the string is not an even multiple of the</span>
00520             <span class="comment">//  size of a UNICODE character or cannot be zero terminated,</span>
00521             <span class="comment">//  then return an error.</span>
00522             <span class="comment">//</span>
00523 
00524             Length = InputObjectName.Length;
00525 
00526             <span class="keywordflow">if</span> (((Length &amp; (<span class="keyword">sizeof</span>(WCHAR) - 1)) != 0) ||
00527                 (Length == (MAXUSHORT - <span class="keyword">sizeof</span>(WCHAR) + 1))) {
00528 
00529                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_INVALID;
00530 
00531             } <span class="keywordflow">else</span> {
00532 
00533                 <span class="comment">//</span>
00534                 <span class="comment">//  Allocate a buffer for the specified name string.</span>
00535                 <span class="comment">//</span>
00536                 <span class="comment">//  N.B. The name buffer allocation routine adds one</span>
00537                 <span class="comment">//       UNICODE character to the length and initializes</span>
00538                 <span class="comment">//       the string descriptor.</span>
00539                 <span class="comment">//</span>
00540 
00541                 FreeBuffer = <a class="code" href="../../d5/d1/obp_8h.html#a60">ObpAllocateObjectNameBuffer</a>( Length,
00542                                                           UseLookaside,
00543                                                           CapturedObjectName );
00544 
00545                 <span class="keywordflow">if</span> (FreeBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00546 
00547                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00548 
00549                 } <span class="keywordflow">else</span> {
00550 
00551                     <span class="comment">//</span>
00552                     <span class="comment">//  Copy the specified name string to the destination</span>
00553                     <span class="comment">//  buffer.</span>
00554                     <span class="comment">//</span>
00555 
00556                     RtlMoveMemory(FreeBuffer, InputObjectName.Buffer, Length);
00557 
00558                     <span class="comment">//</span>
00559                     <span class="comment">//  Zero terminate the name string and initialize the</span>
00560                     <span class="comment">//  string descriptor.</span>
00561                     <span class="comment">//</span>
00562 
00563                     FreeBuffer[Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
00564                 }
00565             }
00566         }
00567 
00568     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00569 
00570         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00571 
00572         <span class="keywordflow">if</span> (FreeBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00573 
00574             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FreeBuffer);
00575         }
00576     }
00577 
00578     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00579 }
00580 
00581 
00582 PWCHAR
<a name="l00583"></a><a class="code" href="../../d5/d1/obp_8h.html#a60">00583</a> <a class="code" href="../../d5/d1/obp_8h.html#a60">ObpAllocateObjectNameBuffer</a> (
00584     IN ULONG Length,
00585     IN LOGICAL UseLookaside,
00586     IN OUT PUNICODE_STRING ObjectName
00587     )
00588 
00589 <span class="comment">/*++</span>
00590 <span class="comment"></span>
00591 <span class="comment">Routine Description:</span>
00592 <span class="comment"></span>
00593 <span class="comment">    This function allocates an object name buffer.</span>
00594 <span class="comment"></span>
00595 <span class="comment">    N.B. This function is nonpageable.</span>
00596 <span class="comment"></span>
00597 <span class="comment">Arguments:</span>
00598 <span class="comment"></span>
00599 <span class="comment">    Length - Supplies the length of the required buffer in bytes.</span>
00600 <span class="comment"></span>
00601 <span class="comment">    UseLookaside - Supplies a logical variable that determines whether an</span>
00602 <span class="comment">        attempt is made to allocate the name buffer from the lookaside list.</span>
00603 <span class="comment"></span>
00604 <span class="comment">    ObjectName - Supplies a pointer to a name buffer string descriptor.</span>
00605 <span class="comment"></span>
00606 <span class="comment">Return Value:</span>
00607 <span class="comment"></span>
00608 <span class="comment">    If the allocation is successful, then name buffer string descriptor</span>
00609 <span class="comment">    is initialized and the address of the name buffer is returned as the</span>
00610 <span class="comment">    function value. Otherwise, a value of NULL is returned.</span>
00611 <span class="comment"></span>
00612 <span class="comment">--*/</span>
00613 
00614 {
00615     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00616     ULONG Maximum;
00617     KIRQL OldIrql;
00618     PKPRCB Prcb;
00619 
00620     <span class="comment">//</span>
00621     <span class="comment">//  If allocation from the lookaside lists is specified and the buffer</span>
00622     <span class="comment">//  size is less than the size of lookaside list entries, then attempt</span>
00623     <span class="comment">//  to allocate the name buffer from the lookaside lists. Otherwise,</span>
00624     <span class="comment">//  attempt to allocate the name buffer from nonpaged pool.</span>
00625     <span class="comment">//</span>
00626 
00627     Maximum = Length + <span class="keyword">sizeof</span>(WCHAR);
00628 
00629     <span class="keywordflow">if</span> ((UseLookaside == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) || (Maximum &gt; <a class="code" href="../../d5/d1/obp_8h.html#a23">OBJECT_NAME_BUFFER_SIZE</a>)) {
00630 
00631         <span class="comment">//</span>
00632         <span class="comment">//  Attempt to allocate the buffer from nonpaged pool.</span>
00633         <span class="comment">//</span>
00634 
00635         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, Maximum, 'mNbO');
00636 
00637     } <span class="keywordflow">else</span> {
00638 
00639         <span class="comment">//</span>
00640         <span class="comment">//  Attempt to allocate the name buffer from the lookaside list. If</span>
00641         <span class="comment">//  the allocation attempt fails, then attempt to allocate the name</span>
00642         <span class="comment">//  buffer from pool.</span>
00643         <span class="comment">//</span>
00644 
00645         Maximum = <a class="code" href="../../d5/d1/obp_8h.html#a23">OBJECT_NAME_BUFFER_SIZE</a>;
00646         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a254">ExAllocateFromPPNPagedLookasideList</a>(<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>);
00647     }
00648 
00649     <span class="comment">//</span>
00650     <span class="comment">//  Initialize the string descriptor and return the buffer address.</span>
00651     <span class="comment">//</span>
00652 
00653     ObjectName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
00654     ObjectName-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Maximum;
00655     ObjectName-&gt;Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00656 
00657     <span class="keywordflow">return</span> (PWCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00658 }
00659 
00660 
00661 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00662 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00663"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a9">00663</a> <a class="code" href="../../d5/d1/obp_8h.html#a61">ObpFreeObjectNameBuffer</a> (
00664     OUT PUNICODE_STRING ObjectName
00665     )
00666 
00667 <span class="comment">/*++</span>
00668 <span class="comment"></span>
00669 <span class="comment">Routine Description:</span>
00670 <span class="comment"></span>
00671 <span class="comment">    This function frees an object name buffer.</span>
00672 <span class="comment"></span>
00673 <span class="comment">    N.B. This function is nonpageable.</span>
00674 <span class="comment"></span>
00675 <span class="comment">Arguments:</span>
00676 <span class="comment"></span>
00677 <span class="comment">    ObjectName - Supplies a pointer to a name buffer string descriptor.</span>
00678 <span class="comment"></span>
00679 <span class="comment">Return Value:</span>
00680 <span class="comment"></span>
00681 <span class="comment">    None.</span>
00682 <span class="comment"></span>
00683 <span class="comment">--*/</span>
00684 
00685 {
00686     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00687     KIRQL OldIrql;
00688     PKPRCB Prcb;
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">//  If the size of the buffer is not equal to the size of lookaside list</span>
00692     <span class="comment">//  entries, then  free the buffer to pool. Otherwise, free the buffer to</span>
00693     <span class="comment">//  the lookaside list.</span>
00694     <span class="comment">//</span>
00695 
00696     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = ObjectName-&gt;Buffer;
00697 
00698     <span class="keywordflow">if</span> (ObjectName-&gt;MaximumLength != <a class="code" href="../../d5/d1/obp_8h.html#a23">OBJECT_NAME_BUFFER_SIZE</a>) {
00699 
00700         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00701 
00702     } <span class="keywordflow">else</span> {
00703 
00704         <a class="code" href="../../d5/d8/ex_8h.html#a255">ExFreeToPPNPagedLookasideList</a>(<a class="code" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00705     }
00706 
00707     <span class="keywordflow">return</span>;
00708 }
00709 
00710 
00711 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
00712 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00713"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a10">00713</a> <a class="code" href="../../d6/d0/obcreate_8c.html#a10">ObDeleteCapturedInsertInfo</a> (
00714     IN PVOID Object
00715     )
00716 
00717 <span class="comment">/*++</span>
00718 <span class="comment"></span>
00719 <span class="comment">Routine Description:</span>
00720 <span class="comment"></span>
00721 <span class="comment">    This function frees the creation information that could be pointed at</span>
00722 <span class="comment">    by the object header.</span>
00723 <span class="comment"></span>
00724 <span class="comment">Arguments:</span>
00725 <span class="comment"></span>
00726 <span class="comment">    Object - Supplies the object being modified</span>
00727 <span class="comment"></span>
00728 <span class="comment">Return Value:</span>
00729 <span class="comment"></span>
00730 <span class="comment">    None.</span>
00731 <span class="comment"></span>
00732 <span class="comment">--*/</span>
00733 
00734 {
00735     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00736 
00737     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00738 
00739     <span class="comment">//</span>
00740     <span class="comment">//  Get the address of the object header and free the object create</span>
00741     <span class="comment">//  information object if the object is being created.</span>
00742     <span class="comment">//</span>
00743 
00744     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Object);
00745 
00746     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>) {
00747 
00748         <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00749 
00750             <a class="code" href="../../d5/d1/obp_8h.html#a29">ObpFreeObjectCreateInformation</a>(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a>);
00751 
00752             ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00753         }
00754     }
00755 
00756     <span class="keywordflow">return</span>;
00757 }
00758 
00759 
00760 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00761"></a><a class="code" href="../../d5/d1/obp_8h.html#a62">00761</a> <a class="code" href="../../d5/d1/obp_8h.html#a62">ObpAllocateObject</a> (
00762     IN <a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a> ObjectCreateInfo,
00763     IN KPROCESSOR_MODE OwnershipMode,
00764     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL,
00765     IN PUNICODE_STRING ObjectName,
00766     IN ULONG ObjectBodySize,
00767     OUT <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> *ReturnedObjectHeader
00768     )
00769 
00770 <span class="comment">/*++</span>
00771 <span class="comment"></span>
00772 <span class="comment">Routine Description:</span>
00773 <span class="comment"></span>
00774 <span class="comment">    This routine allocates a new object including the object header</span>
00775 <span class="comment">    and body from pool and fill in the appropriate fields.</span>
00776 <span class="comment"></span>
00777 <span class="comment">Arguments:</span>
00778 <span class="comment"></span>
00779 <span class="comment">    ObjectCreateInfo - Supplies the create information for the new object</span>
00780 <span class="comment"></span>
00781 <span class="comment">    OwnershipMode - Supplies the processor mode of who is going to own</span>
00782 <span class="comment">        the object</span>
00783 <span class="comment"></span>
00784 <span class="comment">    ObjectType - Optionally supplies the object type of the object being</span>
00785 <span class="comment">        created. If the object create info not null then this field must</span>
00786 <span class="comment">        be supplied.</span>
00787 <span class="comment"></span>
00788 <span class="comment">    ObjectName - Supplies the name of the object being created</span>
00789 <span class="comment"></span>
00790 <span class="comment">    ObjectBodySize - Specifies the size, in bytes, of the body of the object</span>
00791 <span class="comment">        being created</span>
00792 <span class="comment"></span>
00793 <span class="comment">    ReturnedObjectHeader - Receives a pointer to the object header for the</span>
00794 <span class="comment">        newly created objet.</span>
00795 <span class="comment"></span>
00796 <span class="comment">Return Value:</span>
00797 <span class="comment"></span>
00798 <span class="comment">    An appropriate status value.</span>
00799 <span class="comment"></span>
00800 <span class="comment">--*/</span>
00801 
00802 {
00803     ULONG HeaderSize;
00804     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00805     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00806     PVOID ZoneSegment;
00807     ULONG QuotaInfoSize;
00808     ULONG HandleInfoSize;
00809     ULONG NameInfoSize;
00810     ULONG CreatorInfoSize;
00811     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
00812     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
00813     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00814     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
00815     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
00816 
00817     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00818 
00819     <a class="code" href="../../d6/d0/obcreate_8c.html#a0">ObpObjectsCreated</a> += 1;
00820 
00821     <span class="comment">//</span>
00822     <span class="comment">//  Compute the sizes of the optional object header components.</span>
00823     <span class="comment">//</span>
00824 
00825     <span class="keywordflow">if</span> (ObjectCreateInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00826 
00827         QuotaInfoSize = 0;
00828         HandleInfoSize = 0;
00829         NameInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">OBJECT_HEADER_NAME_INFO</a> );
00830         CreatorInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">OBJECT_HEADER_CREATOR_INFO</a> );
00831 
00832     } <span class="keywordflow">else</span> {
00833 
00834         <span class="comment">//</span>
00835         <span class="comment">//  The caller specified some additional object create info</span>
00836         <span class="comment">//</span>
00837         <span class="comment">//  First check to see if we need to set the quota</span>
00838         <span class="comment">//</span>
00839 
00840         <span class="keywordflow">if</span> (ObjectCreateInfo-&gt;PagedPoolCharge != ObjectType-&gt;TypeInfo.DefaultPagedPoolCharge ||
00841             ObjectCreateInfo-&gt;NonPagedPoolCharge != ObjectType-&gt;TypeInfo.DefaultNonPagedPoolCharge ||
00842             ObjectCreateInfo-&gt;SecurityDescriptorCharge &gt; <a class="code" href="../../d0/d5/se_8h.html#a0">SE_DEFAULT_SECURITY_QUOTA</a> ||
00843             (ObjectCreateInfo-&gt;Attributes &amp; OBJ_EXCLUSIVE)) {
00844 
00845             QuotaInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">OBJECT_HEADER_QUOTA_INFO</a> );
00846             <a class="code" href="../../d6/d0/obcreate_8c.html#a1">ObpObjectsWithPoolQuota</a> += 1;
00847 
00848         } <span class="keywordflow">else</span> {
00849 
00850             QuotaInfoSize = 0;
00851         }
00852 
00853         <span class="comment">//</span>
00854         <span class="comment">//  Check if we are to allocate space to maintain handle counts</span>
00855         <span class="comment">//</span>
00856 
00857         <span class="keywordflow">if</span> (ObjectType-&gt;TypeInfo.MaintainHandleCount) {
00858 
00859             HandleInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">OBJECT_HEADER_HANDLE_INFO</a> );
00860             <a class="code" href="../../d6/d0/obcreate_8c.html#a2">ObpObjectsWithHandleDB</a> += 1;
00861 
00862         } <span class="keywordflow">else</span> {
00863 
00864             HandleInfoSize = 0;
00865         }
00866 
00867         <span class="comment">//</span>
00868         <span class="comment">//  Check if we are to allocate space for the name</span>
00869         <span class="comment">//</span>
00870 
00871         <span class="keywordflow">if</span> (ObjectName-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00872 
00873             NameInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">OBJECT_HEADER_NAME_INFO</a> );
00874             <a class="code" href="../../d6/d0/obcreate_8c.html#a3">ObpObjectsWithName</a> += 1;
00875 
00876         } <span class="keywordflow">else</span> {
00877 
00878             NameInfoSize = 0;
00879         }
00880 
00881         <span class="comment">//</span>
00882         <span class="comment">//  Finally check if we are to maintain the creator info</span>
00883         <span class="comment">//</span>
00884 
00885         <span class="keywordflow">if</span> (ObjectType-&gt;TypeInfo.MaintainTypeList) {
00886 
00887             CreatorInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">OBJECT_HEADER_CREATOR_INFO</a> );
00888             <a class="code" href="../../d6/d0/obcreate_8c.html#a4">ObpObjectsWithCreatorInfo</a> += 1;
00889 
00890         } <span class="keywordflow">else</span> {
00891 
00892             CreatorInfoSize = 0;
00893         }
00894     }
00895 
00896     <span class="comment">//</span>
00897     <span class="comment">//  Now compute the total header size</span>
00898     <span class="comment">//</span>
00899 
00900     HeaderSize = QuotaInfoSize +
00901                  HandleInfoSize +
00902                  NameInfoSize +
00903                  CreatorInfoSize +
00904                  FIELD_OFFSET( <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">OBJECT_HEADER</a>, Body );
00905 
00906     <span class="comment">//</span>
00907     <span class="comment">//  Allocate and initialize the object.</span>
00908     <span class="comment">//</span>
00909     <span class="comment">//  If the object type is not specified or specifies nonpaged pool,</span>
00910     <span class="comment">//  then allocate the object from nonpaged pool.</span>
00911     <span class="comment">//  Otherwise, allocate the object from paged pool.</span>
00912     <span class="comment">//</span>
00913 
00914     <span class="keywordflow">if</span> ((ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (ObjectType-&gt;TypeInfo.PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>)) {
00915 
00916         PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00917 
00918     } <span class="keywordflow">else</span> {
00919 
00920         PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00921     }
00922 
00923     ObjectHeader = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PoolType,
00924                                           HeaderSize + ObjectBodySize,
00925                                           (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? 'TjbO' : ObjectType-&gt;Key) |
00926                                             <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a> );
00927 
00928     <span class="keywordflow">if</span> (ObjectHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00929 
00930         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00931     }
00932 
00933     <span class="comment">//</span>
00934     <span class="comment">//  Now based on if we are to put in the quota, handle, name, or creator info we</span>
00935     <span class="comment">//  will do the extra work.  This order is very important because we rely on</span>
00936     <span class="comment">//  it to free the object.</span>
00937     <span class="comment">//</span>
00938 
00939     <span class="keywordflow">if</span> (QuotaInfoSize != 0) {
00940 
00941         QuotaInfo = (<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a>)ObjectHeader;
00942         QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o0">PagedPoolCharge</a> = ObjectCreateInfo-&gt;PagedPoolCharge;
00943         QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o1">NonPagedPoolCharge</a> = ObjectCreateInfo-&gt;NonPagedPoolCharge;
00944         QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a> = ObjectCreateInfo-&gt;SecurityDescriptorCharge;
00945         QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o3">ExclusiveProcess</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00946         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(QuotaInfo + 1);
00947     }
00948 
00949     <span class="keywordflow">if</span> (HandleInfoSize != 0) {
00950 
00951         HandleInfo = (<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a>)ObjectHeader;
00952         HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 0;
00953         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(HandleInfo + 1);
00954     }
00955 
00956     <span class="keywordflow">if</span> (NameInfoSize != 0) {
00957 
00958         NameInfo = (<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a>)ObjectHeader;
00959         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a> = *ObjectName;
00960         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00961         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(NameInfo + 1);
00962     }
00963 
00964     <span class="keywordflow">if</span> (CreatorInfoSize != 0) {
00965 
00966         CreatorInfo = (<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a>)ObjectHeader;
00967         CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o2">CreatorBackTraceIndex</a> = 0;
00968         CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o1">CreatorUniqueProcess</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId;
00969         InitializeListHead( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
00970         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(CreatorInfo + 1);
00971     }
00972 
00973     <span class="comment">//</span>
00974     <span class="comment">//  Compute the proper offsets based on what we have</span>
00975     <span class="comment">//</span>
00976 
00977     <span class="keywordflow">if</span> (QuotaInfoSize != 0) {
00978 
00979         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o6">QuotaInfoOffset</a> = (UCHAR)(QuotaInfoSize + HandleInfoSize + NameInfoSize + CreatorInfoSize);
00980 
00981     } <span class="keywordflow">else</span> {
00982 
00983         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o6">QuotaInfoOffset</a> = 0;
00984     }
00985 
00986     <span class="keywordflow">if</span> (HandleInfoSize != 0) {
00987 
00988         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o5">HandleInfoOffset</a> = (UCHAR)(HandleInfoSize + NameInfoSize + CreatorInfoSize);
00989 
00990     } <span class="keywordflow">else</span> {
00991 
00992         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o5">HandleInfoOffset</a> = 0;
00993     }
00994 
00995     <span class="keywordflow">if</span> (NameInfoSize != 0) {
00996 
00997         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o4">NameInfoOffset</a> =  (UCHAR)(NameInfoSize + CreatorInfoSize);
00998 
00999     } <span class="keywordflow">else</span> {
01000 
01001         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o4">NameInfoOffset</a> = 0;
01002     }
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">//  Say that this is a new object, and conditionally set the other flags</span>
01006     <span class="comment">//</span>
01007 
01008     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> = <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>;
01009 
01010     <span class="keywordflow">if</span> (CreatorInfoSize != 0) {
01011 
01012         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a3">OB_FLAG_CREATOR_INFO</a>;
01013     }
01014 
01015     <span class="keywordflow">if</span> (HandleInfoSize != 0) {
01016 
01017         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>;
01018     }
01019 
01020     <span class="comment">//</span>
01021     <span class="comment">//  Set the counters and its type</span>
01022     <span class="comment">//</span>
01023 
01024     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o0">PointerCount</a> = 1;
01025     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> = 0;
01026     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> = ObjectType;
01027 
01028     <span class="comment">//</span>
01029     <span class="comment">//  Initialize the object header.</span>
01030     <span class="comment">//</span>
01031     <span class="comment">//  N.B. The initialization of the object header is done field by</span>
01032     <span class="comment">//       field rather than zeroing the memory and then initializing</span>
01033     <span class="comment">//       the pertinent fields.</span>
01034     <span class="comment">//</span>
01035     <span class="comment">//  N.B. It is assumed that the caller will initialize the object</span>
01036     <span class="comment">//       attributes, object ownership, and parse context.</span>
01037     <span class="comment">//</span>
01038 
01039     <span class="keywordflow">if</span> (OwnershipMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01040 
01041         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a2">OB_FLAG_KERNEL_OBJECT</a>;
01042     }
01043 
01044     <span class="keywordflow">if</span> (ObjectCreateInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01045         ObjectCreateInfo-&gt;Attributes &amp; OBJ_PERMANENT ) {
01046 
01047         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a5">OB_FLAG_PERMANENT_OBJECT</a>;
01048     }
01049 
01050     <span class="keywordflow">if</span> ((ObjectCreateInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01051         (ObjectCreateInfo-&gt;Attributes &amp; OBJ_EXCLUSIVE)) {
01052 
01053         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>;
01054     }
01055 
01056     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> = ObjectCreateInfo;
01057     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01058 
01059     <span class="keywordflow">if</span> (ObjectType != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01060 
01061         ObjectType-&gt;TotalNumberOfObjects += 1;
01062 
01063         <span class="keywordflow">if</span> (ObjectType-&gt;TotalNumberOfObjects &gt; ObjectType-&gt;HighWaterNumberOfObjects) {
01064 
01065             ObjectType-&gt;HighWaterNumberOfObjects = ObjectType-&gt;TotalNumberOfObjects;
01066         }
01067     }
01068 
01069 <span class="preprocessor">#if DBG</span>
01070 <span class="preprocessor"></span>
01071     <span class="comment">//</span>
01072     <span class="comment">//  On a checked build echo out allocs</span>
01073     <span class="comment">//</span>
01074 
01075     <span class="keywordflow">if</span> (ObpShowAllocAndFree) {
01076 
01077         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"OB: Alloc %lx (%lx) %04lu"</span>, ObjectHeader, ObjectHeader, ObjectBodySize );
01078 
01079         <span class="keywordflow">if</span> (ObjectType) {
01080 
01081             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" - %wZ\n"</span>, &amp;ObjectType-&gt;Name );
01082 
01083         } <span class="keywordflow">else</span> {
01084 
01085             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" - Type\n"</span> );
01086         }
01087     }
01088 <span class="preprocessor">#endif</span>
01089 <span class="preprocessor"></span>
01090     *ReturnedObjectHeader = ObjectHeader;
01091 
01092     <span class="keywordflow">return</span> STATUS_SUCCESS;
01093 }
01094 
01095 
01096 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01097 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01098"></a><a class="code" href="../../d5/d1/obp_8h.html#a63">01098</a> <a class="code" href="../../d5/d1/obp_8h.html#a63">ObpFreeObject</a> (
01099     IN PVOID Object
01100     )
01101 
01102 <span class="comment">/*++</span>
01103 <span class="comment"></span>
01104 <span class="comment">Routine Description:</span>
01105 <span class="comment"></span>
01106 <span class="comment">    This routine undoes ObpAllocateObject.  It returns the object back to free pool.</span>
01107 <span class="comment"></span>
01108 <span class="comment">Arguments:</span>
01109 <span class="comment"></span>
01110 <span class="comment">    Object - Supplies a pointer to the body of the object being freed.</span>
01111 <span class="comment"></span>
01112 <span class="comment">Return Value:</span>
01113 <span class="comment"></span>
01114 <span class="comment">    None.</span>
01115 <span class="comment"></span>
01116 <span class="comment">--*/</span>
01117 
01118 {
01119     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01120     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01121     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01122     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
01123     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01124     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01125     PVOID FreeBuffer;
01126     ULONG NonPagedPoolCharge;
01127     ULONG PagedPoolCharge;
01128 
01129     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01130 
01131     <span class="comment">//</span>
01132     <span class="comment">//  Get the address of the object header.</span>
01133     <span class="comment">//</span>
01134 
01135     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Object);
01136     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01137 
01138     <span class="comment">//</span>
01139     <span class="comment">//  Now from the header determine the start of the allocation.  We need</span>
01140     <span class="comment">//  to backup based on what precedes the header.  The order is very</span>
01141     <span class="comment">//  important and must be the inverse of that used by ObpAllocateObject</span>
01142     <span class="comment">//</span>
01143 
01144     FreeBuffer = ObjectHeader;
01145 
01146     CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01147 
01148     <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01149 
01150         FreeBuffer = CreatorInfo;
01151     }
01152 
01153     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01154 
01155     <span class="keywordflow">if</span> (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01156 
01157         FreeBuffer = NameInfo;
01158     }
01159 
01160     HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>( ObjectHeader );
01161 
01162     <span class="keywordflow">if</span> (HandleInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01163 
01164         FreeBuffer = HandleInfo;
01165     }
01166 
01167     QuotaInfo = <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader );
01168 
01169     <span class="keywordflow">if</span> (QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01170 
01171         FreeBuffer = QuotaInfo;
01172     }
01173 
01174 <span class="preprocessor">#if DBG</span>
01175 <span class="preprocessor"></span>
01176     <span class="comment">//</span>
01177     <span class="comment">//  On a checked build echo out frees</span>
01178     <span class="comment">//</span>
01179 
01180     <span class="keywordflow">if</span> (ObpShowAllocAndFree) {
01181 
01182         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"OB: Free  %lx (%lx) - Type: %wZ\n"</span>, ObjectHeader, ObjectHeader, &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a> );
01183     }
01184 <span class="preprocessor">#endif</span>
01185 <span class="preprocessor"></span>
01186     <span class="comment">//</span>
01187     <span class="comment">//  Decrement the number of objects of this type</span>
01188     <span class="comment">//</span>
01189 
01190     ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o5">TotalNumberOfObjects</a> -= 1;
01191 
01192     <span class="comment">//</span>
01193     <span class="comment">//  Check where we were in the object initialization phase.  This</span>
01194     <span class="comment">//  flag really only tests if we have charged quota for this object.</span>
01195     <span class="comment">//  This is because the object create info and the quota block charged</span>
01196     <span class="comment">//  are unioned together.</span>
01197     <span class="comment">//</span>
01198 
01199     <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>) {
01200 
01201         <span class="keywordflow">if</span> (ObjectHeader-&gt;ObjectCreateInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01202 
01203             <a class="code" href="../../d5/d1/obp_8h.html#a29">ObpFreeObjectCreateInformation</a>( ObjectHeader-&gt;ObjectCreateInfo );
01204 
01205             ObjectHeader-&gt;ObjectCreateInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01206         }
01207 
01208     } <span class="keywordflow">else</span> {
01209 
01210         <span class="keywordflow">if</span> (ObjectHeader-&gt;QuotaBlockCharged != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01211 
01212             <span class="keywordflow">if</span> (QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01213 
01214                 PagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o0">PagedPoolCharge</a> +
01215                                   QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a>;
01216 
01217                 NonPagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o1">NonPagedPoolCharge</a>;
01218 
01219             } <span class="keywordflow">else</span> {
01220 
01221                 PagedPoolCharge = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a>;
01222 
01223                 <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a6">OB_FLAG_DEFAULT_SECURITY_QUOTA</a> ) {
01224 
01225                     PagedPoolCharge += <a class="code" href="../../d0/d5/se_8h.html#a0">SE_DEFAULT_SECURITY_QUOTA</a>;
01226                 }
01227 
01228                 NonPagedPoolCharge = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a>;
01229             }
01230 
01231             <a class="code" href="../../d0/d2/psquota_8c.html#a1">PsReturnSharedPoolQuota</a>( ObjectHeader-&gt;QuotaBlockCharged,
01232                                      PagedPoolCharge,
01233                                      NonPagedPoolCharge );
01234         }
01235     }
01236 
01237     <span class="keywordflow">if</span> ((HandleInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01238         ((ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) == 0)) {
01239 
01240         <span class="comment">//</span>
01241         <span class="comment">//  If a handle database has been allocated, then free the memory.</span>
01242         <span class="comment">//</span>
01243 
01244         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a> );
01245 
01246         HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01247     }
01248 
01249     <span class="comment">//</span>
01250     <span class="comment">//  If a name string buffer has been allocated, then free the memory.</span>
01251     <span class="comment">//</span>
01252 
01253     <span class="keywordflow">if</span> (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01254 
01255         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer );
01256 
01257         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01258     }
01259 
01260     <span class="comment">//</span>
01261     <span class="comment">//  Trash type field so we don't get far if we attempt to</span>
01262     <span class="comment">//  use a stale object pointer to this object.</span>
01263     <span class="comment">//</span>
01264     <span class="comment">//  Sundown Note: trash it by zero-extended it. </span>
01265     <span class="comment">//                sign-extension will create a valid kernel address.</span>
01266 
01267 
01268     ObjectHeader-&gt;Type = UIntToPtr(0xBAD0B0B0); 
01269     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>( FreeBuffer,
01270                        (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? 'TjbO' : ObjectType-&gt;Key) |
01271                             <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a> );
01272 
01273     <span class="keywordflow">return</span>;
01274 }
01275 
01276 
01277 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01278 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01279"></a><a class="code" href="../../d6/d0/obcreate_8c.html#a13">01279</a> <a class="code" href="../../d6/d0/obcreate_8c.html#a13">ObFreeObjectCreateInfoBuffer</a> (
01280     IN <a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a> ObjectCreateInfo
01281     )
01282 
01283 <span class="comment">/*++</span>
01284 <span class="comment"></span>
01285 <span class="comment">Routine Description:</span>
01286 <span class="comment"></span>
01287 <span class="comment">    This function frees a create information buffer.  Called from IO component</span>
01288 <span class="comment"></span>
01289 <span class="comment">    N.B. This function is nonpageable.</span>
01290 <span class="comment"></span>
01291 <span class="comment">Arguments:</span>
01292 <span class="comment"></span>
01293 <span class="comment">    ObjectCreateInfo - Supplies a pointer to a create information buffer.</span>
01294 <span class="comment"></span>
01295 <span class="comment">Return Value:</span>
01296 <span class="comment"></span>
01297 <span class="comment">    None.</span>
01298 <span class="comment"></span>
01299 <span class="comment">--*/</span>
01300 
01301 {
01302     <a class="code" href="../../d5/d1/obp_8h.html#a32">ObpFreeObjectCreateInfoBuffer</a>( ObjectCreateInfo );
01303 
01304     <span class="keywordflow">return</span>;
01305 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
