<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: misc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>misc.c</h1><a href="../../d6/d0/w32_2ntuser_2kernel_2misc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: misc.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains citrix code.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">\***************************************************************************/</span>
00009 
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 <span class="comment">/*</span>
00015 <span class="comment"> * All of the following are gotten from ICASRV</span>
00016 <span class="comment"> */</span>
00017 
<a name="l00018"></a><a class="code" href="../../d6/d0/w32_2ntuser_2kernel_2misc_8c.html#a0">00018</a> CACHE_STATISTICS <a class="code" href="../../d6/d0/w32_2ntuser_2kernel_2misc_8c.html#a0">ThinWireCache</a>;
00019 
<a name="l00020"></a><a class="code" href="../../d4/d1/userk_8h.html#a2085">00020</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a2085">RemoteConnect</a>(
00021     IN <a class="code" href="../../d3/d8/struct__DOCONNECTDATA.html">PDOCONNECTDATA</a> pDoConnectData,
00022     IN ULONG DisplayDriverNameLength,
00023     IN PWCHAR DisplayDriverName)
00024 {
00025     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00026     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>      pFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00027     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>    pDeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00028     PWCHAR            pSep;
00029 
00030     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"RemoteConnect: display %ws\n"</span>, DisplayDriverName));
00031 
00032     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a756">HH_REMOTECONNECT</a>);
00033 
00034     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00035 
00036     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a354">gpThinWireCache</a> = &amp;<a class="code" href="../../d6/d0/w32_2ntuser_2kernel_2misc_8c.html#a0">ThinWireCache</a>;
00037 
00038     <span class="keywordflow">if</span> (pDoConnectData-&gt;fMouse) {
00039         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a334">ghRemoteMouseChannel</a> = pDoConnectData-&gt;IcaMouseChannel;
00040     } <span class="keywordflow">else</span> {
00041         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a334">ghRemoteMouseChannel</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00042     }
00043 
00044     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a333">ghRemoteVideoChannel</a> = pDoConnectData-&gt;IcaVideoChannel;
00045     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a335">ghRemoteBeepChannel</a> = pDoConnectData-&gt;IcaBeepChannel;
00046     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a337">ghRemoteKeyboardChannel</a> = pDoConnectData-&gt;IcaKeyboardChannel;
00047     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a338">ghRemoteThinwireChannel</a> = pDoConnectData-&gt;IcaThinwireChannel;
00048 
00049     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a339">gRemoteClientKeyboardType</a> = pDoConnectData-&gt;ClientKeyboardType;
00050 
00051     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a343">gbClientDoubleClickSupport</a> = pDoConnectData-&gt;fClientDoubleClickSupport;
00052 
00053     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a344">gfEnableWindowsKey</a> = pDoConnectData-&gt;fEnableWindowsKey;
00054 
00055     RtlCopyMemory(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a326">gWinStationInfo</a>.ProtocolName, pDoConnectData-&gt;ProtocolName,
00056                   WPROTOCOLNAME_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
00057 
00058     RtlCopyMemory(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a326">gWinStationInfo</a>.AudioDriverName, pDoConnectData-&gt;AudioDriverName,
00059                   WAUDIONAME_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
00060 
00061     RtlZeroMemory(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a351">gstrBaseWinStationName</a>,
00062                   WINSTATIONNAME_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
00063 
00064     RtlCopyMemory(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a351">gstrBaseWinStationName</a>, pDoConnectData-&gt;WinStationName,
00065                   <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(WINSTATIONNAME_LENGTH * <span class="keyword">sizeof</span>(WCHAR), <span class="keyword">sizeof</span>(pDoConnectData-&gt;WinStationName)));
00066 
00067     <span class="keywordflow">if</span> (pSep = wcschr(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a351">gstrBaseWinStationName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'#'</span>))
00068         *pSep = UNICODE_NULL;
00069 
00070     <span class="comment">/*</span>
00071 <span class="comment">     * Create the event that is signaled when a desktop does away</span>
00072 <span class="comment">     */</span>
00073     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a346">gpevtDesktopDestroyed</a> = <a class="code" href="../../d4/d1/userk_8h.html#a965">CreateKernelEvent</a>(SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00074     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a346">gpevtDesktopDestroyed</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00075         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RemoteConnect couldn't create gpevtDesktopDestroyed"</span>);
00076         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00077     }
00078 
00079     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00080 
00081     <span class="comment">/*</span>
00082 <span class="comment">     * WinStations must have the video device handle passed to them.</span>
00083 <span class="comment">     */</span>
00084     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> &amp;&amp; !<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a352">gVideoFileObject</a>) {
00085 
00086         <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>    pFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00087         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  pDeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00088 
00089         <span class="comment">//</span>
00090         <span class="comment">// Dereference the file handle</span>
00091         <span class="comment">// and obtain a pointer to the device object for the handle.</span>
00092         <span class="comment">//</span>
00093 
00094         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a333">ghRemoteVideoChannel</a>,
00095                                            0,
00096                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00097                                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00098                                            (PVOID*)&amp;pFileObject,
00099                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00100         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00101 
00102             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a352">gVideoFileObject</a> = pFileObject;
00103 
00104             <span class="comment">//</span>
00105             <span class="comment">// Get a pointer to the device object for this file.</span>
00106             <span class="comment">//</span>
00107             pDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>(pFileObject);
00108 
00109             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a338">ghRemoteThinwireChannel</a>,
00110                                                0,
00111                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00112                                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00113                                                (PVOID*)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>,
00114                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00115 
00116             <span class="comment">/*</span>
00117 <span class="comment">             * This must be done before any thinwire data.</span>
00118 <span class="comment">             */</span>
00119             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00120 
00121                 <span class="keywordflow">if</span> (!GreMultiUserInitSession(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a338">ghRemoteThinwireChannel</a>,
00122                                              (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a354">gpThinWireCache</a>,
00123                                              <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a352">gVideoFileObject</a>,
00124                                              <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>,
00125                                              DisplayDriverNameLength,
00126                                              DisplayDriverName)) {
00127                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"UserInit: GreMultiUserInitSession failed"</span>);
00128                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00129                 } <span class="keywordflow">else</span> {
00130 
00131                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> BytesReturned;
00132 
00133                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GreDeviceIoControl( pDeviceObject,
00134                                  IOCTL_VIDEO_ICA_ENABLE_GRAPHICS,
00135                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00136                                  0,
00137                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00138                                  0,
00139                                  &amp;BytesReturned);
00140                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00141                         RIPMSG1(RIP_WARNING, <span class="stringliteral">"UserInit: Enable graphics status %08lx"</span>,
00142                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00143                     }
00144                 }
00145             }
00146         }
00147     }
00148 
00149     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00150         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RemoteConnect failed"</span>);
00151         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00152     }
00153 
00154     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1264">InitVideo</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00155         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00156         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitVideo failed"</span>);
00157         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00158     }
00159 
00160     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1844">LW_BrushInit</a>()) {
00161         RIPMSG0(RIP_WARNING, <span class="stringliteral">"LW_BrushInit failed"</span>);
00162         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00163     }
00164 
00165     <a class="code" href="../../d9/d6/kernel_2server_8c.html#a71">InitLoadResources</a>();
00166 
00167     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a335">ghRemoteBeepChannel</a>,
00168                                        0,
00169                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00170                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00171                                        (PVOID*)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a336">gpRemoteBeepDevice</a>,
00172                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00173 
00174     <span class="comment">/*</span>
00175 <span class="comment">     * video is initialized at this point</span>
00176 <span class="comment">     */</span>
00177     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00178         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a323">gbVideoInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00179     } <span class="keywordflow">else</span> {
00180         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Bad Remote Beep Channel"</span>);
00181     }
00182 
00183     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00184 }
00185 
00186 
00187 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00188"></a><a class="code" href="../../d4/d1/userk_8h.html#a2086">00188</a> <a class="code" href="../../d4/d1/userk_8h.html#a2086">xxxRemoteDisconnect</a>(
00189     VOID)
00190 {
00191     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00192     LARGE_INTEGER li;
00193 
00194     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"xxxRemoteDisconnect\n"</span>));
00195 
00196     <span class="comment">/*</span>
00197 <span class="comment">     * Only allow CSRSS to do this</span>
00198 <span class="comment">     */</span>
00199     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00200         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00201     }
00202 
00203     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a757">HH_REMOTEDISCONNECT</a>);
00204 
00205     RtlZeroMemory(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a351">gstrBaseWinStationName</a>,
00206                   WINSTATIONNAME_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
00207 
00208     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a>);
00209 
00210     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00211         <span class="comment">/*</span>
00212 <span class="comment">         * Convert dwMilliseconds to a relative-time(i.e.  negative)</span>
00213 <span class="comment">         * LARGE_INTEGER.  NT Base calls take time values in 100 nanosecond</span>
00214 <span class="comment">         * units. Timeout after 5 minutes.</span>
00215 <span class="comment">         */</span>
00216         li.QuadPart = Int32x32To64(-10000, 300000);
00217 
00218         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a19">gpEventDiconnectDesktop</a>,
00219                               <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
00220                               <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00221                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00222                               &amp;li);
00223     }
00224 
00225 
00226     <span class="comment">/*</span>
00227 <span class="comment">     * If the disconnected desktop has not yet be setup.  Do not do any</span>
00228 <span class="comment">     * disconnect processing.  It's better for the thinwire driver to try</span>
00229 <span class="comment">     * and write rather than for the transmit buffers to be freed (trap).</span>
00230 <span class="comment">     */</span>
00231     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>) {
00232 
00233         <span class="comment">/*</span>
00234 <span class="comment">         * Blank the screen</span>
00235 <span class="comment">         *</span>
00236 <span class="comment">         * No need to stop graphics mode for disconnects</span>
00237 <span class="comment">         */</span>
00238         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2090">xxxRemoteStopScreenUpdates</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00239         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00240             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00241         }
00242 
00243         <span class="comment">/*</span>
00244 <span class="comment">         * If there are any shadow connections, then redraw the screen now.</span>
00245 <span class="comment">         */</span>
00246         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a>)
00247             <a class="code" href="../../d4/d1/userk_8h.html#a2104">RemoteRedrawScreen</a>();
00248     } <span class="keywordflow">else</span> {
00249         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxRemoteDisconnect failed. The disconnect desktop was not created"</span>);
00250         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00251     }
00252 
00253     <span class="comment">/*</span>
00254 <span class="comment">     * Tell thinwire driver about this</span>
00255 <span class="comment">     */</span>
00256     bDrvDisconnect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a338">ghRemoteThinwireChannel</a>,
00257                    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>);
00258 
00259     
00260     <span class="comment">/*</span>
00261 <span class="comment">     * Tell winlogon about the disconnect</span>
00262 <span class="comment">     */</span>
00263     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00264         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY, SESSION_DISCONNECTED, 0);
00265     }
00266 
00267     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00268 
00269     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00270 }
00271 
00272 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00273"></a><a class="code" href="../../d4/d1/userk_8h.html#a2087">00273</a> <a class="code" href="../../d4/d1/userk_8h.html#a2087">xxxRemoteReconnect</a>(
00274     IN <a class="code" href="../../d4/d8/struct__DORECONNECTDATA.html">PDORECONNECTDATA</a> pDoReconnectData)
00275 {
00276     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00277     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     fResult;
00278     PWCHAR   pSep;
00279 
00280     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"xxxRemoteReconnect\n"</span>));
00281 
00282     <span class="comment">/*</span>
00283 <span class="comment">     * Only allow CSRSS to do this</span>
00284 <span class="comment">     */</span>
00285     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00286         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00287     }
00288 
00289     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a758">HH_REMOTERECONNECT</a>);
00290 
00291     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00292 
00293     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a339">gRemoteClientKeyboardType</a> = pDoReconnectData-&gt;ClientKeyboardType;
00294 
00295     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a343">gbClientDoubleClickSupport</a> = pDoReconnectData-&gt;fClientDoubleClickSupport;
00296 
00297     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a344">gfEnableWindowsKey</a> = pDoReconnectData-&gt;fEnableWindowsKey;
00298 
00299     RtlCopyMemory(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a351">gstrBaseWinStationName</a>, pDoReconnectData-&gt;WinStationName,
00300                   <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(WINSTATIONNAME_LENGTH * <span class="keyword">sizeof</span>(WCHAR), <span class="keyword">sizeof</span>(pDoReconnectData-&gt;WinStationName)));
00301 
00302     <span class="keywordflow">if</span> (pSep = wcschr(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a351">gstrBaseWinStationName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'#'</span>))
00303         *pSep = UNICODE_NULL;
00304 
00305     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a>)
00306         <a class="code" href="../../d4/d1/userk_8h.html#a2090">xxxRemoteStopScreenUpdates</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00307 
00308 
00309     <span class="comment">/*</span>
00310 <span class="comment">     * Call thinwire driver to check for thinwire mode compatibility</span>
00311 <span class="comment">     */</span>
00312     fResult = bDrvReconnect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a338">ghRemoteThinwireChannel</a>,
00313                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>);
00314 
00315     <span class="keywordflow">if</span> (!fResult) {
00316         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a>)
00317             <a class="code" href="../../d4/d1/userk_8h.html#a2104">RemoteRedrawScreen</a>();
00318 
00319         <span class="keywordflow">return</span> STATUS_CTX_BAD_VIDEO_MODE;
00320     }
00321 
00322 
00323 
00324     <span class="comment">/*</span>
00325 <span class="comment">     *  If instructed to do so, change Display mode before Reconnecting.</span>
00326 <span class="comment">     *  Use display resolution information from Reconnect data.</span>
00327 <span class="comment">     */</span>
00328 
00329     <span class="keywordflow">if</span> (pDoReconnectData-&gt;fChangeDisplaySettings) {
00330        DEVMODEW devmodew;
00331        UNICODE_STRING ustrDeviceName;
00332        PDEVMODEW pDevmodew = &amp;devmodew;
00333 
00334        RtlZeroMemory(pDevmodew, <span class="keyword">sizeof</span>(DEVMODEW));
00335        pDevmodew-&gt;dmPelsHeight = pDoReconnectData-&gt;drPelsHeight;
00336        pDevmodew-&gt;dmPelsWidth  = pDoReconnectData-&gt;drPelsWidth;
00337        pDevmodew-&gt;dmBitsPerPel = pDoReconnectData-&gt;drBitsPerPel;
00338        pDevmodew-&gt;dmFields     = DM_BITSPERPEL  | DM_PELSWIDTH  | DM_PELSHEIGHT;
00339        pDevmodew-&gt;dmSize       = <span class="keyword">sizeof</span>(DEVMODEW);
00340 
00341        <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ustrDeviceName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\\\.\\DISPLAY1"</span>);
00342 
00343 
00344        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1758">xxxUserChangeDisplaySettings</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">//&amp;ustrDeviceName,</span>
00345                                             &amp;devmodew,
00346                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00347                                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>,
00348                                             0,
00349                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00350                                             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
00351        <span class="comment">/*</span>
00352 <span class="comment">        * If Display settings change fails, let us disconnect the display driver</span>
00353 <span class="comment">        * as the reconnect is going to be failed anyway.</span>
00354 <span class="comment">        */</span>
00355 
00356 
00357        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00358           bDrvDisconnect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a338">ghRemoteThinwireChannel</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>);
00359           <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00360        }
00361 
00362        <span class="comment">/*</span>
00363 <span class="comment">        * Code in RemoteRedrawScreen() Expects gpDispInfo-&gt;pmdev to disabled, but</span>
00364 <span class="comment">        * it has been enabled by xxxUserChangeDisplaySettings(), so let's disable it</span>
00365 <span class="comment">        * before calling RemoteRedrawScreen().</span>
00366 <span class="comment">        */</span>
00367        DrvDisableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00368 
00369     }
00370 
00371     <span class="comment">/*</span>
00372 <span class="comment">     * Now we can swicth out from disconnected desktop, to normal</span>
00373 <span class="comment">     * desktop, in order to renable screen update.</span>
00374 <span class="comment">     */</span>
00375 
00376     <a class="code" href="../../d4/d1/userk_8h.html#a2104">RemoteRedrawScreen</a>();
00377 
00378     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00379         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY,
00380                      SESSION_RECONNECTED, 0);
00381     }
00382 
00383     <span class="comment">/*</span>
00384 <span class="comment">     * We need to re-init the mouse, especially since we may not have had one before.</span>
00385 <span class="comment">     */</span>
00386     <a class="code" href="../../d6/d8/ntinput_8c.html#a40">UpdateMouseInfo</a>();
00387 
00388     <span class="comment">/*</span>
00389 <span class="comment">     * Re-init'ing the keyboard may not be as neccessary.  Possibly the keyboard</span>
00390 <span class="comment">     * attributes have changed.</span>
00391 <span class="comment">     */</span>
00392     <a class="code" href="../../d4/d1/userk_8h.html#a1174">InitKeyboard</a>();
00393 
00394     <span class="comment">/*</span>
00395 <span class="comment">     * This is neccessary to sync up the client and the host.</span>
00396 <span class="comment">     */</span>
00397     <a class="code" href="../../d4/d1/userk_8h.html#a1180">UpdateKeyLights</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00398 
00399     <a class="code" href="../../d4/d1/userk_8h.html#a1790">SetPointer</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00400 
00401     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00402 
00403 
00404 
00405     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00406 }
00407 
00408 <span class="comment">/*</span>
00409 <span class="comment"> * This allows ICASRV to cleanly logoff the user.  We send a message to winlogon and let</span>
00410 <span class="comment"> * him do it.  We used to call ExitWindowsEx() directly, but that caused too many problems</span>
00411 <span class="comment"> * when it was called from CSRSS.</span>
00412 <span class="comment"> *</span>
00413 <span class="comment"> */</span>
00414 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00415"></a><a class="code" href="../../d4/d1/userk_8h.html#a2088">00415</a> <a class="code" href="../../d4/d1/userk_8h.html#a2088">RemoteLogoff</a>(
00416     VOID)
00417 {
00418     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00419 
00420     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"RemoteLogoff\n"</span>));
00421 
00422     <span class="comment">/*</span>
00423 <span class="comment">     * Only allow CSRSS to do this</span>
00424 <span class="comment">     */</span>
00425     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00426         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00427     }
00428 
00429     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a759">HH_REMOTELOGOFF</a>);
00430 
00431     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00432 
00433     <span class="comment">/*</span>
00434 <span class="comment">     * Tell winlogon about the logoff</span>
00435 <span class="comment">     */</span>
00436     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00437         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY,
00438                      SESSION_LOGOFF, EWX_LOGOFF | EWX_FORCE);
00439     }
00440 
00441     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00442 }
00443 
00444 
00445 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00446"></a><a class="code" href="../../d4/d1/userk_8h.html#a2090">00446</a> <a class="code" href="../../d4/d1/userk_8h.html#a2090">xxxRemoteStopScreenUpdates</a>(
00447     BOOL fDisableGraphics)
00448 {
00449     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00450     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> SaveStatus = STATUS_SUCCESS;
00451     <span class="comment">//ULONG BytesReturned;</span>
00452     WORD NewButtonState;
00453 
00454     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"xxxRemoteStopScreenUpdates fDisableGraphics %d\n"</span>, fDisableGraphics));
00455 
00456     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00457 
00458     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00459 
00460     <span class="comment">/*</span>
00461 <span class="comment">     * No need to do this multiple times.</span>
00462 <span class="comment">     */</span>
00463     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a341">gbFreezeScreenUpdates</a>)
00464         <span class="keywordflow">return</span> STATUS_SUCCESS;
00465 
00466     <span class="comment">/*</span>
00467 <span class="comment">     * This could be called directly from the command channel.</span>
00468 <span class="comment">     */</span>
00469     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>)
00470         <span class="keywordflow">return</span> STATUS_SUCCESS;
00471 
00472     <span class="comment">/*</span>
00473 <span class="comment">     * If not connected, forget it</span>
00474 <span class="comment">     */</span>
00475     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a333">ghRemoteVideoChannel</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00476         <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
00477 
00478     <span class="comment">/*</span>
00479 <span class="comment">     * Mouse buttons up.</span>
00480 <span class="comment">     * (Ensures no mouse buttons are left in a down state)</span>
00481 <span class="comment">     */</span>
00482     NewButtonState = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> &amp; ~<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a54">gwMKCurrentButton</a>;
00483 
00484     <span class="keywordflow">if</span> ((NewButtonState &amp; <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a>) != (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> &amp; <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a>)) {
00485         <a class="code" href="../../d4/d1/userk_8h.html#a1027">xxxButtonEvent</a>(<a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(),
00486                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00487     }
00488 
00489     <span class="keywordflow">if</span> ((NewButtonState &amp; <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>) != (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> &amp; <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>)) {
00490         <a class="code" href="../../d4/d1/userk_8h.html#a1027">xxxButtonEvent</a>(<a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(),
00491                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00492     }
00493     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> = NewButtonState;
00494 
00495     <span class="comment">/*</span>
00496 <span class="comment">     * Send shift key breaks to win32</span>
00497 <span class="comment">     * (Ensures no shift keys are left on)</span>
00498 <span class="comment">     */</span>
00499 
00500     <span class="comment">// { 0, 0xb8, KEY_BREAK, 0, 0 },           // L alt</span>
00501     <a class="code" href="../../d4/d1/userk_8h.html#a2091">xxxPushKeyEvent</a>(VK_LMENU, 0xb8, KEYEVENTF_KEYUP, 0);
00502 
00503     <span class="comment">// { 0, 0xb8, KEY_BREAK | KEY_E0, 0, 0 },  // R alt</span>
00504     <a class="code" href="../../d4/d1/userk_8h.html#a2091">xxxPushKeyEvent</a>(VK_RMENU, 0xb8, KEYEVENTF_EXTENDEDKEY | KEYEVENTF_KEYUP, 0);
00505 
00506     <span class="comment">// { 0, 0x9d, KEY_BREAK, 0, 0 },           // L ctrl</span>
00507     <a class="code" href="../../d4/d1/userk_8h.html#a2091">xxxPushKeyEvent</a>(VK_LCONTROL, 0x9d, KEYEVENTF_KEYUP, 0);
00508 
00509     <span class="comment">// { 0, 0x9d, KEY_BREAK | KEY_E0, 0, 0 },  // R ctrl</span>
00510     <a class="code" href="../../d4/d1/userk_8h.html#a2091">xxxPushKeyEvent</a>(VK_RCONTROL, 0x9d, KEYEVENTF_EXTENDEDKEY | KEYEVENTF_KEYUP, 0);
00511 
00512     <span class="comment">// { 0, 0xaa, KEY_BREAK, 0, 0 },           // L shift</span>
00513     <a class="code" href="../../d4/d1/userk_8h.html#a2091">xxxPushKeyEvent</a>(VK_LSHIFT, 0xaa, KEYEVENTF_KEYUP, 0);
00514 
00515     <span class="comment">// { 0, 0xb6, KEY_BREAK, 0, 0 }            // R shift</span>
00516     <a class="code" href="../../d4/d1/userk_8h.html#a2091">xxxPushKeyEvent</a>(VK_RSHIFT, 0xb6, KEYEVENTF_KEYUP, 0);
00517 
00518     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2105">RemoteDisableScreen</a>();
00519 
00520     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00521        <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
00522     }
00523 
00524     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a329">gspdeskDisconnect</a>);
00525 
00526     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a341">gbFreezeScreenUpdates</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00527 
00528     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00529     UNREFERENCED_PARAMETER(fDisableGraphics);
00530 }
00531 
00532 <span class="comment">/*</span>
00533 <span class="comment"> * Taken from Internal Key Event.</span>
00534 <span class="comment"> * Minus any permissions checking.</span>
00535 <span class="comment"> */</span>
<a name="l00536"></a><a class="code" href="../../d4/d1/userk_8h.html#a2091">00536</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a2091">xxxPushKeyEvent</a>(
00537     BYTE  bVk,
00538     BYTE  bScan,
00539     DWORD dwFlags,
00540     DWORD dwExtraInfo)
00541 {
00542     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> usFlaggedVK;
00543 
00544     usFlaggedVK = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)bVk;
00545 
00546     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; KEYEVENTF_KEYUP)
00547         usFlaggedVK |= KBDBREAK;
00548 
00549     <span class="comment">// IanJa: not all extended keys are numpad, but this seems to work.</span>
00550     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; KEYEVENTF_EXTENDEDKEY)
00551         usFlaggedVK |= KBDNUMPAD | KBDEXT;
00552 
00553     <a class="code" href="../../d4/d1/userk_8h.html#a1039">xxxKeyEvent</a>(usFlaggedVK, bScan, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), dwExtraInfo, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00554 }
00555 
00556 
00557 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00558"></a><a class="code" href="../../d4/d1/userk_8h.html#a2092">00558</a> <a class="code" href="../../d4/d1/userk_8h.html#a2092">RemoteThinwireStats</a>(
00559     OUT PVOID Stats)
00560 {
00561 <span class="keyword">static</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> sThinwireStatsLength = <span class="keyword">sizeof</span>(CACHE_STATISTICS);
00562 
00563     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"RemoteThinwireStats\n"</span>));
00564 
00565     <span class="comment">/*</span>
00566 <span class="comment">     * Only allow CSRSS to do this</span>
00567 <span class="comment">     */</span>
00568     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00569         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00570     }
00571 
00572     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00573     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a354">gpThinWireCache</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00574         RtlCopyMemory(Stats, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a354">gpThinWireCache</a>, sThinwireStatsLength);
00575         <span class="keywordflow">return</span> STATUS_SUCCESS;
00576     }
00577     <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
00578 }
00579 
00580 
00581 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00582"></a><a class="code" href="../../d4/d1/userk_8h.html#a2093">00582</a> <a class="code" href="../../d4/d1/userk_8h.html#a2093">RemoteNtSecurity</a>(
00583     VOID)
00584 {
00585     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"RemoteNtSecurity\n"</span>));
00586 
00587     <span class="comment">/*</span>
00588 <span class="comment">     * Only allow CSRSS to do this</span>
00589 <span class="comment">     */</span>
00590     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00591         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00592     }
00593 
00594     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00595 
00596     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00597 
00598     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00599         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_HOTKEY, 0, 0);
00600     }
00601     <span class="keywordflow">return</span> STATUS_SUCCESS;
00602 }
00603 
00604 
00605 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00606"></a><a class="code" href="../../d4/d1/userk_8h.html#a2094">00606</a> <a class="code" href="../../d4/d1/userk_8h.html#a2094">xxxRemoteShadowSetup</a>(
00607     VOID)
00608 {
00609     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00610 
00611     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"xxxRemoteShadowSetup\n"</span>));
00612 
00613     <span class="comment">/*</span>
00614 <span class="comment">     * Only allow CSRSS to do this</span>
00615 <span class="comment">     */</span>
00616     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00617         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00618     }
00619 
00620     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00621 
00622     <span class="comment">/*</span>
00623 <span class="comment">     * Blank the screen</span>
00624 <span class="comment">     */</span>
00625     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a>)
00626         <a class="code" href="../../d4/d1/userk_8h.html#a2090">xxxRemoteStopScreenUpdates</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00627 
00628     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a>++;
00629 
00630     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00631 }
00632 
00633 
00634 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00635"></a><a class="code" href="../../d4/d1/userk_8h.html#a2095">00635</a> <a class="code" href="../../d4/d1/userk_8h.html#a2095">RemoteShadowStart</a>(
00636     IN PVOID pThinwireData,
00637     ULONG ThinwireDataLength)
00638 {
00639     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult;
00640     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00641 
00642     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"RemoteShadowStart\n"</span>));
00643 
00644     <span class="comment">/*</span>
00645 <span class="comment">     * Only allow CSRSS to do this</span>
00646 <span class="comment">     */</span>
00647     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00648         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00649     }
00650 
00651     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00652 
00653     <span class="comment">/*</span>
00654 <span class="comment">     * Call thinwire driver and check for thinwire mode compatibility</span>
00655 <span class="comment">     */</span>
00656     fResult = bDrvShadowConnect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, pThinwireData,
00657                                 ThinwireDataLength);
00658 
00659     <span class="comment">// Although originally defined as BOOL, allow more meaningful return codes.</span>
00660     <span class="keywordflow">if</span> (!fResult) {
00661         <span class="keywordflow">return</span> STATUS_CTX_BAD_VIDEO_MODE;
00662     }
00663     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fResult != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00664         <span class="keywordflow">return</span> fResult;
00665     }
00666 
00667     <a class="code" href="../../d4/d1/userk_8h.html#a2104">RemoteRedrawScreen</a>();
00668 
00669     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00670 }
00671 
00672 
00673 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00674"></a><a class="code" href="../../d4/d1/userk_8h.html#a2096">00674</a> <a class="code" href="../../d4/d1/userk_8h.html#a2096">xxxRemoteShadowStop</a>(
00675     VOID)
00676 {
00677     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00678 
00679     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"xxxRemoteShadowStop\n"</span>));
00680 
00681     <span class="comment">/*</span>
00682 <span class="comment">     * Only allow CSRSS to do this</span>
00683 <span class="comment">     */</span>
00684     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00685         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00686     }
00687 
00688     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00689 
00690     <span class="comment">/*</span>
00691 <span class="comment">     * Blank the screen</span>
00692 <span class="comment">     */</span>
00693     <a class="code" href="../../d4/d1/userk_8h.html#a2090">xxxRemoteStopScreenUpdates</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00694 
00695     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00696 }
00697 
00698 
00699 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00700"></a><a class="code" href="../../d4/d1/userk_8h.html#a2097">00700</a> <a class="code" href="../../d4/d1/userk_8h.html#a2097">RemoteShadowCleanup</a>(
00701     IN PVOID pThinwireData,
00702     ULONG ThinwireDataLength)
00703 {
00704     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00705 
00706     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"RemoteShadowCleanup\n"</span>));
00707 
00708     <span class="comment">/*</span>
00709 <span class="comment">     * Only allow CSRSS to do this</span>
00710 <span class="comment">     */</span>
00711     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00712         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00713     }
00714 
00715     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00716 
00717     <span class="comment">/*</span>
00718 <span class="comment">     * Tell the Thinwire driver about it</span>
00719 <span class="comment">     */</span>
00720     bDrvShadowDisconnect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, pThinwireData,
00721                          ThinwireDataLength);
00722 
00723     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a> &gt; 0)
00724         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a>--;
00725 
00726     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a>) {
00727         <a class="code" href="../../d4/d1/userk_8h.html#a2104">RemoteRedrawScreen</a>();
00728     }
00729     
00730     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00731 }
00732 
00733 
00734 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00735"></a><a class="code" href="../../d4/d1/userk_8h.html#a2098">00735</a> <a class="code" href="../../d4/d1/userk_8h.html#a2098">xxxRemotePassthruEnable</a>(
00736     VOID)
00737 {
00738     IO_STATUS_BLOCK IoStatus;
00739 <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> KeyboardType101;
00740 
00741     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"xxxRemotePassthruEnable\n"</span>));
00742 
00743     <span class="comment">/*</span>
00744 <span class="comment">     * Only allow CSRSS to do this</span>
00745 <span class="comment">     */</span>
00746     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00747         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00748     }
00749 
00750     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a>);
00751     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a> == 0);
00752     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00753 
00754     KeyboardType101 = !(<a class="code" href="../../d7/d8/kbd_8c.html#a13">gapulCvt_VK</a> == <a class="code" href="../../d7/d8/kbd_8c.html#a11">gapulCvt_VK_84</a>);
00755 
00756     ZwDeviceIoControlFile(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a337">ghRemoteKeyboardChannel</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00757                           &amp;IoStatus, IOCTL_KEYBOARD_ICA_TYPE,
00758                           &amp;KeyboardType101, <span class="keyword">sizeof</span>(KeyboardType101),
00759                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00760 
00761     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a356">guKbdTblSize</a> != 0) {
00762         ZwDeviceIoControlFile(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a337">ghRemoteKeyboardChannel</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00763                               &amp;IoStatus, IOCTL_KEYBOARD_ICA_LAYOUT,
00764                               <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a355">ghKbdTblBase</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a356">guKbdTblSize</a>,
00765                               <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a70">gpKbdTbl</a>, 0);
00766     }
00767 
00768     <a class="code" href="../../d4/d1/userk_8h.html#a2090">xxxRemoteStopScreenUpdates</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00769 
00770     <span class="comment">/*</span>
00771 <span class="comment">     * Tell thinwire driver about this</span>
00772 <span class="comment">     */</span>
00773     bDrvDisconnect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a338">ghRemoteThinwireChannel</a>,
00774                    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>);
00775 
00776     <span class="keywordflow">return</span> STATUS_SUCCESS;
00777 }
00778 
00779 
00780 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00781"></a><a class="code" href="../../d4/d1/userk_8h.html#a2099">00781</a> <a class="code" href="../../d4/d1/userk_8h.html#a2099">RemotePassthruDisable</a>(
00782     VOID)
00783 {
00784     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult;
00785 
00786     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"RemotePassthruDisable\n"</span>));
00787 
00788     <span class="comment">/*</span>
00789 <span class="comment">     * Only allow CSRSS to do this</span>
00790 <span class="comment">     */</span>
00791     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() || !<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00792         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00793     }
00794 
00795     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a349">gnShadowers</a> == 0);
00796     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
00797 
00798     fResult = bDrvReconnect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a338">ghRemoteThinwireChannel</a>,
00799                             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>);
00800     <span class="keywordflow">if</span> (!fResult) {
00801         <span class="keywordflow">return</span> STATUS_CTX_BAD_VIDEO_MODE;
00802     }
00803 
00804     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a>) {
00805         <a class="code" href="../../d4/d1/userk_8h.html#a2104">RemoteRedrawScreen</a>();
00806         <a class="code" href="../../d4/d1/userk_8h.html#a1180">UpdateKeyLights</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// Make sure LED's are correct</span>
00807     }
00808 
00809     <span class="keywordflow">return</span> STATUS_SUCCESS;
00810 }
00811 
00812 
00813 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00814"></a><a class="code" href="../../d4/d1/userk_8h.html#a2100">00814</a> <a class="code" href="../../d4/d1/userk_8h.html#a2100">CtxDisplayIOCtl</a>(
00815     ULONG  DisplayIOCtlFlags,
00816     PUCHAR pDisplayIOCtlData,
00817     ULONG  cbDisplayIOCtlData)
00818 {
00819     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult;
00820 
00821     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"CtxDisplayIOCtl\n"</span>));
00822 
00823     fResult = bDrvDisplayIOCtl(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, pDisplayIOCtlData, cbDisplayIOCtlData);
00824 
00825     <span class="keywordflow">if</span> (!fResult) {
00826         <span class="keywordflow">return</span> STATUS_CTX_BAD_VIDEO_MODE;
00827     }
00828 
00829     <span class="keywordflow">if</span> ((DisplayIOCtlFlags &amp; DISPLAY_IOCTL_FLAG_REDRAW)) {
00830         <a class="code" href="../../d4/d1/userk_8h.html#a2103">RemoteRedrawRectangle</a>(0,0,0xffff,0xffff);
00831     }
00832 
00833     <span class="keywordflow">return</span> STATUS_SUCCESS;
00834 }
00835 
00836 
00837 <span class="comment">/*</span>
00838 <span class="comment"> * This is for things like user32.dll init routines that don't want to use</span>
00839 <span class="comment"> * winsta.dll for queries.</span>
00840 <span class="comment"> *</span>
00841 <span class="comment"> */</span>
00842 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00843"></a><a class="code" href="../../d4/d1/userk_8h.html#a2101">00843</a> <a class="code" href="../../d4/d1/userk_8h.html#a2101">RemoteConnectState</a>(
00844     VOID)
00845 {
00846     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> state = 0;
00847 
00848     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00849 
00850         state = CTX_W32_CONNECT_STATE_CONSOLE;
00851 
00852     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a323">gbVideoInitialized</a>) {
00853 
00854         state = CTX_W32_CONNECT_STATE_IDLE;
00855 
00856     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a>) {
00857 
00858         state = CTX_W32_CONNECT_STATE_EXIT_IN_PROGRESS;
00859 
00860     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a350">gbConnected</a>) {
00861 
00862         state = CTX_W32_CONNECT_STATE_CONNECTED;
00863 
00864     } <span class="keywordflow">else</span> {
00865         state = CTX_W32_CONNECT_STATE_DISCONNECTED;
00866     }
00867 
00868     <span class="keywordflow">return</span> state;
00869 }
00870 
00871 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00872"></a><a class="code" href="../../d4/d1/userk_8h.html#a2102">00872</a> <a class="code" href="../../d4/d1/userk_8h.html#a2102">_GetWinStationInfo</a>(
00873     WSINFO* pWsInfo)
00874 {
00875     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00876 
00877     <span class="keywordflow">try</span> {
00878 
00879         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pWsInfo, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a326">gWinStationInfo</a>), <a class="code" href="../../d4/d1/userk_8h.html#a22">DATAALIGN</a>);
00880         RtlCopyMemory(pWsInfo, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a326">gWinStationInfo</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a326">gWinStationInfo</a>));
00881 
00882     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00883         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00884     }
00885 
00886     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00887 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
