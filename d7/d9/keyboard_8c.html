<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: keyboard.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>keyboard.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d8/d8/keyboard_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a13">SHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a> (int vk)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a13">SHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/keyboard_8c.html#a2">_GetAsyncKeyState</a> (int vk)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/keyboard_8c.html#a3">_SetKeyboardState</a> (CONST <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *pb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/keyboard_8c.html#a4">RegisterPerUserKeyboardIndicators</a> (PUNICODE_STRING pProfileUserName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/keyboard_8c.html#a5">UpdatePerUserKeyboardIndicators</a> (PUNICODE_STRING pProfileUserName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/keyboard_8c.html#a6">UpdateAsyncKeyState</a> (<a class="el" href="../../d7/d4/structtagQ.html">PQ</a> pqOwner, UINT wVK, BOOL fBreak)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CONST WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/keyboard_8c.html#a0">wszInitialKeyboardIndicators</a> [] = L"InitialKeyboardIndicators"</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="keyboard.c::_GetAsyncKeyState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a13">SHORT</a> _GetAsyncKeyState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>vk</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00087">87</a> of file <a class="el" href="../../d8/d8/keyboard_8c-source.html">keyboard.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02984">ClearAsyncKeyStateRecentDown</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02930">CVKKEYSTATE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02968">TestAsyncKeyStateDown</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02980">TestAsyncKeyStateRecentDown</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04907">NtUserGetAsyncKeyState()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l01934">xxxMNOpenHierarchy()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01675">xxxNextWindow()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00808">xxxPaintIconsInSwitchWindow()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01012">xxxPaintSwitchWindow()</a>, and <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01476">xxxShowSwitchWindow()</a>.
<p>
<pre class="fragment"><div>00089 {
00090     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> sKeyState;
00091 
00092     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)vk &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a824">CVKKEYSTATE</a>) {
00093         RIPERR1(ERROR_INVALID_PARAMETER,
00094                 RIP_WARNING,
00095                 <span class="stringliteral">"Invalid parameter \"vk\" (%ld) to _GetAsyncKeyState"</span>,
00096                 vk);
00097 
00098         <span class="keywordflow">return</span> 0;
00099     }
00100 
00101     <span class="comment">/*</span>
00102 <span class="comment">     * See if this key went down since the last time state for it was</span>
00103 <span class="comment">     * read. Clear the flag if so.</span>
00104 <span class="comment">     */</span>
00105     sKeyState = 0;
00106     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a849">TestAsyncKeyStateRecentDown</a>(vk)) {
00107         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a851">ClearAsyncKeyStateRecentDown</a>(vk);
00108         sKeyState = 1;
00109     }
00110 
00111     <span class="comment">/*</span>
00112 <span class="comment">     * Set the keyup/down bit.</span>
00113 <span class="comment">     */</span>
00114     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(vk))
00115         sKeyState |= 0x8000;
00116 
00117     <span class="comment">/*</span>
00118 <span class="comment">     * Don't return the toggle bit since it's a new bit and might</span>
00119 <span class="comment">     * cause compatibility problems.</span>
00120 <span class="comment">     */</span>
00121     <span class="keywordflow">return</span> sKeyState;
00122 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="keyboard.c::_GetKeyState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a13">SHORT</a> _GetKeyState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>vk</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00027">27</a> of file <a class="el" href="../../d8/d8/keyboard_8c-source.html">keyboard.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02930">CVKKEYSTATE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00059">PtiCurrentShared</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02955">TestKeyStateDown</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02961">TestKeyStateToggle</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01120">InitSwitchWndInfo()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l00206">MNCheckButtonDownState()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09596">NtUserGetKeyState()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>, <a class="el" href="../../d7/d0/dragdrop_8c-source.html#l00354">xxxIsDragging()</a>, <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00635">xxxMNLoop()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00677">xxxMNStartMenu()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00437">xxxMS_TrackMove()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l02121">xxxOldNextWindow()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00808">xxxPaintIconsInSwitchWindow()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01012">xxxPaintSwitchWindow()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l02582">xxxSBWndProc()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01476">xxxShowSwitchWindow()</a>, <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00193">xxxSysCommand()</a>, <a class="el" href="../../d3/d2/mnpopup_8c-source.html#l00052">xxxTrackPopupMenuEx()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l02061">xxxTrackThumb()</a>, and <a class="el" href="../../d2/d1/mnaccel_8c-source.html#l00251">xxxTranslateAccelerator()</a>.
<p>
<pre class="fragment"><div>00029 {
00030     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wKeyState;
00031     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00032 
00033     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)vk &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a824">CVKKEYSTATE</a>) {
00034         RIPERR1(ERROR_INVALID_PARAMETER,
00035                 RIP_WARNING,
00036                 <span class="stringliteral">"Invalid parameter \"vk\" (%ld) to _GetKeyState"</span>,
00037                 vk);
00038 
00039         <span class="keywordflow">return</span> 0;
00040     }
00041 
00042     pti = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00043 
00044 <span class="preprocessor">#ifdef LATER</span>
00045 <span class="preprocessor"></span><span class="comment">//</span>
00046 <span class="comment">// note - anything that accesses the pq structure is a bad idea since it</span>
00047 <span class="comment">// can be changed between any two instructions.</span>
00048 <span class="comment">//</span>
00049 <span class="preprocessor">#endif</span>
00050 <span class="preprocessor"></span>
00051     wKeyState = 0;
00052 
00053     <span class="comment">/*</span>
00054 <span class="comment">     * Set the toggle bit.</span>
00055 <span class="comment">     */</span>
00056     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a840">TestKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, vk))
00057         wKeyState = 0x0001;
00058 
00059     <span class="comment">/*</span>
00060 <span class="comment">     * Set the keyup/down bit.</span>
00061 <span class="comment">     */</span>
00062     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, vk)) {
00063         <span class="comment">/*</span>
00064 <span class="comment">         * Used to be wKeyState|= 0x8000.Fix for bug 28820; Ctrl-Enter</span>
00065 <span class="comment">         * accelerator doesn't work on Nestscape Navigator Mail 2.0</span>
00066 <span class="comment">         */</span>
00067         wKeyState |= 0xff80;  <span class="comment">// This is what 3.1 returned!!!!</span>
00068     }
00069 
00070     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)wKeyState;
00071 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="keyboard.c::_SetKeyboardState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _SetKeyboardState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">CONST <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00136">136</a> of file <a class="el" href="../../d8/d8/keyboard_8c-source.html">keyboard.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02978">ClearAsyncKeyStateToggle</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02959">ClearKeyStateDown</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02965">ClearKeyStateToggle</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02976">SetAsyncKeyStateToggle</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02957">SetKeyStateDown</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02963">SetKeyStateToggle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02985">UpdateKeyLights()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l02160">NtUserSetKeyboardState()</a>.
<p>
<pre class="fragment"><div>00138 {
00139     <span class="keywordtype">int</span> i;
00140     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
00141     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00142 
00143     pq = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00144 
00145     <span class="comment">/*</span>
00146 <span class="comment">     * Copy in the new state table.</span>
00147 <span class="comment">     */</span>
00148     <span class="keywordflow">for</span> (i = 0; i &lt; 256; i++, pb++) {
00149         <span class="keywordflow">if</span> (*pb &amp; 0x80) {
00150             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a838">SetKeyStateDown</a>(pq, i);
00151         } <span class="keywordflow">else</span> {
00152             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pq, i);
00153         }
00154 
00155         <span class="keywordflow">if</span> (*pb &amp; 0x01) {
00156             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>(pq, i);
00157         } <span class="keywordflow">else</span> {
00158             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pq, i);
00159         }
00160     }
00161 
00162     <span class="comment">/*</span>
00163 <span class="comment">     * Update the key cache index.</span>
00164 <span class="comment">     */</span>
00165     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwKeyCache++;
00166 
00167 <span class="preprocessor">#ifdef LATER</span>
00168 <span class="preprocessor"></span><span class="comment">// scottlu 6-9-91</span>
00169 <span class="comment">// I don't think we ought to do this unless someone really complains. This</span>
00170 <span class="comment">// could have bad side affects, especially considering that terminal</span>
00171 <span class="comment">// apps will want to do this, and terminal apps could easily not respond</span>
00172 <span class="comment">// to input for awhile, causing this state to change unexpectedly while</span>
00173 <span class="comment">// a user is using some other application. - scottlu.</span>
00174 
00175 <span class="comment">/* DavidPe 02/05/92</span>
00176 <span class="comment"> *  How about if we only do it when the calling app is foreground?</span>
00177 <span class="comment"> */</span>
00178 
00179     <span class="comment">/*</span>
00180 <span class="comment">     * Propagate the toggle bits for the keylight keys to the</span>
00181 <span class="comment">     * async keystate table and update the keylights.</span>
00182 <span class="comment">     *</span>
00183 <span class="comment">     * THIS could be evil in a de-synced environment, but to do this</span>
00184 <span class="comment">     * in a totally "synchronous" way is hard.</span>
00185 <span class="comment">     */</span>
00186     <span class="keywordflow">if</span> (pb[VK_CAPITAL] &amp; 0x01) {
00187         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a847">SetAsyncKeyStateToggle</a>(VK_CAPITAL);
00188     } <span class="keywordflow">else</span> {
00189         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a848">ClearAsyncKeyStateToggle</a>(VK_CAPITAL);
00190     }
00191 
00192     <span class="keywordflow">if</span> (pb[VK_NUMLOCK] &amp; 0x01) {
00193         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a847">SetAsyncKeyStateToggle</a>(VK_NUMLOCK);
00194     } <span class="keywordflow">else</span> {
00195         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a848">ClearAsyncKeyStateToggle</a>(VK_NUMLOCK);
00196     }
00197 
00198     <span class="keywordflow">if</span> (pb[VK_SCROLL] &amp; 0x01) {
00199         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a847">SetAsyncKeyStateToggle</a>(VK_SCROLL);
00200     } <span class="keywordflow">else</span> {
00201         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a848">ClearAsyncKeyStateToggle</a>(VK_SCROLL);
00202     }
00203 
00204     <a class="code" href="../../d4/d1/userk_8h.html#a1180">UpdateKeyLights</a>(TRUE);
00205 <span class="preprocessor">#endif</span>
00206 <span class="preprocessor"></span>
00207     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00208 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="keyboard.c::RegisterPerUserKeyboardIndicators" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RegisterPerUserKeyboardIndicators           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pProfileUserName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00223">223</a> of file <a class="el" href="../../d8/d8/keyboard_8c-source.html">keyboard.c</a>.
<p>
References <a class="el" href="../../d2/d6/w32_2ntuser_2kernel_2profile_8c-source.html#l00988">FastWriteProfileStringW()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03600">ISTS</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06853">PMAP_KEYBOARD</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02974">TestAsyncKeyStateToggle</a>, and <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00220">wszInitialKeyboardIndicators</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00033">PrepareForLogoff()</a>.
<p>
<pre class="fragment"><div>00224 {
00225     WCHAR wszInitKbdInd[2] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"0"</span>;
00226 
00227     <span class="comment">/*</span>
00228 <span class="comment">     * Initial Keyboard state (Num-Lock only)</span>
00229 <span class="comment">     */</span>
00230 
00231     <span class="comment">/*</span>
00232 <span class="comment">     * For HYDRA we do not want to save this as set, since it confuses</span>
00233 <span class="comment">     * dial in laptop computers. So we force it off in the profile on</span>
00234 <span class="comment">     * logoff.</span>
00235 <span class="comment">     */</span>
00236     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00237         wszInitKbdInd[0] += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(VK_NUMLOCK) ? 2 : 0;
00238     }
00239 
00240     <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
00241                             PMAP_KEYBOARD,
00242                             wszInitialKeyboardIndicators,
00243                             wszInitKbdInd);
00244 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="keyboard.c::UpdateAsyncKeyState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void UpdateAsyncKeyState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d4/structtagQ.html">PQ</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pqOwner</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>wVK</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fBreak</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00322">322</a> of file <a class="el" href="../../d8/d8/keyboard_8c-source.html">keyboard.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03121">tagQ::afKeyRecentDown</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02972">ClearAsyncKeyStateDown</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02978">ClearAsyncKeyStateToggle</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00495">CVKASYNCKEYCACHE</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00456">grpdeskRitInput</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l01874">PostUpdateKeyStateEvent()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02668">tagDESKTOP::PtiList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03129">tagQ::QF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02997">QF_UPDATEKEYSTATE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02970">SetAsyncKeyStateDown</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02982">SetAsyncKeyStateRecentDown</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02976">SetAsyncKeyStateToggle</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02950">SetKeyRecentDownBit</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02968">TestAsyncKeyStateDown</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02974">TestAsyncKeyStateToggle</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00472">xxxButtonEvent()</a>, and <a class="el" href="../../d7/d7/ntinput_8c-source.html#l01338">xxxKeyEvent()</a>.
<p>
<pre class="fragment"><div>00326 {
00327     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqT;
00328     PLIST_ENTRY pHead, pEntry;
00329     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00330 
00331     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00332 
00333     <span class="comment">/*</span>
00334 <span class="comment">     * First check to see if the queue this key is going to has a pending</span>
00335 <span class="comment">     * key state event. If it does, post it because we need to copy the</span>
00336 <span class="comment">     * async key state into this event as it is before we modify</span>
00337 <span class="comment">     * this key's state, or else we'll generate a key state event with</span>
00338 <span class="comment">     * the wrong key state in it.</span>
00339 <span class="comment">     */</span>
00340     <span class="keywordflow">if</span> (pqOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pqOwner-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a856">QF_UPDATEKEYSTATE</a>) {
00341         <a class="code" href="../../d4/d1/userk_8h.html#a1235">PostUpdateKeyStateEvent</a>(pqOwner);
00342     }
00343 
00344     <span class="keywordflow">if</span> (!fBreak) {
00345         <span class="comment">/*</span>
00346 <span class="comment">         * This key has gone down - update the "recent down" bit in the</span>
00347 <span class="comment">         * async key state table.</span>
00348 <span class="comment">         */</span>
00349         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a850">SetAsyncKeyStateRecentDown</a>(wVK);
00350 
00351         <span class="comment">/*</span>
00352 <span class="comment">         * This is a key make. If the key was not already down, update the</span>
00353 <span class="comment">         * toggle bit.</span>
00354 <span class="comment">         */</span>
00355         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(wVK)) {
00356             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(wVK)) {
00357                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a848">ClearAsyncKeyStateToggle</a>(wVK);
00358             } <span class="keywordflow">else</span> {
00359                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a847">SetAsyncKeyStateToggle</a>(wVK);
00360             }
00361         }
00362 
00363         <span class="comment">/*</span>
00364 <span class="comment">         * This is a make, so turn on the key down bit.</span>
00365 <span class="comment">         */</span>
00366         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a844">SetAsyncKeyStateDown</a>(wVK);
00367 
00368     } <span class="keywordflow">else</span> {
00369         <span class="comment">/*</span>
00370 <span class="comment">         * This is a break, so turn off the key down bit.</span>
00371 <span class="comment">         */</span>
00372         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a845">ClearAsyncKeyStateDown</a>(wVK);
00373     }
00374 
00375     <span class="comment">/*</span>
00376 <span class="comment">     * If this is one of the keys we cache, update the async key cache index.</span>
00377 <span class="comment">     */</span>
00378     <span class="keywordflow">if</span> (wVK &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a110">CVKASYNCKEYCACHE</a>) {
00379         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwAsyncKeyCache++;
00380     }
00381 
00382     <span class="comment">/*</span>
00383 <span class="comment">     * A key has changed state. Update all queues not receiving this input so</span>
00384 <span class="comment">     * they know that this key has changed state. This lets us know which keys to</span>
00385 <span class="comment">     * update in the thread specific key state table to keep it in sync</span>
00386 <span class="comment">     * with the user.  Walking down the thread list may mean that an</span>
00387 <span class="comment">     * individual queue may by updated more than once, but it is cheaper</span>
00388 <span class="comment">     * than maintaining a list of queues on the desktop.</span>
00389 <span class="comment">     */</span>
00390     UserAssert(grpdeskRitInput != NULL);
00391 
00392     pHead = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
00393     <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
00394         pti = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
00395 
00396         <span class="comment">/*</span>
00397 <span class="comment">         * Don't update the queue this message is going to - it'll be</span>
00398 <span class="comment">         * in sync because it is receiving this message.</span>
00399 <span class="comment">         */</span>
00400         pqT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00401         <span class="keywordflow">if</span> (pqT == pqOwner)
00402             <span class="keywordflow">continue</span>;
00403 
00404         <span class="comment">/*</span>
00405 <span class="comment">         * Set the "recent down" bit. In this case this doesn't really mean</span>
00406 <span class="comment">         * "recent down", it means "recent change" (since the last time</span>
00407 <span class="comment">         * we synced this queue), either up or down. This tells us which</span>
00408 <span class="comment">         * keys went down since the last time this thread synced with key</span>
00409 <span class="comment">         * state. Set the "update key state" flag so we know that later</span>
00410 <span class="comment">         * we need to sync with these keys.</span>
00411 <span class="comment">         */</span>
00412         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a835">SetKeyRecentDownBit</a>(pqT-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o16">afKeyRecentDown</a>, wVK);
00413         pqT-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a856">QF_UPDATEKEYSTATE</a>;
00414     }
00415 
00416     <span class="comment">/*</span>
00417 <span class="comment">     * Update the key cache index.</span>
00418 <span class="comment">     */</span>
00419     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwKeyCache++;
00420 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="keyboard.c::UpdatePerUserKeyboardIndicators" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UpdatePerUserKeyboardIndicators           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pProfileUserName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00256">256</a> of file <a class="el" href="../../d8/d8/keyboard_8c-source.html">keyboard.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02978">ClearAsyncKeyStateToggle</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02965">ClearKeyStateToggle</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05739">ClearRawKeyToggle</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/w32_2ntuser_2kernel_2profile_8c-source.html#l00945">FastGetProfileIntW()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00932">gbRemoteSession</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00594">gfKanaToggle</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00556">gklpBootTime</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06853">PMAP_KEYBOARD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02976">SetAsyncKeyStateToggle</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02963">SetKeyStateToggle</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05738">SetRawKeyToggle</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l02985">UpdateKeyLights()</a>, and <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00220">wszInitialKeyboardIndicators</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l02445">xxxUpdatePerUserSystemParameters()</a>.
<p>
<pre class="fragment"><div>00257 {
00258     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dw;
00259     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
00260     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00261     pq = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00262 
00263     <span class="comment">/*</span>
00264 <span class="comment">     * For terminal server, the client is responsible for synchronizing the</span>
00265 <span class="comment">     * keyboard state.</span>
00266 <span class="comment">     */</span>
00267     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00268         <span class="keywordflow">return</span>;
00269     }
00270 
00271     <span class="comment">/*</span>
00272 <span class="comment">     * Initial Keyboard state (Num-Lock only)</span>
00273 <span class="comment">     */</span>
00274     dw = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
00275                             PMAP_KEYBOARD,
00276                             wszInitialKeyboardIndicators,
00277                             2);
00278 
00279     dw &amp;= 0x80000002;
00280 
00281 
00282     <span class="comment">/*</span>
00283 <span class="comment">     * The special value 0x80000000 in the registry indicates that the BIOS</span>
00284 <span class="comment">     * settings are to be used as the initial LED state. (This is undocumented)</span>
00285 <span class="comment">     */</span>
00286     <span class="keywordflow">if</span> (dw == 0x80000000) {
00287         dw = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a217">gklpBootTime</a>.LedFlags;
00288     }
00289     <span class="keywordflow">if</span> (dw &amp; 0x02) {
00290         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>(pq, VK_NUMLOCK);
00291         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a847">SetAsyncKeyStateToggle</a>(VK_NUMLOCK);
00292         <a class="code" href="../../d4/d1/userk_8h.html#a583">SetRawKeyToggle</a>(VK_NUMLOCK);
00293     } <span class="keywordflow">else</span> {
00294         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pq, VK_NUMLOCK);
00295         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a848">ClearAsyncKeyStateToggle</a>(VK_NUMLOCK);
00296         <a class="code" href="../../d4/d1/userk_8h.html#a584">ClearRawKeyToggle</a>(VK_NUMLOCK);
00297     }
00298 
00299     <span class="comment">/*</span>
00300 <span class="comment">     * Initialize KANA Toggle status</span>
00301 <span class="comment">     */</span>
00302     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a225">gfKanaToggle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00303     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pq, VK_KANA);
00304     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a848">ClearAsyncKeyStateToggle</a>(VK_KANA);
00305     <a class="code" href="../../d4/d1/userk_8h.html#a584">ClearRawKeyToggle</a>(VK_KANA);
00306 
00307     <a class="code" href="../../d4/d1/userk_8h.html#a1180">UpdateKeyLights</a>(FALSE);
00308 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="keyboard.c::wszInitialKeyboardIndicators" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST WCHAR <a class="el" href="../../d7/d9/keyboard_8c.html#a0">wszInitialKeyboardIndicators</a>[] = L"InitialKeyboardIndicators"<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00220">220</a> of file <a class="el" href="../../d8/d8/keyboard_8c-source.html">keyboard.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00223">RegisterPerUserKeyboardIndicators()</a>, and <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00256">UpdatePerUserKeyboardIndicators()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
