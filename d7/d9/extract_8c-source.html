<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: extract.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>extract.c</h1><a href="../../d6/d0/extract_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">*</span>
00003 <span class="comment">* Module Name: extract.c</span>
00004 <span class="comment">*</span>
00005 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* Icon Extraction Routines</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* History:</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "newexe.h"</span>
00015 
00016 <span class="comment">/****************************************************************************</span>
00017 <span class="comment"> ****************************************************************************/</span>
00018 
<a name="l00019"></a><a class="code" href="../../d6/d0/extract_8c.html#a0">00019</a> <span class="preprocessor">#define ARRAYSIZE(a)    (sizeof(a)/sizeof(a[0]))</span>
00020 <span class="preprocessor"></span>
<a name="l00021"></a><a class="code" href="../../d6/d0/extract_8c.html#a1">00021</a> <span class="preprocessor">#define ICON_MAGIC      0</span>
<a name="l00022"></a><a class="code" href="../../d6/d0/extract_8c.html#a2">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define ICO_MAGIC1      1</span>
<a name="l00023"></a><a class="code" href="../../d6/d0/extract_8c.html#a3">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define CUR_MAGIC1      2</span>
<a name="l00024"></a><a class="code" href="../../d6/d0/extract_8c.html#a4">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define BMP_MAGIC       ((WORD)'B'+((WORD)'M'&lt;&lt;8))</span>
<a name="l00025"></a><a class="code" href="../../d6/d0/extract_8c.html#a5">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define ANI_MAGIC       ((WORD)'R'+((WORD)'I'&lt;&lt;8))</span>
<a name="l00026"></a><a class="code" href="../../d6/d0/extract_8c.html#a6">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define ANI_MAGIC1      ((WORD)'F'+((WORD)'F'&lt;&lt;8))</span>
<a name="l00027"></a><a class="code" href="../../d6/d0/extract_8c.html#a7">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define ANI_MAGIC4      ((WORD)'A'+((WORD)'C'&lt;&lt;8))</span>
<a name="l00028"></a><a class="code" href="../../d6/d0/extract_8c.html#a8">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define ANI_MAGIC5      ((WORD)'O'+((WORD)'N'&lt;&lt;8))</span>
<a name="l00029"></a><a class="code" href="../../d6/d0/extract_8c.html#a9">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define MZMAGIC         ((WORD)'M'+((WORD)'Z'&lt;&lt;8))</span>
<a name="l00030"></a><a class="code" href="../../d6/d0/extract_8c.html#a10">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define PEMAGIC         ((WORD)'P'+((WORD)'E'&lt;&lt;8))</span>
<a name="l00031"></a><a class="code" href="../../d6/d0/extract_8c.html#a11">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define LEMAGIC         ((WORD)'L'+((WORD)'E'&lt;&lt;8))</span>
00032 <span class="preprocessor"></span>
<a name="l00033"></a><a class="code" href="../../d6/d0/extract_8c.html#a26">00033</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>new_exe          NEWEXE,      *<a class="code" href="../../d6/d0/extract_8c.html#a26">LPNEWEXE</a>;
<a name="l00034"></a><a class="code" href="../../d6/d0/extract_8c.html#a27">00034</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>exe_hdr          EXEHDR,      *<a class="code" href="../../d6/d0/extract_8c.html#a27">LPEXEHDR</a>;
<a name="l00035"></a><a class="code" href="../../d6/d0/extract_8c.html#a28">00035</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>rsrc_nameinfo    RESNAMEINFO, *<a class="code" href="../../d6/d0/extract_8c.html#a28">LPRESNAMEINFO</a>;
<a name="l00036"></a><a class="code" href="../../d6/d0/extract_8c.html#a29">00036</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>rsrc_typeinfo    RESTYPEINFO, *<a class="code" href="../../d6/d0/extract_8c.html#a29">LPRESTYPEINFO</a>;
<a name="l00037"></a><a class="code" href="../../d6/d0/extract_8c.html#a30">00037</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>rsrc_typeinfo    UNALIGNED    *<a class="code" href="../../d6/d0/extract_8c.html#a30">ULPRESTYPEINFO</a>;
<a name="l00038"></a><a class="code" href="../../d6/d0/extract_8c.html#a31">00038</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>new_rsrc         RESTABLE,    *<a class="code" href="../../d6/d0/extract_8c.html#a31">LPRESTABLE</a>;
00039 
<a name="l00040"></a><a class="code" href="../../d6/d0/extract_8c.html#a12">00040</a> <span class="preprocessor">#define RESOURCE_VA(x)        ((x)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_RESOURCE].VirtualAddress)</span>
<a name="l00041"></a><a class="code" href="../../d6/d0/extract_8c.html#a13">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define RESOURCE_SIZE(x)      ((x)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_RESOURCE].Size)</span>
<a name="l00042"></a><a class="code" href="../../d6/d0/extract_8c.html#a14">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define NUMBER_OF_SECTIONS(x) ((x)-&gt;FileHeader.NumberOfSections)</span>
00043 <span class="preprocessor"></span>
<a name="l00044"></a><a class="code" href="../../d6/d0/extract_8c.html#a15">00044</a> <span class="preprocessor">#define FCC(c0,c1,c2,c3) ((DWORD)(c0)|((DWORD)(c1)&lt;&lt;8)|((DWORD)(c2)&lt;&lt;16)|((DWORD)(c3)&lt;&lt;24))</span>
00045 <span class="preprocessor"></span>
<a name="l00046"></a><a class="code" href="../../d6/d0/extract_8c.html#a16">00046</a> <span class="preprocessor">#define COM_FILE    FCC('.', 'c', 'o', 'm')</span>
<a name="l00047"></a><a class="code" href="../../d6/d0/extract_8c.html#a17">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define BAT_FILE    FCC('.', 'b', 'a', 't')</span>
<a name="l00048"></a><a class="code" href="../../d6/d0/extract_8c.html#a18">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_FILE    FCC('.', 'c', 'm', 'd')</span>
<a name="l00049"></a><a class="code" href="../../d6/d0/extract_8c.html#a19">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define PIF_FILE    FCC('.', 'p', 'i', 'f')</span>
<a name="l00050"></a><a class="code" href="../../d6/d0/extract_8c.html#a20">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define LNK_FILE    FCC('.', 'l', 'n', 'k')</span>
<a name="l00051"></a><a class="code" href="../../d6/d0/extract_8c.html#a21">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define ICO_FILE    FCC('.', 'i', 'c', 'o')</span>
<a name="l00052"></a><a class="code" href="../../d6/d0/extract_8c.html#a22">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define EXE_FILE    FCC('.', 'e', 'x', 'e')</span>
00053 <span class="preprocessor"></span>
00054 
<a name="l00055"></a><a class="code" href="../../d6/d0/extract_8c.html#a23">00055</a> <span class="preprocessor">#define WIN32VER30  0x00030000  // for CreateIconFromResource()</span>
00056 <span class="preprocessor"></span>
<a name="l00057"></a><a class="code" href="../../d6/d0/extract_8c.html#a24">00057</a> <span class="preprocessor">#define GET_COUNT   424242</span>
00058 <span class="preprocessor"></span>
00059 
00060 <span class="comment">/***************************************************************************\</span>
00061 <span class="comment">* PathIsUNC</span>
00062 <span class="comment">*</span>
00063 <span class="comment">* Inline function to check for a double-backslash at the</span>
00064 <span class="comment">* beginning of a string</span>
00065 <span class="comment">*</span>
00066 <span class="comment">\***************************************************************************/</span>
00067 
<a name="l00068"></a><a class="code" href="../../d6/d0/extract_8c.html#a32">00068</a> __inline <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/extract_8c.html#a32">PathIsUNC</a>(
00069     LPWSTR psz)
00070 {
00071     <span class="keywordflow">return</span> (psz[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> &amp;&amp; psz[1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>);
00072 }
00073 
00074 <span class="comment">/***************************************************************************\</span>
00075 <span class="comment">* ReadAByte</span>
00076 <span class="comment">*</span>
00077 <span class="comment">* This is used to touch memory to assure that if we page-fault, it is</span>
00078 <span class="comment">* outside win16lock.  Most icons aren't more than two pages.</span>
00079 <span class="comment">*</span>
00080 <span class="comment">\***************************************************************************/</span>
00081 
<a name="l00082"></a><a class="code" href="../../d6/d0/extract_8c.html#a33">00082</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/extract_8c.html#a33">ReadAByte</a>(
00083     LPCVOID pMem)
00084 {
00085     <span class="keywordflow">return</span> ((*(<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pMem) == 0);
00086 }
00087 
00088 <span class="comment">/***************************************************************************\</span>
00089 <span class="comment">* RVAtoP</span>
00090 <span class="comment">*</span>
00091 <span class="comment">*</span>
00092 <span class="comment">\***************************************************************************/</span>
00093 
<a name="l00094"></a><a class="code" href="../../d6/d0/extract_8c.html#a34">00094</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> <a class="code" href="../../d6/d0/extract_8c.html#a34">RVAtoP</a>(
00095     LPVOID pBase,
00096     DWORD  rva)
00097 {
00098     <a class="code" href="../../d6/d0/extract_8c.html#a27">LPEXEHDR</a>             pmz;
00099     IMAGE_NT_HEADERS     *ppe;
00100     IMAGE_SECTION_HEADER *pSection; <span class="comment">// section table</span>
00101     <span class="keywordtype">int</span>                  i;
00102     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                size;
00103 
00104     pmz = (<a class="code" href="../../d6/d0/extract_8c.html#a27">LPEXEHDR</a>)pBase;
00105     ppe = (IMAGE_NT_HEADERS*)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)pBase + pmz-&gt;e_lfanew);
00106 
00107     <span class="comment">/*</span>
00108 <span class="comment">     * Scan the section table looking for the RVA</span>
00109 <span class="comment">     */</span>
00110     pSection = IMAGE_FIRST_SECTION(ppe);
00111 
00112     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d6/d0/extract_8c.html#a14">NUMBER_OF_SECTIONS</a>(ppe); i++) {
00113 
00114         size = pSection[i].Misc.VirtualSize ?
00115                pSection[i].Misc.VirtualSize : pSection[i].SizeOfRawData;
00116 
00117         <span class="keywordflow">if</span> (rva &gt;= pSection[i].VirtualAddress &amp;&amp;
00118             rva &lt;  pSection[i].VirtualAddress + size) {
00119 
00120             <span class="keywordflow">return</span> (LPBYTE)pBase + pSection[i].PointerToRawData + (rva - pSection[i].VirtualAddress);
00121         }
00122     }
00123 
00124     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00125 }
00126 
00127 <span class="comment">/***************************************************************************\</span>
00128 <span class="comment">* GetResourceTablePE</span>
00129 <span class="comment">*</span>
00130 <span class="comment">*</span>
00131 <span class="comment">\***************************************************************************/</span>
00132 
<a name="l00133"></a><a class="code" href="../../d6/d0/extract_8c.html#a35">00133</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> <a class="code" href="../../d6/d0/extract_8c.html#a35">GetResourceTablePE</a>(
00134     LPVOID pBase)
00135 {
00136     <a class="code" href="../../d6/d0/extract_8c.html#a27">LPEXEHDR</a>         pmz;
00137     IMAGE_NT_HEADERS *ppe;
00138 
00139     pmz = (<a class="code" href="../../d6/d0/extract_8c.html#a27">LPEXEHDR</a>)pBase;
00140     ppe = (IMAGE_NT_HEADERS*)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)pBase + pmz-&gt;e_lfanew);
00141 
00142     <span class="keywordflow">if</span> (pmz-&gt;e_magic != <a class="code" href="../../d6/d0/extract_8c.html#a9">MZMAGIC</a>)
00143         <span class="keywordflow">return</span> 0;
00144 
00145     <span class="keywordflow">if</span> (ppe-&gt;Signature != IMAGE_NT_SIGNATURE)
00146         <span class="keywordflow">return</span> 0;
00147 
00148     <span class="keywordflow">if</span> (ppe-&gt;FileHeader.SizeOfOptionalHeader &lt; IMAGE_SIZEOF_NT_OPTIONAL_HEADER)
00149         <span class="keywordflow">return</span> 0;
00150 
00151     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a34">RVAtoP</a>(pBase, <a class="code" href="../../d6/d0/extract_8c.html#a12">RESOURCE_VA</a>(ppe));
00152 }
00153 
00154 <span class="comment">/****************************************************************************</span>
00155 <span class="comment">* FindResourcePE</span>
00156 <span class="comment">*</span>
00157 <span class="comment">*   given a PE resource directory will find a resource in it.</span>
00158 <span class="comment">*</span>
00159 <span class="comment">*   if iResIndex &lt; 0 we will search for the specific index</span>
00160 <span class="comment">*   if iResIndex &gt;= 0 we will return the Nth index</span>
00161 <span class="comment">*   if iResIndex == GET_COUNT the count of resources will be returned</span>
00162 <span class="comment">*</span>
00163 <span class="comment">\*****************************************************************************/</span>
00164 
<a name="l00165"></a><a class="code" href="../../d6/d0/extract_8c.html#a36">00165</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> <a class="code" href="../../d6/d0/extract_8c.html#a36">FindResourcePE</a>(
00166     LPVOID pBase,
00167     LPVOID prt,
00168     <span class="keywordtype">int</span>    iResIndex,
00169     <span class="keywordtype">int</span>    ResType,
00170     DWORD  *pcb)
00171 {
00172     <span class="keywordtype">int</span>                            i;
00173     <span class="keywordtype">int</span>                            cnt;
00174     IMAGE_RESOURCE_DIRECTORY       *pdir;
00175     IMAGE_RESOURCE_DIRECTORY_ENTRY *pres;
00176     IMAGE_RESOURCE_DATA_ENTRY      *pent;
00177 
00178     pdir = (IMAGE_RESOURCE_DIRECTORY *)prt;
00179 
00180     <span class="comment">/*</span>
00181 <span class="comment">     * First find the type always a ID so ignore strings totaly</span>
00182 <span class="comment">     */</span>
00183     cnt  = pdir-&gt;NumberOfIdEntries + pdir-&gt;NumberOfNamedEntries;
00184     pres = (IMAGE_RESOURCE_DIRECTORY_ENTRY*)(pdir+1);
00185 
00186     <span class="keywordflow">for</span> (i = 0; i &lt; cnt; i++) {
00187 
00188         <span class="keywordflow">if</span> (pres[i].Name == (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)ResType)
00189             <span class="keywordflow">break</span>;
00190     }
00191 
00192     <span class="keywordflow">if</span> (i==cnt)             <span class="comment">// did not find the type</span>
00193         <span class="keywordflow">return</span> 0;
00194 
00195     <span class="comment">/*</span>
00196 <span class="comment">     * Now go find the actual resource  either by id (iResIndex &lt; 0) or</span>
00197 <span class="comment">     * by ordinal (iResIndex &gt;= 0)</span>
00198 <span class="comment">     */</span>
00199     pdir = (IMAGE_RESOURCE_DIRECTORY*)((LPBYTE)prt +
00200         (pres[i].OffsetToData &amp; ~IMAGE_RESOURCE_DATA_IS_DIRECTORY));
00201 
00202     cnt  = pdir-&gt;NumberOfIdEntries + pdir-&gt;NumberOfNamedEntries;
00203     pres = (IMAGE_RESOURCE_DIRECTORY_ENTRY*)(pdir+1);
00204 
00205     <span class="comment">/*</span>
00206 <span class="comment">     * If we just want size, do it.</span>
00207 <span class="comment">     */</span>
00208     <span class="keywordflow">if</span> (iResIndex == <a class="code" href="../../d6/d0/extract_8c.html#a24">GET_COUNT</a>)
00209         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)UIntToPtr( cnt );
00210 
00211     <span class="comment">/*</span>
00212 <span class="comment">     * if we are to search for a specific id do it.</span>
00213 <span class="comment">     */</span>
00214     <span class="keywordflow">if</span> (iResIndex &lt; 0) {
00215 
00216         <span class="keywordflow">for</span> (i = 0; i &lt; cnt; i++)
00217             <span class="keywordflow">if</span> (pres[i].Name == (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-iResIndex))
00218                 <span class="keywordflow">break</span>;
00219     } <span class="keywordflow">else</span> {
00220         i = iResIndex;
00221     }
00222 
00223     <span class="comment">/*</span>
00224 <span class="comment">     * is the index in range?</span>
00225 <span class="comment">     */</span>
00226     <span class="keywordflow">if</span> (i &gt;= cnt)
00227         <span class="keywordflow">return</span> 0;
00228 
00229     <span class="comment">/*</span>
00230 <span class="comment">     * if we get this far the resource has a language part, ick!</span>
00231 <span class="comment">     * !!!for now just punt and return the first one.</span>
00232 <span class="comment">     * !!!BUGBUG we dont handle multi-language icons</span>
00233 <span class="comment">     */</span>
00234     <span class="keywordflow">if</span> (pres[i].OffsetToData &amp; IMAGE_RESOURCE_DATA_IS_DIRECTORY) {
00235 
00236         pdir = (IMAGE_RESOURCE_DIRECTORY*)((LPBYTE)prt +
00237                 (pres[i].OffsetToData &amp; ~IMAGE_RESOURCE_DATA_IS_DIRECTORY));
00238         pres = (IMAGE_RESOURCE_DIRECTORY_ENTRY*)(pdir+1);
00239         i = 0;  <span class="comment">// choose first one</span>
00240     }
00241 
00242     <span class="comment">/*</span>
00243 <span class="comment">     * Nested way to deep for me!</span>
00244 <span class="comment">     */</span>
00245     <span class="keywordflow">if</span> (pres[i].OffsetToData &amp; IMAGE_RESOURCE_DATA_IS_DIRECTORY)
00246         <span class="keywordflow">return</span> 0;
00247 
00248     pent = (IMAGE_RESOURCE_DATA_ENTRY*)((LPBYTE)prt + pres[i].OffsetToData);
00249 
00250     <span class="comment">/*</span>
00251 <span class="comment">     * all OffsetToData fields except the final one are relative to</span>
00252 <span class="comment">     * the start of the section.  the final one is a virtual address</span>
00253 <span class="comment">     * we need to go back to the header and get the virtual address</span>
00254 <span class="comment">     * of the resource section to do this right.</span>
00255 <span class="comment">     */</span>
00256     *pcb = pent-&gt;Size;
00257     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a34">RVAtoP</a>(pBase, pent-&gt;OffsetToData);
00258 }
00259 
00260 <span class="comment">/***************************************************************************\</span>
00261 <span class="comment">* GetResourceTableNE</span>
00262 <span class="comment">*</span>
00263 <span class="comment">*</span>
00264 <span class="comment">\***************************************************************************/</span>
00265 
<a name="l00266"></a><a class="code" href="../../d6/d0/extract_8c.html#a37">00266</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> <a class="code" href="../../d6/d0/extract_8c.html#a37">GetResourceTableNE</a>(
00267     LPVOID pBase)
00268 {
00269     <a class="code" href="../../d6/d0/extract_8c.html#a26">LPNEWEXE</a> pne;
00270     <a class="code" href="../../d6/d0/extract_8c.html#a27">LPEXEHDR</a> pmz;
00271 
00272     pmz = (<a class="code" href="../../d6/d0/extract_8c.html#a27">LPEXEHDR</a>)pBase;
00273     pne = (<a class="code" href="../../d6/d0/extract_8c.html#a26">LPNEWEXE</a>)((LPBYTE)pBase + pmz-&gt;e_lfanew);
00274 
00275     <span class="keywordflow">if</span> (pmz-&gt;e_magic != <a class="code" href="../../d6/d0/extract_8c.html#a9">MZMAGIC</a>)
00276         <span class="keywordflow">return</span> 0;
00277 
00278     <span class="keywordflow">if</span> (pne-&gt;ne_magic != NEMAGIC)           <span class="comment">// must be a NEWEXE</span>
00279         <span class="keywordflow">return</span> 0;
00280 
00281     <span class="keywordflow">if</span> (pne-&gt;ne_exetyp != NE_WINDOWS &amp;&amp;     <span class="comment">// must be a Win DLL/EXE/386</span>
00282         pne-&gt;ne_exetyp != NE_DEV386)
00283         <span class="keywordflow">return</span> 0;
00284 
00285     <span class="keywordflow">if</span> (pne-&gt;ne_expver &lt; 0x0300)            <span class="comment">// must be 3.0 or greater</span>
00286         <span class="keywordflow">return</span> 0;
00287 
00288     <span class="keywordflow">if</span> (pne-&gt;ne_rsrctab == pne-&gt;ne_restab)  <span class="comment">// no resources</span>
00289         <span class="keywordflow">return</span> 0;
00290 
00291     <span class="keywordflow">return</span> (LPBYTE)pne + pne-&gt;ne_rsrctab;   <span class="comment">// return resource table pointer</span>
00292 }
00293 
00294 <span class="comment">/***************************************************************************\</span>
00295 <span class="comment">* FindResourceNE</span>
00296 <span class="comment">*</span>
00297 <span class="comment">* This returns a pointer to the rsrc_nameinfo of the resource with the</span>
00298 <span class="comment">* given index and type, if it is found, otherwise it returns NULL.</span>
00299 <span class="comment">*</span>
00300 <span class="comment">* if iResIndex is &lt; 0, then it is assumed to be a ID and the res table</span>
00301 <span class="comment">* will be searched for a matching id.</span>
00302 <span class="comment">*</span>
00303 <span class="comment">* if iResIndex is &gt;= 0, then it is assumed to be a index and the Nth</span>
00304 <span class="comment">* resorce of the specifed type will be returned.</span>
00305 <span class="comment">*</span>
00306 <span class="comment">* if iResIndex == GET_COUNT the count of resources will be returned</span>
00307 <span class="comment">*</span>
00308 <span class="comment">\***************************************************************************/</span>
00309 
<a name="l00310"></a><a class="code" href="../../d6/d0/extract_8c.html#a38">00310</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> <a class="code" href="../../d6/d0/extract_8c.html#a38">FindResourceNE</a>(
00311     LPVOID lpBase,
00312     LPVOID prt,
00313     <span class="keywordtype">int</span>    iResIndex,
00314     <span class="keywordtype">int</span>    iResType,
00315     DWORD  *pcb)
00316 {
00317     <a class="code" href="../../d6/d0/extract_8c.html#a31">LPRESTABLE</a>     lpResTable;
00318     <a class="code" href="../../d6/d0/extract_8c.html#a30">ULPRESTYPEINFO</a> ulpResTypeInfo;
00319     <a class="code" href="../../d6/d0/extract_8c.html#a28">LPRESNAMEINFO</a>  lpResNameInfo;  <span class="comment">// 16 bit alignment ok - had ushorts only</span>
00320     <span class="keywordtype">int</span>            i;
00321 
00322     lpResTable = (<a class="code" href="../../d6/d0/extract_8c.html#a31">LPRESTABLE</a>)prt;
00323 <span class="comment">//ulpResTypeInfo = (ULPRESTYPEINFO)(LPWBYTE)&amp;lpResTable-&gt;rs_typeinfo;</span>
00324     ulpResTypeInfo = (<a class="code" href="../../d6/d0/extract_8c.html#a30">ULPRESTYPEINFO</a>)((LPBYTE)lpResTable + 2);
00325 
00326     <span class="keywordflow">while</span> (ulpResTypeInfo-&gt;rt_id) {
00327 
00328         <span class="keywordflow">if</span> (ulpResTypeInfo-&gt;rt_id == (iResType | RSORDID)) {
00329 
00330             lpResNameInfo = (<a class="code" href="../../d6/d0/extract_8c.html#a28">LPRESNAMEINFO</a>)(ulpResTypeInfo + 1);
00331 
00332             <span class="keywordflow">if</span> (iResIndex == <a class="code" href="../../d6/d0/extract_8c.html#a24">GET_COUNT</a>)
00333                 <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)ulpResTypeInfo-&gt;rt_nres;
00334 
00335             <span class="keywordflow">if</span> (iResIndex &lt; 0) {
00336 
00337                 <span class="keywordflow">for</span> (i=0; i &lt; (<span class="keywordtype">int</span>)ulpResTypeInfo-&gt;rt_nres; i++) {
00338 
00339                     <span class="keywordflow">if</span> (lpResNameInfo[i].rn_id == ((-iResIndex) | RSORDID))
00340                         <span class="keywordflow">break</span>;
00341                 }
00342 
00343                 iResIndex = i;
00344             }
00345 
00346             <span class="keywordflow">if</span> (iResIndex &gt;= (<span class="keywordtype">int</span>)ulpResTypeInfo-&gt;rt_nres)
00347                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00348 
00349             *pcb = ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lpResNameInfo[iResIndex].rn_length) &lt;&lt; lpResTable-&gt;rs_align;
00350             <span class="keywordflow">return</span> (LPBYTE)lpBase + ((<span class="keywordtype">long</span>)lpResNameInfo[iResIndex].rn_offset &lt;&lt; lpResTable-&gt;rs_align);
00351         }
00352 
00353         ulpResTypeInfo =
00354                (<a class="code" href="../../d6/d0/extract_8c.html#a30">ULPRESTYPEINFO</a>)((<a class="code" href="../../d6/d0/extract_8c.html#a28">LPRESNAMEINFO</a>)(ulpResTypeInfo + 1) +
00355                 ulpResTypeInfo-&gt;rt_nres);
00356     }
00357 
00358     *pcb = 0;
00359     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00360 }
00361 
00362 <span class="comment">/***************************************************************************\</span>
00363 <span class="comment">* ExtractIconFromICO</span>
00364 <span class="comment">*</span>
00365 <span class="comment">*</span>
00366 <span class="comment">\***************************************************************************/</span>
00367 
<a name="l00368"></a><a class="code" href="../../d6/d0/extract_8c.html#a39">00368</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d0/extract_8c.html#a39">ExtractIconFromICO</a>(
00369     LPTSTR szFile,
00370     <span class="keywordtype">int</span>    nIconIndex,
00371     <span class="keywordtype">int</span>    cxIcon,
00372     <span class="keywordtype">int</span>    cyIcon,
00373     HICON  *phicon,
00374     UINT   flags)
00375 {
00376     HICON hicon;
00377 
00378     <span class="keywordflow">if</span> (nIconIndex &gt;= 1)
00379         <span class="keywordflow">return</span> 0;
00380 
00381     flags |= LR_LOADFROMFILE;
00382 
00383 again:
00384 
00385     hicon = LoadImage(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00386                       <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a3">szFile</a>,
00387                       IMAGE_ICON,
00388                       LOWORD(cxIcon),
00389                       LOWORD(cyIcon),
00390                       flags);
00391 
00392     <span class="keywordflow">if</span> (hicon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00393         <span class="keywordflow">return</span> 0;
00394 
00395     <span class="comment">/*</span>
00396 <span class="comment">     * Do we just want a count?</span>
00397 <span class="comment">     */</span>
00398     <span class="keywordflow">if</span> (phicon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00399         <a class="code" href="../../d4/d9/clres_8c.html#a55">DestroyCursor</a>((HCURSOR)hicon);
00400     <span class="keywordflow">else</span>
00401         *phicon = hicon;
00402 
00403     <span class="comment">/*</span>
00404 <span class="comment">     * Check for large/small icon extract</span>
00405 <span class="comment">     */</span>
00406     <span class="keywordflow">if</span> (HIWORD(cxIcon)) {
00407 
00408         cxIcon = HIWORD(cxIcon);
00409         cyIcon = HIWORD(cyIcon);
00410         phicon++;
00411 
00412         <span class="keywordflow">goto</span> again;
00413     }
00414 
00415     <span class="keywordflow">return</span> 1;
00416 }
00417 
00418 <span class="comment">/***************************************************************************\</span>
00419 <span class="comment">* ExtractIconFromBMP</span>
00420 <span class="comment">*</span>
00421 <span class="comment">*</span>
00422 <span class="comment">\***************************************************************************/</span>
00423 
<a name="l00424"></a><a class="code" href="../../d6/d0/extract_8c.html#a25">00424</a> <span class="preprocessor">#define ROP_DSna 0x00220326</span>
00425 <span class="preprocessor"></span>
<a name="l00426"></a><a class="code" href="../../d6/d0/extract_8c.html#a40">00426</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d0/extract_8c.html#a40">ExtractIconFromBMP</a>(
00427     LPTSTR szFile,
00428     <span class="keywordtype">int</span>    nIconIndex,
00429     <span class="keywordtype">int</span>    cxIcon,
00430     <span class="keywordtype">int</span>    cyIcon,
00431     HICON  *phicon,
00432     UINT   flags)
00433 {
00434     HICON    hicon;
00435     HBITMAP  hbm;
00436     HBITMAP  hbmMask;
00437     HDC      hdc;
00438     HDC      hdcMask;
00439     ICONINFO ii;
00440 
00441     <span class="keywordflow">if</span> (nIconIndex &gt;= 1)
00442         <span class="keywordflow">return</span> 0;
00443 
00444     <span class="comment">/*</span>
00445 <span class="comment">     * BUGUS: don't use LR_CREATEDIBSECTION.  USER can't make an icon out</span>
00446 <span class="comment">     * of a DibSection.</span>
00447 <span class="comment">     */</span>
00448     flags |= LR_LOADFROMFILE;
00449 
00450 again:
00451 
00452     hbm = (HBITMAP)LoadImage(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00453                              <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a3">szFile</a>,
00454                              IMAGE_BITMAP,
00455                              LOWORD(cxIcon),
00456                              LOWORD(cyIcon),
00457                              flags);
00458 
00459     <span class="keywordflow">if</span> (hbm == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00460         <span class="keywordflow">return</span> 0;
00461 
00462     <span class="comment">/*</span>
00463 <span class="comment">     *  do we just want a count?</span>
00464 <span class="comment">     */</span>
00465     <span class="keywordflow">if</span> (phicon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00466         DeleteObject(hbm);
00467         <span class="keywordflow">return</span> 1;
00468     }
00469 
00470     hbmMask = CreateBitmap(LOWORD(cxIcon), LOWORD(cyIcon), 1, 1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00471 
00472     hdc = CreateCompatibleDC(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00473     SelectObject(hdc, hbm);
00474 
00475     hdcMask = CreateCompatibleDC(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00476     SelectObject(hdcMask, hbmMask);
00477 
00478     SetBkColor(hdc, GetPixel(hdc, 0, 0));
00479 
00480     BitBlt(hdcMask, 0, 0, LOWORD(cxIcon), LOWORD(cyIcon), hdc, 0, 0, SRCCOPY);
00481     BitBlt(hdc, 0, 0, LOWORD(cxIcon), LOWORD(cyIcon), hdcMask, 0, 0, <a class="code" href="../../d6/d0/extract_8c.html#a25">ROP_DSna</a>);
00482 
00483     ii.fIcon    = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00484     ii.xHotspot = 0;
00485     ii.yHotspot = 0;
00486     ii.hbmColor = hbm;
00487     ii.hbmMask  = hbmMask;
00488     hicon = <a class="code" href="../../d4/d9/clres_8c.html#a60">CreateIconIndirect</a>(&amp;ii);
00489 
00490     DeleteObject(hdc);
00491     DeleteObject(hbm);
00492     DeleteObject(hdcMask);
00493     DeleteObject(hbmMask);
00494 
00495     *phicon = hicon;
00496 
00497     <span class="comment">/*</span>
00498 <span class="comment">     * Check for large/small icon extract</span>
00499 <span class="comment">     */</span>
00500     <span class="keywordflow">if</span> (HIWORD(cxIcon)) {
00501         cxIcon = HIWORD(cxIcon);
00502         cyIcon = HIWORD(cyIcon);
00503         phicon++;
00504 
00505         <span class="keywordflow">goto</span> again;
00506     }
00507 
00508     <span class="keywordflow">return</span> 1;
00509 }
00510 
00511 <span class="comment">/***************************************************************************\</span>
00512 <span class="comment">* ExtractIconFromEXE</span>
00513 <span class="comment">*</span>
00514 <span class="comment">*</span>
00515 <span class="comment">\***************************************************************************/</span>
00516 
<a name="l00517"></a><a class="code" href="../../d6/d0/extract_8c.html#a41">00517</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d0/extract_8c.html#a41">ExtractIconFromEXE</a>(
00518     HANDLE hFile,
00519     <span class="keywordtype">int</span>    nIconIndex,
00520     <span class="keywordtype">int</span>    cxIconSize,
00521     <span class="keywordtype">int</span>    cyIconSize,
00522     HICON  *phicon,
00523     UINT   *piconid,
00524     UINT   nIcons,
00525     UINT   flags)
00526 {
00527     HANDLE           hFileMap = <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00528     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>           lpFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00529     EXEHDR           *pmz;
00530     NEWEXE UNALIGNED *pne;
00531     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>           pBase;
00532     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>           pres = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00533     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>             result = 0;
00534     LONG             FileLength;
00535     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            cbSize;
00536     <span class="keywordtype">int</span>              cxIcon;
00537     <span class="keywordtype">int</span>              cyIcon;
00538 
00539     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> (*FindResourceX)(<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> pBase,
00540                             <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> prt,
00541                             <span class="keywordtype">int</span>    iResIndex,
00542                             <span class="keywordtype">int</span>    iResType,
00543                             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  *pcb);
00544 
00545     FileLength = (LONG)GetFileSize(hFile, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00546 
00547     hFileMap = CreateFileMapping(hFile, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, PAGE_READONLY, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00548     <span class="keywordflow">if</span> (hFileMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00549         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00550 
00551     lpFile = MapViewOfFile(hFileMap, FILE_MAP_READ, 0, 0, 0);
00552     <span class="keywordflow">if</span> (lpFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00553         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00554 
00555     pBase = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lpFile;
00556     pmz = (<span class="keyword">struct </span>exe_hdr *)pBase;
00557 
00558     _try {
00559 
00560         <span class="keywordflow">if</span> (pmz-&gt;e_magic != <a class="code" href="../../d6/d0/extract_8c.html#a9">MZMAGIC</a>)
00561             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00562 
00563         <span class="keywordflow">if</span> (pmz-&gt;e_lfanew &lt;= 0)             <span class="comment">// not a new exe</span>
00564             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00565 
00566         <span class="keywordflow">if</span> (pmz-&gt;e_lfanew &gt;= FileLength)    <span class="comment">// not a new exe</span>
00567             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00568 
00569         pne = (NEWEXE UNALIGNED *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)pmz + pmz-&gt;e_lfanew);
00570 
00571         <span class="keywordflow">switch</span> (pne-&gt;ne_magic) {
00572         <span class="keywordflow">case</span> NEMAGIC:
00573             pres = <a class="code" href="../../d6/d0/extract_8c.html#a37">GetResourceTableNE</a>(pBase);
00574             FindResourceX = <a class="code" href="../../d6/d0/extract_8c.html#a38">FindResourceNE</a>;
00575             <span class="keywordflow">break</span>;
00576 
00577         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a10">PEMAGIC</a>:
00578             pres = <a class="code" href="../../d6/d0/extract_8c.html#a35">GetResourceTablePE</a>(pBase);
00579             FindResourceX = <a class="code" href="../../d6/d0/extract_8c.html#a36">FindResourcePE</a>;
00580             <span class="keywordflow">break</span>;
00581         }
00582 
00583         <span class="comment">/*</span>
00584 <span class="comment">         * cant find the resource table, fail</span>
00585 <span class="comment">         */</span>
00586         <span class="keywordflow">if</span> (pres == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00587             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00588 
00589         <span class="comment">/*</span>
00590 <span class="comment">         * do we just want a count?</span>
00591 <span class="comment">         */</span>
00592         <span class="keywordflow">if</span> (phicon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00593             result = PtrToUlong(FindResourceX(pBase,
00594                                              pres,
00595                                              <a class="code" href="../../d6/d0/extract_8c.html#a24">GET_COUNT</a>,
00596                                              (LONG_PTR)RT_GROUP_ICON,
00597                                              &amp;cbSize));
00598             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00599         }
00600 
00601         <span class="keywordflow">while</span> (result &lt; nIcons) {
00602 
00603             <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> lpIconDir;
00604             <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> lpIcon;
00605             <span class="keywordtype">int</span>    idIcon;
00606 
00607             cxIcon = cxIconSize;
00608             cyIcon = cyIconSize;
00609 
00610             <span class="comment">/*</span>
00611 <span class="comment">             *  find the icon dir for this icon.</span>
00612 <span class="comment">             */</span>
00613             lpIconDir = FindResourceX(pBase,
00614                                       pres,
00615                                       nIconIndex,
00616                                       (LONG_PTR)RT_GROUP_ICON,
00617                                       &amp;cbSize);
00618 
00619             <span class="keywordflow">if</span> (lpIconDir == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00620                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00621 
00622             <span class="keywordflow">if</span> ((((LPNEWHEADER)lpIconDir)-&gt;Reserved != 0) ||
00623                 (((LPNEWHEADER)lpIconDir)-&gt;ResType != FT_ICON)) {
00624 
00625                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00626             }
00627 again:
00628             idIcon = <a class="code" href="../../d4/d9/clres_8c.html#a67">LookupIconIdFromDirectoryEx</a>((LPBYTE)lpIconDir,
00629                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00630                                                  LOWORD(cxIcon),
00631                                                  LOWORD(cyIcon),
00632                                                  flags);
00633             lpIcon = FindResourceX(pBase,
00634                                    pres,
00635                                    -idIcon,
00636                                    (LONG_PTR)RT_ICON,
00637                                    &amp;cbSize);
00638 
00639             <span class="keywordflow">if</span> (lpIcon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00640                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00641 
00642             <span class="keywordflow">if</span> ((((<a class="code" href="../../d6/d0/usercli_8h.html#a378">UPBITMAPINFOHEADER</a>)lpIcon)-&gt;biSize != <span class="keyword">sizeof</span>(BITMAPINFOHEADER)) &amp;&amp;
00643                 (((<a class="code" href="../../d6/d0/usercli_8h.html#a378">UPBITMAPINFOHEADER</a>)lpIcon)-&gt;biSize != <span class="keyword">sizeof</span>(BITMAPCOREHEADER))) {
00644 
00645                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00646             }
00647 
00648 <span class="preprocessor">#ifndef WINNT</span>
00649 <span class="preprocessor"></span>            <span class="comment">/* touch this memory before calling USER</span>
00650 <span class="comment">             * so if we page fault we will do it outside of the Win16Lock</span>
00651 <span class="comment">             * most icons aren't more than 2 pages</span>
00652 <span class="comment">             */</span>
00653             <a class="code" href="../../d6/d0/extract_8c.html#a33">ReadAByte</a>(((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)lpIcon) + cbSize - 1);
00654 <span class="preprocessor">#endif</span>
00655 <span class="preprocessor"></span>
00656             <span class="keywordflow">if</span> (piconid)
00657                 piconid[result] = idIcon;
00658 
00659             phicon[result++] = <a class="code" href="../../d4/d9/clres_8c.html#a70">CreateIconFromResourceEx</a>((LPBYTE)lpIcon,
00660                                                         cbSize,
00661                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00662                                                         <a class="code" href="../../d6/d0/extract_8c.html#a23">WIN32VER30</a>,
00663                                                         LOWORD(cxIcon),
00664                                                         LOWORD(cyIcon),
00665                                                         flags);
00666 
00667             <span class="comment">/*</span>
00668 <span class="comment">             * check for large/small icon extract</span>
00669 <span class="comment">             */</span>
00670             <span class="keywordflow">if</span> (HIWORD(cxIcon)) {
00671 
00672                 cxIcon = HIWORD(cxIcon);
00673                 cyIcon = HIWORD(cyIcon);
00674 
00675                 <span class="keywordflow">goto</span> again;
00676             }
00677 
00678             nIconIndex++;       <span class="comment">// next icon index</span>
00679         }
00680 
00681     } _except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00682         result = 0;
00683     }
00684 
00685 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
00686 
00687     <span class="keywordflow">if</span> (lpFile)
00688         UnmapViewOfFile(lpFile);
00689 
00690     <span class="keywordflow">if</span> (hFileMap != <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
00691         CloseHandle(hFileMap);
00692 
00693     <span class="keywordflow">return</span> result;
00694 }
00695 
00696 <span class="comment">/***************************************************************************\</span>
00697 <span class="comment">* PathFindExtension</span>
00698 <span class="comment">*</span>
00699 <span class="comment">*</span>
00700 <span class="comment">\***************************************************************************/</span>
00701 
<a name="l00702"></a><a class="code" href="../../d6/d0/extract_8c.html#a42">00702</a> LPWSTR <a class="code" href="../../d6/d0/extract_8c.html#a42">PathFindExtension</a>(
00703     LPWSTR pszPath)
00704 {
00705     LPWSTR pszDot;
00706 
00707     <span class="keywordflow">for</span> (pszDot = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; *pszPath; pszPath = CharNext(pszPath)) {
00708 
00709         <span class="keywordflow">switch</span> (*pszPath) {
00710         <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>:
00711             pszDot = pszPath;    <span class="comment">// remember the last dot</span>
00712             <span class="keywordflow">break</span>;
00713 
00714         <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>:
00715         <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>:               <span class="comment">// extensions can't have spaces</span>
00716             pszDot = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// forget last dot, it was in a directory</span>
00717             <span class="keywordflow">break</span>;
00718         }
00719     }
00720 
00721     <span class="comment">/*</span>
00722 <span class="comment">     * if we found the extension, return ptr to the dot, else</span>
00723 <span class="comment">     * ptr to end of the string (NULL extension) (cast-&gt;non const)</span>
00724 <span class="comment">     */</span>
00725     <span class="keywordflow">return</span> pszDot ? (LPWSTR)pszDot : (LPWSTR)pszPath;
00726 }
00727 
00728 <span class="comment">/***************************************************************************\</span>
00729 <span class="comment">* PrivateExtractIconExA</span>
00730 <span class="comment">*</span>
00731 <span class="comment">* Ansi version of PrivateExtractIconExW</span>
00732 <span class="comment">*</span>
00733 <span class="comment">\***************************************************************************/</span>
00734 
<a name="l00735"></a><a class="code" href="../../d6/d0/extract_8c.html#a43">00735</a> WINUSERAPI <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d0/extract_8c.html#a43">PrivateExtractIconExA</a>(
00736     LPCSTR szFileName,
00737     <span class="keywordtype">int</span>    nIconIndex,
00738     HICON  *phiconLarge,
00739     HICON  *phiconSmall,
00740     UINT   nIcons)
00741 {
00742     LPWSTR szFileNameW;
00743     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    uRet;
00744 
00745     <span class="keywordflow">if</span> (!MBToWCS(szFileName, -1, &amp;szFileNameW, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00746         <span class="keywordflow">return</span> 0;
00747 
00748     uRet = <a class="code" href="../../d6/d0/extract_8c.html#a47">PrivateExtractIconExW</a>(szFileNameW,
00749                                  nIconIndex,
00750                                  phiconLarge,
00751                                  phiconSmall,
00752                                  nIcons);
00753 
00754     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(szFileNameW);
00755 
00756     <span class="keywordflow">return</span> uRet;
00757 }
00758 
00759 <span class="comment">/***************************************************************************\</span>
00760 <span class="comment">* HasExtension</span>
00761 <span class="comment">*</span>
00762 <span class="comment">*</span>
00763 <span class="comment">\***************************************************************************/</span>
00764 
<a name="l00765"></a><a class="code" href="../../d6/d0/extract_8c.html#a44">00765</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d0/extract_8c.html#a44">HasExtension</a>(
00766     LPWSTR pszPath)
00767 {
00768     LPWSTR p = <a class="code" href="../../d6/d0/extract_8c.html#a42">PathFindExtension</a>(pszPath);
00769 
00770     <span class="comment">/*</span>
00771 <span class="comment">     * BUGBUG - BobDay - Shouldn't this limit the length to 4 characters?</span>
00772 <span class="comment">     * "Fister.Bather" would return .BAT</span>
00773 <span class="comment">     *</span>
00774 <span class="comment">     * BUGBUG - BobDay - We could make this EXTKEY based like the extension</span>
00775 <span class="comment">     * matching stuff elsewhere.  EXTKEY is a QWORD value so UNICODE would</span>
00776 <span class="comment">     * fit.</span>
00777 <span class="comment">     */</span>
00778     <span class="keywordflow">if</span> (*p == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>) {
00779 
00780         WCHAR szExt[5];
00781 
00782         lstrcpynW(szExt, p, 5);
00783 
00784         <span class="keywordflow">if</span> (lstrcmpiW(szExt,TEXT(<span class="stringliteral">".com"</span>)) == 0) <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a16">COM_FILE</a>;
00785         <span class="keywordflow">if</span> (lstrcmpiW(szExt,TEXT(<span class="stringliteral">".bat"</span>)) == 0) <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a17">BAT_FILE</a>;
00786         <span class="keywordflow">if</span> (lstrcmpiW(szExt,TEXT(<span class="stringliteral">".cmd"</span>)) == 0) <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a18">CMD_FILE</a>;
00787         <span class="keywordflow">if</span> (lstrcmpiW(szExt,TEXT(<span class="stringliteral">".pif"</span>)) == 0) <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a19">PIF_FILE</a>;
00788         <span class="keywordflow">if</span> (lstrcmpiW(szExt,TEXT(<span class="stringliteral">".lnk"</span>)) == 0) <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a20">LNK_FILE</a>;
00789         <span class="keywordflow">if</span> (lstrcmpiW(szExt,TEXT(<span class="stringliteral">".ico"</span>)) == 0) <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a21">ICO_FILE</a>;
00790         <span class="keywordflow">if</span> (lstrcmpiW(szExt,TEXT(<span class="stringliteral">".exe"</span>)) == 0) <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a22">EXE_FILE</a>;
00791     }
00792 
00793     <span class="keywordflow">return</span> 0;
00794 }
00795 
00796 <span class="comment">/***************************************************************************\</span>
00797 <span class="comment">* PrivateExtractIconsW</span>
00798 <span class="comment">*</span>
00799 <span class="comment">* Extracts 1 or more icons from a file.</span>
00800 <span class="comment">*</span>
00801 <span class="comment">* input:</span>
00802 <span class="comment">*     szFileName          - EXE/DLL/ICO/CUR/ANI file to extract from</span>
00803 <span class="comment">*     nIconIndex          - what icon to extract</span>
00804 <span class="comment">*                             0 = first icon, 1=second icon, etc.</span>
00805 <span class="comment">*                            -N = icon with id==N</span>
00806 <span class="comment">*     cxIcon              - icon size wanted (if HIWORD != 0 two sizes...)</span>
00807 <span class="comment">*     cyIcon              - icon size wanted (if HIWORD != 0 two sizes...)</span>
00808 <span class="comment">*                           0,0 means extract at natural size.</span>
00809 <span class="comment">*     phicon              - place to return extracted icon(s)</span>
00810 <span class="comment">*     nIcons              - number of icons to extract.</span>
00811 <span class="comment">*     flags               - LoadImage LR_* flags</span>
00812 <span class="comment">*</span>
00813 <span class="comment">* returns:</span>
00814 <span class="comment">*     if picon is NULL, number of icons in the file is returned.</span>
00815 <span class="comment">*</span>
00816 <span class="comment">* notes:</span>
00817 <span class="comment">*     handles extraction from PE (Win32), NE (Win16), ICO (Icon),</span>
00818 <span class="comment">*     CUR (Cursor), ANI (Animated Cursor), and BMP (Bitmap) files.</span>
00819 <span class="comment">*     only Win16 3.x files are supported (not 2.x)</span>
00820 <span class="comment">*</span>
00821 <span class="comment">*     cx/cyIcon are the size of the icon to extract, two sizes</span>
00822 <span class="comment">*     can be extracted by putting size 1 in the loword and size 2 in the</span>
00823 <span class="comment">*     hiword, ie MAKELONG(24, 48) would extract 24 and 48 size icons.</span>
00824 <span class="comment">*     yea this is a stupid hack it is done so IExtractIcon::Extract</span>
00825 <span class="comment">*     can be called by outside people with custom large/small icon</span>
00826 <span class="comment">*     sizes that are not what the shell uses internaly.</span>
00827 <span class="comment">*</span>
00828 <span class="comment">\***************************************************************************/</span>
00829 
<a name="l00830"></a><a class="code" href="../../d6/d0/extract_8c.html#a45">00830</a> WINUSERAPI <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d6/d0/extract_8c.html#a45">PrivateExtractIconsW</a>(
00831     LPCWSTR szFileName,
00832     <span class="keywordtype">int</span>     nIconIndex,
00833     <span class="keywordtype">int</span>     cxIcon,
00834     <span class="keywordtype">int</span>     cyIcon,
00835     HICON   *phicon,
00836     UINT    *piconid,
00837     UINT    nIcons,
00838     UINT    flags)
00839 {
00840     HANDLE   hFile = (HANDLE)<a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00841     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>     result = 0;
00842     WORD     magic[6];
00843     WCHAR    achFileName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00844     FILETIME ftAccess;
00845     WCHAR    szExpFileName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00846     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwBytesRead;
00847 
00848     <span class="comment">/*</span>
00849 <span class="comment">     * Set failure defaults.</span>
00850 <span class="comment">     */</span>
00851     <span class="keywordflow">if</span> (phicon)
00852         *phicon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00853 
00854     <span class="comment">/*</span>
00855 <span class="comment">     * Check for special extensions, and fail quick</span>
00856 <span class="comment">     */</span>
00857     <span class="keywordflow">switch</span> (<a class="code" href="../../d6/d0/extract_8c.html#a44">HasExtension</a>((LPWSTR)szFileName)) {
00858     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a16">COM_FILE</a>:
00859     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a17">BAT_FILE</a>:
00860     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a18">CMD_FILE</a>:
00861     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a19">PIF_FILE</a>:
00862     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a20">LNK_FILE</a>:
00863         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00864 
00865     <span class="keywordflow">default</span>:
00866         <span class="keywordflow">break</span>;
00867     }
00868 
00869     <span class="comment">/*</span>
00870 <span class="comment">     * Try expanding environment variables in the file name we're passed.</span>
00871 <span class="comment">     */</span>
00872     ExpandEnvironmentStrings(szFileName, szExpFileName, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00873     szExpFileName[ <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>-1 ] = (WCHAR)0;
00874 
00875     <span class="comment">/*</span>
00876 <span class="comment">     * Open the file - First check to see if it is a UNC path.  If it</span>
00877 <span class="comment">     * is make sure that we have access to the path...</span>
00878 <span class="comment">     */</span>
00879     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/extract_8c.html#a32">PathIsUNC</a>(szExpFileName)) {
00880 
00881         lstrcpynW(achFileName, szExpFileName, <a class="code" href="../../d6/d0/extract_8c.html#a0">ARRAYSIZE</a>(achFileName));     <span class="comment">// BUGBUG sizeof</span>
00882 
00883     } <span class="keywordflow">else</span> {
00884 
00885         <span class="keywordflow">if</span> (SearchPath(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00886                        szExpFileName,
00887                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00888                        <a class="code" href="../../d6/d0/extract_8c.html#a0">ARRAYSIZE</a>(achFileName),
00889                        achFileName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == 0) {
00890 
00891             <span class="keywordflow">goto</span> error_file;
00892         }
00893     }
00894 
00895     hFile = CreateFile(achFileName,
00896                        GENERIC_READ|FILE_WRITE_ATTRIBUTES,
00897                        FILE_SHARE_WRITE | FILE_SHARE_READ,
00898                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00899                        <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>,
00900                        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_RANDOM_ACCESS,
00901                        0);
00902 
00903     <span class="keywordflow">if</span> (hFile == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>) {
00904 
00905         hFile = CreateFile(achFileName, GENERIC_READ,
00906                            FILE_SHARE_READ,
00907                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00908                            <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>,
00909                            FILE_ATTRIBUTE_NORMAL | FILE_FLAG_RANDOM_ACCESS,
00910                            0);
00911 
00912         <span class="keywordflow">if</span> (hFile == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
00913             <span class="keywordflow">goto</span> error_file;
00914 
00915     } <span class="keywordflow">else</span> {
00916 
00917         <span class="comment">/*</span>
00918 <span class="comment">         * Restore the Access Date</span>
00919 <span class="comment">         */</span>
00920         <span class="keywordflow">if</span> (GetFileTime(hFile, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ftAccess, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00921             SetFileTime(hFile, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ftAccess, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00922     }
00923 
00924 
00925     ReadFile(hFile, &amp;magic, <span class="keyword">sizeof</span>(magic), &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00926     <span class="keywordflow">if</span> (dwBytesRead != <span class="keyword">sizeof</span>(magic))
00927         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00928 
00929     <span class="keywordflow">if</span> (piconid)
00930         *piconid = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;    <span class="comment">// Fill in "don't know" value</span>
00931 
00932     <span class="keywordflow">switch</span> (magic[0]) {
00933     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a9">MZMAGIC</a>:
00934         result = <a class="code" href="../../d6/d0/extract_8c.html#a41">ExtractIconFromEXE</a>(hFile,
00935                                     nIconIndex,
00936                                     cxIcon,
00937                                     cyIcon,
00938                                     phicon,
00939                                     piconid,
00940                                     nIcons,
00941                                     flags);
00942         <span class="keywordflow">break</span>;
00943 
00944     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a5">ANI_MAGIC</a>:    <span class="comment">// possible .ani cursor</span>
00945 
00946         <span class="comment">/*</span>
00947 <span class="comment">         * Ani cursors are easy they are RIFF files of type 'ACON'</span>
00948 <span class="comment">         */</span>
00949         <span class="keywordflow">if</span> (magic[1] == <a class="code" href="../../d6/d0/extract_8c.html#a6">ANI_MAGIC1</a> &amp;&amp; magic[4] == <a class="code" href="../../d6/d0/extract_8c.html#a7">ANI_MAGIC4</a> &amp;&amp;
00950             magic[5] == <a class="code" href="../../d6/d0/extract_8c.html#a8">ANI_MAGIC5</a>) {
00951 
00952             result = <a class="code" href="../../d6/d0/extract_8c.html#a39">ExtractIconFromICO</a>(achFileName,
00953                                         nIconIndex,
00954                                         cxIcon,
00955                                         cyIcon,
00956                                         phicon,
00957                                         flags);
00958         }
00959         <span class="keywordflow">break</span>;
00960 
00961     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a4">BMP_MAGIC</a>:    <span class="comment">// possible bitmap</span>
00962         result = <a class="code" href="../../d6/d0/extract_8c.html#a40">ExtractIconFromBMP</a>(achFileName,
00963                                     nIconIndex,
00964                                     cxIcon,
00965                                     cyIcon,
00966                                     phicon,
00967                                     flags);
00968         <span class="keywordflow">break</span>;
00969 
00970     <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/extract_8c.html#a1">ICON_MAGIC</a>:   <span class="comment">// possible .ico or .cur</span>
00971 
00972         <span class="comment">/*</span>
00973 <span class="comment">         * Icons and cursors look like this</span>
00974 <span class="comment">         *</span>
00975 <span class="comment">         * iReserved       - always zero</span>
00976 <span class="comment">         * iResourceType   - 1 for icons 2 cor cursor.</span>
00977 <span class="comment">         * cresIcons       - number of resolutions in this file</span>
00978 <span class="comment">         *</span>
00979 <span class="comment">         * We only allow 1 &lt;= cresIcons &lt;= 10</span>
00980 <span class="comment">         */</span>
00981         <span class="keywordflow">if</span> ((magic[1] == <a class="code" href="../../d6/d0/extract_8c.html#a2">ICO_MAGIC1</a> || magic[1] == <a class="code" href="../../d6/d0/extract_8c.html#a3">CUR_MAGIC1</a>) &amp;&amp;
00982             magic[2] &gt;= 1 &amp;&amp; magic[2] &lt;= 10) {
00983 
00984             result = <a class="code" href="../../d6/d0/extract_8c.html#a39">ExtractIconFromICO</a>(achFileName,
00985                                         nIconIndex,
00986                                         cxIcon,
00987                                         cyIcon,
00988                                         phicon,
00989                                         flags);
00990         }
00991         <span class="keywordflow">break</span>;
00992     }
00993 
00994 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
00995 
00996     <span class="keywordflow">if</span> (hFile!=<a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
00997         CloseHandle(hFile);
00998 
00999     <span class="keywordflow">return</span> result;
01000 
01001     <span class="comment">/*</span>
01002 <span class="comment">     *  if we cant open the file, return a code saying we cant open the file</span>
01003 <span class="comment">     *  if phicon==NULL return the count of icons in the file 0</span>
01004 <span class="comment">     */</span>
01005 
01006 error_file:
01007 
01008     result = (phicon ? (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1 : 0);
01009 
01010     <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01011 }
01012 
01013 <span class="comment">/***************************************************************************\</span>
01014 <span class="comment">* PrivateExtractIconsA</span>
01015 <span class="comment">*</span>
01016 <span class="comment">*</span>
01017 <span class="comment">\***************************************************************************/</span>
01018 
<a name="l01019"></a><a class="code" href="../../d6/d0/extract_8c.html#a46">01019</a> WINUSERAPI <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d6/d0/extract_8c.html#a46">PrivateExtractIconsA</a>(
01020     LPCSTR szFileName,
01021     <span class="keywordtype">int</span>     nIconIndex,
01022     <span class="keywordtype">int</span>     cxIcon,
01023     <span class="keywordtype">int</span>     cyIcon,
01024     HICON   *phicon,
01025     UINT    *piconid,
01026     UINT    nIcons,
01027     UINT    flags)
01028 {
01029     LPWSTR szFileNameW;
01030     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uRet;
01031 
01032     <span class="keywordflow">if</span> (!MBToWCS(szFileName, -1, &amp;szFileNameW, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
01033         <span class="keywordflow">return</span> 0;
01034 
01035     uRet = <a class="code" href="../../d6/d0/extract_8c.html#a45">PrivateExtractIconsW</a>(szFileNameW,
01036                                 nIconIndex,
01037                                 cxIcon,
01038                                 cyIcon,
01039                                 phicon,
01040                                 piconid,
01041                                 nIcons,
01042                                 flags);
01043 
01044     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(szFileNameW);
01045 
01046     <span class="keywordflow">return</span> uRet;
01047 }
01048 
01049 <span class="comment">/***************************************************************************\</span>
01050 <span class="comment">* PrivateExtractIconExW</span>
01051 <span class="comment">*</span>
01052 <span class="comment">* extracts 1 or more icons from a file.</span>
01053 <span class="comment">*</span>
01054 <span class="comment">* input:</span>
01055 <span class="comment">*     szFileName          - EXE/DLL/ICO file to extract from</span>
01056 <span class="comment">*     nIconIndex          - what icon to extract</span>
01057 <span class="comment">*                             0 = first icon, 1=second icon, etc.</span>
01058 <span class="comment">*                            -N = icon with id==N</span>
01059 <span class="comment">*     phiconLarge         - place to return extracted icon(s)</span>
01060 <span class="comment">*     phiconSmall         - place to return extracted icon(s) (small size)</span>
01061 <span class="comment">*     nIcons              - number of icons to extract.</span>
01062 <span class="comment">*</span>
01063 <span class="comment">* returns:</span>
01064 <span class="comment">*     number of icons extracted, or the count of icons if phiconLarge==NULL</span>
01065 <span class="comment">*</span>
01066 <span class="comment">* notes:</span>
01067 <span class="comment">*     handles extraction from PE (Win32), NE (Win16), and ICO (Icon) files.</span>
01068 <span class="comment">*     only Win16 3.x files are supported (not 2.x)</span>
01069 <span class="comment">*</span>
01070 <span class="comment">\***************************************************************************/</span>
01071 
<a name="l01072"></a><a class="code" href="../../d6/d0/extract_8c.html#a47">01072</a> WINUSERAPI <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d0/extract_8c.html#a47">PrivateExtractIconExW</a>(
01073     LPCWSTR szFileName,
01074     <span class="keywordtype">int</span>     nIconIndex,
01075     HICON   *phiconLarge,
01076     HICON   *phiconSmall,
01077     UINT    nIcons)
01078 {
01079     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> result = 0;
01080 
01081     <span class="keywordflow">if</span> ((nIconIndex == -1) || ((phiconLarge == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phiconSmall == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)))
01082         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/extract_8c.html#a45">PrivateExtractIconsW</a>(szFileName, 0, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0);
01083 
01084     <span class="keywordflow">if</span> (phiconLarge &amp;&amp; phiconSmall &amp;&amp; (nIcons == 1)) {
01085 
01086         HICON ahicon[2];
01087 
01088         ahicon[0] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01089         ahicon[1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01090 
01091         result = <a class="code" href="../../d6/d0/extract_8c.html#a45">PrivateExtractIconsW</a>(szFileName,
01092                                       nIconIndex,
01093                                       MAKELONG(<a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXICON),
01094                                                <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXSMICON)),
01095                                       MAKELONG(<a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYICON),
01096                                                <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYSMICON)),
01097                                       ahicon,
01098                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01099                                       2,
01100                                       0);
01101 
01102         *phiconLarge = ahicon[0];
01103         *phiconSmall = ahicon[1];
01104 
01105     } <span class="keywordflow">else</span> {
01106 
01107         <span class="keywordflow">if</span> (phiconLarge)
01108             result = <a class="code" href="../../d6/d0/extract_8c.html#a45">PrivateExtractIconsW</a>(szFileName,
01109                                           nIconIndex,
01110                                           <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXICON),
01111                                           <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYICON),
01112                                           phiconLarge,
01113                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01114                                           nIcons,
01115                                           0);
01116 
01117         <span class="keywordflow">if</span> (phiconSmall)
01118             result = <a class="code" href="../../d6/d0/extract_8c.html#a45">PrivateExtractIconsW</a>(szFileName,
01119                                           nIconIndex,
01120                                           <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXSMICON),
01121                                           <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYSMICON),
01122                                           phiconSmall,
01123                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01124                                           nIcons,
01125                                           0);
01126     }
01127 
01128     <span class="keywordflow">return</span> result;
01129 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:58 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
