<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psctxmip.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psctxmip.c</h1><a href="../../d6/d0/psctxmip_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    psctxmip.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements function to get and set the context of a thread.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    David N. Cutler (davec) 1-Oct-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/psp_8h.html">psp.h</a>"</span>
00022 
00023 ULONGLONG
<a name="l00024"></a><a class="code" href="../../d6/d0/psctxmip_8c.html#a0">00024</a> <a class="code" href="../../d6/d0/psctxmip_8c.html#a0">PspGetSavedValue</a> (
00025     IN PVOID ContextPointer
00026     )
00027 
00028 <span class="comment">/*++</span>
00029 <span class="comment"></span>
00030 <span class="comment">Routine Description:</span>
00031 <span class="comment"></span>
00032 <span class="comment">    This function loads the context value specified by the argument</span>
00033 <span class="comment">    pointer.</span>
00034 <span class="comment"></span>
00035 <span class="comment">    N.B. The low bit of the pointer specifies the operand type.</span>
00036 <span class="comment"></span>
00037 <span class="comment">Arguments:</span>
00038 <span class="comment"></span>
00039 <span class="comment">    ContextPointer - Supplies a pointer to the context value that is</span>
00040 <span class="comment">        loaded.</span>
00041 <span class="comment"></span>
00042 <span class="comment">Return Value:</span>
00043 <span class="comment"></span>
00044 <span class="comment">    The value specified by the argument pointer.</span>
00045 <span class="comment"></span>
00046 <span class="comment">--*/</span>
00047 
00048 {
00049 
00050     <span class="comment">//</span>
00051     <span class="comment">// If the low bit of the argument pointer is zero, then the argument</span>
00052     <span class="comment">// value is 32-bits. Otherwise, the argument value is 64-bits.</span>
00053     <span class="comment">//</span>
00054 
00055     <span class="keywordflow">if</span> (((ULONG)ContextPointer &amp; 1) != 0) {
00056         <span class="keywordflow">return</span> *((PULONGLONG)((ULONG)ContextPointer &amp; ~1));
00057 
00058     } <span class="keywordflow">else</span> {
00059         <span class="keywordflow">return</span> *((PLONG)ContextPointer);
00060     }
00061 }
00062 
00063 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00064"></a><a class="code" href="../../d6/d0/psctxmip_8c.html#a1">00064</a> <a class="code" href="../../d6/d0/psctxmip_8c.html#a1">PspSetSavedValue</a> (
00065     IN ULONGLONG ContextValue,
00066     IN PVOID ContextPointer
00067     )
00068 
00069 <span class="comment">/*++</span>
00070 <span class="comment"></span>
00071 <span class="comment">Routine Description:</span>
00072 <span class="comment"></span>
00073 <span class="comment">    This function stores the context value specified in the location</span>
00074 <span class="comment">    specified by the argument pointer.</span>
00075 <span class="comment"></span>
00076 <span class="comment">    N.B. The low bit of the pointer specifies the operand type.</span>
00077 <span class="comment"></span>
00078 <span class="comment">Arguments:</span>
00079 <span class="comment"></span>
00080 <span class="comment">    ContextValue - Supplies the context value to be stored.</span>
00081 <span class="comment"></span>
00082 <span class="comment">    ContextPointer - Supplies a pointer to the context value that is</span>
00083 <span class="comment">        stored.</span>
00084 <span class="comment"></span>
00085 <span class="comment">Return Value:</span>
00086 <span class="comment"></span>
00087 <span class="comment">    None.</span>
00088 <span class="comment"></span>
00089 <span class="comment">--*/</span>
00090 
00091 {
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// If the low bit of the argument pointer is zero, then the argument</span>
00095     <span class="comment">// value is 32-bits. Otherwise, the argument value is 64-bits.</span>
00096     <span class="comment">//</span>
00097 
00098     <span class="keywordflow">if</span> (((ULONG)ContextPointer &amp; 1) != 0) {
00099         *((PULONGLONG)((ULONG)ContextPointer &amp; ~1)) = ContextValue;
00100 
00101     } <span class="keywordflow">else</span> {
00102         *((PULONG)ContextPointer) = (ULONG)ContextValue;
00103     }
00104 }
00105 
00106 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00107"></a><a class="code" href="../../d6/d0/psctxmip_8c.html#a2">00107</a> <a class="code" href="../../d8/d1/psp_8h.html#a73">PspGetContext</a> (
00108     IN PKTRAP_FRAME TrapFrame,
00109     IN PKNONVOLATILE_CONTEXT_POINTERS ContextPointers,
00110     IN OUT PCONTEXT ContextRecord
00111     )
00112 
00113 <span class="comment">/*++</span>
00114 <span class="comment"></span>
00115 <span class="comment">Routine Description:</span>
00116 <span class="comment"></span>
00117 <span class="comment">    This function selectively moves the contents of the specified trap frame</span>
00118 <span class="comment">    and nonvolatile context to the specified context record.</span>
00119 <span class="comment"></span>
00120 <span class="comment">Arguments:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00123 <span class="comment"></span>
00124 <span class="comment">    ContextPointers - Supplies the address of context pointers record.</span>
00125 <span class="comment"></span>
00126 <span class="comment">    ContextRecord - Supplies the address of a context record.</span>
00127 <span class="comment"></span>
00128 <span class="comment">Return Value:</span>
00129 <span class="comment"></span>
00130 <span class="comment">    None.</span>
00131 <span class="comment"></span>
00132 <span class="comment">--*/</span>
00133 
00134 {
00135 
00136     ULONG ContextFlags;
00137     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00138 
00139     <span class="comment">//</span>
00140     <span class="comment">// Get context.</span>
00141     <span class="comment">//</span>
00142 
00143     ContextFlags = ContextRecord-&gt;ContextFlags;
00144     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">// Get integer registers gp, sp, ra, FIR, and PSR.</span>
00148         <span class="comment">//</span>
00149 
00150         ContextRecord-&gt;Fir = TrapFrame-&gt;Fir;
00151         ContextRecord-&gt;Psr = TrapFrame-&gt;Psr;
00152         <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00153             ContextRecord-&gt;IntGp = (ULONG)TrapFrame-&gt;XIntGp;
00154             ContextRecord-&gt;IntSp = (ULONG)TrapFrame-&gt;XIntSp;
00155             ContextRecord-&gt;IntRa = (ULONG)TrapFrame-&gt;XIntRa;
00156 
00157         } <span class="keywordflow">else</span> {
00158             ContextRecord-&gt;XIntGp = TrapFrame-&gt;XIntGp;
00159             ContextRecord-&gt;XIntSp = TrapFrame-&gt;XIntSp;
00160             ContextRecord-&gt;XIntRa = TrapFrame-&gt;XIntRa;
00161         }
00162     }
00163 
00164     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00165 
00166         <span class="comment">//</span>
00167         <span class="comment">// Get integer registers zero, and, at - t9, k0, k1, lo, and hi.</span>
00168         <span class="comment">//</span>
00169 
00170         <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00171             ContextRecord-&gt;IntZero = 0;
00172             ContextRecord-&gt;IntAt = (ULONG)TrapFrame-&gt;XIntAt;
00173             ContextRecord-&gt;IntV0 = (ULONG)TrapFrame-&gt;XIntV0;
00174             ContextRecord-&gt;IntV1 = (ULONG)TrapFrame-&gt;XIntV1;
00175             ContextRecord-&gt;IntA0 = (ULONG)TrapFrame-&gt;XIntA0;
00176             ContextRecord-&gt;IntA1 = (ULONG)TrapFrame-&gt;XIntA1;
00177             ContextRecord-&gt;IntA2 = (ULONG)TrapFrame-&gt;XIntA2;
00178             ContextRecord-&gt;IntA3 = (ULONG)TrapFrame-&gt;XIntA3;
00179             ContextRecord-&gt;IntT0 = (ULONG)TrapFrame-&gt;XIntT0;
00180             ContextRecord-&gt;IntT1 = (ULONG)TrapFrame-&gt;XIntT1;
00181             ContextRecord-&gt;IntT2 = (ULONG)TrapFrame-&gt;XIntT2;
00182             ContextRecord-&gt;IntT3 = (ULONG)TrapFrame-&gt;XIntT3;
00183             ContextRecord-&gt;IntT4 = (ULONG)TrapFrame-&gt;XIntT4;
00184             ContextRecord-&gt;IntT5 = (ULONG)TrapFrame-&gt;XIntT5;
00185             ContextRecord-&gt;IntT6 = (ULONG)TrapFrame-&gt;XIntT6;
00186             ContextRecord-&gt;IntT7 = (ULONG)TrapFrame-&gt;XIntT7;
00187             ContextRecord-&gt;IntT8 = (ULONG)TrapFrame-&gt;XIntT8;
00188             ContextRecord-&gt;IntT9 = (ULONG)TrapFrame-&gt;XIntT9;
00189             ContextRecord-&gt;IntK0 = 0;
00190             ContextRecord-&gt;IntK1 = 0;
00191             ContextRecord-&gt;IntLo = (ULONG)TrapFrame-&gt;XIntLo;
00192             ContextRecord-&gt;IntHi = (ULONG)TrapFrame-&gt;XIntHi;
00193 
00194         } <span class="keywordflow">else</span> {
00195             ContextRecord-&gt;XIntZero = 0;
00196             ContextRecord-&gt;XIntAt = TrapFrame-&gt;XIntAt;
00197             ContextRecord-&gt;XIntV0 = TrapFrame-&gt;XIntV0;
00198             ContextRecord-&gt;XIntV1 = TrapFrame-&gt;XIntV1;
00199             ContextRecord-&gt;XIntA0 = TrapFrame-&gt;XIntA0;
00200             ContextRecord-&gt;XIntA1 = TrapFrame-&gt;XIntA1;
00201             ContextRecord-&gt;XIntA2 = TrapFrame-&gt;XIntA2;
00202             ContextRecord-&gt;XIntA3 = TrapFrame-&gt;XIntA3;
00203             ContextRecord-&gt;XIntT0 = TrapFrame-&gt;XIntT0;
00204             ContextRecord-&gt;XIntT1 = TrapFrame-&gt;XIntT1;
00205             ContextRecord-&gt;XIntT2 = TrapFrame-&gt;XIntT2;
00206             ContextRecord-&gt;XIntT3 = TrapFrame-&gt;XIntT3;
00207             ContextRecord-&gt;XIntT4 = TrapFrame-&gt;XIntT4;
00208             ContextRecord-&gt;XIntT5 = TrapFrame-&gt;XIntT5;
00209             ContextRecord-&gt;XIntT6 = TrapFrame-&gt;XIntT6;
00210             ContextRecord-&gt;XIntT7 = TrapFrame-&gt;XIntT7;
00211             ContextRecord-&gt;XIntT8 = TrapFrame-&gt;XIntT8;
00212             ContextRecord-&gt;XIntT9 = TrapFrame-&gt;XIntT9;
00213             ContextRecord-&gt;XIntK0 = 0;
00214             ContextRecord-&gt;XIntK1 = 0;
00215             ContextRecord-&gt;XIntLo = TrapFrame-&gt;XIntLo;
00216             ContextRecord-&gt;XIntHi = TrapFrame-&gt;XIntHi;
00217         }
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">// Get nonvolatile integer registers s0 - s7, and s8.</span>
00221         <span class="comment">//</span>
00222 
00223         <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00224             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 7;
00225             <span class="keywordflow">do</span> {
00226                 <span class="keywordflow">if</span> (TrapFrame-&gt;SavedFlag == 0) {
00227                     (&amp;ContextRecord-&gt;IntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] =
00228                         (ULONG)<a class="code" href="../../d6/d0/psctxmip_8c.html#a0">PspGetSavedValue</a>((&amp;ContextPointers-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00229 
00230                 } <span class="keywordflow">else</span> {
00231                     (&amp;ContextRecord-&gt;IntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = (ULONG)(&amp;TrapFrame-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00232                 }
00233 
00234                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> -= 1;
00235             } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= 0);
00236             ContextRecord-&gt;IntS8 = (ULONG)TrapFrame-&gt;XIntS8;
00237 
00238         } <span class="keywordflow">else</span> {
00239             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 7;
00240             <span class="keywordflow">do</span> {
00241                 <span class="keywordflow">if</span> (TrapFrame-&gt;SavedFlag == 0) {
00242                     (&amp;ContextRecord-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] =
00243                         <a class="code" href="../../d6/d0/psctxmip_8c.html#a0">PspGetSavedValue</a>((&amp;ContextPointers-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00244 
00245                 } <span class="keywordflow">else</span> {
00246                     (&amp;ContextRecord-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = (&amp;TrapFrame-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00247                 }
00248 
00249                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> -= 1;
00250             } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= 0);
00251             ContextRecord-&gt;XIntS8 = TrapFrame-&gt;XIntS8;
00252         }
00253     }
00254 
00255     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">// Get volatile floating registers f0 - f19.</span>
00259         <span class="comment">//</span>
00260 
00261         RtlMoveMemory(&amp;ContextRecord-&gt;FltF0, &amp;TrapFrame-&gt;FltF0,
00262                      <span class="keyword">sizeof</span>(ULONG) * (20));
00263 
00264         <span class="comment">//</span>
00265         <span class="comment">// Get nonvolatile floating registers f20 - f31.</span>
00266         <span class="comment">//</span>
00267 
00268         ContextRecord-&gt;FltF20 = *ContextPointers-&gt;FltF20;
00269         ContextRecord-&gt;FltF21 = *ContextPointers-&gt;FltF21;
00270         ContextRecord-&gt;FltF22 = *ContextPointers-&gt;FltF22;
00271         ContextRecord-&gt;FltF23 = *ContextPointers-&gt;FltF23;
00272         ContextRecord-&gt;FltF24 = *ContextPointers-&gt;FltF24;
00273         ContextRecord-&gt;FltF25 = *ContextPointers-&gt;FltF25;
00274         ContextRecord-&gt;FltF26 = *ContextPointers-&gt;FltF26;
00275         ContextRecord-&gt;FltF27 = *ContextPointers-&gt;FltF27;
00276         ContextRecord-&gt;FltF28 = *ContextPointers-&gt;FltF28;
00277         ContextRecord-&gt;FltF29 = *ContextPointers-&gt;FltF29;
00278         ContextRecord-&gt;FltF30 = *ContextPointers-&gt;FltF30;
00279         ContextRecord-&gt;FltF31 = *ContextPointers-&gt;FltF31;
00280 
00281         <span class="comment">//</span>
00282         <span class="comment">// Get floating status register.</span>
00283         <span class="comment">//</span>
00284 
00285         ContextRecord-&gt;Fsr = TrapFrame-&gt;Fsr;
00286     }
00287 
00288     <span class="keywordflow">return</span>;
00289 }
00290 
00291 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00292"></a><a class="code" href="../../d6/d0/psctxmip_8c.html#a3">00292</a> <a class="code" href="../../d8/d1/psp_8h.html#a72">PspSetContext</a> (
00293     IN OUT PKTRAP_FRAME TrapFrame,
00294     IN PKNONVOLATILE_CONTEXT_POINTERS ContextPointers,
00295     IN PCONTEXT ContextRecord,
00296     IN KPROCESSOR_MODE ProcessorMode
00297     )
00298 
00299 <span class="comment">/*++</span>
00300 <span class="comment"></span>
00301 <span class="comment">Routine Description:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    This function selectively moves the contents of the specified context</span>
00304 <span class="comment">    record to the specified trap frame and nonvolatile context.</span>
00305 <span class="comment"></span>
00306 <span class="comment">Arguments:</span>
00307 <span class="comment"></span>
00308 <span class="comment">    TrapFrame - Supplies the address of a trap frame.</span>
00309 <span class="comment"></span>
00310 <span class="comment">    ContextPointers - Supplies the address of a context pointers record.</span>
00311 <span class="comment"></span>
00312 <span class="comment">    ContextRecord - Supplies the address of a context record.</span>
00313 <span class="comment"></span>
00314 <span class="comment">    ProcessorMode - Supplies the processor mode to use when sanitizing</span>
00315 <span class="comment">        the PSR and FSR.</span>
00316 <span class="comment"></span>
00317 <span class="comment">Return Value:</span>
00318 <span class="comment"></span>
00319 <span class="comment">    None.</span>
00320 <span class="comment"></span>
00321 <span class="comment">--*/</span>
00322 
00323 {
00324 
00325     ULONG ContextFlags;
00326     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// Set context.</span>
00330     <span class="comment">//</span>
00331 
00332     ContextFlags = ContextRecord-&gt;ContextFlags;
00333     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00334 
00335         <span class="comment">//</span>
00336         <span class="comment">// Set integer registers gp, sp, ra, FIR, and PSR.</span>
00337         <span class="comment">//</span>
00338 
00339         TrapFrame-&gt;Fir = ContextRecord-&gt;Fir;
00340         TrapFrame-&gt;Psr = SANITIZE_PSR(ContextRecord-&gt;Psr, ProcessorMode);
00341         <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00342             TrapFrame-&gt;XIntGp = (LONG)ContextRecord-&gt;IntGp;
00343             TrapFrame-&gt;XIntSp = (LONG)ContextRecord-&gt;IntSp;
00344             TrapFrame-&gt;XIntRa = (LONG)ContextRecord-&gt;IntRa;
00345 
00346         } <span class="keywordflow">else</span> {
00347             TrapFrame-&gt;XIntGp = ContextRecord-&gt;XIntGp;
00348             TrapFrame-&gt;XIntSp = ContextRecord-&gt;XIntSp;
00349             TrapFrame-&gt;XIntRa = ContextRecord-&gt;XIntRa;
00350         }
00351     }
00352 
00353     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00354 
00355         <span class="comment">//</span>
00356         <span class="comment">// Set integer registers at - t9, lo, and hi.</span>
00357         <span class="comment">//</span>
00358 
00359         <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00360             TrapFrame-&gt;XIntAt = (LONG)ContextRecord-&gt;IntAt;
00361             TrapFrame-&gt;XIntV0 = (LONG)ContextRecord-&gt;IntV0;
00362             TrapFrame-&gt;XIntV1 = (LONG)ContextRecord-&gt;IntV1;
00363             TrapFrame-&gt;XIntA0 = (LONG)ContextRecord-&gt;IntA0;
00364             TrapFrame-&gt;XIntA1 = (LONG)ContextRecord-&gt;IntA1;
00365             TrapFrame-&gt;XIntA2 = (LONG)ContextRecord-&gt;IntA2;
00366             TrapFrame-&gt;XIntA3 = (LONG)ContextRecord-&gt;IntA3;
00367             TrapFrame-&gt;XIntT0 = (LONG)ContextRecord-&gt;IntT0;
00368             TrapFrame-&gt;XIntT1 = (LONG)ContextRecord-&gt;IntT1;
00369             TrapFrame-&gt;XIntT2 = (LONG)ContextRecord-&gt;IntT2;
00370             TrapFrame-&gt;XIntT3 = (LONG)ContextRecord-&gt;IntT3;
00371             TrapFrame-&gt;XIntT4 = (LONG)ContextRecord-&gt;IntT4;
00372             TrapFrame-&gt;XIntT5 = (LONG)ContextRecord-&gt;IntT5;
00373             TrapFrame-&gt;XIntT6 = (LONG)ContextRecord-&gt;IntT6;
00374             TrapFrame-&gt;XIntT7 = (LONG)ContextRecord-&gt;IntT7;
00375             TrapFrame-&gt;XIntT8 = (LONG)ContextRecord-&gt;IntT8;
00376             TrapFrame-&gt;XIntT9 = (LONG)ContextRecord-&gt;IntT9;
00377             TrapFrame-&gt;XIntLo = (LONG)ContextRecord-&gt;IntLo;
00378             TrapFrame-&gt;XIntHi = (LONG)ContextRecord-&gt;IntHi;
00379 
00380         } <span class="keywordflow">else</span> {
00381             TrapFrame-&gt;XIntAt = ContextRecord-&gt;XIntAt;
00382             TrapFrame-&gt;XIntV0 = ContextRecord-&gt;XIntV0;
00383             TrapFrame-&gt;XIntV1 = ContextRecord-&gt;XIntV1;
00384             TrapFrame-&gt;XIntA0 = ContextRecord-&gt;XIntA0;
00385             TrapFrame-&gt;XIntA1 = ContextRecord-&gt;XIntA1;
00386             TrapFrame-&gt;XIntA2 = ContextRecord-&gt;XIntA2;
00387             TrapFrame-&gt;XIntA3 = ContextRecord-&gt;XIntA3;
00388             TrapFrame-&gt;XIntT0 = ContextRecord-&gt;XIntT0;
00389             TrapFrame-&gt;XIntT1 = ContextRecord-&gt;XIntT1;
00390             TrapFrame-&gt;XIntT2 = ContextRecord-&gt;XIntT2;
00391             TrapFrame-&gt;XIntT3 = ContextRecord-&gt;XIntT3;
00392             TrapFrame-&gt;XIntT4 = ContextRecord-&gt;XIntT4;
00393             TrapFrame-&gt;XIntT5 = ContextRecord-&gt;XIntT5;
00394             TrapFrame-&gt;XIntT6 = ContextRecord-&gt;XIntT6;
00395             TrapFrame-&gt;XIntT7 = ContextRecord-&gt;XIntT7;
00396             TrapFrame-&gt;XIntT8 = ContextRecord-&gt;XIntT8;
00397             TrapFrame-&gt;XIntT9 = ContextRecord-&gt;XIntT9;
00398             TrapFrame-&gt;XIntLo = ContextRecord-&gt;XIntLo;
00399             TrapFrame-&gt;XIntHi = ContextRecord-&gt;XIntHi;
00400         }
00401 
00402         <span class="comment">//</span>
00403         <span class="comment">// Set nonvolatile integer registers s0 - s7, and s8.</span>
00404         <span class="comment">//</span>
00405 
00406         <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00407             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 7;
00408             <span class="keywordflow">do</span> {
00409                 <span class="keywordflow">if</span> (TrapFrame-&gt;SavedFlag == 0) {
00410                     <a class="code" href="../../d6/d0/psctxmip_8c.html#a1">PspSetSavedValue</a>((LONG)(&amp;ContextRecord-&gt;IntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],
00411                                      (&amp;ContextPointers-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00412 
00413                 } <span class="keywordflow">else</span> {
00414                     (&amp;TrapFrame-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = (LONG)(&amp;ContextRecord-&gt;IntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00415                 }
00416 
00417                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> -= 1;
00418             } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= 0);
00419             TrapFrame-&gt;XIntS8 = (LONG)ContextRecord-&gt;IntS8;
00420 
00421         } <span class="keywordflow">else</span> {
00422             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 7;
00423             <span class="keywordflow">do</span> {
00424                 <span class="keywordflow">if</span> (TrapFrame-&gt;SavedFlag == 0) {
00425                     <a class="code" href="../../d6/d0/psctxmip_8c.html#a1">PspSetSavedValue</a>((&amp;ContextRecord-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],
00426                                      (&amp;ContextPointers-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00427 
00428                 } <span class="keywordflow">else</span> {
00429                     (&amp;TrapFrame-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = (&amp;ContextRecord-&gt;XIntS0)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00430                 }
00431 
00432                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> -= 1;
00433             } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= 0);
00434             TrapFrame-&gt;XIntS8 = ContextRecord-&gt;XIntS8;
00435         }
00436     }
00437 
00438     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00439 
00440         <span class="comment">//</span>
00441         <span class="comment">// Set volatile floating registers f0 - f19.</span>
00442         <span class="comment">//</span>
00443 
00444         RtlMoveMemory(&amp;TrapFrame-&gt;FltF0, &amp;ContextRecord-&gt;FltF0,
00445                      <span class="keyword">sizeof</span>(ULONG) * (20));
00446 
00447         <span class="comment">//</span>
00448         <span class="comment">// Set nonvolatile floating registers f20 - f31.</span>
00449         <span class="comment">//</span>
00450 
00451         *ContextPointers-&gt;FltF20 = ContextRecord-&gt;FltF20;
00452         *ContextPointers-&gt;FltF21 = ContextRecord-&gt;FltF21;
00453         *ContextPointers-&gt;FltF22 = ContextRecord-&gt;FltF22;
00454         *ContextPointers-&gt;FltF23 = ContextRecord-&gt;FltF23;
00455         *ContextPointers-&gt;FltF24 = ContextRecord-&gt;FltF24;
00456         *ContextPointers-&gt;FltF25 = ContextRecord-&gt;FltF25;
00457         *ContextPointers-&gt;FltF26 = ContextRecord-&gt;FltF26;
00458         *ContextPointers-&gt;FltF27 = ContextRecord-&gt;FltF27;
00459         *ContextPointers-&gt;FltF28 = ContextRecord-&gt;FltF28;
00460         *ContextPointers-&gt;FltF29 = ContextRecord-&gt;FltF29;
00461         *ContextPointers-&gt;FltF30 = ContextRecord-&gt;FltF30;
00462         *ContextPointers-&gt;FltF31 = ContextRecord-&gt;FltF31;
00463 
00464         <span class="comment">//</span>
00465         <span class="comment">// Set floating status register.</span>
00466         <span class="comment">//</span>
00467 
00468         TrapFrame-&gt;Fsr = SANITIZE_FSR(ContextRecord-&gt;Fsr, ProcessorMode);
00469     }
00470 
00471     <span class="keywordflow">return</span>;
00472 }
00473 
00474 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00475"></a><a class="code" href="../../d6/d0/psctxmip_8c.html#a4">00475</a> <a class="code" href="../../d8/d1/psp_8h.html#a74">PspGetSetContextSpecialApc</a> (
00476     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00477     IN PKNORMAL_ROUTINE *NormalRoutine,
00478     IN PVOID *NormalContext,
00479     IN PVOID *SystemArgument1,
00480     IN PVOID *SystemArgument2
00481     )
00482 
00483 <span class="comment">/*++</span>
00484 <span class="comment"></span>
00485 <span class="comment">Routine Description:</span>
00486 <span class="comment"></span>
00487 <span class="comment">    This function either captures the user mode state of the current</span>
00488 <span class="comment">    thread, or sets the user mode state of the current thread. The</span>
00489 <span class="comment">    operation type is determined by the value of SystemArgument1. A</span>
00490 <span class="comment">    zero value is used for get context, and a nonzero value is used</span>
00491 <span class="comment">    for set context.</span>
00492 <span class="comment"></span>
00493 <span class="comment">Arguments:</span>
00494 <span class="comment"></span>
00495 <span class="comment">    Apc - Supplies a pointer to the APC control object that caused entry</span>
00496 <span class="comment">          into this routine.</span>
00497 <span class="comment"></span>
00498 <span class="comment">    NormalRoutine - Supplies a pointer to the normal routine function that</span>
00499 <span class="comment">        was specified when the APC was initialized. This parameter is not</span>
00500 <span class="comment">        used.</span>
00501 <span class="comment"></span>
00502 <span class="comment">    NormalContext - Supplies a pointer to an arbitrary data structure that</span>
00503 <span class="comment">        was specified when the APC was initialized. This parameter is not</span>
00504 <span class="comment">        used.</span>
00505 <span class="comment"></span>
00506 <span class="comment">    SystemArgument1, SystemArgument2 - Supplies a set of two pointer to two</span>
00507 <span class="comment">        arguments that contain untyped data. These parameters are not used.</span>
00508 <span class="comment"></span>
00509 <span class="comment">Return Value:</span>
00510 <span class="comment"></span>
00511 <span class="comment">    None.</span>
00512 <span class="comment"></span>
00513 <span class="comment">--*/</span>
00514 
00515 {
00516 
00517     <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">PGETSETCONTEXT</a> ContextBlock;
00518     KNONVOLATILE_CONTEXT_POINTERS ContextPointers;
00519     CONTEXT ContextRecord;
00520     ULONG ControlPc;
00521     ULONG EstablisherFrame;
00522     PRUNTIME_FUNCTION FunctionEntry;
00523     BOOLEAN InFunction;
00524     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00525     ULONG TrapFrame1;
00526     ULONG TrapFrame2;
00527 
00528     <span class="comment">//</span>
00529     <span class="comment">// Get the address of the context block and compute the address of the</span>
00530     <span class="comment">// system entry trap frame.</span>
00531     <span class="comment">//</span>
00532 
00533     ContextBlock = CONTAINING_RECORD(Apc, <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a>, Apc);
00534     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00535     TrapFrame1 = (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> - KTRAP_FRAME_LENGTH;
00536     TrapFrame2 = (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> - KTRAP_FRAME_LENGTH - KTRAP_FRAME_ARGUMENTS;
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// Capture the current thread context and set the initial control PC</span>
00540     <span class="comment">// value.</span>
00541     <span class="comment">//</span>
00542 
00543     RtlCaptureContext(&amp;ContextRecord);
00544     ControlPc = (ULONG)ContextRecord.XIntRa;
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">// Initialize context pointers for the nonvolatile integer and floating</span>
00548     <span class="comment">// registers.</span>
00549     <span class="comment">//</span>
00550 
00551     ContextPointers.XIntS0 = &amp;ContextRecord.XIntS0;
00552     ContextPointers.XIntS1 = &amp;ContextRecord.XIntS1;
00553     ContextPointers.XIntS2 = &amp;ContextRecord.XIntS2;
00554     ContextPointers.XIntS3 = &amp;ContextRecord.XIntS3;
00555     ContextPointers.XIntS4 = &amp;ContextRecord.XIntS4;
00556     ContextPointers.XIntS5 = &amp;ContextRecord.XIntS5;
00557     ContextPointers.XIntS6 = &amp;ContextRecord.XIntS6;
00558     ContextPointers.XIntS7 = &amp;ContextRecord.XIntS7;
00559 
00560     ContextPointers.FltF20 = &amp;ContextRecord.FltF20;
00561     ContextPointers.FltF21 = &amp;ContextRecord.FltF21;
00562     ContextPointers.FltF22 = &amp;ContextRecord.FltF22;
00563     ContextPointers.FltF23 = &amp;ContextRecord.FltF23;
00564     ContextPointers.FltF24 = &amp;ContextRecord.FltF24;
00565     ContextPointers.FltF25 = &amp;ContextRecord.FltF25;
00566     ContextPointers.FltF26 = &amp;ContextRecord.FltF26;
00567     ContextPointers.FltF27 = &amp;ContextRecord.FltF27;
00568     ContextPointers.FltF28 = &amp;ContextRecord.FltF28;
00569     ContextPointers.FltF29 = &amp;ContextRecord.FltF29;
00570     ContextPointers.FltF30 = &amp;ContextRecord.FltF30;
00571     ContextPointers.FltF31 = &amp;ContextRecord.FltF31;
00572 
00573     <span class="comment">//</span>
00574     <span class="comment">// Start with the frame specified by the context record and virtually</span>
00575     <span class="comment">// unwind call frames until the system entry trap frame is encountered.</span>
00576     <span class="comment">//</span>
00577 
00578     <span class="keywordflow">do</span> {
00579 
00580         <span class="comment">//</span>
00581         <span class="comment">// Lookup the function table entry using the point at which control</span>
00582         <span class="comment">// left the procedure.</span>
00583         <span class="comment">//</span>
00584 
00585         FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc);
00586 
00587         <span class="comment">//</span>
00588         <span class="comment">// If there is a function table entry for the routine, then virtually</span>
00589         <span class="comment">// unwind to the caller of the current routine to obtain the address</span>
00590         <span class="comment">// where control left the caller. Otherwise, the function is a leaf</span>
00591         <span class="comment">// function and the return address register contains the address of</span>
00592         <span class="comment">// where control left the caller.</span>
00593         <span class="comment">//</span>
00594 
00595         <span class="keywordflow">if</span> (FunctionEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00596             ControlPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc | 1,
00597                                          FunctionEntry,
00598                                          &amp;ContextRecord,
00599                                          &amp;InFunction,
00600                                          &amp;EstablisherFrame,
00601                                          &amp;ContextPointers);
00602 
00603         } <span class="keywordflow">else</span> {
00604             ControlPc = (ULONG)ContextRecord.XIntRa;
00605         }
00606 
00607     } <span class="keywordflow">while</span> (((ULONG)ContextRecord.XIntSp != TrapFrame1) &amp;&amp;
00608              (((ULONG)ContextRecord.XIntSp != TrapFrame2) ||
00609              (ControlPc &lt; PCR-&gt;SystemServiceDispatchStart) ||
00610              (ControlPc &gt;= PCR-&gt;SystemServiceDispatchEnd)));
00611 
00612     <span class="comment">//</span>
00613     <span class="comment">// If system argument one is nonzero, then set the context of the current</span>
00614     <span class="comment">// thread. Otherwise, get the context of the current thread.</span>
00615     <span class="comment">//</span>
00616 
00617     <span class="keywordflow">if</span> (Apc-&gt;SystemArgument1 != 0) {
00618 
00619         <span class="comment">//</span>
00620         <span class="comment">// Set context of current thread.</span>
00621         <span class="comment">//</span>
00622 
00623         <a class="code" href="../../d8/d1/psp_8h.html#a72">PspSetContext</a>((PKTRAP_FRAME)TrapFrame1,
00624                       &amp;ContextPointers,
00625                       &amp;ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>,
00626                       ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o1">Mode</a>);
00627 
00628     } <span class="keywordflow">else</span> {
00629 
00630         <span class="comment">//</span>
00631         <span class="comment">// Get context of current thread.</span>
00632         <span class="comment">//</span>
00633 
00634         <a class="code" href="../../d8/d1/psp_8h.html#a73">PspGetContext</a>((PKTRAP_FRAME)TrapFrame1,
00635                       &amp;ContextPointers,
00636                       &amp;ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>);
00637     }
00638 
00639     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00640     <span class="keywordflow">return</span>;
00641 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:31 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
