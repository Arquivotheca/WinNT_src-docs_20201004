<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: heappage.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>heappage.h File Reference</h1><code>#include "<a class="el" href="../../d9/d8/heappagi_8h-source.html">heappagi.h</a>"</code><br>

<p>
<a href="../../d8/d8/heappage_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a0">DEBUG_PAGE_HEAP</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a1">HEAP_FLAG_PAGE_ALLOCS</a>&nbsp;&nbsp;&nbsp;0x01000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a2">HEAP_PROTECTION_ENABLED</a>&nbsp;&nbsp;&nbsp;0x02000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a3">HEAP_BREAK_WHEN_OUT_OF_VM</a>&nbsp;&nbsp;&nbsp;0x04000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a4">HEAP_NO_ALIGNMENT</a>&nbsp;&nbsp;&nbsp;0x08000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a5">IS_DEBUG_PAGE_HEAP_HANDLE</a>(<a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>)&nbsp;&nbsp;&nbsp;(((<a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)(<a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>))-&gt;ForceFlags &amp; HEAP_FLAG_PAGE_ALLOCS )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>(<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, ReturnThis)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a7">IF_DEBUG_PAGE_HEAP_THEN_CALL</a>(<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, CallThis)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a8">IF_DEBUG_PAGE_HEAP_THEN_BREAK</a>(<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, Text, ReturnThis)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a9">RtlpDebugPageHeapCreate</a> (IN ULONG Flags, IN PVOID HeapBase, IN SIZE_T ReserveSize, IN SIZE_T CommitSize, IN PVOID Lock, IN PRTL_HEAP_PARAMETERS Parameters)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a11">RtlpDebugPageHeapFree</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN PVOID Address)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a12">RtlpDebugPageHeapReAllocate</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN PVOID Address, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a13">RtlpDebugPageHeapDestroy</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a14">RtlpDebugPageHeapSize</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN PVOID Address)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a15">RtlpDebugPageHeapGetProcessHeaps</a> (ULONG NumberOfHeaps, PVOID *ProcessHeaps)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a16">RtlpDebugPageHeapCompact</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a17">RtlpDebugPageHeapValidate</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN PVOID Address)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a18">RtlpDebugPageHeapWalk</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN OUT PRTL_HEAP_WALK_ENTRY Entry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a19">RtlpDebugPageHeapLock</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a20">RtlpDebugPageHeapUnlock</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a21">RtlpDebugPageHeapSetUserValue</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN PVOID Address, IN PVOID UserValue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a22">RtlpDebugPageHeapGetUserInfo</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN PVOID Address, OUT PVOID *UserValue, OUT PULONG UserFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a23">RtlpDebugPageHeapSetUserFlags</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN PVOID Address, IN ULONG UserFlagsReset, IN ULONG UserFlagsSet)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a24">RtlpDebugPageHeapSerialize</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a25">RtlpDebugPageHeapExtend</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN PVOID Base, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a26">RtlpDebugPageHeapZero</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a27">RtlpDebugPageHeapReset</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a28">RtlpDebugPageHeapUsage</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN OUT PRTL_HEAP_USAGE Usage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a29">RtlpDebugPageHeapIsLocked</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/heappage_8h.html#a30">RtlpDebugPageHeapBreak</a> (PCH Text)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="heappage.h::DEBUG_PAGE_HEAP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEBUG_PAGE_HEAP&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/heappage_8h-source.html#l00017">17</a> of file <a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="heappage.h::HEAP_BREAK_WHEN_OUT_OF_VM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HEAP_BREAK_WHEN_OUT_OF_VM&nbsp;&nbsp;&nbsp;0x04000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/heappage_8h-source.html#l00050">50</a> of file <a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="heappage.h::HEAP_FLAG_PAGE_ALLOCS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HEAP_FLAG_PAGE_ALLOCS&nbsp;&nbsp;&nbsp;0x01000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/heappage_8h-source.html#l00047">47</a> of file <a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/heappage_8c-source.html#l01997">RtlpDebugPageHeapCreate()</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="heappage.h::HEAP_NO_ALIGNMENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HEAP_NO_ALIGNMENT&nbsp;&nbsp;&nbsp;0x08000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/heappage_8h-source.html#l00051">51</a> of file <a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l02336">RtlpDebugPageHeapAllocate()</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l01997">RtlpDebugPageHeapCreate()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="heappage.h::HEAP_PROTECTION_ENABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HEAP_PROTECTION_ENABLED&nbsp;&nbsp;&nbsp;0x02000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/heappage_8h-source.html#l00049">49</a> of file <a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01809">RtlpDebugPageHeapProtectStructures()</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l01839">RtlpDebugPageHeapUnProtectStructures()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="heappage.h::IF_DEBUG_PAGE_HEAP_THEN_BREAK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IF_DEBUG_PAGE_HEAP_THEN_BREAK          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Text,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ReturnThis&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                               \
            <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d9/heappage_8h.html#a5">IS_DEBUG_PAGE_HEAP_HANDLE</a>( Handle ))                       \
                {                                                           \
                <a class="code" href="../../d6/d9/heappage_8c.html#a90">RtlpDebugPageHeapBreak</a>( Text );                             \
                <span class="keywordflow">return</span> ReturnThis;                                          \
                }                                                           \
            }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d8/heappage_8h-source.html#l00077">77</a> of file <a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="heappage.h::IF_DEBUG_PAGE_HEAP_THEN_CALL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IF_DEBUG_PAGE_HEAP_THEN_CALL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>CallThis&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                               \
            <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d9/heappage_8h.html#a5">IS_DEBUG_PAGE_HEAP_HANDLE</a>( Handle ))                       \
                {                                                           \
                CallThis;                                                   \
                <span class="keywordflow">return</span>;                                                     \
                }                                                           \
            }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d8/heappage_8h-source.html#l00067">67</a> of file <a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="heappage.h::IF_DEBUG_PAGE_HEAP_THEN_RETURN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IF_DEBUG_PAGE_HEAP_THEN_RETURN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ReturnThis&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                               \
            <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d9/heappage_8h.html#a5">IS_DEBUG_PAGE_HEAP_HANDLE</a>( Handle ))                       \
                {                                                           \
                <span class="keywordflow">return</span> ReturnThis;                                          \
                }                                                           \
            }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d8/heappage_8h-source.html#l00058">58</a> of file <a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01260">RtlDebugCompactHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00919">RtlDebugGetUserInfoHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01086">RtlDebugSetUserFlagsHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01002">RtlDebugSetUserValueHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01177">RtlDebugSizeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01572">RtlDebugUsageHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01338">RtlDebugZeroHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02132">RtlExtendHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00390">RtlLockHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l06152">RtlpHeapIsLocked()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00323">RtlpSerializeHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01919">RtlQueryTagHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00454">RtlUnlockHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l03714">RtlWalkHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="heappage.h::IS_DEBUG_PAGE_HEAP_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IS_DEBUG_PAGE_HEAP_HANDLE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((<a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)(<a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>))-&gt;ForceFlags &amp; HEAP_FLAG_PAGE_ALLOCS )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/heappage_8h-source.html#l00054">54</a> of file <a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02530">RtlValidateHeap()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a10" doxytag="heappage.h::RtlpDebugPageHeapAllocate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID RtlpDebugPageHeapAllocate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l02336">2336</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d7/d8/heappage_8c-source.html#l00273">BUMP_GLOBAL_COUNTER</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00275">BUMP_SIZE_COUNTER</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00114">DEBUG_ASSERT</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00108">DEBUG_CODE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00258">DPH_DEBUG_BREAK_FOR_SIZE_ZERO</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00253">DPH_DEBUG_INTERNAL_VALIDATION</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d8/heappage_8h-source.html#l00051">HEAP_NO_ALIGNMENT</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00119">IF_GENERATE_EXCEPTION</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00164">IS_BIASED_POINTER</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00124">OUT_OF_VM_BREAK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00103">ROUNDUP2</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01571">RtlpDebugPageHeapAllocateNode()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00962">RtlpDebugPageHeapDecommitVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01358">RtlpDebugPageHeapFindAvailableMem()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01145">RtlpDebugPageHeapPlaceOnBusyList()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00831">RtlpDebugPageHeapProtectVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01080">RtlpDebugPageHeapRemoveFromAvailableList()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00263">RtlpDphDebugLevel</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05197">RtlpDphInternalValidatePageHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05026">RtlpDphLogStackTrace()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04403">RtlpDphNormalHeapAllocate()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l03906">RtlpDphShouldAllocateInPageHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00301">RtlpDphTraceDatabase</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04285">RtlpDphWritePageHeapBlockInformation()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00163">UNBIAS_POINTER</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l02895">RtlpDebugPageHeapReAllocate()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04386">RtlpDphDllcalloc()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04280">RtlpDphDllGlobalAlloc()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04100">RtlpDphDllHeapAlloc()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04195">RtlpDphDllLocalAlloc()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04369">RtlpDphDllmalloc()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04452">RtlpDphDllNew()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04482">RtlpDphDllNewArray()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04405">RtlpDphDllrealloc()</a>.
<p>
<pre class="fragment"><div>02341 {
02342     PDPH_HEAP_ROOT       HeapRoot;
02343     PDPH_HEAP_BLOCK pAvailNode;
02344     PDPH_HEAP_BLOCK pPrevAvailNode;
02345     PDPH_HEAP_BLOCK pBusyNode;
02346     SIZE_T               nBytesAllocate;
02347     SIZE_T               nBytesAccess;
02348     SIZE_T               nActual;
02349     PVOID                pVirtual;
02350     PVOID                pReturn;
02351     PUCHAR               pBlockHeader;
02352     ULONG Reason;
02353     BOOLEAN ForcePageHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02354 
02355     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/heappage_8c.html#a20">IS_BIASED_POINTER</a>(HeapHandle)) {
02356         <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = <a class="code" href="../../d6/d9/heappage_8c.html#a19">UNBIAS_POINTER</a>(HeapHandle);
02357         ForcePageHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02358     }
02359 
02360     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
02361     <span class="keywordflow">if</span> (HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02362         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02363 
02364     <span class="comment">//</span>
02365     <span class="comment">// Is zero size allocation ?</span>
02366     <span class="comment">//</span>
02367 
02368     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == 0) {
02369 
02370         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a28">DPH_DEBUG_BREAK_FOR_SIZE_ZERO</a>)) {
02371 
02372             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Page heap: request for zero sized block \n"</span>);
02373             DbgBreakPoint();
02374         }
02375     }
02376 
02377     <span class="comment">//</span>
02378     <span class="comment">// Get the heap lock.</span>
02379     <span class="comment">//</span>
02380 
02381     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
02382     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
02383 
02384     <span class="comment">//</span>
02385     <span class="comment">// We cannot validate the heap when a forced allocation into page heap</span>
02386     <span class="comment">// is requested due to accounting problems. Allocate is called in this way</span>
02387     <span class="comment">// from ReAllocate while the old node (just about to be freed) is in limbo</span>
02388     <span class="comment">// and is not accounted in any internal structure.</span>
02389     <span class="comment">//</span>
02390 
02391     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a23">DPH_DEBUG_INTERNAL_VALIDATION</a>) &amp;&amp; !ForcePageHeap) {
02392         <a class="code" href="../../d6/d9/heappage_8c.html#a106">RtlpDphInternalValidatePageHeap</a> (HeapRoot, NULL, 0);
02393     }
02394 
02395     Flags |= HeapRoot-&gt;HeapFlags;
02396 
02397     <span class="comment">//</span>
02398     <span class="comment">// Compute alloc statistics. Note that we need to</span>
02399     <span class="comment">// take the heap lock for this and unprotect the</span>
02400     <span class="comment">// heap structures.</span>
02401     <span class="comment">//</span>
02402 
02403     <a class="code" href="../../d6/d9/heappage_8c.html#a32">BUMP_GLOBAL_COUNTER</a> (DPH_COUNTER_NO_OF_ALLOCS);
02404     <a class="code" href="../../d6/d9/heappage_8c.html#a33">BUMP_SIZE_COUNTER</a> (Size);
02405 
02406     HeapRoot-&gt;Counter[DPH_COUNTER_NO_OF_ALLOCS] += 1;
02407 
02408     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; 1024) {
02409         <a class="code" href="../../d6/d9/heappage_8c.html#a32">BUMP_GLOBAL_COUNTER</a> (DPH_COUNTER_SIZE_BELOW_1K);
02410         HeapRoot-&gt;Counter[DPH_COUNTER_SIZE_BELOW_1K] += 1;
02411     }
02412     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; 4096) {
02413         <a class="code" href="../../d6/d9/heappage_8c.html#a32">BUMP_GLOBAL_COUNTER</a> (DPH_COUNTER_SIZE_BELOW_4K);
02414         HeapRoot-&gt;Counter[DPH_COUNTER_SIZE_BELOW_4K] += 1;
02415     }
02416     <span class="keywordflow">else</span> {
02417         <a class="code" href="../../d6/d9/heappage_8c.html#a32">BUMP_GLOBAL_COUNTER</a> (DPH_COUNTER_SIZE_ABOVE_4K);
02418         HeapRoot-&gt;Counter[DPH_COUNTER_SIZE_ABOVE_4K] += 1;
02419     }
02420 
02421     <span class="comment">//</span>
02422     <span class="comment">// Figure out if we need to minimize memory impact. This</span>
02423     <span class="comment">// might trigger an allocation in the normal heap.</span>
02424     <span class="comment">//</span>
02425 
02426     <span class="keywordflow">if</span> (! ForcePageHeap) {
02427         
02428         <span class="keywordflow">if</span> (! (<a class="code" href="../../d6/d9/heappage_8c.html#a88">RtlpDphShouldAllocateInPageHeap</a> (HeapRoot, Size))) {
02429 
02430             pReturn = <a class="code" href="../../d6/d9/heappage_8c.html#a69">RtlpDphNormalHeapAllocate</a> (
02431                 HeapRoot,
02432                 Flags,
02433                 Size); 
02434 
02435             <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
02436         }
02437     }
02438 
02439     <span class="comment">//</span>
02440     <span class="comment">// Check the heap a little bit on checked builds.</span>
02441     <span class="comment">//</span>
02442 
02443     <a class="code" href="../../d6/d9/heappage_8c.html#a9">DEBUG_CODE</a>( RtlpDebugPageHeapVerifyIntegrity( HeapRoot ));
02444 
02445     pReturn = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02446 
02447     <span class="comment">//</span>
02448     <span class="comment">//  Validate requested size so we don't overflow</span>
02449     <span class="comment">//  while rounding up size computations.  We do this</span>
02450     <span class="comment">//  after we've acquired the critsect so we can still</span>
02451     <span class="comment">//  catch serialization problems.</span>
02452     <span class="comment">//</span>
02453 
02454     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; 0x7FFF0000) {
02455         <a class="code" href="../../d6/d9/heappage_8c.html#a14">OUT_OF_VM_BREAK</a>( Flags, <span class="stringliteral">"Page heap: Invalid allocation size\n"</span> );
02456         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
02457     }
02458 
02459     <span class="comment">//</span>
02460     <span class="comment">//  Determine number of pages needed for READWRITE portion</span>
02461     <span class="comment">//  of allocation and add an extra page for the NO_ACCESS</span>
02462     <span class="comment">//  memory beyond the READWRITE page(s).</span>
02463     <span class="comment">//</span>
02464 
02465     nBytesAccess  = <a class="code" href="../../d6/d9/heappage_8c.html#a8">ROUNDUP2</a>( Size + <span class="keyword">sizeof</span>(DPH_BLOCK_INFORMATION), PAGE_SIZE );
02466     nBytesAllocate = nBytesAccess + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02467 
02468     <span class="comment">//</span>
02469     <span class="comment">//  RtlpDebugPageHeapFindAvailableMem will first attempt to satisfy</span>
02470     <span class="comment">//  the request from memory on the Available list.  If that fails,</span>
02471     <span class="comment">//  it will coalesce some of the Free list memory into the Available</span>
02472     <span class="comment">//  list and try again.  If that still fails, new VM is allocated and</span>
02473     <span class="comment">//  added to the Available list.  If that fails, the function will</span>
02474     <span class="comment">//  finally give up and return NULL.</span>
02475     <span class="comment">//</span>
02476 
02477     pAvailNode = <a class="code" href="../../d6/d9/heappage_8c.html#a120">RtlpDebugPageHeapFindAvailableMem</a>(
02478         HeapRoot,
02479         nBytesAllocate,
02480         &amp;pPrevAvailNode,
02481         TRUE
02482         );
02483 
02484     <span class="keywordflow">if</span> (pAvailNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02485         <a class="code" href="../../d6/d9/heappage_8c.html#a14">OUT_OF_VM_BREAK</a>( Flags, <span class="stringliteral">"Page heap: Unable to allocate virtual memory\n"</span> );
02486         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
02487     }
02488 
02489     <span class="comment">//</span>
02490     <span class="comment">//  Now can't call AllocateNode until pAvailNode is</span>
02491     <span class="comment">//  adjusted and/or removed from Avail list since AllocateNode</span>
02492     <span class="comment">//  might adjust the Avail list.</span>
02493     <span class="comment">//</span>
02494 
02495     pVirtual = pAvailNode-&gt;pVirtualBlock;
02496 
02497     <span class="keywordflow">if</span> (nBytesAccess &gt; 0) {
02498 
02499         <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_CATCH_BACKWARD_OVERRUNS)) {
02500 
02501             <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d9/heappage_8c.html#a98">RtlpDebugPageHeapProtectVM</a>( (PUCHAR)pVirtual + PAGE_SIZE, nBytesAccess, PAGE_READWRITE )) {
02502                 <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
02503             }
02504         }
02505         <span class="keywordflow">else</span> {
02506 
02507             <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d9/heappage_8c.html#a98">RtlpDebugPageHeapProtectVM</a>( pVirtual, nBytesAccess, PAGE_READWRITE )) {
02508                 <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
02509             }
02510         }
02511     }
02512 
02513     <span class="comment">//</span>
02514     <span class="comment">// If we use uncommitted ranges we need to decommit the protection</span>
02515     <span class="comment">// page at the end. BAckward overruns flag disables smart memory </span>
02516     <span class="comment">// usage flag.</span>
02517     <span class="comment">//</span>
02518 
02519     <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_CATCH_BACKWARD_OVERRUNS)) {
02520 
02521         <span class="comment">// nothing            </span>
02522 
02523     }
02524     <span class="keywordflow">else</span> {
02525 
02526         <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_SMART_MEMORY_USAGE)) {
02527 
02528             <a class="code" href="../../d6/d9/heappage_8c.html#a102">RtlpDebugPageHeapDecommitVM</a> (
02529                 (PCHAR)pVirtual + nBytesAccess, 
02530                 PAGE_SIZE);
02531         }
02532     }
02533 
02534     <span class="comment">//</span>
02535     <span class="comment">//  pAvailNode (still on avail list) points to block large enough</span>
02536     <span class="comment">//  to satisfy request, but it might be large enough to split</span>
02537     <span class="comment">//  into two blocks -- one for request, remainder leave on</span>
02538     <span class="comment">//  avail list.</span>
02539     <span class="comment">//</span>
02540 
02541     <span class="keywordflow">if</span> (pAvailNode-&gt;nVirtualBlockSize &gt; nBytesAllocate) {
02542 
02543         <span class="comment">//</span>
02544         <span class="comment">//  Adjust pVirtualBlock and nVirtualBlock size of existing</span>
02545         <span class="comment">//  node in avail list.  The node will still be in correct</span>
02546         <span class="comment">//  address space order on the avail list.  This saves having</span>
02547         <span class="comment">//  to remove and then re-add node to avail list.  Note since</span>
02548         <span class="comment">//  we're changing sizes directly, we need to adjust the</span>
02549         <span class="comment">//  avail and busy list counters manually.</span>
02550         <span class="comment">//</span>
02551         <span class="comment">//  Note: since we're leaving at least one page on the</span>
02552         <span class="comment">//  available list, we are guaranteed that AllocateNode</span>
02553         <span class="comment">//  will not fail.</span>
02554         <span class="comment">//</span>
02555 
02556         pAvailNode-&gt;pVirtualBlock                    += nBytesAllocate;
02557         pAvailNode-&gt;nVirtualBlockSize                -= nBytesAllocate;
02558         HeapRoot-&gt;nAvailableAllocationBytesCommitted -= nBytesAllocate;
02559 
02560         pBusyNode = <a class="code" href="../../d6/d9/heappage_8c.html#a123">RtlpDebugPageHeapAllocateNode</a>( HeapRoot );
02561 
02562         <a class="code" href="../../d6/d9/heappage_8c.html#a11">DEBUG_ASSERT</a>( pBusyNode != NULL );
02563 
02564         pBusyNode-&gt;pVirtualBlock     = pVirtual;
02565         pBusyNode-&gt;nVirtualBlockSize = nBytesAllocate;
02566 
02567     }
02568 
02569     <span class="keywordflow">else</span> {
02570 
02571         <span class="comment">//</span>
02572         <span class="comment">//  Entire avail block is needed, so simply remove it from avail list.</span>
02573         <span class="comment">//</span>
02574 
02575         <a class="code" href="../../d6/d9/heappage_8c.html#a110">RtlpDebugPageHeapRemoveFromAvailableList</a>( HeapRoot, pAvailNode, pPrevAvailNode );
02576 
02577         pBusyNode = pAvailNode;
02578 
02579     }
02580 
02581     <span class="comment">//</span>
02582     <span class="comment">//  Now pBusyNode points to our committed virtual block.</span>
02583     <span class="comment">//</span>
02584 
02585     <span class="keywordflow">if</span> (HeapRoot-&gt;HeapFlags &amp; <a class="code" href="../../d7/d9/heappage_8h.html#a4">HEAP_NO_ALIGNMENT</a>)
02586         nActual = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02587     <span class="keywordflow">else</span>
02588         nActual = <a class="code" href="../../d6/d9/heappage_8c.html#a8">ROUNDUP2</a>( Size, USER_ALIGNMENT );
02589 
02590     pBusyNode-&gt;nVirtualAccessSize = nBytesAccess;
02591     pBusyNode-&gt;nUserRequestedSize = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02592     pBusyNode-&gt;nUserActualSize    = nActual;
02593 
02594     <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_CATCH_BACKWARD_OVERRUNS)) {
02595 
02596         pBusyNode-&gt;pUserAllocation    = pBusyNode-&gt;pVirtualBlock
02597             + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02598     }
02599     <span class="keywordflow">else</span> {
02600 
02601         pBusyNode-&gt;pUserAllocation    = pBusyNode-&gt;pVirtualBlock
02602             + pBusyNode-&gt;nVirtualAccessSize
02603             - nActual;
02604     }
02605 
02606     pBusyNode-&gt;UserValue          = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02607     pBusyNode-&gt;UserFlags          = Flags &amp; HEAP_SETTABLE_USER_FLAGS;
02608 
02609     <span class="comment">//</span>
02610     <span class="comment">//  RtlpDebugPageHeapAllocate gets called from RtlDebugAllocateHeap,</span>
02611     <span class="comment">//  which gets called from RtlAllocateHeapSlowly, which gets called</span>
02612     <span class="comment">//  from RtlAllocateHeap.  To keep from wasting lots of stack trace</span>
02613     <span class="comment">//  storage, we'll skip the bottom 3 entries, leaving RtlAllocateHeap</span>
02614     <span class="comment">//  as the first recorded entry.</span>
02615     <span class="comment">//</span>
02616 
02617     <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_COLLECT_STACK_TRACES)) {
02618 
02619         pBusyNode-&gt;StackTrace = <a class="code" href="../../d6/d9/heappage_8c.html#a89">RtlpDphLogStackTrace</a>(3);
02620 
02621         <span class="keywordflow">if</span> (pBusyNode-&gt;StackTrace) {
02622 
02623             RtlTraceDatabaseLock (RtlpDphTraceDatabase);
02624             pBusyNode-&gt;StackTrace-&gt;UserCount += 1;
02625             pBusyNode-&gt;StackTrace-&gt;UserSize += pBusyNode-&gt;nUserRequestedSize;
02626             pBusyNode-&gt;StackTrace-&gt;UserContext = HeapRoot;
02627             RtlTraceDatabaseUnlock (RtlpDphTraceDatabase);
02628         }
02629     }
02630     <span class="keywordflow">else</span> {
02631         pBusyNode-&gt;StackTrace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02632     }
02633 
02634     <a class="code" href="../../d6/d9/heappage_8c.html#a114">RtlpDebugPageHeapPlaceOnBusyList</a>( HeapRoot, pBusyNode );
02635 
02636     pReturn = pBusyNode-&gt;pUserAllocation;
02637 
02638     <span class="comment">//</span>
02639     <span class="comment">//  For requests the specify HEAP_ZERO_MEMORY, we'll fill the</span>
02640     <span class="comment">//  user-requested portion of the block with zeros. For requests </span>
02641     <span class="comment">//  that don't specify HEAP_ZERO_MEMORY, we fill the whole user block</span>
02642     <span class="comment">//  with DPH_PAGE_BLOCK_INFIX.</span>
02643     <span class="comment">//</span>
02644 
02645     <span class="keywordflow">if</span> ((Flags &amp; HEAP_ZERO_MEMORY)) {
02646 
02647         <span class="comment">//</span>
02648         <span class="comment">// SilviuC: The call below can be saved if we have a way</span>
02649         <span class="comment">// to figure out if the memory for the block was freshly</span>
02650         <span class="comment">// virtual allocated (this is already zeroed). This has</span>
02651         <span class="comment">// an impact for large allocations.</span>
02652         <span class="comment">//</span>
02653 
02654         RtlZeroMemory( pBusyNode-&gt;pUserAllocation, Size );
02655     }
02656     <span class="keywordflow">else</span> {
02657 
02658         RtlFillMemory( pBusyNode-&gt;pUserAllocation, Size, DPH_PAGE_BLOCK_INFIX);
02659     }
02660 
02661     <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_CATCH_BACKWARD_OVERRUNS)) {
02662 
02663         <span class="comment">// nothing</span>
02664 
02665     }
02666     <span class="keywordflow">else</span> {
02667 
02668         <a class="code" href="../../d6/d9/heappage_8c.html#a82">RtlpDphWritePageHeapBlockInformation</a> (
02669             HeapRoot,
02670             pBusyNode-&gt;pUserAllocation,
02671             Size,
02672             nBytesAccess);
02673     }
02674 
02675     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>:
02676 
02677     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a23">DPH_DEBUG_INTERNAL_VALIDATION</a>) &amp;&amp; !ForcePageHeap) {
02678         <a class="code" href="../../d6/d9/heappage_8c.html#a106">RtlpDphInternalValidatePageHeap</a> (HeapRoot, NULL, 0);
02679     }
02680 
02681     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
02682     <a class="code" href="../../d6/d9/heappage_8c.html#a9">DEBUG_CODE</a>( RtlpDebugPageHeapVerifyIntegrity( HeapRoot ));
02683     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
02684 
02685     <span class="keywordflow">if</span> (pReturn == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02686         <a class="code" href="../../d6/d9/heappage_8c.html#a13">IF_GENERATE_EXCEPTION</a>( Flags, STATUS_NO_MEMORY );
02687     }
02688 
02689     <span class="keywordflow">return</span> pReturn;
02690 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="heappage.h::RtlpDebugPageHeapBreak" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpDebugPageHeapBreak           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCH&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Text</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/heappage_8c-source.html#l00618">RtlpDebugPageHeapAssert()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l03259">RtlpDebugPageHeapDestroy()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l03458">RtlpDebugPageHeapGetProcessHeaps()</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="heappage.h::RtlpDebugPageHeapCompact" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlpDebugPageHeapCompact           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03512">3512</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01260">RtlDebugCompactHeap()</a>.
<p>
<pre class="fragment"><div>03516 {
03517     PDPH_HEAP_ROOT HeapRoot;
03518 
03519     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03520     <span class="keywordflow">if</span> (HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03521         <span class="keywordflow">return</span> 0;
03522 
03523     Flags |= HeapRoot-&gt;HeapFlags;
03524 
03525     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
03526 
03527     <span class="comment">//</span>
03528     <span class="comment">//  Don't do anything, but we did want to acquire the critsect</span>
03529     <span class="comment">//  in case this was called with HEAP_NO_SERIALIZE while another</span>
03530     <span class="comment">//  thread is in the heap code.</span>
03531     <span class="comment">//</span>
03532 
03533     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03534 
03535     <span class="keywordflow">return</span> 0;
03536 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="heappage.h::RtlpDebugPageHeapCreate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID RtlpDebugPageHeapCreate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ReserveSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CommitSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Lock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PRTL_HEAP_PARAMETERS&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameters</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l01997">1997</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00114">DEBUG_ASSERT</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00108">DEBUG_CODE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00253">DPH_DEBUG_INTERNAL_VALIDATION</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00090">DPH_HEAP_SIGNATURE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00091">FILL_BYTE</a>, <a class="el" href="../../d8/d8/heappage_8h-source.html#l00047">HEAP_FLAG_PAGE_ALLOCS</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00116">HEAP_HANDLE_FROM_ROOT</a>, <a class="el" href="../../d8/d8/heappage_8h-source.html#l00051">HEAP_NO_ALIGNMENT</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00119">IF_GENERATE_EXCEPTION</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00851">NtQueryPerformanceCounter()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00124">OUT_OF_VM_BREAK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00095">POOL_SIZE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00093">RESERVE_SIZE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00111">RETAIL_ASSERT</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01518">RtlpDebugPageHeapAddNewPool()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01571">RtlpDebugPageHeapAllocateNode()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00842">RtlpDebugPageHeapAllocateVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01211">RtlpDebugPageHeapCoalesceNodeIntoAvailable()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01498">RtlpDebugPageHeapPlaceOnPoolList()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01128">RtlpDebugPageHeapPlaceOnVirtualList()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00831">RtlpDebugPageHeapProtectVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00863">RtlpDebugPageHeapReleaseVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00263">RtlpDphDebugLevel</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00231">RtlpDphGlobalFlags</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00211">RtlpDphHeapListCount</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00208">RtlpDphHeapListCriticalSection</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00207">RtlpDphHeapListHasBeenInitialized</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00209">RtlpDphHeapListHead</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00210">RtlpDphHeapListTail</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04819">RtlpDphInitializeDelayedFreeQueue()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05197">RtlpDphInternalValidatePageHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05026">RtlpDphLogStackTrace()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00244">RtlpDphTargetDlls</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05078">RtlpDphTargetDllsLogicInitialize()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00245">RtlpDphTargetDllsUnicode</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00301">RtlpDphTraceDatabase</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00300">RtlpDphTraceDatabaseMaximumSize</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00094">VM_UNIT_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>.
<p>
<pre class="fragment"><div>02005 {
02006     SYSTEM_BASIC_INFORMATION SystemInfo;
02007     PDPH_HEAP_BLOCK     Node;
02008     PDPH_HEAP_ROOT           HeapRoot;
02009     PVOID                    <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
02010     PUCHAR                   pVirtual;
02011     SIZE_T                   nVirtual;
02012     SIZE_T                   <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02013     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02014 
02015     <span class="comment">//</span>
02016     <span class="comment">// If `Parameters' is -1 then this is a recursive call to</span>
02017     <span class="comment">// RtlpDebugPageHeapCreate and we will return NULL so that</span>
02018     <span class="comment">// the normal heap manager will create a normal heap.</span>
02019     <span class="comment">// I agree this is a hack but we need this so that we maintain</span>
02020     <span class="comment">// a very loose dependency between the normal and page heap</span>
02021     <span class="comment">// manager.</span>
02022     <span class="comment">//</span>
02023 
02024     <span class="keywordflow">if</span> ((SIZE_T)Parameters == (SIZE_T)-1) {
02025         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                                        
02026     }
02027 
02028     <span class="comment">//</span>
02029     <span class="comment">//  We don't handle heaps where HeapBase is already allocated</span>
02030     <span class="comment">//  from user or where Lock is provided by user.</span>
02031     <span class="comment">//</span>
02032 
02033     <a class="code" href="../../d6/d9/heappage_8c.html#a11">DEBUG_ASSERT</a>( HeapBase == NULL );
02034     <a class="code" href="../../d6/d9/heappage_8c.html#a11">DEBUG_ASSERT</a>( Lock == NULL );
02035 
02036     <span class="keywordflow">if</span> (( HeapBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) || ( <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))
02037         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02038 
02039     <span class="comment">//</span>
02040     <span class="comment">//  Note that we simply ignore ReserveSize, CommitSize, and</span>
02041     <span class="comment">//  Parameters as we always have a growable heap with our</span>
02042     <span class="comment">//  own thresholds, etc.</span>
02043     <span class="comment">//</span>
02044 
02045     ZwQuerySystemInformation( SystemBasicInformation,
02046         &amp;SystemInfo,
02047         <span class="keyword">sizeof</span>( SystemInfo ),
02048         NULL );
02049 
02050     <a class="code" href="../../d6/d9/heappage_8c.html#a10">RETAIL_ASSERT</a>( SystemInfo.PageSize == PAGE_SIZE );
02051     <a class="code" href="../../d6/d9/heappage_8c.html#a10">RETAIL_ASSERT</a>( SystemInfo.AllocationGranularity == VM_UNIT_SIZE );
02052     <a class="code" href="../../d6/d9/heappage_8c.html#a11">DEBUG_ASSERT</a>(( PAGE_SIZE + POOL_SIZE + PAGE_SIZE ) &lt; VM_UNIT_SIZE );
02053 
02054     nVirtual = <a class="code" href="../../d6/d9/heappage_8c.html#a3">RESERVE_SIZE</a>;
02055     pVirtual = <a class="code" href="../../d6/d9/heappage_8c.html#a99">RtlpDebugPageHeapAllocateVM</a>( nVirtual );
02056 
02057     <span class="keywordflow">if</span> (pVirtual == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02058 
02059         nVirtual = <a class="code" href="../../d6/d9/heappage_8c.html#a4">VM_UNIT_SIZE</a>;
02060         pVirtual = <a class="code" href="../../d6/d9/heappage_8c.html#a99">RtlpDebugPageHeapAllocateVM</a>( nVirtual );
02061 
02062         <span class="keywordflow">if</span> (pVirtual == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02063             <a class="code" href="../../d6/d9/heappage_8c.html#a14">OUT_OF_VM_BREAK</a>( Flags, <span class="stringliteral">"Page heap: Insufficient memory to create heap\n"</span> );
02064             <a class="code" href="../../d6/d9/heappage_8c.html#a13">IF_GENERATE_EXCEPTION</a>( Flags, STATUS_NO_MEMORY );
02065             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02066         }
02067     }
02068 
02069     <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d9/heappage_8c.html#a98">RtlpDebugPageHeapProtectVM</a>( pVirtual, PAGE_SIZE + POOL_SIZE + PAGE_SIZE, PAGE_READWRITE )) {
02070         <a class="code" href="../../d6/d9/heappage_8c.html#a100">RtlpDebugPageHeapReleaseVM</a>( pVirtual );
02071         <a class="code" href="../../d6/d9/heappage_8c.html#a13">IF_GENERATE_EXCEPTION</a>( Flags, STATUS_NO_MEMORY );
02072         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02073     }
02074 
02075     <span class="comment">//</span>
02076     <span class="comment">//  Out of our initial allocation, the initial page is the fake</span>
02077     <span class="comment">//  retail HEAP structure.  The second page begins our DPH_HEAP</span>
02078     <span class="comment">//  structure followed by (POOL_SIZE-sizeof(DPH_HEAP)) bytes for</span>
02079     <span class="comment">//  the initial pool.  The next page contains out CRIT_SECT</span>
02080     <span class="comment">//  variable, which must always be READWRITE.  Beyond that, the</span>
02081     <span class="comment">//  remainder of the virtual allocation is placed on the available</span>
02082     <span class="comment">//  list.</span>
02083     <span class="comment">//</span>
02084     <span class="comment">//  |_____|___________________|_____|__ _ _ _ _ _ _ _ _ _ _ _ _ __|</span>
02085     <span class="comment">//</span>
02086     <span class="comment">//  ^pVirtual</span>
02087     <span class="comment">//</span>
02088     <span class="comment">//  ^FakeRetailHEAP</span>
02089     <span class="comment">//</span>
02090     <span class="comment">//        ^HeapRoot</span>
02091     <span class="comment">//</span>
02092     <span class="comment">//            ^InitialNodePool</span>
02093     <span class="comment">//</span>
02094     <span class="comment">//                            ^CRITICAL_SECTION</span>
02095     <span class="comment">//</span>
02096     <span class="comment">//                                  ^AvailableSpace</span>
02097     <span class="comment">//</span>
02098     <span class="comment">//</span>
02099     <span class="comment">//</span>
02100     <span class="comment">//  Our DPH_HEAP structure starts at the page following the</span>
02101     <span class="comment">//  fake retail HEAP structure pointed to by the "heap handle".</span>
02102     <span class="comment">//  For the fake HEAP structure, we'll fill it with 0xEEEEEEEE</span>
02103     <span class="comment">//  except for the Heap-&gt;Flags and Heap-&gt;ForceFlags fields,</span>
02104     <span class="comment">//  which we must set to include our HEAP_FLAG_PAGE_ALLOCS flag,</span>
02105     <span class="comment">//  and then we'll make the whole page read-only.</span>
02106     <span class="comment">//</span>
02107 
02108     RtlFillMemory( pVirtual, PAGE_SIZE, FILL_BYTE );
02109 
02110     ((<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)pVirtual)-&gt;Flags      = Flags | <a class="code" href="../../d7/d9/heappage_8h.html#a1">HEAP_FLAG_PAGE_ALLOCS</a>;
02111     ((<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)pVirtual)-&gt;ForceFlags = Flags | <a class="code" href="../../d7/d9/heappage_8h.html#a1">HEAP_FLAG_PAGE_ALLOCS</a>;
02112 
02113     <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d9/heappage_8c.html#a98">RtlpDebugPageHeapProtectVM</a>( pVirtual, PAGE_SIZE, PAGE_READONLY )) {
02114         <a class="code" href="../../d6/d9/heappage_8c.html#a100">RtlpDebugPageHeapReleaseVM</a>( pVirtual );
02115         <a class="code" href="../../d6/d9/heappage_8c.html#a13">IF_GENERATE_EXCEPTION</a>( Flags, STATUS_NO_MEMORY );
02116         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02117     }
02118 
02119     HeapRoot = (PDPH_HEAP_ROOT)( pVirtual + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> );
02120 
02121     HeapRoot-&gt;Signature    = <a class="code" href="../../d6/d9/heappage_8c.html#a0">DPH_HEAP_SIGNATURE</a>;
02122     HeapRoot-&gt;HeapFlags    = Flags;
02123     HeapRoot-&gt;HeapCritSect = (PVOID)((PCHAR)HeapRoot + <a class="code" href="../../d6/d9/heappage_8c.html#a5">POOL_SIZE</a> );
02124 
02125     <span class="comment">//</span>
02126     <span class="comment">// Copy the page heap global flags into per heap flags.</span>
02127     <span class="comment">//</span>
02128 
02129     HeapRoot-&gt;ExtraFlags = <a class="code" href="../../d6/d9/heappage_8c.html#a43">RtlpDphGlobalFlags</a>;
02130 
02131     <span class="comment">//</span>
02132     <span class="comment">// If the PAGE_HEAP_UNALIGNED_ALLOCATIONS bit is set</span>
02133     <span class="comment">// in ExtraFlags we will set the HEAP_NO_ALIGNMENT flag</span>
02134     <span class="comment">// in the HeapFlags. This last bit controls if allocations</span>
02135     <span class="comment">// will be aligned or not. The reason we do this transfer is</span>
02136     <span class="comment">// that ExtraFlags can be set from the registry whereas the</span>
02137     <span class="comment">// normal HeapFlags cannot.</span>
02138     <span class="comment">//</span>
02139 
02140     <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_UNALIGNED_ALLOCATIONS)) {
02141         HeapRoot-&gt;HeapFlags |= <a class="code" href="../../d7/d9/heappage_8h.html#a4">HEAP_NO_ALIGNMENT</a>;
02142     }
02143 
02144     <span class="comment">//</span>
02145     <span class="comment">// Initialize the seed for the random generator used to decide</span>
02146     <span class="comment">// from where should we make allocations if random decision</span>
02147     <span class="comment">// flag is on.</span>
02148     <span class="comment">//</span>
02149 
02150     {
02151         LARGE_INTEGER PerformanceCounter;
02152 
02153         PerformanceCounter.LowPart = 0xABCDDCBA;
02154 
02155         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a> (
02156             &amp;PerformanceCounter,
02157             NULL);
02158 
02159         HeapRoot-&gt;Seed = PerformanceCounter.LowPart;
02160     }
02161 
02162     RtlZeroMemory (HeapRoot-&gt;Counter, <span class="keyword">sizeof</span>(HeapRoot-&gt;Counter));
02163 
02164     <span class="comment">//</span>
02165     <span class="comment">// Create the normal heap associated with the page heap.</span>
02166     <span class="comment">// The last parameter value (-1) is very important because</span>
02167     <span class="comment">// it stops the recursive call into page heap create.</span>
02168     <span class="comment">//</span>
02169 
02170     HeapRoot-&gt;NormalHeap = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>(
02171 
02172         Flags,
02173         HeapBase,
02174         ReserveSize,
02175         CommitSize,
02176         Lock,
02177         (PRTL_HEAP_PARAMETERS)-1 );
02178 
02179     <span class="comment">//</span>
02180     <span class="comment">// Initialize heap lock.</span>
02181     <span class="comment">//</span>
02182 
02183     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( HeapRoot-&gt;HeapCritSect );
02184 
02185     <span class="comment">//</span>
02186     <span class="comment">//  On the page that contains our DPH_HEAP structure, use</span>
02187     <span class="comment">//  the remaining memory beyond the DPH_HEAP structure as</span>
02188     <span class="comment">//  pool for allocating heap nodes.</span>
02189     <span class="comment">//</span>
02190 
02191     <a class="code" href="../../d6/d9/heappage_8c.html#a122">RtlpDebugPageHeapAddNewPool</a>( HeapRoot,
02192         HeapRoot + 1,
02193         POOL_SIZE - <span class="keyword">sizeof</span>( DPH_HEAP_ROOT ),
02194         FALSE
02195         );
02196 
02197     <span class="comment">//</span>
02198     <span class="comment">//  Make initial PoolList entry by taking a node from the</span>
02199     <span class="comment">//  UnusedNodeList, which should be guaranteed to be non-empty</span>
02200     <span class="comment">//  since we just added new nodes to it.</span>
02201     <span class="comment">//</span>
02202 
02203     Node = <a class="code" href="../../d6/d9/heappage_8c.html#a123">RtlpDebugPageHeapAllocateNode</a>( HeapRoot );
02204     <a class="code" href="../../d6/d9/heappage_8c.html#a11">DEBUG_ASSERT</a>( Node != NULL );
02205     Node-&gt;pVirtualBlock     = (PVOID)HeapRoot;
02206     Node-&gt;nVirtualBlockSize = <a class="code" href="../../d6/d9/heappage_8c.html#a5">POOL_SIZE</a>;
02207     <a class="code" href="../../d6/d9/heappage_8c.html#a121">RtlpDebugPageHeapPlaceOnPoolList</a>( HeapRoot, Node );
02208 
02209     <span class="comment">//</span>
02210     <span class="comment">//  Make VirtualStorageList entry for initial VM allocation</span>
02211     <span class="comment">//</span>
02212 
02213     Node = <a class="code" href="../../d6/d9/heappage_8c.html#a123">RtlpDebugPageHeapAllocateNode</a>( HeapRoot );
02214     <a class="code" href="../../d6/d9/heappage_8c.html#a11">DEBUG_ASSERT</a>( Node != NULL );
02215     Node-&gt;pVirtualBlock     = pVirtual;
02216     Node-&gt;nVirtualBlockSize = nVirtual;
02217     <a class="code" href="../../d6/d9/heappage_8c.html#a113">RtlpDebugPageHeapPlaceOnVirtualList</a>( HeapRoot, Node );
02218 
02219     <span class="comment">//</span>
02220     <span class="comment">//  Make AvailableList entry containing remainder of initial VM</span>
02221     <span class="comment">//  and add to (create) the AvailableList.</span>
02222     <span class="comment">//</span>
02223 
02224     Node = <a class="code" href="../../d6/d9/heappage_8c.html#a123">RtlpDebugPageHeapAllocateNode</a>( HeapRoot );
02225     <a class="code" href="../../d6/d9/heappage_8c.html#a11">DEBUG_ASSERT</a>( Node != NULL );
02226     Node-&gt;pVirtualBlock     = pVirtual + ( <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> + <a class="code" href="../../d6/d9/heappage_8c.html#a5">POOL_SIZE</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> );
02227     Node-&gt;nVirtualBlockSize = nVirtual - ( <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> + <a class="code" href="../../d6/d9/heappage_8c.html#a5">POOL_SIZE</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> );
02228     <a class="code" href="../../d6/d9/heappage_8c.html#a117">RtlpDebugPageHeapCoalesceNodeIntoAvailable</a>( HeapRoot, Node );
02229 
02230     <span class="comment">//</span>
02231     <span class="comment">// Get heap creation stack trace.</span>
02232     <span class="comment">//</span>
02233 
02234     HeapRoot-&gt;CreateStackTrace = <a class="code" href="../../d6/d9/heappage_8c.html#a89">RtlpDphLogStackTrace</a>(1);
02235 
02236     <span class="comment">//</span>
02237     <span class="comment">//  Initialize heap internal structure protection.</span>
02238     <span class="comment">//</span>
02239 
02240     HeapRoot-&gt;nUnProtectionReferenceCount = 1;          <span class="comment">// initialize</span>
02241 
02242     <span class="comment">//</span>
02243     <span class="comment">//  If this is the first heap creation in this process, then we</span>
02244     <span class="comment">//  need to initialize the process heap list critical section,</span>
02245     <span class="comment">// the global delayed free queue for normal blocks and the</span>
02246     <span class="comment">// trace database.</span>
02247     <span class="comment">//</span>
02248 
02249     <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d9/heappage_8c.html#a38">RtlpDphHeapListHasBeenInitialized</a>) {
02250 
02251         <a class="code" href="../../d6/d9/heappage_8c.html#a38">RtlpDphHeapListHasBeenInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02252 
02253         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( &amp;RtlpDphHeapListCriticalSection );
02254         <a class="code" href="../../d6/d9/heappage_8c.html#a83">RtlpDphInitializeDelayedFreeQueue</a> ();
02255 
02256         <span class="comment">//</span>
02257         <span class="comment">// Do not make fuss if the trace database creation fails.</span>
02258         <span class="comment">// This is something we can live with.</span>
02259         <span class="comment">//</span>
02260         <span class="comment">// The number of buckets is chosen to be a prime not too</span>
02261         <span class="comment">// close to a power of two (Knuth says so). Three possible</span>
02262         <span class="comment">// values are: 1567, 3089, 6263.</span>
02263         <span class="comment">//</span>
02264 
02265         <a class="code" href="../../d6/d9/heappage_8c.html#a56">RtlpDphTraceDatabase</a> = RtlTraceDatabaseCreate (
02266             6263, 
02267             RtlpDphTraceDatabaseMaximumSize,
02268             0,
02269             0,
02270             NULL);
02271 
02272 <span class="preprocessor">#if DBG</span>
02273 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/heappage_8c.html#a56">RtlpDphTraceDatabase</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02274             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Page heap: warning: failed to create trace database for %p"</span>,
02275                 HeapRoot);
02276         }
02277 <span class="preprocessor">#endif</span>
02278 <span class="preprocessor"></span>        <span class="comment">//</span>
02279         <span class="comment">// Create the Unicode string containing the target dlls. </span>
02280         <span class="comment">// If no target dlls have been specified the string will</span>
02281         <span class="comment">// be initialized with the empty string.</span>
02282         <span class="comment">//</span>
02283 
02284         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (
02285             &amp;RtlpDphTargetDllsUnicode,
02286             RtlpDphTargetDlls);
02287         
02288         <span class="comment">//</span>
02289         <span class="comment">// Initialize the target dlls logic</span>
02290         <span class="comment">//</span>
02291 
02292         <a class="code" href="../../d6/d9/heappage_8c.html#a103">RtlpDphTargetDllsLogicInitialize</a> ();
02293     }
02294 
02295     <span class="comment">//</span>
02296     <span class="comment">//  Add this heap entry to the process heap linked list.</span>
02297     <span class="comment">//</span>
02298 
02299     RtlEnterCriticalSection( &amp;RtlpDphHeapListCriticalSection );
02300 
02301     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/heappage_8c.html#a40">RtlpDphHeapListHead</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02302         <a class="code" href="../../d6/d9/heappage_8c.html#a40">RtlpDphHeapListHead</a> = HeapRoot;
02303         <a class="code" href="../../d6/d9/heappage_8c.html#a41">RtlpDphHeapListTail</a> = HeapRoot;
02304     }
02305     <span class="keywordflow">else</span> {
02306         HeapRoot-&gt;pPrevHeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a41">RtlpDphHeapListTail</a>;
02307         <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>(RtlpDphHeapListTail);
02308         <a class="code" href="../../d6/d9/heappage_8c.html#a41">RtlpDphHeapListTail</a>-&gt;pNextHeapRoot = HeapRoot;
02309         <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>(RtlpDphHeapListTail);
02310         <a class="code" href="../../d6/d9/heappage_8c.html#a41">RtlpDphHeapListTail</a>                = HeapRoot;
02311     }
02312 
02313     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );                <span class="comment">// now protected</span>
02314 
02315     <a class="code" href="../../d6/d9/heappage_8c.html#a42">RtlpDphHeapListCount</a> += 1;
02316 
02317     RtlLeaveCriticalSection( &amp;RtlpDphHeapListCriticalSection );
02318 
02319     <a class="code" href="../../d6/d9/heappage_8c.html#a9">DEBUG_CODE</a>( RtlpDebugPageHeapVerifyIntegrity( HeapRoot ));
02320 
02321     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Page heap: process 0x%X created heap @ %p (%p, flags 0x%X)\n"</span>,
02322         NtCurrentTeb()-&gt;ClientId.UniqueProcess,
02323         <a class="code" href="../../d6/d9/heappage_8c.html#a12">HEAP_HANDLE_FROM_ROOT</a>( HeapRoot ),
02324         HeapRoot-&gt;NormalHeap,
02325         HeapRoot-&gt;ExtraFlags);
02326 
02327     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a23">DPH_DEBUG_INTERNAL_VALIDATION</a>)) {
02328         <a class="code" href="../../d6/d9/heappage_8c.html#a106">RtlpDphInternalValidatePageHeap</a> (HeapRoot, NULL, 0);
02329     }
02330 
02331     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/heappage_8c.html#a12">HEAP_HANDLE_FROM_ROOT</a>( HeapRoot );       <span class="comment">// same as pVirtual</span>
02332 
02333 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="heappage.h::RtlpDebugPageHeapDestroy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID RtlpDebugPageHeapDestroy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HeapHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03259">3259</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00108">DEBUG_CODE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">RtlDeleteCriticalSection()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>, <a class="el" href="../../d7/d9/heappage_8h.html#a30">RtlpDebugPageHeapBreak()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00863">RtlpDebugPageHeapReleaseVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04961">RtlpDphFreeDelayedBlocksFromHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00211">RtlpDphHeapListCount</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00208">RtlpDphHeapListCriticalSection</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00209">RtlpDphHeapListHead</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00210">RtlpDphHeapListTail</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04049">RtlpDphIsPageHeapBlock()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04016">RtlpDphReportCorruptedBlock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>.
<p>
<pre class="fragment"><div>03262 {
03263     PDPH_HEAP_ROOT       HeapRoot;
03264     PDPH_HEAP_ROOT       PrevHeapRoot;
03265     PDPH_HEAP_ROOT       NextHeapRoot;
03266     PDPH_HEAP_BLOCK Node;
03267     PDPH_HEAP_BLOCK Next;
03268     ULONG                Flags;
03269     PUCHAR               p;
03270     ULONG Reason;
03271     PVOID NormalHeap;
03272 
03273     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> == RtlProcessHeap()) {
03274         <a class="code" href="../../d7/d9/heappage_8h.html#a30">RtlpDebugPageHeapBreak</a>( <span class="stringliteral">"Page heap: Attempt to destroy process heap\n"</span> );
03275         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03276     }
03277 
03278     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03279     <span class="keywordflow">if</span> (HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03280         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03281 
03282     Flags = HeapRoot-&gt;HeapFlags | HEAP_NO_SERIALIZE;
03283 
03284     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
03285     <a class="code" href="../../d6/d9/heappage_8c.html#a9">DEBUG_CODE</a>( RtlpDebugPageHeapVerifyIntegrity( HeapRoot ));
03286     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03287 
03288     <span class="comment">//</span>
03289     <span class="comment">// Save normal heap pointer for later.</span>
03290     <span class="comment">//</span>
03291 
03292     NormalHeap = HeapRoot-&gt;NormalHeap;
03293 
03294     <span class="comment">//</span>
03295     <span class="comment">//  Walk all busy allocations and check for tail fill corruption</span>
03296     <span class="comment">//</span>
03297 
03298     Node = HeapRoot-&gt;pBusyAllocationListHead;
03299 
03300     <span class="keywordflow">while</span> (Node) {
03301 
03302         <span class="keywordflow">if</span> (! (HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_CATCH_BACKWARD_OVERRUNS)) {
03303             <span class="keywordflow">if</span> (! (<a class="code" href="../../d6/d9/heappage_8c.html#a80">RtlpDphIsPageHeapBlock</a> (HeapRoot, Node-&gt;pUserAllocation, &amp;Reason, TRUE))) {
03304                 <a class="code" href="../../d6/d9/heappage_8c.html#a77">RtlpDphReportCorruptedBlock</a> (Node-&gt;pUserAllocation, Reason);
03305             }
03306         }
03307 
03308         Node = Node-&gt;pNextAlloc;
03309     }
03310 
03311     <span class="comment">//</span>
03312     <span class="comment">//  Remove this heap entry from the process heap linked list.</span>
03313     <span class="comment">//</span>
03314 
03315     RtlEnterCriticalSection( &amp;RtlpDphHeapListCriticalSection );
03316 
03317     <span class="keywordflow">if</span> (HeapRoot-&gt;pPrevHeapRoot) {
03318         HeapRoot-&gt;pPrevHeapRoot-&gt;pNextHeapRoot = HeapRoot-&gt;pNextHeapRoot;
03319     }
03320     <span class="keywordflow">else</span> {
03321         <a class="code" href="../../d6/d9/heappage_8c.html#a40">RtlpDphHeapListHead</a> = HeapRoot-&gt;pNextHeapRoot;
03322     }
03323 
03324     <span class="keywordflow">if</span> (HeapRoot-&gt;pNextHeapRoot) {
03325         HeapRoot-&gt;pNextHeapRoot-&gt;pPrevHeapRoot = HeapRoot-&gt;pPrevHeapRoot;
03326     }
03327     <span class="keywordflow">else</span> {
03328         <a class="code" href="../../d6/d9/heappage_8c.html#a41">RtlpDphHeapListTail</a> = HeapRoot-&gt;pPrevHeapRoot;
03329     }
03330 
03331     <a class="code" href="../../d6/d9/heappage_8c.html#a42">RtlpDphHeapListCount</a>--;
03332 
03333     RtlLeaveCriticalSection( &amp;RtlpDphHeapListCriticalSection );
03334 
03335 
03336     <span class="comment">//</span>
03337     <span class="comment">//  Must release critical section before deleting it; otherwise,</span>
03338     <span class="comment">//  checked build Teb-&gt;CountOfOwnedCriticalSections gets out of sync.</span>
03339     <span class="comment">//</span>
03340 
03341     RtlLeaveCriticalSection( HeapRoot-&gt;HeapCritSect );
03342     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>( HeapRoot-&gt;HeapCritSect );
03343 
03344     <span class="comment">//</span>
03345     <span class="comment">//  This is weird.  A virtual block might contain storage for</span>
03346     <span class="comment">//  one of the nodes necessary to walk this list.  In fact,</span>
03347     <span class="comment">//  we're guaranteed that the root node contains at least one</span>
03348     <span class="comment">//  virtual alloc node.</span>
03349     <span class="comment">//</span>
03350     <span class="comment">//  Each time we alloc new VM, we make that the head of the</span>
03351     <span class="comment">//  of the VM list, like a LIFO structure.  I think we're ok</span>
03352     <span class="comment">//  because no VM list node should be on a subsequently alloc'd</span>
03353     <span class="comment">//  VM -- only a VM list entry might be on its own memory (as</span>
03354     <span class="comment">//  is the case for the root node).  We read pNode-&gt;pNextAlloc</span>
03355     <span class="comment">//  before releasing the VM in case pNode existed on that VM.</span>
03356     <span class="comment">//  I think this is safe -- as long as the VM list is LIFO and</span>
03357     <span class="comment">//  we don't do any list reorganization.</span>
03358     <span class="comment">//</span>
03359 
03360     Node = HeapRoot-&gt;pVirtualStorageListHead;
03361 
03362     <span class="keywordflow">while</span> (Node) {
03363         Next = Node-&gt;pNextAlloc;
03364         <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d9/heappage_8c.html#a100">RtlpDebugPageHeapReleaseVM</a>( Node-&gt;pVirtualBlock )) {
03365             <a class="code" href="../../d7/d9/heappage_8h.html#a30">RtlpDebugPageHeapBreak</a>( <span class="stringliteral">"Page heap: Unable to release virtual memory\n"</span> );
03366         }
03367         Node = Next;
03368     }
03369 
03370     <span class="comment">//</span>
03371     <span class="comment">// Free all blocks in the delayed free queue that belong to the</span>
03372     <span class="comment">// normal heap just about to be destroyed. Note that this is</span>
03373     <span class="comment">// not a bug. The application freed the blocks correctly but</span>
03374     <span class="comment">// we delayed the free operation.</span>
03375     <span class="comment">//</span>
03376 
03377     <a class="code" href="../../d6/d9/heappage_8c.html#a87">RtlpDphFreeDelayedBlocksFromHeap</a> (HeapRoot, NormalHeap);
03378 
03379     <span class="comment">//</span>
03380     <span class="comment">// Destroy normal heap. Note that this will not make a recursive</span>
03381     <span class="comment">// call into this function because this is not a page heap and</span>
03382     <span class="comment">// code in NT heap manager will detect this.</span>
03383     <span class="comment">//</span>
03384 
03385     <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a16">RtlDestroyHeap</a> (NormalHeap);
03386 
03387     <span class="comment">//</span>
03388     <span class="comment">//  That's it.  All the VM, including the root node, should now</span>
03389     <span class="comment">//  be released.  RtlDestroyHeap always returns NULL.</span>
03390     <span class="comment">//</span>
03391 
03392     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Page heap: process 0x%X destroyed heap @ %p (%p)\n"</span>,
03393         NtCurrentTeb()-&gt;ClientId.UniqueProcess,
03394         HeapRoot,
03395         NormalHeap);
03396 
03397     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03398 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="heappage.h::RtlpDebugPageHeapExtend" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpDebugPageHeapExtend           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03817">3817</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02132">RtlExtendHeap()</a>.
<p>
<pre class="fragment"><div>03823 {
03824     <span class="keywordflow">return</span> STATUS_SUCCESS;
03825 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="heappage.h::RtlpDebugPageHeapFree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpDebugPageHeapFree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l02693">2693</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d7/d8/heappage_8c-source.html#l00273">BUMP_GLOBAL_COUNTER</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00108">DEBUG_CODE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00259">DPH_DEBUG_BREAK_FOR_NULL_FREE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00253">DPH_DEBUG_INTERNAL_VALIDATION</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00119">IF_GENERATE_EXCEPTION</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00962">RtlpDebugPageHeapDecommitVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01053">RtlpDebugPageHeapFindBusyMem()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01093">RtlpDebugPageHeapPlaceOnFreeList()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00831">RtlpDebugPageHeapProtectVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01163">RtlpDebugPageHeapRemoveFromBusyList()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00263">RtlpDphDebugLevel</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05197">RtlpDphInternalValidatePageHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04049">RtlpDphIsPageHeapBlock()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05026">RtlpDphLogStackTrace()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04458">RtlpDphNormalHeapFree()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04016">RtlpDphReportCorruptedBlock()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00301">RtlpDphTraceDatabase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04469">RtlpDphDllDelete()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04495">RtlpDphDllDeleteArray()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04434">RtlpDphDllfree()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04336">RtlpDphDllGlobalFree()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04128">RtlpDphDllHeapFree()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04251">RtlpDphDllLocalFree()</a>.
<p>
<pre class="fragment"><div>02698 {
02699 
02700     PDPH_HEAP_ROOT       HeapRoot;
02701     PDPH_HEAP_BLOCK Node, Prev;
02702     BOOLEAN              Success;
02703     PCH                  p;
02704     ULONG Reason;
02705 
02706     <span class="comment">//</span>
02707     <span class="comment">// Check if null frees are of any concern.</span>
02708     <span class="comment">//</span>
02709 
02710     <span class="keywordflow">if</span> (Address == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02711 
02712         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a29">DPH_DEBUG_BREAK_FOR_NULL_FREE</a>)) {
02713 
02714             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Page heap: attempt to free null pointer \n"</span>);
02715             DbgBreakPoint();
02716         }
02717 
02718         <span class="comment">//</span>
02719         <span class="comment">// For C++ apps that delete NULL this is valid.</span>
02720         <span class="comment">//</span>
02721 
02722         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02723     }
02724 
02725     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
02726     <span class="keywordflow">if</span> (HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02727         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02728 
02729     <span class="comment">//</span>
02730     <span class="comment">// Acquire heap lock and unprotect heap structures.</span>
02731     <span class="comment">//</span>
02732 
02733     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
02734     <a class="code" href="../../d6/d9/heappage_8c.html#a9">DEBUG_CODE</a>( RtlpDebugPageHeapVerifyIntegrity( HeapRoot ));
02735     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
02736 
02737     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a23">DPH_DEBUG_INTERNAL_VALIDATION</a>)) {
02738         <a class="code" href="../../d6/d9/heappage_8c.html#a106">RtlpDphInternalValidatePageHeap</a> (HeapRoot, NULL, 0);
02739     }
02740 
02741     Flags |= HeapRoot-&gt;HeapFlags;
02742 
02743     <span class="comment">//</span>
02744     <span class="comment">// Compute free statistics</span>
02745     <span class="comment">//</span>
02746 
02747     <a class="code" href="../../d6/d9/heappage_8c.html#a32">BUMP_GLOBAL_COUNTER</a> (DPH_COUNTER_NO_OF_FREES);
02748     HeapRoot-&gt;Counter[DPH_COUNTER_NO_OF_FREES] += 1;
02749 
02750 
02751     Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02752 
02753     Node = <a class="code" href="../../d6/d9/heappage_8c.html#a109">RtlpDebugPageHeapFindBusyMem</a>( HeapRoot, Address, &amp;Prev );
02754 
02755     <span class="keywordflow">if</span> (Node == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02756 
02757         <span class="comment">//</span>
02758         <span class="comment">// No wonder we did not find the block in the page heap</span>
02759         <span class="comment">// structures because the block was probably allocated</span>
02760         <span class="comment">// from the normal heap. Or there is a real bug.</span>
02761         <span class="comment">// If there is a bug NormalHeapFree will break into debugger.</span>
02762         <span class="comment">//</span>
02763 
02764         Success = <a class="code" href="../../d6/d9/heappage_8c.html#a70">RtlpDphNormalHeapFree</a> (
02765 
02766             HeapRoot,
02767             Flags,
02768             Address);
02769 
02770         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
02771     }
02772 
02773     <span class="comment">//</span>
02774     <span class="comment">//  If tail was allocated, make sure filler not overwritten</span>
02775     <span class="comment">//</span>
02776 
02777     <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_CATCH_BACKWARD_OVERRUNS)) {
02778 
02779         <span class="keywordflow">if</span> (Node-&gt;nVirtualAccessSize &gt; 0) {
02780             <a class="code" href="../../d6/d9/heappage_8c.html#a98">RtlpDebugPageHeapProtectVM</a>( Node-&gt;pVirtualBlock + PAGE_SIZE,
02781                 Node-&gt;nVirtualAccessSize,
02782                 PAGE_NOACCESS );
02783         }
02784     }
02785     <span class="keywordflow">else</span> {
02786 
02787         <span class="comment">//</span>
02788         <span class="comment">// (SilviuC): This can be done at the beginning of the function.</span>
02789         <span class="comment">//</span>
02790 
02791         <span class="keywordflow">if</span> (! (<a class="code" href="../../d6/d9/heappage_8c.html#a80">RtlpDphIsPageHeapBlock</a> (HeapRoot, Address, &amp;Reason, TRUE))) {
02792 
02793             <a class="code" href="../../d6/d9/heappage_8c.html#a77">RtlpDphReportCorruptedBlock</a> (Address, Reason);
02794         }
02795 
02796         <span class="keywordflow">if</span> (Node-&gt;nVirtualAccessSize &gt; 0) {
02797 
02798             <span class="comment">//</span>
02799             <span class="comment">// Mark the block as freed. The information is gone if we</span>
02800             <span class="comment">// will decommit the region but will remain if smart memory</span>
02801             <span class="comment">// flag is not set and can help debug failures.</span>
02802             <span class="comment">//</span>
02803             
02804             {
02805                 PDPH_BLOCK_INFORMATION Info = (PDPH_BLOCK_INFORMATION)(Node-&gt;pUserAllocation);
02806 
02807                 Info -= 1;
02808                 Info-&gt;StartStamp -= 1;
02809                 Info-&gt;EndStamp -= 1;
02810             }
02811 
02812             <a class="code" href="../../d6/d9/heappage_8c.html#a98">RtlpDebugPageHeapProtectVM</a>( Node-&gt;pVirtualBlock,
02813                 Node-&gt;nVirtualAccessSize,
02814                 PAGE_NOACCESS );
02815         }
02816     }
02817 
02818     <a class="code" href="../../d6/d9/heappage_8c.html#a115">RtlpDebugPageHeapRemoveFromBusyList</a>( HeapRoot, Node, Prev );
02819 
02820     <span class="comment">//</span>
02821     <span class="comment">// If we use uncommitted ranges we need to decommit the memory</span>
02822     <span class="comment">// range now for the allocation. Note that the next page (guard) </span>
02823     <span class="comment">// was already decommitted when we allocated the block.</span>
02824     <span class="comment">//</span>
02825 
02826     <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_CATCH_BACKWARD_OVERRUNS)) {
02827 
02828         <span class="comment">// nothing            </span>
02829 
02830     }
02831     <span class="keywordflow">else</span> {
02832 
02833         <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_SMART_MEMORY_USAGE)) {
02834 
02835             <a class="code" href="../../d6/d9/heappage_8c.html#a102">RtlpDebugPageHeapDecommitVM</a> (
02836                 Node-&gt;pVirtualBlock, 
02837                 Node-&gt;nVirtualAccessSize);
02838         }
02839     }
02840 
02841 
02842     <a class="code" href="../../d6/d9/heappage_8c.html#a111">RtlpDebugPageHeapPlaceOnFreeList</a>( HeapRoot, Node );
02843 
02844     <span class="comment">//</span>
02845     <span class="comment">//  RtlpDebugPageHeapFree gets called from RtlDebugFreeHeap, which</span>
02846     <span class="comment">//  gets called from RtlFreeHeapSlowly, which gets called from</span>
02847     <span class="comment">//  RtlFreeHeap.  To keep from wasting lots of stack trace storage,</span>
02848     <span class="comment">//  we'll skip the bottom 3 entries, leaving RtlFreeHeap as the</span>
02849     <span class="comment">//  first recorded entry.</span>
02850     <span class="comment">//</span>
02851 
02852     <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_COLLECT_STACK_TRACES)) {
02853 
02854         <span class="keywordflow">if</span> (Node-&gt;StackTrace) {
02855 
02856             RtlTraceDatabaseLock (RtlpDphTraceDatabase);
02857 
02858             <span class="keywordflow">if</span> (Node-&gt;StackTrace-&gt;UserCount &gt; 0) {
02859                 Node-&gt;StackTrace-&gt;UserCount -= 1;
02860             }
02861 
02862             <span class="keywordflow">if</span> (Node-&gt;StackTrace-&gt;UserSize &gt;= Node-&gt;nUserRequestedSize) {
02863                 Node-&gt;StackTrace-&gt;UserSize -= Node-&gt;nUserRequestedSize;
02864             }
02865 
02866             RtlTraceDatabaseUnlock (RtlpDphTraceDatabase);
02867         }
02868 
02869         Node-&gt;StackTrace = <a class="code" href="../../d6/d9/heappage_8c.html#a89">RtlpDphLogStackTrace</a>(3);
02870     }
02871     <span class="keywordflow">else</span> {
02872         Node-&gt;StackTrace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02873     }
02874 
02875     Success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02876 
02877     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>:
02878 
02879     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a23">DPH_DEBUG_INTERNAL_VALIDATION</a>)) {
02880         <a class="code" href="../../d6/d9/heappage_8c.html#a106">RtlpDphInternalValidatePageHeap</a> (HeapRoot, NULL, 0);
02881     }
02882 
02883     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
02884     <a class="code" href="../../d6/d9/heappage_8c.html#a9">DEBUG_CODE</a>( RtlpDebugPageHeapVerifyIntegrity( HeapRoot ));
02885     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
02886 
02887     <span class="keywordflow">if</span> (! Success) {
02888         <a class="code" href="../../d6/d9/heappage_8c.html#a13">IF_GENERATE_EXCEPTION</a>( Flags, STATUS_ACCESS_VIOLATION );
02889     }
02890 
02891     <span class="keywordflow">return</span> Success;
02892 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="heappage.h::RtlpDebugPageHeapGetProcessHeaps" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlpDebugPageHeapGetProcessHeaps           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfHeaps</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHeaps</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03458">3458</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00116">HEAP_HANDLE_FROM_ROOT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d7/d9/heappage_8h.html#a30">RtlpDebugPageHeapBreak()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00211">RtlpDphHeapListCount</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00208">RtlpDphHeapListCriticalSection</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00207">RtlpDphHeapListHasBeenInitialized</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00209">RtlpDphHeapListHead</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02803">RtlGetProcessHeaps()</a>.
<p>
<pre class="fragment"><div>03462 {
03463     PDPH_HEAP_ROOT HeapRoot;
03464     ULONG          <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03465 
03466     <span class="comment">//</span>
03467     <span class="comment">//  Although we'd expect GetProcessHeaps never to be called</span>
03468     <span class="comment">//  before at least the very first heap creation, we should</span>
03469     <span class="comment">//  still be safe and initialize the critical section if</span>
03470     <span class="comment">//  necessary.</span>
03471     <span class="comment">//</span>
03472 
03473     <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d9/heappage_8c.html#a38">RtlpDphHeapListHasBeenInitialized</a>) {
03474         <a class="code" href="../../d6/d9/heappage_8c.html#a38">RtlpDphHeapListHasBeenInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03475         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( &amp;RtlpDphHeapListCriticalSection );
03476     }
03477 
03478     RtlEnterCriticalSection( &amp;RtlpDphHeapListCriticalSection );
03479 
03480     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/heappage_8c.html#a42">RtlpDphHeapListCount</a> &lt;= NumberOfHeaps) {
03481 
03482         <span class="keywordflow">for</span> (HeapRoot  = <a class="code" href="../../d6/d9/heappage_8c.html#a40">RtlpDphHeapListHead</a>, <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
03483             HeapRoot != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03484             HeapRoot  = HeapRoot-&gt;pNextHeapRoot, <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1) {
03485 
03486             *ProcessHeaps++ = <a class="code" href="../../d6/d9/heappage_8c.html#a12">HEAP_HANDLE_FROM_ROOT</a>( HeapRoot );
03487         }
03488 
03489         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != <a class="code" href="../../d6/d9/heappage_8c.html#a42">RtlpDphHeapListCount</a>) {
03490             <a class="code" href="../../d7/d9/heappage_8h.html#a30">RtlpDebugPageHeapBreak</a>( <span class="stringliteral">"Page heap: BUG: process heap list count wrong\n"</span> );
03491         }
03492 
03493     }
03494     <span class="keywordflow">else</span> {
03495 
03496         <span class="comment">//</span>
03497         <span class="comment">//  User's buffer is too small.  Return number of entries</span>
03498         <span class="comment">//  necessary for subsequent call to succeed.  Buffer</span>
03499         <span class="comment">//  remains untouched.</span>
03500         <span class="comment">//</span>
03501 
03502         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = <a class="code" href="../../d6/d9/heappage_8c.html#a42">RtlpDphHeapListCount</a>;
03503 
03504     }
03505 
03506     RtlLeaveCriticalSection( &amp;RtlpDphHeapListCriticalSection );
03507 
03508     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03509 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="heappage.h::RtlpDebugPageHeapGetUserInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpDebugPageHeapGetUserInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>UserValue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UserFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03683">3683</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01053">RtlpDebugPageHeapFindBusyMem()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04722">RtlpDphNormalHeapGetUserInfo()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00919">RtlDebugGetUserInfoHeap()</a>.
<p>
<pre class="fragment"><div>03690 {
03691     PDPH_HEAP_ROOT       HeapRoot;
03692     PDPH_HEAP_BLOCK Node;
03693     BOOLEAN              Success;
03694 
03695     Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03696 
03697     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03698     <span class="keywordflow">if</span> ( HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
03699         <span class="keywordflow">return</span> Success;
03700 
03701     Flags |= HeapRoot-&gt;HeapFlags;
03702 
03703     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
03704     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03705 
03706     Node = <a class="code" href="../../d6/d9/heappage_8c.html#a109">RtlpDebugPageHeapFindBusyMem</a>( HeapRoot, Address, NULL );
03707 
03708     <span class="keywordflow">if</span> ( Node == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03709 
03710         <span class="comment">//</span>
03711         <span class="comment">// If we cannot find the node in page heap structures it might be</span>
03712         <span class="comment">// because it has been allocated from normal heap.</span>
03713         <span class="comment">//</span>
03714 
03715         Success = <a class="code" href="../../d6/d9/heappage_8c.html#a75">RtlpDphNormalHeapGetUserInfo</a> (
03716             HeapRoot,
03717             Flags,
03718             Address,
03719             UserValue,
03720             UserFlags);
03721 
03722         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
03723     }
03724     <span class="keywordflow">else</span> {
03725         <span class="keywordflow">if</span> ( UserValue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
03726             *UserValue = Node-&gt;UserValue;
03727         <span class="keywordflow">if</span> ( UserFlags != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
03728             *UserFlags = Node-&gt;UserFlags;
03729         Success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03730     }
03731 
03732     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>:
03733     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03734     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03735 
03736     <span class="keywordflow">return</span> Success;
03737 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="heappage.h::RtlpDebugPageHeapIsLocked" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpDebugPageHeapIsLocked           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HeapHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03883">3883</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l06152">RtlpHeapIsLocked()</a>.
<p>
<pre class="fragment"><div>03886 {
03887     PDPH_HEAP_ROOT HeapRoot;
03888 
03889     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03890     <span class="keywordflow">if</span> ( HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
03891         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03892 
03893     <span class="keywordflow">if</span> ( RtlTryEnterCriticalSection( HeapRoot-&gt;HeapCritSect )) {
03894         RtlLeaveCriticalSection( HeapRoot-&gt;HeapCritSect );
03895         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03896     }
03897     <span class="keywordflow">else</span> {
03898         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03899     }
03900 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="heappage.h::RtlpDebugPageHeapLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpDebugPageHeapLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HeapHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03595">3595</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00390">RtlLockHeap()</a>.
<p>
<pre class="fragment"><div>03598 {
03599     PDPH_HEAP_ROOT HeapRoot;
03600 
03601     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03602 
03603     <span class="keywordflow">if</span> (HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03604         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03605     }
03606 
03607     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, HeapRoot-&gt;HeapFlags );
03608 
03609     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03610 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="heappage.h::RtlpDebugPageHeapReAllocate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID RtlpDebugPageHeapReAllocate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l02895">2895</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04097">BIAS_POINTER</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00273">BUMP_GLOBAL_COUNTER</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00275">BUMP_SIZE_COUNTER</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00114">DEBUG_ASSERT</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00108">DEBUG_CODE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00258">DPH_DEBUG_BREAK_FOR_SIZE_ZERO</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00253">DPH_DEBUG_INTERNAL_VALIDATION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00119">IF_GENERATE_EXCEPTION</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00164">IS_BIASED_POINTER</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00124">OUT_OF_VM_BREAK</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00111">RETAIL_ASSERT</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l02336">RtlpDebugPageHeapAllocate()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00962">RtlpDebugPageHeapDecommitVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01053">RtlpDebugPageHeapFindBusyMem()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01145">RtlpDebugPageHeapPlaceOnBusyList()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01093">RtlpDebugPageHeapPlaceOnFreeList()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00831">RtlpDebugPageHeapProtectVM()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01163">RtlpDebugPageHeapRemoveFromBusyList()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00263">RtlpDphDebugLevel</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05197">RtlpDphInternalValidatePageHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04049">RtlpDphIsPageHeapBlock()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05026">RtlpDphLogStackTrace()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04403">RtlpDphNormalHeapAllocate()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04556">RtlpDphNormalHeapReAllocate()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04016">RtlpDphReportCorruptedBlock()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l03906">RtlpDphShouldAllocateInPageHeap()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00301">RtlpDphTraceDatabase</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00163">UNBIAS_POINTER</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04309">RtlpDphDllGlobalReAlloc()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04113">RtlpDphDllHeapReAlloc()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04224">RtlpDphDllLocalReAlloc()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l04405">RtlpDphDllrealloc()</a>.
<p>
<pre class="fragment"><div>02901 {
02902     PDPH_HEAP_ROOT       HeapRoot;
02903     PDPH_HEAP_BLOCK OldNode, OldPrev, NewNode;
02904     PVOID                NewAddress;
02905     PUCHAR               p;
02906     SIZE_T               CopyDataSize;
02907     ULONG                SaveFlags;
02908     BOOLEAN ReallocInNormalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02909     ULONG Reason;
02910     BOOLEAN ForcePageHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02911     BOOLEAN OriginalAllocationInPageHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02912 
02913     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/heappage_8c.html#a20">IS_BIASED_POINTER</a>(HeapHandle)) {
02914         <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = <a class="code" href="../../d6/d9/heappage_8c.html#a19">UNBIAS_POINTER</a>(HeapHandle);
02915         ForcePageHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02916     }
02917 
02918     <span class="comment">//</span>
02919     <span class="comment">// Is zero size allocation ?</span>
02920     <span class="comment">//</span>
02921 
02922     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == 0) {
02923 
02924         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a28">DPH_DEBUG_BREAK_FOR_SIZE_ZERO</a>)) {
02925 
02926             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Page heap: request for zero sized block \n"</span>);
02927             DbgBreakPoint();
02928         }
02929     }
02930 
02931     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
02932     <span class="keywordflow">if</span> (HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02933         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02934 
02935     <span class="comment">//</span>
02936     <span class="comment">// Get heap lock and unprotect heap structures.</span>
02937     <span class="comment">//</span>
02938 
02939     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
02940     <a class="code" href="../../d6/d9/heappage_8c.html#a9">DEBUG_CODE</a>( RtlpDebugPageHeapVerifyIntegrity( HeapRoot ));
02941     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
02942 
02943     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a23">DPH_DEBUG_INTERNAL_VALIDATION</a>)) {
02944         <a class="code" href="../../d6/d9/heappage_8c.html#a106">RtlpDphInternalValidatePageHeap</a> (HeapRoot, NULL, 0);
02945     }
02946 
02947     Flags |= HeapRoot-&gt;HeapFlags;
02948 
02949     <span class="comment">//</span>
02950     <span class="comment">// Compute realloc statistics</span>
02951     <span class="comment">//</span>
02952 
02953     <a class="code" href="../../d6/d9/heappage_8c.html#a32">BUMP_GLOBAL_COUNTER</a> (DPH_COUNTER_NO_OF_REALLOCS);
02954     <a class="code" href="../../d6/d9/heappage_8c.html#a33">BUMP_SIZE_COUNTER</a> (Size);
02955 
02956     HeapRoot-&gt;Counter[DPH_COUNTER_NO_OF_REALLOCS] += 1;
02957 
02958     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; 1024) {
02959         <a class="code" href="../../d6/d9/heappage_8c.html#a32">BUMP_GLOBAL_COUNTER</a> (DPH_COUNTER_SIZE_BELOW_1K);
02960         HeapRoot-&gt;Counter[DPH_COUNTER_SIZE_BELOW_1K] += 1;
02961     }
02962     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; 4096) {
02963         <a class="code" href="../../d6/d9/heappage_8c.html#a32">BUMP_GLOBAL_COUNTER</a> (DPH_COUNTER_SIZE_BELOW_4K);
02964         HeapRoot-&gt;Counter[DPH_COUNTER_SIZE_BELOW_4K] += 1;
02965     }
02966     <span class="keywordflow">else</span> {
02967         <a class="code" href="../../d6/d9/heappage_8c.html#a32">BUMP_GLOBAL_COUNTER</a> (DPH_COUNTER_SIZE_ABOVE_4K);
02968         HeapRoot-&gt;Counter[DPH_COUNTER_SIZE_ABOVE_4K] += 1;
02969     }
02970 
02971 
02972     NewAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02973 
02974     <span class="comment">//</span>
02975     <span class="comment">//  Check Flags for non-moveable reallocation and fail it</span>
02976     <span class="comment">//  unconditionally.  Apps that specify this flag should be</span>
02977     <span class="comment">//  prepared to deal with failure anyway.</span>
02978     <span class="comment">//</span>
02979 
02980     <span class="keywordflow">if</span> (Flags &amp; HEAP_REALLOC_IN_PLACE_ONLY) {
02981         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
02982     }
02983 
02984     <span class="comment">//</span>
02985     <span class="comment">//  Validate requested size so we don't overflow</span>
02986     <span class="comment">//  while rounding up size computations.  We do this</span>
02987     <span class="comment">//  after we've acquired the critsect so we can still</span>
02988     <span class="comment">//  catch serialization problems.</span>
02989     <span class="comment">//</span>
02990 
02991     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; 0x7FFF0000) {
02992         <a class="code" href="../../d6/d9/heappage_8c.html#a14">OUT_OF_VM_BREAK</a>( Flags, <span class="stringliteral">"Page heap: Invalid allocation size\n"</span> );
02993         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
02994     }
02995 
02996     OldNode = <a class="code" href="../../d6/d9/heappage_8c.html#a109">RtlpDebugPageHeapFindBusyMem</a>( HeapRoot, Address, &amp;OldPrev );
02997 
02998     <span class="keywordflow">if</span> (OldNode) {
02999         OriginalAllocationInPageHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03000     }
03001 
03002     <span class="keywordflow">if</span> (OldNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03003 
03004         <span class="comment">//</span>
03005         <span class="comment">// No wonder we did not find the block in the page heap</span>
03006         <span class="comment">// structures because the block was probably allocated</span>
03007         <span class="comment">// from the normal heap. Or there is a real bug. If there </span>
03008         <span class="comment">// is a bug NormalHeapReAllocate will break into debugger.</span>
03009         <span class="comment">//</span>
03010 
03011         NewAddress = <a class="code" href="../../d6/d9/heappage_8c.html#a71">RtlpDphNormalHeapReAllocate</a> (
03012 
03013             HeapRoot,
03014             Flags,
03015             Address,
03016             Size);
03017 
03018         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
03019     }
03020 
03021     <span class="comment">//</span>
03022     <span class="comment">//  If tail was allocated, make sure filler not overwritten</span>
03023     <span class="comment">//</span>
03024 
03025     <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_CATCH_BACKWARD_OVERRUNS)) {
03026 
03027         <span class="comment">// nothing</span>
03028     }
03029     <span class="keywordflow">else</span> {
03030 
03031         <span class="comment">//</span>
03032         <span class="comment">// (SilviuC): This can be done at the beginning of the function.</span>
03033         <span class="comment">//</span>
03034 
03035         <span class="keywordflow">if</span> (! (<a class="code" href="../../d6/d9/heappage_8c.html#a80">RtlpDphIsPageHeapBlock</a> (HeapRoot, Address, &amp;Reason, TRUE))) {
03036 
03037             <a class="code" href="../../d6/d9/heappage_8c.html#a77">RtlpDphReportCorruptedBlock</a> (Address, Reason);
03038         }
03039     }
03040 
03041     <span class="comment">//</span>
03042     <span class="comment">//  Before allocating a new block, remove the old block from</span>
03043     <span class="comment">//  the busy list.  When we allocate the new block, the busy</span>
03044     <span class="comment">//  list pointers will change, possibly leaving our acquired</span>
03045     <span class="comment">//  Prev pointer invalid.</span>
03046     <span class="comment">//</span>
03047 
03048     <a class="code" href="../../d6/d9/heappage_8c.html#a115">RtlpDebugPageHeapRemoveFromBusyList</a>( HeapRoot, OldNode, OldPrev );
03049 
03050     <span class="comment">//</span>
03051     <span class="comment">//  Allocate new memory for new requested size.  Use try/except</span>
03052     <span class="comment">//  to trap exception if Flags caused out-of-memory exception.</span>
03053     <span class="comment">//</span>
03054 
03055     <span class="keywordflow">try</span> {
03056 
03057         <span class="keywordflow">if</span> (!ForcePageHeap &amp;&amp; !(<a class="code" href="../../d6/d9/heappage_8c.html#a88">RtlpDphShouldAllocateInPageHeap</a> (HeapRoot, Size))) {
03058 
03059             NewAddress = <a class="code" href="../../d6/d9/heappage_8c.html#a69">RtlpDphNormalHeapAllocate</a> (
03060                 HeapRoot, 
03061                 Flags, 
03062                 Size);
03063 
03064             ReallocInNormalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03065         }
03066         <span class="keywordflow">else</span> {
03067 
03068             <span class="comment">//</span>
03069             <span class="comment">// Force the allocation in page heap by biasing</span>
03070             <span class="comment">// the heap handle. Validate the heap here since when we use</span>
03071             <span class="comment">// biased pointers validation inside Allocate is disabled.</span>
03072             <span class="comment">//</span>
03073 
03074             <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a23">DPH_DEBUG_INTERNAL_VALIDATION</a>)) {
03075                 <a class="code" href="../../d6/d9/heappage_8c.html#a106">RtlpDphInternalValidatePageHeap</a> (HeapRoot, OldNode-&gt;pVirtualBlock, OldNode-&gt;nVirtualBlockSize);
03076             }
03077 
03078             NewAddress = <a class="code" href="../../d7/d9/heappage_8h.html#a10">RtlpDebugPageHeapAllocate</a>( 
03079                 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a20">BIAS_POINTER</a>(HeapHandle), 
03080                 Flags, 
03081                 Size);
03082 
03083             
03084             <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a23">DPH_DEBUG_INTERNAL_VALIDATION</a>)) {
03085                 <a class="code" href="../../d6/d9/heappage_8c.html#a106">RtlpDphInternalValidatePageHeap</a> (HeapRoot, OldNode-&gt;pVirtualBlock, OldNode-&gt;nVirtualBlockSize);
03086             }
03087 
03088             ReallocInNormalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03089         }
03090     }
03091     except( EXCEPTION_EXECUTE_HANDLER ) {
03092     }
03093 
03094     <span class="comment">//</span>
03095     <span class="comment">// We managed to make a new allocation (normal or page heap).</span>
03096     <span class="comment">// Now we need to copy from old to new all sorts of stuff </span>
03097     <span class="comment">// (contents, user flags/values).</span>
03098     <span class="comment">//</span>
03099 
03100     <span class="keywordflow">if</span> (NewAddress) {
03101 
03102         <span class="comment">//</span>
03103         <span class="comment">// Copy old block contents into the new node.</span>
03104         <span class="comment">//</span>
03105 
03106         CopyDataSize = OldNode-&gt;nUserRequestedSize;
03107 
03108         <span class="keywordflow">if</span> (CopyDataSize &gt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) {
03109             CopyDataSize = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03110         }
03111 
03112         <span class="keywordflow">if</span> (CopyDataSize &gt; 0) {
03113 
03114             RtlCopyMemory(
03115                 NewAddress,
03116                 Address,
03117                 CopyDataSize
03118                 );
03119         }
03120 
03121         <span class="comment">//</span>
03122         <span class="comment">// If new allocation was done in page heap we need to detect the new node</span>
03123         <span class="comment">// and copy over user flags/values.</span>
03124         <span class="comment">//</span>
03125 
03126         <span class="keywordflow">if</span> (! ReallocInNormalHeap) {
03127 
03128             NewNode = <a class="code" href="../../d6/d9/heappage_8c.html#a109">RtlpDebugPageHeapFindBusyMem</a>( HeapRoot, NewAddress, NULL );
03129 
03130             <span class="comment">//</span>
03131             <span class="comment">// This block could not be in normal heap therefore from this</span>
03132             <span class="comment">// respect the call above should always succeed.</span>
03133             <span class="comment">//</span>
03134 
03135             <a class="code" href="../../d6/d9/heappage_8c.html#a11">DEBUG_ASSERT</a>( NewNode != NULL );
03136 
03137             NewNode-&gt;UserValue = OldNode-&gt;UserValue;
03138             NewNode-&gt;UserFlags = ( Flags &amp; HEAP_SETTABLE_USER_FLAGS ) ?
03139                 ( Flags &amp; HEAP_SETTABLE_USER_FLAGS ) :
03140             OldNode-&gt;UserFlags;
03141 
03142         }
03143         
03144         <span class="comment">//</span>
03145         <span class="comment">// We need to cover the case where old allocation was in page heap.</span>
03146         <span class="comment">// In this case we still need to cleanup the old node and </span>
03147         <span class="comment">// insert it back in free list. Actually the way the code is written</span>
03148         <span class="comment">// we take this code path only if original allocation was in page heap.</span>
03149         <span class="comment">// This is the reason for the assert.</span>
03150         <span class="comment">//</span>
03151 
03152 
03153         <a class="code" href="../../d6/d9/heappage_8c.html#a10">RETAIL_ASSERT</a> (OriginalAllocationInPageHeap);
03154 
03155         <span class="keywordflow">if</span> (OriginalAllocationInPageHeap) {
03156 
03157             <span class="keywordflow">if</span> (OldNode-&gt;nVirtualAccessSize &gt; 0) {
03158                 <a class="code" href="../../d6/d9/heappage_8c.html#a98">RtlpDebugPageHeapProtectVM</a>( OldNode-&gt;pVirtualBlock,
03159                     OldNode-&gt;nVirtualAccessSize,
03160                     PAGE_NOACCESS );
03161             }
03162 
03163             <span class="comment">//</span>
03164             <span class="comment">// If we use uncommitted ranges we need to decommit the memory</span>
03165             <span class="comment">// range now. Note that the next page (guard) was already decommitted</span>
03166             <span class="comment">// when we made the allocation.</span>
03167             <span class="comment">//</span>
03168 
03169             <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_CATCH_BACKWARD_OVERRUNS)) {
03170 
03171                 <span class="comment">// nothing            </span>
03172 
03173             }
03174             <span class="keywordflow">else</span> {
03175 
03176                 <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_SMART_MEMORY_USAGE)) {
03177 
03178                     <a class="code" href="../../d6/d9/heappage_8c.html#a102">RtlpDebugPageHeapDecommitVM</a> (
03179                         OldNode-&gt;pVirtualBlock, 
03180                         OldNode-&gt;nVirtualAccessSize);
03181                 }
03182             }
03183 
03184             <a class="code" href="../../d6/d9/heappage_8c.html#a111">RtlpDebugPageHeapPlaceOnFreeList</a>( HeapRoot, OldNode );
03185 
03186             <span class="comment">//</span>
03187             <span class="comment">// RtlpDebugPageHeapReAllocate gets called from RtlDebugReAllocateHeap,</span>
03188             <span class="comment">// which gets called from RtlReAllocateHeap.  To keep from wasting</span>
03189             <span class="comment">// lots of stack trace storage, we'll skip the bottom 2 entries,</span>
03190             <span class="comment">// leaving RtlReAllocateHeap as the first recorded entry in the</span>
03191             <span class="comment">// freed stack trace.</span>
03192             <span class="comment">//</span>
03193             <span class="comment">// Note. For realloc we need to do the accounting for free in the</span>
03194             <span class="comment">// trace block. The accounting for alloc is done in the real</span>
03195             <span class="comment">// alloc operation which always happens for page heap reallocs.</span>
03196             <span class="comment">//</span>
03197 
03198             <span class="keywordflow">if</span> ((HeapRoot-&gt;ExtraFlags &amp; PAGE_HEAP_COLLECT_STACK_TRACES)) {
03199 
03200                 <span class="keywordflow">if</span> (OldNode-&gt;StackTrace) {
03201 
03202                     RtlTraceDatabaseLock (RtlpDphTraceDatabase);
03203 
03204                     <span class="keywordflow">if</span> (OldNode-&gt;StackTrace-&gt;UserCount &gt; 0) {
03205                         OldNode-&gt;StackTrace-&gt;UserCount -= 1;
03206                     }
03207 
03208                     <span class="keywordflow">if</span> (OldNode-&gt;StackTrace-&gt;UserSize &gt;= OldNode-&gt;nUserRequestedSize) {
03209                         OldNode-&gt;StackTrace-&gt;UserSize -= OldNode-&gt;nUserRequestedSize;
03210                     }
03211 
03212                     RtlTraceDatabaseUnlock (RtlpDphTraceDatabase);
03213                 }
03214 
03215                 OldNode-&gt;StackTrace = <a class="code" href="../../d6/d9/heappage_8c.html#a89">RtlpDphLogStackTrace</a>(2);
03216             }
03217             <span class="keywordflow">else</span> {
03218                 OldNode-&gt;StackTrace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03219             }
03220         }
03221     }
03222 
03223     <span class="keywordflow">else</span> {
03224 
03225         <span class="comment">//</span>
03226         <span class="comment">//  Failed to allocate a new block.  Return old block to busy list.</span>
03227         <span class="comment">//</span>
03228 
03229         <span class="keywordflow">if</span> (OriginalAllocationInPageHeap) {
03230 
03231             <a class="code" href="../../d6/d9/heappage_8c.html#a114">RtlpDebugPageHeapPlaceOnBusyList</a>( HeapRoot, OldNode );
03232         }
03233 
03234     }
03235 
03236     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>:
03237 
03238     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d9/heappage_8c.html#a51">RtlpDphDebugLevel</a> &amp; <a class="code" href="../../d6/d9/heappage_8c.html#a23">DPH_DEBUG_INTERNAL_VALIDATION</a>)) {
03239         <a class="code" href="../../d6/d9/heappage_8c.html#a106">RtlpDphInternalValidatePageHeap</a> (HeapRoot, NULL, 0);
03240     }
03241 
03242     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03243     <a class="code" href="../../d6/d9/heappage_8c.html#a9">DEBUG_CODE</a>( RtlpDebugPageHeapVerifyIntegrity( HeapRoot ));
03244     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03245 
03246     <span class="keywordflow">if</span> (NewAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03247         <a class="code" href="../../d6/d9/heappage_8c.html#a13">IF_GENERATE_EXCEPTION</a>( Flags, STATUS_NO_MEMORY );
03248     }
03249 
03250     <span class="keywordflow">return</span> NewAddress;
03251 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="heappage.h::RtlpDebugPageHeapReset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpDebugPageHeapReset           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03837">3837</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
<pre class="fragment"><div>03841 {
03842     <span class="keywordflow">return</span> STATUS_SUCCESS;
03843 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="heappage.h::RtlpDebugPageHeapSerialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpDebugPageHeapSerialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HeapHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03795">3795</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00323">RtlpSerializeHeap()</a>.
<p>
<pre class="fragment"><div>03798 {
03799     PDPH_HEAP_ROOT HeapRoot;
03800 
03801     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03802     <span class="keywordflow">if</span> ( HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
03803         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03804 
03805     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, 0 );
03806     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03807 
03808     HeapRoot-&gt;HeapFlags &amp;= ~HEAP_NO_SERIALIZE;
03809 
03810     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03811     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03812 
03813     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03814 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="heappage.h::RtlpDebugPageHeapSetUserFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpDebugPageHeapSetUserFlags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UserFlagsReset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UserFlagsSet</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03740">3740</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01053">RtlpDebugPageHeapFindBusyMem()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04664">RtlpDphNormalHeapSetUserFlags()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01086">RtlDebugSetUserFlagsHeap()</a>.
<p>
<pre class="fragment"><div>03747 {
03748     PDPH_HEAP_ROOT       HeapRoot;
03749     PDPH_HEAP_BLOCK Node;
03750     BOOLEAN              Success;
03751 
03752     Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03753 
03754     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03755     <span class="keywordflow">if</span> ( HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
03756         <span class="keywordflow">return</span> Success;
03757 
03758     Flags |= HeapRoot-&gt;HeapFlags;
03759 
03760     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
03761     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03762 
03763     Node = <a class="code" href="../../d6/d9/heappage_8c.html#a109">RtlpDebugPageHeapFindBusyMem</a>( HeapRoot, Address, NULL );
03764 
03765     <span class="keywordflow">if</span> ( Node == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03766 
03767         <span class="comment">//</span>
03768         <span class="comment">// If we cannot find the node in page heap structures it might be</span>
03769         <span class="comment">// because it has been allocated from normal heap.</span>
03770         <span class="comment">//</span>
03771 
03772         Success = <a class="code" href="../../d6/d9/heappage_8c.html#a73">RtlpDphNormalHeapSetUserFlags</a> (
03773             HeapRoot,
03774             Flags,
03775             Address,
03776             UserFlagsReset,
03777             UserFlagsSet);
03778 
03779         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
03780     }
03781     <span class="keywordflow">else</span> {
03782         Node-&gt;UserFlags &amp;= ~( UserFlagsReset );
03783         Node-&gt;UserFlags |=    UserFlagsSet;
03784         Success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03785     }
03786 
03787     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>:
03788     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03789     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03790 
03791     <span class="keywordflow">return</span> Success;
03792 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="heappage.h::RtlpDebugPageHeapSetUserValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpDebugPageHeapSetUserValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>UserValue</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03631">3631</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01053">RtlpDebugPageHeapFindBusyMem()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04694">RtlpDphNormalHeapSetUserValue()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01002">RtlDebugSetUserValueHeap()</a>.
<p>
<pre class="fragment"><div>03637 {
03638     PDPH_HEAP_ROOT       HeapRoot;
03639     PDPH_HEAP_BLOCK Node;
03640     BOOLEAN              Success;
03641 
03642     Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03643 
03644     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03645     <span class="keywordflow">if</span> ( HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
03646         <span class="keywordflow">return</span> Success;
03647 
03648     Flags |= HeapRoot-&gt;HeapFlags;
03649 
03650     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
03651     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03652 
03653     Node = <a class="code" href="../../d6/d9/heappage_8c.html#a109">RtlpDebugPageHeapFindBusyMem</a>( HeapRoot, Address, NULL );
03654 
03655     <span class="keywordflow">if</span> ( Node == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03656 
03657         <span class="comment">//</span>
03658         <span class="comment">// If we cannot find the node in page heap structures it might be</span>
03659         <span class="comment">// because it has been allocated from normal heap.</span>
03660         <span class="comment">//</span>
03661 
03662         Success = <a class="code" href="../../d6/d9/heappage_8c.html#a74">RtlpDphNormalHeapSetUserValue</a> (
03663             HeapRoot,
03664             Flags,
03665             Address,
03666             UserValue);
03667 
03668         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
03669     }
03670     <span class="keywordflow">else</span> {
03671         Node-&gt;UserValue = UserValue;
03672         Success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03673     }
03674 
03675     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>:
03676     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03677     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03678 
03679     <span class="keywordflow">return</span> Success;
03680 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="heappage.h::RtlpDebugPageHeapSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T RtlpDebugPageHeapSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03401">3401</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00055">EXIT</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00119">IF_GENERATE_EXCEPTION</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01053">RtlpDebugPageHeapFindBusyMem()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04620">RtlpDphNormalHeapSize()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01177">RtlDebugSizeHeap()</a>.
<p>
<pre class="fragment"><div>03406 {
03407     PDPH_HEAP_ROOT       HeapRoot;
03408     PDPH_HEAP_BLOCK Node;
03409     SIZE_T               <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03410 
03411     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = -1;
03412 
03413     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03414     <span class="keywordflow">if</span> (HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03415         <span class="keywordflow">return</span> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03416     }
03417 
03418     Flags |= HeapRoot-&gt;HeapFlags;
03419 
03420     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
03421     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03422 
03423     Node = <a class="code" href="../../d6/d9/heappage_8c.html#a109">RtlpDebugPageHeapFindBusyMem</a>( HeapRoot, Address, NULL );
03424 
03425     <span class="keywordflow">if</span> (Node == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03426 
03427         <span class="comment">//</span>
03428         <span class="comment">// No wonder we did not find the block in the page heap</span>
03429         <span class="comment">// structures because the block was probably allocated</span>
03430         <span class="comment">// from the normal heap. Or there is a real bug. If there</span>
03431         <span class="comment">// is a bug NormalHeapSize will break into debugger.</span>
03432         <span class="comment">//</span>
03433 
03434         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d6/d9/heappage_8c.html#a72">RtlpDphNormalHeapSize</a> (
03435 
03436             HeapRoot,
03437             Flags,
03438             Address);
03439 
03440         <span class="keywordflow">goto</span> <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>;
03441     }
03442     <span class="keywordflow">else</span> {
03443         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = Node-&gt;nUserRequestedSize;
03444     }
03445 
03446     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>:
03447     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03448     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03449 
03450     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == -1) {
03451         <a class="code" href="../../d6/d9/heappage_8c.html#a13">IF_GENERATE_EXCEPTION</a>( Flags, STATUS_ACCESS_VIOLATION );
03452     }
03453 
03454     <span class="keywordflow">return</span> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03455 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="heappage.h::RtlpDebugPageHeapUnlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpDebugPageHeapUnlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HeapHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03613">3613</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00454">RtlUnlockHeap()</a>.
<p>
<pre class="fragment"><div>03616 {
03617     PDPH_HEAP_ROOT HeapRoot;
03618 
03619     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03620 
03621     <span class="keywordflow">if</span> (HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03622         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03623     }
03624 
03625     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03626 
03627     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03628 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="heappage.h::RtlpDebugPageHeapUsage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpDebugPageHeapUsage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PRTL_HEAP_USAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>Usage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03846">3846</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>, and <a class="el" href="../../d2/d0/hivedmp_8c-source.html#l00066">Usage()</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01572">RtlDebugUsageHeap()</a>.
<p>
<pre class="fragment"><div>03851 {
03852     PDPH_HEAP_ROOT HeapRoot;
03853 
03854     <span class="comment">//</span>
03855     <span class="comment">//  Partial implementation since this information is kind of meaningless.</span>
03856     <span class="comment">//</span>
03857 
03858     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03859     <span class="keywordflow">if</span> ( HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
03860         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03861 
03862     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a>-&gt;Length != <span class="keyword">sizeof</span>( RTL_HEAP_USAGE ))
03863         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03864 
03865     memset( Usage, 0, <span class="keyword">sizeof</span>( RTL_HEAP_USAGE ));
03866     <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a>-&gt;Length = <span class="keyword">sizeof</span>( RTL_HEAP_USAGE );
03867 
03868     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, 0 );
03869     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03870 
03871     <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a>-&gt;BytesAllocated       = HeapRoot-&gt;nBusyAllocationBytesAccessible;
03872     <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a>-&gt;BytesCommitted       = HeapRoot-&gt;nVirtualStorageBytes;
03873     <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a>-&gt;BytesReserved        = HeapRoot-&gt;nVirtualStorageBytes;
03874     <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a>-&gt;BytesReservedMaximum = HeapRoot-&gt;nVirtualStorageBytes;
03875 
03876     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03877     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03878 
03879     <span class="keywordflow">return</span> STATUS_SUCCESS;
03880 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="heappage.h::RtlpDebugPageHeapValidate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpDebugPageHeapValidate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03539">3539</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
References <a class="el" href="../../d7/d8/heappage_8c-source.html#l00108">DEBUG_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00170">PROTECT_HEAP_STRUCTURES</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00627">RtlpDebugPageHeapEnterCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01053">RtlpDebugPageHeapFindBusyMem()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00666">RtlpDebugPageHeapLeaveCritSect()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00689">RtlpDebugPageHeapPointerFromHandle()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04752">RtlpDphNormalHeapValidate()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l00175">UNPROTECT_HEAP_STRUCTURES</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02530">RtlValidateHeap()</a>.
<p>
<pre class="fragment"><div>03544 {
03545     PDPH_HEAP_ROOT       HeapRoot;
03546     PDPH_HEAP_BLOCK Node;
03547     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03548 
03549     HeapRoot = <a class="code" href="../../d6/d9/heappage_8c.html#a95">RtlpDebugPageHeapPointerFromHandle</a>( HeapHandle );
03550     <span class="keywordflow">if</span> (HeapRoot == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03551         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03552 
03553     Flags |= HeapRoot-&gt;HeapFlags;
03554 
03555     <a class="code" href="../../d6/d9/heappage_8c.html#a92">RtlpDebugPageHeapEnterCritSect</a>( HeapRoot, Flags );
03556     <a class="code" href="../../d6/d9/heappage_8c.html#a9">DEBUG_CODE</a>( RtlpDebugPageHeapVerifyIntegrity( HeapRoot ));
03557     <a class="code" href="../../d6/d9/heappage_8c.html#a22">UNPROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03558 
03559     Node = Address ? <a class="code" href="../../d6/d9/heappage_8c.html#a109">RtlpDebugPageHeapFindBusyMem</a>( HeapRoot, Address, NULL ) : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03560 
03561     <span class="keywordflow">if</span> (Node == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03562 
03563         Result = <a class="code" href="../../d6/d9/heappage_8c.html#a76">RtlpDphNormalHeapValidate</a> (
03564             HeapRoot,
03565             Flags,
03566             Address);
03567     }
03568 
03569     <a class="code" href="../../d6/d9/heappage_8c.html#a21">PROTECT_HEAP_STRUCTURES</a>( HeapRoot );
03570     <a class="code" href="../../d6/d9/heappage_8c.html#a93">RtlpDebugPageHeapLeaveCritSect</a>( HeapRoot );
03571 
03572     <span class="keywordflow">if</span> (Address) {
03573         <span class="keywordflow">if</span> (Node) {
03574             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03575         }
03576         <span class="keywordflow">else</span> {
03577             <span class="keywordflow">return</span> Result;
03578         }
03579     }
03580     <span class="keywordflow">else</span> {
03581         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03582     }
03583 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="heappage.h::RtlpDebugPageHeapWalk" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpDebugPageHeapWalk           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PRTL_HEAP_WALK_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03586">3586</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l03714">RtlWalkHeap()</a>.
<p>
<pre class="fragment"><div>03590 {
03591     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
03592 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="heappage.h::RtlpDebugPageHeapZero" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpDebugPageHeapZero           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d8/heappage_8c-source.html#l03828">3828</a> of file <a class="el" href="../../d7/d8/heappage_8c-source.html">heappage.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01338">RtlDebugZeroHeap()</a>.
<p>
<pre class="fragment"><div>03832 {
03833     <span class="keywordflow">return</span> STATUS_SUCCESS;
03834 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
