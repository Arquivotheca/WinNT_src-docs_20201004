<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mmquota.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mmquota.c</h1><a href="../../d6/d1/mmquota_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   mmquota.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the quota and</span>
00012 <span class="comment">    commitment charging for memory management.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 12-December-89</span>
00017 <span class="comment">    Landy Wang (landyw) 02-Jun-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a0">00025</a> <span class="preprocessor">#define MM_MAXIMUM_QUOTA_OVERCHARGE 9</span>
00026 <span class="preprocessor"></span>
<a name="l00027"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a1">00027</a> <span class="preprocessor">#define MM_DONT_EXTEND_SIZE 512</span>
00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a2">00029</a> <span class="preprocessor">#define MM_COMMIT_POPUP_MAX ((512*1024)/PAGE_SIZE)</span>
00030 <span class="preprocessor"></span>
<a name="l00031"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a3">00031</a> <span class="preprocessor">#define MM_EXTEND_COMMIT ((1024*1024)/PAGE_SIZE)</span>
00032 <span class="preprocessor"></span>
<a name="l00033"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a4">00033</a> SIZE_T <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a>;
00034 
<a name="l00035"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a5">00035</a> SIZE_T <a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a>;
00036 
<a name="l00037"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a6">00037</a> SIZE_T <a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a>;
00038 
<a name="l00039"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a7">00039</a> LOGICAL <a class="code" href="../../d6/d1/mmquota_8c.html#a7">MiCommitExtensionActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00040 
<a name="l00041"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a8">00041</a> <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d6/d1/mmquota_8c.html#a8">MmAllocatedPagedPool</a>;
00042 
<a name="l00043"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a9">00043</a> <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>;
00044 
<a name="l00045"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a10">00045</a> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a744">MiOverCommitCallCount</a>;
<a name="l00046"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a11">00046</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">EPROCESS_QUOTA_BLOCK</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>;
00047 
00048 
00049 LOGICAL
00050 <a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a>(
00051     IN SIZE_T NumberOfPages,
00052     IN ULONG Extension
00053     );
00054 
00055 
00056 ULONG
00057 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00058"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a15">00058</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a15">MiChargePageFileQuota</a> (
00059     IN SIZE_T QuotaCharge,
00060     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
00061     )
00062 
00063 <span class="comment">/*++</span>
00064 <span class="comment"></span>
00065 <span class="comment">Routine Description:</span>
00066 <span class="comment"></span>
00067 <span class="comment">    This routine checks to ensure the user has sufficient page file</span>
00068 <span class="comment">    quota remaining and, if so, charges the quota.  If not an exception</span>
00069 <span class="comment">    is raised.</span>
00070 <span class="comment"></span>
00071 <span class="comment">Arguments:</span>
00072 <span class="comment"></span>
00073 <span class="comment">    QuotaCharge - Supplies the quota amount to charge.</span>
00074 <span class="comment"></span>
00075 <span class="comment">    CurrentProcess - Supplies a pointer to the current process.</span>
00076 <span class="comment"></span>
00077 <span class="comment">Return Value:</span>
00078 <span class="comment"></span>
00079 <span class="comment">    TRUE if the quota was successfully charged, raises an exception</span>
00080 <span class="comment">    otherwise.</span>
00081 <span class="comment"></span>
00082 <span class="comment">Environment:</span>
00083 <span class="comment"></span>
00084 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes</span>
00085 <span class="comment">    held.</span>
00086 <span class="comment"></span>
00087 <span class="comment">--*/</span>
00088 
00089 {
00090     SIZE_T NewPagefileValue;
00091     <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">PEPROCESS_QUOTA_BLOCK</a> QuotaBlock;
00092     KIRQL OldIrql;
00093 
00094     QuotaBlock = CurrentProcess-&gt;QuotaBlock;
00095 
00096 retry_charge:
00097     <span class="keywordflow">if</span> ( QuotaBlock != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>) {
00098         ExAcquireFastLock (&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,&amp;OldIrql);
00099 do_charge:
00100         NewPagefileValue = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> + QuotaCharge;
00101 
00102         <span class="keywordflow">if</span> (NewPagefileValue &gt; QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o7">PagefileLimit</a>) {
00103             ExReleaseFastLock (&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00104             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_PAGEFILE_QUOTA_EXCEEDED);
00105         }
00106 
00107         QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> = NewPagefileValue;
00108 
00109         <span class="keywordflow">if</span> (NewPagefileValue &gt; QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o5">PeakPagefileUsage</a>) {
00110             QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o5">PeakPagefileUsage</a> = NewPagefileValue;
00111         }
00112 
00113         NewPagefileValue = CurrentProcess-&gt;PagefileUsage + QuotaCharge;
00114         CurrentProcess-&gt;PagefileUsage = NewPagefileValue;
00115 
00116         <span class="keywordflow">if</span> (NewPagefileValue &gt; CurrentProcess-&gt;PeakPagefileUsage) {
00117             CurrentProcess-&gt;PeakPagefileUsage = NewPagefileValue;
00118         }
00119         ExReleaseFastLock (&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00120     } <span class="keywordflow">else</span> {
00121         ExAcquireFastLock (&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,&amp;OldIrql);
00122 
00123         <span class="keywordflow">if</span> ( (QuotaBlock = CurrentProcess-&gt;QuotaBlock) != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>) {
00124             ExReleaseFastLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00125             <span class="keywordflow">goto</span> retry_charge;
00126         }
00127         <span class="keywordflow">goto</span> do_charge;
00128     }
00129     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00130 }
00131 
00132 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00133"></a><a class="code" href="../../d0/d2/psquota_8c.html#a5">00133</a> <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (
00134     IN SIZE_T QuotaCharge,
00135     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
00136     )
00137 
00138 <span class="comment">/*++</span>
00139 <span class="comment"></span>
00140 <span class="comment">Routine Description:</span>
00141 <span class="comment"></span>
00142 <span class="comment">    This routine releases page file quota.</span>
00143 <span class="comment"></span>
00144 <span class="comment">Arguments:</span>
00145 <span class="comment"></span>
00146 <span class="comment">    QuotaCharge - Supplies the quota amount to charge.</span>
00147 <span class="comment"></span>
00148 <span class="comment">    CurrentProcess - Supplies a pointer to the current process.</span>
00149 <span class="comment"></span>
00150 <span class="comment">Return Value:</span>
00151 <span class="comment"></span>
00152 <span class="comment">    none.</span>
00153 <span class="comment"></span>
00154 <span class="comment">Environment:</span>
00155 <span class="comment"></span>
00156 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes</span>
00157 <span class="comment">    held.</span>
00158 <span class="comment"></span>
00159 <span class="comment">--*/</span>
00160 
00161 {
00162 
00163     <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">PEPROCESS_QUOTA_BLOCK</a> QuotaBlock;
00164     KIRQL OldIrql;
00165 
00166     QuotaBlock = CurrentProcess-&gt;QuotaBlock;
00167 
00168 retry_return:
00169     <span class="keywordflow">if</span> ( QuotaBlock != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>) {
00170         ExAcquireFastLock (&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>, &amp;OldIrql);
00171 do_return:
00172         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentProcess-&gt;PagefileUsage &gt;= QuotaCharge);
00173         CurrentProcess-&gt;PagefileUsage -= QuotaCharge;
00174 
00175         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> &gt;= QuotaCharge);
00176         QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> -= QuotaCharge;
00177         ExReleaseFastLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00178     } <span class="keywordflow">else</span> {
00179         ExAcquireFastLock (&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>, &amp;OldIrql);
00180         <span class="keywordflow">if</span> ( (QuotaBlock = CurrentProcess-&gt;QuotaBlock) != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a> ) {
00181             ExReleaseFastLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00182             <span class="keywordflow">goto</span> retry_return;
00183         }
00184         <span class="keywordflow">goto</span> do_return;
00185     }
00186     <span class="keywordflow">return</span>;
00187 }
00188 
00189 LOGICAL
00190 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00191"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a17">00191</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (
00192     IN SIZE_T QuotaCharge,
00193     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL
00194     )
00195 
00196 <span class="comment">/*++</span>
00197 <span class="comment"></span>
00198 <span class="comment">Routine Description:</span>
00199 <span class="comment"></span>
00200 <span class="comment">    This routine checks to ensure the system has sufficient page file</span>
00201 <span class="comment">    space remaining.</span>
00202 <span class="comment"></span>
00203 <span class="comment">Arguments:</span>
00204 <span class="comment"></span>
00205 <span class="comment">    QuotaCharge - Supplies the quota amount to charge.</span>
00206 <span class="comment"></span>
00207 <span class="comment">    Process - Optionally supplies the current process IF AND ONLY IF</span>
00208 <span class="comment">              the working set mutex is held.  If the paging file</span>
00209 <span class="comment">              is being extended, the working set mutex is released if</span>
00210 <span class="comment">              this is non-null.</span>
00211 <span class="comment"></span>
00212 <span class="comment">Return Value:</span>
00213 <span class="comment"></span>
00214 <span class="comment">    TRUE if there is sufficient space, FALSE if not.</span>
00215 <span class="comment"></span>
00216 <span class="comment">Environment:</span>
00217 <span class="comment"></span>
00218 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes</span>
00219 <span class="comment">    held.</span>
00220 <span class="comment"></span>
00221 <span class="comment">--*/</span>
00222 
00223 {
00224     KIRQL OldIrql;
00225     SIZE_T NewCommitValue;
00226     <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">MMPAGE_FILE_EXPANSION</a> PageExtend;
00227     LOGICAL WsHeldSafe;
00228 
00229 <span class="preprocessor">#if !defined (_WIN64)</span>
00230 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (QuotaCharge &lt; 0x100000);
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>
00233     ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
00234 
00235     NewCommitValue = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + QuotaCharge;
00236 
00237     <span class="keywordflow">while</span> (NewCommitValue &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
00238 
00239         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
00240 
00241         <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00242 
00243             <span class="comment">//</span>
00244             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
00245             <span class="comment">// by our caller.  Handle both cases here and below.</span>
00246             <span class="comment">//</span>
00247 
00248             <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a>(Process, WsHeldSafe);
00249         }
00250 
00251         <span class="comment">//</span>
00252         <span class="comment">// Queue a message to the segment dereferencing / pagefile extending</span>
00253         <span class="comment">// thread to see if the page file can be extended.  This is done</span>
00254         <span class="comment">// in the context of a system thread due to mutexes which may</span>
00255         <span class="comment">// currently be held.</span>
00256         <span class="comment">//</span>
00257 
00258         PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = QuotaCharge;
00259         PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o0">Segment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00260         PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o6">PageFileNumber</a> = <a class="code" href="../../d4/d8/mi_8h.html#a221">MI_EXTEND_ANY_PAGEFILE</a>;
00261         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o4">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00262 
00263         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a58">MiIssuePageExtendRequest</a> (&amp;PageExtend) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00264 
00265             <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00266                 <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a>(Process, WsHeldSafe);
00267             }
00268 
00269             <span class="comment">//</span>
00270             <span class="comment">// If the quota is small enough, commit it anyway.  Otherwise</span>
00271             <span class="comment">// return an error.</span>
00272             <span class="comment">//</span>
00273 
00274             <span class="keywordflow">if</span> (QuotaCharge &lt; <a class="code" href="../../d6/d1/mmquota_8c.html#a0">MM_MAXIMUM_QUOTA_OVERCHARGE</a>) {
00275 
00276                 <span class="comment">//</span>
00277                 <span class="comment">// Try the can't expand routine.</span>
00278                 <span class="comment">//</span>
00279 
00280                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (QuotaCharge, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00281                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00282                 }
00283             } <span class="keywordflow">else</span> {
00284 
00285                 <span class="comment">//</span>
00286                 <span class="comment">// Put up a popup and grant an extension if possible.</span>
00287                 <span class="comment">//</span>
00288 
00289                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a> (QuotaCharge, <a class="code" href="../../d6/d1/mmquota_8c.html#a3">MM_EXTEND_COMMIT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00290                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00291                 }
00292             }
00293             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00294         }
00295 
00296         <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00297             <span class="keywordflow">if</span> (WsHeldSafe == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00298                 <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
00299             }
00300             <span class="keywordflow">else</span> {
00301                 <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00302             }
00303         }
00304 
00305         <span class="keywordflow">if</span> (PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o3">ActualExpansion</a> == 0) {
00306             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a> (QuotaCharge, <a class="code" href="../../d6/d1/mmquota_8c.html#a3">MM_EXTEND_COMMIT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00307                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00308             }
00309             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00310         }
00311 
00312         ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
00313         NewCommitValue = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + QuotaCharge;
00314     }
00315 
00316     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> = NewCommitValue;
00317     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a>) &amp;&amp;
00318         (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> == 0)) {
00319         <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
00320     }
00321 
00322     ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
00323 
00324     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00325 }
00326 
00327 LOGICAL
00328 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00329"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a18">00329</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (
00330     IN SIZE_T QuotaCharge,
00331     IN ULONG MustSucceed
00332     )
00333 
00334 <span class="comment">/*++</span>
00335 <span class="comment"></span>
00336 <span class="comment">Routine Description:</span>
00337 <span class="comment"></span>
00338 <span class="comment">    This routine charges the specified commitment without attempting</span>
00339 <span class="comment">    to expand paging file and waiting for the expansion.  The routine</span>
00340 <span class="comment">    determines if the paging file space is exhausted, and if so,</span>
00341 <span class="comment">    it attempts to ascertain if the paging file space could be expanded.</span>
00342 <span class="comment"></span>
00343 <span class="comment">Arguments:</span>
00344 <span class="comment"></span>
00345 <span class="comment">    QuotaCharge - Supplies the quota amount to charge.</span>
00346 <span class="comment"></span>
00347 <span class="comment">    MustSucceed - Supplies TRUE if the charge must succeed.</span>
00348 <span class="comment"></span>
00349 <span class="comment">Return Value:</span>
00350 <span class="comment"></span>
00351 <span class="comment">    TRUE if the commitment was permitted, FALSE if not.</span>
00352 <span class="comment"></span>
00353 <span class="comment">Environment:</span>
00354 <span class="comment"></span>
00355 <span class="comment">    Kernel mode, APCs disabled.</span>
00356 <span class="comment"></span>
00357 <span class="comment">--*/</span>
00358 
00359 {
00360     KIRQL OldIrql;
00361     SIZE_T NewCommitValue;
00362     SIZE_T ExtendAmount;
00363 
00364     ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
00365 
00366     <span class="comment">//</span>
00367     <span class="comment">// If the overcommitment is bigger than 512 pages, don't extend.</span>
00368     <span class="comment">//</span>
00369 
00370     NewCommitValue = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + QuotaCharge;
00371 
00372     <span class="keywordflow">if</span> (!MustSucceed) {
00373 
00374         <span class="keywordflow">if</span> (NewCommitValue &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
00375 
00376             <span class="keywordflow">if</span> ((NewCommitValue - <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> &gt; <a class="code" href="../../d6/d1/mmquota_8c.html#a1">MM_DONT_EXTEND_SIZE</a>) ||
00377                 (NewCommitValue &lt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>) ||
00378                 (NewCommitValue &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>)) {
00379 
00380                     ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
00381                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382             }
00383         }
00384         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewCommitValue &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
00385             ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
00386             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00387         }
00388     }
00389 
00390     ExtendAmount = NewCommitValue - <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
00391     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> = NewCommitValue;
00392 
00393     <span class="keywordflow">if</span> (NewCommitValue &gt; (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> + 20)) {
00394 
00395         <span class="comment">//</span>
00396         <span class="comment">// Attempt to expand the paging file, but don't wait</span>
00397         <span class="comment">// to see if it succeeds.</span>
00398         <span class="comment">//</span>
00399 
00400         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00401 
00402             <span class="comment">//</span>
00403             <span class="comment">// An expansion request is already in progress, assume</span>
00404             <span class="comment">// this will succeed.</span>
00405             <span class="comment">//</span>
00406 
00407             ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
00408             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00409         }
00410 
00411         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00412         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
00413 
00414         <span class="comment">//</span>
00415         <span class="comment">// Queue a message to the segment dereferencing / pagefile extending</span>
00416         <span class="comment">// thread to see if the page file can be extended.  This is done</span>
00417         <span class="comment">// in the context of a system thread due to mutexes which may</span>
00418         <span class="comment">// currently be held.</span>
00419         <span class="comment">//</span>
00420 
00421         <span class="keywordflow">if</span> (QuotaCharge &gt; ExtendAmount) {
00422             ExtendAmount = QuotaCharge;
00423         }
00424 
00425         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = ExtendAmount;
00426         ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
00427         InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>,
00428                          &amp;<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o1">DereferenceList</a>);
00429         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
00430 
00431         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00432     }
00433     <span class="keywordflow">else</span> {
00434         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
00435     }
00436 
00437     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00438 }
00439 
00440 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00441 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00442"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a19">00442</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (
00443     IN SIZE_T QuotaCharge
00444     )
00445 
00446 <span class="comment">/*++</span>
00447 <span class="comment"></span>
00448 <span class="comment">Routine Description:</span>
00449 <span class="comment"></span>
00450 <span class="comment">    This routine releases page file quota.</span>
00451 <span class="comment"></span>
00452 <span class="comment">Arguments:</span>
00453 <span class="comment"></span>
00454 <span class="comment">    QuotaCharge - Supplies the quota amount to charge.</span>
00455 <span class="comment"></span>
00456 <span class="comment">    CurrentProcess - Supplies a pointer to the current process.</span>
00457 <span class="comment"></span>
00458 <span class="comment">Return Value:</span>
00459 <span class="comment"></span>
00460 <span class="comment">    none.</span>
00461 <span class="comment"></span>
00462 <span class="comment">Environment:</span>
00463 <span class="comment"></span>
00464 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes</span>
00465 <span class="comment">    held.</span>
00466 <span class="comment"></span>
00467 <span class="comment">--*/</span>
00468 
00469 {
00470     KIRQL OldIrql;
00471 
00472     ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
00473 
00474     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt;= QuotaCharge);
00475 
00476     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= QuotaCharge;
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// If commit allotments have been temporarily blocked then open the</span>
00480     <span class="comment">// floodgates provided either enough commit has been freed or the pagefile</span>
00481     <span class="comment">// extension has succeeded.</span>
00482     <span class="comment">//</span>
00483 
00484     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>) {
00485         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt;= <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>);
00486         <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>;
00487         <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> = 0;
00488     }
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// If the system automatically granted an increase that can be returned</span>
00492     <span class="comment">// now, do it.</span>
00493     <span class="comment">//</span>
00494 
00495     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a7">MiCommitExtensionActive</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00496 
00497         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a> != 0) &amp;&amp;
00498             (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>) &amp;&amp;
00499             (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> - <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a>)) {
00500                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> -= <a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a>;
00501                 <a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a> = 0;
00502         }
00503 
00504         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> != 0) {
00505             <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= <a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a>;
00506             <a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> = 0;
00507         }
00508 
00509         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a> == 0) &amp;&amp; (<a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> == 0)) {
00510             <a class="code" href="../../d6/d1/mmquota_8c.html#a7">MiCommitExtensionActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00511         }
00512     }
00513 
00514     ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
00515     <span class="keywordflow">return</span>;
00516 }
00517 
00518 SIZE_T
<a name="l00519"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a20">00519</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a20">MiCalculatePageCommitment</a> (
00520     IN PVOID StartingAddress,
00521     IN PVOID EndingAddress,
00522     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad,
00523     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00524     )
00525 
00526 <span class="comment">/*++</span>
00527 <span class="comment"></span>
00528 <span class="comment">Routine Description:</span>
00529 <span class="comment"></span>
00530 <span class="comment">    This routine examines the range of pages from the starting address</span>
00531 <span class="comment">    up to and including the ending address and returns the commit charge</span>
00532 <span class="comment">    for  the pages within the range.</span>
00533 <span class="comment"></span>
00534 <span class="comment">Arguments:</span>
00535 <span class="comment"></span>
00536 <span class="comment">    StartingAddress - Supplies the starting address of the range.</span>
00537 <span class="comment"></span>
00538 <span class="comment">    EndingAddress - Supplies the ending address of the range.</span>
00539 <span class="comment"></span>
00540 <span class="comment">    Vad - Supplies the virtual address descriptor which describes the range.</span>
00541 <span class="comment"></span>
00542 <span class="comment">    Process - Supplies the current process.</span>
00543 <span class="comment"></span>
00544 <span class="comment">Return Value:</span>
00545 <span class="comment"></span>
00546 <span class="comment">    Commitment charge for the range.</span>
00547 <span class="comment"></span>
00548 <span class="comment">Environment:</span>
00549 <span class="comment"></span>
00550 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes</span>
00551 <span class="comment">    held.</span>
00552 <span class="comment"></span>
00553 <span class="comment">--*/</span>
00554 
00555 {
00556     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00557     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00558     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00559     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00560     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> TempEnd;
00561     SIZE_T NumberOfCommittedPages;
00562     ULONG Waited;
00563 
00564     NumberOfCommittedPages = 0;
00565 
00566     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
00567     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
00568     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00569 
00570     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.MemCommit == 1) {
00571 
00572         TempEnd = EndingAddress;
00573 
00574         <span class="comment">//</span>
00575         <span class="comment">// All the pages are committed within this range.</span>
00576         <span class="comment">//</span>
00577 
00578         NumberOfCommittedPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((PCHAR)TempEnd -
00579                                                        (PCHAR)StartingAddress);
00580 
00581 
00582         <span class="comment">//</span>
00583         <span class="comment">// Examine the PTEs to determine how many pages are committed.</span>
00584         <span class="comment">//</span>
00585 
00586         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (TempEnd);
00587 
00588         <span class="keywordflow">do</span> {
00589 
00590             <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00591                                                 Process,
00592                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00593                                                 &amp;Waited)) {
00594     
00595                 <span class="comment">//</span>
00596                 <span class="comment">// No PPE exists for the starting address, therefore the page</span>
00597                 <span class="comment">// is not committed.</span>
00598                 <span class="comment">//</span>
00599     
00600                 PointerPpe += 1;
00601                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00602                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00603                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00604                     <span class="keywordflow">goto</span> DoneCommit;
00605                 }
00606             }
00607 
00608             Waited = 0;
00609 
00610             <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00611                                                 Process,
00612                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00613                                                 &amp;Waited)) {
00614     
00615                 <span class="comment">//</span>
00616                 <span class="comment">// No PDE exists for the starting address, therefore the page</span>
00617                 <span class="comment">// is not committed.</span>
00618                 <span class="comment">//</span>
00619     
00620                 PointerPde += 1;
00621                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00622                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00623                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00624                     <span class="keywordflow">goto</span> DoneCommit;
00625                 }
00626 <span class="preprocessor">#if defined (_WIN64)</span>
00627 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00628                     Waited = 1;
00629                     <span class="keywordflow">break</span>;
00630                 }
00631 <span class="preprocessor">#endif</span>
00632 <span class="preprocessor"></span>            }
00633 
00634         } <span class="keywordflow">while</span> (Waited != 0);
00635 
00636 restart:
00637 
00638         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00639 
00640             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00641 
00642                 <span class="comment">//</span>
00643                 <span class="comment">// This is a PDE boundary, check to see if the entire</span>
00644                 <span class="comment">// PPE/PDE pages exist.</span>
00645                 <span class="comment">//</span>
00646 
00647                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00648                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00649 
00650                 <span class="keywordflow">do</span> {
00651 
00652                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00653                                                      Process,
00654                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00655                                                      &amp;Waited)) {
00656     
00657                         <span class="comment">//</span>
00658                         <span class="comment">// No PDE exists for the starting address, check the VAD</span>
00659                         <span class="comment">// to see if the pages are not committed.</span>
00660                         <span class="comment">//</span>
00661     
00662                         PointerPpe += 1;
00663                         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00664                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00665     
00666                         <span class="comment">//</span>
00667                         <span class="comment">// Check next page.</span>
00668                         <span class="comment">//</span>
00669     
00670                         <span class="keywordflow">goto</span> restart;
00671                     }
00672     
00673                     Waited = 0;
00674     
00675                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00676                                                      Process,
00677                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00678                                                      &amp;Waited)) {
00679     
00680                         <span class="comment">//</span>
00681                         <span class="comment">// No PDE exists for the starting address, check the VAD</span>
00682                         <span class="comment">// to see if the pages are not committed.</span>
00683                         <span class="comment">//</span>
00684     
00685                         PointerPde += 1;
00686                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00687                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00688     
00689                         <span class="comment">//</span>
00690                         <span class="comment">// Check next page.</span>
00691                         <span class="comment">//</span>
00692     
00693                         <span class="keywordflow">goto</span> restart;
00694                     }
00695                 } <span class="keywordflow">while</span> (Waited != 0);
00696             }
00697 
00698             <span class="comment">//</span>
00699             <span class="comment">// The PDE exists, examine the PTE.</span>
00700             <span class="comment">//</span>
00701 
00702             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00703 
00704                 <span class="comment">//</span>
00705                 <span class="comment">// Has this page been explicitly decommitted?</span>
00706                 <span class="comment">//</span>
00707 
00708                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a3">MiIsPteDecommittedPage</a> (PointerPte)) {
00709 
00710                     <span class="comment">//</span>
00711                     <span class="comment">// This page is decommitted, remove it from the count.</span>
00712                     <span class="comment">//</span>
00713 
00714                     NumberOfCommittedPages -= 1;
00715 
00716                 }
00717             }
00718 
00719             PointerPte += 1;
00720         }
00721 
00722 DoneCommit:
00723 
00724         <span class="keywordflow">if</span> (TempEnd == EndingAddress) {
00725             <span class="keywordflow">return</span> NumberOfCommittedPages;
00726         }
00727 
00728     }
00729 
00730     <span class="comment">//</span>
00731     <span class="comment">// Examine non committed range.</span>
00732     <span class="comment">//</span>
00733 
00734     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00735 
00736     <span class="keywordflow">do</span> {
00737 
00738         <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00739                                             Process,
00740                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00741                                             &amp;Waited)) {
00742     
00743     
00744             <span class="comment">//</span>
00745             <span class="comment">// No PDE exists for the starting address, therefore the page</span>
00746             <span class="comment">// is not committed.</span>
00747             <span class="comment">//</span>
00748     
00749             PointerPpe += 1;
00750             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00751             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00752             <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00753                <span class="keywordflow">return</span> NumberOfCommittedPages;
00754             }
00755         }
00756 
00757         Waited = 0;
00758 
00759         <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00760                                             Process,
00761                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00762                                             &amp;Waited)) {
00763     
00764             <span class="comment">//</span>
00765             <span class="comment">// No PDE exists for the starting address, therefore the page</span>
00766             <span class="comment">// is not committed.</span>
00767             <span class="comment">//</span>
00768     
00769             PointerPde += 1;
00770             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00771             <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00772                <span class="keywordflow">return</span> NumberOfCommittedPages;
00773             }
00774 <span class="preprocessor">#if defined (_WIN64)</span>
00775 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00776                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00777                 Waited = 1;
00778                 <span class="keywordflow">break</span>;
00779             }
00780 <span class="preprocessor">#endif</span>
00781 <span class="preprocessor"></span>        }
00782 
00783     } <span class="keywordflow">while</span> (Waited != 0);
00784 
00785 restart2:
00786 
00787     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00788 
00789         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00790 
00791             <span class="comment">//</span>
00792             <span class="comment">// This is a PDE boundary, check to see if the entire</span>
00793             <span class="comment">// PPE/PDE pages exist.</span>
00794             <span class="comment">//</span>
00795 
00796             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00797             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00798 
00799             <span class="keywordflow">do</span> {
00800 
00801                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00802                                                  Process,
00803                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00804                                                  &amp;Waited)) {
00805     
00806                     <span class="comment">//</span>
00807                     <span class="comment">// No PPE exists for the starting address, check the VAD</span>
00808                     <span class="comment">// to see if the pages are not committed.</span>
00809                     <span class="comment">//</span>
00810     
00811                     PointerPpe += 1;
00812                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00813                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00814     
00815                     <span class="comment">//</span>
00816                     <span class="comment">// Check next page.</span>
00817                     <span class="comment">//</span>
00818     
00819                     <span class="keywordflow">goto</span> restart2;
00820                 }
00821     
00822                 Waited = 0;
00823     
00824                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00825                                                  Process,
00826                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00827                                                  &amp;Waited)) {
00828     
00829                     <span class="comment">//</span>
00830                     <span class="comment">// No PDE exists for the starting address, check the VAD</span>
00831                     <span class="comment">// to see if the pages are not committed.</span>
00832                     <span class="comment">//</span>
00833     
00834                     PointerPde += 1;
00835                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00836                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00837     
00838                     <span class="comment">//</span>
00839                     <span class="comment">// Check next page.</span>
00840                     <span class="comment">//</span>
00841     
00842                     <span class="keywordflow">goto</span> restart2;
00843                 }
00844 
00845             } <span class="keywordflow">while</span> (Waited != 0);
00846         }
00847 
00848         <span class="comment">//</span>
00849         <span class="comment">// The PDE exists, examine the PTE.</span>
00850         <span class="comment">//</span>
00851 
00852         <span class="keywordflow">if</span> ((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) &amp;&amp;
00853              (!<a class="code" href="../../d0/d2/mmsup_8c.html#a3">MiIsPteDecommittedPage</a> (PointerPte))) {
00854 
00855             <span class="comment">//</span>
00856             <span class="comment">// This page is committed, count it.</span>
00857             <span class="comment">//</span>
00858 
00859             NumberOfCommittedPages += 1;
00860         }
00861 
00862         PointerPte += 1;
00863     }
00864 
00865     <span class="keywordflow">return</span> NumberOfCommittedPages;
00866 }
00867 
00868 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00869"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a21">00869</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a21">MiReturnPageTablePageCommitment</a> (
00870     IN PVOID StartingAddress,
00871     IN PVOID EndingAddress,
00872     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess,
00873     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> PreviousVad,
00874     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NextVad
00875     )
00876 
00877 <span class="comment">/*++</span>
00878 <span class="comment"></span>
00879 <span class="comment">Routine Description:</span>
00880 <span class="comment"></span>
00881 <span class="comment">    This routine returns commitment for COMPLETE page table pages which</span>
00882 <span class="comment">    span the virtual address range.  For example (assuming 4k pages),</span>
00883 <span class="comment">    if the StartingAddress =  64k and the EndingAddress = 5mb, no</span>
00884 <span class="comment">    page table charges would be freed as a complete page table page is</span>
00885 <span class="comment">    not covered by the range.  However, if the StartingAddress was 4mb</span>
00886 <span class="comment">    and the EndingAddress was 9mb, 1 page table page would be freed.</span>
00887 <span class="comment"></span>
00888 <span class="comment">Arguments:</span>
00889 <span class="comment"></span>
00890 <span class="comment">    StartingAddress - Supplies the starting address of the range.</span>
00891 <span class="comment"></span>
00892 <span class="comment">    EndingAddress - Supplies the ending address of the range.</span>
00893 <span class="comment"></span>
00894 <span class="comment">    CurrentProcess - Supplies a pointer to the current process.</span>
00895 <span class="comment"></span>
00896 <span class="comment">    PreviousVad - Supplies a pointer to the previous VAD, NULL if none.</span>
00897 <span class="comment"></span>
00898 <span class="comment">    NextVad - Supplies a pointer to the next VAD, NULL if none.</span>
00899 <span class="comment"></span>
00900 <span class="comment">Return Value:</span>
00901 <span class="comment"></span>
00902 <span class="comment">    None.</span>
00903 <span class="comment"></span>
00904 <span class="comment">Environment:</span>
00905 <span class="comment"></span>
00906 <span class="comment">    Kernel mode, APCs disabled, WorkingSetLock and AddressCreation mutexes</span>
00907 <span class="comment">    held.</span>
00908 <span class="comment"></span>
00909 <span class="comment">--*/</span>
00910 
00911 {
00912 <span class="preprocessor">#ifdef _WIN64</span>
00913 <span class="preprocessor"></span>    DBG_UNREFERENCED_PARAMETER (StartingAddress);
00914     DBG_UNREFERENCED_PARAMETER (EndingAddress);
00915     DBG_UNREFERENCED_PARAMETER (CurrentProcess);
00916     DBG_UNREFERENCED_PARAMETER (PreviousVad);
00917     DBG_UNREFERENCED_PARAMETER (NextVad);
00918 <span class="preprocessor">#else</span>
00919 <span class="preprocessor"></span>    ULONG NumberToClear;
00920     LONG FirstPage;
00921     LONG LastPage;
00922     LONG PreviousPage;
00923     LONG NextPage;
00924 
00925     <span class="comment">//</span>
00926     <span class="comment">// Check to see if any page table pages would be freed.</span>
00927     <span class="comment">//</span>
00928 
00929     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartingAddress != EndingAddress);
00930 
00931     <span class="keywordflow">if</span> (PreviousVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00932         PreviousPage = -1;
00933     } <span class="keywordflow">else</span> {
00934         PreviousPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (PreviousVad-&gt;EndingVpn));
00935     }
00936 
00937     <span class="keywordflow">if</span> (NextVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938         NextPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (MM_HIGHEST_USER_ADDRESS) + 1;
00939     } <span class="keywordflow">else</span> {
00940         NextPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (NextVad-&gt;StartingVpn));
00941     }
00942 
00943     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PreviousPage &lt;= NextPage);
00944 
00945     FirstPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a>  (StartingAddress);
00946 
00947     LastPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (EndingAddress);
00948 
00949     <span class="keywordflow">if</span> (PreviousPage == FirstPage) {
00950 
00951         <span class="comment">//</span>
00952         <span class="comment">// A VAD is within the starting page table page.</span>
00953         <span class="comment">//</span>
00954 
00955         FirstPage += 1;
00956     }
00957 
00958     <span class="keywordflow">if</span> (NextPage == LastPage) {
00959 
00960         <span class="comment">//</span>
00961         <span class="comment">// A VAD is within the ending page table page.</span>
00962         <span class="comment">//</span>
00963 
00964         LastPage -= 1;
00965     }
00966 
00967     <span class="comment">//</span>
00968     <span class="comment">// Indicate that the page table page is not in use.</span>
00969     <span class="comment">//</span>
00970 
00971     <span class="keywordflow">if</span> (FirstPage &gt; LastPage) {
00972         <span class="keywordflow">return</span>;
00973     }
00974 
00975     NumberToClear = 1 + LastPage - FirstPage;
00976 
00977     <span class="keywordflow">while</span> (FirstPage &lt;= LastPage) {
00978         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>,
00979                               FirstPage));
00980 
00981         <a class="code" href="../../d4/d8/mi_8h.html#a169">MI_CLEAR_BIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>, FirstPage);
00982         FirstPage += 1;
00983     }
00984 
00985     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a> -= NumberToClear;
00986     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberToClear);
00987     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a301">MM_DBG_COMMIT_RETURN_PAGETABLES</a>, NumberToClear);
00988     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (NumberToClear, CurrentProcess);
00989 
00990     <span class="keywordflow">if</span> (CurrentProcess-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00991         <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)NumberToClear);
00992     }
00993     CurrentProcess-&gt;CommitCharge -= NumberToClear;
00994 
00995     <span class="keywordflow">return</span>;
00996 <span class="preprocessor">#endif</span>
00997 <span class="preprocessor"></span>}
00998 
00999 
01000 LOGICAL
<a name="l01001"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a22">01001</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a>(
01002     SIZE_T NumberOfPages,
01003     IN ULONG Extension
01004     )
01005 
01006 <span class="comment">/*++</span>
01007 <span class="comment"></span>
01008 <span class="comment">Routine Description:</span>
01009 <span class="comment"></span>
01010 <span class="comment">    This function causes an over commit popup to occur.  If a popup is pending</span>
01011 <span class="comment">    it returns FALSE.  Otherwise, it queues a popup to a noncritical worker</span>
01012 <span class="comment">    thread.</span>
01013 <span class="comment"></span>
01014 <span class="comment">Arguments:</span>
01015 <span class="comment"></span>
01016 <span class="comment">    NumberOfPages - Supplies the number of pages of commit requested.</span>
01017 <span class="comment"></span>
01018 <span class="comment">    Extension - Supplies the extension to grant.</span>
01019 <span class="comment"></span>
01020 <span class="comment">Return Value:</span>
01021 <span class="comment"></span>
01022 <span class="comment">    TRUE - An overcommit popup was queued.</span>
01023 <span class="comment"></span>
01024 <span class="comment">    FALSE - An overcommit popup is still pending and will not be queued.</span>
01025 <span class="comment"></span>
01026 <span class="comment">--*/</span>
01027 
01028 {
01029     KIRQL OldIrql;
01030     BOOLEAN RaisedPopup;
01031     ULONG PopupNumber;
01032 
01033     <span class="keywordflow">if</span> (NumberOfPages &gt; <a class="code" href="../../d6/d1/mmquota_8c.html#a2">MM_COMMIT_POPUP_MAX</a> ||
01034         <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + NumberOfPages &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
01035             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01036     }
01037 
01038     <span class="comment">//</span>
01039     <span class="comment">// Give the user a meaningful message - either to increase the minimum,</span>
01040     <span class="comment">// maximum, or both.</span>
01041     <span class="comment">//</span>
01042 
01043     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> - 100) {
01044         PopupNumber = STATUS_COMMITMENT_LIMIT;
01045     }
01046     <span class="keywordflow">else</span> {
01047         PopupNumber = STATUS_COMMITMENT_MINIMUM;
01048     }
01049 
01050     RaisedPopup = <a class="code" href="../../d4/d6/iosubs_8c.html#a94">IoRaiseInformationalHardError</a> (PopupNumber, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01051 
01052     ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
01053 
01054     <span class="keywordflow">if</span> ((RaisedPopup == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (<a class="code" href="../../d4/d8/mi_8h.html#a744">MiOverCommitCallCount</a> &gt; 0)) {
01055 
01056         <span class="comment">//</span>
01057         <span class="comment">// There is already a popup outstanding and we have not</span>
01058         <span class="comment">// returned any of the quota.</span>
01059         <span class="comment">//</span>
01060 
01061         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01062         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01063     }
01064 
01065     <span class="comment">//</span>
01066     <span class="comment">// Now that the commitment lock is held, ensure the commit is not being</span>
01067     <span class="comment">// raised past the absolute maximum.</span>
01068     <span class="comment">//</span>
01069 
01070     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + NumberOfPages &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
01071         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01072         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01073     }
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">// Don't automatically grant increases forever as this can allow the</span>
01077     <span class="comment">// system to run out of available pages.</span>
01078     <span class="comment">//</span>
01079 
01080     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> &gt; 1024) {
01081         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01082         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01083     }
01084 
01085     <a class="code" href="../../d4/d8/mi_8h.html#a744">MiOverCommitCallCount</a> += 1;
01086 
01087     <a class="code" href="../../d6/d1/mmquota_8c.html#a7">MiCommitExtensionActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01088 
01089     <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> += Extension;
01090     <a class="code" href="../../d6/d1/mmquota_8c.html#a6">MmExtendedCommitLimit</a> += Extension;
01091 
01092     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> += NumberOfPages;
01093 
01094     <span class="comment">//</span>
01095     <span class="comment">// The caller will not release this commit, so we must earmark it now</span>
01096     <span class="comment">// for later release.</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="keywordflow">if</span> (Extension == 0) {
01100         <a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a> += NumberOfPages;
01101     }
01102 
01103     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a>) &amp;&amp;
01104         (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> == 0)) {
01105         <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
01106     }
01107 
01108     ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01109 
01110     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01111 }
01112 
01113 
<a name="l01114"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a12">01114</a> SIZE_T <a class="code" href="../../d6/d1/mmquota_8c.html#a12">MmTotalPagedPoolQuota</a>;
<a name="l01115"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a13">01115</a> SIZE_T <a class="code" href="../../d6/d1/mmquota_8c.html#a13">MmTotalNonPagedPoolQuota</a>;
01116 
01117 BOOLEAN
<a name="l01118"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a23">01118</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a23">MmRaisePoolQuota</a>(
01119     IN POOL_TYPE PoolType,
01120     IN SIZE_T OldQuotaLimit,
01121     OUT PSIZE_T NewQuotaLimit
01122     )
01123 
01124 <span class="comment">/*++</span>
01125 <span class="comment"></span>
01126 <span class="comment">Routine Description:</span>
01127 <span class="comment"></span>
01128 <span class="comment">    This function is called (with a spinlock) whenever PS detects a quota</span>
01129 <span class="comment">    limit has been exceeded. The purpose of this function is to attempt to</span>
01130 <span class="comment">    increase the specified quota.</span>
01131 <span class="comment"></span>
01132 <span class="comment">Arguments:</span>
01133 <span class="comment"></span>
01134 <span class="comment">    PoolType - Supplies the pool type of the quota to be raised</span>
01135 <span class="comment"></span>
01136 <span class="comment">    OldQuotaLimit - Supplies the current quota limit for this pool type</span>
01137 <span class="comment"></span>
01138 <span class="comment">    NewQuotaLimit - Returns the new limit</span>
01139 <span class="comment"></span>
01140 <span class="comment">Return Value:</span>
01141 <span class="comment"></span>
01142 <span class="comment">    TRUE - The API succeeded and the quota limit was raised.</span>
01143 <span class="comment"></span>
01144 <span class="comment">    FALSE - We were unable to raise the quota limit.</span>
01145 <span class="comment"></span>
01146 <span class="comment">Environment:</span>
01147 <span class="comment"></span>
01148 <span class="comment">    Kernel mode, QUOTA SPIN LOCK HELD!!</span>
01149 <span class="comment"></span>
01150 <span class="comment">--*/</span>
01151 
01152 {
01153     SIZE_T Limit;
01154     <a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">PMM_PAGED_POOL_INFO</a> PagedPoolInfo;
01155 
01156     <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01157 
01158         <span class="comment">//</span>
01159         <span class="comment">// Check commit limit and make sure at least 1mb is available.</span>
01160         <span class="comment">// Check to make sure 4mb of paged pool still exists.</span>
01161         <span class="comment">//</span>
01162 
01163         PagedPoolInfo = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>;
01164 
01165         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &lt;
01166             (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o8">AllocatedPagedPool</a> + ((<a class="code" href="../../d2/d1/mm_8h.html#a31">MMPAGED_QUOTA_CHECK</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01167 
01168             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01169         }
01170 
01171         <a class="code" href="../../d6/d1/mmquota_8c.html#a12">MmTotalPagedPoolQuota</a> += (<a class="code" href="../../d2/d1/mm_8h.html#a29">MMPAGED_QUOTA_INCREASE</a>);
01172         *NewQuotaLimit = OldQuotaLimit + (<a class="code" href="../../d2/d1/mm_8h.html#a29">MMPAGED_QUOTA_INCREASE</a>);
01173         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01174 
01175     } <span class="keywordflow">else</span> {
01176 
01177         <span class="keywordflow">if</span> ( (ULONG_PTR)(<a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> + ((1*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) &lt; (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01178             <span class="keywordflow">goto</span> aok;
01179             }
01180 
01181         <span class="comment">//</span>
01182         <span class="comment">// Make sure 200 pages and 5mb of nonpaged pool expansion</span>
01183         <span class="comment">// available.  Raise quota by 64k.</span>
01184         <span class="comment">//</span>
01185 
01186         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 200) ||
01187             (MmResidentAvailablePages &lt; ((MMNONPAGED_QUOTA_CHECK) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01188 
01189             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01190         }
01191 
01192         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; ((4*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01193             Limit = (1*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01194         } <span class="keywordflow">else</span> {
01195             Limit = (4*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01196         }
01197 
01198         <span class="keywordflow">if</span> ((ULONG_PTR)((<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) &lt;
01199             (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> + Limit)) {
01200 
01201             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01202         }
01203 aok:
01204         <a class="code" href="../../d6/d1/mmquota_8c.html#a13">MmTotalNonPagedPoolQuota</a> += (<a class="code" href="../../d2/d1/mm_8h.html#a28">MMNONPAGED_QUOTA_INCREASE</a>);
01205         *NewQuotaLimit = OldQuotaLimit + (<a class="code" href="../../d2/d1/mm_8h.html#a28">MMNONPAGED_QUOTA_INCREASE</a>);
01206         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01207     }
01208 }
01209 
01210 
01211 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01212"></a><a class="code" href="../../d6/d1/mmquota_8c.html#a24">01212</a> <a class="code" href="../../d6/d1/mmquota_8c.html#a24">MmReturnPoolQuota</a>(
01213     IN POOL_TYPE PoolType,
01214     IN SIZE_T ReturnedQuota
01215     )
01216 
01217 <span class="comment">/*++</span>
01218 <span class="comment"></span>
01219 <span class="comment">Routine Description:</span>
01220 <span class="comment"></span>
01221 <span class="comment">    Returns pool quota.</span>
01222 <span class="comment"></span>
01223 <span class="comment">Arguments:</span>
01224 <span class="comment"></span>
01225 <span class="comment">    PoolType - Supplies the pool type of the quota to be returned.</span>
01226 <span class="comment"></span>
01227 <span class="comment">    ReturnedQuota - Number of bytes returned.</span>
01228 <span class="comment"></span>
01229 <span class="comment">Return Value:</span>
01230 <span class="comment"></span>
01231 <span class="comment">    NONE.</span>
01232 <span class="comment"></span>
01233 <span class="comment">Environment:</span>
01234 <span class="comment"></span>
01235 <span class="comment">    Kernel mode, QUOTA SPIN LOCK HELD!!</span>
01236 <span class="comment"></span>
01237 <span class="comment">--*/</span>
01238 
01239 {
01240 
01241     <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01242         <a class="code" href="../../d6/d1/mmquota_8c.html#a12">MmTotalPagedPoolQuota</a> -= ReturnedQuota;
01243     } <span class="keywordflow">else</span> {
01244         <a class="code" href="../../d6/d1/mmquota_8c.html#a13">MmTotalNonPagedPoolQuota</a> -= ReturnedQuota;
01245     }
01246 
01247     <span class="keywordflow">return</span>;
01248 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
