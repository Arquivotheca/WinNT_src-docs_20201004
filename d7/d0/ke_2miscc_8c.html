<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ke/miscc.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>miscc.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d8/d9/ke_2miscc_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a0">KeEnterCriticalRegion</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a1">KeLeaveCriticalRegion</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONGLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a2">KeQueryInterruptTime</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (OUT PLARGE_INTEGER CurrentTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a> (OUT PLARGE_INTEGER CurrentCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a5">KeQueryTimeIncrement</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a6">KeSetDmaIoCoherency</a> (IN ULONG Attributes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a7">KeSetSystemTime</a> (IN PLARGE_INTEGER NewTime, OUT PLARGE_INTEGER OldTime, IN BOOLEAN AdjustInterruptTime, IN PLARGE_INTEGER HalTimeToSet OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a8">KiAdjustInterruptTime</a> (IN LONGLONG TimeDelta)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a9">KiCalibrateTimeAdjustment</a> (<a class="el" href="../../d0/d0/ki_8h.html#a34">PADJUST_INTERRUPT_TIME_CONTEXT</a> Adjust)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a10">KeSetTimeIncrement</a> (IN ULONG MaximumIncrement, IN ULONG MinimumIncrement)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a11">KeAddSystemServiceTable</a> (IN PULONG_PTR Base, IN PULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a> OPTIONAL, IN ULONG Limit, IN PUCHAR Number, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a12">KeSetSwapContextNotifyRoutine</a> (IN <a class="el" href="../../d4/d9/ke_8h.html#a120">PSWAP_CONTEXT_NOTIFY_ROUTINE</a> NotifyRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a13">KeSetThreadSelectNotifyRoutine</a> (IN <a class="el" href="../../d4/d9/ke_8h.html#a121">PTHREAD_SELECT_NOTIFY_ROUTINE</a> NotifyRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a14">KeSetTimeUpdateNotifyRoutine</a> (IN <a class="el" href="../../d4/d9/ke_8h.html#a122">PTIME_UPDATE_NOTIFY_ROUTINE</a> NotifyRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KAFFINITY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/ke_2miscc_8c.html#a15">KeQueryActiveProcessors</a> (VOID)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a11" doxytag="ke/miscc.c::KeAddSystemServiceTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeAddSystemServiceTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Limit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Number</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00815">815</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00319">_KSERVICE_TABLE_DESCRIPTOR::Base</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00320">_KSERVICE_TABLE_DESCRIPTOR::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02794">KeServiceDescriptorTable</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02795">KeServiceDescriptorTableShadow</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00321">_KSERVICE_TABLE_DESCRIPTOR::Limit</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00325">_KSERVICE_TABLE_DESCRIPTOR::Number</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00301">NUMBER_SERVICE_TABLES</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00825                    :
00826 
00827     This function allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to add a system service table
00828     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
00829 
00830 Arguments:
00831 
00832     Base - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service table dispatch
00833         table.
00834 
00835     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - Supplies an optional pointer to a table of per system service
00836         counters.
00837 
00838     Limit - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> limit of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service table. Services greater
00839         than or equal to <span class="keyword">this</span> limit will fail.
00840 
00841     Arguments - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument count table.
00842 
00843     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Supplies index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service table.
00844 
00845 Return Value:
00846 
00847     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The operation was successful.
00848 
00849     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation failed. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> service table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already bound to
00850         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified location, or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> larger than
00851         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum allowed index.
00852 
00853 --*/
00854 
00855 {
00856 
00857     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00858 
00859     <span class="comment">//</span>
00860     <span class="comment">// If a system service table is already defined for the specified</span>
00861     <span class="comment">// index, then return FALSE. Otherwise, establish the new system</span>
00862     <span class="comment">// service table.</span>
00863     <span class="comment">//</span>
00864 
00865     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; <a class="code" href="../../d4/d9/ke_8h.html#a13">NUMBER_SERVICE_TABLES</a> - 1) ||
00866         (<a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o0">Base</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00867         (<a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o0">Base</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00868         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00869 
00870     } <span class="keywordflow">else</span> {
00871 
00872         <span class="comment">//</span>
00873         <span class="comment">// If the service table index is equal to the Win32 table, then</span>
00874         <span class="comment">// only update the shadow system service table. Otherwise, both</span>
00875         <span class="comment">// the shadow and static system service tables are updated.</span>
00876         <span class="comment">//</span>
00877 
00878         <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o0">Base</a> = Base;
00879         <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o1">Count</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00880         <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o2">Limit</a> = Limit;
00881 <span class="preprocessor">#if defined(_IA64_)</span>
00882 <span class="preprocessor"></span>
00883             <span class="comment">//</span>
00884             <span class="comment">// The global pointer associated with the table base is</span>
00885             <span class="comment">// placed just before the service table.</span>
00886             <span class="comment">//</span>
00887 
00888             <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].TableBaseGpOffset = 
00889                 (LONG)(*(Base-1) - (ULONG_PTR)Base);
00890 <span class="preprocessor">#endif</span>
00891 <span class="preprocessor"></span>        <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o3">Number</a> = Number;
00892         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != 1) {
00893             <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o0">Base</a> = Base;
00894             <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o1">Count</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00895             <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o2">Limit</a> = Limit;
00896 <span class="preprocessor">#if defined(_IA64_)</span>
00897 <span class="preprocessor"></span>            <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].TableBaseGpOffset = 
00898                 (LONG)(*(Base-1) - (ULONG_PTR)Base);
00899 <span class="preprocessor">#endif</span>
00900 <span class="preprocessor"></span>            <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o3">Number</a> = Number;
00901         }
00902 
00903         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00904     }
00905 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ke/miscc.c::KeEnterCriticalRegion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeEnterCriticalRegion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00041">41</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>.
<p>
<pre class="fragment"><div>00047                    :
00048 
00049    This function disables kernel APC's.
00050 
00051    N.B. The following code does not require any interlocks. There are
00052         two cases of interest: 1) On an MP system, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread cannot
00053         be running on two processors as once, and 2) <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00054         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> interrupted to deliver a kernel mode APC which also calls
00055         <span class="keyword">this</span> routine, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> values read and stored will stack and unstack
00056         properly.
00057 
00058 Arguments:
00059 
00060    None.
00061 
00062 Return Value:
00063 
00064    None.
00065 
00066 --*/
00067 
00068 {
00069     <span class="comment">//</span>
00070     <span class="comment">// Simply directly disable kernel APCs.</span>
00071     <span class="comment">//</span>
00072 
00073     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable -= 1;
00074     <span class="keywordflow">return</span>;
00075 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ke/miscc.c::KeLeaveCriticalRegion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeLeaveCriticalRegion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00080">80</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l01537">KiLeaveCriticalRegion</a>.
<p>
<pre class="fragment"><div>00086                    :
00087 
00088     This function enables kernel APC's and requests an APC interrupt <span class="keywordflow">if</span>
00089     appropriate.
00090 
00091 Arguments:
00092 
00093     None.
00094 
00095 Return Value:
00096 
00097     None.
00098 
00099 --*/
00100 
00101 {
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">// Increment the kernel APC disable count. If the resultant count is</span>
00105     <span class="comment">// zero and the thread's kernel APC List is not empty, then request an</span>
00106     <span class="comment">// APC interrupt.</span>
00107     <span class="comment">//</span>
00108     <span class="comment">// For multiprocessor performance, the following code utilizes the fact</span>
00109     <span class="comment">// that queuing an APC is done by first queuing the APC, then checking</span>
00110     <span class="comment">// the AST disable count. The following code increments the disable</span>
00111     <span class="comment">// count first, checks to determine if it is zero, and then checks the</span>
00112     <span class="comment">// kernel AST queue.</span>
00113     <span class="comment">//</span>
00114     <span class="comment">// See also KiInsertQueueApc().</span>
00115     <span class="comment">//</span>
00116 
00117     <a class="code" href="../../d4/d9/ke_8h.html#a27">KiLeaveCriticalRegion</a>();
00118     <span class="keywordflow">return</span>;
00119 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="ke/miscc.c::KeQueryActiveProcessors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KAFFINITY KeQueryActiveProcessors           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l01004">1004</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>01009                    :
01010 
01011     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current set of active processors
01012     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
01013 
01014 Arguments:
01015 
01016     None.
01017 
01018 Return Value:
01019 
01020     KAFFINITY bitmask representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of active processors
01021 
01022 --*/
01023 
01024 {
01025     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01026 
01027     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>);
01028 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ke/miscc.c::KeQueryInterruptTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONGLONG KeQueryInterruptTime           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00122">122</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l01212">ExGetNextWakeTime()</a>, and <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00592">KiCalibrateTimeAdjustment()</a>.
<p>
<pre class="fragment"><div>00128                    :
00129 
00130     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current interrupt time by determining when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00131     time <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stable and then returning its value.
00132 
00133 Arguments:
00134 
00135     CurrentTime - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00136         current system time.
00137 
00138 Return Value:
00139 
00140     None.
00141 
00142 --*/
00143 
00144 {
00145 
00146     LARGE_INTEGER CurrentTime;
00147 
00148     KiQueryInterruptTime(&amp;CurrentTime);
00149     <span class="keywordflow">return</span> CurrentTime.QuadPart;
00150 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ke/miscc.c::KeQuerySystemTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeQuerySystemTime           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CurrentTime</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">153</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l01059">CheckAppStarting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00528">DbgkExitProcess()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00625">EhCreateChild()</a>, <a class="el" href="../../d5/d4/logger_8c-source.html#l00106">ExDebugLogEvent()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l01212">ExGetNextWakeTime()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00378">ExpAllocateUuids()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00349">ExpRaiseHardError()</a>, <a class="el" href="../../d4/d2/uuid_8c-source.html#l00340">ExpUuidInitialization()</a>, <a class="el" href="../../d2/d6/tunnel_8c-source.html#l00584">FsRtlAddToTunnelCache()</a>, <a class="el" href="../../d2/d6/tunnel_8c-source.html#l01281">FsRtlPruneTunnelCache()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01025">HvpWriteLog()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l00612">IoepFireWMIEvent()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d8/d7/sysinit_8c-source.html#l00040">LfsInitializeLogFileService()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00254">MiDoReplacement()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03270">MiInitializeSpecialPoolCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02465">MiRearrangeWorkingSetExpansionList()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02740">MiRememberUnloadedDriver()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02551">MiSessionOutSwapProcess()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00052">NtCreateSymbolicLinkObject()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00227">NtTerminateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l01168">ViInjectResourceFailure()</a>.
<p>
<pre class="fragment"><div>00159                    :
00160 
00161     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current system time by determining when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00162     time <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stable and then returning its value.
00163 
00164 Arguments:
00165 
00166     CurrentTime - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00167         current system time.
00168 
00169 Return Value:
00170 
00171     None.
00172 
00173 --*/
00174 
00175 {
00176 
00177     KiQuerySystemTime(CurrentTime);
00178     <span class="keywordflow">return</span>;
00179 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ke/miscc.c::KeQueryTickCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeQueryTickCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CurrentCount</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00182">182</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d8/d6/io_2remlock_8c-source.html#l00114">IoAcquireRemoveLockEx()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d6/io_2remlock_8c-source.html#l00244">IoReleaseRemoveLockEx()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03472">MiAllocateSpecialPool()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00051">MiInsertWsle()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03742">MmFreeSpecialPool()</a>, <a class="el" href="../../d9/d6/rtl_2remlock_8c-source.html#l00091">RtlAcquireRemoveLockEx()</a>, <a class="el" href="../../d9/d6/rtl_2remlock_8c-source.html#l00204">RtlReleaseRemoveLock()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01168">ViInjectResourceFailure()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l02333">ViTrimAllSystemPagableMemory()</a>.
<p>
<pre class="fragment"><div>00188                    :
00189 
00190     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current tick count by determining when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00191     count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stable and then returning its value.
00192 
00193 Arguments:
00194 
00195     CurrentCount - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00196         current tick count.
00197 
00198 Return Value:
00199 
00200     None.
00201 
00202 --*/
00203 
00204 {
00205 
00206     KiQueryTickCount(CurrentCount);
00207     <span class="keywordflow">return</span>;
00208 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ke/miscc.c::KeQueryTimeIncrement" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KeQueryTimeIncrement           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00211">211</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00069">CcInitializeCacheManager()</a>.
<p>
<pre class="fragment"><div>00217                    :
00218 
00219     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time increment value in 100ns units. This
00220     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system time at each interval clock
00221     interrupt.
00222 
00223 Arguments:
00224 
00225     None.
00226 
00227 Return Value:
00228 
00229     The time increment value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
00230 
00231 --*/
00232 
00233 {
00234 
00235     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>;
00236 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ke/miscc.c::KeSetDmaIoCoherency" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeSetDmaIoCoherency           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Attributes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00239">239</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00301">KiDmaIoCoherency</a>.
<p>
<pre class="fragment"><div>00245                    :
00246 
00247     This function sets (enables/disables) DMA I/O coherency with data
00248     caches.
00249 
00250 Arguments:
00251 
00252     Attributes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of DMA I/O coherency attributes <span class="keywordflow">for</span>
00253         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host system.
00254 
00255 Return Value:
00256 
00257     None.
00258 
00259 --*/
00260 
00261 {
00262 
00263     <a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> = Attributes;
00264 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ke/miscc.c::KeSetSwapContextNotifyRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KeSetSwapContextNotifyRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/ke_8h.html#a120">PSWAP_CONTEXT_NOTIFY_ROUTINE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NotifyRoutine</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00909">909</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00066">KiSwapContextNotifyRoutine</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00914                    :
00915 
00916     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a callout routine which will be called
00917     at each context swtich.
00918 
00919 Arguments:
00920 
00921     NotifyRoutine - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> swap context notify callout
00922         routine.
00923 
00924 Return Value:
00925 
00926     None.
00927 
00928 --*/
00929 
00930 {
00931 
00932     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00933 
00934     <a class="code" href="../../d5/d9/kernldat_8c.html#a4">KiSwapContextNotifyRoutine</a> = NotifyRoutine;
00935     <span class="keywordflow">return</span>;
00936 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ke/miscc.c::KeSetSystemTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeSetSystemTime           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NewTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>OldTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AdjustInterruptTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER HalTimeToSet&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00335">335</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00259">_DISPATCHER_HEADER::Absolute</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00523">_KTIMER::DueTime</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a176">HalSetRealTimeClock()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00522">_KTIMER::Header</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00091">HIGH_LEVEL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00261">_DISPATCHER_HEADER::Inserted</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02767">KeBootTime</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02768">KeBootTimeBias</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01153">KeRevertToUserAffinityThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01467">KeSetSystemAffinityThread()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00544">KiAdjustInterruptTime()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d6/d1/timersup_8c-source.html#l00121">KiReinsertTreeTimer()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00755">KiRemoveTreeTimer</a>, <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00333">KiTimerListExpire()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00059">KiTimerTableListHead</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d1/d2/po_8h.html#a64">PoNotifySystemTimeSet()</a>, <a class="el" href="../../d2/d1/time_8c-source.html#l00508">RtlTimeToTimeFields()</a>, <a class="el" href="../../d7/d5/ttime_8c-source.html#l00046">TimeFields</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00094">TIMER_TABLE_SIZE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00524">_KTIMER::TimerListEntry</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00344                    :
00345 
00346     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system time to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified value and updates
00347     timer queue entries to reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> difference between <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old system
00348     time and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> system time.
00349 
00350 Arguments:
00351 
00352     NewTime - Supplies a pointer to a variable that specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> system
00353         time.
00354 
00355     OldTime - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous
00356         system time.
00357 
00358     AdjustInterruptTime - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount of time being adjusted <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00359         also applied to InterruptTime and <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a7">TickCount</a>.
00360 
00361     HalTimeToSet - Supplies an optional time that <span class="keywordflow">if</span> specified <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be used
00362         to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> realtime clock.
00363 
00364 Return Value:
00365 
00366     None.
00367 
00368 --*/
00369 
00370 {
00371 
00372     LIST_ENTRY AbsoluteListHead;
00373     LIST_ENTRY ExpiredListHead;
00374     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00375     PLIST_ENTRY ListHead;
00376     PLIST_ENTRY NextEntry;
00377     KIRQL OldIrql1;
00378     KIRQL OldIrql2;
00379     LARGE_INTEGER TimeDelta;
00380     TIME_FIELDS <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>;
00381     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00382 
00383     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt; DISPATCH_LEVEL);
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">// If a realtime clock value is specified, then convert the time value</span>
00387     <span class="comment">// to time fields.</span>
00388     <span class="comment">//</span>
00389 
00390     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HalTimeToSet)) {
00391         <a class="code" href="../../d1/d2/time_8c.html#a26">RtlTimeToTimeFields</a>(HalTimeToSet, &amp;TimeFields);
00392     }
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Set affinity to the processor that keeps the system time, raise IRQL</span>
00396     <span class="comment">// to dispatcher level and lock the dispatcher database, then raise IRQL</span>
00397     <span class="comment">// to HIGH_LEVEL to synchronize with the clock interrupt routine.</span>
00398     <span class="comment">//</span>
00399 
00400     <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>((KAFFINITY)1);
00401     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql1);
00402     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(HIGH_LEVEL, &amp;OldIrql2);
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Save the previous system time, set the new system time, and set</span>
00406     <span class="comment">// the realtime clock, if a time value is specified.</span>
00407     <span class="comment">//</span>
00408 
00409     KiQuerySystemTime(OldTime);
00410 
00411 <span class="preprocessor">#if defined(_WIN64)</span>
00412 <span class="preprocessor"></span>
00413     SharedUserData-&gt;SystemHigh2Time = NewTime-&gt;HighPart;
00414     SharedUserData-&gt;SystemLowTime = NewTime-&gt;LowPart;
00415     SharedUserData-&gt;SystemHigh1Time = NewTime-&gt;HighPart;
00416 
00417 <span class="preprocessor">#elif defined(ALPHA)</span>
00418 <span class="preprocessor"></span>
00419     SharedUserData-&gt;SystemTime = *(PULONGLONG)NewTime;
00420 
00421 <span class="preprocessor">#else</span>
00422 <span class="preprocessor"></span>
00423     SharedUserData-&gt;SystemTime.High2Time = NewTime-&gt;HighPart;
00424     SharedUserData-&gt;SystemTime.LowPart   = NewTime-&gt;LowPart;
00425     SharedUserData-&gt;SystemTime.High1Time = NewTime-&gt;HighPart;
00426 
00427 <span class="preprocessor">#endif // defined(ALPHA) || defined(_IA64_)</span>
00428 <span class="preprocessor"></span>
00429     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HalTimeToSet)) {
00430         <a class="code" href="../../d2/d7/hal_8h.html#a176">HalSetRealTimeClock</a>(&amp;TimeFields);
00431     }
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Compute the difference between the previous system time and the new</span>
00435     <span class="comment">// system time.</span>
00436     <span class="comment">//</span>
00437 
00438     TimeDelta.QuadPart = NewTime-&gt;QuadPart - OldTime-&gt;QuadPart;
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// Update the boot time to reflect the delta. This keeps time based</span>
00442     <span class="comment">// on boot time constant</span>
00443     <span class="comment">//</span>
00444 
00445     <a class="code" href="../../d4/d9/ke_8h.html#a124">KeBootTime</a>.QuadPart = <a class="code" href="../../d4/d9/ke_8h.html#a124">KeBootTime</a>.QuadPart + TimeDelta.QuadPart;
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Track the overall bias applied to the boot time.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d4/d9/ke_8h.html#a125">KeBootTimeBias</a> = <a class="code" href="../../d4/d9/ke_8h.html#a125">KeBootTimeBias</a> + TimeDelta.QuadPart;
00452 
00453     <span class="comment">//</span>
00454     <span class="comment">// Lower IRQL to dispatch level and if needed adjust the physical</span>
00455     <span class="comment">// system interrupt time.</span>
00456     <span class="comment">//</span>
00457 
00458     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql2);
00459     <span class="keywordflow">if</span> (AdjustInterruptTime) {
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// Adjust the physical time of the system</span>
00463         <span class="comment">//</span>
00464 
00465         AdjustInterruptTime = <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a8">KiAdjustInterruptTime</a> (TimeDelta.QuadPart);
00466     }
00467 
00468     <span class="comment">//</span>
00469     <span class="comment">// If the physical interrupt time of the system was not adjusted,</span>
00470     <span class="comment">// recompute any absolute timers in the system for the new</span>
00471     <span class="comment">// system time.</span>
00472     <span class="comment">//</span>
00473 
00474     <span class="keywordflow">if</span> (!AdjustInterruptTime) {
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// Remove all absolute timers from the timer queue so their due time</span>
00478         <span class="comment">// can be recomputed.</span>
00479         <span class="comment">//</span>
00480 
00481         InitializeListHead(&amp;AbsoluteListHead);
00482         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00483             ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a3">KiTimerTableListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00484             NextEntry = ListHead-&gt;Flink;
00485             <span class="keywordflow">while</span> (NextEntry != ListHead) {
00486                 Timer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00487                 NextEntry = NextEntry-&gt;Flink;
00488                 <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o1">Absolute</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00489                     RemoveEntryList(&amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00490                     InsertTailList(&amp;AbsoluteListHead, &amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00491                 }
00492             }
00493         }
00494 
00495         <span class="comment">//</span>
00496         <span class="comment">// Recompute the due time and reinsert all absolute timers in the timer</span>
00497         <span class="comment">// tree. If a timer has already expired, then insert the timer in the</span>
00498         <span class="comment">// expired timer list.</span>
00499         <span class="comment">//</span>
00500 
00501         InitializeListHead(&amp;ExpiredListHead);
00502         <span class="keywordflow">while</span> (AbsoluteListHead.Flink != &amp;AbsoluteListHead) {
00503             Timer = CONTAINING_RECORD(AbsoluteListHead.Flink, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00504             <a class="code" href="../../d0/d0/ki_8h.html#a22">KiRemoveTreeTimer</a>(Timer);
00505             Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart -= TimeDelta.QuadPart;
00506             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/timersup_8c.html#a2">KiReinsertTreeTimer</a>(Timer, Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00507                 Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o3">Inserted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00508                 InsertTailList(&amp;ExpiredListHead, &amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00509             }
00510         }
00511 
00512         <span class="comment">//</span>
00513         <span class="comment">// If any of the attempts to reinsert a timer failed, then timers have</span>
00514         <span class="comment">// already expired and must be processed.</span>
00515         <span class="comment">//</span>
00516         <span class="comment">// N.B. The following function returns with the dispatcher database</span>
00517         <span class="comment">//      unlocked.</span>
00518         <span class="comment">//</span>
00519 
00520         <a class="code" href="../../d0/d0/ki_8h.html#a141">KiTimerListExpire</a>(&amp;ExpiredListHead, OldIrql1);
00521 
00522     } <span class="keywordflow">else</span> {
00523 
00524         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql1);
00525 
00526     }
00527 
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">// Set affinity back to its original value.</span>
00531     <span class="comment">//</span>
00532 
00533     <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// Notify other components that the system time has been set</span>
00537     <span class="comment">//</span>
00538 
00539     <a class="code" href="../../d1/d2/po_8h.html#a64">PoNotifySystemTimeSet</a>();
00540     <span class="keywordflow">return</span>;
00541 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ke/miscc.c::KeSetThreadSelectNotifyRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KeSetThreadSelectNotifyRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/ke_8h.html#a121">PTHREAD_SELECT_NOTIFY_ROUTINE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NotifyRoutine</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00940">940</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00074">KiThreadSelectNotifyRoutine</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00946                    :
00947 
00948     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a callout routine which will be called
00949     when a thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being selected <span class="keywordflow">for</span> execution.
00950 
00951 Arguments:
00952 
00953     NotifyRoutine - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread select notify callout
00954         routine.
00955 
00956 Return Value:
00957 
00958     None.
00959 
00960 --*/
00961 
00962 {
00963 
00964     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00965 
00966     <a class="code" href="../../d5/d9/kernldat_8c.html#a5">KiThreadSelectNotifyRoutine</a> = NotifyRoutine;
00967     <span class="keywordflow">return</span>;
00968 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ke/miscc.c::KeSetTimeIncrement" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeSetTimeIncrement           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumIncrement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MinimumIncrement</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00779">779</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02775">KeMinimumIncrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02812">KeTimeAdjustment</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02813">KeTimeIncrement</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l01139">KiTickOffset</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>.
<p>
<pre class="fragment"><div>00786                    :
00787 
00788     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time increment value in 100ns units. This
00789     value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system time at each interval clock interrupt.
00790 
00791 Arguments:
00792 
00793     MaximumIncrement - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum time between clock interrupts
00794         in 100ns units supported by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a>.
00795 
00796     MinimumIncrement - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> time between clock interrupts
00797         in 100ns units supported by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a>.
00798 
00799 Return Value:
00800 
00801     None.
00802 
00803 --*/
00804 
00805 {
00806 
00807     <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a> = MaximumIncrement;
00808     <a class="code" href="../../d4/d9/ke_8h.html#a132">KeMinimumIncrement</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(MinimumIncrement, 10 * 1000);
00809     <a class="code" href="../../d4/d9/ke_8h.html#a152">KeTimeAdjustment</a> = MaximumIncrement;
00810     <a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a> = MaximumIncrement;
00811     <a class="code" href="../../d0/d0/ki_8h.html#a66">KiTickOffset</a> = MaximumIncrement;
00812 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ke/miscc.c::KeSetTimeUpdateNotifyRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KeSetTimeUpdateNotifyRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/ke_8h.html#a122">PTIME_UPDATE_NOTIFY_ROUTINE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NotifyRoutine</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00972">972</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00082">KiTimeUpdateNotifyRoutine</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00978                    :
00979 
00980     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a callout routine which will be called
00981     each time <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> runtime <span class="keywordflow">for</span> a thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated.
00982 
00983 Arguments:
00984 
00985     RoutineNotify - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time update notify callout
00986         routine.
00987 
00988 Return Value:
00989 
00990     None.
00991 
00992 --*/
00993 
00994 {
00995 
00996     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00997 
00998     <a class="code" href="../../d5/d9/kernldat_8c.html#a6">KiTimeUpdateNotifyRoutine</a> = NotifyRoutine;
00999     <span class="keywordflow">return</span>;
01000 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ke/miscc.c::KiAdjustInterruptTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiAdjustInterruptTime           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LONGLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TimeDelta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00544">544</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d1/d9/ki_8h-source.html#l00430">ADJUST_INTERRUPT_TIME_CONTEXT::Adjustment</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00434">ADJUST_INTERRUPT_TIME_CONTEXT::Barrier</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00433">ADJUST_INTERRUPT_TIME_CONTEXT::HalNumber</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00592">KiCalibrateTimeAdjustment()</a>, <a class="el" href="../../d3/d0/xipi_8c-source.html#l00040">KiIpiGenericCall()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00432">ADJUST_INTERRUPT_TIME_CONTEXT::KiNumber</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00293">PKIPI_BROADCAST_WORKER</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00335">KeSetSystemTime()</a>, and <a class="el" href="../../d5/d5/alpha_2allproc_8c-source.html#l00078">KeStartAllProcessors()</a>.
<p>
<pre class="fragment"><div>00549                    :
00550 
00551     This function moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical interrupt time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
00552     foreward by TimeDelta after a system wake has occurred.
00553 
00554 Arguments:
00555 
00556     TimeDelta - amount of time to bump foreward interrupt time, tick
00557                 count and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> perforamnce counter in 100ns units
00558 
00559 Return Value:
00560 
00561     None.
00562 
00563 --*/
00564 {
00565     <a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html">ADJUST_INTERRUPT_TIME_CONTEXT</a> Adjust;
00566 
00567     <span class="comment">//</span>
00568     <span class="comment">// Can only move time foreward</span>
00569     <span class="comment">//</span>
00570 
00571     <span class="keywordflow">if</span> (TimeDelta &lt; 0) {
00572 
00573         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574 
00575     } <span class="keywordflow">else</span> {
00576 
00577         Adjust.<a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html#o2">KiNumber</a> = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
00578         Adjust.<a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html#o3">HalNumber</a> = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
00579         Adjust.<a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html#o0">Adjustment</a> = (ULONGLONG) TimeDelta;
00580         Adjust.<a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html#o4">Barrier</a> = 1;
00581 
00582         <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
00583             (PKIPI_BROADCAST_WORKER) KiCalibrateTimeAdjustment,
00584             (ULONG_PTR)(&amp;Adjust)
00585         );
00586 
00587         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00588     }
00589 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ke/miscc.c::KiCalibrateTimeAdjustment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiCalibrateTimeAdjustment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d0/ki_8h.html#a34">PADJUST_INTERRUPT_TIME_CONTEXT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Adjust</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00592">592</a> of file <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html">ke/miscc.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a171">HalCalibratePerformanceCounter()</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00089">KeInsertQueueDpc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02769">KeInterruptTimeBias</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00122">KeQueryInterruptTime()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter()</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00272">KeRemoveQueueDpc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02797">KeTickCount</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02813">KeTimeIncrement</a>, <a class="el" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts()</a>, <a class="el" href="../../d0/d4/ke_2debug_8c-source.html#l00538">KiPollFreezeExecution()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l01139">KiTickOffset</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00497">KiTimerExpireDpc</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/largeic_8c-source.html#l00040">RtlExtendedLargeIntegerDivide()</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00094">TIMER_TABLE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00544">KiAdjustInterruptTime()</a>.
<p>
<pre class="fragment"><div>00597                    :
00598 
00599     Worker function <span class="keywordflow">for</span> <a class="code" href="../../d0/d0/ki_8h.html#a96">KiAdjustInterruptTime</a> to calibrate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00600     adjustment of time on all processors.
00601 
00602 Arguments:
00603 
00604     Adjust - context structure <span class="keywordflow">for</span> operation
00605 
00606 Return Value:
00607 
00608     None.
00609 
00610 --*/
00611 {
00612     BOOLEAN             Enable;
00613     LARGE_INTEGER       InterruptTime;
00614     LARGE_INTEGER       SetTime;
00615     LARGE_INTEGER       PerfFreq;
00616     ULARGE_INTEGER      li;
00617     LARGE_INTEGER       NewTickCount;
00618     ULONG               NewTickOffset;
00619     ULONG               cl, divisor;
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">// As each processor arrives, subtract one off the remaining processor</span>
00623     <span class="comment">// count.  If this is the last processor to arrive compute the time</span>
00624     <span class="comment">// change, and signal all processor when to applied the performance</span>
00625     <span class="comment">// counter change.</span>
00626     <span class="comment">//</span>
00627 
00628     <span class="keywordflow">if</span> (InterlockedDecrement((PLONG) &amp;Adjust-&gt;KiNumber)) {
00629 
00630         Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
00631 
00632         <span class="comment">//</span>
00633         <span class="comment">// It is possible to deadlock here if one or more of the</span>
00634         <span class="comment">// other processors gets and processes a freeze request</span>
00635         <span class="comment">// while this processor has interrupts disabled.  Poll</span>
00636         <span class="comment">// for IPI_FREEZE requests until all processors are known</span>
00637         <span class="comment">// to be in this code and hence wont be requesting a </span>
00638         <span class="comment">// freeze.</span>
00639         <span class="comment">//</span>
00640 
00641         <span class="keywordflow">do</span> {
00642             <a class="code" href="../../d0/d0/ki_8h.html#a150">KiPollFreezeExecution</a>();
00643         } <span class="keywordflow">while</span> (Adjust-&gt;KiNumber != (ULONG)-1);
00644 
00645         <span class="comment">//</span>
00646         <span class="comment">// Wait to perform the time set</span>
00647         <span class="comment">//</span>
00648 
00649         <span class="keywordflow">while</span> (Adjust-&gt;Barrier) ;
00650 
00651     } <span class="keywordflow">else</span> {
00652 
00653         <span class="comment">//</span>
00654         <span class="comment">// Set timer expiration dpc to scan the timer queues once</span>
00655         <span class="comment">// for any expired timers</span>
00656         <span class="comment">//</span>
00657 
00658         <a class="code" href="../../d4/d1/dpcobj_8c.html#a3">KeRemoveQueueDpc</a> (&amp;KiTimerExpireDpc);
00659         <a class="code" href="../../d4/d1/dpcobj_8c.html#a2">KeInsertQueueDpc</a> (&amp;KiTimerExpireDpc, (PVOID) TIMER_TABLE_SIZE, NULL);
00660 
00661         <span class="comment">//</span>
00662         <span class="comment">// Disable interrupts and indicate that this processor is now</span>
00663         <span class="comment">// in final portion of this code.</span>
00664         <span class="comment">//</span>
00665 
00666         Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
00667         InterlockedDecrement((PLONG) &amp;Adjust-&gt;KiNumber);
00668 
00669         <span class="comment">//</span>
00670         <span class="comment">// Get the current times</span>
00671         <span class="comment">//</span>
00672 
00673         <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> (&amp;PerfFreq);
00674         InterruptTime.QuadPart = <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a2">KeQueryInterruptTime</a>() + Adjust-&gt;Adjustment;
00675         SetTime.QuadPart = InterruptTime.QuadPart + <a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a> / 2;
00676 
00677         <span class="comment">//</span>
00678         <span class="comment">// Compute performance counter for current SetTime</span>
00679         <span class="comment">//</span>
00680 
00681         <span class="comment">//</span>
00682         <span class="comment">// Multiply SetTime * PerfCount and obtain 96bit result</span>
00683         <span class="comment">// in cl, li.LowPart, li.HighPart.  Then divide the 96bit</span>
00684         <span class="comment">// result by 10,000,000 to get new performance counter value.</span>
00685         <span class="comment">//</span>
00686 
00687         li.QuadPart = RtlEnlargedUnsignedMultiply (
00688                             (ULONG) SetTime.LowPart,
00689                             (ULONG) PerfFreq.LowPart
00690                             ).QuadPart;
00691 
00692         cl = li.LowPart;
00693         li.QuadPart = li.HighPart +
00694                       RtlEnlargedUnsignedMultiply (
00695                             (ULONG) SetTime.LowPart,
00696                             (ULONG) PerfFreq.HighPart
00697                             ).QuadPart;
00698 
00699         li.QuadPart = li.QuadPart +
00700                       RtlEnlargedUnsignedMultiply (
00701                             (ULONG) SetTime.HighPart,
00702                             (ULONG) PerfFreq.LowPart
00703                             ).QuadPart;
00704 
00705         li.HighPart = li.HighPart + SetTime.HighPart * PerfFreq.HighPart;
00706 
00707         divisor = 10000000;
00708         Adjust-&gt;NewCount.HighPart =
00709             RtlEnlargedUnsignedDivide (
00710                 li,
00711                 divisor,
00712                 &amp;li.HighPart
00713                 );
00714 
00715         li.LowPart = cl;
00716         Adjust-&gt;NewCount.LowPart =
00717             RtlEnlargedUnsignedDivide (
00718                 li,
00719                 divisor,
00720                 NULL
00721                 );
00722 
00723         <span class="comment">//</span>
00724         <span class="comment">// Compute tick count and tick offset for current InterruptTime</span>
00725         <span class="comment">//</span>
00726 
00727         NewTickCount = <a class="code" href="../../d0/d1/largeic_8c.html#a0">RtlExtendedLargeIntegerDivide</a>(
00728                             InterruptTime,
00729                             KeMaximumIncrement,
00730                             &amp;NewTickOffset
00731                             );
00732 
00733         <span class="comment">//</span>
00734         <span class="comment">// Apply changes to InterruptTime, TickCount, TickOffset, and the</span>
00735         <span class="comment">// performance counter</span>
00736         <span class="comment">//</span>
00737 
00738         <a class="code" href="../../d0/d0/ki_8h.html#a66">KiTickOffset</a> = <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a> - NewTickOffset;
00739         <a class="code" href="../../d4/d9/ke_8h.html#a126">KeInterruptTimeBias</a> += Adjust-&gt;Adjustment;
00740         SharedUserData-&gt;TickCountLow = NewTickCount.LowPart;
00741 
00742 <span class="preprocessor">#if defined(_WIN64)</span>
00743 <span class="preprocessor"></span>
00744         <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a> = NewTickCount.QuadPart;
00745         SharedUserData-&gt;InterruptHigh2Time = InterruptTime.HighPart;
00746         SharedUserData-&gt;InterruptTime = InterruptTime.QuadPart;
00747 
00748 <span class="preprocessor">#elif defined(ALPHA)</span>
00749 <span class="preprocessor"></span>
00750         <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a> = NewTickCount.QuadPart;
00751         SharedUserData-&gt;InterruptTime = InterruptTime.QuadPart;
00752 
00753 <span class="preprocessor">#else</span>
00754 <span class="preprocessor"></span>        <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>.High2Time = NewTickCount.HighPart;
00755         <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>.LowPart   = NewTickCount.LowPart;
00756         <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>.High1Time = NewTickCount.HighPart;
00757 
00758         SharedUserData-&gt;InterruptTime.High2Time = InterruptTime.HighPart;
00759         SharedUserData-&gt;InterruptTime.LowPart   = InterruptTime.LowPart;
00760         SharedUserData-&gt;InterruptTime.High1Time = InterruptTime.HighPart;
00761 <span class="preprocessor">#endif</span>
00762 <span class="preprocessor"></span>
00763         <span class="comment">//</span>
00764         <span class="comment">// Apply the performance counter change</span>
00765         <span class="comment">//</span>
00766 
00767         Adjust-&gt;Barrier = 0;
00768     }
00769 
00770     <a class="code" href="../../d2/d7/hal_8h.html#a171">HalCalibratePerformanceCounter</a> (
00771         (<span class="keyword">volatile</span> PLONG) &amp;Adjust-&gt;HalNumber,
00772         (ULONGLONG) Adjust-&gt;NewCount.QuadPart
00773         );
00774 
00775     <a class="code" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts</a>(Enable);
00776 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:43 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
