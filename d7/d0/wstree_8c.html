<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wstree.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wstree.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d8/d9/wstree_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a4">MiLookupWsleHashIndex</a> (IN ULONG_PTR WsleEntry, IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a5">MiCheckWsleHash</a> (IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a6">MiInsertWsle</a> (IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> Entry, IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (IN PVOID VirtualAddress, IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList, IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WsPfnIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> Entry, IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> SwapEntry, IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> Entry, IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a10">MiRemoveWsleFromFreeList</a> (IN ULONG Entry, IN <a class="el" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle, IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a0">MmSystemCodePage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a1">MmSystemCachePage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a2">MmPagedPoolPage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/wstree_8c.html#a3">MmSystemDriverPage</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="wstree.c::MiCheckWsleHash" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiCheckWsleHash           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WorkingSetList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">MiGrowWsleHash()</a>, and <a class="el" href="../../d8/d9/wstree_8c-source.html#l00051">MiInsertWsle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="wstree.c::MiInsertWsle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiInsertWsle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00051">51</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01573">_MMWSLENTRY::Direct</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01585">_MMWSLE::e1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01532">_MMWSLE_HASH::Index</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00182">KeQueryTickCount()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01531">_MMWSLE_HASH::Key</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00982">LOCK_EXPANSION_IF_ALPHA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01584">_MMWSLE::Long</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01559">MI_WSLE_HASH</a>, <a class="el" href="../../d7/d0/wstree_8c.html#a5">MiCheckWsleHash()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">MiFreeWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00165">MM_DBG_PTE_UPDATE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00119">MM_GROW_WSLE_HASH</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02174">PERFINFO_GET_PAGE_INFO</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02195">PERFINFO_LOG_WS_REMOVAL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02201">PERFINFO_PAGE_INFO_DECL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d7/lh__open_2pi__tick_8c-source.html#l00055">TickCount()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00991">UNLOCK_EXPANSION_IF_ALPHA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01568">_MMWSLENTRY::Valid</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04228">MiRemoveWorkingSetPages()</a>, and <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">MiUpdateWsle()</a>.
<p>
<pre class="fragment"><div>00058                    :
00059 
00060     This routine inserts a Working Set <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> Entry (WSLE) into the
00061     working set.
00062 
00063 Arguments:
00064 
00065     Entry - The index number of the WSLE to insert.
00066 
00067     WorkingSetList - Supplies the working set list to insert into.
00068 
00069 Return Value:
00070 
00071     None.
00072 
00073 Environment:
00074 
00075     Kernel mode, APCs disabled, Working Set Mutex held.
00076 
00077 --*/
00078 
00079 {
00080     PVOID VirtualAddress;
00081     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00082     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo;
00083     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> Hash;
00084     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> Table;
00085     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> j;
00086     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00087     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00088     LARGE_INTEGER <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a7">TickCount</a>;
00089     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00090 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00091 <span class="preprocessor"></span>    KIRQL OldIrql;
00092 <span class="preprocessor">#endif</span>
00093 <span class="preprocessor"></span>
00094     Wsle = WorkingSetList-&gt;Wsle;
00095 
00096     VirtualAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Wsle[Entry].u1.VirtualAddress);
00097 
00098 <span class="preprocessor">#if DBG</span>
00099 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
00100         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"inserting element %lx %lx\n"</span>, Entry, Wsle[Entry].u1.Long);
00101     }
00102 
00103     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[Entry].u1.e1.Valid == 1);
00104     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[Entry].u1.e1.Direct != 1);
00105 <span class="preprocessor">#endif //DBG</span>
00106 <span class="preprocessor"></span>
00107     WorkingSetList-&gt;NonDirectCount += 1;
00108 
00109     <span class="keywordflow">if</span> ((Table = WorkingSetList-&gt;HashTable) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00110         <span class="keywordflow">return</span>;
00111     }
00112 
00113 <span class="preprocessor">#if DBG</span>
00114 <span class="preprocessor"></span>    MmNumberOfInserts += 1;
00115 <span class="preprocessor">#endif //DBG</span>
00116 <span class="preprocessor"></span>
00117     Hash = <a class="code" href="../../d4/d8/mi_8h.html#a191">MI_WSLE_HASH</a>(Wsle[Entry].u1.Long, WorkingSetList);
00118 
00119     <span class="comment">//</span>
00120     <span class="comment">// Check hash table size and see if there is enough room to</span>
00121     <span class="comment">// hash or if the table should be grown.</span>
00122     <span class="comment">//</span>
00123 
00124     <span class="keywordflow">if</span> ((WorkingSetList-&gt;NonDirectCount + 10 +
00125             (WorkingSetList-&gt;HashTableSize &gt;&gt; 4)) &gt;
00126                                  WorkingSetList-&gt;HashTableSize) {
00127 
00128         <span class="keywordflow">if</span> (WorkingSetList == <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>) {
00129             WsInfo = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm;
00130             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00131         }
00132         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WorkingSetList == <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>) {
00133             WsInfo = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
00134             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00135         }
00136         <span class="keywordflow">else</span> {
00137             WsInfo = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
00138             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
00139         }
00140 
00141         <span class="keywordflow">if</span> ((Table + WorkingSetList-&gt;HashTableSize + ((2*<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) / <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>)) &lt;= (<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a>)WorkingSetList-&gt;HighestPermittedHashAddress) &amp;&amp;
00142                 (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a>)) {
00143 
00144 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00145 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00146 <span class="preprocessor">#endif</span>
00147 <span class="preprocessor"></span>            WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a32">MM_GROW_WSLE_HASH</a>;
00148 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00149 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00150 <span class="preprocessor">#endif</span>
00151 <span class="preprocessor"></span>        }
00152 
00153         <span class="keywordflow">if</span> ((WorkingSetList-&gt;NonDirectCount +
00154                 (WorkingSetList-&gt;HashTableSize &gt;&gt; 4)) &gt;
00155                                      WorkingSetList-&gt;HashTableSize) {
00156 
00157             <span class="comment">//</span>
00158             <span class="comment">// No more room in the hash table, remove one and add there.</span>
00159             <span class="comment">// Pick a victim within 16 of where this would hash to.</span>
00160             <span class="comment">//</span>
00161 
00162             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a>(&amp;TickCount);
00163             j = Hash + (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a7">TickCount</a>.LowPart &amp; 0xF);
00164 
00165             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = WorkingSetList-&gt;HashTableSize;
00166 
00167             <span class="keywordflow">if</span> (j &gt;= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) {
00168                 j = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a7">TickCount</a>.LowPart &amp; 0xF;
00169             }
00170 
00171             <span class="keywordflow">do</span> {
00172                 <span class="keywordflow">if</span> (Table[j].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">Key</a> != 0) {
00173                     <a class="code" href="../../d2/d1/mm_8h.html#a80">PERFINFO_PAGE_INFO_DECL</a>();
00174 
00175                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Table[j].Key);
00176                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = WorkingSetList-&gt;HashTable[j].Index;
00177                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[Index].u1.e1.Valid == 1);
00178                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle[Index].u1.VirtualAddress);
00179 
00180                     <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
00181                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (Index, WsInfo, PointerPte)) {
00182                         <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_HASHFULL, WsInfo);
00183                         <span class="keywordflow">break</span>;
00184                     }
00185                 }
00186                 j += 1;
00187                 <span class="keywordflow">if</span> (j &gt;= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) {
00188                     j = 0;
00189                 }
00190             } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00191         }
00192     }
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">// Add to the hash table.</span>
00196     <span class="comment">//</span>
00197 
00198     <span class="keywordflow">while</span> (Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">Key</a> != 0) {
00199         Hash += 1;
00200         <span class="keywordflow">if</span> (Hash &gt;= WorkingSetList-&gt;HashTableSize) {
00201             Hash = 0;
00202         }
00203     }
00204 
00205     Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">Key</a> = Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00206     Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o1">Index</a> = Entry;
00207 
00208 <span class="preprocessor">#if DBG</span>
00209 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((MmNumberOfInserts % 1000) == 0) {
00210         <a class="code" href="../../d7/d0/wstree_8c.html#a5">MiCheckWsleHash</a> (WorkingSetList);
00211     }
00212 <span class="preprocessor">#endif //DBG</span>
00213 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00214 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="wstree.c::MiLocateWsle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> FASTCALL MiLocateWsle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsPfnIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">248</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01532">_MMWSLE_HASH::Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01531">_MMWSLE_HASH::Key</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00665">MI_GET_WORKING_SET_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00400">MI_MAXIMUM_PTE_WORKING_SET_INDEX</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01559">MI_WSLE_HASH</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05006">MiDeleteAddressesInWorkingSet()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01874">MiGetPageProtection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00579">MiRemoveMappedPtes()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00899">MiRemovePageFromWorkingSet()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04446">MiSessionCopyOnWrite()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00381">MmUnmapViewInSystemCache()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, and <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00256                    :
00257 
00258     This function locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00259     working set list.
00260 
00261 Arguments:
00262 
00263     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> to locate within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working
00264                      set list.
00265 
00266     WorkingSetList - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list to search.
00267 
00268     WsPfnIndex - Supplies a hint to <span class="keywordflow">try</span> before hashing or walking linearly.
00269 
00270 Return Value:
00271 
00272     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry.
00273 
00274 Environment:
00275 
00276     Kernel mode, APCs disabled, Working Set Mutex held.
00277 
00278 --*/
00279 
00280 {
00281     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> i;
00282     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00283     ULONG Hash;
00284     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> Table;
00285     ULONG Tries;
00286     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WsPteIndex;
00287     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00288 
00289     Wsle = WorkingSetList-&gt;Wsle;
00290 
00291     VirtualAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress);
00292 
00293 <span class="preprocessor">#if defined (_WIN64)</span>
00294 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
00295     WsPteIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a110">MI_GET_WORKING_SET_FROM_PTE</a> (PointerPte);
00296     <span class="keywordflow">if</span> (WsPteIndex != 0) {
00297         <span class="keywordflow">while</span> (WsPteIndex &lt;= WorkingSetList-&gt;LastInitializedWsle) {
00298             <span class="keywordflow">if</span> ((VirtualAddress == <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Wsle[WsPteIndex].u1.VirtualAddress)) &amp;&amp;
00299                 (Wsle[WsPteIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1)) {
00300                     <span class="keywordflow">return</span> WsPteIndex;
00301             }
00302             WsPteIndex += <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a92">MI_MAXIMUM_PTE_WORKING_SET_INDEX</a>;
00303         }
00304 
00305         <span class="comment">//</span>
00306         <span class="comment">// No working set index for this PTE !</span>
00307         <span class="comment">//</span>
00308 
00309         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
00310                       0x41283,
00311                       (ULONG_PTR)VirtualAddress,
00312                       PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00313                       (ULONG_PTR)WorkingSetList);
00314     }
00315 <span class="preprocessor">#endif</span>
00316 <span class="preprocessor"></span>
00317     <span class="keywordflow">if</span> (WsPfnIndex &lt;= WorkingSetList-&gt;LastInitializedWsle) {
00318         <span class="keywordflow">if</span> ((VirtualAddress == <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Wsle[WsPfnIndex].u1.VirtualAddress)) &amp;&amp;
00319             (Wsle[WsPfnIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1)) {
00320             <span class="keywordflow">return</span> WsPfnIndex;
00321         }
00322     }
00323 
00324     <span class="keywordflow">if</span> (WorkingSetList-&gt;HashTable) {
00325         Tries = 0;
00326         Table = WorkingSetList-&gt;HashTable;
00327 
00328         Hash = <a class="code" href="../../d4/d8/mi_8h.html#a191">MI_WSLE_HASH</a>(VirtualAddress, WorkingSetList);
00329 
00330         <span class="keywordflow">while</span> (Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">Key</a> != (ULONG_PTR)VirtualAddress) {
00331             Hash += 1;
00332             <span class="keywordflow">if</span> (Hash &gt;= WorkingSetList-&gt;HashTableSize) {
00333                 Hash = 0;
00334                 <span class="keywordflow">if</span> (Tries != 0) {
00335                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
00336                                   0x41284,
00337                                   (ULONG_PTR)VirtualAddress,
00338                                   WsPfnIndex,
00339                                   (ULONG_PTR)WorkingSetList);
00340                 }
00341                 Tries = 1;
00342             }
00343         }
00344         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;Wsle[Table[Hash].Index].u1.e1.Direct == 0);
00345         <span class="keywordflow">return</span> Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o1">Index</a>;
00346     }
00347 
00348     i = 0;
00349 
00350     <span class="keywordflow">for</span> (; ; ) {
00351         <span class="keywordflow">if</span> ((VirtualAddress == <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Wsle[i].u1.VirtualAddress)) &amp;&amp;
00352             (Wsle[i].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1)) {
00353             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;Wsle[i].u1.e1.Direct == 0);
00354             <span class="keywordflow">return</span> i;
00355         }
00356         i += 1;
00357     }
00358 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="wstree.c::MiLookupWsleHashIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiLookupWsleHashIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>WsleEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00765">765</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.
<p>
References <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01531">_MMWSLE_HASH::Key</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01559">MI_WSLE_HASH</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>.
<p>
<pre class="fragment"><div>00770 {
00771     ULONG Hash;
00772     ULONG_PTR VirtualAddress;
00773     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> Table;
00774     ULONG Tries = 0;
00775 
00776     Table = WorkingSetList-&gt;HashTable;
00777     VirtualAddress = WsleEntry &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00778 
00779     Hash = <a class="code" href="../../d4/d8/mi_8h.html#a191">MI_WSLE_HASH</a>(WsleEntry, WorkingSetList);
00780 
00781     <span class="keywordflow">while</span> (Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">Key</a> != (ULONG_PTR)VirtualAddress) {
00782         Hash += 1;
00783         <span class="keywordflow">if</span> (Hash &gt;= WorkingSetList-&gt;HashTableSize) {
00784             Hash = 0;
00785             <span class="keywordflow">if</span> (Tries != 0) {
00786                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
00787                               0x41884,
00788                               (ULONG_PTR)VirtualAddress,
00789                               WsleEntry,
00790                               (ULONG_PTR)WorkingSetList);
00791             }
00792             Tries = 1;
00793         }
00794     }
00795     <span class="keywordflow">return</span> Hash;
00796 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="wstree.c::MiRemoveWsle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiRemoveWsle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00464">464</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01585">_MMWSLE::e1</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01531">_MMWSLE_HASH::Key</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01584">_MMWSLE::Long</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02717">MI_IS_SYSTEM_CACHE_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01559">MI_WSLE_HASH</a>, <a class="el" href="../../d4/d8/mi_8h.html#a967">MiDumpWsl()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00166">MM_DBG_DUMP_WSL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00165">MM_DBG_PTE_UPDATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00160">MM_PAGED_POOL_START</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00063">MmNonPagedSystemStart</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00048">MmPagedPoolPage</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00047">MmSystemCachePage</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00049">MmSystemCacheStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00046">MmSystemCodePage</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00049">MmSystemDriverPage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01568">_MMWSLENTRY::Valid</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">MiFreeWsle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00579">MiRemoveMappedPtes()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00899">MiRemovePageFromWorkingSet()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04228">MiRemoveWorkingSetPages()</a>, and <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00381">MmUnmapViewInSystemCache()</a>.
<p>
<pre class="fragment"><div>00471                    :
00472 
00473     This routine removes a Working Set <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> Entry (WSLE) from the
00474     working set.
00475 
00476 Arguments:
00477 
00478     Entry - The index number of the WSLE to remove.
00479 
00480 
00481 Return Value:
00482 
00483     None.
00484 
00485 Environment:
00486 
00487     Kernel mode, APCs disabled, Working Set Mutex held.
00488 
00489 --*/
00490 {
00491     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00492     PVOID VirtualAddress;
00493     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> Table;
00494     ULONG Hash;
00495     ULONG Tries;
00496 
00497     Wsle = WorkingSetList-&gt;Wsle;
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// Locate the entry in the tree.</span>
00501     <span class="comment">//</span>
00502 
00503 <span class="preprocessor">#if DBG</span>
00504 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
00505         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"removing wsle %lx   %lx\n"</span>,
00506             Entry, Wsle[Entry].u1.Long);
00507     }
00508     <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a58">MM_DBG_DUMP_WSL</a>) {
00509         <a class="code" href="../../d4/d8/mi_8h.html#a967">MiDumpWsl</a>();
00510         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" \n"</span>);
00511     }
00512 
00513 <span class="preprocessor">#endif //DBG</span>
00514 <span class="preprocessor"></span>
00515     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[Entry].u1.e1.Valid == 1);
00516 
00517     VirtualAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (Wsle[Entry].u1.VirtualAddress);
00518 
00519     <span class="keywordflow">if</span> (WorkingSetList == <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>) {
00520 
00521         <span class="comment">//</span>
00522         <span class="comment">// count system space inserts and removals.</span>
00523         <span class="comment">//</span>
00524 
00525 <span class="preprocessor">#if defined(_X86_)</span>
00526 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(VirtualAddress)) {
00527             <a class="code" href="../../d6/d8/sysinfo_8c.html#a10">MmSystemCachePage</a> -= 1;
00528         } <span class="keywordflow">else</span>
00529 <span class="preprocessor">#endif</span>
00530 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a>) {
00531             <a class="code" href="../../d6/d8/sysinfo_8c.html#a9">MmSystemCodePage</a> -= 1;
00532         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a21">MM_PAGED_POOL_START</a>) {
00533             <a class="code" href="../../d6/d8/sysinfo_8c.html#a10">MmSystemCachePage</a> -= 1;
00534         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>) {
00535             <a class="code" href="../../d6/d8/sysinfo_8c.html#a11">MmPagedPoolPage</a> -= 1;
00536         } <span class="keywordflow">else</span> {
00537             <a class="code" href="../../d6/d8/sysinfo_8c.html#a12">MmSystemDriverPage</a> -= 1;
00538         }
00539     }
00540 
00541     Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 0;
00542 
00543     <span class="keywordflow">if</span> (Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct == 0) {
00544 
00545         WorkingSetList-&gt;NonDirectCount -= 1;
00546 
00547         <span class="keywordflow">if</span> (WorkingSetList-&gt;HashTable) {
00548             Hash = <a class="code" href="../../d4/d8/mi_8h.html#a191">MI_WSLE_HASH</a>(Wsle[Entry].u1.Long, WorkingSetList);
00549             Table = WorkingSetList-&gt;HashTable;
00550             Tries = 0;
00551 
00552             <span class="keywordflow">while</span> (Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">Key</a> != (ULONG_PTR)VirtualAddress) {
00553                 Hash += 1;
00554                 <span class="keywordflow">if</span> (Hash &gt;= WorkingSetList-&gt;HashTableSize) {
00555                     Hash = 0;
00556                     <span class="keywordflow">if</span> (Tries != 0) {
00557                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
00558                                       0x41784,
00559                                       (ULONG_PTR)VirtualAddress,
00560                                       Entry,
00561                                       (ULONG_PTR)WorkingSetList);
00562                     }
00563                     Tries = 1;
00564                 }
00565             }
00566             Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">Key</a> = 0;
00567 
00568         }
00569     }
00570 
00571     <span class="keywordflow">return</span>;
00572 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="wstree.c::MiRemoveWsleFromFreeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiRemoveWsleFromFreeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Wsle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00799">799</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>.
<p>
<pre class="fragment"><div>00807                    :
00808 
00809     This routine removes a working set list entry from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list.
00810     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry required <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first element
00811     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list.
00812 
00813 Arguments:
00814 
00815     Entry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry to remove.
00816 
00817     Wsle - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array of WSLEs.
00818 
00819     WorkingSetList - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list.
00820 
00821 Return Value:
00822 
00823     None.
00824 
00825 Environment:
00826 
00827     Kernel mode, Working set lock and PFN lock held, APCs disabled.
00828 
00829 --*/
00830 
00831 {
00832     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> Free;
00833     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> ParentFree;
00834 
00835     Free = WorkingSetList-&gt;FirstFree;
00836 
00837     <span class="keywordflow">if</span> (Entry == Free) {
00838         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Wsle[Entry].u1.Long &gt;&gt; MM_FREE_WSLE_SHIFT) &lt;= WorkingSetList-&gt;LastInitializedWsle);
00839         WorkingSetList-&gt;FirstFree = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(Wsle[Entry].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>);
00840 
00841     } <span class="keywordflow">else</span> {
00842         <span class="keywordflow">do</span> {
00843             ParentFree = Free;
00844             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[Free].u1.e1.Valid == 0);
00845             Free = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(Wsle[Free].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>);
00846         } <span class="keywordflow">while</span> (Free != Entry);
00847 
00848         Wsle[ParentFree].u1.Long = Wsle[Entry].u1.Long;
00849     }
00850     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;FirstFree &lt;= WorkingSetList-&gt;LastInitializedWsle) ||
00851             (WorkingSetList-&gt;FirstFree == WSLE_NULL_INDEX));
00852     <span class="keywordflow">return</span>;
00853 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="wstree.c::MiSwapWslEntries" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSwapWslEntries           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SwapEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">576</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01532">_MMWSLE_HASH::Index</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00765">MiLookupWsleHashIndex()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00799">MiRemoveWsleFromFreeList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l02824">MiAddWorkingSetPage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03179">MiAddWsleHash()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05006">MiDeleteAddressesInWorkingSet()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00899">MiRemovePageFromWorkingSet()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">MiUpdateWsle()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, and <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00584                    :
00585 
00586     This routine swaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list entries Entry and SwapEntry
00587     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified working set list (process or system cache).
00588 
00589 Arguments:
00590 
00591     SwapEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first entry to swap.  This entry must be
00592                 valid, i.e. in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current time.
00593 
00594     Entry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other entry to swap.  This entry may be valid
00595             or invalid.
00596 
00597     WsInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list.
00598 
00599 Return Value:
00600 
00601     None.
00602 
00603 Environment:
00604 
00605     Kernel mode, Working set lock and PFN lock held (<span class="keywordflow">if</span> system cache),
00606                  APCs disabled.
00607 
00608 --*/
00609 
00610 {
00611     <a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a> WsleEntry;
00612     <a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a> WsleSwap;
00613     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00614     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00615     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00616     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00617     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> Table;
00618 <span class="preprocessor">#if DBG</span>
00619 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> CurrentSize = WsInfo-&gt;WorkingSetSize;
00620 <span class="preprocessor">#endif //DBG</span>
00621 <span class="preprocessor"></span><span class="preprocessor">#if PFN_CONSISTENCY</span>
00622 <span class="preprocessor"></span>    KIRQL OldIrql;
00623 <span class="preprocessor">#endif</span>
00624 <span class="preprocessor"></span>
00625     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00626     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
00627 
00628     WsleSwap = Wsle[SwapEntry];
00629 
00630     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsleSwap.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0);
00631 
00632     WsleEntry = Wsle[Entry];
00633 
00634     Table = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a>;
00635 
00636     <span class="keywordflow">if</span> (WsleEntry.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 0) {
00637 
00638         <span class="comment">//</span>
00639         <span class="comment">// Entry is not on any list. Remove it from the free list.</span>
00640         <span class="comment">//</span>
00641 
00642         <a class="code" href="../../d7/d0/wstree_8c.html#a10">MiRemoveWsleFromFreeList</a> (Entry, Wsle, WorkingSetList);
00643 
00644         <span class="comment">//</span>
00645         <span class="comment">// Copy the Entry to this free one.</span>
00646         <span class="comment">//</span>
00647 
00648         Wsle[Entry] = WsleSwap;
00649 
00650         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WsleSwap.u1.VirtualAddress);
00651 
00652         <span class="keywordflow">if</span> (WsleSwap.u1.e1.Direct) {
00653             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00654 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00655 <span class="preprocessor"></span>            OldIrql = 99;
00656             <span class="keywordflow">if</span> (PFN_LOCK_OWNED_BY_ME() == 0) {
00657                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00658             }
00659 <span class="preprocessor">#endif</span>
00660 <span class="preprocessor"></span>            Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = Entry;
00661 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00662 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (OldIrql != 99) {
00663                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00664             }
00665 <span class="preprocessor">#endif</span>
00666 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
00667 
00668             <span class="comment">//</span>
00669             <span class="comment">// Update hash table.</span>
00670             <span class="comment">//</span>
00671 
00672             <span class="keywordflow">if</span> (Table) {
00673                 Table [ <a class="code" href="../../d7/d0/wstree_8c.html#a4">MiLookupWsleHashIndex</a> (WsleSwap.u1.Long,
00674                                            WorkingSetList)].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o1">Index</a> = Entry;
00675             }
00676         }
00677 
00678         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, Entry);
00679 
00680         <span class="comment">//</span>
00681         <span class="comment">// Put entry on free list.</span>
00682         <span class="comment">//</span>
00683 
00684         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>);
00685         Wsle[SwapEntry].u1.Long = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
00686         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = SwapEntry;
00687         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
00688             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
00689 
00690     } <span class="keywordflow">else</span> {
00691 
00692         <span class="comment">//</span>
00693         <span class="comment">// Both entries are valid.</span>
00694         <span class="comment">//</span>
00695 
00696         Wsle[SwapEntry] = WsleEntry;
00697 
00698         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WsleEntry.u1.VirtualAddress);
00699 
00700         <span class="keywordflow">if</span> (WsleEntry.u1.e1.Direct) {
00701 
00702             <span class="comment">//</span>
00703             <span class="comment">// Swap the PFN WsIndex element to point to the new slot.</span>
00704             <span class="comment">//</span>
00705 
00706             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00707 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00708 <span class="preprocessor"></span>            OldIrql = 99;
00709             <span class="keywordflow">if</span> (PFN_LOCK_OWNED_BY_ME() == 0) {
00710                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00711             }
00712 <span class="preprocessor">#endif</span>
00713 <span class="preprocessor"></span>            Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = SwapEntry;
00714 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00715 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (OldIrql != 99) {
00716                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00717             }
00718 <span class="preprocessor">#endif</span>
00719 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
00720 
00721             <span class="comment">//</span>
00722             <span class="comment">// Update hash table.</span>
00723             <span class="comment">//</span>
00724 
00725             <span class="keywordflow">if</span> (Table) {
00726                 Table[ <a class="code" href="../../d7/d0/wstree_8c.html#a4">MiLookupWsleHashIndex</a> (WsleEntry.u1.Long,
00727                                            WorkingSetList)].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o1">Index</a> = SwapEntry;
00728             }
00729         }
00730 
00731         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, SwapEntry);
00732 
00733         Wsle[Entry] = WsleSwap;
00734 
00735         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WsleSwap.u1.VirtualAddress);
00736 
00737         <span class="keywordflow">if</span> (WsleSwap.u1.e1.Direct) {
00738 
00739             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00740 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00741 <span class="preprocessor"></span>            OldIrql = 99;
00742             <span class="keywordflow">if</span> (PFN_LOCK_OWNED_BY_ME() == 0) {
00743                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00744             }
00745 <span class="preprocessor">#endif</span>
00746 <span class="preprocessor"></span>            Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = Entry;
00747 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00748 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (OldIrql != 99) {
00749                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00750             }
00751 <span class="preprocessor">#endif</span>
00752 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
00753             <span class="keywordflow">if</span> (Table) {
00754                 Table[ <a class="code" href="../../d7/d0/wstree_8c.html#a4">MiLookupWsleHashIndex</a> (WsleSwap.u1.Long,
00755                                            WorkingSetList)].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o1">Index</a> = Entry;
00756             }
00757         }
00758         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, Entry);
00759     }
00760     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentSize == WsInfo-&gt;WorkingSetSize);
00761     <span class="keywordflow">return</span>;
00762 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a2" doxytag="wstree.c::MmPagedPoolPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d0/wstree_8c.html#a2">MmPagedPoolPage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00030">30</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="wstree.c::MmSystemCachePage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d0/wstree_8c.html#a1">MmSystemCachePage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00029">29</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="wstree.c::MmSystemCodePage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d0/wstree_8c.html#a0">MmSystemCodePage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00028">28</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="wstree.c::MmSystemDriverPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d0/wstree_8c.html#a3">MmSystemDriverPage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/wstree_8c-source.html#l00031">31</a> of file <a class="el" href="../../d8/d9/wstree_8c-source.html">wstree.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
