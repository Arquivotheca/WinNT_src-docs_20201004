<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hiveload.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hiveload.c</h1><a href="../../d6/d1/hiveload_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hiveload.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements procedures to read a hive into memory, applying</span>
00012 <span class="comment">    logs, etc.</span>
00013 <span class="comment"></span>
00014 <span class="comment">    NOTE:   Alternate image loading is not supported here, that is</span>
00015 <span class="comment">            done by the boot loader.</span>
00016 <span class="comment"></span>
00017 <span class="comment">Author:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Bryan M. Willman (bryanwi) 30-Mar-92</span>
00020 <span class="comment"></span>
00021 <span class="comment">Environment:</span>
00022 <span class="comment"></span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment">    Dragos C. Sambotin (dragoss) 25-Jan-99</span>
00026 <span class="comment">        Implementation of bin-size chunk loading of hives.</span>
00027 <span class="comment">    Dragos C. Sambotin (dragoss) 10-Apr-99</span>
00028 <span class="comment">        64K IO reads when loading the hive</span>
00029 <span class="comment"></span>
00030 <span class="comment">--*/</span>
00031 
00032 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00033 
<a name="l00034"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a0">00034</a> <span class="preprocessor">#define         IO_BUFFER_SIZE  0x10000  //64K</span>
00035 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a20">00036</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20">_RESULT</a> {
00037     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>,
00038     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>,
00039     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>,
00040     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>,
00041     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>,
00042     <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>
00043 } <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>;
00044 
00045 <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>
00046 <a class="code" href="../../d6/d1/hiveload_8c.html#a14">HvpGetHiveHeader</a>(
00047     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00048     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    *BaseBlock,
00049     PLARGE_INTEGER  TimeStamp
00050     );
00051 
00052 <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>
00053 <a class="code" href="../../d6/d1/hiveload_8c.html#a15">HvpGetLogHeader</a>(
00054     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00055     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    *BaseBlock,
00056     PLARGE_INTEGER  TimeStamp
00057     );
00058 
00059 <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>
00060 <a class="code" href="../../d6/d1/hiveload_8c.html#a16">HvpRecoverData</a>(
00061     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00062     BOOLEAN         ReadOnly,
00063     PHCELL_INDEX    TailDisplay OPTIONAL
00064     );
00065 
00066 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00067 <a class="code" href="../../d6/d1/hiveload_8c.html#a17">HvpReadFileImageAndBuildMap</a>(
00068                             <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00069                             ULONG   Length,
00070                             PHCELL_INDEX TailDisplay OPTIONAL
00071                             );
00072 
00073 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00074 <a class="code" href="../../d6/d1/hiveload_8c.html#a18">HvpDelistBinFreeCells</a>(
00075     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00076     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   Bin,
00077     HSTORAGE_TYPE Type,
00078     PHCELL_INDEX TailDisplay OPTIONAL
00079     );
00080 
00081 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvLoadHive)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpGetHiveHeader)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpGetLogHeader)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpRecoverData)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpReadFileImageAndBuildMap)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>
00089 
00090 <span class="keyword">extern</span> <span class="keyword">struct </span>{
<a name="l00091"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a2">00091</a>     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
<a name="l00092"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a3">00092</a>     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
<a name="l00093"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a4">00093</a>     ULONG       <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>;
<a name="l00094"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a5">00094</a>     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a33">MapPoint</a>;
<a name="l00095"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a6">00095</a>     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a34">BinPoint</a>;
00096 } <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>;
00097 
00098 
00099 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00100"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a19">00100</a> <a class="code" href="../../d6/d1/hiveload_8c.html#a19">HvLoadHive</a>(
00101     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00102     PHCELL_INDEX TailDisplay OPTIONAL
00103     )
00104 <span class="comment">/*++</span>
00105 <span class="comment"></span>
00106 <span class="comment">Routine Description:</span>
00107 <span class="comment"></span>
00108 <span class="comment">    Hive must be fully initialized, in particular, file handles</span>
00109 <span class="comment">    must be set up.  This routine is not intended for loading hives</span>
00110 <span class="comment">    from images already in memory.</span>
00111 <span class="comment"></span>
00112 <span class="comment">    This routine will apply whatever fixes are available for errors</span>
00113 <span class="comment">    in the hive image.  In particular, if a log exists, and is applicable,</span>
00114 <span class="comment">    this routine will automatically apply it.</span>
00115 <span class="comment"></span>
00116 <span class="comment">    ALGORITHM:</span>
00117 <span class="comment"></span>
00118 <span class="comment">        call HvpGetHiveHeader()</span>
00119 <span class="comment"></span>
00120 <span class="comment">        if (NoMemory or NoHive)</span>
00121 <span class="comment">            return failure</span>
00122 <span class="comment"></span>
00123 <span class="comment">        if (RecoverData or RecoverHeader) and (no log)</span>
00124 <span class="comment">            return falure</span>
00125 <span class="comment"></span>
00126 <span class="comment">        if (RecoverHeader)</span>
00127 <span class="comment">            call HvpGetLogHeader</span>
00128 <span class="comment">            if (fail)</span>
00129 <span class="comment">                return failure</span>
00130 <span class="comment">            fix up baseblock</span>
00131 <span class="comment"></span>
00132 <span class="comment">        Read Data</span>
00133 <span class="comment"></span>
00134 <span class="comment">        if (RecoverData or RecoverHeader)</span>
00135 <span class="comment">            HvpRecoverData</span>
00136 <span class="comment">            return STATUS_REGISTRY_RECOVERED</span>
00137 <span class="comment"></span>
00138 <span class="comment">        clean up sequence numbers</span>
00139 <span class="comment"></span>
00140 <span class="comment">        return success OR STATUS_REGISTRY_RECOVERED</span>
00141 <span class="comment"></span>
00142 <span class="comment">    If STATUS_REGISTRY_RECOVERED is returned, then</span>
00143 <span class="comment"></span>
00144 <span class="comment">        If (Log) was used, DirtyVector and DirtyCount are set,</span>
00145 <span class="comment">            caller is expected to flush the changes (using a</span>
00146 <span class="comment">            NEW log file)</span>
00147 <span class="comment"></span>
00148 <span class="comment">Arguments:</span>
00149 <span class="comment"></span>
00150 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00151 <span class="comment">            hive of interest</span>
00152 <span class="comment"></span>
00153 <span class="comment">    TailDisplay - array containing the tail ends of the free cell lists - optional</span>
00154 <span class="comment"></span>
00155 <span class="comment">Return Value:</span>
00156 <span class="comment"></span>
00157 <span class="comment">    STATUS:</span>
00158 <span class="comment"></span>
00159 <span class="comment">        STATUS_INSUFFICIENT_RESOURCES   - memory alloc failure, etc</span>
00160 <span class="comment">        STATUS_NOT_REGISTRY_FILE        - bad signatures and the like</span>
00161 <span class="comment">        STATUS_REGISTRY_CORRUPT         - bad signatures in the log,</span>
00162 <span class="comment">                                          bad stuff in both in alternate,</span>
00163 <span class="comment">                                          inconsistent log</span>
00164 <span class="comment"></span>
00165 <span class="comment">        STATUS_REGISTRY_IO_FAILED       - data read failed</span>
00166 <span class="comment"></span>
00167 <span class="comment">        STATUS_RECOVERED                - successfully recovered the hive,</span>
00168 <span class="comment">                                          a semi-flush of logged data</span>
00169 <span class="comment">                                          is necessary.</span>
00170 <span class="comment"></span>
00171 <span class="comment">        STATUS_SUCCESS                  - it worked, no recovery needed</span>
00172 <span class="comment"></span>
00173 <span class="comment">--*/</span>
00174 {
00175     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00176     ULONG           result1;
00177     ULONG           result2;
00178     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
00179     LARGE_INTEGER   TimeStamp;
00180     ULONG           FileOffset;
00181     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           pbin;
00182     BOOLEAN         ReadOnlyFlagCopy;
00183 
00184     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>);
00185 
00186     BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187     result1 = <a class="code" href="../../d6/d1/hiveload_8c.html#a14">HvpGetHiveHeader</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, &amp;BaseBlock, &amp;TimeStamp);
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// bomb out for total errors</span>
00191     <span class="comment">//</span>
00192     <span class="keywordflow">if</span> (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>) {
00193         status = STATUS_INSUFFICIENT_RESOURCES;
00194         <span class="keywordflow">goto</span> Exit1;
00195     }
00196     <span class="keywordflow">if</span> (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>) {
00197         status = STATUS_NOT_REGISTRY_FILE;
00198         <span class="keywordflow">goto</span> Exit1;
00199     }
00200 
00201     
00202     ReadOnlyFlagCopy = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a>;
00203     <span class="comment">//</span>
00204     <span class="comment">// if recovery needed, and no log, bomb out</span>
00205     <span class="comment">//</span>
00206     <span class="keywordflow">if</span> ( ((result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>) ||
00207           (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>)) )
00208     {
00209         <span class="comment">//</span>
00210         <span class="comment">// recovery needed</span>
00211         <span class="comment">//</span>
00212         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00213         {
00214             <span class="comment">//</span>
00215             <span class="comment">// no log ==&gt; bomb out</span>
00216             <span class="comment">//</span>
00217             status = STATUS_REGISTRY_CORRUPT;
00218             <span class="keywordflow">goto</span> Exit1;
00219         } <span class="keywordflow">else</span> {
00220             <span class="comment">//</span>
00221             <span class="comment">// TRICK: simulate hive as read-only; Free cells will not </span>
00222             <span class="comment">// be enlisted in HvpReadFileImageAndBuildMap; Instead, they</span>
00223             <span class="comment">// will be enlisted in HvpRecoverData, when we are sure we have </span>
00224             <span class="comment">// the right info loaded up into memory</span>
00225             <span class="comment">//</span>
00226             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00227         }
00228     }
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">// need to recover header using log, so try to get it from log</span>
00232     <span class="comment">//</span>
00233     <span class="keywordflow">if</span> (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>) {
00234         result2 = <a class="code" href="../../d6/d1/hiveload_8c.html#a15">HvpGetLogHeader</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, &amp;BaseBlock, &amp;TimeStamp);
00235         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>) {
00236             status =  STATUS_INSUFFICIENT_RESOURCES;
00237             <span class="keywordflow">goto</span> Exit1;
00238         }
00239         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>) {
00240             status = STATUS_REGISTRY_CORRUPT;
00241             <span class="keywordflow">goto</span> Exit1;
00242         }
00243         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00244     }
00245     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = BaseBlock;
00246     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00247 
00248     <span class="comment">//</span>
00249     <span class="comment">// at this point, we have a sane baseblock.  we may or may not still</span>
00250     <span class="comment">// need to apply data recovery</span>
00251     <span class="comment">//</span>
00252     status = <a class="code" href="../../d6/d1/hiveload_8c.html#a17">HvpReadFileImageAndBuildMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>,TailDisplay);
00253     
00254     
00255     <span class="comment">//</span>
00256     <span class="comment">// if STATUS_REGISTRY_CORRUPT and RecoverData don't bail out, keep recovering</span>
00257     <span class="comment">//</span>
00258     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; ((status != STATUS_REGISTRY_CORRUPT) || (result1 != <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>)) ) {
00259         <span class="keywordflow">goto</span> Exit2;
00260     }
00261     
00262     <span class="comment">//</span>
00263     <span class="comment">// apply data recovery if we need it</span>
00264     <span class="comment">//</span>
00265     status = STATUS_SUCCESS;
00266     <span class="keywordflow">if</span> ( (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>) ||      <span class="comment">// -&gt; implies recover data</span>
00267          (result1 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>) )
00268     {
00269         <span class="comment">//</span>
00270         <span class="comment">// recover data will enllist the free cells as well and </span>
00271         <span class="comment">// will restore the original read-only state of the hive</span>
00272         <span class="comment">//</span>
00273         result2 = <a class="code" href="../../d6/d1/hiveload_8c.html#a16">HvpRecoverData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,ReadOnlyFlagCopy,TailDisplay);
00274         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>) {
00275             status = STATUS_INSUFFICIENT_RESOURCES;
00276             <span class="keywordflow">goto</span> Exit2;
00277         }
00278         <span class="keywordflow">if</span> (result2 == <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>) {
00279             status = STATUS_REGISTRY_CORRUPT;
00280             <span class="keywordflow">goto</span> Exit2;
00281         }
00282         status = STATUS_REGISTRY_RECOVERED;
00283     }
00284 
00285     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a> = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>;
00286     <span class="keywordflow">return</span> status;
00287 
00288 
00289 Exit2:
00290     <span class="comment">//</span>
00291     <span class="comment">// Clean up the bins already allocated </span>
00292     <span class="comment">//</span>
00293     <a class="code" href="../../d5/d1/hiveinit_8c.html#a2">HvpFreeAllocatedBins</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> );
00294 
00295     <span class="comment">//</span>
00296     <span class="comment">// Clean up the directory table</span>
00297     <span class="comment">//</span>
00298     <a class="code" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> );
00299 
00300 Exit1:
00301     <span class="keywordflow">if</span> (BaseBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00302         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(BaseBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00303     }
00304 
00305     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00306     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00307     <span class="keywordflow">return</span> status;
00308 }
00309 
00310 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00311"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a17">00311</a> <a class="code" href="../../d6/d1/hiveload_8c.html#a17">HvpReadFileImageAndBuildMap</a>(
00312                             <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00313                             ULONG   Length,
00314                             PHCELL_INDEX TailDisplay OPTIONAL
00315                             )
00316 
00317 <span class="comment">/*++</span>
00318 <span class="comment"></span>
00319 <span class="comment">Routine Description:</span>
00320 <span class="comment"></span>
00321 <span class="comment">    Read the hive from the file and allocate storage for the hive</span>
00322 <span class="comment">    image in chunks of HBINs. Build the hive map "on the fly".</span>
00323 <span class="comment">        Optimized to read chunks of 64K from the file.</span>
00324 <span class="comment"></span>
00325 <span class="comment">Arguments:</span>
00326 <span class="comment"></span>
00327 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00328 <span class="comment">            hive of interest</span>
00329 <span class="comment"></span>
00330 <span class="comment">    Length - the length of the hive, in bytes</span>
00331 <span class="comment"></span>
00332 <span class="comment">    TailDisplay - array containing the tail ends of the free cell lists - optional</span>
00333 <span class="comment"></span>
00334 <span class="comment">Return Value:</span>
00335 <span class="comment"></span>
00336 <span class="comment">    STATUS:</span>
00337 <span class="comment"></span>
00338 <span class="comment">        STATUS_INSUFFICIENT_RESOURCES   - memory alloc failure, etc</span>
00339 <span class="comment"></span>
00340 <span class="comment">        STATUS_REGISTRY_IO_FAILED       - data read failed</span>
00341 <span class="comment"></span>
00342 <span class="comment">        STATUS_REGISTRY_CORRUPT         - base block is corrupt</span>
00343 <span class="comment"></span>
00344 <span class="comment">        STATUS_SUCCESS                  - it worked</span>
00345 <span class="comment"></span>
00346 <span class="comment">--*/</span>
00347 {
00348     ULONG           FileOffset;
00349     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00350     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;                        <span class="comment">// current bin</span>
00351     ULONG           BinSize;            <span class="comment">// size of the current bin</span>
00352     ULONG           BinOffset;          <span class="comment">// current offset inside current bin</span>
00353     ULONG           BinFileOffset;  <span class="comment">// physical offset of the bin in the file (used for consistency checking)</span>
00354     ULONG           BinDataInBuffer;<span class="comment">// the amount of data needed to be copied in the current bin available in the buffer</span>
00355     ULONG           BinDataNeeded;  <span class="comment">// </span>
00356     PUCHAR                      IOBuffer;
00357     ULONG           IOBufferSize;       <span class="comment">// valid data in IOBuffer (only at the end of the file this is different than IO_BUFFER_SIZE)</span>
00358     ULONG           IOBufferOffset;     <span class="comment">// current offset inside IOBuffer</span>
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Init the map</span>
00362     <span class="comment">//</span>
00363     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a7">HvpInitMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00364 
00365     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00366         <span class="comment">//</span>
00367         <span class="comment">// return failure </span>
00368         <span class="comment">//</span>
00369         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00370     }
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Allocate a IO_BUFFER_SIZE for I/O operations from paged pool. </span>
00374         <span class="comment">// It will be freed at the end of the function.</span>
00375     <span class="comment">//</span>
00376     IOBuffer = (PUCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d6/d1/hiveload_8c.html#a0">IO_BUFFER_SIZE</a>);
00377     <span class="keywordflow">if</span> (IOBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00378         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00379         <a class="code" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> );
00380         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00381     }
00382 
00383     <span class="comment">//</span>
00384     <span class="comment">// Start right after the hive header</span>
00385     <span class="comment">//</span>
00386     FileOffset = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00387     BinFileOffset = FileOffset;
00388     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00389 
00390     <span class="comment">//</span>
00391         <span class="comment">// outer loop : reads IO_BUFFER_SIZE chunks from the file</span>
00392         <span class="comment">//</span>
00393         <span class="keywordflow">while</span>( FileOffset &lt; (Length + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) ) {
00394                 <span class="comment">//</span>
00395                 <span class="comment">// we are at the begining of the IO buffer</span>
00396         <span class="comment">//</span>
00397         IOBufferOffset = 0;
00398 
00399         <span class="comment">//</span>
00400         <span class="comment">// the buffer size will be either IO_BufferSize, or the amount </span>
00401         <span class="comment">// uread from the file (when this is smaller than IO_BUFFER_SIZE)</span>
00402         <span class="comment">//</span>
00403         IOBufferSize = Length + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a> - FileOffset;
00404         IOBufferSize = ( IOBufferSize &gt; <a class="code" href="../../d6/d1/hiveload_8c.html#a0">IO_BUFFER_SIZE</a> ) ? <a class="code" href="../../d6/d1/hiveload_8c.html#a0">IO_BUFFER_SIZE</a> : IOBufferSize;
00405         
00406         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (IOBufferSize % <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) == 0 );
00407         
00408         <span class="comment">//</span>
00409         <span class="comment">// read data from the file</span>
00410         <span class="comment">//</span>
00411         <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
00412                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00413                         <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00414                         &amp;FileOffset,
00415                         (PVOID)IOBuffer,
00416                         IOBufferSize
00417                         )
00418            )
00419         {
00420             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_IO_FAILED;
00421             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00422         }
00423         
00424         <span class="comment">//</span>
00425         <span class="comment">// inner loop: breaks the buffer into bins</span>
00426         <span class="comment">//</span>
00427         <span class="keywordflow">while</span>( IOBufferOffset &lt; IOBufferSize ) {
00428 
00429             <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00430                 <span class="comment">//</span>
00431                 <span class="comment">// this is the beginning of a new bin</span>
00432                 <span class="comment">// perform bin validation and allocate the bin</span>
00433                 <span class="comment">//</span>
00434                 <span class="comment">// temporary bin points to the current location inside the buffer</span>
00435                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(IOBuffer + IOBufferOffset);
00436                 <span class="comment">//</span>
00437                 <span class="comment">// Check the validity of the bin header</span>
00438                 <span class="comment">//</span>
00439                 BinSize = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00440                 <span class="keywordflow">if</span> ( (BinSize &gt; Length)                         ||
00441                      (BinSize &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)                    ||
00442                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)         ||
00443                      (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != (BinFileOffset - <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) )) {
00444                     <span class="comment">//</span>
00445                     <span class="comment">// Bin is bogus</span>
00446                     <span class="comment">//</span>
00447                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00448                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00449                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00450                         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00451                     }
00452                     <span class="comment">//</span>
00453                     <span class="comment">// copy the data already read in the first HBLOCK of the bin</span>
00454                     <span class="comment">//</span>
00455                     RtlCopyMemory(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>,(IOBuffer + IOBufferOffset), <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
00456                     
00457                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00458                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00459                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA001;
00460                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = Length;
00461                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = BinFileOffset;
00462                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00463             
00464                     <span class="comment">//goto ErrorExit;</span>
00465                     <span class="comment">//</span>
00466                     <span class="comment">// DO NOT EXIT; Fix this bin header and go on. RecoverData should fix it.</span>
00467                     <span class="comment">// If not, CmCheckRegistry called later will prevent loading of an invalid hive</span>
00468                     <span class="comment">//</span>
00469                     <span class="comment">// NOTE: Still, mess the signature, to make sure that if this particular bin doesn't get recovered, </span>
00470                     <span class="comment">//       we'll fail the hive loading request.</span>
00471                     <span class="comment">//</span>
00472                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> = 0; <span class="comment">//TRICK!!!!</span>
00473                     BinSize = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00474                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> = BinFileOffset - <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00475 
00476                     <span class="comment">//</span>
00477                     <span class="comment">// simulate as the entire bin is a used cell</span>
00478                     <span class="comment">//</span>
00479                     ((<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)))-&gt;Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>) - BinSize; <span class="comment">//TRICK!!!!</span>
00480                     <span class="comment">//</span>
00481                     <span class="comment">// Now that we have the entire bin in memory, Enlist It!</span>
00482                     <span class="comment">//</span>
00483                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Length, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, BinFileOffset - <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>, TailDisplay);
00484 
00485                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00486                         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00487                     }
00488                     
00489                     <span class="comment">//</span>
00490                     <span class="comment">// Adjust the offsets</span>
00491                     <span class="comment">//</span>
00492                     BinFileOffset += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00493                     IOBufferOffset += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00494                     
00495                     <span class="comment">//</span>
00496                     <span class="comment">// another bin is on his way </span>
00497                     <span class="comment">//</span>
00498                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00499                 } <span class="keywordflow">else</span> {
00500                     <span class="comment">//</span>
00501                     <span class="comment">// bin is valid; allocate a pool chunk of the right size</span>
00502                     <span class="comment">//</span>
00503                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(BinSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00504                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00505                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00506                         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00507                     }
00508             
00509                     <span class="comment">//</span>
00510                     <span class="comment">// the chunk is allocated; set the offset inside the bin and continue</span>
00511                     <span class="comment">// the next iteration of the inner loop will start by copying data in this bin</span>
00512                     <span class="comment">//</span>
00513                     BinOffset = 0;
00514                 }
00515             } <span class="keywordflow">else</span> {
00516                 <span class="comment">//</span>
00517                 <span class="comment">// if we are here, the bin is allocated, the BinSize and BinOffset are set</span>
00518                 <span class="comment">// We have to calculate how much for this bin is available in the buffer,</span>
00519                 <span class="comment">// and copy it. If we finished with this bin, enlist it and mark the begining of a new one</span>
00520                 <span class="comment">//</span>
00521                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00522                 BinDataInBuffer = (IOBufferSize - IOBufferOffset);
00523                 BinDataNeeded = (BinSize - BinOffset);
00524                 
00525                 <span class="keywordflow">if</span>( BinDataInBuffer &gt;= BinDataNeeded ) {
00526                     <span class="comment">//</span>
00527                     <span class="comment">// we have available more than what we need; Finish the bin</span>
00528                     <span class="comment">//</span>
00529                     RtlCopyMemory(((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + BinOffset),(IOBuffer + IOBufferOffset), BinDataNeeded);
00530                     <span class="comment">//</span>
00531                     <span class="comment">// enlist it</span>
00532                     <span class="comment">//</span>
00533                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Length, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, BinFileOffset - <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>, TailDisplay);
00534 
00535                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00536                         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00537                     }
00538                     <span class="comment">//</span>
00539                     <span class="comment">// Adjust the offsets</span>
00540                     <span class="comment">//</span>
00541                     BinFileOffset += BinSize;
00542                     IOBufferOffset += BinDataNeeded;
00543                     <span class="comment">//</span>
00544                     <span class="comment">// mark the begining of a new bin</span>
00545                     <span class="comment">//</span>
00546                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00547                 } <span class="keywordflow">else</span> {
00548                     <span class="comment">//</span>
00549                     <span class="comment">// we do not have all bin data in the buffer</span>
00550                     <span class="comment">// copy what we can </span>
00551                     <span class="comment">//</span>
00552                     RtlCopyMemory(((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + BinOffset),(IOBuffer + IOBufferOffset), BinDataInBuffer);
00553                     
00554                     <span class="comment">//</span>
00555                     <span class="comment">// adjust the offsets; this should be the last iteration of the inner loop</span>
00556                     <span class="comment">//</span>
00557                     BinOffset += BinDataInBuffer;
00558                     IOBufferOffset += BinDataInBuffer;
00559 
00560                     <span class="comment">// </span>
00561                     <span class="comment">// if we are here, the buffer must have beed exausted  </span>
00562                     <span class="comment">//</span>
00563                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IOBufferOffset == IOBufferSize );
00564                 }
00565             }
00566         }
00567         }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// if we got here, we shouldn't have a bin under construction</span>
00571     <span class="comment">//</span>
00572     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00573 
00574         <span class="comment">//</span>
00575         <span class="comment">// Free the buffer used for I/O operations</span>
00576         <span class="comment">//</span>
00577         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IOBuffer);
00578 
00579     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00580 
00581 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00582     <span class="comment">//</span>
00583     <span class="comment">// Free the buffer used for I/O operations</span>
00584     <span class="comment">//</span>
00585     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IOBuffer);
00586 
00587     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00588 }
00589 
00590 
00591 <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>
<a name="l00592"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a14">00592</a> <a class="code" href="../../d6/d1/hiveload_8c.html#a14">HvpGetHiveHeader</a>(
00593     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00594     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    *BaseBlock,
00595     PLARGE_INTEGER  TimeStamp
00596     )
00597 <span class="comment">/*++</span>
00598 <span class="comment"></span>
00599 <span class="comment">Routine Description:</span>
00600 <span class="comment"></span>
00601 <span class="comment">    Examine the base block sector and possibly the first sector of</span>
00602 <span class="comment">    the first bin, and decide what (if any) recovery needs to be applied</span>
00603 <span class="comment">    based on what we find there.</span>
00604 <span class="comment"></span>
00605 <span class="comment">    ALGORITHM:</span>
00606 <span class="comment"></span>
00607 <span class="comment">        read BaseBlock from offset 0</span>
00608 <span class="comment">        if ( (I/O error)    OR</span>
00609 <span class="comment">             (checksum wrong) )</span>
00610 <span class="comment">        {</span>
00611 <span class="comment">            read bin block from offset HBLOCK_SIZE (4k)</span>
00612 <span class="comment">            if (2nd I/O error)</span>
00613 <span class="comment">                return NotHive</span>
00614 <span class="comment">            }</span>
00615 <span class="comment">            check bin sign., offset.</span>
00616 <span class="comment">            if (OK)</span>
00617 <span class="comment">                return RecoverHeader, TimeStamp=from Link field</span>
00618 <span class="comment">            } else {</span>
00619 <span class="comment">                return NotHive</span>
00620 <span class="comment">            }</span>
00621 <span class="comment">        }</span>
00622 <span class="comment"></span>
00623 <span class="comment">        if (wrong type or signature or version or format)</span>
00624 <span class="comment">            return NotHive</span>
00625 <span class="comment">        }</span>
00626 <span class="comment"></span>
00627 <span class="comment">        if (seq1 != seq2) {</span>
00628 <span class="comment">            return RecoverData, TimeStamp=BaseBlock-&gt;TimeStamp, valid BaseBlock</span>
00629 <span class="comment">        }</span>
00630 <span class="comment"></span>
00631 <span class="comment">        return ReadData, valid BaseBlock</span>
00632 <span class="comment"></span>
00633 <span class="comment">Arguments:</span>
00634 <span class="comment"></span>
00635 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00636 <span class="comment">            hive of interest</span>
00637 <span class="comment"></span>
00638 <span class="comment">    FileType - HFILE_TYPE_PRIMARY or HFILE_TYPE_ALTERNATE - which copy</span>
00639 <span class="comment">            of the hive to read from.</span>
00640 <span class="comment"></span>
00641 <span class="comment">    BaseBlock - supplies pointer to variable to receive pointer to</span>
00642 <span class="comment">            HBASE_BLOCK, if we can successfully read one.</span>
00643 <span class="comment"></span>
00644 <span class="comment">    TimeStamp - pointer to variable to receive time stamp (serial number)</span>
00645 <span class="comment">            of hive, be it from the baseblock or from the Link field</span>
00646 <span class="comment">            of the first bin.</span>
00647 <span class="comment"></span>
00648 <span class="comment">Return Value:</span>
00649 <span class="comment"></span>
00650 <span class="comment">    RESULT code</span>
00651 <span class="comment"></span>
00652 <span class="comment">--*/</span>
00653 {
00654     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    buffer;
00655     BOOLEAN         rc;
00656     ULONG           FileOffset;
00657     ULONG           Alignment;
00658 
00659     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>) &gt;= (<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>));
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">// allocate buffer to hold base block</span>
00663     <span class="comment">//</span>
00664     *BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00665     buffer = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00666     <span class="keywordflow">if</span> (buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00667         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>;
00668     }
00669     <span class="comment">//</span>
00670     <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
00671     <span class="comment">// harder to get an aligned buffer.</span>
00672     <span class="comment">//</span>
00673     Alignment = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> - 1;
00674     <span class="keywordflow">if</span> (((ULONG_PTR)buffer &amp; Alignment) != 0) {
00675         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00676         buffer = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00677         <span class="keywordflow">if</span> (buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00678             <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>;
00679         }
00680     }
00681     RtlZeroMemory((PVOID)buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00682 
00683     <span class="comment">//</span>
00684     <span class="comment">// attempt to read base block</span>
00685     <span class="comment">//</span>
00686     FileOffset = 0;
00687     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00688                           <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00689                           &amp;FileOffset,
00690                           (PVOID)buffer,
00691                           <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>);
00692 
00693     <span class="keywordflow">if</span> ( (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)  ||
00694          (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(buffer) != buffer-&gt;CheckSum)) {
00695         <span class="comment">//</span>
00696         <span class="comment">// base block is toast, try the first block in the first bin</span>
00697         <span class="comment">//</span>
00698         FileOffset = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00699         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00700                               <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00701                               &amp;FileOffset,
00702                               (PVOID)buffer,
00703                               <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>);
00704 
00705         <span class="keywordflow">if</span> ( (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00706              ( ((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)buffer)-&gt;Signature != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)           ||
00707              ( ((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)buffer)-&gt;FileOffset != 0)
00708            )
00709         {
00710             <span class="comment">//</span>
00711             <span class="comment">// the bin is toast too, punt</span>
00712             <span class="comment">//</span>
00713             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00714             <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>;
00715         }
00716 
00717         <span class="comment">//</span>
00718         <span class="comment">// base block is bogus, but bin is OK, so tell caller</span>
00719         <span class="comment">// to look for a log file and apply recovery</span>
00720         <span class="comment">//</span>
00721         *TimeStamp = ((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)buffer)-&gt;TimeStamp;
00722         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00723         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a12">RecoverHeader</a>;
00724     }
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// base block read OK, but is it valid?</span>
00728     <span class="comment">//</span>
00729     <span class="keywordflow">if</span> ( (buffer-&gt;Signature != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)   ||
00730          (buffer-&gt;Type != <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>)           ||
00731          (buffer-&gt;Major != <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>)                  ||
00732          (buffer-&gt;Minor &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>)                   ||
00733          ((buffer-&gt;Major == 1) &amp;&amp; (buffer-&gt;Minor == 0)) ||
00734          (buffer-&gt;Format != <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>)
00735        )
00736     {
00737         <span class="comment">//</span>
00738         <span class="comment">// file is simply not a valid hive</span>
00739         <span class="comment">//</span>
00740         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00741         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a8">NotHive</a>;
00742     }
00743 
00744     <span class="comment">//</span>
00745     <span class="comment">// see if recovery is necessary</span>
00746     <span class="comment">//</span>
00747     *BaseBlock = buffer;
00748     *TimeStamp = buffer-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>;
00749     <span class="keywordflow">if</span> ( (buffer-&gt;Sequence1 != buffer-&gt;Sequence2) ) {
00750         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a13">RecoverData</a>;
00751     }
00752 
00753     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>;
00754 }
00755 
00756 
00757 <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>
<a name="l00758"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a15">00758</a> <a class="code" href="../../d6/d1/hiveload_8c.html#a15">HvpGetLogHeader</a>(
00759     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00760     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    *BaseBlock,
00761     PLARGE_INTEGER  TimeStamp
00762     )
00763 <span class="comment">/*++</span>
00764 <span class="comment"></span>
00765 <span class="comment">Routine Description:</span>
00766 <span class="comment"></span>
00767 <span class="comment">    Read and validate log file header.  Return it if it's valid.</span>
00768 <span class="comment"></span>
00769 <span class="comment">    ALGORITHM:</span>
00770 <span class="comment"></span>
00771 <span class="comment">        read header</span>
00772 <span class="comment">        if ( (I/O error) or</span>
00773 <span class="comment">           (wrong signature,</span>
00774 <span class="comment">            wrong type,</span>
00775 <span class="comment">            seq mismatch</span>
00776 <span class="comment">            wrong checksum,</span>
00777 <span class="comment">            wrong timestamp</span>
00778 <span class="comment">           )</span>
00779 <span class="comment">            return Fail</span>
00780 <span class="comment">        }</span>
00781 <span class="comment">        return baseblock, OK</span>
00782 <span class="comment"></span>
00783 <span class="comment">Arguments:</span>
00784 <span class="comment"></span>
00785 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00786 <span class="comment">            hive of interest</span>
00787 <span class="comment"></span>
00788 <span class="comment">    BaseBlock - supplies pointer to variable to receive pointer to</span>
00789 <span class="comment">            HBASE_BLOCK, if we can successfully read one.</span>
00790 <span class="comment"></span>
00791 <span class="comment">    TimeStamp - pointer to variable holding TimeStamp, which must</span>
00792 <span class="comment">            match the one in the log file.</span>
00793 <span class="comment"></span>
00794 <span class="comment">Return Value:</span>
00795 <span class="comment"></span>
00796 <span class="comment">    RESULT</span>
00797 <span class="comment"></span>
00798 <span class="comment">--*/</span>
00799 {
00800     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    buffer;
00801     BOOLEAN         rc;
00802     ULONG           FileOffset;
00803 
00804     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>) == <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
00805     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>) &gt;= (<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>));
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// allocate buffer to hold base block</span>
00809     <span class="comment">//</span>
00810     *BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00811     buffer = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00812     <span class="keywordflow">if</span> (buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00813         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>;
00814     }
00815     RtlZeroMemory((PVOID)buffer, <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// attempt to read base block</span>
00819     <span class="comment">//</span>
00820     FileOffset = 0;
00821     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00822                           <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
00823                           &amp;FileOffset,
00824                           (PVOID)buffer,
00825                           <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> * <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>);
00826 
00827     <span class="keywordflow">if</span> ( (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)                                              ||
00828          (buffer-&gt;Signature != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)               ||
00829          (buffer-&gt;Type != <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)                           ||
00830          (buffer-&gt;Sequence1 != buffer-&gt;Sequence2)                   ||
00831          (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(buffer) != buffer-&gt;CheckSum)            ||
00832          (TimeStamp-&gt;LowPart != buffer-&gt;TimeStamp.LowPart)          ||
00833          (TimeStamp-&gt;HighPart != buffer-&gt;TimeStamp.HighPart)) {
00834         <span class="comment">//</span>
00835         <span class="comment">// Log is unreadable, invalid, or doesn't apply the right hive</span>
00836         <span class="comment">//</span>
00837         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(buffer, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a55">HBASE_BLOCK</a>));
00838         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
00839     }
00840 
00841     *BaseBlock = buffer;
00842     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>;
00843 }
00844 
00845 
00846 <a class="code" href="../../d6/d1/hiveload_8c.html#a1">RESULT</a>
<a name="l00847"></a><a class="code" href="../../d6/d1/hiveload_8c.html#a16">00847</a> <a class="code" href="../../d6/d1/hiveload_8c.html#a16">HvpRecoverData</a>(
00848     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00849     BOOLEAN         ReadOnly,
00850     PHCELL_INDEX    TailDisplay OPTIONAL
00851     )
00852 <span class="comment">/*++</span>
00853 <span class="comment"></span>
00854 <span class="comment">Routine Description:</span>
00855 <span class="comment"></span>
00856 <span class="comment">    Apply the corrections in the log file to the hive memory image.</span>
00857 <span class="comment"></span>
00858 <span class="comment">    ALGORITHM:</span>
00859 <span class="comment"></span>
00860 <span class="comment">        compute size of dirty vector</span>
00861 <span class="comment">        read in dirty vector</span>
00862 <span class="comment">        if (i/o error)</span>
00863 <span class="comment">            return Fail</span>
00864 <span class="comment"></span>
00865 <span class="comment">        skip first cluster of data (already processed as log)</span>
00866 <span class="comment">        sweep vector, looking for runs of bits</span>
00867 <span class="comment">            address of first bit is used to compute memory offset</span>
00868 <span class="comment">            length of run is length of block to read</span>
00869 <span class="comment">            assert always a cluster multiple</span>
00870 <span class="comment">            file offset kept by running counter</span>
00871 <span class="comment">            read</span>
00872 <span class="comment">            if (i/o error)</span>
00873 <span class="comment">                return fail</span>
00874 <span class="comment"></span>
00875 <span class="comment">        return success</span>
00876 <span class="comment"></span>
00877 <span class="comment">    NOTE:   It is assumed that the data part of the Hive has been</span>
00878 <span class="comment">            read into a single contiguous block, at Image.</span>
00879 <span class="comment"></span>
00880 <span class="comment">Arguments:</span>
00881 <span class="comment"></span>
00882 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
00883 <span class="comment">            hive of interest</span>
00884 <span class="comment"></span>
00885 <span class="comment">    ReadOnly - by the time this function is called, the hive is forced to the</span>
00886 <span class="comment">            ready-only state. At the end, if recovery goes OK, we restore the </span>
00887 <span class="comment">            hive at it's original state, and enlist all free cells.</span>
00888 <span class="comment"></span>
00889 <span class="comment">    TailDisplay - array containing the tail ends of the free cell lists - optional</span>
00890 <span class="comment"></span>
00891 <span class="comment">Return Value:</span>
00892 <span class="comment"></span>
00893 <span class="comment">    RESULT</span>
00894 <span class="comment"></span>
00895 <span class="comment">--*/</span>
00896 {
00897     ULONG       Cluster;
00898     ULONG       ClusterSize;
00899     ULONG       VectorSize;
00900     PULONG      Vector;
00901     ULONG       FileOffset;
00902     BOOLEAN     rc;
00903     ULONG       Current;
00904     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00905     ULONG       <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00906     ULONG       Address;
00907     PUCHAR      MemoryBlock;
00908     RTL_BITMAP  <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00909     ULONG       Length;
00910     ULONG       DirtyVectorSignature = 0;
00911     ULONG       i;
00912     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
00913     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00914     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       NewBin;
00915     PUCHAR      SectorImage;
00916     PUCHAR      Source;
00917     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       SourceBin;
00918     ULONG       SectorOffsetInBin;
00919     ULONG       SectorOffsetInBlock;
00920     ULONG       BlockOffsetInBin;
00921     ULONG       NumberOfSectors;
00922 
00923     <span class="comment">//</span>
00924     <span class="comment">// compute size of dirty vector, read and check signature, read vector</span>
00925     <span class="comment">//</span>
00926     Cluster = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a>;
00927     ClusterSize = Cluster * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00928     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00929     VectorSize = (Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) / 8;       <span class="comment">// VectorSize == Bytes</span>
00930     FileOffset = ClusterSize;
00931 
00932     <span class="comment">//</span>
00933     <span class="comment">// get and check signature</span>
00934     <span class="comment">//</span>
00935     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
00936             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00937             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
00938             &amp;FileOffset,
00939             (PVOID)&amp;DirtyVectorSignature,
00940             <span class="keyword">sizeof</span>(DirtyVectorSignature)
00941             );
00942     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00943         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
00944     }
00945 
00946     <span class="keywordflow">if</span> (DirtyVectorSignature != <a class="code" href="../../d0/d1/hivedata_8h.html#a32">HLOG_DV_SIGNATURE</a>) {
00947         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
00948     }
00949 
00950     <span class="comment">//</span>
00951     <span class="comment">// get the actual vector</span>
00952     <span class="comment">//</span>
00953     Vector = (PULONG)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(VectorSize,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00954     <span class="keywordflow">if</span> (Vector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00955         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a10">NoMemory</a>;
00956     }
00957     rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
00958             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00959             <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
00960             &amp;FileOffset,            <span class="comment">// dirty vector right after header</span>
00961             (PVOID)Vector,
00962             VectorSize
00963             );
00964     <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00965         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(Vector, VectorSize);
00966         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
00967     }
00968     FileOffset = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(FileOffset, ClusterSize);
00969 
00970 
00971     <span class="comment">//</span>
00972     <span class="comment">// step through the diry map, reading in the corresponding file bytes</span>
00973     <span class="comment">//</span>
00974     Current = 0;
00975     VectorSize = VectorSize * 8;        <span class="comment">// VectorSize == bits</span>
00976 
00977     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, Vector, VectorSize);
00978 
00979     <span class="keywordflow">while</span> (Current &lt; VectorSize) {
00980 
00981         <span class="comment">//</span>
00982         <span class="comment">// find next contiguous block of entries to read in</span>
00983         <span class="comment">//</span>
00984         <span class="keywordflow">for</span> (i = Current; i &lt; VectorSize; i++) {
00985             <span class="keywordflow">if</span> (RtlCheckBit(&amp;<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, i) == 1) {
00986                 <span class="keywordflow">break</span>;
00987             }
00988         }
00989         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = i;
00990 
00991         <span class="keywordflow">for</span> ( ; i &lt; VectorSize; i++) {
00992             <span class="keywordflow">if</span> (RtlCheckBit(&amp;<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, i) == 0) {
00993                 <span class="keywordflow">break</span>;
00994             }
00995         }
00996         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = i;
00997         Current = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00998 
00999         <span class="comment">//</span>
01000         <span class="comment">// Start == number of 1st sector, End == number of Last sector + 1</span>
01001         <span class="comment">//</span>
01002         Length = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01003 
01004         <span class="keywordflow">if</span>( 0 == Length ) {
01005             <span class="comment">// no more dirty blocks.</span>
01006             <span class="keywordflow">break</span>;
01007         }
01008         <span class="comment">//</span>
01009         <span class="comment">// allocate a buffer to read the whole run from the file; This is a temporary</span>
01010         <span class="comment">// block that'll be freed immediately, so don't charge quota for it.</span>
01011         <span class="comment">//</span>
01012         MemoryBlock = (PUCHAR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, Length, CM_POOL_TAG);
01013         <span class="keywordflow">if</span>( MemoryBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {        
01014             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01015         }
01016 
01017         rc = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a>)(
01018                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01019                 <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>,
01020                 &amp;FileOffset,
01021                 (PVOID)MemoryBlock,
01022                 Length
01023                 );
01024 
01025         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((FileOffset % ClusterSize) == 0);
01026         <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01027             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(MemoryBlock);
01028             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01029         }
01030         
01031         Source = MemoryBlock;
01032         <span class="comment">//</span>
01033         <span class="comment">// copy recovered data in the right locations inside the in-memory bins</span>
01034         <span class="comment">//</span>
01035         <span class="keywordflow">while</span>( <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> ) {
01036             Address = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01037         
01038             Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Address);
01039             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Address);
01040     
01041             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01042             <span class="comment">//</span>
01043             <span class="comment">// compute the memory address where data should be copied</span>
01044             <span class="comment">//</span>
01045             SectorOffsetInBin = Address - <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>;
01046             
01047             <span class="keywordflow">if</span>( ( SectorOffsetInBin == 0 ) &amp;&amp; ( ((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Source)-&gt;Size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> ) ){
01048                 <span class="comment">//</span>
01049                 <span class="comment">// Bin in the log file is bigger than the one in memory;</span>
01050                 <span class="comment">// two or more bins must have been coalesced</span>
01051                 <span class="comment">//</span>
01052                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a> );
01053                 
01054                 SourceBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Source;
01055 
01056                 <span class="comment">//</span>
01057                 <span class="comment">// new bin must have the right offset</span>
01058                 <span class="comment">//</span>
01059                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Address == SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> );
01060                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a> );
01061                 <span class="comment">//</span>
01062                 <span class="comment">// entire bin should be dirty</span>
01063                 <span class="comment">//</span>
01064                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> );
01065 
01066                 <span class="comment">//</span>
01067                 <span class="comment">// Allocate the right size for the new bin</span>
01068                 <span class="comment">//</span>
01069                 NewBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01070                 <span class="keywordflow">if</span> (NewBin == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01071                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01072                 }
01073                 
01074                 <span class="comment">//</span>
01075                 <span class="comment">// Copy the old data into the new bin and free old bins</span>
01076                 <span class="comment">//</span>
01077                 <span class="keywordflow">while</span>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> &lt; (Address + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
01078                     
01079                     RtlCopyMemory((PUCHAR)NewBin + (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> - Address),<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01080 
01081                     <span class="comment">//</span>
01082                     <span class="comment">// Do not delist as we didn't enlisted  (when hive needs recovery)</span>
01083                     <span class="comment">//</span>
01084                     <span class="comment">//HvpDelistBinFreeCells(Hive,Bin,Stable,TailDisplay);</span>
01085 
01086                     <span class="comment">//</span>
01087                     <span class="comment">// Advance to the new bin</span>
01088                     <span class="comment">//</span>
01089                     <span class="keywordflow">if</span>( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> ) {
01090                         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01091                         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01092 
01093                         <span class="comment">//</span>
01094                         <span class="comment">// Free the old bin</span>
01095                         <span class="comment">//</span>
01096                         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01097             
01098                         <span class="comment">//</span>
01099                         <span class="comment">// the new address must be the begining of a new allocation</span>
01100                         <span class="comment">//</span>
01101                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a> );
01102                     
01103                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01104                     } <span class="keywordflow">else</span> {
01105                         <span class="comment">//</span>
01106                         <span class="comment">// we are at the end of the hive here; just break out of the loop</span>
01107                         <span class="comment">//</span>
01108                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (Address + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) == <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> );
01109                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) == <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> );
01110                         
01111                         <span class="comment">//</span>
01112                         <span class="comment">// Free the old bin</span>
01113                         <span class="comment">//</span>
01114                         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01115                         
01116                         <span class="comment">//</span>
01117                         <span class="comment">// debug purposes only</span>
01118                         <span class="comment">//</span>
01119                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01120 
01121                         <span class="comment">// bail out of while loop</span>
01122                         <span class="keywordflow">break</span>;
01123                     }
01124     
01125                 }
01126 
01127 <span class="preprocessor">#if DBG</span>
01128 <span class="preprocessor"></span>                <span class="comment">//</span>
01129                 <span class="comment">// validation: bin size increase must come from coalescing of former bins</span>
01130                 <span class="comment">// (i.e. bins are never split!!!)</span>
01131                 <span class="comment">//</span>
01132                 <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01133                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> == (Address + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
01134                 } 
01135 <span class="preprocessor">#endif</span>
01136 <span class="preprocessor"></span>
01137                 <span class="comment">//</span>
01138                 <span class="comment">// Now overwrite the modified data !</span>
01139                 <span class="comment">//</span>
01140                 
01141                 <span class="keywordflow">while</span>( (Address &lt; (SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) &amp;&amp; (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) ) {
01142                     RtlCopyMemory((PUCHAR)NewBin + (Address - SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>),Source, <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
01143                     
01144                     <span class="comment">// </span>
01145                     <span class="comment">// skip to the next sector</span>
01146                     <span class="comment">//</span>
01147                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>++;
01148                     Source += <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01149                     Address += <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01150                 }
01151 
01152                 <span class="comment">//</span>
01153                 <span class="comment">// first sector of the new bin is always restaured from the log file!</span>
01154                 <span class="comment">//</span>
01155                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> == SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>);
01156                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> == SourceBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
01157 
01158             } <span class="keywordflow">else</span> {
01159                 <span class="comment">//</span>
01160                 <span class="comment">// Normal case: sector recovery somewhere in the middle of the bin</span>
01161                 <span class="comment">//</span>
01162 
01163                 
01164                 <span class="comment">//</span>
01165                 <span class="comment">// Do not delist as we didn't enlisted  (when hive needs recovery)</span>
01166                 <span class="comment">//</span>
01167                 <span class="comment">//HvpDelistBinFreeCells(Hive,Bin,Stable,TailDisplay);</span>
01168                 
01169                 <span class="comment">//</span>
01170                 <span class="comment">// Offset should fall within bin memory layout</span>
01171                 <span class="comment">//</span>
01172                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SectorOffsetInBin &lt; Bin-&gt;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
01173             
01174                 BlockOffsetInBin = (ULONG)((PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> - (PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
01175                 SectorOffsetInBlock = SectorOffsetInBin - BlockOffsetInBin;
01176             
01177                 <span class="comment">//</span>
01178                 <span class="comment">// sanity check; address should  be the same relative to eigther begining of the bin or begining of the block</span>
01179                 <span class="comment">//</span>
01180                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> + SectorOffsetInBlock) == ((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + SectorOffsetInBin));
01181 
01182                 SectorImage = (PUCHAR)((PUCHAR)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> + SectorOffsetInBlock);
01183 
01184                 <span class="comment">//</span>
01185                 <span class="comment">// both source and destination should be valid at this point</span>
01186                 <span class="comment">//</span>
01187                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SectorImage &lt; ((PUCHAR)Bin + Bin-&gt;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) );
01188                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Source &lt; (MemoryBlock + Length) );
01189 
01190                 NumberOfSectors = 0;
01191                 <span class="keywordflow">while</span>( ( (SectorImage + (NumberOfSectors * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>)) &lt; (PUCHAR)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) &amp;&amp;
01192                         ( (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> + NumberOfSectors ) &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> )    ) {
01193                     <span class="comment">//</span>
01194                     <span class="comment">// we are still inside the same bin;</span>
01195                     <span class="comment">// deal with all sectors inside the same bin at once</span>
01196                     <span class="comment">//</span>
01197                     NumberOfSectors++;
01198                 }
01199 
01200                 <span class="comment">//</span>
01201                 <span class="comment">// finally, copy the memory</span>
01202                 <span class="comment">//</span>
01203                 RtlCopyMemory(SectorImage,Source, NumberOfSectors * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
01204 
01205                 NewBin = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01206 
01207                 <span class="comment">//</span>
01208                 <span class="comment">// skip to the next sector</span>
01209                 <span class="comment">//</span>
01210                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> += NumberOfSectors;
01211                 Source += NumberOfSectors * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
01212 
01213             }
01214 
01215             <span class="comment">//</span>
01216             <span class="comment">// rebuild the map anyway</span>
01217             <span class="comment">//</span>
01218             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Length, NewBin, NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>, TailDisplay)) ) {
01219                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01220             }
01221         }
01222     
01223         <span class="comment">//</span>
01224         <span class="comment">// get rid of the temporary pool</span>
01225         <span class="comment">//</span>
01226         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(MemoryBlock);
01227     }
01228 
01229     <span class="comment">//</span>
01230     <span class="comment">// now, after we have successfully recovered, enlist all free cells</span>
01231     <span class="comment">// and restore the hive to it's original state</span>
01232     <span class="comment">//</span>
01233     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = ReadOnly;
01234 
01235     <span class="keywordflow">if</span>( ReadOnly == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
01236         <span class="comment">//</span>
01237         <span class="comment">// no point going through this loop if the hive is read-only</span>
01238         <span class="comment">//</span>
01239         Address = 0;
01240         <span class="keywordflow">while</span>( Address &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> ) {
01241             Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Address);
01242             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Address);
01243             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01244 
01245             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> == Address );
01246             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a> );
01247 
01248             <span class="comment">//</span>
01249             <span class="comment">// add free cells in the bin to the appropriate free lists</span>
01250             <span class="comment">//</span>
01251             <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, Address,TailDisplay)) {
01252                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01253                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA004;
01254                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
01255                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = Address;
01256                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01257                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01258             }
01259         
01260             Address += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
01261         }
01262     }
01263 
01264     <span class="comment">//</span>
01265     <span class="comment">// put correct dirty vector in Hive so that recovered data</span>
01266     <span class="comment">// can be correctly flushed</span>
01267     <span class="comment">//</span>
01268     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>), Vector, VectorSize);
01269     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
01270     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = VectorSize * 8;
01271     <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));  <span class="comment">// force header of 1st bin dirty</span>
01272     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a11">HiveSuccess</a>;
01273 
01274 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01275     <span class="comment">//</span>
01276     <span class="comment">// free the dirty vector and return failure</span>
01277     <span class="comment">//</span>
01278     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(Vector, VectorSize);
01279     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1/hiveload_8c.html#a20a9">Fail</a>;
01280 }
01281 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
