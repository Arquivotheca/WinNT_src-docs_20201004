<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dragdrop.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dragdrop.c</h1><a href="../../d6/d1/dragdrop_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: dragdrop.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Stuff for object-oriented direct manipulation, designed first for the shell.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 08-06-91 darrinm    Ported from Win 3.1.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> <a class="code" href="../../d6/d1/dragdrop_8c.html#a0">xxxQueryDropObject</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, LPDROPSTRUCT lpds);
00016 
00017 <span class="comment">/***************************************************************************\</span>
00018 <span class="comment">* DragObject (API)</span>
00019 <span class="comment">*</span>
00020 <span class="comment">* Contains the main dragging loop.</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* History:</span>
00023 <span class="comment">* 08-06-91 darrinm      Ported from Win 3.1 sources.</span>
00024 <span class="comment">\***************************************************************************/</span>
00025 
<a name="l00026"></a><a class="code" href="../../d4/d1/userk_8h.html#a1311">00026</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1311">xxxDragObject</a>(
00027     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent,
00028     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFrom,          <span class="comment">// NULL is valid</span>
00029     UINT wFmt,
00030     ULONG_PTR dwData,
00031     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur)
00032 {
00033     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, msgKey;
00034     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> result = 0;
00035     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDrag = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00036     LPDROPSTRUCT lpds;
00037     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDragging = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00038     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTop;
00039     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurOld, pcurT;
00040     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00041     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
00042     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndTop;
00043     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndDragging;
00044     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPool;
00045     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00046 
00047     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndParent);
00048     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndFrom);
00049     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcur);
00050     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00051 
00052     lpds = (LPDROPSTRUCT)UserAllocPoolWithQuota(2 * <span class="keyword">sizeof</span>(DROPSTRUCT), TAG_DRAGDROP);
00053     <span class="keywordflow">if</span> (lpds == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00054         <span class="keywordflow">return</span> 0;
00055 
00056     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(pti, lpds, &amp;tlPool);
00057     lpds-&gt;hwndSource = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndFrom);
00058     lpds-&gt;wFmt = wFmt;
00059     lpds-&gt;dwData = dwData;
00060 
00061     <span class="keywordflow">if</span> (pcur != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00062         <span class="comment">/*</span>
00063 <span class="comment">         * No need to DeferWinEventNotify() - pwndFrom is locked</span>
00064 <span class="comment">         */</span>
00065         pcurOld = <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(pcur);
00066     } <span class="keywordflow">else</span> {
00067         pcurOld = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a>;
00068     }
00069 
00070     <span class="keywordflow">if</span> (pwndFrom) {
00071         <span class="keywordflow">for</span> (pwndTop = pwndFrom; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a735">TestwndChild</a>(pwndTop);
00072                 pwndTop = pwndTop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) ;
00073 
00074         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(pti, pwndTop, &amp;tlpwndTop);
00075         <a class="code" href="../../d4/d1/userk_8h.html#a1673">xxxUpdateWindow</a>(pwndTop);
00076         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndTop);
00077     }
00078 
00079     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00080         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_DRAGDROPSTART, pwndFrom, OBJID_WINDOW, INDEXID_CONTAINER, 0);
00081     }
00082 
00083     <a class="code" href="../../d4/d1/userk_8h.html#a1712">xxxSetCapture</a>(pwndFrom);
00084     <a class="code" href="../../d4/d1/userk_8h.html#a1787">zzzShowCursor</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00085 
00086     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(pti, pwndDragging, &amp;tlpwndDragging);
00087 
00088     <span class="keywordflow">while</span> (fDrag &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == pwndFrom) {
00089         <span class="keywordflow">while</span> (!(<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_MOUSEFIRST, WM_MOUSELAST, PM_REMOVE) ||
00090                  <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_QUEUESYNC, WM_QUEUESYNC, PM_REMOVE) ||
00091                  <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_KEYFIRST, WM_KEYLAST, PM_REMOVE))) {
00092             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1196">xxxSleepThread</a>(QS_MOUSE | QS_KEY, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00093                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDragging);
00094                 <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(pti, &amp;tlPool);
00095                 <span class="keywordflow">return</span> 0;
00096             }
00097         }
00098 
00099         <span class="comment">/*</span>
00100 <span class="comment">         * Be sure to eliminate any extra keydown messages that are</span>
00101 <span class="comment">         * being queued up by MOUSE message processing.</span>
00102 <span class="comment">         */</span>
00103 
00104         <span class="keywordflow">while</span> (<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;msgKey, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_KEYFIRST, WM_KEYLAST, PM_REMOVE))
00105            ;
00106 
00107         <span class="keywordflow">if</span>  ( (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> != pwndFrom) ||
00108               (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_KEYDOWN &amp;&amp; <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam == VK_ESCAPE) )
00109         {
00110             <span class="keywordflow">if</span> (pcurT = <a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(NO))
00111                 <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(pcurT);
00112             <span class="keywordflow">break</span>;
00113         }
00114 
00115         RtlCopyMemory(lpds + 1, lpds, <span class="keyword">sizeof</span>(DROPSTRUCT));
00116 
00117         <span class="comment">/*</span>
00118 <span class="comment">         * in screen coordinates</span>
00119 <span class="comment">         */</span>
00120         lpds-&gt;ptDrop = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.pt;
00121 
00122         pcurT = <a class="code" href="../../d6/d1/dragdrop_8c.html#a0">xxxQueryDropObject</a>(pwndParent, lpds);
00123 
00124         <span class="comment">/*</span>
00125 <span class="comment">         * Returning FALSE to a WM_QUERYDROPOBJECT message means drops</span>
00126 <span class="comment">         * aren't supported and the 'illegal drop target' cursor should be</span>
00127 <span class="comment">         * displayed.  Returning TRUE means the target is valid and the</span>
00128 <span class="comment">         * regular drag cursor should be displayed.  Also, through a bit</span>
00129 <span class="comment">         * of polymorphic magic one can return a cursor handle to override</span>
00130 <span class="comment">         * the normal drag cursor.</span>
00131 <span class="comment">         */</span>
00132         <span class="keywordflow">if</span> (pcurT == (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00133             pcurT = <a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(NO);
00134             lpds-&gt;hwndSink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00135         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcurT == (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00136             pcurT = pcur;
00137         }
00138 
00139         <span class="keywordflow">if</span> (pcurT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00140             <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(pcurT);
00141 
00142         <span class="comment">/*</span>
00143 <span class="comment">         * send the WM_DRAGLOOP after the above zzzSetCursor() to allow the</span>
00144 <span class="comment">         * receiver to change the cursor at WM_DRAGLOOP time with a zzzSetCursor()</span>
00145 <span class="comment">         */</span>
00146         <span class="keywordflow">if</span> (pwndFrom) {
00147             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndFrom, WM_DRAGLOOP, (pcurT != <a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(NO)),
00148                     (LPARAM)lpds);
00149         }
00150 
00151         <span class="comment">/*</span>
00152 <span class="comment">         * send these messages internally only</span>
00153 <span class="comment">         */</span>
00154         <span class="keywordflow">if</span> (pwndDragging != <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(lpds-&gt;hwndSink)) {
00155             <span class="keywordflow">if</span> (pwndDragging != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00156                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndDragging, WM_DRAGSELECT, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00157                         (LPARAM)(lpds + 1));
00158             }
00159             pwndDragging = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(lpds-&gt;hwndSink);
00160             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDragging);
00161             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(pti, pwndDragging, &amp;tlpwndDragging);
00162 
00163             <span class="keywordflow">if</span> (pwndDragging != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00164                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndDragging, WM_DRAGSELECT, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (LPARAM)lpds);
00165             }
00166         } <span class="keywordflow">else</span> {
00167             <span class="keywordflow">if</span> (pwndDragging != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00168                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndDragging, WM_DRAGMOVE, 0, (LPARAM)lpds);
00169             }
00170         }
00171 
00172         <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message) {
00173         <span class="keywordflow">case</span> WM_LBUTTONUP:
00174         <span class="keywordflow">case</span> WM_NCLBUTTONUP:
00175             fDrag = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00176             <span class="keywordflow">break</span>;
00177         }
00178     }
00179 
00180     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDragging);
00181 
00182     <span class="comment">/*</span>
00183 <span class="comment">     * If the capture has been lost (i.e. fDrag == TRUE), don't do the drop.</span>
00184 <span class="comment">     */</span>
00185     <span class="keywordflow">if</span> (fDrag)
00186         pcurT = <a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(NO);
00187 
00188     <span class="comment">/*</span>
00189 <span class="comment">     * before the actual drop, clean up the cursor, as the app may do</span>
00190 <span class="comment">     * stuff here...</span>
00191 <span class="comment">     */</span>
00192     <a class="code" href="../../d4/d1/userk_8h.html#a1713">xxxReleaseCapture</a>();
00193     <a class="code" href="../../d4/d1/userk_8h.html#a1787">zzzShowCursor</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00194 
00195     <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(pcurOld);
00196 
00197     <span class="comment">/*</span>
00198 <span class="comment">     * we either got lbuttonup or enter</span>
00199 <span class="comment">     */</span>
00200     <span class="keywordflow">if</span> (pcurT != <a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(NO)) {
00201 
00202         <span class="comment">/*</span>
00203 <span class="comment">         * object allows drop...  send drop message</span>
00204 <span class="comment">         */</span>
00205         pwndT = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(lpds-&gt;hwndSink);
00206         <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00207 
00208             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(pti, pwndT, &amp;tlpwndT);
00209 
00210             <span class="comment">/*</span>
00211 <span class="comment">             * Allow this guy to activate.</span>
00212 <span class="comment">             */</span>
00213             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT)-&gt;TIF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
00214             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxDragObject set TIF %#p"</span>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT));
00215             result = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndT, WM_DROPOBJECT,
00216                     (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndFrom), (LPARAM)lpds);
00217 
00218             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00219         }
00220     }
00221 
00222     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00223         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_DRAGDROPEND, pwndFrom, OBJID_WINDOW, INDEXID_CONTAINER, 0);
00224     }
00225 
00226     <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(pti, &amp;tlPool);
00227     <span class="keywordflow">return</span> result;
00228 }
00229 
00230 
00231 <span class="comment">/***************************************************************************\</span>
00232 <span class="comment">* QueryDropObject</span>
00233 <span class="comment">*</span>
00234 <span class="comment">* Determines where in the window heirarchy the "drop" takes place, and</span>
00235 <span class="comment">* sends a message to the deepest child window first.  If that window does</span>
00236 <span class="comment">* not respond, we go up the heirarchy (recursively, for the moment) until</span>
00237 <span class="comment">* we either get a window that does respond or the parent doesn't respond.</span>
00238 <span class="comment">*</span>
00239 <span class="comment">* History:</span>
00240 <span class="comment">* 08-06-91 darrinm      Ported from Win 3.1 sources.</span>
00241 <span class="comment">\***************************************************************************/</span>
00242 
<a name="l00243"></a><a class="code" href="../../d6/d1/dragdrop_8c.html#a0">00243</a> <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> <a class="code" href="../../d6/d1/dragdrop_8c.html#a0">xxxQueryDropObject</a>(
00244     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00245     LPDROPSTRUCT lpds)
00246 {
00247     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00248     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00249     POINT pt;
00250     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNC;
00251     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
00252     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00253 
00254     <span class="comment">/*</span>
00255 <span class="comment">     *  pt is in screen coordinates</span>
00256 <span class="comment">     */</span>
00257     pt = lpds-&gt;ptDrop;
00258 
00259     <span class="comment">/*</span>
00260 <span class="comment">     * reject points outside this window or if the window is disabled</span>
00261 <span class="comment">     */</span>
00262     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, pt) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>))
00263         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00264 
00265     <span class="comment">/*</span>
00266 <span class="comment">     * Check to see if in window region (if it has one)</span>
00267 <span class="comment">     */</span>
00268     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00269         <span class="keywordflow">if</span> (!GrePtInRegion(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>, pt.x, pt.y))
00270             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00271     }
00272 
00273     <span class="comment">/*</span>
00274 <span class="comment">     * are we dropping in the nonclient area of the window or on an iconic</span>
00275 <span class="comment">     * window?</span>
00276 <span class="comment">     */</span>
00277     <span class="keywordflow">if</span> (fNC = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) || !<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>, pt))) {
00278         <span class="keywordflow">goto</span> SendQueryDrop;
00279     }
00280 
00281     <span class="comment">/*</span>
00282 <span class="comment">     * dropping in client area</span>
00283 <span class="comment">     */</span>
00284     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a21">_ScreenToClient</a>(pwnd, &amp;pt);
00285     pwndT = <a class="code" href="../../d9/d8/winwhere_8c.html#a1">_ChildWindowFromPointEx</a>(pwnd, pt, CWP_SKIPDISABLED | CWP_SKIPINVISIBLE);
00286     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a18">_ClientToScreen</a>(pwnd, &amp;pt);
00287 
00288     pcurT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00289     <span class="keywordflow">if</span> (pwndT &amp;&amp; pwndT != pwnd) {
00290         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT, &amp;tlpwndT);
00291         pcurT = <a class="code" href="../../d6/d1/dragdrop_8c.html#a0">xxxQueryDropObject</a>(pwndT, lpds);
00292         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00293     }
00294 
00295     <span class="keywordflow">if</span> (pcurT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00296 
00297         <span class="comment">/*</span>
00298 <span class="comment">         * there are no children who are in the right place or who want</span>
00299 <span class="comment">         * drops...  convert the point into client coordinates of the</span>
00300 <span class="comment">         * current window.  Because of the recursion, this is already</span>
00301 <span class="comment">         * done if a child window grabbed the drop.</span>
00302 <span class="comment">         */</span>
00303 SendQueryDrop:
00304         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a21">_ScreenToClient</a>(pwnd, &amp;lpds-&gt;ptDrop);
00305         lpds-&gt;hwndSink = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00306 
00307         <span class="comment">/*</span>
00308 <span class="comment">         * To avoid hanging dropper (sender) app we do a SendMessageTimeout to</span>
00309 <span class="comment">         * the droppee (receiver)</span>
00310 <span class="comment">         */</span>
00311         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwnd, WM_QUERYDROPOBJECT, fNC,
00312                 (LPARAM)lpds, SMTO_ABORTIFHUNG, 3*1000, (PLONG_PTR)&amp;pcurT) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00313             pcurT = (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00314 
00315         <span class="keywordflow">if</span> (pcurT != (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; pcurT != (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00316             pcurT = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>((HCURSOR)pcurT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>);
00317 
00318         <span class="comment">/*</span>
00319 <span class="comment">         * restore drop point to screen coordinates if this window won't</span>
00320 <span class="comment">         * take drops</span>
00321 <span class="comment">         */</span>
00322         <span class="keywordflow">if</span> (pcurT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00323             lpds-&gt;ptDrop = pt;
00324     }
00325     <span class="keywordflow">return</span> pcurT;
00326 }
00327 
00328 
00329 <span class="comment">/***************************************************************************\</span>
00330 <span class="comment">* xxxDragDetect (API)</span>
00331 <span class="comment">*</span>
00332 <span class="comment">*</span>
00333 <span class="comment">*</span>
00334 <span class="comment">* History:</span>
00335 <span class="comment">* 08-06-91 darrinm      Ported from Win 3.1 sources.</span>
00336 <span class="comment">\***************************************************************************/</span>
00337 
<a name="l00338"></a><a class="code" href="../../d4/d1/userk_8h.html#a1312">00338</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1312">xxxDragDetect</a>(
00339     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00340     POINT pt)
00341 {
00342     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1313">xxxIsDragging</a>(pwnd, pt, WM_LBUTTONUP);
00343 }
00344 
00345 <span class="comment">/***************************************************************************\</span>
00346 <span class="comment">* xxxIsDragging</span>
00347 <span class="comment">*</span>
00348 <span class="comment">*</span>
00349 <span class="comment">*</span>
00350 <span class="comment">* History:</span>
00351 <span class="comment">* 05-17-94 johnl        Ported from Chicago sources</span>
00352 <span class="comment">\***************************************************************************/</span>
00353 
<a name="l00354"></a><a class="code" href="../../d4/d1/userk_8h.html#a1313">00354</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1313">xxxIsDragging</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, POINT ptScreen, UINT uMsg)
00355 {
00356     RECT rc;
00357     MSG  <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00358     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDragging;
00359     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCheck;
00360     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>   tlpwndDragging;
00361     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00362 
00363     <span class="comment">/*</span>
00364 <span class="comment">     * Check synchronous mouse state, and punt if the mouse isn't down</span>
00365 <span class="comment">     * according to the queue.</span>
00366 <span class="comment">     */</span>
00367     <span class="keywordflow">if</span> (!(<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>((uMsg == WM_LBUTTONUP ? VK_LBUTTON : VK_RBUTTON)) &amp; 0x8000))
00368         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00369 
00370     <a class="code" href="../../d4/d1/userk_8h.html#a1712">xxxSetCapture</a>(pwnd);
00371 
00372     *(LPPOINT)&amp;rc.left = ptScreen;
00373     *(LPPOINT)&amp;rc.right = ptScreen;
00374     <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXDRAG), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYDRAG));
00375 
00376     fDragging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00377     fCheck    = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00378 
00379     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(pti, pwnd, &amp;tlpwndDragging);
00380     <span class="keywordflow">while</span> (fCheck) {
00381         <span class="keywordflow">while</span> ( !(
00382                   <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_MOUSEFIRST, WM_MOUSELAST,PM_REMOVE) ||
00383                   <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_QUEUESYNC, WM_QUEUESYNC,PM_REMOVE) ||
00384                   <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_KEYFIRST, WM_KEYLAST,PM_REMOVE)
00385                  )
00386                &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == pwnd)) {
00387             <span class="comment">/*</span>
00388 <span class="comment">             * If there is no input for half a second (500ms) consider that</span>
00389 <span class="comment">             * we are dragging. If we don't specify a timeout value, the</span>
00390 <span class="comment">             * thread may sleep here forever and wouldn't repaint, etc.</span>
00391 <span class="comment">             */</span>
00392             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1196">xxxSleepThread</a>(QS_MOUSE | QS_KEY, 500, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00393                 fDragging = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00394                 <span class="keywordflow">goto</span> Cleanup;
00395             }
00396         }
00397 
00398         <span class="comment">/*</span>
00399 <span class="comment">         * Cancel if the button was released or we no longer have the capture.</span>
00400 <span class="comment">         */</span>
00401         <span class="keywordflow">if</span> ( pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> != pwnd || <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == uMsg) {
00402             fCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00403         } <span class="keywordflow">else</span> {
00404             <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message) {
00405 
00406             <span class="keywordflow">case</span> WM_MOUSEMOVE:
00407                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rc, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.pt)) {
00408                     fDragging = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00409                     fCheck    = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00410                 }
00411                 <span class="keywordflow">break</span>;
00412 
00413             <span class="keywordflow">case</span> WM_QUEUESYNC:
00414                 <span class="comment">/*</span>
00415 <span class="comment">                 * CBT Hook needs to know</span>
00416 <span class="comment">                 */</span>
00417                 <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_QS, 0, 0, WH_CBT);
00418                 <span class="keywordflow">break</span>;
00419 
00420             <span class="keywordflow">case</span> WM_KEYDOWN:
00421                 <span class="comment">/*</span>
00422 <span class="comment">                 * &lt;Esc&gt; cancels drag detection</span>
00423 <span class="comment">                 */</span>
00424                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam == VK_ESCAPE)
00425                     fCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00426                 <span class="keywordflow">break</span>;
00427 
00428             }
00429         }
00430     }
00431 
00432 Cleanup:
00433     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == pwnd)
00434         <a class="code" href="../../d4/d1/userk_8h.html#a1713">xxxReleaseCapture</a>();
00435 
00436     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDragging);
00437     <span class="keywordflow">return</span> fDragging ;
00438 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
