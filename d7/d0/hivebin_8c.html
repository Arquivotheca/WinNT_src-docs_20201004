<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivebin.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivebin.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d8/d9/hivebin_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/hivebin_8c.html#a0">HvpCoalesceDiscardedBins</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN ULONG NeededSize, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/hivebin_8c.html#a1">HvpAddBin</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN ULONG NewSize, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="hivebin.c::HvpAddBin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> HvpAddBin           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">46</a> of file <a class="el" href="../../d8/d9/hivebin_8c-source.html">hivebin.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00620">_HHIVE::Alternate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00058">ASSERT_LISTENTRY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00447">_HMAP_DIRECTORY::Directory</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00588">_FREE_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00600">_HHIVE::FileSetSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00589">_FREE_HBIN::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a71">FREE_HBIN</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00583">FREE_HBIN_DISCARDABLE</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a53">HBIN</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00188">HBIN_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00037">HBIN_THRESHOLD</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00045">HCELL_BIG_ROUND</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00569">HFILE_TYPE_ALTERNATE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a61">HMAP_DIRECTORY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a59">HMAP_TABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00401">HvMarkClean()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00270">HvMarkDirty()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00853">HvpAllocateMap()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00434">HvpCoalesceDiscardedBins()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00565">HvpGrowLog2()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00586">_FREE_HBIN::ListEntry</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a72">PFREE_HBIN</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a60">PHMAP_TABLE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00587">_FREE_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
<pre class="fragment"><div>00053                    :
00054 
00055     Grows either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> storage of a hive by adding
00056     a <span class="keyword">new</span> bin.  <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> will be allocated space in <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> store (e.g. file)
00057     if Type == Stable.  Memory image will be allocated and initialized.
00058     Map will be grown and filled in to describe the new bin.
00059 
00060 Arguments:
00061 
00062     Hive - supplies a pointer to the hive control structure for the
00063             hive of interest
00064 
00065     NewSize - size of the object caller wishes to put in the hive.  New
00066                 bin will be at least large enough to hold this.
00067 
00068     Type - Stable or Volatile
00069 
00070 Return Value:
00071 
00072     Pointer to the new BIN if we succeeded, NULL if we failed.
00073 
00074 --*/
00075 {
00076     BOOLEAN         UseForIo;
00077     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           NewBin;
00078     ULONG           OldLength;
00079     ULONG           NewLength;
00080     ULONG           OldMap;
00081     ULONG           NewMap;
00082     ULONG           OldTable;
00083     ULONG           NewTable;
00084     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir;
00085     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     newt;
00086     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00087     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00088     ULONG           i;
00089     ULONG           j;
00090     PULONG          NewVector;
00091     PLIST_ENTRY     Entry;
00092     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>      FreeBin;
00093     ULONG           TotalDiscardedSize;
00094 
00095 
00096     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
00097         KdPrint((<span class="stringliteral">"HvpAddBin:\n"</span>));
00098         KdPrint((<span class="stringliteral">"\tHive=%08lx NewSize=%08lx\n"</span>,Hive,NewSize));
00099     }
00100 
00101     <span class="comment">//</span>
00102     <span class="comment">//  Round size up to account for bin overhead.  Caller should</span>
00103     <span class="comment">//  have accounted for cell overhead.</span>
00104     <span class="comment">//</span>
00105     NewSize += <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>);
00106     <span class="keywordflow">if</span> ((NewSize &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a3">HCELL_BIG_ROUND</a>) &amp;&amp;
00107         ((NewSize % <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a1">HBIN_THRESHOLD</a>)) {
00108         NewSize += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00109     }
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">// Try not to create HBINs smaller than the page size of the machine</span>
00113     <span class="comment">//  (it is not illegal to have bins smaller than the page size, but it</span>
00114     <span class="comment">//  is less efficient)</span>
00115     <span class="comment">//</span>
00116     NewSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(NewSize, ((HBLOCK_SIZE &gt;= PAGE_SIZE) ? HBLOCK_SIZE : PAGE_SIZE));
00117 
00118     <span class="comment">//</span>
00119     <span class="comment">// see if there's a discarded HBIN of the right size</span>
00120     <span class="comment">//</span>
00121     TotalDiscardedSize = 0;
00122 
00123 Retry:
00124 
00125     Entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins.Flink;
00126     <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins) {
00127         FreeBin = CONTAINING_RECORD(Entry,
00128                                     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>,
00129                                     ListEntry);
00130         TotalDiscardedSize += FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00131         <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a> &gt;= NewSize) {
00132 
00133             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive,
00134                              FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> + (Type * HCELL_TYPE_MASK),
00135                              FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>)) {
00136                 <span class="keywordflow">goto</span> ErrorExit1;
00137             }
00138             NewSize = FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00139             <a class="code" href="../../d6/d0/hive_8h.html#a3">ASSERT_LISTENTRY</a>(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
00140             RemoveEntryList(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
00141             <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
00142                 <span class="comment">//</span>
00143                 <span class="comment">// HBIN is still in memory, don't need any more allocs, just</span>
00144                 <span class="comment">// fill in the block addresses.</span>
00145                 <span class="comment">//</span>
00146                 <span class="keywordflow">for</span> (i=0;i&lt;NewSize;i+=<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00147                     Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>+i+(Type*HCELL_TYPE_MASK));
00148                     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>+i+(Type*HCELL_TYPE_MASK));
00149                     Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>)+i;
00150                     Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp;= ~<a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>;
00151                 }
00152                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00153                 <span class="keywordflow">return</span>((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>));
00154             }
00155             <span class="keywordflow">break</span>;
00156         }
00157         Entry = Entry-&gt;Flink;
00158     }
00159 
00160     <span class="keywordflow">if</span> ((Entry == &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins) &amp;&amp;
00161         (TotalDiscardedSize &gt;= NewSize)) {
00162         <span class="comment">//</span>
00163         <span class="comment">// No sufficiently large discarded bin was found,</span>
00164         <span class="comment">// but the total discarded space is large enough.</span>
00165         <span class="comment">// Attempt to coalesce adjacent discarded bins into</span>
00166         <span class="comment">// a larger bin and retry.</span>
00167         <span class="comment">//</span>
00168         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/hivebin_8c.html#a0">HvpCoalesceDiscardedBins</a>(Hive, NewSize, Type)) {
00169             <span class="keywordflow">goto</span> Retry;
00170         }
00171     }
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">//  Attempt to allocate the bin.</span>
00175     <span class="comment">//</span>
00176     UseForIo = (BOOLEAN)((Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00177     <span class="keywordflow">if</span> (Entry != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins) {
00178         <span class="comment">//</span>
00179         <span class="comment">// Note we use ExAllocatePool directly here to avoid</span>
00180         <span class="comment">// charging quota for this bin again. When a bin</span>
00181         <span class="comment">// is discarded, its quota is not returned. This prevents</span>
00182         <span class="comment">// sparse hives from requiring more quota after</span>
00183         <span class="comment">// a reboot than on a running system.</span>
00184         <span class="comment">//</span>
00185         NewBin = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>((UseForIo) ? PagedPoolCacheAligned : PagedPool,
00186                                        NewSize,
00187                                        CM_POOL_TAG);
00188         <span class="keywordflow">if</span> (NewBin == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00189             InsertHeadList(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins, Entry);
00190             <a class="code" href="../../d0/d2/hivesync_8c.html#a10">HvMarkClean</a>(Hive, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00191             <span class="keywordflow">goto</span> ErrorExit1;
00192         }
00193     } <span class="keywordflow">else</span> {
00194         NewBin = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(NewSize, UseForIo);
00195         <span class="keywordflow">if</span> (NewBin == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00196             <span class="keywordflow">goto</span> ErrorExit1;
00197         }
00198     }
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">// Init the bin</span>
00202     <span class="comment">//</span>
00203     NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>;
00204     NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> = NewSize;
00205     NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = NewSize;
00206 
00207     <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)NewBin + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00208     <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;Size = NewSize - <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>);
00209     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00210         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;u.OldCell.Last = (ULONG)<a class="code" href="../../d0/d1/hivedata_8h.html#a25">HBIN_NIL</a>;
00211     }
00212 
00213     <span class="keywordflow">if</span> (Entry != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins) {
00214         <span class="comment">//</span>
00215         <span class="comment">// found a discarded HBIN we can use, just fill in the map and we</span>
00216         <span class="comment">// are done.</span>
00217         <span class="comment">//</span>
00218         <span class="keywordflow">for</span> (i=0;i&lt;NewSize;i+=<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00219             Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>+i+(Type*HCELL_TYPE_MASK));
00220             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>+i+(Type*HCELL_TYPE_MASK));
00221             Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = (ULONG_PTR)NewBin + i;
00222             Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)NewBin;
00223             <span class="keywordflow">if</span> (i==0) {
00224                 Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> |= <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
00225             }
00226         }
00227 
00228         NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> = FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>;
00229 
00230         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00231 
00232         <span class="keywordflow">return</span>(NewBin);
00233     }
00234 
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Compute map growth needed, grow the map</span>
00238     <span class="comment">//</span>
00239     OldLength = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length;
00240     NewLength = OldLength + NewSize;
00241 
00242 
00243     NewBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> = OldLength;
00244 
00245     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((OldLength % HBLOCK_SIZE) == 0);
00246     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((NewLength % HBLOCK_SIZE) == 0);
00247 
00248     <span class="keywordflow">if</span> (OldLength == 0) {
00249         <span class="comment">//</span>
00250         <span class="comment">// Need to create the first table</span>
00251         <span class="comment">//</span>
00252         newt = (PVOID)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
00253         <span class="keywordflow">if</span> (newt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00254             <span class="keywordflow">goto</span> ErrorExit2;
00255         }
00256         RtlZeroMemory(newt, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00257         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].SmallDir = newt;
00258         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map = (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].SmallDir);
00259     }
00260 
00261     <span class="keywordflow">if</span> (OldLength &gt; 0) {
00262         OldMap = (OldLength-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00263     } <span class="keywordflow">else</span> {
00264         OldMap = 0;
00265     }
00266     NewMap = (NewLength-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00267 
00268     OldTable = OldMap / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00269     NewTable = NewMap / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00270 
00271     <span class="keywordflow">if</span> (NewTable != OldTable) {
00272 
00273         <span class="comment">//</span>
00274         <span class="comment">// Need some new Tables</span>
00275         <span class="comment">//</span>
00276         <span class="keywordflow">if</span> (OldTable == 0) {
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// We can get here even if the real directory has already been created.</span>
00280             <span class="comment">// This can happen if we create the directory then fail on something </span>
00281             <span class="comment">// later. So we need to handle the case where a directory already exists.</span>
00282             <span class="comment">//</span>
00283             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map == (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].SmallDir) {
00284                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].SmallDir != NULL);
00285 
00286                 <span class="comment">//</span>
00287                 <span class="comment">// Need a real directory</span>
00288                 <span class="comment">//</span>
00289                 Dir = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00290                 <span class="keywordflow">if</span> (Dir == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00291                     <span class="keywordflow">goto</span> ErrorExit2;
00292                 }
00293                 RtlZeroMemory(Dir, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00294     
00295                 Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[0] = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].SmallDir;
00296                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00297     
00298                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map = Dir;
00299             } <span class="keywordflow">else</span> {
00300                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].SmallDir == NULL);
00301             }
00302 
00303         }
00304         Dir = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map;
00305 
00306         <span class="comment">//</span>
00307         <span class="comment">// Fill in directory with new tables</span>
00308         <span class="comment">//</span>
00309         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/hivemap_8c.html#a13">HvpAllocateMap</a>(Hive, Dir, OldTable+1, NewTable) ==  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00310             <span class="keywordflow">goto</span> ErrorExit3;
00311         }
00312     }
00313 
00314     <span class="comment">//</span>
00315     <span class="comment">// If Type == Stable, and the hive is not marked WholeHiveVolatile,</span>
00316     <span class="comment">// grow the file, the log, and the DirtyVector</span>
00317     <span class="comment">//</span>
00318     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length = NewLength;
00319     <span class="keywordflow">if</span> ((Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>) &amp;&amp; (!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>))) {
00320 
00321         <span class="comment">//</span>
00322         <span class="comment">// Grow the dirtyvector</span>
00323         <span class="comment">//</span>
00324         NewVector = (PULONG)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(NewMap+1,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00325         <span class="keywordflow">if</span> (NewVector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00326             <span class="keywordflow">goto</span> ErrorExit3;
00327         }
00328 
00329         RtlZeroMemory(NewVector, NewMap+1);
00330 
00331         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00332 
00333             RtlCopyMemory(
00334                 (PVOID)NewVector,
00335                 (PVOID)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer,
00336                 OldMap+1
00337                 );
00338             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a>);
00339         }
00340 
00341         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(
00342             &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>),
00343             NewVector,
00344             NewLength / HSECTOR_SIZE
00345             );
00346         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = NewMap+1;
00347 
00348         <span class="comment">//</span>
00349         <span class="comment">// Grow the log</span>
00350         <span class="comment">//</span>
00351         <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d0/d2/hivesync_8c.html#a12">HvpGrowLog2</a>(Hive, NewSize))) {
00352             <span class="keywordflow">goto</span> ErrorExit4;
00353         }
00354 
00355         <span class="comment">//</span>
00356         <span class="comment">// Grow the primary</span>
00357         <span class="comment">//</span>
00358         <span class="keywordflow">if</span> ( !  (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(
00359                     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00360                     <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00361                     NewLength+<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>
00362                     ) )
00363         {
00364             <span class="keywordflow">goto</span> ErrorExit4;
00365         }
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// Grow the alternate if it exists</span>
00369         <span class="comment">//</span>
00370         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00371             <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(
00372                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00373                         <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>,
00374                         NewLength+<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>
00375                         ) )
00376             {
00377                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(
00378                     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00379                     <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00380                     OldLength+<a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>
00381                     );
00382                 <span class="keywordflow">goto</span> ErrorExit4;
00383             }
00384         }
00385 
00386         <span class="comment">//</span>
00387         <span class="comment">// Mark new bin dirty so all control structures get written at next sync</span>
00388         <span class="comment">//</span>
00389         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive, OldLength, NewSize)) {
00390             <span class="keywordflow">goto</span> ErrorExit4;
00391         }
00392     }
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Fill in the map, mark new allocation.</span>
00396     <span class="comment">//</span>
00397     j = 0;
00398     <span class="keywordflow">for</span> (i = OldLength; i &lt; NewLength; i += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00399         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, i + (Type*HCELL_TYPE_MASK));
00400         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,i + (Type*HCELL_TYPE_MASK));
00401         Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = (ULONG_PTR)NewBin + j;
00402         Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)NewBin;
00403 
00404         <span class="keywordflow">if</span> (j == 0) {
00405             <span class="comment">//</span>
00406             <span class="comment">// First block of allocation, mark it.</span>
00407             <span class="comment">//</span>
00408             Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> |= <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
00409         }
00410         j += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00411     }
00412 
00413     <span class="keywordflow">return</span> NewBin;
00414 
00415 ErrorExit4:
00416     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>,
00417                         NewVector,
00418                         OldLength / HSECTOR_SIZE);
00419     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00420 
00421 ErrorExit3:
00422     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length = OldLength;
00423     <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, Dir, OldTable+1, NewTable);
00424 
00425 ErrorExit2:
00426     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(NewBin, NewSize);
00427 
00428 ErrorExit1:
00429     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00430 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="hivebin.c::HvpCoalesceDiscardedBins" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpCoalesceDiscardedBins           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NeededSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00434">434</a> of file <a class="el" href="../../d8/d9/hivebin_8c-source.html">hivebin.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00588">_FREE_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00589">_FREE_HBIN::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00583">FREE_HBIN_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00586">_FREE_HBIN::ListEntry</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00587">_FREE_HBIN::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>.
<p>
<pre class="fragment"><div>00442                    :
00443 
00444     Walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of discarded bins and attempts to
00445     coalesce adjacent discarded bins into one larger bin in
00446     order to satisfy an allocation request.
00447 
00448 Arguments:
00449 
00450     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00451 
00452     NeededSize - Supplies size of allocation needed.
00453 
00454     Type - <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>
00455 
00456 Return Value:
00457 
00458     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> bin of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired size was created.
00459 
00460     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - No bin of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired size could be created.
00461 
00462 --*/
00463 
00464 {
00465     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00466     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> FreeBin;
00467     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> PreviousFreeBin;
00468     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> NextFreeBin;
00469     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
00470     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> PreviousMap;
00471     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> NextMap;
00472     ULONG MapBlock;
00473 
00474     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins.Flink;
00475 
00476     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins) {
00477         FreeBin = CONTAINING_RECORD(List, <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>, ListEntry);
00478 
00479         <span class="keywordflow">if</span> ((FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>)==0) {
00480 
00481             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>);
00482             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>);
00483 
00484             <span class="comment">//</span>
00485             <span class="comment">// Scan backwards, coalescing previous discarded bins</span>
00486             <span class="comment">//</span>
00487             <span class="keywordflow">while</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> &gt; 0) {
00488                 PreviousMap = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> - HBLOCK_SIZE);
00489                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,PreviousMap,Hive,FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> - HBLOCK_SIZE);
00490                 <span class="keywordflow">if</span> (PreviousMap-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
00491                     PreviousFreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)PreviousMap-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00492 
00493                     <span class="keywordflow">if</span> (PreviousFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
00494                         <span class="keywordflow">break</span>;
00495                     }
00496                     RemoveEntryList(&amp;PreviousFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
00497 
00498                     <span class="comment">//</span>
00499                     <span class="comment">// Fill in all the old map entries with the new one.</span>
00500                     <span class="comment">//</span>
00501                     <span class="keywordflow">for</span> (MapBlock = 0; MapBlock &lt; PreviousFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>; MapBlock += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00502                         PreviousMap = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, PreviousFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> + MapBlock);
00503                         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,PreviousMap,Hive,PreviousFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> + MapBlock);
00504                         PreviousMap-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = (ULONG_PTR)FreeBin;
00505                     }
00506 
00507                     FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> = PreviousFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a>;
00508                     FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a> += PreviousFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00509                     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(PreviousFreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00510                 } <span class="keywordflow">else</span> {
00511                     <span class="keywordflow">break</span>;
00512                 }
00513             }
00514 
00515             <span class="comment">//</span>
00516             <span class="comment">// Scan forwards, coalescing subsequent discarded bins</span>
00517             <span class="comment">//</span>
00518             <span class="keywordflow">while</span> ((FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> + FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>) &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>) {
00519                 NextMap = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> + FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00520                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,NextMap,Hive,FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> + FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00521                 <span class="keywordflow">if</span> (NextMap-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
00522                     NextFreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)NextMap-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00523 
00524                     <span class="keywordflow">if</span> (NextFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
00525                         <span class="keywordflow">break</span>;
00526                     }
00527 
00528                     RemoveEntryList(&amp;NextFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
00529 
00530                     <span class="comment">//</span>
00531                     <span class="comment">// Fill in all the old map entries with the new one.</span>
00532                     <span class="comment">//</span>
00533                     <span class="keywordflow">for</span> (MapBlock = 0; MapBlock &lt; NextFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>; MapBlock += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00534                         NextMap = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, NextFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> + MapBlock);
00535                         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,NextMap,Hive,NextFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> + MapBlock);
00536                         NextMap-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = (ULONG_PTR)FreeBin;
00537                     }
00538 
00539                     FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a> += NextFreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00540                     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(NextFreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00541                 } <span class="keywordflow">else</span> {
00542                     <span class="keywordflow">break</span>;
00543                 }
00544             }
00545             <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a> &gt;= NeededSize) {
00546                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00547             }
00548         }
00549         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>=<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
00550     }
00551     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00552 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
