<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpinit.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d8/d9/pnpinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">_ROOT_ENUMERATOR_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a0">ALLOW_WORLD_READ_OF_ENUM</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">_ROOT_ENUMERATOR_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a1">ROOT_ENUMERATOR_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">_ROOT_ENUMERATOR_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a2">PROOT_ENUMERATOR_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a3">IopPnPDriverEntry</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN PUNICODE_STRING RegistryPath)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a4">IopInitializeDeviceKey</a> (IN HANDLE KeyHandle, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN OUT PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a5">IopInitializeDeviceInstanceKey</a> (IN HANDLE KeyHandle, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN OUT PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a6">IopGetServiceType</a> (IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN PULONG ServiceType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INTERFACE_TYPE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a7">IopDetermineDefaultInterfaceType</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a8">IopInitializePlugPlayServices</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, IN ULONG Phase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a9">IopGetRootDevices</a> (<a class="el" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *DeviceRelations)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/pnpinit_8c.html#a10">IopIsFirmwareMapperDevicePresent</a> (IN HANDLE KeyHandle)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="pnpinit.c::ALLOW_WORLD_READ_OF_ENUM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALLOW_WORLD_READ_OF_ENUM&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00040">40</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a2" doxytag="pnpinit.c::PROOT_ENUMERATOR_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">_ROOT_ENUMERATOR_CONTEXT</a> * <a class="el" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">PROOT_ENUMERATOR_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, and <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00819">IopInitializeDeviceKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="pnpinit.c::ROOT_ENUMERATOR_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">_ROOT_ENUMERATOR_CONTEXT</a>  <a class="el" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">ROOT_ENUMERATOR_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="pnpinit.c::IopDetermineDefaultInterfaceType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INTERFACE_TYPE IopDetermineDefaultInterfaceType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01510">1510</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a237a142">HalInstalledBusInformation</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01542">HalQuerySystemInformation</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00038">IopPnpScratchBuffer1</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00900">PNP_LARGE_SCRATCH_BUFFER_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>01516                    :
01517 
01518     This routine checks <span class="keywordflow">if</span> detection flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to enable driver detection.
01519     The detection will be enabled <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no PCI bus in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> machine and <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
01520     on ALPHA machine.
01521 
01522 Parameters:
01523 
01524     None.
01525 
01526 Return Value:
01527 
01528     BOOLEAN value to indicate <span class="keywordflow">if</span> detection <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> enabled.
01529 
01530 --*/
01531 
01532 {
01533     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01534     PVOID p;
01535     <a class="code" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> pBusInfo;
01536     ULONG length, i;
01537     INTERFACE_TYPE interfaceType = Isa;
01538 
01539     pBusInfo = <a class="code" href="../../d1/d0/pnpdata_8c.html#a0">IopPnpScratchBuffer1</a>;
01540     length = <a class="code" href="../../d9/d0/pnpiop_8h.html#a87">PNP_LARGE_SCRATCH_BUFFER_SIZE</a>;
01541     status = <a class="code" href="../../d2/d7/hal_8h.html#a20">HalQuerySystemInformation</a> (
01542                 HalInstalledBusInformation,
01543                 length,
01544                 pBusInfo,
01545                 &amp;length
01546                 );
01547 
01548     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01549 
01550         <span class="keywordflow">return</span> interfaceType;
01551     }
01552 
01553     <span class="comment">//</span>
01554     <span class="comment">// Check installed bus information to make sure there is no existing Pnp Isa</span>
01555     <span class="comment">// bus extender.</span>
01556     <span class="comment">//</span>
01557 
01558     p = pBusInfo;
01559     <span class="keywordflow">for</span> (i = 0; i &lt; length / <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">HAL_BUS_INFORMATION</a>); i++, pBusInfo++) {
01560         <span class="keywordflow">if</span> (pBusInfo-&gt;BusType == Isa || pBusInfo-&gt;BusType == Eisa) {
01561             interfaceType = Isa;
01562             <span class="keywordflow">break</span>;
01563         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBusInfo-&gt;BusType == MicroChannel) {
01564             interfaceType = MicroChannel;
01565         }
01566     }
01567 
01568     <span class="keywordflow">return</span> interfaceType;
01569 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="pnpinit.c::IopGetRootDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetRootDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceRelations</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">680</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00177">CmRegistryMachineSystemCurrentControlSetEnumRootName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01927">_DEVICE_RELATIONS::Count</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00046">_ROOT_ENUMERATOR_CONTEXT::DeviceCount</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00047">_ROOT_ENUMERATOR_CONTEXT::DeviceList</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00913">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01690">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00819">IopInitializeDeviceKey()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00044">_ROOT_ENUMERATOR_CONTEXT::KeyName</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00045">_ROOT_ENUMERATOR_CONTEXT::MaxDeviceCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01928">_DEVICE_RELATIONS::Objects</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01213">PDEVICE_OBJECT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00900">PNP_LARGE_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00899">PNP_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00663">RtlAppendStringToString()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00043">_ROOT_ENUMERATOR_CONTEXT::Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>.
<p>
<pre class="fragment"><div>00686                    :
00687 
00688     This routine scans through System\Enum\Root subtree to build a device node <span class="keywordflow">for</span>
00689     each root device.
00690 
00691 Arguments:
00692 
00693     DeviceRelations - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">DEVICE_RELATIONS</a> structure.
00694 
00695 Return Value:
00696 
00697     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00698 
00699 --*/
00700 
00701 {
00702     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00703     HANDLE baseHandle;
00704     UNICODE_STRING workName, tmpName;
00705     PVOID buffer;
00706     <a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">ROOT_ENUMERATOR_CONTEXT</a> context;
00707     ULONG i;
00708     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
00709 
00710     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00711 
00712     *DeviceRelations = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00713     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, PNP_LARGE_SCRATCH_BUFFER_SIZE);
00714     <span class="keywordflow">if</span> (!buffer) {
00715         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00716     }
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Allocate a buffer to store the PDOs enumerated.</span>
00720     <span class="comment">// Note, the the buffer turns out to be not big enough, it will be reallocated dynamically.</span>
00721     <span class="comment">//</span>
00722 
00723     context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a> = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, PNP_SCRATCH_BUFFER_SIZE * 2);
00724     <span class="keywordflow">if</span> (context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>) {
00725         context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o2">MaxDeviceCount</a> = (<a class="code" href="../../d9/d0/pnpiop_8h.html#a86">PNP_SCRATCH_BUFFER_SIZE</a> * 2) / <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>);
00726         context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a> = 0;
00727     } <span class="keywordflow">else</span> {
00728         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
00729         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00730     }
00731 
00732     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00733     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;PpRegistryDeviceResource, TRUE);
00734 
00735     <span class="comment">//</span>
00736     <span class="comment">// Open System\CurrentControlSet\Enum\Root key and call worker routine to recursively</span>
00737     <span class="comment">// scan through the subkeys.</span>
00738     <span class="comment">//</span>
00739 
00740     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;baseHandle,
00741                                      NULL,
00742                                      &amp;CmRegistryMachineSystemCurrentControlSetEnumRootName,
00743                                      KEY_READ,
00744                                      REG_OPTION_NON_VOLATILE,
00745                                      NULL
00746                                      );
00747 
00748     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00749 
00750         workName.Buffer = (PWSTR)buffer;
00751         RtlFillMemory(buffer, PNP_LARGE_SCRATCH_BUFFER_SIZE, 0);
00752         workName.MaximumLength = <a class="code" href="../../d9/d0/pnpiop_8h.html#a87">PNP_LARGE_SCRATCH_BUFFER_SIZE</a>;
00753         workName.Length = 0;
00754 
00755         <span class="comment">//</span>
00756         <span class="comment">// only look at ROOT key</span>
00757         <span class="comment">//</span>
00758 
00759         PiWstrToUnicodeString(&amp;tmpName, REGSTR_KEY_ROOTENUM);
00760         <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;workName, (PSTRING)&amp;tmpName);
00761 
00762         <span class="comment">//</span>
00763         <span class="comment">// Enumerate all subkeys under the System\CCS\Enum\Root.</span>
00764         <span class="comment">//</span>
00765 
00766         context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o0">Status</a> = STATUS_SUCCESS;
00767         context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o1">KeyName</a> = &amp;workName;
00768 
00769         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a12">IopApplyFunctionToSubKeys</a>(baseHandle,
00770                                            NULL,
00771                                            KEY_ALL_ACCESS,
00772                                            FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS,
00773                                            IopInitializeDeviceKey,
00774                                            &amp;context
00775                                            );
00776         ZwClose(baseHandle);
00777 
00778         <span class="comment">//</span>
00779         <span class="comment">// Build returned information from ROOT_ENUMERATOR_CONTEXT.</span>
00780         <span class="comment">//</span>
00781 
00782 
00783         status = context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o0">Status</a>;
00784         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a> != 0) {
00785             deviceRelations = (<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00786                 PagedPool,
00787                 <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">DEVICE_RELATIONS</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>
00788                 );
00789             <span class="keywordflow">if</span> (deviceRelations == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00790                 status = STATUS_INSUFFICIENT_RESOURCES;
00791             } <span class="keywordflow">else</span> {
00792                 deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a> = context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>;
00793                 RtlMoveMemory(deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>,
00794                               context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>,
00795                               sizeof (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>);
00796                 *DeviceRelations = deviceRelations;
00797             }
00798         }
00799         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00800 
00801             <span class="comment">//</span>
00802             <span class="comment">// If somehow the enumeration failed, we need to derefernece all the</span>
00803             <span class="comment">// device objects.</span>
00804             <span class="comment">//</span>
00805 
00806             <span class="keywordflow">for</span> (i = 0; i &lt; context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>; i++) {
00807                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>[i]);
00808             }
00809         }
00810     }
00811     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00812     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00813     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
00814     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(context.<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>);
00815     <span class="keywordflow">return</span> status;
00816 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pnpinit.c::IopGetServiceType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetServiceType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01454">1454</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>.
<p>
<pre class="fragment"><div>01461                    :
01462 
01463     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling service's service <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
01464     Device instance.
01465 
01466 Arguments:
01467 
01468     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - supplies a unicode string to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance.
01469 
01470     ServiceType - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
01471 
01472 Return Value:
01473 
01474     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01475 
01476 --*/
01477 
01478 {
01479     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01480     HANDLE handle;
01481     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01482 
01483 
01484     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01485 
01486     *ServiceType = -1;
01487     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a> (
01488                              KeyName,
01489                              KEY_READ,
01490                              &amp;handle,
01491                              NULL,
01492                              FALSE
01493                              );
01494     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01495         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle, L<span class="stringliteral">"Type"</span>, &amp;keyValueInformation);
01496         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01497             <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_DWORD) {
01498                 <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG)) {
01499                     *ServiceType = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01500                 }
01501             }
01502             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01503         }
01504         ZwClose(handle);
01505     }
01506     <span class="keywordflow">return</span> status;
01507 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="pnpinit.c::IopInitializeDeviceInstanceKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopInitializeDeviceInstanceKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">879</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00046">_ROOT_ENUMERATOR_CONTEXT::DeviceCount</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00047">_ROOT_ENUMERATOR_CONTEXT::DeviceList</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00376">DNF_DUPLICATE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01224">DOE_START_PENDING</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00056">IopAllocateDeviceNode()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">IopConcatenateUnicodeStrings()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05633">IopDeviceNodeCapabilitiesToRegistry()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01870">IopDeviceNodeFlagsToCapabilities</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01471">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03967">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01454">IopGetServiceType()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00447">IopInsertTreeDeviceNode()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03332">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01572">IopIsFirmwareMapperDevicePresent()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00037">IoPnpDriverObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00098">IopNumberDeviceNodes</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a281">IopProcessCriticalDevice()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00182">KeQueryTickCount()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00045">_ROOT_ENUMERATOR_CONTEXT::MaxDeviceCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01213">PDEVICE_OBJECT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00899">PNP_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration()</a>, <a class="el" href="../../d7/d0/pnpinit_8c.html#a2">PROOT_ENUMERATOR_CONTEXT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00663">RtlAppendStringToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00043">_ROOT_ENUMERATOR_CONTEXT::Status</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00819">IopInitializeDeviceKey()</a>.
<p>
<pre class="fragment"><div>00887                    :
00888 
00889     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a callback function <span class="keywordflow">for</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a243">IopApplyFunctionToSubKeys</a>.
00890     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> each subkey under HKLM\System\Enum\Root\DeviceKey.
00891 
00892 Arguments:
00893 
00894     KeyHandle - Supplies a handle to <span class="keyword">this</span> key.
00895 
00896     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <span class="keyword">this</span> key.
00897 
00898     Context - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">ROOT_ENUMERATOR_CONTEXT</a> structure.
00899 
00900 Returns:
00901 
00902     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to <span class="keywordflow">continue</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
00903     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to abort <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00904 
00905 --*/
00906 {
00907     UNICODE_STRING unicodeName, serviceName;
00908     PKEY_VALUE_FULL_INFORMATION serviceKeyValueInfo;
00909     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00910     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00911     BOOLEAN isDuplicate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00912     BOOLEAN configuredBySetup;
00913     ULONG deviceFlags, instance, tmpValue1;
00914     ULONG legacy;
00915     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> savedLength;
00916     PUNICODE_STRING pUnicode;
00917     HANDLE handle;
00918     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00919     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00920     <a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">PROOT_ENUMERATOR_CONTEXT</a> enumContext = (<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">PROOT_ENUMERATOR_CONTEXT</a>)Context;
00921     WCHAR buffer[30];
00922     UNICODE_STRING deviceName;
00923     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> length;
00924     LARGE_INTEGER tickCount;
00925 
00926 
00927     <span class="comment">//</span>
00928     <span class="comment">// First off, check to see if this is a phantom device instance (i.e.,</span>
00929     <span class="comment">// registry key only).  If so, we want to totally ignore this key and</span>
00930     <span class="comment">// move on to the next one.</span>
00931     <span class="comment">//</span>
00932     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(KeyHandle,
00933                                  REGSTR_VAL_PHANTOM,
00934                                  &amp;keyValueInformation);
00935 
00936     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00937         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
00938             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
00939             tmpValue1 = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00940         } <span class="keywordflow">else</span> {
00941             tmpValue1 = 0;
00942         }
00943 
00944         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00945 
00946         <span class="keywordflow">if</span> (tmpValue1) {
00947             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00948         }
00949     }
00950 
00951     <span class="comment">//</span>
00952     <span class="comment">// Since it is highly likely we are going to report another PDO make sure</span>
00953     <span class="comment">// there will be room in the buffer.</span>
00954     <span class="comment">//</span>
00955 
00956     <span class="keywordflow">if</span> (enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a> == enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o2">MaxDeviceCount</a>) {
00957 
00958         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *tmpDeviceObjectList;
00959         ULONG tmpDeviceObjectListSize;
00960 
00961         <span class="comment">//</span>
00962         <span class="comment">// We need to grow our PDO list buffer.</span>
00963         <span class="comment">//</span>
00964 
00965         tmpDeviceObjectListSize = (enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o2">MaxDeviceCount</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>))
00966                                         + (<a class="code" href="../../d9/d0/pnpiop_8h.html#a86">PNP_SCRATCH_BUFFER_SIZE</a> * 2);
00967 
00968         tmpDeviceObjectList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, tmpDeviceObjectListSize);
00969 
00970         <span class="keywordflow">if</span> (tmpDeviceObjectList) {
00971 
00972             RtlCopyMemory( tmpDeviceObjectList,
00973                            enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>,
00974                            enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)
00975                            );
00976             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>);
00977             enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a> = tmpDeviceObjectList;
00978             enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o2">MaxDeviceCount</a> = tmpDeviceObjectListSize / <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>);
00979 
00980         } <span class="keywordflow">else</span> {
00981 
00982             <span class="comment">//</span>
00983             <span class="comment">// We are out of memory.  There is no point going any further</span>
00984             <span class="comment">// since we don't have any place to report the PDOs anyways.</span>
00985             <span class="comment">//</span>
00986 
00987             enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o0">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00988 
00989             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00990         }
00991     }
00992 
00993     <span class="comment">//</span>
00994     <span class="comment">// Check if the PDO for the device instance key exists already.  If no,</span>
00995     <span class="comment">// see if we need to create it.</span>
00996     <span class="comment">//</span>
00997 
00998     deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(KeyHandle, NULL);
00999 
01000     <span class="keywordflow">if</span> (deviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01001 
01002         enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>[enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>] = deviceObject;
01003         enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>++;
01004         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01005     }
01006 
01007     <span class="comment">//</span>
01008     <span class="comment">// We don't have device object for it.</span>
01009     <span class="comment">// First check if this key was created by firmware mapper.  If yes, make sure</span>
01010     <span class="comment">// the device is still present.</span>
01011     <span class="comment">//</span>
01012 
01013     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a249">IopIsFirmwareMapperDevicePresent</a>(KeyHandle)) {
01014         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01015     }
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Get the "DuplicateOf" value entry to determine if the device instance</span>
01019     <span class="comment">// should be registered.  If the device instance is duplicate, We don't</span>
01020     <span class="comment">// add it to its service key's enum branch.</span>
01021     <span class="comment">//</span>
01022 
01023     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
01024                                   REGSTR_VALUE_DUPLICATEOF,
01025                                   &amp;keyValueInformation
01026                                   );
01027     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01028         <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_SZ &amp;&amp;
01029             keyValueInformation-&gt;DataLength &gt; 0) {
01030             isDuplicate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01031         }
01032 
01033         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01034     }
01035 
01036     <span class="comment">//</span>
01037     <span class="comment">// Get the "Service=" value entry from KeyHandle</span>
01038     <span class="comment">//</span>
01039 
01040     serviceKeyValueInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01041 
01042     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;serviceName, NULL);
01043 
01044     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( KeyHandle,
01045                                    REGSTR_VALUE_SERVICE,
01046                                    &amp;serviceKeyValueInfo
01047                                    );
01048     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01049 
01050         <span class="comment">//</span>
01051         <span class="comment">// Append the new instance to its corresponding</span>
01052         <span class="comment">// Service\Name\Enum.</span>
01053         <span class="comment">//</span>
01054 
01055         <span class="keywordflow">if</span> (serviceKeyValueInfo-&gt;Type == REG_SZ &amp;&amp;
01056             serviceKeyValueInfo-&gt;DataLength != 0) {
01057 
01058             <span class="comment">//</span>
01059             <span class="comment">// Set up ServiceKeyName unicode string</span>
01060             <span class="comment">//</span>
01061 
01062             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(
01063                                 &amp;serviceName,
01064                                 (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(serviceKeyValueInfo),
01065                                 serviceKeyValueInfo-&gt;DataLength
01066                                 );
01067         }
01068 
01069         <span class="comment">//</span>
01070         <span class="comment">// Do not Free serviceKeyValueInfo.  It contains Service Name.</span>
01071         <span class="comment">//</span>
01072 
01073     }
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">// Combine Context-&gt;KeyName, i.e. the device name and KeyName (device instance name)</span>
01077     <span class="comment">// to form device instance path and register this device instance by</span>
01078     <span class="comment">// constructing new value entry for ServiceKeyName\Enum key.</span>
01079     <span class="comment">// i.e., &lt;Number&gt; = &lt;PathToSystemEnumBranch&gt;</span>
01080     <span class="comment">//</span>
01081 
01082     pUnicode = ((<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">PROOT_ENUMERATOR_CONTEXT</a>)Context)-&gt;KeyName;
01083     savedLength = pUnicode-&gt;Length;                  <span class="comment">// Save WorkName</span>
01084     <span class="keywordflow">if</span> (pUnicode-&gt;Buffer[pUnicode-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) - 1] != OBJ_NAME_PATH_SEPARATOR) {
01085         pUnicode-&gt;Buffer[pUnicode-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] = OBJ_NAME_PATH_SEPARATOR;
01086         pUnicode-&gt;Length += 2;
01087     }
01088 
01089     <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)pUnicode, (PSTRING)KeyName);
01090 
01091     <span class="comment">//</span>
01092     <span class="comment">// For the stuff under Root, we need to expose devnodes for everything</span>
01093     <span class="comment">// except those devices whose CsConfigFlags are set to CSCONFIGFLAG_DO_NOT_CREATE.</span>
01094     <span class="comment">//</span>
01095 
01096     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a9">IopGetDeviceInstanceCsConfigFlags</a>( pUnicode, &amp;deviceFlags );
01097 
01098     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_CREATE)) {
01099         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(serviceKeyValueInfo);
01100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01101     }
01102 
01103     <span class="comment">//</span>
01104     <span class="comment">// Make sure this device instance is really a "device" by checking</span>
01105     <span class="comment">// the "Legacy" value name.</span>
01106     <span class="comment">//</span>
01107 
01108     legacy = 0;
01109     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
01110                                   REGSTR_VALUE_LEGACY,
01111                                   &amp;keyValueInformation
01112                                   );
01113     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01114 
01115         <span class="comment">//</span>
01116         <span class="comment">// If "Legacy=" exists ...</span>
01117         <span class="comment">//</span>
01118 
01119         <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_DWORD) {
01120             <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG)) {
01121                 legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01122             }
01123         }
01124         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01125     }
01126 
01127     <span class="keywordflow">if</span> (legacy) {
01128         BOOLEAN doCreate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01129 
01130         <span class="comment">//</span>
01131         <span class="comment">// Check if the the service for the device instance is a kernel mode</span>
01132         <span class="comment">// driver (even though it is a legacy device instance.) If yes, we will</span>
01133         <span class="comment">// create a PDO for it.</span>
01134         <span class="comment">//</span>
01135 
01136         <span class="keywordflow">if</span> (serviceName.Length) {
01137             status = <a class="code" href="../../d7/d0/pnpinit_8c.html#a6">IopGetServiceType</a>(&amp;serviceName, &amp;tmpValue1);
01138             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; tmpValue1 == SERVICE_KERNEL_DRIVER) {
01139                 doCreate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01140             }
01141         }
01142 
01143         <span class="keywordflow">if</span> (!doCreate)  {
01144 
01145             <span class="comment">//</span>
01146             <span class="comment">// We are not creating PDO for the device instance.  In this case we</span>
01147             <span class="comment">// need to register the device ourself for legacy compatibility.</span>
01148             <span class="comment">//</span>
01149             <span class="comment">// Note we will register this device to its driver even it is a</span>
01150             <span class="comment">// duplicate.  It will be deregistered when the real enumerated</span>
01151             <span class="comment">// device shows up.  We need to do this because the driver which</span>
01152             <span class="comment">// controls the device may be a boot driver.</span>
01153             <span class="comment">//</span>
01154 
01155             <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>( pUnicode, TRUE, NULL );
01156 
01157             <span class="comment">//</span>
01158             <span class="comment">// We did not create a PDO.  Release the service and ordinal names.</span>
01159             <span class="comment">//</span>
01160 
01161             <span class="keywordflow">if</span> (serviceKeyValueInfo) {
01162                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(serviceKeyValueInfo);
01163             }
01164 
01165             pUnicode-&gt;Length = savedLength;         <span class="comment">// Restore WorkName</span>
01166 
01167             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01168         }
01169     }
01170 
01171     <span class="keywordflow">if</span> (serviceKeyValueInfo) {
01172         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(serviceKeyValueInfo);
01173     }
01174 
01175     <span class="comment">//</span>
01176     <span class="comment">// Create madeup PDO and device node to represent the root device.</span>
01177     <span class="comment">//</span>
01178 
01179     <span class="comment">//</span>
01180     <span class="comment">// Madeup a name for the device object.</span>
01181     <span class="comment">//</span>
01182 
01183     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a>(&amp;tickCount);
01184 
01185     length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), L<span class="stringliteral">"\\Device\\%04u%x"</span>,
01186                         IopNumberDeviceNodes, tickCount.LowPart);
01187     deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
01188     deviceName.Length = length * <span class="keyword">sizeof</span>(WCHAR);
01189     deviceName.Buffer = buffer;
01190 
01191     <span class="comment">//</span>
01192     <span class="comment">// Create madeup PDO and device node to represent the root device.</span>
01193     <span class="comment">//</span>
01194 
01195     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( IoPnpDriverObject,
01196                              <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">IOPNP_DEVICE_EXTENSION</a>),
01197                              &amp;deviceName,
01198                              FILE_DEVICE_CONTROLLER,
01199                              0,
01200                              FALSE,
01201                              &amp;deviceObject );
01202 
01203     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01204 
01205         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>;
01206         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
01207 
01208         deviceNode = <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(deviceObject);
01209         <span class="keywordflow">if</span> (deviceNode) {
01210             PCM_RESOURCE_LIST cmResource;
01211 
01212             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>;
01213 
01214             <a class="code" href="../../d9/d0/pnpiop_8h.html#a250">IopInsertTreeDeviceNode</a>(IopRootDeviceNode, deviceNode);
01215 
01216             <span class="comment">//</span>
01217             <span class="comment">// Make a copy of the device instance path and save it in</span>
01218             <span class="comment">// device node.</span>
01219             <span class="comment">//</span>
01220 
01221             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(
01222                                 &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
01223                                 pUnicode,
01224                                 NULL
01225                                 );
01226             <span class="keywordflow">if</span> (legacy) {
01227                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> +
01228                                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
01229             } <span class="keywordflow">else</span> {
01230                 <span class="comment">//</span>
01231                 <span class="comment">// The device instance key exists.  We need to propagate the ConfigFlag</span>
01232                 <span class="comment">// to problem and StatusFlags</span>
01233                 <span class="comment">//</span>
01234 
01235                 deviceFlags = 0;
01236                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(KeyHandle,
01237                                                 REGSTR_VALUE_CONFIG_FLAGS,
01238                                                 &amp;keyValueInformation);
01239                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01240                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01241                         (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
01242                         deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01243                     }
01244                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01245                     <span class="keywordflow">if</span> (deviceFlags &amp; CONFIGFLAG_REINSTALL) {
01246                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_REINSTALL);
01247                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceFlags &amp; CONFIGFLAG_PARTIAL_LOG_CONF) {
01248                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_PARTIAL_LOG_CONF);
01249                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceFlags &amp; CONFIGFLAG_FAILEDINSTALL) {
01250                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_FAILED_INSTALL);
01251                     }
01252 
01253                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND || status == STATUS_OBJECT_PATH_NOT_FOUND) {
01254                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NOT_CONFIGURED);
01255                 }
01256             }
01257 
01258             <span class="keywordflow">if</span> (isDuplicate) {
01259                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a6">DNF_DUPLICATE</a>;
01260             }
01261 
01262             <span class="comment">//</span>
01263             <span class="comment">// If the key say don't assign any resource, honor it...</span>
01264             <span class="comment">//</span>
01265 
01266             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_NO_RESOURCE_AT_INIT);
01267             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
01268                                           unicodeName.Buffer,
01269                                           &amp;keyValueInformation
01270                                           );
01271 
01272             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01273                 <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_DWORD) {
01274                     <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG)) {
01275                         tmpValue1 = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01276 
01277                         <span class="keywordflow">if</span> (tmpValue1 != 0) {
01278                             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
01279                         }
01280                     }
01281                 }
01282                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01283             }
01284 
01285             <span class="comment">//</span>
01286             <span class="comment">// we need to set initial capabilities, like any other device</span>
01287             <span class="comment">// this will also handle hardware-disabled case</span>
01288             <span class="comment">//</span>
01289             <a class="code" href="../../d9/d1/pnpsubs_8c.html#a37">IopDeviceNodeCapabilitiesToRegistry</a>(deviceNode);
01290 
01291             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a101">IopDeviceNodeFlagsToCapabilities</a>(deviceNode)-&gt;HardwareDisabled &amp;&amp;
01292                 !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode,CM_PROB_NOT_CONFIGURED)) {
01293                 <span class="comment">//</span>
01294                 <span class="comment">// mark the node as hardware disabled, if no other problems</span>
01295                 <span class="comment">//</span>
01296 
01297                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(deviceNode);
01298                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_HARDWARE_DISABLED);
01299                 <span class="comment">//</span>
01300                 <span class="comment">// Issue a PNP REMOVE_DEVICE Irp so when we query resources</span>
01301                 <span class="comment">// we have those required after boot</span>
01302                 <span class="comment">//</span>
01303                 <span class="comment">//status = IopRemoveDevice (deviceNode-&gt;PhysicalDeviceObject, IRP_MN_REMOVE_DEVICE);</span>
01304                 <span class="comment">//ASSERT(NT_SUCCESS(status));</span>
01305             }
01306 
01307             <span class="comment">//</span>
01308             <span class="comment">// Install service for critical devices.</span>
01309             <span class="comment">// however don't do it if we found HardwareDisabled to be set</span>
01310             <span class="comment">//</span>
01311             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode) &amp;&amp;
01312                 !<a class="code" href="../../d9/d0/pnpiop_8h.html#a101">IopDeviceNodeFlagsToCapabilities</a>(deviceNode)-&gt;HardwareDisabled) {
01313                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a281">IopProcessCriticalDevice</a>(deviceNode);
01314             }
01315 
01316             <span class="comment">//</span>
01317             <span class="comment">// Set DNF_DISABLED flag if the device instance is disabled.</span>
01318             <span class="comment">//</span>
01319 
01320             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode) ||
01321                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_NOT_CONFIGURED) ||
01322                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_REINSTALL) ||
01323                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_FAILED_INSTALL) ||
01324                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_HARDWARE_DISABLED) ||
01325                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_PARTIAL_LOG_CONF));
01326 
01327             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED) &amp;&amp;
01328                 !<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_HARDWARE_DISABLED) &amp;&amp;
01329                 !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a20">IopIsDeviceInstanceEnabled</a>(KeyHandle, &amp;deviceNode-&gt;InstancePath, TRUE)) {
01330 
01331                 <span class="comment">//</span>
01332                 <span class="comment">// Normally IopIsDeviceInstanceEnabled would set</span>
01333                 <span class="comment">// CM_PROB_DISABLED as a side effect (if necessary).  But it</span>
01334                 <span class="comment">// relies on the DeviceReference already being in the registry.</span>
01335                 <span class="comment">// We don't write it out till later so just set the problem</span>
01336                 <span class="comment">// now.</span>
01337 
01338                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>( deviceNode, CM_PROB_DISABLED );
01339             }
01340 
01341             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a347">IopNotifySetupDeviceArrival</a>( deviceNode-&gt;PhysicalDeviceObject,
01342                                                   KeyHandle,
01343                                                   TRUE);
01344 
01345             configuredBySetup = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status);
01346 
01347             status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>( &amp;deviceNode-&gt;InstancePath,
01348                                            TRUE,
01349                                            &amp;deviceNode-&gt;ServiceName
01350                                            );
01351 
01352             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; configuredBySetup &amp;&amp;
01353                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_NOT_CONFIGURED)) {
01354 
01355                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(deviceNode);
01356             }
01357 
01358             <span class="comment">//</span>
01359             <span class="comment">// Write the addr of the device object to registry</span>
01360             <span class="comment">//</span>
01361 
01362             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
01363             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
01364                                              KeyHandle,
01365                                              &amp;unicodeName,
01366                                              KEY_ALL_ACCESS,
01367                                              REG_OPTION_VOLATILE,
01368                                              NULL
01369                                              );
01370             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01371 
01372                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_DEVICE_REFERENCE);
01373                 ZwSetValueKey( handle,
01374                                &amp;unicodeName,
01375                                TITLE_INDEX_VALUE,
01376                                REG_DWORD,
01377                                (PULONG_PTR)&amp;deviceObject,
01378                                <span class="keyword">sizeof</span>(ULONG_PTR)
01379                                );
01380                 ZwClose(handle);
01381             }
01382 
01383             <span class="comment">//</span>
01384             <span class="comment">// Add a reference for config magr</span>
01385             <span class="comment">//</span>
01386 
01387             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceObject);
01388 
01389             <span class="comment">//</span>
01390             <span class="comment">// Check if this device has BOOT config.  If yes, reserve them</span>
01391             <span class="comment">//</span>
01392 
01393             cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01394             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a26">IopGetDeviceResourcesFromRegistry</a> (
01395                                 deviceObject,
01396                                 QUERY_RESOURCE_LIST,
01397                                 REGISTRY_BOOT_CONFIG,
01398                                 &amp;cmResource,
01399                                 &amp;tmpValue1
01400                                 );
01401 
01402             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; cmResource) {
01403 
01404                 <span class="comment">//</span>
01405                 <span class="comment">// Still reserve boot config, even though the device is</span>
01406                 <span class="comment">// disabled.</span>
01407                 <span class="comment">//</span>
01408 
01409                 status = (*IopReserveResourcesRoutine)(
01410                                         <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>,
01411                                         deviceNode-&gt;PhysicalDeviceObject,
01412                                         cmResource);
01413                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01414                     deviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;
01415                 }
01416                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResource);
01417             }
01418 
01419             status = STATUS_SUCCESS;
01420 
01421             <span class="comment">//</span>
01422             <span class="comment">// Add a reference for query device relations</span>
01423             <span class="comment">//</span>
01424 
01425             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceObject);
01426 
01427         } <span class="keywordflow">else</span> {
01428             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
01429             deviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01430             status = STATUS_INSUFFICIENT_RESOURCES;
01431         }
01432     }
01433 
01434     pUnicode-&gt;Length = savedLength;                  <span class="comment">// Restore WorkName</span>
01435 
01436     <span class="comment">//</span>
01437     <span class="comment">// If we enumerated a root device, add it to the device list</span>
01438     <span class="comment">//</span>
01439 
01440     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01441         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceObject != NULL);
01442 
01443         enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o4">DeviceList</a>[enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>] = deviceObject;
01444         enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o3">DeviceCount</a>++;
01445 
01446         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01447     } <span class="keywordflow">else</span> {
01448         enumContext-&gt;<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html#o0">Status</a> = status;
01449         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01450     }
01451 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="pnpinit.c::IopInitializeDeviceKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopInitializeDeviceKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00819">819</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00913">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01690">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d0/pnpinit_8c.html#a2">PROOT_ENUMERATOR_CONTEXT</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00663">RtlAppendStringToString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">IopGetRootDevices()</a>.
<p>
<pre class="fragment"><div>00827                    :
00828 
00829     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a callback function <span class="keywordflow">for</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a243">IopApplyFunctionToSubKeys</a>.
00830     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> each subkey under HKLM\System\CCS\Enum\BusKey.
00831 
00832 Arguments:
00833 
00834     KeyHandle - Supplies a handle to <span class="keyword">this</span> key.
00835 
00836     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <span class="keyword">this</span> key.
00837 
00838     Context - points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">ROOT_ENUMERATOR_CONTEXT</a> structure.
00839 
00840 Returns:
00841 
00842     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to <span class="keywordflow">continue</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
00843     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to abort <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00844 
00845 --*/
00846 {
00847     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> length;
00848     PWSTR p;
00849     PUNICODE_STRING unicodeName = ((<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">PROOT_ENUMERATOR_CONTEXT</a>)Context)-&gt;KeyName;
00850 
00851     length = unicodeName-&gt;Length;
00852 
00853     p = unicodeName-&gt;Buffer;
00854     <span class="keywordflow">if</span> ( unicodeName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) != 0) {
00855         p += unicodeName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00856         *p = OBJ_NAME_PATH_SEPARATOR;
00857         unicodeName-&gt;Length += <span class="keyword">sizeof</span> (WCHAR);
00858     }
00859 
00860     <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)unicodeName, (PSTRING)KeyName);
00861 
00862     <span class="comment">//</span>
00863     <span class="comment">// Enumerate all subkeys under the current device key.</span>
00864     <span class="comment">//</span>
00865 
00866     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a12">IopApplyFunctionToSubKeys</a>(KeyHandle,
00867                               NULL,
00868                               KEY_ALL_ACCESS,
00869                               FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS,
00870                               IopInitializeDeviceInstanceKey,
00871                               Context
00872                               );
00873     unicodeName-&gt;Length = length;
00874 
00875     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(((<a class="code" href="../../d8/d4/struct__ROOT__ENUMERATOR__CONTEXT.html">PROOT_ENUMERATOR_CONTEXT</a>)Context)-&gt;Status);
00876 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pnpinit.c::IopInitializePlugPlayServices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopInitializePlugPlayServices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Phase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">93</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a186">BUS_TYPE_GUID_LIST</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00175">CmRegistryMachineSystemCurrentControlSet</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01071">IoCreateDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01264">IoDeleteDriver()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00056">IopAllocateDeviceNode()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a369">IopBusNumberInitialize()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00161">IopBusTypeGuidList</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01510">IopDetermineDefaultInterfaceType()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00074">IopDeviceTreeLock</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a368">IopDmaInitialize()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00072">IopDockDeviceCount</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00071">IopDockDeviceListHead</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00073">IopDockDeviceListLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a346">IopInitializePlugPlayNotification()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00042">IopInitReservedResourceList</a>, <a class="el" href="../../d1/d1/pnpirq_8c.html#a1">IopIrqInitialize()</a>, <a class="el" href="../../d3/d1/pnpmemio_8c.html#a21">IopMemInitialize()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a136">IOPNP_DEVICE_EXTENSION</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00037">IoPnpDriverObject</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00183">IopPendingEjects</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00188">IopPendingSurpriseRemovals</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00636">IopPnPDriverEntry()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00104">IopPnpEnumerationRequestList</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00038">IopPnpScratchBuffer1</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00039">IopPnpScratchBuffer2</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00068">IopPnPSpinLock</a>, <a class="el" href="../../d4/d0/pnpmemio_8c-source.html#l00349">IopPortInitialize()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00207">IopRequestDeviceAction()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00148">IopReserveResourcesRoutine</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00193">IopWarmEjectLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00198">IopWarmEjectPdo</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l02420">_BUS_TYPE_GUID_LIST::Lock</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01600">MapperConstructRootEnumTree()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01549">MapperFreeList()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l02060">MapperPhantomizeDetectedComPorts()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l01009">MapperProcessFirmwareTree()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00086">PiEnumerationLock</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00080">PiEventQueueEmpty</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00893">PNP_DETECTION_ENABLED_DEFAULT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00900">PNP_LARGE_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l03008">PnPBiosMapper()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00116">PnPDetectionEnabled</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00110">PnPInitialized</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a163">PpInitializeNotification()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a391a225">ReenumerateRootDevices</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01666">RtlAddAccessAllowedAceEx()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02066">RtlValidSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01628">SeLocalSystemSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01609">SeWorldSid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>00100                    :
00101 
00102     This routine initializes kernel mode Plug and Play services.
00103 
00104 Arguments:
00105 
00106     LoaderBlock - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LoaderBlock passed in from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00107         OS Loader.
00108 
00109 Returns:
00110 
00111     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code <span class="keywordflow">for</span> sucess or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00112 
00113 --*/
00114 {
00115     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00116     HANDLE hTreeHandle, parentHandle, handle, hCurrentControlSet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00117     UNICODE_STRING unicodeName;
00118     PKEY_VALUE_FULL_INFORMATION detectionInfo;
00119     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00120     ULONG disposition;
00121 
00122     <span class="keywordflow">if</span> (Phase == 0) {
00123         <a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00124 
00125         <span class="comment">//</span>
00126         <span class="comment">// Allocate two one-page scratch buffers to be used by our</span>
00127         <span class="comment">// initialization code.  This avoids constant pool allocations.</span>
00128         <span class="comment">//</span>
00129 
00130         <a class="code" href="../../d1/d0/pnpdata_8c.html#a0">IopPnpScratchBuffer1</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, PNP_LARGE_SCRATCH_BUFFER_SIZE);
00131         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a0">IopPnpScratchBuffer1</a>) {
00132             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00133         }
00134         <a class="code" href="../../d1/d0/pnpdata_8c.html#a1">IopPnpScratchBuffer2</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, PNP_LARGE_SCRATCH_BUFFER_SIZE);
00135         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a1">IopPnpScratchBuffer2</a>) {
00136             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer1);
00137             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00138         }
00139 
00140         <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00141 
00142         <a class="code" href="../../d1/d0/pnpdata_8c.html#a20">IopReserveResourcesRoutine</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a334">IopReserveBootResources</a>;
00143 
00144         <span class="comment">//</span>
00145         <span class="comment">// Determine the PnpDefaultInterfaceType.  For root enumerated devices if the Interface</span>
00146         <span class="comment">// type of their resource list or resource requirements list are undefined.  We will use</span>
00147         <span class="comment">// the default type instead.</span>
00148         <span class="comment">//</span>
00149 
00150         <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a> = <a class="code" href="../../d7/d0/pnpinit_8c.html#a7">IopDetermineDefaultInterfaceType</a>();
00151 
00152         <span class="comment">//</span>
00153         <span class="comment">// Initialize root arbiters</span>
00154         <span class="comment">//</span>
00155 
00156         status = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a25">IopPortInitialize</a>();
00157         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00158             <span class="keywordflow">goto</span> init_Exit0;
00159         }
00160 
00161         status = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a21">IopMemInitialize</a>();
00162         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00163             <span class="keywordflow">goto</span> init_Exit0;
00164         }
00165 
00166         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a368">IopDmaInitialize</a>();
00167         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00168             <span class="keywordflow">goto</span> init_Exit0;
00169         }
00170 
00171         status = <a class="code" href="../../d1/d1/pnpirq_8c.html#a1">IopIrqInitialize</a>();
00172         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00173             <span class="keywordflow">goto</span> init_Exit0;
00174         }
00175 
00176         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a369">IopBusNumberInitialize</a>();
00177         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00178             <span class="keywordflow">goto</span> init_Exit0;
00179         }
00180 
00181         <span class="comment">//</span>
00182         <span class="comment">// Next open/create System\CurrentControlSet\Enum\Root key.</span>
00183         <span class="comment">//</span>
00184 
00185         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hCurrentControlSet,
00186                                        NULL,
00187                                        &amp;CmRegistryMachineSystemCurrentControlSet,
00188                                        KEY_ALL_ACCESS
00189                                        );
00190         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00191             hCurrentControlSet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00192             <span class="keywordflow">goto</span> init_Exit0;
00193         }
00194 
00195         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_ENUM);
00196         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00197                                          hCurrentControlSet,
00198                                          &amp;unicodeName,
00199                                          KEY_ALL_ACCESS,
00200                                          REG_OPTION_NON_VOLATILE,
00201                                          &amp;disposition
00202                                          );
00203         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00204             <span class="keywordflow">goto</span> init_Exit0;
00205         }
00206 
00207         <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
00208             SECURITY_DESCRIPTOR     newSD;
00209             PACL                    newDacl;
00210             ULONG                   sizeDacl;
00211 
00212             status = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( &amp;newSD,
00213                                                   SECURITY_DESCRIPTOR_REVISION );
00214             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00215 
00216             <span class="comment">//</span>
00217             <span class="comment">// calculate the size of the new DACL</span>
00218             <span class="comment">//</span>
00219             sizeDacl = <span class="keyword">sizeof</span>(ACL);
00220             sizeDacl += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) + <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(SeLocalSystemSid) - <span class="keyword">sizeof</span>(ULONG);
00221 
00222 <span class="preprocessor">#if ALLOW_WORLD_READ_OF_ENUM</span>
00223 <span class="preprocessor"></span>            sizeDacl += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) + <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(SeWorldSid) - <span class="keyword">sizeof</span>(ULONG);
00224 <span class="preprocessor">#endif</span>
00225 <span class="preprocessor"></span>
00226             <span class="comment">//</span>
00227             <span class="comment">// create and initialize the new DACL</span>
00228             <span class="comment">//</span>
00229             newDacl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, sizeDacl);
00230 
00231             <span class="keywordflow">if</span> (newDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00232 
00233                 status = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(newDacl, sizeDacl, ACL_REVISION);
00234 
00235                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00236 
00237                 <span class="comment">//</span>
00238                 <span class="comment">// Add just the local system full control ace to this new DACL</span>
00239                 <span class="comment">//</span>
00240                 status = <a class="code" href="../../d2/d4/acledit_8c.html#a17">RtlAddAccessAllowedAceEx</a>( newDacl,
00241                                                    ACL_REVISION,
00242                                                    CONTAINER_INHERIT_ACE,
00243                                                    KEY_ALL_ACCESS,
00244                                                    SeLocalSystemSid
00245                                                    );
00246                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00247 
00248 <span class="preprocessor">#if ALLOW_WORLD_READ_OF_ENUM</span>
00249 <span class="preprocessor"></span>                <span class="comment">//</span>
00250                 <span class="comment">// Add just the local system full control ace to this new DACL</span>
00251                 <span class="comment">//</span>
00252                 status = <a class="code" href="../../d2/d4/acledit_8c.html#a17">RtlAddAccessAllowedAceEx</a>( newDacl,
00253                                                    ACL_REVISION,
00254                                                    CONTAINER_INHERIT_ACE,
00255                                                    KEY_READ,
00256                                                    SeWorldSid
00257                                                    );
00258                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00259 
00260 <span class="preprocessor">#endif</span>
00261 <span class="preprocessor"></span>                <span class="comment">//</span>
00262                 <span class="comment">// Set the new DACL in the absolute security descriptor</span>
00263                 <span class="comment">//</span>
00264                 status = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR) &amp;newSD,
00265                                                        TRUE,
00266                                                        newDacl,
00267                                                        FALSE
00268                                                        );
00269 
00270                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00271 
00272                 <span class="comment">//</span>
00273                 <span class="comment">// validate the new security descriptor</span>
00274                 <span class="comment">//</span>
00275                 status = <a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a>(&amp;newSD);
00276 
00277                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00278 
00279                 status = ZwSetSecurityObject( handle,
00280                                               DACL_SECURITY_INFORMATION,
00281                                               &amp;newSD
00282                                               );
00283                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00284 
00285                     KdPrint((<span class="stringliteral">"IopInitializePlugPlayServices: ZwSetSecurityObject on Enum key failed, status = %8.8X\n"</span>, status));
00286                 }
00287 
00288                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newDacl);
00289             } <span class="keywordflow">else</span> {
00290 
00291                 KdPrint((<span class="stringliteral">"IopInitializePlugPlayServices: ExAllocatePool failed allocating DACL for Enum key\n"</span>));
00292             }
00293         }
00294 
00295         parentHandle = handle;
00296         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_ROOTENUM);
00297         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00298                                          parentHandle,
00299                                          &amp;unicodeName,
00300                                          KEY_ALL_ACCESS,
00301                                          REG_OPTION_NON_VOLATILE,
00302                                          NULL
00303                                          );
00304         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(parentHandle);
00305         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00306             <span class="keywordflow">goto</span> init_Exit0;
00307         }
00308         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">// Create the registry entry for the root of the hardware tree (HTREE\ROOT\0).</span>
00312         <span class="comment">//</span>
00313 
00314         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
00315                                        NULL,
00316                                        &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
00317                                        KEY_ALL_ACCESS
00318                                        );
00319         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00320             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ROOT_DEVNODE);
00321             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hTreeHandle,
00322                                              handle,
00323                                              &amp;unicodeName,
00324                                              KEY_ALL_ACCESS,
00325                                              REG_OPTION_NON_VOLATILE,
00326                                              NULL
00327                                              );
00328             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00329             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00330                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hTreeHandle);
00331             }
00332         }
00333 
00334         <span class="comment">//</span>
00335         <span class="comment">// Before creating device node tree, we need to initialize the device</span>
00336         <span class="comment">// tree lock.</span>
00337         <span class="comment">//</span>
00338 
00339         InitializeListHead(&amp;IopPendingEjects);
00340         InitializeListHead(&amp;IopPendingSurpriseRemovals);
00341         InitializeListHead(&amp;IopPnpEnumerationRequestList);
00342         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;IopDeviceTreeLock);
00343         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;PiEventQueueEmpty, NotificationEvent, TRUE );
00344         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;PiEnumerationLock, NotificationEvent, TRUE );
00345         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;IopPnPSpinLock);
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">// Initialize the list of dock devices, and its lock.</span>
00349         <span class="comment">//</span>
00350         InitializeListHead(&amp;IopDockDeviceListHead);
00351         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;IopDockDeviceListLock);
00352         <a class="code" href="../../d9/d0/dockhwp_8c.html#a2">IopDockDeviceCount</a> = 0;
00353 
00354         <span class="comment">//</span>
00355         <span class="comment">// Initialize warm docking variables.</span>
00356         <span class="comment">//</span>
00357         <a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00358         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;IopWarmEjectLock, SynchronizationEvent, TRUE );
00359 
00360         <span class="comment">//</span>
00361         <span class="comment">// Create a PnP manager's driver object to own all the detected PDOs.</span>
00362         <span class="comment">//</span>
00363 
00364         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, PNPMGR_STR_PNP_DRIVER);
00365         status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a76">IoCreateDriver</a> (&amp;unicodeName, IopPnPDriverEntry);
00366         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00367 
00368             <span class="comment">//</span>
00369             <span class="comment">// Create empty device node tree, i.e., only contains only root device node</span>
00370             <span class="comment">//     (No need to initialize Parent, Child and Sibling links.)</span>
00371 
00372             status = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( IoPnpDriverObject,
00373                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">IOPNP_DEVICE_EXTENSION</a>),
00374                                      NULL,
00375                                      FILE_DEVICE_CONTROLLER,
00376                                      0,
00377                                      FALSE,
00378                                      &amp;deviceObject );
00379 
00380             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00381                 deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>;
00382                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(deviceObject);
00383 
00384                 <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
00385                     <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
00386                     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a77">IoDeleteDriver</a>(IoPnpDriverObject);
00387                     status = STATUS_INSUFFICIENT_RESOURCES;
00388                 } <span class="keywordflow">else</span> {
00389                     <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a> +
00390                                                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a> +
00391                                                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>;
00392 
00393                     <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
00394                                                                              <span class="keyword">sizeof</span>(REGSTR_VAL_ROOT_DEVNODE));
00395 
00396                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00397                         <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.MaximumLength = <span class="keyword">sizeof</span>(REGSTR_VAL_ROOT_DEVNODE);
00398                         <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length = <span class="keyword">sizeof</span>(REGSTR_VAL_ROOT_DEVNODE) - <span class="keyword">sizeof</span>(WCHAR);
00399 
00400                         RtlMoveMemory( <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer,
00401                                        REGSTR_VAL_ROOT_DEVNODE,
00402                                        <span class="keyword">sizeof</span>(REGSTR_VAL_ROOT_DEVNODE));
00403                     } <span class="keywordflow">else</span> {
00404                         <span class="comment">//</span>
00405                         <span class="comment">// BUGBUG - Need to bugcheck here</span>
00406                         <span class="comment">//</span>
00407 
00408                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00409                     }
00410                 }
00411             }
00412         }
00413 
00414         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00415             <span class="keywordflow">goto</span> init_Exit0;
00416         }
00417 
00418         <span class="comment">//</span>
00419         <span class="comment">// Initialize PnPDetectionEnabled flag to determine should Wdm driver be loaded</span>
00420         <span class="comment">// to run detection code.</span>
00421         <span class="comment">// This is stored as a REG_DWORD under HKLM\System\CurrentControlSet\Control\Pnp\DetectionEnabled</span>
00422         <span class="comment">// if it is not present then PNP_DETECTION_ENABLED_DEFAULT is used</span>
00423         <span class="comment">//</span>
00424 
00425         <span class="comment">//</span>
00426         <span class="comment">// Open HKLM\System\CurrentControlSet\Control\Pnp</span>
00427         <span class="comment">//</span>
00428 
00429         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_PATH_CONTROL_PNP);
00430         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00431                                          hCurrentControlSet,
00432                                          &amp;unicodeName,
00433                                          KEY_ALL_ACCESS,
00434                                          REG_OPTION_NON_VOLATILE,
00435                                          NULL
00436                                          );
00437         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00438             <span class="keywordflow">goto</span> init_Exit0;
00439         }
00440 
00441         <span class="comment">//</span>
00442         <span class="comment">// Get the value of DetectionEnabled key if it exisit otherwise use the default</span>
00443         <span class="comment">//</span>
00444 
00445         <a class="code" href="../../d1/d0/pnpdata_8c.html#a15">PnPDetectionEnabled</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a85">PNP_DETECTION_ENABLED_DEFAULT</a>;
00446 
00447         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00448                                      REGSTR_VALUE_DETECTION_ENABLED,
00449                                      &amp;detectionInfo
00450                                      );
00451 
00452         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00453 
00454             <span class="keywordflow">if</span> (detectionInfo-&gt;Type == REG_DWORD &amp;&amp; detectionInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
00455                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a15">PnPDetectionEnabled</a> = (BOOLEAN) *(<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(detectionInfo));
00456             }
00457 
00458             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(detectionInfo);
00459         }
00460 
00461         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00462 
00463         <span class="comment">//</span>
00464         <span class="comment">// Initialize the kernel mode pnp notification system</span>
00465         <span class="comment">//</span>
00466 
00467         status = <a class="code" href="../../d6/d9/pnp_8h.html#a163">PpInitializeNotification</a>();
00468         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00469             <span class="keywordflow">goto</span> init_Exit0;
00470         }
00471 
00472         <a class="code" href="../../d9/d0/pnpiop_8h.html#a346">IopInitializePlugPlayNotification</a>();
00473 
00474         <span class="comment">//</span>
00475         <span class="comment">// Initialize table for holding bus type guid list.</span>
00476         <span class="comment">//</span>
00477 
00478         <a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">BUS_TYPE_GUID_LIST</a>));
00479         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00480             status = STATUS_INSUFFICIENT_RESOURCES;
00481             <span class="keywordflow">goto</span> init_Exit0;
00482         }
00483 
00484         RtlZeroMemory( IopBusTypeGuidList, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html">BUS_TYPE_GUID_LIST</a>));
00485 
00486         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o1">Lock</a>);
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Enumerate the ROOT bus synchronously.</span>
00490         <span class="comment">//</span>
00491 
00492         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>, ReenumerateRootDevices, NULL, NULL);
00493 
00494 init_Exit0:
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">// If we managed to open the Current Control Set close it</span>
00498         <span class="comment">//</span>
00499 
00500         <span class="keywordflow">if</span>(hCurrentControlSet) {
00501             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentControlSet);
00502         }
00503 
00504         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00505             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer1);
00506             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer2);
00507         }
00508 
00509     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Phase == 1) {
00510 
00511         BOOLEAN legacySerialPortMappingOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// Next open/create System\CurrentControlSet\Enum\Root key.</span>
00515         <span class="comment">//</span>
00516 
00517         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hCurrentControlSet,
00518                                        NULL,
00519                                        &amp;CmRegistryMachineSystemCurrentControlSet,
00520                                        KEY_ALL_ACCESS
00521                                        );
00522         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00523             hCurrentControlSet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00524             <span class="keywordflow">goto</span> init_Exit1;
00525         }
00526 
00527         <span class="comment">//</span>
00528         <span class="comment">// Open HKLM\System\CurrentControlSet\Control\Pnp</span>
00529         <span class="comment">//</span>
00530 
00531         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_PATH_CONTROL_PNP);
00532         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00533                                          hCurrentControlSet,
00534                                          &amp;unicodeName,
00535                                          KEY_ALL_ACCESS,
00536                                          REG_OPTION_NON_VOLATILE,
00537                                          NULL
00538                                          );
00539         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00540             <span class="keywordflow">goto</span> init_Exit1;
00541         }
00542 
00543         <span class="comment">//</span>
00544         <span class="comment">// Check the "DisableFirmwareMapper" value entry to see whether we</span>
00545         <span class="comment">// should skip mapping ntdetect/firmware reported devices (except for</span>
00546         <span class="comment">// COM ports, which we always map).</span>
00547         <span class="comment">//</span>
00548 
00549         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00550                                      REGSTR_VALUE_DISABLE_FIRMWARE_MAPPER,
00551                                      &amp;detectionInfo
00552                                      );
00553 
00554         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00555 
00556             <span class="keywordflow">if</span> (detectionInfo-&gt;Type == REG_DWORD &amp;&amp; detectionInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
00557                 legacySerialPortMappingOnly = (BOOLEAN) *(<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(detectionInfo));
00558             }
00559 
00560             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(detectionInfo);
00561 
00562         }
00563         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(handle);
00564 
00565         <span class="comment">//</span>
00566         <span class="comment">// Collect the necessary firmware tree information.</span>
00567         <span class="comment">//</span>
00568 
00569         <a class="code" href="../../d9/d0/pnpiop_8h.html#a338">MapperProcessFirmwareTree</a>(legacySerialPortMappingOnly);
00570 
00571         <span class="comment">//</span>
00572         <span class="comment">// Map this into the root enumerator tree</span>
00573         <span class="comment">//</span>
00574 
00575         <a class="code" href="../../d9/d0/pnpiop_8h.html#a339">MapperConstructRootEnumTree</a>(legacySerialPortMappingOnly);
00576 
00577 <span class="preprocessor">#if i386</span>
00578 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!legacySerialPortMappingOnly) {
00579 
00580             <span class="comment">//</span>
00581             <span class="comment">// Now do the PnP BIOS enumerated devnodes.</span>
00582             <span class="comment">//</span>
00583             <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d2/d1/pnpmap_8c.html#a58">PnPBiosMapper</a>(VOID);
00584 
00585             status = <a class="code" href="../../d2/d1/pnpmap_8c.html#a58">PnPBiosMapper</a>();
00586 
00587             <span class="comment">//</span>
00588             <span class="comment">// If the previous call succeeds, we have a PNPBios, turn any newly</span>
00589             <span class="comment">// created ntdetect COM ports into phantoms</span>
00590             <span class="comment">//</span>
00591             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00592                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a342">MapperPhantomizeDetectedComPorts</a>();
00593             }
00594         }
00595         <a class="code" href="../../d9/d0/pnpiop_8h.html#a341">EisaBuildEisaDeviceNode</a>();
00596 <span class="preprocessor">#endif</span>
00597 <span class="preprocessor"></span>
00598         <span class="comment">//</span>
00599         <span class="comment">// We're done with the firmware mapper device list.</span>
00600         <span class="comment">//</span>
00601 
00602         <a class="code" href="../../d9/d0/pnpiop_8h.html#a340">MapperFreeList</a>();
00603 
00604 
00605         <span class="comment">//</span>
00606         <span class="comment">// Enumerate the ROOT bus synchronously.</span>
00607         <span class="comment">//</span>
00608 
00609         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>, ReenumerateRootDevices, NULL, NULL);
00610 
00611 init_Exit1:
00612 
00613         <span class="comment">//</span>
00614         <span class="comment">// If we managed to open the Current Control Set close it</span>
00615         <span class="comment">//</span>
00616 
00617         <span class="keywordflow">if</span>(hCurrentControlSet) {
00618             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hCurrentControlSet);
00619         }
00620 
00621         <span class="comment">//</span>
00622         <span class="comment">// Free our scratch buffers and exit.</span>
00623         <span class="comment">//</span>
00624 
00625         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer1);
00626         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopPnpScratchBuffer2);
00627         status = STATUS_SUCCESS;
00628     } <span class="keywordflow">else</span> {
00629         status = STATUS_INVALID_PARAMETER_1;
00630     }
00631 
00632     <span class="keywordflow">return</span> status;
00633 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="pnpinit.c::IopIsFirmwareMapperDevicePresent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsFirmwareMapperDevicePresent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01572">1572</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>.
<p>
<pre class="fragment"><div>01578                    :
01579 
01580     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created by FirmwareMapper.
01581     If Yes, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> further checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present in <span class="keyword">this</span>
01582     boot.
01583 
01584 Parameters:
01585 
01586     KeyHandle - Specifies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key to be checked.
01587 
01588 Return Value:
01589 
01590     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN vaStatus code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
01591 
01592 --*/
01593 {
01594     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01595     HANDLE handle;
01596     UNICODE_STRING unicodeName;
01597     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01598     ULONG tmp = 0;
01599 
01600     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01601 
01602     <span class="comment">//</span>
01603     <span class="comment">// First check to see if this device instance key is a firmware-created one</span>
01604     <span class="comment">//</span>
01605 
01606     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (KeyHandle,
01607                                   REGSTR_VAL_FIRMWAREIDENTIFIED,
01608                                   &amp;keyValueInformation);
01609     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01610         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01611             (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG))) {
01612 
01613             tmp = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01614         }
01615         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01616     }
01617     <span class="keywordflow">if</span> (tmp == 0) {
01618         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01619     }
01620 
01621     <span class="comment">//</span>
01622     <span class="comment">// Make sure the device is present.</span>
01623     <span class="comment">//</span>
01624 
01625     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
01626     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
01627                                    KeyHandle,
01628                                    &amp;unicodeName,
01629                                    KEY_READ
01630                                    );
01631     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01632         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01633     }
01634 
01635     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
01636                                   REGSTR_VAL_FIRMWAREMEMBER,
01637                                   &amp;keyValueInformation);
01638     ZwClose(handle);
01639     tmp = 0;
01640 
01641     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01642         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01643             (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG))) {
01644 
01645             tmp = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01646         }
01647         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01648     }
01649     <span class="keywordflow">if</span> (!tmp) {
01650         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01651     } <span class="keywordflow">else</span> {
01652         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01653     }
01654 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="pnpinit.c::IopPnPDriverEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPnPDriverEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RegistryPath</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00636">636</a> of file <a class="el" href="../../d8/d9/pnpinit_8c-source.html">pnpinit.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01323">_DRIVER_EXTENSION::AddDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00037">IoPnpDriverObject</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00419">IopPnPAddDevice()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00648">IopPnPDispatch()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00570">IopPowerDispatch()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l00590">PDRIVER_ADD_DEVICE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>00643                    :
00644 
00645     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback function when we call <a class="code" href="../../d0/d5/io_8h.html#a567">IoCreateDriver</a> to create a
00646     PnP Driver Object.  In <span class="keyword">this</span> function, we need to remember <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DriverObject.
00647 
00648 Arguments:
00649 
00650     DriverObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object created by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00651 
00652     RegistryPath - <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00653 
00654 Return Value:
00655 
00656    STATUS_SUCCESS
00657 
00658 --*/
00659 
00660 {
00661     <span class="comment">//</span>
00662     <span class="comment">// File the pointer to our driver object away</span>
00663     <span class="comment">//</span>
00664 
00665     <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a> = DriverObject;
00666 
00667     <span class="comment">//</span>
00668     <span class="comment">// Fill in the driver object</span>
00669     <span class="comment">//</span>
00670 
00671     DriverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o1">AddDevice</a> = (<a class="code" href="../../d0/d5/io_8h.html#a290">PDRIVER_ADD_DEVICE</a>)<a class="code" href="../../d2/d0/pnpdd_8c.html#a12">IopPnPAddDevice</a>;
00672     DriverObject-&gt;MajorFunction[ <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a> ] = <a class="code" href="../../d2/d0/pnpdd_8c.html#a17">IopPnPDispatch</a>;
00673     DriverObject-&gt;MajorFunction[ <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a> ] = <a class="code" href="../../d2/d0/pnpdd_8c.html#a16">IopPowerDispatch</a>;
00674 
00675     <span class="keywordflow">return</span> STATUS_SUCCESS;
00676 
00677 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
