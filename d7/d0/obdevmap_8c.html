<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obdevmap.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obdevmap.c File Reference</h1><code>#include "<a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>"</code><br>

<p>
<a href="../../d8/d9/obdevmap_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/obdevmap_8c.html#a0">ObSetDeviceMap</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess OPTIONAL, IN HANDLE <a class="el" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/obdevmap_8c.html#a1">ObQueryDeviceMapInformation</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess OPTIONAL, OUT PPROCESS_DEVICEMAP_INFORMATION DeviceMapInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/obdevmap_8c.html#a2">ObInheritDeviceMap</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ParentProcess OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="obdevmap.c::ObDereferenceDeviceMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObDereferenceDeviceMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00416">416</a> of file <a class="el" href="../../d8/d9/obdevmap_8c-source.html">obdevmap.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00213">_OBJECT_DIRECTORY::DeviceMap</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00244">_DEVICE_MAP::DosDevicesDirectory</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00098">ObpDeviceMapLock</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00243">_DEVICE_MAP::ReferenceCount</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00030">ObSetDeviceMap()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>00422                    :
00423 
00424     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called at process tear down time to decrement <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00425     reference count on a device map.  When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count goes to
00426     zero, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> means no more processes are <span class="keyword">using</span> <span class="keyword">this</span>, so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be freed
00427     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated object directory can be released.
00428 
00429 Arguments:
00430 
00431     Process - Process being destroyed.
00432 
00433 Return Value:
00434 
00435     None.
00436 
00437 --*/
00438 
00439 {
00440     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap;
00441     KIRQL OldIrql;
00442 
00443     <span class="comment">//</span>
00444     <span class="comment">//  Grab the device map and then we only have work to do</span>
00445     <span class="comment">//  it there is one</span>
00446     <span class="comment">//</span>
00447 
00448     DeviceMap = Process-&gt;DeviceMap;
00449 
00450     <span class="keywordflow">if</span> (DeviceMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00451 
00452         <span class="comment">//</span>
00453         <span class="comment">//  To dereference the device map we need to null out the</span>
00454         <span class="comment">//  processes device map pointer, and decrement its ref count</span>
00455         <span class="comment">//  If the ref count goes to zero we can free up the memory</span>
00456         <span class="comment">//  and dereference the dos device directory object</span>
00457         <span class="comment">//</span>
00458 
00459         ExAcquireSpinLock( &amp;ObpDeviceMapLock, &amp;OldIrql );
00460 
00461         Process-&gt;DeviceMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00462         DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a>--;
00463 
00464         <span class="keywordflow">if</span> (DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a> == 0) {
00465 
00466             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a>-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467 
00468             ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );
00469 
00470             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a> );
00471 
00472             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DeviceMap );
00473 
00474         } <span class="keywordflow">else</span> {
00475 
00476             ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );
00477         }
00478     }
00479 
00480     <span class="comment">//</span>
00481     <span class="comment">//  And return to our caller</span>
00482     <span class="comment">//</span>
00483 
00484     <span class="keywordflow">return</span>;
00485 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="obdevmap.c::ObInheritDeviceMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObInheritDeviceMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ParentProcess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00343">343</a> of file <a class="el" href="../../d8/d9/obdevmap_8c-source.html">obdevmap.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00098">ObpDeviceMapLock</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00249">ObSystemDeviceMap</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00243">_DEVICE_MAP::ReferenceCount</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00350                    :
00351 
00352     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called at process initialization time to inherit <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00353     device map <span class="keywordflow">for</span> a process.  If no parent process, then inherits from
00354     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system device map.
00355 
00356 Arguments:
00357 
00358     NewProcess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process being initialized that needs a <span class="keyword">new</span>
00359         dos device map
00360 
00361     ParentProcess - - Optionally specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent process whose device
00362         map we inherit.  This process <span class="keywordflow">if</span> specified must have a device map
00363 
00364 Return Value:
00365 
00366     None.
00367 
00368 --*/
00369 
00370 {
00371     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap;
00372     KIRQL OldIrql;
00373 
00374     <span class="comment">//</span>
00375     <span class="comment">//  If we are called with a parent process then grab its device map</span>
00376     <span class="comment">//  otherwise grab the system wide device map and check that is does</span>
00377     <span class="comment">//  exist</span>
00378     <span class="comment">//</span>
00379 
00380     <span class="keywordflow">if</span> (ParentProcess) {
00381 
00382         DeviceMap = ParentProcess-&gt;DeviceMap;
00383 
00384     } <span class="keywordflow">else</span> {
00385 
00386         <span class="comment">//</span>
00387         <span class="comment">//  Note: WindowStation guys may want a callout here to get the</span>
00388         <span class="comment">//  device map to use for this case.</span>
00389         <span class="comment">//</span>
00390 
00391         DeviceMap = <a class="code" href="../../d4/d0/ob_8h.html#a41">ObSystemDeviceMap</a>;
00392 
00393         <span class="keywordflow">if</span> (DeviceMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00394 
00395             <span class="keywordflow">return</span>;
00396         }
00397     }
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">//  With the device map bumps its reference count and add it to the</span>
00401     <span class="comment">//  new process</span>
00402     <span class="comment">//</span>
00403 
00404     ExAcquireSpinLock( &amp;ObpDeviceMapLock, &amp;OldIrql );
00405 
00406     DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a>++;
00407     NewProcess-&gt;DeviceMap = DeviceMap;
00408 
00409     ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );
00410 
00411     <span class="keywordflow">return</span>;
00412 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="obdevmap.c::ObQueryDeviceMapInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObQueryDeviceMapInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPROCESS_DEVICEMAP_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceMapInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00236">236</a> of file <a class="el" href="../../d8/d9/obdevmap_8c-source.html">obdevmap.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00245">_DEVICE_MAP::DriveMap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00098">ObpDeviceMapLock</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00249">ObSystemDeviceMap</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>.
<p>
<pre class="fragment"><div>00243                    :
00244 
00245     This function queries information from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device map associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00246     specified process.  The returned information contains a bit map indicating
00247     which drive letters are defined in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated object directory, along
00248     with an array of drive types that give <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of each drive letter.
00249 
00250 Arguments:
00251 
00252     TargetProcess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process to retreive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device map
00253         from.  If not specified then we <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global <span class="keywordflow">default</span> device map
00254 
00255     DeviceMapInformation - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> location where to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results.
00256 
00257 Return Value:
00258 
00259     Returns one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following status codes:
00260 
00261         STATUS_SUCCESS - normal, successful completion.
00262 
00263         STATUS_END_OF_FILE - The specified process was not associated with
00264             a device map.
00265 
00266         STATUS_ACCESS_VIOLATION - The DeviceMapInformation buffer pointer
00267             value specified an invalid address.
00268 
00269 --*/
00270 
00271 {
00272     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00273     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap;
00274     KIRQL OldIrql;
00275     PROCESS_DEVICEMAP_INFORMATION LocalMapInformation;
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">//  Check if the caller gave us a target process and if not then use</span>
00279     <span class="comment">//  the globally defined one</span>
00280     <span class="comment">//</span>
00281 
00282     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( TargetProcess )) {
00283 
00284         DeviceMap = TargetProcess-&gt;DeviceMap;
00285 
00286     } <span class="keywordflow">else</span> {
00287 
00288         DeviceMap = <a class="code" href="../../d4/d0/ob_8h.html#a41">ObSystemDeviceMap</a>;
00289     }
00290 
00291     <span class="comment">//</span>
00292     <span class="comment">//  If we do not have a device map then we'll return an error otherwise</span>
00293     <span class="comment">//  we simply copy over the device map structure (bitmap and drive type</span>
00294     <span class="comment">//  array) into the output buffer</span>
00295     <span class="comment">//</span>
00296 
00297     <span class="keywordflow">if</span> (DeviceMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00298 
00299         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_END_OF_FILE;
00300 
00301     } <span class="keywordflow">else</span> {
00302 
00303         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00304 
00305         <span class="comment">//</span>
00306         <span class="comment">//  First, while using a spinlock to protect the device map from</span>
00307         <span class="comment">//  going away we will make local copy of the information.</span>
00308         <span class="comment">//</span>
00309 
00310         ExAcquireSpinLock( &amp;ObpDeviceMapLock, &amp;OldIrql );
00311 
00312         RtlMoveMemory( &amp;LocalMapInformation.Query,
00313                        &amp;DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o2">DriveMap</a>,
00314                        <span class="keyword">sizeof</span>( DeviceMapInformation-&gt;Query ));
00315 
00316         ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">//  Now we can copy the information to the caller buffer using</span>
00320         <span class="comment">//  a try-except to guard against the output buffer changing.</span>
00321         <span class="comment">//  Note that the caller must have already probed the buffer</span>
00322         <span class="comment">//  for write.</span>
00323         <span class="comment">//</span>
00324 
00325         <span class="keywordflow">try</span> {
00326 
00327             RtlMoveMemory( &amp;DeviceMapInformation-&gt;Query,
00328                            &amp;LocalMapInformation.Query,
00329                            <span class="keyword">sizeof</span>( DeviceMapInformation-&gt;Query ));
00330 
00331         } except( EXCEPTION_EXECUTE_HANDLER ) {
00332 
00333             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00334         }
00335 
00336     }
00337 
00338     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00339 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="obdevmap.c::ObSetDeviceMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObSetDeviceMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00030">30</a> of file <a class="el" href="../../d8/d9/obdevmap_8c-source.html">obdevmap.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00259">_EPROCESS::DeviceMap</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00213">_OBJECT_DIRECTORY::DeviceMap</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00063">DirectoryHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00416">ObDereferenceDeviceMap()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00098">ObpDeviceMapLock</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00367">ObpDirectoryObjectType</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00249">ObSystemDeviceMap</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00243">_DEVICE_MAP::ReferenceCount</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, and <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">ObpCreateDosDevicesDirectory()</a>.
<p>
<pre class="fragment"><div>00037                    :
00038 
00039     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process, <span class="keyword">using</span>
00040     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object directory.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> device map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a structure
00041     associated with an object directory and a process.  When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00042     manager sees a references to a name beginning with \??\ or just \??,
00043     then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> follows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device map object in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process's
00044     <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a> structure to get to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object directory to use <span class="keywordflow">for</span> that
00045     reference.  This allows multiple <span class="keyword">virtual</span> \??  object directories on
00046     a per process basis.  The WindowStation logic will use <span class="keyword">this</span>
00047     functionality to allocate devices unique to each WindowStation.
00048 
00049 Arguments:
00050 
00051     TargetProcess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process to associate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device map
00052         with.  If null then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory
00053         becomes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <span class="keywordflow">default</span> dos device map.
00054 
00055     <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object directory to associate with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00056         device map.
00057 
00058 
00059 Return Value:
00060 
00061     Returns one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following status codes:
00062 
00063         STATUS_SUCCESS - normal, successful completion.
00064 
00065         STATUS_SHARING_VIOLATION - The specified object directory <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already
00066             associated with a device map.
00067 
00068         STATUS_INSUFFICIENT_RESOURCES - Unable to allocate <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
00069             map data structure;
00070 
00071         STATUS_ACCESS_DENIED - Caller did not have DIRECTORY_TRAVERSE access
00072             to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object directory.
00073 
00074 --*/
00075 
00076 {
00077     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00078     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> DosDevicesDirectory;
00079     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap;
00080     PVOID Object;
00081     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00082     KIRQL OldIrql;
00083 
00084     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">//  Reference the object directory handle and see if it is already</span>
00088     <span class="comment">//  associated with a device map structure.  If so, fail this call.</span>
00089     <span class="comment">//</span>
00090 
00091     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( DirectoryHandle,
00092                                         DIRECTORY_TRAVERSE,
00093                                         ObpDirectoryObjectType,
00094                                         KeGetPreviousMode(),
00095                                         &amp;DosDevicesDirectory,
00096                                         NULL );
00097 
00098     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00099 
00100         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00101     }
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">//  Capture the device map</span>
00105     <span class="comment">//</span>
00106     
00107     ExAcquireSpinLock( &amp;ObpDeviceMapLock, &amp;OldIrql );
00108     
00109     DeviceMap = DosDevicesDirectory-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a>;
00110     
00111     <span class="comment">//</span>
00112     <span class="comment">//  Check if the directory already has a dos device map</span>
00113     <span class="comment">//</span>
00114     
00115     <span class="keywordflow">if</span> (DeviceMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00116         
00117         <span class="comment">//</span>
00118         <span class="comment">//  Test if the DeviceMap is about to delete and has the</span>
00119         <span class="comment">//  ReferenceCount 0</span>
00120         <span class="comment">//</span>
00121     
00122         <span class="keywordflow">if</span> (DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a> != 0) {
00123         
00124             <span class="comment">//</span>
00125             <span class="comment">//  We have a dos device map, so setup the target process to be either</span>
00126             <span class="comment">//  what the caller specified or the current process</span>
00127             <span class="comment">//</span>
00128 
00129             <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Target = TargetProcess;
00130 
00131             <span class="keywordflow">if</span> (Target == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00132 
00133                 Target = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00134             }
00135 
00136             <span class="comment">//</span>
00137             <span class="comment">//  If the current process already has the exact same dos device map</span>
00138             <span class="comment">//  then everything is already done and nothing left for us to do.</span>
00139             <span class="comment">//</span>
00140 
00141             <span class="keywordflow">if</span> (Target-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o59">DeviceMap</a> == DeviceMap) {
00142 
00143                 ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );
00144                 
00145                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DosDevicesDirectory );
00146 
00147                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00148             }
00149 
00150             <span class="comment">//</span>
00151             <span class="comment">//  Add a new reference before releasing the spinlock</span>
00152             <span class="comment">//  to make sure nobody will release the devicemap while</span>
00153             <span class="comment">//  we try to attach to the process.</span>
00154             <span class="comment">//</span>
00155             
00156             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a>++;
00157 
00158             ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );
00159         
00160             <span class="comment">//</span>
00161             <span class="comment">//  We can dereference the target processes device map because it</span>
00162             <span class="comment">//  no longer will have it's old dos device map.</span>
00163             <span class="comment">//</span>
00164 
00165             <a class="code" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a> ( Target );
00166 
00167             <span class="comment">//</span>
00168             <span class="comment">//  Now setup the new device map that we were feed in.  We lock it</span>
00169             <span class="comment">//  bump its ref count, make the targe process point to it, unlock it,</span>
00170             <span class="comment">//  and return to our caller</span>
00171             <span class="comment">//</span>
00172 
00173             ExAcquireSpinLock( &amp;ObpDeviceMapLock, &amp;OldIrql );
00174 
00175             Target-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o59">DeviceMap</a> = DeviceMap;
00176 
00177             ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );
00178 
00179             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DosDevicesDirectory );
00180 
00181             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00182         }
00183     }
00184 
00185     ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );
00186     
00187     <span class="comment">//</span>
00188     <span class="comment">//  The input directory does not have a dos device map. so we'll</span>
00189     <span class="comment">//  allocate and initialize a new device map structure.</span>
00190     <span class="comment">//</span>
00191 
00192     DeviceMap = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, <span class="keyword">sizeof</span>( *DeviceMap ), 'mDbO' );
00193 
00194     <span class="keywordflow">if</span> (DeviceMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00195 
00196         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DosDevicesDirectory );
00197         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00198 
00199     } <span class="keywordflow">else</span> {
00200 
00201         RtlZeroMemory( DeviceMap, <span class="keyword">sizeof</span>( *DeviceMap ) );
00202 
00203         DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a> = 1;
00204         DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a> = DosDevicesDirectory;
00205 
00206         DosDevicesDirectory-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a> = DeviceMap;
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">//  If the caller specified a target process then remove the</span>
00210         <span class="comment">//  processes device map if in use and replace it with the new</span>
00211         <span class="comment">//  one, otherwise set this new device map to the system wide one</span>
00212         <span class="comment">//  and put it into the current process</span>
00213         <span class="comment">//</span>
00214 
00215         <span class="keywordflow">if</span> (TargetProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00216 
00217             <a class="code" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a> ( TargetProcess );
00218 
00219             TargetProcess-&gt;DeviceMap = DeviceMap;
00220 
00221         } <span class="keywordflow">else</span> {
00222 
00223             <a class="code" href="../../d4/d0/ob_8h.html#a41">ObSystemDeviceMap</a> = DeviceMap;
00224 
00225             <a class="code" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a> ( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
00226 
00227             <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DeviceMap = DeviceMap;
00228         }
00229     }
00230 
00231     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00232 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
