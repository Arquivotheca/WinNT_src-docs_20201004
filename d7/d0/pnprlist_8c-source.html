<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnprlist.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnprlist.c</h1><a href="../../d6/d1/pnprlist_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1998 Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    pnprlist.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains routines to manipulate relations list.  Relation lists</span>
00012 <span class="comment">    are used by Plug and Play during the processing of device removal and</span>
00013 <span class="comment">    ejection.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    These routines are all pageable and can't be called at raised IRQL or with</span>
00016 <span class="comment">    a spinlock held.</span>
00017 <span class="comment"></span>
00018 <span class="comment">Author:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Robert Nelson (robertn) Apr, 1998.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00027 
00028 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,'lrpP')</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
00033 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAddRelationToList)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAllocateRelationList)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopCompressRelationList)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopEnumerateRelations)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFreeRelationList)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetRelationsCount)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetRelationsTaggedCount)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsRelationInList)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopMergeRelationLists)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRemoveIndirectRelationsFromList)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRemoveRelationFromList)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopSetAllRelationsTags)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopSetRelationsTag)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00048 <span class="preprocessor"></span>
<a name="l00049"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a0">00049</a> <span class="preprocessor">#define RELATION_FLAGS              0x00000003</span>
00050 <span class="preprocessor"></span>
<a name="l00051"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a1">00051</a> <span class="preprocessor">#define RELATION_FLAG_TAGGED        0x00000001</span>
<a name="l00052"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a2">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define RELATION_FLAG_DESCENDANT    0x00000002</span>
00053 <span class="preprocessor"></span>
00054 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00055"></a><a class="code" href="../../d7/d1/pnprlist_8h.html#a7">00055</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a7">IopAddRelationToList</a>(
00056     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List,
00057     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00058     IN BOOLEAN DirectDescendant,
00059     IN BOOLEAN Tagged
00060     )
00061 
00062 <span class="comment">/*++</span>
00063 <span class="comment"></span>
00064 <span class="comment">Routine Description:</span>
00065 <span class="comment"></span>
00066 <span class="comment">    Adds an element to a relation list.</span>
00067 <span class="comment"></span>
00068 <span class="comment">    If this is the first DeviceObject of a particular level then a new</span>
00069 <span class="comment">    RELATION_LIST_ENTRY will be allocated.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    This routine should only be called on an uncompressed relation list,</span>
00072 <span class="comment">    otherwise it is likely that STATUS_INVALID_PARAMETER will be returned.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Arguments:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    List                Relation list to which the DeviceObject is added.</span>
00077 <span class="comment"></span>
00078 <span class="comment">    DeviceObject        DeviceObject to be added to List.  It must be a</span>
00079 <span class="comment">                        PhysicalDeviceObject (PDO).</span>
00080 <span class="comment"></span>
00081 <span class="comment">    DirectDescendant    Indicates whether DeviceObject is a direct descendant of</span>
00082 <span class="comment">                        the original target device of this remove.</span>
00083 <span class="comment"></span>
00084 <span class="comment">    Tagged              Indicates whether DeviceObject should be tagged in List.</span>
00085 <span class="comment"></span>
00086 <span class="comment">Return Value:</span>
00087 <span class="comment"></span>
00088 <span class="comment">    STATUS_SUCCESS</span>
00089 <span class="comment"></span>
00090 <span class="comment">        The DeviceObject was added successfully.</span>
00091 <span class="comment"></span>
00092 <span class="comment">    STATUS_OBJECT_NAME_COLLISION</span>
00093 <span class="comment"></span>
00094 <span class="comment">        The DeviceObject already exists in the relation list.</span>
00095 <span class="comment"></span>
00096 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
00097 <span class="comment"></span>
00098 <span class="comment">        There isn't enough PagedPool available to allocate a new</span>
00099 <span class="comment">        RELATION_LIST_ENTRY.</span>
00100 <span class="comment"></span>
00101 <span class="comment">    STATUS_INVALID_PARAMETER</span>
00102 <span class="comment"></span>
00103 <span class="comment">        The level of the DEVICE_NODE associated with DeviceObject is less than</span>
00104 <span class="comment">        FirstLevel or greater than the MaxLevel.</span>
00105 <span class="comment"></span>
00106 <span class="comment">    STATUS_NO_SUCH_DEVICE</span>
00107 <span class="comment"></span>
00108 <span class="comment">        DeviceObject is not a PhysicalDeviceObject (PDO), it doesn't have a</span>
00109 <span class="comment">        DEVICE_NODE associated with it.</span>
00110 <span class="comment"></span>
00111 <span class="comment">--*/</span>
00112 
00113 {
00114     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode;
00115     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00116     ULONG                   level;
00117     ULONG                   index;
00118     ULONG                   flags;
00119 
00120     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00121 
00122     flags = 0;
00123 
00124     <span class="keywordflow">if</span> (Tagged) {
00125         Tagged = 1;
00126         flags |= <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>;
00127     }
00128 
00129     <span class="keywordflow">if</span> (DirectDescendant) {
00130         flags |= <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>;
00131     }
00132 
00133     <span class="keywordflow">if</span> ((deviceNode = DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00134         level = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>;
00135 
00136         <span class="comment">//</span>
00137         <span class="comment">// Since this routine is called with the DeviceNode Tree locked and</span>
00138         <span class="comment">// List is initially allocated with enough entries to hold the deepest</span>
00139         <span class="comment">// DEVICE_NODE this ASSERT should never fire.  If it does then either</span>
00140         <span class="comment">// the tree is changing or we were given a compressed list.</span>
00141         <span class="comment">//</span>
00142         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= List-&gt;MaxLevel);
00143 
00144         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel) {
00145 
00146             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00147 
00148                 <span class="comment">//</span>
00149                 <span class="comment">// This is the first DeviceObject of its level, allocate a new</span>
00150                 <span class="comment">// RELATION_LIST_ENTRY.</span>
00151                 <span class="comment">//</span>
00152                 entry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00153                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">RELATION_LIST_ENTRY</a>) +
00154                                         <a class="code" href="../../d1/d0/pnpdata_8c.html#a12">IopNumberDeviceNodes</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
00155 
00156                 <span class="keywordflow">if</span> (entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00157                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00158                 }
00159 
00160                 <span class="comment">//</span>
00161                 <span class="comment">// We always allocate enough Devices to hold the whole tree as</span>
00162                 <span class="comment">// a simplification.  Since each entry is a PDEVICE_OBJECT and</span>
00163                 <span class="comment">// there is generally under 50 devices on a machine this means</span>
00164                 <span class="comment">// under 1K for each entry.  The excess space will be freed when</span>
00165                 <span class="comment">// the list is compressed.</span>
00166                 <span class="comment">//</span>
00167                 entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> = 0;
00168                 entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a> = <a class="code" href="../../d1/d0/pnpdata_8c.html#a12">IopNumberDeviceNodes</a>;
00169 
00170                 <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ] = entry;
00171             }
00172 
00173             <span class="comment">//</span>
00174             <span class="comment">// There should always be room for a DeviceObject since the Entry is</span>
00175             <span class="comment">// initially dimensioned large enough to hold all the DEVICE_NODES</span>
00176             <span class="comment">// in the system.</span>
00177             <span class="comment">//</span>
00178             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a>);
00179 
00180             <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a>) {
00181                 <span class="comment">//</span>
00182                 <span class="comment">// Search the list to see if DeviceObject has already been</span>
00183                 <span class="comment">// added.</span>
00184                 <span class="comment">//</span>
00185                 <span class="keywordflow">for</span> (index = 0; index &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; index++) {
00186                     <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>) == (ULONG_PTR)DeviceObject) {
00187 
00188                         <span class="comment">//</span>
00189                         <span class="comment">// DeviceObject already exists in the list.  However</span>
00190                         <span class="comment">// the Direct Descendant flag may differ.  We will</span>
00191                         <span class="comment">// override it if DirectDescendant is TRUE.  This could</span>
00192                         <span class="comment">// happen if we merged two relation lists.</span>
00193 
00194                         <span class="keywordflow">if</span> (DirectDescendant) {
00195                             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] | <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>);
00196                         }
00197 
00198                         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_COLLISION;
00199                     }
00200                 }
00201             } <span class="keywordflow">else</span> {
00202                 <span class="comment">//</span>
00203                 <span class="comment">// There isn't room in the Entry for another DEVICE_OBJECT, the</span>
00204                 <span class="comment">// list has probably already been compressed.</span>
00205                 <span class="comment">//</span>
00206                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00207             }
00208 
00209             <span class="comment">//</span>
00210             <span class="comment">// Take out a reference on DeviceObject, we will release it when we</span>
00211             <span class="comment">// free the list or remove the DeviceObject from the list.</span>
00212             <span class="comment">//</span>
00213             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( DeviceObject );
00214 
00215             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)DeviceObject | flags);
00216             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>++;
00217 
00218             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count++;
00219             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount += Tagged;
00220 
00221             <span class="keywordflow">return</span> STATUS_SUCCESS;
00222         } <span class="keywordflow">else</span> {
00223             <span class="comment">//</span>
00224             <span class="comment">// There isn't an Entry available for the level of this</span>
00225             <span class="comment">// DEVICE_OBJECT, the list has probably already been compressed.</span>
00226             <span class="comment">//</span>
00227 
00228             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00229         }
00230     } <span class="keywordflow">else</span> {
00231         <span class="comment">//</span>
00232         <span class="comment">// DeviceObject is not a PhysicalDeviceObject (PDO).</span>
00233         <span class="comment">//</span>
00234         <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
00235     }
00236 }
00237 
00238 <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>
<a name="l00239"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a4">00239</a> <a class="code" href="../../d6/d1/pnprlist_8c.html#a4">IopAllocateRelationList</a>(
00240     VOID
00241     )
00242 
00243 <span class="comment">/*++</span>
00244 <span class="comment"></span>
00245 <span class="comment">Routine Description:</span>
00246 <span class="comment"></span>
00247 <span class="comment">    Allocate a new Relations List.  The list is initially sized large enough to</span>
00248 <span class="comment">    hold the deepest DEVICE_NODE encountered since the system started.</span>
00249 <span class="comment"></span>
00250 <span class="comment">Arguments:</span>
00251 <span class="comment"></span>
00252 <span class="comment">    NONE</span>
00253 <span class="comment"></span>
00254 <span class="comment">Return Value:</span>
00255 <span class="comment"></span>
00256 <span class="comment">    Newly allocated list if enough PagedPool is available, otherwise NULL.</span>
00257 <span class="comment"></span>
00258 <span class="comment">--*/</span>
00259 
00260 {
00261     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>  list;
00262     ULONG           maxLevel;
00263     ULONG           listSize;
00264 
00265     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">// Level number of the deepest DEVICE_NODE allocated since the system</span>
00269     <span class="comment">// started.</span>
00270     <span class="comment">//</span>
00271     maxLevel = <a class="code" href="../../d1/d0/pnpdata_8c.html#a25">IopMaxDeviceNodeLevel</a>;
00272     listSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d3/struct__RELATION__LIST.html">RELATION_LIST</a>) + maxLevel * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>);
00273 
00274     <span class="keywordflow">if</span> ((list = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, listSize )) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00275         RtlZeroMemory(list, listSize);
00276         <span class="comment">// list-&gt;FirstLevel = 0;</span>
00277         <span class="comment">// list-&gt;Count = 0;</span>
00278         <span class="comment">// list-&gt;Tagged = 0;</span>
00279         list-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a> = maxLevel;
00280     }
00281 
00282     <span class="keywordflow">return</span> list;
00283 }
00284 
00285 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00286"></a><a class="code" href="../../d7/d1/pnprlist_8h.html#a8">00286</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a8">IopCompressRelationList</a>(
00287     IN OUT <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> *List
00288     )
00289 
00290 <span class="comment">/*++</span>
00291 <span class="comment"></span>
00292 <span class="comment">Routine Description:</span>
00293 <span class="comment"></span>
00294 <span class="comment">    Compresses the relation list by reallocating the list and all the entries so</span>
00295 <span class="comment">    that they a just large enough to hold their current contents.</span>
00296 <span class="comment"></span>
00297 <span class="comment">    Once a list has been compressed IopAddRelationToList and</span>
00298 <span class="comment">    IopMergeRelationLists targetting this list are both likely to fail.</span>
00299 <span class="comment"></span>
00300 <span class="comment">Arguments:</span>
00301 <span class="comment"></span>
00302 <span class="comment">    List    Relation List to compress.</span>
00303 <span class="comment"></span>
00304 <span class="comment">Return Value:</span>
00305 <span class="comment"></span>
00306 <span class="comment">    STATUS_SUCCESS</span>
00307 <span class="comment"></span>
00308 <span class="comment">        The list was compressed.  Although this routine does allocate memory and</span>
00309 <span class="comment">        the allocation can fail, the routine itself will never fail.  Since the</span>
00310 <span class="comment">        memory we are allocating is always smaller then the memory it is</span>
00311 <span class="comment">        replacing we just keep the old memory if the allocation fails.</span>
00312 <span class="comment"></span>
00313 <span class="comment">--*/</span>
00314 
00315 {
00316     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>          oldList, newList;
00317     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    oldEntry, newEntry;
00318     ULONG                   lowestLevel;
00319     ULONG                   highestLevel;
00320     ULONG                   index;
00321 
00322     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00323 
00324     oldList = *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Initialize lowestLevel and highestLevel with illegal values chosen so</span>
00328     <span class="comment">// that the first real entry will override them.</span>
00329     <span class="comment">//</span>
00330     lowestLevel = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a>;
00331     highestLevel = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o2">FirstLevel</a>;
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// Loop through the list looking for allocated entries.</span>
00335     <span class="comment">//</span>
00336     <span class="keywordflow">for</span> (index = 0; index &lt;= (oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a> - oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o2">FirstLevel</a>); index++) {
00337 
00338         <span class="keywordflow">if</span> ((oldEntry = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o4">Entries</a>[ index ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00339             <span class="comment">//</span>
00340             <span class="comment">// This entry is allocated, update lowestLevel and highestLevel if</span>
00341             <span class="comment">// necessary.</span>
00342             <span class="comment">//</span>
00343             <span class="keywordflow">if</span> (lowestLevel &gt; index) {
00344                 lowestLevel = index;
00345             }
00346 
00347             <span class="keywordflow">if</span> (highestLevel &lt; index) {
00348                 highestLevel = index;
00349             }
00350 
00351             <span class="keywordflow">if</span> (oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> &lt; oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a>) {
00352 
00353                 <span class="comment">//</span>
00354                 <span class="comment">// This entry is only partially full.  Allocate a new entry</span>
00355                 <span class="comment">// which is just the right size to hold the current number of</span>
00356                 <span class="comment">// PDEVICE_OBJECTs.</span>
00357                 <span class="comment">//</span>
00358                 newEntry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00359                                            <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">RELATION_LIST_ENTRY</a>) +
00360                                            (oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
00361 
00362                 <span class="keywordflow">if</span> (newEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00363 
00364                     <span class="comment">//</span>
00365                     <span class="comment">// Initialize Count and MaxCount to the number of</span>
00366                     <span class="comment">// PDEVICE_OBJECTs in the old entry.</span>
00367                     <span class="comment">//</span>
00368                     newEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> = oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>;
00369                     newEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o1">MaxCount</a> = oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>;
00370 
00371                     <span class="comment">//</span>
00372                     <span class="comment">// Copy the PDEVICE_OBJECTs from the old entry to the new</span>
00373                     <span class="comment">// one.</span>
00374                     <span class="comment">//</span>
00375                     RtlCopyMemory( newEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>,
00376                                    oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>,
00377                                    oldEntry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/io_8h.html#a340">PDEVICE_OBJECT</a>));
00378 
00379                     <span class="comment">//</span>
00380                     <span class="comment">// Free the old entry and store the new entry in the list.</span>
00381                     <span class="comment">//</span>
00382                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( oldEntry );
00383 
00384                     oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o4">Entries</a>[ index ] = newEntry;
00385                 }
00386             }
00387         }
00388     }
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">// Assert that the old list isn't empty.</span>
00392     <span class="comment">//</span>
00393     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(lowestLevel &lt;= highestLevel);
00394 
00395     <span class="keywordflow">if</span> (lowestLevel &gt; highestLevel) {
00396         <span class="comment">//</span>
00397         <span class="comment">// The list is empty - we shouldn't get asked to compress an empty list</span>
00398         <span class="comment">// but lets do it anyways.</span>
00399         <span class="comment">//</span>
00400         lowestLevel = 0;
00401         highestLevel = 0;
00402     }
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Check if the old list had unused entries at the beginning or the end of</span>
00406     <span class="comment">// the Entries array.</span>
00407     <span class="comment">//</span>
00408     <span class="keywordflow">if</span> (lowestLevel != oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o2">FirstLevel</a> || highestLevel != oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a>) {
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">// Allocate a new List with just enough Entries to hold those between</span>
00412         <span class="comment">// FirstLevel and MaxLevel inclusive.</span>
00413         <span class="comment">//</span>
00414         newList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00415                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d3/struct__RELATION__LIST.html">RELATION_LIST</a>) +
00416                                   (highestLevel - lowestLevel) * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>));
00417 
00418         <span class="keywordflow">if</span> (newList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00419             <span class="comment">//</span>
00420             <span class="comment">// Copy the old list to the new list and return it to the caller.</span>
00421             <span class="comment">//</span>
00422             newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o0">Count</a> = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o0">Count</a>;
00423             newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o1">TagCount</a> = oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o1">TagCount</a>;
00424             newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o2">FirstLevel</a> = lowestLevel;
00425             newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o3">MaxLevel</a> = highestLevel;
00426 
00427             RtlCopyMemory( newList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o4">Entries</a>,
00428                            &amp;oldList-&gt;<a class="code" href="../../d6/d3/struct__RELATION__LIST.html#o4">Entries</a>[ lowestLevel ],
00429                            (highestLevel - lowestLevel + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d1/pnprlist_8h.html#a1">PRELATION_LIST_ENTRY</a>));
00430 
00431             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( oldList );
00432 
00433             *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = newList;
00434         }
00435     }
00436 
00437     <span class="keywordflow">return</span> STATUS_SUCCESS;
00438 }
00439 
00440 BOOLEAN
<a name="l00441"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a6">00441</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>(
00442     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List,
00443     IN OUT PULONG Marker,
00444     OUT <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *DeviceObject,
00445     OUT BOOLEAN *DirectDescendant, OPTIONAL
00446     OUT BOOLEAN *Tagged, OPTIONAL
00447     IN BOOLEAN Reverse
00448     )
00449 
00450 <span class="comment">/*++</span>
00451 <span class="comment"></span>
00452 <span class="comment">Routine Description:</span>
00453 <span class="comment"></span>
00454 <span class="comment">    Enumerates the relations in a list.</span>
00455 <span class="comment"></span>
00456 <span class="comment">Arguments:</span>
00457 <span class="comment"></span>
00458 <span class="comment">    List                Relation list to be enumerated.</span>
00459 <span class="comment"></span>
00460 <span class="comment">    Marker              Cookie used to maintain current place in the list.  It</span>
00461 <span class="comment">                        must be initialized to 0 the first time</span>
00462 <span class="comment">                        IopEnumerateRelations is called.</span>
00463 <span class="comment"></span>
00464 <span class="comment">    DeviceObject        Returned Relation.</span>
00465 <span class="comment"></span>
00466 <span class="comment">    DirectDescendant    If specified then it is set if the relation is a direct</span>
00467 <span class="comment">                        descendant of the original target device of this remove.</span>
00468 <span class="comment"></span>
00469 <span class="comment">    Tagged              If specified then it is set if the relation is tagged</span>
00470 <span class="comment">                        otherwise it is cleared.</span>
00471 <span class="comment"></span>
00472 <span class="comment">    Reverse             Direction of traversal, TRUE means from deepest to</span>
00473 <span class="comment">                        closest to the root, FALSE means from the root down.</span>
00474 <span class="comment"></span>
00475 <span class="comment">                        If Reverse changes on a subsequent call then the</span>
00476 <span class="comment">                        previously enumerated relation is skipped.  For example,</span>
00477 <span class="comment">                        given the sequence A, B, C, D, E.  If</span>
00478 <span class="comment">                        IopEnumerateRelations is called thrice with Reverse set</span>
00479 <span class="comment">                        to FALSE and then called repeatedly with Reverse set to</span>
00480 <span class="comment">                        TRUE until it returns FALSE, the sequence would be: A,</span>
00481 <span class="comment">                        B, C, B, A.</span>
00482 <span class="comment"></span>
00483 <span class="comment">                        Once the end has been reached it is not possible to</span>
00484 <span class="comment">                        change directions.</span>
00485 <span class="comment"></span>
00486 <span class="comment"></span>
00487 <span class="comment">Return Value:</span>
00488 <span class="comment"></span>
00489 <span class="comment">    TRUE</span>
00490 <span class="comment"></span>
00491 <span class="comment">        DeviceObject and optionally Tagged have been set to the next relation.</span>
00492 <span class="comment"></span>
00493 <span class="comment">    FALSE</span>
00494 <span class="comment"></span>
00495 <span class="comment">        There are no more relations.</span>
00496 <span class="comment"></span>
00497 <span class="comment">--*/</span>
00498 
00499 {
00500     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00501     LONG                    levelIndex;
00502     ULONG                   entryIndex;
00503 
00504     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// The basic assumptions of our use of Marker is that there will never be</span>
00508     <span class="comment">// more than 16M DeviceNodes at any one level and that the tree will never</span>
00509     <span class="comment">// be more than 127 deep.</span>
00510     <span class="comment">//</span>
00511     <span class="comment">// The format of Marker is</span>
00512     <span class="comment">//      Bit 31      = Valid (used to distinguish the initial call</span>
00513     <span class="comment">//      Bit 30-24   = Current index into entries</span>
00514     <span class="comment">//      Bit 23-0    = Current index into devices, 0xFFFFFF means last</span>
00515     <span class="comment">//</span>
00516     <span class="keywordflow">if</span> (*Marker == ~0U) {
00517         <span class="comment">//</span>
00518         <span class="comment">// We've reached the end.</span>
00519         <span class="comment">//</span>
00520         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00521     }
00522 
00523     <span class="keywordflow">if</span> (*Marker == 0) {
00524         <span class="comment">//</span>
00525         <span class="comment">// This is the initial call to IopEnumerateRelations</span>
00526         <span class="comment">//</span>
00527         <span class="keywordflow">if</span> (Reverse) {
00528             <span class="comment">//</span>
00529             <span class="comment">// Initialize levelIndex to the last element of Entries</span>
00530             <span class="comment">//</span>
00531             levelIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel;
00532         } <span class="keywordflow">else</span> {
00533             <span class="comment">//</span>
00534             <span class="comment">// Initialize levelIndex to the first element of Entries</span>
00535             <span class="comment">//</span>
00536             levelIndex = 0;
00537         }
00538         <span class="comment">//</span>
00539         <span class="comment">// Initialize entryIndex to unknown element of Devices.  If we are going</span>
00540         <span class="comment">// in reverse then this will appear to be beyond the last element and</span>
00541         <span class="comment">// we'll adjust it the last one.  If we are going forward then this will</span>
00542         <span class="comment">// appear to be just prior to the first element so when we increment it,</span>
00543         <span class="comment">// it will become zero.</span>
00544         <span class="comment">//</span>
00545         entryIndex = ~0U;
00546     } <span class="keywordflow">else</span> {
00547         <span class="comment">//</span>
00548         <span class="comment">// Bit 31 is our valid bit, used to distinguish level 0, device 0 from</span>
00549         <span class="comment">// the first time call.</span>
00550         <span class="comment">//</span>
00551         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*Marker &amp; ((ULONG)1 &lt;&lt; 31));
00552         <span class="comment">//</span>
00553         <span class="comment">// Current level stored in bits 30-24.</span>
00554         <span class="comment">//</span>
00555         levelIndex = (*Marker &gt;&gt; 24) &amp; 0x7F;
00556         <span class="comment">//</span>
00557         <span class="comment">// Current device stored in bits 23-0.</span>
00558         <span class="comment">//</span>
00559         entryIndex = *Marker &amp; 0x00FFFFFF;
00560     }
00561 
00562     <span class="keywordflow">if</span> (Reverse) {
00563         <span class="comment">//</span>
00564         <span class="comment">// We are traversing the list bottom up, from the deepest device towards</span>
00565         <span class="comment">// the root.</span>
00566         <span class="comment">//</span>
00567         <span class="keywordflow">for</span> ( ; levelIndex &gt;= 0; levelIndex--) {
00568 
00569             <span class="comment">//</span>
00570             <span class="comment">// Since the Entries array can be sparse find the next allocated</span>
00571             <span class="comment">// Entry.</span>
00572             <span class="comment">//</span>
00573             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ levelIndex ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00574 
00575                 <span class="keywordflow">if</span> (entryIndex &gt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>) {
00576                     <span class="comment">//</span>
00577                     <span class="comment">// entryIndex (the current one) is greater than Count, this</span>
00578                     <span class="comment">// will be the case where it is 0xFFFFFF, in other words</span>
00579                     <span class="comment">// unspecified.  Adjust it so that it is one past the last</span>
00580                     <span class="comment">// one in this Entry.</span>
00581                     <span class="comment">//</span>
00582                     entryIndex = entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>;
00583                 }
00584 
00585                 <span class="keywordflow">if</span> (entryIndex &gt; 0) {
00586 
00587                     <span class="comment">//</span>
00588                     <span class="comment">// The current entry is beyond the first entry so the next</span>
00589                     <span class="comment">// entry (which is the one we are looking for is immediately</span>
00590                     <span class="comment">// prior, adjust entryIndex.</span>
00591                     <span class="comment">//</span>
00592                     entryIndex--;
00593 
00594                     <span class="comment">//</span>
00595                     <span class="comment">// Get the device object and remove the tag.</span>
00596                     <span class="comment">//</span>
00597                     *DeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>);
00598 
00599                     <span class="keywordflow">if</span> (Tagged != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00600                         <span class="comment">//</span>
00601                         <span class="comment">// The caller is interested in the tag value.</span>
00602                         <span class="comment">//</span>
00603                         *Tagged = (BOOLEAN)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
00604                     }
00605 
00606                     <span class="keywordflow">if</span> (DirectDescendant != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00607                         <span class="comment">//</span>
00608                         <span class="comment">// The caller is interested in the DirectDescendant value.</span>
00609                         <span class="comment">//</span>
00610                         *DirectDescendant = (BOOLEAN)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>);
00611                     }
00612 
00613                     <span class="comment">//</span>
00614                     <span class="comment">// Update the marker (info for current device)</span>
00615                     <span class="comment">//</span>
00616                     *Marker = ((ULONG)1 &lt;&lt; 31) | (levelIndex &lt;&lt; 24) | (entryIndex &amp; 0x00FFFFFF);
00617 
00618                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00619                 }
00620             }
00621 
00622             <span class="comment">//</span>
00623             <span class="comment">// The current device object has been deleted or the current</span>
00624             <span class="comment">// device object is the first one in this Entry.</span>
00625             <span class="comment">// We need to continue to search backwards through the other</span>
00626             <span class="comment">// Entries.</span>
00627             <span class="comment">//</span>
00628             entryIndex = ~0U;
00629         }
00630     } <span class="keywordflow">else</span> {
00631         <span class="keywordflow">for</span> ( ; levelIndex &lt;= (LONG)(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel); levelIndex++) {
00632 
00633             <span class="comment">//</span>
00634             <span class="comment">// Since the Entries array can be sparse find the next allocated</span>
00635             <span class="comment">// Entry.</span>
00636             <span class="comment">//</span>
00637             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ levelIndex ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638 
00639                 <span class="comment">//</span>
00640                 <span class="comment">// entryIndex is the index of the current device or 0xFFFFFFFF</span>
00641                 <span class="comment">// if this is the first time we have been called or the current</span>
00642                 <span class="comment">// current device is the last one in its Entry.  Increment the</span>
00643                 <span class="comment">// index to point to the next device.</span>
00644                 <span class="comment">//</span>
00645                 entryIndex++;
00646 
00647                 <span class="keywordflow">if</span> (entryIndex &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>) {
00648 
00649                     <span class="comment">//</span>
00650                     <span class="comment">// The next device is within this entry.</span>
00651                     <span class="comment">//</span>
00652                     <span class="comment">//</span>
00653                     <span class="comment">// Get the device object and remove the tag.</span>
00654                     <span class="comment">//</span>
00655                     *DeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>);
00656 
00657                     <span class="keywordflow">if</span> (Tagged != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00658                         <span class="comment">//</span>
00659                         <span class="comment">// The caller is interested in the tag value.</span>
00660                         <span class="comment">//</span>
00661                         *Tagged = (BOOLEAN)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
00662                     }
00663 
00664                     <span class="keywordflow">if</span> (DirectDescendant != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00665                         <span class="comment">//</span>
00666                         <span class="comment">// The caller is interested in the DirectDescendant value.</span>
00667                         <span class="comment">//</span>
00668                         *DirectDescendant = (BOOLEAN)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>);
00669                     }
00670 
00671                     <span class="comment">//</span>
00672                     <span class="comment">// Update the marker (info for current device)</span>
00673                     <span class="comment">//</span>
00674                     *Marker = ((ULONG)1 &lt;&lt; 31) | (levelIndex &lt;&lt; 24) | (entryIndex &amp; 0x00FFFFFF);
00675 
00676                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00677                 }
00678             }
00679 
00680             <span class="comment">//</span>
00681             <span class="comment">// The current device has been removed or we have processed the</span>
00682             <span class="comment">// last device in the current entry.</span>
00683             <span class="comment">// Set entryIndex so that it is just before the first device in</span>
00684             <span class="comment">// the next entry.  Continue the search looking for the next</span>
00685             <span class="comment">// allocated Entry.</span>
00686             <span class="comment">//</span>
00687             entryIndex = ~0U;
00688         }
00689     }
00690 
00691     <span class="comment">//</span>
00692     <span class="comment">// We are at the end of the list</span>
00693     <span class="comment">//</span>
00694     *Marker = ~0U;
00695     *DeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00696 
00697     <span class="keywordflow">if</span> (Tagged != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00698         *Tagged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00699     }
00700 
00701     <span class="keywordflow">if</span> (DirectDescendant != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00702         *DirectDescendant = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00703     }
00704 
00705     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00706 }
00707 
00708 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00709"></a><a class="code" href="../../d7/d1/pnprlist_8h.html#a10">00709</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a10">IopFreeRelationList</a>(
00710     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List
00711     )
00712 
00713 <span class="comment">/*++</span>
00714 <span class="comment"></span>
00715 <span class="comment">Routine Description:</span>
00716 <span class="comment"></span>
00717 <span class="comment">    Free a relation list allocated by IopAllocateRelationList.</span>
00718 <span class="comment"></span>
00719 <span class="comment">Arguments:</span>
00720 <span class="comment"></span>
00721 <span class="comment">    List    The list to be freed.</span>
00722 <span class="comment"></span>
00723 <span class="comment">Return Value:</span>
00724 <span class="comment"></span>
00725 <span class="comment">    NONE.</span>
00726 <span class="comment"></span>
00727 <span class="comment">--*/</span>
00728 
00729 {
00730     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00731     ULONG                   levelIndex;
00732     ULONG                   entryIndex;
00733 
00734     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">// Search the list looking for allocated Entries.</span>
00738     <span class="comment">//</span>
00739     <span class="keywordflow">for</span> (levelIndex = 0; levelIndex &lt;= (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel); levelIndex++) {
00740 
00741         <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ levelIndex ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00742             <span class="comment">//</span>
00743             <span class="comment">// This entry has been allocated.</span>
00744             <span class="comment">//</span>
00745             <span class="keywordflow">for</span> (entryIndex = 0; entryIndex &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; entryIndex++) {
00746                 <span class="comment">//</span>
00747                 <span class="comment">// Dereference all the Devices in the entry.</span>
00748                 <span class="comment">//</span>
00749                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>));
00750             }
00751             <span class="comment">//</span>
00752             <span class="comment">// Free the Entry.</span>
00753             <span class="comment">//</span>
00754             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( entry );
00755         }
00756     }
00757 
00758     <span class="comment">//</span>
00759     <span class="comment">// Free the list.  It isn't necessary to dereference the DeviceObject that</span>
00760     <span class="comment">// was the original target that caused the list to be created.  This</span>
00761     <span class="comment">// DeviceObject is also in one of the Entries and its reference is taken</span>
00762     <span class="comment">// and released there.</span>
00763     <span class="comment">//</span>
00764     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> );
00765 }
00766 
00767 ULONG
<a name="l00768"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a8">00768</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a11">IopGetRelationsCount</a>(
00769     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List
00770     )
00771 
00772 <span class="comment">/*++</span>
00773 <span class="comment"></span>
00774 <span class="comment">Routine Description:</span>
00775 <span class="comment"></span>
00776 <span class="comment">    Returns the total number of relations (Device Objects) in all the entries.</span>
00777 <span class="comment"></span>
00778 <span class="comment">Arguments:</span>
00779 <span class="comment"></span>
00780 <span class="comment">    List    Relation List.</span>
00781 <span class="comment"></span>
00782 <span class="comment">Return Value:</span>
00783 <span class="comment"></span>
00784 <span class="comment">    Count of relations (Device Objects).</span>
00785 <span class="comment"></span>
00786 <span class="comment">--*/</span>
00787 
00788 {
00789     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00790 
00791     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count;
00792 }
00793 
00794 ULONG
<a name="l00795"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a9">00795</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a12">IopGetRelationsTaggedCount</a>(
00796     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List
00797     )
00798 
00799 <span class="comment">/*++</span>
00800 <span class="comment"></span>
00801 <span class="comment">Routine Description:</span>
00802 <span class="comment"></span>
00803 <span class="comment">    Returns the total number of relations (Device Objects) in all the entries</span>
00804 <span class="comment">    which are tagged.</span>
00805 <span class="comment"></span>
00806 <span class="comment">Arguments:</span>
00807 <span class="comment"></span>
00808 <span class="comment">    List    Relation List.</span>
00809 <span class="comment"></span>
00810 <span class="comment">Return Value:</span>
00811 <span class="comment"></span>
00812 <span class="comment">    Count of tagged relations (Device Objects).</span>
00813 <span class="comment"></span>
00814 <span class="comment">--*/</span>
00815 
00816 {
00817     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00818 
00819     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount;
00820 }
00821 
00822 BOOLEAN
<a name="l00823"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a10">00823</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a13">IopIsRelationInList</a>(
00824     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List,
00825     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
00826     )
00827 
00828 <span class="comment">/*++</span>
00829 <span class="comment"></span>
00830 <span class="comment">Routine Description:</span>
00831 <span class="comment"></span>
00832 <span class="comment">    Checks if a relation (Device Object) exists in the specified relation list.</span>
00833 <span class="comment"></span>
00834 <span class="comment">Arguments:</span>
00835 <span class="comment"></span>
00836 <span class="comment">    List            Relation list to check.</span>
00837 <span class="comment"></span>
00838 <span class="comment">    DeviceObject    Relation to be checked.</span>
00839 <span class="comment"></span>
00840 <span class="comment"></span>
00841 <span class="comment">Return Value:</span>
00842 <span class="comment"></span>
00843 <span class="comment">    TRUE</span>
00844 <span class="comment"></span>
00845 <span class="comment">        Relation exists.</span>
00846 <span class="comment"></span>
00847 <span class="comment">    FALSE</span>
00848 <span class="comment"></span>
00849 <span class="comment">        Relation is not in the list.</span>
00850 <span class="comment"></span>
00851 <span class="comment">--*/</span>
00852 
00853 {
00854     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode;
00855     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00856     ULONG                   level;
00857     ULONG                   index;
00858 
00859     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00860 
00861     <span class="keywordflow">if</span> ((deviceNode = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00862         <span class="comment">//</span>
00863         <span class="comment">// The device object is a PDO.</span>
00864         <span class="comment">//</span>
00865         level = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>;
00866 
00867         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel) {
00868             <span class="comment">//</span>
00869             <span class="comment">// The level is within the range of levels stored in this list.</span>
00870             <span class="comment">//</span>
00871             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00872                 <span class="comment">//</span>
00873                 <span class="comment">// There is an Entry for this level.</span>
00874                 <span class="comment">//</span>
00875                 <span class="keywordflow">for</span> (index = 0; index &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; index++) {
00876                     <span class="comment">//</span>
00877                     <span class="comment">// For each Device in the entry, compare it to the given</span>
00878                     <span class="comment">// DeviceObject</span>
00879                     <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>) == (ULONG_PTR)DeviceObject) {
00880                         <span class="comment">//</span>
00881                         <span class="comment">// It matches</span>
00882                         <span class="comment">//</span>
00883                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00884                     }
00885                 }
00886             }
00887         }
00888     }
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// It wasn't a PDO</span>
00892     <span class="comment">//      or the level wasn't in the range of levels in this list</span>
00893     <span class="comment">//      or there are no DeviceObjects at the same level in this list</span>
00894     <span class="comment">//      or the DeviceObject isn't in the Entry for its level in this list</span>
00895     <span class="comment">//</span>
00896     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00897 }
00898 
00899 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00900"></a><a class="code" href="../../d7/d1/pnprlist_8h.html#a14">00900</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a14">IopMergeRelationLists</a>(
00901     IN OUT <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> TargetList,
00902     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> SourceList,
00903     IN BOOLEAN Tagged
00904     )
00905 
00906 <span class="comment">/*++</span>
00907 <span class="comment"></span>
00908 <span class="comment">Routine Description:</span>
00909 <span class="comment"></span>
00910 <span class="comment">    Merges two relation lists by copying all the relations from the source list</span>
00911 <span class="comment">    to the target list.  Source list remains unchanged.</span>
00912 <span class="comment"></span>
00913 <span class="comment">Arguments:</span>
00914 <span class="comment"></span>
00915 <span class="comment">    TargetList  List to which the relations from Sourcelist are added.</span>
00916 <span class="comment"></span>
00917 <span class="comment">    SourceList  List of relations to be added to TargetList.</span>
00918 <span class="comment"></span>
00919 <span class="comment">    Tagged      TRUE if relations from SourceList should be tagged when added to</span>
00920 <span class="comment">                TargetList.  If FALSE then relations added from SourceList are</span>
00921 <span class="comment">                untagged.</span>
00922 <span class="comment"></span>
00923 <span class="comment">Return Value:</span>
00924 <span class="comment"></span>
00925 <span class="comment">    STATUS_SUCCESS</span>
00926 <span class="comment"></span>
00927 <span class="comment">        All the relations in SourceList were added to TargetList successfully.</span>
00928 <span class="comment"></span>
00929 <span class="comment">    STATUS_OBJECT_NAME_COLLISION</span>
00930 <span class="comment"></span>
00931 <span class="comment">        One of the relations in SourceList already exists in TargetList.  This</span>
00932 <span class="comment">        is a fatal error and TargetList may already have some of the relations</span>
00933 <span class="comment">        from SourceList added.  This could be dealt with more gracefully if</span>
00934 <span class="comment">        necessary but the current callers of IopMergeRelationLists avoid this</span>
00935 <span class="comment">        situation.</span>
00936 <span class="comment"></span>
00937 <span class="comment">    STATUS_INSUFFICIENT_RESOURCES</span>
00938 <span class="comment"></span>
00939 <span class="comment">        There isn't enough PagedPool available to allocate a new</span>
00940 <span class="comment">        RELATION_LIST_ENTRY.</span>
00941 <span class="comment"></span>
00942 <span class="comment">    STATUS_INVALID_PARAMETER</span>
00943 <span class="comment"></span>
00944 <span class="comment">        The level of one of the relations in SourceList is less than FirstLevel</span>
00945 <span class="comment">        or greater than the MaxLevel.  This is a fatal error and TargetList may</span>
00946 <span class="comment">        already have some of the relations from SourceList added.  The only way</span>
00947 <span class="comment">        this could happen is if the tree lock isn't held or if TargetList has</span>
00948 <span class="comment">        been compressed by IopCompressRelationList.  Both situations would be</span>
00949 <span class="comment">        bugs in the caller.</span>
00950 <span class="comment"></span>
00951 <span class="comment">    STATUS_NO_SUCH_DEVICE</span>
00952 <span class="comment"></span>
00953 <span class="comment">        One of the relations in SourceList is not a PhysicalDeviceObject (PDO),</span>
00954 <span class="comment">        it doesn't have a DEVICE_NODE associated with it.  This is a fatal error</span>
00955 <span class="comment">        and TargetList may already have some of the relations from SourceList</span>
00956 <span class="comment">        added.  This should never happen since it was a PDO when it was added to</span>
00957 <span class="comment">        SourceList.</span>
00958 <span class="comment"></span>
00959 <span class="comment"></span>
00960 <span class="comment">--*/</span>
00961 
00962 {
00963     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
00964     ULONG                   levelIndex;
00965     ULONG                   entryIndex;
00966     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status = STATUS_SUCCESS;
00967 
00968     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00969 
00970     <span class="comment">//</span>
00971     <span class="comment">// For each level entry in SourceList</span>
00972     <span class="comment">//</span>
00973     <span class="keywordflow">for</span> (levelIndex = 0;
00974          levelIndex &lt;= (SourceList-&gt;MaxLevel - SourceList-&gt;FirstLevel);
00975          levelIndex++) {
00976 
00977         <span class="keywordflow">if</span> ((entry = SourceList-&gt;Entries[ levelIndex ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00978             <span class="comment">//</span>
00979             <span class="comment">// The Entry has Devices</span>
00980             <span class="comment">//</span>
00981             <span class="keywordflow">for</span> (entryIndex = 0; entryIndex &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; entryIndex++) {
00982                 <span class="comment">//</span>
00983                 <span class="comment">// For each Device in the Entry, add it to the target List.</span>
00984                 <span class="comment">//</span>
00985                 status = <a class="code" href="../../d7/d1/pnprlist_8h.html#a7">IopAddRelationToList</a>( TargetList,
00986                                                (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ entryIndex ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>),
00987                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00988                                                Tagged);
00989 
00990                 <span class="comment">//</span>
00991                 <span class="comment">// BUGBUG - Need to handle STATUS_INSUFFICIENT_RESOURCES more</span>
00992                 <span class="comment">// gracefully.  Currently the only way this can happen is</span>
00993                 <span class="comment">// during Eject and that code isn't enabled yet.</span>
00994                 <span class="comment">//</span>
00995                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
00996 
00997                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00998                     <span class="comment">//</span>
00999                     <span class="comment">// BUGBUG - We should undo the damage we've done to</span>
01000                     <span class="comment">// TargetList by removing those relations we've added from</span>
01001                     <span class="comment">// SourceList.</span>
01002                     <span class="comment">//</span>
01003                     <span class="keywordflow">break</span>;
01004                 }
01005             }
01006         }
01007     }
01008 
01009     <span class="keywordflow">return</span> status;
01010 }
01011 
01012 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01013"></a><a class="code" href="../../d7/d1/pnprlist_8h.html#a15">01013</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a15">IopRemoveIndirectRelationsFromList</a>(
01014     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List
01015     )
01016 
01017 <span class="comment">/*++</span>
01018 <span class="comment"></span>
01019 <span class="comment">Routine Description:</span>
01020 <span class="comment"></span>
01021 <span class="comment">    Removes all the relations without the DirectDescendant flag from a relation</span>
01022 <span class="comment">    list.</span>
01023 <span class="comment"></span>
01024 <span class="comment">Arguments:</span>
01025 <span class="comment"></span>
01026 <span class="comment">    List    List from which to remove the relations.</span>
01027 <span class="comment"></span>
01028 <span class="comment"></span>
01029 <span class="comment">Return Value:</span>
01030 <span class="comment"></span>
01031 <span class="comment">    STATUS_SUCCESS</span>
01032 <span class="comment"></span>
01033 <span class="comment">        The relations were removed successfully.</span>
01034 <span class="comment"></span>
01035 <span class="comment">--*/</span>
01036 
01037 {
01038     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>          deviceObject;
01039     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
01040     ULONG                   level;
01041     LONG                    index;
01042 
01043     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01044 
01045     <span class="comment">//</span>
01046     <span class="comment">// For each Entry in the list.</span>
01047     <span class="comment">//</span>
01048     <span class="keywordflow">for</span> (level = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel; level++) {
01049 
01050         <span class="comment">//</span>
01051         <span class="comment">// If the entry is allocated.</span>
01052         <span class="comment">//</span>
01053         <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01054 
01055             <span class="comment">//</span>
01056             <span class="comment">// For each Device in the list.</span>
01057             <span class="comment">//</span>
01058             <span class="keywordflow">for</span> (index = entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1; index &gt;= 0; index--) {
01059                 <span class="keywordflow">if</span> (!((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a2">RELATION_FLAG_DESCENDANT</a>)) {
01060 
01061                     deviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>);
01062 
01063                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( deviceObject );
01064 
01065                     <span class="keywordflow">if</span> ((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>) {
01066                         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount--;
01067                     }
01068 
01069                     <span class="keywordflow">if</span> (index &lt; ((LONG)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1)) {
01070 
01071                         RtlMoveMemory( &amp;entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ],
01072                                         &amp;entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index + 1 ],
01073                                         (entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - index - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
01074                     }
01075 
01076                     <span class="keywordflow">if</span> (--entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> == 0) {
01077                         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01078                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
01079                     }
01080 
01081                     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count--;
01082                 }
01083             }
01084         }
01085     }
01086     <span class="keywordflow">return</span> STATUS_SUCCESS;
01087 }
01088 
01089 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01090"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a13">01090</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a16">IopRemoveRelationFromList</a>(
01091     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List,
01092     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
01093     )
01094 
01095 <span class="comment">/*++</span>
01096 <span class="comment"></span>
01097 <span class="comment">Routine Description:</span>
01098 <span class="comment"></span>
01099 <span class="comment">    Removes a relation from a relation list.</span>
01100 <span class="comment"></span>
01101 <span class="comment">Arguments:</span>
01102 <span class="comment"></span>
01103 <span class="comment">    List            List from which to remove the relation.</span>
01104 <span class="comment"></span>
01105 <span class="comment">    DeviceObject    Relation to remove.</span>
01106 <span class="comment"></span>
01107 <span class="comment">Return Value:</span>
01108 <span class="comment"></span>
01109 <span class="comment">    STATUS_SUCCESS</span>
01110 <span class="comment"></span>
01111 <span class="comment">        The relation was removed successfully.</span>
01112 <span class="comment"></span>
01113 <span class="comment">    STATUS_NO_SUCH_DEVICE</span>
01114 <span class="comment"></span>
01115 <span class="comment">        The relation doesn't exist in the list.</span>
01116 <span class="comment"></span>
01117 <span class="comment">--*/</span>
01118 
01119 {
01120     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode;
01121     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
01122     ULONG                   level;
01123     LONG                    index;
01124 
01125     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01126 
01127     <span class="keywordflow">if</span> ((deviceNode = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01128         level = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>;
01129 
01130         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= List-&gt;MaxLevel);
01131 
01132         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel) {
01133             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01134                 <span class="keywordflow">for</span> (index = entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1; index &gt;= 0; index--) {
01135                     <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>) == (ULONG_PTR)DeviceObject) {
01136 
01137                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DeviceObject );
01138 
01139                         <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>) != 0) {
01140                             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount--;
01141                         }
01142                         <span class="keywordflow">if</span> (index &lt; ((LONG)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1)) {
01143 
01144                             RtlMoveMemory( &amp;entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ],
01145                                            &amp;entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index + 1 ],
01146                                            (entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - index - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
01147                         }
01148 
01149                         <span class="keywordflow">if</span> (--entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> == 0) {
01150                             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01151                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
01152                         }
01153 
01154                         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count--;
01155 
01156                         <span class="keywordflow">return</span> STATUS_SUCCESS;
01157                     }
01158                 }
01159             }
01160         }
01161     }
01162     <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
01163 }
01164 
01165 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01166"></a><a class="code" href="../../d6/d1/pnprlist_8c.html#a14">01166</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a17">IopSetAllRelationsTags</a>(
01167     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List,
01168     BOOLEAN Tagged
01169     )
01170 
01171 <span class="comment">/*++</span>
01172 <span class="comment"></span>
01173 <span class="comment">Routine Description:</span>
01174 <span class="comment"></span>
01175 <span class="comment">    Tags or untags all the relations in a relations list.</span>
01176 <span class="comment"></span>
01177 <span class="comment">Arguments:</span>
01178 <span class="comment"></span>
01179 <span class="comment">    List    Relation list containing relations to be tagged or untagged.</span>
01180 <span class="comment"></span>
01181 <span class="comment">    Tagged  TRUE if the relations should be tagged, FALSE if they are to be</span>
01182 <span class="comment">            untagged.</span>
01183 <span class="comment"></span>
01184 <span class="comment">Return Value:</span>
01185 <span class="comment"></span>
01186 <span class="comment">    NONE</span>
01187 <span class="comment"></span>
01188 <span class="comment">--*/</span>
01189 
01190 {
01191     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
01192     ULONG                   level;
01193     ULONG                   index;
01194 
01195     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">// For each Entry in the list.</span>
01199     <span class="comment">//</span>
01200     <span class="keywordflow">for</span> (level = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel; level++) {
01201 
01202         <span class="comment">//</span>
01203         <span class="comment">// If the entry is allocated.</span>
01204         <span class="comment">//</span>
01205         <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01206 
01207             <span class="comment">//</span>
01208             <span class="comment">// For each Device in the list.</span>
01209             <span class="comment">//</span>
01210             <span class="keywordflow">for</span> (index = 0; index &lt; entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a>; index++) {
01211 
01212                 <span class="comment">//</span>
01213                 <span class="comment">// Set or clear the tag based on the argument Tagged.</span>
01214                 <span class="comment">//</span>
01215                 <span class="keywordflow">if</span> (Tagged) {
01216                     entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] | <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
01217                 } <span class="keywordflow">else</span> {
01218                     entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
01219                 }
01220             }
01221         }
01222     }
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">// If we are setting the tags then update the TagCount to the number of</span>
01226     <span class="comment">// relations in the list.  Otherwise reset it to zero.</span>
01227     <span class="comment">//</span>
01228     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount = Tagged ? <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Count : 0;
01229 }
01230 
01231 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01232"></a><a class="code" href="../../d7/d1/pnprlist_8h.html#a18">01232</a> <a class="code" href="../../d7/d1/pnprlist_8h.html#a18">IopSetRelationsTag</a>(
01233     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List,
01234     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
01235     IN BOOLEAN Tagged
01236     )
01237 
01238 <span class="comment">/*++</span>
01239 <span class="comment"></span>
01240 <span class="comment">Routine Description:</span>
01241 <span class="comment"></span>
01242 <span class="comment">    Sets or clears a tag on a specified relation in a relations list.  This</span>
01243 <span class="comment">    routine is also used by some callers to determine if a relation exists in</span>
01244 <span class="comment">    a list and if so to set the tag.</span>
01245 <span class="comment"></span>
01246 <span class="comment">Arguments:</span>
01247 <span class="comment"></span>
01248 <span class="comment">    List            List containing relation to be tagged or untagged.</span>
01249 <span class="comment"></span>
01250 <span class="comment">    DeviceObject    Relation to be tagged or untagged.</span>
01251 <span class="comment"></span>
01252 <span class="comment">    Tagged          TRUE if relation is to be tagged, FALSE if it is to be</span>
01253 <span class="comment">                    untagged.</span>
01254 <span class="comment"></span>
01255 <span class="comment">Return Value:</span>
01256 <span class="comment"></span>
01257 <span class="comment">    STATUS_SUCCESS</span>
01258 <span class="comment"></span>
01259 <span class="comment">        The relation was tagged successfully.</span>
01260 <span class="comment"></span>
01261 <span class="comment">    STATUS_NO_SUCH_DEVICE</span>
01262 <span class="comment"></span>
01263 <span class="comment">        The relation doesn't exist in the list.</span>
01264 <span class="comment"></span>
01265 <span class="comment">--*/</span>
01266 
01267 {
01268     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode;
01269     <a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html">PRELATION_LIST_ENTRY</a>    entry;
01270     ULONG                   level;
01271     LONG                    index;
01272 
01273     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01274 
01275     <span class="keywordflow">if</span> ((deviceNode = DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01276         <span class="comment">//</span>
01277         <span class="comment">// DeviceObject is a PhysicalDeviceObject (PDO), get its level.</span>
01278         <span class="comment">//</span>
01279         level = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o4">Level</a>;
01280 
01281         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel &lt;= level &amp;&amp; level &lt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;MaxLevel) {
01282             <span class="comment">//</span>
01283             <span class="comment">// The level is within the range of levels in this List.</span>
01284             <span class="comment">//</span>
01285             <span class="keywordflow">if</span> ((entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Entries[ level - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;FirstLevel ]) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01286                 <span class="comment">//</span>
01287                 <span class="comment">// The Entry for this level is allocated.  Search each device</span>
01288                 <span class="comment">// in the Entry looking for a match.</span>
01289                 <span class="comment">//</span>
01290                 <span class="keywordflow">for</span> (index = entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o0">Count</a> - 1; index &gt;= 0; index--) {
01291 
01292                     <span class="keywordflow">if</span> (((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a0">RELATION_FLAGS</a>) == (ULONG_PTR)DeviceObject) {
01293 
01294                         <span class="comment">//</span>
01295                         <span class="comment">// We found a match</span>
01296                         <span class="comment">//</span>
01297                         <span class="keywordflow">if</span> ((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>) {
01298                             <span class="comment">//</span>
01299                             <span class="comment">// The relation is already tagged so to simplify the</span>
01300                             <span class="comment">// logic below decrement the TagCount.  We'll</span>
01301                             <span class="comment">// increment it later if the caller still wants it</span>
01302                             <span class="comment">// to be tagged.</span>
01303                             <span class="comment">//</span>
01304                             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount--;
01305                         }
01306 
01307                         <span class="keywordflow">if</span> (Tagged) {
01308                             <span class="comment">//</span>
01309                             <span class="comment">// Set the tag and increment the number of tagged</span>
01310                             <span class="comment">// relations.</span>
01311                             <span class="comment">//</span>
01312                             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] | <a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
01313                             <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;TagCount++;
01314                         } <span class="keywordflow">else</span> {
01315                             <span class="comment">//</span>
01316                             <span class="comment">// Clear the tag.</span>
01317                             <span class="comment">//</span>
01318                             entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)((ULONG_PTR)entry-&gt;<a class="code" href="../../d7/d3/struct__RELATION__LIST__ENTRY.html#o2">Devices</a>[ index ] &amp; ~<a class="code" href="../../d6/d1/pnprlist_8c.html#a1">RELATION_FLAG_TAGGED</a>);
01319                         }
01320 
01321                         <span class="keywordflow">return</span> STATUS_SUCCESS;
01322                     }
01323                 }
01324             }
01325         }
01326     }
01327 
01328     <span class="comment">//</span>
01329     <span class="comment">// It wasn't a PDO</span>
01330     <span class="comment">//      or the level wasn't in the range of levels in this list</span>
01331     <span class="comment">//      or there are no DeviceObjects at the same level in this list</span>
01332     <span class="comment">//      or the DeviceObject isn't in the Entry for its level in this list</span>
01333     <span class="comment">//</span>
01334     <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
01335 }
01336 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
