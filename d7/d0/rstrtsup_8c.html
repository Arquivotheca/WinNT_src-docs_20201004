<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rstrtsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rstrtsup.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>"</code><br>

<p>
<a href="../../d8/d9/rstrtsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/rstrtsup_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_RESTART_SUP)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN ULONG ThisRestartSize, IN BOOLEAN WaitForIo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d0/rstrtsup_8c.html#a2">LfsFindOldestClientLsn</a> (IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea, IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientArray, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> OldestLsn)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="rstrtsup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_RESTART_SUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00027">27</a> of file <a class="el" href="../../d8/d9/rstrtsup_8c-source.html">rstrtsup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="rstrtsup.c::LfsFindOldestClientLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsFindOldestClientLsn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OldestLsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00189">189</a> of file <a class="el" href="../../d8/d9/rstrtsup_8c-source.html">rstrtsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00355">LFS_NO_CLIENT</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00382">_LFS_CLIENT_RECORD::NextClient</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00365">_LFS_CLIENT_RECORD::OldestLsn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">LfsSetBaseLsnPriv()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>.
<p>
<pre class="fragment"><div>00197                    :
00198 
00199     This routine walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active clients to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oldest
00200     Lsn <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system must maintain.
00201 
00202 Arguments:
00203 
00204     RestartArea - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Restart Area to examine.
00205 
00206     ClientArray - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client data array.
00207 
00208     OldestLsn - We store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oldest Lsn we find in <span class="keyword">this</span> value.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00209         initialized with a starting value, we won'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> <span class="keywordflow">return</span> a more recent
00210         Lsn.
00211 
00212 Return Value:
00213 
00214     None.
00215 
00216 --*/
00217 
00218 {
00219     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NextClient;
00220 
00221     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientBlock;
00222 
00223     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00224 
00225     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsFindOldestClientLsn:  Entered\n"</span>, 0 );
00226     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"RestartArea       -&gt; %08lx\n"</span>, RestartArea );
00227     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (Low)    -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00228     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (High)   -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">//  Take the first client off the in use list.</span>
00232     <span class="comment">//</span>
00233 
00234     NextClient = RestartArea-&gt;ClientInUseList;
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">//  While there are more clients, compare their oldest Lsn with the</span>
00238     <span class="comment">//  current oldest.</span>
00239     <span class="comment">//</span>
00240 
00241     <span class="keywordflow">while</span> (NextClient != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00242 
00243         ClientBlock = ClientArray + NextClient;
00244 
00245         <span class="comment">//</span>
00246         <span class="comment">//  We ignore this block if it's oldest Lsn is 0.</span>
00247         <span class="comment">//</span>
00248 
00249         <span class="keywordflow">if</span> (( ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a>.QuadPart != 0 )
00250             &amp;&amp; ( ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a>.QuadPart &lt; OldestLsn-&gt;QuadPart )) {
00251 
00252             *OldestLsn = ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a>;
00253         }
00254 
00255         <span class="comment">//</span>
00256         <span class="comment">//  Try the next client block.</span>
00257         <span class="comment">//</span>
00258 
00259         NextClient = ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a>;
00260     }
00261 
00262     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"OldestLsn (Low)   -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00263     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"OldestLsn (High)  -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00264     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsFindOldestClientLsn:  Exit\n"</span>, 0 );
00265 
00266     <span class="keywordflow">return</span>;
00267 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="rstrtsup.c::LfsWriteLfsRestart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsWriteLfsRestart           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ThisRestartSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitForIo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">36</a> of file <a class="el" href="../../d8/d9/rstrtsup_8c-source.html">rstrtsup.c</a>.
<p>
References <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00196">_LBCB::ActiveLinks</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00471">_LFS_RESTART_AREA::ClientArrayOffset</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00203">_LBCB::FileOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00249">_LBCB::LastEndLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00242">_LBCB::LastLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00285">LBCB_NOT_EMPTY</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00284">LBCB_ON_ACTIVE_QUEUE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00287">LBCB_RESTART_LBCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00273">_LBCB::LbcbFlags</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00204">_LBCB::Length</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00602">LFCB_PACK_LOG</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00315">LfsAllocateLbcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00438">LfsAllocateRestartArea</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00037">LfsFlushLbcb()</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00228">_LBCB::PageHeader</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00195">_LBCB::WorkqueLinks</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03065">LfsInitializeLogFilePriv()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.
<p>
<pre class="fragment"><div>00044                    :
00045 
00046     This routine puts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs restart area on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue of operations to
00047     write to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  We <span class="keywordflow">do</span> <span class="keyword">this</span> by allocating a second restart area
00048     and attaching <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb.  We also allocate a buffer <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
00049     block to use <span class="keywordflow">for</span> <span class="keyword">this</span> write.  We look at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WaitForIo <span class="keywordtype">boolean</span> to
00050     determine whether <span class="keyword">this</span> thread can perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O.  This also indicates
00051     whether <span class="keyword">this</span> thread gives up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfcb.
00052 
00053 Arguments:
00054 
00055     Lfcb - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <span class="keyword">this</span> operation.
00056 
00057     ThisRestartSize - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size to use <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restart area.
00058 
00059     WaitForIo - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work.
00060 
00061 Return Value:
00062 
00063     None.
00064 
00065 --*/
00066 
00067 {
00068     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NewLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00069     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> NewRestart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00070 
00071     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00072 
00073     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsWriteLfsRestart:  Entered\n"</span>, 0 );
00074     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
00075     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Write Chkdsk  -&gt; %04x\n"</span>, WriteChkdsk );
00076     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Restart Size  -&gt; %08lx\n"</span>, ThisRestartSize );
00077     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"WaitForIo     -&gt; %08lx\n"</span>, WaitForIo );
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00081     <span class="comment">//</span>
00082 
00083     <span class="keywordflow">try</span> {
00084 
00085         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ActiveLbcb;
00086 
00087         <span class="comment">//</span>
00088         <span class="comment">//  We allocate another restart area and</span>
00089         <span class="comment">//  copy the current area into it.  Attach the new area to the Lfcb.</span>
00090         <span class="comment">//</span>
00091 
00092         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a18">LfsAllocateRestartArea</a>( &amp;NewRestart, ThisRestartSize );
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">//  We allocate a Lbcb structure and update the values to</span>
00096         <span class="comment">//  reflect this restart area.</span>
00097         <span class="comment">//</span>
00098 
00099         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a>( Lfcb, &amp;NewLbcb );
00100         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_RESTART_LBCB );
00101 
00102         <span class="comment">//</span>
00103         <span class="comment">//  If this is the second page, then add a system page to the offset.</span>
00104         <span class="comment">//</span>
00105 
00106         <span class="keywordflow">if</span> (!Lfcb-&gt;InitialRestartArea) {
00107 
00108             NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> = Lfcb-&gt;SystemPageSize + NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>;
00109         }
00110 
00111         (ULONG)NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o5">Length</a> = ThisRestartSize;
00112 
00113         NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a> = (PVOID) Lfcb-&gt;RestartArea;
00114 
00115         <span class="comment">//</span>
00116         <span class="comment">//  Lets put the current lsn in the Lbcb.</span>
00117         <span class="comment">//</span>
00118 
00119         NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o11">LastEndLsn</a> = NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o10">LastLsn</a> = Lfcb-&gt;NextRestartLsn;
00120         Lfcb-&gt;NextRestartLsn.QuadPart = 1 + Lfcb-&gt;NextRestartLsn.QuadPart;
00121 
00122         <span class="comment">//</span>
00123         <span class="comment">//  Copy the existing restart area into the new area.</span>
00124         <span class="comment">//</span>
00125 
00126         RtlCopyMemory( NewRestart, Lfcb-&gt;RestartArea, ThisRestartSize );
00127         Lfcb-&gt;RestartArea = NewRestart;
00128 
00129         Lfcb-&gt;ClientArray = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NewRestart, Lfcb-&gt;ClientArrayOffset, <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00130 
00131         NewRestart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00132 
00133         <span class="comment">//</span>
00134         <span class="comment">//  Update the Lfcb to indicate that the other restart area</span>
00135         <span class="comment">//  on the disk is to be used.</span>
00136         <span class="comment">//</span>
00137 
00138         Lfcb-&gt;InitialRestartArea = !Lfcb-&gt;InitialRestartArea;
00139 
00140         <span class="comment">//</span>
00141         <span class="comment">//  Add this Lbcb to the end of the workque and flush to that point.</span>
00142         <span class="comment">//</span>
00143 
00144         InsertTailList( &amp;Lfcb-&gt;LbcbWorkque, &amp;NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">//  If we don't support a packed log file then we need to make</span>
00148         <span class="comment">//  sure that all file records written out ahead of this</span>
00149         <span class="comment">//  restart area make it out to disk and we don't add anything</span>
00150         <span class="comment">//  to this page.</span>
00151         <span class="comment">//</span>
00152 
00153         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, LFCB_PACK_LOG )
00154             &amp;&amp; !IsListEmpty( &amp;Lfcb-&gt;LbcbActive )) {
00155 
00156             ActiveLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00157                                             <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00158                                             ActiveLinks );
00159 
00160             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ActiveLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_NOT_EMPTY )) {
00161 
00162                 RemoveEntryList( &amp;ActiveLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a> );
00163                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ActiveLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, LBCB_ON_ACTIVE_QUEUE );
00164             }
00165         }
00166 
00167         <span class="keywordflow">if</span> (WaitForIo) {
00168 
00169             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a53">LfsFlushLbcb</a>( Lfcb, NewLbcb );
00170         }
00171 
00172     } finally {
00173 
00174         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsWriteLfsRestart );
00175 
00176         <span class="keywordflow">if</span> (NewRestart != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00177 
00178             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewRestart );
00179         }
00180 
00181         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsWriteLfsRestart:  Exit\n"</span>, 0 );
00182     }
00183 
00184     <span class="keywordflow">return</span>;
00185 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
