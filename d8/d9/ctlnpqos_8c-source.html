<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ctlnpqos.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ctlnpqos.c</h1><a href="../../d7/d0/ctlnpqos_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00003 <span class="comment">//                                                                          //</span>
00004 <span class="comment">//                Global Definitions                                        //</span>
00005 <span class="comment">//                                                                          //</span>
00007 <span class="comment"></span>
<a name="l00008"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">00008</a> <span class="preprocessor">#define DevPrint</span>
00009 <span class="preprocessor"></span><span class="comment">//#define DevPrint DbgPrint</span>
00010 
<a name="l00011"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">00011</a> <span class="preprocessor">#define Error(N,S) { DbgPrint(#N); DbgPrint(" Error %08lx\n", S); }</span>
00012 <span class="preprocessor"></span>
<a name="l00013"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">00013</a> <span class="preprocessor">#define Delay(SECONDS) {                                               \</span>
00014 <span class="preprocessor">    LARGE_INTEGER Time;                                                \</span>
00015 <span class="preprocessor">    Time.QuadPart = -10 * 1000 * 1000, ((LONGLONG)SECONDS);            \</span>
00016 <span class="preprocessor">    NtDelayExecution(TRUE,(PLARGE_INTEGER)&amp;Time);                               \</span>
00017 <span class="preprocessor">}</span>
00018 <span class="preprocessor"></span>
00019 
00021 <span class="comment">//                                                                          //</span>
00022 <span class="comment">//                Global Variables                                          //</span>
00023 <span class="comment">//                                                                          //</span>
00025 <span class="comment"></span>
<a name="l00026"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a3">00026</a>     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
<a name="l00027"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">00027</a>     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
<a name="l00028"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a5">00028</a>     STRING <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a5">EventName</a>;
<a name="l00029"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a6">00029</a>     UNICODE_STRING <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a6">UnicodeEventName</a>;
<a name="l00030"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">00030</a>     HANDLE <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>;
<a name="l00031"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a8">00031</a>     STRING <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>;
<a name="l00032"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a9">00032</a>     UNICODE_STRING <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a9">UnicodePortName</a>;
<a name="l00033"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a10">00033</a>     STRING <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a10">RelativePortName</a>;
<a name="l00034"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a11">00034</a>     UNICODE_STRING <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a11">UnicodeRelativePortName</a>;
<a name="l00035"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a12">00035</a>     HANDLE <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a12">EarPort</a>;
<a name="l00036"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">00036</a>     HANDLE <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>;
<a name="l00037"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">00037</a>     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>;
<a name="l00038"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a15">00038</a>     ULONG <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a15">RequestCount</a>;
<a name="l00039"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">00039</a>     HANDLE <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>;
<a name="l00040"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">00040</a>     TOKEN_STATISTICS <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>;
<a name="l00041"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a18">00041</a>     ULONG <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a18">IgnoreLength</a>;
00042 
<a name="l00043"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a19">00043</a>     HANDLE <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a19">SepServerThread</a>;
00044 
00045 
00046 
00047 
00049 <span class="comment">//                                                                          //</span>
00050 <span class="comment">//                Test Routine Definitions                                  //</span>
00051 <span class="comment">//                                                                          //</span>
00053 <span class="comment"></span>BOOLEAN
00054 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a15">SepClientTestStatic</a>(VOID);
00055 
00056 BOOLEAN
00057 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a16">SepClientTestDynamic</a>(VOID);
00058 
00059 BOOLEAN
00060 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a17">SepClientTestEffectiveOnly</a>(
00061     BOOLEAN StaticTest
00062     );
00063 
00064 BOOLEAN
00065 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a18">SepClientTestNotEffectiveOnly</a>(
00066     BOOLEAN StaticTest
00067     );
00068 
00069 BOOLEAN
00070 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a19">SepClientTestAnonymous</a>(
00071     BOOLEAN StaticTest,
00072     BOOLEAN EffectiveOnly
00073     );
00074 
00075 BOOLEAN
00076 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a20">SepClientTestIdentification</a>(
00077     BOOLEAN StaticTest,
00078     BOOLEAN EffectiveOnly
00079     );
00080 
00081 BOOLEAN
00082 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a21">SepClientTestImpersonation</a>(
00083     BOOLEAN StaticTest,
00084     BOOLEAN EffectiveOnly
00085     );
00086 
00087 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00088 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a22">SepClientConnect</a>(
00089     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel,
00090     SECURITY_CONTEXT_TRACKING_MODE TrackingMode,
00091     BOOLEAN EffectiveOnly
00092     );
00093 
00094 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00095 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a23">SepClientMakeRemoteCall</a>( VOID );
00096 
00097 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00098 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a24">SepClientDropConnection</a>( VOID );
00099 
00100 BOOLEAN
00101 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a25">SepClientTest</a>(VOID);
00102 
00103 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00104 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a31">SepClientInitialize</a>(
00105   );
00106 
00107 
00108 
00109 
00110 
00111 
00112 BOOLEAN
00113 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a27">SepServerTestStatic</a>(VOID);
00114 
00115 BOOLEAN
00116 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a28">SepServerTestDynamic</a>(VOID);
00117 
00118 BOOLEAN
00119 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a29">SepServerTestEffectiveOnly</a>(
00120     BOOLEAN StaticTest
00121     );
00122 
00123 BOOLEAN
00124 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a30">SepServerTestNotEffectiveOnly</a>(
00125     BOOLEAN StaticTest
00126     );
00127 
00128 BOOLEAN
00129 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a31">SepServerTestAnonymous</a>(
00130     BOOLEAN StaticTest,
00131     BOOLEAN EffectiveOnly
00132     );
00133 
00134 BOOLEAN
00135 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a32">SepServerTestIdentification</a>(
00136     BOOLEAN StaticTest,
00137     BOOLEAN EffectiveOnly
00138     );
00139 
00140 BOOLEAN
00141 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a33">SepServerTestImpersonation</a>(
00142     BOOLEAN StaticTest,
00143     BOOLEAN EffectiveOnly
00144     );
00145 
00146 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00147 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a34">SepServerWaitForNextConnect</a>( VOID );
00148 
00149 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00150 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a35">SepServerGetNextMessage</a>( VOID );
00151 
00152 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00153 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a36">SepServerCompleteMessage</a>( VOID );
00154 
00155 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00156 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a37">SepServerDropConnection</a>( VOID );
00157 
00158 
00159 
00160 BOOLEAN
00161 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a38">SepServerTest</a>(VOID);
00162 
00163 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00164 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a44">SepServerInitialize</a>(
00165   );
00166 
00167 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00168 <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a40">SepServerSpawnClientProcess</a>(VOID);
00169 
00170 
00171 
00172 
00173 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00174 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a46">SepWritePipe</a>( PSZ String );
00175 
00176 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00177 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a57">SepReadPipe</a>(VOID);
00178 
00179 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00180 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a48">SepTransceivePipe</a>( PSZ String );
00181 
00182 
00183 
00184 
00185 HANDLE
00186 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a49">SepServerCreatePipe</a>(VOID);
00187 
00188 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00189 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a58">SepServerListenPipe</a>(VOID);
00190 
00191 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00192 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a59">SepServerImpersonatePipe</a>(VOID);
00193 
00194 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00195 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a60">SepServerDisconnectPipe</a>(VOID);
00196 
00197 
00198 
00199 
00200 HANDLE
00201 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a53">SepClientOpenPipe</a>( VOID );
00202 
00203 
00204 
00205 
00206 BOOLEAN
00207 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a54">CtLnpQos</a> (VOID);
00208 
00209 
00211 <span class="comment">//                                                                          //</span>
00212 <span class="comment">//                Client-Side Test Routines                                 //</span>
00213 <span class="comment">//                                                                          //</span>
00215 <span class="comment"></span>
00216 
00217 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00218"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a27">00218</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a22">SepClientConnect</a>(
00219     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel,
00220     SECURITY_CONTEXT_TRACKING_MODE TrackingMode,
00221     BOOLEAN EffectiveOnly
00222     )
00223 
00224 {
00225 
00226     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>.ImpersonationLevel = ImpersonationLevel;
00227     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>.ContextTrackingMode = TrackingMode;
00228     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>.EffectiveOnly = EffectiveOnly;
00229 
00230     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"\nClient: "</span>);
00231     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a> = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a53">SepClientOpenPipe</a>();
00232 
00233     <span class="keywordflow">return</span>;
00234 }
00235 
00236 
00237 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00238"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a28">00238</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a23">SepClientMakeRemoteCall</a>( VOID )
00239 
00240 {
00241 
00242     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"\nClient: "</span>);
00243     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a48">SepTransceivePipe</a>( <span class="stringliteral">"Make Client Call\n"</span> );
00244 
00245     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a15">RequestCount</a> += 1;
00246 
00247     <span class="keywordflow">return</span>;
00248 }
00249 
00250 
00251 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00252"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a29">00252</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a24">SepClientDropConnection</a>( VOID )
00253 
00254 {
00255 
00256     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a> );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00257 
00258     <span class="keywordflow">return</span>;
00259 
00260 }
00261 
00262 
00263 BOOLEAN
<a name="l00264"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a20">00264</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a15">SepClientTestStatic</a>(VOID)
00265 
00266 {
00267 
00268     BOOLEAN CompletionStatus;
00269 
00270     <span class="comment">//</span>
00271     <span class="comment">//  Static Context Tracking ... Suite</span>
00272     <span class="comment">//</span>
00273 
00274     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a17">SepClientTestEffectiveOnly</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00275 
00276 
00277     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00278 
00279         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a18">SepClientTestNotEffectiveOnly</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00280     }
00281 
00282     <span class="keywordflow">return</span> CompletionStatus;
00283 
00284 }
00285 
00286 
00287 BOOLEAN
<a name="l00288"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a21">00288</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a16">SepClientTestDynamic</a>(VOID)
00289 
00290 {
00291     BOOLEAN CompletionStatus;
00292 
00293     <span class="comment">//</span>
00294     <span class="comment">// Dynamic Context Tracking ... Suite</span>
00295     <span class="comment">//</span>
00296 
00297     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a17">SepClientTestEffectiveOnly</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00298 
00299 
00300     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00301 
00302         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a18">SepClientTestNotEffectiveOnly</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00303     }
00304 
00305     <span class="keywordflow">return</span> CompletionStatus;
00306 
00307 }
00308 
00309 
00310 BOOLEAN
<a name="l00311"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a22">00311</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a17">SepClientTestEffectiveOnly</a>(
00312     BOOLEAN StaticTest
00313     )
00314 
00315 
00316 {
00317 
00318     BOOLEAN CompletionStatus;
00319 
00320     <span class="comment">//</span>
00321     <span class="comment">// Effective Only ... Test</span>
00322     <span class="comment">//</span>
00323 
00324     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a19">SepClientTestAnonymous</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00325     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00326         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a20">SepClientTestIdentification</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00327     }
00328     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00329         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a21">SepClientTestImpersonation</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00330     }
00331 
00332     <span class="keywordflow">return</span> CompletionStatus;
00333 
00334 }
00335 
00336 
00337 BOOLEAN
<a name="l00338"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a23">00338</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a18">SepClientTestNotEffectiveOnly</a>(
00339     BOOLEAN StaticTest
00340     )
00341 
00342 {
00343     BOOLEAN CompletionStatus;
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// Not Effective Only ... Test</span>
00347     <span class="comment">//</span>
00348 
00349     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a19">SepClientTestAnonymous</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00350     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00351         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a20">SepClientTestIdentification</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00352     }
00353     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00354         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a21">SepClientTestImpersonation</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00355     }
00356 
00357     <span class="keywordflow">return</span> CompletionStatus;
00358 
00359 }
00360 
00361 
00362 BOOLEAN
<a name="l00363"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a24">00363</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a19">SepClientTestAnonymous</a>(
00364     BOOLEAN StaticTest,
00365     BOOLEAN EffectiveOnly
00366     )
00367 
00368 {
00369 
00371     <span class="comment">//                                                                      //</span>
00372     <span class="comment">//        Anonymous Use Test                                            //</span>
00373     <span class="comment">//                                                                      //</span>
00375 <span class="comment"></span>
00376     SECURITY_CONTEXT_TRACKING_MODE TrackingMode;
00377 
00378     <span class="keywordflow">if</span> (StaticTest) {
00379         TrackingMode = SECURITY_STATIC_TRACKING;
00380     } <span class="keywordflow">else</span> {
00381         TrackingMode = SECURITY_DYNAMIC_TRACKING;
00382     }
00383 
00384     <span class="keywordflow">if</span> (!StaticTest) {
00385         <span class="comment">//</span>
00386         <span class="comment">// No action for dynamic test</span>
00387         <span class="comment">//</span>
00388         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00389     }
00390 
00391     <span class="comment">//</span>
00392     <span class="comment">// Anonymous Use ... Test</span>
00393     <span class="comment">//</span>
00394 
00395 
00396     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a22">SepClientConnect</a>(
00397         SecurityAnonymous,
00398         TrackingMode,
00399         EffectiveOnly
00400         );
00401 
00402     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a23">SepClientMakeRemoteCall</a>();
00403 
00404     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a24">SepClientDropConnection</a>();
00405 
00406 
00407     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00408 }
00409 
00410 
00411 BOOLEAN
<a name="l00412"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a25">00412</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a20">SepClientTestIdentification</a>(
00413     BOOLEAN StaticTest,
00414     BOOLEAN EffectiveOnly
00415     )
00416 
00417 {
00418 
00420     <span class="comment">//                                                                      //</span>
00421     <span class="comment">//        Identification Use Test                                       //</span>
00422     <span class="comment">//                                                                      //</span>
00424 <span class="comment"></span>
00425     SECURITY_CONTEXT_TRACKING_MODE TrackingMode;
00426 
00427     <span class="keywordflow">if</span> (StaticTest) {
00428         TrackingMode = SECURITY_STATIC_TRACKING;
00429     } <span class="keywordflow">else</span> {
00430         TrackingMode = SECURITY_DYNAMIC_TRACKING;
00431     }
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Identification Use ... Test</span>
00435     <span class="comment">//</span>
00436 
00437 
00438     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a22">SepClientConnect</a>(
00439         SecurityIdentification,
00440         TrackingMode,
00441         EffectiveOnly
00442         );
00443 
00444     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a23">SepClientMakeRemoteCall</a>();
00445 
00446     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a24">SepClientDropConnection</a>();
00447 
00448 
00449     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00450 
00451 }
00452 
00453 
00454 BOOLEAN
<a name="l00455"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a26">00455</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a21">SepClientTestImpersonation</a>(
00456     BOOLEAN StaticTest,
00457     BOOLEAN EffectiveOnly
00458     )
00459 
00460 {
00461 
00463     <span class="comment">//                                                                      //</span>
00464     <span class="comment">//        Impersonation Use Test                                        //</span>
00465     <span class="comment">//                                                                      //</span>
00467 <span class="comment"></span>
00468     SECURITY_CONTEXT_TRACKING_MODE TrackingMode;
00469 
00470     <span class="keywordflow">if</span> (StaticTest) {
00471         TrackingMode = SECURITY_STATIC_TRACKING;
00472     } <span class="keywordflow">else</span> {
00473         TrackingMode = SECURITY_DYNAMIC_TRACKING;
00474     }
00475 
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Impersonation Use ... Test</span>
00479     <span class="comment">//</span>
00480 
00481 
00482     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a22">SepClientConnect</a>(
00483         SecurityImpersonation,
00484         TrackingMode,
00485         EffectiveOnly
00486         );
00487 
00488     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a23">SepClientMakeRemoteCall</a>();
00489 
00490     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a24">SepClientDropConnection</a>();
00491 
00492 
00493 
00494     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00495 
00496 }
00497 
00498 
00499 
00500 
00501 BOOLEAN
<a name="l00502"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a30">00502</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a25">SepClientTest</a>(VOID)
00503 <span class="comment">//</span>
00504 <span class="comment">// Tests:</span>
00505 <span class="comment">//</span>
00506 <span class="comment">//      Static Context Tracking Tests</span>
00507 <span class="comment">//          Effective Only</span>
00508 <span class="comment">//              Anonymous</span>
00509 <span class="comment">//              Identification</span>
00510 <span class="comment">//              Impersonation</span>
00511 <span class="comment">//          Not Effective Only</span>
00512 <span class="comment">//              Anonymous</span>
00513 <span class="comment">//              Identification</span>
00514 <span class="comment">//              Impersonation</span>
00515 <span class="comment">//</span>
00516 <span class="comment">//      Dynamic Context Tracking Tests</span>
00517 <span class="comment">//          Effective Only</span>
00518 <span class="comment">//              Identification</span>
00519 <span class="comment">//              Impersonation</span>
00520 <span class="comment">//          Not Effective Only</span>
00521 <span class="comment">//              Identification</span>
00522 <span class="comment">//              Impersonation</span>
00523 <span class="comment">//</span>
00524 {
00525 
00526     BOOLEAN CompletionStatus;
00527 
00528 
00529 
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Run the static test suite...</span>
00533     <span class="comment">//</span>
00534 
00535     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a15">SepClientTestStatic</a>();
00536 
00537     <span class="comment">//</span>
00538     <span class="comment">// Run the dynamic test suite...</span>
00539     <span class="comment">//</span>
00540 
00541     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00542         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a16">SepClientTestDynamic</a>();
00543     }
00544 
00545     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: Client Test Complete.\n"</span>);
00546 
00547 
00548     <span class="keywordflow">return</span> CompletionStatus;
00549 }
00550 
00551 
00552 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00553"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a31">00553</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a31">SepClientInitialize</a>(
00554   )
00555 
00556 {
00557 
00558 
00559 
00560     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: Client Initializing ...\n"</span>);
00561 
00562 
00563     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a15">RequestCount</a> = 0;
00564 
00565 
00566     <span class="comment">//</span>
00567     <span class="comment">// Signal the named event to start the test</span>
00568     <span class="comment">//</span>
00569 
00570     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: Client Starting Test ...\n"</span>);
00571     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ); <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00572 
00573     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> ); <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00574 
00575 
00576     <span class="keywordflow">return</span> STATUS_SUCCESS;
00577 }
00578 
00579 
00581 <span class="comment">//                                                                          //</span>
00582 <span class="comment">//                Server-Side Test Routines                                 //</span>
00583 <span class="comment">//                                                                          //</span>
00585 <span class="comment"></span>
00586 
00587 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00588"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a39">00588</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a34">SepServerWaitForNextConnect</a>( VOID )
00589 {
00590 
00591     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"\nServer: "</span>);
00592     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a58">SepServerListenPipe</a>();
00593 
00594     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
00595                  NtCurrentProcess(),     <span class="comment">// SourceProcessHandle</span>
00596                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a12">EarPort</a>,                <span class="comment">// SourceHandle</span>
00597                  NtCurrentProcess(),     <span class="comment">// TargetProcessHandle</span>
00598                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>,              <span class="comment">// TargetHandle</span>
00599                  0,                      <span class="comment">// DesiredAccess (over-ridden by option)</span>
00600                  0,                      <span class="comment">// HandleAttributes</span>
00601                  DUPLICATE_SAME_ACCESS   <span class="comment">// Options</span>
00602                  );
00603     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00604 
00605 
00606     <span class="keywordflow">return</span>;
00607 
00608 }
00609 
00610 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00611"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a40">00611</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a35">SepServerGetNextMessage</a>( VOID )
00612 
00613 {
00614 
00615 
00616 
00617     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"\nServer: "</span>);
00618     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a57">SepReadPipe</a>();
00619 
00620     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a15">RequestCount</a> += 1;
00621 
00622     <span class="keywordflow">return</span>;
00623 }
00624 
00625 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00626"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a41">00626</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a36">SepServerCompleteMessage</a>( VOID )
00627 
00628 {
00629 
00630     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"\nServer: "</span>);
00631     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a46">SepWritePipe</a>(<span class="stringliteral">"Return From Server\n"</span>);
00632     <span class="keywordflow">return</span>;
00633 }
00634 
00635 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00636"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a55">00636</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a42">SepServerImpersonateClient</a>( VOID )
00637 
00638 {
00639 
00640     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"\nServer: "</span>);
00641     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a59">SepServerImpersonatePipe</a>( );
00642 
00643 }
00644 
00645 
00646 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00647"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a56">00647</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a43">SepServerRevertToSelf</a>( VOID )
00648 
00649 {
00650     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> TmpStatus;
00651     HANDLE NullHandle;
00652 
00653     NullHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00654     TmpStatus = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
00655                     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a19">SepServerThread</a>,
00656                     ThreadImpersonationToken,
00657                     (PVOID)&amp;NullHandle,
00658                     (ULONG)<span class="keyword">sizeof</span>(HANDLE)
00659                     );   <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(TmpStatus);
00660 
00661 }
00662 
00663 
00664 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00665"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a42">00665</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a37">SepServerDropConnection</a>( VOID )
00666 
00667 {
00668     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"\nServer: "</span>);
00669     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a60">SepServerDisconnectPipe</a>();
00670 
00671     <span class="keywordflow">return</span>;
00672 }
00673 
00674 BOOLEAN
<a name="l00675"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a32">00675</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a27">SepServerTestStatic</a>(VOID)
00676 
00677 {
00678     BOOLEAN CompletionStatus;
00679 
00680     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:    Static Context Tracking ...                           Suite\n"</span>);
00681 
00682     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a29">SepServerTestEffectiveOnly</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00683 
00684 
00685     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00686 
00687         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a30">SepServerTestNotEffectiveOnly</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00688     }
00689 
00690     <span class="keywordflow">return</span> CompletionStatus;
00691 
00692 }
00693 
00694 
00695 BOOLEAN
<a name="l00696"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a33">00696</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a28">SepServerTestDynamic</a>(VOID)
00697 
00698 {
00699     BOOLEAN CompletionStatus;
00700 
00701     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:    Dynamic Context Tracking ...                          Suite\n"</span>);
00702 
00703     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a29">SepServerTestEffectiveOnly</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00704 
00705 
00706     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00707 
00708         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a30">SepServerTestNotEffectiveOnly</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00709     }
00710 
00711     <span class="keywordflow">return</span> CompletionStatus;
00712 
00713 }
00714 
00715 
00716 BOOLEAN
<a name="l00717"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a34">00717</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a29">SepServerTestEffectiveOnly</a>(
00718     BOOLEAN StaticTest
00719     )
00720 
00721 {
00722 
00723     BOOLEAN CompletionStatus;
00724 
00725     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:      Effective Only ...                                    Test\n"</span>);
00726 
00727     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a31">SepServerTestAnonymous</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00728     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00729         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a32">SepServerTestIdentification</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00730     }
00731     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00732         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a33">SepServerTestImpersonation</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00733     }
00734 
00735     <span class="keywordflow">return</span> CompletionStatus;
00736 
00737 }
00738 
00739 
00740 BOOLEAN
<a name="l00741"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a35">00741</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a30">SepServerTestNotEffectiveOnly</a>(
00742     BOOLEAN StaticTest
00743     )
00744 
00745 {
00746 
00747     BOOLEAN CompletionStatus;
00748 
00749     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:      Not Effective Only ...                                Test\n"</span>);
00750 
00751     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a31">SepServerTestAnonymous</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00752     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00753         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a32">SepServerTestIdentification</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00754     }
00755     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00756         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a33">SepServerTestImpersonation</a>( StaticTest, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00757     }
00758 
00759     <span class="keywordflow">return</span> CompletionStatus;
00760 
00761 }
00762 
00763 
00764 BOOLEAN
<a name="l00765"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a36">00765</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a31">SepServerTestAnonymous</a>(
00766     BOOLEAN StaticTest,
00767     BOOLEAN EffectiveOnly
00768     )
00769 
00770 {
00771     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00772 
00774     <span class="comment">//                                                                      //</span>
00775     <span class="comment">//        Anonymous Use Test                                            //</span>
00776     <span class="comment">//                                                                      //</span>
00778 <span class="comment"></span>
00779 
00780     <span class="keywordflow">if</span> (!StaticTest) {
00781         <span class="comment">//</span>
00782         <span class="comment">// No action for dynamic test</span>
00783         <span class="comment">//</span>
00784 
00785         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00786     }
00787 
00788     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:        Anonymous Use ...                                     "</span>);
00789 
00790     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a34">SepServerWaitForNextConnect</a>();
00791 
00792     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a35">SepServerGetNextMessage</a>();
00793 
00794 
00795     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a42">SepServerImpersonateClient</a>();
00796     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
00797                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a19">SepServerThread</a>,
00798                  TOKEN_ALL_ACCESS,
00799                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00800                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>
00801                  );
00802     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a43">SepServerRevertToSelf</a>();
00803     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_OPEN_ANONYMOUS) {
00804 
00805         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" Succeeded\n"</span>);
00806 
00807     } <span class="keywordflow">else</span> {
00808         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"* ! FAILED (srvr) ! *\n"</span>);
00809         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Status is: 0x%lx \n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00810         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00811     }
00812 
00813 
00814     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a36">SepServerCompleteMessage</a>();
00815 
00816     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a37">SepServerDropConnection</a>();
00817 
00818     <span class="comment">//</span>
00819     <span class="comment">// Appease the compiler Gods..</span>
00820     <span class="comment">//</span>
00821 
00822     <span class="keywordflow">if</span> (EffectiveOnly) {;}
00823 
00824 
00825     <span class="keywordflow">return</span> CompletionStatus;
00826 
00827 }
00828 
00829 
00830 BOOLEAN
<a name="l00831"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a37">00831</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a32">SepServerTestIdentification</a>(
00832     BOOLEAN StaticTest,
00833     BOOLEAN EffectiveOnly
00834     )
00835 
00836 {
00837 
00838     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00840     <span class="comment">//                                                                      //</span>
00841     <span class="comment">//        Identification Use Test                                       //</span>
00842     <span class="comment">//                                                                      //</span>
00844 <span class="comment"></span>
00845     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:        Identification Use ...                                "</span>);
00846 
00847     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a34">SepServerWaitForNextConnect</a>();
00848 
00849     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a35">SepServerGetNextMessage</a>();
00850 
00851     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a42">SepServerImpersonateClient</a>();
00852     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
00853                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a19">SepServerThread</a>,
00854                  TOKEN_ALL_ACCESS,
00855                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00856                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>
00857                  );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00858     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a43">SepServerRevertToSelf</a>();
00859     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00860                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,
00861                  TokenStatistics,
00862                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>,
00863                  (ULONG)<span class="keyword">sizeof</span>(TOKEN_STATISTICS),
00864                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a18">IgnoreLength</a>
00865                  );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00866 
00867     <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>.TokenType == TokenImpersonation) &amp;&amp;
00868          (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>.ImpersonationLevel == SecurityIdentification)
00869        ) {
00870         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" Succeeded\n"</span>);
00871 
00872     } <span class="keywordflow">else</span> {
00873         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"* ! FAILED (srvr) ! *\n"</span>);
00874         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00875     }
00876 
00877 
00878     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a36">SepServerCompleteMessage</a>();
00879 
00880     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a37">SepServerDropConnection</a>();
00881 
00882     <span class="comment">//</span>
00883     <span class="comment">// Appease the compiler Gods..</span>
00884     <span class="comment">//</span>
00885     <span class="keywordflow">if</span> (StaticTest) {;}
00886     <span class="keywordflow">if</span> (EffectiveOnly) {;}
00887 
00888     <span class="keywordflow">return</span> CompletionStatus;
00889 }
00890 
00891 
00892 BOOLEAN
<a name="l00893"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a38">00893</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a33">SepServerTestImpersonation</a>(
00894     BOOLEAN StaticTest,
00895     BOOLEAN EffectiveOnly
00896     )
00897 
00898 {
00899     BOOLEAN CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00900 
00902     <span class="comment">//                                                                      //</span>
00903     <span class="comment">//        Impersonation Use Test                                        //</span>
00904     <span class="comment">//                                                                      //</span>
00906 <span class="comment"></span>
00907     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:        Impersonation Use ...                                 "</span>);
00908 
00909 
00910     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a34">SepServerWaitForNextConnect</a>();
00911 
00912     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a35">SepServerGetNextMessage</a>();
00913 
00914 
00915 
00916     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a42">SepServerImpersonateClient</a>();
00917     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
00918                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a19">SepServerThread</a>,
00919                  TOKEN_ALL_ACCESS,
00920                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00921                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>
00922                  );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00923     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a43">SepServerRevertToSelf</a>();
00924     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00925                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,
00926                  TokenStatistics,
00927                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>,
00928                  (ULONG)<span class="keyword">sizeof</span>(TOKEN_STATISTICS),
00929                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a18">IgnoreLength</a>
00930                  );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00931 
00932     <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>.TokenType == TokenImpersonation) &amp;&amp;
00933          (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>.ImpersonationLevel == SecurityImpersonation)
00934        ) {
00935         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" Succeeded\n"</span>);
00936 
00937     } <span class="keywordflow">else</span> {
00938         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"* ! FAILED (srvr) ! *\n"</span>);
00939         CompletionStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00940     }
00941 
00942 
00943 
00944 
00945     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a36">SepServerCompleteMessage</a>();
00946 
00947     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a37">SepServerDropConnection</a>();
00948 
00949     <span class="comment">//</span>
00950     <span class="comment">// Appease the compiler gods</span>
00951     <span class="comment">//</span>
00952     <span class="keywordflow">if</span> (StaticTest) {;}
00953     <span class="keywordflow">if</span> (EffectiveOnly) {;}
00954 
00955     <span class="keywordflow">return</span> CompletionStatus;
00956 }
00957 
00958 
00959 BOOLEAN
<a name="l00960"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a43">00960</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a38">SepServerTest</a>(VOID)
00961 <span class="comment">//</span>
00962 <span class="comment">// Tests:</span>
00963 <span class="comment">//</span>
00964 <span class="comment">//      Static Context Tracking Tests</span>
00965 <span class="comment">//          Effective Only</span>
00966 <span class="comment">//              Anonymous</span>
00967 <span class="comment">//              Identification</span>
00968 <span class="comment">//              Impersonation</span>
00969 <span class="comment">//          Not Effective Only</span>
00970 <span class="comment">//              Anonymous</span>
00971 <span class="comment">//              Identification</span>
00972 <span class="comment">//              Impersonation</span>
00973 <span class="comment">//</span>
00974 <span class="comment">//      Dynamic Context Tracking Tests</span>
00975 <span class="comment">//          Effective Only</span>
00976 <span class="comment">//              Identification</span>
00977 <span class="comment">//              Impersonation</span>
00978 <span class="comment">//          Not Effective Only</span>
00979 <span class="comment">//              Identification</span>
00980 <span class="comment">//              Impersonation</span>
00981 <span class="comment">//</span>
00982 {
00983 
00984     BOOLEAN CompletionStatus;
00985 
00986 
00987     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: Server Starting Test ...\n"</span>);
00988 
00989     <span class="comment">//</span>
00990     <span class="comment">// Run the static test suite...</span>
00991     <span class="comment">//</span>
00992 
00993     CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a27">SepServerTestStatic</a>();
00994 
00995     <span class="comment">//</span>
00996     <span class="comment">// Run the dynamic test suite...</span>
00997     <span class="comment">//</span>
00998 
00999     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01000         CompletionStatus = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a28">SepServerTestDynamic</a>();
01001     }
01002 
01003     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: Server Test Complete.\n"</span>);
01004 
01005     <span class="comment">//</span>
01006     <span class="comment">// Print test results</span>
01007     <span class="comment">//</span>
01008 
01009     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01010     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01011     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**********************\n"</span>);
01012     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**                  **\n"</span>);
01013 
01014     <span class="keywordflow">if</span> (CompletionStatus == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01015         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**  Test Succeeded  **\n"</span>);
01016     } <span class="keywordflow">else</span> {
01017         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**  Test Failed !!  **\n"</span>);
01018     }
01019 
01020     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**                  **\n"</span>);
01021     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**********************\n"</span>);
01022 
01023     <span class="keywordflow">return</span> CompletionStatus;
01024 
01025 }
01026 
01027 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01028"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a44">01028</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a44">SepServerInitialize</a>(
01029   )
01030 
01031 {
01032 
01033     OBJECT_ATTRIBUTES ThreadAttributes;
01034     PTEB CurrentTeb;
01035 
01036 
01037     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: Server Initializing ...\n"</span>);
01038 
01039     <span class="comment">//</span>
01040     <span class="comment">// Initialize global variables</span>
01041     <span class="comment">//</span>
01042 
01043     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a15">RequestCount</a> = 0;
01044 
01045     <span class="comment">//</span>
01046     <span class="comment">// Get a handle to our thread to so that we can access our thread</span>
01047     <span class="comment">// even when impersonating an anonymous client (which we can't do</span>
01048     <span class="comment">// using NtCurrentThread()).</span>
01049     <span class="comment">//</span>
01050 
01051     CurrentTeb = NtCurrentTeb();
01052     InitializeObjectAttributes(&amp;ThreadAttributes, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01053     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/psopen_8c.html#a1">NtOpenThread</a>(
01054                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a19">SepServerThread</a>,           <span class="comment">// TargetHandle</span>
01055                  THREAD_ALL_ACCESS,          <span class="comment">// DesiredAccess</span>
01056                  &amp;ThreadAttributes,          <span class="comment">// ObjectAttributes</span>
01057                  &amp;CurrentTeb-&gt;ClientId       <span class="comment">// ClientId</span>
01058                  );
01059     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01060 
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">// Create the server's port</span>
01064     <span class="comment">//</span>
01065 
01066     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a12">EarPort</a> = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a49">SepServerCreatePipe</a>();
01067 
01068 
01069 
01070     <span class="comment">//</span>
01071     <span class="comment">// Spawn a copy of ourselves...</span>
01072     <span class="comment">//</span>
01073 
01074     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: Server Spawning client process ...\n"</span>);
01075     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a40">SepServerSpawnClientProcess</a>();
01076 
01077 
01078     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: Server waiting for start of test signal ...\n"</span>);
01079 
01080     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(
01081                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>,
01082                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01083                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01084                  ); <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01085 
01086     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a> );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01087 
01088 
01089     <span class="keywordflow">return</span> STATUS_SUCCESS;
01090 }
01091 
01092 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01093"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a45">01093</a> <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a40">SepServerSpawnClientProcess</a>(VOID)
01094 
01095 {
01096 
01097     RTL_USER_PROCESS_INFORMATION ProcessInformation;
01098     STRING ProgramName;
01099     UNICODE_STRING UnicodeProgramName;
01100     STRING ImagePathName;
01101     UNICODE_STRING UnicodeImagePathName;
01102     PRTL_USER_PROCESS_PARAMETERS ProcessParameters;
01103 
01104     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;ProgramName, <span class="stringliteral">"\\SystemRoot\\Bin\\utlnpqos.exe"</span> );
01105     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01106                  &amp;UnicodeProgramName,
01107                  &amp;ProgramName,
01108                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01109     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;ImagePathName, <span class="stringliteral">"utlnpqos.exe"</span>);
01110     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01111                  &amp;UnicodeImagePathName,
01112                  &amp;ImagePathName,
01113                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01114 
01115 
01116     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a8">RtlCreateProcessParameters</a>(
01117                  &amp;ProcessParameters,
01118                  &amp;ImagePathName,        <span class="comment">// FIX, FIX &amp;UnicodeImagePathName, (when converted to unicode)</span>
01119                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01120                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01121                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01122                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01123                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01124                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01125                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01126                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01127                  );
01128 
01129     <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01130     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;UnicodeImagePathName );
01131 
01132 
01133     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a12">RtlCreateUserProcess</a>(
01134                  &amp;ProgramName,                   <span class="comment">// FIX, FIX &amp;UnicodeProgramName (when converted to unicode)</span>
01135                  ProcessParameters,              <span class="comment">// ProcessParameters</span>
01136                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                           <span class="comment">// ProcessSecurityDescriptor</span>
01137                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                           <span class="comment">// ThreadSecurityDescriptor</span>
01138                  NtCurrentProcess(),             <span class="comment">// ParentProcess</span>
01139                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                          <span class="comment">// InheritHandles</span>
01140                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                           <span class="comment">// DebugPort</span>
01141                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                           <span class="comment">// ExceptionPort</span>
01142                  &amp;ProcessInformation             <span class="comment">// ProcessInformation</span>
01143                  ); <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01144     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;UnicodeProgramName );
01145 
01146     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(
01147                   ProcessInformation.Thread,
01148                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01149                   ); <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01150 
01151     <a class="code" href="../../d0/d2/rtlexec_8c.html#a9">RtlDestroyProcessParameters</a>( ProcessParameters );
01152 
01153 }
01154 
01155 
01156 
01157 
01159 <span class="comment">//                                                                          //</span>
01160 <span class="comment">//                Main Program Entry Routine                                //</span>
01161 <span class="comment">//                                                                          //</span>
01163 <span class="comment"></span>
01164 BOOLEAN
<a name="l01165"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a54">01165</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a54">CtLnpQos</a> (VOID)
01166 {
01167 
01168     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01169 
01170     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;<a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>, <span class="stringliteral">"\\Device\\NamedPipe\\TestLnpQosServerPort"</span> );
01171     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01172                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a9">UnicodePortName</a>,
01173                  &amp;<a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>,
01174                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01175 
01176     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a10">RelativePortName</a>, <span class="stringliteral">"TestLnpQosServerPort"</span> );
01177     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01178                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a11">UnicodeRelativePortName</a>,
01179                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a10">RelativePortName</a>,
01180                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01181 
01182 
01183     <span class="comment">//</span>
01184     <span class="comment">// Determine whether we are the client or server side of the test.</span>
01185     <span class="comment">// This is done by creating or opening a named event object.  If the</span>
01186     <span class="comment">// event does not yet exist, then we are the client, and must create</span>
01187     <span class="comment">// the server process.  Otherwise, we are the server and the client</span>
01188     <span class="comment">// is waiting for us to signal the event.</span>
01189     <span class="comment">//</span>
01190 
01191     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a5">EventName</a>, <span class="stringliteral">"\\TestLnpQosEvent"</span> );
01192     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01193                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a6">UnicodeEventName</a>,
01194                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a5">EventName</a>,
01195                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01196 
01197     InitializeObjectAttributes(
01198         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01199         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a6">UnicodeEventName</a>,
01200         OBJ_OPENIF,
01201         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01202         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01203         );
01204     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(
01205                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a7">EventHandle</a>,
01206                  EVENT_ALL_ACCESS,
01207                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01208                  SynchronizationEvent,
01209                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01210                  );
01211     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a6">UnicodeEventName</a> );
01212 
01213     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_EXISTS) {
01214 
01215         <span class="comment">//</span>
01216         <span class="comment">// Server is already running, therefore, this process gets to be</span>
01217         <span class="comment">// the client.</span>
01218         <span class="comment">//</span>
01219 
01220         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a31">SepClientInitialize</a>(); <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01221         Result = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a25">SepClientTest</a>();
01222 
01223     } <span class="keywordflow">else</span> {
01224 
01225         <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01226 
01227         <span class="comment">//</span>
01228         <span class="comment">// Event wasn't yet there, so we must be the server.</span>
01229         <span class="comment">//</span>
01230 
01231     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: Starting Local Named Pipe Impersonation Test.\n"</span>);
01232 
01233         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a44">SepServerInitialize</a>(); <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01234         Result = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a38">SepServerTest</a>();
01235 
01236     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se: End Test.\n"</span>);
01237 
01238         }
01239 
01240 
01241 
01242     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>( NtCurrentThread(), STATUS_SUCCESS);
01243     <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01244 
01245     <span class="keywordflow">return</span> Result;
01246 
01247 }
01248 
01249 
01251 <span class="comment">//                                                                          //</span>
01252 <span class="comment">//   Named Pipe Common Operations                                           //</span>
01253 <span class="comment">//                                                                          //</span>
01255 <span class="comment"></span>
01256 
01257 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01258"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a57">01258</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a57">SepReadPipe</a>(
01259     )
01260 {
01261     IO_STATUS_BLOCK Iosb;
01262     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[512];
01263 
01264     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"ReadPipe...\n"</span>, 0);
01265 
01266     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/io_2read_8c.html#a1">NtReadFile</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>,
01267                                       (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01268                                       (PIO_APC_ROUTINE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01269                                       (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01270                                       &amp;Iosb,
01271                                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01272                                       512,
01273                                       (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01274                                       (PULONG) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))) {
01275         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d6/d5/io_2read_8c.html#a1">NtReadFile</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01276     }
01277 
01278     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))) {
01279 
01280         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01281     }
01282 
01283     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb.Status)) {
01284 
01285         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( NtReadFileFinalStatus, Iosb.Status );
01286     }
01287 
01288     <span class="keywordflow">return</span>;
01289 }
01290 
01291 
01292 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01293"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a46">01293</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a46">SepWritePipe</a>(
01294     PSZ String
01295     )
01296 {
01297     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01298     IO_STATUS_BLOCK Iosb;
01299 
01300 
01301     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"WritePipe...\n"</span>, 0);
01302 
01303     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/io_2write_8c.html#a0">NtWriteFile</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>,
01304                                        (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01305                                        (PIO_APC_ROUTINE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01306                                        (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01307                                        &amp;Iosb,
01308                                        <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>,
01309                                        <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>( <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> ),
01310                                        (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01311                                        (PULONG)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))) {
01312         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d0/d0/io_2write_8c.html#a0">NtWriteFile</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01313     }
01314 
01315     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))) {
01316 
01317         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01318     }
01319 
01320     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb.Status)) {
01321 
01322         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( NtWriteFileFinalStatus, Iosb.Status );
01323     }
01324 
01325     <span class="keywordflow">return</span>;
01326 }
01327 
01328 
01329 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01330"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a48">01330</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a48">SepTransceivePipe</a>(
01331     PSZ String
01332     )
01333 {
01334     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01335     IO_STATUS_BLOCK Iosb;
01336     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[512];
01337 
01338 
01339     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"TransceivePipe...\n"</span>, 0);
01340 
01341     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01342                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>,
01343                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// Event</span>
01344                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// ApcRoutine</span>
01345                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// ApcContext</span>
01346                                 &amp;Iosb,
01347                                 FSCTL_PIPE_TRANSCEIVE,
01348                                 <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>,
01349                                 <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>( <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> ),
01350                                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01351                                 511
01352                                 ))) {
01353         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( NtTransceiveFile, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01354     }
01355 
01356     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))) {
01357 
01358         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01359     }
01360 
01361     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb.Status)) {
01362 
01363         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( NtTransceiveFileFinalStatus, Iosb.Status );
01364     }
01365 
01366     <span class="keywordflow">return</span>;
01367 }
01368 
01369 
01371 <span class="comment">//                                                                          //</span>
01372 <span class="comment">//   Named Pipe Server Operations                                           //</span>
01373 <span class="comment">//                                                                          //</span>
01375 <span class="comment"></span>
01376 HANDLE
<a name="l01377"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a49">01377</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a49">SepServerCreatePipe</a>(
01378     VOID
01379     )
01380 {
01381     HANDLE PipeHandle;
01382     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01383     IO_STATUS_BLOCK Iosb;
01384     LARGE_INTEGER Timeout;
01385     <a class="code" href="../../d3/d2/utlnpqos_8c.html#a3">READ_MODE</a> Mode;
01386     ULONG Share;
01387     <a class="code" href="../../d3/d2/utlnpqos_8c.html#a7">NAMED_PIPE_CONFIGURATION</a> Config = FILE_PIPE_FULL_DUPLEX;
01388     <a class="code" href="../../d3/d2/utlnpqos_8c.html#a1">NAMED_PIPE_TYPE</a> PipeType        = FILE_PIPE_MESSAGE_TYPE;
01389     <a class="code" href="../../d3/d2/utlnpqos_8c.html#a5">COMPLETION_MODE</a> CompletionMode  = FILE_PIPE_QUEUE_OPERATION;
01390     ULONG MaximumInstances          = 4;
01391 
01392 
01393     <span class="comment">//</span>
01394     <span class="comment">//  Set the default timeout to 60 seconds, and initalize the attributes</span>
01395     <span class="comment">//</span>
01396 
01397     Timeout.QuadPart = -10 * 1000 * 1000 * 60;
01398 
01399     InitializeObjectAttributes(
01400         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01401         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a9">UnicodePortName</a>,
01402         OBJ_CASE_INSENSITIVE,
01403         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01404         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01405         );
01406 
01407     <span class="comment">//</span>
01408     <span class="comment">//  Calculate the readmode and share access</span>
01409     <span class="comment">//</span>
01410 
01411     Mode = (PipeType == FILE_PIPE_MESSAGE_TYPE ? FILE_PIPE_MESSAGE_MODE :
01412                                                  FILE_PIPE_BYTE_STREAM_MODE);
01413 
01414     Share = (Config == FILE_PIPE_INBOUND  ? FILE_SHARE_WRITE :
01415             (Config == FILE_PIPE_OUTBOUND ? FILE_SHARE_READ :
01416                                             FILE_SHARE_READ | FILE_SHARE_WRITE));
01417 
01418     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/io_2create_8c.html#a1">NtCreateNamedPipeFile</a>(
01419                                 &amp;PipeHandle,
01420                                 GENERIC_READ | GENERIC_WRITE | SYNCHRONIZE,
01421                                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01422                                 &amp;Iosb,
01423                                 Share,
01424                                 FILE_CREATE,
01425                                 0,
01426                                 PipeType,
01427                                 Mode,
01428                                 CompletionMode,
01429                                 MaximumInstances,
01430                                 1024,
01431                                 1024,
01432                                 (PLARGE_INTEGER)&amp;Timeout ))) {
01433 
01434         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( CreatePipe, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01435     }
01436     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a9">UnicodePortName</a> );
01437 
01438     <span class="keywordflow">return</span> PipeHandle;
01439 }
01440 
01441 
01442 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01443"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a58">01443</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a58">SepServerListenPipe</a>(
01444     )
01445 {
01446     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01447     IO_STATUS_BLOCK Iosb;
01448 
01449     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"ListenPipe...\n"</span>, 0);
01450 
01451     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01452                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a12">EarPort</a>,
01453                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// Event</span>
01454                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// ApcRoutine</span>
01455                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// ApcContext</span>
01456                                 &amp;Iosb,
01457                                 FSCTL_PIPE_LISTEN,
01458                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// InputBuffer</span>
01459                                 0,      <span class="comment">// InputBufferLength,</span>
01460                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// OutputBuffer</span>
01461                                 0       <span class="comment">// OutputBufferLength</span>
01462                                 ))) {
01463 
01464         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( ListenPipe, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01465     }
01466     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a12">EarPort</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))) {
01467 
01468         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01469     }
01470 
01471     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb.Status)) {
01472 
01473         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( ListenPipeFinalStatus, Iosb.Status );
01474     }
01475 
01476 
01477     <span class="keywordflow">return</span>;
01478 }
01479 
01480 
01481 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01482"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a59">01482</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a59">SepServerImpersonatePipe</a>(
01483     )
01484 {
01485     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01486     IO_STATUS_BLOCK Iosb;
01487 
01488     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"ImpersonatePipe...\n"</span>, 0);
01489 
01490     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01491                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>,
01492                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// Event</span>
01493                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// ApcRoutine</span>
01494                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// ApcContext</span>
01495                                 &amp;Iosb,
01496                                 FSCTL_PIPE_IMPERSONATE,
01497                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// InputBuffer</span>
01498                                 0,      <span class="comment">// InputBufferLength,</span>
01499                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// OutputBuffer</span>
01500                                 0       <span class="comment">// OutputBufferLength</span>
01501                                 ))) {
01502 
01503         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( ImpersonatePipe, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01504     }
01505     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))) {
01506 
01507         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01508     }
01509 
01510     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb.Status)) {
01511 
01512         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( ImpersonatePipeFinalStatus, Iosb.Status );
01513     }
01514 
01515     <span class="keywordflow">return</span>;
01516 }
01517 
01518 
01519 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01520"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a60">01520</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a60">SepServerDisconnectPipe</a>(
01521     )
01522 {
01523     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01524     IO_STATUS_BLOCK Iosb;
01525 
01526     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"DisconnectPipe...\n"</span>, 0);
01527     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"        (Flush)...\n"</span>, 0);
01528 
01529     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/io_2misc_8c.html#a3">NtFlushBuffersFile</a>(
01530                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a>,
01531                                 &amp;Iosb
01532                                 ))) {
01533         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( DisconnectPipe, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01534     }
01535 
01536     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb.Status)) {
01537 
01538         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( FlushPipeFinalStatus, Iosb.Status );
01539     }
01540 
01541 
01542     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"        (Close Talk Port)...\n"</span>, 0);
01543     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a13">TalkPort</a> ); <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01544 
01545     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a0">DevPrint</a>(<span class="stringliteral">"        (Disconnect)...\n"</span>, 0);
01546     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01547                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a12">EarPort</a>,
01548                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// Event</span>
01549                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// ApcRoutine</span>
01550                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// ApcContext</span>
01551                                 &amp;Iosb,
01552                                 FSCTL_PIPE_DISCONNECT,
01553                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// InputBuffer</span>
01554                                 0,      <span class="comment">// InputBufferLength,</span>
01555                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// OutputBuffer</span>
01556                                 0       <span class="comment">// OutputBufferLength</span>
01557                                 ))) {
01558 
01559         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( DisconnectPipe, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01560     }
01561     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a12">EarPort</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))) {
01562 
01563         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01564     }
01565 
01566     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb.Status)) {
01567 
01568         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( DisconnectPipeFinalStatus, Iosb.Status );
01569     }
01570 
01571     <span class="keywordflow">return</span>;
01572 }
01573 
01574 
01576 <span class="comment">//                                                                          //</span>
01577 <span class="comment">//   Named Pipe Client Operations                                           //</span>
01578 <span class="comment">//                                                                          //</span>
01580 <span class="comment"></span>
01581 HANDLE
<a name="l01582"></a><a class="code" href="../../d7/d0/ctlnpqos_8c.html#a53">01582</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a53">SepClientOpenPipe</a>(
01583     VOID
01584     )
01585 {
01586     HANDLE PipeHandle, NpfsHandle;
01587     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01588     IO_STATUS_BLOCK Iosb;
01589     ULONG Share;
01590     STRING Npfs;
01591     UNICODE_STRING UnicodeNpfs;
01592     PFILE_PIPE_WAIT_FOR_BUFFER WaitPipe;
01593     ULONG WaitPipeLength;
01594     <a class="code" href="../../d3/d2/utlnpqos_8c.html#a7">NAMED_PIPE_CONFIGURATION</a> Config = FILE_PIPE_FULL_DUPLEX;
01595     <a class="code" href="../../d3/d2/utlnpqos_8c.html#a3">READ_MODE</a> ReadMode              = FILE_PIPE_MESSAGE_MODE;
01596     <a class="code" href="../../d3/d2/utlnpqos_8c.html#a5">COMPLETION_MODE</a> CompletionMode  = FILE_PIPE_QUEUE_OPERATION;
01597 
01598 
01599 <span class="comment">//#ifdef NOT_YET_WORKING</span>
01600     <span class="comment">//</span>
01601     <span class="comment">// Wait for the server's pipe to reach a listen state...</span>
01602     <span class="comment">//</span>
01603 
01604     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Npfs, <span class="stringliteral">"\\Device\\NamedPipe\\"</span>);
01605     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
01606                  &amp;UnicodeNpfs,
01607                  &amp;Npfs,
01608                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );  <a class="code" href="../../d2/d6/tsecomm_8c.html#a0">SEASSERT_SUCCESS</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
01609 
01610     InitializeObjectAttributes(
01611         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01612         &amp;UnicodeNpfs,
01613         OBJ_CASE_INSENSITIVE,
01614         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01615         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01616 
01617     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/open_8c.html#a0">NtOpenFile</a>(
01618                                 &amp;NpfsHandle,
01619                                 GENERIC_READ | SYNCHRONIZE,
01620                                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01621                                 &amp;Iosb,
01622                                 FILE_SHARE_READ,
01623                                 0 ))) {
01624 
01625         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( OpenNpfs, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01626     }
01627     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;UnicodeNpfs );
01628 
01629     WaitPipeLength =
01630         FIELD_OFFSET(FILE_PIPE_WAIT_FOR_BUFFER, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>[0]) +
01631         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a10">RelativePortName</a>.MaximumLength;                 <span class="comment">//UNICODEFIX UnicodeRelativePortName.MaximumLength;</span>
01632     WaitPipe = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, WaitPipeLength);
01633     WaitPipe-&gt;TimeoutSpecified = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01634 
01635     WaitPipe-&gt;NameLength = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a10">RelativePortName</a>.Length;     <span class="comment">//UNICODEFIX UnicodeRelativePortName.Length;</span>
01636     strcpy(WaitPipe-&gt;Name, <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a10">RelativePortName</a>.Buffer);    <span class="comment">//UNICODEFIX UnicodePortName.Buffer;</span>
01637 
01638     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
01639                                 NpfsHandle,
01640                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,        <span class="comment">// Event</span>
01641                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,        <span class="comment">// ApcRoutine</span>
01642                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,        <span class="comment">// ApcContext</span>
01643                                 &amp;Iosb,
01644                                 FSCTL_PIPE_WAIT,
01645                                 WaitPipe,       <span class="comment">// Buffer for data to the FS</span>
01646                                 WaitPipeLength,
01647                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,        <span class="comment">// OutputBuffer</span>
01648                                 0            <span class="comment">// OutputBufferLength</span>
01649                                 ))) {
01650 
01651         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( ClientWaitPipe, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01652     }
01653     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
01654         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( NpfsHandle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ))) {
01655 
01656             <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01657         }
01658     }
01659 
01660     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Iosb.Status)) {
01661 
01662         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( ClientWaitPipeFinalStatus, Iosb.Status );
01663     }
01664 
01665     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( NpfsHandle );
01666     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01667 <span class="comment">//#endif  // NOT_YET_WORKING</span>
01668 <span class="comment">//    Delay(1);</span>
01669 
01670 
01671     <span class="comment">//</span>
01672     <span class="comment">//  Initialize the attributes</span>
01673     <span class="comment">//</span>
01674 
01675     InitializeObjectAttributes(
01676         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01677         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a9">UnicodePortName</a>,
01678         OBJ_CASE_INSENSITIVE,
01679         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01680         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01681         );
01682     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.SecurityQualityOfService = (PVOID)(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>);
01683 
01684     <span class="comment">//</span>
01685     <span class="comment">//  Calculate the share access</span>
01686     <span class="comment">//</span>
01687 
01688     Share = (Config == FILE_PIPE_INBOUND  ? FILE_SHARE_WRITE :
01689             (Config == FILE_PIPE_OUTBOUND ? FILE_SHARE_READ :
01690                        FILE_SHARE_READ | FILE_SHARE_WRITE));
01691 
01692 
01693 
01694     <span class="comment">//</span>
01695     <span class="comment">// And now open it...</span>
01696     <span class="comment">//</span>
01697 
01698     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/open_8c.html#a0">NtOpenFile</a>(
01699                                 &amp;PipeHandle,
01700                                 GENERIC_READ | GENERIC_WRITE | SYNCHRONIZE,
01701                                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01702                                 &amp;Iosb,
01703                                 Share,
01704                                 0 ))) {
01705 
01706         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( OpenPipe, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01707     }
01708 
01709     <span class="keywordflow">if</span> ((ReadMode != FILE_PIPE_BYTE_STREAM_MODE) ||
01710         (CompletionMode != FILE_PIPE_QUEUE_OPERATION)) {
01711 
01712         FILE_PIPE_INFORMATION <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01713 
01714         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.ReadMode = ReadMode;
01715         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.CompletionMode = CompletionMode;
01716 
01717         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a>(
01718                                 PipeHandle,
01719                                 &amp;Iosb,
01720                                 &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01721                                 <span class="keyword">sizeof</span>(FILE_PIPE_INFORMATION),
01722                                 FilePipeInformation ))) {
01723 
01724             <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>( <a class="code" href="../../d6/d9/restrfil_8c.html#a38">NtSetInformationFile</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01725         }
01726     }
01727 
01728     <span class="keywordflow">return</span> PipeHandle;
01729 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
