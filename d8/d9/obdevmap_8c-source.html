<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obdevmap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obdevmap.c</h1><a href="../../d7/d0/obdevmap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    obdevmap.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains routines for creating and querying Device Map objects.</span>
00012 <span class="comment">    Device Map objects define a DOS device name space, such as drive letters</span>
00013 <span class="comment">    and peripheral devices (e.g. COM1)</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Steve Wood (stevewo) 01-Oct-1996</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00024 
00025 <span class="preprocessor">#if defined(ALLOC_PRAGMA)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00027 <span class="preprocessor"></span>
00028 
00029 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00030"></a><a class="code" href="../../d7/d0/obdevmap_8c.html#a0">00030</a> <a class="code" href="../../d7/d0/obdevmap_8c.html#a0">ObSetDeviceMap</a> (
00031     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess OPTIONAL,
00032     IN HANDLE DirectoryHandle
00033     )
00034 
00035 <span class="comment">/*++</span>
00036 <span class="comment"></span>
00037 <span class="comment">Routine Description:</span>
00038 <span class="comment"></span>
00039 <span class="comment">    This function sets the device map for the specified process, using</span>
00040 <span class="comment">    the specified object directory.  A device map is a structure</span>
00041 <span class="comment">    associated with an object directory and a process.  When the object</span>
00042 <span class="comment">    manager sees a references to a name beginning with \??\ or just \??,</span>
00043 <span class="comment">    then it follows the device map object in the calling process's</span>
00044 <span class="comment">    EPROCESS structure to get to the object directory to use for that</span>
00045 <span class="comment">    reference.  This allows multiple virtual \??  object directories on</span>
00046 <span class="comment">    a per process basis.  The WindowStation logic will use this</span>
00047 <span class="comment">    functionality to allocate devices unique to each WindowStation.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Arguments:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    TargetProcess - Specifies the target process to associate the device map</span>
00052 <span class="comment">        with.  If null then the current process is used and the directory</span>
00053 <span class="comment">        becomes the system default dos device map.</span>
00054 <span class="comment"></span>
00055 <span class="comment">    DirectoryHandle - Specifies the object directory to associate with the</span>
00056 <span class="comment">        device map.</span>
00057 <span class="comment"></span>
00058 <span class="comment"></span>
00059 <span class="comment">Return Value:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    Returns one of the following status codes:</span>
00062 <span class="comment"></span>
00063 <span class="comment">        STATUS_SUCCESS - normal, successful completion.</span>
00064 <span class="comment"></span>
00065 <span class="comment">        STATUS_SHARING_VIOLATION - The specified object directory is already</span>
00066 <span class="comment">            associated with a device map.</span>
00067 <span class="comment"></span>
00068 <span class="comment">        STATUS_INSUFFICIENT_RESOURCES - Unable to allocate pool for the device</span>
00069 <span class="comment">            map data structure;</span>
00070 <span class="comment"></span>
00071 <span class="comment">        STATUS_ACCESS_DENIED - Caller did not have DIRECTORY_TRAVERSE access</span>
00072 <span class="comment">            to the specified object directory.</span>
00073 <span class="comment"></span>
00074 <span class="comment">--*/</span>
00075 
00076 {
00077     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00078     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> DosDevicesDirectory;
00079     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap;
00080     PVOID Object;
00081     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00082     KIRQL OldIrql;
00083 
00084     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">//  Reference the object directory handle and see if it is already</span>
00088     <span class="comment">//  associated with a device map structure.  If so, fail this call.</span>
00089     <span class="comment">//</span>
00090 
00091     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a>,
00092                                         DIRECTORY_TRAVERSE,
00093                                         <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>,
00094                                         KeGetPreviousMode(),
00095                                         &amp;DosDevicesDirectory,
00096                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00097 
00098     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00099 
00100         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00101     }
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">//  Capture the device map</span>
00105     <span class="comment">//</span>
00106     
00107     ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, &amp;OldIrql );
00108     
00109     DeviceMap = DosDevicesDirectory-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a>;
00110     
00111     <span class="comment">//</span>
00112     <span class="comment">//  Check if the directory already has a dos device map</span>
00113     <span class="comment">//</span>
00114     
00115     <span class="keywordflow">if</span> (DeviceMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00116         
00117         <span class="comment">//</span>
00118         <span class="comment">//  Test if the DeviceMap is about to delete and has the</span>
00119         <span class="comment">//  ReferenceCount 0</span>
00120         <span class="comment">//</span>
00121     
00122         <span class="keywordflow">if</span> (DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a> != 0) {
00123         
00124             <span class="comment">//</span>
00125             <span class="comment">//  We have a dos device map, so setup the target process to be either</span>
00126             <span class="comment">//  what the caller specified or the current process</span>
00127             <span class="comment">//</span>
00128 
00129             <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Target = TargetProcess;
00130 
00131             <span class="keywordflow">if</span> (Target == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00132 
00133                 Target = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00134             }
00135 
00136             <span class="comment">//</span>
00137             <span class="comment">//  If the current process already has the exact same dos device map</span>
00138             <span class="comment">//  then everything is already done and nothing left for us to do.</span>
00139             <span class="comment">//</span>
00140 
00141             <span class="keywordflow">if</span> (Target-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o59">DeviceMap</a> == DeviceMap) {
00142 
00143                 ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
00144                 
00145                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DosDevicesDirectory );
00146 
00147                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00148             }
00149 
00150             <span class="comment">//</span>
00151             <span class="comment">//  Add a new reference before releasing the spinlock</span>
00152             <span class="comment">//  to make sure nobody will release the devicemap while</span>
00153             <span class="comment">//  we try to attach to the process.</span>
00154             <span class="comment">//</span>
00155             
00156             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a>++;
00157 
00158             ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
00159         
00160             <span class="comment">//</span>
00161             <span class="comment">//  We can dereference the target processes device map because it</span>
00162             <span class="comment">//  no longer will have it's old dos device map.</span>
00163             <span class="comment">//</span>
00164 
00165             <a class="code" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a> ( Target );
00166 
00167             <span class="comment">//</span>
00168             <span class="comment">//  Now setup the new device map that we were feed in.  We lock it</span>
00169             <span class="comment">//  bump its ref count, make the targe process point to it, unlock it,</span>
00170             <span class="comment">//  and return to our caller</span>
00171             <span class="comment">//</span>
00172 
00173             ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, &amp;OldIrql );
00174 
00175             Target-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o59">DeviceMap</a> = DeviceMap;
00176 
00177             ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
00178 
00179             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DosDevicesDirectory );
00180 
00181             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00182         }
00183     }
00184 
00185     ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
00186     
00187     <span class="comment">//</span>
00188     <span class="comment">//  The input directory does not have a dos device map. so we'll</span>
00189     <span class="comment">//  allocate and initialize a new device map structure.</span>
00190     <span class="comment">//</span>
00191 
00192     DeviceMap = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>( *DeviceMap ), 'mDbO' );
00193 
00194     <span class="keywordflow">if</span> (DeviceMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00195 
00196         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DosDevicesDirectory );
00197         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00198 
00199     } <span class="keywordflow">else</span> {
00200 
00201         RtlZeroMemory( DeviceMap, <span class="keyword">sizeof</span>( *DeviceMap ) );
00202 
00203         DeviceMap-&gt;ReferenceCount = 1;
00204         DeviceMap-&gt;DosDevicesDirectory = DosDevicesDirectory;
00205 
00206         DosDevicesDirectory-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a> = DeviceMap;
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">//  If the caller specified a target process then remove the</span>
00210         <span class="comment">//  processes device map if in use and replace it with the new</span>
00211         <span class="comment">//  one, otherwise set this new device map to the system wide one</span>
00212         <span class="comment">//  and put it into the current process</span>
00213         <span class="comment">//</span>
00214 
00215         <span class="keywordflow">if</span> (TargetProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00216 
00217             <a class="code" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a> ( TargetProcess );
00218 
00219             TargetProcess-&gt;DeviceMap = DeviceMap;
00220 
00221         } <span class="keywordflow">else</span> {
00222 
00223             <a class="code" href="../../d4/d0/ob_8h.html#a41">ObSystemDeviceMap</a> = DeviceMap;
00224 
00225             <a class="code" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a> ( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
00226 
00227             <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DeviceMap = DeviceMap;
00228         }
00229     }
00230 
00231     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00232 }
00233 
00234 
00235 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00236"></a><a class="code" href="../../d7/d0/obdevmap_8c.html#a1">00236</a> <a class="code" href="../../d7/d0/obdevmap_8c.html#a1">ObQueryDeviceMapInformation</a> (
00237     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess OPTIONAL,
00238     OUT PPROCESS_DEVICEMAP_INFORMATION DeviceMapInformation
00239     )
00240 
00241 <span class="comment">/*++</span>
00242 <span class="comment"></span>
00243 <span class="comment">Routine Description:</span>
00244 <span class="comment"></span>
00245 <span class="comment">    This function queries information from the device map associated with the</span>
00246 <span class="comment">    specified process.  The returned information contains a bit map indicating</span>
00247 <span class="comment">    which drive letters are defined in the associated object directory, along</span>
00248 <span class="comment">    with an array of drive types that give the type of each drive letter.</span>
00249 <span class="comment"></span>
00250 <span class="comment">Arguments:</span>
00251 <span class="comment"></span>
00252 <span class="comment">    TargetProcess - Specifies the target process to retreive the device map</span>
00253 <span class="comment">        from.  If not specified then we return the global default device map</span>
00254 <span class="comment"></span>
00255 <span class="comment">    DeviceMapInformation - Specifies the location where to store the results.</span>
00256 <span class="comment"></span>
00257 <span class="comment">Return Value:</span>
00258 <span class="comment"></span>
00259 <span class="comment">    Returns one of the following status codes:</span>
00260 <span class="comment"></span>
00261 <span class="comment">        STATUS_SUCCESS - normal, successful completion.</span>
00262 <span class="comment"></span>
00263 <span class="comment">        STATUS_END_OF_FILE - The specified process was not associated with</span>
00264 <span class="comment">            a device map.</span>
00265 <span class="comment"></span>
00266 <span class="comment">        STATUS_ACCESS_VIOLATION - The DeviceMapInformation buffer pointer</span>
00267 <span class="comment">            value specified an invalid address.</span>
00268 <span class="comment"></span>
00269 <span class="comment">--*/</span>
00270 
00271 {
00272     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00273     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap;
00274     KIRQL OldIrql;
00275     PROCESS_DEVICEMAP_INFORMATION LocalMapInformation;
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">//  Check if the caller gave us a target process and if not then use</span>
00279     <span class="comment">//  the globally defined one</span>
00280     <span class="comment">//</span>
00281 
00282     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( TargetProcess )) {
00283 
00284         DeviceMap = TargetProcess-&gt;DeviceMap;
00285 
00286     } <span class="keywordflow">else</span> {
00287 
00288         DeviceMap = <a class="code" href="../../d4/d0/ob_8h.html#a41">ObSystemDeviceMap</a>;
00289     }
00290 
00291     <span class="comment">//</span>
00292     <span class="comment">//  If we do not have a device map then we'll return an error otherwise</span>
00293     <span class="comment">//  we simply copy over the device map structure (bitmap and drive type</span>
00294     <span class="comment">//  array) into the output buffer</span>
00295     <span class="comment">//</span>
00296 
00297     <span class="keywordflow">if</span> (DeviceMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00298 
00299         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_END_OF_FILE;
00300 
00301     } <span class="keywordflow">else</span> {
00302 
00303         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00304 
00305         <span class="comment">//</span>
00306         <span class="comment">//  First, while using a spinlock to protect the device map from</span>
00307         <span class="comment">//  going away we will make local copy of the information.</span>
00308         <span class="comment">//</span>
00309 
00310         ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, &amp;OldIrql );
00311 
00312         RtlMoveMemory( &amp;LocalMapInformation.Query,
00313                        &amp;DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o2">DriveMap</a>,
00314                        <span class="keyword">sizeof</span>( DeviceMapInformation-&gt;Query ));
00315 
00316         ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">//  Now we can copy the information to the caller buffer using</span>
00320         <span class="comment">//  a try-except to guard against the output buffer changing.</span>
00321         <span class="comment">//  Note that the caller must have already probed the buffer</span>
00322         <span class="comment">//  for write.</span>
00323         <span class="comment">//</span>
00324 
00325         <span class="keywordflow">try</span> {
00326 
00327             RtlMoveMemory( &amp;DeviceMapInformation-&gt;Query,
00328                            &amp;LocalMapInformation.Query,
00329                            <span class="keyword">sizeof</span>( DeviceMapInformation-&gt;Query ));
00330 
00331         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00332 
00333             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00334         }
00335 
00336     }
00337 
00338     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00339 }
00340 
00341 
00342 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00343"></a><a class="code" href="../../d7/d0/obdevmap_8c.html#a2">00343</a> <a class="code" href="../../d7/d0/obdevmap_8c.html#a2">ObInheritDeviceMap</a> (
00344     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess,
00345     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ParentProcess OPTIONAL
00346     )
00347 
00348 <span class="comment">/*++</span>
00349 <span class="comment"></span>
00350 <span class="comment">Routine Description:</span>
00351 <span class="comment"></span>
00352 <span class="comment">    This function is called at process initialization time to inherit the</span>
00353 <span class="comment">    device map for a process.  If no parent process, then inherits from</span>
00354 <span class="comment">    the system device map.</span>
00355 <span class="comment"></span>
00356 <span class="comment">Arguments:</span>
00357 <span class="comment"></span>
00358 <span class="comment">    NewProcess - Supplies the process being initialized that needs a new</span>
00359 <span class="comment">        dos device map</span>
00360 <span class="comment"></span>
00361 <span class="comment">    ParentProcess - - Optionally specifies the parent process whose device</span>
00362 <span class="comment">        map we inherit.  This process if specified must have a device map</span>
00363 <span class="comment"></span>
00364 <span class="comment">Return Value:</span>
00365 <span class="comment"></span>
00366 <span class="comment">    None.</span>
00367 <span class="comment"></span>
00368 <span class="comment">--*/</span>
00369 
00370 {
00371     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap;
00372     KIRQL OldIrql;
00373 
00374     <span class="comment">//</span>
00375     <span class="comment">//  If we are called with a parent process then grab its device map</span>
00376     <span class="comment">//  otherwise grab the system wide device map and check that is does</span>
00377     <span class="comment">//  exist</span>
00378     <span class="comment">//</span>
00379 
00380     <span class="keywordflow">if</span> (ParentProcess) {
00381 
00382         DeviceMap = ParentProcess-&gt;DeviceMap;
00383 
00384     } <span class="keywordflow">else</span> {
00385 
00386         <span class="comment">//</span>
00387         <span class="comment">//  Note: WindowStation guys may want a callout here to get the</span>
00388         <span class="comment">//  device map to use for this case.</span>
00389         <span class="comment">//</span>
00390 
00391         DeviceMap = <a class="code" href="../../d4/d0/ob_8h.html#a41">ObSystemDeviceMap</a>;
00392 
00393         <span class="keywordflow">if</span> (DeviceMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00394 
00395             <span class="keywordflow">return</span>;
00396         }
00397     }
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">//  With the device map bumps its reference count and add it to the</span>
00401     <span class="comment">//  new process</span>
00402     <span class="comment">//</span>
00403 
00404     ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, &amp;OldIrql );
00405 
00406     DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a>++;
00407     NewProcess-&gt;DeviceMap = DeviceMap;
00408 
00409     ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
00410 
00411     <span class="keywordflow">return</span>;
00412 }
00413 
00414 
00415 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00416"></a><a class="code" href="../../d7/d0/obdevmap_8c.html#a3">00416</a> <a class="code" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a> (
00417     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00418     )
00419 
00420 <span class="comment">/*++</span>
00421 <span class="comment"></span>
00422 <span class="comment">Routine Description:</span>
00423 <span class="comment"></span>
00424 <span class="comment">    This function is called at process tear down time to decrement the</span>
00425 <span class="comment">    reference count on a device map.  When the reference count goes to</span>
00426 <span class="comment">    zero, it means no more processes are using this, so it can be freed</span>
00427 <span class="comment">    and the reference on the associated object directory can be released.</span>
00428 <span class="comment"></span>
00429 <span class="comment">Arguments:</span>
00430 <span class="comment"></span>
00431 <span class="comment">    Process - Process being destroyed.</span>
00432 <span class="comment"></span>
00433 <span class="comment">Return Value:</span>
00434 <span class="comment"></span>
00435 <span class="comment">    None.</span>
00436 <span class="comment"></span>
00437 <span class="comment">--*/</span>
00438 
00439 {
00440     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap;
00441     KIRQL OldIrql;
00442 
00443     <span class="comment">//</span>
00444     <span class="comment">//  Grab the device map and then we only have work to do</span>
00445     <span class="comment">//  it there is one</span>
00446     <span class="comment">//</span>
00447 
00448     DeviceMap = Process-&gt;DeviceMap;
00449 
00450     <span class="keywordflow">if</span> (DeviceMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00451 
00452         <span class="comment">//</span>
00453         <span class="comment">//  To dereference the device map we need to null out the</span>
00454         <span class="comment">//  processes device map pointer, and decrement its ref count</span>
00455         <span class="comment">//  If the ref count goes to zero we can free up the memory</span>
00456         <span class="comment">//  and dereference the dos device directory object</span>
00457         <span class="comment">//</span>
00458 
00459         ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, &amp;OldIrql );
00460 
00461         Process-&gt;DeviceMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00462         DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a>--;
00463 
00464         <span class="keywordflow">if</span> (DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a> == 0) {
00465 
00466             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a>-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467 
00468             ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
00469 
00470             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a> );
00471 
00472             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DeviceMap );
00473 
00474         } <span class="keywordflow">else</span> {
00475 
00476             ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
00477         }
00478     }
00479 
00480     <span class="comment">//</span>
00481     <span class="comment">//  And return to our caller</span>
00482     <span class="comment">//</span>
00483 
00484     <span class="keywordflow">return</span>;
00485 }
00486 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
