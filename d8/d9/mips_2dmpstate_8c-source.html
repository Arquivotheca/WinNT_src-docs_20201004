<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dmpstate.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dmpstate.c</h1><a href="../../d7/d0/mips_2dmpstate_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dmpstate.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements  the architecture specific routine that dumps</span>
00012 <span class="comment">    the machine state when a bug check occurs and no debugger is hooked</span>
00013 <span class="comment">    to the system. It is assumed that it is called from bug check.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    David N. Cutler (davec) 17-Jan-1992</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00028 
00029 <span class="comment">//</span>
00030 <span class="comment">// Define forward referenced prototypes.</span>
00031 <span class="comment">//</span>
00032 
00033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00034 <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a2">KiDisplayString</a> (
00035     IN ULONG Column,
00036     IN ULONG Row,
00037     IN PCHAR Buffer
00038     );
00039 
00040 PRUNTIME_FUNCTION
00041 <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a3">KiLookupFunctionEntry</a> (
00042     IN ULONG ControlPc
00043     );
00044 
00045 PVOID
00046 <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a>(
00047     IN PVOID PcValue,
00048     OUT PVOID *BaseOfImage,
00049     OUT PLDR_DATA_TABLE_ENTRY *DataTableEntry
00050     );
00051 
00052 <span class="comment">//</span>
00053 <span class="comment">// Define external data.</span>
00054 <span class="comment">//</span>
00055 
<a name="l00056"></a><a class="code" href="../../d7/d0/mips_2dmpstate_8c.html#a0">00056</a> <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
00057 
00058 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00059"></a><a class="code" href="../../d7/d0/mips_2dmpstate_8c.html#a4">00059</a> <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a5">KeDumpMachineState</a> (
00060     IN PKPROCESSOR_STATE ProcessorState,
00061     IN PCHAR Buffer,
00062     IN PULONG BugCheckParameters,
00063     IN ULONG NumberOfParameters,
00064     IN PKE_BUGCHECK_UNICODE_TO_ANSI UnicodeToAnsiRoutine
00065     )
00066 
00067 <span class="comment">/*++</span>
00068 <span class="comment"></span>
00069 <span class="comment">Routine Description:</span>
00070 <span class="comment"></span>
00071 <span class="comment">    This function formats and displays the machine state at the time of the</span>
00072 <span class="comment">    to bug check.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Arguments:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    ProcessorState - Supplies a pointer to a processor state record.</span>
00077 <span class="comment"></span>
00078 <span class="comment">    Buffer - Supplies a pointer to a buffer to be used to output machine</span>
00079 <span class="comment">        state information.</span>
00080 <span class="comment"></span>
00081 <span class="comment">    BugCheckParameters - Supplies a pointer to an array of additional</span>
00082 <span class="comment">        bug check information.</span>
00083 <span class="comment"></span>
00084 <span class="comment">    NumberOfParameters - Suppiles the size of the bug check parameters</span>
00085 <span class="comment">        array.</span>
00086 <span class="comment"></span>
00087 <span class="comment">    UnicodeToAnsiRoutine - Supplies a pointer to a routine to convert Unicode strings</span>
00088 <span class="comment">        to Ansi strings without touching paged translation tables.</span>
00089 <span class="comment"></span>
00090 <span class="comment">Return Value:</span>
00091 <span class="comment"></span>
00092 <span class="comment">    None.</span>
00093 <span class="comment"></span>
00094 <span class="comment">--*/</span>
00095 
00096 {
00097 
00098     PCONTEXT ContextRecord;
00099     ULONG ControlPc;
00100     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00101     ULONG DisplayColumn;
00102     ULONG DisplayHeight;
00103     ULONG DisplayRow;
00104     ULONG DisplayWidth;
00105     UNICODE_STRING DllName;
00106     ULONG EstablisherFrame;
00107     PRUNTIME_FUNCTION FunctionEntry;
00108     PVOID ImageBase;
00109     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00110     BOOLEAN InFunction;
00111     ULONG LastStack;
00112     PLIST_ENTRY ModuleListHead;
00113     PLIST_ENTRY NextEntry;
00114     ULONG NextPc;
00115     ULONG StackLimit;
00116     UCHAR AnsiBuffer[ 32 ];
00117     ULONG DateStamp;
00118 
00119     <span class="comment">//</span>
00120     <span class="comment">// Query display parameters.</span>
00121     <span class="comment">//</span>
00122 
00123     <a class="code" href="../../d2/d7/hal_8h.html#a161">HalQueryDisplayParameters</a>(&amp;DisplayWidth,
00124                               &amp;DisplayHeight,
00125                               &amp;DisplayColumn,
00126                               &amp;DisplayRow);
00127 
00128     <span class="comment">//</span>
00129     <span class="comment">// Display any addresses that fall within the range of any module in</span>
00130     <span class="comment">// the loaded module list.</span>
00131     <span class="comment">//</span>
00132 
00133     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; NumberOfParameters; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00134         ImageBase = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a>((PVOID)*BugCheckParameters,
00135                                      &amp;ImageBase,
00136                                      &amp;DataTableEntry);
00137 
00138         <span class="keywordflow">if</span> (ImageBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00139             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00140                     <span class="stringliteral">"*** %08lX has base at %08lX - %s\n"</span>,
00141                     *BugCheckParameters,
00142                     ImageBase,
00143                     (*UnicodeToAnsiRoutine)( &amp;DataTableEntry-&gt;BaseDllName, AnsiBuffer, <span class="keyword">sizeof</span>( AnsiBuffer )));
00144 
00145             <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00146         }
00147 
00148         BugCheckParameters += 1;
00149     }
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">// Virtually unwind to the caller of bug check.</span>
00153     <span class="comment">//</span>
00154 
00155     ContextRecord = &amp;ProcessorState-&gt;ContextFrame;
00156     LastStack = (ULONG)ContextRecord-&gt;XIntSp;
00157     ControlPc = (ULONG)(ContextRecord-&gt;XIntRa - 4);
00158     NextPc = ControlPc;
00159     FunctionEntry = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a3">KiLookupFunctionEntry</a>(ControlPc);
00160     <span class="keywordflow">if</span> (FunctionEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00161         NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc | 1,
00162                                   FunctionEntry,
00163                                   ContextRecord,
00164                                   &amp;InFunction,
00165                                   &amp;EstablisherFrame,
00166                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00167     }
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">// At this point the context record contains the machine state at the</span>
00171     <span class="comment">// call to bug check.</span>
00172     <span class="comment">//</span>
00173     <span class="comment">// Put out the machine state at the time of the bugcheck.</span>
00174     <span class="comment">//</span>
00175 
00176     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00177             <span class="stringliteral">"\nMachine State at Call to Bug Check PC : %08lX PSR : %08lX\n\n"</span>,
00178             (ULONG)ContextRecord-&gt;XIntRa,
00179             ContextRecord-&gt;Psr);
00180 
00181     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00182 
00183     <span class="comment">//</span>
00184     <span class="comment">// Format and output the integer registers.</span>
00185     <span class="comment">//</span>
00186 
00187     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00188             <span class="stringliteral">"AT :%8lX  V0 :%8lX  V1 :%8lX  A0 :%8lX\n"</span>,
00189             (ULONG)ContextRecord-&gt;XIntAt,
00190             (ULONG)ContextRecord-&gt;XIntV0,
00191             (ULONG)ContextRecord-&gt;XIntV1,
00192             (ULONG)ContextRecord-&gt;XIntA0);
00193 
00194     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00195 
00196     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00197             <span class="stringliteral">"A1 :%8lX  A2 :%8lX  A3 :%8lX  T0 :%8lX\n"</span>,
00198             (ULONG)ContextRecord-&gt;XIntA1,
00199             (ULONG)ContextRecord-&gt;XIntA2,
00200             (ULONG)ContextRecord-&gt;XIntA3,
00201             (ULONG)ContextRecord-&gt;XIntT0);
00202 
00203     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00204 
00205     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00206             <span class="stringliteral">"T1 :%8lX  T2 :%8lX  T3 :%8lX  T4 :%8lX\n"</span>,
00207             (ULONG)ContextRecord-&gt;XIntT1,
00208             (ULONG)ContextRecord-&gt;XIntT2,
00209             (ULONG)ContextRecord-&gt;XIntT3,
00210             (ULONG)ContextRecord-&gt;XIntT4);
00211 
00212     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00213 
00214     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00215             <span class="stringliteral">"T5 :%8lX  T6 :%8lX  T7 :%8lX  T8 :%8lX\n"</span>,
00216             (ULONG)ContextRecord-&gt;XIntT5,
00217             (ULONG)ContextRecord-&gt;XIntT6,
00218             (ULONG)ContextRecord-&gt;XIntT7,
00219             (ULONG)ContextRecord-&gt;XIntT8);
00220 
00221     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00222 
00223     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00224             <span class="stringliteral">"T9 :%8lX  S0 :%8lX  S1 :%8lX  S2 :%8lX\n"</span>,
00225             (ULONG)ContextRecord-&gt;XIntT9,
00226             (ULONG)ContextRecord-&gt;XIntS0,
00227             (ULONG)ContextRecord-&gt;XIntS1,
00228             (ULONG)ContextRecord-&gt;XIntS2);
00229 
00230     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00231 
00232     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00233             <span class="stringliteral">"S3 :%8lX  S4 :%8lX  S5 :%8lX  S6 :%8lX\n"</span>,
00234             (ULONG)ContextRecord-&gt;XIntS3,
00235             (ULONG)ContextRecord-&gt;XIntS4,
00236             (ULONG)ContextRecord-&gt;XIntS5,
00237             (ULONG)ContextRecord-&gt;XIntS6);
00238 
00239     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00240 
00241     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00242             <span class="stringliteral">"S7 :%8lX  S8 :%8lX  GP :%8lX  SP :%8lX\n"</span>,
00243             (ULONG)ContextRecord-&gt;XIntS7,
00244             (ULONG)ContextRecord-&gt;XIntS8,
00245             (ULONG)ContextRecord-&gt;XIntGp,
00246             (ULONG)ContextRecord-&gt;XIntSp);
00247 
00248      <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00249 
00250      <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00251             <span class="stringliteral">"RA :%8lX  LO :%8lX  HI :%8lX  FSR:%8lX\n"</span>,
00252             (ULONG)ContextRecord-&gt;XIntRa,
00253             (ULONG)ContextRecord-&gt;XIntLo,
00254             (ULONG)ContextRecord-&gt;XIntHi,
00255             (ULONG)ContextRecord-&gt;Fsr);
00256 
00257     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Format and output the firswt four floating registers.</span>
00261     <span class="comment">//</span>
00262 
00263     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00264             <span class="stringliteral">"F0 :%8lX  F1 :%8lX  F2 :%8lX  F3 :%8lX\n"</span>,
00265             ContextRecord-&gt;FltF0,
00266             ContextRecord-&gt;FltF1,
00267             ContextRecord-&gt;FltF2,
00268             ContextRecord-&gt;FltF3);
00269 
00270     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00271 
00272     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00273             <span class="stringliteral">"F4 :%8lX  F5 :%8lX  F6 :%8lX  F7 :%8lX\n"</span>,
00274             ContextRecord-&gt;FltF4,
00275             ContextRecord-&gt;FltF5,
00276             ContextRecord-&gt;FltF6,
00277             ContextRecord-&gt;FltF7);
00278 
00279     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00280 
00281     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00282             <span class="stringliteral">"F8 :%8lX  F9 :%8lX  F10:%8lX  F11:%8lX\n"</span>,
00283             ContextRecord-&gt;FltF8,
00284             ContextRecord-&gt;FltF9,
00285             ContextRecord-&gt;FltF10,
00286             ContextRecord-&gt;FltF11);
00287 
00288     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00289 
00290     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00291             <span class="stringliteral">"F12:%8lX  F13:%8lX  F14:%8lX  F15:%8lX\n"</span>,
00292             ContextRecord-&gt;FltF12,
00293             ContextRecord-&gt;FltF13,
00294             ContextRecord-&gt;FltF14,
00295             ContextRecord-&gt;FltF15);
00296 
00297     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00298 
00299     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00300             <span class="stringliteral">"F16:%8lX  F17:%8lX  F18:%8lX  F19:%8lX\n"</span>,
00301             ContextRecord-&gt;FltF16,
00302             ContextRecord-&gt;FltF17,
00303             ContextRecord-&gt;FltF18,
00304             ContextRecord-&gt;FltF19);
00305 
00306     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00307 
00308     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00309             <span class="stringliteral">"F20:%8lX  F21:%8lX  F22:%8lX  F23:%8lX\n"</span>,
00310             ContextRecord-&gt;FltF20,
00311             ContextRecord-&gt;FltF21,
00312             ContextRecord-&gt;FltF22,
00313             ContextRecord-&gt;FltF23);
00314 
00315     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00316 
00317     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00318             <span class="stringliteral">"F24:%8lX  F25:%8lX  F26:%8lX  F27:%8lX\n"</span>,
00319             ContextRecord-&gt;FltF24,
00320             ContextRecord-&gt;FltF25,
00321             ContextRecord-&gt;FltF26,
00322             ContextRecord-&gt;FltF27);
00323 
00324     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00325 
00326     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00327             <span class="stringliteral">"F28:%8lX  F29:%8lX  F30:%8lX  F31:%8lX\n\n"</span>,
00328             ContextRecord-&gt;FltF28,
00329             ContextRecord-&gt;FltF29,
00330             ContextRecord-&gt;FltF30,
00331             ContextRecord-&gt;FltF31);
00332 
00333     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00334 
00335     <span class="comment">//</span>
00336     <span class="comment">// Output short stack back trace with base address.</span>
00337     <span class="comment">//</span>
00338 
00339     DllName.Length = 0;
00340     DllName.Buffer = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00341     <span class="keywordflow">if</span> (FunctionEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00342         StackLimit = (ULONG)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelStack;
00343         <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<span class="stringliteral">"Callee-Sp Return-Ra  Dll Base - Name\n"</span>);
00344         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; 8; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00345             ImageBase = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a>((PVOID)ControlPc,
00346                                          &amp;ImageBase,
00347                                          &amp;DataTableEntry);
00348 
00349             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00350                     <span class="stringliteral">" %08lX %08lX : %08lX - %s\n"</span>,
00351                     (ULONG)ContextRecord-&gt;XIntSp,
00352                     NextPc + 4,
00353                     ImageBase,
00354                     (*UnicodeToAnsiRoutine)( (ImageBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? &amp;DataTableEntry-&gt;BaseDllName : &amp;DllName,
00355                                              AnsiBuffer, <span class="keyword">sizeof</span>( AnsiBuffer )));
00356 
00357             <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00358             <span class="keywordflow">if</span> ((NextPc != ControlPc) || ((ULONG)ContextRecord-&gt;XIntSp != LastStack)) {
00359                 ControlPc = NextPc;
00360                 LastStack = (ULONG)ContextRecord-&gt;XIntSp;
00361                 FunctionEntry = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a3">KiLookupFunctionEntry</a>(ControlPc);
00362                 <span class="keywordflow">if</span> ((FunctionEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (LastStack &lt; StackLimit)) {
00363                     NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc | 1,
00364                                               FunctionEntry,
00365                                               ContextRecord,
00366                                               &amp;InFunction,
00367                                               &amp;EstablisherFrame,
00368                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00369                 } <span class="keywordflow">else</span> {
00370                     NextPc = (ULONG)ContextRecord-&gt;XIntRa;
00371                 }
00372 
00373             } <span class="keywordflow">else</span> {
00374                 <span class="keywordflow">break</span>;
00375             }
00376         }
00377     }
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">// Output the build number and other useful information.</span>
00381     <span class="comment">//</span>
00382 
00383     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00384            <span class="stringliteral">"\nIRQL : %d, DPC Active : %s, SYSVER 0x%08x\n"</span>,
00385            KeGetCurrentIrql(),
00386            KeIsExecutingDpc() ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>,
00387            <a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a>);
00388 
00389     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00390 
00391     <span class="comment">//</span>
00392     <span class="comment">// Output the processor id and the primary cache sizes.</span>
00393     <span class="comment">//</span>
00394 
00395     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00396             <span class="stringliteral">"Processor Id %d.%d, Icache : %d, Dcache : %d\n"</span>,
00397             (PCR-&gt;ProcessorId &gt;&gt; 8) &amp; 0xff,
00398             PCR-&gt;ProcessorId &amp; 0xff,
00399             PCR-&gt;FirstLevelIcacheSize,
00400             PCR-&gt;FirstLevelDcacheSize);
00401 
00402     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// If the display width is greater than 80 + 24 (the size of a DLL</span>
00406     <span class="comment">// name and base address), then display all the modules loaded in</span>
00407     <span class="comment">// the system.</span>
00408     <span class="comment">//</span>
00409 
00410     <a class="code" href="../../d2/d7/hal_8h.html#a161">HalQueryDisplayParameters</a>(&amp;DisplayWidth,
00411                               &amp;DisplayHeight,
00412                               &amp;DisplayColumn,
00413                               &amp;DisplayRow);
00414 
00415     <span class="keywordflow">if</span> (DisplayWidth &gt; (80 + 24)) {
00416         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00417             ModuleListHead = &amp;<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o0">LoadOrderListHead</a>;
00418 
00419         } <span class="keywordflow">else</span> {
00420             ModuleListHead = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
00421         }
00422 
00423         <span class="comment">//</span>
00424         <span class="comment">// Output display headers.</span>
00425         <span class="comment">//</span>
00426 
00427         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
00428         <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a2">KiDisplayString</a>(80, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, <span class="stringliteral">"Dll Base DateStmp - Name"</span>);
00429         NextEntry = ModuleListHead-&gt;Flink;
00430         <span class="keywordflow">if</span> (NextEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00431 
00432             <span class="comment">//</span>
00433             <span class="comment">// Scan the list of loaded modules and display their base</span>
00434             <span class="comment">// address and name.</span>
00435             <span class="comment">//</span>
00436 
00437             <span class="keywordflow">while</span> (NextEntry != ModuleListHead) {
00438                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00439                 DataTableEntry = CONTAINING_RECORD(NextEntry,
00440                                                    LDR_DATA_TABLE_ENTRY,
00441                                                    InLoadOrderLinks);
00442 
00443                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a>(DataTableEntry-&gt;DllBase) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00444                     PIMAGE_NT_HEADERS NtHeaders;
00445 
00446                     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
00447                     DateStamp = NtHeaders-&gt;FileHeader.TimeDateStamp;
00448 
00449                 } <span class="keywordflow">else</span> {
00450                     DateStamp = 0;
00451                 }
00452                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00453                         <span class="stringliteral">"%08lX %08lx - %s"</span>,
00454                         DataTableEntry-&gt;DllBase,
00455                         DateStamp,
00456                         (*UnicodeToAnsiRoutine)( &amp;DataTableEntry-&gt;BaseDllName, AnsiBuffer, <span class="keyword">sizeof</span>( AnsiBuffer )));
00457 
00458                 <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a2">KiDisplayString</a>(80, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00459                 NextEntry = NextEntry-&gt;Flink;
00460                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; DisplayHeight) {
00461                     <span class="keywordflow">break</span>;
00462                 }
00463             }
00464         }
00465     }
00466 
00467     <span class="comment">//</span>
00468     <span class="comment">// Reset the current display position.</span>
00469     <span class="comment">//</span>
00470 
00471     <a class="code" href="../../d2/d7/hal_8h.html#a162">HalSetDisplayParameters</a>(DisplayColumn, DisplayRow);
00472     <span class="keywordflow">return</span>;
00473 }
00474 
00475 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00476"></a><a class="code" href="../../d7/d0/mips_2dmpstate_8c.html#a1">00476</a> <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a2">KiDisplayString</a> (
00477     IN ULONG Column,
00478     IN ULONG Row,
00479     IN PCHAR Buffer
00480     )
00481 
00482 <span class="comment">/*++</span>
00483 <span class="comment"></span>
00484 <span class="comment">Routine Description:</span>
00485 <span class="comment"></span>
00486 <span class="comment">    This function display a string starting at the specified column and row</span>
00487 <span class="comment">    position on the screen.</span>
00488 <span class="comment"></span>
00489 <span class="comment">Arguments:</span>
00490 <span class="comment"></span>
00491 <span class="comment">    Column - Supplies the starting column of where the string is displayed.</span>
00492 <span class="comment"></span>
00493 <span class="comment">    Row - Supplies the starting row of where the string is displayed.</span>
00494 <span class="comment"></span>
00495 <span class="comment">    Bufer - Supplies a pointer to the string that is displayed.</span>
00496 <span class="comment"></span>
00497 <span class="comment">Return Value:</span>
00498 <span class="comment"></span>
00499 <span class="comment">    None.</span>
00500 <span class="comment"></span>
00501 <span class="comment">--*/</span>
00502 
00503 {
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// Position the cursor and display the string.</span>
00507     <span class="comment">//</span>
00508 
00509     <a class="code" href="../../d2/d7/hal_8h.html#a162">HalSetDisplayParameters</a>(Column, Row);
00510     <a class="code" href="../../d2/d7/hal_8h.html#a160">HalDisplayString</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00511     <span class="keywordflow">return</span>;
00512 }
00513 
00514 PRUNTIME_FUNCTION
<a name="l00515"></a><a class="code" href="../../d7/d0/mips_2dmpstate_8c.html#a2">00515</a> <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a3">KiLookupFunctionEntry</a> (
00516     IN ULONG ControlPc
00517     )
00518 
00519 <span class="comment">/*++</span>
00520 <span class="comment"></span>
00521 <span class="comment">Routine Description:</span>
00522 <span class="comment"></span>
00523 <span class="comment">    This function searches the currently active function tables for an entry</span>
00524 <span class="comment">    that corresponds to the specified PC value.</span>
00525 <span class="comment"></span>
00526 <span class="comment">Arguments:</span>
00527 <span class="comment"></span>
00528 <span class="comment">    ControlPc - Supplies the address of an instruction within the specified</span>
00529 <span class="comment">        function.</span>
00530 <span class="comment"></span>
00531 <span class="comment">Return Value:</span>
00532 <span class="comment"></span>
00533 <span class="comment">    If there is no entry in the function table for the specified PC, then</span>
00534 <span class="comment">    NULL is returned. Otherwise, the address of the function table entry</span>
00535 <span class="comment">    that corresponds to the specified PC is returned.</span>
00536 <span class="comment"></span>
00537 <span class="comment">--*/</span>
00538 
00539 {
00540 
00541     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00542     PRUNTIME_FUNCTION FunctionEntry;
00543     PRUNTIME_FUNCTION FunctionTable;
00544     ULONG SizeOfExceptionTable;
00545     LONG High;
00546     PVOID ImageBase;
00547     LONG Low;
00548     LONG Middle;
00549 
00550     <span class="comment">//</span>
00551     <span class="comment">// Search for the image that includes the specified PC value.</span>
00552     <span class="comment">//</span>
00553 
00554     ImageBase = <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a>((PVOID)ControlPc,
00555                                  &amp;ImageBase,
00556                                  &amp;DataTableEntry);
00557 
00558     <span class="comment">//</span>
00559     <span class="comment">// If an image is found that includes the specified PC, then locate the</span>
00560     <span class="comment">// function table for the image.</span>
00561     <span class="comment">//</span>
00562 
00563     <span class="keywordflow">if</span> (ImageBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00564         FunctionTable = (PRUNTIME_FUNCTION)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00565                          ImageBase, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, IMAGE_DIRECTORY_ENTRY_EXCEPTION,
00566                          &amp;SizeOfExceptionTable);
00567 
00568         <span class="comment">//</span>
00569         <span class="comment">// If a function table is located, then search the function table</span>
00570         <span class="comment">// for a function table entry for the specified PC.</span>
00571         <span class="comment">//</span>
00572 
00573         <span class="keywordflow">if</span> (FunctionTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00574 
00575             <span class="comment">//</span>
00576             <span class="comment">// Initialize search indicies.</span>
00577             <span class="comment">//</span>
00578 
00579             Low = 0;
00580             High = (SizeOfExceptionTable / <span class="keyword">sizeof</span>(RUNTIME_FUNCTION)) - 1;
00581 
00582             <span class="comment">//</span>
00583             <span class="comment">// Perform binary search on the function table for a function table</span>
00584             <span class="comment">// entry that subsumes the specified PC.</span>
00585             <span class="comment">//</span>
00586 
00587             <span class="keywordflow">while</span> (High &gt;= Low) {
00588 
00589                 <span class="comment">//</span>
00590                 <span class="comment">// Compute next probe index and test entry. If the specified PC</span>
00591                 <span class="comment">// is greater than of equal to the beginning address and less</span>
00592                 <span class="comment">// than the ending address of the function table entry, then</span>
00593                 <span class="comment">// return the address of the function table entry. Otherwise,</span>
00594                 <span class="comment">// continue the search.</span>
00595                 <span class="comment">//</span>
00596 
00597                 Middle = (Low + High) &gt;&gt; 1;
00598                 FunctionEntry = &amp;FunctionTable[Middle];
00599                 <span class="keywordflow">if</span> (ControlPc &lt; FunctionEntry-&gt;BeginAddress) {
00600                     High = Middle - 1;
00601 
00602                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlPc &gt;= FunctionEntry-&gt;EndAddress) {
00603                     Low = Middle + 1;
00604 
00605                 } <span class="keywordflow">else</span> {
00606 
00607                     <span class="comment">//</span>
00608                     <span class="comment">// The capability exists for more than one function entry</span>
00609                     <span class="comment">// to map to the same function. This permits a function to</span>
00610                     <span class="comment">// have discontiguous code segments described by separate</span>
00611                     <span class="comment">// function table entries. If the ending prologue address</span>
00612                     <span class="comment">// is not within the limits of the begining and ending</span>
00613                     <span class="comment">// address of the function able entry, then the prologue</span>
00614                     <span class="comment">// ending address is the address of a function table entry</span>
00615                     <span class="comment">// that accurately describes the ending prologue address.</span>
00616                     <span class="comment">//</span>
00617 
00618                     <span class="keywordflow">if</span> ((FunctionEntry-&gt;PrologEndAddress &lt; FunctionEntry-&gt;BeginAddress) ||
00619                         (FunctionEntry-&gt;PrologEndAddress &gt;= FunctionEntry-&gt;EndAddress)) {
00620                         FunctionEntry = (PRUNTIME_FUNCTION)FunctionEntry-&gt;PrologEndAddress;
00621                     }
00622 
00623                     <span class="keywordflow">return</span> FunctionEntry;
00624                 }
00625             }
00626         }
00627     }
00628 
00629     <span class="comment">//</span>
00630     <span class="comment">// A function table entry for the specified PC was not found.</span>
00631     <span class="comment">//</span>
00632 
00633     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00634 }
00635 
00636 PVOID
<a name="l00637"></a><a class="code" href="../../d7/d0/mips_2dmpstate_8c.html#a3">00637</a> <a class="code" href="../../d8/d0/ppc_2dmpstate_8c.html#a4">KiPcToFileHeader</a>(
00638     IN PVOID PcValue,
00639     OUT PVOID *BaseOfImage,
00640     OUT PLDR_DATA_TABLE_ENTRY *DataTableEntry
00641     )
00642 
00643 <span class="comment">/*++</span>
00644 <span class="comment"></span>
00645 <span class="comment">Routine Description:</span>
00646 <span class="comment"></span>
00647 <span class="comment">    This function returns the base of an image that contains the</span>
00648 <span class="comment">    specified PcValue. An image contains the PcValue if the PcValue</span>
00649 <span class="comment">    is within the ImageBase, and the ImageBase plus the size of the</span>
00650 <span class="comment">    virtual image.</span>
00651 <span class="comment"></span>
00652 <span class="comment">Arguments:</span>
00653 <span class="comment"></span>
00654 <span class="comment">    PcValue - Supplies a PcValue.</span>
00655 <span class="comment"></span>
00656 <span class="comment">    BaseOfImage - Returns the base address for the image containing the</span>
00657 <span class="comment">        PcValue. This value must be added to any relative addresses in</span>
00658 <span class="comment">        the headers to locate portions of the image.</span>
00659 <span class="comment"></span>
00660 <span class="comment">    DataTableEntry - Suppies a pointer to a variable that receives the</span>
00661 <span class="comment">        address of the data table entry that describes the image.</span>
00662 <span class="comment"></span>
00663 <span class="comment">Return Value:</span>
00664 <span class="comment"></span>
00665 <span class="comment">    NULL - No image was found that contains the PcValue.</span>
00666 <span class="comment"></span>
00667 <span class="comment">    NON-NULL - Returns the base address of the image that contain the</span>
00668 <span class="comment">        PcValue.</span>
00669 <span class="comment"></span>
00670 <span class="comment">--*/</span>
00671 
00672 {
00673 
00674     PLIST_ENTRY ModuleListHead;
00675     PLDR_DATA_TABLE_ENTRY Entry;
00676     PLIST_ENTRY Next;
00677     ULONG Bounds;
00678     PVOID ReturnBase, Base;
00679 
00680     <span class="comment">//</span>
00681     <span class="comment">// If the module list has been initialized, then scan the list to</span>
00682     <span class="comment">// locate the appropriate entry.</span>
00683     <span class="comment">//</span>
00684 
00685     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00686         ModuleListHead = &amp;<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o0">LoadOrderListHead</a>;
00687 
00688     } <span class="keywordflow">else</span> {
00689         ModuleListHead = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
00690     }
00691 
00692     ReturnBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00693     Next = ModuleListHead-&gt;Flink;
00694     <span class="keywordflow">if</span> (Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00695         <span class="keywordflow">while</span> (Next != ModuleListHead) {
00696             Entry = CONTAINING_RECORD(Next,
00697                                       LDR_DATA_TABLE_ENTRY,
00698                                       InLoadOrderLinks);
00699 
00700             Next = Next-&gt;Flink;
00701             Base = Entry-&gt;DllBase;
00702             Bounds = (ULONG)Base + Entry-&gt;SizeOfImage;
00703             <span class="keywordflow">if</span> ((ULONG)PcValue &gt;= (ULONG)Base &amp;&amp; (ULONG)PcValue &lt; Bounds) {
00704                 *DataTableEntry = Entry;
00705                 ReturnBase = Base;
00706                 <span class="keywordflow">break</span>;
00707             }
00708         }
00709     }
00710 
00711     *BaseOfImage = ReturnBase;
00712     <span class="keywordflow">return</span> ReturnBase;
00713 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
