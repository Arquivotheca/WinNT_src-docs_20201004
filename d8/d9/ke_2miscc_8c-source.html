<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: miscc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>miscc.c</h1><a href="../../d7/d0/ke_2miscc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989-1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    miscc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements machine independent miscellaneous kernel functions.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    David N. Cutler (davec) 13-May-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00026 
00027 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, KeAddSystemServiceTable)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, KeSetSwapContextNotifyRoutine)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, KeSetTimeUpdateNotifyRoutine)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, KeSetThreadSelectNotifyRoutine)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, KeQueryActiveProcessors)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, KiCalibrateTimeAdjustment)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 
00037 
00038 
00039 <span class="preprocessor">#undef KeEnterCriticalRegion</span>
00040 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00041"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a0">00041</a> <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a> (
00042    VOID
00043    )
00044 
00045 <span class="comment">/*++</span>
00046 <span class="comment"></span>
00047 <span class="comment">Routine Description:</span>
00048 <span class="comment"></span>
00049 <span class="comment">   This function disables kernel APC's.</span>
00050 <span class="comment"></span>
00051 <span class="comment">   N.B. The following code does not require any interlocks. There are</span>
00052 <span class="comment">        two cases of interest: 1) On an MP system, the thread cannot</span>
00053 <span class="comment">        be running on two processors as once, and 2) if the thread is</span>
00054 <span class="comment">        is interrupted to deliver a kernel mode APC which also calls</span>
00055 <span class="comment">        this routine, the values read and stored will stack and unstack</span>
00056 <span class="comment">        properly.</span>
00057 <span class="comment"></span>
00058 <span class="comment">Arguments:</span>
00059 <span class="comment"></span>
00060 <span class="comment">   None.</span>
00061 <span class="comment"></span>
00062 <span class="comment">Return Value:</span>
00063 <span class="comment"></span>
00064 <span class="comment">   None.</span>
00065 <span class="comment"></span>
00066 <span class="comment">--*/</span>
00067 
00068 {
00069     <span class="comment">//</span>
00070     <span class="comment">// Simply directly disable kernel APCs.</span>
00071     <span class="comment">//</span>
00072 
00073     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable -= 1;
00074     <span class="keywordflow">return</span>;
00075 }
00076 
00077 
00078 <span class="preprocessor">#undef KeLeaveCriticalRegion</span>
00079 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00080"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a1">00080</a> <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> (
00081     VOID
00082     )
00083 
00084 <span class="comment">/*++</span>
00085 <span class="comment"></span>
00086 <span class="comment">Routine Description:</span>
00087 <span class="comment"></span>
00088 <span class="comment">    This function enables kernel APC's and requests an APC interrupt if</span>
00089 <span class="comment">    appropriate.</span>
00090 <span class="comment"></span>
00091 <span class="comment">Arguments:</span>
00092 <span class="comment"></span>
00093 <span class="comment">    None.</span>
00094 <span class="comment"></span>
00095 <span class="comment">Return Value:</span>
00096 <span class="comment"></span>
00097 <span class="comment">    None.</span>
00098 <span class="comment"></span>
00099 <span class="comment">--*/</span>
00100 
00101 {
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">// Increment the kernel APC disable count. If the resultant count is</span>
00105     <span class="comment">// zero and the thread's kernel APC List is not empty, then request an</span>
00106     <span class="comment">// APC interrupt.</span>
00107     <span class="comment">//</span>
00108     <span class="comment">// For multiprocessor performance, the following code utilizes the fact</span>
00109     <span class="comment">// that queuing an APC is done by first queuing the APC, then checking</span>
00110     <span class="comment">// the AST disable count. The following code increments the disable</span>
00111     <span class="comment">// count first, checks to determine if it is zero, and then checks the</span>
00112     <span class="comment">// kernel AST queue.</span>
00113     <span class="comment">//</span>
00114     <span class="comment">// See also KiInsertQueueApc().</span>
00115     <span class="comment">//</span>
00116 
00117     <a class="code" href="../../d4/d9/ke_8h.html#a27">KiLeaveCriticalRegion</a>();
00118     <span class="keywordflow">return</span>;
00119 }
00120 
00121 ULONGLONG
<a name="l00122"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a2">00122</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a2">KeQueryInterruptTime</a> (
00123     VOID
00124     )
00125 
00126 <span class="comment">/*++</span>
00127 <span class="comment"></span>
00128 <span class="comment">Routine Description:</span>
00129 <span class="comment"></span>
00130 <span class="comment">    This function returns the current interrupt time by determining when the</span>
00131 <span class="comment">    time is stable and then returning its value.</span>
00132 <span class="comment"></span>
00133 <span class="comment">Arguments:</span>
00134 <span class="comment"></span>
00135 <span class="comment">    CurrentTime - Supplies a pointer to a variable that will receive the</span>
00136 <span class="comment">        current system time.</span>
00137 <span class="comment"></span>
00138 <span class="comment">Return Value:</span>
00139 <span class="comment"></span>
00140 <span class="comment">    None.</span>
00141 <span class="comment"></span>
00142 <span class="comment">--*/</span>
00143 
00144 {
00145 
00146     LARGE_INTEGER CurrentTime;
00147 
00148     KiQueryInterruptTime(&amp;CurrentTime);
00149     <span class="keywordflow">return</span> CurrentTime.QuadPart;
00150 }
00151 
00152 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00153"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">00153</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (
00154     OUT PLARGE_INTEGER CurrentTime
00155     )
00156 
00157 <span class="comment">/*++</span>
00158 <span class="comment"></span>
00159 <span class="comment">Routine Description:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    This function returns the current system time by determining when the</span>
00162 <span class="comment">    time is stable and then returning its value.</span>
00163 <span class="comment"></span>
00164 <span class="comment">Arguments:</span>
00165 <span class="comment"></span>
00166 <span class="comment">    CurrentTime - Supplies a pointer to a variable that will receive the</span>
00167 <span class="comment">        current system time.</span>
00168 <span class="comment"></span>
00169 <span class="comment">Return Value:</span>
00170 <span class="comment"></span>
00171 <span class="comment">    None.</span>
00172 <span class="comment"></span>
00173 <span class="comment">--*/</span>
00174 
00175 {
00176 
00177     KiQuerySystemTime(CurrentTime);
00178     <span class="keywordflow">return</span>;
00179 }
00180 
00181 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00182"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">00182</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a> (
00183     OUT PLARGE_INTEGER CurrentCount
00184     )
00185 
00186 <span class="comment">/*++</span>
00187 <span class="comment"></span>
00188 <span class="comment">Routine Description:</span>
00189 <span class="comment"></span>
00190 <span class="comment">    This function returns the current tick count by determining when the</span>
00191 <span class="comment">    count is stable and then returning its value.</span>
00192 <span class="comment"></span>
00193 <span class="comment">Arguments:</span>
00194 <span class="comment"></span>
00195 <span class="comment">    CurrentCount - Supplies a pointer to a variable that will receive the</span>
00196 <span class="comment">        current tick count.</span>
00197 <span class="comment"></span>
00198 <span class="comment">Return Value:</span>
00199 <span class="comment"></span>
00200 <span class="comment">    None.</span>
00201 <span class="comment"></span>
00202 <span class="comment">--*/</span>
00203 
00204 {
00205 
00206     KiQueryTickCount(CurrentCount);
00207     <span class="keywordflow">return</span>;
00208 }
00209 
00210 ULONG
<a name="l00211"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a5">00211</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a5">KeQueryTimeIncrement</a> (
00212     VOID
00213     )
00214 
00215 <span class="comment">/*++</span>
00216 <span class="comment"></span>
00217 <span class="comment">Routine Description:</span>
00218 <span class="comment"></span>
00219 <span class="comment">    This function returns the time increment value in 100ns units. This</span>
00220 <span class="comment">    is the value that is added to the system time at each interval clock</span>
00221 <span class="comment">    interrupt.</span>
00222 <span class="comment"></span>
00223 <span class="comment">Arguments:</span>
00224 <span class="comment"></span>
00225 <span class="comment">    None.</span>
00226 <span class="comment"></span>
00227 <span class="comment">Return Value:</span>
00228 <span class="comment"></span>
00229 <span class="comment">    The time increment value is returned as the function value.</span>
00230 <span class="comment"></span>
00231 <span class="comment">--*/</span>
00232 
00233 {
00234 
00235     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>;
00236 }
00237 
00238 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00239"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a6">00239</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a6">KeSetDmaIoCoherency</a> (
00240     IN ULONG Attributes
00241     )
00242 
00243 <span class="comment">/*++</span>
00244 <span class="comment"></span>
00245 <span class="comment">Routine Description:</span>
00246 <span class="comment"></span>
00247 <span class="comment">    This function sets (enables/disables) DMA I/O coherency with data</span>
00248 <span class="comment">    caches.</span>
00249 <span class="comment"></span>
00250 <span class="comment">Arguments:</span>
00251 <span class="comment"></span>
00252 <span class="comment">    Attributes - Supplies the set of DMA I/O coherency attributes for</span>
00253 <span class="comment">        the host system.</span>
00254 <span class="comment"></span>
00255 <span class="comment">Return Value:</span>
00256 <span class="comment"></span>
00257 <span class="comment">    None.</span>
00258 <span class="comment"></span>
00259 <span class="comment">--*/</span>
00260 
00261 {
00262 
00263     <a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> = Attributes;
00264 }
00265 
00266 <span class="preprocessor">#if defined(i386)</span>
00267 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00268 KeSetProfileIrql (
00269     IN KIRQL ProfileIrql
00270     )
00271 
00272 <span class="comment">/*++</span>
00273 <span class="comment"></span>
00274 <span class="comment">Routine Description:</span>
00275 <span class="comment"></span>
00276 <span class="comment">    This function sets the profile IRQL.</span>
00277 <span class="comment"></span>
00278 <span class="comment">    N.B. There are only two valid values for synchronization IRQL:</span>
00279 <span class="comment">        PROFILE_LEVEL and HIGH_LEVEL.</span>
00280 <span class="comment"></span>
00281 <span class="comment">Arguments:</span>
00282 <span class="comment"></span>
00283 <span class="comment">    Irql - Supplies the synchronization IRQL value.</span>
00284 <span class="comment"></span>
00285 <span class="comment">Return Value:</span>
00286 <span class="comment"></span>
00287 <span class="comment">    None.</span>
00288 <span class="comment"></span>
00289 <span class="comment">--*/</span>
00290 
00291 {
00292 
00293     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ProfileIrql == PROFILE_LEVEL) || (ProfileIrql == HIGH_LEVEL));
00294     <a class="code" href="../../d7/d3/i386init_8c.html#a0">KiProfileIrql</a> = ProfileIrql;
00295 }
00296 
00297 <span class="preprocessor">#endif</span>
00298 <span class="preprocessor"></span>
00299 <span class="preprocessor">#if defined(_ALPHA_)</span>
00300 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00301 KeSetSynchIrql (
00302     IN KIRQL SynchIrql
00303     )
00304 
00305 <span class="comment">/*++</span>
00306 <span class="comment"></span>
00307 <span class="comment">Routine Description:</span>
00308 <span class="comment"></span>
00309 <span class="comment">    This function sets the synchronization IRQL.</span>
00310 <span class="comment"></span>
00311 <span class="comment">    N.B. Synchronization IRQL may be any value between DISPATCH_LEVEL</span>
00312 <span class="comment">         and SYNCH_LEVEL.</span>
00313 <span class="comment"></span>
00314 <span class="comment">Arguments:</span>
00315 <span class="comment"></span>
00316 <span class="comment">    Irql - Supplies the synchronization IRQL value.</span>
00317 <span class="comment"></span>
00318 <span class="comment">Return Value:</span>
00319 <span class="comment"></span>
00320 <span class="comment">    None.</span>
00321 <span class="comment"></span>
00322 <span class="comment">--*/</span>
00323 
00324 {
00325 
00326     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((SynchIrql &gt;= DISPATCH_LEVEL) &amp;&amp; (SynchIrql &lt;= SYNCH_LEVEL));
00327 
00328     KiSynchIrql = SynchIrql;
00329 }
00330 
00331 <span class="preprocessor">#endif</span>
00332 <span class="preprocessor"></span>
00333 
00334 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00335"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a7">00335</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a7">KeSetSystemTime</a> (
00336     IN PLARGE_INTEGER NewTime,
00337     OUT PLARGE_INTEGER OldTime,
00338     IN BOOLEAN AdjustInterruptTime,
00339     IN PLARGE_INTEGER HalTimeToSet OPTIONAL
00340     )
00341 
00342 <span class="comment">/*++</span>
00343 <span class="comment"></span>
00344 <span class="comment">Routine Description:</span>
00345 <span class="comment"></span>
00346 <span class="comment">    This function sets the system time to the specified value and updates</span>
00347 <span class="comment">    timer queue entries to reflect the difference between the old system</span>
00348 <span class="comment">    time and the new system time.</span>
00349 <span class="comment"></span>
00350 <span class="comment">Arguments:</span>
00351 <span class="comment"></span>
00352 <span class="comment">    NewTime - Supplies a pointer to a variable that specifies the new system</span>
00353 <span class="comment">        time.</span>
00354 <span class="comment"></span>
00355 <span class="comment">    OldTime - Supplies a pointer to a variable that will receive the previous</span>
00356 <span class="comment">        system time.</span>
00357 <span class="comment"></span>
00358 <span class="comment">    AdjustInterruptTime - If TRUE the amount of time being adjusted is</span>
00359 <span class="comment">        also applied to InterruptTime and TickCount.</span>
00360 <span class="comment"></span>
00361 <span class="comment">    HalTimeToSet - Supplies an optional time that if specified is to be used</span>
00362 <span class="comment">        to set the time in the realtime clock.</span>
00363 <span class="comment"></span>
00364 <span class="comment">Return Value:</span>
00365 <span class="comment"></span>
00366 <span class="comment">    None.</span>
00367 <span class="comment"></span>
00368 <span class="comment">--*/</span>
00369 
00370 {
00371 
00372     LIST_ENTRY AbsoluteListHead;
00373     LIST_ENTRY ExpiredListHead;
00374     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00375     PLIST_ENTRY ListHead;
00376     PLIST_ENTRY NextEntry;
00377     KIRQL OldIrql1;
00378     KIRQL OldIrql2;
00379     LARGE_INTEGER TimeDelta;
00380     TIME_FIELDS <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>;
00381     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00382 
00383     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">// If a realtime clock value is specified, then convert the time value</span>
00387     <span class="comment">// to time fields.</span>
00388     <span class="comment">//</span>
00389 
00390     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HalTimeToSet)) {
00391         <a class="code" href="../../d1/d2/time_8c.html#a26">RtlTimeToTimeFields</a>(HalTimeToSet, &amp;<a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>);
00392     }
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Set affinity to the processor that keeps the system time, raise IRQL</span>
00396     <span class="comment">// to dispatcher level and lock the dispatcher database, then raise IRQL</span>
00397     <span class="comment">// to HIGH_LEVEL to synchronize with the clock interrupt routine.</span>
00398     <span class="comment">//</span>
00399 
00400     <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>((KAFFINITY)1);
00401     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql1);
00402     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;OldIrql2);
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Save the previous system time, set the new system time, and set</span>
00406     <span class="comment">// the realtime clock, if a time value is specified.</span>
00407     <span class="comment">//</span>
00408 
00409     KiQuerySystemTime(OldTime);
00410 
00411 <span class="preprocessor">#if defined(_WIN64)</span>
00412 <span class="preprocessor"></span>
00413     SharedUserData-&gt;SystemHigh2Time = NewTime-&gt;HighPart;
00414     SharedUserData-&gt;SystemLowTime = NewTime-&gt;LowPart;
00415     SharedUserData-&gt;SystemHigh1Time = NewTime-&gt;HighPart;
00416 
00417 <span class="preprocessor">#elif defined(ALPHA)</span>
00418 <span class="preprocessor"></span>
00419     SharedUserData-&gt;SystemTime = *(PULONGLONG)NewTime;
00420 
00421 <span class="preprocessor">#else</span>
00422 <span class="preprocessor"></span>
00423     SharedUserData-&gt;SystemTime.High2Time = NewTime-&gt;HighPart;
00424     SharedUserData-&gt;SystemTime.LowPart   = NewTime-&gt;LowPart;
00425     SharedUserData-&gt;SystemTime.High1Time = NewTime-&gt;HighPart;
00426 
00427 <span class="preprocessor">#endif // defined(ALPHA) || defined(_IA64_)</span>
00428 <span class="preprocessor"></span>
00429     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HalTimeToSet)) {
00430         <a class="code" href="../../d2/d7/hal_8h.html#a176">HalSetRealTimeClock</a>(&amp;<a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>);
00431     }
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Compute the difference between the previous system time and the new</span>
00435     <span class="comment">// system time.</span>
00436     <span class="comment">//</span>
00437 
00438     TimeDelta.QuadPart = NewTime-&gt;QuadPart - OldTime-&gt;QuadPart;
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// Update the boot time to reflect the delta. This keeps time based</span>
00442     <span class="comment">// on boot time constant</span>
00443     <span class="comment">//</span>
00444 
00445     <a class="code" href="../../d4/d9/ke_8h.html#a124">KeBootTime</a>.QuadPart = <a class="code" href="../../d4/d9/ke_8h.html#a124">KeBootTime</a>.QuadPart + TimeDelta.QuadPart;
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Track the overall bias applied to the boot time.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d4/d9/ke_8h.html#a125">KeBootTimeBias</a> = <a class="code" href="../../d4/d9/ke_8h.html#a125">KeBootTimeBias</a> + TimeDelta.QuadPart;
00452 
00453     <span class="comment">//</span>
00454     <span class="comment">// Lower IRQL to dispatch level and if needed adjust the physical</span>
00455     <span class="comment">// system interrupt time.</span>
00456     <span class="comment">//</span>
00457 
00458     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql2);
00459     <span class="keywordflow">if</span> (AdjustInterruptTime) {
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// Adjust the physical time of the system</span>
00463         <span class="comment">//</span>
00464 
00465         AdjustInterruptTime = <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a8">KiAdjustInterruptTime</a> (TimeDelta.QuadPart);
00466     }
00467 
00468     <span class="comment">//</span>
00469     <span class="comment">// If the physical interrupt time of the system was not adjusted,</span>
00470     <span class="comment">// recompute any absolute timers in the system for the new</span>
00471     <span class="comment">// system time.</span>
00472     <span class="comment">//</span>
00473 
00474     <span class="keywordflow">if</span> (!AdjustInterruptTime) {
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// Remove all absolute timers from the timer queue so their due time</span>
00478         <span class="comment">// can be recomputed.</span>
00479         <span class="comment">//</span>
00480 
00481         InitializeListHead(&amp;AbsoluteListHead);
00482         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00483             ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a3">KiTimerTableListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00484             NextEntry = ListHead-&gt;Flink;
00485             <span class="keywordflow">while</span> (NextEntry != ListHead) {
00486                 Timer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00487                 NextEntry = NextEntry-&gt;Flink;
00488                 <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o1">Absolute</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00489                     RemoveEntryList(&amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00490                     InsertTailList(&amp;AbsoluteListHead, &amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00491                 }
00492             }
00493         }
00494 
00495         <span class="comment">//</span>
00496         <span class="comment">// Recompute the due time and reinsert all absolute timers in the timer</span>
00497         <span class="comment">// tree. If a timer has already expired, then insert the timer in the</span>
00498         <span class="comment">// expired timer list.</span>
00499         <span class="comment">//</span>
00500 
00501         InitializeListHead(&amp;ExpiredListHead);
00502         <span class="keywordflow">while</span> (AbsoluteListHead.Flink != &amp;AbsoluteListHead) {
00503             Timer = CONTAINING_RECORD(AbsoluteListHead.Flink, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00504             <a class="code" href="../../d0/d0/ki_8h.html#a22">KiRemoveTreeTimer</a>(Timer);
00505             Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart -= TimeDelta.QuadPart;
00506             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/timersup_8c.html#a2">KiReinsertTreeTimer</a>(Timer, Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00507                 Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o3">Inserted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00508                 InsertTailList(&amp;ExpiredListHead, &amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00509             }
00510         }
00511 
00512         <span class="comment">//</span>
00513         <span class="comment">// If any of the attempts to reinsert a timer failed, then timers have</span>
00514         <span class="comment">// already expired and must be processed.</span>
00515         <span class="comment">//</span>
00516         <span class="comment">// N.B. The following function returns with the dispatcher database</span>
00517         <span class="comment">//      unlocked.</span>
00518         <span class="comment">//</span>
00519 
00520         <a class="code" href="../../d0/d0/ki_8h.html#a141">KiTimerListExpire</a>(&amp;ExpiredListHead, OldIrql1);
00521 
00522     } <span class="keywordflow">else</span> {
00523 
00524         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql1);
00525 
00526     }
00527 
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">// Set affinity back to its original value.</span>
00531     <span class="comment">//</span>
00532 
00533     <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// Notify other components that the system time has been set</span>
00537     <span class="comment">//</span>
00538 
00539     <a class="code" href="../../d1/d2/po_8h.html#a64">PoNotifySystemTimeSet</a>();
00540     <span class="keywordflow">return</span>;
00541 }
00542 
00543 BOOLEAN
<a name="l00544"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a8">00544</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a8">KiAdjustInterruptTime</a> (
00545     IN LONGLONG TimeDelta
00546     )
00547 <span class="comment">/*++</span>
00548 <span class="comment"></span>
00549 <span class="comment">Routine Description:</span>
00550 <span class="comment"></span>
00551 <span class="comment">    This function moves the physical interrupt time of the system</span>
00552 <span class="comment">    foreward by TimeDelta after a system wake has occurred.</span>
00553 <span class="comment"></span>
00554 <span class="comment">Arguments:</span>
00555 <span class="comment"></span>
00556 <span class="comment">    TimeDelta - amount of time to bump foreward interrupt time, tick</span>
00557 <span class="comment">                count and the perforamnce counter in 100ns units</span>
00558 <span class="comment"></span>
00559 <span class="comment">Return Value:</span>
00560 <span class="comment"></span>
00561 <span class="comment">    None.</span>
00562 <span class="comment"></span>
00563 <span class="comment">--*/</span>
00564 {
00565     <a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html">ADJUST_INTERRUPT_TIME_CONTEXT</a> Adjust;
00566 
00567     <span class="comment">//</span>
00568     <span class="comment">// Can only move time foreward</span>
00569     <span class="comment">//</span>
00570 
00571     <span class="keywordflow">if</span> (TimeDelta &lt; 0) {
00572 
00573         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574 
00575     } <span class="keywordflow">else</span> {
00576 
00577         Adjust.<a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html#o2">KiNumber</a> = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
00578         Adjust.<a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html#o3">HalNumber</a> = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
00579         Adjust.<a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html#o0">Adjustment</a> = (ULONGLONG) TimeDelta;
00580         Adjust.<a class="code" href="../../d7/d0/structADJUST__INTERRUPT__TIME__CONTEXT.html#o4">Barrier</a> = 1;
00581 
00582         <a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
00583             (<a class="code" href="../../d0/d0/ki_8h.html#a33">PKIPI_BROADCAST_WORKER</a>) <a class="code" href="../../d0/d0/ki_8h.html#a99">KiCalibrateTimeAdjustment</a>,
00584             (ULONG_PTR)(&amp;Adjust)
00585         );
00586 
00587         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00588     }
00589 }
00590 
00591 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00592"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a9">00592</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a9">KiCalibrateTimeAdjustment</a> (
00593     PADJUST_INTERRUPT_TIME_CONTEXT  Adjust
00594     )
00595 <span class="comment">/*++</span>
00596 <span class="comment"></span>
00597 <span class="comment">Routine Description:</span>
00598 <span class="comment"></span>
00599 <span class="comment">    Worker function for KiAdjustInterruptTime to calibrate the</span>
00600 <span class="comment">    adjustment of time on all processors.</span>
00601 <span class="comment"></span>
00602 <span class="comment">Arguments:</span>
00603 <span class="comment"></span>
00604 <span class="comment">    Adjust - context structure for operation</span>
00605 <span class="comment"></span>
00606 <span class="comment">Return Value:</span>
00607 <span class="comment"></span>
00608 <span class="comment">    None.</span>
00609 <span class="comment"></span>
00610 <span class="comment">--*/</span>
00611 {
00612     BOOLEAN             Enable;
00613     LARGE_INTEGER       InterruptTime;
00614     LARGE_INTEGER       SetTime;
00615     LARGE_INTEGER       PerfFreq;
00616     ULARGE_INTEGER      li;
00617     LARGE_INTEGER       NewTickCount;
00618     ULONG               NewTickOffset;
00619     ULONG               cl, divisor;
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">// As each processor arrives, subtract one off the remaining processor</span>
00623     <span class="comment">// count.  If this is the last processor to arrive compute the time</span>
00624     <span class="comment">// change, and signal all processor when to applied the performance</span>
00625     <span class="comment">// counter change.</span>
00626     <span class="comment">//</span>
00627 
00628     <span class="keywordflow">if</span> (InterlockedDecrement((PLONG) &amp;Adjust-&gt;KiNumber)) {
00629 
00630         Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
00631 
00632         <span class="comment">//</span>
00633         <span class="comment">// It is possible to deadlock here if one or more of the</span>
00634         <span class="comment">// other processors gets and processes a freeze request</span>
00635         <span class="comment">// while this processor has interrupts disabled.  Poll</span>
00636         <span class="comment">// for IPI_FREEZE requests until all processors are known</span>
00637         <span class="comment">// to be in this code and hence wont be requesting a </span>
00638         <span class="comment">// freeze.</span>
00639         <span class="comment">//</span>
00640 
00641         <span class="keywordflow">do</span> {
00642             <a class="code" href="../../d0/d0/ki_8h.html#a150">KiPollFreezeExecution</a>();
00643         } <span class="keywordflow">while</span> (Adjust-&gt;KiNumber != (ULONG)-1);
00644 
00645         <span class="comment">//</span>
00646         <span class="comment">// Wait to perform the time set</span>
00647         <span class="comment">//</span>
00648 
00649         <span class="keywordflow">while</span> (Adjust-&gt;Barrier) ;
00650 
00651     } <span class="keywordflow">else</span> {
00652 
00653         <span class="comment">//</span>
00654         <span class="comment">// Set timer expiration dpc to scan the timer queues once</span>
00655         <span class="comment">// for any expired timers</span>
00656         <span class="comment">//</span>
00657 
00658         <a class="code" href="../../d4/d1/dpcobj_8c.html#a3">KeRemoveQueueDpc</a> (&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a58">KiTimerExpireDpc</a>);
00659         <a class="code" href="../../d4/d1/dpcobj_8c.html#a2">KeInsertQueueDpc</a> (&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a58">KiTimerExpireDpc</a>, (PVOID) <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00660 
00661         <span class="comment">//</span>
00662         <span class="comment">// Disable interrupts and indicate that this processor is now</span>
00663         <span class="comment">// in final portion of this code.</span>
00664         <span class="comment">//</span>
00665 
00666         Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
00667         InterlockedDecrement((PLONG) &amp;Adjust-&gt;KiNumber);
00668 
00669         <span class="comment">//</span>
00670         <span class="comment">// Get the current times</span>
00671         <span class="comment">//</span>
00672 
00673         <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> (&amp;PerfFreq);
00674         InterruptTime.QuadPart = <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a2">KeQueryInterruptTime</a>() + Adjust-&gt;Adjustment;
00675         SetTime.QuadPart = InterruptTime.QuadPart + <a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a> / 2;
00676 
00677         <span class="comment">//</span>
00678         <span class="comment">// Compute performance counter for current SetTime</span>
00679         <span class="comment">//</span>
00680 
00681         <span class="comment">//</span>
00682         <span class="comment">// Multiply SetTime * PerfCount and obtain 96bit result</span>
00683         <span class="comment">// in cl, li.LowPart, li.HighPart.  Then divide the 96bit</span>
00684         <span class="comment">// result by 10,000,000 to get new performance counter value.</span>
00685         <span class="comment">//</span>
00686 
00687         li.QuadPart = RtlEnlargedUnsignedMultiply (
00688                             (ULONG) SetTime.LowPart,
00689                             (ULONG) PerfFreq.LowPart
00690                             ).QuadPart;
00691 
00692         cl = li.LowPart;
00693         li.QuadPart = li.HighPart +
00694                       RtlEnlargedUnsignedMultiply (
00695                             (ULONG) SetTime.LowPart,
00696                             (ULONG) PerfFreq.HighPart
00697                             ).QuadPart;
00698 
00699         li.QuadPart = li.QuadPart +
00700                       RtlEnlargedUnsignedMultiply (
00701                             (ULONG) SetTime.HighPart,
00702                             (ULONG) PerfFreq.LowPart
00703                             ).QuadPart;
00704 
00705         li.HighPart = li.HighPart + SetTime.HighPart * PerfFreq.HighPart;
00706 
00707         divisor = 10000000;
00708         Adjust-&gt;NewCount.HighPart =
00709             RtlEnlargedUnsignedDivide (
00710                 li,
00711                 divisor,
00712                 &amp;li.HighPart
00713                 );
00714 
00715         li.LowPart = cl;
00716         Adjust-&gt;NewCount.LowPart =
00717             RtlEnlargedUnsignedDivide (
00718                 li,
00719                 divisor,
00720                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00721                 );
00722 
00723         <span class="comment">//</span>
00724         <span class="comment">// Compute tick count and tick offset for current InterruptTime</span>
00725         <span class="comment">//</span>
00726 
00727         NewTickCount = <a class="code" href="../../d0/d1/largeic_8c.html#a0">RtlExtendedLargeIntegerDivide</a>(
00728                             InterruptTime,
00729                             <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>,
00730                             &amp;NewTickOffset
00731                             );
00732 
00733         <span class="comment">//</span>
00734         <span class="comment">// Apply changes to InterruptTime, TickCount, TickOffset, and the</span>
00735         <span class="comment">// performance counter</span>
00736         <span class="comment">//</span>
00737 
00738         <a class="code" href="../../d0/d0/ki_8h.html#a66">KiTickOffset</a> = <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a> - NewTickOffset;
00739         <a class="code" href="../../d4/d9/ke_8h.html#a126">KeInterruptTimeBias</a> += Adjust-&gt;Adjustment;
00740         SharedUserData-&gt;TickCountLow = NewTickCount.LowPart;
00741 
00742 <span class="preprocessor">#if defined(_WIN64)</span>
00743 <span class="preprocessor"></span>
00744         <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a> = NewTickCount.QuadPart;
00745         SharedUserData-&gt;InterruptHigh2Time = InterruptTime.HighPart;
00746         SharedUserData-&gt;InterruptTime = InterruptTime.QuadPart;
00747 
00748 <span class="preprocessor">#elif defined(ALPHA)</span>
00749 <span class="preprocessor"></span>
00750         <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a> = NewTickCount.QuadPart;
00751         SharedUserData-&gt;InterruptTime = InterruptTime.QuadPart;
00752 
00753 <span class="preprocessor">#else</span>
00754 <span class="preprocessor"></span>        <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>.High2Time = NewTickCount.HighPart;
00755         <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>.LowPart   = NewTickCount.LowPart;
00756         <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>.High1Time = NewTickCount.HighPart;
00757 
00758         SharedUserData-&gt;InterruptTime.High2Time = InterruptTime.HighPart;
00759         SharedUserData-&gt;InterruptTime.LowPart   = InterruptTime.LowPart;
00760         SharedUserData-&gt;InterruptTime.High1Time = InterruptTime.HighPart;
00761 <span class="preprocessor">#endif</span>
00762 <span class="preprocessor"></span>
00763         <span class="comment">//</span>
00764         <span class="comment">// Apply the performance counter change</span>
00765         <span class="comment">//</span>
00766 
00767         Adjust-&gt;Barrier = 0;
00768     }
00769 
00770     <a class="code" href="../../d2/d7/hal_8h.html#a171">HalCalibratePerformanceCounter</a> (
00771         (<span class="keyword">volatile</span> PLONG) &amp;Adjust-&gt;HalNumber,
00772         (ULONGLONG) Adjust-&gt;NewCount.QuadPart
00773         );
00774 
00775     <a class="code" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts</a>(Enable);
00776 }
00777 
00778 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00779"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a10">00779</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a10">KeSetTimeIncrement</a> (
00780     IN ULONG MaximumIncrement,
00781     IN ULONG MinimumIncrement
00782     )
00783 
00784 <span class="comment">/*++</span>
00785 <span class="comment"></span>
00786 <span class="comment">Routine Description:</span>
00787 <span class="comment"></span>
00788 <span class="comment">    This function sets the time increment value in 100ns units. This</span>
00789 <span class="comment">    value is added to the system time at each interval clock interrupt.</span>
00790 <span class="comment"></span>
00791 <span class="comment">Arguments:</span>
00792 <span class="comment"></span>
00793 <span class="comment">    MaximumIncrement - Supplies the maximum time between clock interrupts</span>
00794 <span class="comment">        in 100ns units supported by the host HAL.</span>
00795 <span class="comment"></span>
00796 <span class="comment">    MinimumIncrement - Supplies the minimum time between clock interrupts</span>
00797 <span class="comment">        in 100ns units supported by the host HAL.</span>
00798 <span class="comment"></span>
00799 <span class="comment">Return Value:</span>
00800 <span class="comment"></span>
00801 <span class="comment">    None.</span>
00802 <span class="comment"></span>
00803 <span class="comment">--*/</span>
00804 
00805 {
00806 
00807     <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a> = MaximumIncrement;
00808     <a class="code" href="../../d4/d9/ke_8h.html#a132">KeMinimumIncrement</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(MinimumIncrement, 10 * 1000);
00809     <a class="code" href="../../d4/d9/ke_8h.html#a152">KeTimeAdjustment</a> = MaximumIncrement;
00810     <a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a> = MaximumIncrement;
00811     <a class="code" href="../../d0/d0/ki_8h.html#a66">KiTickOffset</a> = MaximumIncrement;
00812 }
00813 
00814 BOOLEAN
<a name="l00815"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a11">00815</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a11">KeAddSystemServiceTable</a>(
00816     IN PULONG_PTR Base,
00817     IN PULONG Count OPTIONAL,
00818     IN ULONG Limit,
00819     IN PUCHAR Number,
00820     IN ULONG Index
00821     )
00822 
00823 <span class="comment">/*++</span>
00824 <span class="comment"></span>
00825 <span class="comment">Routine Description:</span>
00826 <span class="comment"></span>
00827 <span class="comment">    This function allows the caller to add a system service table</span>
00828 <span class="comment">    to the system</span>
00829 <span class="comment"></span>
00830 <span class="comment">Arguments:</span>
00831 <span class="comment"></span>
00832 <span class="comment">    Base - Supplies the address of the system service table dispatch</span>
00833 <span class="comment">        table.</span>
00834 <span class="comment"></span>
00835 <span class="comment">    Count - Supplies an optional pointer to a table of per system service</span>
00836 <span class="comment">        counters.</span>
00837 <span class="comment"></span>
00838 <span class="comment">    Limit - Supplies the limit of the service table. Services greater</span>
00839 <span class="comment">        than or equal to this limit will fail.</span>
00840 <span class="comment"></span>
00841 <span class="comment">    Arguments - Supplies the address of the argument count table.</span>
00842 <span class="comment"></span>
00843 <span class="comment">    Index - Supplies index of the service table.</span>
00844 <span class="comment"></span>
00845 <span class="comment">Return Value:</span>
00846 <span class="comment"></span>
00847 <span class="comment">    TRUE - The operation was successful.</span>
00848 <span class="comment"></span>
00849 <span class="comment">    FALSE - the operation failed. A service table is already bound to</span>
00850 <span class="comment">        the specified location, or the specified index is larger than</span>
00851 <span class="comment">        the maximum allowed index.</span>
00852 <span class="comment"></span>
00853 <span class="comment">--*/</span>
00854 
00855 {
00856 
00857     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00858 
00859     <span class="comment">//</span>
00860     <span class="comment">// If a system service table is already defined for the specified</span>
00861     <span class="comment">// index, then return FALSE. Otherwise, establish the new system</span>
00862     <span class="comment">// service table.</span>
00863     <span class="comment">//</span>
00864 
00865     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; <a class="code" href="../../d4/d9/ke_8h.html#a13">NUMBER_SERVICE_TABLES</a> - 1) ||
00866         (<a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o0">Base</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00867         (<a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o0">Base</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00868         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00869 
00870     } <span class="keywordflow">else</span> {
00871 
00872         <span class="comment">//</span>
00873         <span class="comment">// If the service table index is equal to the Win32 table, then</span>
00874         <span class="comment">// only update the shadow system service table. Otherwise, both</span>
00875         <span class="comment">// the shadow and static system service tables are updated.</span>
00876         <span class="comment">//</span>
00877 
00878         <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o0">Base</a> = Base;
00879         <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o1">Count</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00880         <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o2">Limit</a> = Limit;
00881 <span class="preprocessor">#if defined(_IA64_)</span>
00882 <span class="preprocessor"></span>
00883             <span class="comment">//</span>
00884             <span class="comment">// The global pointer associated with the table base is</span>
00885             <span class="comment">// placed just before the service table.</span>
00886             <span class="comment">//</span>
00887 
00888             <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].TableBaseGpOffset = 
00889                 (LONG)(*(Base-1) - (ULONG_PTR)Base);
00890 <span class="preprocessor">#endif</span>
00891 <span class="preprocessor"></span>        <a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o3">Number</a> = Number;
00892         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != 1) {
00893             <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o0">Base</a> = Base;
00894             <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o1">Count</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00895             <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o2">Limit</a> = Limit;
00896 <span class="preprocessor">#if defined(_IA64_)</span>
00897 <span class="preprocessor"></span>            <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].TableBaseGpOffset = 
00898                 (LONG)(*(Base-1) - (ULONG_PTR)Base);
00899 <span class="preprocessor">#endif</span>
00900 <span class="preprocessor"></span>            <a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d7/struct__KSERVICE__TABLE__DESCRIPTOR.html#o3">Number</a> = Number;
00901         }
00902 
00903         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00904     }
00905 }
00906 
00907 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00908 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00909"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a12">00909</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a12">KeSetSwapContextNotifyRoutine</a>(
00910     IN PSWAP_CONTEXT_NOTIFY_ROUTINE NotifyRoutine
00911     )
00912 <span class="comment">/*++</span>
00913 <span class="comment"></span>
00914 <span class="comment">Routine Description:</span>
00915 <span class="comment"></span>
00916 <span class="comment">    This function sets the address of a callout routine which will be called</span>
00917 <span class="comment">    at each context swtich.</span>
00918 <span class="comment"></span>
00919 <span class="comment">Arguments:</span>
00920 <span class="comment"></span>
00921 <span class="comment">    NotifyRoutine - Supplies the address of the swap context notify callout</span>
00922 <span class="comment">        routine.</span>
00923 <span class="comment"></span>
00924 <span class="comment">Return Value:</span>
00925 <span class="comment"></span>
00926 <span class="comment">    None.</span>
00927 <span class="comment"></span>
00928 <span class="comment">--*/</span>
00929 
00930 {
00931 
00932     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00933 
00934     <a class="code" href="../../d5/d9/kernldat_8c.html#a4">KiSwapContextNotifyRoutine</a> = NotifyRoutine;
00935     <span class="keywordflow">return</span>;
00936 }
00937 
00938 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00939 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00940"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a13">00940</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a13">KeSetThreadSelectNotifyRoutine</a>(
00941     IN PTHREAD_SELECT_NOTIFY_ROUTINE NotifyRoutine
00942     )
00943 
00944 <span class="comment">/*++</span>
00945 <span class="comment"></span>
00946 <span class="comment">Routine Description:</span>
00947 <span class="comment"></span>
00948 <span class="comment">    This function sets the address of a callout routine which will be called</span>
00949 <span class="comment">    when a thread is being selected for execution.</span>
00950 <span class="comment"></span>
00951 <span class="comment">Arguments:</span>
00952 <span class="comment"></span>
00953 <span class="comment">    NotifyRoutine - Supplies the address of the thread select notify callout</span>
00954 <span class="comment">        routine.</span>
00955 <span class="comment"></span>
00956 <span class="comment">Return Value:</span>
00957 <span class="comment"></span>
00958 <span class="comment">    None.</span>
00959 <span class="comment"></span>
00960 <span class="comment">--*/</span>
00961 
00962 {
00963 
00964     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00965 
00966     <a class="code" href="../../d5/d9/kernldat_8c.html#a5">KiThreadSelectNotifyRoutine</a> = NotifyRoutine;
00967     <span class="keywordflow">return</span>;
00968 }
00969 
00970 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00971 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00972"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a14">00972</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a14">KeSetTimeUpdateNotifyRoutine</a>(
00973     IN PTIME_UPDATE_NOTIFY_ROUTINE NotifyRoutine
00974     )
00975 
00976 <span class="comment">/*++</span>
00977 <span class="comment"></span>
00978 <span class="comment">Routine Description:</span>
00979 <span class="comment"></span>
00980 <span class="comment">    This function sets the address of a callout routine which will be called</span>
00981 <span class="comment">    each time the runtime for a thread is updated.</span>
00982 <span class="comment"></span>
00983 <span class="comment">Arguments:</span>
00984 <span class="comment"></span>
00985 <span class="comment">    RoutineNotify - Supplies the address of the time update notify callout</span>
00986 <span class="comment">        routine.</span>
00987 <span class="comment"></span>
00988 <span class="comment">Return Value:</span>
00989 <span class="comment"></span>
00990 <span class="comment">    None.</span>
00991 <span class="comment"></span>
00992 <span class="comment">--*/</span>
00993 
00994 {
00995 
00996     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00997 
00998     <a class="code" href="../../d5/d9/kernldat_8c.html#a6">KiTimeUpdateNotifyRoutine</a> = NotifyRoutine;
00999     <span class="keywordflow">return</span>;
01000 }
01001 
01002 
01003 KAFFINITY
<a name="l01004"></a><a class="code" href="../../d7/d0/ke_2miscc_8c.html#a15">01004</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a15">KeQueryActiveProcessors</a>(
01005     VOID
01006     )
01007 <span class="comment">/*++</span>
01008 <span class="comment"></span>
01009 <span class="comment">Routine Description:</span>
01010 <span class="comment"></span>
01011 <span class="comment">    This function returns the current set of active processors</span>
01012 <span class="comment">    in the system.</span>
01013 <span class="comment"></span>
01014 <span class="comment">Arguments:</span>
01015 <span class="comment"></span>
01016 <span class="comment">    None.</span>
01017 <span class="comment"></span>
01018 <span class="comment">Return Value:</span>
01019 <span class="comment"></span>
01020 <span class="comment">    KAFFINITY bitmask representing the set of active processors</span>
01021 <span class="comment"></span>
01022 <span class="comment">--*/</span>
01023 
01024 {
01025     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01026 
01027     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>);
01028 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
