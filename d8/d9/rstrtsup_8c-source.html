<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rstrtsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rstrtsup.c</h1><a href="../../d7/d0/rstrtsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    RstrtSup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements support for dealing with the Lfs restart area.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Brian Andrew    [BrianAn]   20-June-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/lfsprocs_8h.html">lfsprocs.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  The debug trace level</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d7/d0/rstrtsup_8c.html#a0">00027</a> <span class="preprocessor">#define Dbg                              (DEBUG_TRACE_RESTART_SUP)</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsFindOldestClientLsn)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsWriteLfsRestart)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00036"></a><a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">00036</a> <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a> (
00037     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00038     IN ULONG ThisRestartSize,
00039     IN BOOLEAN WaitForIo
00040     )
00041 
00042 <span class="comment">/*++</span>
00043 <span class="comment"></span>
00044 <span class="comment">Routine Description:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    This routine puts the Lfs restart area on the queue of operations to</span>
00047 <span class="comment">    write to the file.  We do this by allocating a second restart area</span>
00048 <span class="comment">    and attaching it to the Lfcb.  We also allocate a buffer control</span>
00049 <span class="comment">    block to use for this write.  We look at the WaitForIo boolean to</span>
00050 <span class="comment">    determine whether this thread can perform the I/O.  This also indicates</span>
00051 <span class="comment">    whether this thread gives up the Lfcb.</span>
00052 <span class="comment"></span>
00053 <span class="comment">Arguments:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    Lfcb - A pointer to the log file control block for this operation.</span>
00056 <span class="comment"></span>
00057 <span class="comment">    ThisRestartSize - This is the size to use for the restart area.</span>
00058 <span class="comment"></span>
00059 <span class="comment">    WaitForIo - Indicates if this thread is to perform the work.</span>
00060 <span class="comment"></span>
00061 <span class="comment">Return Value:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    None.</span>
00064 <span class="comment"></span>
00065 <span class="comment">--*/</span>
00066 
00067 {
00068     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NewLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00069     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> NewRestart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00070 
00071     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00072 
00073     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsWriteLfsRestart:  Entered\n"</span>, 0 );
00074     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
00075     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Write Chkdsk  -&gt; %04x\n"</span>, WriteChkdsk );
00076     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Restart Size  -&gt; %08lx\n"</span>, ThisRestartSize );
00077     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"WaitForIo     -&gt; %08lx\n"</span>, WaitForIo );
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00081     <span class="comment">//</span>
00082 
00083     <span class="keywordflow">try</span> {
00084 
00085         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ActiveLbcb;
00086 
00087         <span class="comment">//</span>
00088         <span class="comment">//  We allocate another restart area and</span>
00089         <span class="comment">//  copy the current area into it.  Attach the new area to the Lfcb.</span>
00090         <span class="comment">//</span>
00091 
00092         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a18">LfsAllocateRestartArea</a>( &amp;NewRestart, ThisRestartSize );
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">//  We allocate a Lbcb structure and update the values to</span>
00096         <span class="comment">//  reflect this restart area.</span>
00097         <span class="comment">//</span>
00098 
00099         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a>( Lfcb, &amp;NewLbcb );
00100         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a4">LBCB_RESTART_LBCB</a> );
00101 
00102         <span class="comment">//</span>
00103         <span class="comment">//  If this is the second page, then add a system page to the offset.</span>
00104         <span class="comment">//</span>
00105 
00106         <span class="keywordflow">if</span> (!Lfcb-&gt;InitialRestartArea) {
00107 
00108             NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> = Lfcb-&gt;SystemPageSize + NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>;
00109         }
00110 
00111         (ULONG)NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o5">Length</a> = ThisRestartSize;
00112 
00113         NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a> = (PVOID) Lfcb-&gt;RestartArea;
00114 
00115         <span class="comment">//</span>
00116         <span class="comment">//  Lets put the current lsn in the Lbcb.</span>
00117         <span class="comment">//</span>
00118 
00119         NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o11">LastEndLsn</a> = NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o10">LastLsn</a> = Lfcb-&gt;NextRestartLsn;
00120         Lfcb-&gt;NextRestartLsn.QuadPart = 1 + Lfcb-&gt;NextRestartLsn.QuadPart;
00121 
00122         <span class="comment">//</span>
00123         <span class="comment">//  Copy the existing restart area into the new area.</span>
00124         <span class="comment">//</span>
00125 
00126         RtlCopyMemory( NewRestart, Lfcb-&gt;RestartArea, ThisRestartSize );
00127         Lfcb-&gt;RestartArea = NewRestart;
00128 
00129         Lfcb-&gt;ClientArray = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NewRestart, Lfcb-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o7">ClientArrayOffset</a>, <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00130 
00131         NewRestart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00132 
00133         <span class="comment">//</span>
00134         <span class="comment">//  Update the Lfcb to indicate that the other restart area</span>
00135         <span class="comment">//  on the disk is to be used.</span>
00136         <span class="comment">//</span>
00137 
00138         Lfcb-&gt;InitialRestartArea = !Lfcb-&gt;InitialRestartArea;
00139 
00140         <span class="comment">//</span>
00141         <span class="comment">//  Add this Lbcb to the end of the workque and flush to that point.</span>
00142         <span class="comment">//</span>
00143 
00144         InsertTailList( &amp;Lfcb-&gt;LbcbWorkque, &amp;NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">//  If we don't support a packed log file then we need to make</span>
00148         <span class="comment">//  sure that all file records written out ahead of this</span>
00149         <span class="comment">//  restart area make it out to disk and we don't add anything</span>
00150         <span class="comment">//  to this page.</span>
00151         <span class="comment">//</span>
00152 
00153         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a8">LFCB_PACK_LOG</a> )
00154             &amp;&amp; !IsListEmpty( &amp;Lfcb-&gt;LbcbActive )) {
00155 
00156             ActiveLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbActive.Flink,
00157                                             <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00158                                             ActiveLinks );
00159 
00160             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ActiveLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a2">LBCB_NOT_EMPTY</a> )) {
00161 
00162                 RemoveEntryList( &amp;ActiveLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a> );
00163                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ActiveLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a1">LBCB_ON_ACTIVE_QUEUE</a> );
00164             }
00165         }
00166 
00167         <span class="keywordflow">if</span> (WaitForIo) {
00168 
00169             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a53">LfsFlushLbcb</a>( Lfcb, NewLbcb );
00170         }
00171 
00172     } finally {
00173 
00174         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a63">LfsWriteLfsRestart</a> );
00175 
00176         <span class="keywordflow">if</span> (NewRestart != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00177 
00178             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewRestart );
00179         }
00180 
00181         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsWriteLfsRestart:  Exit\n"</span>, 0 );
00182     }
00183 
00184     <span class="keywordflow">return</span>;
00185 }
00186 
00187 
00188 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00189"></a><a class="code" href="../../d7/d0/rstrtsup_8c.html#a2">00189</a> <a class="code" href="../../d7/d0/rstrtsup_8c.html#a2">LfsFindOldestClientLsn</a> (
00190     IN <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea,
00191     IN <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientArray,
00192     OUT PLSN OldestLsn
00193     )
00194 
00195 <span class="comment">/*++</span>
00196 <span class="comment"></span>
00197 <span class="comment">Routine Description:</span>
00198 <span class="comment"></span>
00199 <span class="comment">    This routine walks through the active clients to determine the oldest</span>
00200 <span class="comment">    Lsn the system must maintain.</span>
00201 <span class="comment"></span>
00202 <span class="comment">Arguments:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    RestartArea - This is the Restart Area to examine.</span>
00205 <span class="comment"></span>
00206 <span class="comment">    ClientArray - This is the start of the client data array.</span>
00207 <span class="comment"></span>
00208 <span class="comment">    OldestLsn - We store the oldest Lsn we find in this value.  It is</span>
00209 <span class="comment">        initialized with a starting value, we won't return a more recent</span>
00210 <span class="comment">        Lsn.</span>
00211 <span class="comment"></span>
00212 <span class="comment">Return Value:</span>
00213 <span class="comment"></span>
00214 <span class="comment">    None.</span>
00215 <span class="comment"></span>
00216 <span class="comment">--*/</span>
00217 
00218 {
00219     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NextClient;
00220 
00221     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientBlock;
00222 
00223     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00224 
00225     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFindOldestClientLsn:  Entered\n"</span>, 0 );
00226     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"RestartArea       -&gt; %08lx\n"</span>, RestartArea );
00227     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Base Lsn (Low)    -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00228     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Base Lsn (High)   -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">//  Take the first client off the in use list.</span>
00232     <span class="comment">//</span>
00233 
00234     NextClient = RestartArea-&gt;ClientInUseList;
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">//  While there are more clients, compare their oldest Lsn with the</span>
00238     <span class="comment">//  current oldest.</span>
00239     <span class="comment">//</span>
00240 
00241     <span class="keywordflow">while</span> (NextClient != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
00242 
00243         ClientBlock = ClientArray + NextClient;
00244 
00245         <span class="comment">//</span>
00246         <span class="comment">//  We ignore this block if it's oldest Lsn is 0.</span>
00247         <span class="comment">//</span>
00248 
00249         <span class="keywordflow">if</span> (( ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a>.QuadPart != 0 )
00250             &amp;&amp; ( ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a>.QuadPart &lt; OldestLsn-&gt;QuadPart )) {
00251 
00252             *OldestLsn = ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o0">OldestLsn</a>;
00253         }
00254 
00255         <span class="comment">//</span>
00256         <span class="comment">//  Try the next client block.</span>
00257         <span class="comment">//</span>
00258 
00259         NextClient = ClientBlock-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a>;
00260     }
00261 
00262     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"OldestLsn (Low)   -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00263     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"OldestLsn (High)  -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00264     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFindOldestClientLsn:  Exit\n"</span>, 0 );
00265 
00266     <span class="keywordflow">return</span>;
00267 }
00268 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
