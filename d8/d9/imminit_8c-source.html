<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: imminit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>imminit.c</h1><a href="../../d7/d0/imminit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: imminit.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module implements IMM32 initialization</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">// required for wow.obj in userrtl.lib</span>
<a name="l00016"></a><a class="code" href="../../d7/d0/imminit_8c.html#a0">00016</a> <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d1/d8/clglobal_8c.html#a7">gHighestUserAddress</a>;
00017 
00018 
<a name="l00019"></a><a class="code" href="../../d7/d0/imminit_8c.html#a1">00019</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d0/imminit_8c.html#a1">ImmInitializeGlobals</a>(HINSTANCE hmod)
00020 {
00021     SYSTEM_BASIC_INFORMATION SystemInformation;
00022 
00023     <span class="keywordflow">if</span> (hmod) {
00024         <span class="comment">/*</span>
00025 <span class="comment">         * Remember IMM32.DLL's hmodule so we can grab resources from it later.</span>
00026 <span class="comment">         */</span>
00027         <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a2">ghInst</a> = hmod;
00028     }
00029     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a1">gfInitialized</a>) {
00030         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00031     }
00032     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>))) {
00033         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmInitializeGlobals: failed to initialize critical section at startup. Just bail."</span>);
00034         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00035     }
00036     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a>(SystemBasicInformation,
00037             &amp;SystemInformation,
00038             <span class="keyword">sizeof</span>(SystemInformation),
00039             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00040         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmInitializeGlobals: failed to query system information. Just bail."</span>);
00041         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00042     }
00043     <a class="code" href="../../d1/d8/clglobal_8c.html#a7">gHighestUserAddress</a> = SystemInformation.MaximumUserModeAddress;
00044 
00045     <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a1">gfInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00046 
00047     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00048 }
00049 
00050 
<a name="l00051"></a><a class="code" href="../../d7/d0/imminit_8c.html#a2">00051</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d0/imminit_8c.html#a2">ImmRegisterClient</a>(
00052     IN <a class="code" href="../../d4/d6/structtagSHAREDINFO.html">PSHAREDINFO</a> psiClient, HINSTANCE hmod)
00053 {
00054     <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a> = *psiClient;
00055     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o0">psi</a>;
00056     <span class="comment">/* Raid #97316</span>
00057 <span class="comment">     * Dlls loaded earlier than imm32.dll could make</span>
00058 <span class="comment">     * user32 call which calls back imm routines.</span>
00059 <span class="comment">     * ImmRegisterClient() is called from User32's init routine,</span>
00060 <span class="comment">     * so we can expect to reach here early enough.</span>
00061 <span class="comment">     * We need to initialize globals as much as possible</span>
00062 <span class="comment">     * here.</span>
00063 <span class="comment">     */</span>
00064     <span class="keywordflow">return</span> <a class="code" href="../../d7/d0/imminit_8c.html#a1">ImmInitializeGlobals</a>(hmod);
00065 }
00066 
<a name="l00067"></a><a class="code" href="../../d7/d0/imminit_8c.html#a3">00067</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d0/imminit_8c.html#a3">ImmDllInitialize</a>(
00068     IN PVOID hmod,
00069     IN DWORD Reason,
00070     IN PCONTEXT pctx OPTIONAL)
00071 {
00072     UNREFERENCED_PARAMETER(pctx);
00073 
00074     <span class="keywordflow">switch</span> ( Reason ) {
00075 
00076     <span class="keywordflow">case</span> DLL_PROCESS_ATTACH:
00077         UserAssert(!<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a1">gfInitialized</a> || hmod == <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a2">ghInst</a>);
00078 
00079         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d0/imminit_8c.html#a1">ImmInitializeGlobals</a>(hmod))
00080             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00081 
00082         UserAssert(hmod != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00083 
00084         <span class="comment">// Initialize USER32.DLL in case if USER32 has not bound itself to IMM32</span>
00085         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/inc_2user_8h.html#a1135">User32InitializeImmEntryTable</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a127">IMM_MAGIC_CALLER_ID</a>))
00086             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00087         <span class="keywordflow">break</span>;
00088 
00089     <span class="keywordflow">case</span> DLL_PROCESS_DETACH:
00090         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a1">gfInitialized</a>) {
00091             <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;<a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a8">gcsImeDpi</a>);
00092         }
00093         <span class="keywordflow">break</span>;
00094 
00095     <span class="keywordflow">case</span> DLL_THREAD_DETACH:
00096         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00097             <a class="code" href="../../d4/d1/userk_8h.html#a2031">DestroyInputContext</a>(
00098                 (HIMC)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateDefaultInputContext),
00099                 <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0),
00100                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00101         }
00102         <span class="keywordflow">break</span>;
00103 
00104     <span class="keywordflow">default</span>:
00105         <span class="keywordflow">break</span>;
00106     }
00107 
00108     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00109 }
00110 
00111 
00112 <span class="comment">/***************************************************************************\</span>
00113 <span class="comment">* Allocation routines for RTL functions.</span>
00114 <span class="comment">*</span>
00115 <span class="comment">*</span>
00116 <span class="comment">\***************************************************************************/</span>
00117 
<a name="l00118"></a><a class="code" href="../../d7/d0/imminit_8c.html#a4">00118</a> PVOID <a class="code" href="../../d6/d1/userrtl_8h.html#a31">UserRtlAllocMem</a>(
00119     ULONG uBytes)
00120 {
00121     <span class="keywordflow">return</span> LocalAlloc(LPTR, uBytes);
00122 }
00123 
<a name="l00124"></a><a class="code" href="../../d7/d0/imminit_8c.html#a5">00124</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d1/userrtl_8h.html#a32">UserRtlFreeMem</a>(
00125     PVOID pMem)
00126 {
00127     LocalFree(pMem);
00128 }
00129 
<a name="l00130"></a><a class="code" href="../../d7/d0/imminit_8c.html#a6">00130</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a61">UserRtlRaiseStatus</a>(
00131     NTSTATUS Status)
00132 {
00133     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00134 }
00135 
<a name="l00136"></a><a class="code" href="../../d7/d0/imminit_8c.html#a7">00136</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a55">GetRipComponent</a>(VOID) { <span class="keywordflow">return</span> RIP_IMM; }
00137 
<a name="l00138"></a><a class="code" href="../../d7/d0/imminit_8c.html#a8">00138</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a56">GetDbgTagFlags</a>(<span class="keywordtype">int</span> tag)
00139 {
00140 <span class="preprocessor">#if DEBUGTAGS</span>
00141 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;adwDBGTAGFlags[tag] : 0);
00142 <span class="preprocessor">#else</span>
00143 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
00144     UNREFERENCED_PARAMETER(tag);
00145 <span class="preprocessor">#endif // DEBUGTAGS</span>
00146 <span class="preprocessor"></span>}
00147 
<a name="l00148"></a><a class="code" href="../../d7/d0/imminit_8c.html#a9">00148</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a57">GetRipPID</a>(VOID) { <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o2">wRIPPID</a> : 0); }
<a name="l00149"></a><a class="code" href="../../d7/d0/imminit_8c.html#a10">00149</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a58">GetRipFlags</a>(VOID) { <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o0">wRIPFlags</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a393">RIPF_DEFAULT</a>); }
00150 
00151 <span class="keyword">extern</span> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a171">NtUserSetRipFlags</a>(DWORD, DWORD);
00152 
<a name="l00153"></a><a class="code" href="../../d7/d0/imminit_8c.html#a12">00153</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a59">SetRipFlags</a>(DWORD dwRipFlags, DWORD dwRipPID)
00154 {
00155     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a171">NtUserSetRipFlags</a>(dwRipFlags, dwRipPID);
00156 }
00157 
<a name="l00158"></a><a class="code" href="../../d7/d0/imminit_8c.html#a13">00158</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a60">SetDbgTag</a>(<span class="keywordtype">int</span> tag, DWORD dwBitFlags)
00159 {
00160     RIPMSG0(RIP_ERROR, <span class="stringliteral">"SetDbgTag not available in imm32.dll"</span>);
00161     <span class="keywordflow">return</span>;
00162     UNREFERENCED_PARAMETER(tag);
00163     UNREFERENCED_PARAMETER(dwBitFlags);
00164 }
00165 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:21 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
