<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmapi.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmapi.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d9/d8/cmapi_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a9">CmpSetValueKeyExisting</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> OldChild, IN <a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Value, IN ULONG Type, IN PVOID Data, IN ULONG DataSize, IN ULONG StorageType, IN ULONG TempData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a10">CmpSetValueKeyNew</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Parent, IN PUNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN ULONG Type, IN PVOID Data, IN ULONG DataSize, IN ULONG StorageType, IN ULONG TempData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a11">CmDeleteValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN UNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a12">CmEnumerateKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, IN KEY_INFORMATION_CLASS KeyInformationClass, IN PVOID KeyInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a13">CmEnumerateValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, IN PVOID KeyValueInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a14">CmFlushKey</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a15">CmQueryKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN KEY_INFORMATION_CLASS KeyInformationClass, IN PVOID KeyInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a16">CmQueryValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN UNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, IN PVOID KeyValueInformation, IN ULONG Length, IN PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a17">CmQueryMultipleValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN PKEY_VALUE_ENTRY ValueEntries, IN ULONG EntryCount, IN PVOID <a class="el" href="../../d2/d7/regtest_8c.html#a1">ValueBuffer</a>, IN OUT PULONG BufferLength, IN OPTIONAL PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a18">CmSetValueKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN PUNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN ULONG Type, IN PVOID Data, IN ULONG DataSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a19">CmSetLastWriteTimeKey</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, IN PLARGE_INTEGER LastWriteTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a20">CmLoadKey</a> (IN POBJECT_ATTRIBUTES TargetKey, IN POBJECT_ATTRIBUTES SourceFile, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a21">CmUnloadKey</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Kcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a22">CmpDoFlushAll</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a23">CmReplaceKey</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN PUNICODE_STRING NewHiveName, IN PUNICODE_STRING OldFileName)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a3">CmpWasSetupBoot</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PUCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a5">CmpStashBufferSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a11" doxytag="cmapi.c::CmDeleteValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmDeleteValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">92</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00033">CmpFindNameInList()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00053">CmpFreeValue()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">HvReallocateCell()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a69">PCHILD_LIST</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a64">PCM_KEY_CONTROL_BLOCK</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00943">EhDeleteValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>.
<p>
<pre class="fragment"><div>00098                    :
00099 
00100     One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entries of a registry key may be removed with <span class="keyword">this</span> call.
00101 
00102     The value entry with <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
00103     If no such entry exists, an error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00104 
00105 Arguments:
00106 
00107     KeyControlBlock - pointer to <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> <span class="keywordflow">for</span> key to operate on
00108 
00109     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - The name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value to be deleted.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a legal name.
00110 
00111 Return Value:
00112 
00113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00114 
00115         &lt;TBS&gt;
00116 
00117 --*/
00118 {
00119     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00120     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> pcell;
00121     <a class="code" href="../../d7/d9/struct__CHILD__LIST.html">PCHILD_LIST</a> plist;
00122     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> targetaddress;
00123     ULONG  targetindex;
00124     ULONG   newcount;
00125     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newcell;
00126     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ChildCell;
00127     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00128     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00129     ULONG realsize;
00130     LARGE_INTEGER systemtime;
00131 
00132     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmDeleteValueKey\n"));
00133 
00134     CmpLockRegistryExclusive();
00135 
00136     try {
00137         <span class="comment">//</span>
00138         <span class="comment">// no edits, not even this one, on keys marked for deletion</span>
00139         <span class="comment">//</span>
00140         <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00141             <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00142         }
00143 
00144         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00145         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00146         pcell = KeyControlBlock-&gt;KeyNode;
00147 
00148         <span class="comment">// Mark the hive as read only</span>
00149         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00150 
00151         status = STATUS_OBJECT_NAME_NOT_FOUND;
00152 
00153         plist = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>);
00154         ChildCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00155 
00156         <span class="keywordflow">if</span> (plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> != 0) {
00157 
00158             <span class="comment">//</span>
00159             <span class="comment">// The parent has at least one value, map in the list of</span>
00160             <span class="comment">// values and call CmpFindChildInList</span>
00161             <span class="comment">//</span>
00162 
00163             <span class="comment">//</span>
00164             <span class="comment">// plist -&gt; the CHILD_LIST structure</span>
00165             <span class="comment">// pchild -&gt; the child node structure being examined</span>
00166             <span class="comment">//</span>
00167 
00168             ChildCell = <a class="code" href="../../d4/d3/cmtree_8c.html#a0">CmpFindNameInList</a>(Hive,
00169                                           plist,
00170                                           &amp;ValueName,
00171                                           &amp;targetaddress,
00172                                           &amp;targetindex);
00173 
00174             <span class="keywordflow">if</span> (ChildCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00175 
00176                 <span class="comment">//</span>
00177                 <span class="comment">// 1. the desired target was found</span>
00178                 <span class="comment">// 2. ChildCell is it's HCELL_INDEX</span>
00179                 <span class="comment">// 3. targetaddress points to it</span>
00180                 <span class="comment">// 4. targetindex is it's index</span>
00181                 <span class="comment">//</span>
00182 
00183                 <span class="comment">//</span>
00184                 <span class="comment">// attempt to mark all relevent cells dirty</span>
00185                 <span class="comment">//</span>
00186                 <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell) &amp;&amp;
00187                       <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>) &amp;&amp;
00188                       <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, ChildCell)))
00189 
00190                 {
00191                     <span class="comment">// Mark the hive as read only</span>
00192                     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00193 
00194                     <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00195                 }
00196 
00197                 <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize,targetaddress-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>)) {
00198 
00199                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, targetaddress-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>)) {
00200 
00201                         <span class="comment">// Mark the hive as read only</span>
00202                         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00203 
00204                         <span class="keywordflow">return</span>(STATUS_NO_LOG_SPACE);
00205                     }
00206                 }
00207 
00208                 newcount = plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> - 1;
00209 
00210                 <span class="keywordflow">if</span> (newcount &gt; 0) {
00211                     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pvector;
00212 
00213                     <span class="comment">//</span>
00214                     <span class="comment">// more than one entry list, squeeze</span>
00215                     <span class="comment">//</span>
00216                     pvector = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00217                     <span class="keywordflow">for</span> ( ; targetindex &lt; newcount; targetindex++) {
00218                         pvector-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[ targetindex ] =
00219                             pvector-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[ targetindex+1 ];
00220                     }
00221 
00222                     newcell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(
00223                                 Hive,
00224                                 plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>,
00225                                 newcount * <span class="keyword">sizeof</span>(HCELL_INDEX)
00226                                 );
00227                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(newcell != HCELL_NIL);
00228                     plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = newcell;
00229 
00230                 } <span class="keywordflow">else</span> {
00231 
00232                     <span class="comment">//</span>
00233                     <span class="comment">// list is empty, free it</span>
00234                     <span class="comment">//</span>
00235                     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00236                 }
00237                 plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = newcount;
00238                 <a class="code" href="../../d9/d2/cmsubs2_8c.html#a3">CmpFreeValue</a>(Hive, ChildCell);
00239 
00240                 <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
00241                 pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
00242 
00243                 <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> == 0) {
00244                     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = 0;
00245                     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = 0;
00246                 }
00247 
00248                 <span class="comment">//</span>
00249                 <span class="comment">// We are changing the KCB cache. Since the registry is locked exclusively,</span>
00250                 <span class="comment">// we do not need a KCB lock.</span>
00251                 <span class="comment">//</span>
00252                 <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00253 
00254                 <span class="comment">//</span>
00255                 <span class="comment">// Invalidate the cache</span>
00256                 <span class="comment">//</span>
00257                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(KeyControlBlock);
00258 
00259                 KeyControlBlock-&gt;ValueCache.Count = plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
00260                 KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>;
00261     
00262                 <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(
00263                         KeyControlBlock,
00264                         KeyControlBlock-&gt;KeyHive,
00265                         KeyControlBlock-&gt;KeyCell,
00266                         REG_NOTIFY_CHANGE_LAST_SET
00267                         );
00268                 status = STATUS_SUCCESS;
00269             } <span class="keywordflow">else</span> {
00270                 status = STATUS_OBJECT_NAME_NOT_FOUND;
00271             }
00272         }
00273     } finally {
00274         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00275     }
00276 
00277     <span class="comment">// Mark the hive as read only</span>
00278     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00279 
00280     <span class="keywordflow">return</span> status;
00281 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmapi.c::CmEnumerateKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmEnumerateKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">285</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">CmpQueryKeyData()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00320">EhEnumerateKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>.
<p>
<pre class="fragment"><div>00295                    :
00296 
00297     Enumerate sub keys, <span class="keywordflow">return</span> data on <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>'th entry.
00298 
00299     <a class="code" href="../../d8/d9/cmapi_8c.html#a12">CmEnumerateKey</a> returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>'th sub key of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open
00300     key specified.  The value STATUS_NO_MORE_ENTRIES will be
00301     returned <span class="keywordflow">if</span> value of <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> larger than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sub keys.
00302 
00303     Note that <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply a way to select among child keys.  Two calls
00304     to <a class="code" href="../../d8/d9/cmapi_8c.html#a12">CmEnumerateKey</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> are NOT guaranteed to <span class="keywordflow">return</span>
00305     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same results.
00306 
00307     If KeyInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00308     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00309     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00310 
00311 Arguments:
00312 
00313     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00314 
00315     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (0-based) number of the sub key to be returned.
00316 
00317     KeyInformationClass - Specifies the type of information returned in
00318         Buffer.  One of the following types:
00319 
00320         KeyBasicInformation - return last write time, title index, and name.
00321             (see KEY_BASIC_INFORMATION structure)
00322 
00323         KeyNodeInformation - return last write time, title index, name, class.
00324             (see KEY_NODE_INFORMATION structure)
00325 
00326     KeyInformation -Supplies pointer to buffer to receive the data.
00327 
00328     Length - Length of KeyInformation in bytes.
00329 
00330     ResultLength - Number of bytes actually written into KeyInformation.
00331 
00332 Return Value:
00333 
00334     NTSTATUS - Result code from call, among the following:
00335 
00336         &lt;TBS&gt;
00337 
00338 --*/
00339 {
00340     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00341     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> childcell;
00342     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00343     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00344     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00345 
00346     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmEnumerateKey\n"));
00347 
00348 
00349     CmpLockRegistry();
00350 
00351     if (KeyControlBlock-&gt;Delete) {
00352         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00353         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00354     }
00355 
00356     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00357     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00358 
00359     <span class="comment">// Mark the hive as read only</span>
00360     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// fetch the child of interest</span>
00364     <span class="comment">//</span>
00365 
00366     childcell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(Hive, KeyControlBlock-&gt;KeyNode, Index);
00367     <span class="keywordflow">if</span> (childcell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00368         <span class="comment">//</span>
00369         <span class="comment">// no such child, clean up and return error</span>
00370         <span class="comment">//</span>
00371 
00372         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00373 
00374         <span class="comment">// Mark the hive as read only</span>
00375         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00376 
00377         <span class="keywordflow">return</span> STATUS_NO_MORE_ENTRIES;
00378     }
00379 
00380     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,childcell);
00381 
00382     <span class="keywordflow">try</span> {
00383 
00384         <span class="comment">//</span>
00385         <span class="comment">// call a worker to perform data transfer</span>
00386         <span class="comment">//</span>
00387 
00388         status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a4">CmpQueryKeyData</a>(Hive,
00389                                  Node,
00390                                  KeyInformationClass,
00391                                  KeyInformation,
00392                                  Length,
00393                                  ResultLength);
00394 
00395      } except (EXCEPTION_EXECUTE_HANDLER) {
00396         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00397         status = GetExceptionCode();
00398 
00399         <span class="comment">// Mark the hive as read only</span>
00400         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00401 
00402         <span class="keywordflow">return</span> status;
00403     }
00404 
00405     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00406 
00407     <span class="comment">// Mark the hive as read only</span>
00408     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00409 
00410     <span class="keywordflow">return</span> status;
00411 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="cmapi.c::CmEnumerateValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmEnumerateValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_VALUE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">416</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00256">CM_KCB_SYM_LINK_FOUND</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00609">CMP_GET_CACHED_ADDRESS</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00200">CmpGetValueKeyFromCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00115">CmpGetValueListFromCache()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00144">CmpMakeValueCacheReadOnly</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00145">CmpMakeValueCacheReadWrite</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a81">PCM_KEY_VALUE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00604">PPCM_CACHED_VALUE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00396">EhEnumerateValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>.
<p>
<pre class="fragment"><div>00426                    :
00427 
00428     The value entries of an open key may be enumerated.
00429 
00430     <a class="code" href="../../d8/d9/cmapi_8c.html#a13">CmEnumerateValueKey</a> returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>'th value
00431     entry of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open key specified by KeyHandle.  The value
00432     STATUS_NO_MORE_ENTRIES will be returned <span class="keywordflow">if</span> value of <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00433     larger than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sub keys.
00434 
00435     Note that <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply a way to select among value
00436     entries.  Two calls to <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>
00437     are NOT guaranteed to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same results.
00438 
00439     If KeyValueInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00440     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00441     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00442 
00443 Arguments:
00444 
00445     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00446 
00447     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (0-based) number of the sub key to be returned.
00448 
00449     KeyValueInformationClass - Specifies the type of information returned
00450     in Buffer. One of the following types:
00451 
00452         KeyValueBasicInformation - return time of last write,
00453             title index, and name.  (See KEY_VALUE_BASIC_INFORMATION)
00454 
00455         KeyValueFullInformation - return time of last write,
00456             title index, name, class.  (See KEY_VALUE_FULL_INFORMATION)
00457 
00458     KeyValueInformation -Supplies pointer to buffer to receive the data.
00459 
00460     Length - Length of KeyValueInformation in bytes.
00461 
00462     ResultLength - Number of bytes actually written into KeyValueInformation.
00463 
00464 Return Value:
00465 
00466     NTSTATUS - Result code from call, among the following:
00467 
00468         &lt;TBS&gt;
00469 
00470 --*/
00471 {
00472     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00473     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00474     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00475     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> ChildList;
00476     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueData;
00477     BOOLEAN    IndexCached;
00478     BOOLEAN    ValueCached;
00479     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList;
00480 
00481     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmEnumerateValueKey\n"));
00482 
00483 
00484     <span class="comment">//</span>
00485     <span class="comment">// lock the parent cell</span>
00486     <span class="comment">//</span>
00487 
00488     CmpLockRegistry();
00489 
00490     if (KeyControlBlock-&gt;Delete) {
00491         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00492         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00493     }
00494     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00495     Node = KeyControlBlock-&gt;KeyNode;
00496 
00497     <span class="comment">//</span>
00498     <span class="comment">// fetch the child of interest</span>
00499     <span class="comment">//</span>
00500     <span class="comment">//</span>
00501     <span class="comment">// Do it using the cache</span>
00502     <span class="comment">//</span>
00503     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= KeyControlBlock-&gt;ValueCache.Count) {
00504         <span class="comment">//</span>
00505         <span class="comment">// No such child, clean up and return error.</span>
00506         <span class="comment">//</span>
00507         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00508         <span class="keywordflow">return</span>(STATUS_NO_MORE_ENTRIES);
00509     }
00510 
00511     <span class="comment">// Mark the hive as read only</span>
00512     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00513 
00514     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00515     <span class="keywordflow">if</span> (KeyControlBlock-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
00516         <span class="comment">//</span>
00517         <span class="comment">// The value list is now set to the KCB for symbolic link,</span>
00518         <span class="comment">// Clean it up and set the value right before we do the query.</span>
00519         <span class="comment">//</span>
00520         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock-&gt;ValueCache.RealKcb);
00521         KeyControlBlock-&gt;ExtFlags &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
00522 
00523         KeyControlBlock-&gt;ValueCache.Count = KeyControlBlock-&gt;KeyNode-&gt;ValueList.Count;
00524         KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) KeyControlBlock-&gt;KeyNode-&gt;ValueList.List;
00525     }
00526 
00527     ChildList = <a class="code" href="../../d4/d3/cmtree_8c.html#a1">CmpGetValueListFromCache</a>(Hive, &amp;(KeyControlBlock-&gt;ValueCache), &amp;IndexCached);
00528     ValueData = <a class="code" href="../../d4/d3/cmtree_8c.html#a2">CmpGetValueKeyFromCache</a>(Hive, ChildList, Index, &amp;ContainingList, IndexCached, &amp;ValueCached);    
00529 
00530     <span class="keywordflow">try</span> {
00531 
00532         <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00533         <a class="code" href="../../d1/d2/cmp_8h.html#a10">CmpMakeValueCacheReadWrite</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00534 
00535         <span class="comment">//</span>
00536         <span class="comment">// call a worker to perform data transfer</span>
00537         <span class="comment">//</span>
00538         status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a5">CmpQueryKeyValueData</a>(Hive,
00539                                   ContainingList,
00540                                   ValueData,
00541                                   ValueCached,
00542                                   KeyValueInformationClass,
00543                                   KeyValueInformation,
00544                                   Length,
00545                                   ResultLength);
00546 
00547          <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00548         <a class="code" href="../../d1/d2/cmp_8h.html#a9">CmpMakeValueCacheReadOnly</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00549     } finally {
00550 
00551         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00552         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00553     }
00554 
00555     <span class="comment">// Mark the hive as read only</span>
00556     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00557 
00558     <span class="keywordflow">return</span> status;
00559 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmapi.c::CmFlushKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmFlushKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">564</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d1/d2/cmp_8h.html#a178">CMHIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00660">CmLockHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">CmpNoWrite</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00275">CMS_IO_ERROR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00662">CmUnlockHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">DCmCheckRegistry</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d2/cmp_8h.html#a179">PCMHIVE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>.
<p>
<pre class="fragment"><div>00570                    :
00571 
00572     Forces changes <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to a key to disk.
00573 
00574     <a class="code" href="../../d8/d9/cmapi_8c.html#a14">CmFlushKey</a> will not <span class="keywordflow">return</span> to its caller until any changed data
00575     associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key has been written <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
00576 
00577     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>: <a class="code" href="../../d8/d9/cmapi_8c.html#a14">CmFlushKey</a> will flush <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire registry tree, and thus will
00578     burn cycles and I/O.
00579 
00580 Arguments:
00581 
00582     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00583 
00584     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of node to whose sub keys are to be found
00585 
00586 Return Value:
00587 
00588     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00589 
00590         &lt;TBS&gt;
00591 
00592 --*/
00593 {
00594     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00595     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
00596     <span class="keyword">extern</span> <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
00597 
00598     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmFlushKey\n"));
00599 
00600     <span class="comment">//</span>
00601     <span class="comment">// If writes are not working, lie and say we succeeded, will</span>
00602     <span class="comment">// clean up in a short time.  Only early system init code</span>
00603     <span class="comment">// will ever know the difference.</span>
00604     <span class="comment">//</span>
00605     if (CmpNoWrite) {
00606         <span class="keywordflow">return</span> STATUS_SUCCESS;
00607     }
00608 
00609 
00610     <span class="comment">// Mark the hive as read only</span>
00611     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00612 
00613     CmHive = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// Don't flush the master hive.  If somebody asks for a flushkey on</span>
00617     <span class="comment">// the master hive, do a CmpDoFlushAll instead.  CmpDoFlushAll flushes</span>
00618     <span class="comment">// every hive except the master hive, which is what they REALLY want.</span>
00619     <span class="comment">//</span>
00620     <span class="keywordflow">if</span> (CmHive == <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>) {
00621         <a class="code" href="../../d1/d2/cmp_8h.html#a243">CmpDoFlushAll</a>();
00622     } <span class="keywordflow">else</span> {
00623         <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive));
00624 
00625         <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a> (CmHive);
00626 
00627         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>(Hive)) {
00628 
00629             status = STATUS_REGISTRY_IO_FAILED;
00630 
00631             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO_ERROR) {
00632                 KdPrint((<span class="stringliteral">"CmFlushKey: HvSyncHive failed\n"</span>));
00633             }
00634         }
00635 
00636         <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a> (CmHive);
00637     }
00638 
00639     <span class="comment">// Mark the hive as read only</span>
00640     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
00641 
00642     <span class="keywordflow">return</span>  status;
00643 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="cmapi.c::CmLoadKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmLoadKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">1901</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00748">_REGISTRY_COMMAND::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00745">_REGISTRY_COMMAND::CmHive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00496">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00029">CmpProfileLoaded</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00354">CmpSetGlobalQuotaAllowed()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00030">CmpWasSetupBoot</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00744">_REGISTRY_COMMAND::FileAttributes</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00754">_REGISTRY_COMMAND::ImpersonationContext</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00726">REG_CMD_ADD_HIVE_LIST</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00723">REG_CMD_HIVE_CLOSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00722">REG_CMD_HIVE_OPEN</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a180">REGISTRY_COMMAND</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00750">_REGISTRY_COMMAND::RegistryLockAquired</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00209">SeCreateClientSecurity()</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a60">SECURITY_CLIENT_CONTEXT</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00612">SeDeleteClientSecurity</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00743">_REGISTRY_COMMAND::Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02881">NtLoadKey2()</a>.
<p>
<pre class="fragment"><div>01909                    :
01910 
01911     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> hive (file in the format created by NtSaveKey) may be linked
01912     into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active registry with <span class="keyword">this</span> call.  UNLIKE <a class="code" href="../../d7/d7/ntapi_8c.html#a26">NtRestoreKey</a>,
01913     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> specified to <a class="code" href="../../d7/d7/ntapi_8c.html#a30">NtLoadKey</a> will become <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual backing
01914     store of part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry (that is, it will NOT be copied.)
01915 
01916     The file may have an associated .log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01917 
01918     If the hive file is marked as needing a .log file, and one is
01919     not present, the call will fail.
01920 
01921     The name specified by SourceFile must be such that <span class="stringliteral">".log"</span> can
01922     be appended to it to generate the name of the log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Thus,
01923     on FAT file systems, the hive file may not have an <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
01924 
01925     This call is used by logon to make the user's profile available
01926     in the registry.  It is not intended <span class="keywordflow">for</span> use doing backup,
01927     restore, etc.  Use NtRestoreKey <span class="keywordflow">for</span> that.
01928 
01929     N.B.  This routine assumes that the object attributes <span class="keywordflow">for</span> the file
01930           to be opened have been captured into kernel space so that
01931           they can safely be passed to the worker thread to open the file
01932           and <span class="keywordflow">do</span> the actual I/O.
01933 
01934 Arguments:
01935 
01936     TargetKey - specifies the path to a key to link the hive to.
01937                 path must be of the form <span class="stringliteral">"\registry\user&lt;username&gt;"</span>
01938 
01939     SourceFile - specifies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  <span class="keywordflow">while</span> file could be remote,
01940                 that is strongly discouraged.
01941 
01942     Flags - specifies any flags that should be used <span class="keywordflow">for</span> the load operation.
01943             The only valid flag is REG_NO_LAZY_FLUSH.
01944 
01945 Return Value:
01946 
01947     NTSTATUS - values TBS.
01948 
01949 --*/
01950 {
01951     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
01952     NTSTATUS Status;
01953     BOOLEAN Allocate;
01954     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
01955     SECURITY_QUALITY_OF_SERVICE ServiceQos;
01956     <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">SECURITY_CLIENT_CONTEXT</a> ClientSecurityContext;
01957 
01958 
01959     <span class="comment">//</span>
01960     <span class="comment">// Obtain the security context here so we can use it</span>
01961     <span class="comment">// later to impersonate the user, which we will do</span>
01962     <span class="comment">// if we cannot access the file as SYSTEM.  This</span>
01963     <span class="comment">// usually occurs if the file is on a remote machine.</span>
01964     <span class="comment">//</span>
01965     ServiceQos.Length = <span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
01966     ServiceQos.ImpersonationLevel = SecurityImpersonation;
01967     ServiceQos.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
01968     ServiceQos.EffectiveOnly = TRUE;
01969     Status = <a class="code" href="../../d0/d5/se_8h.html#a169">SeCreateClientSecurity</a>(CONTAINING_RECORD(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(),<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,Tcb),
01970                                     &amp;ServiceQos,
01971                                     FALSE,
01972                                     &amp;ClientSecurityContext);
01973     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01974         <span class="keywordflow">return</span>(Status);
01975     }
01976 
01977     <span class="comment">//</span>
01978     <span class="comment">// Do not lock the registry; Instead set the RegistryLockAquired member </span>
01979     <span class="comment">// of REGISTRY_COMMAND so CmpWorker can lock it after opening the hive files</span>
01980     <span class="comment">//</span>
01981     <span class="comment">//CmpLockRegistryExclusive();</span>
01982     <span class="comment">//</span>
01983 
01984     Command.RegistryLockAquired = FALSE;
01985     Command.Command = REG_CMD_HIVE_OPEN;
01986     Command.Allocate = TRUE;
01987     Command.FileAttributes = SourceFile;
01988     Command.ImpersonationContext = &amp;ClientSecurityContext;
01989 
01990     <a class="code" href="../../d1/d2/cmp_8h.html#a292">CmpWorker</a>(&amp;Command);
01991     Status = Command.Status;
01992 
01993     <a class="code" href="../../d0/d5/se_8h.html#a12">SeDeleteClientSecurity</a>( &amp;ClientSecurityContext );
01994 
01995     NewHive = Command.CmHive;
01996     Allocate = Command.Allocate;
01997 
01998     if (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01999         <span class="keywordflow">if</span>( Command.RegistryLockAquired ) {
02000             <span class="comment">// if CmpWorker has locked the registry, unlock it now.</span>
02001             <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02002         }
02003         <span class="keywordflow">return</span>(Status);
02004     } <span class="keywordflow">else</span> {
02005         <span class="comment">//</span>
02006         <span class="comment">// if we got here, CmpWorker should have locked the registry exclusive.</span>
02007         <span class="comment">//</span>
02008         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Command.RegistryLockAquired );
02009     }
02010 
02011     <span class="comment">//</span>
02012     <span class="comment">// if this is a NO_LAZY_FLUSH hive, set the appropriate bit.</span>
02013     <span class="comment">//</span>
02014     <span class="keywordflow">if</span> (Flags &amp; REG_NO_LAZY_FLUSH) {
02015         NewHive-&gt;Hive.HiveFlags |= <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>;
02016     }
02017 
02018     <span class="comment">//</span>
02019     <span class="comment">// We now have a succesfully loaded and initialized CmHive, so we</span>
02020     <span class="comment">// just need to link that into the appropriate spot in the master hive.</span>
02021     <span class="comment">//</span>
02022     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(TargetKey-&gt;ObjectName,
02023                                  TargetKey-&gt;RootDirectory,
02024                                  NewHive,
02025                                  Allocate,
02026                                  TargetKey-&gt;SecurityDescriptor);
02027 
02028     Command.CmHive = NewHive;
02029     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02030         <span class="comment">//</span>
02031         <span class="comment">// add new hive to hivelist</span>
02032         <span class="comment">//</span>
02033         Command.Command = <a class="code" href="../../d1/d2/cmp_8h.html#a108">REG_CMD_ADD_HIVE_LIST</a>;
02034 
02035     } <span class="keywordflow">else</span> {
02036         <span class="comment">//</span>
02037         <span class="comment">// Close the files we've opened.</span>
02038         <span class="comment">//</span>
02039         Command.Command = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02040     }
02041     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02042 
02043     <span class="comment">//</span>
02044     <span class="comment">// We've given user chance to log on, so turn on quota</span>
02045     <span class="comment">//</span>
02046     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
02047         (<a class="code" href="../../d8/d9/cmapi_8c.html#a3">CmpWasSetupBoot</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02048         <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02049         <a class="code" href="../../d1/d2/cmp_8h.html#a249">CmpSetGlobalQuotaAllowed</a>();
02050     }
02051 
02052     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02053     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02054 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="cmapi.c::CmpDoFlushAll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpDoFlushAll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">2195</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00660">CmLockHive</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00027">CmpHiveListHead</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">CmpNoWrite</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00662">CmUnlockHive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00204">HIVE_NOLAZYFLUSH</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00461">CmpLazyFlushWorker()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.
<p>
<pre class="fragment"><div>02200                    :
02201 
02202     Flush all hives.
02203 
02204     Runs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CmpWorkerThread.
02205 
02206     Runs down list of Hives and applies <a class="code" href="../../d6/d0/hive_8h.html#a34">HvSyncHive</a> to them.
02207 
02208     NOTE: Hives which are marked as HV_NOLAZYFLUSH are *NOT* flushed
02209           by <span class="keyword">this</span> call.  You must call <a class="code" href="../../d6/d0/hive_8h.html#a34">HvSyncHive</a> explicitly to flush
02210           a hive marked as HV_NOLAZYFLUSH.
02211 
02212 Arguments:
02213 
02214 Return Value:
02215 
02216     NONE
02217 
02218 --*/
02219 {
02220     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02221     PLIST_ENTRY p;
02222     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     h;
02223     BOOLEAN     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    
02224 <span class="comment">/*</span>
02225 <span class="comment">    ULONG rc;</span>
02226 <span class="comment">*/</span>
02227     <span class="keyword">extern</span> <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
02228 
02229     <span class="comment">//</span>
02230     <span class="comment">// If writes are not working, lie and say we succeeded, will</span>
02231     <span class="comment">// clean up in a short time.  Only early system init code</span>
02232     <span class="comment">// will ever know the difference.</span>
02233     <span class="comment">//</span>
02234     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
02235         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02236     }
02237 
02238     <span class="comment">//</span>
02239     <span class="comment">// traverse list of hives, sync each one</span>
02240     <span class="comment">//</span>
02241     p = <a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>.Flink;
02242     <span class="keywordflow">while</span> (p != &amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>) {
02243 
02244         h = CONTAINING_RECORD(p, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, HiveList);
02245 
02246 <span class="comment">/*</span>
02247 <span class="comment">#if DBG</span>
02248 <span class="comment">        if (h!=CmpMasterHive) {</span>
02249 <span class="comment">            rc = CmCheckRegistry(h, FALSE);</span>
02250 <span class="comment"></span>
02251 <span class="comment">            if (rc!=0) {</span>
02252 <span class="comment">                KdPrint(("CmpDoFlushAll: corrupt hive, rc = %08lx\n",rc));</span>
02253 <span class="comment">                DbgBreakPoint();</span>
02254 <span class="comment">            }</span>
02255 <span class="comment">        }</span>
02256 <span class="comment">#endif</span>
02257 <span class="comment">*/</span>
02258         <span class="keywordflow">if</span> (!(h-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>)) {
02259 
02260             <span class="comment">//</span>
02261             <span class="comment">//Lock the hive before we flush it.</span>
02262             <span class="comment">//-- since we now allow multiple readers</span>
02263             <span class="comment">// during a flush (a flush is considered a read)</span>
02264             <span class="comment">// we have to force a serialization on the vector table</span>
02265             <span class="comment">//</span>
02266             <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a> (h);
02267             
02268             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)h);
02269 
02270             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
02271                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02272             }
02273             <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a> (h);
02274             <span class="comment">//</span>
02275             <span class="comment">// WARNNOTE - the above means that a lazy flush or</span>
02276             <span class="comment">//            or shutdown flush did not work.  we don't</span>
02277             <span class="comment">//            know why.  there is noone to report an error</span>
02278             <span class="comment">//            to, so continue on and hope for the best.</span>
02279             <span class="comment">//            (in theory, worst that can happen is user changes</span>
02280             <span class="comment">//             are lost.)</span>
02281             <span class="comment">//</span>
02282         }
02283 
02284 
02285         p = p-&gt;Flink;
02286     }
02287     
02288     <span class="keywordflow">return</span> Result;
02289 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmapi.c::CmpSetValueKeyExisting" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpSetValueKeyExisting           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OldChild</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Value</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Data</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StorageType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TempData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">1383</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00489">CM_KEY_VALUE_SMALL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00487">CM_KEY_VALUE_SPECIAL_SIZE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00428">CM_MAX_STASH</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00032">CmpStashBuffer</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00033">CmpStashBufferSize</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00335">HvGetCellSize()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>.
<p>
<pre class="fragment"><div>01395                    :
01396 
01397     Helper <span class="keywordflow">for</span> <a class="code" href="../../d8/d9/cmapi_8c.html#a18">CmSetValueKey</a>, implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry
01398     being set already exists.
01399 
01400 Arguments:
01401 
01402     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - hive of interest
01403 
01404     OldChild - hcell_index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry body to which we are to
01405                     set <span class="keyword">new</span> data
01406 
01407     Type - The integer <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
01408 
01409     Data - Pointer to buffer with actual data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
01410 
01411     DataSize - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of Data buffer.
01412 
01413     StorageType - stable or <span class="keyword">volatile</span>
01414 
01415     TempData - small values are passed here
01416 
01417 Return Value:
01418 
01419     STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked, appropriate status code <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> did not
01420 
01421 --*/
01422 {
01423     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DataCell;
01424     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pdata;
01425     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewCell;
01426     ULONG realsize;
01427     BOOLEAN small;
01428     PUCHAR      StashBuffer;
01429     ULONG <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01430 
01431     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01432 
01433 
01434     <span class="comment">//</span>
01435     <span class="comment">// value entry by the specified name already exists</span>
01436     <span class="comment">// oldchild is hcell_index of its value entry body</span>
01437     <span class="comment">//  which we will always edit, so mark it dirty</span>
01438     <span class="comment">//</span>
01439     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, OldChild)) {
01440         <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01441     }
01442 
01443     small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pvalue-&gt;u.KeyValue.DataLength);
01444 
01445     <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) {               <span class="comment">// small</span>
01446 
01447         <span class="comment">//</span>
01448         <span class="comment">// We are storing a small datum, TempData has data.</span>
01449         <span class="comment">//</span>
01450         <span class="keywordflow">if</span> ((! small) &amp;&amp; (realsize &gt; 0))
01451         {
01452             <span class="comment">//</span>
01453             <span class="comment">// value entry has existing external data to free</span>
01454             <span class="comment">//</span>
01455             <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, pvalue-&gt;u.KeyValue.Data)) {
01456                 <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01457             }
01458             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, pvalue-&gt;u.KeyValue.Data);
01459         }
01460 
01461         <span class="comment">//</span>
01462         <span class="comment">// write our new small data into value entry body</span>
01463         <span class="comment">//</span>
01464         pvalue-&gt;u.KeyValue.DataLength = DataSize + <a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>;
01465         pvalue-&gt;u.KeyValue.Data = TempData;
01466         pvalue-&gt;u.KeyValue.Type = Type;
01467 
01468         <span class="keywordflow">return</span> STATUS_SUCCESS;
01469 
01470     } <span class="keywordflow">else</span> {                                            <span class="comment">// large</span>
01471 
01472         <span class="comment">//</span>
01473         <span class="comment">// We are storing a "large" datum</span>
01474         <span class="comment">//</span>
01475 
01476         <span class="comment">//</span>
01477         <span class="comment">// See if we can write data on top of existing cell</span>
01478         <span class="comment">//</span>
01479         <span class="keywordflow">if</span> ((! small) &amp;&amp; (realsize &gt; 0)) {
01480 
01481             DataCell = pvalue-&gt;u.KeyValue.Data;
01482             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DataCell != HCELL_NIL);
01483             pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, DataCell);
01484 
01485             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(Hive, pdata) &gt; 0);
01486 
01487             <span class="keywordflow">if</span> (DataSize &lt;= (ULONG)(<a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(Hive, pdata))) {
01488 
01489                 <span class="comment">//</span>
01490                 <span class="comment">// The existing data cell is big enough to hold the</span>
01491                 <span class="comment">// new data.  Attempt to copy to stash buffer. if</span>
01492                 <span class="comment">// we succeed we can copy directly onto the old cell.</span>
01493                 <span class="comment">// if we fail, we must allocate and fill a new cell,</span>
01494                 <span class="comment">// and replace the old one with it.</span>
01495                 <span class="comment">//</span>
01496                 <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, DataCell)) {
01497                     <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01498                 }
01499 
01500                 StashBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01501                 <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d8/d9/cmapi_8c.html#a5">CmpStashBufferSize</a>) {
01502 
01503                     StashBuffer = <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>;
01504 
01505                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d1/d2/cmp_8h.html#a70">CM_MAX_STASH</a>) {
01506 
01507                     <span class="comment">//</span>
01508                     <span class="comment">// Try to allocate a bigger stash buffer.  If it works, keep it and</span>
01509                     <span class="comment">// free the old one.  This prevents pool from becoming too fragmented</span>
01510                     <span class="comment">// if somebody (like SAM) is repeatedly setting very large values</span>
01511                     <span class="comment">//</span>
01512                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = ((DataSize + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1));
01513 
01514                     StashBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, BufferSize, 'bSmC');
01515                     <span class="keywordflow">if</span> (StashBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01516                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmpStashBuffer);
01517                         <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a> = StashBuffer;
01518                         <a class="code" href="../../d8/d9/cmapi_8c.html#a5">CmpStashBufferSize</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01519                     }
01520                 }
01521 
01522                 <span class="keywordflow">if</span> (StashBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01523                     <span class="comment">//</span>
01524                     <span class="comment">// We have a stash buffer</span>
01525                     <span class="comment">//</span>
01526                     <span class="keywordflow">try</span> {
01527 
01528                         RtlCopyMemory(
01529                             StashBuffer,
01530                             Data,
01531                             DataSize
01532                             );
01533 
01534                     } except (EXCEPTION_EXECUTE_HANDLER) {
01535                         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01536                             KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01537                         }
01538                         <span class="keywordflow">return</span> GetExceptionCode();
01539                     }
01540 
01541 
01542                     <span class="comment">//</span>
01543                     <span class="comment">// We have filled the stash buffer, copy data and finish</span>
01544                     <span class="comment">//</span>
01545                     RtlCopyMemory(
01546                         pdata,
01547                         StashBuffer,
01548                         DataSize
01549                         );
01550 
01551                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(StashBuffer != NULL);
01552 
01553                     pvalue-&gt;u.KeyValue.DataLength = DataSize;
01554                     pvalue-&gt;u.KeyValue.Type = Type;
01555 
01556                     <span class="keywordflow">return</span> STATUS_SUCCESS;
01557 
01558                  } <span class="comment">// else stashbuffer == null</span>
01559             } <span class="comment">// else existing cell is too small</span>
01560         } <span class="comment">// else there is no existing cell</span>
01561     } <span class="comment">// new cell needed (always large)</span>
01562 
01563     <span class="comment">//</span>
01564     <span class="comment">// Either the existing cell is not large enough, or does</span>
01565     <span class="comment">// not exist, or we couldn't stash successfully.</span>
01566     <span class="comment">//</span>
01567     <span class="comment">// Allocate and fill a new cell.  Free the old one.  Store</span>
01568     <span class="comment">// the new's index into the value entry body.</span>
01569     <span class="comment">//</span>
01570     NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive, DataSize, StorageType);
01571 
01572     <span class="keywordflow">if</span> (NewCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01573         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01574     }
01575 
01576     <span class="comment">//</span>
01577     <span class="comment">// fill the new data cell</span>
01578     <span class="comment">//</span>
01579     pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, NewCell);
01580     <span class="keywordflow">try</span> {
01581 
01582         RtlMoveMemory(
01583             pdata,
01584             Data,
01585             DataSize
01586             );
01587 
01588     } except (EXCEPTION_EXECUTE_HANDLER) {
01589         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01590             KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01591         }
01592         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, NewCell);
01593         <span class="keywordflow">return</span> GetExceptionCode();
01594     }
01595 
01596     <span class="comment">//</span>
01597     <span class="comment">// free the old data cell</span>
01598     <span class="comment">//</span>
01599     <span class="keywordflow">if</span> ((! small) &amp;&amp; (realsize &gt; 0)) {
01600         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pvalue-&gt;u.KeyValue.Data != HCELL_NIL);
01601         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, pvalue-&gt;u.KeyValue.Data)) {
01602             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, NewCell);
01603             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01604         }
01605         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, pvalue-&gt;u.KeyValue.Data);
01606     }
01607 
01608     <span class="comment">//</span>
01609     <span class="comment">// set body</span>
01610     <span class="comment">//</span>
01611     pvalue-&gt;u.KeyValue.DataLength = DataSize;
01612     pvalue-&gt;u.KeyValue.Data = NewCell;
01613     pvalue-&gt;u.KeyValue.Type = Type;
01614 
01615     <span class="keywordflow">return</span> STATUS_SUCCESS;
01616 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmapi.c::CmpSetValueKeyNew" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpSetValueKeyNew           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Data</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StorageType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TempData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">1619</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00485">CM_KEY_VALUE_SIGNATURE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00489">CM_KEY_VALUE_SMALL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00487">CM_KEY_VALUE_SPECIAL_SIZE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00431">CM_MAX_REASONABLE_VALUES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00074">CmpCopyName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00697">CmpHKeyValueSize</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00500">_CM_KEY_VALUE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">HvReallocateCell()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00502">_CM_KEY_VALUE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00496">_CM_KEY_VALUE::NameLength</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00495">_CM_KEY_VALUE::Signature</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00491">VALUE_COMP_NAME</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>.
<p>
<pre class="fragment"><div>01631                    :
01632 
01633     Helper <span class="keywordflow">for</span> <a class="code" href="../../d8/d9/cmapi_8c.html#a18">CmSetValueKey</a>, implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry
01634     being set does not exist.  Will create <span class="keyword">new</span> value entry and data,
01635     place in list (which may be created)
01636 
01637 Arguments:
01638 
01639     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - hive of interest
01640 
01641     Parent - pointer to key node value entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span>
01642 
01643     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - The unique (relative to the containing key) name
01644         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.  May be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
01645 
01646     TitleIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> title index <span class="keywordflow">for</span> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.  The title
01647         index specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> localized alias <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.
01648 
01649     Type - The integer <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
01650 
01651     Data - Pointer to buffer with actual data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
01652 
01653     DataSize - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of Data buffer.
01654 
01655     StorageType - stable or <span class="keyword">volatile</span>
01656 
01657     TempData - small data values passed here
01658 
01659 
01660 Return Value:
01661 
01662     STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked, appropriate status code <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> did not
01663 
01664 --*/
01665 {
01666     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pvalue;
01667     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
01668     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DataCell;
01669     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pdata;
01670     ULONG   count;
01671     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewCell;
01672     ULONG AllocateSize;
01673 
01674     <span class="comment">//</span>
01675     <span class="comment">// Either Count == 0 (no list) or our entry is simply not in</span>
01676     <span class="comment">// the list.  Create a new value entry body, and data.  Add to list.</span>
01677     <span class="comment">// (May create the list.)</span>
01678     <span class="comment">//</span>
01679     <span class="keywordflow">if</span> (Parent-&gt;ValueList.Count != 0) {
01680         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Parent-&gt;ValueList.List != HCELL_NIL);
01681         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Parent-&gt;ValueList.List)) {
01682             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01683         }
01684     }
01685 
01686     <span class="comment">//</span>
01687     <span class="comment">// allocate the body of the value entry, and the data</span>
01688     <span class="comment">//</span>
01689     ValueCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
01690                     Hive,
01691                     <a class="code" href="../../d1/d2/cmp_8h.html#a100">CmpHKeyValueSize</a>(Hive, ValueName),
01692                     StorageType
01693                     );
01694 
01695     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01696         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01697     }
01698 
01699     DataCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01700     <span class="keywordflow">if</span> (DataSize &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) {
01701         DataCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive, DataSize, StorageType);
01702         <span class="keywordflow">if</span> (DataCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01703             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, ValueCell);
01704             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01705         }
01706     }
01707 
01708     <span class="comment">//</span>
01709     <span class="comment">// map in the body, and fill in its fixed portion</span>
01710     <span class="comment">//</span>
01711     pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
01712     pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a34">CM_KEY_VALUE_SIGNATURE</a>;
01713 
01714     <span class="comment">//</span>
01715     <span class="comment">// fill in the variable portions of the new value entry,  name and</span>
01716     <span class="comment">// and data are copied from caller space, could fault.</span>
01717     <span class="comment">//</span>
01718     <span class="keywordflow">try</span> {
01719 
01720         <span class="comment">//</span>
01721         <span class="comment">// fill in the name</span>
01722         <span class="comment">//</span>
01723         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a>(Hive,
01724                                                     pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>,
01725                                                     ValueName);
01726     } except (EXCEPTION_EXECUTE_HANDLER) {
01727         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01728             KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01729         }
01730 
01731         <span class="comment">//</span>
01732         <span class="comment">// We have bombed out loading user data, clean up and exit.</span>
01733         <span class="comment">//</span>
01734         <span class="keywordflow">if</span> (DataCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01735             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, DataCell);
01736         }
01737         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, ValueCell);
01738         <span class="keywordflow">return</span> GetExceptionCode();
01739     }
01740 
01741     <span class="keywordflow">if</span> (pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a> &lt; <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length) {
01742         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>;
01743     } <span class="keywordflow">else</span> {
01744         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> = 0;
01745     }
01746 
01747     <span class="comment">//</span>
01748     <span class="comment">// fill in the data</span>
01749     <span class="comment">//</span>
01750     <span class="keywordflow">if</span> (DataSize &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) {
01751         pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, DataCell);
01752 
01753         <span class="keywordflow">try</span> {
01754 
01755             RtlMoveMemory(pdata, Data, DataSize);
01756 
01757         } except (EXCEPTION_EXECUTE_HANDLER) {
01758             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01759                 KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01760             }
01761 
01762             <span class="comment">//</span>
01763             <span class="comment">// We have bombed out loading user data, clean up and exit.</span>
01764             <span class="comment">//</span>
01765             <span class="keywordflow">if</span> (DataCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01766                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, DataCell);
01767             }
01768             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, ValueCell);
01769             <span class="keywordflow">return</span> GetExceptionCode();
01770         }
01771 
01772         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> = DataSize;
01773         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a> = DataCell;
01774 
01775     } <span class="keywordflow">else</span> {
01776         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> = DataSize + <a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>;
01777         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a> = TempData;
01778     }
01779 
01780     <span class="comment">//</span>
01781     <span class="comment">// either add ourselves to list, or make new one with us in it.</span>
01782     <span class="comment">//</span>
01783     count = Parent-&gt;ValueList.Count;
01784     count++;
01785     <span class="keywordflow">if</span> (count &gt; 1) {
01786 
01787         <span class="keywordflow">if</span> (count &lt; <a class="code" href="../../d1/d2/cmp_8h.html#a71">CM_MAX_REASONABLE_VALUES</a>) {
01788 
01789             <span class="comment">//</span>
01790             <span class="comment">// A reasonable number of values, allocate just enough</span>
01791             <span class="comment">// space.</span>
01792             <span class="comment">//</span>
01793 
01794             AllocateSize = count * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01795         } <span class="keywordflow">else</span> {
01796 
01797             <span class="comment">//</span>
01798             <span class="comment">// An excessive number of values, pad the allocation out</span>
01799             <span class="comment">// to avoid fragmentation. (if there's this many values,</span>
01800             <span class="comment">// there'll probably be more pretty soon)</span>
01801             <span class="comment">//</span>
01802             AllocateSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(count, CM_MAX_REASONABLE_VALUES) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01803             <span class="keywordflow">if</span> (AllocateSize &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
01804                 AllocateSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(AllocateSize, HBLOCK_SIZE);
01805             }
01806         }
01807         NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(
01808                         Hive,
01809                         Parent-&gt;ValueList.List,
01810                         AllocateSize
01811                         );
01812     } <span class="keywordflow">else</span> {
01813         NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive, <span class="keyword">sizeof</span>(HCELL_INDEX), StorageType);
01814     }
01815 
01816     <span class="comment">//</span>
01817     <span class="comment">// put ourselves on the list</span>
01818     <span class="comment">//</span>
01819     <span class="keywordflow">if</span> (NewCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01820         Parent-&gt;ValueList.List = NewCell;
01821         pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, NewCell);
01822 
01823         pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[count-1] = ValueCell;
01824         Parent-&gt;ValueList.Count = count;
01825         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> = Type;
01826 
01827         <span class="keywordflow">return</span> STATUS_SUCCESS;
01828 
01829     } <span class="keywordflow">else</span> {
01830         <span class="comment">// out of space, free all allocated stuff</span>
01831         <span class="keywordflow">if</span> (DataCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01832             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, DataCell);
01833         }
01834         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, ValueCell);
01835         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01836     }
01837 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmapi.c::CmQueryKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmQueryKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">647</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00699">CmpConstructName()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">CmpQueryKeyData()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00555">_KEY_INFORMATION::KeyNameInformation</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a87">PKEY_INFORMATION</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00785">EhQueryKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>.
<p>
<pre class="fragment"><div>00656                    :
00657 
00658     Data about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of a key, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> numbers and sizes of its
00659     children and value entries may be queried with <a class="code" href="../../d8/d9/cmapi_8c.html#a15">CmQueryKey</a>.
00660 
00661     NOTE: The returned lengths are guaranteed to be at least as
00662           long as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> described values, but may be longer in
00663           some circumstances.
00664 
00665 Arguments:
00666 
00667     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00668 
00669     KeyInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information
00670         returned in <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following types:
00671 
00672         KeyBasicInformation - return last write time, title index, and name.
00673             (See KEY_BASIC_INFORMATION)
00674 
00675         KeyNodeInformation - return last write time, title index, name, class.
00676             (See KEY_NODE_INFORMATION)
00677 
00678         KeyFullInformation - return all data except for name and security.
00679             (See KEY_FULL_INFORMATION)
00680 
00681     KeyInformation -Supplies pointer to buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00682 
00683     Length - Length of KeyInformation in bytes.
00684 
00685     ResultLength - Number of bytes actually written into KeyInformation.
00686 
00687 Return Value:
00688 
00689     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00690 
00691         &lt;TBS&gt;
00692 
00693 --*/
00694 {
00695     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00696 
00697     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmQueryKey\n"));
00698 
00699 
00700 
00701     CmpLockRegistry();
00702 
00703     <span class="comment">// Mark the hive as read only</span>
00704     CmpMarkAllBinsReadOnly(KeyControlBlock-&gt;KeyHive);
00705 
00706     try {
00707 
00708         <span class="comment">//</span>
00709         <span class="comment">// request for the FULL path of the key</span>
00710         <span class="comment">//</span>
00711         <span class="keywordflow">if</span>( KeyInformationClass == KeyNameInformation ) {
00712             <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete ) {
00713                 <span class="comment">//</span>
00714                 <span class="comment">// special case: return key deleted status, but still fill the full name of the key.</span>
00715                 <span class="comment">//</span>
00716                 status = STATUS_KEY_DELETED;
00717             } <span class="keywordflow">else</span> {
00718                 status = STATUS_SUCCESS;
00719             }
00720             
00721             <span class="keywordflow">if</span>( KeyControlBlock-&gt;NameBlock ) {
00722 
00723                 PUNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00724                 <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(KeyControlBlock);
00725                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00726                     status = STATUS_INSUFFICIENT_RESOURCES;
00727                 } <span class="keywordflow">else</span> {
00728                     ULONG       requiredlength;
00729                     ULONG       minimumlength;
00730                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      NameLength;
00731                     LONG        leftlength;
00732                     <a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a> pbuffer = (<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a>)KeyInformation;
00733 
00734                     NameLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00735 
00736                     requiredlength = FIELD_OFFSET(KEY_NAME_INFORMATION, Name) + NameLength;
00737                     
00738                     minimumlength = FIELD_OFFSET(KEY_NAME_INFORMATION, Name);
00739 
00740                     *ResultLength = requiredlength;
00741                     <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00742 
00743                         status = STATUS_BUFFER_TOO_SMALL;
00744 
00745                     } <span class="keywordflow">else</span> {
00746                         <span class="comment">//</span>
00747                         <span class="comment">// Fill in the length of the name</span>
00748                         <span class="comment">//</span>
00749                         pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o3">KeyNameInformation</a>.NameLength = NameLength;
00750                         
00751                         <span class="comment">//</span>
00752                         <span class="comment">// Now copy the full name into the user buffer, if enough space</span>
00753                         <span class="comment">//</span>
00754                         leftlength = Length - minimumlength;
00755                         requiredlength = NameLength;
00756                         <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00757                             requiredlength = leftlength;
00758                             status = STATUS_BUFFER_OVERFLOW;
00759                         }
00760 
00761                         <span class="comment">//</span>
00762                         <span class="comment">// If not enough space, copy how much we can and return overflow</span>
00763                         <span class="comment">//</span>
00764                         RtlCopyMemory(
00765                             &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o3">KeyNameInformation</a>.Name[0]),
00766                             <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer,
00767                             requiredlength
00768                             );
00769                     }
00770 
00771                     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Name, CM_NAME_TAG | PROTECTED_POOL);
00772                 }
00773             }
00774         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(KeyControlBlock-&gt;Delete ) {
00775             <span class="comment">// </span>
00776             <span class="comment">// key already deleted</span>
00777             <span class="comment">//</span>
00778             status = STATUS_KEY_DELETED;
00779         } <span class="keywordflow">else</span> {
00780             <span class="comment">//</span>
00781             <span class="comment">// call a worker to perform data transfer</span>
00782             <span class="comment">//</span>
00783 
00784             status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a4">CmpQueryKeyData</a>(KeyControlBlock-&gt;KeyHive,
00785                                      KeyControlBlock-&gt;KeyNode,
00786                                      KeyInformationClass,
00787                                      KeyInformation,
00788                                      Length,
00789                                      ResultLength);
00790         }
00791 
00792     } finally {
00793         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00794     }
00795 
00796     <span class="comment">// Mark the hive as read only</span>
00797     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00798 
00799     <span class="keywordflow">return</span> status;
00800 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="cmapi.c::CmQueryMultipleValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmQueryMultipleValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEY_VALUE_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueEntries</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>EntryCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OPTIONAL PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00940">940</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d2/d0/hivedmp_8c-source.html#l00060">ValueBuffer</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>.
<p>
<pre class="fragment"><div>00950                    :
00951 
00952     Multiple values of any key may be queried atomically with
00953     <span class="keyword">this</span> api.
00954 
00955 Arguments:
00956 
00957     KeyControlBlock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to be queried.
00958 
00959     ValueEntries - Returns an array of KEY_VALUE_ENTRY structures, one <span class="keywordflow">for</span> each value.
00960 
00961     EntryCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ValueNames and ValueEntries arrays
00962 
00963     <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value data <span class="keywordflow">for</span> each value.
00964 
00965     BufferLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> array in bytes.
00966                    Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> array that was filled in.
00967 
00968     ResultLength - <span class="keywordflow">if</span> present, Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>
00969                     array required to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested values of <span class="keyword">this</span> key.
00970 
00971 Return Value:
00972 
00973     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00974 
00975 --*/
00976 
00977 {
00978     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00979     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00980     ULONG i;
00981     UNICODE_STRING CurrentName;
00982     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00983     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueNode;
00984     ULONG RequiredLength = 0;
00985     ULONG UsedLength = 0;
00986     ULONG DataLength;
00987     BOOLEAN BufferFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00988     BOOLEAN Small;
00989     PUCHAR Data;
00990     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00991 
00992     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00993     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmQueryMultipleValueKey\n"));
00994 
00995 
00996     CmpLockRegistry();
00997     if (KeyControlBlock-&gt;Delete) {
00998         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00999         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
01000     }
01001     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
01002     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01003 
01004     <span class="comment">// Mark the hive as read only</span>
01005     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
01006 
01007     PreviousMode = KeGetPreviousMode();
01008     <span class="keywordflow">try</span> {
01009         <span class="keywordflow">for</span> (i=0; i &lt; EntryCount; i++) {
01010             <span class="comment">//</span>
01011             <span class="comment">// find the data</span>
01012             <span class="comment">//</span>
01013             <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
01014                 CurrentName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(ValueEntries[i].ValueName);
01015                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(CurrentName.Buffer,CurrentName.Length,<span class="keyword">sizeof</span>(WCHAR));
01016             } <span class="keywordflow">else</span> {
01017                 CurrentName = *(ValueEntries[i].ValueName);
01018             }
01019             ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
01020                                            KeyControlBlock-&gt;KeyNode,
01021                                            &amp;CurrentName);
01022             <span class="keywordflow">if</span> (ValueCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01023 
01024                 ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueCell);
01025                 Small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(DataLength, ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
01026 
01027                 <span class="comment">//</span>
01028                 <span class="comment">// Round up UsedLength and RequiredLength to a ULONG boundary</span>
01029                 <span class="comment">//</span>
01030                 UsedLength = (UsedLength + <span class="keyword">sizeof</span>(ULONG)-1) &amp; ~(<span class="keyword">sizeof</span>(ULONG)-1);
01031                 RequiredLength = (RequiredLength + <span class="keyword">sizeof</span>(ULONG)-1) &amp; ~(<span class="keyword">sizeof</span>(ULONG)-1);
01032 
01033                 <span class="comment">//</span>
01034                 <span class="comment">// If there is enough room for this data value in the buffer,</span>
01035                 <span class="comment">// fill it in now. Otherwise, mark the buffer as full. We must</span>
01036                 <span class="comment">// keep iterating through the values in order to determine the</span>
01037                 <span class="comment">// RequiredLength.</span>
01038                 <span class="comment">//</span>
01039                 <span class="keywordflow">if</span> ((UsedLength + DataLength &lt;= *BufferLength) &amp;&amp;
01040                     (!BufferFull)) {
01041                     <span class="keywordflow">if</span> (DataLength &gt; 0) {
01042                         <span class="keywordflow">if</span> (Small) {
01043                             Data = (PUCHAR)&amp;ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
01044                         } <span class="keywordflow">else</span> {
01045                             Data = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
01046                         }
01047                         RtlCopyMemory((PUCHAR)ValueBuffer + UsedLength,
01048                                       Data,
01049                                       DataLength);
01050                     }
01051                     ValueEntries[i].Type = ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
01052                     ValueEntries[i].DataLength = DataLength;
01053                     ValueEntries[i].DataOffset = UsedLength;
01054                     UsedLength += DataLength;
01055                 } <span class="keywordflow">else</span> {
01056                     BufferFull = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01057                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01058                 }
01059                 RequiredLength += DataLength;
01060 
01061             } <span class="keywordflow">else</span> {
01062                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01063                 <span class="keywordflow">break</span>;
01064             }
01065         }
01066 
01067         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ||
01068             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW)) {
01069             *BufferLength = UsedLength;
01070             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ResultLength)) {
01071                 *ResultLength = RequiredLength;
01072             }
01073         }
01074 
01075     } finally {
01076         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01077     }
01078 
01079     <span class="comment">// Mark the hive as read only</span>
01080     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(Hive);
01081 
01082     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01083 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="cmapi.c::CmQueryValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmQueryValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KEY_VALUE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">804</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00256">CM_KCB_SYM_LINK_FOUND</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00609">CMP_GET_CACHED_ADDRESS</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00309">CmpFindValueByNameFromCache()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00144">CmpMakeValueCacheReadOnly</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00145">CmpMakeValueCacheReadWrite</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00871">EhQueryValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>.
<p>
<pre class="fragment"><div>00814                    :
00815 
00816     The <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, TitleIndex, Type, and Data <span class="keywordflow">for</span> any one of a key's
00817     value entries may be queried with <a class="code" href="../../d8/d9/cmapi_8c.html#a16">CmQueryValueKey</a>.
00818 
00819     If KeyValueInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00820     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00821     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00822 
00823 Arguments:
00824 
00825     KeyControlBlock - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00826 
00827     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>  - The name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry to <span class="keywordflow">return</span> data <span class="keywordflow">for</span>.
00828 
00829     KeyValueInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information
00830         returned in KeyValueInformation.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following types:
00831 
00832         KeyValueBasicInformation - <span class="keywordflow">return</span> time of last write, title
00833             index, and name.  (See KEY_VALUE_BASIC_INFORMATION)
00834 
00835         KeyValueFullInformation - <span class="keywordflow">return</span> time of last write, title
00836             index, name, <span class="keyword">class</span>.  (See KEY_VALUE_FULL_INFORMATION)
00837 
00838     KeyValueInformation -Supplies pointer to buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00839 
00840     Length - Length of KeyValueInformation in bytes.
00841 
00842     ResultLength - Number of bytes actually written into KeyValueInformation.
00843 
00844 Return Value:
00845 
00846     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00847 
00848         &lt;TBS&gt;
00849 
00850 --*/
00851 {
00852     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00853     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> childcell;
00854     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>  childindex;
00855     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00856     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueData;
00857     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00858     BOOLEAN     ValueCached;
00859     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList;
00860 
00861     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00862     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmQueryValueKey\n"));
00863 
00864 
00865     CmpLockRegistry();
00866 
00867     if (KeyControlBlock-&gt;Delete) {
00868         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00869         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00870     }
00871 
00872     <span class="comment">// Mark the hive as read only</span>
00873     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00874 
00875     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00876 
00877     <span class="keywordflow">if</span> (KeyControlBlock-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
00878         <span class="comment">//</span>
00879         <span class="comment">// The value list is now set to the KCB for symbolic link,</span>
00880         <span class="comment">// Clean it up and set the value right before we do the query.</span>
00881         <span class="comment">//</span>
00882         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock-&gt;ValueCache.RealKcb);
00883         KeyControlBlock-&gt;ExtFlags &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
00884 
00885         KeyControlBlock-&gt;ValueCache.Count = KeyControlBlock-&gt;KeyNode-&gt;ValueList.Count;
00886         KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) KeyControlBlock-&gt;KeyNode-&gt;ValueList.List;
00887     }
00888 
00889 
00890     <span class="keywordflow">try</span> {
00891         <span class="comment">//</span>
00892         <span class="comment">// Find the data</span>
00893         <span class="comment">//</span>
00894 
00895         ValueData = <a class="code" href="../../d4/d3/cmtree_8c.html#a3">CmpFindValueByNameFromCache</a>(KeyControlBlock-&gt;KeyHive,
00896                                                 &amp;(KeyControlBlock-&gt;ValueCache),
00897                                                 &amp;ValueName,
00898                                                 &amp;ContainingList,
00899                                                 &amp;Index,
00900                                                 &amp;ValueCached
00901                                                 );
00902         <span class="keywordflow">if</span> (ValueData) {
00903 
00904             <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00905             <a class="code" href="../../d1/d2/cmp_8h.html#a10">CmpMakeValueCacheReadWrite</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00906 
00907             <span class="comment">//</span>
00908             <span class="comment">// call a worker to perform data transfer</span>
00909             <span class="comment">//</span>
00910 
00911             status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a5">CmpQueryKeyValueData</a>(KeyControlBlock-&gt;KeyHive,
00912                                           ContainingList,
00913                                           ValueData,
00914                                           ValueCached,
00915                                           KeyValueInformationClass,
00916                                           KeyValueInformation,
00917                                           Length,
00918                                           ResultLength);
00919 
00920             <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00921             <a class="code" href="../../d1/d2/cmp_8h.html#a9">CmpMakeValueCacheReadOnly</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00922 
00923         } <span class="keywordflow">else</span> {
00924             status = STATUS_OBJECT_NAME_NOT_FOUND;
00925         }
00926 
00927     } finally {
00928         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00929         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00930     }
00931 
00932     <span class="comment">// Mark the hive as read only</span>
00933     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00934 
00935     <span class="keywordflow">return</span> status;
00936 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="cmapi.c::CmReplaceKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmReplaceKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NewHiveName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>OldFileName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">2293</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00748">_REGISTRY_COMMAND::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00422">CM_WRAP_LIMIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00745">_REGISTRY_COMMAND::CmHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00037">CmpGlobalQuotaAllowed</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00038">CmpGlobalQuotaWarning</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00744">_REGISTRY_COMMAND::FileAttributes</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00205">HIVE_HAS_BEEN_REPLACED</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00652">_CMHIVE::HiveList</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00754">_REGISTRY_COMMAND::ImpersonationContext</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00753">_REGISTRY_COMMAND::NameInfoLength</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00751">_REGISTRY_COMMAND::NewName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00752">_REGISTRY_COMMAND::OldName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00723">REG_CMD_HIVE_CLOSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00722">REG_CMD_HIVE_OPEN</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00725">REG_CMD_RENAME_HIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00750">_REGISTRY_COMMAND::RegistryLockAquired</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00743">_REGISTRY_COMMAND::Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>.
<p>
<pre class="fragment"><div>02302                    :
02303 
02304     Renames <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> a running system and replaces <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> with a <span class="keyword">new</span>
02305     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The <span class="keyword">new</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not actually used until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next boot.
02306 
02307 Arguments:
02308 
02309     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to be replaced.
02310 
02311     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to be
02312            replaced.
02313 
02314     NewHiveName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be installed
02315             as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> hive.
02316 
02317     OldFileName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> existing hive
02318             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be renamed to.
02319 
02320 Return Value:
02321 
02322     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02323 
02324 --*/
02325 
02326 {
02327     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
02328     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ObjectInfoBuffer[512];
02329     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02330     OBJECT_ATTRIBUTES Attributes;
02331     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
02332     POBJECT_NAME_INFORMATION NameInfo;
02333     ULONG OldQuotaAllowed;
02334     ULONG OldQuotaWarning;
02335 
02336     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02337 
02338     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a11">HIVE_HAS_BEEN_REPLACED</a>) {
02339         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02340         <span class="keywordflow">return</span> STATUS_FILE_RENAMED;
02341     }
02342 
02343     <span class="comment">//</span>
02344     <span class="comment">// temporarily disable registry quota as we will be giving this memory back immediately!</span>
02345     <span class="comment">//</span>
02346     OldQuotaAllowed = <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a>;
02347     OldQuotaWarning = <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a>;
02348     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
02349     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
02350 
02351     <span class="comment">//</span>
02352     <span class="comment">// First open the new hive file and check to make sure it is valid.</span>
02353     <span class="comment">//</span>
02354     InitializeObjectAttributes(&amp;Attributes,
02355                                NewHiveName,
02356                                OBJ_CASE_INSENSITIVE,
02357                                NULL,
02358                                NULL);
02359 
02360     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o12">RegistryLockAquired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02361     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a104">REG_CMD_HIVE_OPEN</a>;
02362     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o6">FileAttributes</a> = &amp;Attributes;
02363     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02364     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o16">ImpersonationContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02365     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02366     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
02367     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02368         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02369     }
02370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a> == FALSE);
02371 
02372     NewHive = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>;
02373 
02374     <span class="comment">//</span>
02375     <span class="comment">// The new hive exists, and is consistent, and we have it open.</span>
02376     <span class="comment">// Now rename the current hive file.</span>
02377     <span class="comment">//</span>
02378     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>;
02379     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a> = OldFileName;
02380     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> = (POBJECT_NAME_INFORMATION)ObjectInfoBuffer;
02381     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a> = <span class="keyword">sizeof</span>(ObjectInfoBuffer);
02382     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
02383     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02384     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
02385     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02386             <span class="comment">//</span>
02387         <span class="comment">// rename failed, close the files associated with the new hive</span>
02388         <span class="comment">//</span>
02389         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02390         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02391         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02392         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02393     }
02394 
02395     <span class="comment">//</span>
02396     <span class="comment">// The existing hive was successfully renamed, so try to rename the</span>
02397     <span class="comment">// new file to what the old hive file was named.  (which was returned</span>
02398     <span class="comment">// into ObjectInfoBuffer by the worker thread)</span>
02399     <span class="comment">//</span>
02400     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> |= <a class="code" href="../../d6/d0/hive_8h.html#a11">HIVE_HAS_BEEN_REPLACED</a>;
02401     NameInfo = (POBJECT_NAME_INFORMATION)ObjectInfoBuffer;
02402     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>;
02403     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a> = &amp;NameInfo-&gt;Name;
02404     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02405     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a> = 0;
02406     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02407     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02408     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
02409     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02410 
02411         <span class="comment">//</span>
02412         <span class="comment">// Close the handles to the new hive</span>
02413         <span class="comment">//</span>
02414         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02415         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02416         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02417 
02418         <span class="comment">//</span>
02419         <span class="comment">// We are in trouble now.  We have renamed the existing hive file,</span>
02420         <span class="comment">// but we couldn't rename the new hive file!  Try to rename the</span>
02421         <span class="comment">// existing hive file back to where it was.</span>
02422         <span class="comment">//</span>
02423         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>;
02424         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a> = &amp;NameInfo-&gt;Name;
02425         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02426         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a> = 0;
02427         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
02428         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02429         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>)) {
02430             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_SAVRES) {
02431                 KdPrint((<span class="stringliteral">"CmReplaceKey: renamed existing hive file, but couldn't\n"</span>));
02432                 KdPrint((<span class="stringliteral">"              rename new hive file (%08lx) "</span>,Status));
02433                 KdPrint((<span class="stringliteral">" or replace old hive file (%08lx)!\n"</span>,Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>));
02434             }
02435 
02436             <span class="comment">//</span>
02437             <span class="comment">// WARNNOTE:</span>
02438             <span class="comment">//      To get into this state, the user must have relevent</span>
02439             <span class="comment">//      privileges, deliberately screw with system in an attempt</span>
02440             <span class="comment">//      to defeat it, AND get it done in a narrow timing window.</span>
02441             <span class="comment">//</span>
02442             <span class="comment">//      Further, if it's a user profile, the system will</span>
02443             <span class="comment">//      still come up.</span>
02444             <span class="comment">//</span>
02445             <span class="comment">//      Therefore, return an error code and go on.</span>
02446             <span class="comment">//</span>
02447 
02448             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
02449 
02450         }
02451     }
02452 
02453     <span class="comment">//</span>
02454     <span class="comment">// All of the renaming is done.  However, we are holding an in-memory</span>
02455     <span class="comment">// image of the new hive.  Release it, since it will not actually</span>
02456     <span class="comment">// be used until next boot.</span>
02457     <span class="comment">//</span>
02458     <span class="comment">// Do not close the open file handles to the new hive, we need to</span>
02459     <span class="comment">// keep it locked exclusively until the system is rebooted to prevent</span>
02460     <span class="comment">// people from mucking with it.</span>
02461     <span class="comment">//</span>
02462     RemoveEntryList(&amp;(NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>));
02463 
02464     <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)NewHive);
02465 
02466     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
02467     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
02468     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(NewHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
02469 
02470 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
02471     <span class="comment">//</span>
02472     <span class="comment">// Set global quota back to what it was.</span>
02473     <span class="comment">//</span>
02474     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = OldQuotaAllowed;
02475     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = OldQuotaWarning;
02476 
02477     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02478     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02479 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="cmapi.c::CmSetLastWriteTimeKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmSetLastWriteTimeKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>LastWriteTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01841">1841</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>.
<p>
<pre class="fragment"><div>01847                    :
01848 
01849     The LastWriteTime associated with a key node can be set with
01850     <a class="code" href="../../d8/d9/cmapi_8c.html#a19">CmSetLastWriteTimeKey</a>
01851 
01852 Arguments:
01853 
01854     KeyControlBlock - pointer to <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key to operate on
01855 
01856     LastWriteTime - <span class="keyword">new</span> time <span class="keywordflow">for</span> key
01857 
01858 Return Value:
01859 
01860     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
01861 
01862         &lt;TBS&gt;
01863 
01864 --*/
01865 {
01866     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> parent;
01867     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01868     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01869     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
01870 
01871     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmSetLastWriteTimeKey\n"));
01872 
01873     CmpLockRegistryExclusive();
01874 
01875     <span class="comment">//</span>
01876     <span class="comment">// Check that we are not being asked to modify a key</span>
01877     <span class="comment">// that has been deleted</span>
01878     <span class="comment">//</span>
01879     if (KeyControlBlock-&gt;Delete == TRUE) {
01880         status = STATUS_KEY_DELETED;
01881         <span class="keywordflow">goto</span> Exit;
01882     }
01883 
01884     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
01885     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
01886     parent = KeyControlBlock-&gt;KeyNode;
01887     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
01888         status = STATUS_NO_LOG_SPACE;
01889         <span class="keywordflow">goto</span> Exit;
01890     }
01891 
01892     parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = *LastWriteTime;
01893 
01894 Exit:
01895     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01896     <span class="keywordflow">return</span> status;
01897 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="cmapi.c::CmSetValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmSetValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Data</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">1087</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00489">CM_KEY_VALUE_SMALL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00487">CM_KEY_VALUE_SPECIAL_SIZE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00243">CML_API</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00033">CmpFindNameInList()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00172">CmpMarkAllBinsReadOnly</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00267">CMS_EXCEPTION</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00035">CmSymbolicLinkValueName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00439">KEY_SYM_LINK</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00515">EhSetValueKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>.
<p>
<pre class="fragment"><div>01096                    :
01097 
01098     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value entry may be created or replaced with <a class="code" href="../../d8/d9/cmapi_8c.html#a18">CmSetValueKey</a>.
01099 
01100     If a value entry with a Value <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> (i.e. name) matching the
01101     one specified by ValueName exists, it is deleted and replaced
01102     with the one specified.  If no such value entry exists, a new
01103     one is created.  NULL is a legal Value ID.  While Value IDs must
01104     be unique within any given key, the same Value ID may appear
01105     in many different keys.
01106 
01107 Arguments:
01108 
01109     KeyControlBlock - pointer to kcb for the key to operate on
01110 
01111     ValueName - The unique (relative to the containing key) name
01112         of the value entry.  May be NULL.
01113 
01114     Type - The integer type number of the value entry.
01115 
01116     Data - Pointer to buffer with actual data for the value entry.
01117 
01118     DataSize - Size of Data buffer.
01119 
01120 
01121 Return Value:
01122 
01123     NTSTATUS - Result code from call, among the following:
01124 
01125         &lt;TBS&gt;
01126 
01127 --*/
01128 {
01129     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
01130     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> parent;
01131     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> oldchild;
01132     ULONG       count;
01133     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01134     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01135     ULONG       StorageType;
01136     ULONG       TempData;
01137     BOOLEAN     found;
01138     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pdata;
01139     LARGE_INTEGER systemtime;
01140     ULONG compareSize,mustChange=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01141 
01142     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmSetValueKey\n"));
01143 
01144     CmpLockRegistry();
01145     ASSERT(sizeof(ULONG) == CM_KEY_VALUE_SMALL);
01146 
01147     <span class="comment">// Mark the hive as read only</span>
01148     CmpMarkAllBinsReadOnly(KeyControlBlock-&gt;KeyHive);
01149 
01150     while (TRUE) {
01151         <span class="comment">//</span>
01152         <span class="comment">// Check that we are not being asked to add a value to a key</span>
01153         <span class="comment">// that has been deleted</span>
01154         <span class="comment">//</span>
01155         <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01156             status = STATUS_KEY_DELETED;
01157             <span class="keywordflow">goto</span> Exit;
01158         }
01159 
01160         <span class="comment">//</span>
01161         <span class="comment">// Check to see if this is a symbolic link node.  If so caller</span>
01162         <span class="comment">// is only allowed to create/change the SymbolicLinkValue</span>
01163         <span class="comment">// value name</span>
01164         <span class="comment">//</span>
01165 
01166         <span class="keywordflow">if</span> (KeyControlBlock-&gt;KeyNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a> &amp;&amp;
01167             (Type != REG_LINK ||
01168              <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01169              !<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;CmSymbolicLinkValueName, ValueName, TRUE)))
01170         {
01171             <span class="comment">//</span>
01172             <span class="comment">// Disallow attempts to manipulate any value names under a symbolic link</span>
01173             <span class="comment">// except for the "SymbolicLinkValue" value name or type other than REG_LINK</span>
01174             <span class="comment">//</span>
01175 
01176             <span class="comment">// Mark the hive as read only</span>
01177             <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
01178 
01179             status = STATUS_ACCESS_DENIED;
01180             <span class="keywordflow">goto</span> Exit;
01181         }
01182 
01183         <span class="comment">//</span>
01184         <span class="comment">// get reference to parent key,</span>
01185         <span class="comment">//</span>
01186         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
01187         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
01188         parent = KeyControlBlock-&gt;KeyNode;
01189 
01190         <span class="comment">//</span>
01191         <span class="comment">// try to find an existing value entry by the same name</span>
01192         <span class="comment">//</span>
01193         count = parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01194         found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01195 
01196         <span class="keywordflow">if</span> (count &gt; 0) {
01197             oldchild = <a class="code" href="../../d4/d3/cmtree_8c.html#a0">CmpFindNameInList</a>(Hive,
01198                                          &amp;parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>,
01199                                          ValueName,
01200                                          &amp;pdata,
01201                                          NULL);
01202 
01203             <span class="keywordflow">if</span> (oldchild != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01204                 found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01205             }
01206         }
01207         <span class="comment">//</span>
01208         <span class="comment">// Performance Hack:</span>
01209         <span class="comment">// If a Set is asking us to set a key to the current value (IE does this a lot)</span>
01210         <span class="comment">// drop it (and, therefore, the last modified time) on the floor, but return success</span>
01211         <span class="comment">// this stops the page from being dirtied, and us having to flush the registry.</span>
01212         <span class="comment">//</span>
01213         <span class="comment">//</span>
01214         <span class="keywordflow">if</span> (mustChange == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01215             <span class="keywordflow">break</span>; <span class="comment">//while</span>
01216         }
01217         <span class="keywordflow">if</span> ((found) &amp;&amp;
01218             (Type == pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>)) {
01219 
01220             <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pcmpdata;
01221 
01222             <span class="keywordflow">if</span> (DataSize == (pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> &amp; ~<a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>)) {
01223 
01224                 <span class="keywordflow">if</span> (DataSize &gt; 0) {
01225                     <span class="comment">//</span>
01226                     <span class="comment">//check for small values</span>
01227                     <span class="comment">//</span>
01228                     <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a> ) {
01229                         pcmpdata = (<a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>)&amp;pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
01230                     } <span class="keywordflow">else</span> {
01231                         pcmpdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
01232                     }
01233 
01234                     <span class="keywordflow">try</span> {
01235                         compareSize = (ULONG)RtlCompareMemory ((PVOID)pcmpdata,Data,(DataSize &amp; ~CM_KEY_VALUE_SPECIAL_SIZE));
01236                     } except (EXCEPTION_EXECUTE_HANDLER) {
01237                         
01238                         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01239                             KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01240                         }
01241                         status = GetExceptionCode();
01242                         <span class="keywordflow">goto</span> Exit;
01243                     }
01244                 }<span class="keywordflow">else</span> {
01245                     compareSize = 0;
01246                 }
01247 
01248                 <span class="keywordflow">if</span> (compareSize == DataSize) {
01249                     status = STATUS_SUCCESS;
01250                     <span class="keywordflow">goto</span> Exit;
01251                 }
01252             }
01253 
01254         }
01255 
01256         <span class="comment">//</span>
01257         <span class="comment">// To Get here, we must either be changing a value, or setting a new one</span>
01258         <span class="comment">//</span>
01259         mustChange=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01260         <span class="comment">//</span>
01261         <span class="comment">// We're going through these gyrations so that if someone does come in and try and delete the</span>
01262         <span class="comment">// key we're setting we're safe. Once we know we have to change the key, take the</span>
01263         <span class="comment">// Exclusive (write) lock then restart</span>
01264         <span class="comment">//</span>
01265         <span class="comment">//</span>
01266         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01267         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01268 
01269     }<span class="comment">// while</span>
01270 
01271     <span class="comment">// It's a different or new value, mark it dirty, since we'll</span>
01272     <span class="comment">// at least set its time stamp</span>
01273 
01274     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
01275         status = STATUS_NO_LOG_SPACE;
01276         <span class="keywordflow">goto</span> Exit;
01277     }
01278 
01279     StorageType = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
01280 
01281     <span class="comment">//</span>
01282     <span class="comment">// stash small data if relevent</span>
01283     <span class="comment">//</span>
01284     TempData = 0;
01285     <span class="keywordflow">if</span> ((DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) &amp;&amp;
01286         (DataSize &gt; 0))
01287     {
01288         <span class="keywordflow">try</span> {
01289             RtlMoveMemory(          <span class="comment">// yes, move memory, could be 1 byte</span>
01290                 &amp;TempData,          <span class="comment">// at the end of a page.</span>
01291                 Data,
01292                 DataSize
01293                 );
01294          } except (EXCEPTION_EXECUTE_HANDLER) {
01295             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_API, CMS_EXCEPTION) {
01296                 KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01297             }
01298             status = GetExceptionCode();
01299             <span class="keywordflow">goto</span> Exit;
01300         }
01301     }
01302 
01303     <span class="keywordflow">if</span> (found) {
01304 
01305         <span class="comment">//</span>
01306         <span class="comment">// ----- Existing Value Entry Path -----</span>
01307         <span class="comment">//</span>
01308 
01309         <span class="comment">//</span>
01310         <span class="comment">// An existing value entry of the specified name exists,</span>
01311         <span class="comment">// set our data into it.</span>
01312         <span class="comment">//</span>
01313         status = <a class="code" href="../../d8/d9/cmapi_8c.html#a9">CmpSetValueKeyExisting</a>(Hive,
01314                                         oldchild,
01315                                         pdata,
01316                                         Type,
01317                                         Data,
01318                                         DataSize,
01319                                         StorageType,
01320                                         TempData);
01321 
01322     } <span class="keywordflow">else</span> {
01323 
01324         <span class="comment">//</span>
01325         <span class="comment">// ----- New Value Entry Path -----</span>
01326         <span class="comment">//</span>
01327 
01328         <span class="comment">//</span>
01329         <span class="comment">// Either there are no existing value entries, or the one</span>
01330         <span class="comment">// specified is not in the list.  In either case, create and</span>
01331         <span class="comment">// fill a new one, and add it to the list</span>
01332         <span class="comment">//</span>
01333         status = <a class="code" href="../../d8/d9/cmapi_8c.html#a10">CmpSetValueKeyNew</a>(Hive,
01334                                    parent,
01335                                    ValueName,
01336                                    Type,
01337                                    Data,
01338                                    DataSize,
01339                                    StorageType,
01340                                    TempData);
01341     }
01342 
01343     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01344 
01345         <span class="keywordflow">if</span> (parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> &lt; <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length) {
01346             parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length;
01347         }
01348 
01349         <span class="keywordflow">if</span> (parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> &lt; DataSize) {
01350             parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = DataSize;
01351         }
01352 
01353         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
01354         parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
01355 
01356         <span class="comment">//</span>
01357         <span class="comment">// Update the cache, no need for KCB lock as the registry is locked exclusively.</span>
01358         <span class="comment">//</span>
01359         <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01360 
01361         <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(KeyControlBlock);
01362 
01363         KeyControlBlock-&gt;ValueCache.Count = parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01364         KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>;
01365 
01366         <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyControlBlock,
01367                         KeyControlBlock-&gt;KeyHive,
01368                         KeyControlBlock-&gt;KeyCell,
01369                         REG_NOTIFY_CHANGE_LAST_SET);
01370     }
01371 
01372 Exit:
01373     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01374   
01375     <span class="comment">// Mark the hive as read only</span>
01376     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
01377 
01378     <span class="keywordflow">return</span> status;
01379 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="cmapi.c::CmUnloadKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmUnloadKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Kcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">2079</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00740">_REGISTRY_COMMAND::Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00745">_REGISTRY_COMMAND::CmHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00245">CML_WORKER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00667">CmpDestroyHive()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00262">CMS_CM</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00739">_REGISTRY_COMMAND::Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00653">_CMHIVE::HiveLock</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00720">REG_CMD_FLUSH_KEY</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00723">REG_CMD_HIVE_CLOSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00727">REG_CMD_REMOVE_HIVE_LIST</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, and <a class="el" href="../../d9/d0/cmdata_8h.html#a105a100">SearchIfExist</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>02087                    :
02088 
02089     Unlinks a hive from its location in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry, closes its <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
02090     handles, and deallocates all its memory.
02091 
02092     There must be no key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> blocks currently referencing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
02093     to be unloaded.
02094 
02095 Arguments:
02096 
02097     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02098            hive to be unloaded
02099 
02100     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
02101 
02102     Kcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block
02103 
02104 Return Value:
02105 
02106     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02107 
02108 --*/
02109 
02110 {
02111     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
02112     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
02113     BOOLEAN Success;
02114 
02115     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_WORKER, CMS_CM) KdPrint(("CmUnloadKey\n"));
02116 
02117     CmpLockRegistryExclusive();
02118 
02119     <span class="comment">//</span>
02120     <span class="comment">// Make sure the cell passed in is the root cell of the hive.</span>
02121     <span class="comment">//</span>
02122     if (Cell != Hive-&gt;BaseBlock-&gt;RootCell) {
02123         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02124         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
02125     }
02126 
02127     <span class="comment">//</span>
02128     <span class="comment">// Make sure there are no open references to key control blocks</span>
02129     <span class="comment">// for this hive.  If there are none, then we can unload the hive.</span>
02130     <span class="comment">//</span>
02131 
02132     CmHive = CONTAINING_RECORD(Hive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive);
02133     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a>(Kcb,SearchIfExist) != 0) || (Kcb-&gt;RefCount != 1)) {
02134 <span class="preprocessor">#if DBG</span>
02135 <span class="preprocessor"></span>        KdPrint((<span class="stringliteral">"List of keys open against hive unload was attempted on:\n"</span>));
02136         <a class="code" href="../../d8/d2/cmsubs_8c.html#a21">CmpSearchKeyControlBlockTree</a>(
02137             CmpUnloadKeyWorker,
02138             Hive,
02139             NULL
02140             );
02141 <span class="preprocessor">#endif</span>
02142 <span class="preprocessor"></span>        <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02143         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
02144     }
02145 
02146     <span class="comment">//</span>
02147     <span class="comment">// Flush any dirty data to disk. If this fails, too bad.</span>
02148     <span class="comment">//</span>
02149     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a102">REG_CMD_FLUSH_KEY</a>;
02150     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
02151     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o2">Cell</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
02152     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02153 
02154     <span class="comment">//</span>
02155     <span class="comment">// Remove the hive from the HiveFileList</span>
02156     <span class="comment">//</span>
02157     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a109">REG_CMD_REMOVE_HIVE_LIST</a>;
02158     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
02159     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02160 
02161     <span class="comment">//</span>
02162     <span class="comment">// Unlink from master hive, remove from list</span>
02163     <span class="comment">//</span>
02164     Success = <a class="code" href="../../d1/d2/cmp_8h.html#a276">CmpDestroyHive</a>(Hive, Cell);
02165 
02166     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02167 
02168     <span class="keywordflow">if</span> (Success) {
02169         <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>(Hive);
02170 
02171         <span class="comment">//</span>
02172         <span class="comment">// Close the hive files</span>
02173         <span class="comment">//</span>
02174         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02175         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CmHive;
02176         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02177 
02178         <span class="comment">//</span>
02179         <span class="comment">// free the cm level structure</span>
02180         <span class="comment">//</span>
02181         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
02182         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
02183         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(CmHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
02184 
02185         <span class="keywordflow">return</span>(STATUS_SUCCESS);
02186     } <span class="keywordflow">else</span> {
02187         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
02188     }
02189 
02190 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a7" doxytag="cmapi.c::CmpGlobalQuotaAllowed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d2/cmsavres_8c.html#a4">CmpGlobalQuotaAllowed</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00037">37</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00204">CmpClaimGlobalQuota()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00354">CmpSetGlobalQuotaAllowed()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, and <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00121">CmSetRegistryQuotaInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmapi.c::CmpGlobalQuotaWarning" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d2/cmsavres_8c.html#a5">CmpGlobalQuotaWarning</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00038">38</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00204">CmpClaimGlobalQuota()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00293">CmpComputeGlobalQuotaAllowed()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>, and <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00121">CmSetRegistryQuotaInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmapi.c::CmpHiveListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d4/edithive_8c.html#a2">CmpHiveListHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00027">27</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="cmapi.c::CmpNoWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d3/cmwraper_8c.html#a4">CmpNoWrite</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">25</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00564">CmFlushKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02195">CmpDoFlushAll()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00368">CmpLazyFlush()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmapi.c::CmpProfileLoaded" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d3/cmworker_8c.html#a12">CmpProfileLoaded</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00029">29</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00556">CmpDiskFullWarning()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmapi.c::CmpStashBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUCHAR <a class="el" href="../../d1/d3/cmsysini_8c.html#a26">CmpStashBuffer</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00032">32</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmapi.c::CmpStashBufferSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d1/d3/cmsysini_8c.html#a27">CmpStashBufferSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00033">33</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmapi.c::CmpWasSetupBoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d3/cmworker_8c.html#a10">CmpWasSetupBoot</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00030">30</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01901">CmLoadKey()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmapi.c::CmSymbolicLinkValueName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d6/d2/hwprofil_8c.html#a0">CmSymbolicLinkValueName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00035">35</a> of file <a class="el" href="../../d9/d8/cmapi_8c-source.html">cmapi.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d1/d0/cmdatini_8c-source.html#l00089">CmpInitializeRegistryNames()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
