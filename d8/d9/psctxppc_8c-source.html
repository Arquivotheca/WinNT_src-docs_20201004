<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psctxppc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psctxppc.c</h1><a href="../../d7/d0/psctxppc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    psctxmip.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements function to get and set the context of a thread.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    David N. Cutler (davec) 1-Oct-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Tom Wood (twood) 19-Aug-1994</span>
00020 <span class="comment">    Update to use RtlVirtualUnwind even when there isn't a function table</span>
00021 <span class="comment">    entry.  Add stack limit parameters to RtlVirtualUnwind.</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/psp_8h.html">psp.h</a>"</span>
00026 <span class="preprocessor">#pragma hdrstop</span>
<a name="l00027"></a><a class="code" href="../../d7/d0/psctxppc_8c.html#a0">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define         STK_MIN_FRAME   56</span>
<a name="l00028"></a><a class="code" href="../../d7/d0/psctxppc_8c.html#a1">00028</a> <span class="preprocessor"></span><span class="keyword">extern</span>  ULONG   <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a7">KiBreakPoints</a>;
00029 
00030 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00031"></a><a class="code" href="../../d7/d0/psctxppc_8c.html#a2">00031</a> <a class="code" href="../../d8/d1/psp_8h.html#a73">PspGetContext</a> (
00032     IN PKTRAP_FRAME TrapFrame,
00033     IN PKNONVOLATILE_CONTEXT_POINTERS ContextPointers,
00034     IN OUT PCONTEXT ContextRecord
00035     )
00036 
00037 <span class="comment">/*++</span>
00038 <span class="comment"></span>
00039 <span class="comment">Routine Description:</span>
00040 <span class="comment"></span>
00041 <span class="comment">    This function selectively moves the contents of the specified trap frame</span>
00042 <span class="comment">    and nonvolatile context to the specified context record.</span>
00043 <span class="comment"></span>
00044 <span class="comment">Arguments:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00047 <span class="comment"></span>
00048 <span class="comment">    ContextPointers - Supplies the address of context pointers record.</span>
00049 <span class="comment"></span>
00050 <span class="comment">    ContextRecord - Supplies the address of a context record.</span>
00051 <span class="comment"></span>
00052 <span class="comment">Return Value:</span>
00053 <span class="comment"></span>
00054 <span class="comment">    None.</span>
00055 <span class="comment"></span>
00056 <span class="comment">--*/</span>
00057 
00058 {
00059 
00060     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00061 
00062         <span class="comment">//</span>
00063         <span class="comment">// Get machine state, instr address, link, count registers</span>
00064         <span class="comment">//</span>
00065 
00066         ContextRecord-&gt;Msr = TrapFrame-&gt;Msr;
00067         ContextRecord-&gt;Iar = TrapFrame-&gt;Iar;
00068         ContextRecord-&gt;Lr  = TrapFrame-&gt;Lr;
00069         ContextRecord-&gt;Ctr = TrapFrame-&gt;Ctr;
00070     }
00071 
00072     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00073 
00074         <span class="comment">//</span>
00075         <span class="comment">// Get volatile integer regs in trap frame are 0..12</span>
00076         <span class="comment">//</span>
00077 
00078         RtlMoveMemory (&amp;ContextRecord-&gt;Gpr0, &amp;TrapFrame-&gt;Gpr0,
00079                        sizeof (ULONG) * 13);
00080 
00081         <span class="comment">//</span>
00082         <span class="comment">// Get non-volatile integer regs in exception frame are 13..31</span>
00083         <span class="comment">//</span>
00084 
00085         ContextRecord-&gt;Gpr13 = *ContextPointers-&gt;IntegerContext[13];
00086         ContextRecord-&gt;Gpr14 = *ContextPointers-&gt;IntegerContext[14];
00087         ContextRecord-&gt;Gpr15 = *ContextPointers-&gt;IntegerContext[15];
00088         ContextRecord-&gt;Gpr16 = *ContextPointers-&gt;IntegerContext[16];
00089         ContextRecord-&gt;Gpr17 = *ContextPointers-&gt;IntegerContext[17];
00090         ContextRecord-&gt;Gpr18 = *ContextPointers-&gt;IntegerContext[18];
00091         ContextRecord-&gt;Gpr19 = *ContextPointers-&gt;IntegerContext[19];
00092         ContextRecord-&gt;Gpr20 = *ContextPointers-&gt;IntegerContext[20];
00093         ContextRecord-&gt;Gpr21 = *ContextPointers-&gt;IntegerContext[21];
00094         ContextRecord-&gt;Gpr22 = *ContextPointers-&gt;IntegerContext[22];
00095         ContextRecord-&gt;Gpr23 = *ContextPointers-&gt;IntegerContext[23];
00096         ContextRecord-&gt;Gpr24 = *ContextPointers-&gt;IntegerContext[24];
00097         ContextRecord-&gt;Gpr25 = *ContextPointers-&gt;IntegerContext[25];
00098         ContextRecord-&gt;Gpr26 = *ContextPointers-&gt;IntegerContext[26];
00099         ContextRecord-&gt;Gpr27 = *ContextPointers-&gt;IntegerContext[27];
00100         ContextRecord-&gt;Gpr28 = *ContextPointers-&gt;IntegerContext[28];
00101         ContextRecord-&gt;Gpr29 = *ContextPointers-&gt;IntegerContext[29];
00102         ContextRecord-&gt;Gpr30 = *ContextPointers-&gt;IntegerContext[30];
00103         ContextRecord-&gt;Gpr31 = *ContextPointers-&gt;IntegerContext[31];
00104 
00105         <span class="comment">//</span>
00106         <span class="comment">// The CR is made up of volatile and non-volatile fields,</span>
00107         <span class="comment">// but the entire CR is saved in the trap frame</span>
00108         <span class="comment">//</span>
00109 
00110         ContextRecord-&gt;Cr = TrapFrame-&gt;Cr;
00111 
00112         <span class="comment">//</span>
00113         <span class="comment">// Fixed Point Exception Register (XER) is part of the</span>
00114         <span class="comment">// integer state</span>
00115         <span class="comment">//</span>
00116 
00117         ContextRecord-&gt;Xer = TrapFrame-&gt;Xer;
00118     }
00119 
00120     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) ==
00121          <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00122 
00123         <span class="comment">//</span>
00124         <span class="comment">// Get volatile floating point regs in trap frame are 0..13</span>
00125         <span class="comment">//</span>
00126 
00127         RtlMoveMemory(&amp;ContextRecord-&gt;Fpr0, &amp;TrapFrame-&gt;Fpr0,
00128                      <span class="keyword">sizeof</span>(DOUBLE) * (14));
00129 
00130         <span class="comment">//</span>
00131         <span class="comment">// Get non-volatile floating point regs 14..31</span>
00132         <span class="comment">//</span>
00133 
00134         ContextRecord-&gt;Fpr14 = *ContextPointers-&gt;FloatingContext[14];
00135         ContextRecord-&gt;Fpr15 = *ContextPointers-&gt;FloatingContext[15];
00136         ContextRecord-&gt;Fpr16 = *ContextPointers-&gt;FloatingContext[16];
00137         ContextRecord-&gt;Fpr17 = *ContextPointers-&gt;FloatingContext[17];
00138         ContextRecord-&gt;Fpr18 = *ContextPointers-&gt;FloatingContext[18];
00139         ContextRecord-&gt;Fpr19 = *ContextPointers-&gt;FloatingContext[19];
00140         ContextRecord-&gt;Fpr20 = *ContextPointers-&gt;FloatingContext[20];
00141         ContextRecord-&gt;Fpr21 = *ContextPointers-&gt;FloatingContext[21];
00142         ContextRecord-&gt;Fpr22 = *ContextPointers-&gt;FloatingContext[22];
00143         ContextRecord-&gt;Fpr23 = *ContextPointers-&gt;FloatingContext[23];
00144         ContextRecord-&gt;Fpr24 = *ContextPointers-&gt;FloatingContext[24];
00145         ContextRecord-&gt;Fpr25 = *ContextPointers-&gt;FloatingContext[25];
00146         ContextRecord-&gt;Fpr26 = *ContextPointers-&gt;FloatingContext[26];
00147         ContextRecord-&gt;Fpr27 = *ContextPointers-&gt;FloatingContext[27];
00148         ContextRecord-&gt;Fpr28 = *ContextPointers-&gt;FloatingContext[28];
00149         ContextRecord-&gt;Fpr29 = *ContextPointers-&gt;FloatingContext[29];
00150         ContextRecord-&gt;Fpr30 = *ContextPointers-&gt;FloatingContext[30];
00151         ContextRecord-&gt;Fpr31 = *ContextPointers-&gt;FloatingContext[31];
00152 
00153         <span class="comment">//</span>
00154         <span class="comment">// Get floating point status and control register.</span>
00155         <span class="comment">//</span>
00156 
00157         ContextRecord-&gt;Fpscr = TrapFrame-&gt;Fpscr;
00158     }
00159 
00160     <span class="comment">//</span>
00161     <span class="comment">// Fetch Dr register contents if requested.  Values may be trash.</span>
00162     <span class="comment">//</span>
00163 
00164     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; CONTEXT_DEBUG_REGISTERS) ==
00165         CONTEXT_DEBUG_REGISTERS) {
00166 
00167 
00168         ContextRecord-&gt;Dr0 = TrapFrame-&gt;Dr0;
00169         ContextRecord-&gt;Dr1 = TrapFrame-&gt;Dr1;
00170         ContextRecord-&gt;Dr2 = TrapFrame-&gt;Dr2;
00171         ContextRecord-&gt;Dr3 = TrapFrame-&gt;Dr3;
00172         ContextRecord-&gt;Dr6 = TrapFrame-&gt;Dr6;
00173         ContextRecord-&gt;Dr5 = 0;           <span class="comment">// Zero initialize unused regs</span>
00174         ContextRecord-&gt;Dr4 = 0;
00175 
00176         <span class="comment">//</span>
00177         <span class="comment">// If it's a user mode frame, and the thread doesn't have DRs set,</span>
00178         <span class="comment">// and we just return the trash in the frame, we risk accidentally</span>
00179         <span class="comment">// making the thread active with trash values on a set.  Therefore,</span>
00180         <span class="comment">// Dr7 must be set to the number of available data address breakpoint</span>
00181         <span class="comment">// registers if we get a non-active user mode frame.</span>
00182         <span class="comment">//</span>
00183         <span class="keywordflow">if</span> (((TrapFrame-&gt;PreviousMode) != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00184             (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;DebugActive)) {
00185 
00186             ContextRecord-&gt;Dr7 = TrapFrame-&gt;Dr7;
00187             ContextRecord-&gt;Dr6 |= <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a7">KiBreakPoints</a>;
00188         } <span class="keywordflow">else</span> {
00189 
00190             ContextRecord-&gt;Dr7 = 0;
00191             ContextRecord-&gt;Dr6 = <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a7">KiBreakPoints</a>;
00192         }
00193     }
00194 
00195     <span class="keywordflow">return</span>;
00196 }
00197 
00198 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00199"></a><a class="code" href="../../d7/d0/psctxppc_8c.html#a3">00199</a> <a class="code" href="../../d8/d1/psp_8h.html#a72">PspSetContext</a> (
00200     IN OUT PKTRAP_FRAME TrapFrame,
00201     IN PKNONVOLATILE_CONTEXT_POINTERS ContextPointers,
00202     IN PCONTEXT ContextRecord,
00203     IN KPROCESSOR_MODE ProcessorMode
00204     )
00205 
00206 <span class="comment">/*++</span>
00207 <span class="comment"></span>
00208 <span class="comment">Routine Description:</span>
00209 <span class="comment"></span>
00210 <span class="comment">    This function selectively moves the contents of the specified context</span>
00211 <span class="comment">    record to the specified trap frame and nonvolatile context.</span>
00212 <span class="comment"></span>
00213 <span class="comment">Arguments:</span>
00214 <span class="comment"></span>
00215 <span class="comment">    TrapFrame - Supplies the address of a trap frame.</span>
00216 <span class="comment"></span>
00217 <span class="comment">    ContextPointers - Supplies the address of a context pointers record.</span>
00218 <span class="comment"></span>
00219 <span class="comment">    ContextRecord - Supplies the address of a context record.</span>
00220 <span class="comment"></span>
00221 <span class="comment">    ProcessorMode - Supplies the processor mode to use when sanitizing</span>
00222 <span class="comment">        the PSR and FSR.</span>
00223 <span class="comment"></span>
00224 <span class="comment">Return Value:</span>
00225 <span class="comment"></span>
00226 <span class="comment">    None.</span>
00227 <span class="comment"></span>
00228 <span class="comment">--*/</span>
00229 
00230 {
00231 
00232     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00233 
00234         <span class="comment">//</span>
00235         <span class="comment">// Set instruction address, link, count, and machine state registers</span>
00236         <span class="comment">//</span>
00237 
00238         TrapFrame-&gt;Lr  = ContextRecord-&gt;Lr;
00239         TrapFrame-&gt;Ctr = ContextRecord-&gt;Ctr;
00240         TrapFrame-&gt;Msr = SANITIZE_MSR(ContextRecord-&gt;Msr, ProcessorMode);
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">// If this is a remote call dereference the function descritor in</span>
00244         <span class="comment">// the remote threads context.</span>
00245         <span class="comment">//</span>
00246         <span class="keywordflow">if</span> (((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) ==
00247               <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) &amp;&amp;
00248             (ContextRecord-&gt;Gpr2 == 0)) {
00249            <span class="keywordflow">try</span> {
00250 
00251                <span class="comment">//</span>
00252                <span class="comment">// Make sure we have read access to the function descriptor.</span>
00253                <span class="comment">//</span>
00254                <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ContextRecord-&gt;Iar,
00255                             (<span class="keyword">sizeof</span>(ULONG) * 2), <span class="keyword">sizeof</span>(ULONG));
00256                TrapFrame-&gt;Iar = *((PULONG)(ContextRecord-&gt;Iar))++;
00257                ContextRecord-&gt;Gpr2 = *(PULONG)(ContextRecord-&gt;Iar);
00258 
00259            } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00260 
00261                <span class="comment">//</span>
00262                <span class="comment">// Remote thread doesn't have access to the function</span>
00263                <span class="comment">// descriptor. Just set the IAR and let the thread take</span>
00264                <span class="comment">// the exception.</span>
00265                <span class="comment">//</span>
00266                TrapFrame-&gt;Iar = ContextRecord-&gt;Iar;
00267                <span class="keywordflow">return</span>;
00268            }
00269         } <span class="keywordflow">else</span> {
00270            TrapFrame-&gt;Iar = ContextRecord-&gt;Iar;
00271         }
00272     }
00273 
00274     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00275 
00276         <span class="comment">//</span>
00277         <span class="comment">// Volatile integer regs are 0..12</span>
00278         <span class="comment">//</span>
00279 
00280         RtlMoveMemory(&amp;TrapFrame-&gt;Gpr0, &amp;ContextRecord-&gt;Gpr0,
00281                      <span class="keyword">sizeof</span>(ULONG) * (13));
00282 
00283         <span class="comment">//</span>
00284         <span class="comment">// Non-volatile integer regs are 13..31</span>
00285         <span class="comment">//</span>
00286 
00287         *ContextPointers-&gt;IntegerContext[13] = ContextRecord-&gt;Gpr13;
00288         *ContextPointers-&gt;IntegerContext[14] = ContextRecord-&gt;Gpr14;
00289         *ContextPointers-&gt;IntegerContext[15] = ContextRecord-&gt;Gpr15;
00290         *ContextPointers-&gt;IntegerContext[16] = ContextRecord-&gt;Gpr16;
00291         *ContextPointers-&gt;IntegerContext[17] = ContextRecord-&gt;Gpr17;
00292         *ContextPointers-&gt;IntegerContext[18] = ContextRecord-&gt;Gpr18;
00293         *ContextPointers-&gt;IntegerContext[19] = ContextRecord-&gt;Gpr19;
00294         *ContextPointers-&gt;IntegerContext[20] = ContextRecord-&gt;Gpr20;
00295         *ContextPointers-&gt;IntegerContext[21] = ContextRecord-&gt;Gpr21;
00296         *ContextPointers-&gt;IntegerContext[22] = ContextRecord-&gt;Gpr22;
00297         *ContextPointers-&gt;IntegerContext[23] = ContextRecord-&gt;Gpr23;
00298         *ContextPointers-&gt;IntegerContext[24] = ContextRecord-&gt;Gpr24;
00299         *ContextPointers-&gt;IntegerContext[25] = ContextRecord-&gt;Gpr25;
00300         *ContextPointers-&gt;IntegerContext[26] = ContextRecord-&gt;Gpr26;
00301         *ContextPointers-&gt;IntegerContext[27] = ContextRecord-&gt;Gpr27;
00302         *ContextPointers-&gt;IntegerContext[28] = ContextRecord-&gt;Gpr28;
00303         *ContextPointers-&gt;IntegerContext[29] = ContextRecord-&gt;Gpr29;
00304         *ContextPointers-&gt;IntegerContext[30] = ContextRecord-&gt;Gpr30;
00305         *ContextPointers-&gt;IntegerContext[31] = ContextRecord-&gt;Gpr31;
00306 
00307         <span class="comment">//</span>
00308         <span class="comment">// Copy the Condition Reg and Fixed Point Exception Reg</span>
00309         <span class="comment">//</span>
00310 
00311         TrapFrame-&gt;Cr = ContextRecord-&gt;Cr;
00312         TrapFrame-&gt;Xer = ContextRecord-&gt;Xer;
00313     }
00314 
00315     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) ==
00316          <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">// Volatile floating point regs are 0..13</span>
00320         <span class="comment">//</span>
00321 
00322         RtlMoveMemory(&amp;TrapFrame-&gt;Fpr0, &amp;ContextRecord-&gt;Fpr0,
00323                      <span class="keyword">sizeof</span>(DOUBLE) * (14));
00324 
00325         <span class="comment">//</span>
00326         <span class="comment">// Non-volatile floating point regs are 14..31</span>
00327         <span class="comment">//</span>
00328 
00329         *ContextPointers-&gt;FloatingContext[14] = ContextRecord-&gt;Fpr14;
00330         *ContextPointers-&gt;FloatingContext[15] = ContextRecord-&gt;Fpr15;
00331         *ContextPointers-&gt;FloatingContext[16] = ContextRecord-&gt;Fpr16;
00332         *ContextPointers-&gt;FloatingContext[17] = ContextRecord-&gt;Fpr17;
00333         *ContextPointers-&gt;FloatingContext[18] = ContextRecord-&gt;Fpr18;
00334         *ContextPointers-&gt;FloatingContext[19] = ContextRecord-&gt;Fpr19;
00335         *ContextPointers-&gt;FloatingContext[20] = ContextRecord-&gt;Fpr20;
00336         *ContextPointers-&gt;FloatingContext[21] = ContextRecord-&gt;Fpr21;
00337         *ContextPointers-&gt;FloatingContext[22] = ContextRecord-&gt;Fpr22;
00338         *ContextPointers-&gt;FloatingContext[23] = ContextRecord-&gt;Fpr23;
00339         *ContextPointers-&gt;FloatingContext[24] = ContextRecord-&gt;Fpr24;
00340         *ContextPointers-&gt;FloatingContext[25] = ContextRecord-&gt;Fpr25;
00341         *ContextPointers-&gt;FloatingContext[26] = ContextRecord-&gt;Fpr26;
00342         *ContextPointers-&gt;FloatingContext[27] = ContextRecord-&gt;Fpr27;
00343         *ContextPointers-&gt;FloatingContext[28] = ContextRecord-&gt;Fpr28;
00344         *ContextPointers-&gt;FloatingContext[29] = ContextRecord-&gt;Fpr29;
00345         *ContextPointers-&gt;FloatingContext[30] = ContextRecord-&gt;Fpr30;
00346         *ContextPointers-&gt;FloatingContext[31] = ContextRecord-&gt;Fpr31;
00347 
00348         <span class="comment">//</span>
00349         <span class="comment">// Set floating point status and control register.</span>
00350         <span class="comment">//</span>
00351 
00352         TrapFrame-&gt;Fpscr = SANITIZE_FPSCR(ContextRecord-&gt;Fpscr, ProcessorMode);
00353     }
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// Set debug register state if specified.  If previous mode is user</span>
00357     <span class="comment">// mode (i.e. it's a user frame we're setting) and if effect will be to</span>
00358     <span class="comment">// cause at least one of the debug register enable bits in Dr7</span>
00359     <span class="comment">// to be set then set DebugActive to the enable bit mask.</span>
00360     <span class="comment">//</span>
00361 
00362     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; CONTEXT_DEBUG_REGISTERS) ==
00363          CONTEXT_DEBUG_REGISTERS) {
00364 
00365         <span class="comment">//</span>
00366         <span class="comment">// Set the debug control register for the 601 and 604</span>
00367         <span class="comment">// indicating the number of address breakpoints supported.</span>
00368         <span class="comment">//</span>
00369         TrapFrame-&gt;Dr0 = SANITIZE_DRADDR(ContextRecord-&gt;Dr0, ProcessorMode);
00370         TrapFrame-&gt;Dr1 = SANITIZE_DRADDR(ContextRecord-&gt;Dr1, ProcessorMode);
00371         TrapFrame-&gt;Dr2 = SANITIZE_DRADDR(ContextRecord-&gt;Dr2, ProcessorMode);
00372         TrapFrame-&gt;Dr3 = SANITIZE_DRADDR(ContextRecord-&gt;Dr3, ProcessorMode);
00373         TrapFrame-&gt;Dr6 = SANITIZE_DR6(ContextRecord-&gt;Dr6, ProcessorMode);
00374         TrapFrame-&gt;Dr7 = SANITIZE_DR7(ContextRecord-&gt;Dr7, ProcessorMode);
00375 
00376         <span class="keywordflow">if</span> (ProcessorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00377               <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;DebugActive = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;DebugActive =
00378                                         (UCHAR)(TrapFrame-&gt;Dr7 &amp; DR7_ACTIVE);
00379         }
00380     }
00381 
00382     <span class="keywordflow">return</span>;
00383 }
00384 
00385 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00386"></a><a class="code" href="../../d7/d0/psctxppc_8c.html#a4">00386</a> <a class="code" href="../../d7/d0/psctxppc_8c.html#a4">PspGetSetContextApc</a> (
00387     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00388     IN PKNORMAL_ROUTINE *NormalRoutine,
00389     IN PVOID *NormalContext,
00390     IN PVOID *SystemArgument1,
00391     IN PVOID *SystemArgument2
00392     )
00393 
00394 <span class="comment">/*++</span>
00395 <span class="comment"></span>
00396 <span class="comment">Routine Description:</span>
00397 <span class="comment"></span>
00398 <span class="comment">    This function either captures the user mode state of the current</span>
00399 <span class="comment">    thread, or sets the user mode state of the current thread. The</span>
00400 <span class="comment">    operation type is determined by the value of SystemArgument1. A</span>
00401 <span class="comment">    zero value is used for get context, and a nonzero value is used</span>
00402 <span class="comment">    for set context.</span>
00403 <span class="comment"></span>
00404 <span class="comment">Arguments:</span>
00405 <span class="comment"></span>
00406 <span class="comment">    Apc - Supplies a pointer to the APC control object that caused entry</span>
00407 <span class="comment">          into this routine.</span>
00408 <span class="comment"></span>
00409 <span class="comment">    NormalRoutine - Supplies a pointer to the normal routine function that</span>
00410 <span class="comment">        was specified when the APC was initialized. This parameter is not</span>
00411 <span class="comment">        used.</span>
00412 <span class="comment"></span>
00413 <span class="comment">    NormalContext - Supplies a pointer to an arbitrary data structure that</span>
00414 <span class="comment">        was specified when the APC was initialized. This parameter is not</span>
00415 <span class="comment">        used.</span>
00416 <span class="comment"></span>
00417 <span class="comment">    SystemArgument1, SystemArgument2 - Supplies a set of two pointer to two</span>
00418 <span class="comment">        arguments that contain untyped data. These parameters are not used.</span>
00419 <span class="comment"></span>
00420 <span class="comment">Return Value:</span>
00421 <span class="comment"></span>
00422 <span class="comment">    None.</span>
00423 <span class="comment"></span>
00424 <span class="comment">--*/</span>
00425 
00426 {
00427 
00428     <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">PGETSETCONTEXT</a> ContextBlock;
00429     KNONVOLATILE_CONTEXT_POINTERS ContextPointers;
00430     CONTEXT ContextRecord;
00431     ULONG ControlPc;
00432     ULONG EstablisherFrame;
00433     PRUNTIME_FUNCTION FunctionEntry;
00434     BOOLEAN InFunction;
00435     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00436     ULONG TrapFrame1;
00437     ULONG TrapFrame2;
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">// Get the address of the context block and compute the address of the</span>
00441     <span class="comment">// system entry trap frame.</span>
00442     <span class="comment">//</span>
00443 
00444     ContextBlock = CONTAINING_RECORD(Apc, <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a>, Apc);
00445     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00446     TrapFrame1 = (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> - (KTRAP_FRAME_LENGTH +
00447                  <span class="keyword">sizeof</span>(KEXCEPTION_FRAME) + (2 * <span class="keyword">sizeof</span>(ULONG)));
00448     TrapFrame2 = (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> - (KTRAP_FRAME_LENGTH +
00449                  <span class="keyword">sizeof</span>(KEXCEPTION_FRAME) + <a class="code" href="../../d7/d0/psctxppc_8c.html#a0">STK_MIN_FRAME</a> +
00450                  (10 * <span class="keyword">sizeof</span>(ULONG)));
00451 
00452     <span class="comment">//</span>
00453     <span class="comment">// Capture the current thread context and set the initial control PC</span>
00454     <span class="comment">// value.</span>
00455     <span class="comment">//</span>
00456 
00457     RtlCaptureContext(&amp;ContextRecord);
00458     ControlPc = ContextRecord.Lr;
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// Initialize context pointers for the nonvolatile integer and floating</span>
00462     <span class="comment">// registers.</span>
00463     <span class="comment">//</span>
00464 
00465     ContextPointers.IntegerContext[13] = &amp;ContextRecord.Gpr13;
00466     ContextPointers.IntegerContext[14] = &amp;ContextRecord.Gpr14;
00467     ContextPointers.IntegerContext[15] = &amp;ContextRecord.Gpr15;
00468     ContextPointers.IntegerContext[16] = &amp;ContextRecord.Gpr16;
00469     ContextPointers.IntegerContext[17] = &amp;ContextRecord.Gpr17;
00470     ContextPointers.IntegerContext[18] = &amp;ContextRecord.Gpr18;
00471     ContextPointers.IntegerContext[19] = &amp;ContextRecord.Gpr19;
00472     ContextPointers.IntegerContext[20] = &amp;ContextRecord.Gpr20;
00473     ContextPointers.IntegerContext[21] = &amp;ContextRecord.Gpr21;
00474     ContextPointers.IntegerContext[22] = &amp;ContextRecord.Gpr22;
00475     ContextPointers.IntegerContext[23] = &amp;ContextRecord.Gpr23;
00476     ContextPointers.IntegerContext[24] = &amp;ContextRecord.Gpr24;
00477     ContextPointers.IntegerContext[25] = &amp;ContextRecord.Gpr25;
00478     ContextPointers.IntegerContext[26] = &amp;ContextRecord.Gpr26;
00479     ContextPointers.IntegerContext[27] = &amp;ContextRecord.Gpr27;
00480     ContextPointers.IntegerContext[28] = &amp;ContextRecord.Gpr28;
00481     ContextPointers.IntegerContext[29] = &amp;ContextRecord.Gpr29;
00482     ContextPointers.IntegerContext[30] = &amp;ContextRecord.Gpr30;
00483     ContextPointers.IntegerContext[31] = &amp;ContextRecord.Gpr31;
00484 
00485     ContextPointers.FloatingContext[14] = &amp;ContextRecord.Fpr14;
00486     ContextPointers.FloatingContext[15] = &amp;ContextRecord.Fpr15;
00487     ContextPointers.FloatingContext[16] = &amp;ContextRecord.Fpr16;
00488     ContextPointers.FloatingContext[17] = &amp;ContextRecord.Fpr17;
00489     ContextPointers.FloatingContext[18] = &amp;ContextRecord.Fpr18;
00490     ContextPointers.FloatingContext[19] = &amp;ContextRecord.Fpr19;
00491     ContextPointers.FloatingContext[20] = &amp;ContextRecord.Fpr20;
00492     ContextPointers.FloatingContext[21] = &amp;ContextRecord.Fpr21;
00493     ContextPointers.FloatingContext[22] = &amp;ContextRecord.Fpr22;
00494     ContextPointers.FloatingContext[23] = &amp;ContextRecord.Fpr23;
00495     ContextPointers.FloatingContext[24] = &amp;ContextRecord.Fpr24;
00496     ContextPointers.FloatingContext[25] = &amp;ContextRecord.Fpr25;
00497     ContextPointers.FloatingContext[26] = &amp;ContextRecord.Fpr26;
00498     ContextPointers.FloatingContext[27] = &amp;ContextRecord.Fpr27;
00499     ContextPointers.FloatingContext[28] = &amp;ContextRecord.Fpr28;
00500     ContextPointers.FloatingContext[29] = &amp;ContextRecord.Fpr29;
00501     ContextPointers.FloatingContext[30] = &amp;ContextRecord.Fpr30;
00502     ContextPointers.FloatingContext[31] = &amp;ContextRecord.Fpr31;
00503 
00504     <span class="comment">//</span>
00505     <span class="comment">// Start with the frame specified by the context record and virtually</span>
00506     <span class="comment">// unwind call frames until the system entry trap frame is encountered.</span>
00507     <span class="comment">//</span>
00508 
00509     <span class="keywordflow">do</span> {
00510 
00511         <span class="comment">//</span>
00512         <span class="comment">// Lookup the function table entry using the point at which control</span>
00513         <span class="comment">// left the procedure.</span>
00514         <span class="comment">//</span>
00515 
00516         FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc);
00517 
00518         <span class="comment">//</span>
00519         <span class="comment">// Virtually unwind to the caller of the current routine to</span>
00520         <span class="comment">// obtain the address where control left the caller.</span>
00521         <span class="comment">//</span>
00522 
00523         ControlPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc,
00524                                      FunctionEntry,
00525                                      &amp;ContextRecord,
00526                                      &amp;InFunction,
00527                                      &amp;EstablisherFrame,
00528                                      &amp;ContextPointers,
00529                                      (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o3">StackLimit</a>,
00530                                      (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a>);
00531 
00532     } <span class="keywordflow">while</span> ((ContextRecord.Gpr1 &gt;= (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o3">StackLimit</a>) &amp;&amp;
00533              (ContextRecord.Gpr1 &lt; (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a>));
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// If system argument one is nonzero, then set the context of the current</span>
00537     <span class="comment">// thread. Otherwise, get the context of the current thread.</span>
00538     <span class="comment">//</span>
00539 
00540     <span class="keywordflow">if</span> (Apc-&gt;SystemArgument1 != 0) {
00541 
00542         <span class="comment">//</span>
00543         <span class="comment">// Set context of current thread.</span>
00544         <span class="comment">//</span>
00545 
00546         <a class="code" href="../../d8/d1/psp_8h.html#a72">PspSetContext</a>((PKTRAP_FRAME)TrapFrame1,
00547                       &amp;ContextPointers,
00548                       &amp;ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>,
00549                       ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o1">Mode</a>);
00550 
00551     } <span class="keywordflow">else</span> {
00552 
00553         <span class="comment">//</span>
00554         <span class="comment">// Get context of current thread.</span>
00555         <span class="comment">//</span>
00556 
00557         <a class="code" href="../../d8/d1/psp_8h.html#a73">PspGetContext</a>((PKTRAP_FRAME)TrapFrame1,
00558                       &amp;ContextPointers,
00559                       &amp;ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>);
00560     }
00561 
00562     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00563     <span class="keywordflow">return</span>;
00564 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
