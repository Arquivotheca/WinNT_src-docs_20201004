<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: errorlog.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>errorlog.c</h1><a href="../../d7/d7/errorlog_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    errorlog.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code for the I/O error log thread.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Darryl E. Havens (darrylh) May 3, 1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode, system process thread</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00027 <span class="preprocessor">#include "elfkrnl.h"</span>
00028 
<a name="l00029"></a><a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html">00029</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html">_IOP_ERROR_LOG_CONTEXT</a> {
<a name="l00030"></a><a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html#o0">00030</a>     <a class="code" href="../../d1/d6/struct__KDPC.html">KDPC</a> <a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html#o0">ErrorLogDpc</a>;
<a name="l00031"></a><a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html#o1">00031</a>     <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a> <a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html#o1">ErrorLogTimer</a>;
00032 }<a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html">IOP_ERROR_LOG_CONTEXT</a>, *<a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html">PIOP_ERROR_LOG_CONTEXT</a>;
00033 
00034 <span class="comment">//</span>
00035 <span class="comment">// Declare routines local to this module.</span>
00036 <span class="comment">//</span>
00037 
00038 BOOLEAN
00039 <a class="code" href="../../d7/d7/errorlog_8c.html#a8">IopErrorLogConnectPort</a>(
00040     VOID
00041     );
00042 
00043 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00044 <a class="code" href="../../d7/d7/errorlog_8c.html#a9">IopErrorLogDpc</a>(
00045     IN <span class="keyword">struct</span> <a class="code" href="../../d1/d6/struct__KDPC.html">_KDPC</a> *Dpc,
00046     IN PVOID DeferredContext,
00047     IN PVOID SystemArgument1,
00048     IN PVOID SystemArgument2
00049     );
00050 
00051 PLIST_ENTRY
00052 <a class="code" href="../../d7/d7/errorlog_8c.html#a10">IopErrorLogGetEntry</a>(
00053     );
00054 
00055 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00056 <a class="code" href="../../d7/d7/errorlog_8c.html#a11">IopErrorLogQueueRequest</a>(
00057     VOID
00058     );
00059 
00060 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00061 <a class="code" href="../../d7/d7/errorlog_8c.html#a12">IopErrorLogRequeueEntry</a>(
00062     IN PLIST_ENTRY ListEntry
00063     );
00064 
00065 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopErrorLogThread)</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopErrorLogConnectPort)</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopErrorLogQueueRequest)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00070 <span class="preprocessor"></span>
00071 <span class="comment">//</span>
00072 <span class="comment">// Define a global varibles used by the error logging code.</span>
00073 <span class="comment">//</span>
00074 
<a name="l00075"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a3">00075</a> <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="code" href="../../d7/d7/errorlog_8c.html#a3">IopErrorLogWorkItem</a>;
<a name="l00076"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a4">00076</a> HANDLE <a class="code" href="../../d7/d7/errorlog_8c.html#a4">ErrorLogPort</a>;
<a name="l00077"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a5">00077</a> BOOLEAN <a class="code" href="../../d7/d7/errorlog_8c.html#a5">ErrorLogPortConnected</a>;
<a name="l00078"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a6">00078</a> BOOLEAN <a class="code" href="../../d7/d7/errorlog_8c.html#a6">IopErrorLogPortPending</a>;
<a name="l00079"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a7">00079</a> BOOLEAN <a class="code" href="../../d7/d7/errorlog_8c.html#a7">IopErrorLogDisabledThisBoot</a>;
00080 
00081 <span class="comment">//</span>
00082 <span class="comment">// Define the amount of space required for the device and driver names.</span>
00083 <span class="comment">//</span>
00084 
<a name="l00085"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a0">00085</a> <span class="preprocessor">#define IO_ERROR_NAME_LENGTH 100</span>
00086 <span class="preprocessor"></span>
00087 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00088"></a><a class="code" href="../../d0/d6/iop_8h.html#a171">00088</a> <a class="code" href="../../d0/d6/iop_8h.html#a171">IopErrorLogThread</a>(
00089     IN PVOID StartContext
00090     )
00091 
00092 <span class="comment">/*++</span>
00093 <span class="comment"></span>
00094 <span class="comment">Routine Description:</span>
00095 <span class="comment"></span>
00096 <span class="comment">    This is the main loop for the I/O error log thread which executes in the</span>
00097 <span class="comment">    system process context.  This routine is started when the system is</span>
00098 <span class="comment">    initialized.</span>
00099 <span class="comment"></span>
00100 <span class="comment">Arguments:</span>
00101 <span class="comment"></span>
00102 <span class="comment">    StartContext - Startup context; not used.</span>
00103 <span class="comment"></span>
00104 <span class="comment">Return Value:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    None.</span>
00107 <span class="comment"></span>
00108 <span class="comment">--*/</span>
00109 
00110 {
00111     <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">PERROR_LOG_ENTRY</a> errorLogEntry;
00112     UNICODE_STRING nameString;
00113     PLIST_ENTRY listEntry;
00114     PIO_ERROR_LOG_MESSAGE errorMessage;
00115     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00116     PELF_PORT_MSG portMessage;
00117     PCHAR objectName;
00118     ULONG messageLength;
00119     ULONG driverNameLength;
00120     ULONG deviceNameLength;
00121     ULONG objectNameLength;
00122     ULONG remainingLength;
00123     ULONG stringLength;
00124     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> nameBuffer[<a class="code" href="../../d7/d7/errorlog_8c.html#a0">IO_ERROR_NAME_LENGTH</a>+<span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION )];
00125     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
00126     POBJECT_NAME_INFORMATION nameInformation;
00127     PIO_ERROR_LOG_PACKET errorData;
00128     PWSTR string;
00129 
00130     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00131 
00132     UNREFERENCED_PARAMETER( StartContext );
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">// Check to see whether a connection has been made to the error log</span>
00136     <span class="comment">// port.  If the port is not connected return.</span>
00137     <span class="comment">//</span>
00138 
00139     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d7/errorlog_8c.html#a8">IopErrorLogConnectPort</a>()) {
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">// The port could not be connected.  A timer was started that will</span>
00143         <span class="comment">// try again later.</span>
00144         <span class="comment">//</span>
00145 
00146         <span class="keywordflow">return</span>;
00147     }
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">// Allocate and zero the port message structure, include space for the</span>
00151     <span class="comment">// name of the device and driver.</span>
00152     <span class="comment">//</span>
00153 
00154     messageLength = IO_ERROR_LOG_MESSAGE_LENGTH;
00155     portMessage = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, messageLength);
00156 
00157     <span class="keywordflow">if</span> (portMessage == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00158 
00159         <span class="comment">//</span>
00160         <span class="comment">// The message buffer could not be allocated. Request that</span>
00161         <span class="comment">// the error log thread routine be called again later.</span>
00162         <span class="comment">//</span>
00163 
00164         <a class="code" href="../../d7/d7/errorlog_8c.html#a11">IopErrorLogQueueRequest</a>();
00165         <span class="keywordflow">return</span>;
00166     }
00167 
00168     RtlZeroMemory( portMessage, <span class="keyword">sizeof</span>( *portMessage ) );
00169     portMessage-&gt;MessageType = IO_ERROR_LOG;
00170     errorMessage = &amp;portMessage-&gt;u.IoErrorLogMessage;
00171 
00172     nameInformation = (PVOID) &amp;nameBuffer;
00173 
00174     <span class="comment">//</span>
00175     <span class="comment">// Now enter the main loop for this thread.  This thread performs the</span>
00176     <span class="comment">// following operations:</span>
00177     <span class="comment">//</span>
00178     <span class="comment">//   1)  If a connection has been made to the error log port, dequeue a</span>
00179     <span class="comment">//       packet from the queue head and attempt to send it to the port.</span>
00180     <span class="comment">//</span>
00181     <span class="comment">//   2)  If the send works, loop sending packets until there are no more</span>
00182     <span class="comment">//       packets;  otherwise, indicate that the connection has been broken,</span>
00183     <span class="comment">//       cleanup, place the packet back onto the head of the queue and</span>
00184     <span class="comment">//       return.</span>
00185     <span class="comment">//</span>
00186     <span class="comment">//   3)  After all the packets are sent clear the pending variable and</span>
00187     <span class="comment">//       return.</span>
00188     <span class="comment">//</span>
00189 
00190     <span class="keywordflow">for</span> (;;) {
00191 
00192         <span class="comment">//</span>
00193         <span class="comment">// Loop dequeueing  packets from the queue head and attempt to send</span>
00194         <span class="comment">// each to the port.</span>
00195         <span class="comment">//</span>
00196         <span class="comment">// If the send works, continue looping until there are no more packets.</span>
00197         <span class="comment">// Otherwise, indicate that the connection has been broken, cleanup,</span>
00198         <span class="comment">// place the packet back onto the head of the queue, and start from the</span>
00199         <span class="comment">// top of the loop again.</span>
00200         <span class="comment">//</span>
00201 
00202         <span class="keywordflow">if</span> (!(listEntry = <a class="code" href="../../d7/d7/errorlog_8c.html#a10">IopErrorLogGetEntry</a>())) {
00203             <span class="keywordflow">break</span>;
00204         }
00205 
00206         errorLogEntry = CONTAINING_RECORD( listEntry,
00207                                            <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">ERROR_LOG_ENTRY</a>,
00208                                            ListEntry );
00209 
00210         <span class="comment">//</span>
00211         <span class="comment">// The size of errorLogEntry is ERROR_LOG_ENTRY +</span>
00212         <span class="comment">// IO_ERROR_LOG_PACKET + (Extra Dump data).  The size of the</span>
00213         <span class="comment">// initial message length should be IO_ERROR_LOG_MESSAGE +</span>
00214         <span class="comment">// (Extra Dump data), since IO_ERROR_LOG_MESSAGE contains an</span>
00215         <span class="comment">// IO_ERROR_LOG_PACKET. Using the above calculations set the</span>
00216         <span class="comment">// message length.</span>
00217         <span class="comment">//</span>
00218 
00219         messageLength = <span class="keyword">sizeof</span>( IO_ERROR_LOG_MESSAGE ) -
00220             <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">ERROR_LOG_ENTRY</a> ) - <span class="keyword">sizeof</span>( IO_ERROR_LOG_PACKET ) +
00221             errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o1">Size</a>;
00222 
00223         errorData = (PIO_ERROR_LOG_PACKET) (errorLogEntry + 1);
00224 
00225         <span class="comment">//</span>
00226         <span class="comment">// Copy the error log packet and the extra data to the message.</span>
00227         <span class="comment">//</span>
00228 
00229         RtlMoveMemory( &amp;errorMessage-&gt;EntryData,
00230                        errorData,
00231                        errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o1">Size</a> - <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html">ERROR_LOG_ENTRY</a> ) );
00232 
00233         errorMessage-&gt;TimeStamp = errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o5">TimeStamp</a>;
00234         errorMessage-&gt;Type = <a class="code" href="../../d0/d5/io_8h.html#a11">IO_TYPE_ERROR_MESSAGE</a>;
00235 
00236         <span class="comment">//</span>
00237         <span class="comment">// Add the driver and device name string.  These strings go</span>
00238         <span class="comment">// before the error log strings.  Just write over the current</span>
00239         <span class="comment">// strings and they will be recopied later.</span>
00240         <span class="comment">//</span>
00241 
00242         <span class="keywordflow">if</span> (errorData-&gt;NumberOfStrings != 0) {
00243 
00244             <span class="comment">//</span>
00245             <span class="comment">// Start the driver and device strings where the current</span>
00246             <span class="comment">// strings start.</span>
00247             <span class="comment">//</span>
00248 
00249             objectName = (PCHAR) (&amp;errorMessage-&gt;EntryData) +
00250                                  errorData-&gt;StringOffset;
00251 
00252         } <span class="keywordflow">else</span> {
00253 
00254             <span class="comment">//</span>
00255             <span class="comment">// Put the driver and device strings at the end of the</span>
00256             <span class="comment">// data.</span>
00257             <span class="comment">//</span>
00258 
00259             objectName = (PCHAR) errorMessage + messageLength;
00260 
00261         }
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">// Make sure the driver offset starts on an even bountry.</span>
00265         <span class="comment">//</span>
00266 
00267         objectName = (PCHAR) ((ULONG_PTR) (objectName + <span class="keyword">sizeof</span>(WCHAR) - 1) &amp;
00268             ~(ULONG_PTR)(<span class="keyword">sizeof</span>(WCHAR) - 1));
00269 
00270         errorMessage-&gt;DriverNameOffset = (ULONG)(objectName - (PCHAR) errorMessage);
00271 
00272         remainingLength = (ULONG)((PCHAR) portMessage + IO_ERROR_LOG_MESSAGE_LENGTH
00273                             - objectName);
00274 
00275         <span class="comment">//</span>
00276         <span class="comment">// Calculate the length of the driver name and</span>
00277         <span class="comment">// the device name. If the driver object has a name then get</span>
00278         <span class="comment">// it from there; otherwise try to query the device object.</span>
00279         <span class="comment">//</span>
00280 
00281         driverObject = errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o4">DriverObject</a>;
00282         driverNameLength = 0;
00283 
00284         <span class="keywordflow">if</span> (driverObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00285             <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00286 
00287                 nameString.Buffer = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer;
00288                 driverNameLength = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Length;
00289             }
00290 
00291             <span class="keywordflow">if</span> (driverNameLength == 0) {
00292 
00293                 <span class="comment">//</span>
00294                 <span class="comment">// Try to query the driver object for a name.</span>
00295                 <span class="comment">//</span>
00296 
00297                 status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( driverObject,
00298                                             nameInformation,
00299                                             <a class="code" href="../../d7/d7/errorlog_8c.html#a0">IO_ERROR_NAME_LENGTH</a> + <span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION ),
00300                                             &amp;objectNameLength );
00301 
00302                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) || !nameInformation-&gt;Name.Length) {
00303 
00304                     <span class="comment">//</span>
00305                     <span class="comment">// No driver name was available.</span>
00306                     <span class="comment">//</span>
00307 
00308                     driverNameLength = 0;
00309 
00310                 } <span class="keywordflow">else</span> {
00311                     nameString = nameInformation-&gt;Name;
00312                 }
00313 
00314             }
00315 
00316         } <span class="keywordflow">else</span> {
00317 
00318             <span class="comment">//</span>
00319             <span class="comment">// If no driver object, this message must be from the </span>
00320             <span class="comment">// kernel.   We need to point the eventlog service to</span>
00321             <span class="comment">// an event message file containing ntstatus messages,</span>
00322             <span class="comment">// ie, ntdll, we do this by claiming this event is an</span>
00323             <span class="comment">// application popup.</span>
00324             <span class="comment">//</span>
00325 
00326             nameString.Buffer = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Application Popup"</span>;
00327             driverNameLength = wcslen(nameString.Buffer) * <span class="keyword">sizeof</span>(WCHAR);
00328         }
00329 
00330         <span class="keywordflow">if</span> (driverNameLength != 0 ) {
00331 
00332             <span class="comment">//</span>
00333             <span class="comment">// Pick out the module name.</span>
00334             <span class="comment">//</span>
00335 
00336             string = nameString.Buffer +
00337                 (driverNameLength / <span class="keyword">sizeof</span>(WCHAR));
00338 
00339             driverNameLength = <span class="keyword">sizeof</span>(WCHAR);
00340             string--;
00341             <span class="keywordflow">while</span> (*string != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> &amp;&amp; string != nameString.Buffer) {
00342                 string--;
00343                 driverNameLength += <span class="keyword">sizeof</span>(WCHAR);
00344             }
00345 
00346             <span class="keywordflow">if</span> (*string == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
00347                 string++;
00348                 driverNameLength -= <span class="keyword">sizeof</span>(WCHAR);
00349             }
00350 
00351             <span class="comment">//</span>
00352             <span class="comment">// Ensure there is enough room for the driver name.</span>
00353             <span class="comment">// Save space for 3 NULLs one for the driver name,</span>
00354             <span class="comment">// one for the device name and one for strings.</span>
00355             <span class="comment">//</span>
00356 
00357             <span class="keywordflow">if</span> (driverNameLength &gt; remainingLength - (3 * <span class="keyword">sizeof</span>(WCHAR))) {
00358                 driverNameLength = remainingLength - (3 * <span class="keyword">sizeof</span>(WCHAR));
00359             }
00360 
00361             RtlMoveMemory(
00362                 objectName,
00363                 string,
00364                 driverNameLength
00365                 );
00366 
00367         }
00368 
00369         <span class="comment">//</span>
00370         <span class="comment">// Add a null after the driver name even if there is no</span>
00371         <span class="comment">// driver name.</span>
00372         <span class="comment">//</span>
00373 
00374        *((PWSTR) (objectName + driverNameLength)) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00375        driverNameLength += <span class="keyword">sizeof</span>(WCHAR);
00376 
00377         <span class="comment">//</span>
00378         <span class="comment">// Determine where the next string goes.</span>
00379         <span class="comment">//</span>
00380 
00381         objectName += driverNameLength;
00382         remainingLength -= driverNameLength;
00383 
00384         errorMessage-&gt;EntryData.StringOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(objectName - (PCHAR) errorMessage);
00385 
00386         <span class="keywordflow">if</span> (errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o3">DeviceObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00387 
00388             status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o3">DeviceObject</a>,
00389                                         nameInformation,
00390                                         <a class="code" href="../../d7/d7/errorlog_8c.html#a0">IO_ERROR_NAME_LENGTH</a> + <span class="keyword">sizeof</span>( OBJECT_NAME_INFORMATION ) - driverNameLength,
00391                                         &amp;objectNameLength );
00392 
00393             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) || !nameInformation-&gt;Name.Length) {
00394 
00395                 <span class="comment">//</span>
00396                 <span class="comment">// No device name was available. Add a Null string.</span>
00397                 <span class="comment">//</span>
00398 
00399                 nameInformation-&gt;Name.Length = 0;
00400                 nameInformation-&gt;Name.Buffer = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\0"</span>;
00401 
00402             }
00403 
00404             <span class="comment">//</span>
00405             <span class="comment">// No device name was available. Add a Null string.</span>
00406             <span class="comment">// Always add a device name string so that the</span>
00407             <span class="comment">// insertion string counts are correct.</span>
00408             <span class="comment">//</span>
00409 
00410         } <span class="keywordflow">else</span> {
00411 
00412                 <span class="comment">//</span>
00413                 <span class="comment">// No device name was available. Add a Null string.</span>
00414                 <span class="comment">// Always add a device name string so that the</span>
00415                 <span class="comment">// insertion string counts are correct.</span>
00416                 <span class="comment">//</span>
00417 
00418                 nameInformation-&gt;Name.Length = 0;
00419                 nameInformation-&gt;Name.Buffer = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\0"</span>;
00420 
00421         }
00422 
00423         deviceNameLength = nameInformation-&gt;Name.Length;
00424 
00425         <span class="comment">//</span>
00426         <span class="comment">// Ensure there is enough room for the device name.</span>
00427         <span class="comment">// Save space for a NULL.</span>
00428         <span class="comment">//</span>
00429 
00430         <span class="keywordflow">if</span> (deviceNameLength &gt; remainingLength - (2 * <span class="keyword">sizeof</span>(WCHAR))) {
00431 
00432             deviceNameLength = remainingLength - (2 * <span class="keyword">sizeof</span>(WCHAR));
00433 
00434         }
00435 
00436         RtlMoveMemory( objectName,
00437                        nameInformation-&gt;Name.Buffer,
00438                        deviceNameLength );
00439 
00440         <span class="comment">//</span>
00441         <span class="comment">// Add a null after the device name even if there is no</span>
00442         <span class="comment">// device name.</span>
00443         <span class="comment">//</span>
00444 
00445         *((PWSTR) (objectName + deviceNameLength)) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00446         deviceNameLength += <span class="keyword">sizeof</span>(WCHAR);
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">// Update the string count for the device object.</span>
00450         <span class="comment">//</span>
00451 
00452         errorMessage-&gt;EntryData.NumberOfStrings++;
00453         objectName += deviceNameLength;
00454         remainingLength -= deviceNameLength;
00455 
00456         <span class="keywordflow">if</span> (errorData-&gt;NumberOfStrings) {
00457 
00458             stringLength = errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o1">Size</a> - <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/iop_8h.html#a27">ERROR_LOG_ENTRY</a> ) -
00459                             errorData-&gt;StringOffset;
00460 
00461             <span class="comment">//</span>
00462             <span class="comment">// Ensure there is enough room for the strings.</span>
00463             <span class="comment">// Save space for a NULL.</span>
00464             <span class="comment">//</span>
00465 
00466             <span class="keywordflow">if</span> (stringLength &gt; remainingLength - <span class="keyword">sizeof</span>(WCHAR)) {
00467 
00468 
00469                 messageLength -= stringLength - remainingLength;
00470                 stringLength = remainingLength - <span class="keyword">sizeof</span>(WCHAR);
00471 
00472             }
00473 
00474             <span class="comment">//</span>
00475             <span class="comment">// Copy the strings to the end of the message.</span>
00476             <span class="comment">//</span>
00477 
00478             RtlMoveMemory( objectName,
00479                            (PCHAR) errorData + errorData-&gt;StringOffset,
00480                            stringLength );
00481 
00482             <span class="comment">//</span>
00483             <span class="comment">// Add a null after the strings</span>
00484             <span class="comment">//</span>
00485             <span class="comment">//</span>
00486 
00487            *((PWSTR) (objectName + stringLength)) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00488 
00489         }
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// Update the message length.</span>
00493         <span class="comment">//</span>
00494 
00495         errorMessage-&gt;DriverNameLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) driverNameLength;
00496         messageLength += deviceNameLength + driverNameLength;
00497         errorMessage-&gt;Size = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) messageLength;
00498 
00499         messageLength += FIELD_OFFSET ( ELF_PORT_MSG, u ) -
00500             FIELD_OFFSET (ELF_PORT_MSG, MessageType);
00501 
00502         portMessage-&gt;PortMessage.u1.s1.TotalLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00503             (<span class="keyword">sizeof</span>( PORT_MESSAGE ) + messageLength);
00504         portMessage-&gt;PortMessage.u1.s1.DataLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (messageLength);
00505         status = <a class="code" href="../../d6/d7/lpcsend_8c.html#a0">NtRequestPort</a>( <a class="code" href="../../d7/d7/errorlog_8c.html#a4">ErrorLogPort</a>, (PPORT_MESSAGE) portMessage );
00506 
00507         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00508 
00509             <span class="comment">//</span>
00510             <span class="comment">// The send failed.  Place the packet back onto the head of</span>
00511             <span class="comment">// the error log queue, forget the current connection since</span>
00512             <span class="comment">// it no longer works, and close the handle to the port.</span>
00513             <span class="comment">// Set a timer up for another attempt later.</span>
00514             <span class="comment">// Finally, exit the loop since there is no connection</span>
00515             <span class="comment">// to do any work on.</span>
00516             <span class="comment">//</span>
00517 
00518             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d7/d7/errorlog_8c.html#a4">ErrorLogPort</a> );
00519 
00520             <a class="code" href="../../d7/d7/errorlog_8c.html#a12">IopErrorLogRequeueEntry</a>( &amp;errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o2">ListEntry</a> );
00521 
00522             <a class="code" href="../../d7/d7/errorlog_8c.html#a11">IopErrorLogQueueRequest</a>();
00523 
00524             <span class="keywordflow">break</span>;
00525 
00526         } <span class="keywordflow">else</span> {
00527 
00528             <span class="comment">//</span>
00529             <span class="comment">// The send worked fine.  Free the packet and the update</span>
00530             <span class="comment">// the allocation count.</span>
00531             <span class="comment">//</span>
00532 
00533             <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a22">IopErrorLogAllocation</a>,
00534                                    (ULONG) ( -errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o1">Size</a> ),
00535                                    &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a7">IopErrorLogAllocationLock</a> );
00536 
00537             <span class="comment">//</span>
00538             <span class="comment">// Dereference the object pointers now that the name has been</span>
00539             <span class="comment">// captured.</span>
00540             <span class="comment">//</span>
00541 
00542 
00543             <span class="keywordflow">if</span> (errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o3">DeviceObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00544                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o3">DeviceObject</a> );
00545             }
00546 
00547             <span class="keywordflow">if</span> (driverObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00548                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( errorLogEntry-&gt;<a class="code" href="../../d8/d5/struct__ERROR__LOG__ENTRY.html#o4">DriverObject</a> );
00549             }
00550 
00551             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( errorLogEntry );
00552 
00553         } <span class="comment">// if</span>
00554 
00555     } <span class="comment">// for</span>
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">// Finally, free the message buffer and return.</span>
00559     <span class="comment">//</span>
00560 
00561     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(portMessage);
00562 
00563 }
00564 
00565 BOOLEAN
<a name="l00566"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a8">00566</a> <a class="code" href="../../d7/d7/errorlog_8c.html#a8">IopErrorLogConnectPort</a>(
00567     VOID
00568     )
00569 <span class="comment">/*++</span>
00570 <span class="comment"></span>
00571 <span class="comment">Routine Description:</span>
00572 <span class="comment"></span>
00573 <span class="comment">    This routine attempts to connect to the error log port.  If the connection</span>
00574 <span class="comment">    was made successfully and the port allows suficiently large messages, then</span>
00575 <span class="comment">    the ErrorLogPort to the port handle, ErrorLogPortConnected is set to</span>
00576 <span class="comment">    TRUE and TRUE is retuned.  Otherwise a timer is started to queue a</span>
00577 <span class="comment">    worker thread at a later time, unless there is a pending connection.</span>
00578 <span class="comment"></span>
00579 <span class="comment">Arguments:</span>
00580 <span class="comment"></span>
00581 <span class="comment">    None.</span>
00582 <span class="comment"></span>
00583 <span class="comment">Return Value:</span>
00584 <span class="comment"></span>
00585 <span class="comment">    Returns TRUE if the port was connected.</span>
00586 <span class="comment"></span>
00587 <span class="comment">--*/</span>
00588 
00589 {
00590 
00591     UNICODE_STRING errorPortName;
00592     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00593     ULONG maxMessageLength;
00594     SECURITY_QUALITY_OF_SERVICE dynamicQos;
00595 
00596     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00597 
00598     <span class="comment">//</span>
00599     <span class="comment">// If the ErrorLogPort is connected then return true.</span>
00600     <span class="comment">//</span>
00601 
00602     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/errorlog_8c.html#a5">ErrorLogPortConnected</a>) {
00603 
00604         <span class="comment">//</span>
00605         <span class="comment">// The port is connect return.</span>
00606         <span class="comment">//</span>
00607 
00608         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00609     }
00610 
00611     <span class="comment">//</span>
00612     <span class="comment">// Set up the security quality of service parameters to use over the</span>
00613     <span class="comment">// port.  Use the most efficient (least overhead) - which is dynamic</span>
00614     <span class="comment">// rather than static tracking.</span>
00615     <span class="comment">//</span>
00616 
00617     dynamicQos.ImpersonationLevel = SecurityImpersonation;
00618     dynamicQos.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
00619     dynamicQos.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">// Generate the string structure for describing the error logger's port.</span>
00623     <span class="comment">//</span>
00624 
00625     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;errorPortName, ELF_PORT_NAME_U );
00626 
00627     status = <a class="code" href="../../d5/d6/lpcconn_8c.html#a1">NtConnectPort</a>( &amp;<a class="code" href="../../d7/d7/errorlog_8c.html#a4">ErrorLogPort</a>,
00628                             &amp;errorPortName,
00629                             &amp;dynamicQos,
00630                             (PPORT_VIEW) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00631                             (PREMOTE_PORT_VIEW) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00632                             &amp;maxMessageLength,
00633                             (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00634                             (PULONG) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00635 
00636     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00637         <span class="keywordflow">if</span> (maxMessageLength &gt;= IO_ERROR_LOG_MESSAGE_LENGTH) {
00638             <a class="code" href="../../d7/d7/errorlog_8c.html#a5">ErrorLogPortConnected</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00639             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00640         } <span class="keywordflow">else</span> {
00641             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d7/d7/errorlog_8c.html#a4">ErrorLogPort</a>);
00642         }
00643     }
00644 
00645     <span class="comment">//</span>
00646     <span class="comment">// The port was not successfully opened, or its message size was unsuitable</span>
00647     <span class="comment">// for use here.  Queue a later request to run the error log thread.</span>
00648     <span class="comment">//</span>
00649 
00650     <a class="code" href="../../d7/d7/errorlog_8c.html#a11">IopErrorLogQueueRequest</a>();
00651 
00652     <span class="comment">//</span>
00653     <span class="comment">// The port could not be connected at this time return false.</span>
00654     <span class="comment">//</span>
00655 
00656     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00657 }
00658 
00659 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00660"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a9">00660</a> <a class="code" href="../../d7/d7/errorlog_8c.html#a9">IopErrorLogDpc</a>(
00661     IN <span class="keyword">struct</span> <a class="code" href="../../d1/d6/struct__KDPC.html">_KDPC</a> *Dpc,
00662     IN PVOID DeferredContext,
00663     IN PVOID SystemArgument1,
00664     IN PVOID SystemArgument2
00665     )
00666 
00667 <span class="comment">/*++</span>
00668 <span class="comment"></span>
00669 <span class="comment">Routine Description:</span>
00670 <span class="comment"></span>
00671 <span class="comment">    This routine queues a work request to the worker thread to process logged</span>
00672 <span class="comment">    errors. It is called by a timer DPC when the error log port cannot be</span>
00673 <span class="comment">    connected.  The DPC structure itself is freed by this routine.</span>
00674 <span class="comment"></span>
00675 <span class="comment">Arguments:</span>
00676 <span class="comment"></span>
00677 <span class="comment">    Dpc - Supplies a pointer to the DPC structure.  This structure is freed by</span>
00678 <span class="comment">        this routine.</span>
00679 <span class="comment"></span>
00680 <span class="comment">    DeferredContext - Unused.</span>
00681 <span class="comment"></span>
00682 <span class="comment">    SystemArgument1 - Unused.</span>
00683 <span class="comment"></span>
00684 <span class="comment">    SystemArgument2 - Unused.</span>
00685 <span class="comment"></span>
00686 <span class="comment">Return Value:</span>
00687 <span class="comment"></span>
00688 <span class="comment">    None</span>
00689 <span class="comment"></span>
00690 <span class="comment">--*/</span>
00691 
00692 {
00693     <span class="comment">//</span>
00694     <span class="comment">// Free the DPC structure if there is one.</span>
00695     <span class="comment">//</span>
00696 
00697     <span class="keywordflow">if</span> (Dpc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00698         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Dpc);
00699     }
00700 
00701     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;<a class="code" href="../../d7/d7/errorlog_8c.html#a3">IopErrorLogWorkItem</a>, <a class="code" href="../../d7/d7/errorlog_8c.html#a13">IopErrorLogThread</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00702 
00703     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;<a class="code" href="../../d7/d7/errorlog_8c.html#a3">IopErrorLogWorkItem</a>, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a> );
00704 }
00705 
00706 PLIST_ENTRY
<a name="l00707"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a10">00707</a> <a class="code" href="../../d7/d7/errorlog_8c.html#a10">IopErrorLogGetEntry</a>(
00708     )
00709 
00710 <span class="comment">/*++</span>
00711 <span class="comment"></span>
00712 <span class="comment">Routine Description:</span>
00713 <span class="comment"></span>
00714 <span class="comment">    This routine gets the next entry from the head of the error log queue</span>
00715 <span class="comment">    and returns it to the caller.</span>
00716 <span class="comment"></span>
00717 <span class="comment">Arguments:</span>
00718 <span class="comment"></span>
00719 <span class="comment">    None.</span>
00720 <span class="comment"></span>
00721 <span class="comment">Return Value:</span>
00722 <span class="comment"></span>
00723 <span class="comment">    The return value is a pointer to the packet removed, or NULL if there were</span>
00724 <span class="comment">    no packets on the queue.</span>
00725 <span class="comment"></span>
00726 <span class="comment">--*/</span>
00727 
00728 {
00729     KIRQL irql;
00730     PLIST_ENTRY listEntry;
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">// Remove the next packet from the queue, if there is one.</span>
00734     <span class="comment">//</span>
00735 
00736     ExAcquireSpinLock( &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a6">IopErrorLogLock</a>, &amp;irql );
00737     <span class="keywordflow">if</span> (IsListEmpty( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a21">IopErrorLogListHead</a> )) {
00738 
00739         <span class="comment">//</span>
00740         <span class="comment">// Indicate no more work will be done in the context of this worker</span>
00741         <span class="comment">// thread and indicate to the caller that no packets were located.</span>
00742         <span class="comment">//</span>
00743 
00744         <a class="code" href="../../d7/d7/errorlog_8c.html#a6">IopErrorLogPortPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00745         listEntry = (PLIST_ENTRY) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00746     } <span class="keywordflow">else</span> {
00747 
00748         <span class="comment">//</span>
00749         <span class="comment">// Remove the next packet from the head of the list.</span>
00750         <span class="comment">//</span>
00751 
00752         listEntry = RemoveHeadList( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a21">IopErrorLogListHead</a> );
00753     }
00754 
00755     ExReleaseSpinLock( &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a6">IopErrorLogLock</a>, irql );
00756     <span class="keywordflow">return</span> listEntry;
00757 }
00758 
00759 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00760"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a11">00760</a> <a class="code" href="../../d7/d7/errorlog_8c.html#a11">IopErrorLogQueueRequest</a>(
00761     VOID
00762     )
00763 
00764 <span class="comment">/*++</span>
00765 <span class="comment"></span>
00766 <span class="comment">Routine Description:</span>
00767 <span class="comment"></span>
00768 <span class="comment">    This routine sets a timer to fire after 30 seconds.  The timer queues a</span>
00769 <span class="comment">    DPC which then queues a worker thread request to run the error log thread</span>
00770 <span class="comment">    routine.</span>
00771 <span class="comment"></span>
00772 <span class="comment">Arguments:</span>
00773 <span class="comment"></span>
00774 <span class="comment">    None.</span>
00775 <span class="comment"></span>
00776 <span class="comment">Return Value:</span>
00777 <span class="comment"></span>
00778 <span class="comment">    None.</span>
00779 <span class="comment"></span>
00780 <span class="comment">--*/</span>
00781 
00782 {
00783     LARGE_INTEGER interval;
00784     <a class="code" href="../../d7/d7/errorlog_8c.html#a2">PIOP_ERROR_LOG_CONTEXT</a> context;
00785 
00786     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00787 
00788     <span class="comment">//</span>
00789     <span class="comment">// Allocate a context block which will contain the timer and the DPC.</span>
00790     <span class="comment">//</span>
00791 
00792     context = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html">IOP_ERROR_LOG_CONTEXT</a> ) );
00793 
00794     <span class="keywordflow">if</span> (context == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00795 
00796         <span class="comment">//</span>
00797         <span class="comment">// The context block could not be allocated. Clear the error log</span>
00798         <span class="comment">// pending bit. If there is another error then a new attempt will</span>
00799         <span class="comment">// be made.  Note the spinlock does not need to be held here since</span>
00800         <span class="comment">// new attempt should be made later not right now, so if another</span>
00801         <span class="comment">// error log packet is currently being queue, it waits with the</span>
00802         <span class="comment">// others.</span>
00803         <span class="comment">//</span>
00804 
00805         <a class="code" href="../../d7/d7/errorlog_8c.html#a6">IopErrorLogPortPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00806         <span class="keywordflow">return</span>;
00807     }
00808 
00809     <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>( &amp;context-&gt;<a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html#o0">ErrorLogDpc</a>,
00810                      <a class="code" href="../../d7/d7/errorlog_8c.html#a9">IopErrorLogDpc</a>,
00811                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00812 
00813     <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>( &amp;context-&gt;<a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html#o1">ErrorLogTimer</a> );
00814 
00815     <span class="comment">//</span>
00816     <span class="comment">// Delay for 30 seconds and try for the port again.</span>
00817     <span class="comment">//</span>
00818 
00819     interval.QuadPart = - 10 * 1000 * 1000 * 30;
00820 
00821     <span class="comment">//</span>
00822     <span class="comment">// Set the timer to fire a DPC in 30 seconds.</span>
00823     <span class="comment">//</span>
00824 
00825     <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>( &amp;context-&gt;<a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html#o1">ErrorLogTimer</a>, interval, &amp;context-&gt;<a class="code" href="../../d6/d0/struct__IOP__ERROR__LOG__CONTEXT.html#o0">ErrorLogDpc</a> );
00826 }
00827 
00828 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00829"></a><a class="code" href="../../d7/d7/errorlog_8c.html#a12">00829</a> <a class="code" href="../../d7/d7/errorlog_8c.html#a12">IopErrorLogRequeueEntry</a>(
00830     IN PLIST_ENTRY ListEntry
00831     )
00832 
00833 <span class="comment">/*++</span>
00834 <span class="comment"></span>
00835 <span class="comment">Routine Description:</span>
00836 <span class="comment"></span>
00837 <span class="comment">    This routine puts an error packet back at the head of the error log queue</span>
00838 <span class="comment">    since it cannot be processed at the moment.</span>
00839 <span class="comment"></span>
00840 <span class="comment">Arguments:</span>
00841 <span class="comment"></span>
00842 <span class="comment">    ListEntry - Supplies a pointer to the packet to be placed back onto the</span>
00843 <span class="comment">        error log queue.</span>
00844 <span class="comment"></span>
00845 <span class="comment">Return Value:</span>
00846 <span class="comment"></span>
00847 <span class="comment">    None.</span>
00848 <span class="comment"></span>
00849 <span class="comment">--*/</span>
00850 
00851 {
00852     KIRQL irql;
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">// Simply insert the packet back onto the head of the queue, indicate that</span>
00856     <span class="comment">// the error log port is not connected, queue a request to check again</span>
00857     <span class="comment">// soon, and return.</span>
00858     <span class="comment">//</span>
00859 
00860     ExAcquireSpinLock( &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a6">IopErrorLogLock</a>, &amp;irql );
00861     InsertHeadList( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a21">IopErrorLogListHead</a>, ListEntry );
00862     <a class="code" href="../../d7/d7/errorlog_8c.html#a5">ErrorLogPortConnected</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00863     ExReleaseSpinLock( &amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a6">IopErrorLogLock</a>, irql );
00864 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:56 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
