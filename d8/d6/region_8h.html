<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: region.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>region.h File Reference</h1>
<p>
<a href="../../d9/d5/region_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">_REGION_SEGMENT_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/struct__REGION__HEADER.html">_REGION_HEADER</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a0">ExInterlockedAllocateFromRegion</a>(Region, Lock)&nbsp;&nbsp;&nbsp;(PVOID)ExInterlockedPopEntryList((PSINGLE_LIST_ENTRY)&amp;(Region)-&gt;ListHead.Next, Lock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a1">ExInterlockedFreeToRegion</a>(Region, Block, Lock)&nbsp;&nbsp;&nbsp;ExInterlockedPushEntryList((PSINGLE_LIST_ENTRY)&amp;(Region)-&gt;ListHead.Next, ((PSINGLE_LIST_ENTRY)(Block)), Lock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a2">ExIsFullRegion</a>(Region)&nbsp;&nbsp;&nbsp;((Region)-&gt;ListHead.Next == (PSINGLE_LIST_ENTRY)NULL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a3">ExIsObjectInFirstRegionSegment</a>(Region, Object)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">_REGION_SEGMENT_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a4">REGION_SEGMENT_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">_REGION_SEGMENT_HEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a5">PREGION_SEGMENT_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">_REGION_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a6">REGION_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">_REGION_HEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a7">PREGION_HEADER</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a8">ExInitializeRegion</a> (IN <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">PREGION_HEADER</a> Region, IN ULONG BlockSize, IN PVOID Segment, IN ULONG SegmentSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/region_8h.html#a9">ExInterlockedExtendRegion</a> (IN <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">PREGION_HEADER</a> Region, IN PVOID Segment, IN ULONG SegmentSize, IN PKSPIN_LOCK Lock)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="region.h::ExInterlockedAllocateFromRegion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExInterlockedAllocateFromRegion          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Region,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Lock&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(PVOID)ExInterlockedPopEntryList((PSINGLE_LIST_ENTRY)&amp;(Region)-&gt;ListHead.Next, Lock)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/region_8h-source.html#l00070">70</a> of file <a class="el" href="../../d9/d5/region_8h-source.html">region.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="region.h::ExInterlockedFreeToRegion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExInterlockedFreeToRegion          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Region,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Block,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Lock&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExInterlockedPushEntryList((PSINGLE_LIST_ENTRY)&amp;(Region)-&gt;ListHead.Next, ((PSINGLE_LIST_ENTRY)(Block)), Lock)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/region_8h-source.html#l00113">113</a> of file <a class="el" href="../../d9/d5/region_8h-source.html">region.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="region.h::ExIsFullRegion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExIsFullRegion          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Region&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((Region)-&gt;ListHead.Next == (PSINGLE_LIST_ENTRY)NULL)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/region_8h-source.html#l00140">140</a> of file <a class="el" href="../../d9/d5/region_8h-source.html">region.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="region.h::ExIsObjectInFirstRegionSegment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExIsObjectInFirstRegionSegment          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Region,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Object&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((BOOLEAN)   \
    (((PUCHAR)(Object) &gt;= ((PUCHAR)((Region)-&gt;FirstSegment) + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>))) &amp;&amp;        \
     ((PUCHAR)(Object) &lt; ((PUCHAR)((Region)-&gt;FirstSegment) + (Region)-&gt;TotalSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>)))))
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d5/region_8h-source.html#l00168">168</a> of file <a class="el" href="../../d9/d5/region_8h-source.html">region.h</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a7" doxytag="region.h::PREGION_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">_REGION_HEADER</a> * <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">PREGION_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d5/ex_2region_8c-source.html#l00024">ExInitializeRegion()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="region.h::PREGION_SEGMENT_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">_REGION_SEGMENT_HEADER</a> * <a class="el" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">PREGION_SEGMENT_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d5/ex_2region_8c-source.html#l00024">ExInitializeRegion()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="region.h::REGION_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">_REGION_HEADER</a>  <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">REGION_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="region.h::REGION_SEGMENT_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">_REGION_SEGMENT_HEADER</a>  <a class="el" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d5/ex_2region_8c-source.html#l00024">ExInitializeRegion()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a8" doxytag="region.h::ExInitializeRegion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExInitializeRegion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">PREGION_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Region</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BlockSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Segment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SegmentSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ex_2region_8c-source.html#l00024">24</a> of file <a class="el" href="../../d7/d5/ex_2region_8c-source.html">ex/region.c</a>.
<p>
References <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">BlockSize</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00611">ExInitializeSListHead</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l03073">MmQuerySystemSize()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d8/d6/region_8h.html#a7">PREGION_HEADER</a>, <a class="el" href="../../d8/d6/region_8h.html#a5">PREGION_SEGMENT_HEADER</a>, and <a class="el" href="../../d8/d6/region_8h.html#a4">REGION_SEGMENT_HEADER</a>.
<p>
<pre class="fragment"><div>00033                    :
00034 
00035     This function initializes a region header.
00036 
00037 Arguments:
00038 
00039     Region - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a region header to initialize.
00040 
00041     <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocatable units within
00042         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region. The size must be larger that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial
00043         segment, and must be 64-bit aligned.
00044 
00045     Segment - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a segment of storage.
00046 
00047     SegmentSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment.
00048 
00049 Return Value:
00050 
00051     None.
00052 
00053 --*/
00054 
00055 {
00056 
00057     SINGLE_LIST_ENTRY FirstEntry;
00058     PSINGLE_LIST_ENTRY LastEntry;
00059     PSINGLE_LIST_ENTRY NextEntry;
00060     ULONG TotalSize;
00061 
00062     <span class="comment">//</span>
00063     <span class="comment">// If the host system is a small system and the segment size is greater</span>
00064     <span class="comment">// than two pages, then bugcheck.</span>
00065     <span class="comment">//</span>
00066 
00067     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>() == <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>) &amp;&amp; (SegmentSize &gt; (2 * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>))) {
00068         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(NO_PAGES_AVAILABLE, 0x123, SegmentSize, 0, 0);
00069     }
00070 
00071     <span class="comment">//</span>
00072     <span class="comment">// If the segment address is not quadword aligned, or the block size is</span>
00073     <span class="comment">// greater than the segment size minus size of the segment header, then</span>
00074     <span class="comment">// the region is not valid - bugcheck.</span>
00075     <span class="comment">//</span>
00076 
00077     <span class="keywordflow">if</span> ((((ULONG)Segment &amp; 7) != 0) ||
00078         ((<a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> &amp; 7) != 0) ||
00079         (<a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> &gt; (SegmentSize - <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>)))) {
00080         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_REGION_OR_SEGMENT, (ULONG)Segment, SegmentSize, BlockSize, 0);
00081     }
00082 
00083     <span class="comment">//</span>
00084     <span class="comment">// Initialize the region header.</span>
00085     <span class="comment">//</span>
00086 
00087     <a class="code" href="../../d5/d8/ex_8h.html#a9">ExInitializeSListHead</a>(&amp;Region-&gt;ListHead);
00088     Region-&gt;FirstSegment = (<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">PREGION_SEGMENT_HEADER</a>)Segment;
00089     Region-&gt;BlockSize = <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00090     TotalSize = ((SegmentSize - <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>)) / <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>) * <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00091     Region-&gt;TotalSize = TotalSize;
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// Initialize the segment free list.</span>
00095     <span class="comment">//</span>
00096 
00097     FirstEntry.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00098     NextEntry = (PSINGLE_LIST_ENTRY)((PCHAR)Segment + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>));
00099     LastEntry = (PSINGLE_LIST_ENTRY)((PCHAR)NextEntry + TotalSize);
00100     <span class="keywordflow">do</span> {
00101        NextEntry-&gt;Next = FirstEntry.Next;
00102        FirstEntry.Next = NextEntry;
00103        NextEntry = (PSINGLE_LIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>);
00104     } <span class="keywordflow">while</span> (NextEntry != LastEntry);
00105     Region-&gt;ListHead.Next.Next = FirstEntry.Next;
00106     <span class="keywordflow">return</span>;
00107 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="region.h::ExInterlockedExtendRegion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID ExInterlockedExtendRegion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__REGION__HEADER.html">PREGION_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Region</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Segment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SegmentSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKSPIN_LOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>Lock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/ex_2region_8c-source.html#l00110">110</a> of file <a class="el" href="../../d7/d5/ex_2region_8c-source.html">ex/region.c</a>.
<p>
References <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">BlockSize</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>00119                    :
00120 
00121     This function extends a region by adding another segment's worth of
00122     blocks to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region.
00123 
00124 Arguments:
00125 
00126     Region - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a region header.
00127 
00128     Segment - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a segment of storage.
00129 
00130     SegmentSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in bytes of Segment.
00131 
00132     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a spinlock.
00133 
00134 Return Value:
00135 
00136     None.
00137 
00138 --*/
00139 
00140 {
00141 
00142     ULONG <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00143     SINGLE_LIST_ENTRY FirstEntry;
00144     KIRQL OldIrql;
00145     PSINGLE_LIST_ENTRY LastEntry;
00146     PSINGLE_LIST_ENTRY NextEntry;
00147     ULONG TotalSize;
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">// If the segment address is not quadword aligned, or the block size is</span>
00151     <span class="comment">// greater than the segment size minus size of the segment header, then</span>
00152     <span class="comment">// the region is not valid.</span>
00153     <span class="comment">//</span>
00154 
00155     <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> = Region-&gt;BlockSize;
00156     <span class="keywordflow">if</span> ((((ULONG)Segment &amp; 7) != 0) ||
00157         ((<a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> &amp; 7) != 0) ||
00158         (<a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> &gt; (SegmentSize - <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>)))) {
00159         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_REGION_OR_SEGMENT, (ULONG)Segment, SegmentSize, BlockSize, 0);
00160     }
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Initialize the segment free list.</span>
00164     <span class="comment">//</span>
00165 
00166     TotalSize = ((SegmentSize - <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>)) / <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>) * <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00167     FirstEntry.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00168     NextEntry = (PSINGLE_LIST_ENTRY)((PCHAR)Segment + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>));
00169     LastEntry = (PSINGLE_LIST_ENTRY)((PCHAR)NextEntry + TotalSize);
00170     <span class="keywordflow">do</span> {
00171        NextEntry-&gt;Next = FirstEntry.Next;
00172        FirstEntry.Next = NextEntry;
00173        NextEntry = (PSINGLE_LIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>);
00174     } <span class="keywordflow">while</span> (NextEntry != LastEntry);
00175 
00176     <span class="comment">//</span>
00177     <span class="comment">// Acquire the specified spinlock, insert the next segment in the segment</span>
00178     <span class="comment">// list, update the total segment size, and carefully merge the new segment</span>
00179     <span class="comment">// list with the current list.</span>
00180     <span class="comment">//</span>
00181     <span class="comment">// N.B. The merging of the free list is done very carefully such that</span>
00182     <span class="comment">//      manipulation of the free list can occur without using spinlocks.</span>
00183     <span class="comment">//</span>
00184 
00185     ExAcquireSpinLock(Lock, &amp;OldIrql);
00186     ((<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">PREGION_SEGMENT_HEADER</a>)Segment)-&gt;NextSegment = Region-&gt;FirstSegment;
00187     Region-&gt;FirstSegment = (<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">PREGION_SEGMENT_HEADER</a>)Segment;
00188     Region-&gt;TotalSize += TotalSize;
00189     NextEntry = (PSINGLE_LIST_ENTRY)((PCHAR)Segment + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__REGION__SEGMENT__HEADER.html">REGION_SEGMENT_HEADER</a>));
00190     LastEntry = (PSINGLE_LIST_ENTRY)((PCHAR)LastEntry - Region-&gt;BlockSize);
00191     <span class="keywordflow">do</span> {
00192 
00193         <span class="comment">//</span>
00194         <span class="comment">// The next entry in the region list head is a volatile entry and,</span>
00195         <span class="comment">// therefore, is read each time through the loop.</span>
00196         <span class="comment">//</span>
00197 
00198         FirstEntry.Next = Region-&gt;ListHead.Next.Next;
00199 
00200         <span class="comment">//</span>
00201         <span class="comment">// The last entry in the new segment list, i.e., the one with a link</span>
00202         <span class="comment">// of NULL, is merged with the current list by storing the captured</span>
00203         <span class="comment">// region next link in the free entry. A compare and exchange is then</span>
00204         <span class="comment">// done using the merged link address as the comparand and the head</span>
00205         <span class="comment">// of the new free list as the exchange value. This is safe since it</span>
00206         <span class="comment">// does not matter if the next link of the first region entry changes.</span>
00207         <span class="comment">//</span>
00208 
00209         NextEntry-&gt;Next = FirstEntry.Next;
00210     } <span class="keywordflow">while</span> (InterlockedCompareExchange((PVOID)&amp;Region-&gt;ListHead.Next,
00211                                         LastEntry,
00212                                         FirstEntry.Next) != FirstEntry.Next);
00213 
00214     ExReleaseSpinLock(Lock, OldIrql);
00215     <span class="keywordflow">return</span>;
00216 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
