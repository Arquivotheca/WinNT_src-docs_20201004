<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntapi.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntapi.c</h1><a href="../../d7/d7/ntapi_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ntapi.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the NT level entry points for the registry.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 26-Aug-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">   Elliot Shmukler (t-ellios) 24-Aug-1998</span>
00020 <span class="comment"></span>
00021 <span class="comment">      Modified NtInitializeRegistry to handle the LKG work that needs</span>
00022 <span class="comment">      to be done when a boot is accepted by SC.</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00027 <span class="preprocessor">#include "safeboot.h"</span>
00028 <span class="preprocessor">#include &lt;evntrace.h&gt;</span>
00029 
<a name="l00030"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a3">00030</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>;
00031 
<a name="l00032"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a4">00032</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>;
00033 
<a name="l00034"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a5">00034</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d6/d0/cmdat_8c.html#a68">CmFirstTime</a>;
<a name="l00035"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a6">00035</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d6/d0/cmdat_8c.html#a69">CmBootAcceptFirstTime</a>;
00036 
<a name="l00037"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a7">00037</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d7/d7/ntapi_8c.html#a7">CmpTraceFlag</a>;
00038 
00039 <span class="comment">//</span>
00040 <span class="comment">// Nt API helper routines</span>
00041 <span class="comment">//</span>
00042 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00043 <a class="code" href="../../d7/d7/ntapi_8c.html#a10">CmpNameFromAttributes</a>(
00044     IN POBJECT_ATTRIBUTES Attributes,
00045     KPROCESSOR_MODE PreviousMode,
00046     OUT PUNICODE_STRING FullName
00047     );
00048 
00049 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00050 <span class="preprocessor"></span>
00051 <span class="preprocessor">#define ALLOCATE_WITH_QUOTA(a,b,c) ExAllocatePoolWithQuotaTag((a)|POOL_QUOTA_FAIL_INSTEAD_OF_RAISE,b,c)</span>
00052 <span class="preprocessor"></span>
00053 <span class="preprocessor">#else</span>
00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a0">00055</a> <span class="preprocessor">#define ALLOCATE_WITH_QUOTA(a,b,c) ExAllocatePoolWithQuota((a)|POOL_QUOTA_FAIL_INSTEAD_OF_RAISE,b)</span>
00056 <span class="preprocessor"></span>
00057 <span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span>
00059 <span class="preprocessor">#if DBG</span>
00060 <span class="preprocessor"></span>
00061 ULONG
00062 <a class="code" href="../../d7/d7/ntapi_8c.html#a1">CmpExceptionFilter</a>(
00063     IN PEXCEPTION_POINTERS ExceptionPointers
00064     );
00065 
00066 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpExceptionFilter)</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00070 <span class="preprocessor"></span>
<a name="l00071"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a1">00071</a> <span class="preprocessor">#define CmpExceptionFilter(x) EXCEPTION_EXECUTE_HANDLER</span>
00072 <span class="preprocessor"></span>
00073 <span class="preprocessor">#endif</span>
00074 <span class="preprocessor"></span>
00075 <span class="preprocessor">#ifdef  REGISTRY_LOCK_CHECKING</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCheckLockExceptionFilter)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00079 <span class="preprocessor"></span>
00080 ULONG
<a name="l00081"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a11">00081</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a11">CmpCheckLockExceptionFilter</a>(
00082     IN PEXCEPTION_POINTERS ExceptionPointers
00083     )
00084 {
00085     KdPrint((<span class="stringliteral">"CM: Registry exception %lx, ExceptionPointers = %lx\n"</span>,
00086             ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00087             ExceptionPointers));
00088 
00089     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,12,
00090         (ULONG_PTR)ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00091         (ULONG_PTR)ExceptionPointers-&gt;ExceptionRecord,
00092         (ULONG_PTR)ExceptionPointers-&gt;ContextRecord);
00093 
00094     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00095 }
00096 <span class="preprocessor">#endif //REGISTRY_LOCK_CHECKING</span>
00097 <span class="preprocessor"></span>
00098 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
00099 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00100 CmpFlushNotifiesOnKeyBodyList(
00101     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   kcb
00102     );
00103 <span class="preprocessor">#else</span>
00104 <span class="preprocessor"></span>BOOLEAN
00105 <a class="code" href="../../d7/d7/ntapi_8c.html#a12">CmpEnumKeyObjectCallback</a>(
00106     IN PVOID Object,
00107     IN PUNICODE_STRING ObjectName,
00108     IN ULONG HandleCount,
00109     IN ULONG PointerCount,
00110     IN PVOID Context
00111     );
00112 
00113 <span class="preprocessor">#endif</span>
00114 <span class="preprocessor"></span>
00115 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00116 <a class="code" href="../../d7/d7/ntapi_8c.html#a13">CmpDummyApc</a>(
00117     <span class="keyword">struct</span> <a class="code" href="../../d1/d5/struct__KAPC.html">_KAPC</a> *Apc,
00118     PVOID *SystemArgument1,
00119     PVOID *SystemArgument2
00120     );
00121 
00122 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00123 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtCreateKey)</span>
00124 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtDeleteKey)</span>
00125 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtDeleteValueKey)</span>
00126 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtEnumerateKey)</span>
00127 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtEnumerateValueKey)</span>
00128 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtFlushKey)</span>
00129 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtInitializeRegistry)</span>
00130 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtNotifyChangeKey)</span>
00131 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtNotifyChangeMultipleKeys)</span>
00132 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtOpenKey)</span>
00133 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtQueryKey)</span>
00134 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtQueryValueKey)</span>
00135 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtQueryMultipleValueKey)</span>
00136 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtRestoreKey)</span>
00137 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtSaveKey)</span>
00138 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtSaveMergedKeys)</span>
00139 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtSetValueKey)</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtLoadKey)</span>
00141 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtUnloadKey)</span>
00142 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtSetInformationKey)</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtReplaceKey)</span>
00144 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtQueryOpenSubKeys)</span>
00145 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpNameFromAttributes)</span>
00146 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpAllocatePostBlock)</span>
00147 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFreePostBlock)</span>
00148 <span class="preprocessor"></span>
00149 <span class="preprocessor">#ifndef KCB_TO_KEYBODY_LINK</span>
00150 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpEnumKeyObjectCallback)</span>
00151 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00152 <span class="preprocessor"></span>
00153 <span class="preprocessor">#endif</span>
00154 <span class="preprocessor"></span>
00155 <span class="comment">// #define LOG_NT_API 1</span>
00156 
00157 <span class="preprocessor">#ifdef LOG_NT_API</span>
00158 <span class="preprocessor"></span>BOOLEAN CmpLogApi = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00159 <span class="preprocessor">#endif</span>
00160 <span class="preprocessor"></span>
00161 <span class="comment">//</span>
00162 <span class="comment">// Nt level registry API calls</span>
00163 <span class="comment">//</span>
00164 
00165 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00166"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a14">00166</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00167     OUT PHANDLE KeyHandle,
00168     IN ACCESS_MASK DesiredAccess,
00169     IN POBJECT_ATTRIBUTES ObjectAttributes,
00170     IN ULONG TitleIndex,
00171     IN PUNICODE_STRING Class OPTIONAL,
00172     IN ULONG CreateOptions,
00173     OUT PULONG Disposition OPTIONAL
00174     )
00175 <span class="comment">/*++</span>
00176 <span class="comment"></span>
00177 <span class="comment">Routine Description:</span>
00178 <span class="comment"></span>
00179 <span class="comment">    An existing registry key may be opened, or a new one created,</span>
00180 <span class="comment">    with NtCreateKey.</span>
00181 <span class="comment"></span>
00182 <span class="comment">    If the specified key does not exist, an attempt is made to create it.</span>
00183 <span class="comment">    For the create attempt to succeed, the new node must be a direct</span>
00184 <span class="comment">    child of the node referred to by KeyHandle.  If the node exists,</span>
00185 <span class="comment">    it is opened.  Its value is not affected in any way.</span>
00186 <span class="comment"></span>
00187 <span class="comment">    Share access is computed from desired access.</span>
00188 <span class="comment"></span>
00189 <span class="comment">    NOTE:</span>
00190 <span class="comment"></span>
00191 <span class="comment">        If CreateOptions has REG_OPTION_BACKUP_RESTORE set, then</span>
00192 <span class="comment">        DesiredAccess will be ignored.  If the caller has the</span>
00193 <span class="comment">        privilege SeBackupPrivilege asserted, a handle with</span>
00194 <span class="comment">        KEY_READ | ACCESS_SYSTEM_SECURITY will be returned.</span>
00195 <span class="comment">        If SeRestorePrivilege, then same but KEY_WRITE rather</span>
00196 <span class="comment">        than KEY_READ.  If both, then both access sets.  If neither</span>
00197 <span class="comment">        privilege is asserted, then the call will fail.</span>
00198 <span class="comment"></span>
00199 <span class="comment">Arguments:</span>
00200 <span class="comment"></span>
00201 <span class="comment">    KeyHandle - Receives a Handle which is used to access the</span>
00202 <span class="comment">        specified key in the Registration Database.</span>
00203 <span class="comment"></span>
00204 <span class="comment">    DesiredAccess - Specifies the access rights desired.</span>
00205 <span class="comment"></span>
00206 <span class="comment">    ObjectAttributes - Specifies the attributes of the key being opened.</span>
00207 <span class="comment">        Note that a key name must be specified.  If a Root Directory is</span>
00208 <span class="comment">        specified, the name is relative to the root.  The name of the</span>
00209 <span class="comment">        object must be within the name space allocated to the Registry,</span>
00210 <span class="comment">        that is, all names beginning "\Registry".  RootHandle, if</span>
00211 <span class="comment">        present, must be a handle to "\", or "\Registry", or a key</span>
00212 <span class="comment">        under "\Registry".</span>
00213 <span class="comment"></span>
00214 <span class="comment">        RootHandle must have been opened for KEY_CREATE_SUB_KEY access</span>
00215 <span class="comment">        if a new node is to be created.</span>
00216 <span class="comment"></span>
00217 <span class="comment">        NOTE:   Object manager will capture and probe this argument.</span>
00218 <span class="comment"></span>
00219 <span class="comment">    TitleIndex - Specifies the index of the localized alias for</span>
00220 <span class="comment">        the name of the key.  The title index specifies the index of</span>
00221 <span class="comment">        the localized alias for the name.  Ignored if the key</span>
00222 <span class="comment">        already exists.</span>
00223 <span class="comment"></span>
00224 <span class="comment">    Class - Specifies the object class of the key.  (To the registry</span>
00225 <span class="comment">        this is just a string.)  Ignored if NULL.</span>
00226 <span class="comment"></span>
00227 <span class="comment">    CreateOptions - Optional control values:</span>
00228 <span class="comment"></span>
00229 <span class="comment">        REG_OPTION_VOLATILE - Object is not to be stored across boots.</span>
00230 <span class="comment"></span>
00231 <span class="comment">    Disposition - This optional parameter is a pointer to a variable</span>
00232 <span class="comment">        that will receive a value indicating whether a new Registry</span>
00233 <span class="comment">        key was created or an existing one opened:</span>
00234 <span class="comment"></span>
00235 <span class="comment">        REG_CREATED_NEW_KEY - A new Registry Key was created</span>
00236 <span class="comment">        REG_OPENED_EXISTING_KEY - An existing Registry Key was opened</span>
00237 <span class="comment"></span>
00238 <span class="comment">Return Value:</span>
00239 <span class="comment"></span>
00240 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00241 <span class="comment"></span>
00242 <span class="comment">        &lt;TBS&gt;</span>
00243 <span class="comment"></span>
00244 <span class="comment">--*/</span>
00245 {
00246     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00247     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
00248     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> ParseContext;
00249     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
00250     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = 0;
00251     UNICODE_STRING CapturedObjectName = {0};
00252 
00253     <span class="comment">// Start registry call tracing</span>
00254     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00255 
00256     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00257 
00258     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00259 
00260     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtCreateKey\n"</span>));
00261     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
00262         KdPrint((<span class="stringliteral">"\tDesiredAccess=%08lx "</span>, DesiredAccess));
00263         KdPrint((<span class="stringliteral">"\tCreateOptions=%08lx\n"</span>, CreateOptions));
00264         KdPrint((<span class="stringliteral">"\tRootHandle=%08lx\n"</span>, <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;RootDirectory));
00265         KdPrint((<span class="stringliteral">"\tName='%wZ'\n"</span>, <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName));
00266     }
00267 
00268     mode = KeGetPreviousMode();
00269     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00270     
00271 <span class="preprocessor">#ifdef LOG_NT_API</span>
00272 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00273         KdPrint((<span class="stringliteral">"NtCreateKey %wZ relative to %d..."</span>,
00274                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName,
00275                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;RootDirectory));
00276     }
00277 <span class="preprocessor">#endif</span>
00278 <span class="preprocessor"></span>
00279     <span class="keywordflow">try</span> {
00280 
00281         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Length = 0;
00282         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00283 
00284         <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00285 
00286             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Class)) {
00287                 ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a> = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(Class);
00288                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00289                     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Buffer,
00290                     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Length,
00291                     <span class="keyword">sizeof</span>(WCHAR)
00292                     );
00293             }
00294             <a class="code" href="../../d5/d8/ex_8h.html#a36">ProbeAndZeroHandle</a>(KeyHandle);
00295 
00296             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Disposition)) {
00297                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(Disposition);
00298             }
00299 
00300             <span class="comment">//</span>
00301             <span class="comment">// probe the ObjectAttributes as we shall use it for tracing</span>
00302             <span class="comment">//</span>
00303             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00304                           <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES),
00305                           PROBE_ALIGNMENT(OBJECT_ATTRIBUTES) );
00306             CapturedObjectName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName);
00307             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00308                 CapturedObjectName.Buffer,
00309                 CapturedObjectName.Length,
00310                 <span class="keyword">sizeof</span>(WCHAR)
00311                 );
00312 
00313         } <span class="keywordflow">else</span> {
00314             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Class)) {
00315                 ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a> = *Class;
00316             }
00317             CapturedObjectName = *(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName);
00318         }
00319 
00320         <span class="keywordflow">if</span> ((CreateOptions &amp; REG_LEGAL_OPTION) != CreateOptions) {
00321             <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00322 
00323             <span class="comment">// End registry call tracing</span>
00324             <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_PARAMETER,0,&amp;CapturedObjectName,EVENT_TRACE_TYPE_REGCREATE);
00325 
00326             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00327         }
00328 
00329         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o0">TitleIndex</a> = 0;
00330         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o2">CreateOptions</a> = CreateOptions;
00331         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o3">Disposition</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00332         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00333         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o6">PredefinedHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00334 
00335         status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(
00336                     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00337                     <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
00338                     mode,
00339                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00340                     DesiredAccess,
00341                     (PVOID)&amp;ParseContext,
00342                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00343                     );
00344 
00345         <span class="keywordflow">if</span> (status==STATUS_PREDEFINED_HANDLE) {
00346             status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00347                                                0,
00348                                                <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
00349                                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00350                                                (PVOID *)(&amp;KeyBody),
00351                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00352             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00353                 HANDLE TempHandle;
00354 
00355                 <span class="comment">//</span>
00356                 <span class="comment">// Make sure we do the dereference and close before accessing</span>
00357                 <span class="comment">// user space as the reference might fault.</span>
00358                 <span class="comment">//</span>
00359                 TempHandle = (HANDLE)LongToHandle(KeyBody-&gt;Type);
00360                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00361                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00362                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = *KeyHandle = TempHandle;
00363                 status = STATUS_SUCCESS;
00364             }
00365         } <span class="keywordflow">else</span>
00366         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00367             *KeyHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00368         }
00369 
00370         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Disposition)) {
00371             *Disposition = ParseContext.Disposition;
00372         }
00373 
00374     } except (<a class="code" href="../../d7/d7/ntapi_8c.html#a1">CmpExceptionFilter</a>(GetExceptionInformation())) {
00375         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
00376             KdPrint((<span class="stringliteral">"!!NtCreateKey: code:%08lx\n"</span>, GetExceptionCode()));
00377         }
00378         status = GetExceptionCode();
00379     }
00380 <span class="preprocessor">#ifdef LOG_NT_API</span>
00381 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00382         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00383             KdPrint((<span class="stringliteral">"succeeded %d\n"</span>,<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>));
00384         } <span class="keywordflow">else</span> {
00385             KdPrint((<span class="stringliteral">"failed %08lx\n"</span>,status));
00386         }
00387     }
00388 <span class="preprocessor">#endif</span>
00389 <span class="preprocessor"></span>
00390 
00391     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00392 
00393     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00394 
00395     <span class="comment">// End registry call tracing</span>
00396     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,&amp;CapturedObjectName,EVENT_TRACE_TYPE_REGCREATE);
00397 
00398     <span class="keywordflow">return</span>  status;
00399 }
00400 
<a name="l00401"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a8">00401</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[2];
00402 
00403 <span class="comment">//</span>
00404 <span class="comment">// WARNING: This should be the same as the one defined in obp.h</span>
00405 <span class="comment">//          Remove this one when object manager guys will export </span>
00406 <span class="comment">//          this via ob.h</span>
00407 <span class="comment">//</span>
<a name="l00408"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a2">00408</a> <span class="preprocessor">#define OBJ_AUDIT_OBJECT_CLOSE 0x00000004L</span>
00409 <span class="preprocessor"></span>
00410 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00411"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a15">00411</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a15">NtDeleteKey</a>(
00412     IN HANDLE KeyHandle
00413     )
00414 <span class="comment">/*++</span>
00415 <span class="comment"></span>
00416 <span class="comment">Routine Description:</span>
00417 <span class="comment"></span>
00418 <span class="comment">    A registry key may be marked for delete, causing it to be removed</span>
00419 <span class="comment">    from the system.  It will remain in the name space until the last</span>
00420 <span class="comment">    handle to it is closed.</span>
00421 <span class="comment"></span>
00422 <span class="comment">Arguments:</span>
00423 <span class="comment"></span>
00424 <span class="comment">    KeyHandle - Specifies the handle of the Key to delete, must have</span>
00425 <span class="comment">        been opened for DELETE access.</span>
00426 <span class="comment"></span>
00427 <span class="comment">Return Value:</span>
00428 <span class="comment"></span>
00429 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00430 <span class="comment"></span>
00431 <span class="comment">        &lt;TBS&gt;</span>
00432 <span class="comment"></span>
00433 <span class="comment">--*/</span>
00434 {
00435     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>                KeyBody;
00436     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
00437     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a>   HandleInfo;
00438 
00439     <span class="comment">// Start registry call tracing</span>
00440     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00441 
00442     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00443 
00444     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00445 
00446     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtDeleteKey\n"</span>));
00447     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
00448         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
00449     }
00450 <span class="preprocessor">#ifdef LOG_NT_API</span>
00451 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00452         KdPrint((<span class="stringliteral">"NtDeleteKey %d\n"</span>,KeyHandle));
00453     }
00454 <span class="preprocessor">#endif</span>
00455 <span class="preprocessor"></span>
00456     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
00457                                        DELETE,
00458                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
00459                                        KeGetPreviousMode(),
00460                                        (PVOID *)(&amp;KeyBody),
00461                                        &amp;HandleInfo);
00462 
00463     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00464 
00465         <span class="comment">//</span>
00466         <span class="comment">// Silently fail deletes of setup key and productoptions key</span>
00467         <span class="comment">//</span>
00468 
00469         <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[0] &amp;&amp; KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> == <a class="code" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[0]-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>) ||
00470              (<a class="code" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[1] &amp;&amp; KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> == <a class="code" href="../../d7/d7/ntapi_8c.html#a8">ExpControlKey</a>[1]-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>) ) {
00471             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00472 
00473             <span class="comment">// End registry call tracing</span>
00474             <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_SUCCESS,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGDELETE);
00475 
00476             <span class="keywordflow">return</span> STATUS_SUCCESS;
00477         }
00478 
00479         status = <a class="code" href="../../d1/d2/cmp_8h.html#a224">CmDeleteKey</a>(KeyBody);
00480 
00481         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00482             <span class="comment">//</span>
00483             <span class="comment">// Audit the deletion</span>
00484             <span class="comment">//</span>
00485 
00486             <span class="keywordflow">if</span> ( HandleInfo.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a> ) {
00487                 <a class="code" href="../../d3/d5/seaudit_8c.html#a30">SeDeleteObjectAuditAlarm</a>(KeyBody,
00488                                          KeyHandle );
00489             }
00490         }
00491         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00492     }
00493 
00494     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00495 
00496     <span class="comment">// End registry call tracing</span>
00497     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGDELETE);
00498 
00499     <span class="keywordflow">return</span> status;
00500 }
00501 
00502 
00503 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00504"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a16">00504</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>(
00505     IN HANDLE KeyHandle,
00506     IN PUNICODE_STRING ValueName
00507     )
00508 <span class="comment">/*++</span>
00509 <span class="comment"></span>
00510 <span class="comment">Routine Description:</span>
00511 <span class="comment"></span>
00512 <span class="comment">    One of the value entries of a registry key may be removed with this</span>
00513 <span class="comment">    call.  To remove the entire key, call NtDeleteKey.</span>
00514 <span class="comment"></span>
00515 <span class="comment">    The value entry with ValueName matching ValueName is removed from the key.</span>
00516 <span class="comment">    If no such entry exists, an error is returned.</span>
00517 <span class="comment"></span>
00518 <span class="comment">Arguments:</span>
00519 <span class="comment"></span>
00520 <span class="comment">    KeyHandle - Specifies the handle of the key containing the value</span>
00521 <span class="comment">        entry of interest.  Must have been opend for KEY_SET_VALUE access.</span>
00522 <span class="comment"></span>
00523 <span class="comment">    ValueName - The name of the value to be deleted.  NULL is a legal name.</span>
00524 <span class="comment"></span>
00525 <span class="comment">Return Value:</span>
00526 <span class="comment"></span>
00527 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00528 <span class="comment"></span>
00529 <span class="comment">        &lt;TBS&gt;</span>
00530 <span class="comment"></span>
00531 <span class="comment">--*/</span>
00532 {
00533     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00534     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
00535     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
00536     UNICODE_STRING LocalValueName;
00537 
00538     <span class="comment">// Start registry call tracing</span>
00539     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00540 
00541     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00542 
00543     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00544 
00545     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtDeleteValueKey\n"</span>));
00546     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
00547         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
00548         KdPrint((<span class="stringliteral">"\tValueName='%wZ'\n"</span>, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>));
00549     }
00550 <span class="preprocessor">#ifdef LOG_NT_API</span>
00551 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00552         KdPrint((<span class="stringliteral">"NtDeleteValueKey %d %wZ\n"</span>,KeyHandle,<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>));
00553     }
00554 <span class="preprocessor">#endif</span>
00555 <span class="preprocessor"></span>    mode = KeGetPreviousMode();
00556 
00557     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00558                 KeyHandle,
00559                 KEY_SET_VALUE,
00560                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
00561                 mode,
00562                 (PVOID *)(&amp;KeyBody),
00563                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00564                 );
00565 
00566     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00567 
00568 
00569         <span class="keywordflow">try</span> {
00570             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00571                 LocalValueName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
00572                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00573                     LocalValueName.Buffer,
00574                     LocalValueName.Length,
00575                     <span class="keyword">sizeof</span>(WCHAR)
00576                     );
00577             } <span class="keywordflow">else</span> {
00578                 LocalValueName = *<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00579             }
00580 
00581             status = <a class="code" href="../../d1/d2/cmp_8h.html#a225">CmDeleteValueKey</a>(
00582                         KeyBody-&gt;KeyControlBlock,
00583                         LocalValueName
00584                         );
00585 
00586         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00587             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
00588                KdPrint((<span class="stringliteral">"!!NtDeleteValueKey: code:%08lx\n"</span>, GetExceptionCode()));
00589             }
00590             status = GetExceptionCode();
00591         }
00592 
00593 
00594         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00595     } <span class="keywordflow">else</span> {
00596         LocalValueName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00597         LocalValueName.Length = 0;
00598     }
00599 
00600     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00601 
00602     <span class="comment">// End registry call tracing</span>
00603     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,&amp;LocalValueName,EVENT_TRACE_TYPE_REGDELETEVALUE);
00604 
00605     <span class="keywordflow">return</span> status;
00606 }
00607 
00608 
00609 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00610"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a17">00610</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a17">NtEnumerateKey</a>(
00611     IN HANDLE KeyHandle,
00612     IN ULONG Index,
00613     IN KEY_INFORMATION_CLASS KeyInformationClass,
00614     IN PVOID KeyInformation,
00615     IN ULONG Length,
00616     IN PULONG ResultLength
00617     )
00618 <span class="comment">/*++</span>
00619 <span class="comment"></span>
00620 <span class="comment">Routine Description:</span>
00621 <span class="comment"></span>
00622 <span class="comment">    The sub keys of an open key may be enumerated with NtEnumerateKey.</span>
00623 <span class="comment"></span>
00624 <span class="comment">    NtEnumerateKey returns the name of the Index'th sub key of the open</span>
00625 <span class="comment">    key specified by KeyHandle.  The value STATUS_NO_MORE_ENTRIES will be</span>
00626 <span class="comment">    returned if value of Index is larger than the number of sub keys.</span>
00627 <span class="comment"></span>
00628 <span class="comment">    Note that Index is simply a way to select among child keys.  Two calls</span>
00629 <span class="comment">    to NtEnumerateKey with the same Index are NOT guaranteed to return</span>
00630 <span class="comment">    the same results.</span>
00631 <span class="comment"></span>
00632 <span class="comment">    If KeyInformation is not long enough to hold all requested data,</span>
00633 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00634 <span class="comment">    set to the number of bytes actually required.</span>
00635 <span class="comment"></span>
00636 <span class="comment">Arguments:</span>
00637 <span class="comment"></span>
00638 <span class="comment">    KeyHandle - Handle of the key whose sub keys are to be enumerated.  Must</span>
00639 <span class="comment">        be open for KEY_ENUMERATE_SUB_KEY access.</span>
00640 <span class="comment"></span>
00641 <span class="comment">    Index - Specifies the (0-based) number of the sub key to be returned.</span>
00642 <span class="comment"></span>
00643 <span class="comment">    KeyInformationClass - Specifies the type of information returned in</span>
00644 <span class="comment">        Buffer.  One of the following types:</span>
00645 <span class="comment"></span>
00646 <span class="comment">        KeyBasicInformation - return last write time, title index, and name.</span>
00647 <span class="comment">            (see KEY_BASIC_INFORMATION structure)</span>
00648 <span class="comment"></span>
00649 <span class="comment">        KeyNodeInformation - return last write time, title index, name, class.</span>
00650 <span class="comment">            (see KEY_NODE_INFORMATION structure)</span>
00651 <span class="comment"></span>
00652 <span class="comment">    KeyInformation -Supplies pointer to buffer to receive the data.</span>
00653 <span class="comment"></span>
00654 <span class="comment">    Length - Length of KeyInformation in bytes.</span>
00655 <span class="comment"></span>
00656 <span class="comment">    ResultLength - Number of bytes actually written into KeyInformation.</span>
00657 <span class="comment"></span>
00658 <span class="comment">Return Value:</span>
00659 <span class="comment"></span>
00660 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00661 <span class="comment"></span>
00662 <span class="comment">        &lt;TBS&gt;</span>
00663 <span class="comment"></span>
00664 <span class="comment">--*/</span>
00665 {
00666     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00667     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
00668     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
00669 
00670     <span class="comment">// Start registry call tracing</span>
00671     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00672 
00673     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00674 
00675     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00676 
00677     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtEnumerateKey\n"</span>));
00678     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
00679         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx Index=%08lx\n"</span>, KeyHandle, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>));
00680     }
00681 
00682 <span class="preprocessor">#ifdef LOG_NT_API</span>
00683 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00684         KdPrint((<span class="stringliteral">"NtEnumerateKey %d %d %d\n"</span>,KeyHandle,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,KeyInformationClass));
00685     }
00686 <span class="preprocessor">#endif</span>
00687 <span class="preprocessor"></span>
00688     <span class="keywordflow">if</span> ((KeyInformationClass != KeyBasicInformation) &amp;&amp;
00689         (KeyInformationClass != KeyNodeInformation)  &amp;&amp;
00690         (KeyInformationClass != KeyFullInformation))
00691     {
00692         <span class="comment">// End registry call tracing</span>
00693         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_PARAMETER,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGENUMERATEKEY);
00694 
00695         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00696     }
00697 
00698     mode = KeGetPreviousMode();
00699 
00700     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00701                 KeyHandle,
00702                 KEY_ENUMERATE_SUB_KEYS,
00703                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
00704                 mode,
00705                 (PVOID *)(&amp;KeyBody),
00706                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00707                 );
00708 
00709     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00710 
00711         <span class="keywordflow">try</span> {
00712             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00713                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00714                     KeyInformation,
00715                     Length,
00716                     <span class="keyword">sizeof</span>(ULONG)
00717                     );
00718                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ResultLength);
00719             }
00720 
00721         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00722             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
00723                 KdPrint((<span class="stringliteral">"!!NtEnumerateKey: code:%08lx\n"</span>, GetExceptionCode()));
00724             }
00725             status = GetExceptionCode();
00726         }
00727 
00728         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00729             <span class="comment">//</span>
00730             <span class="comment">// CmEnumerateKey is protected to user mode buffer exceptions</span>
00731             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
00732             <span class="comment">//</span>
00733             status = <a class="code" href="../../d1/d2/cmp_8h.html#a226">CmEnumerateKey</a>(
00734                         KeyBody-&gt;KeyControlBlock,
00735                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00736                         KeyInformationClass,
00737                         KeyInformation,
00738                         Length,
00739                         ResultLength
00740                         );
00741         }
00742 
00743         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00744     }
00745 
00746     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00747 
00748     <span class="comment">// End registry call tracing</span>
00749     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGENUMERATEKEY);
00750 
00751     <span class="keywordflow">return</span> status;
00752 }
00753 
00754 
00755 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00756"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a18">00756</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(
00757     IN HANDLE KeyHandle,
00758     IN ULONG Index,
00759     IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,
00760     IN PVOID KeyValueInformation,
00761     IN ULONG Length,
00762     IN PULONG ResultLength
00763     )
00764 <span class="comment">/*++</span>
00765 <span class="comment"></span>
00766 <span class="comment">Routine Description:</span>
00767 <span class="comment"></span>
00768 <span class="comment">    The value entries of an open key may be enumerated</span>
00769 <span class="comment">    with NtEnumerateValueKey.</span>
00770 <span class="comment"></span>
00771 <span class="comment">    NtEnumerateValueKey returns the name of the Index'th value</span>
00772 <span class="comment">    entry of the open key specified by KeyHandle.  The value</span>
00773 <span class="comment">    STATUS_NO_MORE_ENTRIES will be returned if value of Index is</span>
00774 <span class="comment">    larger than the number of sub keys.</span>
00775 <span class="comment"></span>
00776 <span class="comment">    Note that Index is simply a way to select among value</span>
00777 <span class="comment">    entries.  Two calls to NtEnumerateValueKey with the same Index</span>
00778 <span class="comment">    are NOT guaranteed to return the same results.</span>
00779 <span class="comment"></span>
00780 <span class="comment">    If KeyValueInformation is not long enough to hold all requested data,</span>
00781 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00782 <span class="comment">    set to the number of bytes actually required.</span>
00783 <span class="comment"></span>
00784 <span class="comment">Arguments:</span>
00785 <span class="comment"></span>
00786 <span class="comment">    KeyHandle - Handle of the key whose value entries are to be enumerated.</span>
00787 <span class="comment">        Must have been opened with KEY_QUERY_VALUE access.</span>
00788 <span class="comment"></span>
00789 <span class="comment">    Index - Specifies the (0-based) number of the sub key to be returned.</span>
00790 <span class="comment"></span>
00791 <span class="comment">    KeyValueInformationClass - Specifies the type of information returned</span>
00792 <span class="comment">    in Buffer. One of the following types:</span>
00793 <span class="comment"></span>
00794 <span class="comment">        KeyValueBasicInformation - return time of last write,</span>
00795 <span class="comment">            title index, and name.  (See KEY_VALUE_BASIC_INFORMATION)</span>
00796 <span class="comment"></span>
00797 <span class="comment">        KeyValueFullInformation - return time of last write,</span>
00798 <span class="comment">            title index, name, class.  (See KEY_VALUE_FULL_INFORMATION)</span>
00799 <span class="comment"></span>
00800 <span class="comment">    KeyValueInformation -Supplies pointer to buffer to receive the data.</span>
00801 <span class="comment"></span>
00802 <span class="comment">    Length - Length of KeyValueInformation in bytes.</span>
00803 <span class="comment"></span>
00804 <span class="comment">    ResultLength - Number of bytes actually written into KeyValueInformation.</span>
00805 <span class="comment"></span>
00806 <span class="comment">Return Value:</span>
00807 <span class="comment"></span>
00808 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00809 <span class="comment"></span>
00810 <span class="comment">        &lt;TBS&gt;</span>
00811 <span class="comment"></span>
00812 <span class="comment">--*/</span>
00813 {
00814     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00815     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
00816     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
00817 
00818     <span class="comment">// Start registry call tracing</span>
00819     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00820 
00821     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00822 
00823     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00824 
00825     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtEnumerateValueKey\n"</span>));
00826     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
00827         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx Index=%08lx\n"</span>, KeyHandle, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>));
00828     }
00829 
00830 <span class="preprocessor">#ifdef LOG_NT_API</span>
00831 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00832         KdPrint((<span class="stringliteral">"NtEnumerateValueKey %d %d %d\n"</span>,KeyHandle,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,KeyValueInformationClass));
00833     }
00834 <span class="preprocessor">#endif</span>
00835 <span class="preprocessor"></span>
00836     <span class="keywordflow">if</span> ((KeyValueInformationClass != KeyValueBasicInformation) &amp;&amp;
00837         (KeyValueInformationClass != KeyValueFullInformation)  &amp;&amp;
00838         (KeyValueInformationClass != KeyValuePartialInformation))
00839     {
00840         <span class="comment">// End registry call tracing</span>
00841         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_PARAMETER,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGENUMERATEVALUEKEY);
00842 
00843         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00844     }
00845 
00846     mode = KeGetPreviousMode();
00847 
00848     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00849                 KeyHandle,
00850                 KEY_QUERY_VALUE,
00851                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
00852                 mode,
00853                 (PVOID *)(&amp;KeyBody),
00854                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00855                 );
00856 
00857     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00858 
00859         <span class="keywordflow">try</span> {
00860             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00861                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00862                     KeyValueInformation,
00863                     Length,
00864                     <span class="keyword">sizeof</span>(ULONG)
00865                     );
00866                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ResultLength);
00867             }
00868 
00869         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00870             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
00871                 KdPrint((<span class="stringliteral">"!!NtEnumerateValueKey: code:%08lx\n"</span>, GetExceptionCode()));
00872             }
00873             status = GetExceptionCode();
00874         }
00875 
00876         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00877             <span class="comment">//</span>
00878             <span class="comment">// CmEnumerateValueKey is protected to user mode buffer exceptions</span>
00879             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
00880             <span class="comment">//</span>
00881             status = <a class="code" href="../../d1/d2/cmp_8h.html#a227">CmEnumerateValueKey</a>(
00882                         KeyBody-&gt;KeyControlBlock,
00883                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00884                         KeyValueInformationClass,
00885                         KeyValueInformation,
00886                         Length,
00887                         ResultLength
00888                         );
00889         }
00890 
00891         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00892     }
00893 
00894     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00895 
00896     <span class="comment">// End registry call tracing</span>
00897     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGENUMERATEVALUEKEY);
00898 
00899     <span class="keywordflow">return</span> status;
00900 }
00901 
00902 
00903 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00904"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a19">00904</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a19">NtFlushKey</a>(
00905     IN HANDLE KeyHandle
00906     )
00907 <span class="comment">/*++</span>
00908 <span class="comment"></span>
00909 <span class="comment">Routine Description:</span>
00910 <span class="comment"></span>
00911 <span class="comment">    Changes made by NtCreateKey or NtSetKey may be flushed to disk with</span>
00912 <span class="comment">    NtFlushKey.</span>
00913 <span class="comment"></span>
00914 <span class="comment">    NtFlushKey will not return to its caller until any changed data</span>
00915 <span class="comment">    associated with KeyHandle has been written to permanent store.</span>
00916 <span class="comment"></span>
00917 <span class="comment">    WARNING: NtFlushKey will flush the entire registry tree, and thus will</span>
00918 <span class="comment">    burn cycles and I/O.</span>
00919 <span class="comment"></span>
00920 <span class="comment">Arguments:</span>
00921 <span class="comment"></span>
00922 <span class="comment">    KeyHandle - Handle of open key to be flushed.</span>
00923 <span class="comment"></span>
00924 <span class="comment">Return Value:</span>
00925 <span class="comment"></span>
00926 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00927 <span class="comment"></span>
00928 <span class="comment">        &lt;TBS&gt;</span>
00929 <span class="comment"></span>
00930 <span class="comment">--*/</span>
00931 {
00932     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
00933     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00934     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
00935 
00936     <span class="comment">// Start registry call tracing</span>
00937     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
00938 
00939     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00940 
00941     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
00942 
00943     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtFlushKey\n"</span>));
00944 
00945 <span class="preprocessor">#ifdef LOG_NT_API</span>
00946 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
00947         KdPrint((<span class="stringliteral">"NtFlushKey(%d)\n"</span>,KeyHandle));
00948     }
00949 <span class="preprocessor">#endif</span>
00950 <span class="preprocessor"></span>
00951     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00952                 KeyHandle,
00953                 0,
00954                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
00955                 KeGetPreviousMode(),
00956                 (PVOID *)(&amp;KeyBody),
00957                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00958                 );
00959 
00960     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00961 
00962         <span class="comment">//</span>
00963         <span class="comment">// Need the exclusive lock so we can call the registry worker thread.</span>
00964         <span class="comment">//</span>
00965         <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00966 
00967         <span class="keywordflow">if</span> (KeyBody-&gt;KeyControlBlock-&gt;Delete) {
00968             status = STATUS_KEY_DELETED;
00969         } <span class="keywordflow">else</span> {
00970             <span class="comment">//</span>
00971             <span class="comment">// Wake up worker thread to do real work for us</span>
00972             <span class="comment">//</span>
00973 
00974             Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a102">REG_CMD_FLUSH_KEY</a>;
00975             Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a> = KeyBody-&gt;KeyControlBlock-&gt;KeyHive;
00976             Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o2">Cell</a> = KeyBody-&gt;KeyControlBlock-&gt;KeyCell;
00977 
00978             <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
00979             status = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
00980         }
00981 
00982         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
00983 
00984         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00985     }
00986 
00987     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
00988 
00989     <span class="comment">// End registry call tracing</span>
00990     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGFLUSH);
00991 
00992     <span class="keywordflow">return</span> status;
00993 }
00994 
00995 
00996 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00997"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a20">00997</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a20">NtInitializeRegistry</a>(
00998     IN USHORT BootCondition
00999     )
01000 <span class="comment">/*++</span>
01001 <span class="comment"></span>
01002 <span class="comment">Routine Description:</span>
01003 <span class="comment"></span>
01004 <span class="comment">    This routine is called in 2 situations:</span>
01005 <span class="comment"></span>
01006 <span class="comment">    1) It is called from SM after autocheck (chkdsk) has</span>
01007 <span class="comment">    run and the paging files have been opened.  It's function is</span>
01008 <span class="comment">    to bind in memory hives to their files, and to open any other</span>
01009 <span class="comment">    files yet to be used.</span>
01010 <span class="comment"></span>
01011 <span class="comment">    2) It is called from SC after the current boot has been accepted</span>
01012 <span class="comment">    and the control set used for the boot process should be saved</span>
01013 <span class="comment">    as the LKG control set.</span>
01014 <span class="comment"></span>
01015 <span class="comment">    After this routine accomplishes the work of situation #1 and</span>
01016 <span class="comment">      #2, further requests for such work will not be carried out.</span>
01017 <span class="comment"></span>
01018 <span class="comment">Arguments:</span>
01019 <span class="comment"></span>
01020 <span class="comment">    BootCondition -</span>
01021 <span class="comment"></span>
01022 <span class="comment">         REG_INIT_BOOT_SM -     The routine has been called from SM</span>
01023 <span class="comment">                                in situation #1.</span>
01024 <span class="comment"></span>
01025 <span class="comment">         REG_INIT_BOOT_SETUP -  The routine has been called to perform</span>
01026 <span class="comment">                                situation #1 work but has been called</span>
01027 <span class="comment">                                from setup and needs to do some special</span>
01028 <span class="comment">                                work.</span>
01029 <span class="comment"></span>
01030 <span class="comment">        REG_INIT_BOOT_ACCEPTED_BASE + Num</span>
01031 <span class="comment">                        (where 0 &lt; Num &lt; 1000) - The routine has been called</span>
01032 <span class="comment">                                                 in situation #2. "Num" is the</span>
01033 <span class="comment">                                                 number of the control set</span>
01034 <span class="comment">                                                 to which the boot control set</span>
01035 <span class="comment">                                                 should be saved.</span>
01036 <span class="comment"></span>
01037 <span class="comment">Return Value:</span>
01038 <span class="comment"></span>
01039 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
01040 <span class="comment"></span>
01041 <span class="comment">        STATUS_SUCCESS - it worked</span>
01042 <span class="comment">        STATUS_ACCESS_DENIED - the routine has already done the work</span>
01043 <span class="comment">                               requested and will not do it again.</span>
01044 <span class="comment"></span>
01045 <span class="comment">--*/</span>
01046 {
01047     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
01048     BOOLEAN SetupBoot;
01049 
01050     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01051 <span class="preprocessor">#ifdef LOG_NT_API</span>
01052 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
01053         KdPrint((<span class="stringliteral">"NtInitializeRegistry()\n"</span>));
01054     }
01055 <span class="preprocessor">#endif</span>
01056 <span class="preprocessor"></span>
01057     <span class="comment">//</span>
01058     <span class="comment">// Force previous mode to be KernelMode</span>
01059     <span class="comment">//</span>
01060     <span class="keywordflow">if</span> (KeGetPreviousMode() == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
01061         <span class="keywordflow">return</span> ZwInitializeRegistry(BootCondition);
01062     } <span class="keywordflow">else</span> {
01063 
01064         <span class="comment">//</span>
01065         <span class="comment">// Check for a valid BootCondition value</span>
01066         <span class="comment">//</span>
01067 
01068         <span class="keywordflow">if</span>(BootCondition &gt; REG_INIT_MAX_VALID_CONDITION)
01069            <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01070 
01071         <span class="comment">//</span>
01072         <span class="comment">// Check for a Boot acceptance</span>
01073         <span class="comment">//</span>
01074 
01075         <span class="keywordflow">if</span>((BootCondition &gt;= REG_INIT_BOOT_ACCEPTED_BASE) &amp;&amp;
01076            (BootCondition &lt;= REG_INIT_BOOT_ACCEPTED_MAX))
01077         {
01078            <span class="comment">//</span>
01079            <span class="comment">// Make sure the Boot can be accepted only once</span>
01080            <span class="comment">//</span>
01081 
01082            <span class="keywordflow">if</span>(!<a class="code" href="../../d6/d0/cmdat_8c.html#a69">CmBootAcceptFirstTime</a>)
01083               <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01084 
01085            <a class="code" href="../../d6/d0/cmdat_8c.html#a69">CmBootAcceptFirstTime</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01086 
01087            <span class="comment">//</span>
01088            <span class="comment">// Calculate the control set we want to save</span>
01089            <span class="comment">// the boot control set to</span>
01090            <span class="comment">//</span>
01091 
01092            BootCondition -= REG_INIT_BOOT_ACCEPTED_BASE;
01093 
01094            <span class="keywordflow">if</span>(BootCondition)
01095            {
01096               <span class="comment">//</span>
01097               <span class="comment">// Valid control set number passed in.</span>
01098               <span class="comment">// Do the save.</span>
01099               <span class="comment">//</span>
01100 
01101               <span class="keywordflow">return</span> <a class="code" href="../../d1/d3/cmsysini_8c.html#a54">CmpSaveBootControlSet</a>(BootCondition);
01102            }
01103            <span class="keywordflow">else</span>
01104            {
01105               <span class="comment">//</span>
01106               <span class="comment">// 0 passed in as a control set number.</span>
01107               <span class="comment">// That is not valid, fail.</span>
01108               <span class="comment">//</span>
01109 
01110               <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01111            }
01112         }
01113 
01114         <span class="comment">// called from setup?</span>
01115 
01116         SetupBoot = (BootCondition == REG_INIT_BOOT_SETUP ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01117 
01118         <span class="comment">//</span>
01119         <span class="comment">// Fail if not first time called for situation #1 work.</span>
01120         <span class="comment">//</span>
01121 
01122         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/cmdat_8c.html#a68">CmFirstTime</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01123             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01124         }
01125         <a class="code" href="../../d6/d0/cmdat_8c.html#a68">CmFirstTime</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01126 
01127         <span class="comment">//</span>
01128         <span class="comment">// Wake up worker thread to do real work for us</span>
01129         <span class="comment">//</span>
01130 
01131         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a101">REG_CMD_INIT</a>;
01132         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o11">SetupBoot</a> = SetupBoot;
01133 
01134         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01135 
01136         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
01137         <a class="code" href="../../d1/d3/cmsysini_8c.html#a50">CmpSetVersionData</a>();
01138 
01139         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01140 
01141         <span class="comment">//</span>
01142         <span class="comment">// Notify PO that the volumes are usabled</span>
01143         <span class="comment">//</span>
01144         <a class="code" href="../../d1/d2/po_8h.html#a60">PoInitHiberServices</a>(SetupBoot);
01145 
01146         <span class="keywordflow">if</span> (!SetupBoot) {
01147             <a class="code" href="../../d2/d4/internal_8c.html#a18">IopCopyBootLogRegistryToFile</a>();
01148         }
01149 
01150         <span class="keywordflow">return</span> STATUS_SUCCESS;
01151     }
01152 }
01153 
01154 
01155 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01156"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a21">01156</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a21">NtNotifyChangeKey</a>(
01157     IN HANDLE KeyHandle,
01158     IN HANDLE Event OPTIONAL,
01159     IN PIO_APC_ROUTINE ApcRoutine OPTIONAL,
01160     IN PVOID ApcContext OPTIONAL,
01161     OUT PIO_STATUS_BLOCK IoStatusBlock,
01162     IN ULONG CompletionFilter,
01163     IN BOOLEAN WatchTree,
01164     OUT PVOID Buffer,
01165     IN ULONG BufferSize,
01166     IN BOOLEAN Asynchronous
01167     )
01168 <span class="comment">/*++</span>
01169 <span class="comment"></span>
01170 <span class="comment">Routine Description:</span>
01171 <span class="comment"></span>
01172 <span class="comment">    Notification of key creation, deletion, and modification may be</span>
01173 <span class="comment">    obtained by calling NtNotifyChangeKey.</span>
01174 <span class="comment"></span>
01175 <span class="comment">    NtNotifyChangeKey monitors changes to a key - if the key or</span>
01176 <span class="comment">    subtree specified by KeyHandle are modified, the service notifies</span>
01177 <span class="comment">    its caller.  It also returns the name(s) of the key(s) that changed.</span>
01178 <span class="comment">    All names are specified relative to the key that the handle represents</span>
01179 <span class="comment">    (therefore a NULL name represents that key).  The service completes</span>
01180 <span class="comment">    once the key or subtree has been modified based on the supplied</span>
01181 <span class="comment">    CompletionFilter.  The service is a "single shot" and therefore</span>
01182 <span class="comment">    needs to be reinvoked to watch the key for further changes.</span>
01183 <span class="comment"></span>
01184 <span class="comment">    The operation of this service begins by opening a key for KEY_NOTIFY</span>
01185 <span class="comment">    access.  Once the handle is returned, the NtNotifyChangeKey service</span>
01186 <span class="comment">    may be invoked to begin watching the values and subkeys of the</span>
01187 <span class="comment">    specified key for changes.  The first time the service is invoked,</span>
01188 <span class="comment">    the BufferSize parameter supplies not only the size of the user's</span>
01189 <span class="comment">    Buffer, but also the size of the buffer that will be used by the</span>
01190 <span class="comment">    Registry to store names of keys that have changed.  Likewise, the</span>
01191 <span class="comment">    CompletionFilter and WatchTree parameters on the first call indicate</span>
01192 <span class="comment">    how notification should operate for all calls using the supplied</span>
01193 <span class="comment">    KeyHandle.   These two parameters are ignored on subsequent calls</span>
01194 <span class="comment">    to the API with the same instance of KeyHandle.</span>
01195 <span class="comment"></span>
01196 <span class="comment">    Once a modification is made that should be reported, the Registry will</span>
01197 <span class="comment">    complete the service.  The names of the files that have changed since</span>
01198 <span class="comment">    the last time the service was called will be placed into the caller's</span>
01199 <span class="comment">    output Buffer.  The Information field of IoStatusBlock will contain</span>
01200 <span class="comment">    the number of bytes placed in Buffer, or zero if too many keys have</span>
01201 <span class="comment">    changed since the last time the service was called, in which case</span>
01202 <span class="comment">    the application must Query and Enumerate the key and sub keys to</span>
01203 <span class="comment">    discover changes.  The Status field of IoStatusBlock will contain</span>
01204 <span class="comment">    the actual status of the call.</span>
01205 <span class="comment"></span>
01206 <span class="comment">    If Asynchronous is TRUE, then Event, if specified, will be set to</span>
01207 <span class="comment">    the Signaled state.  If no Event parameter was specified, then</span>
01208 <span class="comment">    KeyHandle will be set to the Signaled state.  If an ApcRoutine</span>
01209 <span class="comment">    was specified, it is invoked with the ApcContext and the address of the</span>
01210 <span class="comment">    IoStatusBlock as its arguments.  If Asynchronous is FALSE, Event,</span>
01211 <span class="comment">    ApcRoutine, and ApcContext are ignored.</span>
01212 <span class="comment"></span>
01213 <span class="comment">    This service requires KEY_NOTIFY access to the key that was</span>
01214 <span class="comment">    actually modified</span>
01215 <span class="comment"></span>
01216 <span class="comment">    The notify "session" is terminated by closing KeyHandle.</span>
01217 <span class="comment"></span>
01218 <span class="comment">Arguments:</span>
01219 <span class="comment"></span>
01220 <span class="comment">    KeyHandle-- Supplies a handle to an open key.  This handle is</span>
01221 <span class="comment">        effectively the notify handle, because only one set of</span>
01222 <span class="comment">        notify parameters may be set against it.</span>
01223 <span class="comment"></span>
01224 <span class="comment">    Event - An optional handle to an event to be set to the</span>
01225 <span class="comment">        Signaled state when the operation completes.</span>
01226 <span class="comment"></span>
01227 <span class="comment">    ApcRoutine - An optional procedure to be invoked once the</span>
01228 <span class="comment">        operation completes.  For more information about this</span>
01229 <span class="comment">        parameter see the NtReadFile system service description.</span>
01230 <span class="comment"></span>
01231 <span class="comment">        If PreviousMode == Kernel, this parameter is an optional</span>
01232 <span class="comment">        pointer to a WORK_QUEUE_ITEM to be queued when the notify</span>
01233 <span class="comment">        is signaled.</span>
01234 <span class="comment"></span>
01235 <span class="comment">    ApcContext - A pointer to pass as an argument to the ApcRoutine,</span>
01236 <span class="comment">        if one was specified, when the operation completes.  This</span>
01237 <span class="comment">        argument is required if an ApcRoutine was specified.</span>
01238 <span class="comment"></span>
01239 <span class="comment">        If PreviousMode == Kernel, this parameter is an optional</span>
01240 <span class="comment">        WORK_QUEUE_TYPE describing the queue to be used. This argument</span>
01241 <span class="comment">        is required if an ApcRoutine was specified.</span>
01242 <span class="comment"></span>
01243 <span class="comment">    IoStatusBlock - A variable to receive the final completion status.</span>
01244 <span class="comment">        For more information about this parameter see the NtCreateFile</span>
01245 <span class="comment">        system service description.</span>
01246 <span class="comment"></span>
01247 <span class="comment">    CompletionFilter -- Specifies a set of flags that indicate the</span>
01248 <span class="comment">        types of operations on the key or its value that cause the</span>
01249 <span class="comment">        call to complete.  The following are valid flags for this parameter:</span>
01250 <span class="comment"></span>
01251 <span class="comment">        REG_NOTIFY_CHANGE_NAME -- Specifies that the call should be</span>
01252 <span class="comment">            completed if a subkey is added or deleted.</span>
01253 <span class="comment"></span>
01254 <span class="comment">        REG_NOTIFY_CHANGE_ATTRIBUTES -- Specifies that the call should</span>
01255 <span class="comment">            be completed if the attributes (e.g.: ACL) of the key or</span>
01256 <span class="comment">            any subkey are changed.</span>
01257 <span class="comment"></span>
01258 <span class="comment">        REG_NOTIFY_CHANGE_LAST_SET -- Specifies that the call should be</span>
01259 <span class="comment">            completed if the lastWriteTime of the key or any of its</span>
01260 <span class="comment">            subkeys is changed.  (Ie. if the value of the key or any</span>
01261 <span class="comment">            subkey is changed).</span>
01262 <span class="comment"></span>
01263 <span class="comment">        REG_NOTIFY_CHANGE_SECURITY -- Specifies that the call should be</span>
01264 <span class="comment">            completed if the security information (e.g. ACL) on the key</span>
01265 <span class="comment">            or any subkey is changed.</span>
01266 <span class="comment"></span>
01267 <span class="comment">    WatchTree -- A BOOLEAN value that, if TRUE, specifies that all</span>
01268 <span class="comment">        changes in the subtree of this key should also be reported.</span>
01269 <span class="comment">        If FALSE, only changes to this key, its value, and its immediate</span>
01270 <span class="comment">        subkeys (but not their values nor their subkeys) are reported.</span>
01271 <span class="comment"></span>
01272 <span class="comment">    Buffer -- A variable to receive the name(s) of the key(s) that</span>
01273 <span class="comment">        changed.  See REG_NOTIFY_INFORMATION.</span>
01274 <span class="comment"></span>
01275 <span class="comment">    BufferSize -- Specifies the length of Buffer.</span>
01276 <span class="comment"></span>
01277 <span class="comment">    Asynchronous  -- If FALSE, call will not return until</span>
01278 <span class="comment">        complete (synchronous) if TRUE, call may return STATUS_PENDING.</span>
01279 <span class="comment"></span>
01280 <span class="comment">Obs:</span>
01281 <span class="comment">    Since NtNotifyChangeMultipleKeys, this routine is kept only for bacwards compatibility</span>
01282 <span class="comment"></span>
01283 <span class="comment">Return Value:</span>
01284 <span class="comment"></span>
01285 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
01286 <span class="comment"></span>
01287 <span class="comment">        &lt;TBS&gt;</span>
01288 <span class="comment"></span>
01289 <span class="comment">--*/</span>
01290 {
01291     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01292 
01293     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtNotifyChangeKey\n"</span>));
01294 <span class="preprocessor">#ifdef LOG_NT_API</span>
01295 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
01296         KdPrint((<span class="stringliteral">"NtNotifyChangeKey(%d)\n"</span>,KeyHandle));
01297     }
01298 <span class="preprocessor">#endif</span>
01299 <span class="preprocessor"></span>
01300     <span class="comment">// Just call the wiser routine</span>
01301     <span class="keywordflow">return</span> <a class="code" href="../../d7/d7/ntapi_8c.html#a22">NtNotifyChangeMultipleKeys</a>(
01302                                         KeyHandle,          
01303                                         0,
01304                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01305                                         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
01306                                         ApcRoutine,
01307                                         ApcContext,
01308                                         IoStatusBlock,
01309                                         CompletionFilter,
01310                                         <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>,
01311                                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01312                                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
01313                                         Asynchronous
01314                                     );
01315 
01316 }
01317 
01318 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01319"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a22">01319</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a22">NtNotifyChangeMultipleKeys</a>(
01320     IN HANDLE MasterKeyHandle,          
01321     IN ULONG Count,
01322     IN OBJECT_ATTRIBUTES SlaveObjects[],
01323     IN HANDLE Event OPTIONAL,
01324     IN PIO_APC_ROUTINE ApcRoutine OPTIONAL,
01325     IN PVOID ApcContext OPTIONAL,
01326     OUT PIO_STATUS_BLOCK IoStatusBlock,
01327     IN ULONG CompletionFilter,
01328     IN BOOLEAN WatchTree,
01329     OUT PVOID Buffer,
01330     IN ULONG BufferSize,
01331     IN BOOLEAN Asynchronous
01332     )
01333 <span class="comment">/*++</span>
01334 <span class="comment"></span>
01335 <span class="comment">Routine Description:</span>
01336 <span class="comment"></span>
01337 <span class="comment">    Notificaion of creation, deletion and modification on multiple keys</span>
01338 <span class="comment">    may be obtained with NtNotifyChangeMultipleKeys.</span>
01339 <span class="comment"></span>
01340 <span class="comment">    NtNotifyMultipleKeys monitors changes to any of the MasterKeyHandle</span>
01341 <span class="comment">    or one of SlaveObjects and/or their subtrees, whichever occurs first.</span>
01342 <span class="comment">    When an event on these keys is triggered, the notification is considered</span>
01343 <span class="comment">    fulfilled, and has to be "armed" again, in order to watch for further</span>
01344 <span class="comment">    changes.</span>
01345 <span class="comment"></span>
01346 <span class="comment">    The mechanism is similar to the one described in NtNotifyChangeKey.</span>
01347 <span class="comment"></span>
01348 <span class="comment">    The MasterKeyHandle key, give the caller control over the lifetime</span>
01349 <span class="comment">    of the notification. The notification will live as long as the caller</span>
01350 <span class="comment">    keeps the MasterKeyHandle open, or an event is triggered.</span>
01351 <span class="comment"></span>
01352 <span class="comment">    The caller doesn't have to open the SlaveKeys. He will provide the</span>
01353 <span class="comment">    routine with an array of OBJECT_ATTRIBUTES, describing the slave objects.</span>
01354 <span class="comment">    The routine will open the objects, and ensure keep a reference on them</span>
01355 <span class="comment">    untill the back-end side will close them.</span>
01356 <span class="comment"></span>
01357 <span class="comment">    The notify "session" is terminated by closing MasterKeyHandle.</span>
01358 <span class="comment"></span>
01359 <span class="comment">Obs:</span>
01360 <span class="comment">    For the time being, the routine supports only one slave object. When more</span>
01361 <span class="comment">    than one slave object is provided, the routine will signal an error of</span>
01362 <span class="comment">    STATUS_INVALID_PARAMETER.</span>
01363 <span class="comment">    However, the interface is designed for future enhancements (taking an</span>
01364 <span class="comment">    array of slave objects), that may be provided with future versions(w2001).</span>
01365 <span class="comment"></span>
01366 <span class="comment">    When no slave object is supplied (i.e. Count == 0) we have the identical</span>
01367 <span class="comment">    behavior as for NtNotifyChangeKey.</span>
01368 <span class="comment"></span>
01369 <span class="comment">Arguments:</span>
01370 <span class="comment"></span>
01371 <span class="comment">    MasterKeyHandle - Supplies a handle to an open key.  This handle is</span>
01372 <span class="comment">        the "master handle". It has control overthe lifetime of the</span>
01373 <span class="comment">        notification.</span>
01374 <span class="comment"></span>
01375 <span class="comment">    Count - Number of slave objects. For the time being, this should be 1</span>
01376 <span class="comment"></span>
01377 <span class="comment">    SlaveObjects - Array of slave objects. Only the attributes of the</span>
01378 <span class="comment">        objects are provided, so the caller doesn't have to take care</span>
01379 <span class="comment">        of them.</span>
01380 <span class="comment"></span>
01381 <span class="comment">    Event,ApcRoutine,ApcContext,IoStatusBlock,CompletionFilter,WatchTree,</span>
01382 <span class="comment">    Buffer,BufferSize,Asynchronous - same as for NtNotifyChangeKey</span>
01383 <span class="comment"></span>
01384 <span class="comment">Return Value:</span>
01385 <span class="comment"></span>
01386 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
01387 <span class="comment"></span>
01388 <span class="comment">        &lt;TBS&gt;</span>
01389 <span class="comment"></span>
01390 <span class="comment">--*/</span>
01391 {
01392     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
01393     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            WaitStatus;
01394     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>     PreviousMode;
01395     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>        MasterKeyBody;
01396     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>        SlaveKeyBody;
01397     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>             UserEvent=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01398     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      MasterPostBlock;
01399     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>      SlavePostBlock;
01400     KIRQL               OldIrql;
01401     HANDLE              SlaveKeyHandle;
01402     <a class="code" href="../../d1/d2/cmp_8h.html#a166">POST_BLOCK_TYPE</a>     PostType = <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>;
01403     BOOLEAN             SlavePresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// assume that we are in the NtNotifyChangeKey case</span>
01404 <span class="preprocessor">#if defined(_WIN64)</span>
01405 <span class="preprocessor"></span>    BOOLEAN             UseIosb32=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">// If the caller is a 32bit process on sundown and previous mode</span>
01406                                          <span class="comment">// is user mode, use a 32bit IoSb.</span>
01407 <span class="preprocessor">#endif</span>
01408 <span class="preprocessor"></span>
01409     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01410 
01411     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
01412 
01413     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtNotifyChangeMultipleKeys\n"</span>));
01414 
01415     <span class="keywordflow">if</span>(<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; 1) {
01416         <span class="comment">//</span>
01417         <span class="comment">// This version supports only one slave object</span>
01418         <span class="comment">//</span>
01419         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01420     }
01421 
01422     <span class="keywordflow">if</span>(<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 1) {
01423         <span class="comment">//</span>
01424         <span class="comment">// We have one slave, so we are in the NtNotifyChangeMultipleKeys case</span>
01425         <span class="comment">//</span>
01426         SlavePresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01427     }
01428 
01429 <span class="preprocessor">#ifdef LOG_NT_API</span>
01430 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi &amp;&amp; SlavePresent) {
01431         KdPrint((<span class="stringliteral">"NtNotifyChangeMultipleKeys(%d,%wZ relative to %d, Asynchronous = %d)\n"</span>,MasterKeyHandle,SlaveObjects-&gt;ObjectName,SlaveObjects-&gt;RootDirectory,(<span class="keywordtype">int</span>)Asynchronous));
01432     }
01433 <span class="preprocessor">#endif</span>
01434 <span class="preprocessor"></span>
01435     <span class="comment">//</span>
01436     <span class="comment">// Threads that are attached give us real grief, so disallow it.</span>
01437     <span class="comment">//</span>
01438     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a25">KeIsAttachedProcess</a>()) {
01439         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR,8,1,0,0);
01440     }
01441 
01442     <span class="comment">//</span>
01443     <span class="comment">// Probe user buffer parameters.</span>
01444     <span class="comment">//</span>
01445     PreviousMode = KeGetPreviousMode();
01446     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01447 
01448 <span class="preprocessor">#if defined(_WIN64)</span>
01449 <span class="preprocessor"></span>        <span class="comment">// Process is 32bit if Wow64 is not NULL.</span>
01450         UseIosb32 = (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01451 <span class="preprocessor">#endif</span>
01452 <span class="preprocessor"></span>
01453         <span class="keywordflow">try</span> {
01454 
01455             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
01456                 IoStatusBlock,
01457 #<span class="keywordflow">if</span> defined(_WIN64)
01458                 UseIosb32 ? <span class="keyword">sizeof</span>(IO_STATUS_BLOCK32) : <span class="keyword">sizeof</span>(IO_STATUS_BLOCK),
01459 #<span class="keywordflow">else</span>
01460                 <span class="keyword">sizeof</span>(IO_STATUS_BLOCK),
01461 #endif
01462                 <span class="keyword">sizeof</span>(ULONG)
01463                 );
01464 
01465 
01466             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>, <span class="keyword">sizeof</span>(ULONG));
01467 
01468             <span class="comment">//</span>
01469             <span class="comment">// Initialize IOSB</span>
01470             <span class="comment">//</span>
01471 
01472             <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(IoStatusBlock, STATUS_PENDING, 0, UseIosb32);
01473         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01474             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01475                 KdPrint((<span class="stringliteral">"!!NtChangeNotifyMultipleKeys: code:%08lx\n"</span>, GetExceptionCode()));
01476             }
01477             <span class="keywordflow">return</span> GetExceptionCode();
01478         }
01479         <span class="keywordflow">if</span> (Asynchronous) {
01480             PostType = <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>;
01481         }
01482     } <span class="keywordflow">else</span> {
01483         <span class="keywordflow">if</span> (Asynchronous) {
01484             PostType = <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>;
01485                         <span class="keywordflow">if</span>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; 0 ) {
01486                 <span class="comment">//</span>
01487                 <span class="comment">// we don't allow multiple asyncronous kernel notifications</span>
01488                 <span class="comment">//</span>
01489                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01490                         }
01491         }
01492     }
01493 
01494     <span class="comment">//</span>
01495     <span class="comment">// Check filter</span>
01496     <span class="comment">//</span>
01497     <span class="keywordflow">if</span> (CompletionFilter != (CompletionFilter &amp; REG_LEGAL_CHANGE_FILTER)) {
01498         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01499     }
01500 
01501     <span class="comment">//</span>
01502     <span class="comment">// Reference the Master Key handle</span>
01503     <span class="comment">//</span>
01504     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01505                 MasterKeyHandle,
01506                 KEY_NOTIFY,
01507                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
01508                 PreviousMode,
01509                 (PVOID *)(&amp;MasterKeyBody),
01510                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01511                 );
01512     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01513         <span class="keywordflow">return</span> status;
01514     }
01515 
01516     <span class="keywordflow">if</span>(SlavePresent) {
01517         <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
01518         <span class="comment">//</span>
01519         <span class="comment">// Open the slave object and add a reference to it.</span>
01520         <span class="comment">//</span>
01521         <span class="keywordflow">try</span> {
01522 
01523             status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(SlaveObjects,
01524                                         <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
01525                                         PreviousMode,
01526                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01527                                         KEY_NOTIFY,
01528                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01529                                         &amp;SlaveKeyHandle);
01530             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01531                 status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(SlaveKeyHandle,
01532                                                    KEY_NOTIFY,
01533                                                    <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
01534                                                    PreviousMode,
01535                                                    (PVOID *)&amp;SlaveKeyBody,
01536                                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01537                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SlaveKeyHandle);
01538 
01539             }
01540 
01541         } except (<a class="code" href="../../d7/d7/ntapi_8c.html#a1">CmpExceptionFilter</a>(GetExceptionInformation())) {
01542             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01543                 KdPrint((<span class="stringliteral">"!!NtNotifyChangeMultipleKeys: code:%08lx\n"</span>, GetExceptionCode()));
01544             }
01545             status = GetExceptionCode();
01546         }
01547 
01548         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01549 
01550         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01551             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01552             <span class="keywordflow">return</span> status;
01553         }
01554 
01555         <span class="comment">//</span>
01556         <span class="comment">// Reject calls setting with keys on the same hive as they could lead to obscure deadlocks</span>
01557         <span class="comment">//</span>
01558         <span class="keywordflow">if</span>( MasterKeyBody-&gt;KeyControlBlock-&gt;KeyHive == SlaveKeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> ) {
01559             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SlaveKeyBody);
01560             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01561             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01562         }
01563     }
01564 
01565 
01566     <span class="comment">//</span>
01567     <span class="comment">// Allocate master and slave post blocks, and init it.  Do NOT put it on the chain,</span>
01568     <span class="comment">// CmNotifyChangeKey will do that while holding a mutex.</span>
01569     <span class="comment">//</span>
01570     <span class="comment">// WARNING: PostBlocks MUST BE ALLOCATED from Pool, since back side</span>
01571     <span class="comment">//          of Notify will free it!</span>
01572     <span class="comment">//</span>
01573     <span class="comment">//</span>
01574     <span class="comment">// Exclusively lock the registry; We want nobody to mess with it while we are doing the</span>
01575     <span class="comment">// post/notify list manipulation; what else could be safer than that :-)</span>
01576     <span class="comment">//</span>
01577     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01578     MasterPostBlock = <a class="code" href="../../d1/d2/cmp_8h.html#a122">CmpAllocateMasterPostBlock</a>(PostType);
01579     <span class="keywordflow">if</span> (MasterPostBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01580         <span class="keywordflow">if</span>(SlavePresent) {
01581             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SlaveKeyBody);
01582         }
01583         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01584         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01585         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01586     }
01587 
01588 <span class="preprocessor">#if DBG</span>
01589 <span class="preprocessor"></span>    MasterPostBlock-&gt;TraceIntoDebugger = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01590 <span class="preprocessor">#endif</span>
01591 <span class="preprocessor"></span>
01592     <span class="keywordflow">if</span>(SlavePresent) {
01593         SlavePostBlock = <a class="code" href="../../d1/d2/cmp_8h.html#a123">CmpAllocateSlavePostBlock</a>(PostType,SlaveKeyBody,MasterPostBlock);
01594         <span class="keywordflow">if</span> (SlavePostBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01595             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SlaveKeyBody);
01596             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01597             <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01598             <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01599             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01600         }
01601 
01602 <span class="preprocessor">#if DBG</span>
01603 <span class="preprocessor"></span>        SlavePostBlock-&gt;TraceIntoDebugger = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01604 <span class="preprocessor">#endif</span>
01605 <span class="preprocessor"></span>    }
01606 
01607     <span class="keywordflow">if</span> ((PostType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>) ||
01608         (PostType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>)) {
01609 
01610         <span class="comment">//</span>
01611         <span class="comment">// If event is present, reference it, save its address, and set</span>
01612         <span class="comment">// it to the not signaled state.</span>
01613         <span class="comment">//</span>
01614         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>)) {
01615             status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01616                             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
01617                             EVENT_MODIFY_STATE,
01618                             <a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
01619                             PreviousMode,
01620                             (PVOID *)(&amp;UserEvent),
01621                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01622                             );
01623             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01624                 <span class="keywordflow">if</span>(SlavePresent) {
01625                     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01626                     <span class="comment">// SlaveKeyBody is dereferenced in CmpFreePostBlock(SlavePostBlock)</span>
01627                 }
01628                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01629                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01630                 <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01631                 <span class="keywordflow">return</span> status;
01632             } <span class="keywordflow">else</span> {
01633                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(UserEvent);
01634             }
01635         }
01636 
01637         <span class="keywordflow">if</span> (PostType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>) {
01638             <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>     ApcMode;
01639 
01640             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o2">IoStatusBlock</a> = IoStatusBlock;
01641             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o0">UserEvent</a> = UserEvent;
01642             <span class="comment">//</span>
01643             <span class="comment">// Initialize APC.  May or may not be a user apc, will always</span>
01644             <span class="comment">// be a kernel apc.</span>
01645             <span class="comment">//</span>
01646             ApcMode = PreviousMode;
01647             <span class="keywordflow">if</span>( ApcRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01648                 ApcRoutine = (PIO_APC_ROUTINE)<a class="code" href="../../d0/d2/cmnotify_8c.html#a8">CmpDummyApc</a>;
01649                 ApcMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
01650             }
01651             <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o1">AsyncUser</a>.<a class="code" href="../../d1/d3/struct__CM__ASYNC__USER__POST__BLOCK.html#o1">Apc</a>,
01652                             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(),
01653                             <a class="code" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>,
01654                             (<a class="code" href="../../d0/d9/ntosdef_8h.html#a42">PKKERNEL_ROUTINE</a>)<a class="code" href="../../d0/d2/cmnotify_8c.html#a11">CmpPostApc</a>,
01655                             (<a class="code" href="../../d0/d9/ntosdef_8h.html#a43">PKRUNDOWN_ROUTINE</a>)<a class="code" href="../../d0/d2/cmnotify_8c.html#a12">CmpPostApcRunDown</a>,
01656                             (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)ApcRoutine,
01657                             ApcMode,
01658                             ApcContext);
01659 
01660         } <span class="keywordflow">else</span> {
01661             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o0">Event</a> = UserEvent;
01662             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o1">WorkItem</a> = (<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>)ApcRoutine;
01663             MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o2">AsyncKernel</a>.<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html#o2">QueueType</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a>)((ULONG_PTR)ApcContext);
01664         }
01665     }
01666 
01667 
01668     <span class="comment">//</span>
01669     <span class="comment">// Call worker for master</span>
01670     <span class="comment">//</span>
01671     status = <a class="code" href="../../d1/d2/cmp_8h.html#a239">CmpNotifyChangeKey</a>(
01672                 MasterKeyBody,
01673                 MasterPostBlock,
01674                 CompletionFilter,
01675                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>,
01676                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01677                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
01678                 MasterPostBlock
01679                 );
01680     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01681         <span class="comment">//</span>
01682         <span class="comment">// it didn't work, clean up for error path</span>
01683         <span class="comment">//</span>
01684         <span class="keywordflow">if</span> (UserEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01685             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(UserEvent);
01686         }
01687 
01688         <span class="keywordflow">if</span>(SlavePresent) {
01689             <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01690             <span class="comment">// SlaveKeyBody is dereferenced in CmpFreePostBlock(SlavePostBlock)</span>
01691         }
01692         <span class="comment">// MasterPostBlock if freed by CmpNotifyChangeKey !!!</span>
01693         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01694         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01695         <span class="keywordflow">return</span> status;
01696 
01697     }
01698 
01699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_PENDING || status == STATUS_SUCCESS);
01700 
01701     <span class="keywordflow">if</span>(SlavePresent) {
01702         <span class="keywordflow">if</span>( status == STATUS_SUCCESS ) {
01703             <span class="comment">//</span>
01704             <span class="comment">// The notify has already been triggered for the master, there is no point to set one for the slave too</span>
01705             <span class="comment">// Clean up the mess we made for the slave object and signal as there is no slave present</span>
01706             <span class="comment">//</span>
01707             <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01708             SlavePresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01709         } <span class="keywordflow">else</span> {
01710             <span class="comment">//</span>
01711             <span class="comment">// Call worker for slave</span>
01712             <span class="comment">//</span>
01713             status = <a class="code" href="../../d1/d2/cmp_8h.html#a239">CmpNotifyChangeKey</a>(
01714                         SlaveKeyBody,
01715                         SlavePostBlock,
01716                         CompletionFilter,
01717                         <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>,
01718                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01719                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
01720                         MasterPostBlock
01721                         );
01722             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01723                 <span class="comment">//</span>
01724                 <span class="comment">// if we are here, the slave key has been deleted in between or there was no memory available to allocate</span>
01725                 <span class="comment">// a notify block for the slave key. We do the cleanup here since we already hold the registry lock</span>
01726                 <span class="comment">// exclusively and we don't want to give a anybody else a chance to trigger the notification on master post</span>
01727                 <span class="comment">// (otherwise we could end up freeing it twice). The master post block and the user event are cleaned later,</span>
01728                 <span class="comment">// covering both single and multiple notifications cases</span>
01729                 <span class="comment">//</span>
01730 
01731                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01732                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01733 
01734                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
01735                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01736                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01737                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01738             }
01739         }
01740     }
01741 
01742     <span class="comment">//</span>
01743     <span class="comment">// postblocks are now on various lists, so we can die without losing them</span>
01744     <span class="comment">//</span>
01745     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01746 
01747     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01748         <span class="comment">//</span>
01749         <span class="comment">// success.  wait for event if sync.</span>
01750         <span class="comment">// do NOT deref User event, back side of notify will do that.</span>
01751         <span class="comment">//</span>
01752         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_PENDING || status == STATUS_SUCCESS);
01753 
01754         <span class="keywordflow">if</span> (PostType == <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>) {
01755             WaitStatus = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o0">SystemEvent</a>,
01756                                                <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
01757                                                PreviousMode,
01758                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01759                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01760 
01761 
01762             <span class="keywordflow">if</span> ((WaitStatus==STATUS_ALERTED) || (WaitStatus == STATUS_USER_APC)) {
01763 
01764                 <span class="comment">//</span>
01765                 <span class="comment">// The wait was aborted, clean up and return.</span>
01766                 <span class="comment">//</span>
01767                 <span class="comment">// 1. Remove the PostBlocks from the notify list.  This</span>
01768                 <span class="comment">//    is normally done by the back end of notify, but</span>
01769                 <span class="comment">//    we have to do it here since the back end is not</span>
01770                 <span class="comment">//    involved.</span>
01771                 <span class="comment">// 2. Delist and free the post blocks</span>
01772                 <span class="comment">//</span>
01773                 <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01774 
01775                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
01776                 <span class="keywordflow">if</span>(SlavePresent) {
01777                     <span class="keywordflow">if</span> (SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01778                         <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01779                         <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01780                     }
01781                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01782                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01783                 }
01784 
01785                 <span class="keywordflow">if</span> (MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01786                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01787                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01788                 }
01789                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01790                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01791                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01792 
01793                 <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01794 
01795                 <span class="keywordflow">if</span>(SlavePresent) {
01796                     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01797                 }
01798                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01799 
01800                 status = WaitStatus;
01801 
01802             } <span class="keywordflow">else</span> {
01803                 <span class="comment">//</span>
01804                 <span class="comment">// The wait was satisfied, which means the back end has</span>
01805                 <span class="comment">// already removed the postblock from the notify list.</span>
01806                 <span class="comment">// We just have to delist and free the post block.</span>
01807                 <span class="comment">//</span>
01808 
01809                 <span class="comment">//</span>
01810                 <span class="comment">// Aquire the registry lock exclusive to enter the post block rule prerequisites</span>
01811                 <span class="comment">//</span>
01812                 <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01813 
01814                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
01815                 <span class="keywordflow">if</span>(SlavePresent) {
01816                     <span class="keywordflow">if</span> (SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01817                         <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01818                         <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01819                     }
01820                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01821                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(SlavePostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01822                 }
01823 
01824                 <span class="keywordflow">if</span> (MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01825                     <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01826                     <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o0">NotifyList</a>));
01827                 }
01828                 <span class="comment">// Use Cmp variant to protect for multiple deletion of the same object</span>
01829                 <a class="code" href="../../d1/d2/cmp_8h.html#a1">CmpRemoveEntryList</a>(&amp;(MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o1">ThreadList</a>));
01830                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
01831 
01832                 <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01833 
01834                 status = MasterPostBlock-&gt;<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html#o5">u</a>-&gt;<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html#o0">Sync</a>.<a class="code" href="../../d7/d6/struct__CM__SYNC__POST__BLOCK.html#o1">Status</a>;
01835 
01836                 <span class="keywordflow">try</span> {
01837                     <a class="code" href="../../d1/d2/cmp_8h.html#a151">CmpSetIoStatus</a>(IoStatusBlock, status, 0, UseIosb32);
01838                 } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01839                     status = GetExceptionCode();
01840                 }
01841 
01842                 <span class="keywordflow">if</span>(SlavePresent) {
01843                     <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(SlavePostBlock);
01844                 }
01845                 <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01846             }
01847         }
01848 
01849     } <span class="keywordflow">else</span> {
01850         <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(MasterPostBlock);
01851         <span class="comment">//</span>
01852         <span class="comment">// it didn't work, clean up for error path</span>
01853         <span class="comment">//</span>
01854         <span class="keywordflow">if</span> (UserEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01855             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(UserEvent);
01856         }
01857     }
01858 
01859     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MasterKeyBody);
01860     <span class="comment">//</span>
01861     <span class="comment">// Don't dereference SlaveKeyBody!!! =&gt; Back-end routine will do that !!!</span>
01862     <span class="comment">//</span>
01863 
01864     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
01865 
01866     <span class="keywordflow">return</span> status;
01867 }
01868 
01869 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01870"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a23">01870</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
01871     OUT PHANDLE KeyHandle,
01872     IN ACCESS_MASK DesiredAccess,
01873     IN POBJECT_ATTRIBUTES ObjectAttributes
01874     )
01875 <span class="comment">/*++</span>
01876 <span class="comment"></span>
01877 <span class="comment">Routine Description:</span>
01878 <span class="comment"></span>
01879 <span class="comment">    A registry key which already exists may be opened with NtOpenKey.</span>
01880 <span class="comment"></span>
01881 <span class="comment">    Share access is computed from desired access.</span>
01882 <span class="comment"></span>
01883 <span class="comment">Arguments:</span>
01884 <span class="comment"></span>
01885 <span class="comment">    KeyHandle - Receives a  Handle which is used to access the</span>
01886 <span class="comment">        specified key in the Registration Database.</span>
01887 <span class="comment"></span>
01888 <span class="comment">    DesiredAccess - Specifies the access rights desired.</span>
01889 <span class="comment"></span>
01890 <span class="comment">    ObjectAttributes - Specifies the attributes of the key being opened.</span>
01891 <span class="comment">        Note that a key name must be specified.  If a Root Directory</span>
01892 <span class="comment">        is specified, the name is relative to the root.  The name of</span>
01893 <span class="comment">        the object must be within the name space allocated to the</span>
01894 <span class="comment">        Registry, that is, all names beginning "\Registry".  RootHandle,</span>
01895 <span class="comment">        if present, must be a handle to "\", or "\Registry", or a</span>
01896 <span class="comment">        key under "\Registry".  If the specified key does not exist, or</span>
01897 <span class="comment">        access requested is not allowed, the operation will fail.</span>
01898 <span class="comment"></span>
01899 <span class="comment">        NOTE:   Object manager will capture and probe this argument.</span>
01900 <span class="comment"></span>
01901 <span class="comment">Return Value:</span>
01902 <span class="comment"></span>
01903 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
01904 <span class="comment"></span>
01905 <span class="comment">        &lt;TBS&gt;</span>
01906 <span class="comment"></span>
01907 <span class="comment">--*/</span>
01908 {
01909     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
01910     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
01911     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
01912     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> =0;
01913     UNICODE_STRING CapturedObjectName = {0};
01914 
01915     <span class="comment">// Start registry call tracing</span>
01916     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
01917 
01918     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01919 
01920     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
01921 
01922     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtOpenKey\n"</span>));
01923     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
01924         KdPrint((<span class="stringliteral">"\tDesiredAccess=%08lx "</span>, DesiredAccess));
01925         KdPrint((<span class="stringliteral">"\tRootHandle=%08lx\n"</span>, <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;RootDirectory));
01926         KdPrint((<span class="stringliteral">"\tName='%wZ'\n"</span>, <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName));
01927     }
01928 
01929     mode = KeGetPreviousMode();
01930 
01931     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
01932 
01933 <span class="preprocessor">#ifdef LOG_NT_API</span>
01934 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
01935         KdPrint((<span class="stringliteral">"NtOpenKey %wZ relative to %d..."</span>,
01936                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName,
01937                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;RootDirectory));
01938     }
01939 <span class="preprocessor">#endif</span>
01940 <span class="preprocessor"></span>
01941     <span class="keywordflow">try</span> {
01942 
01943         <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
01944             <a class="code" href="../../d5/d8/ex_8h.html#a36">ProbeAndZeroHandle</a>(KeyHandle);
01945             <span class="comment">//</span>
01946             <span class="comment">// probe the ObjectAttributes as we shall use it for tracing</span>
01947             <span class="comment">//</span>
01948             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01949                           <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES),
01950                           PROBE_ALIGNMENT(OBJECT_ATTRIBUTES) );
01951             CapturedObjectName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName);
01952             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01953                 CapturedObjectName.Buffer,
01954                 CapturedObjectName.Length,
01955                 <span class="keyword">sizeof</span>(WCHAR)
01956                 );
01957 
01958         } <span class="keywordflow">else</span> {
01959             CapturedObjectName = *(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName);
01960         }
01961 
01962         status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(
01963                     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01964                     <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
01965                     mode,
01966                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01967                     DesiredAccess,
01968                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01969                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
01970                     );
01971         <span class="keywordflow">if</span> (status==STATUS_PREDEFINED_HANDLE) {
01972             status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
01973                                                0,
01974                                                <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
01975                                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01976                                                (PVOID *)(&amp;KeyBody),
01977                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01978             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01979                 *KeyHandle = (HANDLE)LongToHandle(KeyBody-&gt;Type);
01980                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
01981                 status = STATUS_SUCCESS;
01982             }
01983             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
01984             <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = *KeyHandle;
01985         } <span class="keywordflow">else</span>
01986         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01987             *KeyHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01988         }
01989 
01990     } except (<a class="code" href="../../d7/d7/ntapi_8c.html#a1">CmpExceptionFilter</a>(GetExceptionInformation())) {
01991         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01992             KdPrint((<span class="stringliteral">"!!NtOpenKey: code:%08lx\n"</span>, GetExceptionCode()));
01993         }
01994         status = GetExceptionCode();
01995     }
01996 <span class="preprocessor">#ifdef LOG_NT_API</span>
01997 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
01998         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01999             KdPrint((<span class="stringliteral">"succeeded %d\n"</span>,<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>));
02000         } <span class="keywordflow">else</span> {
02001             KdPrint((<span class="stringliteral">"failed %08lx\n"</span>,status));
02002         }
02003     }
02004 <span class="preprocessor">#endif</span>
02005 <span class="preprocessor"></span>
02006     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02007 
02008     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02009 
02010         <span class="comment">// End registry call tracing</span>
02011         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,&amp;CapturedObjectName,EVENT_TRACE_TYPE_REGOPEN);
02012 
02013     <span class="keywordflow">return</span>  status;
02014 }
02015 
02016 
02017 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02018"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a24">02018</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(
02019     IN HANDLE KeyHandle,
02020     IN KEY_INFORMATION_CLASS KeyInformationClass,
02021     IN PVOID KeyInformation,
02022     IN ULONG Length,
02023     IN PULONG ResultLength
02024     )
02025 <span class="comment">/*++</span>
02026 <span class="comment"></span>
02027 <span class="comment">Routine Description:</span>
02028 <span class="comment"></span>
02029 <span class="comment">    Data about the class of a key, and the numbers and sizes of its</span>
02030 <span class="comment">    children and value entries may be queried with NtQueryKey.</span>
02031 <span class="comment"></span>
02032 <span class="comment">    If KeyValueInformation is not long enough to hold all requested data,</span>
02033 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
02034 <span class="comment">    set to the number of bytes actually required.</span>
02035 <span class="comment"></span>
02036 <span class="comment">    NOTE: The returned lengths are guaranteed to be at least as</span>
02037 <span class="comment">          long as the described values, but may be longer in</span>
02038 <span class="comment">          some circumstances.</span>
02039 <span class="comment"></span>
02040 <span class="comment">Arguments:</span>
02041 <span class="comment"></span>
02042 <span class="comment">    KeyHandle - Handle of the key to query data for.  Must have been</span>
02043 <span class="comment">        opened for KEY_QUERY_KEY access.</span>
02044 <span class="comment"></span>
02045 <span class="comment">    KeyInformationClass - Specifies the type of information</span>
02046 <span class="comment">        returned in Buffer.  One of the following types:</span>
02047 <span class="comment"></span>
02048 <span class="comment">        KeyBasicInformation - return last write time, title index, and name.</span>
02049 <span class="comment">            (See KEY_BASIC_INFORMATION)</span>
02050 <span class="comment"></span>
02051 <span class="comment">        KeyNodeInformation - return last write time, title index, name, class.</span>
02052 <span class="comment">            (See KEY_NODE_INFORMATION)</span>
02053 <span class="comment"></span>
02054 <span class="comment">        KeyFullInformation - return all data except for name and security.</span>
02055 <span class="comment">            (See KEY_FULL_INFORMATION)</span>
02056 <span class="comment"></span>
02057 <span class="comment">    KeyInformation -Supplies pointer to buffer to receive the data.</span>
02058 <span class="comment"></span>
02059 <span class="comment">    Length - Length of KeyInformation in bytes.</span>
02060 <span class="comment"></span>
02061 <span class="comment">    ResultLength - Number of bytes actually written into KeyInformation.</span>
02062 <span class="comment"></span>
02063 <span class="comment">Return Value:</span>
02064 <span class="comment"></span>
02065 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
02066 <span class="comment"></span>
02067 <span class="comment">        &lt;TBS&gt;</span>
02068 <span class="comment"></span>
02069 <span class="comment">--*/</span>
02070 {
02071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02072     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02073     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02074 
02075     <span class="comment">// Start registry call tracing</span>
02076     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
02077 
02078     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02079 
02080     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02081 
02082     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtQueryKey\n"</span>));
02083 <span class="preprocessor">#ifdef LOG_NT_API</span>
02084 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02085         KdPrint((<span class="stringliteral">"NtQueryKey %d %d\n"</span>,KeyHandle,KeyInformationClass));
02086     }
02087 <span class="preprocessor">#endif</span>
02088 <span class="preprocessor"></span>
02089     <span class="keywordflow">if</span> ((KeyInformationClass != KeyBasicInformation) &amp;&amp;
02090         (KeyInformationClass != KeyNodeInformation)  &amp;&amp;
02091         (KeyInformationClass != KeyFullInformation)  &amp;&amp;
02092         (KeyInformationClass != KeyNameInformation) )
02093     {
02094 
02095         <span class="comment">// End registry call tracing</span>
02096         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_PARAMETER,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGQUERY);
02097 
02098         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02099     }
02100 
02101     mode = KeGetPreviousMode();
02102 
02103     <span class="keywordflow">if</span>( KeyInformationClass == KeyNameInformation ){
02104         <span class="comment">//</span>
02105         <span class="comment">// special case: name information is available regardless of the access level</span>
02106         <span class="comment">// you have on the key  (provided that you have some ...)</span>
02107         <span class="comment">//</span>
02108 
02109         <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInfo;
02110 
02111         <span class="comment">// reference with "no access required"</span>
02112         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02113                 KeyHandle,
02114                 0,
02115                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02116                 mode,
02117                 (PVOID *)(&amp;KeyBody),
02118                 &amp;HandleInfo
02119                 );
02120         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
02121             <span class="keywordflow">if</span>( HandleInfo.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a> == 0 ) {
02122                 <span class="comment">//</span>
02123                 <span class="comment">// no access is granted on the handle; bad luck!</span>
02124                 <span class="comment">//</span>
02125                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02126 
02127                 status = STATUS_ACCESS_DENIED;
02128             }
02129         }
02130     } <span class="keywordflow">else</span> {
02131         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02132                 KeyHandle,
02133                 KEY_QUERY_VALUE,
02134                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02135                 mode,
02136                 (PVOID *)(&amp;KeyBody),
02137                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02138                 );
02139     }
02140 
02141     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02142 
02143         <span class="keywordflow">try</span> {
02144             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02145                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
02146                     KeyInformation,
02147                     Length,
02148                     <span class="keyword">sizeof</span>(ULONG)
02149                     );
02150                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ResultLength);
02151             }
02152 
02153         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02154             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
02155                 KdPrint((<span class="stringliteral">"!!NtQueryKey: code:%08lx\n"</span>, GetExceptionCode()));
02156             }
02157             status = GetExceptionCode();
02158         }
02159 
02160         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02161             <span class="comment">//</span>
02162             <span class="comment">// CmQueryKey is protected to user mode buffer exceptions</span>
02163             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
02164             <span class="comment">//</span>
02165             status = <a class="code" href="../../d1/d2/cmp_8h.html#a229">CmQueryKey</a>(
02166                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
02167                         KeyInformationClass,
02168                         KeyInformation,
02169                         Length,
02170                         ResultLength
02171                         );
02172         }
02173 
02174         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02175     }
02176 
02177     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02178 
02179     <span class="comment">// End registry call tracing</span>
02180     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGQUERY);
02181 
02182     <span class="keywordflow">return</span> status;
02183 }
02184 
02185 
02186 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02187"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a25">02187</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
02188     IN HANDLE KeyHandle,
02189     IN PUNICODE_STRING ValueName,
02190     IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,
02191     IN PVOID KeyValueInformation,
02192     IN ULONG Length,
02193     IN PULONG ResultLength
02194     )
02195 <span class="comment">/*++</span>
02196 <span class="comment"></span>
02197 <span class="comment">Routine Description:</span>
02198 <span class="comment"></span>
02199 <span class="comment">    The ValueName, TitleIndex, Type, and Data for any one of a key's</span>
02200 <span class="comment">    value entries may be queried with NtQueryValueKey.</span>
02201 <span class="comment"></span>
02202 <span class="comment">    If KeyValueInformation is not long enough to hold all requested data,</span>
02203 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
02204 <span class="comment">    set to the number of bytes actually required.</span>
02205 <span class="comment"></span>
02206 <span class="comment">Arguments:</span>
02207 <span class="comment"></span>
02208 <span class="comment">    KeyHandle - Handle of the key whose value entries are to be</span>
02209 <span class="comment">        enumerated.  Must be open for KEY_QUERY_VALUE access.</span>
02210 <span class="comment"></span>
02211 <span class="comment">    Index - Specifies the (0-based) number of the sub key to be returned.</span>
02212 <span class="comment"></span>
02213 <span class="comment">    ValueName  - The name of the value entry to return data for.</span>
02214 <span class="comment"></span>
02215 <span class="comment">    KeyValueInformationClass - Specifies the type of information</span>
02216 <span class="comment">        returned in KeyValueInformation.  One of the following types:</span>
02217 <span class="comment"></span>
02218 <span class="comment">        KeyValueBasicInformation - return time of last write, title</span>
02219 <span class="comment">            index, and name.  (See KEY_VALUE_BASIC_INFORMATION)</span>
02220 <span class="comment"></span>
02221 <span class="comment">        KeyValueFullInformation - return time of last write, title</span>
02222 <span class="comment">            index, name, class.  (See KEY_VALUE_FULL_INFORMATION)</span>
02223 <span class="comment"></span>
02224 <span class="comment">    KeyValueInformation -Supplies pointer to buffer to receive the data.</span>
02225 <span class="comment"></span>
02226 <span class="comment">    Length - Length of KeyValueInformation in bytes.</span>
02227 <span class="comment"></span>
02228 <span class="comment">    ResultLength - Number of bytes actually written into KeyValueInformation.</span>
02229 <span class="comment"></span>
02230 <span class="comment">Return Value:</span>
02231 <span class="comment"></span>
02232 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
02233 <span class="comment"></span>
02234 <span class="comment">        &lt;TBS&gt;</span>
02235 <span class="comment"></span>
02236 <span class="comment">    TMP: The IopQueryRegsitryValues() routine in the IO system assumes</span>
02237 <span class="comment">         STATUS_OBJECT_NAME_NOT_FOUND is returned if the value being queried</span>
02238 <span class="comment">         for does not exist.</span>
02239 <span class="comment"></span>
02240 <span class="comment">--*/</span>
02241 {
02242     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02243     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02244     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02245     UNICODE_STRING LocalValueName;
02246 
02247     <span class="comment">// Start registry call tracing</span>
02248     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
02249 
02250     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02251 
02252     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02253 
02254     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtQueryValueKey\n"</span>));
02255     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
02256         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
02257         KdPrint((<span class="stringliteral">"\tValueName='%wZ'\n"</span>, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>));
02258     }
02259 <span class="preprocessor">#ifdef LOG_NT_API</span>
02260 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02261         KdPrint((<span class="stringliteral">"NtQueryValueKey %d %wZ %d\n"</span>,KeyHandle,<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,KeyValueInformationClass));
02262     }
02263 <span class="preprocessor">#endif</span>
02264 <span class="preprocessor"></span>
02265     <span class="keywordflow">if</span> ((KeyValueInformationClass != KeyValueBasicInformation) &amp;&amp;
02266         (KeyValueInformationClass != KeyValueFullInformation)  &amp;&amp;
02267         (KeyValueInformationClass != KeyValueFullInformationAlign64)  &amp;&amp;
02268         (KeyValueInformationClass != KeyValuePartialInformationAlign64)  &amp;&amp;
02269         (KeyValueInformationClass != KeyValuePartialInformation))
02270     {
02271         <span class="comment">// End registry call tracing</span>
02272         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_PARAMETER,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGQUERYVALUE);
02273 
02274         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02275     }
02276 
02277     mode = KeGetPreviousMode();
02278 
02279     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02280                 KeyHandle,
02281                 KEY_QUERY_VALUE,
02282                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02283                 mode,
02284                 (PVOID *)(&amp;KeyBody),
02285                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02286                 );
02287 
02288     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02289 
02290         <span class="keywordflow">try</span> {
02291             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02292                 LocalValueName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
02293                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(LocalValueName.Buffer,
02294                              LocalValueName.Length,
02295                              <span class="keyword">sizeof</span>(WCHAR));
02296 
02297                 <span class="comment">//</span>
02298                 <span class="comment">// We only probe the output buffer for Read to avoid touching</span>
02299                 <span class="comment">// all the pages. Some people like to pass in gigantic buffers</span>
02300                 <span class="comment">// Just In Case. The actual copy into the buffer is done under</span>
02301                 <span class="comment">// an exception handler.</span>
02302                 <span class="comment">//</span>
02303 
02304                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(KeyValueInformation,
02305                              Length,
02306                              <span class="keyword">sizeof</span>(ULONG));
02307                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ResultLength);
02308             } <span class="keywordflow">else</span> {
02309                 LocalValueName = *<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
02310             }
02311 
02312         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02313             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
02314                 KdPrint((<span class="stringliteral">"!!NtQueryValueKey: code:%08lx\n"</span>, GetExceptionCode()));
02315             }
02316             status = GetExceptionCode();
02317         }
02318 
02319         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02320             <span class="comment">//</span>
02321             <span class="comment">// CmQueryValueKey is protected to user mode buffer exceptions</span>
02322             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
02323             <span class="comment">//</span>
02324             status = <a class="code" href="../../d1/d2/cmp_8h.html#a230">CmQueryValueKey</a>(KeyBody-&gt;KeyControlBlock,
02325                                      LocalValueName,
02326                                      KeyValueInformationClass,
02327                                      KeyValueInformation,
02328                                      Length,
02329                                      ResultLength);
02330         }
02331 
02332         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02333     } <span class="keywordflow">else</span> {
02334         LocalValueName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02335         LocalValueName.Length = 0;
02336     }
02337 
02338     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02339 
02340     <span class="comment">// End registry call tracing</span>
02341     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,&amp;LocalValueName,EVENT_TRACE_TYPE_REGQUERYVALUE);
02342 
02343     <span class="keywordflow">return</span> status;
02344 }
02345 
02346 
02347 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02348"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a26">02348</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a26">NtRestoreKey</a>(
02349     IN HANDLE KeyHandle,
02350     IN HANDLE FileHandle,
02351     IN ULONG Flags
02352     )
02353 <span class="comment">/*++</span>
02354 <span class="comment"></span>
02355 <span class="comment">Routine Description:</span>
02356 <span class="comment"></span>
02357 <span class="comment">    A file in the format created by NtSaveKey may be loaded into</span>
02358 <span class="comment">    the system's active registry with NtRestoreKey.  An entire subtree</span>
02359 <span class="comment">    is created in the active registry as a result.  All of the</span>
02360 <span class="comment">    data for the new sub-tree, including such things as security</span>
02361 <span class="comment">    descriptors, will be read from the source file.  The data will</span>
02362 <span class="comment">    not be interpreted in any way.</span>
02363 <span class="comment"></span>
02364 <span class="comment">    This call (unlike NtLoadKey, see below) copies the data.  The</span>
02365 <span class="comment">    system will NOT be using the source file after the call returns.</span>
02366 <span class="comment"></span>
02367 <span class="comment">    If the flag REG_WHOLE_HIVE_VOLATILE is specified, a new hive</span>
02368 <span class="comment">    can be created.  It will be a memory only copy.  The restore</span>
02369 <span class="comment">    must be done to the root of a hive (e.g. \registry\user&lt;name&gt;)</span>
02370 <span class="comment"></span>
02371 <span class="comment">    If the flag is NOT set, then the target of the restore must</span>
02372 <span class="comment">    be an existing hive.  The restore can be done to an arbitrary</span>
02373 <span class="comment">    location within an existing hive.</span>
02374 <span class="comment"></span>
02375 <span class="comment">    Caller must have SeRestorePrivilege privilege.</span>
02376 <span class="comment"></span>
02377 <span class="comment">    If the flag REG_REFRESH_HIVE is set (must be only flag) then the</span>
02378 <span class="comment">    the Hive will be restored to its state as of the last flush.</span>
02379 <span class="comment"></span>
02380 <span class="comment">    The hive must be marked NOLAZY_FLUSH, and the caller must have</span>
02381 <span class="comment">    TCB privilege, and the handle must point to the root of the hive.</span>
02382 <span class="comment">    If the refresh fails, the hive will be corrupt, and the system</span>
02383 <span class="comment">    will bugcheck.  Notifies are flushed.  The hive file will be resized,</span>
02384 <span class="comment">    the log will not.  If there is any volatile space in the hive</span>
02385 <span class="comment">    being refreshed, STATUS_UNSUCCESSFUL will be returned.  (It's much</span>
02386 <span class="comment">    too obscure a failure to warrant a new error code.)</span>
02387 <span class="comment"></span>
02388 <span class="comment">    If the flag REG_FORCE_RESTORE is set, the restore operation is done</span>
02389 <span class="comment">    even if the KeyHandle has open subkeys by other applications</span>
02390 <span class="comment"></span>
02391 <span class="comment">Arguments:</span>
02392 <span class="comment"></span>
02393 <span class="comment">    KeyHandle - refers to the Key in the registry which is to be the</span>
02394 <span class="comment">                root of the new tree read from the disk.  This key</span>
02395 <span class="comment">                will be replaced.</span>
02396 <span class="comment"></span>
02397 <span class="comment">    FileHandle - refers to file to restore from, must have read access.</span>
02398 <span class="comment"></span>
02399 <span class="comment">    Flags   - If REG_WHOLE_HIVE_VOLATILE is set, then the copy will</span>
02400 <span class="comment">              exist only in memory, and disappear when the machine</span>
02401 <span class="comment">              is rebooted.  No hive file will be created on disk.</span>
02402 <span class="comment"></span>
02403 <span class="comment">              Normally, a hive file will be created on disk.</span>
02404 <span class="comment"></span>
02405 <span class="comment">Return Value:</span>
02406 <span class="comment"></span>
02407 <span class="comment">    NTSTATUS - values TBS.</span>
02408 <span class="comment"></span>
02409 <span class="comment"></span>
02410 <span class="comment">--*/</span>
02411 {
02412     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02413     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02414     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02415 
02416     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02417 
02418     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02419 
02420     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtRestoreKey\n"</span>));
02421 <span class="preprocessor">#ifdef LOG_NT_API</span>
02422 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02423         KdPrint((<span class="stringliteral">"NtRestoreKey\n"</span>));
02424     }
02425 <span class="preprocessor">#endif</span>
02426 <span class="preprocessor"></span>
02427     mode = KeGetPreviousMode();
02428     <span class="comment">//</span>
02429     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
02430     <span class="comment">//</span>
02431     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>, mode)) {
02432         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02433     }
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">// Force previous mode to be KernelMode so we can call filesystems</span>
02437     <span class="comment">//</span>
02438 
02439     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02440         <span class="keywordflow">return</span> ZwRestoreKey(KeyHandle, FileHandle, Flags);
02441     } <span class="keywordflow">else</span> {
02442 
02443         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02444                     KeyHandle,
02445                     0,
02446                     <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02447                     mode,
02448                     (PVOID *)(&amp;KeyBody),
02449                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02450                     );
02451 
02452         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02453 
02454             status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a14">CmRestoreKey</a>(
02455                         KeyBody-&gt;KeyControlBlock,
02456                         FileHandle,
02457                         Flags
02458                         );
02459 
02460             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02461         }
02462     }
02463 
02464     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02465 
02466     <span class="keywordflow">return</span> status;
02467 }
02468 
02469 
02470 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02471"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a27">02471</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a27">NtSaveKey</a>(
02472     IN HANDLE KeyHandle,
02473     IN HANDLE FileHandle
02474     )
02475 <span class="comment">/*++</span>
02476 <span class="comment"></span>
02477 <span class="comment">Routine Description:</span>
02478 <span class="comment"></span>
02479 <span class="comment">    A subtree of the active registry may be written to a file in a</span>
02480 <span class="comment">    format suitable for use with NtRestoreKey.  All of the data in the</span>
02481 <span class="comment">    subtree, including such things as security descriptors will be written</span>
02482 <span class="comment">    out.</span>
02483 <span class="comment"></span>
02484 <span class="comment">    Caller must have SeBackupPrivilege privilege.</span>
02485 <span class="comment"></span>
02486 <span class="comment">Arguments:</span>
02487 <span class="comment"></span>
02488 <span class="comment">    KeyHandle - refers to the Key in the registry which is the</span>
02489 <span class="comment">                root of the tree to be written to disk.  The specified</span>
02490 <span class="comment">                node will be included in the data written out.</span>
02491 <span class="comment"></span>
02492 <span class="comment">    FileHandle - a file handle with write access to the target file</span>
02493 <span class="comment">                 of interest.</span>
02494 <span class="comment"></span>
02495 <span class="comment">Return Value:</span>
02496 <span class="comment"></span>
02497 <span class="comment">    NTSTATUS - values TBS</span>
02498 <span class="comment"></span>
02499 <span class="comment">--*/</span>
02500 {
02501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02502     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02503     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02504 
02505     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02506 
02507     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02508 
02509     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtSaveKey\n"</span>));
02510 <span class="preprocessor">#ifdef LOG_NT_API</span>
02511 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02512         KdPrint((<span class="stringliteral">"NtSaveKey\n"</span>));
02513     }
02514 <span class="preprocessor">#endif</span>
02515 <span class="preprocessor"></span>
02516     mode = KeGetPreviousMode();
02517 
02518     <span class="comment">//</span>
02519     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
02520     <span class="comment">//</span>
02521     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a>, mode)) {
02522         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02523     }
02524 
02525     <span class="comment">//</span>
02526     <span class="comment">// Force previous mode to be KernelMode</span>
02527     <span class="comment">//</span>
02528 
02529     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02530         <span class="keywordflow">return</span> ZwSaveKey(KeyHandle, FileHandle);
02531     } <span class="keywordflow">else</span> {
02532 
02533         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02534                     KeyHandle,
02535                     0,
02536                     <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02537                     mode,
02538                     (PVOID *)(&amp;KeyBody),
02539                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02540                     );
02541 
02542         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02543 
02544             status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a15">CmSaveKey</a>(
02545                         KeyBody-&gt;KeyControlBlock,
02546                         FileHandle
02547                         );
02548 
02549             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02550         }
02551     }
02552 
02553     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02554 
02555     <span class="keywordflow">return</span> status;
02556 }
02557 
02558 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02559"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a28">02559</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a28">NtSaveMergedKeys</a>(
02560     IN HANDLE HighPrecedenceKeyHandle,
02561     IN HANDLE LowPrecedenceKeyHandle,
02562     IN HANDLE FileHandle
02563     )
02564 <span class="comment">/*++</span>
02565 <span class="comment"></span>
02566 <span class="comment">Routine Description:</span>
02567 <span class="comment"></span>
02568 <span class="comment">    Two subtrees of the registry can be merged. The resulting subtree may</span>
02569 <span class="comment">    be written to a file in a format suitable for use with NtRestoreKey.</span>
02570 <span class="comment">    All of the data in the subtree, including such things as security</span>
02571 <span class="comment">    descriptors will be written out.</span>
02572 <span class="comment"></span>
02573 <span class="comment">    Caller must have SeBackupPrivilege privilege.</span>
02574 <span class="comment"></span>
02575 <span class="comment">Arguments:</span>
02576 <span class="comment"></span>
02577 <span class="comment">    HighPrecedenceKeyHandle - refers to the key in the registry which is the</span>
02578 <span class="comment">                root of the HighPrecedence tree. I.e., when a key is present in</span>
02579 <span class="comment">                both trees headded by the two keys, the key underneath HighPrecedence</span>
02580 <span class="comment">                tree will always prevail. The specified</span>
02581 <span class="comment">                node will be included in the data written out.</span>
02582 <span class="comment"></span>
02583 <span class="comment">    LowPrecedenceKeyHandle - referrs to the key in the registry which is the</span>
02584 <span class="comment">                root of the "second choice" tree. Keys from this trees get saved</span>
02585 <span class="comment">                when there is no equivalent key in the tree headded by HighPrecedenceKey</span>
02586 <span class="comment"></span>
02587 <span class="comment">    FileHandle - a file handle with write access to the target file</span>
02588 <span class="comment">                 of interest.</span>
02589 <span class="comment"></span>
02590 <span class="comment">Return Value:</span>
02591 <span class="comment"></span>
02592 <span class="comment">    NTSTATUS - values TBS</span>
02593 <span class="comment"></span>
02594 <span class="comment">--*/</span>
02595 {
02596     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02597     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   HighKeyBody;
02598     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   LowKeyBody;
02599     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02600 
02601     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02602 
02603     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02604 
02605     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtSaveMergedKeys\n"</span>));
02606 <span class="preprocessor">#ifdef LOG_NT_API</span>
02607 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02608         KdPrint((<span class="stringliteral">"NtSaveMergedKeys\n"</span>));
02609     }
02610 <span class="preprocessor">#endif</span>
02611 <span class="preprocessor"></span>
02612     mode = KeGetPreviousMode();
02613 
02614     <span class="comment">//</span>
02615     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
02616     <span class="comment">//</span>
02617     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a>, mode)) {
02618         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02619     }
02620 
02621     <span class="comment">//</span>
02622     <span class="comment">// Force previous mode to be KernelMode</span>
02623     <span class="comment">//</span>
02624 
02625     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02626         <span class="keywordflow">return</span> ZwSaveMergedKeys(HighPrecedenceKeyHandle, LowPrecedenceKeyHandle, FileHandle);
02627     } <span class="keywordflow">else</span> {
02628 
02629         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02630                     HighPrecedenceKeyHandle,
02631                     0,
02632                     <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02633                     mode,
02634                     (PVOID *)(&amp;HighKeyBody),
02635                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02636                     );
02637 
02638         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02639 
02640             status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02641                         LowPrecedenceKeyHandle,
02642                         0,
02643                         <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02644                         mode,
02645                         (PVOID *)(&amp;LowKeyBody),
02646                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02647                         );
02648 
02649             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02650 
02651                 status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a16">CmSaveMergedKeys</a>(
02652                             HighKeyBody-&gt;KeyControlBlock,
02653                             LowKeyBody-&gt;KeyControlBlock,
02654                             FileHandle
02655                             );
02656 
02657                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)LowKeyBody);
02658             }
02659 
02660             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)HighKeyBody);
02661         }
02662 
02663     }
02664 
02665     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02666 
02667     <span class="keywordflow">return</span> status;
02668 }
02669 
02670 
02671 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02672"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a29">02672</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
02673     IN HANDLE KeyHandle,
02674     IN PUNICODE_STRING ValueName,
02675     IN ULONG TitleIndex OPTIONAL,
02676     IN ULONG Type,
02677     IN PVOID Data,
02678     IN ULONG DataSize
02679     )
02680 <span class="comment">/*++</span>
02681 <span class="comment"></span>
02682 <span class="comment">Routine Description:</span>
02683 <span class="comment"></span>
02684 <span class="comment">    A value entry may be created or replaced with NtSetValueKey.</span>
02685 <span class="comment"></span>
02686 <span class="comment">    If a value entry with a Value ID (i.e. name) matching the</span>
02687 <span class="comment">    one specified by ValueName exists, it is deleted and replaced</span>
02688 <span class="comment">    with the one specified.  If no such value entry exists, a new</span>
02689 <span class="comment">    one is created.  NULL is a legal Value ID.  While Value IDs must</span>
02690 <span class="comment">    be unique within any given key, the same Value ID may appear</span>
02691 <span class="comment">    in many different keys.</span>
02692 <span class="comment"></span>
02693 <span class="comment">Arguments:</span>
02694 <span class="comment"></span>
02695 <span class="comment">    KeyHandle - Handle of the key whose for which a value entry is</span>
02696 <span class="comment">        to be set.  Must be opened for KEY_SET_VALUE access.</span>
02697 <span class="comment"></span>
02698 <span class="comment">    ValueName - The unique (relative to the containing key) name</span>
02699 <span class="comment">        of the value entry.  May be NULL.</span>
02700 <span class="comment"></span>
02701 <span class="comment">    TitleIndex - Supplies the title index for ValueName.  The title</span>
02702 <span class="comment">        index specifies the index of the localized alias for the ValueName.</span>
02703 <span class="comment"></span>
02704 <span class="comment">    Type - The integer type number of the value entry.</span>
02705 <span class="comment"></span>
02706 <span class="comment">    Data - Pointer to buffer with actual data for the value entry.</span>
02707 <span class="comment"></span>
02708 <span class="comment">    DataSize - Size of Data buffer.</span>
02709 <span class="comment"></span>
02710 <span class="comment"></span>
02711 <span class="comment">Return Value:</span>
02712 <span class="comment"></span>
02713 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
02714 <span class="comment"></span>
02715 <span class="comment">        &lt;TBS&gt;</span>
02716 <span class="comment"></span>
02717 <span class="comment">--*/</span>
02718 {
02719     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
02720     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
02721     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
02722     UNICODE_STRING LocalValueName;
02723     PWSTR CapturedName=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02724 
02725     <span class="comment">// Start registry call tracing</span>
02726     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
02727 
02728     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02729 
02730     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02731 
02732     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtSetValueKey\n"</span>));
02733     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
02734         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
02735         KdPrint((<span class="stringliteral">"\tValueName='%wZ'n"</span>, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>));
02736     }
02737 <span class="preprocessor">#ifdef LOG_NT_API</span>
02738 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02739         KdPrint((<span class="stringliteral">"NtSetValueKey %d %wZ\n"</span>,KeyHandle,<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>));
02740     }
02741 <span class="preprocessor">#endif</span>
02742 <span class="preprocessor"></span>
02743     mode = KeGetPreviousMode();
02744 
02745     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02746                 KeyHandle,
02747                 KEY_SET_VALUE,
02748                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02749                 mode,
02750                 (PVOID *)(&amp;KeyBody),
02751                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02752                 );
02753 
02754     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02755 
02756         <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
02757             <span class="keywordflow">try</span> {
02758                 LocalValueName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
02759                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Data,
02760                              DataSize,
02761                              <span class="keyword">sizeof</span>(UCHAR));
02762 
02763                 <span class="comment">//</span>
02764                 <span class="comment">// Sanity check for ValueName length</span>
02765                 <span class="comment">//</span>
02766                 <span class="keywordflow">if</span>(LocalValueName.Length &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a3">MAX_KEY_VALUE_NAME_LENGTH</a>) {
02767                     status = STATUS_INVALID_PARAMETER;
02768                     <span class="keywordflow">goto</span> Exit;
02769                 }
02770 
02771                 <span class="comment">//</span>
02772                 <span class="comment">// Capture the name buffer. Note that a zero-length name is valid, that is the</span>
02773                 <span class="comment">// "Default" value.</span>
02774                 <span class="comment">//</span>
02775                 <span class="keywordflow">if</span> (LocalValueName.Length &gt; 0) {
02776                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(LocalValueName.Buffer,
02777                                  LocalValueName.Length,
02778                                  <span class="keyword">sizeof</span>(WCHAR));
02779                     CapturedName = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, LocalValueName.Length, 'nVmC');
02780                     <span class="keywordflow">if</span> (CapturedName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02781                         status = STATUS_INSUFFICIENT_RESOURCES;
02782                         <span class="keywordflow">goto</span> Exit;
02783                     }
02784                     RtlCopyMemory(CapturedName, LocalValueName.Buffer, LocalValueName.Length);
02785                 } <span class="keywordflow">else</span> {
02786                     CapturedName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02787                 }
02788                 LocalValueName.Buffer = CapturedName;
02789 
02790             } except (<a class="code" href="../../d7/d7/ntapi_8c.html#a1">CmpExceptionFilter</a>(GetExceptionInformation())) {
02791                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
02792                     KdPrint((<span class="stringliteral">"!!NtSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
02793                 }
02794                 status = GetExceptionCode();
02795                 <span class="keywordflow">goto</span> Exit;
02796             }
02797         } <span class="keywordflow">else</span> {
02798             LocalValueName = *<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
02799             CapturedName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02800 
02801             <span class="comment">//</span>
02802             <span class="comment">// Sanity check for ValueName length</span>
02803             <span class="comment">//</span>
02804             <span class="keywordflow">if</span>(LocalValueName.Length &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a3">MAX_KEY_VALUE_NAME_LENGTH</a>) {
02805                 status = STATUS_INVALID_PARAMETER;
02806                 <span class="keywordflow">goto</span> Exit;
02807             }
02808         }
02809 
02810         status = <a class="code" href="../../d1/d2/cmp_8h.html#a237">CmSetValueKey</a>(KeyBody-&gt;KeyControlBlock,
02811                                &amp;LocalValueName,
02812                                Type,
02813                                Data,
02814                                DataSize);
02815 
02816 Exit:
02817         <span class="comment">// End registry call tracing</span>
02818         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,&amp;LocalValueName,EVENT_TRACE_TYPE_REGSETVALUE);
02819 
02820         <span class="keywordflow">if</span> (CapturedName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02821             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CapturedName);
02822         }
02823         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02824     }
02825 
02826     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
02827 
02828     <span class="keywordflow">return</span> status;
02829 }
02830 
02831 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02832"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a30">02832</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a30">NtLoadKey</a>(
02833     IN POBJECT_ATTRIBUTES TargetKey,
02834     IN POBJECT_ATTRIBUTES SourceFile
02835     )
02836 
02837 <span class="comment">/*++</span>
02838 <span class="comment"></span>
02839 <span class="comment">Routine Description:</span>
02840 <span class="comment"></span>
02841 <span class="comment">    A hive (file in the format created by NtSaveKey) may be linked</span>
02842 <span class="comment">    into the active registry with this call.  UNLIKE NtRestoreKey,</span>
02843 <span class="comment">    the file specified to NtLoadKey will become the actual backing</span>
02844 <span class="comment">    store of part of the registry (that is, it will NOT be copied.)</span>
02845 <span class="comment"></span>
02846 <span class="comment">    The file may have an associated .log file.</span>
02847 <span class="comment"></span>
02848 <span class="comment">    If the hive file is marked as needing a .log file, and one is</span>
02849 <span class="comment">    not present, the call will fail.</span>
02850 <span class="comment"></span>
02851 <span class="comment">    The name specified by SourceFile must be such that ".log" can</span>
02852 <span class="comment">    be appended to it to generate the name of the log file.  Thus,</span>
02853 <span class="comment">    on FAT file systems, the hive file may not have an extension.</span>
02854 <span class="comment"></span>
02855 <span class="comment">    Caller must have SeRestorePrivilege privilege.</span>
02856 <span class="comment"></span>
02857 <span class="comment">    This call is used by logon to make the user's profile available</span>
02858 <span class="comment">    in the registry.  It is not intended for use doing backup,</span>
02859 <span class="comment">    restore, etc.  Use NtRestoreKey for that.</span>
02860 <span class="comment"></span>
02861 <span class="comment">Arguments:</span>
02862 <span class="comment"></span>
02863 <span class="comment">    TargetKey - specifies the path to a key to link the hive to.</span>
02864 <span class="comment">                path must be of the form "\registry\user&lt;username&gt;"</span>
02865 <span class="comment"></span>
02866 <span class="comment">    SourceFile - specifies a file.  while file could be remote,</span>
02867 <span class="comment">                that is strongly discouraged.</span>
02868 <span class="comment"></span>
02869 <span class="comment">Return Value:</span>
02870 <span class="comment"></span>
02871 <span class="comment">    NTSTATUS - values TBS.</span>
02872 <span class="comment"></span>
02873 <span class="comment">--*/</span>
02874 
02875 {
02876     <span class="keywordflow">return</span>(<a class="code" href="../../d7/d7/ntapi_8c.html#a31">NtLoadKey2</a>(TargetKey, SourceFile, 0));
02877 }
02878 
02879 
02880 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02881"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a31">02881</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a31">NtLoadKey2</a>(
02882     IN POBJECT_ATTRIBUTES TargetKey,
02883     IN POBJECT_ATTRIBUTES SourceFile,
02884     IN ULONG Flags
02885     )
02886 
02887 <span class="comment">/*++</span>
02888 <span class="comment"></span>
02889 <span class="comment">Routine Description:</span>
02890 <span class="comment"></span>
02891 <span class="comment">    A hive (file in the format created by NtSaveKey) may be linked</span>
02892 <span class="comment">    into the active registry with this call.  UNLIKE NtRestoreKey,</span>
02893 <span class="comment">    the file specified to NtLoadKey will become the actual backing</span>
02894 <span class="comment">    store of part of the registry (that is, it will NOT be copied.)</span>
02895 <span class="comment"></span>
02896 <span class="comment">    The file may have an associated .log file.</span>
02897 <span class="comment"></span>
02898 <span class="comment">    If the hive file is marked as needing a .log file, and one is</span>
02899 <span class="comment">    not present, the call will fail.</span>
02900 <span class="comment"></span>
02901 <span class="comment">    The name specified by SourceFile must be such that ".log" can</span>
02902 <span class="comment">    be appended to it to generate the name of the log file.  Thus,</span>
02903 <span class="comment">    on FAT file systems, the hive file may not have an extension.</span>
02904 <span class="comment"></span>
02905 <span class="comment">    Caller must have SeRestorePrivilege privilege.</span>
02906 <span class="comment"></span>
02907 <span class="comment">    This call is used by logon to make the user's profile available</span>
02908 <span class="comment">    in the registry.  It is not intended for use doing backup,</span>
02909 <span class="comment">    restore, etc.  Use NtRestoreKey for that.</span>
02910 <span class="comment"></span>
02911 <span class="comment">Arguments:</span>
02912 <span class="comment"></span>
02913 <span class="comment">    TargetKey - specifies the path to a key to link the hive to.</span>
02914 <span class="comment">                path must be of the form "\registry\user&lt;username&gt;"</span>
02915 <span class="comment"></span>
02916 <span class="comment">    SourceFile - specifies a file.  while file could be remote,</span>
02917 <span class="comment">                that is strongly discouraged.</span>
02918 <span class="comment"></span>
02919 <span class="comment">    Flags - specifies any flags that should be used for the load operation.</span>
02920 <span class="comment">            The only valid flag is REG_NO_LAZY_FLUSH.</span>
02921 <span class="comment"></span>
02922 <span class="comment"></span>
02923 <span class="comment">Return Value:</span>
02924 <span class="comment"></span>
02925 <span class="comment">    NTSTATUS - values TBS.</span>
02926 <span class="comment"></span>
02927 <span class="comment">--*/</span>
02928 
02929 {
02930     OBJECT_ATTRIBUTES <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
02931     OBJECT_ATTRIBUTES <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
02932     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02933     UNICODE_STRING CapturedKeyName;
02934     UNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
02935     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Maximum;
02936     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02937     PWSTR KeyBuffer;
02938     PSECURITY_DESCRIPTOR CapturedDescriptor;
02939 
02940     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02941 
02942     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
02943 
02944     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtLoadKey\n"</span>));
02945     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
02946         KdPrint((<span class="stringliteral">"\tTargetKey ='%wZ'\n"</span>, TargetKey-&gt;ObjectName));
02947         KdPrint((<span class="stringliteral">"\tSourceFile='%wZ'\n"</span>, SourceFile-&gt;ObjectName));
02948     }
02949 <span class="preprocessor">#ifdef LOG_NT_API</span>
02950 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
02951         KdPrint((<span class="stringliteral">"NtLoadKey\n"</span>));
02952     }
02953 <span class="preprocessor">#endif</span>
02954 <span class="preprocessor"></span>    <span class="comment">//</span>
02955     <span class="comment">// Check for illegal flags</span>
02956     <span class="comment">//</span>
02957     <span class="keywordflow">if</span> (Flags &amp; ~REG_NO_LAZY_FLUSH) {
02958         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
02959     }
02960 
02961     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02962     KeyBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02963 
02964     <span class="comment">//</span>
02965     <span class="comment">// The way we do this is a cronk, but at least it's the same cronk we</span>
02966     <span class="comment">// use for all the registry I/O.</span>
02967     <span class="comment">//</span>
02968     <span class="comment">// The file needs to be opened in the worker thread's context, since</span>
02969     <span class="comment">// the resulting handle must be valid when we poke him to go read/write</span>
02970     <span class="comment">// from.  So we just capture the object attributes for the hive file</span>
02971     <span class="comment">// here, then poke the worker thread to go do the rest of the work.</span>
02972     <span class="comment">//</span>
02973 
02974     PreviousMode = KeGetPreviousMode();
02975 
02976     <span class="comment">//</span>
02977     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
02978     <span class="comment">//</span>
02979     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>, PreviousMode)) {
02980         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02981     }
02982 
02983     <span class="comment">//</span>
02984     <span class="comment">// CmpNameFromAttributes will probe and capture as necessary.</span>
02985     <span class="comment">//</span>
02986     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02987     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a10">CmpNameFromAttributes</a>(SourceFile,
02988                                    PreviousMode,
02989                                    &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
02990     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02991         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02992         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02993     }
02994 
02995     <span class="keywordflow">try</span> {
02996 
02997         <span class="comment">//</span>
02998         <span class="comment">// Probe the object attributes if necessary.</span>
02999         <span class="comment">//</span>
03000         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03001             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(TargetKey,
03002                          <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES),
03003                          PROBE_ALIGNMENT(OBJECT_ATTRIBUTES) );
03004         }
03005 
03006         <span class="comment">//</span>
03007         <span class="comment">// Capture the object attributes.</span>
03008         <span class="comment">//</span>
03009         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>  = *TargetKey;
03010 
03011         <span class="comment">//</span>
03012         <span class="comment">// Capture the object name.</span>
03013         <span class="comment">//</span>
03014 
03015         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03016             CapturedKeyName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.ObjectName);
03017             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(CapturedKeyName.Buffer,
03018                          CapturedKeyName.Length,
03019                          <span class="keyword">sizeof</span>(WCHAR));
03020         } <span class="keywordflow">else</span> {
03021             CapturedKeyName = *(TargetKey-&gt;ObjectName);
03022         }
03023 
03024         <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>.ObjectName = &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
03025         <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>.SecurityDescriptor = SourceFile-&gt;SecurityDescriptor;
03026 
03027         Maximum = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(CapturedKeyName.Length);
03028 
03029         KeyBuffer = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, Maximum, CM_POOL_TAG);
03030 
03031         <span class="keywordflow">if</span> (KeyBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03032             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
03033             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03034             <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
03035         }
03036 
03037         RtlMoveMemory(KeyBuffer, CapturedKeyName.Buffer, Maximum);
03038         CapturedKeyName.Length = Maximum;
03039         CapturedKeyName.Buffer = KeyBuffer;
03040 
03041         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.ObjectName = &amp;CapturedKeyName;
03042         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03043 
03044         <span class="comment">//</span>
03045         <span class="comment">// Capture the security descriptor.</span>
03046         <span class="comment">//</span>
03047         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>.SecurityDescriptor,
03048                                              PreviousMode,
03049                                              <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03050                                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03051                                              &amp;CapturedDescriptor);
03052         <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>.SecurityDescriptor = CapturedDescriptor;
03053 
03054     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03055         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
03056             KdPrint((<span class="stringliteral">"!!NtLoadKey: code:%08lx\n"</span>, GetExceptionCode()));
03057         }
03058         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03059 
03060     }
03061 
03062     <span class="comment">//</span>
03063     <span class="comment">// Clean up if there was an exception or SeCaptureSD failed.</span>
03064     <span class="comment">//</span>
03065     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03066         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03067             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
03068         }
03069         <span class="keywordflow">if</span> (KeyBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03070             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyBuffer);
03071         }
03072         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03073         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03074     }
03075 
03076     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a240">CmLoadKey</a>(&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, &amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, Flags);
03077 
03078     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
03079     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyBuffer);
03080     <span class="keywordflow">if</span> (CapturedDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03081         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CapturedDescriptor);
03082     }
03083 
03084     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03085 
03086     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03087 
03088     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03089 }
03090 
03091 
03092 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03093"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a32">03093</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a32">NtUnloadKey</a>(
03094     IN POBJECT_ATTRIBUTES TargetKey
03095     )
03096 <span class="comment">/*++</span>
03097 <span class="comment"></span>
03098 <span class="comment">Routine Description:</span>
03099 <span class="comment"></span>
03100 <span class="comment">    Drop a subtree (hive) out of the registry.</span>
03101 <span class="comment"></span>
03102 <span class="comment">    Will fail if applied to anything other than the root of a hive.</span>
03103 <span class="comment"></span>
03104 <span class="comment">    Cannot be applied to core system hives (HARDWARE, SYSTEM, etc.)</span>
03105 <span class="comment"></span>
03106 <span class="comment">    Can be applied to user hives loaded via NtRestoreKey or NtLoadKey.</span>
03107 <span class="comment"></span>
03108 <span class="comment">    If there are handles open to the hive being dropped, this call</span>
03109 <span class="comment">    will fail.  Terminate relevent processes so that handles are</span>
03110 <span class="comment">    closed.</span>
03111 <span class="comment"></span>
03112 <span class="comment">    This call will flush the hive being dropped.</span>
03113 <span class="comment"></span>
03114 <span class="comment">    Caller must have SeRestorePrivilege privilege.</span>
03115 <span class="comment"></span>
03116 <span class="comment">Arguments:</span>
03117 <span class="comment"></span>
03118 <span class="comment">    TargetKey - specifies the path to a key to link the hive to.</span>
03119 <span class="comment">                path must be of the form "\registry\user&lt;username&gt;"</span>
03120 <span class="comment"></span>
03121 <span class="comment">Return Value:</span>
03122 <span class="comment"></span>
03123 <span class="comment">    NTSTATUS - values TBS.</span>
03124 <span class="comment"></span>
03125 <span class="comment">--*/</span>
03126 {
03127     HANDLE KeyHandle;
03128     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03129     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
03130     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
03131     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
03132     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
03133     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> ParseContext;
03134 
03135     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03136 
03137     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
03138 
03139     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtUnloadKey\n"</span>));
03140     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
03141         KdPrint((<span class="stringliteral">"\tTargetKey ='%wZ'\n"</span>, TargetKey-&gt;ObjectName));
03142     }
03143 <span class="preprocessor">#ifdef LOG_NT_API</span>
03144 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
03145         KdPrint((<span class="stringliteral">"NtUnloadKey\n"</span>));
03146     }
03147 <span class="preprocessor">#endif</span>
03148 <span class="preprocessor"></span>
03149     PreviousMode = KeGetPreviousMode();
03150 
03151     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>, PreviousMode)) {
03152         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
03153     }
03154 
03155     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
03156 
03157     <span class="keywordflow">try</span> {
03158 
03159         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o0">TitleIndex</a> = 0;
03160         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Length = 0;
03161         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03162         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o2">CreateOptions</a> = REG_OPTION_BACKUP_RESTORE;
03163         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o3">Disposition</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03164         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03165         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o6">PredefinedHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03166 
03167         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(TargetKey,
03168                                     <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
03169                                     PreviousMode,
03170                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03171                                     KEY_WRITE,
03172                                     &amp;ParseContext,
03173                                     &amp;KeyHandle);
03174         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03175             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
03176                                                KEY_WRITE,
03177                                                <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
03178                                                PreviousMode,
03179                                                (PVOID *)&amp;KeyBody,
03180                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03181             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
03182         }
03183 
03184     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03185         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03186         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
03187             KdPrint((<span class="stringliteral">"!!NtUnloadKey: code:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03188         }
03189     }
03190 
03191     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03192         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
03193         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
03194 
03195         <span class="comment">//</span>
03196         <span class="comment">// Report the notify here, because the KCB won't be around later.</span>
03197         <span class="comment">//</span>
03198 
03199         <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
03200                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
03201                         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
03202                         REG_NOTIFY_CHANGE_LAST_SET);
03203 
03204 
03205         <span class="comment">//</span>
03206         <span class="comment">// post any waiting notifies</span>
03207         <span class="comment">//</span>
03208         <a class="code" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a>(KeyBody);
03209 
03210         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a241">CmUnloadKey</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>);
03211         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03212             <span class="comment">//</span>
03213             <span class="comment">// Mark this kcb as deleted so that it won't get put on the delayed close list.</span>
03214             <span class="comment">//</span>
03215             KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03216             <span class="comment">//</span>
03217             <span class="comment">// If the parent has the subkey info or hint cached, free it.</span>
03218             <span class="comment">//</span>
03219             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
03220             <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>);
03221             <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>);
03222         } 
03223 
03224         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
03225     }
03226 
03227     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
03228 
03229     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03230 
03231     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03232 }
03233 
03234 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03235"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a33">03235</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a33">NtSetInformationKey</a>(
03236     IN HANDLE KeyHandle,
03237     IN KEY_SET_INFORMATION_CLASS KeySetInformationClass,
03238     IN PVOID KeySetInformation,
03239     IN ULONG KeySetInformationLength
03240     )
03241 {
03242     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
03243     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
03244     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> mode;
03245     LARGE_INTEGER LocalWriteTime;
03246 
03247     <span class="comment">// Start registry call tracing</span>
03248     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
03249 
03250     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03251 
03252     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
03253 
03254     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtSetInformationKey\n"</span>));
03255     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
03256         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
03257         KdPrint((<span class="stringliteral">"\tInfoClass=%08x\n"</span>, KeySetInformationClass));
03258     }
03259 <span class="preprocessor">#ifdef LOG_NT_API</span>
03260 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
03261         KdPrint((<span class="stringliteral">"NtSetInformationKey %d %d\n"</span>,KeyHandle,KeySetInformationClass));
03262     }
03263 <span class="preprocessor">#endif</span>
03264 <span class="preprocessor"></span>
03265     <span class="keywordflow">switch</span> (KeySetInformationClass) {
03266     <span class="keywordflow">case</span> KeyWriteTimeInformation:
03267         <span class="keywordflow">if</span> (KeySetInformationLength != <span class="keyword">sizeof</span>( KEY_WRITE_TIME_INFORMATION )) {
03268 
03269             <span class="comment">// End registry call tracing</span>
03270             <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INFO_LENGTH_MISMATCH,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGSETINFORMATION);
03271 
03272             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03273         }
03274         <span class="keywordflow">break</span>;
03275 
03276     <span class="keywordflow">default</span>:
03277 
03278         <span class="comment">// End registry call tracing</span>
03279         <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(STATUS_INVALID_INFO_CLASS,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGSETINFORMATION);
03280 
03281         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
03282     }
03283 
03284     mode = KeGetPreviousMode();
03285 
03286     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03287                 KeyHandle,
03288                 KEY_SET_VALUE,
03289                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
03290                 mode,
03291                 (PVOID *)(&amp;KeyBody),
03292                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03293                 );
03294 
03295     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03296 
03297         <span class="keywordflow">try</span> {
03298 
03299             <span class="keywordflow">if</span> (mode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03300                 LocalWriteTime = <a class="code" href="../../d5/d8/ex_8h.html#a24">ProbeAndReadLargeInteger</a>(
03301                     (PLARGE_INTEGER) KeySetInformation );
03302             } <span class="keywordflow">else</span> {
03303                 LocalWriteTime = *(PLARGE_INTEGER)KeySetInformation;
03304             }
03305 
03306         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03307             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
03308                 KdPrint((<span class="stringliteral">"!!NtSetInformationKey: code:%08lx\n"</span>, GetExceptionCode()));
03309             }
03310             status = GetExceptionCode();
03311         }
03312 
03313         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03314             <span class="comment">//</span>
03315             <span class="comment">// not in try ... except! we want bugcheck here if something wrong in the registry</span>
03316             <span class="comment">//</span>
03317             status = <a class="code" href="../../d1/d2/cmp_8h.html#a238">CmSetLastWriteTimeKey</a>(
03318                         KeyBody-&gt;KeyControlBlock,
03319                         &amp;LocalWriteTime
03320                         );
03321         }
03322 
03323         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
03324     }
03325 
03326     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03327 
03328     <span class="comment">// End registry call tracing</span>
03329     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(status,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGSETINFORMATION);
03330 
03331     <span class="keywordflow">return</span> status;
03332 }
03333 
03334 
03335 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03336"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a34">03336</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a34">NtReplaceKey</a>(
03337     IN POBJECT_ATTRIBUTES NewFile,
03338     IN HANDLE             TargetHandle,
03339     IN POBJECT_ATTRIBUTES OldFile
03340     )
03341 <span class="comment">/*++</span>
03342 <span class="comment"></span>
03343 <span class="comment">Routine Description:</span>
03344 <span class="comment"></span>
03345 <span class="comment">    A hive file may be "replaced" under a running system, such</span>
03346 <span class="comment">    that the new file will be the one actually used at next</span>
03347 <span class="comment">    boot, with this call.</span>
03348 <span class="comment"></span>
03349 <span class="comment">    This routine will:</span>
03350 <span class="comment"></span>
03351 <span class="comment">        Open newfile, and verify that it is a valid Hive file.</span>
03352 <span class="comment"></span>
03353 <span class="comment">        Rename the Hive file backing TargetHandle to OldFile.</span>
03354 <span class="comment">        All handles will remain open, and the system will continue</span>
03355 <span class="comment">        to use the file until rebooted.</span>
03356 <span class="comment"></span>
03357 <span class="comment">        Rename newfile to match the name of the hive file</span>
03358 <span class="comment">        backing TargetHandle.</span>
03359 <span class="comment"></span>
03360 <span class="comment">    .log and .alt files are ignored</span>
03361 <span class="comment"></span>
03362 <span class="comment">    The system must be rebooted for any useful effect to be seen.</span>
03363 <span class="comment"></span>
03364 <span class="comment">    Caller must have SeRestorePrivilege.</span>
03365 <span class="comment"></span>
03366 <span class="comment">Arguments:</span>
03367 <span class="comment"></span>
03368 <span class="comment">    NewFile - specifies the new file to use.  must not be just</span>
03369 <span class="comment">              a handle, since NtReplaceKey will insist on</span>
03370 <span class="comment">              opening the file for exclusive access (which it</span>
03371 <span class="comment">              will hold until the system is rebooted.)</span>
03372 <span class="comment"></span>
03373 <span class="comment">    TargetHandle - handle to a registry hive root</span>
03374 <span class="comment"></span>
03375 <span class="comment">    OldFile - name of file to apply to current hive, which will</span>
03376 <span class="comment">              become old hive</span>
03377 <span class="comment"></span>
03378 <span class="comment">Return Value:</span>
03379 <span class="comment"></span>
03380 <span class="comment">    NTSTATUS - values TBS.</span>
03381 <span class="comment"></span>
03382 <span class="comment">--*/</span>
03383 {
03384     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
03385     UNICODE_STRING NewHiveName;
03386     UNICODE_STRING OldFileName;
03387     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03388     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
03389 
03390     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03391 
03392     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
03393 
03394     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtReplaceKey\n"</span>));
03395     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
03396         KdPrint((<span class="stringliteral">"\tNewFile ='%wZ'\n"</span>, NewFile-&gt;ObjectName));
03397         KdPrint((<span class="stringliteral">"\tOldFile ='%wZ'\n"</span>, OldFile-&gt;ObjectName));
03398     }
03399 <span class="preprocessor">#ifdef LOG_NT_API</span>
03400 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
03401         KdPrint((<span class="stringliteral">"NtReplaceKey\n"</span>));
03402     }
03403 <span class="preprocessor">#endif</span>
03404 <span class="preprocessor"></span>
03405     PreviousMode = KeGetPreviousMode();
03406 
03407     <span class="comment">//</span>
03408     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
03409     <span class="comment">//</span>
03410     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>, PreviousMode)) {
03411         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
03412     }
03413 
03414     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03415     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a10">CmpNameFromAttributes</a>(NewFile,
03416                                    PreviousMode,
03417                                    &amp;NewHiveName);
03418     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03419         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03420         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03421     }
03422 
03423     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a10">CmpNameFromAttributes</a>(OldFile,
03424                                    PreviousMode,
03425                                    &amp;OldFileName);
03426     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03427         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewHiveName.Buffer);
03428         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03429         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03430     }
03431 
03432     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(TargetHandle,
03433                                        0,
03434                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
03435                                        PreviousMode,
03436                                        (PVOID *)&amp;KeyBody,
03437                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03438     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03439 
03440         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a233">CmReplaceKey</a>(KeyBody-&gt;KeyControlBlock-&gt;KeyHive,
03441                               KeyBody-&gt;KeyControlBlock-&gt;KeyCell,
03442                               &amp;NewHiveName,
03443                               &amp;OldFileName);
03444 
03445         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
03446     }
03447 
03448     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OldFileName.Buffer);
03449     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewHiveName.Buffer);
03450     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03451 
03452     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03453 
03454     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03455 }
03456 
03457 
03458 NTSYSAPI
03459 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03460 NTAPI
<a name="l03461"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a35">03461</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a35">NtQueryMultipleValueKey</a>(
03462     IN HANDLE KeyHandle,
03463     IN PKEY_VALUE_ENTRY ValueEntries,
03464     IN ULONG EntryCount,
03465     OUT PVOID ValueBuffer,
03466     IN OUT PULONG BufferLength,
03467     OUT OPTIONAL PULONG RequiredBufferLength
03468     )
03469 <span class="comment">/*++</span>
03470 <span class="comment"></span>
03471 <span class="comment">Routine Description:</span>
03472 <span class="comment"></span>
03473 <span class="comment">    Multiple values of any key may be queried atomically with</span>
03474 <span class="comment">    this api.</span>
03475 <span class="comment"></span>
03476 <span class="comment">Arguments:</span>
03477 <span class="comment"></span>
03478 <span class="comment">    KeyHandle - Supplies the key to be queried.</span>
03479 <span class="comment"></span>
03480 <span class="comment">    ValueNames - Supplies an array of value names to be queried</span>
03481 <span class="comment"></span>
03482 <span class="comment">    ValueEntries - Returns an array of KEY_VALUE_ENTRY structures, one for each value.</span>
03483 <span class="comment"></span>
03484 <span class="comment">    EntryCount - Supplies the number of entries in the ValueNames and ValueEntries arrays</span>
03485 <span class="comment"></span>
03486 <span class="comment">    ValueBuffer - Returns the value data for each value.</span>
03487 <span class="comment"></span>
03488 <span class="comment">    BufferLength - Supplies the length of the ValueBuffer array in bytes.</span>
03489 <span class="comment">                   Returns the length of the ValueBuffer array that was filled in.</span>
03490 <span class="comment"></span>
03491 <span class="comment">    RequiredBufferLength - if present, Returns the length in bytes of the ValueBuffer</span>
03492 <span class="comment">                    array required to return all the values of this key.</span>
03493 <span class="comment"></span>
03494 <span class="comment">Return Value:</span>
03495 <span class="comment"></span>
03496 <span class="comment">    NTSTATUS</span>
03497 <span class="comment"></span>
03498 <span class="comment">--*/</span>
03499 
03500 {
03501     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
03502     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03503     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
03504     ULONG i;
03505     ULONG LocalBufferLength;
03506 
03507     <span class="comment">// Start registry call tracing</span>
03508     <a class="code" href="../../d1/d2/cmp_8h.html#a5">StartWmiCmTrace</a>();
03509 
03510     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03511 
03512     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
03513 
03514     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtQueryMultipleValueKey\n"</span>));
03515     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
03516         KdPrint((<span class="stringliteral">"\tKeyHandle=%08lx\n"</span>, KeyHandle));
03517     }
03518 <span class="preprocessor">#ifdef LOG_NT_API</span>
03519 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
03520         KdPrint((<span class="stringliteral">"NtQueryMultipleValueKey\n"</span>));
03521     }
03522 <span class="preprocessor">#endif</span>
03523 <span class="preprocessor"></span>
03524     PreviousMode = KeGetPreviousMode();
03525     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
03526                                        KEY_QUERY_VALUE,
03527                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
03528                                        PreviousMode,
03529                                        (PVOID *)(&amp;KeyBody),
03530                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03531     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03532         <span class="keywordflow">try</span> {
03533             <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03534                 LocalBufferLength = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>(BufferLength);
03535 
03536                 <span class="comment">//</span>
03537                 <span class="comment">// Probe the output buffers</span>
03538                 <span class="comment">//</span>
03539                 <span class="comment">// Put an arbitrary 64K limit on the number of entries to</span>
03540                 <span class="comment">// prevent bogus apps from passing an EntryCount large enough</span>
03541                 <span class="comment">// to overflow the EntryCount * sizeof(KEY_VALUE_ENTRY) calculation.</span>
03542                 <span class="comment">//</span>
03543                 <span class="keywordflow">if</span> (EntryCount &gt; 0x10000) {
03544                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
03545                 }
03546                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ValueEntries,
03547                               EntryCount * <span class="keyword">sizeof</span>(KEY_VALUE_ENTRY),
03548                               <span class="keyword">sizeof</span>(ULONG));
03549                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RequiredBufferLength)) {
03550                     <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(RequiredBufferLength);
03551                 }
03552 
03553                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>,
03554                               LocalBufferLength,
03555                               <span class="keyword">sizeof</span>(ULONG));
03556 
03557             } <span class="keywordflow">else</span> {
03558                 LocalBufferLength = *BufferLength;
03559             }
03560 
03561         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03562             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
03563                 KdPrint((<span class="stringliteral">"!!NtQueryMultipleValueKey: code:%08lx\n"</span>,GetExceptionCode()));
03564             }
03565             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03566         }
03567 
03568         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03569             <span class="comment">//</span>
03570             <span class="comment">// CmQueryMultipleValueKey is protected to user mode buffer exceptions</span>
03571             <span class="comment">// all other exceptions are cm internals and should result in a bugcheck</span>
03572             <span class="comment">//</span>
03573             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a231">CmQueryMultipleValueKey</a>(KeyBody-&gt;KeyControlBlock,
03574                                              ValueEntries,
03575                                              EntryCount,
03576                                              <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>,
03577                                              &amp;LocalBufferLength,
03578                                              RequiredBufferLength);
03579             <span class="keywordflow">try</span> {
03580                 <span class="comment">// anybody messed with BufferLength in between?</span>
03581                 *BufferLength = LocalBufferLength;
03582             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03583                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
03584                     KdPrint((<span class="stringliteral">"!!NtQueryMultipleValueKey: code:%08lx\n"</span>,GetExceptionCode()));
03585                 }
03586                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03587             }
03588         }
03589         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
03590     }
03591 
03592     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
03593 
03594     <span class="comment">// End registry call tracing</span>
03595     <a class="code" href="../../d1/d2/cmp_8h.html#a6">EndWmiCmTrace</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,KeyHandle,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,EVENT_TRACE_TYPE_REGQUERYMULTIPLEVALUE);
03596 
03597     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03598 
03599 }
03600 
03601 
03602 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03603"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a10">03603</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a10">CmpNameFromAttributes</a>(
03604     IN POBJECT_ATTRIBUTES Attributes,
03605     KPROCESSOR_MODE PreviousMode,
03606     OUT PUNICODE_STRING FullName
03607     )
03608 
03609 <span class="comment">/*++</span>
03610 <span class="comment"></span>
03611 <span class="comment">Routine Description:</span>
03612 <span class="comment"></span>
03613 <span class="comment">    This is a helper routine that converts OBJECT_ATTRIBUTES into a</span>
03614 <span class="comment">    full object pathname.  This is needed because we cannot pass handles</span>
03615 <span class="comment">    to the worker thread, since it runs in a different process.</span>
03616 <span class="comment"></span>
03617 <span class="comment">    This routine will also probe and capture the attributes based on</span>
03618 <span class="comment">    PreviousMode.</span>
03619 <span class="comment"></span>
03620 <span class="comment">    Storage for the string buffer is allocated from paged pool, and should</span>
03621 <span class="comment">    be freed by the caller.</span>
03622 <span class="comment"></span>
03623 <span class="comment">Arguments:</span>
03624 <span class="comment"></span>
03625 <span class="comment">    Attributes - Supplies the object attributes to be converted to a pathname</span>
03626 <span class="comment"></span>
03627 <span class="comment">    PreviousMode - Supplies the previous mode.</span>
03628 <span class="comment"></span>
03629 <span class="comment">    Name - Returns the object pathname.</span>
03630 <span class="comment"></span>
03631 <span class="comment">Return Value:</span>
03632 <span class="comment"></span>
03633 <span class="comment">    NTSTATUS</span>
03634 <span class="comment"></span>
03635 <span class="comment">--*/</span>
03636 
03637 {
03638     OBJECT_ATTRIBUTES CapturedAttributes;
03639     UNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
03640     UNICODE_STRING RootName;
03641     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03642     ULONG ObjectNameLength;
03643     UCHAR ObjectNameInfo[512];
03644     POBJECT_NAME_INFORMATION ObjectName;
03645     PWSTR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
03646     PUNICODE_STRING CapturedObjectName;
03647     ULONG   Length;
03648 
03649     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03650     FullName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;            <span class="comment">// so we know whether to free it in our exception handler</span>
03651     <span class="keywordflow">try</span> {
03652 
03653         <span class="comment">//</span>
03654         <span class="comment">// Probe the object attributes if necessary.</span>
03655         <span class="comment">//</span>
03656         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
03657             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Attributes,
03658                          <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES),
03659                          PROBE_ALIGNMENT(OBJECT_ATTRIBUTES) );
03660             CapturedObjectName = Attributes-&gt;ObjectName;
03661             <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(CapturedObjectName);
03662             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer,
03663                          <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length,
03664                          <span class="keyword">sizeof</span>(WCHAR));
03665         } <span class="keywordflow">else</span> {
03666             <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = *(Attributes-&gt;ObjectName);
03667         }
03668 
03669         CapturedAttributes = *Attributes;
03670 
03671         <span class="keywordflow">if</span> (CapturedAttributes.RootDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03672 
03673             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03674                 (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length &gt;= <span class="keyword">sizeof</span>(WCHAR)) &amp;&amp;
03675                 (*(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer) == OBJ_NAME_PATH_SEPARATOR)) {
03676                 <span class="keywordflow">return</span>(STATUS_OBJECT_PATH_SYNTAX_BAD);
03677             }
03678 
03679             <span class="comment">//</span>
03680             <span class="comment">// Find the name of the root directory and append the</span>
03681             <span class="comment">// name of the relative object to it.</span>
03682             <span class="comment">//</span>
03683 
03684             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryObject(CapturedAttributes.RootDirectory,
03685                                    ObjectNameInformation,
03686                                    &amp;ObjectNameInfo,
03687                                    <span class="keyword">sizeof</span>(ObjectNameInfo),
03688                                    &amp;ObjectNameLength);
03689 
03690             ObjectName = (POBJECT_NAME_INFORMATION)ObjectNameInfo;
03691             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03692                 <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03693             }
03694             RootName = ObjectName-&gt;Name;
03695 
03696             FullName-&gt;Length = 0;
03697             Length = RootName.Length+<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length+<span class="keyword">sizeof</span>(WCHAR);
03698             <span class="comment">//</span>
03699             <span class="comment">// Overflow test: If Length overflows the USHRT_MAX value</span>
03700             <span class="comment">//                cleanup and return STATUS_OBJECT_PATH_INVALID</span>
03701             <span class="comment">//</span>
03702             <span class="keywordflow">if</span>( Length&gt;0xFFFF ) {
03703                 <span class="keywordflow">return</span> STATUS_OBJECT_PATH_INVALID;
03704             }
03705 
03706             FullName-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
03707             
03708             FullName-&gt;Buffer = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, FullName-&gt;MaximumLength, CM_POOL_TAG);
03709             <span class="keywordflow">if</span> (FullName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03710                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03711             }
03712 
03713             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(FullName, &amp;RootName);
03714             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03715 
03716             <span class="comment">//</span>
03717             <span class="comment">// Append a trailing separator if necessary.</span>
03718             <span class="comment">//</span>
03719                         <span class="keywordflow">if</span>( FullName-&gt;Length != 0 ) {
03720                                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PWSTR)((PUCHAR)FullName-&gt;Buffer + FullName-&gt;Length) - 1;
03721                                 <span class="keywordflow">if</span> (*<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> != OBJ_NAME_PATH_SEPARATOR) {
03722                                         ++<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
03723                                         *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = OBJ_NAME_PATH_SEPARATOR;
03724                                         FullName-&gt;Length += <span class="keyword">sizeof</span>(WCHAR);
03725                                 }
03726                         }
03727 
03728             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(FullName, &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
03729             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03730 
03731         } <span class="keywordflow">else</span> {
03732 
03733             <span class="comment">//</span>
03734             <span class="comment">// RootDirectory is NULL, so just use the name.</span>
03735             <span class="comment">//</span>
03736             FullName-&gt;Length = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length;
03737             FullName-&gt;MaximumLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length;
03738             FullName-&gt;Buffer = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length, CM_POOL_TAG);
03739             <span class="keywordflow">if</span> (FullName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03740                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
03741             } <span class="keywordflow">else</span> {
03742                 RtlMoveMemory(FullName-&gt;Buffer,
03743                               <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer,
03744                               <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length);
03745                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03746             }
03747         }
03748 
03749 
03750     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03751         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03752         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
03753             KdPrint((<span class="stringliteral">"!!CmpNameFromAttributes: code %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03754         }
03755         <span class="keywordflow">if</span> (FullName-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03756             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FullName-&gt;Buffer);
03757         }
03758     }
03759 
03760     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03761 }
03762 
03763 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03764"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a36">03764</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a36">CmpFreePostBlock</a>(
03765     IN <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock
03766     )
03767 
03768 <span class="comment">/*++</span>
03769 <span class="comment"></span>
03770 <span class="comment">Routine Description:</span>
03771 <span class="comment"></span>
03772 <span class="comment">    Frees the various bits of pool that were allocated for a postblock</span>
03773 <span class="comment"></span>
03774 <span class="comment">Arguments:</span>
03775 <span class="comment"></span>
03776 <span class="comment">    None</span>
03777 <span class="comment"></span>
03778 <span class="comment">Return Value:</span>
03779 <span class="comment"></span>
03780 <span class="comment">    None.</span>
03781 <span class="comment"></span>
03782 <span class="comment">--*/</span>
03783 
03784 {
03785 
03786     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
03787 <span class="preprocessor">#if DBG</span>
03788 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(PostBlock-&gt;TraceIntoDebugger) {
03789             KdPrint((<span class="stringliteral">"[CM]CmpFreePostBlock: PostBlock:%08lx\t"</span>, PostBlock));
03790             <span class="keywordflow">if</span>( PostBlock-&gt;NotifyType&amp;<a class="code" href="../../d1/d2/cmp_8h.html#a87">REG_NOTIFY_MASTER_POST</a>) {
03791                 KdPrint((<span class="stringliteral">"--MasterBlock\n"</span>));
03792             } <span class="keywordflow">else</span> {
03793                 KdPrint((<span class="stringliteral">"--SlaveBlock\n"</span>));
03794             }
03795         }
03796 <span class="preprocessor">#endif</span>
03797 <span class="preprocessor"></span>    }
03798 
03799 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
03800 <span class="preprocessor"></span>    <span class="comment">// check if the post block has been removed from the notify and thread list(s)</span>
03801     <span class="keywordflow">if</span>((PostBlock-&gt;NotifyList.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PostBlock-&gt;NotifyList.Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03802         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFreePostBlock: Attempt to free post block %08lx not removed from notify list\n"</span>,PostBlock);
03803         DbgBreakPoint();
03804     }
03805     <span class="keywordflow">if</span>((PostBlock-&gt;ThreadList.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PostBlock-&gt;ThreadList.Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03806         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFreePostBlock: Attempt to free post block %08lx not removed from thread list\n"</span>,PostBlock);
03807         DbgBreakPoint();
03808     }
03809 
03810 <span class="preprocessor">#endif</span>
03811 <span class="preprocessor"></span>
03812     <span class="comment">// Protect for multiple deletion of the same object</span>
03813     <a class="code" href="../../d1/d2/cmp_8h.html#a2">CmpClearListEntry</a>(&amp;(PostBlock-&gt;CancelPostList));
03814 
03815     <span class="comment">//</span>
03816     <span class="comment">// Cleanup for objects referenced by NtNotifyMultipleKeys</span>
03817     <span class="comment">//</span>
03818     <span class="keywordflow">if</span>( PostBlock-&gt;PostKeyBody) {
03819 
03820         <span class="comment">//</span>
03821         <span class="comment">// If we have a PostKeyBody, the attached key body must not be NULL</span>
03822         <span class="comment">//</span>
03823         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PostBlock-&gt;PostKeyBody-&gt;KeyBody);
03824 
03825         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a37">CMS_NOTIFY</a>) {
03826 <span class="preprocessor">#if DBG</span>
03827 <span class="preprocessor"></span>            WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03828             UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
03829 
03830             KdPrint((<span class="stringliteral">"[CM]\tCmpFreePostBlock: Dereferencing KeyBody:%08lx\n"</span>, PostBlock-&gt;PostKeyBody-&gt;KeyBody));
03831             NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>);
03832             <span class="keywordflow">if</span>(NameBuffer) {
03833                <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(PostBlock-&gt;PostKeyBody-&gt;KeyBody-&gt;KeyControlBlock-&gt;KeyNode,&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,NameBuffer);
03834                KdPrint((<span class="stringliteral">"[CM]\tCmpFreePostBlock: KeyName:tKey = %.*S\n"</span>,<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
03835                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
03836             }
03837 <span class="preprocessor">#endif</span>
03838 <span class="preprocessor"></span>        }
03839 
03840         <span class="comment">//</span>
03841         <span class="comment">// KeyBodyList must be used only in CmpPostBlock implementation for the delayed dereferencing mechanism.</span>
03842         <span class="comment">//</span>
03843         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;(PostBlock-&gt;PostKeyBody-&gt;KeyBodyList)));
03844 
03845         <span class="comment">//</span>
03846         <span class="comment">// dereference the actual keybody</span>
03847         <span class="comment">//</span>
03848         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(PostBlock-&gt;PostKeyBody-&gt;KeyBody);
03849 
03850         <span class="comment">//</span>
03851         <span class="comment">// Free the PostKeyBody structure</span>
03852         <span class="comment">//</span>
03853         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;PostKeyBody);
03854     }
03855 
03856     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock) ) {
03857         <span class="comment">//</span>
03858         <span class="comment">// this members are allocated only for master post blocks</span>
03859         <span class="comment">//</span>
03860         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a88">PostBlockType</a>(PostBlock)) {
03861             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>:
03862                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u-&gt;Sync.SystemEvent);
03863                 <span class="keywordflow">break</span>;
03864             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>:
03865                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u-&gt;AsyncUser.Apc);
03866                 <span class="keywordflow">break</span>;
03867             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>:
03868                 <span class="keywordflow">break</span>;
03869         }
03870         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u);
03871     }
03872 
03873 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
03874 <span class="preprocessor"></span>    RtlZeroMemory((PVOID)PostBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>));
03875 <span class="preprocessor">#endif</span>
03876 <span class="preprocessor"></span>
03877     <span class="comment">// and the storage for the Post object</span>
03878     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03879 }
03880 
03881 
03882 <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>
<a name="l03883"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a37">03883</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a37">CmpAllocatePostBlock</a>(
03884     IN POST_BLOCK_TYPE  BlockType,
03885     IN ULONG            PostFlags,
03886     IN <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>     KeyBody,
03887     IN <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a>   MasterBlock
03888     )
03889 
03890 <span class="comment">/*++</span>
03891 <span class="comment"></span>
03892 <span class="comment">Routine Description:</span>
03893 <span class="comment"></span>
03894 <span class="comment">    Allocates a post block from pool.  The non-pagable stuff comes from</span>
03895 <span class="comment">    NonPagedPool, the pagable stuff from paged pool.  Quota will be</span>
03896 <span class="comment">    charged.</span>
03897 <span class="comment"></span>
03898 <span class="comment">Arguments:</span>
03899 <span class="comment"></span>
03900 <span class="comment">    BlockType  - specifies the type of the post block to be allocated</span>
03901 <span class="comment">                i.e. : PostSyncrhronous, PostAsyncUser, PostAsyncKernel</span>
03902 <span class="comment"></span>
03903 <span class="comment">    PostFlags      - specifies the flags to be set on the allocated post block</span>
03904 <span class="comment">                vallid flags:</span>
03905 <span class="comment">                    - REG_NOTIFY_MASTER_POST - the post block to be allocated</span>
03906 <span class="comment">                      is a master post block.</span>
03907 <span class="comment">    KeyBody     - The Key object to whom this post block is attached. On master blocks</span>
03908 <span class="comment">                  this is NULL. When the post object is freed, the KeyBody object is</span>
03909 <span class="comment">                  dereferenced (if not NULL - i.e. for slave blocks). This allow us to</span>
03910 <span class="comment">                  perform back-end cleanup for "fake-slave" keys opened by NtNotifyMultipleKeys</span>
03911 <span class="comment">    MasterBlock - the post block to be allocated is a slave of this master block.</span>
03912 <span class="comment">                  valid only when PostFlags ==  REG_NOTIFY_MASTER_POST</span>
03913 <span class="comment"></span>
03914 <span class="comment"></span>
03915 <span class="comment">Obs: The Sync.SystemEvent and AsyncUser.Apc members are allocated only for master post blocks</span>
03916 <span class="comment"></span>
03917 <span class="comment">Return Value:</span>
03918 <span class="comment"></span>
03919 <span class="comment">    Pointer to the CM_POST_BLOCK if successful</span>
03920 <span class="comment"></span>
03921 <span class="comment">    NULL if there were not enough resources available.</span>
03922 <span class="comment"></span>
03923 <span class="comment">--*/</span>
03924 
03925 {
03926     <a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">PCM_POST_BLOCK</a> PostBlock;
03927 
03928     <span class="comment">// protection against outrageous calls</span>
03929     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !PostFlags || (!MasterBlock &amp;&amp; !KeyBody) );
03930 
03931     PostBlock = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d6/struct__CM__POST__BLOCK.html">CM_POST_BLOCK</a>),CM_POSTBLOCK_TAG);
03932     <span class="keywordflow">if</span> (PostBlock==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03933         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03934     }
03935 
03936 <span class="preprocessor">#ifdef _CM_ENTRYLIST_MANIPULATION</span>
03937 <span class="preprocessor"></span>    RtlZeroMemory((PVOID)PostBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a175">CM_POST_BLOCK</a>));
03938 <span class="preprocessor">#endif</span>
03939 <span class="preprocessor"></span>
03940 <span class="preprocessor">#if DBG</span>
03941 <span class="preprocessor"></span>    PostBlock-&gt;TraceIntoDebugger = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03942 <span class="preprocessor">#endif</span>
03943 <span class="preprocessor"></span>
03944     PostBlock-&gt;NotifyType = (ULONG)BlockType;
03945     PostBlock-&gt;NotifyType |= PostFlags;
03946 
03947     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a89">IsMasterPostBlock</a>(PostBlock)) {
03948         PostBlock-&gt;PostKeyBody = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03949         <span class="comment">//</span>
03950         <span class="comment">// master post block ==&gt; allocate the storage</span>
03951         <span class="comment">//</span>
03952         PostBlock-&gt;u = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
03953                                            <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d6/union__CM__POST__BLOCK__UNION.html">CM_POST_BLOCK_UNION</a>),
03954                                            CM_POSTBLOCK_TAG);
03955         <span class="keywordflow">if</span> (PostBlock-&gt;u == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03956             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03957             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03958         }
03959 
03960          <span class="keywordflow">switch</span> (BlockType) {
03961             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a204">PostSynchronous</a>:
03962                 PostBlock-&gt;u-&gt;Sync.SystemEvent = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
03963                                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>),
03964                                                                     CM_POSTEVENT_TAG);
03965                 <span class="keywordflow">if</span> (PostBlock-&gt;u-&gt;Sync.SystemEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03966                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u);
03967                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03968                     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03969                 }
03970                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(PostBlock-&gt;u-&gt;Sync.SystemEvent,
03971                                   SynchronizationEvent,
03972                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03973                 <span class="keywordflow">break</span>;
03974             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a205">PostAsyncUser</a>:
03975                 PostBlock-&gt;u-&gt;AsyncUser.Apc = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
03976                                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>),
03977                                                              CM_POSTAPC_TAG);
03978                 <span class="keywordflow">if</span> (PostBlock-&gt;u-&gt;AsyncUser.Apc==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03979                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock-&gt;u);
03980                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
03981                     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03982                 }
03983                 <span class="keywordflow">break</span>;
03984             <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a335a206">PostAsyncKernel</a>:
03985                 RtlZeroMemory(&amp;PostBlock-&gt;u-&gt;AsyncKernel, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d3/struct__CM__ASYNC__KERNEL__POST__BLOCK.html">CM_ASYNC_KERNEL_POST_BLOCK</a>));
03986                 <span class="keywordflow">break</span>;
03987         }
03988     } <span class="keywordflow">else</span> {
03989         <span class="comment">//</span>
03990         <span class="comment">// Slave post block ==&gt; copy storage allocated for the master post block</span>
03991         <span class="comment">//</span>
03992         PostBlock-&gt;u = MasterBlock-&gt;u;
03993 
03994         <span class="comment">//</span>
03995         <span class="comment">// allocate a PostKeyBody which will hold this KeyBody, and initialize the head of its KeyBodyList</span>
03996         <span class="comment">//</span>
03997         PostBlock-&gt;PostKeyBody = <a class="code" href="../../d7/d7/ntapi_8c.html#a0">ALLOCATE_WITH_QUOTA</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__CM__POST__KEY__BODY.html">CM_POST_KEY_BODY</a>),CM_POSTBLOCK_TAG);
03998         <span class="keywordflow">if</span> (PostBlock-&gt;PostKeyBody == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03999             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PostBlock);
04000             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04001         }
04002         PostBlock-&gt;PostKeyBody-&gt;KeyBody = KeyBody;
04003         InitializeListHead(&amp;(PostBlock-&gt;PostKeyBody-&gt;KeyBodyList));
04004     }
04005 
04006     <span class="keywordflow">return</span>(PostBlock);
04007 }
04008 
04009 <span class="preprocessor">#if DBG</span>
04010 <span class="preprocessor"></span>
04011 LOGICAL CmpExceptionBreak = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04012  
04013 
04014 ULONG
04015 <a class="code" href="../../d7/d7/ntapi_8c.html#a1">CmpExceptionFilter</a>(
04016     IN PEXCEPTION_POINTERS ExceptionPointers
04017     )
04018 
04019 <span class="comment">/*++</span>
04020 <span class="comment"></span>
04021 <span class="comment">Routine Description:</span>
04022 <span class="comment"></span>
04023 <span class="comment">    Debug code to find registry exceptions that are being swallowed</span>
04024 <span class="comment"></span>
04025 <span class="comment">Return Value:</span>
04026 <span class="comment"></span>
04027 <span class="comment">    EXCEPTION_EXECUTE_HANDLER</span>
04028 <span class="comment"></span>
04029 <span class="comment">--*/</span>
04030 
04031 {
04032     KdPrint((<span class="stringliteral">"CM: Registry exception %lx, ExceptionPointers = %p\n"</span>,
04033             ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
04034             ExceptionPointers));
04035     
04036     <span class="keywordflow">if</span> (CmpExceptionBreak == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04037 
04038         <span class="keywordflow">try</span> {
04039             DbgBreakPoint();
04040         } except (EXCEPTION_EXECUTE_HANDLER) {
04041 
04042             <span class="comment">//</span>
04043             <span class="comment">// no debugger enabled, just keep going</span>
04044             <span class="comment">//</span>
04045 
04046         }
04047     }
04048 
04049     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>);
04050 }
04051 
04052 <span class="preprocessor">#endif</span>
04053 <span class="preprocessor"></span>
<a name="l04054"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a9">04054</a> ULONG   <a class="code" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a>;
04055 
04056 <span class="preprocessor">#ifndef KCB_TO_KEYBODY_LINK</span>
04057 <span class="preprocessor"></span>
04058 BOOLEAN
<a name="l04059"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a12">04059</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a12">CmpEnumKeyObjectCallback</a>(
04060     IN PVOID Object,
04061     IN PUNICODE_STRING ObjectName,
04062     IN ULONG HandleCount,
04063     IN ULONG PointerCount,
04064     IN PVOID Context
04065     )
04066 {
04067     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>    KeyBody;
04068     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
04069 
04070     KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object;
04071     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)Context;
04072 
04073     <span class="keywordflow">if</span>( KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> == <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> ) {
04074         <span class="comment">//</span>
04075         <span class="comment">// that's and open subkey inside of the hive</span>
04076         <span class="comment">//</span>
04077         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Key %wZ (HandleCount = %lu PointerCount = %lu) is opened by process %lx\n"</span>,
04078                         ObjectName,HandleCount,PointerCount,KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o3">Process</a>);
04079 
04080         <span class="comment">// count it</span>
04081         <a class="code" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a>++;
04082     }
04083 
04084     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04085 }
04086 
04087 <span class="preprocessor">#endif</span>
04088 <span class="preprocessor"></span>
04089 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04090"></a><a class="code" href="../../d7/d7/ntapi_8c.html#a38">04090</a> <a class="code" href="../../d7/d7/ntapi_8c.html#a38">NtQueryOpenSubKeys</a>(
04091     IN POBJECT_ATTRIBUTES TargetKey,
04092     OUT PULONG  HandleCount
04093     )
04094 <span class="comment">/*++</span>
04095 <span class="comment"></span>
04096 <span class="comment">Routine Description:</span>
04097 <span class="comment"></span>
04098 <span class="comment">    Dumps all the subkeys of the target key that are kept open by some other</span>
04099 <span class="comment">    process; Returns the number of open subkeys</span>
04100 <span class="comment"></span>
04101 <span class="comment"></span>
04102 <span class="comment">Arguments:</span>
04103 <span class="comment"></span>
04104 <span class="comment">    TargetKey - specifies the path to a key to link the hive to.</span>
04105 <span class="comment">                path must be of the form "\registry\user&lt;username&gt;"</span>
04106 <span class="comment"></span>
04107 <span class="comment">Return Value:</span>
04108 <span class="comment"></span>
04109 <span class="comment">    NTSTATUS - values TBS.</span>
04110 <span class="comment"></span>
04111 <span class="comment">--*/</span>
04112 {
04113     HANDLE KeyHandle;
04114     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04115     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>   KeyBody;
04116     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
04117     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
04118     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
04119     UNICODE_STRING  HiveName;
04120 
04121     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04122 
04123     <a class="code" href="../../d1/d2/cmp_8h.html#a59">BEGIN_LOCK_CHECKPOINT</a>;
04124 
04125     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) KdPrint((<span class="stringliteral">"NtQueryOpenSubKeys\n"</span>));
04126     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a20">CML_API_ARGS</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
04127         KdPrint((<span class="stringliteral">"\tTargetKey ='%wZ'\n"</span>, TargetKey-&gt;ObjectName));
04128     }
04129 <span class="preprocessor">#ifdef LOG_NT_API</span>
04130 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CmpLogApi) {
04131         KdPrint((<span class="stringliteral">"NtQueryOpenSubKeys\n"</span>));
04132     }
04133 <span class="preprocessor">#endif</span>
04134 <span class="preprocessor"></span>
04135     PreviousMode = KeGetPreviousMode();
04136 
04137     <span class="comment">//</span>
04138     <span class="comment">// lock registry exclusive so nobody messes with it while we're around</span>
04139     <span class="comment">//</span>
04140     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
04141 
04142     <span class="keywordflow">try</span> {
04143 
04144         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
04145             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(HandleCount);
04146         }
04147 
04148         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(TargetKey,
04149                                     <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
04150                                     PreviousMode,
04151                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04152                                     KEY_READ,
04153                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04154                                     &amp;KeyHandle);
04155         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04156             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
04157                                                KEY_READ,
04158                                                <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
04159                                                PreviousMode,
04160                                                (PVOID *)&amp;KeyBody,
04161                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04162             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
04163         }
04164 
04165     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
04166         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04167         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
04168             KdPrint((<span class="stringliteral">"!!NtQueryOpenSubKeys: code:%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04169         }
04170     }
04171 
04172     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04173         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
04174         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
04175 
04176 
04177         <span class="comment">//</span>
04178         <span class="comment">// Make sure the cell passed in is the root cell of the hive.</span>
04179         <span class="comment">//</span>
04180         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> != <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>) {
04181             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
04182             <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
04183             <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
04184         }
04185 
04186         <span class="comment">//</span>
04187         <span class="comment">// Dump the hive name and hive address</span>
04188         <span class="comment">//</span>
04189         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;HiveName, (PCWSTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>);
04190         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n Subkeys open inside the hive (%lx) (%.*S) :\n\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,HiveName.Length / <span class="keyword">sizeof</span>(WCHAR),HiveName.Buffer);
04191 
04192         <span class="comment">//</span>
04193         <span class="comment">// dump open subkeys (if any)</span>
04194         <span class="comment">//</span>
04195 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
04196 <span class="preprocessor"></span>        <a class="code" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,<a class="code" href="../../d9/d0/cmdata_8h.html#a105a102">SearchAndCount</a>);
04197 <span class="preprocessor">#else</span>
04198 <span class="preprocessor"></span>        <span class="comment">//</span>
04199         <span class="comment">// use a global var to count the number of subkeys, as this is the only</span>
04200         <span class="comment">// way interfere with the Enum callback; It is safe to use as this will</span>
04201         <span class="comment">// be the only thread working on this global var (registry is locked exclusively)</span>
04202         <span class="comment">//</span>
04203         <a class="code" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a> = 0;
04204         <a class="code" href="../../d0/d2/obtype_8c.html#a3">ObEnumerateObjectsByType</a>(
04205             <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
04206             <a class="code" href="../../d7/d7/ntapi_8c.html#a12">CmpEnumKeyObjectCallback</a>,
04207             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>
04208             );
04209 <span class="preprocessor">#endif</span>
04210 <span class="preprocessor"></span>        <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
04211         <span class="keywordflow">try</span> {
04212             <span class="comment">// </span>
04213             <span class="comment">// protect user mode memory</span>
04214             <span class="comment">//</span>
04215             *HandleCount = <a class="code" href="../../d7/d7/ntapi_8c.html#a9">CmpOpenSubKeys</a>;
04216         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
04217             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04218         }
04219     }
04220 
04221     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
04222 
04223     <a class="code" href="../../d1/d2/cmp_8h.html#a60">END_LOCK_CHECKPOINT</a>;
04224 
04225     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04226 }
04227 
04228 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:58 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
