<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: winhtky.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>winhtky.c</h1><a href="../../d7/d7/winhtky_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: whotkeys.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the core functions of 3.1 window hotkey processing.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 16-Apr-1992 JimA      Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">/***************************************************************************\</span>
00016 <span class="comment">* HotKeyToWindow</span>
00017 <span class="comment">*</span>
00018 <span class="comment">* Scans the hotkey table and returns the pwnd corresponding to the</span>
00019 <span class="comment">* given hot key.  Returns NULL if no such hot key in the list.  Looks at the</span>
00020 <span class="comment">* current key state array.</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* History:</span>
00023 <span class="comment">* 04-15-92 JimA         Ported from Win3.1 sources.</span>
00024 <span class="comment">\***************************************************************************/</span>
00025 
<a name="l00026"></a><a class="code" href="../../d7/d7/winhtky_8c.html#a0">00026</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d7/d7/winhtky_8c.html#a0">HotKeyToWindow</a>(
00027     DWORD key)
00028 {
00029     <a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">PHOTKEYSTRUCT</a> phk;
00030     <span class="keywordtype">int</span> ckeys;
00031 
00032     ckeys = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>;
00033 
00034     <span class="keywordflow">if</span> (ckeys == 0)
00035         <span class="keywordflow">return</span> 0;
00036 
00037     phk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>;
00038 
00039     <span class="keywordflow">while</span> (ckeys) {
00040         <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o1">key</a> == key)
00041             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>) ? phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o0">spwnd</a> : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00042         phk++;
00043         ckeys--;
00044     }
00045 
00046     <span class="keywordflow">return</span> 0;
00047 }
00048 
00049 
00050 <span class="comment">/***************************************************************************\</span>
00051 <span class="comment">* HotKeyHelper</span>
00052 <span class="comment">*</span>
00053 <span class="comment">* Scans the hot key list and returns a pointer to the entry for the</span>
00054 <span class="comment">* window.</span>
00055 <span class="comment">*</span>
00056 <span class="comment">* History:</span>
00057 <span class="comment">* 04-15-92 JimA         Ported from Win3.1 sources.</span>
00058 <span class="comment">\***************************************************************************/</span>
00059 
<a name="l00060"></a><a class="code" href="../../d7/d7/winhtky_8c.html#a1">00060</a> <a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">PHOTKEYSTRUCT</a> <a class="code" href="../../d7/d7/winhtky_8c.html#a1">HotKeyHelper</a>(
00061     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00062 {
00063     <a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">PHOTKEYSTRUCT</a> phk;
00064     <span class="keywordtype">int</span> count;
00065 
00066     count = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>;
00067 
00068     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00069         <span class="keywordflow">return</span> 0;
00070 
00071     phk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>;
00072 
00073     <span class="keywordflow">while</span> (count) {
00074         <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o0">spwnd</a> == pwnd)
00075             <span class="keywordflow">return</span> phk;
00076         phk++;
00077         count--;
00078     }
00079 
00080     <span class="keywordflow">return</span> 0;
00081 }
00082 
00083 
00084 <span class="comment">/***************************************************************************\</span>
00085 <span class="comment">* DWP_SetHotKey</span>
00086 <span class="comment">*</span>
00087 <span class="comment">* Set the hot key for this window.  Replace existing hot key, or if new</span>
00088 <span class="comment">* key is NULL, delete the entry.  Return 2 if key already existed and</span>
00089 <span class="comment">* was replaced, 1 if key did not exist and was set, 0 for</span>
00090 <span class="comment">* failure, and -1 for invalid hot key.</span>
00091 <span class="comment">*</span>
00092 <span class="comment">* History:</span>
00093 <span class="comment">* 15-Apr-1992 JimA      Ported from Win3.1 sources.</span>
00094 <span class="comment">\***************************************************************************/</span>
00095 
<a name="l00096"></a><a class="code" href="../../d7/d7/winhtky_8c.html#a2">00096</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d7/d7/winhtky_8c.html#a2">DWP_SetHotKey</a>(
00097     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00098     DWORD dwKey)
00099 {
00100     <a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">PHOTKEYSTRUCT</a> phk;
00101     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fKeyExists = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00102     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>          pwndTemp;
00103 
00104     <span class="comment">/*</span>
00105 <span class="comment">     * Filter out invalid hotkeys</span>
00106 <span class="comment">     */</span>
00107     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(dwKey) == VK_ESCAPE ||
00108         <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(dwKey) == VK_SPACE ||
00109         <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(dwKey) == VK_TAB ||
00110         <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(dwKey) == VK_PACKET) {
00111 
00112         <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
00113     }
00114 
00115     <span class="comment">/*</span>
00116 <span class="comment">     * Don't allow hotkeys for children</span>
00117 <span class="comment">     */</span>
00118     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))
00119         <span class="keywordflow">return</span> 0;
00120 
00121     <span class="comment">/*</span>
00122 <span class="comment">     * Check if the hot key exists and is assigned to a different pwnd</span>
00123 <span class="comment">     */</span>
00124     <span class="keywordflow">if</span> (dwKey != 0) {
00125 
00126         pwndTemp = <a class="code" href="../../d7/d7/winhtky_8c.html#a0">HotKeyToWindow</a>(dwKey);
00127 
00128         <span class="keywordflow">if</span> ((pwndTemp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pwndTemp != pwnd))
00129             fKeyExists = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00130     }
00131 
00132     <span class="comment">/*</span>
00133 <span class="comment">     * Get the hotkey assigned to the window, if any</span>
00134 <span class="comment">     */</span>
00135     <span class="keywordflow">if</span> ((phk = <a class="code" href="../../d7/d7/winhtky_8c.html#a1">HotKeyHelper</a>(pwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00136 
00137         <span class="comment">/*</span>
00138 <span class="comment">         * Window doesn't exist in the hotkey list and key is being set</span>
00139 <span class="comment">         * to zero, so just return.</span>
00140 <span class="comment">         */</span>
00141         <span class="keywordflow">if</span> (dwKey == 0)
00142             <span class="keywordflow">return</span> 1;
00143 
00144         <span class="comment">/*</span>
00145 <span class="comment">         * Allocate and point to a spot for the new hotkey</span>
00146 <span class="comment">         */</span>
00147         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a> &gt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a118">gcHotKeyAlloc</a>) {
00148 
00149             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a118">gcHotKeyAlloc</a>) {
00150 
00151                 phk = (<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">PHOTKEYSTRUCT</a>)UserReAllocPool(
00152                         (HANDLE)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>,
00153                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a118">gcHotKeyAlloc</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">HOTKEYSTRUCT</a>),
00154                         (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a949">HOTKEYSTRUCT</a>), TAG_HOTKEY);
00155 
00156                 <span class="keywordflow">if</span> (phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00157 
00158                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a> = phk;
00159                     phk = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>++];
00160                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a118">gcHotKeyAlloc</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>;
00161 
00162                 } <span class="keywordflow">else</span> {
00163 
00164                     <span class="keywordflow">return</span> 0;
00165                 }
00166 
00167             } <span class="keywordflow">else</span> {
00168 
00169                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00170                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a> == 0);
00171 
00172                 phk = (<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">PHOTKEYSTRUCT</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">HOTKEYSTRUCT</a>),
00173                                                    TAG_HOTKEY);
00174 
00175                 <span class="keywordflow">if</span> (phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00176 
00177                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a> = phk;
00178                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a> = 1;
00179                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a118">gcHotKeyAlloc</a> = 1;
00180 
00181                 } <span class="keywordflow">else</span> {
00182 
00183                     <span class="keywordflow">return</span> 0;
00184                 }
00185             }
00186 
00187         } <span class="keywordflow">else</span> {
00188             phk = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>++];
00189         }
00190     }
00191 
00192     <span class="keywordflow">if</span> (dwKey == 0) {
00193 
00194         <span class="comment">/*</span>
00195 <span class="comment">         * The hotkey for this window is being deleted. Copy the last item</span>
00196 <span class="comment">         * on the list on top of the one being deleted.</span>
00197 <span class="comment">         */</span>
00198         <span class="keywordflow">if</span> (--<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>) {
00199 
00200             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o0">spwnd</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>].spwnd);
00201             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>].spwnd);
00202 
00203             phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o1">key</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>].<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o1">key</a>;
00204             phk = (<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">PHOTKEYSTRUCT</a>)UserReAllocPool((HANDLE)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>,
00205                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a118">gcHotKeyAlloc</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">HOTKEYSTRUCT</a>),
00206                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a949">HOTKEYSTRUCT</a>), TAG_HOTKEY);
00207 
00208             <span class="keywordflow">if</span> (phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00209                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a> = phk;
00210                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a118">gcHotKeyAlloc</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>;
00211             }
00212 
00213         } <span class="keywordflow">else</span> {
00214 
00215             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a116">gcHotKey</a>].spwnd);
00216             UserFreePool((HANDLE)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a>);
00217             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a117">gpHotKeyList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00218             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a118">gcHotKeyAlloc</a> = 0;
00219         }
00220 
00221     } <span class="keywordflow">else</span> {
00222 
00223         <span class="comment">/*</span>
00224 <span class="comment">         * Add the window and key to the list</span>
00225 <span class="comment">         */</span>
00226         phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o0">spwnd</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00227         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o0">spwnd</a>, pwnd);
00228         phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o1">key</a> = dwKey;
00229     }
00230 
00231     <span class="keywordflow">return</span> fKeyExists ? 2 : 1;
00232 }
00233 
00234 <span class="comment">/***************************************************************************\</span>
00235 <span class="comment">* DWP_GetHotKey</span>
00236 <span class="comment">*</span>
00237 <span class="comment">*</span>
00238 <span class="comment">* History:</span>
00239 <span class="comment">* 15-Apr-1992 JimA      Created.</span>
00240 <span class="comment">\***************************************************************************/</span>
00241 
<a name="l00242"></a><a class="code" href="../../d7/d7/winhtky_8c.html#a3">00242</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d7/d7/winhtky_8c.html#a3">DWP_GetHotKey</a>(
00243     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00244 {
00245     <a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html">PHOTKEYSTRUCT</a> phk;
00246 
00247     <span class="keywordflow">if</span> ((phk = <a class="code" href="../../d7/d7/winhtky_8c.html#a1">HotKeyHelper</a>(pwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00248         <span class="keywordflow">return</span> 0;
00249 
00250     <span class="keywordflow">return</span> phk-&gt;<a class="code" href="../../d9/d6/structtagHOTKEYSTRUCT.html#o1">key</a>;
00251 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
