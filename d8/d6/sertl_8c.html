<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sertl.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sertl.c File Reference</h1><code>#include "<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>"</code><br>
<code>#include &lt;stdio.h&gt;</code><br>
<code>#include "seopaque.h"</code><br>
<code>#include "sertlp.h"</code><br>
<code>#include &lt;..\dll\ldrp.h&gt;</code><br>

<p>
<a href="../../d9/d5/sertl_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a>&nbsp;&nbsp;&nbsp;12</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a1">max</a>(a, b)&nbsp;&nbsp;&nbsp;(((a) &gt; (b)) ? (a) : (b))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a2">SE_VALID_CONTROL_BITS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a3">ProbeAndReadUlongUM</a>(Address)&nbsp;&nbsp;&nbsp;(*(volatile ULONG *)(Address))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a4">MAX_CHILD_SID_GROUP_SIZE</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a5">EFFECTIVE_ACE</a>&nbsp;&nbsp;&nbsp;INHERIT_ONLY_ACE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a6">AceFlagsInAce</a>(_Ace)</td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a80">ACE_TYPE_TO_COPY</a> { <a class="el" href="../../d8/d6/sertl_8c.html#a80a10">CopyInheritedAces</a>, 
<a class="el" href="../../d8/d6/sertl_8c.html#a80a11">CopyNonInheritedAces</a>, 
<a class="el" href="../../d8/d6/sertl_8c.html#a80a12">CopyAllAces</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a13">RtlLengthUsedSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSYSAPI BOOLEAN NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a14">RtlEqualLuid</a> (PLUID Luid1, PLUID Luid2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a15">RtlpConvertAclToAutoInherit</a> (IN PACL ParentAcl OPTIONAL, IN PACL ChildAcl, IN GUID *ObjectType OPTIONAL, IN BOOLEAN IsDirectoryObject, IN PSID OwnerSid, IN PSID GroupSid, IN PGENERIC_MAPPING GenericMapping, OUT PACL *NewAcl, OUT PULONG NewGenericControl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a16">RtlpCopyEffectiveAce</a> (IN PACE_HEADER OldAce, IN BOOLEAN AutoInherit, IN BOOLEAN WillGenerateInheritAce, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN GUID *NewObjectType OPTIONAL, IN OUT PVOID *AcePosition, OUT PULONG NewAceLength, OUT PACL NewAcl, OUT PBOOLEAN ObjectAceInherited OPTIONAL, OUT PBOOLEAN EffectiveAceMapped, OUT PBOOLEAN AclOverflowed)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a17">RtlpCopyAces</a> (IN PACL Acl, IN PGENERIC_MAPPING GenericMapping, IN <a class="el" href="../../d8/d6/sertl_8c.html#a80">ACE_TYPE_TO_COPY</a> AceTypeToCopy, IN UCHAR AceFlagsToReset, IN BOOLEAN MapSids, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, OUT PULONG NewAclSizeParam, OUT PACL NewAcl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a18">RtlpGenerateInheritedAce</a> (IN PACE_HEADER OldAce, IN BOOLEAN IsDirectoryObject, IN BOOLEAN AutoInherit, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN GUID *NewObjectType OPTIONAL, OUT PULONG NewAceLength, OUT PACL NewAcl, OUT PULONG NewAceExtraLength, OUT PBOOLEAN ObjectAceInherited)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a19">RtlpGenerateInheritAcl</a> (IN PACL Acl, IN BOOLEAN IsDirectoryObject, IN BOOLEAN AutoInherit, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN GUID *NewObjectType OPTIONAL, OUT PULONG NewAclSizeParam, OUT PACL NewAcl, OUT PBOOLEAN ObjectAceInherited)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a20">RtlpInheritAcl2</a> (IN PACL DirectoryAcl, IN PACL ChildAcl, IN ULONG ChildGenericControl, IN BOOLEAN IsDirectoryObject, IN BOOLEAN AutoInherit, IN BOOLEAN DefaultDescriptorForObject, IN PSID OwnerSid, IN PSID GroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN IsSacl, IN GUID *NewObjectType OPTIONAL, IN PULONG AclBufferSize, IN OUT PUCHAR AclBuffer, OUT PBOOLEAN NewAclExplicitlyAssigned, OUT PULONG NewGenericControl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a21">RtlpComputeMergedAcl</a> (IN PACL CurrentAcl, IN ULONG CurrentGenericControl, IN PACL ModificationAcl, IN ULONG ModificationGenericControl, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN IsSacl, OUT PACL *NewAcl, OUT PULONG NewGenericControl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a22">RtlpComputeMergedAcl2</a> (IN PACL CurrentAcl, IN ULONG CurrentGenericControl, IN PACL ModificationAcl, IN ULONG ModificationGenericControl, IN PSID ClientOwnerSid, IN PSID ClientGroupSid, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN IsSacl, IN PULONG AclBufferSize, IN OUT PUCHAR AclBuffer, OUT PULONG NewGenericControl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a23">RtlpCompareAces</a> (IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> InheritedAce, IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> ChildAce, IN PSID OwnerSid, IN PSID GroupSid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a24">RtlpCompareKnownObjectAces</a> (IN PKNOWN_OBJECT_ACE InheritedAce, IN PKNOWN_OBJECT_ACE ChildAce, IN PSID OwnerSid OPTIONAL, IN PSID GroupSid OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a25">RtlpCompareKnownAces</a> (IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> InheritedAce, IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> ChildAce, IN PSID OwnerSid OPTIONAL, IN PSID GroupSid OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a26">RtlpIsDuplicateAce</a> (IN PACL Acl, IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> NewAce, IN GUID *ObjectType OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a27">RtlpCreateServerAcl</a> (IN PACL Acl, IN BOOLEAN AclUntrusted, IN PSID ServerSid, OUT PACL *ServerAcl, OUT BOOLEAN *ServerAclAllocated)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a28">RtlpGetDefaultsSubjectContext</a> (HANDLE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>, OUT PTOKEN_OWNER *OwnerInfo, OUT PTOKEN_PRIMARY_GROUP *GroupInfo, OUT PTOKEN_DEFAULT_DACL *DefaultDaclInfo, OUT PTOKEN_OWNER *ServerOwner, OUT PTOKEN_PRIMARY_GROUP *ServerGroup)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a29">RtlpValidateSDOffsetAndSize</a> (IN ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, IN ULONG Length, IN ULONG MinLength, OUT PULONG MaxLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a30">RtlValidRelativeSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptorInput, IN ULONG SecurityDescriptorLength, IN SECURITY_INFORMATION RequiredInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a31">RtlRunEncodeUnicodeString</a> (PUCHAR <a class="el" href="../../d1/d1/theap_8c.html#a17">Seed</a> OPTIONAL, PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a32">RtlRunDecodeUnicodeString</a> (UCHAR <a class="el" href="../../d1/d1/theap_8c.html#a17">Seed</a>, PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a33">RtlEraseUnicodeString</a> (PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a34">RtlAdjustPrivilege</a> (ULONG Privilege, BOOLEAN Enable, BOOLEAN Client, PBOOLEAN WasEnabled)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a> (IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a> (IN PSID Sid1, IN PSID Sid2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a37">RtlEqualPrefixSid</a> (IN PSID Sid1, IN PSID Sid2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a> (IN ULONG SubAuthorityCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a39">RtlAllocateAndInitializeSid</a> (IN PSID_IDENTIFIER_AUTHORITY IdentifierAuthority, IN UCHAR SubAuthorityCount, IN ULONG SubAuthority0, IN ULONG SubAuthority1, IN ULONG SubAuthority2, IN ULONG SubAuthority3, IN ULONG SubAuthority4, IN ULONG SubAuthority5, IN ULONG SubAuthority6, IN ULONG SubAuthority7, OUT PSID *Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a> (IN PSID Sid, IN PSID_IDENTIFIER_AUTHORITY IdentifierAuthority, IN UCHAR SubAuthorityCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a41">RtlFreeSid</a> (IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSID_IDENTIFIER_AUTHORITY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a42">RtlIdentifierAuthoritySid</a> (IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a> (IN PSID Sid, IN ULONG SubAuthority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PUCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a> (IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a> (IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a> (IN ULONG DestinationSidLength, OUT PSID DestinationSid, IN PSID SourceSid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a> (IN ULONG ArrayLength, IN PSID_AND_ATTRIBUTES Source, IN ULONG TargetSidBufferSize, OUT PSID_AND_ATTRIBUTES TargetArrayElement, OUT PSID TargetSid, OUT PSID *NextTargetSid, OUT PULONG RemainingTargetSidBufferSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a48">RtlLengthSidAsUnicodeString</a> (PSID Sid, PULONG StringLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a49">RtlConvertSidToUnicodeString</a> (PUNICODE_STRING UnicodeString, PSID Sid, BOOLEAN AllocateDestinationString)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a> (IN PLUID Luid1, IN PLUID Luid2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a51">RtlCopyLuid</a> (OUT PLUID DestinationLuid, IN PLUID SourceLuid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a52">RtlCopyLuidAndAttributesArray</a> (IN ULONG ArrayLength, IN PLUID_AND_ATTRIBUTES Source, OUT PLUID_AND_ATTRIBUTES Target)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN ULONG Revision)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a54">RtlCreateSecurityDescriptorRelative</a> (IN PISECURITY_DESCRIPTOR_RELATIVE SecurityDescriptor, IN ULONG Revision)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a57">RtlSetAttributesSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN SECURITY_DESCRIPTOR_CONTROL Control, OUT PULONG Revision)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a58">RtlGetControlSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PSECURITY_DESCRIPTOR_CONTROL Control, OUT PULONG Revision)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a59">RtlSetControlSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR pSecurityDescriptor, IN SECURITY_DESCRIPTOR_CONTROL ControlBitsOfInterest, IN SECURITY_DESCRIPTOR_CONTROL ControlBitsToSet)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN BOOLEAN DaclPresent, IN PACL <a class="el" href="../../d2/d1/cttoken_8c.html#a55">Dacl</a> OPTIONAL, IN BOOLEAN DaclDefaulted OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PBOOLEAN DaclPresent, OUT PACL *<a class="el" href="../../d2/d1/cttoken_8c.html#a55">Dacl</a>, OUT PBOOLEAN DaclDefaulted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a62">RtlSetSaclSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN BOOLEAN SaclPresent, IN PACL Sacl OPTIONAL, IN BOOLEAN SaclDefaulted OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a63">RtlGetSaclSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PBOOLEAN SaclPresent, OUT PACL *Sacl, OUT PBOOLEAN SaclDefaulted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID <a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a> OPTIONAL, IN BOOLEAN OwnerDefaulted OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a65">RtlGetOwnerSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PSID *<a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a>, OUT PBOOLEAN OwnerDefaulted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID <a class="el" href="../../d2/d1/cttoken_8c.html#a54">Group</a> OPTIONAL, IN BOOLEAN GroupDefaulted OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a67">RtlGetGroupSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PSID *<a class="el" href="../../d2/d1/cttoken_8c.html#a54">Group</a>, OUT PBOOLEAN GroupDefaulted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a> (IN ACCESS_MASK GrantedAccess, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a69">RtlAreAnyAccessesGranted</a> (IN ACCESS_MASK GrantedAccess, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a> (IN OUT PACCESS_MASK AccessMask, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a71">RtlImpersonateSelf</a> (IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a72">RtlpValidOwnerSubjectContext</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN PSID <a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a>, IN BOOLEAN ServerObject, OUT PNTSTATUS ReturnStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a73">RtlpApplyAclToObject</a> (IN PACL Acl, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a74">RtlpInheritAcl</a> (IN PACL DirectoryAcl, IN PACL ChildAcl, IN ULONG ChildGenericControl, IN BOOLEAN IsDirectoryObject, IN BOOLEAN AutoInherit, IN BOOLEAN DefaultDescriptorForObject, IN PSID OwnerSid, IN PSID GroupSid, IN PSID ServerOwnerSid OPTIONAL, IN PSID ServerGroupSid OPTIONAL, IN PGENERIC_MAPPING GenericMapping, IN BOOLEAN IsSacl, IN GUID *NewObjectType OPTIONAL, OUT PACL *NewAcl, OUT PBOOLEAN NewAclExplicitlyAssigned, OUT PULONG NewGenericControl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a75">RtlpConvertToAutoInheritSecurityObject</a> (IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN PSECURITY_DESCRIPTOR CurrentSecurityDescriptor, OUT PSECURITY_DESCRIPTOR *NewSecurityDescriptor, IN GUID *ObjectType OPTIONAL, IN BOOLEAN IsDirectoryObject, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a> (IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN PSECURITY_DESCRIPTOR CreatorDescriptor OPTIONAL, OUT PSECURITY_DESCRIPTOR *NewDescriptor, IN GUID *ObjectType OPTIONAL, IN BOOLEAN IsDirectoryObject, IN ULONG AutoInheritFlags, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a> OPTIONAL, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a> (IN PVOID Object OPTIONAL, IN SECURITY_INFORMATION SecurityInformation, IN PSECURITY_DESCRIPTOR ModificationDescriptor, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN ULONG AutoInheritFlags, IN ULONG PoolType, IN PGENERIC_MAPPING GenericMapping, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a78">RtlGetSecurityDescriptorRMControl</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, OUT PUCHAR RMControl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a79">RtlSetSecurityDescriptorRMControl</a> (IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN PUCHAR RMControl OPTIONAL)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a8">RtlIsSystemAceType</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> = FALSE</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a6" doxytag="sertl.c::AceFlagsInAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define AceFlagsInAce          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_Ace&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(((PACE_HEADER)(_Ace))-&gt;AceFlags &amp; (OBJECT_INHERIT_ACE|CONTAINER_INHERIT_ACE) | \
             (((PACE_HEADER)(_Ace))-&gt;AceFlags &amp; INHERIT_ONLY_ACE) ^ INHERIT_ONLY_ACE )
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l06966">6966</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="sertl.c::CREATOR_SID_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CREATOR_SID_SIZE&nbsp;&nbsp;&nbsp;12          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00330">330</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03880">RtlpCopyEffectiveAce()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l05381">RtlpGenerateInheritedAce()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="sertl.c::EFFECTIVE_ACE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EFFECTIVE_ACE&nbsp;&nbsp;&nbsp;INHERIT_ONLY_ACE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l06965">6965</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="sertl.c::max" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define max          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((a) &gt; (b)) ? (a) : (b))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">332</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/loadbits_8c-source.html#l00026">_CreateEmptyCursorObject()</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00316">_MapWindowPoints()</a>, <a class="el" href="../../d9/d7/arbiter_8c-source.html#l02592">ArbGetNextAllocationRange()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l00925">CalcSBStuff2()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00769">CheckPlacementBounds()</a>, <a class="el" href="../../d2/d3/combo_8c-source.html#l00207">ComboBoxWndProcWorker()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02935">CommandListPopup()</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00146">ComputeSecPerCluster()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00603">ConvertToFullScreen()</a>, <a class="el" href="../../d1/d0/lh__core_2genluts_8c-source.html#l01999">Create_LH_ProfileSet()</a>, <a class="el" href="../../d9/d3/sprite_8c-source.html#l00054">CreateRedirectionBitmap()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00485">CreateScreenBuffer()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04346">DrawCommandListPopup()</a>, <a class="el" href="../../d0/d2/mngrayc_8c-source.html#l00075">DrawStateW()</a>, <a class="el" href="../../d9/d3/editec_8c-source.html#l03692">ECCalcChangeSelection()</a>, <a class="el" href="../../d9/d3/editec_8c-source.html#l03652">ECFindXORblks()</a>, <a class="el" href="../../d6/d3/edecrare_8c-source.html#l01337">ECImeComposition()</a>, <a class="el" href="../../d6/d3/edecrare_8c-source.html#l00516">ECSetPasswordChar()</a>, <a class="el" href="../../d9/d3/editec_8c-source.html#l00770">ECTabTheTextOut()</a>, <a class="el" href="../../d9/d0/fdengine_8c-source.html#l03172">FdGetMinimumSizeMB()</a>, <a class="el" href="../../d2/d2/dtbitmap_8c-source.html#l00264">GetDeskWallpaperName()</a>, <a class="el" href="../../d2/d2/dtbitmap_8c-source.html#l00729">GetWallpaperCenterRect()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00207">GetWindowLimits()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04653">HorizontalScroll()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01471">InitCreateUserSubsystem()</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00191">IntersectRect()</a>, <a class="el" href="../../d7/d0/ntcon_2server_2cursor_8c-source.html#l00033">InvertPixels()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l01047">IopCreateArcNames()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">IopMakeGloballyUniqueId()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>, <a class="el" href="../../d7/d3/mips_2intobj_8c-source.html#l00153">KeConnectInterrupt()</a>, <a class="el" href="../../d7/d3/mips_2intobj_8c-source.html#l00301">KeDisconnectInterrupt()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00779">KeSetTimeIncrement()</a>, <a class="el" href="../../d3/d0/xipi_8c-source.html#l00040">KiIpiGenericCall()</a>, <a class="el" href="../../d0/d1/lboxctl2_8c-source.html#l01090">LastFullVisible()</a>, <a class="el" href="../../d2/d1/lboxmult_8c-source.html#l00025">LBCalcItemRowsAndColumns()</a>, <a class="el" href="../../d4/d1/lboxvar_8c-source.html#l00157">LBPage()</a>, <a class="el" href="../../d7/d0/lb1_8c-source.html#l00032">ListBoxWndProcWorker()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l01562">MLBuildchLines()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l00085">MLCalcXOffset()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l01367">MLDeleteText()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l03991">MLDrawText()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l03457">MLEditWndProc()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l00443">MLIchToLine()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l01040">MLInsertText()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l00689">MLMouseToIch()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l02966">MLScroll()</a>, <a class="el" href="../../d2/d4/editml_8c-source.html#l00292">MLSetCaretPosition()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l00324">ParkIcon()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00765">PositionConsoleWindow()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l01191">ProcessDeviceChanges()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05893">RtlpComputeMergedAcl2()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05722">RtlpGenerateInheritAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05381">RtlpGenerateInheritedAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l04716">RtlpInheritAcl2()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00378">RW_RegisterControls()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00837">SelectInputContext()</a>, <a class="el" href="../../d2/d0/inctlpan_8c-source.html#l01213">SetIconMetrics()</a>, <a class="el" href="../../d2/d0/inctlpan_8c-source.html#l01170">SetMinMetrics()</a>, <a class="el" href="../../d4/d4/editsl_8c-source.html#l00080">SLCalcXOffsetSpecial()</a>, <a class="el" href="../../d4/d4/editsl_8c-source.html#l01304">SLChar()</a>, <a class="el" href="../../d4/d4/editsl_8c-source.html#l00507">SLDrawLine()</a>, <a class="el" href="../../d4/d4/editsl_8c-source.html#l00126">SLSetCaretPosition()</a>, <a class="el" href="../../d4/d7/winmgrc_8c-source.html#l01210">SmoothScrollWindowEx()</a>, <a class="el" href="../../d7/d3/msgbox_8c-source.html#l00730">SoftModalMessageBox()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02998">StreamScrollRegion()</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00241">UnionRect()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00564">UpdateUserScreen()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04575">VerticalScroll()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l02641">WowGetDefWindowProcBits()</a>, <a class="el" href="../../d9/d1/__output_8h-source.html#l02145">WWSB_ConsolePolyTextOut()</a>, <a class="el" href="../../d9/d1/__output_8h-source.html#l00552">WWSB_WriteRegionToScreen()</a>, <a class="el" href="../../d9/d1/__output_8h-source.html#l00918">WWSB_WriteToScreen()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l01401">xxxAdjustSize()</a>, <a class="el" href="../../d0/d1/lboxctl2_8c-source.html#l03754">xxxAlterHilite()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l00558">xxxAnimateCaption()</a>, <a class="el" href="../../d8/d8/icons_8c-source.html#l00031">xxxArrangeIconicWindows()</a>, <a class="el" href="../../d9/d0/btnctl_8c-source.html#l00722">xxxBNDrawText()</a>, <a class="el" href="../../d4/d3/comboini_8c-source.html#l00253">xxxCBCalcControlRects()</a>, <a class="el" href="../../d4/d3/comboini_8c-source.html#l00485">xxxCBSetEditItemHeight()</a>, <a class="el" href="../../d2/d3/combo_8c-source.html#l01819">xxxCBShowListBoxWindow()</a>, <a class="el" href="../../d7/d1/mndraw_8c-source.html#l01972">xxxDrawMenuBarTemp()</a>, <a class="el" href="../../d7/d1/mndraw_8c-source.html#l00750">xxxDrawMenuItem()</a>, <a class="el" href="../../d9/d1/mngray_8c-source.html#l00169">xxxDrawState()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l00032">xxxInitSendValidateMinMaxInfo()</a>, <a class="el" href="../../d0/d1/lboxctl2_8c-source.html#l02092">xxxInsureVisible()</a>, <a class="el" href="../../d9/d0/lboxctl1_8c-source.html#l00722">xxxLBBinarySearchString()</a>, <a class="el" href="../../d0/d1/lboxctl2_8c-source.html#l03206">xxxLBSelRange()</a>, <a class="el" href="../../d3/d1/lboxrare_8c-source.html#l00514">xxxLBSize()</a>, <a class="el" href="../../d5/d1/mncomput_8c-source.html#l00233">xxxMNCompute()</a>, <a class="el" href="../../d5/d1/mncomput_8c-source.html#l00062">xxxMNItemSize()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l01683">xxxMNPositionHierarchy()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03213">xxxMouseEventDirect()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00437">xxxMS_TrackMove()</a>, <a class="el" href="../../d6/d4/statctl_8c-source.html#l01211">xxxNextAniIconStep()</a>, <a class="el" href="../../d7/d1/mndraw_8c-source.html#l00954">xxxRealDrawMenuItem()</a>, <a class="el" href="../../d9/d0/lboxctl1_8c-source.html#l00026">xxxSetLBScrollParms()</a>, <a class="el" href="../../d2/d0/inctlpan_8c-source.html#l00861">xxxSetNCFonts()</a>, <a class="el" href="../../d6/d4/statctl_8c-source.html#l00094">xxxSetStaticImage()</a>, <a class="el" href="../../d2/d0/inctlpan_8c-source.html#l01080">xxxSetWindowNCMetrics()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l01497">xxxSystemParametersInfo()</a>, <a class="el" href="../../d0/d1/lboxctl2_8c-source.html#l01290">xxxTrackMouse()</a>, and <a class="el" href="../../d8/d0/ntuser_2kernel_2cursor_8c-source.html#l00216">zzzClipCursor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="sertl.c::MAX_CHILD_SID_GROUP_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_CHILD_SID_GROUP_SIZE&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l06964">6964</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="sertl.c::ProbeAndReadUlongUM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ProbeAndReadUlongUM          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Address&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(*(volatile ULONG *)(Address))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="sertl.c::SE_VALID_CONTROL_BITS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SE_VALID_CONTROL_BITS          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( SE_DACL_UNTRUSTED | \
                                SE_SERVER_SECURITY | \
                                SE_DACL_AUTO_INHERIT_REQ | \
                                SE_SACL_AUTO_INHERIT_REQ | \
                                SE_DACL_AUTO_INHERITED | \
                                SE_SACL_AUTO_INHERITED | \
                                SE_DACL_PROTECTED | \
                                SE_SACL_PROTECTED )
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00370">370</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l02386">RtlSetAttributesSecurityDescriptor()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l02472">RtlSetControlSecurityDescriptor()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a80" doxytag="sertl.c::ACE_TYPE_TO_COPY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d8/d6/sertl_8c.html#a80">ACE_TYPE_TO_COPY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a80a10" doxytag="CopyInheritedAces" ></a>CopyInheritedAces</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a80a11" doxytag="CopyNonInheritedAces" ></a>CopyNonInheritedAces</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a80a12" doxytag="CopyAllAces" ></a>CopyAllAces</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00089">89</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l04716">RtlpInheritAcl2()</a>.
<p>
<pre class="fragment"><div>00089              {
00090      <a class="code" href="../../d8/d6/sertl_8c.html#a80a10">CopyInheritedAces</a>,
00091      <a class="code" href="../../d8/d6/sertl_8c.html#a80a11">CopyNonInheritedAces</a>,
00092      <a class="code" href="../../d8/d6/sertl_8c.html#a80a12">CopyAllAces</a> } <a class="code" href="../../d8/d6/sertl_8c.html#a80">ACE_TYPE_TO_COPY</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a34" doxytag="sertl.c::RtlAdjustPrivilege" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAdjustPrivilege           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Privilege</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Client</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WasEnabled</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00639">639</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/tfilmem_8c-source.html#l00037">Buffer1</a>, <a class="el" href="../../d0/d0/tfilmem_8c-source.html#l00038">Buffer2</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00046">NtAdjustPrivilegesToken()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00051">main()</a>.
<p>
<pre class="fragment"><div>00648                    :
00649 
00650     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> enables or disables a privilege process-wide.
00651 
00652 Arguments:
00653 
00654     Privilege - The lower 32-bits of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> to be enabled or
00655         disabled.  The upper 32-bits <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be zero.
00656 
00657     Enable - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be enabled
00658         or disabled.  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be enabled.
00659         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be disabled.
00660 
00661     Client - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege should be adjusted
00662         in a client token or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's own token.   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates
00663         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's token should be used (and an error returned <span class="keywordflow">if</span> there
00664         is no client token).  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's token should
00665         be used.
00666 
00667     WasEnabled - points to a <span class="keywordtype">boolean</span> to receive an indication of whether
00668         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege was previously enabled or disabled.  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates
00669         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege was previously enabled.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege
00670         was previoulsy disabled.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> useful <span class="keywordflow">for</span> returning <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00671         privilege to its original state after <span class="keyword">using</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00672 
00673 
00674 Return Value:
00675 
00676     STATUS_SUCCESS - The privilege has been sucessfully enabled or disabled.
00677 
00678     STATUS_PRIVILEGE_NOT_HELD - The privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not held by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context.
00679 
00680     Other status values as may be returned by:
00681 
00682             <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>()
00683             NtAdjustPrivilegesToken()
00684 
00685 
00686 --*/
00687 
00688 {
00689     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00690         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
00691         TmpStatus;
00692 
00693     HANDLE
00694         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00695 
00696     LUID
00697         LuidPrivilege;
00698 
00699     PTOKEN_PRIVILEGES
00700         NewPrivileges,
00701         OldPrivileges;
00702 
00703     ULONG
00704         Length;
00705 
00706     UCHAR
00707         <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>[<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES)+
00708                 ((1-<a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>)*<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES))],
00709         <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>[<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES)+
00710                 ((1-<a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>)*<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES))];
00711 
00712 
00713     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00714 
00715     NewPrivileges = (PTOKEN_PRIVILEGES)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>;
00716     OldPrivileges = (PTOKEN_PRIVILEGES)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>;
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Open the appropriate token...</span>
00720     <span class="comment">//</span>
00721 
00722     <span class="keywordflow">if</span> (Client == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00723         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
00724                      NtCurrentThread(),
00725                      TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,
00726                      FALSE,
00727                      &amp;Token
00728                      );
00729     } <span class="keywordflow">else</span> {
00730 
00731         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
00732                      NtCurrentProcess(),
00733                      TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,
00734                      &amp;Token
00735                     );
00736     }
00737 
00738     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00739         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00740     }
00741 
00742 
00743 
00744     <span class="comment">//</span>
00745     <span class="comment">// Initialize the privilege adjustment structure</span>
00746     <span class="comment">//</span>
00747 
00748     LuidPrivilege = RtlConvertUlongToLuid(Privilege);
00749 
00750 
00751     NewPrivileges-&gt;PrivilegeCount = 1;
00752     NewPrivileges-&gt;Privileges[0].Luid = LuidPrivilege;
00753     NewPrivileges-&gt;Privileges[0].Attributes = Enable ? SE_PRIVILEGE_ENABLED : 0;
00754 
00755 
00756 
00757     <span class="comment">//</span>
00758     <span class="comment">// Adjust the privilege</span>
00759     <span class="comment">//</span>
00760 
00761     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
00762                  Token,                     <span class="comment">// TokenHandle</span>
00763                  FALSE,                     <span class="comment">// DisableAllPrivileges</span>
00764                  NewPrivileges,             <span class="comment">// NewPrivileges</span>
00765                  <span class="keyword">sizeof</span>(Buffer1),           <span class="comment">// BufferLength</span>
00766                  OldPrivileges,             <span class="comment">// PreviousState (OPTIONAL)</span>
00767                  &amp;Length                    <span class="comment">// ReturnLength</span>
00768                  );
00769 
00770 
00771     TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Token);
00772     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus));
00773 
00774 
00775     <span class="comment">//</span>
00776     <span class="comment">// Map the success code NOT_ALL_ASSIGNED to an appropriate error</span>
00777     <span class="comment">// since we're only trying to adjust the one privilege.</span>
00778     <span class="comment">//</span>
00779 
00780     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_ALL_ASSIGNED) {
00781         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
00782     }
00783 
00784 
00785     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00786 
00787         <span class="comment">//</span>
00788         <span class="comment">// If there are no privileges in the previous state, there were</span>
00789         <span class="comment">// no changes made. The previous state of the privilege</span>
00790         <span class="comment">// is whatever we tried to change it to.</span>
00791         <span class="comment">//</span>
00792 
00793         <span class="keywordflow">if</span> (OldPrivileges-&gt;PrivilegeCount == 0) {
00794 
00795             (*WasEnabled) = Enable;
00796 
00797         } <span class="keywordflow">else</span> {
00798 
00799             (*WasEnabled) =
00800                 (OldPrivileges-&gt;Privileges[0].Attributes &amp; SE_PRIVILEGE_ENABLED)
00801                 ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00802         }
00803     }
00804 
00805     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00806 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="sertl.c::RtlAllocateAndInitializeSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAllocateAndInitializeSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID_IDENTIFIER_AUTHORITY&nbsp;</td>
          <td class="mdname" nowrap> <em>IdentifierAuthority</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthorityCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthority0</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthority1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthority2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthority3</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthority4</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthority5</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthority6</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthority7</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01062">1062</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00705">CreateBSMEventSD()</a>, and <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">CsrpConnectToServer()</a>.
<p>
<pre class="fragment"><div>01078                    :
01079 
01080     This function allocates and initializes a sid with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
01081     number of sub-authorities (up to 8).  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> sid allocated with <span class="keyword">this</span>
01082     routine must be freed <span class="keyword">using</span> <a class="code" href="../../d8/d6/sertl_8c.html#a41">RtlFreeSid</a>().
01083 
01084     THIS ROUTINE IS CURRENTLY NOT CALLABLE FROM <a class="code" href="../../d0/d2/genxx_8h.html#a22">KERNEL</a> <a class="code" href="../../d3/d6/nec98_8h.html#a17">MODE</a>.
01085 
01086 Arguments:
01087 
01088     IdentifierAuthority - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Identifier Authority value to
01089         set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID.
01090 
01091     SubAuthorityCount - The number of sub-authorities to place in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID.
01092         This also identifies how many of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SubAuthorityN parameters
01093         have meaningful values.  This must contain a value from 0 through
01094         8.
01095 
01096     SubAuthority0-7 - Provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding sub-authority value to
01097         place in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID.  For example, a SubAuthorityCount value of 3
01098         indicates that SubAuthority0, SubAuthority1, and SubAuthority0
01099         have meaningful values and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rest are to be ignored.
01100 
01101     Sid - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID data structure to initialize.
01102 
01103 Return Value:
01104 
01105     STATUS_SUCCESS - The SID has been allocated and initialized.
01106 
01107     STATUS_NO_MEMORY - The attempt to allocate memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID
01108         failed.
01109 
01110     STATUS_INVALID_SID - The number of sub-authorities specified did
01111         not fall in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> valid range <span class="keywordflow">for</span> <span class="keyword">this</span> api (0 through 8).
01112 
01113 
01114 --*/
01115 {
01116     PISID ISid;
01117 
01118     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01119 
01120     <span class="keywordflow">if</span> ( SubAuthorityCount &gt; 8 ) {
01121         <span class="keywordflow">return</span>( STATUS_INVALID_SID );
01122     }
01123 
01124     ISid = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0,
01125                             <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(SubAuthorityCount)
01126                             );
01127     <span class="keywordflow">if</span> (ISid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01128         <span class="keywordflow">return</span>(STATUS_NO_MEMORY);
01129     }
01130 
01131     ISid-&gt;SubAuthorityCount = (UCHAR)SubAuthorityCount;
01132     ISid-&gt;Revision = 1;
01133     ISid-&gt;IdentifierAuthority = *IdentifierAuthority;
01134 
01135     <span class="keywordflow">switch</span> (SubAuthorityCount) {
01136 
01137     <span class="keywordflow">case</span> 8:
01138         ISid-&gt;SubAuthority[7] = SubAuthority7;
01139     <span class="keywordflow">case</span> 7:
01140         ISid-&gt;SubAuthority[6] = SubAuthority6;
01141     <span class="keywordflow">case</span> 6:
01142         ISid-&gt;SubAuthority[5] = SubAuthority5;
01143     <span class="keywordflow">case</span> 5:
01144         ISid-&gt;SubAuthority[4] = SubAuthority4;
01145     <span class="keywordflow">case</span> 4:
01146         ISid-&gt;SubAuthority[3] = SubAuthority3;
01147     <span class="keywordflow">case</span> 3:
01148         ISid-&gt;SubAuthority[2] = SubAuthority2;
01149     <span class="keywordflow">case</span> 2:
01150         ISid-&gt;SubAuthority[1] = SubAuthority1;
01151     <span class="keywordflow">case</span> 1:
01152         ISid-&gt;SubAuthority[0] = SubAuthority0;
01153     <span class="keywordflow">case</span> 0:
01154         ;
01155     }
01156 
01157     (*Sid) = ISid;
01158     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01159 
01160 }
<span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="sertl.c::RtlAreAllAccessesGranted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlAreAllAccessesGranted           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03309">3309</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03498">_BlockInput()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00492">CheckGrantedAccess()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00518">CheckWinstaWriteAttributesAccess()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">InitiateShutdown()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03403">xxxInternalKeyEventDirect()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l01077">xxxSetProcessWindowStation()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>03316                    :
03317 
03318     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to check a desired access mask against a
03319     granted access mask.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Object Management
03320     component when dereferencing a handle.
03321 
03322 Arguments:
03323 
03324         GrantedAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted access mask.
03325 
03326         DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access mask.
03327 
03328 Return Value:
03329 
03330     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GrantedAccess mask has all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bits set
03331         that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DesiredAccess mask has set.  That <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03332         returned <span class="keywordflow">if</span> all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired accesses have been granted.
03333 
03334 --*/
03335 
03336 {
03337     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03338 
03339     <span class="keywordflow">return</span> ((BOOLEAN)((~(GrantedAccess) &amp; (DesiredAccess)) == 0));
03340 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="sertl.c::RtlAreAnyAccessesGranted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlAreAnyAccessesGranted           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03344">3344</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04907">NtUserGetAsyncKeyState()</a>.
<p>
<pre class="fragment"><div>03351                    :
03352 
03353     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to test whether any of a set of desired
03354     accesses are granted by a granted access mask.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by
03355     components other than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Object Management component <span class="keywordflow">for</span>
03356     checking access mask subsets.
03357 
03358 Arguments:
03359 
03360         GrantedAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted access mask.
03361 
03362         DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access mask.
03363 
03364 Return Value:
03365 
03366     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GrantedAccess mask contains any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bits
03367         specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DesiredAccess mask.  That <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, <span class="keywordflow">if</span> any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03368         desired accesses have been granted, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
03369 
03370 
03371 --*/
03372 
03373 {
03374     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03375 
03376     <span class="keywordflow">return</span> ((BOOLEAN)(((GrantedAccess) &amp; (DesiredAccess)) != 0));
03377 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="sertl.c::RtlConvertSidToUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlConvertSidToUnicodeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocateDestinationString</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01611">1611</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01935">RtlCreateUnicodeString()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00352">RtlIntegerToUnicode()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00544">RtlLargeIntegerToUnicode()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01453">RtlFormatCurrentUserKeyPath()</a>.
<p>
<pre class="fragment"><div>01619                    :
01620 
01621 
01622     This function generates a printable unicode string representation
01623     of a SID.
01624 
01625     The resulting string will take one of two forms.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01626     IdentifierAuthority value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not greater than 2^32, then
01627     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID will be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> form:
01628 
01629 
01630         S-1-281736-12-72-9-110
01631               ^    ^^ ^^ ^ ^^^
01632               |     |  | |  |
01633               +-----+--+-+--+---- Decimal
01634 
01635 
01636 
01637     Otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> form:
01638 
01639 
01640         S-1-0x173495281736-12-72-9-110
01641             ^^^^^^^^^^^^^^ ^^ ^^ ^ ^^^
01642              Hexidecimal    |  | |  |
01643                             +--+-+--+---- Decimal
01644 
01645 
01646 
01647 
01648 
01649 
01650 Arguments:
01651 
01652 
01653 
01654     UnicodeString - Returns a unicode string that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> equivalent to
01655         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID. The maximum length field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> set <span class="keywordflow">if</span>
01656         AllocateDestinationString <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
01657 
01658     Sid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be converted to unicode.
01659 
01660     AllocateDestinationString - Supplies a flag that controls whether or
01661         not <span class="keyword">this</span> API allocates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer space <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination
01662         string.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer must be deallocated <span class="keyword">using</span>
01663         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a> (note that only storage <span class="keywordflow">for</span>
01664         DestinationString-&gt;Buffer is allocated by <span class="keyword">this</span> API).
01665 
01666 Return Value:
01667 
01668     SUCCESS - The conversion was successful
01669 
01670     STATUS_INVALID_SID - The sid provided does not have a valid structure,
01671         or has too many sub-authorities (more than SID_MAX_SUB_AUTHORITIES).
01672 
01673     STATUS_NO_MEMORY - There was not sufficient memory to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01674         target string.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> AllocateDestinationString
01675         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
01676 
01677     STATUS_BUFFER_OVERFLOW - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span>
01678         AllocateDestinationString <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
01679 
01680 
01681 --*/
01682 
01683 {
01684     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01685     WCHAR UniBuffer[ 256 ];
01686     PWSTR <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> ;
01687     UNICODE_STRING LocalString ;
01688 
01689     UCHAR   i;
01690     ULONG   Tmp;
01691     LARGE_INTEGER Auth ;
01692 
01693     PISID   iSid = (PISID)Sid;  <span class="comment">// pointer to opaque structure</span>
01694 
01695 
01696     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01697 
01698     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( Sid ) != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01699         <span class="keywordflow">return</span>(STATUS_INVALID_SID);
01700     }
01701 
01702     <span class="keywordflow">if</span> ( iSid-&gt;Revision != SID_REVISION )
01703     {
01704         <span class="keywordflow">return</span> STATUS_INVALID_SID ;
01705     }
01706 
01707     wcscpy( UniBuffer, L<span class="stringliteral">"S-1-"</span> );
01708 
01709     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = &amp;UniBuffer[ 4 ];
01710 
01711     <span class="keywordflow">if</span> (  (iSid-&gt;IdentifierAuthority.Value[0] != 0)  ||
01712           (iSid-&gt;IdentifierAuthority.Value[1] != 0)     ){
01713 
01714         <span class="comment">//</span>
01715         <span class="comment">// Ugly hex dump.</span>
01716         <span class="comment">//</span>
01717 
01718         Auth.HighPart = (LONG) (iSid-&gt;IdentifierAuthority.Value[ 0 ] &lt;&lt; 8) +
01719                         (LONG) iSid-&gt;IdentifierAuthority.Value[ 1 ] ;
01720 
01721         Auth.LowPart = (ULONG)iSid-&gt;IdentifierAuthority.Value[5]          +
01722                        (ULONG)(iSid-&gt;IdentifierAuthority.Value[4] &lt;&lt;  8)  +
01723                        (ULONG)(iSid-&gt;IdentifierAuthority.Value[3] &lt;&lt; 16)  +
01724                        (ULONG)(iSid-&gt;IdentifierAuthority.Value[2] &lt;&lt; 24);
01725 
01726         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a8">RtlLargeIntegerToUnicode</a>(
01727                         &amp;Auth,
01728                         16,
01729                         256 - (LONG) (Offset - UniBuffer),
01730                         Offset );
01731 
01732 
01733     } <span class="keywordflow">else</span> {
01734 
01735         Tmp = (ULONG)iSid-&gt;IdentifierAuthority.Value[5]          +
01736               (ULONG)(iSid-&gt;IdentifierAuthority.Value[4] &lt;&lt;  8)  +
01737               (ULONG)(iSid-&gt;IdentifierAuthority.Value[3] &lt;&lt; 16)  +
01738               (ULONG)(iSid-&gt;IdentifierAuthority.Value[2] &lt;&lt; 24);
01739 
01740         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a5">RtlIntegerToUnicode</a>(
01741                         Tmp,
01742                         10,
01743                         256 - (LONG) (Offset - UniBuffer),
01744                         Offset );
01745 
01746     }
01747 
01748     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) )
01749     {
01750         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01751     }
01752 
01753 
01754     <span class="keywordflow">for</span> (i=0;i&lt;iSid-&gt;SubAuthorityCount ;i++ ) {
01755 
01756         <span class="keywordflow">while</span> ( *<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp;&amp; ( <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &lt; &amp;UniBuffer[ 255 ] ) )
01757         {
01758             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>++ ;
01759         }
01760 
01761         *<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'-'</span> ;
01762 
01763         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a5">RtlIntegerToUnicode</a>(
01764                         iSid-&gt;SubAuthority[ i ],
01765                         10,
01766                         256 - (LONG) (Offset - UniBuffer),
01767                         Offset );
01768 
01769         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) )
01770         {
01771             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01772         }
01773     }
01774 
01775     <span class="keywordflow">if</span> ( AllocateDestinationString )
01776     {
01777         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>( UnicodeString,
01778                                          UniBuffer ) )
01779         {
01780             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
01781         }
01782         <span class="keywordflow">else</span>
01783         {
01784             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY ;
01785         }
01786 
01787     }
01788     <span class="keywordflow">else</span>
01789     {
01790 
01791         <span class="keywordflow">while</span> ( *<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp;&amp; ( <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &lt; &amp;UniBuffer[ 255 ] ) )
01792         {
01793             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>++ ;
01794         }
01795 
01796         Tmp = (ULONG) (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - UniBuffer) * <span class="keyword">sizeof</span>( WCHAR );
01797 
01798         <span class="keywordflow">if</span> ( Tmp &lt; UnicodeString-&gt;MaximumLength )
01799         {
01800             LocalString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) Tmp ;
01801             LocalString.MaximumLength = LocalString.Length + <span class="keyword">sizeof</span>( WCHAR );
01802             LocalString.Buffer = UniBuffer ;
01803 
01804             <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(
01805                         UnicodeString,
01806                         &amp;LocalString );
01807 
01808             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
01809         }
01810         <span class="keywordflow">else</span>
01811         {
01812             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW ;
01813         }
01814 
01815     }
01816 
01817     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01818 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="sertl.c::RtlCopyLuid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlCopyLuid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>DestinationLuid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceLuid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01863">1863</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l01690">NtCreateToken()</a>.
<p>
<pre class="fragment"><div>01870                    :
01871 
01872     This routine copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source LUID to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01873     destination LUID.
01874 
01875 Arguments:
01876 
01877     DestinationLuid - Receives a copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source Luid value.
01878 
01879     SourceLuid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Luid value to be copied.  This LUID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01880                  assumed to be structurally valid.
01881 
01882 Return Value:
01883 
01884     None.
01885 
01886 --*/
01887 
01888 {
01889     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01890 
01891     (*DestinationLuid) = (*SourceLuid);
01892     <span class="keywordflow">return</span>;
01893 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="sertl.c::RtlCopyLuidAndAttributesArray" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlCopyLuidAndAttributesArray           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ArrayLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLUID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>Target</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01896">1896</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, and <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01189">SeQueryInformationToken()</a>.
<p>
<pre class="fragment"><div>01904                    :
01905 
01906     This routine copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source LUID_AND_ATTRIBUTES array
01907     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target.
01908 
01909 Arguments:
01910 
01911     ArrayLength - Number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source array to copy.
01912 
01913     Source - The source array.
01914 
01915     Target - Indicates where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array elements are to be copied to.
01916 
01917 
01918 Return Value:
01919 
01920     None.
01921 
01922 
01923 --*/
01924 
01925 {
01926 
01927     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
01928 
01929     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01930 
01931     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ArrayLength) {
01932 
01933         Target[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = Source[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01934 
01935         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01936 
01937     } <span class="comment">//end_while</span>
01938 
01939 
01940     <span class="keywordflow">return</span>;
01941 
01942 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="sertl.c::RtlCopySid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCopySid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DestinationSidLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>DestinationSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceSid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">1380</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00037">AllocAce()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01844">GetSiteSidFromToken()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02492">NtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02627">NtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01098">RtlAddCompoundAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01436">RtlCopySidAndAttributesArray()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01405">RtlpAddKnownObjectAce()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01111">RtlpInitializeAllowedAce()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01211">RtlpInitializeAuditAce()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01161">RtlpInitializeDeniedAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l01099">SepAdjustGroups()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01189">SeQueryInformationToken()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00042">TestSeSid()</a>, <a class="el" href="../../d5/d5/tsevars_8c-source.html#l00167">TSeVariableInitialization()</a>, and <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>.
<p>
<pre class="fragment"><div>01388                    :
01389 
01390     This routine copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source SID to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination
01391     SID.
01392 
01393 Arguments:
01394 
01395     DestinationSidLength - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01396         destination SID buffer.
01397 
01398     DestinationSid - Pointer to a buffer to receive a copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01399         source Sid value.
01400 
01401     SourceSid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Sid value to be copied.
01402 
01403 Return Value:
01404 
01405     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID was successfully copied.
01406 
01407     STATUS_BUFFER_TOO_SMALL - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target buffer wasn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>
01408         large enough to receive a copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID.
01409 
01410 
01411 --*/
01412 
01413 {
01414     ULONG SidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(SourceSid);
01415 
01416     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01417 
01418     <span class="keywordflow">if</span> (SidLength &gt; DestinationSidLength) {
01419 
01420         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
01421 
01422     }
01423 
01424     <span class="comment">//</span>
01425     <span class="comment">// Buffer is large enough</span>
01426     <span class="comment">//</span>
01427 
01428     RtlMoveMemory( DestinationSid, SourceSid, SidLength );
01429 
01430     <span class="keywordflow">return</span> STATUS_SUCCESS;
01431 
01432 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="sertl.c::RtlCopySidAndAttributesArray" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCopySidAndAttributesArray           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ArrayLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetSidBufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetArrayElement</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NextTargetSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingTargetSidBufferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01436">1436</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00194">LongAlign</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00814">NtQueryInformationJobObject()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01189">SeQueryInformationToken()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00042">TestSeSid()</a>.
<p>
<pre class="fragment"><div>01448                    :
01449 
01450     This routine copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source SID_AND_ATTRIBUTES array
01451     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target.  The actual SID values are placed according to a separate
01452     parameter.  This allows multiple arrays to be merged <span class="keyword">using</span> <span class="keyword">this</span> service
01453     to copy each.
01454 
01455 Arguments:
01456 
01457     ArrayLength - Number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source array to copy.
01458 
01459     Source - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source array.
01460 
01461     TargetSidBufferSize - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
01462         to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual SID values.  If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> less than
01463         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual amount needed, then STATUS_BUFFER_TOO_SMALL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01464 
01465     TargetArrayElement - Indicates where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array elements are to be
01466         copied to (but not the SID values themselves).
01467 
01468     TargetSid - Indicates where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target SID values s are to be copied.  This
01469         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be ULONG aligned.  Each SID value will be copied
01470         into <span class="keyword">this</span> buffer.  Each SID will be ULONG aligned.
01471 
01472     NextTargetSid - On completion, will be set to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ULONG
01473         aligned address following <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last SID copied.
01474 
01475     RemainingTargetSidBufferSize - On completion, receives an indicatation
01476         of how much of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still unused.
01477 
01478 
01479 Return Value:
01480 
01481     STATUS_SUCCESS - The call completed successfully.
01482 
01483     STATUS_BUFFER_TOO_SMALL - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID
01484         values wasn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> large enough.
01485 
01486 
01487 
01488 --*/
01489 
01490 {
01491 
01492     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
01493     PSID NextSid = TargetSid;
01494     ULONG NextSidLength;
01495     ULONG AlignedSidLength;
01496     ULONG RemainingLength = TargetSidBufferSize;
01497 
01498     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01499 
01500     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ArrayLength) {
01501 
01502         NextSidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Source[Index].Sid );
01503         AlignedSidLength = PtrToUlong(<a class="code" href="../../d3/d8/fsrtlp_8h.html#a10">LongAlign</a>(NextSidLength));
01504 
01505         <span class="keywordflow">if</span> (NextSidLength &gt; RemainingLength) {
01506             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
01507         }
01508 
01509         RemainingLength -= AlignedSidLength;
01510 
01511         TargetArrayElement[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid = NextSid;
01512         TargetArrayElement[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes = Source[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes;
01513 
01514         <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( NextSidLength, NextSid, Source[Index].Sid );
01515 
01516         NextSid = (PSID)((PCHAR)NextSid + AlignedSidLength);
01517 
01518         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01519 
01520     } <span class="comment">//end_while</span>
01521 
01522     (*NextTargetSid) = NextSid;
01523     (*RemainingTargetSidBufferSize) = RemainingLength;
01524 
01525     <span class="keywordflow">return</span> STATUS_SUCCESS;
01526 
01527 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="sertl.c::RtlCreateSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Revision</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">1945</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00705">CreateBSMEventSD()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01865">InternalCreateCallbackThread()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05813">IoCreateUnprotectedSymbolicLink()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00168">IopApplySystemPartitionProt()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12098">IopCreateDefaultDeviceSecurityDescriptor()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">ObpGetDosDevicesProtection()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00418">RtlQuerySecurityObject()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>, <a class="el" href="../../d0/d5/seinit_8c-source.html#l00184">SepInitializationPhase1()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00651">SepInitSystemDacls()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00060">SeRmInitPhase1()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00636">TestSeAccess()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00213">TestSeNamedCreate()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00167">TestTokenInitialize()</a>.
<p>
<pre class="fragment"><div>01952                    :
01953 
01954     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> initializes a <span class="keyword">new</span> <span class="stringliteral">"absolute format"</span> security descriptor.
01955     After <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized with no
01956     system ACL, no discretionary ACL, no owner, no primary group and
01957     all <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags set to <span class="keyword">false</span> (null).
01958 
01959 Arguments:
01960 
01961 
01962     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor to
01963         initialize.
01964 
01965     Revision - Provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision level to assign to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
01966         descriptor.  This should be one (1) for this release.
01967 
01968 Return Value:
01969 
01970     STATUS_SUCCESS - Indicates the call completed successfully.
01971 
01972     STATUS_UNKNOWN_REVISION - Indicates the revision level provided
01973         is not supported by this routine.
01974 
01975 --*/
01976 
01977 {
01978     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01979 
01980     <span class="comment">//</span>
01981     <span class="comment">// Check the requested revision</span>
01982     <span class="comment">//</span>
01983 
01984     <span class="keywordflow">if</span> (Revision == SECURITY_DESCRIPTOR_REVISION) {
01985 
01986         <span class="comment">//</span>
01987         <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
01988         <span class="comment">//</span>
01989 
01990         SECURITY_DESCRIPTOR *ISecurityDescriptor = SecurityDescriptor;
01991 
01992         RtlZeroMemory( ISecurityDescriptor, <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR));
01993 
01994         ISecurityDescriptor-&gt;Revision = SECURITY_DESCRIPTOR_REVISION;
01995 
01996         <span class="keywordflow">return</span> STATUS_SUCCESS;
01997     }
01998 
01999     <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
02000 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="sertl.c::RtlCreateSecurityDescriptorRelative" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateSecurityDescriptorRelative           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PISECURITY_DESCRIPTOR_RELATIVE&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Revision</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02004">2004</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l06520">RtlpConvertToAutoInheritSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00529">SeAssignWorldSecurityDescriptor()</a>, and <a class="el" href="../../d1/d5/semethod_8c-source.html#l00559">SeQuerySecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>02011                    :
02012 
02013     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> initializes a <span class="keyword">new</span> <span class="stringliteral">"relative format"</span> security descriptor.
02014     After <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized with no
02015     system ACL, no discretionary ACL, no owner, no primary group and
02016     all <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags set to <span class="keyword">false</span> (null).
02017 
02018 Arguments:
02019 
02020 
02021     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor to
02022         initialize.
02023 
02024     Revision - Provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision level to assign to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02025         descriptor.  This should be one (1) for this release.
02026 
02027 Return Value:
02028 
02029     STATUS_SUCCESS - Indicates the call completed successfully.
02030 
02031     STATUS_UNKNOWN_REVISION - Indicates the revision level provided
02032         is not supported by this routine.
02033 
02034 Note:
02035     Warning, this code assume the caller allocated a relative security
02036     descriptor rather than a relative one.  Absolute is larger on systems
02037     with 64-bit pointers.
02038 
02039 --*/
02040 
02041 {
02042     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02043 
02044     <span class="comment">//</span>
02045     <span class="comment">// Check the requested revision</span>
02046     <span class="comment">//</span>
02047 
02048     <span class="keywordflow">if</span> (Revision == SECURITY_DESCRIPTOR_REVISION) {
02049 
02050         <span class="comment">//</span>
02051         <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
02052         <span class="comment">//</span>
02053 
02054         RtlZeroMemory( SecurityDescriptor, <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE));
02055 
02056         SecurityDescriptor-&gt;Revision = SECURITY_DESCRIPTOR_REVISION;
02057 
02058         <span class="keywordflow">return</span> STATUS_SUCCESS;
02059     }
02060 
02061     <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
02062 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="sertl.c::RtlEqualLuid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlEqualLuid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>Luid1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>Luid2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">1824</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00295">_UserTestForWinStaAccess()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l00222">CheckAllowForeground()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00324">EndShutdown()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00119">InitiateShutdown()</a>, <a class="el" href="../../d2/d6/w32_2ntuser_2kernel_2profile_8c-source.html#l00103">InitPreviousUserString()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00077">NotifyLogon()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03161">NtUserPostThreadMessage()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03192">OpenDesktopCompletion()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00680">RtlNewInstanceSecurityObject()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02867">SeIsChildToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02960">SeIsChildTokenByPointer()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00979">SeMarkLogonSessionForTerminationNotification()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00819">SepAdjustPrivileges()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00541">SepCreateLogonSessionTrack()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00655">SepDeleteLogonSessionTrack()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04587">SepFilterPrivilegeAudits()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00038">SepPrivilegeCheck()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00278">SepReferenceLogonSession()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01041">SepRemoveDisabledGroupsAndPrivileges()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01039">SetWindowStationUser()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00255">TestForInteractiveUser()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07016">TestpCompareDuplicateToken()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01276">TestTokenOpenPrimary()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01434">TestTokenQuery()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01343">xxxCreateDesktop2()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00068">xxxProcessNotifyWinEvent()</a>, <a class="el" href="../../d9/d2/ntuser_2kernel_2access_8c-source.html#l02314">xxxUpdatePerUserAccessPackSettings()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>01831                    :
01832 
01833     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> test two LUID values <span class="keywordflow">for</span> equality.
01834 
01835     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> here <span class="keywordflow">for</span> backwards compatibility <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>. New code
01836     should use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> macro.
01837 
01838 Arguments:
01839 
01840     Luid1, Luid2 - Supply pointers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two LUID values to compare.
01841 
01842 Return Value:
01843 
01844     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of Luid1 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> equal to Luid2, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01845         otherwise.
01846 
01847 
01848 --*/
01849 
01850 {
01851     LUID UNALIGNED * TempLuid1;
01852     LUID UNALIGNED * TempLuid2;
01853 
01854     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01855 
01856     <span class="keywordflow">return</span>((Luid1-&gt;HighPart == Luid2-&gt;HighPart) &amp;&amp;
01857            (Luid1-&gt;LowPart  == Luid2-&gt;LowPart));
01858 
01859 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="sertl.c::RtlEqualLuid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSYSAPI BOOLEAN NTAPI RtlEqualLuid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>Luid1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>Luid2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="sertl.c::RtlEqualPrefixSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlEqualPrefixSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00924">924</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l03880">RtlpCopyEffectiveAce()</a>.
<p>
<pre class="fragment"><div>00931                    :
00932 
00933     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> tests two SID prefix values <span class="keywordflow">for</span> equality.
00934 
00935     An SID prefix <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire SID except <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last sub-authority
00936     value.
00937 
00938 Arguments:
00939 
00940     Sid1, Sid2 - Supply pointers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two SID values to compare.
00941         The SID structures are assumed to be valid.
00942 
00943 Return Value:
00944 
00945     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix value of Sid1 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> equal to Sid2, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00946         otherwise.
00947 
00948 --*/
00949 
00950 
00951 {
00952     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00953 
00954     <span class="comment">//</span>
00955     <span class="comment">// Typecast to the opaque SID structures.</span>
00956     <span class="comment">//</span>
00957 
00958     SID *ISid1 = Sid1;
00959     SID *ISid2 = Sid2;
00960 
00961     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00962 
00963     <span class="comment">//</span>
00964     <span class="comment">// Make sure they are the same revision</span>
00965     <span class="comment">//</span>
00966 
00967     <span class="keywordflow">if</span> (ISid1-&gt;Revision == ISid2-&gt;Revision ) {
00968 
00969         <span class="comment">//</span>
00970         <span class="comment">// Compare IdentifierAuthority values</span>
00971         <span class="comment">//</span>
00972 
00973         <span class="keywordflow">if</span> ( (ISid1-&gt;IdentifierAuthority.Value[0] ==
00974               ISid2-&gt;IdentifierAuthority.Value[0])  &amp;&amp;
00975              (ISid1-&gt;IdentifierAuthority.Value[1]==
00976               ISid2-&gt;IdentifierAuthority.Value[1])  &amp;&amp;
00977              (ISid1-&gt;IdentifierAuthority.Value[2] ==
00978               ISid2-&gt;IdentifierAuthority.Value[2])  &amp;&amp;
00979              (ISid1-&gt;IdentifierAuthority.Value[3] ==
00980               ISid2-&gt;IdentifierAuthority.Value[3])  &amp;&amp;
00981              (ISid1-&gt;IdentifierAuthority.Value[4] ==
00982               ISid2-&gt;IdentifierAuthority.Value[4])  &amp;&amp;
00983              (ISid1-&gt;IdentifierAuthority.Value[5] ==
00984               ISid2-&gt;IdentifierAuthority.Value[5])
00985             ) {
00986 
00987             <span class="comment">//</span>
00988             <span class="comment">// Compare SubAuthorityCount values</span>
00989             <span class="comment">//</span>
00990 
00991             <span class="keywordflow">if</span> (ISid1-&gt;SubAuthorityCount == ISid2-&gt;SubAuthorityCount) {
00992 
00993                 <span class="keywordflow">if</span> (ISid1-&gt;SubAuthorityCount == 0) {
00994                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00995                 }
00996 
00997                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00998                 <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (ISid1-&gt;SubAuthorityCount - 1)) {
00999                     <span class="keywordflow">if</span> ((ISid1-&gt;SubAuthority[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) != (ISid2-&gt;SubAuthority[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>])) {
01000 
01001                         <span class="comment">//</span>
01002                         <span class="comment">// Found some SubAuthority values that weren't equal.</span>
01003                         <span class="comment">//</span>
01004 
01005                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01006                     }
01007                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01008                 }
01009 
01010                 <span class="comment">//</span>
01011                 <span class="comment">// All SubAuthority values are equal.</span>
01012                 <span class="comment">//</span>
01013 
01014                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01015             }
01016         }
01017     }
01018 
01019     <span class="comment">//</span>
01020     <span class="comment">// Either the Revision, SubAuthorityCount, or IdentifierAuthority values</span>
01021     <span class="comment">// weren't equal.</span>
01022     <span class="comment">//</span>
01023 
01024     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01025 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="sertl.c::RtlEqualSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlEqualSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">871</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01316">RtlSubAuthorityCountSid()</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12098">IopCreateDefaultDeviceSecurityDescriptor()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03544">RtlpValidOwnerSubjectContext()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03871">SeFastTraverseCheck()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l01099">SepAdjustGroups()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00306">SepIdAssignableAsGroup()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00806">SepMakeTokenEffectiveOnly()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01041">SepRemoveDisabledGroupsAndPrivileges()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00989">SePrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00933">SepSidInSidAndAttributes()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00733">SepSidInToken()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00856">SepSidInTokenEx()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l01065">SepSidTranslation()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00381">SepValidOwnerSubjectContext()</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00390">SidTranslation()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07016">TestpCompareDuplicateToken()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00042">TestSeSid()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01434">TestTokenQuery()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l03311">TestTokenSet()</a>.
<p>
<pre class="fragment"><div>00878                    :
00879 
00880     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> tests two SID values <span class="keywordflow">for</span> equality.
00881 
00882 Arguments:
00883 
00884     Sid1, Sid2 - Supply pointers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two SID values to compare.
00885         The SID structures are assumed to be valid.
00886 
00887 Return Value:
00888 
00889     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of Sid1 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> equal to Sid2, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00890         otherwise.
00891 
00892 --*/
00893 
00894 {
00895    ULONG SidLength;
00896 
00897    <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00898 
00899    <span class="comment">//</span>
00900    <span class="comment">// Make sure they are the same revision</span>
00901    <span class="comment">//</span>
00902 
00903    <span class="keywordflow">if</span> ( ((SID *)Sid1)-&gt;Revision == ((SID *)Sid2)-&gt;Revision ) {
00904 
00905        <span class="comment">//</span>
00906        <span class="comment">// Check the SubAuthorityCount first, because it's fast and</span>
00907        <span class="comment">// can help us exit faster.</span>
00908        <span class="comment">//</span>
00909 
00910        <span class="keywordflow">if</span> ( *<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>( Sid1 ) == *<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>( Sid2 )) {
00911 
00912            SidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid1 );
00913            <span class="keywordflow">return</span>( (BOOLEAN)RtlEqualMemory( Sid1, Sid2, SidLength) );
00914        }
00915    }
00916 
00917    <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00918 
00919 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="sertl.c::RtlEraseUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlEraseUnicodeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>String</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00596">596</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>.
<p>
<pre class="fragment"><div>00601                    :
00602 
00603     This function scrubs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed string by over-writing all
00604     characters in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string.  The entire string (i.e., MaximumLength)
00605     is erased, not just the current length.
00606 
00607 
00608 Argumen ts:
00609 
00610     String - The string to be erased.
00611 
00612 
00613 Return Value:
00614 
00615     None - Nothing can really go wrong unless the caller passes bogus
00616         parameters.  In this case, the caller can catch the access
00617         violation.
00618 
00619 
00620 --*/
00621 
00622 {
00623     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00624 
00625     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;MaximumLength == 0)) {
00626         <span class="keywordflow">return</span>;
00627     }
00628 
00629     RtlZeroMemory( (PVOID)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer, (ULONG)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;MaximumLength );
00630 
00631     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length = 0;
00632 
00633     <span class="keywordflow">return</span>;
00634 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="sertl.c::RtlFreeSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID RtlFreeSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Sid</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01218">1218</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00705">CreateBSMEventSD()</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">CsrpConnectToServer()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>.
<p>
<pre class="fragment"><div>01224                    :
01225 
01226     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to free a SID previously allocated <span class="keyword">using</span>
01227     <a class="code" href="../../d8/d6/sertl_8c.html#a39">RtlAllocateAndInitializeSid</a>().
01228 
01229     THIS ROUTINE IS CURRENTLY NOT CALLABLE FROM <a class="code" href="../../d0/d2/genxx_8h.html#a22">KERNEL</a> <a class="code" href="../../d3/d6/nec98_8h.html#a17">MODE</a>.
01230 
01231 Arguments:
01232 
01233     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID to free.
01234 
01235 Return Value:
01236 
01237     None.
01238 
01239 
01240 --*/
01241 {
01242     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01243 
01244     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, Sid ))
01245         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01246     <span class="keywordflow">else</span>
01247         <span class="keywordflow">return</span> Sid;
01248 }
<span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="sertl.c::RtlGetControlSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlGetControlSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR_CONTROL&nbsp;</td>
          <td class="mdname" nowrap> <em>Control</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Revision</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02415">2415</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>02423                    :
02424 
02425     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> information from a security descriptor.
02426 
02427 Arguments:
02428 
02429     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
02430 
02431     Control - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> information.
02432 
02433     Revision - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
02434                This value will always be returned, even <span class="keywordflow">if</span> an error
02435                <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned by <span class="keyword">this</span> routine.
02436 
02437 Return Value:
02438 
02439     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
02440 
02441     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02442         descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.  It may be a newer
02443         revision than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine knows about.
02444 
02445 
02446 --*/
02447 
02448 {
02449     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02450 
02451     <span class="comment">//</span>
02452     <span class="comment">// Always return the revision value - even if this isn't a valid</span>
02453     <span class="comment">// security descriptor</span>
02454     <span class="comment">//</span>
02455 
02456     *Revision = ((SECURITY_DESCRIPTOR *)SecurityDescriptor)-&gt;Revision;
02457 
02458 
02459     <span class="keywordflow">if</span> ( ((SECURITY_DESCRIPTOR *)SecurityDescriptor)-&gt;Revision
02460          != SECURITY_DESCRIPTOR_REVISION ) {
02461         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
02462     }
02463 
02464 
02465     *Control = ((SECURITY_DESCRIPTOR *)SecurityDescriptor)-&gt;Control;
02466 
02467     <span class="keywordflow">return</span> STATUS_SUCCESS;
02468 
02469 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="sertl.c::RtlGetDaclSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlGetDaclSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DaclPresent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>Dacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DaclDefaulted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02665">2665</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00283">DumpSecurity()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08959">IopSetSecurityObjectFromRegistry()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01805">ObpFreeDosDevicesProtection()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00182">ObpHashSecurityDescriptor()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>02674                    :
02675 
02676     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> discretionary ACL information of a
02677     security descriptor.
02678 
02679 Arguments:
02680 
02681     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
02682 
02683     DaclPresent - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
02684         does contain a discretionary ACL.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02685         remaining OUT parameters will receive valid values.
02686         Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor does not contain a
02687         discretionary ACL and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining OUT parameters will not
02688         receive valid values.
02689 
02690     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value returned <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02691         DaclPresent flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> parameter
02692         receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor's
02693         discretionary ACL.  If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as null, then
02694         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor has a null discretionary ACL.
02695 
02696     DaclDefaulted - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value returned
02697         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DaclPresent flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02698         DaclDefaulted parameter receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02699         descriptor's DaclDefaulted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flag.
02700 
02701 Return Value:
02702 
02703     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
02704 
02705     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02706         descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.  It may be a newer
02707         revision than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine knows about.
02708 
02709 
02710 --*/
02711 
02712 {
02713     <span class="comment">//</span>
02714     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
02715     <span class="comment">//</span>
02716 
02717     SECURITY_DESCRIPTOR *ISecurityDescriptor = SecurityDescriptor;
02718 
02719     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02720 
02721     <span class="comment">//</span>
02722     <span class="comment">// Check the revision</span>
02723     <span class="comment">//</span>
02724 
02725     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Revision != SECURITY_DESCRIPTOR_REVISION) {
02726         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
02727     }
02728 
02729     <span class="comment">//</span>
02730     <span class="comment">// Assign the DaclPresent flag value</span>
02731     <span class="comment">//</span>
02732 
02733     *DaclPresent = RtlpAreControlBitsSet( ISecurityDescriptor, SE_DACL_PRESENT );
02734 
02735     <span class="keywordflow">if</span> (*DaclPresent) {
02736 
02737         <span class="comment">//</span>
02738         <span class="comment">// Assign the ACL address.</span>
02739         <span class="comment">//</span>
02740 
02741         *<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor(ISecurityDescriptor);
02742 
02743         <span class="comment">//</span>
02744         <span class="comment">// Assign DaclDefaulted flag.</span>
02745         <span class="comment">//</span>
02746 
02747         *DaclDefaulted = RtlpAreControlBitsSet( ISecurityDescriptor, SE_DACL_DEFAULTED );
02748     }
02749 
02750     <span class="keywordflow">return</span> STATUS_SUCCESS;
02751 
02752 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="sertl.c::RtlGetGroupSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlGetGroupSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Group</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupDefaulted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03232">3232</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00160">Group</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08959">IopSetSecurityObjectFromRegistry()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00182">ObpHashSecurityDescriptor()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>03240                    :
03241 
03242     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary group information of a
03243     security descriptor.
03244 
03245 Arguments:
03246 
03247     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
03248 
03249     <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary group SID.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03250         security descriptor does not currently contain a primary
03251         group, then <span class="keyword">this</span> value will be returned as null.  In <span class="keyword">this</span>
03252         <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining OUT parameters are not given valid <span class="keywordflow">return</span>
03253         values.  Otherwise, <span class="keyword">this</span> parameter points to an SID and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03254         remaining OUT parameters are provided valid <span class="keywordflow">return</span> values.
03255 
03256     GroupDefaulted - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
03257         returned <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null.  In <span class="keyword">this</span> <span class="keywordflow">case</span>,
03258         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GroupDefaulted parameter receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03259         security descriptor's GroupDefaulted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flag.
03260 
03261 Return Value:
03262 
03263     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
03264 
03265     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
03266         descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.  It may be a newer
03267         revision than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine knows about.
03268 
03269 
03270 --*/
03271 
03272 {
03273 
03274     <span class="comment">//</span>
03275     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
03276     <span class="comment">//</span>
03277 
03278     SECURITY_DESCRIPTOR *ISecurityDescriptor =
03279         (SECURITY_DESCRIPTOR *)SecurityDescriptor;
03280 
03281     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03282 
03283     <span class="comment">//</span>
03284     <span class="comment">// Check the revision</span>
03285     <span class="comment">//</span>
03286 
03287     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Revision != SECURITY_DESCRIPTOR_REVISION) {
03288         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
03289     }
03290 
03291     <span class="comment">//</span>
03292     <span class="comment">// Return the Group field value.</span>
03293     <span class="comment">//</span>
03294 
03295     *<a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> = RtlpGroupAddrSecurityDescriptor(ISecurityDescriptor);
03296 
03297     <span class="comment">//</span>
03298     <span class="comment">// Return the GroupDefaulted flag value.</span>
03299     <span class="comment">//</span>
03300 
03301     *GroupDefaulted = RtlpAreControlBitsSet( ISecurityDescriptor, SE_GROUP_DEFAULTED );
03302 
03303     <span class="keywordflow">return</span> STATUS_SUCCESS;
03304 
03305 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="sertl.c::RtlGetOwnerSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlGetOwnerSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Owner</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerDefaulted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03059">3059</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08959">IopSetSecurityObjectFromRegistry()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00182">ObpHashSecurityDescriptor()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>03067                    :
03068 
03069     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner information of a security
03070     descriptor.
03071 
03072 Arguments:
03073 
03074     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
03075 
03076     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner SID.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
03077         descriptor does not currently contain an owner, then <span class="keyword">this</span>
03078         value will be returned as null.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining
03079         OUT parameters are not given valid <span class="keywordflow">return</span> values.  Otherwise,
03080         <span class="keyword">this</span> parameter points to an SID and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining OUT
03081         parameters are provided valid <span class="keywordflow">return</span> values.
03082 
03083     OwnerDefaulted - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
03084         returned <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null.  In <span class="keyword">this</span> <span class="keywordflow">case</span>,
03085         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OwnerDefaulted parameter receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03086         security descriptor's OwnerDefaulted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flag.
03087 
03088 Return Value:
03089 
03090     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
03091 
03092     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
03093         descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.  It may be a newer
03094         revision than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine knows about.
03095 
03096 
03097 --*/
03098 
03099 {
03100 
03101     <span class="comment">//</span>
03102     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
03103     <span class="comment">//</span>
03104 
03105     SECURITY_DESCRIPTOR *ISecurityDescriptor = SecurityDescriptor;
03106 
03107     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03108 
03109     <span class="comment">//</span>
03110     <span class="comment">// Check the revision</span>
03111     <span class="comment">//</span>
03112 
03113     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Revision != SECURITY_DESCRIPTOR_REVISION) {
03114         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
03115     }
03116 
03117     <span class="comment">//</span>
03118     <span class="comment">// Return the Owner field value.</span>
03119     <span class="comment">//</span>
03120 
03121     *<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = RtlpOwnerAddrSecurityDescriptor(ISecurityDescriptor);
03122 
03123     <span class="comment">//</span>
03124     <span class="comment">// Return the OwnerDefaulted flag value.</span>
03125     <span class="comment">//</span>
03126 
03127     *OwnerDefaulted = RtlpAreControlBitsSet( ISecurityDescriptor, SE_OWNER_DEFAULTED );
03128 
03129     <span class="keywordflow">return</span> STATUS_SUCCESS;
03130 
03131 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="sertl.c::RtlGetSaclSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlGetSaclSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SaclPresent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>Sacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SaclDefaulted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02871">2871</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08959">IopSetSecurityObjectFromRegistry()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00182">ObpHashSecurityDescriptor()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>02880                    :
02881 
02882     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system ACL information of a security
02883     descriptor.
02884 
02885 Arguments:
02886 
02887     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
02888 
02889     SaclPresent - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
02890         does contain a system ACL.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining OUT
02891         parameters will receive valid values.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02892         security descriptor does not contain a system ACL and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02893         remaining OUT parameters will not receive valid values.
02894 
02895     Sacl - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value returned <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02896         SaclPresent flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Sacl parameter
02897         receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor's system ACL.
02898         If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02899         descriptor has a null system ACL.
02900 
02901     SaclDefaulted - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value returned
02902         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SaclPresent flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02903         SaclDefaulted parameter receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02904         descriptor's SaclDefaulted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flag.
02905 
02906 Return Value:
02907 
02908     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
02909 
02910     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02911         descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.  It may be a newer
02912         revision than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine knows about.
02913 
02914 
02915 --*/
02916 
02917 {
02918 
02919     <span class="comment">//</span>
02920     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
02921     <span class="comment">//</span>
02922 
02923     SECURITY_DESCRIPTOR *ISecurityDescriptor = SecurityDescriptor;
02924 
02925     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02926 
02927     <span class="comment">//</span>
02928     <span class="comment">// Check the revision</span>
02929     <span class="comment">//</span>
02930 
02931     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Revision != SECURITY_DESCRIPTOR_REVISION) {
02932         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
02933     }
02934 
02935     <span class="comment">//</span>
02936     <span class="comment">// Assign the SaclPresent flag value</span>
02937     <span class="comment">//</span>
02938 
02939     *SaclPresent = RtlpAreControlBitsSet( ISecurityDescriptor, SE_SACL_PRESENT );
02940 
02941     <span class="keywordflow">if</span> (*SaclPresent) {
02942 
02943         <span class="comment">//</span>
02944         <span class="comment">// Assign the ACL address.</span>
02945         <span class="comment">//</span>
02946 
02947         *Sacl = RtlpSaclAddrSecurityDescriptor(ISecurityDescriptor);
02948 
02949         <span class="comment">//</span>
02950         <span class="comment">// Assign SaclDefaulted flag.</span>
02951         <span class="comment">//</span>
02952 
02953         *SaclDefaulted = RtlpAreControlBitsSet( ISecurityDescriptor, SE_SACL_DEFAULTED );
02954 
02955     }
02956 
02957     <span class="keywordflow">return</span> STATUS_SUCCESS;
02958 
02959 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="sertl.c::RtlGetSecurityDescriptorRMControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlGetSecurityDescriptorRMControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>RMControl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l11323">11323</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>11330                    :
11331 
11332     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RM Control flags from a SecurityDescriptor <span class="keywordflow">if</span>
11333     SE_RM_CONTROL_VALID flags <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> field.
11334 
11335 Arguments:
11336 
11337     SecurityDescriptor - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SECURITY_DESCRIPTOR structure
11338     RMControl          - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flags in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor <span class="keywordflow">if</span>
11339                          SE_RM_CONTROL_VALID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> bits of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
11340                          SecurityDescriptor.
11341 
11342 
11343 Return Value:
11344 
11345     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> SE_RM_CONTROL_VALID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Control bits of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
11346               SecurityDescriptor.
11347 
11348 Note:
11349     Parameter validation has already been done in Advapi.
11350 
11351 
11352 --*/
11353 
11354 {
11355     PISECURITY_DESCRIPTOR ISecurityDescriptor = (PISECURITY_DESCRIPTOR) SecurityDescriptor;
11356 
11357     <span class="keywordflow">if</span> (!(ISecurityDescriptor-&gt;Control &amp; SE_RM_CONTROL_VALID))
11358     {
11359         *RMControl = 0;
11360         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11361     }
11362 
11363     *RMControl = ISecurityDescriptor-&gt;Sbz1;
11364 
11365     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
11366 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="sertl.c::RtlIdentifierAuthoritySid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSID_IDENTIFIER_AUTHORITY RtlIdentifierAuthoritySid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Sid</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01253">1253</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00447">DisplayAccountSid()</a>.
<p>
<pre class="fragment"><div>01258                    :
01259 
01260     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of an SID's IdentifierAuthority field.
01261 
01262 Arguments:
01263 
01264     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID data structure.
01265 
01266 Return Value:
01267 
01268 
01269 --*/
01270 {
01271     PISID ISid;
01272 
01273     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01274 
01275     <span class="comment">//</span>
01276     <span class="comment">//  Typecast to the opaque SID</span>
01277     <span class="comment">//</span>
01278 
01279     ISid = (PISID)Sid;
01280 
01281     <span class="keywordflow">return</span> &amp;(ISid-&gt;IdentifierAuthority);
01282 
01283 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="sertl.c::RtlImpersonateSelf" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlImpersonateSelf           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SECURITY_IMPERSONATION_LEVEL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImpersonationLevel</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03446">3446</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00046">NtDuplicateToken()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03103">NtSetInformationThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>03452                    :
03453 
03454     This routine may be used to obtain an Impersonation token representing
03455     your own process's context.  This may be useful <span class="keywordflow">for</span> enabling a privilege
03456     <span class="keywordflow">for</span> a single thread rather than <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire process; or changing
03457     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> DACL <span class="keywordflow">for</span> a single thread.
03458 
03459     The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callers thread.
03460 
03461 
03462 
03463 Arguments:
03464 
03465     ImpersonationLevel - The level to make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation token.
03466 
03467 
03468 
03469 Return Value:
03470 
03471     STATUS_SUCCESS -  The thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> now impersonating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process.
03472 
03473     Other - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> values returned by:
03474 
03475             <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>()
03476             NtDuplicateToken()
03477             NtSetInformationThread()
03478 
03479 --*/
03480 
03481 {
03482     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03483         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,
03484         IgnoreStatus;
03485 
03486     HANDLE
03487         Token1,
03488         Token2;
03489 
03490     OBJECT_ATTRIBUTES
03491         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
03492 
03493     SECURITY_QUALITY_OF_SERVICE
03494         Qos;
03495 
03496 
03497     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03498 
03499     InitializeObjectAttributes(&amp;ObjectAttributes, NULL, 0, 0, NULL);
03500 
03501     Qos.Length = <span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
03502     Qos.ImpersonationLevel = ImpersonationLevel;
03503     Qos.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
03504     Qos.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03505     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.SecurityQualityOfService = &amp;Qos;
03506 
03507     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>( NtCurrentProcess(), TOKEN_DUPLICATE, &amp;Token1 );
03508 
03509     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03510         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>(
03511                      Token1,
03512                      TOKEN_IMPERSONATE,
03513                      &amp;ObjectAttributes,
03514                      FALSE,                 <span class="comment">//EffectiveOnly</span>
03515                      TokenImpersonation,
03516                      &amp;Token2
03517                      );
03518         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03519             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
03520                          NtCurrentThread(),
03521                          ThreadImpersonationToken,
03522                          &amp;Token2,
03523                          <span class="keyword">sizeof</span>(HANDLE)
03524                          );
03525 
03526             IgnoreStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Token2 );
03527         }
03528 
03529 
03530         IgnoreStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Token1 );
03531     }
03532 
03533 
03534     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03535 
03536 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="sertl.c::RtlInitializeSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlInitializeSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_IDENTIFIER_AUTHORITY&nbsp;</td>
          <td class="mdname" nowrap> <em>IdentifierAuthority</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthorityCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01166">1166</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00511">InitVars()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03880">RtlpCopyEffectiveAce()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00307">SepVariableInitialization()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l03311">TestTokenSet()</a>, and <a class="el" href="../../d5/d5/tsevars_8c-source.html#l00167">TSeVariableInitialization()</a>.
<p>
<pre class="fragment"><div>01173                    :
01174 
01175     This function initializes an SID data structure.  It does not, however,
01176     set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sub-authority values.  This must be done separately.
01177 
01178 Arguments:
01179 
01180     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID data structure to initialize.
01181 
01182     IdentifierAuthority - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Identifier Authority value to
01183         set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID.
01184 
01185     SubAuthorityCount - The number of sub-authorities that will be placed in
01186         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID (a separate action).
01187 
01188 Return Value:
01189 
01190 
01191 --*/
01192 {
01193     PISID ISid;
01194 
01195     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">//  Typecast to the opaque SID</span>
01199     <span class="comment">//</span>
01200 
01201     ISid = (PISID)Sid;
01202 
01203     <span class="keywordflow">if</span> ( SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES ) {
01204         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
01205     }
01206 
01207     ISid-&gt;SubAuthorityCount = (UCHAR)SubAuthorityCount;
01208     ISid-&gt;Revision = 1;
01209     ISid-&gt;IdentifierAuthority = *IdentifierAuthority;
01210 
01211     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01212 
01213 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="sertl.c::RtlLengthRequiredSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlLengthRequiredSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SubAuthorityCount</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">1030</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00511">InitVars()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01062">RtlAllocateAndInitializeSid()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03880">RtlpCopyEffectiveAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05381">RtlpGenerateInheritedAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00053">SeCaptureSecurityDescriptor()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01141">SeCaptureSid()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01850">SeCaptureSidAndAttributesArray()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00307">SepVariableInitialization()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00042">TestSeSid()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l03311">TestTokenSet()</a>, and <a class="el" href="../../d5/d5/tsevars_8c-source.html#l00167">TSeVariableInitialization()</a>.
<p>
<pre class="fragment"><div>01036                    :
01037 
01038     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, required to store an SID
01039     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified number of Sub-Authorities.
01040 
01041 Arguments:
01042 
01043     SubAuthorityCount - The number of sub-authorities to be stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID.
01044 
01045 Return Value:
01046 
01047     ULONG - The length, in bytes, required to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID.
01048 
01049 
01050 --*/
01051 
01052 {
01053     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01054 
01055     <span class="keywordflow">return</span> (8<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> + (4 * SubAuthorityCount));
01056 
01057 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="sertl.c::RtlLengthSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlLengthSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SecurityDescriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02165">2165</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00988">EhpAttachSecurity()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00839">ObpCompareSecurityDescriptors()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00491">ObpCreateCacheEntry()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>02171                    :
02172 
02173     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, necessary to capture a
02174     structurally valid SECURITY_DESCRIPTOR.  The length includes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length
02175     of all associated data structures (like SIDs and ACLs).  The length also
02176     takes into account <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> alignment requirements of each component.
02177 
02178     The <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> length of a security descriptor (one which has no associated
02179     SIDs or ACLs) <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> SECURITY_DESCRIPTOR_MIN_LENGTH.
02180 
02181 
02182 Arguments:
02183 
02184     SecurityDescriptor - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SECURITY_DESCRIPTOR whose
02185         length <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be returned.  The SECURITY_DESCRIPTOR's
02186         structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be valid.
02187 
02188 Return Value:
02189 
02190     ULONG - The length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SECURITY_DESCRIPTOR.
02191 
02192 
02193 --*/
02194 
02195 {
02196     ULONG sum;
02197     PVOID Temp;
02198 
02199 
02200     <span class="comment">//</span>
02201     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
02202     <span class="comment">//</span>
02203 
02204     SECURITY_DESCRIPTOR *ISecurityDescriptor = (SECURITY_DESCRIPTOR *)SecurityDescriptor;
02205 
02206     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02207 
02208     <span class="comment">//</span>
02209     <span class="comment">// The length is the sum of the following:</span>
02210     <span class="comment">//</span>
02211     <span class="comment">//       SECURITY_DESCRIPTOR_MIN_LENGTH (or sizeof(SECURITY_DESCRIPTOR))</span>
02212     <span class="comment">//       length of Owner SID (if present)</span>
02213     <span class="comment">//       length of Group SID (if present)</span>
02214     <span class="comment">//       length of Discretionary ACL (if present and non-null)</span>
02215     <span class="comment">//       length of System ACL (if present and non-null)</span>
02216     <span class="comment">//</span>
02217 
02218     sum = ISecurityDescriptor-&gt;Control &amp; SE_SELF_RELATIVE ?
02219                             <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) :
02220                             <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR);
02221 
02222     <span class="comment">//</span>
02223     <span class="comment">// Add in length of Owner SID</span>
02224     <span class="comment">//</span>
02225 
02226     Temp = RtlpOwnerAddrSecurityDescriptor(ISecurityDescriptor);
02227     <span class="keywordflow">if</span> (Temp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02228         sum += LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Temp));
02229     }
02230 
02231     <span class="comment">//</span>
02232     <span class="comment">// Add in length of Group SID</span>
02233     <span class="comment">//</span>
02234 
02235     Temp = RtlpGroupAddrSecurityDescriptor(ISecurityDescriptor);
02236     <span class="keywordflow">if</span> (Temp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02237         sum += LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Temp));
02238     }
02239 
02240     <span class="comment">//</span>
02241     <span class="comment">// Add in used length of Discretionary ACL</span>
02242     <span class="comment">//</span>
02243 
02244     Temp = RtlpDaclAddrSecurityDescriptor(ISecurityDescriptor);
02245     <span class="keywordflow">if</span> ( Temp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02246 
02247         sum += LongAlignSize(((PACL) Temp)-&gt;AclSize );
02248     }
02249 
02250     <span class="comment">//</span>
02251     <span class="comment">// Add in used length of System Acl</span>
02252     <span class="comment">//</span>
02253 
02254     Temp = RtlpSaclAddrSecurityDescriptor(ISecurityDescriptor);
02255     <span class="keywordflow">if</span> ( Temp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02256 
02257         sum += LongAlignSize(((PACL) Temp)-&gt;AclSize );
02258     }
02259 
02260     <span class="keywordflow">return</span> sum;
02261 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="sertl.c::RtlLengthSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlLengthSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Sid</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">1350</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00626">_GetUserObjectInformation()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00037">AllocAce()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00705">CreateBSMEventSD()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01844">GetSiteSidFromToken()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02874">IoCheckQuotaBufferValidity()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00524">IopCheckGetQuotaBufferValidity()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">ObpGetDosDevicesProtection()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00182">ObpHashSecurityDescriptor()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01111">RtlpInitializeAllowedAce()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01211">RtlpInitializeAuditAce()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01161">RtlpInitializeDeniedAce()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01850">SeCaptureSidAndAttributesArray()</a>, and <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>.
<p>
<pre class="fragment"><div>01356                    :
01357 
01358     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of a structurally valid SID.
01359 
01360 Arguments:
01361 
01362     Sid - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID whose length <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be returned.  The
01363         SID's structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be valid.
01364 
01365 Return Value:
01366 
01367     ULONG - The length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID.
01368 
01369 
01370 --*/
01371 
01372 {
01373     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01374 
01375     <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Sid);
01376 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="sertl.c::RtlLengthSidAsUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlLengthSidAsUnicodeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StringLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01532">1532</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00449">StringLength()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01453">RtlFormatCurrentUserKeyPath()</a>.
<p>
<pre class="fragment"><div>01539                    :
01540 
01541 
01542     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string needed
01543     to represent <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID supplied.  The actual string may be shorter,
01544     but <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> intended to be a quick calculation.
01545 
01546 Arguments:
01547 
01548 
01549     Sid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be converted to unicode.
01550 
01551     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> length required in bytes.
01552 
01553 Return Value:
01554 
01555     SUCCESS - The conversion was successful
01556 
01557     STATUS_INVALID_SID - The sid provided does not have a valid structure,
01558         or has too many sub-authorities (more than SID_MAX_SUB_AUTHORITIES).
01559 
01560 --*/
01561 
01562 {
01563     ULONG   i ;
01564 
01565     PISID   iSid = (PISID)Sid;  <span class="comment">// pointer to opaque structure</span>
01566 
01567 
01568     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01569 
01570     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( Sid ) != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
01571     {
01572         <span class="keywordflow">return</span>(STATUS_INVALID_SID);
01573     }
01574 
01575     <span class="comment">//</span>
01576     <span class="comment">// if the SID's IA value has 5 or 6 significant bytes, the</span>
01577     <span class="comment">// representation will be in hex, with a 0x preceding.  Otherwise</span>
01578     <span class="comment">// it will be in decimal, with at most 10 characters.</span>
01579     <span class="comment">//</span>
01580 
01581     <span class="keywordflow">if</span> (  (iSid-&gt;IdentifierAuthority.Value[0] != 0)  ||
01582           (iSid-&gt;IdentifierAuthority.Value[1] != 0)  )
01583     {
01584         i = 14 ;    <span class="comment">// 0x665544332211</span>
01585 
01586     }
01587     <span class="keywordflow">else</span>
01588     {
01589         i = 10 ;    <span class="comment">// 4294967295 is the max ulong, at 10 chars</span>
01590     }
01591 
01592     i += 4 ;        <span class="comment">// room for the S-1-</span>
01593 
01594     <span class="comment">//</span>
01595     <span class="comment">// for each sub authority, it is a max of 10 chars (for a ulong),</span>
01596     <span class="comment">// plus the - separator</span>
01597     <span class="comment">//</span>
01598 
01599     i += 11 * iSid-&gt;SubAuthorityCount ;
01600 
01601     *<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = i * <span class="keyword">sizeof</span>( WCHAR );
01602 
01603     <span class="keywordflow">return</span> STATUS_SUCCESS ;
01604 
01605 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="sertl.c::RtlLengthUsedSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlLengthUsedSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SecurityDescriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02265">2265</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00460">RtlQueryInformationAcl()</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>.
<p>
<pre class="fragment"><div>02271                    :
02272 
02273     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, in use in a structurally valid
02274     SECURITY_DESCRIPTOR.
02275 
02276     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes necessary to capture <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor,
02277     which may be less <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current actual length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
02278     (<a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>() is used to retrieve the actual length).
02279 
02280     Notice that the used length and actual length may differ if either the SACL
02281     or DACL include padding bytes.
02282 
02283     The length includes the length of all associated data structures (like SIDs
02284     and ACLs).  The length also takes into account the alignment requirements
02285     of each component.
02286 
02287     The minimum length of a security descriptor (one which has no associated
02288     SIDs or ACLs) is SECURITY_DESCRIPTOR_MIN_LENGTH.
02289 
02290 
02291 Arguments:
02292 
02293     SecurityDescriptor - Points to the SECURITY_DESCRIPTOR whose used
02294         length is to be returned.  The SECURITY_DESCRIPTOR's
02295         structure is assumed to be valid.
02296 
02297 Return Value:
02298 
02299     ULONG - Number of bytes of the SECURITY_DESCRIPTOR that are in use.
02300 
02301 
02302 --*/
02303 
02304 {
02305     ULONG sum;
02306 
02307     ACL_SIZE_INFORMATION AclSize;
02308     PVOID Temp;
02309 
02310     <span class="comment">//</span>
02311     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
02312     <span class="comment">//</span>
02313 
02314     SECURITY_DESCRIPTOR *ISecurityDescriptor = (SECURITY_DESCRIPTOR *)SecurityDescriptor;
02315 
02316     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02317 
02318     <span class="comment">//</span>
02319     <span class="comment">// The length is the sum of the following:</span>
02320     <span class="comment">//</span>
02321     <span class="comment">//       SECURITY_DESCRIPTOR_MIN_LENGTH (or sizeof(SECURITY_DESCRIPTOR))</span>
02322     <span class="comment">//       length of Owner SID (if present)</span>
02323     <span class="comment">//       length of Group SID (if present)</span>
02324     <span class="comment">//       length of Discretionary ACL (if present and non-null)</span>
02325     <span class="comment">//       length of System ACL (if present and non-null)</span>
02326     <span class="comment">//</span>
02327 
02328     sum = ISecurityDescriptor-&gt;Control &amp; SE_SELF_RELATIVE ?
02329                             <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) :
02330                             <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR);
02331 
02332     <span class="comment">//</span>
02333     <span class="comment">// Add in length of Owner SID</span>
02334     <span class="comment">//</span>
02335 
02336     Temp = RtlpOwnerAddrSecurityDescriptor(ISecurityDescriptor);
02337     <span class="keywordflow">if</span> (Temp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02338         sum += LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Temp));
02339     }
02340 
02341     <span class="comment">//</span>
02342     <span class="comment">// Add in length of Group SID</span>
02343     <span class="comment">//</span>
02344 
02345     Temp = RtlpGroupAddrSecurityDescriptor(ISecurityDescriptor);
02346     <span class="keywordflow">if</span> (Temp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02347         sum += LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Temp));
02348     }
02349 
02350     <span class="comment">//</span>
02351     <span class="comment">// Add in used length of Discretionary ACL</span>
02352     <span class="comment">//</span>
02353 
02354     Temp = RtlpDaclAddrSecurityDescriptor(ISecurityDescriptor);
02355     <span class="keywordflow">if</span> ( Temp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02356 
02357         <a class="code" href="../../d2/d4/acledit_8c.html#a8">RtlQueryInformationAcl</a>( Temp,
02358                                 (PVOID)&amp;AclSize,
02359                                 <span class="keyword">sizeof</span>(AclSize),
02360                                 AclSizeInformation );
02361 
02362         sum += LongAlignSize(AclSize.AclBytesInUse);
02363     }
02364 
02365     <span class="comment">//</span>
02366     <span class="comment">// Add in used length of System Acl</span>
02367     <span class="comment">//</span>
02368 
02369     Temp = RtlpSaclAddrSecurityDescriptor(ISecurityDescriptor);
02370     <span class="keywordflow">if</span> ( Temp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02371 
02372         <a class="code" href="../../d2/d4/acledit_8c.html#a8">RtlQueryInformationAcl</a>( Temp,
02373                                 (PVOID)&amp;AclSize,
02374                                 <span class="keyword">sizeof</span>(AclSize),
02375                                 AclSizeInformation );
02376 
02377         sum += LongAlignSize(AclSize.AclBytesInUse);
02378     }
02379 
02380     <span class="keywordflow">return</span> sum;
02381 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="sertl.c::RtlMapGenericMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlMapGenericMask           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">3381</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02340">IoCheckDesiredAccess()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00818">RtlNewSecurityGrantedAccess()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00180">SeCreateAccessState()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02765">SeOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03085">SeOpenObjectForDeleteAuditAlarm()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l01343">xxxCreateDesktop2()</a>.
<p>
<pre class="fragment"><div>03388                    :
03389 
03390     This routine maps all generic accesses in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> provided access mask
03391     to specific and standard accesses according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> provided
03392     GenericMapping.
03393 
03394 Arguments:
03395 
03396         AccessMask - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mask to be mapped.
03397 
03398         GenericMapping - The mapping of generic to specific and standard
03399                          access types.
03400 
03401 Return Value:
03402 
03403     None.
03404 
03405 --*/
03406 
03407 {
03408     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03409 
03410 <span class="comment">//    //</span>
03411 <span class="comment">//    // Make sure the pointer is properly aligned</span>
03412 <span class="comment">//    //</span>
03413 <span class="comment">//</span>
03414 <span class="comment">//    ASSERT( ((ULONG)AccessMask &gt;&gt; 2) &lt;&lt; 2 == (ULONG)AccessMask );</span>
03415 
03416     <span class="keywordflow">if</span> (*AccessMask &amp; GENERIC_READ) {
03417 
03418         *AccessMask |= GenericMapping-&gt;GenericRead;
03419     }
03420 
03421     <span class="keywordflow">if</span> (*AccessMask &amp; GENERIC_WRITE) {
03422 
03423         *AccessMask |= GenericMapping-&gt;GenericWrite;
03424     }
03425 
03426     <span class="keywordflow">if</span> (*AccessMask &amp; GENERIC_EXECUTE) {
03427 
03428         *AccessMask |= GenericMapping-&gt;GenericExecute;
03429     }
03430 
03431     <span class="keywordflow">if</span> (*AccessMask &amp; GENERIC_ALL) {
03432 
03433         *AccessMask |= GenericMapping-&gt;GenericAll;
03434     }
03435 
03436     <span class="comment">//</span>
03437     <span class="comment">// Now clear the generic flags</span>
03438     <span class="comment">//</span>
03439 
03440     *AccessMask &amp;= ~(GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | GENERIC_ALL);
03441 
03442     <span class="keywordflow">return</span>;
03443 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="sertl.c::RtlpApplyAclToObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpApplyAclToObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03812">3812</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>.
<p>
<pre class="fragment"><div>03819                    :
03820 
03821     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">private</span> routine that maps Access Masks of an ACL so that
03822     they are applicable to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being applied to.
03823 
03824     Only known DSA ACEs are mapped.  Unknown ACE types are ignored.
03825 
03826     Only access types in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GenericAll mapping <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target object
03827     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> will be non-zero upon <span class="keywordflow">return</span>.
03828 
03829 Arguments:
03830 
03831     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl being applied.
03832 
03833     GenericMapping - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping to use.
03834 
03835 
03836 Return Value:
03837 
03838     None.
03839 
03840 --*/
03841 
03842 {
03843     ULONG i;
03844 
03845     PACE_HEADER Ace;
03846 
03847     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03848 
03849     <span class="comment">//</span>
03850     <span class="comment">//  First check if the acl is null</span>
03851     <span class="comment">//</span>
03852 
03853     <span class="keywordflow">if</span> (Acl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03854 
03855         <span class="keywordflow">return</span>;
03856 
03857     }
03858 
03859 
03860     <span class="comment">//</span>
03861     <span class="comment">// Now walk the ACL, mapping each ACE as we go.</span>
03862     <span class="comment">//</span>
03863 
03864     <span class="keywordflow">for</span> (i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(Acl);
03865          i &lt; Acl-&gt;AceCount;
03866          i += 1, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(Ace)) {
03867 
03868         <span class="keywordflow">if</span> (IsMSAceType( Ace )) {
03869 
03870             RtlApplyAceToObject( Ace, GenericMapping );
03871         }
03872 
03873     }
03874 
03875     <span class="keywordflow">return</span>;
03876 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="sertl.c::RtlpCompareAces" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpCompareAces           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritedAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupSid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l06972">6972</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l08362">RtlpIsDuplicateAce()</a>.
<p>
<pre class="fragment"><div>06980                    :
06981 
06982     <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a> two aces to see <span class="keywordflow">if</span> they are <span class="stringliteral">"substantially"</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
06983 
06984 Arguments:
06985 
06986     InheritedAce - Computed ACE as inherited from DirectoryAcl.
06987 
06988     ChildAce - The current acl on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  This ACL must be a revision 2 ACL.
06989 
06990     ObjectType - GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being created.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being
06991         created has no GUID associated with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
06992         specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
06993 
06994     OwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use.
06995         If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner sid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not treated as special.
06996 
06997     GroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group SID to use.
06998         If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group sid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not treated as special.
06999 
07000 Return Value:
07001 
07002     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The ACEs are substantially <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
07003     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The ACEs are not substantially <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
07004 
07005 --*/
07006 {
07007     BOOLEAN AcesCompare = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07008 
07009     <span class="keywordflow">if</span> (IsObjectAceType(InheritedAce) &amp;&amp; IsObjectAceType(ChildAce)) {
07010 
07011         AcesCompare = <a class="code" href="../../d8/d6/sertl_8c.html#a24">RtlpCompareKnownObjectAces</a>( (PKNOWN_OBJECT_ACE)InheritedAce,
07012                                                   (PKNOWN_OBJECT_ACE)ChildAce,
07013                                                   OwnerSid,
07014                                                   GroupSid
07015                                                   );
07016     } <span class="keywordflow">else</span> {
07017 
07018         <span class="keywordflow">if</span> (!IsObjectAceType(InheritedAce) &amp;&amp; !IsObjectAceType(ChildAce)) {
07019 
07020             AcesCompare = <a class="code" href="../../d8/d6/sertl_8c.html#a25">RtlpCompareKnownAces</a>( InheritedAce,
07021                                                 ChildAce,
07022                                                 OwnerSid,
07023                                                 GroupSid
07024                                                 );
07025         }
07026     }
07027 
07028     <span class="keywordflow">return</span>( AcesCompare );
07029 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="sertl.c::RtlpCompareKnownAces" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpCompareKnownAces           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritedAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID OwnerSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID GroupSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">7033</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l06966">AceFlagsInAce</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00330">CREATOR_SID_SIZE</a>, <a class="el" href="../../d5/d5/tsevars_8c-source.html#l00116">CreatorSid</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06965">EFFECTIVE_ACE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00340">RtlBaseAceType</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00924">RtlEqualPrefixSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01166">RtlInitializeSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00356">RtlIsSystemAceType</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00368">RtlpVerboseConvert</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l06972">RtlpCompareAces()</a>.
<p>
<pre class="fragment"><div>07042                    :
07043 
07044     <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a> two aces to see <span class="keywordflow">if</span> they are <span class="stringliteral">"substantially"</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
07045 
07046 Arguments:
07047 
07048     InheritedAce - Computed ACE as inherited from DirectoryAcl.
07049 
07050     ChildAce - The current acl on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  This ACL must be a revision 2 ACL.
07051 
07052     OwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use.
07053         If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner sid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not treated as special.
07054 
07055     GroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group SID to use.
07056         If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group sid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not treated as special.
07057 
07058 Return Value:
07059 
07060     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The ACEs are substantially <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
07061     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The ACEs are not substantially <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
07062 
07063 --*/
07064 
07065 {
07066     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
07067     ACE_HEADER <span class="keyword">volatile</span> *InheritedAceHdr = &amp;InheritedAce-&gt;Header;
07068 
07069     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
07070 
07071     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsObjectAceType(InheritedAce));
07072     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsObjectAceType(ChildAce));
07073 
07074     <span class="comment">//</span>
07075     <span class="comment">// If the Ace types are different,</span>
07076     <span class="comment">//  we don't match.</span>
07077     <span class="comment">//</span>
07078     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[ChildAce-&gt;Header.AceType] != <a class="code" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[InheritedAceHdr-&gt;AceType] ) {
07079 <span class="preprocessor">#if DBG</span>
07080 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07081             KdPrint((<span class="stringliteral">"AceType mismatch"</span>));
07082         }
07083 <span class="preprocessor">#endif // DBG</span>
07084 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07085     }
07086 
07087     <span class="comment">//</span>
07088     <span class="comment">// If this is a system ACE,</span>
07089     <span class="comment">//  ensure the SUCCESS/FAILURE flags match.</span>
07090     <span class="comment">//</span>
07091 
07092     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a8">RtlIsSystemAceType</a>[ChildAce-&gt;Header.AceType] ) {
07093         <span class="keywordflow">if</span> ( (ChildAce-&gt;Header.AceFlags &amp; (SUCCESSFUL_ACCESS_ACE_FLAG|FAILED_ACCESS_ACE_FLAG)) !=
07094              (InheritedAceHdr-&gt;AceFlags &amp; (SUCCESSFUL_ACCESS_ACE_FLAG|FAILED_ACCESS_ACE_FLAG)) ) {
07095 <span class="preprocessor">#if DBG</span>
07096 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07097                 KdPrint((<span class="stringliteral">"System ace success/fail mismatch"</span>));
07098             }
07099 <span class="preprocessor">#endif // DBG</span>
07100 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07101         }
07102     }
07103 
07104     <span class="comment">//</span>
07105     <span class="comment">// If the SID of the inherited ACE doesn't match,</span>
07106     <span class="comment">//  we don't match.</span>
07107     <span class="comment">//</span>
07108 
07109     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( (PSID)&amp;ChildAce-&gt;SidStart, (PSID)&amp;InheritedAce-&gt;SidStart )) {
07110 
07111         <span class="comment">//</span>
07112         <span class="comment">// The inheritance algorithm only does SID mapping when building the effective</span>
07113         <span class="comment">//  ace.  So, we only check for a mapped SID if the child ACE is an effective ACE.</span>
07114         <span class="comment">//</span>
07115 
07116         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a6">AceFlagsInAce</a>(ChildAce) != <a class="code" href="../../d8/d6/sertl_8c.html#a5">EFFECTIVE_ACE</a> ) {
07117 <span class="preprocessor">#if DBG</span>
07118 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07119                 KdPrint((<span class="stringliteral">"SID mismatch"</span>));
07120             }
07121 <span class="preprocessor">#endif // DBG</span>
07122 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07123         }
07124 
07125         <span class="comment">//</span>
07126         <span class="comment">// In the case of CreatorOwner and CreatorGroup, the SIDs don't have to</span>
07127         <span class="comment">//  exactly match.  When the InheritedAce was generated, care was taken</span>
07128         <span class="comment">//  to NOT map these sids.  The SID may (or may not) have been mapped in</span>
07129         <span class="comment">//  the ChildAce.  We want to compare equal in both cases.</span>
07130         <span class="comment">//</span>
07131         <span class="comment">// If the InheritedAce contains a CreatorOwner/Group SID,</span>
07132         <span class="comment">//  do the another comparison of the SID in the child ACE with the</span>
07133         <span class="comment">//  real owner/group from the child security descriptor.</span>
07134         <span class="comment">//</span>
07135 
07136         <span class="keywordflow">if</span> ( OwnerSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || GroupSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
07137             SID_IDENTIFIER_AUTHORITY  CreatorSidAuthority = SECURITY_CREATOR_SID_AUTHORITY;
07138             ULONG <a class="code" href="../../d4/d6/tsevars_8c.html#a33">CreatorSid</a>[<a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a>];
07139 
07140             <span class="comment">//</span>
07141             <span class="comment">// Allocate and initialize the universal SIDs we're going to need</span>
07142             <span class="comment">// to look for inheritable ACEs.</span>
07143             <span class="comment">//</span>
07144 
07145             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 ) == CREATOR_SID_SIZE);
07146             <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( (PSID)CreatorSid, &amp;CreatorSidAuthority, 1 );
07147             *(RtlpSubAuthoritySid( (PSID)CreatorSid, 0 )) = SECURITY_CREATOR_OWNER_RID;
07148 
07149             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a37">RtlEqualPrefixSid</a> ( (PSID)&amp;InheritedAce-&gt;SidStart, CreatorSid )) {
07150                 ULONG Rid;
07151 
07152                 Rid = *RtlpSubAuthoritySid( (PSID)&amp;InheritedAce-&gt;SidStart, 0 );
07153                 <span class="keywordflow">switch</span> (Rid) {
07154                 <span class="keywordflow">case</span> SECURITY_CREATOR_OWNER_RID:
07155                     <span class="keywordflow">if</span> ( OwnerSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
07156                          !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( (PSID)&amp;ChildAce-&gt;SidStart, OwnerSid )) {
07157 <span class="preprocessor">#if DBG</span>
07158 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07159                             KdPrint((<span class="stringliteral">"SID mismatch (Creator Owner)"</span>));
07160                         }
07161 <span class="preprocessor">#endif // DBG</span>
07162 <span class="preprocessor"></span>                        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07163                     }
07164                     <span class="keywordflow">break</span>;
07165                 <span class="keywordflow">case</span> SECURITY_CREATOR_GROUP_RID:
07166                     <span class="keywordflow">if</span> ( GroupSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
07167                          !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( (PSID)&amp;ChildAce-&gt;SidStart, GroupSid )) {
07168 <span class="preprocessor">#if DBG</span>
07169 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07170                             KdPrint((<span class="stringliteral">"SID mismatch (Creator Group)"</span>));
07171                         }
07172 <span class="preprocessor">#endif // DBG</span>
07173 <span class="preprocessor"></span>                        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07174                     }
07175                     <span class="keywordflow">break</span>;
07176                 <span class="keywordflow">default</span>:
07177 <span class="preprocessor">#if DBG</span>
07178 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07179                         KdPrint((<span class="stringliteral">"SID mismatch (Creator)"</span>));
07180                     }
07181 <span class="preprocessor">#endif // DBG</span>
07182 <span class="preprocessor"></span>                    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07183                 }
07184 
07185             } <span class="keywordflow">else</span> {
07186 <span class="preprocessor">#if DBG</span>
07187 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07188                     KdPrint((<span class="stringliteral">"SID mismatch"</span>));
07189                 }
07190 <span class="preprocessor">#endif // DBG</span>
07191 <span class="preprocessor"></span>                <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07192             }
07193         } <span class="keywordflow">else</span> {
07194 <span class="preprocessor">#if DBG</span>
07195 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07196                 KdPrint((<span class="stringliteral">"SID mismatch"</span>));
07197             }
07198 <span class="preprocessor">#endif // DBG</span>
07199 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07200         }
07201     }
07202 
07203     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07204 
07205 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="sertl.c::RtlpCompareKnownObjectAces" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpCompareKnownObjectAces           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKNOWN_OBJECT_ACE&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritedAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKNOWN_OBJECT_ACE&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID OwnerSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID GroupSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">7209</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l06966">AceFlagsInAce</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00330">CREATOR_SID_SIZE</a>, <a class="el" href="../../d5/d5/tsevars_8c-source.html#l00116">CreatorSid</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06965">EFFECTIVE_ACE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00340">RtlBaseAceType</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00924">RtlEqualPrefixSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01166">RtlInitializeSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00356">RtlIsSystemAceType</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00368">RtlpVerboseConvert</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l06972">RtlpCompareAces()</a>.
<p>
<pre class="fragment"><div>07218                    :
07219 
07220     <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a> two aces to see <span class="keywordflow">if</span> they are <span class="stringliteral">"substantially"</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
07221 
07222 Arguments:
07223 
07224     InheritedAce - Computed ACE as inherited from DirectoryAcl.
07225 
07226     ChildAce - The current acl on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  This ACL must be a revision 2 ACL.
07227 
07228     ObjectType - GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being created.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being
07229         created has no GUID associated with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
07230         specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
07231 
07232     OwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use.
07233         If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner sid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not treated as special.
07234 
07235     GroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group SID to use.
07236         If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group sid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not treated as special.
07237 
07238 Return Value:
07239 
07240     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The ACEs are substantially <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
07241     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The ACEs are not substantially <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
07242 
07243 --*/
07244 
07245 {
07246     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
07247     BOOLEAN DoingObjectAces;
07248     GUID *ChildObjectGuid;
07249     GUID *InhObjectGuid;
07250     GUID *ChildInheritedObjectGuid;
07251     GUID *InhInheritedObjectGuid;
07252     ACE_HEADER <span class="keyword">volatile</span> *InheritedAceHdr = &amp;InheritedAce-&gt;Header;
07253 
07254     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
07255 
07256     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsObjectAceType(InheritedAce));
07257     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsObjectAceType(ChildAce));
07258     <span class="comment">//</span>
07259     <span class="comment">// If the Ace types are different,</span>
07260     <span class="comment">//  we don't match.</span>
07261     <span class="comment">//</span>
07262     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[ChildAce-&gt;Header.AceType] != <a class="code" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[InheritedAceHdr-&gt;AceType] ) {
07263 <span class="preprocessor">#if DBG</span>
07264 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07265             KdPrint((<span class="stringliteral">"AceType mismatch"</span>));
07266         }
07267 <span class="preprocessor">#endif // DBG</span>
07268 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07269     }
07270 
07271     <span class="comment">//</span>
07272     <span class="comment">// If this is a system ACE,</span>
07273     <span class="comment">//  ensure the SUCCESS/FAILURE flags match.</span>
07274     <span class="comment">//</span>
07275 
07276     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a8">RtlIsSystemAceType</a>[ChildAce-&gt;Header.AceType] ) {
07277         <span class="keywordflow">if</span> ( (ChildAce-&gt;Header.AceFlags &amp; (SUCCESSFUL_ACCESS_ACE_FLAG|FAILED_ACCESS_ACE_FLAG)) !=
07278              (InheritedAceHdr-&gt;AceFlags &amp; (SUCCESSFUL_ACCESS_ACE_FLAG|FAILED_ACCESS_ACE_FLAG)) ) {
07279 <span class="preprocessor">#if DBG</span>
07280 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07281                 KdPrint((<span class="stringliteral">"System ace success/fail mismatch"</span>));
07282             }
07283 <span class="preprocessor">#endif // DBG</span>
07284 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07285         }
07286     }
07287 
07288     <span class="comment">//</span>
07289     <span class="comment">// Get the GUIDs from the Object Aces</span>
07290     <span class="comment">//</span>
07291 
07292     ChildObjectGuid = RtlObjectAceObjectType(ChildAce);
07293     ChildInheritedObjectGuid = RtlObjectAceInheritedObjectType(ChildAce);
07294 
07295     InhObjectGuid = RtlObjectAceObjectType(InheritedAce);
07296     InhInheritedObjectGuid = RtlObjectAceInheritedObjectType(InheritedAce);
07297 
07298     <span class="comment">//</span>
07299     <span class="comment">// If the InheritedObjectGuid is present in either ACE,</span>
07300     <span class="comment">//  they must be equal.</span>
07301     <span class="comment">//</span>
07302 
07303     <span class="keywordflow">if</span> ( ChildInheritedObjectGuid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || InhInheritedObjectGuid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
07304 
07305         <span class="keywordflow">if</span> ( ChildInheritedObjectGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
07306              InhInheritedObjectGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
07307              !RtlpIsEqualGuid( ChildInheritedObjectGuid, InhInheritedObjectGuid )) {
07308 <span class="preprocessor">#if DBG</span>
07309 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07310                 KdPrint((<span class="stringliteral">"InheritedObject GUID mismatch"</span>));
07311             }
07312 <span class="preprocessor">#endif // DBG</span>
07313 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07314         }
07315     }
07316 
07317     <span class="comment">//</span>
07318     <span class="comment">// If the ObjectGUID is present in either ACE,</span>
07319     <span class="comment">//  they must be equal.</span>
07320     <span class="comment">//</span>
07321     <span class="comment">// Any missing object GUID defaults to the passed in object GUID.</span>
07322     <span class="comment">//</span>
07323 
07324     <span class="keywordflow">if</span> ( (ChildObjectGuid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (InhObjectGuid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
07325 
07326         <span class="keywordflow">if</span> (!RtlpIsEqualGuid( ChildObjectGuid, InhObjectGuid )) {
07327 <span class="preprocessor">#if DBG</span>
07328 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07329                 KdPrint((<span class="stringliteral">"Object GUID mismatch"</span>));
07330             }
07331 <span class="preprocessor">#endif // DBG</span>
07332 <span class="preprocessor"></span>
07333             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
07334         }
07335     } <span class="keywordflow">else</span> {
07336 
07337         <span class="comment">//</span>
07338         <span class="comment">// One or both is NULL, if it's only one, they don't match.</span>
07339         <span class="comment">//</span>
07340 
07341         <span class="keywordflow">if</span> ( !((ChildObjectGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (InhObjectGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) ) {
07342 <span class="preprocessor">#if DBG</span>
07343 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07344                 KdPrint((<span class="stringliteral">"Object GUID mismatch"</span>));
07345             }
07346 <span class="preprocessor">#endif // DBG</span>
07347 <span class="preprocessor"></span>
07348             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
07349         }
07350     }
07351 
07352     <span class="comment">//</span>
07353     <span class="comment">// If the SID of the inherited ACE doesn't match,</span>
07354     <span class="comment">//  we don't match.</span>
07355     <span class="comment">//</span>
07356 
07357     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( RtlObjectAceSid(ChildAce), RtlObjectAceSid(InheritedAce))) {
07358 
07359         <span class="comment">//</span>
07360         <span class="comment">// The inheritance algorithm only does SID mapping when building the effective</span>
07361         <span class="comment">//  ace.  So, we only check for a mapped SID if the child ACE is an effective ACE.</span>
07362         <span class="comment">//</span>
07363 
07364         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a6">AceFlagsInAce</a>(ChildAce) != <a class="code" href="../../d8/d6/sertl_8c.html#a5">EFFECTIVE_ACE</a> ) {
07365 <span class="preprocessor">#if DBG</span>
07366 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07367                 KdPrint((<span class="stringliteral">"SID mismatch"</span>));
07368             }
07369 <span class="preprocessor">#endif // DBG</span>
07370 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07371         }
07372 
07373 
07374 
07375         <span class="comment">//</span>
07376         <span class="comment">// In the case of CreatorOwner and CreatorGroup, the SIDs don't have to</span>
07377         <span class="comment">//  exactly match.  When the InheritedAce was generated, care was taken</span>
07378         <span class="comment">//  to NOT map these sids.  The SID may (or may not) have been mapped in</span>
07379         <span class="comment">//  the ChildAce.  We want to compare equal in both cases.</span>
07380         <span class="comment">//</span>
07381         <span class="comment">// If the InheritedAce contains a CreatorOwner/Group SID,</span>
07382         <span class="comment">//  do the another comparison of the SID in the child ACE with the</span>
07383         <span class="comment">//  real owner/group from the child security descriptor.</span>
07384         <span class="comment">//</span>
07385 
07386         <span class="keywordflow">if</span> ( OwnerSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || GroupSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
07387             SID_IDENTIFIER_AUTHORITY  CreatorSidAuthority = SECURITY_CREATOR_SID_AUTHORITY;
07388             ULONG <a class="code" href="../../d4/d6/tsevars_8c.html#a33">CreatorSid</a>[<a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a>];
07389 
07390             <span class="comment">//</span>
07391             <span class="comment">// Allocate and initialize the universal SIDs we're going to need</span>
07392             <span class="comment">// to look for inheritable ACEs.</span>
07393             <span class="comment">//</span>
07394 
07395             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 ) == CREATOR_SID_SIZE);
07396             <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( (PSID)CreatorSid, &amp;CreatorSidAuthority, 1 );
07397             *(RtlpSubAuthoritySid( (PSID)CreatorSid, 0 )) = SECURITY_CREATOR_OWNER_RID;
07398 
07399             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a37">RtlEqualPrefixSid</a> ( RtlObjectAceSid(InheritedAce), CreatorSid )) {
07400                 ULONG Rid;
07401 
07402                 Rid = *RtlpSubAuthoritySid( RtlObjectAceSid(InheritedAce), 0 );
07403                 <span class="keywordflow">switch</span> (Rid) {
07404                 <span class="keywordflow">case</span> SECURITY_CREATOR_OWNER_RID:
07405                     <span class="keywordflow">if</span> ( OwnerSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
07406                          !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( RtlObjectAceSid(ChildAce), OwnerSid )) {
07407 <span class="preprocessor">#if DBG</span>
07408 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07409                             KdPrint((<span class="stringliteral">"SID mismatch (Creator Owner)"</span>));
07410                         }
07411 <span class="preprocessor">#endif // DBG</span>
07412 <span class="preprocessor"></span>                        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07413                     }
07414                     <span class="keywordflow">break</span>;
07415                 <span class="keywordflow">case</span> SECURITY_CREATOR_GROUP_RID:
07416                     <span class="keywordflow">if</span> ( GroupSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
07417                          !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( RtlObjectAceSid(ChildAce), GroupSid )) {
07418 <span class="preprocessor">#if DBG</span>
07419 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07420                             KdPrint((<span class="stringliteral">"SID mismatch (Creator Group)"</span>));
07421                         }
07422 <span class="preprocessor">#endif // DBG</span>
07423 <span class="preprocessor"></span>                        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07424                     }
07425                     <span class="keywordflow">break</span>;
07426                 <span class="keywordflow">default</span>:
07427 <span class="preprocessor">#if DBG</span>
07428 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07429                         KdPrint((<span class="stringliteral">"SID mismatch (Creator)"</span>));
07430                     }
07431 <span class="preprocessor">#endif // DBG</span>
07432 <span class="preprocessor"></span>                    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07433                 }
07434 
07435             } <span class="keywordflow">else</span> {
07436 <span class="preprocessor">#if DBG</span>
07437 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07438                     KdPrint((<span class="stringliteral">"SID mismatch"</span>));
07439                 }
07440 <span class="preprocessor">#endif // DBG</span>
07441 <span class="preprocessor"></span>                <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07442             }
07443         } <span class="keywordflow">else</span> {
07444 <span class="preprocessor">#if DBG</span>
07445 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07446                 KdPrint((<span class="stringliteral">"SID mismatch"</span>));
07447             }
07448 <span class="preprocessor">#endif // DBG</span>
07449 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07450         }
07451     }
07452 
07453     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07454 
07455 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="sertl.c::RtlpComputeMergedAcl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpComputeMergedAcl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentGenericControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationGenericControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientOwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientGroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsSacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewGenericControl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l06266">6266</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05893">RtlpComputeMergedAcl2()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>.
<p>
<pre class="fragment"><div>06281                    :
06282 
06283     This routine builds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual ACL that should be set on an object.
06284     The built ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a composite of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous ACL on an object and
06285     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly set ACL on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The New ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built as follows:
06286 
06287     If SEP_ACL_PROTECTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in neither CurrentAcl nor ModificationAcl,
06288     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> constructed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherited ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06289     CurrentAcl and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-inherited ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ModificationAcl.
06290     (That <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> impossible to edit an inherited ACE by changing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06291     ACL on an object.)
06292 
06293     If SEP_ACL_PROTECTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set on ModificationAcl, CurrentAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
06294     NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built as a copy of ModificationAcl with any INHERITED_ACE
06295     bits turned off.
06296 
06297     If SEP_ACL_PROTECTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set on CurrentAcl and not ModificationAcl, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06298     CurrentAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.  NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built as a copy of
06299     ModificationDescriptor.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callers responsibility to ensure
06300     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct ACEs have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> INHERITED_ACE bit turned on.
06301 
06302 Arguments:
06303 
06304     CurrentAcl - The current ACL on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
06305 
06306     CurrentGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor
06307         describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CurrentAcl.
06308 
06309     ModificationAcl - The ACL being applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
06310 
06311     ModificationGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor
06312         describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CurrentAcl.
06313 
06314     ClientOwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use
06315 
06316     ClientGroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> Sid to use
06317 
06318     GenericMapping - The mapping of generic to specific and standard
06319                      access types.
06320 
06321     IsSacl - True <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SACL.  False <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL.
06322 
06323     NewAcl - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> resultant acl.
06324 
06325     NewGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly
06326         generated ACL.
06327 
06328         Only <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Protected and AutoInherited bits are returned.
06329 
06330 Return Value:
06331 
06332     STATUS_SUCCESS - An ACL was successfully generated.
06333 
06334     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a revision that
06335         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unknown to <span class="keyword">this</span> routine.
06336 
06337 --*/
06338 
06339 {
06340     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06341     ULONG AclBufferSize;
06342     ULONG i;
06343 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
06344 <span class="preprocessor"></span>    PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
06345 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06346 <span class="preprocessor"></span>
06347     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
06348 
06349     <span class="comment">//</span>
06350     <span class="comment">// Get the handle to the current process heap</span>
06351     <span class="comment">//</span>
06352 
06353 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
06354 <span class="preprocessor"></span>    <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
06355 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06356 <span class="preprocessor"></span>
06357 
06358     <span class="comment">//</span>
06359     <span class="comment">// Implement a two pass strategy.</span>
06360     <span class="comment">//</span>
06361     <span class="comment">// First try to create the ACL in a fixed length buffer.</span>
06362     <span class="comment">// If that is too small,</span>
06363     <span class="comment">//  then use the buffer size determined on the first pass</span>
06364     <span class="comment">//</span>
06365 
06366     AclBufferSize = 1024;
06367     <span class="keywordflow">for</span> ( i=0; i&lt;2 ; i++ ) {
06368 
06369         <span class="comment">//</span>
06370         <span class="comment">// Allocate heap for the new ACL.</span>
06371         <span class="comment">//</span>
06372 
06373 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
06374 <span class="preprocessor"></span>        (*NewAcl) = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
06375                         PagedPool,
06376                         AclBufferSize,
06377                         'cAeS' );
06378 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
06379 <span class="preprocessor"></span>        (*NewAcl) = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, 0, AclBufferSize );
06380 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06381 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((*NewAcl) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06382             <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
06383         }
06384 
06385         <span class="comment">//</span>
06386         <span class="comment">// Merge the ACLs</span>
06387         <span class="comment">//</span>
06388 
06389         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a22">RtlpComputeMergedAcl2</a> (
06390                     CurrentAcl,
06391                     CurrentGenericControl,
06392                     ModificationAcl,
06393                     ModificationGenericControl,
06394                     ClientOwnerSid,
06395                     ClientGroupSid,
06396                     GenericMapping,
06397                     IsSacl,
06398                     &amp;AclBufferSize,
06399                     (PUCHAR) *NewAcl,
06400                     NewGenericControl );
06401 
06402 
06403         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
06404 
06405             <span class="comment">//</span>
06406             <span class="comment">// If a NULL ACL should be used,</span>
06407             <span class="comment">//  tell the caller.</span>
06408             <span class="comment">//</span>
06409 
06410             <span class="keywordflow">if</span> ( AclBufferSize == 0 ) {
06411 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
06412 <span class="preprocessor"></span>                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *NewAcl );
06413 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
06414 <span class="preprocessor"></span>                <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, *NewAcl );
06415 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06416 <span class="preprocessor"></span>                *NewAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06417             }
06418 
06419             <span class="keywordflow">break</span>;
06420 
06421         } <span class="keywordflow">else</span> {
06422 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
06423 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *NewAcl );
06424 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
06425 <span class="preprocessor"></span>            <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, *NewAcl );
06426 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06427 <span class="preprocessor"></span>            *NewAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06428 
06429             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL ) {
06430                 <span class="keywordflow">break</span>;
06431             }
06432         }
06433     }
06434 
06435 
06436     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06437 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="sertl.c::RtlpComputeMergedAcl2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpComputeMergedAcl2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentGenericControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationGenericControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientOwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientGroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsSacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AclBufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>AclBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewGenericControl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l05893">5893</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d8/d6/sertl_8c.html#a80a12">CopyAllAces</a>, <a class="el" href="../../d8/d6/sertl_8c.html#a80a10">CopyInheritedAces</a>, <a class="el" href="../../d8/d6/sertl_8c.html#a80a11">CopyNonInheritedAces</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l04371">RtlpCopyAces()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l06266">RtlpComputeMergedAcl()</a>.
<p>
<pre class="fragment"><div>05909                    :
05910 
05911     This routine implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 'set' semantics <span class="keywordflow">for</span> <span class="keyword">auto</span> inheritance.
05912 
05913     This routine builds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual ACL that should be set on an object.
05914     The built ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a composite of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous ACL on an object and
05915     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly set ACL on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The New ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built as follows:
05916 
05917     If SEP_ACL_PROTECTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in neither CurrentAcl nor ModificationAcl,
05918     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> constructed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherited ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05919     CurrentAcl and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-inherited ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ModificationAcl.
05920     (That <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> impossible to edit an inherited ACE by changing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05921     ACL on an object.)
05922 
05923     If SEP_ACL_PROTECTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set on ModificationAcl, CurrentAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
05924     NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built as a copy of ModificationAcl with any INHERITED_ACE
05925     bits turned off.
05926 
05927     If SEP_ACL_PROTECTED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set on CurrentAcl and not ModificationAcl, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05928     CurrentAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.  NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built as a copy of
05929     ModificationDescriptor.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callers responsibility to ensure
05930     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct ACEs have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> INHERITED_ACE bit turned on.
05931 
05932 Arguments:
05933 
05934     CurrentAcl - The current ACL on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
05935 
05936     CurrentGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor
05937         describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CurrentAcl.
05938 
05939     ModificationAcl - The ACL being applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
05940 
05941     ModificationGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor
05942         describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CurrentAcl.
05943 
05944     ClientOwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use
05945 
05946     ClientGroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> Sid to use
05947 
05948     GenericMapping - The mapping of generic to specific and standard
05949                      access types.
05950 
05951     IsSacl - True <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SACL.  False <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL.
05952 
05953     AclBufferSize - On input, specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of AclBuffer.
05954         On output, on success, returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> used size of AclBuffer.
05955         On output, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too small, returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required size of AclBuffer.
05956 
05957     AclBuffer - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> (inherited) acl.
05958 
05959     NewGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly
05960         generated ACL.
05961 
05962         Only <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Protected and AutoInherited bits are returned.
05963 
05964 Return Value:
05965 
05966     STATUS_SUCCESS - An ACL was successfully generated.
05967 
05968     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a revision that
05969         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unknown to <span class="keyword">this</span> routine.
05970 
05971 --*/
05972 
05973 {
05974     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05975     ULONG ModificationNewAclSize = 0;
05976     ULONG CurrentNewAclSize = 0;
05977     ULONG AclRevision;
05978     BOOLEAN AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05979     BOOLEAN NullAclOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05980 
05981     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
05982 
05983 
05984     <span class="comment">//</span>
05985     <span class="comment">// Assume the ACL revision.</span>
05986     <span class="comment">//</span>
05987 
05988     AclRevision = ACL_REVISION;
05989     <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( (PACL)AclBuffer, *AclBufferSize, AclRevision );
05990 
05991     <span class="comment">//</span>
05992     <span class="comment">// This routine is only called for the AutoInheritance case.</span>
05993     <span class="comment">//</span>
05994 
05995     *NewGenericControl = SEP_ACL_AUTO_INHERITED;
05996 
05997     <span class="comment">//</span>
05998     <span class="comment">// If the new ACL is protected,</span>
05999     <span class="comment">//  simply use the new ACL with the INHERITED_ACE bits turned off.</span>
06000     <span class="comment">//</span>
06001 
06002     <span class="keywordflow">if</span> ( (ModificationGenericControl &amp; SEP_ACL_PROTECTED) != 0 ) {
06003 
06004         <span class="comment">//</span>
06005         <span class="comment">// Set the Control bits for the resultant descriptor.</span>
06006         <span class="comment">//</span>
06007 
06008         *NewGenericControl |= SEP_ACL_PROTECTED;
06009 
06010         <span class="comment">//</span>
06011         <span class="comment">// Only copy the ACL if it is actually present</span>
06012         <span class="comment">//</span>
06013 
06014         <span class="keywordflow">if</span> ( ModificationAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06015 
06016             AclRevision = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( AclRevision, ModificationAcl-&gt;AclRevision );
06017 
06018             <span class="comment">//</span>
06019             <span class="comment">// Copy all ACES, turn off the inherited bit, and generic map them.</span>
06020             <span class="comment">//</span>
06021 
06022             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a17">RtlpCopyAces</a>(
06023                         ModificationAcl,
06024                         GenericMapping,
06025                         CopyAllAces,
06026                         INHERITED_ACE,  <span class="comment">// Turn off all INHERITED_ACE flags</span>
06027                         TRUE,           <span class="comment">// Map sids as needed</span>
06028                         ClientOwnerSid,
06029                         ClientGroupSid,
06030                         ClientOwnerSid, <span class="comment">// Not technically correct. s.b. server sid</span>
06031                         ClientGroupSid, <span class="comment">// Not technically correct. s.b. server sid</span>
06032                         &amp;ModificationNewAclSize,
06033                         (PACL)AclBuffer );
06034 
06035             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ) {
06036                 AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06037                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06038             }
06039 
06040             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
06041                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06042             }
06043 
06044             <span class="comment">//</span>
06045             <span class="comment">// If the caller specified an ACL with no ACES,</span>
06046             <span class="comment">//  make sure we generate an ACL with no ACES.</span>
06047             <span class="comment">//</span>
06048 
06049             NullAclOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06050         }
06051 
06052     <span class="comment">//</span>
06053     <span class="comment">// If the old ACL is protected but the new one isn't,</span>
06054     <span class="comment">//  simply use the new ACL as is.</span>
06055     <span class="comment">//</span>
06056     <span class="comment">// Rely on the caller to get the INHERITED_ACE bits right.</span>
06057     <span class="comment">//</span>
06058 
06059     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (CurrentGenericControl &amp; SEP_ACL_PROTECTED) != 0 ) {
06060 
06061         <span class="comment">//</span>
06062         <span class="comment">// Only do the copy if the new ACL is specified.</span>
06063         <span class="comment">//</span>
06064 
06065         <span class="keywordflow">if</span> ( ModificationAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06066             AclRevision = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( AclRevision, ModificationAcl-&gt;AclRevision );
06067 
06068             <span class="comment">//</span>
06069             <span class="comment">// Copy all ACES, and generic map them.</span>
06070             <span class="comment">//</span>
06071 
06072             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a17">RtlpCopyAces</a>(
06073                         ModificationAcl,
06074                         GenericMapping,
06075                         CopyAllAces,
06076                         0,
06077                         TRUE,           <span class="comment">// Map sids as needed</span>
06078                         ClientOwnerSid,
06079                         ClientGroupSid,
06080                         ClientOwnerSid, <span class="comment">// Not technically correct. s.b. server sid</span>
06081                         ClientGroupSid, <span class="comment">// Not technically correct. s.b. server sid</span>
06082                         &amp;ModificationNewAclSize,
06083                         (PACL)AclBuffer );
06084 
06085             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ) {
06086                 AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06087                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06088             }
06089 
06090             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
06091                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06092             }
06093 
06094             <span class="comment">//</span>
06095             <span class="comment">// If the caller specified an ACL with no ACES,</span>
06096             <span class="comment">//  make sure we generate an ACL with no ACES.</span>
06097             <span class="comment">//</span>
06098 
06099             NullAclOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06100 
06101         <span class="comment">//</span>
06102         <span class="comment">// Since the ACL isn't protected,</span>
06103         <span class="comment">//  don't allow NULL ACL semantics.</span>
06104         <span class="comment">//  (those semantics are ambiguous for auto inheritance)</span>
06105         <span class="comment">//</span>
06106         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !IsSacl ) {
06107             <span class="keywordflow">return</span> STATUS_INVALID_ACL;
06108         }
06109 
06110 
06111     <span class="comment">//</span>
06112     <span class="comment">// If neither are protected,</span>
06113     <span class="comment">//  use the non-inherited ACEs from the new ACL, and</span>
06114     <span class="comment">//  preserve the inherited ACEs from the old ACL.</span>
06115     <span class="comment">//</span>
06116 
06117     } <span class="keywordflow">else</span> {
06118 
06119         <span class="comment">//</span>
06120         <span class="comment">// NULL ACLs are always OK for a SACL.</span>
06121         <span class="comment">// NULL ACLs are never OK for a non-protected DACL.</span>
06122         <span class="comment">//</span>
06123 
06124         NullAclOk = IsSacl;
06125 
06126 
06127         <span class="comment">//</span>
06128         <span class="comment">// Only do the copy if the new ACL is specified.</span>
06129         <span class="comment">//</span>
06130 
06131         <span class="keywordflow">if</span> ( ModificationAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06132             AclRevision = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( AclRevision, ModificationAcl-&gt;AclRevision );
06133 
06134             <span class="comment">//</span>
06135             <span class="comment">// Copy the non-inherited ACES, and generic map them.</span>
06136             <span class="comment">//</span>
06137 
06138             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a17">RtlpCopyAces</a>(
06139                         ModificationAcl,
06140                         GenericMapping,
06141                         CopyNonInheritedAces,
06142                         0,
06143                         TRUE,           <span class="comment">// Map sids as needed</span>
06144                         ClientOwnerSid,
06145                         ClientGroupSid,
06146                         ClientOwnerSid, <span class="comment">// Not technically correct. s.b. server sid</span>
06147                         ClientGroupSid, <span class="comment">// Not technically correct. s.b. server sid</span>
06148                         &amp;ModificationNewAclSize,
06149                         (PACL)AclBuffer );
06150 
06151             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ) {
06152                 AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06153                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06154             }
06155 
06156             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
06157                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06158             }
06159 
06160             <span class="comment">//</span>
06161             <span class="comment">// If the caller specified an ACL with no ACES,</span>
06162             <span class="comment">//  make sure we generate an ACL with no ACES.</span>
06163             <span class="comment">//</span>
06164             <span class="comment">// If inherited aces were deleted, leave the flag alone allowing</span>
06165             <span class="comment">//  a NULL SACL to be generated.</span>
06166             <span class="comment">//</span>
06167 
06168             <span class="keywordflow">if</span> ( ModificationAcl-&gt;AceCount == 0 ) {
06169                 NullAclOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06170             }
06171 
06172         <span class="comment">//</span>
06173         <span class="comment">// Since the ACL isn't protected,</span>
06174         <span class="comment">//  don't allow NULL ACL semantics.</span>
06175         <span class="comment">//  (those semantics are ambiguous for auto inheritance)</span>
06176         <span class="comment">//</span>
06177         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !IsSacl ) {
06178             <span class="keywordflow">return</span> STATUS_INVALID_ACL;
06179         }
06180 
06181 
06182         <span class="comment">//</span>
06183         <span class="comment">// Only do the copy if the old ACL is specified.</span>
06184         <span class="comment">//</span>
06185 
06186         <span class="keywordflow">if</span> ( CurrentAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06187 
06188             AclRevision = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( AclRevision, CurrentAcl-&gt;AclRevision );
06189 
06190 
06191             <span class="comment">//</span>
06192             <span class="comment">// Copy the inherited ACES, and generic map them.</span>
06193             <span class="comment">//</span>
06194             <span class="comment">// Don't bother mapping the sids in these ACEs.  They got mapped</span>
06195             <span class="comment">// during inheritance.</span>
06196             <span class="comment">//</span>
06197 
06198             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a17">RtlpCopyAces</a>(
06199                         CurrentAcl,
06200                         GenericMapping,
06201                         CopyInheritedAces,
06202                         0,
06203                         FALSE,          <span class="comment">// Don't map the sids,</span>
06204                         NULL,
06205                         NULL,
06206                         NULL,
06207                         NULL,
06208                         &amp;CurrentNewAclSize,
06209                         (PACL)AclBuffer );
06210 
06211             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ) {
06212                 AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06213                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06214             }
06215 
06216             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
06217                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06218             }
06219         }
06220     }
06221 
06222     <span class="comment">//</span>
06223     <span class="comment">// If this routine didn't build the ACL,</span>
06224     <span class="comment">//  tell the caller to use an explict NULL ACL</span>
06225     <span class="comment">//</span>
06226 
06227     <span class="keywordflow">if</span> ( ModificationNewAclSize + CurrentNewAclSize == 0) {
06228         <span class="comment">//</span>
06229         <span class="comment">// If the Acl was explictly assigned,</span>
06230         <span class="comment">//  generate a NULL ACL based on the path taken above.</span>
06231         <span class="comment">//</span>
06232 
06233         <span class="keywordflow">if</span> ( NullAclOk ) {
06234             *AclBufferSize = 0;
06235             <span class="keywordflow">return</span> STATUS_SUCCESS;
06236         }
06237     }
06238 
06239 
06240     <span class="comment">//</span>
06241     <span class="comment">// And make sure we don't exceed the length limitations of an ACL (WORD)</span>
06242     <span class="comment">//</span>
06243 
06244     <span class="keywordflow">if</span> ( ModificationNewAclSize + CurrentNewAclSize + <span class="keyword">sizeof</span>(ACL) &gt; 0xFFFF) {
06245         <span class="keywordflow">return</span>(STATUS_BAD_INHERITANCE_ACL);
06246     }
06247 
06248     (*AclBufferSize) = ModificationNewAclSize + CurrentNewAclSize + <span class="keyword">sizeof</span>(ACL);
06249 
06250     <span class="keywordflow">if</span> ( AclOverflowed ) {
06251         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
06252     }
06253 
06254     <span class="comment">//</span>
06255     <span class="comment">// Patch the real ACL size and revision into the ACL</span>
06256     <span class="comment">//</span>
06257 
06258     ((PACL)AclBuffer)-&gt;AclSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) *AclBufferSize;
06259     ((PACL)AclBuffer)-&gt;AclRevision = (UCHAR) AclRevision;
06260 
06261     <span class="keywordflow">return</span> STATUS_SUCCESS;
06262 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="sertl.c::RtlpConvertAclToAutoInherit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpConvertAclToAutoInherit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL ParentAcl&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewGenericControl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">7461</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l06966">AceFlagsInAce</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00330">CREATOR_SID_SIZE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00111">CreatorOwnerSid</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06965">EFFECTIVE_ACE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00066">_KNOWN_ACE::Header</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00067">_KNOWN_ACE::Mask</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00340">RtlBaseAceType</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01166">RtlInitializeSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06972">RtlpCompareAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05153">RtlpInheritAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00368">RtlpVerboseConvert</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">SE_TAG</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l06520">RtlpConvertToAutoInheritSecurityObject()</a>.
<p>
<pre class="fragment"><div>07475                    :
07476 
07477     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">private</span> routine that produces an <span class="keyword">auto</span> inherited acl from
07478     a ChildAcl that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not marked as <span class="keyword">auto</span> inherited.  The passed in InheritedAcl
07479     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> computed as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pure inherited ACL of Parent ACL of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
07480 
07481     See comments <span class="keywordflow">for</span> <a class="code" href="../../d4/d8/seurtl_8c.html#a14">RtlConvertToAutoInheritSecurityObject</a>.
07482 
07483 Arguments:
07484 
07485     ParentAcl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent object.
07486 
07487     ChildAcl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  This
07488         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current acl on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
07489 
07490     ObjectType - GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being created.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being
07491         created has no GUID associated with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
07492         specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
07493 
07494     IsDirectoryObject - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
07495         directory object.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
07496         container of other objects.
07497 
07498     OwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use.
07499 
07500     GroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group SID to use.
07501 
07502     GenericMapping - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping to use.
07503 
07504     NewAcl - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> (<span class="keyword">auto</span> inherited) acl.
07505         The ACL must be deallocated <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> (kernel mode) or
07506             heap (user mode) deallocator.
07507 
07508     NewGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly
07509         generated ACL.
07510 
07511         SEP_ACL_PRESENT: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explictly supplied by
07512             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller. ?? Ever set?
07513 
07514         SEP_ACL_DEFAULTED: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL was supplied by some
07515             defaulting mechanism. ?? Ever set
07516 
07517         SEP_ACL_AUTO_INHERITED: Set <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL was generated <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
07518             Automatic Inheritance algorithm.
07519 
07520         SEP_ACL_PROTECTED: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">protected</span> and
07521             was not inherited from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent ACL.
07522 
07523 Return Value:
07524 
07525     STATUS_SUCCESS - An inheritable ACL was successfully generated.
07526 
07527     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a revision that
07528         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unknown to <span class="keyword">this</span> routine.
07529 
07530     STATUS_INVALID_ACL - The structure of one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACLs in invalid.
07531 
07532 --*/
07533 
07534 {
07535     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
07536 
07537     PACL InheritedAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07538     PACL RealInheritedAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07539     BOOLEAN AclExplicitlyAssigned;
07540     ULONG GenericControl;
07541 
07542     <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> ChildAce = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07543     <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> InheritedAce;
07544 
07545     LONG ChildAceIndex;
07546     LONG InheritedAceIndex;
07547 
07548     BOOLEAN InheritedAllowFound;
07549     BOOLEAN InheritedDenyFound;
07550 
07551     BOOLEAN AcesCompare;
07552 
07553     ACCESS_MASK InheritedContainerInheritMask;
07554     ACCESS_MASK InheritedObjectInheritMask;
07555     ACCESS_MASK InheritedEffectiveMask;
07556     ACCESS_MASK OriginalInheritedContainerInheritMask;
07557     ACCESS_MASK OriginalInheritedObjectInheritMask;
07558     ACCESS_MASK OriginalInheritedEffectiveMask;
07559 
07560     ULONG InheritedAceFlags;
07561     ULONG MatchedFlags;
07562     ULONG NonInheritedAclSize;
07563 
07564 
07565     PACE_HEADER AceHeader;
07566     PUCHAR Where;
07567 
07568     <span class="comment">// ULONG i;</span>
07569 
07570     <span class="comment">//</span>
07571     <span class="comment">// This routine maintains an array of the structure below (one element per ACE in</span>
07572     <span class="comment">// the ChildAcl).</span>
07573     <span class="comment">//</span>
07574     <span class="comment">// The ACE is broken down into its component parts.  The access mask is triplicated.</span>
07575     <span class="comment">// That is, if the ACE is a ContainerInherit ACE, the access mask is remembered as</span>
07576     <span class="comment">// being a "ContainerInheritMask".  The same is true if the ACE is an ObjectInherit ACE</span>
07577     <span class="comment">// on an effective ACE.  This is done since each of the resultant 96 bits are</span>
07578     <span class="comment">// individually matched against corresponding bits in the computed inherited ACE.</span>
07579     <span class="comment">//</span>
07580     <span class="comment">// Each of the above mentioned masks are maintained in two forms.  The first is never</span>
07581     <span class="comment">// changed and represents the bits as the originally appeared in the child ACL.</span>
07582     <span class="comment">// This second is modified as the corresponding bits are matched in the inherited ACL.</span>
07583     <span class="comment">// When the algorithm is completed, bits that haven't been matched represent ACEs</span>
07584     <span class="comment">// that weren't inherited from the parent.</span>
07585     <span class="comment">//</span>
07586 
07587     <span class="keyword">typedef</span> <span class="keyword">struct </span>{
07588         ACCESS_MASK OriginalContainerInheritMask;
07589         ACCESS_MASK OriginalObjectInheritMask;
07590         ACCESS_MASK OriginalEffectiveMask;
07591 
07592         ACCESS_MASK ContainerInheritMask;
07593         ACCESS_MASK ObjectInheritMask;
07594         ACCESS_MASK EffectiveMask;
07595     } ACE_INFO, *PACE_INFO;
07596 
07597     PACE_INFO ChildAceInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07598 
07599     ULONG <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a10">CreatorOwnerSid</a>[<a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a>];
07600     ULONG CreatorGroupSid[<a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a>];
07601 
07602     SID_IDENTIFIER_AUTHORITY  CreatorSidAuthority = SECURITY_CREATOR_SID_AUTHORITY;
07603 
07604 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
07605 <span class="preprocessor"></span>    PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
07606 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
07607 <span class="preprocessor"></span>
07608     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
07609 
07610     <span class="comment">//</span>
07611     <span class="comment">// Get the handle to the current process heap</span>
07612     <span class="comment">//</span>
07613 
07614 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
07615 <span class="preprocessor"></span>    <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
07616 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
07617 <span class="preprocessor"></span>
07618     <span class="comment">//</span>
07619     <span class="comment">// Allocate and initialize the universal SIDs we're going to need</span>
07620     <span class="comment">// to look for inheritable ACEs.</span>
07621     <span class="comment">//</span>
07622 
07623     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 ) == CREATOR_SID_SIZE);
07624     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( (PSID)CreatorOwnerSid, &amp;CreatorSidAuthority, 1 );
07625     *(RtlpSubAuthoritySid( (PSID)CreatorOwnerSid, 0 )) = SECURITY_CREATOR_OWNER_RID;
07626 
07627     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( (PSID)CreatorGroupSid, &amp;CreatorSidAuthority, 1 );
07628     *(RtlpSubAuthoritySid( (PSID)CreatorGroupSid, 0 )) = SECURITY_CREATOR_GROUP_RID;
07629 
07630     <span class="comment">//</span>
07631     <span class="comment">// Ensure the passed in ACLs are valid.</span>
07632     <span class="comment">//</span>
07633 
07634     *NewGenericControl = SEP_ACL_AUTO_INHERITED;
07635     *NewAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07636 
07637     <span class="keywordflow">if</span> ( ParentAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( ParentAcl ) ) {
07638         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_ACL;
07639         <span class="keywordflow">goto</span> Cleanup;
07640     }
07641 
07642     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( ChildAcl ) ) {
07643         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_ACL;
07644         <span class="keywordflow">goto</span> Cleanup;
07645     }
07646 
07647 
07648     <span class="comment">//</span>
07649     <span class="comment">// Compute what the inherited ACL "should" look like.</span>
07650     <span class="comment">//</span>
07651     <span class="comment">// The inherited ACL is computed to NOT SID-map Creator Owner and Creator Group.</span>
07652     <span class="comment">// This allows use to later recognize the constant SIDs and special case them</span>
07653     <span class="comment">// rather than mistakenly confuse them with the mapped SID.</span>
07654     <span class="comment">//</span>
07655 
07656     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a74">RtlpInheritAcl</a> (
07657                 ParentAcl,
07658                 NULL,   <span class="comment">// No explicit child ACL</span>
07659                 0,      <span class="comment">// No Child Generic Control</span>
07660                 IsDirectoryObject,
07661                 TRUE,   <span class="comment">// AutoInherit the DACL</span>
07662                 FALSE,  <span class="comment">// Not default descriptor for object</span>
07663                 CreatorOwnerSid,   <span class="comment">// Subsitute a constant SID</span>
07664                 CreatorGroupSid,   <span class="comment">// Subsitute a constant SID</span>
07665                 CreatorOwnerSid,   <span class="comment">// Server Owner (Technically incorrect, but OK since we don't support compound ACEs)</span>
07666                 CreatorGroupSid,   <span class="comment">// Server Group</span>
07667                 GenericMapping,
07668                 TRUE,   <span class="comment">// Is a SACL</span>
07669                 ObjectType,
07670                 &amp;InheritedAcl,
07671                 &amp;AclExplicitlyAssigned,
07672                 &amp;GenericControl );
07673 
07674     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_INHERITANCE ) {
07675         *NewGenericControl |= SEP_ACL_PROTECTED;
07676 <span class="preprocessor">#if DBG</span>
07677 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07678             KdPrint((<span class="stringliteral">"NO_INHERITANCE of the parent ACL\n"</span> ));
07679         }
07680 <span class="preprocessor">#endif // DBG</span>
07681 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
07682         <span class="keywordflow">goto</span> Cleanup;
07683     }
07684 
07685     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
07686 <span class="preprocessor">#if DBG</span>
07687 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07688             KdPrint((<span class="stringliteral">"Can't build inherited ACL %lX\n"</span>, Status ));
07689         }
07690 <span class="preprocessor">#endif // DBG</span>
07691 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> Cleanup;
07692     }
07693 
07694 
07695 
07696 
07697 
07698     <span class="comment">//</span>
07699     <span class="comment">// Allocate a work buffer describing the ChildAcl</span>
07700     <span class="comment">//</span>
07701 
07702 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
07703 <span class="preprocessor"></span>    ChildAceInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
07704                         PagedPool,
07705                         ChildAcl-&gt;AceCount * <span class="keyword">sizeof</span>(ACE_INFO),
07706                         'cAeS' );
07707 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
07708 <span class="preprocessor"></span>    ChildAceInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
07709                         HeapHandle,
07710                         <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(SE_TAG),
07711                         ChildAcl-&gt;AceCount * <span class="keyword">sizeof</span>(ACE_INFO) );
07712 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
07713 <span class="preprocessor"></span>
07714     <span class="keywordflow">if</span> (ChildAceInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
07715         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
07716         <span class="keywordflow">goto</span> Cleanup;
07717     }
07718 
07719     <span class="keywordflow">for</span> (ChildAceIndex = 0, ChildAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(ChildAcl);
07720          ChildAceIndex &lt; ChildAcl-&gt;AceCount;
07721          ChildAceIndex += 1, ChildAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(ChildAce)) {
07722         ACCESS_MASK LocalMask;
07723         ULONG ChildAceFlags;
07724 
07725         <span class="keywordflow">if</span> ( !IsV4AceType(ChildAce) || IsCompoundAceType(ChildAce)) {
07726              *NewGenericControl |= SEP_ACL_PROTECTED;
07727 <span class="preprocessor">#if DBG</span>
07728 <span class="preprocessor"></span>             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07729                  KdPrint((<span class="stringliteral">"Inherited Ace type (%ld) not known\n"</span>, ChildAce-&gt;Header.AceType ));
07730              }
07731 <span class="preprocessor">#endif // DBG</span>
07732 <span class="preprocessor"></span>             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
07733              <span class="keywordflow">goto</span> Cleanup;
07734         }
07735 
07736         <span class="comment">//</span>
07737         <span class="comment">// Compute the generic mapped mask for use in all comparisons.  The</span>
07738         <span class="comment">//  generic mapping will be undone if needed later.</span>
07739         <span class="comment">//</span>
07740         <span class="comment">// All V4 aces have an access mask in the same location.</span>
07741         <span class="comment">//</span>
07742         LocalMask = ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)(ChildAce))-&gt;Mask;
07743         RtlApplyGenericMask( ChildAce, &amp;LocalMask, GenericMapping);
07744 
07745 
07746         <span class="comment">//</span>
07747         <span class="comment">// Break the ACE into its component parts.</span>
07748         <span class="comment">//</span>
07749         ChildAceFlags = <a class="code" href="../../d8/d6/sertl_8c.html#a6">AceFlagsInAce</a>( ChildAce );
07750         <span class="keywordflow">if</span> ( ChildAceFlags &amp; CONTAINER_INHERIT_ACE ) {
07751             ChildAceInfo[ChildAceIndex].OriginalContainerInheritMask = LocalMask;
07752             ChildAceInfo[ChildAceIndex].ContainerInheritMask = LocalMask;
07753         } <span class="keywordflow">else</span> {
07754             ChildAceInfo[ChildAceIndex].OriginalContainerInheritMask = 0;
07755             ChildAceInfo[ChildAceIndex].ContainerInheritMask = 0;
07756         }
07757 
07758         <span class="keywordflow">if</span> ( ChildAceFlags &amp; OBJECT_INHERIT_ACE ) {
07759             ChildAceInfo[ChildAceIndex].OriginalObjectInheritMask = LocalMask;
07760             ChildAceInfo[ChildAceIndex].ObjectInheritMask = LocalMask;
07761         } <span class="keywordflow">else</span> {
07762             ChildAceInfo[ChildAceIndex].OriginalObjectInheritMask = 0;
07763             ChildAceInfo[ChildAceIndex].ObjectInheritMask = 0;
07764         }
07765 
07766         <span class="keywordflow">if</span> ( ChildAceFlags &amp; <a class="code" href="../../d8/d6/sertl_8c.html#a5">EFFECTIVE_ACE</a> ) {
07767             ChildAceInfo[ChildAceIndex].OriginalEffectiveMask = LocalMask;
07768             ChildAceInfo[ChildAceIndex].EffectiveMask = LocalMask;
07769         } <span class="keywordflow">else</span> {
07770             ChildAceInfo[ChildAceIndex].OriginalEffectiveMask = 0;
07771             ChildAceInfo[ChildAceIndex].EffectiveMask = 0;
07772         }
07773 
07774     }
07775 
07776 
07777     <span class="comment">//</span>
07778     <span class="comment">// Walk through the computed inherited ACL one ACE at a time.</span>
07779     <span class="comment">//</span>
07780 
07781     <span class="keywordflow">for</span> (InheritedAceIndex = 0, InheritedAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(InheritedAcl);
07782          InheritedAceIndex &lt; InheritedAcl-&gt;AceCount;
07783          InheritedAceIndex += 1, InheritedAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(InheritedAce)) {
07784 
07785         ACCESS_MASK LocalMask;
07786 
07787         <span class="comment">//</span>
07788         <span class="comment">// If the ACE isn't a valid version 4 ACE,</span>
07789         <span class="comment">//  this isn't an ACL we're interested in handling.</span>
07790         <span class="comment">//</span>
07791 
07792         <span class="keywordflow">if</span> ( !IsV4AceType(InheritedAce) || IsCompoundAceType(InheritedAce)) {
07793              *NewGenericControl |= SEP_ACL_PROTECTED;
07794 <span class="preprocessor">#if DBG</span>
07795 <span class="preprocessor"></span>             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07796                  KdPrint((<span class="stringliteral">"Inherited Ace type (%ld) not known\n"</span>, InheritedAce-&gt;Header.AceType ));
07797              }
07798 <span class="preprocessor">#endif // DBG</span>
07799 <span class="preprocessor"></span>             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
07800              <span class="keywordflow">goto</span> Cleanup;
07801         }
07802 
07803         <span class="comment">//</span>
07804         <span class="comment">// Compute the generic mapped mask for use in all comparisons.  The</span>
07805         <span class="comment">//  generic mapping will be undone if needed later.</span>
07806         <span class="comment">//</span>
07807         <span class="comment">// All V4 aces have an access mask in the same location.</span>
07808         <span class="comment">//</span>
07809         LocalMask = ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)(InheritedAce))-&gt;Mask;
07810         RtlApplyGenericMask( InheritedAce, &amp;LocalMask, GenericMapping);
07811 
07812         <span class="keywordflow">if</span> ( LocalMask == 0 ) {
07813 <span class="preprocessor">#if DBG</span>
07814 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07815                 KdPrint((<span class="stringliteral">"Worthless INH ACE: %ld 0x%8.8lx\n"</span>, InheritedAceIndex, LocalMask ));
07816             }
07817 <span class="preprocessor">#endif // DBG</span>
07818 <span class="preprocessor"></span>            <span class="keywordflow">continue</span>;
07819         }
07820 
07821         <span class="comment">//</span>
07822         <span class="comment">// This ACE is some combination of an effective ACE, a container</span>
07823         <span class="comment">//  inherit ACE and an object inherit ACE.  Process each of those</span>
07824         <span class="comment">//  attributes separately since they might be represented separately</span>
07825         <span class="comment">//  in the ChildAcl.</span>
07826         <span class="comment">//</span>
07827 
07828         InheritedAceFlags = <a class="code" href="../../d8/d6/sertl_8c.html#a6">AceFlagsInAce</a>( InheritedAce );
07829 
07830         <span class="keywordflow">if</span>  ( InheritedAceFlags == 0 ) {
07831 <span class="preprocessor">#if DBG</span>
07832 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07833                 KdPrint((<span class="stringliteral">"Worthless INH ACE: %ld 0x%lx\n"</span>, InheritedAceIndex, InheritedAceFlags ));
07834             }
07835 <span class="preprocessor">#endif // DBG</span>
07836 <span class="preprocessor"></span>            <span class="keywordflow">continue</span>;
07837         }
07838 
07839         <span class="keywordflow">if</span> ( InheritedAceFlags &amp; CONTAINER_INHERIT_ACE ) {
07840             OriginalInheritedContainerInheritMask = InheritedContainerInheritMask = LocalMask;
07841         } <span class="keywordflow">else</span> {
07842             OriginalInheritedContainerInheritMask = InheritedContainerInheritMask = 0;
07843         }
07844 
07845         <span class="keywordflow">if</span> ( InheritedAceFlags &amp; OBJECT_INHERIT_ACE ) {
07846             OriginalInheritedObjectInheritMask = InheritedObjectInheritMask = LocalMask;
07847         } <span class="keywordflow">else</span> {
07848             OriginalInheritedObjectInheritMask = InheritedObjectInheritMask = 0;
07849         }
07850 
07851         <span class="keywordflow">if</span> ( InheritedAceFlags &amp; <a class="code" href="../../d8/d6/sertl_8c.html#a5">EFFECTIVE_ACE</a> ) {
07852             OriginalInheritedEffectiveMask = InheritedEffectiveMask = LocalMask;
07853         } <span class="keywordflow">else</span> {
07854             OriginalInheritedEffectiveMask = InheritedEffectiveMask = 0;
07855         }
07856 
07857 <span class="preprocessor">#if DBG</span>
07858 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07859             KdPrint((<span class="stringliteral">"Doing INH ACE:  %ld %8.8lX %8.8lX %8.8lX\n"</span>, InheritedAceIndex, InheritedEffectiveMask, InheritedContainerInheritMask, InheritedObjectInheritMask ));
07860         }
07861 <span class="preprocessor">#endif // DBG</span>
07862 <span class="preprocessor"></span>
07863 
07864         <span class="comment">//</span>
07865         <span class="comment">// Loop through the entire child ACL comparing each inherited ACE with</span>
07866         <span class="comment">//  each child ACE.  Don't stop simply because we've matched once.</span>
07867         <span class="comment">//  Multiple ACEs in the one ACL may have been condensed into a single ACE</span>
07868         <span class="comment">//  in the other ACL in any combination (by any of our friendly ACL editors).</span>
07869         <span class="comment">//  In all cases, it is better to compute a resultant auto inherited ACL</span>
07870         <span class="comment">//  than it is to compute a protected ACL.</span>
07871         <span class="comment">//</span>
07872 
07873         <span class="keywordflow">for</span> (ChildAceIndex = 0, ChildAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(ChildAcl);
07874              ChildAceIndex &lt; ChildAcl-&gt;AceCount;
07875              ChildAceIndex += 1, ChildAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(ChildAce)) {
07876 
07877 
07878             <span class="comment">//</span>
07879             <span class="comment">// Ensure the ACE represents the same principal and object,</span>
07880             <span class="comment">//</span>
07881 
07882 <span class="preprocessor">#if DBG</span>
07883 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07884                 KdPrint((<span class="stringliteral">"Compare Child Ace: %ld "</span>, ChildAceIndex ));
07885             }
07886 <span class="preprocessor">#endif // DBG</span>
07887 <span class="preprocessor"></span>
07888             <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a23">RtlpCompareAces</a>( InheritedAce,
07889                                    ChildAce,
07890                                    OwnerSid,
07891                                    GroupSid ) ) {
07892 <span class="preprocessor">#if DBG</span>
07893 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07894                     KdPrint((<span class="stringliteral">"\n"</span> ));
07895                 }
07896 <span class="preprocessor">#endif // DBG</span>
07897 <span class="preprocessor"></span>                <span class="keywordflow">continue</span>;
07898             }
07899 <span class="preprocessor">#if DBG</span>
07900 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07901                 KdPrint((<span class="stringliteral">"\n"</span> ));
07902             }
07903 <span class="preprocessor">#endif // DBG</span>
07904 <span class="preprocessor"></span>
07905 
07906             <span class="comment">//</span>
07907             <span class="comment">// Match as many access bits in the INH ACE as possible.</span>
07908             <span class="comment">//</span>
07909             <span class="comment">// Don't pay any attention to whether the bits have been previously matched</span>
07910             <span class="comment">// in the CHILD ACE.  To do so, would imply that there is a one-to-one</span>
07911             <span class="comment">// correspondance between bits in the INH ACL and Child ACL.  Unfortunately,</span>
07912             <span class="comment">// ACL editors feel free to compress out duplicate bits in both</span>
07913             <span class="comment">// the CHILD ACL and PARENT ACL as they see fit.</span>
07914             <span class="comment">//</span>
07915 
07916             InheritedEffectiveMask &amp;= ~ChildAceInfo[ChildAceIndex].OriginalEffectiveMask;
07917             InheritedContainerInheritMask &amp;= ~ChildAceInfo[ChildAceIndex].OriginalContainerInheritMask;
07918             InheritedObjectInheritMask &amp;= ~ChildAceInfo[ChildAceIndex].OriginalObjectInheritMask;
07919 
07920 <span class="preprocessor">#if DBG</span>
07921 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07922                 KdPrint((<span class="stringliteral">"New   INH MASKs %ld %8.8lX %8.8lX %8.8lX\n"</span>, InheritedAceIndex, InheritedEffectiveMask, InheritedContainerInheritMask, InheritedObjectInheritMask ));
07923             }
07924 <span class="preprocessor">#endif // DBG</span>
07925 <span class="preprocessor"></span>
07926 
07927             <span class="comment">//</span>
07928             <span class="comment">// Match as many access bits in the child ACE as possible.</span>
07929             <span class="comment">//</span>
07930             <span class="comment">// Same reasoning as above.</span>
07931             <span class="comment">//</span>
07932 
07933             ChildAceInfo[ChildAceIndex].EffectiveMask &amp;= ~OriginalInheritedEffectiveMask;
07934             ChildAceInfo[ChildAceIndex].ContainerInheritMask &amp;= ~OriginalInheritedContainerInheritMask;
07935             ChildAceInfo[ChildAceIndex].ObjectInheritMask &amp;= ~OriginalInheritedObjectInheritMask;
07936 
07937 <span class="preprocessor">#if DBG</span>
07938 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07939                 KdPrint((<span class="stringliteral">"New Child MASKs %ld %8.8lX %8.8lX %8.8lX\n"</span>, ChildAceIndex, ChildAceInfo[ChildAceIndex].EffectiveMask, ChildAceInfo[ChildAceIndex].ContainerInheritMask, ChildAceInfo[ChildAceIndex].ObjectInheritMask ));
07940             }
07941 <span class="preprocessor">#endif // DBG</span>
07942 <span class="preprocessor"></span>
07943         }
07944 
07945 
07946         <span class="comment">//</span>
07947         <span class="comment">// If we couldn't process this inherited ACE,</span>
07948         <span class="comment">//  then the child ACL wasn't inherited.</span>
07949         <span class="comment">//</span>
07950 
07951         <span class="keywordflow">if</span> ( (InheritedEffectiveMask | InheritedContainerInheritMask | InheritedObjectInheritMask) != 0 ) {
07952             *NewGenericControl |= SEP_ACL_PROTECTED;
07953 <span class="preprocessor">#if DBG</span>
07954 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
07955                 KdPrint((<span class="stringliteral">"INH ACE not completely matched: %ld %8.8lX %8.8lX %8.8lX\n"</span>, InheritedAceIndex, InheritedEffectiveMask, InheritedContainerInheritMask, InheritedObjectInheritMask ));
07956             }
07957 <span class="preprocessor">#endif // DBG</span>
07958 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
07959             <span class="keywordflow">goto</span> Cleanup;
07960         }
07961 
07962 
07963     }
07964 
07965     <span class="comment">//</span>
07966     <span class="comment">// ASSERT: All of the inherited ACEs have been processed.</span>
07967     <span class="comment">//</span>
07968 
07969     <span class="comment">//</span>
07970     <span class="comment">// Loop through the Child ACL ensuring we can build a valid auto inherited ACL</span>
07971     <span class="comment">//</span>
07972 
07973     InheritedAllowFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07974     InheritedDenyFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07975     NonInheritedAclSize = 0;
07976     <span class="keywordflow">for</span> (ChildAceIndex = 0, ChildAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(ChildAcl);
07977          ChildAceIndex &lt; ChildAcl-&gt;AceCount;
07978          ChildAceIndex += 1, ChildAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(ChildAce)) {
07979 
07980         ACCESS_MASK ResultantMask;
07981 
07982         <span class="comment">//</span>
07983         <span class="comment">// Any Child ACE access bits not eliminated above required than an</span>
07984         <span class="comment">//  explicit non-inherited ACE by built.  That ACE will have an</span>
07985         <span class="comment">//  access mask that is the combined access mask of the unmatched bit</span>
07986         <span class="comment">//  in the effective, container inherit, and object inherit categories.</span>
07987         <span class="comment">//  Even though, the combined mask may include access bits not absolutely</span>
07988         <span class="comment">//  required (since they were already inherited), this strategy prevents</span>
07989         <span class="comment">//  us from having to build multiple ACEs (one for each category) for this</span>
07990         <span class="comment">//  single ACE.</span>
07991         <span class="comment">//</span>
07992 
07993         ResultantMask =
07994             ChildAceInfo[ChildAceIndex].EffectiveMask |
07995             ChildAceInfo[ChildAceIndex].ContainerInheritMask |
07996             ChildAceInfo[ChildAceIndex].ObjectInheritMask;
07997 
07998 
07999         <span class="comment">//</span>
08000         <span class="comment">// Handle an inherited ACE</span>
08001         <span class="comment">//</span>
08002 
08003         <span class="keywordflow">if</span> ( ResultantMask == 0 ) {
08004 
08005             <span class="comment">//</span>
08006             <span class="comment">// Keep track of whether inherited "allow" and "deny" ACEs are found.</span>
08007             <span class="comment">//</span>
08008 
08009             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[ChildAce-&gt;Header.AceType] == ACCESS_ALLOWED_ACE_TYPE ) {
08010                 InheritedAllowFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08011             }
08012 
08013             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[ChildAce-&gt;Header.AceType] == ACCESS_DENIED_ACE_TYPE ) {
08014                 InheritedDenyFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08015             }
08016 
08017         <span class="comment">//</span>
08018         <span class="comment">// Handle a non-inherited ACE</span>
08019         <span class="comment">//</span>
08020 
08021         } <span class="keywordflow">else</span> {
08022 
08023             <span class="comment">//</span>
08024             <span class="comment">// Keep a running tab of the size of the non-inherited ACEs.</span>
08025             <span class="comment">//</span>
08026 
08027             NonInheritedAclSize += ChildAce-&gt;Header.AceSize;
08028 
08029             <span class="comment">//</span>
08030             <span class="comment">// Since non-inherited ACEs will be moved to the front of the ACL,</span>
08031             <span class="comment">//  we have to be careful that we don't move a deny ACE in front of a</span>
08032             <span class="comment">//  previously found inherited allow ACE (and vice-versa).  To do so would</span>
08033             <span class="comment">//  change the semantics of the ACL.</span>
08034             <span class="comment">//</span>
08035 
08036             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[ChildAce-&gt;Header.AceType] == ACCESS_ALLOWED_ACE_TYPE &amp;&amp; InheritedDenyFound ) {
08037                 *NewGenericControl |= SEP_ACL_PROTECTED;
08038 <span class="preprocessor">#if DBG</span>
08039 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08040                     KdPrint((<span class="stringliteral">"Previous deny found Child ACE: %ld\n"</span>, ChildAceIndex ));
08041                 }
08042 <span class="preprocessor">#endif // DBG</span>
08043 <span class="preprocessor"></span>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
08044                 <span class="keywordflow">goto</span> Cleanup;
08045             }
08046 
08047             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[ChildAce-&gt;Header.AceType] == ACCESS_DENIED_ACE_TYPE &amp;&amp; InheritedAllowFound ) {
08048                 *NewGenericControl |= SEP_ACL_PROTECTED;
08049 <span class="preprocessor">#if DBG</span>
08050 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08051                     KdPrint((<span class="stringliteral">"Previous allow found Child ACE: %ld\n"</span>, ChildAceIndex ));
08052                 }
08053 <span class="preprocessor">#endif // DBG</span>
08054 <span class="preprocessor"></span>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
08055                 <span class="keywordflow">goto</span> Cleanup;
08056             }
08057 
08058         }
08059 
08060     }
08061 
08062     <span class="comment">//</span>
08063     <span class="comment">// The resultant ACL is composed of the non-inherited ACEs followed by</span>
08064     <span class="comment">// the inherited ACE. The inherited ACEs are built by running the</span>
08065     <span class="comment">// inheritance algorithm over the Parent ACL.</span>
08066     <span class="comment">//</span>
08067     <span class="comment">// The Inherited ACL computed below is almost identical to InhertedAcl.</span>
08068     <span class="comment">// However, InheritedAcl didn't properly substitute the correct owner and</span>
08069     <span class="comment">// group SID.</span>
08070     <span class="comment">//</span>
08071 
08072     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a74">RtlpInheritAcl</a> (
08073                 ParentAcl,
08074                 NULL,   <span class="comment">// No explicit child ACL</span>
08075                 0,      <span class="comment">// No Child Generic Control</span>
08076                 IsDirectoryObject,
08077                 TRUE,   <span class="comment">// AutoInherit the DACL</span>
08078                 FALSE,  <span class="comment">// Not default descriptor for object</span>
08079                 OwnerSid,   <span class="comment">// Subsitute a constant SID</span>
08080                 GroupSid,   <span class="comment">// Subsitute a constant SID</span>
08081                 OwnerSid,   <span class="comment">// Server Owner (Technically incorrect, but OK since we don't support compound ACEs)</span>
08082                 GroupSid,   <span class="comment">// Server Group</span>
08083                 GenericMapping,
08084                 TRUE,   <span class="comment">// Is a SACL</span>
08085                 ObjectType,
08086                 &amp;RealInheritedAcl,
08087                 &amp;AclExplicitlyAssigned,
08088                 &amp;GenericControl );
08089 
08090     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
08091 <span class="preprocessor">#if DBG</span>
08092 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08093             KdPrint((<span class="stringliteral">"Can't build real inherited ACL %lX\n"</span>, Status ));
08094         }
08095 <span class="preprocessor">#endif // DBG</span>
08096 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> Cleanup;
08097     }
08098 
08099 
08100 
08101     <span class="comment">//</span>
08102     <span class="comment">// Allocate a buffer for the inherited ACL</span>
08103     <span class="comment">//</span>
08104 
08105 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
08106 <span class="preprocessor"></span>    *NewAcl = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
08107                         PagedPool,
08108                         RealInheritedAcl-&gt;AclSize + NonInheritedAclSize,
08109                         'cAeS' );
08110 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
08111 <span class="preprocessor"></span>    *NewAcl = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
08112                         HeapHandle,
08113                         <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(SE_TAG),
08114                         RealInheritedAcl-&gt;AclSize + NonInheritedAclSize );
08115 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
08116 <span class="preprocessor"></span>
08117     <span class="keywordflow">if</span> ( *NewAcl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
08118         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
08119         <span class="keywordflow">goto</span> Cleanup;
08120     }
08121 
08122     <span class="comment">//</span>
08123     <span class="comment">// All non-inherited ACEs are copied first.</span>
08124     <span class="comment">// The inherited ACES are grabbed from real inherited ACL.</span>
08125     <span class="comment">//</span>
08126     <span class="comment">// Build an ACL Header.</span>
08127     <span class="comment">//</span>
08128 
08129     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( *NewAcl,
08130                            RealInheritedAcl-&gt;AclSize + NonInheritedAclSize,
08131                            <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( RealInheritedAcl-&gt;AclRevision, ChildAcl-&gt;AclRevision ) );
08132 
08133     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
08134 <span class="preprocessor">#if DBG</span>
08135 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08136             KdPrint((<span class="stringliteral">"Can't create final ACL %lX\n"</span>, Status ));
08137         }
08138 <span class="preprocessor">#endif // DBG</span>
08139 <span class="preprocessor"></span>        <span class="comment">//</span>
08140         <span class="comment">// The only reason for failure would be if the combined ACL is too large.</span>
08141         <span class="comment">// So just create a protected ACL (better than a failure).</span>
08142         <span class="comment">//</span>
08143         *NewGenericControl |= SEP_ACL_PROTECTED;
08144         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
08145         <span class="keywordflow">goto</span> Cleanup;
08146     }
08147 
08148     <span class="comment">//</span>
08149     <span class="comment">// Copy the non-inherited ACES.</span>
08150     <span class="comment">//</span>
08151 
08152     Where = ((PUCHAR)(*NewAcl)) + <span class="keyword">sizeof</span>(ACL);
08153     <span class="keywordflow">for</span> (ChildAceIndex = 0, ChildAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(ChildAcl);
08154          ChildAceIndex &lt; ChildAcl-&gt;AceCount;
08155          ChildAceIndex += 1, ChildAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(ChildAce)) {
08156 
08157         ACCESS_MASK ResultantMask;
08158 
08159         <span class="comment">//</span>
08160         <span class="comment">// Copy the non-inherited ACE from the Child only if there's a non-zero access mask.</span>
08161         <span class="comment">//</span>
08162 
08163         ResultantMask =
08164             ChildAceInfo[ChildAceIndex].EffectiveMask |
08165             ChildAceInfo[ChildAceIndex].ContainerInheritMask |
08166             ChildAceInfo[ChildAceIndex].ObjectInheritMask;
08167 
08168         <span class="keywordflow">if</span> ( ResultantMask != 0 ) {
08169             <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> NewAce;
08170             ULONG GenericBitToTry;
08171 
08172             <span class="comment">//</span>
08173             <span class="comment">// Use the original ChildAce as the template.</span>
08174             <span class="comment">//</span>
08175 
08176             RtlCopyMemory( Where, ChildAce, ChildAce-&gt;Header.AceSize );
08177             NewAce = (<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)Where;
08178             NewAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o0">Header</a>.AceFlags &amp;= ~INHERITED_ACE;  <span class="comment">// Clear stray bits</span>
08179             Where += ChildAce-&gt;Header.AceSize;
08180 
08181             (*NewAcl)-&gt;AceCount ++;
08182 
08183             <span class="comment">//</span>
08184             <span class="comment">// The AccessMask on the ACE are those access bits that didn't get matched</span>
08185             <span class="comment">//  by inherited ACEs.</span>
08186             <span class="comment">//</span>
08187 
08188             NewAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">Mask</a> = ChildAce-&gt;Mask &amp; ResultantMask;
08189             ResultantMask &amp;= ~ChildAce-&gt;Mask;
08190 <span class="preprocessor">#if DBG</span>
08191 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08192                 KdPrint((<span class="stringliteral">"Original non-inherited: %ld %8.8lX %8.8lX\n"</span>, ChildAceIndex, NewAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">Mask</a>, ResultantMask ));
08193             }
08194 <span class="preprocessor">#endif // DBG</span>
08195 <span class="preprocessor"></span>
08196             <span class="comment">//</span>
08197             <span class="comment">// Map any remaining bits back to generic access bits.</span>
08198             <span class="comment">// Doing so might expand the ResultantMask to beyond what was computed above.</span>
08199             <span class="comment">// Doing so will never expand the computed ACE to beyond what the original</span>
08200             <span class="comment">//  ChildAce granted.</span>
08201             <span class="comment">//</span>
08202 
08203             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( GENERIC_WRITE == (GENERIC_READ &gt;&gt; 1));
08204             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( GENERIC_EXECUTE == (GENERIC_WRITE &gt;&gt; 1));
08205             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( GENERIC_ALL == (GENERIC_EXECUTE &gt;&gt; 1));
08206 
08207             GenericBitToTry = GENERIC_READ;
08208 
08209             <span class="keywordflow">while</span> ( ResultantMask &amp;&amp; GenericBitToTry &gt;= GENERIC_ALL ) {
08210 
08211                 <span class="comment">//</span>
08212                 <span class="comment">// Only map generic bits that are in the ChildAce.</span>
08213                 <span class="comment">//</span>
08214 
08215                 <span class="keywordflow">if</span> ( GenericBitToTry &amp; ChildAce-&gt;Mask ) {
08216                     ACCESS_MASK GenericMask;
08217 
08218                     <span class="comment">//</span>
08219                     <span class="comment">// Compute the real access mask corresponding to the Generic bit.</span>
08220                     <span class="comment">//</span>
08221 
08222                     GenericMask = GenericBitToTry;
08223                     <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( &amp;GenericMask, GenericMapping );
08224 
08225                     <span class="comment">//</span>
08226                     <span class="comment">// If the current generic bit matches any of the bits remaining,</span>
08227                     <span class="comment">//  set the generic bit in the current ACE.</span>
08228                     <span class="comment">//</span>
08229 
08230                     <span class="keywordflow">if</span> ( (ResultantMask &amp; GenericMask) != 0 ) {
08231                         NewAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">Mask</a> |= GenericBitToTry;
08232                         ResultantMask &amp;= ~GenericMask;
08233                     }
08234 <span class="preprocessor">#if DBG</span>
08235 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08236                         KdPrint((<span class="stringliteral">"Generic  non-inherited: %ld %8.8lX %8.8lX\n"</span>, ChildAceIndex, NewAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">Mask</a>, ResultantMask ));
08237                     }
08238 <span class="preprocessor">#endif // DBG</span>
08239 <span class="preprocessor"></span>                }
08240 
08241                 <span class="comment">//</span>
08242                 <span class="comment">// Try the next Generic bit.</span>
08243                 <span class="comment">//</span>
08244 
08245                 GenericBitToTry &gt;&gt;= 1;
08246             }
08247 
08248 
08249             <span class="comment">//</span>
08250             <span class="comment">// This is really an internal error, but press on regardless.</span>
08251             <span class="comment">//</span>
08252 
08253             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResultantMask == 0 );
08254             NewAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">Mask</a> |= ResultantMask;
08255 <span class="preprocessor">#if DBG</span>
08256 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08257                 KdPrint((<span class="stringliteral">"Final    non-inherited: %ld %8.8lX %8.8lX\n"</span>, ChildAceIndex, NewAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">Mask</a>, ResultantMask ));
08258             }
08259 <span class="preprocessor">#endif // DBG</span>
08260 <span class="preprocessor"></span>
08261         }
08262     }
08263 
08264     <span class="comment">//</span>
08265     <span class="comment">// Copy the inherited ACES.</span>
08266     <span class="comment">//  Simply copy computed Inherited ACL.</span>
08267     <span class="comment">//</span>
08268 
08269     RtlCopyMemory( Where,
08270                    <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(RealInheritedAcl),
08271                    RealInheritedAcl-&gt;AclSize - (ULONG)(((PUCHAR)<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(RealInheritedAcl)) - (PUCHAR)RealInheritedAcl));
08272     Where += RealInheritedAcl-&gt;AclSize - (ULONG)(((PUCHAR)<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(RealInheritedAcl)) - (PUCHAR)RealInheritedAcl);
08273 
08274     (*NewAcl)-&gt;AceCount += RealInheritedAcl-&gt;AceCount;
08275     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (*NewAcl)-&gt;AclSize == Where - (PUCHAR)(*NewAcl) );
08276 
08277 
08278     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
08279 Cleanup:
08280 
08281     <span class="comment">//</span>
08282     <span class="comment">// If successful,</span>
08283     <span class="comment">//  build the resultant autoinherited ACL.</span>
08284     <span class="comment">//</span>
08285 
08286     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
08287 
08288         <span class="comment">//</span>
08289         <span class="comment">// If the Child ACL is protected,</span>
08290         <span class="comment">//  just build it as a copy of the original ACL</span>
08291         <span class="comment">//</span>
08292 
08293         <span class="keywordflow">if</span> ( *NewGenericControl &amp; SEP_ACL_PROTECTED ) {
08294 
08295             <span class="comment">//</span>
08296             <span class="comment">// If we've already allocated a new ACL (and couldn't finish it for some reason),</span>
08297             <span class="comment">//  free it.</span>
08298 
08299             <span class="keywordflow">if</span> ( *NewAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08300 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
08301 <span class="preprocessor"></span>                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *NewAcl );
08302 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
08303 <span class="preprocessor"></span>                <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, *NewAcl );
08304 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
08305 <span class="preprocessor"></span>                *NewAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08306             }
08307 
08308             <span class="comment">//</span>
08309             <span class="comment">// Allocate a buffer for the protected ACL.</span>
08310             <span class="comment">//</span>
08311 
08312 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
08313 <span class="preprocessor"></span>            *NewAcl = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
08314                                 PagedPool,
08315                                 ChildAcl-&gt;AclSize,
08316                                 'cAeS' );
08317 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
08318 <span class="preprocessor"></span>            *NewAcl = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
08319                                 HeapHandle,
08320                                 <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(SE_TAG),
08321                                 ChildAcl-&gt;AclSize );
08322 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
08323 <span class="preprocessor"></span>
08324             <span class="keywordflow">if</span> ( *NewAcl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
08325                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
08326             } <span class="keywordflow">else</span> {
08327                 RtlCopyMemory( *NewAcl, ChildAcl, ChildAcl-&gt;AclSize );
08328             }
08329         }
08330 
08331     }
08332 
08333     <span class="keywordflow">if</span> ( ChildAceInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08334 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
08335 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ChildAceInfo );
08336 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
08337 <span class="preprocessor"></span>        <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, ChildAceInfo );
08338 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
08339 <span class="preprocessor"></span>    }
08340 
08341     <span class="keywordflow">if</span> ( InheritedAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08342 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
08343 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( InheritedAcl );
08344 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
08345 <span class="preprocessor"></span>        <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, InheritedAcl );
08346 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
08347 <span class="preprocessor"></span>    }
08348 
08349     <span class="keywordflow">if</span> ( RealInheritedAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08350 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
08351 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( RealInheritedAcl );
08352 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
08353 <span class="preprocessor"></span>        <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, RealInheritedAcl );
08354 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
08355 <span class="preprocessor"></span>    }
08356 
08357     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
08358 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="sertl.c::RtlpConvertToAutoInheritSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpConvertToAutoInheritSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR ParentDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l06520">6520</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02004">RtlCreateSecurityDescriptorRelative()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02066">RtlValidSecurityDescriptor()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">SE_TAG</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01786">RtlConvertToAutoInheritSecurityObject()</a>.
<p>
<pre class="fragment"><div>06530                    :
06531 
06532     This routine a converts a security descriptor whose ACLs are not marked
06533     as AutoInherit to a security descriptor whose ACLs are marked as
06534     AutoInherit.
06535 
06536     See comments <span class="keywordflow">for</span> <a class="code" href="../../d4/d8/seurtl_8c.html#a14">RtlConvertToAutoInheritSecurityObject</a>.
06537 
06538 Arguments:
06539 
06540     ParentDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Security Descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
06541         directory under which a object exists.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
06542         no parent directory, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
06543 
06544     CurrentSecurityDescriptor - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects security descriptor
06545         that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to be altered by <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>.
06546 
06547     NewSecurityDescriptor Points to a pointer that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06548         newly allocated <span class="keyword">self</span>-relative security descriptor. When no
06549         longer needed, <span class="keyword">this</span> descriptor must be freed <span class="keyword">using</span>
06550         DestroyPrivateObjectSecurity().
06551 
06552     ObjectType - GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being created.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being
06553         created has no GUID associated with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
06554         specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
06555 
06556     IsDirectoryObject - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
06557         directory object.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
06558         container of other objects.
06559 
06560     GenericMapping - Supplies a pointer to a generic mapping array denoting
06561         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping between each generic right to specific rights.
06562 
06563 Return Value:
06564 
06565     STATUS_SUCCESS - The operation was successful.
06566 
06567     See comments <span class="keywordflow">for</span> <a class="code" href="../../d4/d8/seurtl_8c.html#a14">RtlConvertToAutoInheritSecurityObject</a>.
06568 
06569 
06570 --*/
06571 {
06572     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06573     PISECURITY_DESCRIPTOR CurrentDescriptor;
06574     PACL CurrentSacl;
06575     PACL CurrentDacl;
06576 
06577     PSID NewOwner;
06578     PSID NewGroup;
06579 
06580     PACL NewSacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06581     ULONG NewSaclControl = 0;
06582     BOOLEAN NewSaclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06583 
06584     PACL NewDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06585     ULONG NewDaclControl = 0;
06586     BOOLEAN NewDaclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06587     PACL TemplateInheritedDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06588     ULONG GenericControl;
06589 
06590     ULONG AllocationSize;
06591     ULONG NewOwnerSize;
06592     ULONG NewGroupSize;
06593     ULONG NewSaclSize;
06594     ULONG NewDaclSize;
06595 
06596     PCHAR Field;
06597     PCHAR Base;
06598 
06599     PISECURITY_DESCRIPTOR_RELATIVE INewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06600     ULONG ReturnLength;
06601     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> PassedStatus;
06602     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
06603 
06604 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
06605 <span class="preprocessor"></span>    PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
06606 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06607 <span class="preprocessor"></span>
06608     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
06609 
06610     <span class="comment">//</span>
06611     <span class="comment">// Get the handle to the current process heap</span>
06612     <span class="comment">//</span>
06613 
06614 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
06615 <span class="preprocessor"></span>    <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
06616 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06617 <span class="preprocessor"></span>
06618 
06619 
06620     <span class="comment">//</span>
06621     <span class="comment">//</span>
06622 
06623     CurrentDescriptor = CurrentSecurityDescriptor;
06624 
06625     <span class="comment">//</span>
06626     <span class="comment">// Validate the incoming security descriptor.</span>
06627     <span class="comment">//</span>
06628 
06629     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a> ( CurrentDescriptor )) {
06630         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
06631         <span class="keywordflow">goto</span> Cleanup;
06632     }
06633 
06634 
06635     NewOwner = RtlpOwnerAddrSecurityDescriptor( CurrentDescriptor );
06636     <span class="keywordflow">if</span> ( NewOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06637         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
06638         <span class="keywordflow">goto</span> Cleanup;
06639     }
06640 
06641     NewGroup = RtlpGroupAddrSecurityDescriptor( CurrentDescriptor );
06642 
06643 
06644 
06645 
06646     <span class="comment">//</span>
06647     <span class="comment">// Handle the SACL.</span>
06648     <span class="comment">//</span>
06649     <span class="comment">//</span>
06650     <span class="comment">// If the SACL isn't present,</span>
06651     <span class="comment">//  special case it.</span>
06652     <span class="comment">//</span>
06653 
06654     CurrentSacl = RtlpSaclAddrSecurityDescriptor( CurrentDescriptor );
06655 
06656     <span class="keywordflow">if</span> ( CurrentSacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06657         PACL ParentSacl;
06658 
06659         <span class="comment">// Preserve the Acl Present bit and protected bit from the existing descriptor.</span>
06660         NewSaclControl |= CurrentDescriptor-&gt;Control &amp; (SE_SACL_PROTECTED|SE_SACL_PRESENT);
06661 
06662         <span class="comment">// Always set the autoinherited bit.</span>
06663         NewSaclControl |= SE_SACL_AUTO_INHERITED;
06664 
06665 
06666         <span class="comment">//</span>
06667         <span class="comment">// If the Parent also has a NULL SACL,</span>
06668         <span class="comment">//  just consider this SACL as inherited.</span>
06669         <span class="comment">//  otherwise, this SACL is protected.</span>
06670         <span class="comment">//</span>
06671 
06672         ParentSacl = ARGUMENT_PRESENT(ParentDescriptor) ?
06673                         RtlpSaclAddrSecurityDescriptor( ((SECURITY_DESCRIPTOR *)ParentDescriptor)) :
06674                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06675         <span class="keywordflow">if</span> ( ParentSacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06676             NewSaclControl |= SE_SACL_PROTECTED;
06677         }
06678 
06679 
06680     <span class="comment">//</span>
06681     <span class="comment">// If the SACL is already converted,</span>
06682     <span class="comment">//  or if this object is at the root of the tree,</span>
06683     <span class="comment">//  simply leave it alone.</span>
06684     <span class="comment">//</span>
06685     <span class="comment">// Don't force the Protect bit on at the root of the tree since it is semantically</span>
06686     <span class="comment">//  a no-op and gets in the way if the object is ever moved.</span>
06687     <span class="comment">//</span>
06688 
06689     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( RtlpAreControlBitsSet( CurrentDescriptor, SE_SACL_AUTO_INHERITED) ||
06690                 RtlpAreControlBitsSet( CurrentDescriptor, SE_SACL_PROTECTED ) ||
06691                 !ARGUMENT_PRESENT(ParentDescriptor) ) {
06692 
06693         <span class="comment">// Preserve the Acl Present bit and protected bit from the existing descriptor.</span>
06694         NewSaclControl |= CurrentDescriptor-&gt;Control &amp; (SE_SACL_PROTECTED|SE_SACL_PRESENT);
06695 
06696         <span class="comment">// Always set the autoinherited bit.</span>
06697         NewSaclControl |= SE_SACL_AUTO_INHERITED;
06698 
06699         NewSacl = CurrentSacl;
06700 
06701 
06702     <span class="comment">//</span>
06703     <span class="comment">// If the SACL is present,</span>
06704     <span class="comment">//  compute a new SACL with appropriate ACEs marked as inherited.</span>
06705     <span class="comment">//</span>
06706 
06707     } <span class="keywordflow">else</span> {
06708 
06709 
06710         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a15">RtlpConvertAclToAutoInherit</a> (
06711                     ARGUMENT_PRESENT(ParentDescriptor) ?
06712                         RtlpSaclAddrSecurityDescriptor(
06713                             ((SECURITY_DESCRIPTOR *)ParentDescriptor)) :
06714                         NULL,
06715                     RtlpSaclAddrSecurityDescriptor(CurrentDescriptor),
06716                     ObjectType,
06717                     IsDirectoryObject,
06718                     RtlpOwnerAddrSecurityDescriptor(CurrentDescriptor),
06719                     RtlpGroupAddrSecurityDescriptor(CurrentDescriptor),
06720                     GenericMapping,
06721                     &amp;NewSacl,
06722                     &amp;GenericControl );
06723 
06724         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
06725             <span class="keywordflow">goto</span> Cleanup;
06726         }
06727 
06728         NewSaclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06729         NewSaclControl |= SE_SACL_PRESENT | SeControlGenericToSacl( GenericControl );
06730     }
06731 
06732 
06733     <span class="comment">//</span>
06734     <span class="comment">// Handle the DACL.</span>
06735     <span class="comment">//</span>
06736     <span class="comment">//</span>
06737     <span class="comment">// If the DACL isn't present,</span>
06738     <span class="comment">//  special case it.</span>
06739     <span class="comment">//</span>
06740 
06741     CurrentDacl = RtlpDaclAddrSecurityDescriptor( CurrentDescriptor );
06742 
06743     <span class="keywordflow">if</span> ( CurrentDacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06744         <span class="comment">// Preserve the Dacl Present bit from the existing descriptor.</span>
06745         NewDaclControl |= CurrentDescriptor-&gt;Control &amp; SE_DACL_PRESENT;
06746 
06747         <span class="comment">// Always set the autoinherited bit.</span>
06748         <span class="comment">// Force it protected.</span>
06749         NewDaclControl |= SE_DACL_AUTO_INHERITED | SE_DACL_PROTECTED;
06750 
06751 
06752 
06753     <span class="comment">//</span>
06754     <span class="comment">// If the DACL is already converted,</span>
06755     <span class="comment">//  or if this object is at the root of the tree,</span>
06756     <span class="comment">//  simply leave it alone.</span>
06757     <span class="comment">//</span>
06758     <span class="comment">// Don't force the Protect bit on at the root of the tree since it is semantically</span>
06759     <span class="comment">//  a no-op and gets in the way if the object is ever moved.</span>
06760     <span class="comment">//</span>
06761 
06762     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( RtlpAreControlBitsSet( CurrentDescriptor, SE_DACL_AUTO_INHERITED) ||
06763                 RtlpAreControlBitsSet( CurrentDescriptor, SE_DACL_PROTECTED ) ||
06764                 !ARGUMENT_PRESENT(ParentDescriptor) ) {
06765 
06766         <span class="comment">// Preserve the Acl Present bit and protected bit from the existing descriptor.</span>
06767         NewDaclControl |= CurrentDescriptor-&gt;Control &amp; (SE_DACL_PROTECTED|SE_DACL_PRESENT);
06768 
06769         <span class="comment">// Always set the autoinherited bit.</span>
06770         NewDaclControl |= SE_DACL_AUTO_INHERITED;
06771 
06772         NewDacl = CurrentDacl;
06773 
06774 
06775 
06776     <span class="comment">//</span>
06777     <span class="comment">// If the DACL is present,</span>
06778     <span class="comment">//  compute a new DACL with appropriate ACEs marked as inherited.</span>
06779     <span class="comment">//</span>
06780 
06781     } <span class="keywordflow">else</span> {
06782 
06783 
06784         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a15">RtlpConvertAclToAutoInherit</a> (
06785                     ARGUMENT_PRESENT(ParentDescriptor) ?
06786                         RtlpDaclAddrSecurityDescriptor(
06787                             ((SECURITY_DESCRIPTOR *)ParentDescriptor)) :
06788                         NULL,
06789                     RtlpDaclAddrSecurityDescriptor(CurrentDescriptor),
06790                     ObjectType,
06791                     IsDirectoryObject,
06792                     RtlpOwnerAddrSecurityDescriptor(CurrentDescriptor),
06793                     RtlpGroupAddrSecurityDescriptor(CurrentDescriptor),
06794                     GenericMapping,
06795                     &amp;NewDacl,
06796                     &amp;GenericControl );
06797 
06798         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
06799             <span class="keywordflow">goto</span> Cleanup;
06800         }
06801 
06802         NewDaclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06803         NewDaclControl |= SE_DACL_PRESENT | SeControlGenericToDacl( GenericControl );
06804     }
06805 
06806 
06807 
06808     <span class="comment">//</span>
06809     <span class="comment">// Build the resultant security descriptor</span>
06810     <span class="comment">//</span>
06811     <span class="comment">// Also map the ACEs for application to the target object</span>
06812     <span class="comment">// type, if they haven't already been mapped.</span>
06813     <span class="comment">//</span>
06814 
06815     NewOwnerSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewOwner));
06816 
06817     <span class="keywordflow">if</span> ( NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06818         NewGroupSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewGroup));
06819     } <span class="keywordflow">else</span> {
06820         NewGroupSize = 0;
06821     }
06822 
06823     <span class="keywordflow">if</span> (NewSacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06824         NewSaclSize = LongAlignSize(NewSacl-&gt;AclSize);
06825     } <span class="keywordflow">else</span> {
06826         NewSaclSize = 0;
06827     }
06828 
06829     <span class="keywordflow">if</span> (NewDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06830         NewDaclSize = LongAlignSize(NewDacl-&gt;AclSize);
06831     } <span class="keywordflow">else</span> {
06832         NewDaclSize = 0;
06833     }
06834 
06835     AllocationSize = LongAlignSize(<span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE)) +
06836                      NewOwnerSize +
06837                      NewGroupSize +
06838                      NewSaclSize  +
06839                      NewDaclSize;
06840 
06841     <span class="comment">//</span>
06842     <span class="comment">// Allocate and initialize the security descriptor as</span>
06843     <span class="comment">// self-relative form.</span>
06844     <span class="comment">//</span>
06845 
06846 
06847 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
06848 <span class="preprocessor"></span>    INewDescriptor = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
06849                         PagedPool,
06850                         AllocationSize,
06851                         'dSeS' );
06852 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
06853 <span class="preprocessor"></span>    INewDescriptor = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
06854                         HeapHandle,
06855                         <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(SE_TAG),
06856                         AllocationSize );
06857 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06858 <span class="preprocessor"></span>
06859     <span class="keywordflow">if</span> ( INewDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06860         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
06861         <span class="keywordflow">goto</span> Cleanup;
06862     }
06863 
06864 
06865     <span class="comment">//</span>
06866     <span class="comment">// Initialize the security descriptor as self-relative form.</span>
06867     <span class="comment">//</span>
06868 
06869     <a class="code" href="../../d8/d6/sertl_8c.html#a54">RtlCreateSecurityDescriptorRelative</a>(
06870         INewDescriptor,
06871         SECURITY_DESCRIPTOR_REVISION
06872         );
06873 
06874     RtlpSetControlBits( INewDescriptor, SE_SELF_RELATIVE );
06875 
06876     Base = (PCHAR)(INewDescriptor);
06877     Field =  Base + <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
06878 
06879     <span class="comment">//</span>
06880     <span class="comment">// Copy the Sacl</span>
06881     <span class="comment">//</span>
06882 
06883     RtlpSetControlBits( INewDescriptor, NewSaclControl );
06884     <span class="keywordflow">if</span> (NewSacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06885 
06886         RtlCopyMemory( Field, NewSacl, NewSacl-&gt;AclSize );
06887         INewDescriptor-&gt;Sacl = RtlPointerToOffset(Base,Field);
06888         Field += NewSaclSize;
06889 
06890     } <span class="keywordflow">else</span> {
06891 
06892         INewDescriptor-&gt;Sacl = 0;
06893     }
06894 
06895     <span class="comment">//</span>
06896     <span class="comment">// Copy the Dacl</span>
06897     <span class="comment">//</span>
06898 
06899     RtlpSetControlBits( INewDescriptor, NewDaclControl );
06900     <span class="keywordflow">if</span> (NewDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06901 
06902         RtlCopyMemory( Field, NewDacl, NewDacl-&gt;AclSize );
06903         INewDescriptor-&gt;Dacl = RtlPointerToOffset(Base,Field);
06904         Field += NewDaclSize;
06905 
06906     } <span class="keywordflow">else</span> {
06907 
06908         INewDescriptor-&gt;Dacl = 0;
06909     }
06910 
06911     <span class="comment">//</span>
06912     <span class="comment">// Assign the owner</span>
06913     <span class="comment">//</span>
06914 
06915     RtlCopyMemory( Field, NewOwner, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewOwner) );
06916     INewDescriptor-&gt;Owner = RtlPointerToOffset(Base,Field);
06917     Field += NewOwnerSize;
06918 
06919     <span class="keywordflow">if</span> ( NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
06920         RtlCopyMemory( Field, NewGroup, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewGroup) );
06921         INewDescriptor-&gt;Group = RtlPointerToOffset(Base,Field);
06922     }
06923 
06924     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06925 
06926 
06927 
06928     <span class="comment">//</span>
06929     <span class="comment">// Cleanup any locally used resources.</span>
06930     <span class="comment">//</span>
06931 Cleanup:
06932     <span class="keywordflow">if</span> (NewDaclAllocated) {
06933 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
06934 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewDacl );
06935 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
06936 <span class="preprocessor"></span>            <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, NewDacl );
06937 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06938 <span class="preprocessor"></span>    }
06939     <span class="keywordflow">if</span> (NewSaclAllocated) {
06940 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
06941 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewSacl );
06942 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
06943 <span class="preprocessor"></span>            <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, NewSacl );
06944 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
06945 <span class="preprocessor"></span>    }
06946 
06947     *NewSecurityDescriptor = (PSECURITY_DESCRIPTOR) INewDescriptor;
06948 
06949     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06950 
06951 
06952 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="sertl.c::RtlpCopyAces" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpCopyAces           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d6/sertl_8c.html#a80">ACE_TYPE_TO_COPY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AceTypeToCopy</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlagsToReset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MapSids</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientOwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientGroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerOwnerSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerGroupSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAclSizeParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAcl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l04371">4371</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d8/d6/sertl_8c.html#a80a12">CopyAllAces</a>, <a class="el" href="../../d8/d6/sertl_8c.html#a80a10">CopyInheritedAces</a>, <a class="el" href="../../d8/d6/sertl_8c.html#a80a11">CopyNonInheritedAces</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">RtlFirstFreeAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03880">RtlpCopyEffectiveAce()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l05893">RtlpComputeMergedAcl2()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l04716">RtlpInheritAcl2()</a>.
<p>
<pre class="fragment"><div>04387                    :
04388 
04389     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> ACEs from of an ACL and perform generic mapping.  Only ACEs specified
04390     by 'AceFilter' are copied.
04391 
04392 Arguments:
04393 
04394     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL to copy from.
04395 
04396     GenericMapping - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping to use.
04397 
04398     AceTypeToCopy - Describes which aces to copy.
04399 
04400     AceFlagsToReset - Bit mask of ACE flags to reset (<span class="keywordflow">if</span> set) on each ACE.
04401 
04402     MapSids - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be mapped to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
04403         actual SID.
04404 
04405     ClientOwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use
04406 
04407     ClientGroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> Sid to use
04408 
04409     ServerOwnerSid - Optionally specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> Sid to use in compound ACEs.
04410 
04411     ServerGroupSid - Optionally specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> group Sid to use in compound ACEs.
04412 
04413     NewAclSizeParam - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cumulatiave length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> copies ACEs
04414 
04415     NewAcl - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL to copy to.
04416         This ACL must already be initialized.
04417 
04418 
04419 Return Value:
04420 
04421     STATUS_SUCCESS - An inheritable ACL has been generated.
04422 
04423     STATUS_BUFFER_TOO_SMALL - The ACL specified by NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too small <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04424         copied ACEs.  The required size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in NewAceLength.
04425 
04426 
04427 --*/
04428 
04429 {
04430 
04431     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04432     ULONG i;
04433 
04434     PACE_HEADER OldAce;
04435     ULONG NewAclSize, NewAceSize;
04436     BOOLEAN AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04437     BOOLEAN CopyAce;
04438     PVOID AcePosition;
04439 
04440 
04441     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
04442 
04443     <span class="comment">//</span>
04444     <span class="comment">// Validate the ACL.</span>
04445     <span class="comment">//</span>
04446 
04447     <span class="keywordflow">if</span> ( !ValidAclRevision(NewAcl) ) {
04448         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
04449     }
04450 
04451     <span class="comment">//</span>
04452     <span class="comment">// Find where the first ACE goes.</span>
04453     <span class="comment">//</span>
04454 
04455     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( NewAcl, &amp;AcePosition )) {
04456         <span class="keywordflow">return</span> STATUS_BAD_INHERITANCE_ACL;
04457     }
04458 
04459     <span class="comment">//</span>
04460     <span class="comment">// Walk through the original ACL copying ACEs.</span>
04461     <span class="comment">//</span>
04462 
04463     NewAclSize = 0;
04464     <span class="keywordflow">for</span> (i = 0, OldAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(Acl);
04465          i &lt; Acl-&gt;AceCount;
04466          i += 1, OldAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(OldAce)) {
04467 
04468         <span class="comment">//</span>
04469         <span class="comment">// If the ACE wasn't inherited,</span>
04470         <span class="comment">//  copy it.</span>
04471         <span class="comment">//</span>
04472 
04473         <span class="keywordflow">switch</span> (AceTypeToCopy) {
04474         <span class="keywordflow">case</span> <a class="code" href="../../d8/d6/sertl_8c.html#a80a10">CopyInheritedAces</a>:
04475             CopyAce = AceInherited(OldAce);
04476             <span class="keywordflow">break</span>;
04477         <span class="keywordflow">case</span> <a class="code" href="../../d8/d6/sertl_8c.html#a80a11">CopyNonInheritedAces</a>:
04478             CopyAce = !AceInherited(OldAce);
04479             <span class="keywordflow">break</span>;
04480         <span class="keywordflow">case</span> <a class="code" href="../../d8/d6/sertl_8c.html#a80a12">CopyAllAces</a>:
04481             CopyAce = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04482             <span class="keywordflow">break</span>;
04483         <span class="keywordflow">default</span>:
04484             CopyAce = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04485             <span class="keywordflow">break</span>;
04486         }
04487 
04488         <span class="keywordflow">if</span> ( CopyAce ) {
04489 
04490 
04491             <span class="comment">//</span>
04492             <span class="comment">// If SIDs are to be mapped,</span>
04493             <span class="comment">//  do so (and potentially create up to two ACEs).</span>
04494             <span class="comment">//</span>
04495 
04496             <span class="keywordflow">if</span> ( MapSids ) {
04497                 PVOID TempAcePosition;
04498                 ULONG EffectiveAceSize = 0;
04499 
04500                 BOOLEAN EffectiveAceMapped;
04501                 BOOLEAN GenerateInheritAce;
04502 
04503                 <span class="comment">//</span>
04504                 <span class="comment">// Remember where the next ACE will be copied.</span>
04505                 <span class="comment">//</span>
04506 
04507                 TempAcePosition = AcePosition;
04508                 NewAceSize = 0;
04509                 GenerateInheritAce =
04510                     (((PACE_HEADER)OldAce)-&gt;AceFlags &amp; (OBJECT_INHERIT_ACE|CONTAINER_INHERIT_ACE)) != 0;
04511 
04512 
04513                 <span class="comment">//</span>
04514                 <span class="comment">// If the orginal ACE is an effective ACE,</span>
04515                 <span class="comment">//  create an effective ACE.</span>
04516                 <span class="comment">//</span>
04517 
04518                 <span class="keywordflow">if</span> ( !(((PACE_HEADER)OldAce)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
04519                     BOOLEAN LocalAclOverflowed;
04520 
04521                     <span class="comment">//</span>
04522                     <span class="comment">// Copy the effective ACE into the ACL.</span>
04523                     <span class="comment">//</span>
04524                     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a16">RtlpCopyEffectiveAce</a> (
04525                                     OldAce,
04526                                     FALSE,  <span class="comment">// Don't set the auto inherit bit</span>
04527                                     GenerateInheritAce,
04528                                     ClientOwnerSid,
04529                                     ClientGroupSid,
04530                                     ServerOwnerSid,
04531                                     ServerGroupSid,
04532                                     GenericMapping,
04533                                     NULL,   <span class="comment">// Always copy object ACES</span>
04534                                     &amp;TempAcePosition,
04535                                     &amp;EffectiveAceSize,
04536                                     NewAcl,
04537                                     NULL,   <span class="comment">// Always copy object ACES</span>
04538                                     &amp;EffectiveAceMapped,
04539                                     &amp;LocalAclOverflowed ) ) {
04540 
04541                         <span class="keywordflow">return</span> STATUS_BAD_INHERITANCE_ACL;
04542                     }
04543 
04544                     <span class="keywordflow">if</span> (LocalAclOverflowed) {
04545                         AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04546                     }
04547                     NewAceSize += EffectiveAceSize;
04548 
04549                     <span class="comment">//</span>
04550                     <span class="comment">// Reset any undesirable AceFlags.</span>
04551                     <span class="comment">//</span>
04552 
04553                     <span class="keywordflow">if</span> ( !AclOverflowed ) {
04554                         ((PACE_HEADER)AcePosition)-&gt;AceFlags &amp;= ~AceFlagsToReset;
04555                     }
04556 
04557                 }
04558 
04559                 <span class="comment">//</span>
04560                 <span class="comment">// If the original ACE is inheritable,</span>
04561                 <span class="comment">//  create an inheritable ACE.</span>
04562                 <span class="comment">//</span>
04563                 <span class="comment">// ASSERT: AcePosition points to where the effective ACE was copied</span>
04564                 <span class="comment">// ASSERT: TempAcePosition points to where the inheritable ACE should be copied</span>
04565                 <span class="comment">//</span>
04566 
04567                 <span class="keywordflow">if</span> ( GenerateInheritAce ) {
04568 
04569                     <span class="comment">//</span>
04570                     <span class="comment">// If a effective ACE was created,</span>
04571                     <span class="comment">//  and it wasn't mapped,</span>
04572                     <span class="comment">//  avoid generating another ACE and simply merge the inheritance bits into</span>
04573                     <span class="comment">//      the effective ACE.</span>
04574                     <span class="comment">//</span>
04575 
04576                     <span class="keywordflow">if</span> ( EffectiveAceSize != 0 &amp;&amp; !EffectiveAceMapped ) {
04577 
04578                        <span class="comment">//</span>
04579                        <span class="comment">// Copy the inherit bits from the original ACE.</span>
04580                        <span class="comment">//</span>
04581                        <span class="keywordflow">if</span> ( !AclOverflowed ) {
04582                             ((PACE_HEADER)AcePosition)-&gt;AceFlags |=
04583                                 ((PACE_HEADER)OldAce)-&gt;AceFlags &amp; (VALID_INHERIT_FLAGS);
04584                             ((PACE_HEADER)AcePosition)-&gt;AceFlags &amp;= ~AceFlagsToReset;
04585                        }
04586 
04587 
04588                     <span class="comment">//</span>
04589                     <span class="comment">// Otherwise, generate an explicit inheritance ACE.</span>
04590                     <span class="comment">//</span>
04591                     <span class="comment">// But only if the access mask isn't zero.</span>
04592                     <span class="comment">//</span>
04593 
04594                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !IsMSAceType(OldAce) || ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)(OldAce))-&gt;Mask != 0 ) {
04595 
04596                         <span class="comment">//</span>
04597                         <span class="comment">// Account for the new ACE being added to the ACL.</span>
04598                         <span class="comment">//</span>
04599                         NewAceSize += (ULONG)(((PACE_HEADER)OldAce)-&gt;AceSize);
04600 
04601                         <span class="keywordflow">if</span> (NewAceSize &gt; 0xFFFF) {
04602                             <span class="keywordflow">return</span> STATUS_BAD_INHERITANCE_ACL;
04603                         }
04604 
04605                         <span class="comment">//</span>
04606                         <span class="comment">// If the ACE doesn't fit,</span>
04607                         <span class="comment">//  just note the fact and don't copy the ACE.</span>
04608                         <span class="comment">//</span>
04609 
04610                         <span class="keywordflow">if</span> ( ((PACE_HEADER)OldAce)-&gt;AceSize &gt; NewAcl-&gt;AclSize - ((PUCHAR)TempAcePosition - (PUCHAR)NewAcl) ) {
04611                             AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04612                         } <span class="keywordflow">else</span> {
04613 
04614                             <span class="comment">//</span>
04615                             <span class="comment">// copy it as is, but make sure the InheritOnly bit is set.</span>
04616                             <span class="comment">//</span>
04617 
04618                             <span class="keywordflow">if</span> ( !AclOverflowed ) {
04619                                 RtlCopyMemory(
04620                                     TempAcePosition,
04621                                     OldAce,
04622                                     ((PACE_HEADER)OldAce)-&gt;AceSize
04623                                     );
04624 
04625                                 ((PACE_HEADER)TempAcePosition)-&gt;AceFlags |= INHERIT_ONLY_ACE;
04626                                 ((PACE_HEADER)TempAcePosition)-&gt;AceFlags &amp;= ~AceFlagsToReset;
04627                                 NewAcl-&gt;AceCount += 1;
04628                             }
04629                         }
04630                     }
04631 
04632                 }
04633 
04634             } <span class="keywordflow">else</span> {
04635                 NewAceSize = (ULONG)OldAce-&gt;AceSize;
04636 
04637                 <span class="comment">//</span>
04638                 <span class="comment">// If the ACE doesn't fit,</span>
04639                 <span class="comment">//  just note the fact and don't copy the ACE.</span>
04640                 <span class="comment">//</span>
04641 
04642                 <span class="keywordflow">if</span> ( AcePosition == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
04643                      NewAceSize &gt; (ULONG)NewAcl-&gt;AclSize - ((PUCHAR)AcePosition - (PUCHAR)NewAcl) ) {
04644                     AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04645                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !AclOverflowed ) {
04646 
04647 
04648                     <span class="comment">//</span>
04649                     <span class="comment">// Copy the ACE.</span>
04650                     <span class="comment">//</span>
04651 
04652                     RtlCopyMemory(
04653                         AcePosition,
04654                         OldAce,
04655                         NewAceSize );
04656 
04657                     <span class="comment">//</span>
04658                     <span class="comment">// Map the generic bits.</span>
04659                     <span class="comment">//</span>
04660                     <span class="comment">// Is it really right to map the generic bits on an ACE</span>
04661                     <span class="comment">// that's both effective and inheritable.  Shouldn't this</span>
04662                     <span class="comment">// be split into two ACEs in that case?  Or just skip the mapping?</span>
04663                     <span class="comment">//</span>
04664                     <span class="keywordflow">if</span> (IsMSAceType( AcePosition )) {
04665                         RtlApplyAceToObject( (PACE_HEADER)AcePosition, GenericMapping );
04666                     }
04667 
04668                     <span class="comment">//</span>
04669                     <span class="comment">// Reset any undesirable AceFlags.</span>
04670                     <span class="comment">//</span>
04671 
04672                     ((PACE_HEADER)AcePosition)-&gt;AceFlags &amp;= ~AceFlagsToReset;
04673 
04674                     <span class="comment">//</span>
04675                     <span class="comment">// Account for the new ACE.</span>
04676                     <span class="comment">//</span>
04677 
04678                     NewAcl-&gt;AceCount += 1;
04679                 }
04680             }
04681 
04682 
04683             <span class="comment">//</span>
04684             <span class="comment">// Move the Ace Position to where the next ACE goes.</span>
04685             <span class="comment">//</span>
04686             <span class="keywordflow">if</span> ( !AclOverflowed ) {
04687                 AcePosition = ((PUCHAR)AcePosition) + NewAceSize;
04688             } <span class="keywordflow">else</span> {
04689                 <span class="comment">// On overflow, ensure no other ACEs are actually output to the buffer</span>
04690                 AcePosition = ((PUCHAR)NewAcl) + NewAcl-&gt;AclSize;
04691             }
04692             NewAclSize += NewAceSize;
04693 
04694         }
04695     }
04696 
04697 
04698     <span class="comment">//</span>
04699     <span class="comment">// We have the length of the new ACE, but we've calculated</span>
04700     <span class="comment">// it with a ULONG.  It must fit into a USHORT.  See if it</span>
04701     <span class="comment">// does.</span>
04702     <span class="comment">//</span>
04703 
04704     <span class="keywordflow">if</span> (NewAclSize &gt; 0xFFFF) {
04705         <span class="keywordflow">return</span> STATUS_BAD_INHERITANCE_ACL;
04706     }
04707 
04708     (*NewAclSizeParam) = NewAclSize;
04709 
04710     <span class="keywordflow">return</span> AclOverflowed ? STATUS_BUFFER_TOO_SMALL : STATUS_SUCCESS;
04711 
04712 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="sertl.c::RtlpCopyEffectiveAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpCopyEffectiveAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACE_HEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>OldAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInherit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WillGenerateInheritAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientOwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientGroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerOwnerSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerGroupSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *NewObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>AcePosition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAceLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN ObjectAceInherited&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveAceMapped</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AclOverflowed</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03880">3880</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00330">CREATOR_SID_SIZE</a>, <a class="el" href="../../d5/d5/tsevars_8c-source.html#l00116">CreatorSid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d1/rtdmpsec_8c.html#a3">KNOWN_ACE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00340">RtlBaseAceType</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00924">RtlEqualPrefixSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01166">RtlInitializeSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l04371">RtlpCopyAces()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l05381">RtlpGenerateInheritedAce()</a>.
<p>
<pre class="fragment"><div>03900                    :
03901 
03902     This routine copy a specified ACE into an ACL as an effective ACE.
03903     The resultant ACE has all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inheritance bits turned of.
03904     The resultant ACE has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID mapped from a generic SID to a specific SID
03905     (e.g., From <span class="stringliteral">"creator owner"</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in owner sid).
03906 
03907 Arguments:
03908 
03909     OldAce - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ace being inherited
03910 
03911     AutoInherit - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inheritance <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an <span class="stringliteral">"automatic inheritance"</span>.
03912         As such, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherited ACEs will be marked as such.
03913 
03914     WillGenerateInheritAce - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller intends to generate an
03915         inheritable ACE <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponds to OldAce.  If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> routine will
03916         <span class="keywordflow">try</span> to not map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective ACE (increasing the likelyhood that
03917         EffectiveAceMapped will <span class="keywordflow">return</span> FALSE),
03918 
03919     ClientOwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use
03920 
03921     ClientGroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> Sid to use
03922 
03923     ServerSid - Optionally specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> Sid to use in compound ACEs.
03924 
03925     ClientSid - Optionally specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Client Sid to use in compound ACEs.
03926 
03927     GenericMapping - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping to use
03928 
03929     NewObjectType - Type of object being inherited to.  If not specified,
03930         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object has no object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
03931 
03932     AcePosition - On entry and <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>, specifies location of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next available ACE
03933         position in NewAcl.
03934         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ACE position means there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no room at all in NewAcl.
03935 
03936     NewAceLength - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length (in bytes) needed in NewAcl to
03937         copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ACE. This might be zero to indicate that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE
03938         need not be copied at all.
03939 
03940     NewAcl - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL into which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
03941         inherited.
03942 
03943     ObjectAceInherited - Returns <span class="keyword">true</span> <span class="keywordflow">if</span> one or more object ACEs were inherited
03944         based on NewObjectType
03945         If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, NewObjectType <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object ACE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always inherited
03946 
03947     EffectiveAceMapped - Return <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID, guid, or access mask of Old Ace
03948         was modifed when copying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
03949 
03950     AclOverflowed - Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> NewAcl wasn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> <span class="keywordtype">long</span> enough to contain NewAceLength.
03951 
03952 Return Value:
03953 
03954     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - No problem was detected.
03955     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Indicates something went wrong preventing
03956         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE from being compied.  This generally represents a bugcheck
03957         situation when returned from <span class="keyword">this</span> call.
03958 
03959 --*/
03960 {
03961     ULONG LengthRequired;
03962     ACCESS_MASK LocalMask;
03963 
03964     PSID LocalServerOwner;
03965     PSID LocalServerGroup;
03966 
03967     ULONG <a class="code" href="../../d4/d6/tsevars_8c.html#a33">CreatorSid</a>[<a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a>];
03968 
03969     SID_IDENTIFIER_AUTHORITY  CreatorSidAuthority = SECURITY_CREATOR_SID_AUTHORITY;
03970 
03971 
03972     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03973 
03974     <span class="comment">//</span>
03975     <span class="comment">// Allocate and initialize the universal SIDs we're going to need</span>
03976     <span class="comment">// to look for inheritable ACEs.</span>
03977     <span class="comment">//</span>
03978 
03979     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 ) == CREATOR_SID_SIZE);
03980     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( (PSID)CreatorSid, &amp;CreatorSidAuthority, 1 );
03981     *(RtlpSubAuthoritySid( (PSID)CreatorSid, 0 )) = SECURITY_CREATOR_OWNER_RID;
03982 
03983     LocalServerOwner = ARGUMENT_PRESENT(ServerOwnerSid) ? ServerOwnerSid : ClientOwnerSid;
03984     LocalServerGroup = ARGUMENT_PRESENT(ServerGroupSid) ? ServerGroupSid : ClientGroupSid;
03985 
03986 
03987     <span class="comment">//</span>
03988     <span class="comment">// Initialization</span>
03989     <span class="comment">//</span>
03990     *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03991     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ObjectAceInherited)) {
03992         *ObjectAceInherited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03993     }
03994     *AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03995     LengthRequired = (ULONG)OldAce-&gt;AceSize;
03996 
03997     <span class="comment">//</span>
03998     <span class="comment">// Process all MS ACE types specially</span>
03999     <span class="comment">//</span>
04000 
04001     <span class="keywordflow">if</span> ( IsMSAceType(OldAce) ) {
04002         ULONG Rid;
04003         PSID SidToCopy = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04004         ULONG AceHeaderToCopyLength;
04005         PACE_HEADER AceHeaderToCopy = OldAce;
04006         PSID ServerSidToCopy = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04007 
04008         UCHAR DummyAce[<span class="keyword">sizeof</span>(KNOWN_OBJECT_ACE)+<span class="keyword">sizeof</span>(GUID)];
04009 
04010         <span class="comment">//</span>
04011         <span class="comment">// Grab the Sid pointer and access mask as a function of the ACE type</span>
04012         <span class="comment">//</span>
04013         <span class="keywordflow">if</span> (IsKnownAceType( OldAce ) ) {
04014             SidToCopy = &amp;((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)OldAce)-&gt;SidStart;
04015             AceHeaderToCopyLength = FIELD_OFFSET(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>, SidStart);
04016 
04017         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsCompoundAceType(OldAce)) {
04018 
04019             SidToCopy = RtlCompoundAceClientSid( OldAce );
04020             AceHeaderToCopyLength = FIELD_OFFSET(KNOWN_COMPOUND_ACE, SidStart);
04021             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET(KNOWN_COMPOUND_ACE, Mask) ==
04022                     FIELD_OFFSET(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>, Mask) );
04023 
04024             <span class="comment">//</span>
04025             <span class="comment">// Compound ACEs have two SIDs (Map one now).</span>
04026             <span class="comment">//</span>
04027             ServerSidToCopy = RtlCompoundAceServerSid( OldAce );
04028 
04029             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a37">RtlEqualPrefixSid</a> ( ServerSidToCopy, CreatorSid )) {
04030 
04031                 Rid = *RtlpSubAuthoritySid( ServerSidToCopy, 0 );
04032                 <span class="keywordflow">switch</span> (Rid) {
04033                 <span class="keywordflow">case</span> SECURITY_CREATOR_OWNER_RID:
04034                     ServerSidToCopy = ClientOwnerSid;
04035                     LengthRequired = LengthRequired - <a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a> + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientOwnerSid);
04036                     *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04037                     <span class="keywordflow">break</span>;
04038                 <span class="keywordflow">case</span> SECURITY_CREATOR_GROUP_RID:
04039                     <span class="keywordflow">if</span> ( ClientGroupSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04040                         ServerSidToCopy = ClientGroupSid;
04041                         LengthRequired = LengthRequired - <a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a> + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientGroupSid);
04042                         *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04043                     }
04044                     <span class="keywordflow">break</span>;
04045                 <span class="keywordflow">case</span> SECURITY_CREATOR_OWNER_SERVER_RID:
04046                     ServerSidToCopy = LocalServerOwner;
04047                     LengthRequired = LengthRequired - <a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a> + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(LocalServerOwner);
04048                     *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04049                     <span class="keywordflow">break</span>;
04050                 <span class="keywordflow">case</span> SECURITY_CREATOR_GROUP_SERVER_RID:
04051                     ServerSidToCopy = LocalServerGroup;
04052                     LengthRequired = LengthRequired - <a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a> + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(LocalServerGroup);
04053                     *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04054                     <span class="keywordflow">break</span>;
04055                 }
04056 
04057                 <span class="comment">//</span>
04058                 <span class="comment">// If we don't know what this SID is, just copy the original.</span>
04059                 <span class="comment">//</span>
04060                 <span class="keywordflow">if</span> ( !*EffectiveAceMapped ) {
04061                     AceHeaderToCopyLength += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( ServerSidToCopy );
04062                     ServerSidToCopy = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04063                 }
04064 
04065             } <span class="keywordflow">else</span> {
04066                 <span class="comment">//</span>
04067                 <span class="comment">// We don't know what this SID is, just copy the original.</span>
04068                 <span class="comment">//</span>
04069                 AceHeaderToCopyLength += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( ServerSidToCopy );
04070                 ServerSidToCopy = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04071             }
04072 
04073         <span class="comment">//</span>
04074         <span class="comment">// Handle Object ACEs</span>
04075         <span class="comment">//</span>
04076         } <span class="keywordflow">else</span> {
04077             GUID *InheritedObjectType;
04078 
04079             SidToCopy = RtlObjectAceSid( OldAce );
04080             AceHeaderToCopyLength = (ULONG) ((PUCHAR)SidToCopy - (PUCHAR)OldAce);
04081             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET(KNOWN_OBJECT_ACE, Mask) ==
04082                     FIELD_OFFSET(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>, Mask) );
04083 
04084             <span class="comment">//</span>
04085             <span class="comment">// Handle ACEs that are only inherited for a specific object type,</span>
04086             <span class="comment">//</span>
04087             InheritedObjectType = RtlObjectAceInheritedObjectType( OldAce );
04088             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ObjectAceInherited) &amp;&amp; InheritedObjectType != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04089 
04090                 <span class="comment">//</span>
04091                 <span class="comment">// If the object type doesn't match the inherited object type,</span>
04092                 <span class="comment">//  don't inherit the ACE.</span>
04093                 <span class="comment">//</span>
04094 
04095                 <span class="keywordflow">if</span> ( NewObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
04096                      !RtlEqualMemory( InheritedObjectType,
04097                                       NewObjectType,
04098                                       <span class="keyword">sizeof</span>(GUID) ) ) {
04099 
04100                     LengthRequired = 0;
04101 
04102                 <span class="comment">//</span>
04103                 <span class="comment">// If the object type matches the inherited object type,</span>
04104                 <span class="comment">//  Inherit an ACE with no inherited object type.</span>
04105                 <span class="comment">//</span>
04106 
04107                 } <span class="keywordflow">else</span> {
04108 
04109                     <span class="comment">//</span>
04110                     <span class="comment">// Tell the caller we inherited an object type specific ACE.</span>
04111                     <span class="comment">//</span>
04112 
04113                     *ObjectAceInherited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04114 
04115                     <span class="comment">//</span>
04116                     <span class="comment">// If the caller is not going to generate an inheritable ACE,</span>
04117                     <span class="comment">//  deleting the inherited object type GUID for the effective ACE.</span>
04118                     <span class="comment">//</span>
04119                     <span class="comment">// Otherwise, leave it so the caller can merge the two ACEs.</span>
04120                     <span class="comment">//</span>
04121 
04122                     <span class="keywordflow">if</span> ( !WillGenerateInheritAce ) {
04123                         *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04124 
04125                         <span class="comment">//</span>
04126                         <span class="comment">// If an object type GUID is present,</span>
04127                         <span class="comment">//  simply delete the inherited object type GUID.</span>
04128                         <span class="comment">//</span>
04129                         <span class="keywordflow">if</span> ( RtlObjectAceObjectTypePresent( OldAce )) {
04130                             LengthRequired -= <span class="keyword">sizeof</span>(GUID);
04131                             AceHeaderToCopyLength -= <span class="keyword">sizeof</span>(GUID);
04132                             RtlCopyMemory( DummyAce, OldAce, AceHeaderToCopyLength );
04133 
04134                             AceHeaderToCopy = (PACE_HEADER)DummyAce;
04135                             ((PKNOWN_OBJECT_ACE)AceHeaderToCopy)-&gt;Flags &amp;= ~ACE_INHERITED_OBJECT_TYPE_PRESENT;
04136 
04137 
04138                         <span class="comment">//</span>
04139                         <span class="comment">// If an object type GUID is not present,</span>
04140                         <span class="comment">//  convert the ACE to non-object type specific.</span>
04141                         <span class="comment">//</span>
04142                         } <span class="keywordflow">else</span> {
04143                             AceHeaderToCopyLength = AceHeaderToCopyLength -
04144                                              <span class="keyword">sizeof</span>(GUID) +
04145                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>) -
04146                                              <span class="keyword">sizeof</span>(KNOWN_OBJECT_ACE);
04147                             LengthRequired = LengthRequired -
04148                                              <span class="keyword">sizeof</span>(GUID) +
04149                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>) -
04150                                              <span class="keyword">sizeof</span>(KNOWN_OBJECT_ACE);
04151 
04152                             RtlCopyMemory( DummyAce, OldAce, AceHeaderToCopyLength );
04153                             AceHeaderToCopy = (PACE_HEADER)DummyAce;
04154 
04155                             AceHeaderToCopy-&gt;AceType = <a class="code" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[ OldAce-&gt;AceType ];
04156 
04157                         }
04158                     }
04159                 }
04160 
04161             }
04162         }
04163 
04164         <span class="comment">//</span>
04165         <span class="comment">// Only proceed if we've not already determined to drop the ACE.</span>
04166         <span class="comment">//</span>
04167 
04168         <span class="keywordflow">if</span> ( LengthRequired != 0 ) {
04169 
04170             <span class="comment">//</span>
04171             <span class="comment">// If after mapping the access mask, the access mask</span>
04172             <span class="comment">// is empty, then drop the ACE.</span>
04173             <span class="comment">//</span>
04174             <span class="comment">// This is incompatible with NT 4.0 which simply mapped and left</span>
04175             <span class="comment">//  undefined access bits set.</span>
04176 
04177             LocalMask = ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)(OldAce))-&gt;Mask;
04178             RtlApplyGenericMask( OldAce, &amp;LocalMask, GenericMapping);
04179 
04180             <span class="keywordflow">if</span> ( LocalMask != ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)(OldAce))-&gt;Mask ) {
04181                 *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04182             }
04183 
04184             <span class="comment">//</span>
04185             <span class="comment">// Mask off any bits that aren't meaningful</span>
04186             <span class="comment">//</span>
04187 
04188             LocalMask &amp;= ( STANDARD_RIGHTS_ALL | SPECIFIC_RIGHTS_ALL | ACCESS_SYSTEM_SECURITY );
04189 
04190             <span class="keywordflow">if</span> (LocalMask == 0) {
04191 
04192                 LengthRequired = 0;
04193 
04194             } <span class="keywordflow">else</span> {
04195 
04196                 <span class="comment">//</span>
04197                 <span class="comment">// See if the SID in the ACE is one of the various CREATOR_* SIDs by</span>
04198                 <span class="comment">// comparing identifier authorities.</span>
04199                 <span class="comment">//</span>
04200 
04201                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a37">RtlEqualPrefixSid</a> ( SidToCopy, CreatorSid )) {
04202 
04203                     Rid = *RtlpSubAuthoritySid( SidToCopy, 0 );
04204 
04205                     <span class="keywordflow">switch</span> (Rid) {
04206                     <span class="keywordflow">case</span> SECURITY_CREATOR_OWNER_RID:
04207                         SidToCopy = ClientOwnerSid;
04208                         LengthRequired = LengthRequired - <a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a> + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientOwnerSid);
04209                         *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04210                         <span class="keywordflow">break</span>;
04211                     <span class="keywordflow">case</span> SECURITY_CREATOR_GROUP_RID:
04212                         <span class="keywordflow">if</span> ( ClientGroupSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04213                             SidToCopy = ClientGroupSid;
04214                             LengthRequired = LengthRequired - <a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a> + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientGroupSid);
04215                             *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04216                         }
04217                         <span class="keywordflow">break</span>;
04218                     <span class="keywordflow">case</span> SECURITY_CREATOR_OWNER_SERVER_RID:
04219                         SidToCopy = LocalServerOwner;
04220                         LengthRequired = LengthRequired - <a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a> + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(LocalServerOwner);
04221                         *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04222                         <span class="keywordflow">break</span>;
04223                     <span class="keywordflow">case</span> SECURITY_CREATOR_GROUP_SERVER_RID:
04224                         SidToCopy = LocalServerGroup;
04225                         LengthRequired = LengthRequired - <a class="code" href="../../d8/d6/sertl_8c.html#a0">CREATOR_SID_SIZE</a> + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(LocalServerGroup);
04226                         *EffectiveAceMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04227                         <span class="keywordflow">break</span>;
04228                     <span class="keywordflow">default</span> :
04229                         <span class="comment">//</span>
04230                         <span class="comment">// We don't know what this SID is, just copy the original.</span>
04231                         <span class="comment">//</span>
04232                         <span class="keywordflow">break</span>;
04233                     }
04234                 }
04235 
04236                 <span class="comment">//</span>
04237                 <span class="comment">// If the ACE doesn't fit,</span>
04238                 <span class="comment">//  just note the fact and don't copy the ACE.</span>
04239                 <span class="comment">//</span>
04240 
04241                 <span class="keywordflow">if</span> ( *AcePosition == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
04242                      LengthRequired &gt; (ULONG)NewAcl-&gt;AclSize - ((PUCHAR)(*AcePosition) - (PUCHAR)NewAcl) ) {
04243                     *AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04244                 } <span class="keywordflow">else</span> {
04245 
04246                     PUCHAR Target;
04247 
04248                     <span class="comment">//</span>
04249                     <span class="comment">// Copy individual parts of the ACE separately.</span>
04250                     <span class="comment">//</span>
04251 
04252                     Target = (PUCHAR)*AcePosition;
04253 
04254                     RtlCopyMemory(
04255                         Target,
04256                         AceHeaderToCopy,
04257                         AceHeaderToCopyLength );
04258 
04259                     Target += AceHeaderToCopyLength;
04260 
04261                     <span class="comment">//</span>
04262                     <span class="comment">// Now copy the correct server SID</span>
04263                     <span class="comment">//</span>
04264 
04265                     <span class="keywordflow">if</span> ( ServerSidToCopy != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04266                         RtlCopyMemory(
04267                             Target,
04268                             ServerSidToCopy,
04269                             <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSidToCopy)
04270                             );
04271                         Target += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSidToCopy);
04272                     }
04273 
04274                     <span class="comment">//</span>
04275                     <span class="comment">// Now copy the correct SID</span>
04276                     <span class="comment">//</span>
04277 
04278                     RtlCopyMemory(
04279                         Target,
04280                         SidToCopy,
04281                         <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(SidToCopy)
04282                         );
04283                     Target += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(SidToCopy);
04284 
04285                     <span class="comment">//</span>
04286                     <span class="comment">// Set the size of the ACE accordingly</span>
04287                     <span class="comment">//</span>
04288 
04289                     <span class="keywordflow">if</span> ( LengthRequired &lt; (ULONG)(Target - (PUCHAR)*AcePosition) ) {
04290                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04291                     }
04292                     LengthRequired = (ULONG)(Target - (PUCHAR)*AcePosition);
04293                     ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)*AcePosition)-&gt;Header.AceSize =
04294                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)LengthRequired;
04295 
04296 
04297                     <span class="comment">//</span>
04298                     <span class="comment">// Put the mapped access mask in the new ACE</span>
04299                     <span class="comment">//</span>
04300 
04301                     ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)*AcePosition)-&gt;Mask = LocalMask;
04302 
04303                 }
04304             }
04305         }
04306 
04307     } <span class="keywordflow">else</span> {
04308 
04309         <span class="comment">//</span>
04310         <span class="comment">// If the ACE doesn't fit,</span>
04311         <span class="comment">//  just note the fact and don't copy the ACE.</span>
04312         <span class="comment">//</span>
04313 
04314         <span class="keywordflow">if</span> ( LengthRequired &gt; (ULONG)NewAcl-&gt;AclSize - ((PUCHAR)*AcePosition - (PUCHAR)NewAcl) ) {
04315             *AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04316         } <span class="keywordflow">else</span> {
04317 
04318             <span class="comment">//</span>
04319             <span class="comment">// Not a known ACE type, copy ACE as is</span>
04320             <span class="comment">//</span>
04321 
04322             RtlCopyMemory(
04323                 *AcePosition,
04324                 OldAce,
04325                 LengthRequired );
04326          }
04327     }
04328 
04329     <span class="comment">//</span>
04330     <span class="comment">// If the ACE was actually kept, clear all the inherit flags</span>
04331     <span class="comment">// and update the ACE count of the ACL.</span>
04332     <span class="comment">//</span>
04333 
04334     <span class="keywordflow">if</span> ( !*AclOverflowed &amp;&amp; LengthRequired != 0 ) {
04335         ((PACE_HEADER)*AcePosition)-&gt;AceFlags &amp;= ~VALID_INHERIT_FLAGS;
04336         <span class="keywordflow">if</span> ( AutoInherit ) {
04337             ((PACE_HEADER)*AcePosition)-&gt;AceFlags |= INHERITED_ACE;
04338         }
04339         NewAcl-&gt;AceCount += 1;
04340     }
04341 
04342     <span class="comment">//</span>
04343     <span class="comment">// We have the length of the new ACE, but we've calculated</span>
04344     <span class="comment">// it with a ULONG.  It must fit into a USHORT.  See if it</span>
04345     <span class="comment">// does.</span>
04346     <span class="comment">//</span>
04347 
04348     <span class="keywordflow">if</span> (LengthRequired &gt; 0xFFFF) {
04349         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04350     }
04351 
04352     <span class="comment">//</span>
04353     <span class="comment">// Move the Ace Position to where the next ACE goes.</span>
04354     <span class="comment">//</span>
04355     <span class="keywordflow">if</span> ( !*AclOverflowed ) {
04356         *AcePosition = ((PUCHAR)*AcePosition) + LengthRequired;
04357     }
04358 
04359     <span class="comment">//</span>
04360     <span class="comment">//  Now return to our caller</span>
04361     <span class="comment">//</span>
04362 
04363     (*NewAceLength) = LengthRequired;
04364 
04365     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04366 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="sertl.c::RtlpCreateServerAcl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpCreateServerAcl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AclUntrusted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT BOOLEAN *&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerAclAllocated</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l08588">8588</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d4/d1/rtdmpsec_8c.html#a3">KNOWN_ACE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">SE_TAG</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>.
<p>
<pre class="fragment"><div>08598                    :
08599 
08600     This routine takes an ACL and converts <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into a server ACL.
08601     Currently, that means converting all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GRANT ACEs into
08602     Compount Grants, and <span class="keywordflow">if</span> necessary sanitizing any Compound
08603     Grants that are encountered.
08604 
08605 Arguments:
08606 
08607 
08608 
08609 Return Value:
08610 
08611 
08612 --*/
08613 
08614 {
08615     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> RequiredSize = <span class="keyword">sizeof</span>(ACL);
08616     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AceSizeAdjustment;
08617     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ServerSidSize;
08618     PACE_HEADER Ace;
08619     ULONG i;
08620     PVOID Target;
08621     PVOID AcePosition;
08622     PSID UntrustedSid;
08623     PSID ClientSid;
08624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
08625 
08626     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
08627 
08628     <span class="keywordflow">if</span> (Acl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08629         *ServerAclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08630         *ServerAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08631         <span class="keywordflow">return</span>( STATUS_SUCCESS );
08632     }
08633 
08634     AceSizeAdjustment = <span class="keyword">sizeof</span>( KNOWN_COMPOUND_ACE ) - <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a> );
08635     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( KNOWN_COMPOUND_ACE ) &gt;= <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a> ) );
08636 
08637     ServerSidSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( ServerSid );
08638 
08639     <span class="comment">//</span>
08640     <span class="comment">// Do this in two passes.  First, determine how big the final</span>
08641     <span class="comment">// result is going to be, and then allocate the space and make</span>
08642     <span class="comment">// the changes.</span>
08643     <span class="comment">//</span>
08644 
08645     <span class="keywordflow">for</span> (i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(Acl);
08646          i &lt; Acl-&gt;AceCount;
08647          i += 1, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(Ace)) {
08648 
08649         <span class="comment">//</span>
08650         <span class="comment">// If it's an ACCESS_ALLOWED_ACE_TYPE, we'll need to add in the</span>
08651         <span class="comment">// size of the Server SID.</span>
08652         <span class="comment">//</span>
08653 
08654         <span class="keywordflow">if</span> (Ace-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) {
08655 
08656             <span class="comment">//</span>
08657             <span class="comment">// Simply add the size of the new Server SID plus whatever</span>
08658             <span class="comment">// adjustment needs to be made to increase the size of the ACE.</span>
08659             <span class="comment">//</span>
08660 
08661             RequiredSize += ( ServerSidSize + AceSizeAdjustment );
08662 
08663         } <span class="keywordflow">else</span> {
08664 
08665             <span class="keywordflow">if</span> (AclUntrusted &amp;&amp; Ace-&gt;AceType == ACCESS_ALLOWED_COMPOUND_ACE_TYPE ) {
08666 
08667                 <span class="comment">//</span>
08668                 <span class="comment">// Since the Acl is untrusted, we don't care what is in the</span>
08669                 <span class="comment">// server SID, we're going to replace it.</span>
08670                 <span class="comment">//</span>
08671 
08672                 UntrustedSid = RtlCompoundAceServerSid( Ace );
08673                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(UntrustedSid) &gt; ServerSidSize) {
08674                     RequiredSize += ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(UntrustedSid) - ServerSidSize);
08675                 } <span class="keywordflow">else</span> {
08676                     RequiredSize += (ServerSidSize - (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(UntrustedSid));
08677 
08678                 }
08679             }
08680         }
08681 
08682         RequiredSize += Ace-&gt;AceSize;
08683     }
08684 
08685 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
08686 <span class="preprocessor"></span>    (*ServerAcl) = (PACL)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, RequiredSize, 'cAeS' );
08687 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
08688 <span class="preprocessor"></span>    (*ServerAcl) = (PACL)<a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), RequiredSize );
08689 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
08690 <span class="preprocessor"></span>
08691     <span class="keywordflow">if</span> ((*ServerAcl) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08692         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
08693     }
08694 
08695     <span class="comment">//</span>
08696     <span class="comment">// Mark as allocated so caller knows to free it.</span>
08697     <span class="comment">//</span>
08698 
08699     *ServerAclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08700 
08701     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( (*ServerAcl), RequiredSize, ACL_REVISION3 );
08702     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
08703 
08704     <span class="keywordflow">for</span> (i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(Acl), Target=<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( *ServerAcl );
08705          i &lt; Acl-&gt;AceCount;
08706          i += 1, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(Ace)) {
08707 
08708         <span class="comment">//</span>
08709         <span class="comment">// If it's an ACCESS_ALLOWED_ACE_TYPE, convert to a Server ACE.</span>
08710         <span class="comment">//</span>
08711 
08712         <span class="keywordflow">if</span> (Ace-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE ||
08713            (AclUntrusted &amp;&amp; Ace-&gt;AceType == ACCESS_ALLOWED_COMPOUND_ACE_TYPE )) {
08714 
08715             AcePosition = Target;
08716 
08717             <span class="keywordflow">if</span> (Ace-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) {
08718                 ClientSid =  &amp;((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)Ace)-&gt;SidStart;
08719             } <span class="keywordflow">else</span> {
08720                 ClientSid = RtlCompoundAceClientSid( Ace );
08721             }
08722 
08723             <span class="comment">//</span>
08724             <span class="comment">// Copy up to the access mask.</span>
08725             <span class="comment">//</span>
08726 
08727             RtlCopyMemory(
08728                 Target,
08729                 Ace,
08730                 FIELD_OFFSET(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>, SidStart)
08731                 );
08732 
08733             <span class="comment">//</span>
08734             <span class="comment">// Now copy the correct Server SID</span>
08735             <span class="comment">//</span>
08736 
08737             Target = ((PCHAR)Target + (UCHAR)(FIELD_OFFSET(KNOWN_COMPOUND_ACE, SidStart)));
08738 
08739             RtlCopyMemory(
08740                 Target,
08741                 ServerSid,
08742                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSid)
08743                 );
08744 
08745             Target = ((PCHAR)Target + (UCHAR)<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSid));
08746 
08747             <span class="comment">//</span>
08748             <span class="comment">// Now copy in the correct client SID.  We can copy this right out of</span>
08749             <span class="comment">// the original ACE.</span>
08750             <span class="comment">//</span>
08751 
08752             RtlCopyMemory(
08753                 Target,
08754                 ClientSid,
08755                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientSid)
08756                 );
08757 
08758             Target = ((PCHAR)Target + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientSid));
08759 
08760             <span class="comment">//</span>
08761             <span class="comment">// Set the size of the ACE accordingly</span>
08762             <span class="comment">//</span>
08763 
08764             ((PKNOWN_COMPOUND_ACE)AcePosition)-&gt;Header.AceSize =
08765                 (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)FIELD_OFFSET(KNOWN_COMPOUND_ACE, SidStart) +
08766                 (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSid) +
08767                 (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientSid);
08768 
08769             <span class="comment">//</span>
08770             <span class="comment">// Set the type</span>
08771             <span class="comment">//</span>
08772 
08773             ((PKNOWN_COMPOUND_ACE)AcePosition)-&gt;Header.AceType = ACCESS_ALLOWED_COMPOUND_ACE_TYPE;
08774             ((PKNOWN_COMPOUND_ACE)AcePosition)-&gt;CompoundAceType = COMPOUND_ACE_IMPERSONATION;
08775 
08776         } <span class="keywordflow">else</span> {
08777 
08778             <span class="comment">//</span>
08779             <span class="comment">// Just copy the ACE as is.</span>
08780             <span class="comment">//</span>
08781 
08782             RtlCopyMemory( Target, Ace, Ace-&gt;AceSize );
08783 
08784             Target = ((PCHAR)Target + Ace-&gt;AceSize);
08785         }
08786     }
08787 
08788     (*ServerAcl)-&gt;AceCount = Acl-&gt;AceCount;
08789 
08790     <span class="keywordflow">return</span>( STATUS_SUCCESS );
08791 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="sertl.c::RtlpGenerateInheritAcl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpGenerateInheritAcl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInherit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientOwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientGroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerOwnerSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerGroupSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *NewObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAclSizeParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAceInherited</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l05722">5722</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05381">RtlpGenerateInheritedAce()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l04716">RtlpInheritAcl2()</a>.
<p>
<pre class="fragment"><div>05739                    :
05740 
05741     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">private</span> routine that produces an inheritable ACL.
05742 
05743     The buffer to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherted ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed in.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
05744     too small, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corect size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> computed and STATUS_BUFFER_TOO_SMALL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
05745     returned.
05746 
05747 Arguments:
05748 
05749     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl being inherited.
05750 
05751     IsDirectoryObject - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> acl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a directory.
05752 
05753     AutoInherit - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inheritance <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an <span class="stringliteral">"automatic inheritance"</span>.
05754         As such, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherited ACEs will be marked as such.
05755 
05756     OwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use.
05757 
05758     GroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group SID to use.
05759 
05760     GenericMapping - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping to use.
05761 
05762     NewObjectType - Type of object being inherited to.  If not specified,
05763         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object has no object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
05764 
05765     NewAclSizeParam - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherited ACL.
05766 
05767     NewAcl - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
05768         (inherited) acl.  This ACL must already be initialized.
05769 
05770     ObjectAceInherited - Returns <span class="keyword">true</span> <span class="keywordflow">if</span> one or more object ACEs were inherited
05771         based on NewObjectType
05772 
05773 
05774 Return Value:
05775 
05776     STATUS_SUCCESS - An inheritable ACL has been generated.
05777 
05778     STATUS_BAD_INHERITANCE_ACL - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl built was not a valid ACL.
05779         This can becaused by a number of things.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> more probable
05780         causes <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> replacement of a CreatorId with an SID that didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> fit
05781         into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE or ACL.
05782 
05783     STATUS_BUFFER_TOO_SMALL - The ACL specified by NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too small <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05784         inheritance ACEs.  The required size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in NewAceLength.
05785 
05786 
05787 --*/
05788 
05789 {
05790 
05791     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05792     ULONG i;
05793 
05794     PACE_HEADER OldAce;
05795     ULONG NewAclSize, NewAceSize;
05796     ULONG NewAclExtraSize, NewAceExtraSize;
05797     BOOLEAN AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05798     BOOLEAN LocalObjectAceInherited;
05799 
05800 
05801     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
05802 
05803     <span class="comment">//</span>
05804     <span class="comment">// Walk through the original ACL generating any necessary</span>
05805     <span class="comment">// inheritable ACEs.</span>
05806     <span class="comment">//</span>
05807 
05808     NewAclSize = 0;
05809     NewAclExtraSize = 0;
05810     *ObjectAceInherited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05811     <span class="keywordflow">for</span> (i = 0, OldAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(Acl);
05812          i &lt; Acl-&gt;AceCount;
05813          i += 1, OldAce = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(OldAce)) {
05814 
05815         <span class="comment">//</span>
05816         <span class="comment">//  RtlpGenerateInheritedAce() will generate the ACE(s) necessary</span>
05817         <span class="comment">//  to inherit a single ACE.  This may be 0, 1, or more ACEs.</span>
05818         <span class="comment">//</span>
05819 
05820         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a18">RtlpGenerateInheritedAce</a>(
05821                      OldAce,
05822                      IsDirectoryObject,
05823                      AutoInherit,
05824                      ClientOwnerSid,
05825                      ClientGroupSid,
05826                      ServerOwnerSid,
05827                      ServerGroupSid,
05828                      GenericMapping,
05829                      NewObjectType,
05830                      &amp;NewAceSize,
05831                      NewAcl,
05832                      &amp;NewAceExtraSize,
05833                      &amp;LocalObjectAceInherited
05834                      );
05835 
05836         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ) {
05837             AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05838             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
05839         }
05840 
05841         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
05842             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05843         }
05844 
05845         <span class="keywordflow">if</span> ( LocalObjectAceInherited ) {
05846             *ObjectAceInherited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05847         }
05848 
05849         <span class="comment">//</span>
05850         <span class="comment">// Make room in the ACL for the new ACE</span>
05851         <span class="comment">//</span>
05852         NewAclSize += NewAceSize;
05853 
05854         <span class="comment">//</span>
05855         <span class="comment">// If a previous ACE needed 'extra' space,</span>
05856         <span class="comment">//  reduce that requirement by the size of this ACE.</span>
05857         <span class="comment">//</span>
05858         <span class="comment">// The previous ACE can use this ACE's space temporarily</span>
05859         <span class="comment">//</span>
05860         <span class="keywordflow">if</span> ( NewAceSize &gt; NewAclExtraSize ) {
05861             NewAclExtraSize = 0 ;
05862         } <span class="keywordflow">else</span> {
05863             NewAclExtraSize -= NewAceSize;
05864         }
05865 
05866         <span class="comment">//</span>
05867         <span class="comment">// The 'extra' space needed is the larger of that needed by any</span>
05868         <span class="comment">//  previous ACE and that need by this ACE</span>
05869         <span class="comment">//</span>
05870         NewAclExtraSize = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( NewAclExtraSize, NewAceExtraSize );
05871 
05872     }
05873 
05874     <span class="comment">//</span>
05875     <span class="comment">// We only need to include the "ExtraSize" if we've overflowed.</span>
05876     <span class="comment">//  In those cases, the caller will allocate the size we requested and</span>
05877     <span class="comment">//  try again.  Otherwise, the caller won't call back so we don't care</span>
05878     <span class="comment">//  if it knows about the extra size.</span>
05879     <span class="comment">//</span>
05880 
05881     <span class="keywordflow">if</span> ( AclOverflowed ) {
05882         (*NewAclSizeParam) = NewAclSize + NewAclExtraSize;
05883         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
05884     } <span class="keywordflow">else</span> {
05885         (*NewAclSizeParam) = NewAclSize;
05886         <span class="keywordflow">return</span> STATUS_SUCCESS;
05887     }
05888 
05889 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="sertl.c::RtlpGenerateInheritedAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpGenerateInheritedAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACE_HEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>OldAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInherit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientOwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientGroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerOwnerSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerGroupSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *NewObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAceLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAceExtraLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAceInherited</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l05381">5381</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00330">CREATOR_SID_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">RtlFirstFreeAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03880">RtlpCopyEffectiveAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08362">RtlpIsDuplicateAce()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l05722">RtlpGenerateInheritAcl()</a>.
<p>
<pre class="fragment"><div>05399                    :
05400 
05401     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">private</span> routine that checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input ace <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inheritable
05402     and produces 0, 1, or 2 inherited aces in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given buffer.
05403 
05404 Arguments:
05405 
05406     OldAce - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ace being inherited
05407 
05408     IsDirectoryObject - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> ACE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a directory
05409 
05410     AutoInherit - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inheritance <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an <span class="stringliteral">"automatic inheritance"</span>.
05411         As such, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherited ACEs will be marked as such.
05412 
05413     ClientOwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use
05414 
05415     ClientGroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> Sid to use
05416 
05417     ServerSid - Optionally specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> Sid to use in compound ACEs.
05418 
05419     ClientSid - Optionally specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Client Sid to use in compound ACEs.
05420 
05421     GenericMapping - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping to use
05422 
05423     NewObjectType - Type of object being inherited to.  If not specified,
05424         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object has no object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
05425 
05426     NewAceLength - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length (number of bytes) needed to allow <span class="keywordflow">for</span>
05427         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inheritance of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ACE.  This might be zero.
05428 
05429     NewAcl - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL into which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
05430         inherited.
05431 
05432     NewAceExtraLength - Receives a length (number of bytes) temporarily used
05433         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inheritance ACE.  This might be zero
05434 
05435     ObjectAceInherited - Returns <span class="keyword">true</span> <span class="keywordflow">if</span> one or more object ACEs were inherited
05436         based on NewObjectType
05437 
05438 Return Value:
05439 
05440     STATUS_SUCCESS - The ACE was inherited successfully.
05441 
05442     STATUS_BAD_INHERITANCE_ACL - Indicates something went wrong preventing
05443         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE from being inherited.  This generally represents a bugcheck
05444         situation when returned from <span class="keyword">this</span> call.
05445 
05446     STATUS_BUFFER_TOO_SMALL - The ACL specified by NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too small <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05447         inheritance ACEs.  The required size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in NewAceLength.
05448 
05449 
05450 --*/
05451 
05452 {
05454     <span class="comment">//                                                                       //</span>
05455     <span class="comment">// !!!!!!!!!  This is tricky  !!!!!!!!!!                                 //</span>
05456     <span class="comment">//                                                                       //</span>
05457     <span class="comment">// The inheritence flags AND the sid of the ACE determine whether        //</span>
05458     <span class="comment">// we need 0, 1, or 2 ACEs.                                              //</span>
05459     <span class="comment">//                                                                       //</span>
05460     <span class="comment">// BE CAREFUL WHEN CHANGING THIS CODE.  READ THE DSA ACL ARCHITECTURE    //</span>
05461     <span class="comment">// SECTION COVERING INHERITENCE BEFORE ASSUMING YOU KNOW WHAT THE HELL   //</span>
05462     <span class="comment">// YOU ARE DOING!!!!                                                     //</span>
05463     <span class="comment">//                                                                       //</span>
05464     <span class="comment">// The general gist of the algorithm is:                                 //</span>
05465     <span class="comment">//                                                                       //</span>
05466     <span class="comment">//       if ( (container  &amp;&amp; ContainerInherit) ||                        //</span>
05467     <span class="comment">//            (!container &amp;&amp; ObjectInherit)      ) {                     //</span>
05468     <span class="comment">//               GenerateEffectiveAce;                                   //</span>
05469     <span class="comment">//       }                                                               //</span>
05470     <span class="comment">//                                                                       //</span>
05471     <span class="comment">//                                                                       //</span>
05472     <span class="comment">//       if (Container &amp;&amp; Propagate) {                                   //</span>
05473     <span class="comment">//           Propogate copy of ACE and set InheritOnly;                  //</span>
05474     <span class="comment">//       }                                                               //</span>
05475     <span class="comment">//                                                                       //</span>
05476     <span class="comment">//                                                                       //</span>
05477     <span class="comment">// A slightly more accurate description of this algorithm is:            //</span>
05478     <span class="comment">//                                                                       //</span>
05479     <span class="comment">//   IO  === InheritOnly flag                                            //</span>
05480     <span class="comment">//   CI  === ContainerInherit flag                                       //</span>
05481     <span class="comment">//   OI  === ObjectInherit flag                                          //</span>
05482     <span class="comment">//   NPI === NoPropagateInherit flag                                     //</span>
05483     <span class="comment">//                                                                       //</span>
05484     <span class="comment">//   if ( (container  &amp;&amp; CI) ||                                          //</span>
05485     <span class="comment">//        (!container &amp;&amp; OI)   ) {                                       //</span>
05486     <span class="comment">//       Copy Header of ACE;                                             //</span>
05487     <span class="comment">//       Clear IO, NPI, CI, OI;                                          //</span>
05488     <span class="comment">//                                                                       //</span>
05489     <span class="comment">//       if (KnownAceType) {                                             //</span>
05490     <span class="comment">//           if (SID is a creator ID) {                                  //</span>
05491     <span class="comment">//               Copy appropriate creator SID;                           //</span>
05492     <span class="comment">//           } else {                                                    //</span>
05493     <span class="comment">//               Copy SID of original;                                   //</span>
05494     <span class="comment">//           }                                                           //</span>
05495     <span class="comment">//                                                                       //</span>
05496     <span class="comment">//           Copy AccessMask of original;                                //</span>
05497     <span class="comment">//           MapGenericAccesses;                                         //</span>
05498     <span class="comment">//           if (AccessMask == 0) {                                      //</span>
05499     <span class="comment">//               discard new ACE;                                        //</span>
05500     <span class="comment">//           }                                                           //</span>
05501     <span class="comment">//                                                                       //</span>
05502     <span class="comment">//       } else {                                                        //</span>
05503     <span class="comment">//           Copy body of ACE;                                           //</span>
05504     <span class="comment">//       }                                                               //</span>
05505     <span class="comment">//                                                                       //</span>
05506     <span class="comment">//   }                                                                   //</span>
05507     <span class="comment">//                                                                       //</span>
05508     <span class="comment">//   if (!NPI) {                                                         //</span>
05509     <span class="comment">//       Copy ACE as is;                                                 //</span>
05510     <span class="comment">//       Set IO;                                                         //</span>
05511     <span class="comment">//   }                                                                   //</span>
05512     <span class="comment">//                                                                       //</span>
05513     <span class="comment">//                                                                       //</span>
05514     <span class="comment">//                                                                       //</span>
05516 <span class="comment"></span>
05517 
05518 
05519     ULONG LengthRequired = 0;
05520     ULONG ExtraLengthRequired = 0;
05521     PVOID AcePosition;
05522     PVOID EffectiveAcePosition;
05523     ULONG EffectiveAceSize = 0;
05524 
05525     BOOLEAN EffectiveAceMapped;
05526     BOOLEAN AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05527     BOOLEAN GenerateInheritAce;
05528 
05529     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
05530 
05531     <span class="comment">//</span>
05532     <span class="comment">//  This is gross and ugly, but it's better than allocating</span>
05533     <span class="comment">//  virtual memory to hold the ClientSid, because that can</span>
05534     <span class="comment">//  fail, and propogating the error back is a tremendous pain</span>
05535     <span class="comment">//</span>
05536 
05537     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 ) == CREATOR_SID_SIZE);
05538     *ObjectAceInherited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05539     GenerateInheritAce = IsDirectoryObject &amp;&amp; Propagate(OldAce);
05540 
05541     <span class="comment">//</span>
05542     <span class="comment">// Allocate and initialize the universal SIDs we're going to need</span>
05543     <span class="comment">// to look for inheritable ACEs.</span>
05544     <span class="comment">//</span>
05545 
05546     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( NewAcl, &amp;AcePosition ) ) {
05547         <span class="keywordflow">return</span> STATUS_BAD_INHERITANCE_ACL;
05548     }
05549 
05550     <span class="comment">//</span>
05551     <span class="comment">//  check to see if we will have a effective ACE (one mapped to</span>
05552     <span class="comment">//  the target object type).</span>
05553     <span class="comment">//</span>
05554 
05555     <span class="keywordflow">if</span> ( (IsDirectoryObject  &amp;&amp; ContainerInherit(OldAce)) ||
05556          (!IsDirectoryObject &amp;&amp; ObjectInherit(OldAce))      ) {
05557 
05558 
05559         <span class="comment">//</span>
05560         <span class="comment">// Remember where the effective ACE will be copied to.</span>
05561         <span class="comment">//</span>
05562         EffectiveAcePosition = AcePosition;
05563 
05564         <span class="comment">//</span>
05565         <span class="comment">// Copy the effective ACE into the ACL.</span>
05566         <span class="comment">//</span>
05567         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a16">RtlpCopyEffectiveAce</a> (
05568                         OldAce,
05569                         AutoInherit,
05570                         GenerateInheritAce,
05571                         ClientOwnerSid,
05572                         ClientGroupSid,
05573                         ServerOwnerSid,
05574                         ServerGroupSid,
05575                         GenericMapping,
05576                         NewObjectType,
05577                         &amp;AcePosition,
05578                         &amp;EffectiveAceSize,
05579                         NewAcl,
05580                         ObjectAceInherited,
05581                         &amp;EffectiveAceMapped,
05582                         &amp;AclOverflowed ) ) {
05583 
05584             <span class="keywordflow">return</span> STATUS_BAD_INHERITANCE_ACL;
05585         }
05586 
05587         <span class="comment">//</span>
05588         <span class="comment">// If the effective ACE is a duplicate of existing inherited ACEs,</span>
05589         <span class="comment">//  Don't really generate it.</span>
05590         <span class="comment">//</span>
05591 
05592         <span class="keywordflow">if</span> ( !AclOverflowed &amp;&amp;
05593              EffectiveAceSize &gt; 0 &amp;&amp;
05594              EffectiveAcePosition != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
05595                 <a class="code" href="../../d8/d6/sertl_8c.html#a26">RtlpIsDuplicateAce</a>(
05596                     NewAcl,
05597                     EffectiveAcePosition,
05598                     NewObjectType ) ) {
05599 
05600 
05601             <span class="comment">//</span>
05602             <span class="comment">// Truncate the ACE we just added.</span>
05603             <span class="comment">//</span>
05604 
05605             NewAcl-&gt;AceCount--;
05606             AcePosition = EffectiveAcePosition;
05607             ExtraLengthRequired = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( ExtraLengthRequired, EffectiveAceSize );
05608             EffectiveAceSize = 0;
05609         }
05610 
05611         LengthRequired += EffectiveAceSize;
05612 
05613     }
05614 
05615     <span class="comment">//</span>
05616     <span class="comment">// If we are inheriting onto a container, then we may need to</span>
05617     <span class="comment">// propagate the inheritance as well.</span>
05618     <span class="comment">//</span>
05619 
05620     <span class="keywordflow">if</span> ( GenerateInheritAce ) {
05621 
05622         <span class="comment">//</span>
05623         <span class="comment">// If a effective ACE was created,</span>
05624         <span class="comment">//  and it wasn't mapped,</span>
05625         <span class="comment">//  avoid generating another ACE and simply merge the inheritance bits into</span>
05626         <span class="comment">//      the effective ACE.</span>
05627         <span class="comment">//</span>
05628 
05629         <span class="keywordflow">if</span> ( EffectiveAceSize != 0 &amp;&amp; !EffectiveAceMapped ) {
05630 
05631            <span class="comment">//</span>
05632            <span class="comment">// Copy the inherit bits from the original ACE.</span>
05633            <span class="comment">//</span>
05634            <span class="keywordflow">if</span> ( !AclOverflowed ) {
05635                ((PACE_HEADER)EffectiveAcePosition)-&gt;AceFlags |=
05636                     ((PACE_HEADER)OldAce)-&gt;AceFlags &amp; (CONTAINER_INHERIT_ACE | OBJECT_INHERIT_ACE);
05637                <span class="keywordflow">if</span> ( AutoInherit ) {
05638                    ((PACE_HEADER)EffectiveAcePosition)-&gt;AceFlags |= INHERITED_ACE;
05639                }
05640            }
05641 
05642 
05643         <span class="comment">//</span>
05644         <span class="comment">// Otherwise, generate an explicit inheritance ACE.</span>
05645         <span class="comment">//</span>
05646         <span class="comment">// But only if the access mask isn't zero.</span>
05647         <span class="comment">//</span>
05648 
05649         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !IsMSAceType(OldAce) || ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)(OldAce))-&gt;Mask != 0 ) {
05650 
05651             <span class="comment">//</span>
05652             <span class="comment">// Account for the new ACE being added to the ACL.</span>
05653             <span class="comment">//</span>
05654             LengthRequired += (ULONG)(((PACE_HEADER)OldAce)-&gt;AceSize);
05655 
05656             <span class="keywordflow">if</span> (LengthRequired &gt; 0xFFFF) {
05657                 <span class="keywordflow">return</span> STATUS_BAD_INHERITANCE_ACL;
05658             }
05659 
05660             <span class="comment">//</span>
05661             <span class="comment">// If the ACE doesn't fit,</span>
05662             <span class="comment">//  just note the fact and don't copy the ACE.</span>
05663             <span class="comment">//</span>
05664 
05665             <span class="keywordflow">if</span> ( ((PACE_HEADER)OldAce)-&gt;AceSize &gt; NewAcl-&gt;AclSize - ((PUCHAR)AcePosition - (PUCHAR)NewAcl) ) {
05666                 AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05667             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!AclOverflowed){
05668 
05669                 <span class="comment">//</span>
05670                 <span class="comment">// copy it as is, but make sure the InheritOnly bit is set.</span>
05671                 <span class="comment">//</span>
05672 
05673                 RtlCopyMemory(
05674                     AcePosition,
05675                     OldAce,
05676                     ((PACE_HEADER)OldAce)-&gt;AceSize
05677                     );
05678 
05679                 ((PACE_HEADER)AcePosition)-&gt;AceFlags |= INHERIT_ONLY_ACE;
05680                 NewAcl-&gt;AceCount += 1;
05681                 <span class="keywordflow">if</span> ( AutoInherit ) {
05682                     ((PACE_HEADER)AcePosition)-&gt;AceFlags |= INHERITED_ACE;
05683 
05684                     <span class="comment">//</span>
05685                     <span class="comment">// If the inheritance ACE is a duplicate of existing inherited ACEs,</span>
05686                     <span class="comment">//  Don't really generate it.</span>
05687                     <span class="comment">//</span>
05688 
05689                     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a26">RtlpIsDuplicateAce</a>(
05690                                 NewAcl,
05691                                 AcePosition,
05692                                 NewObjectType ) ) {
05693 
05694 
05695                         <span class="comment">//</span>
05696                         <span class="comment">// Truncate the ACE we just added.</span>
05697                         <span class="comment">//</span>
05698 
05699                         NewAcl-&gt;AceCount--;
05700                         ExtraLengthRequired = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( ExtraLengthRequired,
05701                                                    ((PACE_HEADER)OldAce)-&gt;AceSize );
05702                         LengthRequired -= (ULONG)(((PACE_HEADER)OldAce)-&gt;AceSize);
05703                     }
05704                 }
05705 
05706             }
05707         }
05708     }
05709 
05710     <span class="comment">//</span>
05711     <span class="comment">//  Now return to our caller</span>
05712     <span class="comment">//</span>
05713 
05714     (*NewAceLength) = LengthRequired;
05715     (*NewAceExtraLength) = ExtraLengthRequired;
05716 
05717     <span class="keywordflow">return</span> AclOverflowed ? STATUS_BUFFER_TOO_SMALL : STATUS_SUCCESS;
05718 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="sertl.c::RtlpGetDefaultsSubjectContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpGetDefaultsSubjectContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_OWNER *&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_PRIMARY_GROUP *&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_DEFAULT_DACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>DefaultDaclInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_OWNER *&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerOwner</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_PRIMARY_GROUP *&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerGroup</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l08795">8795</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">SE_TAG</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>.
<p>
<pre class="fragment"><div>08803 {
08804     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
08805     PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
08806     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
08807     ULONG ServerGroupInfoSize;
08808     ULONG ServerOwnerInfoSize;
08809     ULONG TokenDaclInfoSize;
08810     ULONG TokenGroupInfoSize;
08811     ULONG TokenOwnerInfoSize;
08812 
08813     BOOLEAN ClosePrimaryToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08814 
08815     *OwnerInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08816     *GroupInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08817     *DefaultDaclInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08818     *ServerOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08819     *ServerGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08820 
08821     <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
08822 
08823     <span class="comment">//</span>
08824     <span class="comment">// If the caller doesn't know the client token,</span>
08825     <span class="comment">//  simply don't return any information.</span>
08826     <span class="comment">//</span>
08827 
08828     <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
08829         <span class="comment">//</span>
08830         <span class="comment">// Obtain the default owner from the client.</span>
08831         <span class="comment">//</span>
08832 
08833         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
08834                      ClientToken,                        <span class="comment">// Handle</span>
08835                      TokenOwner,                   <span class="comment">// TokenInformationClass</span>
08836                      NULL,                         <span class="comment">// TokenInformation</span>
08837                      0,                            <span class="comment">// TokenInformationLength</span>
08838                      &amp;TokenOwnerInfoSize           <span class="comment">// ReturnLength</span>
08839                      );
08840 
08841         <span class="keywordflow">if</span> ( STATUS_BUFFER_TOO_SMALL != <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) {
08842             <span class="keywordflow">goto</span> Cleanup;
08843         }
08844 
08845         *OwnerInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), TokenOwnerInfoSize );
08846 
08847         <span class="keywordflow">if</span> ( *OwnerInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
08848             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
08849             <span class="keywordflow">goto</span> Cleanup;
08850         }
08851 
08852         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
08853                      ClientToken,                        <span class="comment">// Handle</span>
08854                      TokenOwner,                   <span class="comment">// TokenInformationClass</span>
08855                      *OwnerInfo,               <span class="comment">// TokenInformation</span>
08856                      TokenOwnerInfoSize,           <span class="comment">// TokenInformationLength</span>
08857                      &amp;TokenOwnerInfoSize           <span class="comment">// ReturnLength</span>
08858                      );
08859 
08860         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
08861             <span class="keywordflow">goto</span> Cleanup;
08862         }
08863 
08864         <span class="comment">//</span>
08865         <span class="comment">// Obtain the default group from the client token.</span>
08866         <span class="comment">//</span>
08867 
08868         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
08869                      ClientToken,                        <span class="comment">// Handle</span>
08870                      TokenPrimaryGroup,            <span class="comment">// TokenInformationClass</span>
08871                      *GroupInfo,                   <span class="comment">// TokenInformation</span>
08872                      0,                            <span class="comment">// TokenInformationLength</span>
08873                      &amp;TokenGroupInfoSize           <span class="comment">// ReturnLength</span>
08874                      );
08875 
08876         <span class="keywordflow">if</span> ( STATUS_BUFFER_TOO_SMALL != <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) {
08877             <span class="keywordflow">goto</span> Cleanup;
08878         }
08879 
08880         *GroupInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), TokenGroupInfoSize );
08881 
08882         <span class="keywordflow">if</span> ( *GroupInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
08883 
08884             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
08885             <span class="keywordflow">goto</span> Cleanup;
08886         }
08887 
08888         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
08889                      ClientToken,                  <span class="comment">// Handle</span>
08890                      TokenPrimaryGroup,            <span class="comment">// TokenInformationClass</span>
08891                      *GroupInfo,                   <span class="comment">// TokenInformation</span>
08892                      TokenGroupInfoSize,           <span class="comment">// TokenInformationLength</span>
08893                      &amp;TokenGroupInfoSize           <span class="comment">// ReturnLength</span>
08894                      );
08895 
08896         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
08897             <span class="keywordflow">goto</span> Cleanup;
08898         }
08899 
08900         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
08901                      ClientToken,                        <span class="comment">// Handle</span>
08902                      TokenDefaultDacl,             <span class="comment">// TokenInformationClass</span>
08903                      *DefaultDaclInfo,             <span class="comment">// TokenInformation</span>
08904                      0,                            <span class="comment">// TokenInformationLength</span>
08905                      &amp;TokenDaclInfoSize            <span class="comment">// ReturnLength</span>
08906                      );
08907 
08908         <span class="keywordflow">if</span> ( STATUS_BUFFER_TOO_SMALL != <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) {
08909             <span class="keywordflow">goto</span> Cleanup;
08910         }
08911 
08912         *DefaultDaclInfo = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), TokenDaclInfoSize );
08913 
08914         <span class="keywordflow">if</span> ( *DefaultDaclInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
08915 
08916             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
08917             <span class="keywordflow">goto</span> Cleanup;
08918         }
08919 
08920         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
08921                      ClientToken,                        <span class="comment">// Handle</span>
08922                      TokenDefaultDacl,             <span class="comment">// TokenInformationClass</span>
08923                      *DefaultDaclInfo,             <span class="comment">// TokenInformation</span>
08924                      TokenDaclInfoSize,            <span class="comment">// TokenInformationLength</span>
08925                      &amp;TokenDaclInfoSize            <span class="comment">// ReturnLength</span>
08926                      );
08927 
08928         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
08929             <span class="keywordflow">goto</span> Cleanup;
08930         }
08931     }
08932 
08933     <span class="comment">//</span>
08934     <span class="comment">// Now open the primary token to determine how to substitute for</span>
08935     <span class="comment">// ServerOwner and ServerGroup.</span>
08936     <span class="comment">//</span>
08937 
08938     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
08939                  NtCurrentProcess(),
08940                  TOKEN_QUERY,
08941                  &amp;PrimaryToken
08942                  );
08943 
08944     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
08945         ClosePrimaryToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08946         <span class="keywordflow">goto</span> Cleanup;
08947     } <span class="keywordflow">else</span> {
08948         ClosePrimaryToken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08949     }
08950 
08951     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
08952                  PrimaryToken,                 <span class="comment">// Handle</span>
08953                  TokenOwner,                   <span class="comment">// TokenInformationClass</span>
08954                  NULL,                         <span class="comment">// TokenInformation</span>
08955                  0,                            <span class="comment">// TokenInformationLength</span>
08956                  &amp;ServerOwnerInfoSize          <span class="comment">// ReturnLength</span>
08957                  );
08958 
08959     <span class="keywordflow">if</span> ( STATUS_BUFFER_TOO_SMALL != <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) {
08960         <span class="keywordflow">goto</span> Cleanup;
08961     }
08962 
08963     *ServerOwner = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), ServerOwnerInfoSize );
08964 
08965     <span class="keywordflow">if</span> ( *ServerOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
08966         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
08967         <span class="keywordflow">goto</span> Cleanup;
08968     }
08969 
08970     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
08971                  PrimaryToken,                 <span class="comment">// Handle</span>
08972                  TokenOwner,                   <span class="comment">// TokenInformationClass</span>
08973                  *ServerOwner,                 <span class="comment">// TokenInformation</span>
08974                  ServerOwnerInfoSize,          <span class="comment">// TokenInformationLength</span>
08975                  &amp;ServerOwnerInfoSize          <span class="comment">// ReturnLength</span>
08976                  );
08977 
08978     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
08979         <span class="keywordflow">goto</span> Cleanup;
08980     }
08981 
08982     <span class="comment">//</span>
08983     <span class="comment">// Find the server group.</span>
08984     <span class="comment">//</span>
08985 
08986     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
08987                  PrimaryToken,                 <span class="comment">// Handle</span>
08988                  TokenPrimaryGroup,            <span class="comment">// TokenInformationClass</span>
08989                  *ServerGroup,                 <span class="comment">// TokenInformation</span>
08990                  0,                            <span class="comment">// TokenInformationLength</span>
08991                  &amp;ServerGroupInfoSize          <span class="comment">// ReturnLength</span>
08992                  );
08993 
08994     <span class="keywordflow">if</span> ( STATUS_BUFFER_TOO_SMALL != <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) {
08995         <span class="keywordflow">goto</span> Cleanup;
08996     }
08997 
08998     *ServerGroup = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), ServerGroupInfoSize );
08999 
09000     <span class="keywordflow">if</span> ( *ServerGroup == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
09001         <span class="keywordflow">goto</span> Cleanup;
09002     }
09003 
09004     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
09005                  PrimaryToken,                 <span class="comment">// Handle</span>
09006                  TokenPrimaryGroup,            <span class="comment">// TokenInformationClass</span>
09007                  *ServerGroup,                 <span class="comment">// TokenInformation</span>
09008                  ServerGroupInfoSize,          <span class="comment">// TokenInformationLength</span>
09009                  &amp;ServerGroupInfoSize          <span class="comment">// ReturnLength</span>
09010                  );
09011 
09012     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
09013         <span class="keywordflow">goto</span> Cleanup;
09014     }
09015 
09016     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( PrimaryToken );
09017 
09018     <span class="keywordflow">return</span>( STATUS_SUCCESS );
09019 
09020 Cleanup:
09021 
09022     <span class="keywordflow">if</span> (*OwnerInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09023         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)*OwnerInfo );
09024         *OwnerInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09025     }
09026 
09027     <span class="keywordflow">if</span> (*GroupInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09028         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)*GroupInfo );
09029         *GroupInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09030     }
09031 
09032     <span class="keywordflow">if</span> (*DefaultDaclInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09033         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)*DefaultDaclInfo );
09034         *DefaultDaclInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09035     }
09036 
09037     <span class="keywordflow">if</span> (*ServerOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09038         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)*ServerOwner );
09039         *ServerOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09040     }
09041 
09042     <span class="keywordflow">if</span> (*ServerGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09043         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)*ServerGroup );
09044         *ServerGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09045     }
09046 
09047     <span class="keywordflow">if</span> (ClosePrimaryToken  == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
09048         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( PrimaryToken );
09049     }
09050 
09051     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
09052 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="sertl.c::RtlpInheritAcl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpInheritAcl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildGenericControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInherit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DefaultDescriptorForObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerOwnerSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerGroupSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsSacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *NewObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAclExplicitlyAssigned</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewGenericControl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l05153">5153</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l04716">RtlpInheritAcl2()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">SE_TAG</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, and <a class="el" href="../../d2/d4/seassign_8c-source.html#l00416">SepInheritAcl()</a>.
<p>
<pre class="fragment"><div>05174                    :
05175 
05176     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">private</span> routine that produces an inherited acl from
05177     a parent acl according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rules of inheritance
05178 
05179 Arguments:
05180 
05181     DirectoryAcl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl being inherited.
05182 
05183     ChildAcl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  This
05184         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current acl on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl being assigned
05185         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
05186 
05187     ChildGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor
05188         describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ChildAcl:
05189 
05190         SEP_ACL_PRESENT: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explictly supplied by
05191             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
05192 
05193         SEP_ACL_DEFAULTED: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child ACL was supplied by some
05194             defaulting mechanism.
05195 
05196         SEP_ACL_PROTECTED: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">protected</span> and
05197             should not inherit any ACE from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DirectoryACL
05198 
05199     IsDirectoryObject - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> acl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a directory.
05200 
05201     AutoInherit - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inheritance <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an <span class="stringliteral">"automatic inheritance"</span>.
05202         As such, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-inherited ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ChildAcl will be preserved and
05203         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherited ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DirectoryAcl will be marked as such.
05204 
05205     DefaultDescriptorForObject - If set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor
05206         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> descriptor <span class="keywordflow">for</span> ObjectType.  As such, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05207         CreatorDescriptor will be ignored <span class="keywordflow">if</span> any ObjectType specific
05208         ACEs are inherited from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent.  If not such ACEs are inherited,
05209         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled as though <span class="keyword">this</span> flag were not
05210         specified.
05211 
05212     OwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use.
05213 
05214     GroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group SID to use.
05215 
05216     GenericMapping - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping to use.
05217 
05218     IsSacl - True <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SACL.  False <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL.
05219 
05220     NewObjectType - Type of object being inherited to.  If not specified,
05221         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object has no object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
05222 
05223     NewAcl - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> (inherited) acl.
05224 
05225     NewAclExplicitlyAssigned - Returns <span class="keyword">true</span> to indicate that some portion of
05226         <span class="stringliteral">"NewAcl"</span> was derived from an <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">explicit</span> ChildAcl
05227 
05228     NewGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly
05229         generated ACL.
05230 
05231         SEP_ACL_AUTO_INHERITED: Set <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL was generated <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05232             Automatic Inheritance algorithm.
05233 
05234         SEP_ACL_PROTECTED: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">protected</span> and
05235             was not inherited from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent ACL.
05236 
05237 Return Value:
05238 
05239     STATUS_SUCCESS - An inheritable ACL was successfully generated.
05240 
05241     STATUS_NO_INHERITANCE - An inheritable ACL was not successfully generated.
05242         This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a warning completion status.
05243 
05244     STATUS_BAD_INHERITANCE_ACL - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl built was not a valid ACL.
05245         This can becaused by a number of things.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> more probable
05246         causes <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> replacement of a CreatorId with an SID that didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> fit
05247         into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE or ACL.
05248 
05249     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a revision that
05250         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unknown to <span class="keyword">this</span> routine.
05251 
05252 --*/
05253 
05254 {
05256 <span class="comment">//                                                                          //</span>
05257 <span class="comment">//   The logic in the ACL inheritance code must mirror the code for         //</span>
05258 <span class="comment">//   inheritance in the executive (in seassign.c).  Do not make changes     //</span>
05259 <span class="comment">//   here without also making changes in that module.                       //</span>
05260 <span class="comment">//                                                                          //</span>
05262 <span class="comment"></span>
05263 
05264 
05265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05266     ULONG AclBufferSize;
05267     ULONG i;
05268 
05269 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
05270 <span class="preprocessor"></span>    PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
05271 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
05272 <span class="preprocessor"></span>
05273     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
05274 
05275     <span class="comment">//</span>
05276     <span class="comment">// Get the handle to the current process heap</span>
05277     <span class="comment">//</span>
05278 
05279 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
05280 <span class="preprocessor"></span>    <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
05281 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
05282 <span class="preprocessor"></span>
05283 
05284 
05285     <span class="comment">//</span>
05286     <span class="comment">// Implement a two pass strategy.</span>
05287     <span class="comment">//</span>
05288     <span class="comment">// First try to create the ACL in a fixed length buffer.</span>
05289     <span class="comment">// If that is too small,</span>
05290     <span class="comment">//  then use the buffer size determined on the first pass</span>
05291     <span class="comment">//</span>
05292 
05293     AclBufferSize = 1024;   <span class="comment">// Typical maximum size of an ACL</span>
05294     <span class="keywordflow">for</span> ( i=0; i&lt;2 ; i++ ) {
05295 
05296         <span class="comment">//</span>
05297         <span class="comment">// Allocate heap for the new ACL.</span>
05298         <span class="comment">//</span>
05299 
05300 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
05301 <span class="preprocessor"></span>        (*NewAcl) = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
05302                         PagedPool,
05303                         AclBufferSize,
05304                         'cAeS' );
05305 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
05306 <span class="preprocessor"></span>        (*NewAcl) = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
05307                         HeapHandle,
05308                         <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(SE_TAG),
05309                         AclBufferSize );
05310 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
05311 <span class="preprocessor"></span>
05312         <span class="keywordflow">if</span> ((*NewAcl) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
05313             <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
05314         }
05315 
05316         <span class="comment">//</span>
05317         <span class="comment">// Actually build the inherited ACL.</span>
05318         <span class="comment">//</span>
05319 
05320         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a20">RtlpInheritAcl2</a> (
05321                     DirectoryAcl,
05322                     ChildAcl,
05323                     ChildGenericControl,
05324                     IsDirectoryObject,
05325                     AutoInherit,
05326                     DefaultDescriptorForObject,
05327                     OwnerSid,
05328                     GroupSid,
05329                     ServerOwnerSid,
05330                     ServerGroupSid,
05331                     GenericMapping,
05332                     IsSacl,
05333                     NewObjectType,
05334                     &amp;AclBufferSize,
05335                     (PUCHAR) *NewAcl,
05336                     NewAclExplicitlyAssigned,
05337                     NewGenericControl );
05338 
05339 
05340         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
05341 
05342             <span class="comment">//</span>
05343             <span class="comment">// If a NULL ACL should be used,</span>
05344             <span class="comment">//  tell the caller.</span>
05345             <span class="comment">//</span>
05346 
05347             <span class="keywordflow">if</span> ( AclBufferSize == 0 ) {
05348 
05349 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
05350 <span class="preprocessor"></span>                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *NewAcl );
05351 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
05352 <span class="preprocessor"></span>                <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, *NewAcl );
05353 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
05354 <span class="preprocessor"></span>
05355                 *NewAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05356             }
05357 
05358             <span class="keywordflow">break</span>;
05359 
05360         } <span class="keywordflow">else</span> {
05361 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
05362 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *NewAcl );
05363 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
05364 <span class="preprocessor"></span>            <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, *NewAcl );
05365 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
05366 <span class="preprocessor"></span>
05367             *NewAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05368 
05369             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL ) {
05370                 <span class="keywordflow">break</span>;
05371             }
05372         }
05373     }
05374 
05375 
05376     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05377 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="sertl.c::RtlpInheritAcl2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpInheritAcl2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildAcl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildGenericControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInherit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DefaultDescriptorForObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerOwnerSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID ServerGroupSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsSacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *NewObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AclBufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>AclBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAclExplicitlyAssigned</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewGenericControl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l04716">4716</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l00089">ACE_TYPE_TO_COPY</a>, <a class="el" href="../../d8/d6/sertl_8c.html#a80a12">CopyAllAces</a>, <a class="el" href="../../d8/d6/sertl_8c.html#a80a11">CopyNonInheritedAces</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">RtlFirstFreeAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l04371">RtlpCopyAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05722">RtlpGenerateInheritAcl()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l05153">RtlpInheritAcl()</a>.
<p>
<pre class="fragment"><div>04738                    :
04739 
04740     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">private</span> routine that produces an inherited acl from
04741     a parent acl according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rules of inheritance
04742 
04743 Arguments:
04744 
04745     DirectoryAcl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl being inherited.
04746 
04747     ChildAcl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  This
04748         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current acl on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl being assigned
04749         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
04750 
04751     ChildGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor
04752         describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ChildAcl:
04753 
04754         SEP_ACL_PRESENT: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explictly supplied by
04755             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
04756 
04757         SEP_ACL_DEFAULTED: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child ACL was supplied by some
04758             defaulting mechanism.
04759 
04760         SEP_ACL_PROTECTED: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">protected</span> and
04761             should not inherit any ACE from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DirectoryACL
04762 
04763     IsDirectoryObject - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> acl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a directory.
04764 
04765     AutoInherit - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inheritance <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an <span class="stringliteral">"automatic inheritance"</span>.
04766         As such, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-inherited ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ChildAcl will be preserved and
04767         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherited ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DirectoryAcl will be marked as such.
04768 
04769     DefaultDescriptorForObject - If set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor
04770         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> descriptor <span class="keywordflow">for</span> ObjectType.  As such, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04771         CreatorDescriptor will be ignored <span class="keywordflow">if</span> any ObjectType specific
04772         ACEs are inherited from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent.  If not such ACEs are inherited,
04773         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled as though <span class="keyword">this</span> flag were not
04774         specified.
04775 
04776     OwnerSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner Sid to use.
04777 
04778     GroupSid - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group SID to use.
04779 
04780     GenericMapping - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping to use.
04781 
04782     IsSacl - True <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SACL.  False <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL.
04783 
04784     NewObjectType - Type of object being inherited to.  If not specified,
04785         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object has no object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
04786 
04787     AclBufferSize - On input, specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of AclBuffer.
04788         On output, on success, returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> used size of AclBuffer.
04789         On output, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too small, returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required size of AclBuffer.
04790 
04791     AclBuffer - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> (inherited) acl.
04792 
04793     NewAclExplicitlyAssigned - Returns <span class="keyword">true</span> to indicate that some portion of
04794         <span class="stringliteral">"NewAcl"</span> was derived from an <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">explicit</span> ChildAcl
04795 
04796     NewGenericControl - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly
04797         generated ACL.
04798 
04799         SEP_ACL_AUTO_INHERITED: Set <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL was generated <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04800             Automatic Inheritance algorithm.
04801 
04802         SEP_ACL_PROTECTED: Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">protected</span> and
04803             was not inherited from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent ACL.
04804 
04805 Return Value:
04806 
04807     STATUS_SUCCESS - An inheritable ACL was successfully generated.
04808 
04809     STATUS_NO_INHERITANCE - An inheritable ACL was not successfully generated.
04810         This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a warning completion status.  The caller should use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span>
04811         ACL.
04812 
04813     STATUS_BAD_INHERITANCE_ACL - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl built was not a valid ACL.
04814         This can becaused by a number of things.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> more probable
04815         causes <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> replacement of a CreatorId with an SID that didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> fit
04816         into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE or ACL.
04817 
04818     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a revision that
04819         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unknown to <span class="keyword">this</span> routine.
04820 
04821     STATUS_BUFFER_TOO_SMALL - The ACL specified by NewAcl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too small <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04822         inheritance ACEs.  The required size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in AclBufferSize.
04823 
04824 --*/
04825 
04826 {
04827     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04828     ULONG ChildNewAclSize = 0;
04829     ULONG UsedChildNewAclSize = 0;
04830     ULONG DirectoryNewAclSize = 0;
04831     ULONG AclRevision;
04832     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ChildAceCount;
04833     PVOID ChildAcePosition;
04834     PVOID DirectoryAcePosition;
04835     BOOLEAN AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04836     BOOLEAN AclProtected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04837     BOOLEAN NullAclOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04838     BOOLEAN ObjectAceInherited;
04839 
04840     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
04841 
04842 
04843     <span class="comment">//</span>
04844     <span class="comment">// Assume the ACL revision.</span>
04845     <span class="comment">//</span>
04846 
04847     AclRevision = ACL_REVISION;
04848     <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( (PACL)AclBuffer, *AclBufferSize, AclRevision );
04849     *NewAclExplicitlyAssigned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04850     *NewGenericControl = AutoInherit ? SEP_ACL_AUTO_INHERITED : 0;
04851 
04852     <span class="comment">//</span>
04853     <span class="comment">// If the a current child ACL is not defaulted,</span>
04854     <span class="comment">//  the non-inherited ACEs from the current child ACL are to be preserved.</span>
04855     <span class="comment">//</span>
04856 
04857     <span class="keywordflow">if</span> ( (ChildGenericControl &amp; SEP_ACL_DEFAULTED) == 0 ) {
04858 
04859         <span class="comment">//</span>
04860         <span class="comment">// The resultant ACL should be protected if the input ACL is</span>
04861         <span class="comment">//  protected.</span>
04862         <span class="comment">//</span>
04863 
04864         <span class="keywordflow">if</span> ( ChildGenericControl &amp; SEP_ACL_PROTECTED ) {
04865             AclProtected = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04866             *NewGenericControl |= SEP_ACL_PROTECTED;
04867         }
04868 
04869         <span class="comment">//</span>
04870         <span class="comment">// Only copy ACEs if the child ACL is actually present.</span>
04871         <span class="comment">//</span>
04872         <span class="keywordflow">if</span> ( (ChildGenericControl &amp; (SEP_ACL_PRESENT|SEP_ACL_PROTECTED)) != 0 ) {
04873 
04874 
04875             <span class="keywordflow">if</span> ( ChildAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04876                 <a class="code" href="../../d8/d6/sertl_8c.html#a80">ACE_TYPE_TO_COPY</a> AceTypeToCopy;
04877                 UCHAR AceFlagsToReset;
04878                 BOOLEAN MapSids;
04879 
04880 
04881                 AclRevision = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( AclRevision, ChildAcl-&gt;AclRevision );
04882 
04883                 <span class="comment">//</span>
04884                 <span class="comment">// Since we're explicitly using the ACL specified by the caller,</span>
04885                 <span class="comment">//  we never want to return a NULL ACL.</span>
04886                 <span class="comment">//  Rather, if we have an ACL with no ACEs,</span>
04887                 <span class="comment">//  we'll return exactly that.  For a DACL, that results</span>
04888                 <span class="comment">//  in a DACL that grants no access rather than a DACL</span>
04889                 <span class="comment">//  that grants all access.</span>
04890                 <span class="comment">//</span>
04891 
04892                 NullAclOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04893 
04894                 <span class="comment">//</span>
04895                 <span class="comment">// If the caller doesn't understand auto inheritance,</span>
04896                 <span class="comment">//  simply preserve the specified ACL 100% intact.</span>
04897                 <span class="comment">//</span>
04898                 <span class="keywordflow">if</span> ( !AutoInherit ) {
04899 
04900                     AceTypeToCopy = <a class="code" href="../../d8/d6/sertl_8c.html#a80a12">CopyAllAces</a>;
04901                     AceFlagsToReset = 0;      <span class="comment">// Don't turn off any ACE Flags</span>
04902                     MapSids = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;          <span class="comment">// For backward compatibility</span>
04903 
04904                 <span class="comment">//</span>
04905                 <span class="comment">// If the child is protected,</span>
04906                 <span class="comment">//  keep all of the ACEs turning off the INHERITED ACE flags.</span>
04907                 <span class="comment">//</span>
04908                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ChildGenericControl &amp; SEP_ACL_PROTECTED ) {
04909 
04910                     AceTypeToCopy = <a class="code" href="../../d8/d6/sertl_8c.html#a80a12">CopyAllAces</a>;
04911                     AceFlagsToReset = INHERITED_ACE; <span class="comment">// Turn off all INHERITED_ACE flags</span>
04912                     MapSids = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04913 
04914                 <span class="comment">//</span>
04915                 <span class="comment">// If the child is not protected,</span>
04916                 <span class="comment">//  just copy the non-inherited ACEs.</span>
04917                 <span class="comment">//</span>
04918                 <span class="comment">// (The inherited ACEs will be recomputed from the parent.)</span>
04919                 <span class="comment">//</span>
04920                 } <span class="keywordflow">else</span> {
04921 
04922                     AceTypeToCopy = <a class="code" href="../../d8/d6/sertl_8c.html#a80a11">CopyNonInheritedAces</a>;
04923                     AceFlagsToReset = 0;      <span class="comment">// Don't turn off any ACE Flags</span>
04924                     MapSids = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04925 
04926                 }
04927 
04928                 <span class="comment">//</span>
04929                 <span class="comment">// Copy the requested ACEs.</span>
04930                 <span class="comment">//</span>
04931 
04932                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a17">RtlpCopyAces</a>(
04933                             ChildAcl,
04934                             GenericMapping,
04935                             AceTypeToCopy,
04936                             AceFlagsToReset,
04937                             MapSids,
04938                             OwnerSid,
04939                             GroupSid,
04940                             ServerOwnerSid,
04941                             ServerGroupSid,
04942                             &amp;ChildNewAclSize,
04943                             (PACL)AclBuffer );
04944 
04945                 UsedChildNewAclSize = ChildNewAclSize;
04946                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ) {
04947                     AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04948                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04949                 }
04950 
04951                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04952                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04953                 }
04954 
04955                 <span class="comment">//</span>
04956                 <span class="comment">// If this ACL might be ignored later,</span>
04957                 <span class="comment">//  remember the current state of the ACL.</span>
04958                 <span class="comment">//</span>
04959 
04960                 <span class="keywordflow">if</span> ( DefaultDescriptorForObject &amp;&amp; ChildNewAclSize != 0 ) {
04961                     ChildAceCount = ((PACL)AclBuffer)-&gt;AceCount;
04962 
04963                     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( (PACL)AclBuffer, &amp;ChildAcePosition ) ) {
04964                         <span class="keywordflow">return</span> STATUS_BAD_INHERITANCE_ACL;
04965                     }
04966                 }
04967 
04968             <span class="comment">//</span>
04969             <span class="comment">// If the ACL isn't protected,</span>
04970             <span class="comment">//  don't allow NULL ACL semantics.</span>
04971             <span class="comment">//  (those semantics are ambiguous for auto inheritance)</span>
04972             <span class="comment">//</span>
04973             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( AutoInherit &amp;&amp;
04974                         !IsSacl &amp;&amp;
04975                         (ChildGenericControl &amp; (SEP_ACL_PRESENT|SEP_ACL_PROTECTED)) == SEP_ACL_PRESENT ) {
04976                 <span class="keywordflow">return</span> STATUS_INVALID_ACL;
04977 
04978             }
04979 
04980             *NewAclExplicitlyAssigned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04981 
04982         }
04983 
04984     }
04985 
04986     <span class="comment">//</span>
04987     <span class="comment">// Inherit ACEs from the Directory ACL in any of the following cases:</span>
04988     <span class="comment">//  If !AutoInheriting,</span>
04989     <span class="comment">//      Inherit if there is no explicit child ACL (ignoring a defaulted child).</span>
04990     <span class="comment">//  If AutoInheriting,</span>
04991     <span class="comment">//      observe the protected flag.</span>
04992     <span class="comment">//</span>
04993 
04994     <span class="keywordflow">if</span> ( (!AutoInherit &amp;&amp;
04995             (ChildGenericControl &amp; SEP_ACL_PRESENT) == 0 ||
04996                 (ChildGenericControl &amp; SEP_ACL_DEFAULTED) != 0) ||
04997          (AutoInherit &amp;&amp; !AclProtected) ) {
04998 
04999         <span class="comment">//</span>
05000         <span class="comment">//  If there is no directory ACL,</span>
05001         <span class="comment">//      don't inherit from it.</span>
05002         <span class="comment">//</span>
05003 
05004         <span class="keywordflow">if</span> ( DirectoryAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
05005 
05006             <span class="comment">//</span>
05007             <span class="comment">// If the DirectoryAcl is used,</span>
05008             <span class="comment">//  the revision of the Directory ACL is picked up.</span>
05009             <span class="comment">//</span>
05010 
05011             <span class="keywordflow">if</span> ( !ValidAclRevision(DirectoryAcl) ) {
05012                 <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
05013             }
05014 
05015             AclRevision = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( AclRevision, DirectoryAcl-&gt;AclRevision );
05016 
05017             <span class="comment">//</span>
05018             <span class="comment">// Inherit the Parent's ACL.</span>
05019             <span class="comment">//</span>
05020 
05021             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a19">RtlpGenerateInheritAcl</a>(
05022                          DirectoryAcl,
05023                          IsDirectoryObject,
05024                          AutoInherit,
05025                          OwnerSid,
05026                          GroupSid,
05027                          ServerOwnerSid,
05028                          ServerGroupSid,
05029                          GenericMapping,
05030                          NewObjectType,
05031                          &amp;DirectoryNewAclSize,
05032                          (PACL)AclBuffer,
05033                          &amp;ObjectAceInherited );
05034 
05035             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ) {
05036                 AclOverflowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05037                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
05038             }
05039 
05040             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
05041                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05042             }
05043 
05044             <span class="comment">//</span>
05045             <span class="comment">// If the default descriptor for the object should be ditched,</span>
05046             <span class="comment">//  because object specific ACEs were inherited from the directory,</span>
05047             <span class="comment">//  ditch them now.</span>
05048             <span class="comment">//</span>
05049 
05050             <span class="keywordflow">if</span> ( DefaultDescriptorForObject &amp;&amp;
05051                  ChildNewAclSize != 0 &amp;&amp;
05052                  ObjectAceInherited &amp;&amp;
05053                  !AclOverflowed ) {
05054 
05055                 <span class="comment">//</span>
05056                 <span class="comment">// Compute the last used byte of the combined ACL</span>
05057                 <span class="comment">//</span>
05058                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( (PACL)AclBuffer, &amp;DirectoryAcePosition ) ) {
05059                     <span class="keywordflow">return</span> STATUS_BAD_INHERITANCE_ACL;
05060                 }
05061                 <span class="keywordflow">if</span> ( DirectoryAcePosition == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
05062                     DirectoryAcePosition = AclBuffer + ((PACL)AclBuffer)-&gt;AclSize;
05063                 }
05064 
05065 
05066 
05067                 <span class="comment">//</span>
05068                 <span class="comment">// Move all the inherited ACEs to the front of the ACL.</span>
05069                 <span class="comment">//</span>
05070 
05071                 RtlMoveMemory( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( AclBuffer ),
05072                                ChildAcePosition,
05073                                (ULONG)(((PUCHAR)DirectoryAcePosition) -
05074                                 (PUCHAR)ChildAcePosition) );
05075 
05076                 <span class="comment">//</span>
05077                 <span class="comment">// Adjust the ACE count to remove the deleted ACEs</span>
05078                 <span class="comment">//</span>
05079 
05080                 ((PACL)AclBuffer)-&gt;AceCount -= ChildAceCount;
05081 
05082                 <span class="comment">//</span>
05083                 <span class="comment">// Save the number of bytes of the Child ACL that were</span>
05084                 <span class="comment">//  actually used.</span>
05085                 <span class="comment">//</span>
05086 
05087                 UsedChildNewAclSize = 0;
05088 
05089             }
05090         }
05091 
05092     }
05093 
05094     <span class="comment">//</span>
05095     <span class="comment">// If this routine didn't build the ACL,</span>
05096     <span class="comment">//  tell the caller.</span>
05097     <span class="comment">//</span>
05098 
05099     <span class="keywordflow">if</span> ( DirectoryNewAclSize + UsedChildNewAclSize == 0) {
05100 
05101         <span class="comment">//</span>
05102         <span class="comment">// If the ACL was not explicitly assigned,</span>
05103         <span class="comment">//  tell the caller to default the ACL.</span>
05104         <span class="comment">//</span>
05105         <span class="keywordflow">if</span> ( !(*NewAclExplicitlyAssigned) ) {
05106             *AclBufferSize = 0;
05107             <span class="keywordflow">return</span> STATUS_NO_INHERITANCE;
05108 
05109         <span class="comment">//</span>
05110         <span class="comment">// If the Acl was explictly assigned,</span>
05111         <span class="comment">//  generate a NULL ACL based on the path taken above.</span>
05112         <span class="comment">//</span>
05113 
05114         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( NullAclOk ) {
05115             *AclBufferSize = 0;
05116             <span class="keywordflow">return</span> STATUS_SUCCESS;
05117         }
05118 
05119         <span class="comment">// DbgBreakPoint();</span>
05120     }
05121 
05122 
05123     <span class="comment">//</span>
05124     <span class="comment">// And make sure we don't exceed the length limitations of an ACL (WORD)</span>
05125     <span class="comment">//</span>
05126 
05127     <span class="keywordflow">if</span> ( DirectoryNewAclSize + UsedChildNewAclSize + <span class="keyword">sizeof</span>(ACL) &gt; 0xFFFF) {
05128         <span class="keywordflow">return</span>(STATUS_BAD_INHERITANCE_ACL);
05129     }
05130 
05131     <span class="comment">// BUGBUG: The caller has to allocate a buffer large enough for</span>
05132     <span class="comment">// ChildNewAclSize rather than UsedChildNewAclSize.  Due to the nature of</span>
05133     <span class="comment">// my algorithm above.</span>
05134     (*AclBufferSize) = DirectoryNewAclSize + ChildNewAclSize + <span class="keyword">sizeof</span>(ACL);
05135 
05136     <span class="keywordflow">if</span> ( AclOverflowed ) {
05137         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
05138     }
05139 
05140     <span class="comment">//</span>
05141     <span class="comment">// Patch the real ACL size and revision into the ACL</span>
05142     <span class="comment">//</span>
05143 
05144     ((PACL)AclBuffer)-&gt;AclSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
05145         (DirectoryNewAclSize + UsedChildNewAclSize + <span class="keyword">sizeof</span>(ACL));
05146     ((PACL)AclBuffer)-&gt;AclRevision = (UCHAR) AclRevision;
05147 
05148     <span class="keywordflow">return</span> STATUS_SUCCESS;
05149 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="sertl.c::RtlpIsDuplicateAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpIsDuplicateAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l08362">8362</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06972">RtlpCompareAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00368">RtlpVerboseConvert</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l05381">RtlpGenerateInheritedAce()</a>.
<p>
<pre class="fragment"><div>08370                    :
08371 
08372     This routine determine <span class="keywordflow">if</span> an ACE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a duplicate of an ACE already in an
08373     ACL.  If so, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewAce can be removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
08374 
08375     This routine currently <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> detects duplicate version 4 ACEs.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
08376     ACE isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> version 4, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE will be declared to be a non-duplicate.
08377 
08378     This routine <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> detects duplicate INHERTED ACEs.
08379 
08380 Arguments:
08381 
08382     Acl - Existing ACL
08383 
08384     NewAce - Ace to determine <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in Acl.
08385         NewAce <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last ACE in <span class="stringliteral">"Acl"</span>.
08386 
08387     ObjectType - GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> represented by Acl.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
08388         has no GUID associated with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
08389         specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
08390 
08391 Return Value:
08392 
08393     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - NewAce <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a duplicate of another ACE on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl
08394     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - NewAce <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT a duplicate of another ACE on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl
08395 
08396 --*/
08397 
08398 {
08399     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
08400     BOOLEAN RetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08401 
08402     LONG AceIndex;
08403 
08404     ACCESS_MASK NewAceContainerInheritMask;
08405     ACCESS_MASK NewAceObjectInheritMask;
08406     ACCESS_MASK NewAceEffectiveMask;
08407 
08408     ACCESS_MASK LocalMask;
08409 
08410     <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> AceFromAcl;
08411 
08412     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
08413 
08414 
08415     <span class="comment">//</span>
08416     <span class="comment">// Ensure the passed in ACE is one this routine understands</span>
08417     <span class="comment">//</span>
08418 
08419     <span class="keywordflow">if</span> ( !IsV4AceType(NewAce) || IsCompoundAceType(NewAce)) {
08420 <span class="preprocessor">#if DBG</span>
08421 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08422             KdPrint((<span class="stringliteral">"New Ace type (%ld) not known\n"</span>, NewAce-&gt;Header.AceType ));
08423         }
08424 <span class="preprocessor">#endif // DBG</span>
08425 <span class="preprocessor"></span>        RetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08426         <span class="keywordflow">goto</span> Cleanup;
08427     }
08428 
08429     <span class="comment">//</span>
08430     <span class="comment">// This routine only works for ACEs marked as INHERITED.</span>
08431     <span class="comment">//</span>
08432 
08433     <span class="keywordflow">if</span> ( (NewAce-&gt;Header.AceFlags &amp; INHERITED_ACE ) == 0 ) {
08434 <span class="preprocessor">#if DBG</span>
08435 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08436             KdPrint((<span class="stringliteral">"New Ace type isn't inherited\n"</span> ));
08437         }
08438 <span class="preprocessor">#endif // DBG</span>
08439 <span class="preprocessor"></span>        RetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08440         <span class="keywordflow">goto</span> Cleanup;
08441     }
08442 
08443 
08444     <span class="comment">//</span>
08445     <span class="comment">// Break the new ACE into its component parts.</span>
08446     <span class="comment">//</span>
08447     <span class="comment">// All V4 aces have an access mask in the same location.</span>
08448     <span class="comment">//</span>
08449     LocalMask = ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)(NewAce))-&gt;Mask;
08450 
08451     <span class="keywordflow">if</span> ( NewAce-&gt;Header.AceFlags &amp; CONTAINER_INHERIT_ACE ) {
08452         NewAceContainerInheritMask = LocalMask;
08453     } <span class="keywordflow">else</span> {
08454         NewAceContainerInheritMask = 0;
08455     }
08456 
08457     <span class="keywordflow">if</span> ( NewAce-&gt;Header.AceFlags &amp; OBJECT_INHERIT_ACE ) {
08458         NewAceObjectInheritMask = LocalMask;
08459     } <span class="keywordflow">else</span> {
08460         NewAceObjectInheritMask = 0;
08461     }
08462 
08463     <span class="keywordflow">if</span> ( (NewAce-&gt;Header.AceFlags &amp; INHERIT_ONLY_ACE) == 0 ) {
08464         NewAceEffectiveMask = LocalMask;
08465     } <span class="keywordflow">else</span> {
08466         NewAceEffectiveMask = 0;
08467     }
08468 <span class="preprocessor">#if DBG</span>
08469 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08470         KdPrint((<span class="stringliteral">"Starting MASKs:  %8.8lX %8.8lX %8.8lX"</span>, NewAceEffectiveMask, NewAceContainerInheritMask, NewAceObjectInheritMask ));
08471     }
08472 <span class="preprocessor">#endif // DBG</span>
08473 <span class="preprocessor"></span>
08474 
08475 
08476 
08477     <span class="comment">//</span>
08478     <span class="comment">// Walk through the ACL one ACE at a time.</span>
08479     <span class="comment">//</span>
08480 
08481     <span class="keywordflow">for</span> (AceIndex = 0, AceFromAcl = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(Acl);
08482          AceIndex &lt; Acl-&gt;AceCount-1;    <span class="comment">// NewAce is the last ACE</span>
08483          AceIndex += 1, AceFromAcl = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(AceFromAcl)) {
08484 
08485 
08486         <span class="comment">//</span>
08487         <span class="comment">// If the ACE isn't a valid version 4 ACE,</span>
08488         <span class="comment">//  this isn't an ACE we're interested in handling.</span>
08489         <span class="comment">//</span>
08490 
08491         <span class="keywordflow">if</span> ( !IsV4AceType(AceFromAcl) || IsCompoundAceType(AceFromAcl)) {
08492             <span class="keywordflow">continue</span>;
08493         }
08494 
08495         <span class="comment">//</span>
08496         <span class="comment">// This routine only works for ACEs marked as INHERITED.</span>
08497         <span class="comment">//</span>
08498 
08499         <span class="keywordflow">if</span> ( (AceFromAcl-&gt;Header.AceFlags &amp; INHERITED_ACE ) == 0 ) {
08500             <span class="keywordflow">continue</span>;
08501         }
08502 
08503 
08504         <span class="comment">//</span>
08505         <span class="comment">// Compare the Ace from the ACL with the New ACE</span>
08506         <span class="comment">//</span>
08507         <span class="comment">//  Don't stop simply because we've matched once.</span>
08508         <span class="comment">//  Multiple ACEs in the one ACL may have been condensed into a single ACE</span>
08509         <span class="comment">//  in the other ACL in any combination (by any of our friendly ACL editors).</span>
08510         <span class="comment">//</span>
08511 <span class="preprocessor">#if DBG</span>
08512 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08513             KdPrint((<span class="stringliteral">"Compare Ace: %ld "</span>, AceIndex ));
08514         }
08515 <span class="preprocessor">#endif // DBG</span>
08516 <span class="preprocessor"></span>
08517         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a23">RtlpCompareAces</a>( AceFromAcl,
08518                               NewAce,
08519                               NULL,
08520                               NULL ) ) {
08521 
08522 
08523             <span class="comment">//</span>
08524             <span class="comment">// Match the bits from the current ACE with bits from the New ACE.</span>
08525             <span class="comment">//</span>
08526             <span class="comment">// All V4 aces have an access mask in the same location.</span>
08527             <span class="comment">//</span>
08528 
08529             LocalMask = ((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)(AceFromAcl))-&gt;Mask;
08530 
08531             <span class="keywordflow">if</span> ( AceFromAcl-&gt;Header.AceFlags &amp; CONTAINER_INHERIT_ACE ) {
08532                 NewAceContainerInheritMask &amp;= ~LocalMask;
08533             }
08534 
08535             <span class="keywordflow">if</span> ( AceFromAcl-&gt;Header.AceFlags &amp; OBJECT_INHERIT_ACE ) {
08536                 NewAceObjectInheritMask &amp;= ~LocalMask;
08537             }
08538 
08539             <span class="keywordflow">if</span> ( (AceFromAcl-&gt;Header.AceFlags &amp; INHERIT_ONLY_ACE) == 0 ) {
08540                 NewAceEffectiveMask &amp;= ~LocalMask;
08541             }
08542 
08543 <span class="preprocessor">#if DBG</span>
08544 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08545                 KdPrint((<span class="stringliteral">"Remaining MASKs:  %8.8lX %8.8lX %8.8lX"</span>, NewAceEffectiveMask, NewAceContainerInheritMask, NewAceObjectInheritMask ));
08546             }
08547 <span class="preprocessor">#endif // DBG</span>
08548 <span class="preprocessor"></span>
08549             <span class="comment">//</span>
08550             <span class="comment">// If all bits have been matched in the New Ace,</span>
08551             <span class="comment">//  then this is a duplicate ACE.</span>
08552             <span class="comment">//</span>
08553 
08554             <span class="keywordflow">if</span> ( (NewAceEffectiveMask | NewAceContainerInheritMask | NewAceObjectInheritMask) == 0 ) {
08555 <span class="preprocessor">#if DBG</span>
08556 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08557                     KdPrint((<span class="stringliteral">"\n"</span>));
08558                 }
08559 <span class="preprocessor">#endif // DBG</span>
08560 <span class="preprocessor"></span>                RetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08561                 <span class="keywordflow">goto</span> Cleanup;
08562             }
08563         }
08564 <span class="preprocessor">#if DBG</span>
08565 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> ) {
08566               KdPrint((<span class="stringliteral">"\n"</span>));
08567         }
08568 <span class="preprocessor">#endif // DBG</span>
08569 <span class="preprocessor"></span>
08570 
08571     }
08572 
08573     <span class="comment">//</span>
08574     <span class="comment">// All of the ACEs of the ACL have been processed.</span>
08575     <span class="comment">//</span>
08576     <span class="comment">// We haven't matched all of the bits in the New Ace so this is not a duplicate ACE.</span>
08577     <span class="comment">//</span>
08578 
08579     RetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08580 Cleanup:
08581 
08582     <span class="keywordflow">return</span> RetVal;
08583 
08584 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="sertl.c::RtlpNewSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpNewSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR ParentDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR CreatorDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInheritFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">9057</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00231">NtPrivilegeCheck()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02004">RtlCreateSecurityDescriptorRelative()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03812">RtlpApplyAclToObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08588">RtlpCreateServerAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08795">RtlpGetDefaultsSubjectContext()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05153">RtlpInheritAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03544">RtlpValidOwnerSubjectContext()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">SE_TAG</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00234">SepGetDefaultsSubjectContext()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00158">SePrivilegeCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00989">SePrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00381">SepValidOwnerSubjectContext()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01676">SeSecurityPrivilege</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00280">RtlNewSecurityObject()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00226">RtlNewSecurityObjectEx()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00089">SeAssignSecurity()</a>, and <a class="el" href="../../d2/d4/seassign_8c-source.html#l00228">SeAssignSecurityEx()</a>.
<p>
<pre class="fragment"><div>09069                    :
09070 
09071     The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to allocate and initialize a <span class="keyword">self</span>-relative
09072     Security Descriptor <span class="keywordflow">for</span> a <span class="keyword">new</span> <span class="keyword">protected</span> server's object.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called
09073     when a <span class="keyword">new</span> <span class="keyword">protected</span> server object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being created.  The generated
09074     security descriptor will be in <span class="keyword">self</span>-relative form.
09075 
09076     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>, called <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> from user mode, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to establish a
09077     security descriptor <span class="keywordflow">for</span> a <span class="keyword">new</span> <span class="keyword">protected</span> server's object.  Memory <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
09078     allocated to hold each of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor's components (<span class="keyword">using</span>
09079     <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>()).  The <span class="keyword">final</span> security descriptor generated by
09080     <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> produced according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rules stated in ???
09081 
09082     System and Discretionary ACL Assignment
09083     ---------------------------------------
09084 
09085     The assignment of system and discretionary ACLs <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> governed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09086     logic illustrated in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following table:
09087 
09088                  |  Explicit      |  Explicit     |
09089                  | (non-<span class="keywordflow">default</span>)  |  Default      |   No
09090                  |  Acl           |  Acl          |   Acl
09091                  |  Specified     |  Specified    |   Specified
09092     -------------+----------------+---------------+--------------
09093                  |                |               |
09094     Inheritable  | Assign         |  Assign       | Assign
09095     Acl From     | Specified      |  Inherited    | Inherited
09096     Parent       | Acl(1)(2)      |  Acl          | Acl
09097                  |                |               |
09098     -------------+----------------+---------------+--------------
09099     No           |                |               |
09100     Inheritable  | Assign         |  Assign       | Assign
09101     Acl From     | Specified      |  Default      | No Acl
09102     Parent       | Acl(1)         |  Acl          |
09103                  |                |               |
09104     -------------+----------------+---------------+--------------
09105 
09106     (1) Any ACEs with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> INHERITED_ACE bit set are NOT copied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assigned
09107     security descriptor.
09108 
09109     (2) If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AutoInheritFlags <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flagged to automatically inherit ACEs from
09110     parent (SEF_DACL_AUTO_INHERIT or SEF_SACL_AUTO_INHERIT), inherited
09111     ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent will be appended after <span class="keyword">explicit</span> ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09112     CreatorDescriptor.
09113 
09114 
09115     Note that an explicitly specified ACL, whether a <span class="keywordflow">default</span> ACL or
09116     not, may be empty or null.
09117 
09118     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explicitly assigning a system acl, <span class="keywordflow">default</span> or
09119     non-<span class="keywordflow">default</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must either be a kernel mode client or
09120     must be appropriately privileged.
09121 
09122 
09123     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> and <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> Assignment
09124     --------------------------
09125 
09126     The assignment of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object's owner and group <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> governed
09127     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following logic:
09128 
09129        1)   If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed security descriptor includes an owner, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
09130             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object's owner.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09131             caller's token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> looked in <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner.  Within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09132             token, <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keywordflow">default</span> owner, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assigned.
09133             Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's user <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assigned.
09134 
09135        2)   If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed security descriptor includes a group, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
09136             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object's group.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09137             caller's token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> looked in <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group.  Within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09138             token, <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keywordflow">default</span> group, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assigned.
09139             Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's primary group <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assigned.
09140 
09141 
09142 Arguments:
09143 
09144     ParentDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Security Descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
09145         directory under which a <span class="keyword">new</span> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being created.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
09146         no parent directory, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
09147 
09148     CreatorDescriptor - (Optionally) Points to a security descriptor
09149         presented by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creator of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creator of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09150         object did not explicitly pass security information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
09151         object, then a null pointer should be passed.
09152 
09153     NewDescriptor - Points to a pointer that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09154         newly allocated <span class="keyword">self</span>-relative security descriptor.
09155 
09156     ObjectType - GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being created.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being
09157         created has no GUID associated with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
09158         specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
09159 
09160     IsDirectoryObject - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to be a
09161         directory object.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
09162         container of other objects.
09163 
09164     AutoInheritFlags - Controls automatic inheritance of ACES from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Parent
09165         Descriptor.  Valid values are a bits mask of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logical OR of
09166         one or more of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following bits:
09167 
09168         SEF_DACL_AUTO_INHERIT - If set, inherit ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09169             DACL ParentDescriptor are inherited to NewDescriptor in addition
09170             to any <span class="keyword">explicit</span> ACEs specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor.
09171 
09172         SEF_SACL_AUTO_INHERIT - If set, inherit ACEs from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09173             SACL ParentDescriptor are inherited to NewDescriptor in addition
09174             to any <span class="keyword">explicit</span> ACEs specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor.
09175 
09176         SEF_DEFAULT_DESCRIPTOR_FOR_OBJECT - If set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor
09177             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> descriptor <span class="keywordflow">for</span> ObjectType.  As such, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09178             CreatorDescriptor will be ignored <span class="keywordflow">if</span> any ObjectType specific
09179             ACEs are inherited from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent.  If no such ACEs are inherited,
09180             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled as though <span class="keyword">this</span> flag were not
09181             specified.
09182 
09183         SEF_AVOID_PRIVILEGE_CHECK - If set, no privilege checking <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by <span class="keyword">this</span>
09184             routine.  This flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> useful <span class="keywordflow">while</span> implementing automatic inheritance
09185             to avoid checking privileges on each child updated.
09186 
09187         SEF_AVOID_OWNER_CHECK - If set, no owner checking <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by <span class="keyword">this</span> routine.
09188 
09189         SEF_DEFAULT_OWNER_FROM_PARENT - If set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of NewDescriptor will
09190             <span class="keywordflow">default</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner from ParentDescriptor.  If not set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner
09191             of NewDescriptor will <span class="keywordflow">default</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user specified in <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>.
09192 
09193             In either <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of NewDescriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner from
09194             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor <span class="keywordflow">if</span> that field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.
09195 
09196         SEF_DEFAULT_GROUP_FROM_PARENT - If set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group of NewDescriptor will
09197             <span class="keywordflow">default</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group from ParentDescriptor.  If not set, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group
09198             of NewDescriptor will <span class="keywordflow">default</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group specified in <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>.
09199 
09200             In either <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group of NewDescriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group from
09201             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CreatorDescriptor <span class="keywordflow">if</span> that field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.
09202 
09203     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client on whose behalf <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09204         object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being created.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an impersonation token,
09205         then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be at SecurityIdentification level or higher.  If
09206         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an impersonation token, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation proceeds
09207         normally.
09208 
09209         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> client token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to retrieve <span class="keywordflow">default</span> security
09210         information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object, such as <span class="keywordflow">default</span> owner, primary
09211         group, and discretionary access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.  The token must be
09212         open <span class="keywordflow">for</span> TOKEN_QUERY access.
09213 
09214         For calls from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel, Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject creating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09215         object. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to retrieve <span class="keywordflow">default</span> security information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09216         <span class="keyword">new</span> object, such as <span class="keywordflow">default</span> owner, primary group, and discretionary
09217         access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
09218 
09219         If not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> and Primary group must be specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09220         CreatorDescriptor.
09221 
09222     GenericMapping - Supplies a pointer to a generic mapping array denoting
09223         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping between each generic right to specific rights.
09224 
09225 Return Value:
09226 
09227     STATUS_SUCCESS - The operation was successful.
09228 
09229     STATUS_INVALID_OWNER - The owner SID provided as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09230         target security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not one <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> authorized to
09231         assign as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of an object.
09232 
09233     STATUS_NO_CLIENT_TOKEN - Indicates a client token was not explicitly
09234         provided and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently impersonating a client.
09235 
09236     STATUS_PRIVILEGE_NOT_HELD - The caller does not have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege
09237         necessary to explicitly assign <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified system ACL.
09238         <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to explicitly assign
09239         system ACLs to objects.
09240 
09241 
09242 --*/
09243 {
09244 
09245 
09246     SECURITY_DESCRIPTOR *CapturedDescriptor;
09247     SECURITY_DESCRIPTOR InCaseOneNotPassed;
09248     BOOLEAN SecurityDescriptorPassed;
09249 
09250     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
09251 
09252     PACL NewSacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09253     BOOLEAN NewSaclInherited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09254 
09255     PACL NewDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09256     PACL ServerDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09257     BOOLEAN NewDaclInherited = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09258 
09259     PSID NewOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09260     PSID NewGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09261 
09262     BOOLEAN SaclExplicitlyAssigned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09263     BOOLEAN OwnerExplicitlyAssigned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09264     BOOLEAN DaclExplicitlyAssigned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09265 
09266     BOOLEAN ServerDaclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09267 
09268     BOOLEAN ServerObject;
09269     BOOLEAN DaclUntrusted;
09270 
09271     BOOLEAN HasPrivilege;
09272     PRIVILEGE_SET PrivilegeSet;
09273 
09274     PSID SubjectContextOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09275     PSID SubjectContextGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09276     PSID ServerOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09277     PSID ServerGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09278 
09279     PACL SubjectContextDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09280 
09281     ULONG AllocationSize;
09282     ULONG NewOwnerSize;
09283     ULONG NewGroupSize;
09284     ULONG NewSaclSize;
09285     ULONG NewDaclSize;
09286 
09287     PCHAR Field;
09288     PCHAR Base;
09289 
09290 
09291 
09292     PISECURITY_DESCRIPTOR_RELATIVE INewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> PassedStatus;
09294     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode;
09295 
09296     ULONG GenericControl;
09297     ULONG NewControlBits = SE_SELF_RELATIVE;
09298 
09299 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
09300 <span class="preprocessor"></span>    PTOKEN_OWNER         TokenOwnerInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09301     PTOKEN_PRIMARY_GROUP TokenPrimaryGroupInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09302     PTOKEN_DEFAULT_DACL  TokenDefaultDaclInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09303 
09304     PTOKEN_OWNER         ServerOwnerInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09305     PTOKEN_PRIMARY_GROUP ServerGroupInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09306     PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
09307 
09308 <span class="preprocessor">#else</span>
09309 <span class="preprocessor"></span>
09310     <span class="comment">//</span>
09311     <span class="comment">// For kernel mode callers, the Token parameter is really</span>
09312     <span class="comment">// a pointer to a subject context structure.</span>
09313     <span class="comment">//</span>
09314 
09315     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
09316     PVOID SubjectContextInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09317 
09318     SubjectSecurityContext = (<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
09319 
09320 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
09321 <span class="preprocessor"></span>
09322 
09323 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
09324 <span class="preprocessor"></span>    <span class="comment">//</span>
09325     <span class="comment">//  Get the previous mode of the caller</span>
09326     <span class="comment">//</span>
09327 
09328     RequestorMode = KeGetPreviousMode();
09329 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
09330 <span class="preprocessor"></span>    RequestorMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
09331 
09332     <span class="comment">//</span>
09333     <span class="comment">// Get the handle to the current process heap</span>
09334     <span class="comment">//</span>
09335 
09336     <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
09337 
09338     <span class="comment">//</span>
09339     <span class="comment">// Ensure the token is an impersonation token.</span>
09340     <span class="comment">//</span>
09341     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
09342         TOKEN_STATISTICS    ThreadTokenStatistics;
09343         ULONG ReturnLength;
09344 
09345         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
09346                      Token,                        <span class="comment">// Handle</span>
09347                      TokenStatistics,              <span class="comment">// TokenInformationClass</span>
09348                      &amp;ThreadTokenStatistics,       <span class="comment">// TokenInformation</span>
09349                      <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
09350                      &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
09351                      );
09352 
09353         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
09354             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
09355         }
09356 
09357         <span class="comment">//</span>
09358         <span class="comment">//  If it is an impersonation token, then make sure it is at a</span>
09359         <span class="comment">//  high enough level.</span>
09360         <span class="comment">//</span>
09361 
09362         <span class="keywordflow">if</span> (ThreadTokenStatistics.TokenType == TokenImpersonation) {
09363 
09364             <span class="keywordflow">if</span> (ThreadTokenStatistics.ImpersonationLevel &lt; SecurityIdentification ) {
09365 
09366                 <span class="keywordflow">return</span>( STATUS_BAD_IMPERSONATION_LEVEL );
09367             }
09368         }
09369 
09370     }
09371 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
09372 <span class="preprocessor"></span>
09373 
09374     <span class="comment">//</span>
09375     <span class="comment">//  The desired end result is to build a self-relative security descriptor.</span>
09376     <span class="comment">//  This means that a single block of memory will be allocated and all</span>
09377     <span class="comment">//  security information copied into it.  To minimize work along the way,</span>
09378     <span class="comment">//  it is desirable to reference (rather than copy) each field as we</span>
09379     <span class="comment">//  determine its source.  This can not be done with inherited ACLs, however,</span>
09380     <span class="comment">//  since they must be built from another ACL.  So, explicitly assigned</span>
09381     <span class="comment">//  and defaulted SIDs and ACLs are just referenced until they are copied</span>
09382     <span class="comment">//  into the self-relative descriptor.  Inherited ACLs are built in a</span>
09383     <span class="comment">//  temporary buffer which must be deallocated after being copied to the</span>
09384     <span class="comment">//  self-relative descriptor.</span>
09385     <span class="comment">//</span>
09386 
09387 
09388 
09389     <span class="comment">//</span>
09390     <span class="comment">//  If a security descriptor has been passed, capture it, otherwise</span>
09391     <span class="comment">//  cobble up a fake one to simplify the code that follows.</span>
09392     <span class="comment">//</span>
09393 
09394     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CreatorDescriptor)) {
09395 
09396         CapturedDescriptor = CreatorDescriptor;
09397         SecurityDescriptorPassed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09398 
09399     } <span class="keywordflow">else</span> {
09400 
09401         <span class="comment">//</span>
09402         <span class="comment">//  No descriptor passed, make a fake one</span>
09403         <span class="comment">//</span>
09404 
09405         SecurityDescriptorPassed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09406 
09407         <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(&amp;InCaseOneNotPassed,
09408                                     SECURITY_DESCRIPTOR_REVISION);
09409         CapturedDescriptor = &amp;InCaseOneNotPassed;
09410 
09411     }
09412 
09413 
09414     <span class="keywordflow">if</span> ( CapturedDescriptor-&gt;Control &amp; SE_SERVER_SECURITY ) {
09415         ServerObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09416     } <span class="keywordflow">else</span> {
09417         ServerObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09418     }
09419 
09420     <span class="keywordflow">if</span> ( CapturedDescriptor-&gt;Control &amp; SE_DACL_UNTRUSTED ) {
09421         DaclUntrusted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09422     } <span class="keywordflow">else</span> {
09423         DaclUntrusted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09424     }
09425 
09426 
09427 
09428     <span class="comment">//</span>
09429     <span class="comment">// Get the required information from the token.</span>
09430     <span class="comment">//</span>
09431     <span class="comment">//</span>
09432     <span class="comment">// Grab pointers to the default owner, primary group, and</span>
09433     <span class="comment">// discretionary ACL.</span>
09434     <span class="comment">//</span>
09435     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ServerObject ) {
09436 
09437 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
09438 <span class="preprocessor"></span>
09439         PSID TmpSubjectContextOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09440         PSID TmpSubjectContextGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09441         PSID TmpServerOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09442         PSID TmpServerGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09443 
09444         PACL TmpSubjectContextDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09445 
09446         SIZE_T SubjectContextInfoSize = 0;
09447 
09448         <span class="comment">//</span>
09449         <span class="comment">// Lock the subject context for read access so that the pointers</span>
09450         <span class="comment">// we copy out of it don't disappear on us at random</span>
09451         <span class="comment">//</span>
09452 
09453         <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( SubjectSecurityContext );
09454 
09455         <a class="code" href="../../d0/d8/subject_8c.html#a4">SepGetDefaultsSubjectContext</a>(
09456             SubjectSecurityContext,
09457             &amp;TmpSubjectContextOwner,
09458             &amp;TmpSubjectContextGroup,
09459             &amp;TmpServerOwner,
09460             &amp;TmpServerGroup,
09461             &amp;TmpSubjectContextDacl
09462             );
09463 
09464         <span class="comment">//</span>
09465         <span class="comment">// We can't keep the subject context locked, because</span>
09466         <span class="comment">// we may have to do a privilege check later, which calls</span>
09467         <span class="comment">// PsLockProcessSecurityFields, which can cause a deadlock</span>
09468         <span class="comment">// with PsImpersonateClient, which takes them in the reverse</span>
09469         <span class="comment">// order.</span>
09470         <span class="comment">//</span>
09471         <span class="comment">// Since we're giving up our read lock on the token, we</span>
09472         <span class="comment">// need to copy all the stuff that we just got back.  Since</span>
09473         <span class="comment">// it's not going to change, we can save some cycles and copy</span>
09474         <span class="comment">// it all into a single chunck of memory.</span>
09475         <span class="comment">//</span>
09476 
09477         SubjectContextInfoSize = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpSubjectContextOwner ) +
09478                                  <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpServerOwner )         +
09479                                  (TmpSubjectContextGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpSubjectContextGroup ) : 0) +
09480                                  (TmpServerGroup         != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpServerGroup )         : 0) +
09481                                  (TmpSubjectContextDacl  != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? TmpSubjectContextDacl-&gt;AclSize        : 0);
09482 
09483         SubjectContextInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, SubjectContextInfoSize, 'dSeS');
09484 
09485         <span class="keywordflow">if</span> (SubjectContextInfo) {
09486 
09487             <span class="comment">//</span>
09488             <span class="comment">// Copy in the data</span>
09489             <span class="comment">//</span>
09490 
09491             Base = SubjectContextInfo;
09492 
09493             <span class="comment">//</span>
09494             <span class="comment">// There will always be an owner.</span>
09495             <span class="comment">//</span>
09496 
09497             SubjectContextOwner = (PSID)Base;
09498             <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpSubjectContextOwner), Base, TmpSubjectContextOwner );
09499             Base += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpSubjectContextOwner);
09500 
09501             <span class="comment">//</span>
09502             <span class="comment">// Groups may be NULL</span>
09503             <span class="comment">//</span>
09504 
09505             <span class="keywordflow">if</span> (TmpSubjectContextGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09506                 SubjectContextGroup = (PSID)Base;
09507                 <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpSubjectContextGroup), Base, TmpSubjectContextGroup );
09508                 Base += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpSubjectContextGroup );
09509             } <span class="keywordflow">else</span> {
09510                 SubjectContextGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09511             }
09512 
09513             ServerOwner = (PSID)Base;
09514             <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpServerOwner ), Base, TmpServerOwner );
09515             Base += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpServerOwner );
09516 
09517             <span class="comment">//</span>
09518             <span class="comment">// Groups may be NULL</span>
09519             <span class="comment">//</span>
09520 
09521             <span class="keywordflow">if</span> (TmpServerGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09522                 ServerGroup = (PSID)Base;
09523                 <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpServerGroup ), Base, TmpServerGroup );
09524                 Base += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TmpServerGroup );
09525             } <span class="keywordflow">else</span> {
09526                 ServerGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09527             }
09528 
09529             <span class="keywordflow">if</span> (TmpSubjectContextDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09530                 SubjectContextDacl = (PACL)Base;
09531                 RtlCopyMemory( Base, TmpSubjectContextDacl, TmpSubjectContextDacl-&gt;AclSize );
09532                 <span class="comment">// Base += TmpSubjectContextDacl-&gt;AclSize;</span>
09533             } <span class="keywordflow">else</span> {
09534                 SubjectContextDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09535             }
09536 
09537         } <span class="keywordflow">else</span> {
09538 
09539             <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( SubjectSecurityContext );
09540 
09541             <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
09542         }
09543 
09544         <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( SubjectSecurityContext );
09545 
09546 
09547 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
09548 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a28">RtlpGetDefaultsSubjectContext</a>(
09549                      Token,
09550                      &amp;TokenOwnerInfo,
09551                      &amp;TokenPrimaryGroupInfo,
09552                      &amp;TokenDefaultDaclInfo,
09553                      &amp;ServerOwnerInfo,
09554                      &amp;ServerGroupInfo
09555                      );
09556 
09557         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
09558             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
09559         }
09560 
09561         SubjectContextOwner = TokenOwnerInfo-&gt;Owner;
09562         SubjectContextGroup = TokenPrimaryGroupInfo-&gt;PrimaryGroup;
09563         SubjectContextDacl  = TokenDefaultDaclInfo-&gt;DefaultDacl;
09564         ServerOwner         = ServerOwnerInfo-&gt;Owner;
09565         ServerGroup         = ServerGroupInfo-&gt;PrimaryGroup;
09566 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
09567 <span class="preprocessor"></span>    }
09568 
09569 
09570 
09571     <span class="comment">//</span>
09572     <span class="comment">// Establish an owner SID</span>
09573     <span class="comment">//</span>
09574 
09575     NewOwner = RtlpOwnerAddrSecurityDescriptor(CapturedDescriptor);
09576 
09577     <span class="keywordflow">if</span> ((NewOwner) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09578 
09579         <span class="comment">//</span>
09580         <span class="comment">// Use the specified owner</span>
09581         <span class="comment">//</span>
09582 
09583         OwnerExplicitlyAssigned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09584 
09585     } <span class="keywordflow">else</span> {
09586 
09587         <span class="comment">//</span>
09588         <span class="comment">// If the caller said to default the owner from the parent descriptor,</span>
09589         <span class="comment">//  grab it now.</span>
09590         <span class="comment">//</span>
09591 
09592         <span class="keywordflow">if</span> ( AutoInheritFlags &amp; SEF_DEFAULT_OWNER_FROM_PARENT) {
09593             <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT(ParentDescriptor) ) {
09594                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OWNER;
09595                 <span class="keywordflow">goto</span> Cleanup;
09596             }
09597             NewOwner = RtlpOwnerAddrSecurityDescriptor((SECURITY_DESCRIPTOR *)ParentDescriptor);
09598             OwnerExplicitlyAssigned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09599 
09600             <span class="keywordflow">if</span> ( NewOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
09601                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OWNER;
09602                 <span class="keywordflow">goto</span> Cleanup;
09603             }
09604         } <span class="keywordflow">else</span> {
09605 
09606             <span class="comment">//</span>
09607             <span class="comment">// Pick up the default from the subject's security context.</span>
09608             <span class="comment">//</span>
09609             <span class="comment">// This does NOT constitute explicit assignment of owner</span>
09610             <span class="comment">// and does not have to be checked as an ID that can be</span>
09611             <span class="comment">// assigned as owner.  This is because a default can not</span>
09612             <span class="comment">// be established in a token unless the user of the token</span>
09613             <span class="comment">// can assign it as an owner.</span>
09614             <span class="comment">//</span>
09615 
09616             <span class="comment">//</span>
09617             <span class="comment">// If we've been asked to create a ServerObject, we need to</span>
09618             <span class="comment">// make sure to pick up the new owner from the Primary token,</span>
09619             <span class="comment">// not the client token.  If we're not impersonating, they will</span>
09620             <span class="comment">// end up being the same.</span>
09621             <span class="comment">//</span>
09622 
09623             NewOwner = ServerObject ? ServerOwner : SubjectContextOwner;
09624 
09625             <span class="comment">//</span>
09626             <span class="comment">// Ensure an owner is now defined.</span>
09627             <span class="comment">//</span>
09628 
09629             <span class="keywordflow">if</span> ( NewOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
09630                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_TOKEN;
09631                 <span class="keywordflow">goto</span> Cleanup;
09632             }
09633         }
09634     }
09635 
09636 
09637     <span class="comment">//</span>
09638     <span class="comment">// Establish a Group SID</span>
09639     <span class="comment">//</span>
09640 
09641     NewGroup = RtlpGroupAddrSecurityDescriptor(CapturedDescriptor);
09642 
09643     <span class="keywordflow">if</span> (NewGroup == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09644 
09645         <span class="comment">//</span>
09646         <span class="comment">// If the caller said to default the group from the parent descriptor,</span>
09647         <span class="comment">//  grab it now.</span>
09648         <span class="comment">//</span>
09649 
09650         <span class="keywordflow">if</span> ( AutoInheritFlags &amp; SEF_DEFAULT_GROUP_FROM_PARENT) {
09651             <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT(ParentDescriptor) ) {
09652                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PRIMARY_GROUP;
09653                 <span class="keywordflow">goto</span> Cleanup;
09654             }
09655             NewGroup = RtlpGroupAddrSecurityDescriptor((SECURITY_DESCRIPTOR *)ParentDescriptor);
09656         } <span class="keywordflow">else</span> {
09657             <span class="comment">//</span>
09658             <span class="comment">// Pick up the primary group from the subject's security context</span>
09659             <span class="comment">//</span>
09660             <span class="comment">// If we're creating a Server object, use the group from the server</span>
09661             <span class="comment">// context.</span>
09662             <span class="comment">//</span>
09663 
09664             NewGroup = ServerObject ? ServerGroup : SubjectContextGroup;
09665         }
09666 
09667     }
09668 
09669     <span class="keywordflow">if</span> (NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09670         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( NewGroup )) {
09671             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PRIMARY_GROUP;
09672             <span class="keywordflow">goto</span> Cleanup;
09673         }
09674     } <span class="keywordflow">else</span> {
09675         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PRIMARY_GROUP;
09676         <span class="keywordflow">goto</span> Cleanup;
09677     }
09678 
09679 
09680 
09681 
09682     <span class="comment">//</span>
09683     <span class="comment">// Establish System Acl</span>
09684     <span class="comment">//</span>
09685 
09686     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a74">RtlpInheritAcl</a> (
09687                 ARGUMENT_PRESENT(ParentDescriptor) ?
09688                     RtlpSaclAddrSecurityDescriptor(
09689                         ((SECURITY_DESCRIPTOR *)ParentDescriptor)) :
09690                     NULL,
09691                 RtlpSaclAddrSecurityDescriptor(CapturedDescriptor),
09692                 SeControlSaclToGeneric( CapturedDescriptor-&gt;Control ),
09693                 IsDirectoryObject,
09694                 (BOOLEAN)((AutoInheritFlags &amp; SEF_SACL_AUTO_INHERIT) != 0),
09695                 (BOOLEAN)((AutoInheritFlags &amp; SEF_DEFAULT_DESCRIPTOR_FOR_OBJECT) != 0),
09696                 NewOwner,
09697                 NewGroup,
09698                 ServerOwner,
09699                 ServerGroup,
09700                 GenericMapping,
09701                 TRUE,   <span class="comment">// Is a SACL</span>
09702                 ObjectType,
09703                 &amp;NewSacl,
09704                 &amp;SaclExplicitlyAssigned,
09705                 &amp;GenericControl );
09706 
09707     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
09708         NewSaclInherited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09709         NewControlBits |= SE_SACL_PRESENT | SeControlGenericToSacl( GenericControl );
09710 
09711     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_INHERITANCE ) {
09712 
09713         <span class="comment">//</span>
09714         <span class="comment">// Always set the auto inherit bit if the caller requested it.</span>
09715         <span class="comment">//</span>
09716 
09717         <span class="keywordflow">if</span> ( AutoInheritFlags &amp; SEF_SACL_AUTO_INHERIT) {
09718             NewControlBits |= SE_SACL_AUTO_INHERITED;
09719         }
09720 
09721         <span class="comment">//</span>
09722         <span class="comment">// No inheritable ACL - check for a defaulted one.</span>
09723         <span class="comment">//</span>
09724         <span class="keywordflow">if</span> ( RtlpAreControlBitsSet( CapturedDescriptor,
09725                                 SE_SACL_PRESENT | SE_SACL_DEFAULTED ) ) {
09726 
09727             <span class="comment">//</span>
09728             <span class="comment">// Reference the default ACL</span>
09729             <span class="comment">//</span>
09730 
09731             NewSacl = RtlpSaclAddrSecurityDescriptor(CapturedDescriptor);
09732             NewControlBits |= SE_SACL_PRESENT;
09733             NewControlBits |= (CapturedDescriptor-&gt;Control &amp; SE_SACL_PROTECTED);
09734 
09735             <span class="comment">//</span>
09736             <span class="comment">// This counts as an explicit assignment.</span>
09737             <span class="comment">//</span>
09738             SaclExplicitlyAssigned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09739         }
09740 
09741     } <span class="keywordflow">else</span> {
09742 
09743         <span class="comment">//</span>
09744         <span class="comment">// Some unusual error occured</span>
09745         <span class="comment">//</span>
09746 
09747         <span class="keywordflow">goto</span> Cleanup;
09748     }
09749 
09750 
09751 
09752 
09753     <span class="comment">//</span>
09754     <span class="comment">// Establish Discretionary Acl</span>
09755     <span class="comment">//</span>
09756 
09757     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a74">RtlpInheritAcl</a> (
09758                 ARGUMENT_PRESENT(ParentDescriptor) ?
09759                     RtlpDaclAddrSecurityDescriptor(
09760                         ((SECURITY_DESCRIPTOR *)ParentDescriptor)) :
09761                     NULL,
09762                 RtlpDaclAddrSecurityDescriptor(CapturedDescriptor),
09763                 SeControlDaclToGeneric( CapturedDescriptor-&gt;Control ),
09764                 IsDirectoryObject,
09765                 (BOOLEAN)((AutoInheritFlags &amp; SEF_DACL_AUTO_INHERIT) != 0),
09766                 (BOOLEAN)((AutoInheritFlags &amp; SEF_DEFAULT_DESCRIPTOR_FOR_OBJECT) != 0),
09767                 NewOwner,
09768                 NewGroup,
09769                 ServerOwner,
09770                 ServerGroup,
09771                 GenericMapping,
09772                 FALSE,   <span class="comment">// Is a DACL</span>
09773                 ObjectType,
09774                 &amp;NewDacl,
09775                 &amp;DaclExplicitlyAssigned,
09776                 &amp;GenericControl );
09777 
09778     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
09779         NewDaclInherited = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09780         NewControlBits |= SE_DACL_PRESENT | SeControlGenericToDacl( GenericControl );
09781 
09782     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_INHERITANCE ) {
09783 
09784         <span class="comment">//</span>
09785         <span class="comment">// Always set the auto inherit bit if the caller requested it.</span>
09786         <span class="comment">//</span>
09787 
09788         <span class="keywordflow">if</span> ( AutoInheritFlags &amp; SEF_DACL_AUTO_INHERIT) {
09789             NewControlBits |= SE_DACL_AUTO_INHERITED;
09790         }
09791 
09792         <span class="comment">//</span>
09793         <span class="comment">// No inheritable ACL - check for a defaulted one.</span>
09794         <span class="comment">//</span>
09795         <span class="keywordflow">if</span> ( RtlpAreControlBitsSet( CapturedDescriptor,
09796                                 SE_DACL_PRESENT | SE_DACL_DEFAULTED ) ) {
09797 
09798             <span class="comment">//</span>
09799             <span class="comment">// Reference the default ACL</span>
09800             <span class="comment">//</span>
09801 
09802             NewDacl = RtlpDaclAddrSecurityDescriptor(CapturedDescriptor);
09803             NewControlBits |= SE_DACL_PRESENT;
09804             NewControlBits |= (CapturedDescriptor-&gt;Control &amp; SE_DACL_PROTECTED);
09805 
09806             <span class="comment">//</span>
09807             <span class="comment">// This counts as an explicit assignment.</span>
09808             <span class="comment">//</span>
09809             DaclExplicitlyAssigned = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09810 
09811         <span class="comment">//</span>
09812         <span class="comment">// Default to the DACL on the token.</span>
09813         <span class="comment">//</span>
09814         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SubjectContextDacl)) {
09815 
09816             NewDacl = SubjectContextDacl;
09817             NewControlBits |= SE_DACL_PRESENT;
09818 
09819         }
09820 
09821 
09822     } <span class="keywordflow">else</span> {
09823 
09824         <span class="comment">//</span>
09825         <span class="comment">// Some unusual error occured</span>
09826         <span class="comment">//</span>
09827 
09828         <span class="keywordflow">goto</span> Cleanup;
09829     }
09830 
09831     <span class="comment">//</span>
09832     <span class="comment">// If auto inheriting and the computed child DACL is NULL,</span>
09833     <span class="comment">//  mark it as protected.</span>
09834     <span class="comment">//</span>
09835     <span class="comment">// NULL DACLs are problematic when ACEs are actually inherited from the</span>
09836     <span class="comment">// parent DACL.  It is better to mark them as protected NOW (even if we don't</span>
09837     <span class="comment">// end up inheriting any ACEs) to avoid confusion later.</span>
09838     <span class="comment">//</span>
09839 
09840     <span class="keywordflow">if</span> ( (AutoInheritFlags &amp; SEF_DACL_AUTO_INHERIT) != 0 &amp;&amp;
09841          NewDacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
09842         NewControlBits |= SE_DACL_PROTECTED;
09843     }
09844 
09845 
09846 
09847     <span class="comment">//</span>
09848     <span class="comment">// Now make sure that the caller has the right to assign</span>
09849     <span class="comment">// everything in the descriptor.  The requestor is subjected</span>
09850     <span class="comment">// to privilege and restriction tests for some assignments.</span>
09851     <span class="comment">//</span>
09852     <span class="keywordflow">if</span> (RequestorMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
09853 
09854 
09855         <span class="comment">//</span>
09856         <span class="comment">// Anybody can assign any Discretionary ACL or group that they want to.</span>
09857         <span class="comment">//</span>
09858 
09859         <span class="comment">//</span>
09860         <span class="comment">//  See if the system ACL was explicitly specified</span>
09861         <span class="comment">//</span>
09862 
09863         <span class="keywordflow">if</span> ( SaclExplicitlyAssigned &amp;&amp;
09864              (AutoInheritFlags &amp; SEF_AVOID_PRIVILEGE_CHECK) == 0 ) {
09865 
09866             <span class="comment">//</span>
09867             <span class="comment">// Require a Token if we're to do the privilege check.</span>
09868             <span class="comment">//</span>
09869 
09870             <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
09871                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_TOKEN;
09872                 <span class="keywordflow">goto</span> Cleanup;
09873             }
09874 
09875 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
09876 <span class="preprocessor"></span>
09877             <span class="comment">//</span>
09878             <span class="comment">// Check for appropriate Privileges</span>
09879             <span class="comment">// Audit/Alarm messages need to be generated due to the attempt</span>
09880             <span class="comment">// to perform a privileged operation.</span>
09881             <span class="comment">//</span>
09882 
09883             <span class="comment">//</span>
09884             <span class="comment">// Note: be sure to do the privilege check against</span>
09885             <span class="comment">// the passed subject context!</span>
09886             <span class="comment">//</span>
09887 
09888             PrivilegeSet.PrivilegeCount = 1;
09889             PrivilegeSet.Control = PRIVILEGE_SET_ALL_NECESSARY;
09890             PrivilegeSet.Privilege[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>;
09891             PrivilegeSet.Privilege[0].Attributes = 0;
09892 
09893             HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a1">SePrivilegeCheck</a>(
09894                                &amp;PrivilegeSet,
09895                                SubjectSecurityContext,
09896                                RequestorMode
09897                                );
09898 
09899             <span class="keywordflow">if</span> ( RequestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
09900 
09901                 <a class="code" href="../../d3/d5/seaudit_8c.html#a15">SePrivilegedServiceAuditAlarm</a> (
09902                     NULL,                              <span class="comment">// BUGWARNING need service name</span>
09903                     SubjectSecurityContext,
09904                     &amp;PrivilegeSet,
09905                     HasPrivilege
09906                     );
09907             }
09908 
09909 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
09910 <span class="preprocessor"></span>            <span class="comment">//</span>
09911             <span class="comment">// Check for appropriate Privileges</span>
09912             <span class="comment">//</span>
09913             <span class="comment">// Audit/Alarm messages need to be generated due to the attempt</span>
09914             <span class="comment">// to perform a privileged operation.</span>
09915             <span class="comment">//</span>
09916 
09917             PrivilegeSet.PrivilegeCount = 1;
09918             PrivilegeSet.Control = PRIVILEGE_SET_ALL_NECESSARY;
09919             PrivilegeSet.Privilege[0].Luid = RtlConvertLongToLuid(SE_SECURITY_PRIVILEGE);
09920             PrivilegeSet.Privilege[0].Attributes = 0;
09921 
09922             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d4/privileg_8c.html#a2">NtPrivilegeCheck</a>(
09923                         Token,
09924                         &amp;PrivilegeSet,
09925                         &amp;HasPrivilege
09926                         );
09927 
09928             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
09929                 <span class="keywordflow">goto</span> Cleanup;
09930             }
09931 
09932 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
09933 <span class="preprocessor"></span>
09934             <span class="keywordflow">if</span> ( !HasPrivilege ) {
09935                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
09936                 <span class="keywordflow">goto</span> Cleanup;
09937             }
09938 
09939         }
09940 
09941         <span class="comment">//</span>
09942         <span class="comment">// See if the owner field is one the requestor can assign</span>
09943         <span class="comment">//</span>
09944 
09945         <span class="keywordflow">if</span> (OwnerExplicitlyAssigned &amp;&amp;
09946             (AutoInheritFlags &amp; SEF_AVOID_OWNER_CHECK) == 0 ) {
09947 
09948 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
09949 <span class="preprocessor"></span>
09950 
09951             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/subject_8c.html#a6">SepValidOwnerSubjectContext</a>(
09952                     SubjectSecurityContext,
09953                     NewOwner,
09954                     ServerObject)
09955                     ) {
09956 
09957                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OWNER;
09958                 <span class="keywordflow">goto</span> Cleanup;
09959             }
09960 
09961 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
09962 <span class="preprocessor"></span>
09963             <span class="comment">//</span>
09964             <span class="comment">// Require a Token if we're to do the privilege check.</span>
09965             <span class="comment">//</span>
09966 
09967             <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
09968                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_TOKEN;
09969                 <span class="keywordflow">goto</span> Cleanup;
09970             }
09971 
09972             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a72">RtlpValidOwnerSubjectContext</a>(
09973                     Token,
09974                     NewOwner,
09975                     ServerObject,
09976                     &amp;PassedStatus) ) {
09977 
09978                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = PassedStatus;
09979                 <span class="keywordflow">goto</span> Cleanup;
09980             }
09981 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
09982 <span class="preprocessor"></span>        }
09983 
09984 
09985         <span class="comment">//</span>
09986         <span class="comment">// If the DACL was explictly assigned and this is a server object,</span>
09987         <span class="comment">//  convert the DACL to be a server DACL</span>
09988         <span class="comment">//</span>
09989 
09990         <span class="keywordflow">if</span> (DaclExplicitlyAssigned &amp;&amp; ServerObject) {
09991 
09992             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a27">RtlpCreateServerAcl</a>(
09993                          NewDacl,
09994                          DaclUntrusted,
09995                          ServerOwner,
09996                          &amp;ServerDacl,
09997                          &amp;ServerDaclAllocated
09998                          );
09999 
10000             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
10001                 <span class="keywordflow">goto</span> Cleanup;
10002             }
10003 
10004             NewDacl = ServerDacl;
10005         }
10006     }
10007 
10008 
10009     <span class="comment">//</span>
10010     <span class="comment">// Everything is assignable by the requestor.</span>
10011     <span class="comment">// Calculate the memory needed to house all the information in</span>
10012     <span class="comment">// a self-relative security descriptor.</span>
10013     <span class="comment">//</span>
10014     <span class="comment">// Also map the ACEs for application to the target object</span>
10015     <span class="comment">// type, if they haven't already been mapped.</span>
10016     <span class="comment">//</span>
10017 
10018     NewOwnerSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewOwner));
10019     <span class="keywordflow">if</span> (NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10020         NewGroupSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewGroup));
10021     }
10022 
10023     <span class="keywordflow">if</span> ((NewControlBits &amp; SE_SACL_PRESENT) &amp;&amp; (NewSacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
10024         NewSaclSize = LongAlignSize(NewSacl-&gt;AclSize);
10025     } <span class="keywordflow">else</span> {
10026         NewSaclSize = 0;
10027     }
10028 
10029     <span class="keywordflow">if</span> ( (NewControlBits &amp; SE_DACL_PRESENT) &amp;&amp; (NewDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
10030         NewDaclSize = LongAlignSize(NewDacl-&gt;AclSize);
10031     } <span class="keywordflow">else</span> {
10032         NewDaclSize = 0;
10033     }
10034 
10035     AllocationSize = LongAlignSize(<span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE)) +
10036                      NewOwnerSize +
10037                      NewGroupSize +
10038                      NewSaclSize  +
10039                      NewDaclSize;
10040 
10041     <span class="comment">//</span>
10042     <span class="comment">// Allocate and initialize the security descriptor as</span>
10043     <span class="comment">// self-relative form.</span>
10044     <span class="comment">//</span>
10045 
10046 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10047 <span class="preprocessor"></span>    INewDescriptor = (PSECURITY_DESCRIPTOR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, AllocationSize, 'dSeS');
10048 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10049 <span class="preprocessor"></span>    INewDescriptor = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), AllocationSize );
10050 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10051 <span class="preprocessor"></span>
10052     <span class="keywordflow">if</span> ( INewDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
10053 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10054 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
10055 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10056 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
10057 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10058 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> Cleanup;
10059     }
10060 
10061     <a class="code" href="../../d8/d6/sertl_8c.html#a54">RtlCreateSecurityDescriptorRelative</a>(
10062         INewDescriptor,
10063         SECURITY_DESCRIPTOR_REVISION
10064         );
10065 
10066     RtlpSetControlBits( INewDescriptor, NewControlBits );
10067 
10068     Base = (PCHAR)(INewDescriptor);
10069     Field =  Base + <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
10070 
10071     <span class="comment">//</span>
10072     <span class="comment">// Map and Copy in the Sacl</span>
10073     <span class="comment">//</span>
10074 
10075     <span class="keywordflow">if</span> (NewControlBits &amp; SE_SACL_PRESENT) {
10076 
10077         <span class="keywordflow">if</span> (NewSacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10078 
10079             RtlCopyMemory( Field, NewSacl, NewSacl-&gt;AclSize );
10080 
10081             <span class="keywordflow">if</span> (!NewSaclInherited) {
10082                 <a class="code" href="../../d8/d6/sertl_8c.html#a73">RtlpApplyAclToObject</a>( (PACL)Field, GenericMapping );
10083             }
10084 
10085             INewDescriptor-&gt;Sacl = RtlPointerToOffset(Base,Field);
10086             Field += NewSaclSize;
10087 
10088         } <span class="keywordflow">else</span> {
10089 
10090             INewDescriptor-&gt;Sacl = 0;
10091         }
10092 
10093     }
10094 
10095     <span class="comment">//</span>
10096     <span class="comment">// Map and Copy in the Dacl</span>
10097     <span class="comment">//</span>
10098 
10099     <span class="keywordflow">if</span> (NewControlBits &amp; SE_DACL_PRESENT) {
10100 
10101         <span class="keywordflow">if</span> (NewDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10102 
10103             RtlCopyMemory( Field, NewDacl, NewDacl-&gt;AclSize );
10104 
10105             <span class="keywordflow">if</span> (!NewDaclInherited) {
10106                 <a class="code" href="../../d8/d6/sertl_8c.html#a73">RtlpApplyAclToObject</a>( (PACL)Field, GenericMapping );
10107             }
10108 
10109             INewDescriptor-&gt;Dacl = RtlPointerToOffset(Base,Field);
10110             Field += NewDaclSize;
10111 
10112         } <span class="keywordflow">else</span> {
10113 
10114             INewDescriptor-&gt;Dacl = 0;
10115         }
10116 
10117     }
10118 
10119     <span class="comment">//</span>
10120     <span class="comment">// Assign the owner</span>
10121     <span class="comment">//</span>
10122 
10123     RtlCopyMemory( Field, NewOwner, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewOwner) );
10124     INewDescriptor-&gt;Owner = RtlPointerToOffset(Base,Field);
10125     Field += NewOwnerSize;
10126 
10127     <span class="keywordflow">if</span> (NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10128         RtlCopyMemory( Field, NewGroup, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewGroup) );
10129         INewDescriptor-&gt;Group = RtlPointerToOffset(Base,Field);
10130     }
10131 
10132     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
10133 
10134 
10135 
10136 Cleanup:
10137     <span class="comment">//</span>
10138     <span class="comment">// If we allocated memory for a Server DACL, free it now.</span>
10139     <span class="comment">//</span>
10140 
10141     <span class="keywordflow">if</span> (ServerDaclAllocated) {
10142 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10143 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ServerDacl );
10144 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10145 <span class="preprocessor"></span>        <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, ServerDacl );
10146 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10147 <span class="preprocessor"></span>    }
10148 
10149     <span class="comment">//</span>
10150     <span class="comment">// Either an error was encountered or the assignment has completed</span>
10151     <span class="comment">// successfully.  In either case, we have to clean up any memory.</span>
10152     <span class="comment">//</span>
10153 
10154 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10155 <span class="preprocessor"></span><span class="comment">//     if ( SubjectSecurityContext != NULL ) {</span>
10156 <span class="comment">//         SeUnlockSubjectContext( SubjectSecurityContext );</span>
10157 <span class="comment">//     }</span>
10158 
10159     <span class="keywordflow">if</span> (SubjectContextInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10160         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SubjectContextInfo );
10161     }
10162 
10163 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10164 <span class="preprocessor"></span>    <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)TokenOwnerInfo );
10165     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)TokenPrimaryGroupInfo );
10166     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)TokenDefaultDaclInfo );
10167     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)ServerOwnerInfo );
10168     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)ServerGroupInfo );
10169 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10170 <span class="preprocessor"></span>
10171     <span class="keywordflow">if</span> (NewSaclInherited &amp;&amp; NewSacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
10172 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10173 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewSacl );
10174 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10175 <span class="preprocessor"></span>        <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)NewSacl );
10176 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10177 <span class="preprocessor"></span>    }
10178 
10179     <span class="keywordflow">if</span> (NewDaclInherited &amp;&amp; NewDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
10180 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10181 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewDacl );
10182 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10183 <span class="preprocessor"></span>        <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)NewDacl );
10184 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10185 <span class="preprocessor"></span>    }
10186 
10187     *NewDescriptor = (PSECURITY_DESCRIPTOR) INewDescriptor;
10188 
10189 
10190     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
10191 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="sertl.c::RtlpSetSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpSetSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID Object&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInheritFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">10195</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01473">ObValidateSecurityQuota()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02004">RtlCreateSecurityDescriptorRelative()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03812">RtlpApplyAclToObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06266">RtlpComputeMergedAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08588">RtlpCreateServerAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03544">RtlpValidOwnerSubjectContext()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">SE_TAG</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00234">SepGetDefaultsSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00381">SepValidOwnerSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00331">RtlSetSecurityObject()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00373">RtlSetSecurityObjectEx()</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00365">SeSetSecurityDescriptorInfo()</a>, and <a class="el" href="../../d1/d5/semethod_8c-source.html#l00452">SeSetSecurityDescriptorInfoEx()</a>.
<p>
<pre class="fragment"><div>10209                    :
10210 
10211     Modify an object's existing <span class="keyword">self</span>-relative form security descriptor.
10212 
10213     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>, called <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> from user mode, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to update a
10214     security descriptor on an existing <span class="keyword">protected</span> server's object.  It
10215     applies changes requested by a <span class="keyword">new</span> security descriptor to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> existing
10216     security descriptor.  If necessary, <span class="keyword">this</span> routine will allocate
10217     additional memory to produce a larger security descriptor.  All access
10218     checking <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to be done before calling <span class="keyword">this</span> routine.  This
10219     includes checking <span class="keywordflow">for</span> WRITE_OWNER, WRITE_DAC, and privilege to assign a
10220     system ACL as appropriate.
10221 
10222     The caller of <span class="keyword">this</span> routine must not be impersonating a client.
10223 
10224                                   - - <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a> - -
10225 
10226     This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> use by <span class="keyword">protected</span> subsystems that project their own
10227     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object.  This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explicitly not <span class="keywordflow">for</span> use by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
10228     executive <span class="keywordflow">for</span> executive objects and must not be called from kernel
10229     mode.
10230 
10231 Arguments:
10232 
10233     Object - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object whose security <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
10234         being adjusted.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to update security quota
10235         information.
10236 
10237     SecurityInformation - Indicates which security information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
10238         to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The value(s) to be assigned are
10239         passed in the ModificationDescriptor parameter.
10240 
10241     ModificationDescriptor - Supplies the input security descriptor to be
10242         applied to the object.  The caller of this routine is expected
10243         to probe and capture the passed security descriptor before calling
10244         and release it after calling.
10245 
10246     ObjectsSecurityDescriptor - Supplies the address of a pointer to
10247         the objects security descriptor that is going to be altered by
10248         this procedure.  This security descriptor must be in self-
10249         relative form or an error will be returned.
10250 
10251     AutoInheritFlags - Controls automatic inheritance of ACES.
10252         Valid values are a bits mask of the logical OR of
10253         one or more of the following bits:
10254 
10255         SEF_DACL_AUTO_INHERIT - If set, inherited ACEs from the
10256             DACL in the ObjectsSecurityDescriptor are preserved and inherited ACEs from
10257             the ModificationDescriptor are ignored. Inherited ACEs are not supposed
10258             to be modified; so preserving them across this call is appropriate.
10259             If a protected server does not itself implement auto inheritance, it should
10260             not set this bit.  The caller of the protected server may implement
10261             auto inheritance and my indeed be modifying inherited ACEs.
10262 
10263         SEF_SACL_AUTO_INHERIT - If set, inherited ACEs from the
10264             SACL in the ObjectsSecurityDescriptor are preserved and inherited ACEs from
10265             the ModificationDescriptor are ignored. Inherited ACEs are not supposed
10266             to be modified; so preserving them across this call is appropriate.
10267             If a protected server does not itself implement auto inheritance, it should
10268             not set this bit.  The caller of the protected server may implement
10269             auto inheritance and my indeed be modifying inherited ACEs.
10270 
10271          SEF_AVOID_PRIVILEGE_CHECK - If set, the Token in not used to ensure the
10272             Owner passed in ModificationDescriptor is valid.
10273 
10274     PoolType - Specifies the type of pool to allocate for the objects
10275         security descriptor.
10276 
10277     GenericMapping - This argument provides the mapping of generic to
10278         specific/standard access types for the object being accessed.
10279         This mapping structure is expected to be safe to access
10280         (i.e., captured if necessary) prior to be passed to this routine.
10281 
10282     Token - (optionally) Supplies the token for the client on whose
10283         behalf the security is being modified.  This parameter is only
10284         required to ensure that the client has provided a legitimate
10285         value for a new owner SID.  The token must be open for
10286         TOKEN_QUERY access.
10287 
10288 Return Value:
10289 
10290     STATUS_SUCCESS - The operation was successful.
10291 
10292     STATUS_INVALID_OWNER - The owner SID provided as the new owner of the
10293         target security descriptor is not one the caller is authorized to
10294         assign as the owner of an object, or the client did not pass
10295         a token at all.
10296 
10297     STATUS_NO_CLIENT_TOKEN - Indicates a client token was not explicitly
10298         provided and the caller is not currently impersonating a client.
10299 
10300     STATUS_BAD_DESCRIPTOR_FORMAT - Indicates the provided object's security
10301         descriptor was not in self-relative format.
10302 
10303 --*/
10304 
10305 {
10306     BOOLEAN NewGroupPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10307     BOOLEAN NewOwnerPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10308 
10309     BOOLEAN ServerAclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10310     BOOLEAN LocalDaclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10311     BOOLEAN LocalSaclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10312     BOOLEAN ServerObject;
10313     BOOLEAN DaclUntrusted;
10314 
10315     PCHAR Field;
10316     PCHAR Base;
10317 
10318     PISECURITY_DESCRIPTOR_RELATIVE NewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10319 
10320     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
10321 
10322     TOKEN_STATISTICS ThreadTokenStatistics;
10323 
10324     ULONG ReturnLength;
10325 
10326     PSID NewGroup;
10327     PSID NewOwner;
10328 
10329     PACL NewDacl;
10330     PACL LocalDacl;
10331     PACL NewSacl;
10332     PACL LocalSacl;
10333 
10334     ULONG NewDaclSize;
10335     ULONG NewSaclSize;
10336     ULONG NewOwnerSize;
10337     ULONG NewGroupSize;
10338     ULONG AllocationSize;
10339     ULONG ServerOwnerInfoSize;
10340 
10341     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
10342     ULONG GenericControl;
10343     ULONG NewControlBits = SE_SELF_RELATIVE;
10344 
10345     PACL ServerDacl;
10346 
10347     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
10348 
10349 
10350     <span class="comment">//</span>
10351     <span class="comment">// Typecast to internal representation of security descriptor.</span>
10352     <span class="comment">// Note that the internal one is not a pointer to a pointer.</span>
10353     <span class="comment">// It is just a pointer to a security descriptor.</span>
10354     <span class="comment">//</span>
10355     PISECURITY_DESCRIPTOR IModificationDescriptor =
10356        (PISECURITY_DESCRIPTOR)ModificationDescriptor;
10357 
10358     PISECURITY_DESCRIPTOR *IObjectsSecurityDescriptor =
10359        (PISECURITY_DESCRIPTOR *)(ObjectsSecurityDescriptor);
10360 
10361 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
10362 <span class="preprocessor"></span>    PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
10363 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10364 <span class="preprocessor"></span>
10365     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
10366 
10367     <span class="comment">//</span>
10368     <span class="comment">// Get the handle to the current process heap</span>
10369     <span class="comment">//</span>
10370 
10371 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
10372 <span class="preprocessor"></span>    <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
10373 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10374 <span class="preprocessor"></span>
10375     <span class="comment">//</span>
10376     <span class="comment">//  Validate that the provided SD is in self-relative form</span>
10377     <span class="comment">//</span>
10378 
10379     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet(*IObjectsSecurityDescriptor, SE_SELF_RELATIVE) ) {
10380         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BAD_DESCRIPTOR_FORMAT;
10381         <span class="keywordflow">goto</span> Cleanup;
10382     }
10383 
10384     <span class="comment">//</span>
10385     <span class="comment">// Check to see if we need to edit the passed acl</span>
10386     <span class="comment">// either because we're creating a server object, or because</span>
10387     <span class="comment">// we were passed an untrusted ACL.</span>
10388     <span class="comment">//</span>
10389 
10390     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ModificationDescriptor)) {
10391 
10392         <span class="keywordflow">if</span> ( RtlpAreControlBitsSet(IModificationDescriptor, SE_SERVER_SECURITY)) {
10393             ServerObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
10394         } <span class="keywordflow">else</span> {
10395             ServerObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10396         }
10397 
10398         <span class="keywordflow">if</span> ( RtlpAreControlBitsSet(IModificationDescriptor, SE_DACL_UNTRUSTED)) {
10399             DaclUntrusted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
10400         } <span class="keywordflow">else</span> {
10401             DaclUntrusted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10402         }
10403 
10404     } <span class="keywordflow">else</span> {
10405 
10406         ServerObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10407         DaclUntrusted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10408 
10409     }
10410 
10411 
10412     <span class="comment">//</span>
10413     <span class="comment">// For each item specified in the SecurityInformation, extract it</span>
10414     <span class="comment">// and get it to the point where it can be copied into a new</span>
10415     <span class="comment">// descriptor.</span>
10416     <span class="comment">//</span>
10417 
10418     <span class="comment">//</span>
10419     <span class="comment">// if he's setting the owner field, make sure he's</span>
10420     <span class="comment">// allowed to set that value as an owner.</span>
10421     <span class="comment">//</span>
10422 
10423     <span class="keywordflow">if</span> (SecurityInformation &amp; OWNER_SECURITY_INFORMATION) {
10424 
10425         NewOwner = RtlpOwnerAddrSecurityDescriptor( IModificationDescriptor );
10426         NewOwnerPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
10427 
10428         <span class="keywordflow">if</span> ((AutoInheritFlags &amp; SEF_AVOID_PRIVILEGE_CHECK) == 0 ) {
10429 
10430 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10431 <span class="preprocessor"></span>
10432             <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>( &amp;SubjectContext );
10433 
10434             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/subject_8c.html#a6">SepValidOwnerSubjectContext</a>( &amp;SubjectContext, NewOwner, ServerObject ) ) {
10435 
10436                 <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
10437                 <span class="keywordflow">return</span>( STATUS_INVALID_OWNER );
10438 
10439             } <span class="keywordflow">else</span> {
10440 
10441                 <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
10442             }
10443 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10444 <span class="preprocessor"></span>
10445             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Token )) {
10446 
10447                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
10448                              Token,                        <span class="comment">// Handle</span>
10449                              TokenStatistics,              <span class="comment">// TokenInformationClass</span>
10450                              &amp;ThreadTokenStatistics,       <span class="comment">// TokenInformation</span>
10451                              <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
10452                              &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
10453                              );
10454 
10455                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
10456                     <span class="keywordflow">goto</span> Cleanup;
10457                 }
10458 
10459                 <span class="comment">//</span>
10460                 <span class="comment">//  If it is an impersonation token, then make sure it is at a</span>
10461                 <span class="comment">//  high enough level.</span>
10462                 <span class="comment">//</span>
10463 
10464                 <span class="keywordflow">if</span> (ThreadTokenStatistics.TokenType == TokenImpersonation) {
10465 
10466                     <span class="keywordflow">if</span> (ThreadTokenStatistics.ImpersonationLevel &lt; SecurityIdentification ) {
10467                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BAD_IMPERSONATION_LEVEL;
10468                         <span class="keywordflow">goto</span> Cleanup;
10469                     }
10470                 }
10471 
10472             } <span class="keywordflow">else</span> {
10473 
10474                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OWNER;
10475                 <span class="keywordflow">goto</span> Cleanup;
10476             }
10477 
10478             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a72">RtlpValidOwnerSubjectContext</a>(
10479                     Token,
10480                     NewOwner,
10481                     ServerObject,
10482                     &amp;Status) ) {
10483 
10484                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OWNER;
10485                     <span class="keywordflow">goto</span> Cleanup;
10486             }
10487 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10488 <span class="preprocessor"></span>        }
10489 
10490     } <span class="keywordflow">else</span> {
10491 
10492         NewOwner = RtlpOwnerAddrSecurityDescriptor ( *IObjectsSecurityDescriptor );
10493         <span class="keywordflow">if</span> (NewOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10494             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OWNER;
10495             <span class="keywordflow">goto</span> Cleanup;
10496         }
10497 
10498     }
10499     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NewOwner != NULL );
10500     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( NewOwner )) {
10501         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OWNER;
10502         <span class="keywordflow">goto</span> Cleanup;
10503     }
10504 
10505 
10506     <span class="keywordflow">if</span> (SecurityInformation &amp; GROUP_SECURITY_INFORMATION) {
10507 
10508         NewGroup = RtlpGroupAddrSecurityDescriptor(IModificationDescriptor);
10509         NewGroupPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
10510 
10511     } <span class="keywordflow">else</span> {
10512 
10513         NewGroup = RtlpGroupAddrSecurityDescriptor( *IObjectsSecurityDescriptor );
10514     }
10515 
10516     <span class="keywordflow">if</span> (NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10517         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( NewGroup )) {
10518             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PRIMARY_GROUP;
10519             <span class="keywordflow">goto</span> Cleanup;
10520         }
10521     } <span class="keywordflow">else</span> {
10522         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PRIMARY_GROUP;
10523         <span class="keywordflow">goto</span> Cleanup;
10524     }
10525 
10526 
10527     <span class="keywordflow">if</span> (SecurityInformation &amp; DACL_SECURITY_INFORMATION) {
10528 
10529         <span class="comment">//</span>
10530         <span class="comment">// If AutoInherit is requested,</span>
10531         <span class="comment">//  build a merged ACL.</span>
10532         <span class="comment">//</span>
10533 
10534         <span class="keywordflow">if</span> ( AutoInheritFlags &amp; SEF_DACL_AUTO_INHERIT ) {
10535             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a21">RtlpComputeMergedAcl</a>(
10536                         RtlpDaclAddrSecurityDescriptor( *IObjectsSecurityDescriptor ),
10537                         SeControlDaclToGeneric( (*IObjectsSecurityDescriptor)-&gt;Control ),
10538                         RtlpDaclAddrSecurityDescriptor( IModificationDescriptor ),
10539                         SeControlDaclToGeneric( IModificationDescriptor-&gt;Control ),
10540                         NewOwner,
10541                         NewGroup,
10542                         GenericMapping,
10543                         FALSE,      <span class="comment">// Not a SACL</span>
10544                         &amp;LocalDacl,
10545                         &amp;GenericControl );
10546 
10547             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
10548                 <span class="keywordflow">goto</span> Cleanup;
10549             }
10550 
10551             LocalDaclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
10552             NewDacl = LocalDacl;
10553             NewControlBits |= SE_DACL_PRESENT;
10554             NewControlBits |= SeControlGenericToDacl( GenericControl );
10555 
10556         <span class="comment">//</span>
10557         <span class="comment">// If AutoInherit isn't requested,</span>
10558         <span class="comment">//  just grab a copy of the input DACL.</span>
10559         <span class="comment">//</span>
10560 
10561         } <span class="keywordflow">else</span> {
10562             NewDacl = RtlpDaclAddrSecurityDescriptor( IModificationDescriptor );
10563             NewControlBits |= SE_DACL_PRESENT;
10564             NewControlBits |= IModificationDescriptor-&gt;Control &amp; SE_DACL_PROTECTED;
10565 
10566             <span class="comment">//</span>
10567             <span class="comment">// If the original caller claims he understands auto inheritance,</span>
10568             <span class="comment">//  preserve the AutoInherited flag.</span>
10569             <span class="comment">//</span>
10570 
10571             <span class="keywordflow">if</span> ( RtlpAreControlBitsSet(IModificationDescriptor, SE_DACL_AUTO_INHERIT_REQ|SE_DACL_AUTO_INHERITED) ) {
10572                 NewControlBits |= SE_DACL_AUTO_INHERITED;
10573             }
10574         }
10575 
10576         <span class="keywordflow">if</span> (ServerObject) {
10577 
10578 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10579 <span class="preprocessor"></span>
10580             PSID SubjectContextOwner;
10581             PSID SubjectContextGroup;
10582             PSID SubjectContextServerOwner;
10583             PSID SubjectContextServerGroup;
10584             PACL SubjectContextDacl;
10585 
10586             <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>( &amp;SubjectContext );
10587 
10588             <a class="code" href="../../d0/d8/subject_8c.html#a4">SepGetDefaultsSubjectContext</a>(
10589                 &amp;SubjectContext,
10590                 &amp;SubjectContextOwner,
10591                 &amp;SubjectContextGroup,
10592                 &amp;SubjectContextServerOwner,
10593                 &amp;SubjectContextServerGroup,
10594                 &amp;SubjectContextDacl
10595                 );
10596 
10597             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a27">RtlpCreateServerAcl</a>(
10598                          NewDacl,
10599                          DaclUntrusted,
10600                          SubjectContextServerOwner,
10601                          &amp;ServerDacl,
10602                          &amp;ServerAclAllocated
10603                          );
10604 
10605             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
10606 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10607 <span class="preprocessor"></span>            PTOKEN_OWNER ServerSid;
10608 
10609             <span class="comment">//</span>
10610             <span class="comment">// Obtain the default Server SID to substitute in the</span>
10611             <span class="comment">// ACL if necessary.</span>
10612             <span class="comment">//</span>
10613 
10614             ServerOwnerInfoSize = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( SID_MAX_SUB_AUTHORITIES );
10615 
10616             ServerSid = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), ServerOwnerInfoSize );
10617 
10618             <span class="keywordflow">if</span> (ServerSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10619                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
10620                 <span class="keywordflow">goto</span> Cleanup;
10621             }
10622 
10623             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
10624                          NtCurrentProcess(),
10625                          TOKEN_QUERY,
10626                          &amp;PrimaryToken
10627                          );
10628 
10629             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
10630                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, ServerSid );
10631                 <span class="keywordflow">goto</span> Cleanup;
10632             }
10633 
10634             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
10635                          PrimaryToken,                 <span class="comment">// Handle</span>
10636                          TokenOwner,                   <span class="comment">// TokenInformationClass</span>
10637                          ServerSid,                    <span class="comment">// TokenInformation</span>
10638                          ServerOwnerInfoSize,          <span class="comment">// TokenInformationLength</span>
10639                          &amp;ServerOwnerInfoSize          <span class="comment">// ReturnLength</span>
10640                          );
10641 
10642             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( PrimaryToken );
10643 
10644             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
10645                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, ServerSid );
10646                 <span class="keywordflow">goto</span> Cleanup;
10647             }
10648 
10649             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a27">RtlpCreateServerAcl</a>(
10650                          NewDacl,
10651                          DaclUntrusted,
10652                          ServerSid-&gt;Owner,
10653                          &amp;ServerDacl,
10654                          &amp;ServerAclAllocated
10655                          );
10656 
10657             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, ServerSid );
10658 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10659 <span class="preprocessor"></span>
10660             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
10661                 <span class="keywordflow">goto</span> Cleanup;
10662             }
10663 
10664             NewDacl = ServerDacl;
10665 
10666         }
10667 
10668     } <span class="keywordflow">else</span> {
10669 
10670         NewDacl = RtlpDaclAddrSecurityDescriptor( *IObjectsSecurityDescriptor );
10671     }
10672 
10673 
10674 
10675     <span class="keywordflow">if</span> (SecurityInformation &amp; SACL_SECURITY_INFORMATION) {
10676 
10677 
10678         <span class="comment">//</span>
10679         <span class="comment">// If AutoInherit is requested,</span>
10680         <span class="comment">//  build a merged ACL.</span>
10681         <span class="comment">//</span>
10682 
10683         <span class="keywordflow">if</span> ( AutoInheritFlags &amp; SEF_SACL_AUTO_INHERIT ) {
10684             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a21">RtlpComputeMergedAcl</a>(
10685                         RtlpSaclAddrSecurityDescriptor( *IObjectsSecurityDescriptor ),
10686                         SeControlSaclToGeneric( (*IObjectsSecurityDescriptor)-&gt;Control ),
10687                         RtlpSaclAddrSecurityDescriptor( IModificationDescriptor ),
10688                         SeControlSaclToGeneric( IModificationDescriptor-&gt;Control ),
10689                         NewOwner,
10690                         NewGroup,
10691                         GenericMapping,
10692                         TRUE,      <span class="comment">// Is a SACL</span>
10693                         &amp;LocalSacl,
10694                         &amp;GenericControl );
10695 
10696             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
10697                 <span class="keywordflow">goto</span> Cleanup;
10698             }
10699             LocalSaclAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
10700             NewSacl = LocalSacl;
10701             NewControlBits |= SE_SACL_PRESENT;
10702             NewControlBits |= SeControlGenericToSacl( GenericControl );
10703         } <span class="keywordflow">else</span> {
10704             NewSacl = RtlpSaclAddrSecurityDescriptor( IModificationDescriptor );
10705             NewControlBits |= SE_SACL_PRESENT;
10706             NewControlBits |= IModificationDescriptor-&gt;Control &amp; SE_SACL_PROTECTED;
10707 
10708             <span class="comment">//</span>
10709             <span class="comment">// If the original caller claims he understands auto inheritance,</span>
10710             <span class="comment">//  preserve the AutoInherited flag.</span>
10711             <span class="comment">//</span>
10712 
10713             <span class="keywordflow">if</span> ( RtlpAreControlBitsSet(IModificationDescriptor, SE_SACL_AUTO_INHERIT_REQ|SE_SACL_AUTO_INHERITED) ) {
10714                 NewControlBits |= SE_SACL_AUTO_INHERITED;
10715             }
10716         }
10717 
10718     } <span class="keywordflow">else</span> {
10719 
10720         NewSacl = RtlpSaclAddrSecurityDescriptor( *IObjectsSecurityDescriptor );
10721     }
10722 
10723 
10724     <span class="comment">//</span>
10725     <span class="comment">// Everything is assignable by the requestor.</span>
10726     <span class="comment">// Calculate the memory needed to house all the information in</span>
10727     <span class="comment">// a self-relative security descriptor.</span>
10728     <span class="comment">//</span>
10729     <span class="comment">// Also map the ACEs for application to the target object</span>
10730     <span class="comment">// type, if they haven't already been mapped.</span>
10731     <span class="comment">//</span>
10732 
10733     NewOwnerSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewOwner));
10734 
10735     <span class="keywordflow">if</span> (NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10736         NewGroupSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewGroup));
10737     } <span class="keywordflow">else</span> {
10738         NewGroupSize = 0;
10739     }
10740 
10741     <span class="keywordflow">if</span> (NewSacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10742         NewSaclSize = LongAlignSize(NewSacl-&gt;AclSize);
10743     } <span class="keywordflow">else</span> {
10744         NewSaclSize = 0;
10745     }
10746 
10747     <span class="keywordflow">if</span> (NewDacl !=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10748         NewDaclSize = LongAlignSize(NewDacl-&gt;AclSize);
10749     } <span class="keywordflow">else</span> {
10750         NewDaclSize = 0;
10751     }
10752 
10753     AllocationSize = LongAlignSize(<span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE)) +
10754                      NewOwnerSize +
10755                      NewGroupSize +
10756                      NewSaclSize  +
10757                      NewDaclSize;
10758 
10759     <span class="comment">//</span>
10760     <span class="comment">// Allocate and initialize the security descriptor as</span>
10761     <span class="comment">// self-relative form.</span>
10762     <span class="comment">//</span>
10763 
10764 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10765 <span class="preprocessor"></span>    NewDescriptor = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PoolType, AllocationSize, 'dSeS');
10766 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10767 <span class="preprocessor"></span>    NewDescriptor = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), AllocationSize );
10768 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10769 <span class="preprocessor"></span>
10770     <span class="keywordflow">if</span> ( NewDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
10771         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
10772         <span class="keywordflow">goto</span> Cleanup;
10773     }
10774 
10775     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a54">RtlCreateSecurityDescriptorRelative</a>(
10776                  NewDescriptor,
10777                  SECURITY_DESCRIPTOR_REVISION
10778                  );
10779 
10780     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
10781 
10782 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10783 <span class="preprocessor"></span>    <span class="comment">//</span>
10784     <span class="comment">// We must check to make sure that the Group and Dacl size</span>
10785     <span class="comment">// do not exceed the quota preallocated for this object's</span>
10786     <span class="comment">// security when it was created.</span>
10787     <span class="comment">//</span>
10788     <span class="comment">// Update SeComputeSecurityQuota if this changes.</span>
10789     <span class="comment">//</span>
10790 
10791 
10792     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Object )) {
10793 
10794         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a10">ObValidateSecurityQuota</a>(
10795                      Object,
10796                      NewGroupSize + NewDaclSize
10797                      );
10798 
10799         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
10800 
10801             <span class="comment">//</span>
10802             <span class="comment">// The new information is too big.</span>
10803             <span class="comment">//</span>
10804 
10805             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewDescriptor );
10806             <span class="keywordflow">goto</span> Cleanup;
10807         }
10808 
10809     }
10810 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10811 <span class="preprocessor"></span>
10812 
10813     Base = (PCHAR)NewDescriptor;
10814     Field =  Base + <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
10815 
10816     <span class="comment">//</span>
10817     <span class="comment">// Map and Copy in the Sacl</span>
10818     <span class="comment">//</span>
10819 
10820 
10821     <span class="comment">//         if new item {</span>
10822     <span class="comment">//             PRESENT=TRUE</span>
10823     <span class="comment">//             DEFAULTED=FALSE</span>
10824     <span class="comment">//             if (NULL) {</span>
10825     <span class="comment">//                 set new pointer to NULL</span>
10826     <span class="comment">//             } else {</span>
10827     <span class="comment">//                 copy into new SD</span>
10828     <span class="comment">//             }</span>
10829     <span class="comment">//         } else {</span>
10830     <span class="comment">//             copy PRESENT bit</span>
10831     <span class="comment">//             copy DEFAULTED bit</span>
10832     <span class="comment">//             if (NULL) {</span>
10833     <span class="comment">//                 set new pointer to NULL</span>
10834     <span class="comment">//             } else {</span>
10835     <span class="comment">//                 copy old one into new SD</span>
10836     <span class="comment">//             }</span>
10837     <span class="comment">//         }</span>
10838 
10839     RtlpSetControlBits( NewDescriptor, NewControlBits );
10840 
10841 
10842     <span class="keywordflow">if</span> (IModificationDescriptor-&gt;Control &amp; SE_RM_CONTROL_VALID) {
10843         NewDescriptor-&gt;Sbz1 = IModificationDescriptor-&gt;Sbz1;
10844         NewDescriptor-&gt;Control |= SE_RM_CONTROL_VALID;
10845     }
10846 
10847     <span class="keywordflow">if</span> (NewSacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10848         NewDescriptor-&gt;Sacl = 0;
10849 
10850     } <span class="keywordflow">else</span> {
10851         RtlCopyMemory( Field, NewSacl, NewSacl-&gt;AclSize );
10852         <a class="code" href="../../d8/d6/sertl_8c.html#a73">RtlpApplyAclToObject</a>( (PACL)Field, GenericMapping );
10853         NewDescriptor-&gt;Sacl = RtlPointerToOffset(Base,Field);
10854         Field += NewSaclSize;
10855     }
10856 
10857 
10858 
10859 
10860     <span class="keywordflow">if</span> ( (NewControlBits &amp; SE_SACL_PRESENT) == 0 ) {
10861 
10862         <span class="comment">//</span>
10863         <span class="comment">// Propagate the SE_SACL_DEFAULTED and SE_SACL_PRESENT</span>
10864         <span class="comment">// bits from the old security descriptor into the new</span>
10865         <span class="comment">// one.</span>
10866         <span class="comment">//</span>
10867 
10868         RtlpPropagateControlBits(
10869             NewDescriptor,
10870             *IObjectsSecurityDescriptor,
10871             SE_SACL_DEFAULTED | SE_SACL_PRESENT | SE_SACL_PROTECTED
10872             );
10873 
10874     }
10875 
10876 
10877 
10878     <span class="comment">//</span>
10879     <span class="comment">// Fill in Dacl field in new SD</span>
10880     <span class="comment">//</span>
10881 
10882     <span class="keywordflow">if</span> (NewDacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10883         NewDescriptor-&gt;Dacl = 0;
10884 
10885     } <span class="keywordflow">else</span> {
10886         RtlCopyMemory( Field, NewDacl, NewDacl-&gt;AclSize );
10887         <a class="code" href="../../d8/d6/sertl_8c.html#a73">RtlpApplyAclToObject</a>( (PACL)Field, GenericMapping );
10888         NewDescriptor-&gt;Dacl = RtlPointerToOffset(Base,Field);
10889         Field += NewDaclSize;
10890     }
10891 
10892 
10893     <span class="keywordflow">if</span> ( (NewControlBits &amp; SE_DACL_PRESENT) == 0 ) {
10894 
10895         <span class="comment">//</span>
10896         <span class="comment">// Propagate the SE_DACL_DEFAULTED and SE_DACL_PRESENT</span>
10897         <span class="comment">// bits from the old security descriptor into the new</span>
10898         <span class="comment">// one.</span>
10899         <span class="comment">//</span>
10900 
10901         RtlpPropagateControlBits(
10902             NewDescriptor,
10903             *IObjectsSecurityDescriptor,
10904             SE_DACL_DEFAULTED | SE_DACL_PRESENT | SE_DACL_PROTECTED
10905             );
10906 
10907     }
10908 
10909 <span class="comment">//         if new item {</span>
10910 <span class="comment">//             PRESENT=TRUE</span>
10911 <span class="comment">//             DEFAULTED=FALSE</span>
10912 <span class="comment">//             if (NULL) {</span>
10913 <span class="comment">//                 set new pointer to NULL</span>
10914 <span class="comment">//             } else {</span>
10915 <span class="comment">//                 copy into new SD</span>
10916 <span class="comment">//             }</span>
10917 <span class="comment">//         } else {</span>
10918 <span class="comment">//             copy PRESENT bit</span>
10919 <span class="comment">//             copy DEFAULTED bit</span>
10920 <span class="comment">//             if (NULL) {</span>
10921 <span class="comment">//                 set new pointer to NULL</span>
10922 <span class="comment">//             } else {</span>
10923 <span class="comment">//                 copy old one into new SD</span>
10924 <span class="comment">//             }</span>
10925 <span class="comment">//         }</span>
10926 
10927 
10928     <span class="comment">//</span>
10929     <span class="comment">// Fill in Owner field in new SD</span>
10930     <span class="comment">//</span>
10931 
10932     RtlCopyMemory( Field, NewOwner, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewOwner) );
10933     NewDescriptor-&gt;Owner = RtlPointerToOffset(Base,Field);
10934     Field += NewOwnerSize;
10935 
10936     <span class="keywordflow">if</span> (!NewOwnerPresent) {
10937 
10938         <span class="comment">//</span>
10939         <span class="comment">// Propagate the SE_OWNER_DEFAULTED bit from the old SD.</span>
10940         <span class="comment">// If a new owner is being assigned, we want to leave</span>
10941         <span class="comment">// SE_OWNER_DEFAULTED off, which means leave it alone.</span>
10942         <span class="comment">//</span>
10943 
10944         RtlpPropagateControlBits(
10945             NewDescriptor,
10946             *IObjectsSecurityDescriptor,
10947             SE_OWNER_DEFAULTED
10948             );
10949 
10950     } <span class="keywordflow">else</span> {
10951         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !RtlpAreControlBitsSet( NewDescriptor, SE_OWNER_DEFAULTED ) );
10952     }
10953 
10954 
10955     <span class="comment">//</span>
10956     <span class="comment">// Fill in Group field in new SD</span>
10957     <span class="comment">//</span>
10958 
10959     <span class="keywordflow">if</span> ( NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10960         RtlCopyMemory( Field, NewGroup, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(NewGroup) );
10961         NewDescriptor-&gt;Group = RtlPointerToOffset(Base,Field);
10962     }
10963 
10964     <span class="keywordflow">if</span> (!NewGroupPresent) {
10965 
10966         <span class="comment">//</span>
10967         <span class="comment">// Propagate the SE_GROUP_DEFAULTED bit from the old SD</span>
10968         <span class="comment">// If a new owner is being assigned, we want to leave</span>
10969         <span class="comment">// SE_GROUP_DEFAULTED off, which means leave it alone.</span>
10970         <span class="comment">//</span>
10971 
10972         RtlpPropagateControlBits(
10973             NewDescriptor,
10974             *IObjectsSecurityDescriptor,
10975             SE_GROUP_DEFAULTED
10976             );
10977     } <span class="keywordflow">else</span> {
10978         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !RtlpAreControlBitsSet( NewDescriptor, SE_GROUP_DEFAULTED ) );
10979 
10980     }
10981 
10982     <span class="comment">//</span>
10983     <span class="comment">// Free old descriptor</span>
10984     <span class="comment">//</span>
10985 
10986     <span class="comment">// Kernel version doesn't free the old descriptor</span>
10987 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
10988 <span class="preprocessor"></span>    <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID) *IObjectsSecurityDescriptor );
10989 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
10990 <span class="preprocessor"></span>
10991     *ObjectsSecurityDescriptor = (PSECURITY_DESCRIPTOR)NewDescriptor;
10992     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
10993 
10994 Cleanup:
10995     <span class="keywordflow">if</span> ( LocalDaclAllocated ) {
10996 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
10997 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LocalDacl );
10998 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
10999 <span class="preprocessor"></span>        <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, LocalDacl );
11000 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
11001 <span class="preprocessor"></span>    }
11002     <span class="keywordflow">if</span> ( LocalSaclAllocated ) {
11003 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
11004 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LocalSacl );
11005 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
11006 <span class="preprocessor"></span>        <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, LocalSacl );
11007 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
11008 <span class="preprocessor"></span>    }
11009     <span class="keywordflow">if</span> (ServerAclAllocated) {
11010 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
11011 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ServerDacl );
11012 <span class="preprocessor">#else // NTOS_KERNEL_RUNTIME</span>
11013 <span class="preprocessor"></span>        <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, ServerDacl );
11014 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
11015 <span class="preprocessor"></span>    }
11016 
11017     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
11018 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="sertl.c::RtlpValidateSDOffsetAndSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpValidateSDOffsetAndSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MinLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l11020">11020</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l11089">RtlValidRelativeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>11028                    :
11029 
11030     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> validates offsets within a SecurityDescriptor.
11031     It checks that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure can have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> length,
11032     not overlap with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fixed header and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum size
11033     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> item and longword alignment.
11034 
11035 Arguments:
11036 
11037     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> from start of SD of structure to validate
11038     Length - Total size of SD
11039     MinLength - Minimum size <span class="keyword">this</span> structure can be
11040     MaxLength - Retuns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum length <span class="keyword">this</span> item can be given by
11041                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enclosing structure.
11042 
11043 Return Value:
11044 
11045     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> item <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid
11046 
11047 
11048 --*/
11049 
11050 {
11051     ULONG Left;
11052 
11053     *MaxLength = 0;
11054     <span class="comment">//</span>
11055     <span class="comment">// Don't allow overlap with header just in case caller modifies control bits etc</span>
11056     <span class="comment">//</span>
11057     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &lt; <span class="keyword">sizeof</span> (SECURITY_DESCRIPTOR_RELATIVE)) {
11058        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11059     }
11060 
11061     <span class="comment">//</span>
11062     <span class="comment">// Don't allow offsets beyond the end of the buffer</span>
11063     <span class="comment">//</span>
11064     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt;= Length) {
11065        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11066     }
11067 
11068     <span class="comment">//</span>
11069     <span class="comment">// Calculate maximim size of segment and check its limits</span>
11070     <span class="comment">//</span>
11071     Left = Length - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
11072 
11073     <span class="keywordflow">if</span> (Left &lt; MinLength) {
11074        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11075     }
11076 
11077     <span class="comment">//</span>
11078     <span class="comment">// Reject unaligned offsets</span>
11079     <span class="comment">//</span>
11080     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<span class="keyword">sizeof</span> (ULONG) - 1)) {
11081        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11082     }
11083     *MaxLength = Left;
11084     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
11085 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="sertl.c::RtlpValidOwnerSubjectContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpValidOwnerSubjectContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Owner</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03544">3544</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00231">NtPrivilegeCheck()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>.
<p>
<pre class="fragment"><div>03552                    :
03553 
03554     This routine checks to see whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject
03555     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> authorized to assign as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of objects.
03556 
03557 Arguments:
03558 
03559     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject's effective token
03560 
03561     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID to be checked.
03562 
03563     ServerObject - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> indicating whether or not <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a server
03564        object, meaning <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">protected</span> by a primary-client combination.
03565 
03566     ReturnStatus - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> to be passed back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
03567 
03568 Return Value:
03569 
03570     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
03571 
03572 --*/
03573 
03574 {
03575     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03576 
03577     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03578     BOOLEAN Found;
03579     ULONG ReturnLength;
03580     PTOKEN_GROUPS GroupIds = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03581     PTOKEN_USER UserId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03582     PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
03583     HANDLE TokenToUse;
03584 
03585     BOOLEAN HasPrivilege;
03586     PRIVILEGE_SET PrivilegeSet;
03587 
03588     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03589 
03590     <span class="comment">//</span>
03591     <span class="comment">// Get the handle to the current process heap</span>
03592     <span class="comment">//</span>
03593 
03594     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03595         *ReturnStatus = STATUS_INVALID_OWNER;
03596         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03597     }
03598 
03599     <span class="comment">//</span>
03600     <span class="comment">// If it's not a server object, check the owner against the contents of the</span>
03601     <span class="comment">// client token.  If it is a server object, the owner must be valid in the</span>
03602     <span class="comment">// primary token.</span>
03603     <span class="comment">//</span>
03604 
03605     <span class="keywordflow">if</span> (!ServerObject) {
03606 
03607         TokenToUse = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
03608 
03609     } <span class="keywordflow">else</span> {
03610 
03611         *ReturnStatus = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
03612                             NtCurrentProcess(),
03613                             TOKEN_QUERY,
03614                             &amp;TokenToUse
03615                             );
03616 
03617         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( *ReturnStatus )) {
03618             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03619         }
03620     }
03621 
03622     <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
03623 
03624     <span class="comment">//</span>
03625     <span class="comment">//  Get the User from the Token</span>
03626     <span class="comment">//</span>
03627 
03628     *ReturnStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03629                          TokenToUse,
03630                          TokenUser,
03631                          UserId,
03632                          0,
03633                          &amp;ReturnLength
03634                          );
03635 
03636     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( *ReturnStatus ) &amp;&amp; (STATUS_BUFFER_TOO_SMALL != *ReturnStatus)) {
03637         <span class="keywordflow">if</span> (ServerObject) {
03638             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TokenToUse );
03639         }
03640         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03641 
03642     }
03643 
03644     UserId = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, 0, ReturnLength );
03645 
03646     <span class="keywordflow">if</span> (UserId == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03647 
03648         *ReturnStatus = STATUS_NO_MEMORY;
03649         <span class="keywordflow">if</span> (ServerObject) {
03650             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TokenToUse );
03651         }
03652 
03653         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03654     }
03655 
03656     *ReturnStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03657                          TokenToUse,
03658                          TokenUser,
03659                          UserId,
03660                          ReturnLength,
03661                          &amp;ReturnLength
03662                          );
03663 
03664     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( *ReturnStatus )) {
03665         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)UserId );
03666         <span class="keywordflow">if</span> (ServerObject) {
03667             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TokenToUse );
03668         }
03669         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03670     }
03671 
03672     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( Owner, UserId-&gt;User.Sid ) ) {
03673 
03674         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)UserId );
03675         <span class="keywordflow">if</span> (ServerObject) {
03676             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TokenToUse );
03677         }
03678         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03679     }
03680 
03681     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, (PVOID)UserId );
03682 
03683     <span class="comment">//</span>
03684     <span class="comment">// Get the groups from the Token</span>
03685     <span class="comment">//</span>
03686 
03687     *ReturnStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03688                          TokenToUse,
03689                          TokenGroups,
03690                          GroupIds,
03691                          0,
03692                          &amp;ReturnLength
03693                          );
03694 
03695     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( *ReturnStatus ) &amp;&amp; (STATUS_BUFFER_TOO_SMALL != *ReturnStatus)) {
03696 
03697         <span class="keywordflow">if</span> (ServerObject) {
03698             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TokenToUse );
03699         }
03700         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03701     }
03702 
03703     GroupIds = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, 0, ReturnLength );
03704 
03705     <span class="keywordflow">if</span> (GroupIds == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03706 
03707         *ReturnStatus = STATUS_NO_MEMORY;
03708         <span class="keywordflow">if</span> (ServerObject) {
03709             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TokenToUse );
03710         }
03711         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03712     }
03713 
03714     *ReturnStatus = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
03715                          TokenToUse,
03716                          TokenGroups,
03717                          GroupIds,
03718                          ReturnLength,
03719                          &amp;ReturnLength
03720                          );
03721 
03722     <span class="keywordflow">if</span> (ServerObject) {
03723         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TokenToUse );
03724     }
03725 
03726     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( *ReturnStatus )) {
03727         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, GroupIds );
03728         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03729     }
03730 
03731     <span class="comment">//</span>
03732     <span class="comment">//  Walk through the list of group IDs looking for a match to</span>
03733     <span class="comment">//  the specified SID.  If one is found, make sure it may be</span>
03734     <span class="comment">//  assigned as an owner.</span>
03735     <span class="comment">//</span>
03736     <span class="comment">//  This code is similar to that performed to set the default</span>
03737     <span class="comment">//  owner of a token (NtSetInformationToken).</span>
03738     <span class="comment">//</span>
03739 
03740     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
03741     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; GroupIds-&gt;GroupCount) {
03742 
03743         Found = <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
03744                     Owner,
03745                     GroupIds-&gt;Groups[Index].Sid
03746                     );
03747 
03748         <span class="keywordflow">if</span> ( Found ) {
03749 
03750             <span class="keywordflow">if</span> ( RtlpIdAssignableAsOwner(GroupIds-&gt;Groups[Index])) {
03751 
03752                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, GroupIds );
03753                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03754 
03755             } <span class="keywordflow">else</span> {
03756 
03757                 <span class="keywordflow">break</span>;
03758 
03759             } <span class="comment">//endif assignable</span>
03760 
03761         }  <span class="comment">//endif Found</span>
03762 
03763         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++;
03764 
03765     } <span class="comment">//endwhile</span>
03766 
03767     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, 0, GroupIds );
03768 
03769     <span class="comment">//</span>
03770     <span class="comment">// If we are going to fail this call, check for Restore privilege,</span>
03771     <span class="comment">// and succeed if he has it.</span>
03772     <span class="comment">//</span>
03773 
03774     <span class="comment">//</span>
03775     <span class="comment">// Check for appropriate Privileges</span>
03776     <span class="comment">//</span>
03777     <span class="comment">// Audit/Alarm messages need to be generated due to the attempt</span>
03778     <span class="comment">// to perform a privileged operation.</span>
03779     <span class="comment">//</span>
03780 
03781     PrivilegeSet.PrivilegeCount = 1;
03782     PrivilegeSet.Control = PRIVILEGE_SET_ALL_NECESSARY;
03783     PrivilegeSet.Privilege[0].Luid = RtlConvertLongToLuid(SE_RESTORE_PRIVILEGE);
03784     PrivilegeSet.Privilege[0].Attributes = 0;
03785 
03786     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d4/privileg_8c.html#a2">NtPrivilegeCheck</a>(
03787                 Token,
03788                 &amp;PrivilegeSet,
03789                 &amp;HasPrivilege
03790                 );
03791 
03792     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
03793         HasPrivilege = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03794     }
03795 
03796     <span class="keywordflow">if</span> ( HasPrivilege ) {
03797         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03798     } <span class="keywordflow">else</span> {
03799         *ReturnStatus = STATUS_INVALID_OWNER;
03800         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03801     }
03802 }
<span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="sertl.c::RtlRunDecodeUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlRunDecodeUnicodeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Seed</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00520">520</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d5/d3/tprefix_8c-source.html#l00032">Seed</a>, and <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/editec_8c-source.html#l00052">ECLock()</a>.
<p>
<pre class="fragment"><div>00526                    :
00527 
00528     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inverse of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function performed
00529     by <a class="code" href="../../d8/d6/sertl_8c.html#a31">RtlRunEncodeUnicodeString</a>().  Please see <a class="code" href="../../d8/d6/sertl_8c.html#a31">RtlRunEncodeUnicodeString</a>()
00530     for details.
00531 
00532 
00533 Arguments:
00534 
00535     Seed - The seed value to use in RtlRunEncodeUnicodeString().
00536 
00537     String - The string to reveal.
00538 
00539 
00540 Return Value:
00541 
00542     None - Nothing can really go wrong unless the caller passes bogus
00543         parameters.  In this case, the caller can catch the access
00544         violation.
00545 
00546 
00547 --*/
00548 
00549 {
00550 
00551     ULONG
00552         i;
00553 
00554     PSTRING
00555         S;
00556 
00557     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00558 
00559     <span class="comment">//</span>
00560     <span class="comment">// Typecast so we can work on bytes rather than WCHARs</span>
00561     <span class="comment">//</span>
00562 
00563     S = (PSTRING)((PVOID)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>);
00564 
00565 
00566     <span class="comment">//</span>
00567     <span class="comment">// Transform the end of the string</span>
00568     <span class="comment">//</span>
00569 
00570     <span class="keywordflow">for</span> (i=S-&gt;Length; i&gt;1; i--) {
00571 
00572         <span class="comment">//</span>
00573         <span class="comment">// a simple running XOR with the previous byte and the</span>
00574         <span class="comment">// seed value.</span>
00575         <span class="comment">//</span>
00576 
00577         S-&gt;Buffer[i-1] ^= (S-&gt;Buffer[i-2]^<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>);
00578 
00579     }
00580 
00581     <span class="comment">//</span>
00582     <span class="comment">// Finally, transform the initial byte</span>
00583     <span class="comment">//</span>
00584 
00585     <span class="keywordflow">if</span> (S-&gt;Length &gt;= 1) {
00586         S-&gt;Buffer[0] ^= (<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> | 0X43);
00587     }
00588 
00589 
00590     <span class="keywordflow">return</span>;
00591 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="sertl.c::RtlRunEncodeUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlRunEncodeUnicodeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUCHAR <a class="el" href="../../d1/d1/theap_8c.html#a17">Seed</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00388">388</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, and <a class="el" href="../../d7/d5/ttime_8c-source.html#l00047">Time</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/editec_8c-source.html#l00086">ECUnlock()</a>.
<p>
<pre class="fragment"><div>00395                    :
00396 
00397     This function performs a trivial XOR run-encoding of a string.
00398     The purpose of <span class="keyword">this</span> run-encoding <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> character values
00399     to appear somewhat random and typically not printable.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00400     useful <span class="keywordflow">for</span> transforming passwords that you don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> want to be easily
00401     distinguishable by visually scanning a paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or memory dump.
00402 
00403 
00404 Arguments:
00405 
00406     <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> - Points to a seed value to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> encoding.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00407         pointed to value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, then <span class="keyword">this</span> routine will assign
00408         a value.
00409 
00410     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - The string to encode.  This string may be decode
00411         by passing <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> seed value to <a class="code" href="../../d8/d6/sertl_8c.html#a32">RtlRunDecodeUnicodeString</a>().
00412 
00413 
00414 Return Value:
00415 
00416     None - Nothing can really go wrong unless <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller passes bogus
00417         parameters.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller can <span class="keywordflow">catch</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access
00418         violation.
00419 
00420 
00421 --*/
00422 {
00423 
00424     LARGE_INTEGER <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>;
00425     PUCHAR        LocalSeed;
00426     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00427     ULONG         i;
00428     PSTRING       S;
00429 
00430 
00431     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Typecast so we can work on bytes rather than WCHARs</span>
00435     <span class="comment">//</span>
00436 
00437     S = (PSTRING)((PVOID)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>);
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">// If a seed wasn't passed, use the 2nd byte of current time.</span>
00441     <span class="comment">// This byte seems to be sufficiently random (by observation).</span>
00442     <span class="comment">//</span>
00443 
00444     <span class="keywordflow">if</span> ((*Seed) == 0) {
00445         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = NtQuerySystemTime ( &amp;Time );
00446         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00447 
00448         LocalSeed = (PUCHAR)((PVOID)&amp;<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>);
00449 
00450         i = 1;
00451 
00452         (*Seed) = LocalSeed[ i ];
00453 
00454         <span class="comment">//</span>
00455         <span class="comment">// Occasionally, this byte could be zero.  That would cause the</span>
00456         <span class="comment">// string to become un-decodable, since 0 is the magic value that</span>
00457         <span class="comment">// causes us to re-gen the seed.  This loop makes sure that we</span>
00458         <span class="comment">// never end up with a zero byte (unless time is zero, as well).</span>
00459         <span class="comment">//</span>
00460 
00461         <span class="keywordflow">while</span> ( ((*Seed) == 0) &amp;&amp; ( i &lt; <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> ) ) )
00462         {
00463             (*Seed) |= LocalSeed[ i++ ] ;
00464         }
00465 
00466         <span class="keywordflow">if</span> ( (*Seed) == 0 )
00467         {
00468             (*Seed) = 1;
00469         }
00470     }
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// Transform the initial byte.</span>
00474     <span class="comment">// The funny constant just keeps the first byte from propagating</span>
00475     <span class="comment">// into the second byte in the next step.  Without a funny constant</span>
00476     <span class="comment">// this would happen for many languages (which typically have every</span>
00477     <span class="comment">// other byte zero.</span>
00478     <span class="comment">//</span>
00479     <span class="comment">//</span>
00480 
00481     <span class="keywordflow">if</span> (S-&gt;Length &gt;= 1) {
00482         S-&gt;Buffer[0] ^= ((*Seed) | 0X43);
00483     }
00484 
00485 
00486     <span class="comment">//</span>
00487     <span class="comment">// Now transform the rest of the string</span>
00488     <span class="comment">//</span>
00489 
00490     <span class="keywordflow">for</span> (i=1; i&lt;S-&gt;Length; i++) {
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">//  There are export issues that cause us to want to</span>
00494         <span class="comment">//  keep this algorithm simple.  Please don't change it</span>
00495         <span class="comment">//  without checking with JimK first.  Thanks.</span>
00496         <span class="comment">//</span>
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// In order to be compatible with zero terminated unicode strings,</span>
00500         <span class="comment">//  this algorithm is designed to not produce a wide character of</span>
00501         <span class="comment">//  zero as long a the seed is not zero.</span>
00502         <span class="comment">//</span>
00503 
00504         <span class="comment">//</span>
00505         <span class="comment">// Simple running XOR with the previous byte and the</span>
00506         <span class="comment">// seed value.</span>
00507         <span class="comment">//</span>
00508 
00509         S-&gt;Buffer[i] ^= (S-&gt;Buffer[i-1]^(*Seed));
00510 
00511     }
00512 
00513 
00514     <span class="keywordflow">return</span>;
00515 
00516 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="sertl.c::RtlSetAttributesSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetAttributesSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_DESCRIPTOR_CONTROL&nbsp;</td>
          <td class="mdname" nowrap> <em>Control</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Revision</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02386">2386</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02472">RtlSetControlSecurityDescriptor()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l00370">SE_VALID_CONTROL_BITS</a>.
<p>
<pre class="fragment"><div>02391 {
02392     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02393 
02394     <span class="comment">//</span>
02395     <span class="comment">// Always return the revision value - even if this isn't a valid</span>
02396     <span class="comment">// security descriptor</span>
02397     <span class="comment">//</span>
02398 
02399     *Revision = ((SECURITY_DESCRIPTOR *)SecurityDescriptor)-&gt;Revision;
02400 
02401     <span class="keywordflow">if</span> ( ((SECURITY_DESCRIPTOR *)SecurityDescriptor)-&gt;Revision
02402          != SECURITY_DESCRIPTOR_REVISION ) {
02403         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
02404     }
02405 
02406     <span class="comment">// BUGBUG: This is a worthless API.  There is no way to turn any of the bits off.</span>
02407     <span class="comment">// Use the newer RtlSetControlSecurityDescriptor.</span>
02408     Control &amp;= <a class="code" href="../../d8/d6/sertl_8c.html#a2">SE_VALID_CONTROL_BITS</a>;
02409     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a59">RtlSetControlSecurityDescriptor</a> ( SecurityDescriptor, Control, Control );
02410 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="sertl.c::RtlSetControlSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetControlSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>pSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_DESCRIPTOR_CONTROL&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlBitsOfInterest</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_DESCRIPTOR_CONTROL&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlBitsToSet</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02472">2472</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l00370">SE_VALID_CONTROL_BITS</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l02386">RtlSetAttributesSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>02479                    :
02480 
02481     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> information in a security descriptor.
02482 
02483 
02484     For instance,
02485 
02486         SetSecurityDescriptorControl( &amp;SecDesc,
02487                                       SE_DACL_PROTECTED,
02488                                       SE_DACL_PROTECTED );
02489 
02490     marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor as <span class="keyword">protected</span>. And
02491 
02492         SetSecurityDescriptorControl( &amp;SecDesc,
02493                                       SE_DACL_PROTECTED,
02494                                       0 );
02495 
02496 
02497     marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL as not <span class="keyword">protected</span>.
02498 
02499 Arguments:
02500 
02501     pSecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
02502 
02503     ControlBitsOfInterest - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> mask of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> bits being changed, set,
02504         or reset by <span class="keyword">this</span> call.  The mask <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logical OR of one or more of
02505         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following flags:
02506 
02507             SE_DACL_UNTRUSTED
02508             SE_SERVER_SECURITY
02509             SE_DACL_AUTO_INHERIT_REQ
02510             SE_SACL_AUTO_INHERIT_REQ
02511             SE_DACL_AUTO_INHERITED
02512             SE_SACL_AUTO_INHERITED
02513             SE_DACL_PROTECTED
02514             SE_SACL_PROTECTED
02515 
02516     ControlBitsToSet - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> mask indicating what <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bits specified by ControlBitsOfInterest
02517         should be set to.
02518 
02519 Return Value:
02520 
02521     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">for</span> success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">for</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.  Extended error status
02522     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available <span class="keyword">using</span> GetLastError.
02523 
02524 --*/
02525 {
02526     <span class="comment">//</span>
02527     <span class="comment">// Ensure the caller passed valid bits.</span>
02528     <span class="comment">//</span>
02529 
02530     <span class="keywordflow">if</span> ( (ControlBitsOfInterest &amp; ~<a class="code" href="../../d8/d6/sertl_8c.html#a2">SE_VALID_CONTROL_BITS</a>) != 0 ||
02531          (ControlBitsToSet &amp; ~ControlBitsOfInterest) != 0 ) {
02532         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02533     }
02534 
02535     ((SECURITY_DESCRIPTOR *)pSecurityDescriptor)-&gt;Control &amp;= ~ControlBitsOfInterest;
02536     ((SECURITY_DESCRIPTOR *)pSecurityDescriptor)-&gt;Control |= ControlBitsToSet;
02537 
02538     <span class="keywordflow">return</span> STATUS_SUCCESS;
02539 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="sertl.c::RtlSetDaclSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetDaclSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DaclPresent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL <a class="el" href="../../d2/d1/cttoken_8c.html#a55">Dacl</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN DaclDefaulted&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">2543</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00705">CreateBSMEventSD()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01865">InternalCreateCallbackThread()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05813">IoCreateUnprotectedSymbolicLink()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00168">IopApplySystemPartitionProt()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12098">IopCreateDefaultDeviceSecurityDescriptor()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">ObpGetDosDevicesProtection()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>, <a class="el" href="../../d0/d5/seinit_8c-source.html#l00184">SepInitializationPhase1()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00651">SepInitSystemDacls()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00213">TestSeNamedCreate()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00167">TestTokenInitialize()</a>.
<p>
<pre class="fragment"><div>02552                    :
02553 
02554     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> discretionary ACL information of an absolute
02555     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> security descriptor.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already a discretionary ACL
02556     present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> superseded.
02557 
02558 Arguments:
02559 
02560     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor to be which
02561         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> discretionary ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be added.
02562 
02563     DaclPresent - If <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DaclPresent flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02564         security descriptor should be set to <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  In <span class="keyword">this</span> <span class="keywordflow">case</span>,
02565         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining optional parameters are ignored.  Otherwise,
02566         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DaclPresent <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02567         set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining optional parameters are not
02568         ignored.
02569 
02570     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> discretionary ACL <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02571         descriptor.  If <span class="keyword">this</span> optional parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not passed, then a
02572         null ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> null
02573         discretionary ACL unconditionally grants access.  The ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02574         referenced by, not copied into, by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
02575 
02576     DaclDefaulted - When set, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> discretionary ACL was
02577         picked up from some <span class="keywordflow">default</span> mechanism (rather than explicitly
02578         specified by a user).  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DaclDefaulted
02579         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.  If <span class="keyword">this</span> optional
02580         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not passed, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DaclDefaulted flag will be
02581         cleared.
02582 
02583 Return Value:
02584 
02585     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
02586 
02587     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02588         descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.  It may be a newer
02589         revision than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine knows about.
02590 
02591     STATUS_INVALID_SECURITY_DESCR - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
02592         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an absolute <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> security descriptor.
02593 
02594 
02595 --*/
02596 
02597 {
02598 
02599     <span class="comment">//</span>
02600     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
02601     <span class="comment">//</span>
02602 
02603     SECURITY_DESCRIPTOR *ISecurityDescriptor = SecurityDescriptor;
02604 
02605     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02606 
02607     <span class="comment">//</span>
02608     <span class="comment">// Check the revision</span>
02609     <span class="comment">//</span>
02610 
02611     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Revision != SECURITY_DESCRIPTOR_REVISION) {
02612        <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
02613     }
02614 
02615     <span class="comment">//</span>
02616     <span class="comment">// Make sure the descriptor is absolute format</span>
02617     <span class="comment">//</span>
02618 
02619     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Control &amp; SE_SELF_RELATIVE) {
02620         <span class="keywordflow">return</span> STATUS_INVALID_SECURITY_DESCR;
02621     }
02622 
02623     <span class="comment">//</span>
02624     <span class="comment">// Assign the DaclPresent flag value passed</span>
02625     <span class="comment">//</span>
02626 
02627 
02628     <span class="keywordflow">if</span> (DaclPresent) {
02629 
02630         ISecurityDescriptor-&gt;Control |= SE_DACL_PRESENT;
02631 
02632         <span class="comment">//</span>
02633         <span class="comment">// Assign the ACL address if passed, otherwise set to null.</span>
02634         <span class="comment">//</span>
02635 
02636         ISecurityDescriptor-&gt;Dacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02637         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Dacl)) {
02638             ISecurityDescriptor-&gt;Dacl = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
02639         }
02640 
02641 
02642 
02643 
02644         <span class="comment">//</span>
02645         <span class="comment">// Assign DaclDefaulted flag if passed, otherwise clear it.</span>
02646         <span class="comment">//</span>
02647 
02648         ISecurityDescriptor-&gt;Control &amp;= ~SE_DACL_DEFAULTED;
02649         <span class="keywordflow">if</span> (DaclDefaulted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02650             ISecurityDescriptor-&gt;Control |= SE_DACL_DEFAULTED;
02651         }
02652     } <span class="keywordflow">else</span> {
02653 
02654         ISecurityDescriptor-&gt;Control &amp;= ~SE_DACL_PRESENT;
02655 
02656     }
02657 
02658 
02659     <span class="keywordflow">return</span> STATUS_SUCCESS;
02660 
02661 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="sertl.c::RtlSetGroupSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetGroupSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID <a class="el" href="../../d2/d1/cttoken_8c.html#a54">Group</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN GroupDefaulted&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l03135">3135</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00160">Group</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>03143                    :
03144 
03145     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary group information of an absolute security
03146     descriptor.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already an primary group present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03147     security descriptor, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> superseded.
03148 
03149 Arguments:
03150 
03151     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor in which
03152         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary group <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be set.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
03153         already includes a primary group, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be superseded by
03154         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> group.
03155 
03156     <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary group SID <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
03157         descriptor.  If <span class="keyword">this</span> optional parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not passed, then
03158         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary group <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleared (indicating the security
03159         descriptor has no primary group).  The SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced by,
03160         not copied into, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
03161 
03162     GroupDefaulted - When set, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner was picked up from
03163         some <span class="keywordflow">default</span> mechanism (rather than explicitly specified by a
03164         user).  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OwnerDefaulted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flag
03165         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.  If <span class="keyword">this</span> optional parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03166         not passed, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SaclDefaulted flag will be cleared.
03167 
03168 Return Value:
03169 
03170     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
03171 
03172     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
03173         descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.  It may be a newer
03174         revision than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine knows about.
03175 
03176     STATUS_INVALID_SECURITY_DESCR - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
03177         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an absolute <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> security descriptor.
03178 
03179 
03180 --*/
03181 
03182 {
03183 
03184     <span class="comment">//</span>
03185     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
03186     <span class="comment">//</span>
03187 
03188     SECURITY_DESCRIPTOR *ISecurityDescriptor = SecurityDescriptor;
03189 
03190     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03191 
03192     <span class="comment">//</span>
03193     <span class="comment">// Check the revision</span>
03194     <span class="comment">//</span>
03195 
03196     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Revision != SECURITY_DESCRIPTOR_REVISION) {
03197         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
03198     }
03199 
03200     <span class="comment">//</span>
03201     <span class="comment">// Make sure the descriptor is absolute format</span>
03202     <span class="comment">//</span>
03203 
03204     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Control &amp; SE_SELF_RELATIVE) {
03205         <span class="keywordflow">return</span> STATUS_INVALID_SECURITY_DESCR;
03206     }
03207 
03208     <span class="comment">//</span>
03209     <span class="comment">// Assign the Group field if passed, otherwise clear it.</span>
03210     <span class="comment">//</span>
03211 
03212     ISecurityDescriptor-&gt;Group = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03213     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Group)) {
03214         ISecurityDescriptor-&gt;Group = <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>;
03215     }
03216 
03217     <span class="comment">//</span>
03218     <span class="comment">// Assign the GroupDefaulted flag if passed, otherwise clear it.</span>
03219     <span class="comment">//</span>
03220 
03221     ISecurityDescriptor-&gt;Control &amp;= ~SE_GROUP_DEFAULTED;
03222     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(GroupDefaulted)) {
03223         ISecurityDescriptor-&gt;Control |= SE_GROUP_DEFAULTED;
03224     }
03225 
03226     <span class="keywordflow">return</span> STATUS_SUCCESS;
03227 
03228 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="sertl.c::RtlSetOwnerSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetOwnerSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID <a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN OwnerDefaulted&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02963">2963</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>02971                    :
02972 
02973     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner information of an absolute security
02974     descriptor.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already an owner present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02975     descriptor, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> superseded.
02976 
02977 Arguments:
02978 
02979     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor in which
02980         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be set.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor already
02981         includes an owner, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be superseded by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> owner.
02982 
02983     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner SID <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.  If
02984         <span class="keyword">this</span> optional parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not passed, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02985         cleared (indicating the security descriptor has no owner).
02986         The SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced by, not copied into, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02987         descriptor.
02988 
02989     OwnerDefaulted - When set, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner was picked up from
02990         some <span class="keywordflow">default</span> mechanism (rather than explicitly specified by a
02991         user).  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OwnerDefaulted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flag
02992         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.  If <span class="keyword">this</span> optional parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02993         not passed, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SaclDefaulted flag will be cleared.
02994 
02995 Return Value:
02996 
02997     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
02998 
02999     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
03000         descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.  It may be a newer
03001         revision than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine knows about.
03002 
03003     STATUS_INVALID_SECURITY_DESCR - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
03004         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an absolute <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> security descriptor.
03005 
03006 
03007 --*/
03008 
03009 {
03010 
03011     <span class="comment">//</span>
03012     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
03013     <span class="comment">//</span>
03014 
03015     SECURITY_DESCRIPTOR *ISecurityDescriptor = SecurityDescriptor;
03016 
03017     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03018 
03019     <span class="comment">//</span>
03020     <span class="comment">// Check the revision</span>
03021     <span class="comment">//</span>
03022 
03023     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Revision != SECURITY_DESCRIPTOR_REVISION) {
03024         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
03025     }
03026 
03027     <span class="comment">//</span>
03028     <span class="comment">// Make sure the descriptor is absolute format</span>
03029     <span class="comment">//</span>
03030 
03031     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Control &amp; SE_SELF_RELATIVE) {
03032         <span class="keywordflow">return</span> STATUS_INVALID_SECURITY_DESCR;
03033     }
03034 
03035     <span class="comment">//</span>
03036     <span class="comment">// Assign the Owner field if passed, otherwise clear it.</span>
03037     <span class="comment">//</span>
03038 
03039     ISecurityDescriptor-&gt;Owner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03040     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Owner)) {
03041         ISecurityDescriptor-&gt;Owner = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
03042     }
03043 
03044     <span class="comment">//</span>
03045     <span class="comment">// Assign the OwnerDefaulted flag if passed, otherwise clear it.</span>
03046     <span class="comment">//</span>
03047 
03048     ISecurityDescriptor-&gt;Control &amp;= ~SE_OWNER_DEFAULTED;
03049     <span class="keywordflow">if</span> (OwnerDefaulted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03050         ISecurityDescriptor-&gt;Control |= SE_OWNER_DEFAULTED;
03051     }
03052 
03053     <span class="keywordflow">return</span> STATUS_SUCCESS;
03054 
03055 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="sertl.c::RtlSetSaclSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetSaclSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SaclPresent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL Sacl&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN SaclDefaulted&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02756">2756</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>02765                    :
02766 
02767     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system ACL information of an absolute security
02768     descriptor.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already a system ACL present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02769     security descriptor, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> superseded.
02770 
02771 Arguments:
02772 
02773     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor to be which
02774         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be added.
02775 
02776     SaclPresent - If <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SaclPresent flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02777         security descriptor should be set to <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  In <span class="keyword">this</span> <span class="keywordflow">case</span>,
02778         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining optional parameters are ignored.  Otherwise,
02779         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SaclPresent <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02780         set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining optional parameters are not
02781         ignored.
02782 
02783     Sacl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system ACL <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.  If
02784         <span class="keyword">this</span> optional parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not passed, then a null ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02785         assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.  The ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced
02786         by, not copied into, by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
02787 
02788     SaclDefaulted - When set, indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system ACL was picked up
02789         from some <span class="keywordflow">default</span> mechanism (rather than explicitly specified
02790         by a user).  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SaclDefaulted <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
02791         flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.  If <span class="keyword">this</span> optional parameter
02792         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not passed, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SaclDefaulted flag will be cleared.
02793 
02794 Return Value:
02795 
02796     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call completed successfully.
02797 
02798     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
02799         descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.  It may be a newer
02800         revision than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine knows about.
02801 
02802     STATUS_INVALID_SECURITY_DESCR - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
02803         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an absolute <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> security descriptor.
02804 
02805 
02806 --*/
02807 
02808 {
02809 
02810     <span class="comment">//</span>
02811     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
02812     <span class="comment">//</span>
02813 
02814     SECURITY_DESCRIPTOR *ISecurityDescriptor = SecurityDescriptor;
02815 
02816     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02817 
02818     <span class="comment">//</span>
02819     <span class="comment">// Check the revision</span>
02820     <span class="comment">//</span>
02821 
02822     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Revision != SECURITY_DESCRIPTOR_REVISION) {
02823         <span class="keywordflow">return</span> STATUS_UNKNOWN_REVISION;
02824     }
02825 
02826     <span class="comment">//</span>
02827     <span class="comment">// Make sure the descriptor is absolute format</span>
02828     <span class="comment">//</span>
02829 
02830     <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Control &amp; SE_SELF_RELATIVE) {
02831         <span class="keywordflow">return</span> STATUS_INVALID_SECURITY_DESCR;
02832     }
02833 
02834     <span class="comment">//</span>
02835     <span class="comment">// Assign the SaclPresent flag value passed</span>
02836     <span class="comment">//</span>
02837 
02838 
02839     <span class="keywordflow">if</span> (SaclPresent) {
02840 
02841         ISecurityDescriptor-&gt;Control |= SE_SACL_PRESENT;
02842 
02843         <span class="comment">//</span>
02844         <span class="comment">// Assign the ACL address if passed, otherwise set to null.</span>
02845         <span class="comment">//</span>
02846 
02847         ISecurityDescriptor-&gt;Sacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02848         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Sacl)) {
02849            ISecurityDescriptor-&gt;Sacl = Sacl;
02850         }
02851 
02852         <span class="comment">//</span>
02853         <span class="comment">// Assign SaclDefaulted flag if passed, otherwise clear it.</span>
02854         <span class="comment">//</span>
02855 
02856         ISecurityDescriptor-&gt;Control &amp;= ~ SE_SACL_DEFAULTED;
02857         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SaclDefaulted)) {
02858             ISecurityDescriptor-&gt;Control |= SE_SACL_DEFAULTED;
02859         }
02860     } <span class="keywordflow">else</span> {
02861 
02862         ISecurityDescriptor-&gt;Control &amp;= ~SE_SACL_PRESENT;
02863     }
02864 
02865     <span class="keywordflow">return</span> STATUS_SUCCESS;
02866 
02867 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="sertl.c::RtlSetSecurityDescriptorRMControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlSetSecurityDescriptorRMControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR RMControl&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l11370">11370</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
<pre class="fragment"><div>11377                    :
11378 
11379     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RM Control flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> field of
11380     SecurityDescriptor and sets Sbz1 to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> byte to which RMContol points.
11381     If RMControl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bits are cleared.
11382 
11383 Arguments:
11384 
11385     SecurityDescriptor - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SECURITY_DESCRIPTOR structure
11386     RMControl          - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flags to set. If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bits
11387                          are cleared.
11388 
11389 Note:
11390     Parameter validation has already been done in Advapi.
11391 
11392 
11393 --*/
11394 
11395 {
11396     PISECURITY_DESCRIPTOR ISecurityDescriptor = (PISECURITY_DESCRIPTOR) SecurityDescriptor;
11397 
11398     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RMControl)) {
11399         ISecurityDescriptor-&gt;Control |= SE_RM_CONTROL_VALID;
11400         ISecurityDescriptor-&gt;Sbz1 = *RMControl;
11401     } <span class="keywordflow">else</span> {
11402         ISecurityDescriptor-&gt;Control &amp;= ~SE_RM_CONTROL_VALID;
11403         ISecurityDescriptor-&gt;Sbz1 = 0;
11404     }
11405 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="sertl.c::RtlSubAuthorityCountSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUCHAR RtlSubAuthorityCountSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Sid</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01316">1316</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00447">DisplayAccountSid()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01915">GetMangledSiteSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, and <a class="el" href="../../d5/d5/tsevars_8c-source.html#l00167">TSeVariableInitialization()</a>.
<p>
<pre class="fragment"><div>01321                    :
01322 
01323     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sub-authority count field of
01324     an SID.
01325 
01326 Arguments:
01327 
01328     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID data structure.
01329 
01330 Return Value:
01331 
01332 
01333 --*/
01334 {
01335     PISID ISid;
01336 
01337     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01338 
01339     <span class="comment">//</span>
01340     <span class="comment">//  Typecast to the opaque SID</span>
01341     <span class="comment">//</span>
01342 
01343     ISid = (PISID)Sid;
01344 
01345     <span class="keywordflow">return</span> &amp;(ISid-&gt;SubAuthorityCount);
01346 
01347 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="sertl.c::RtlSubAuthoritySid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PULONG RtlSubAuthoritySid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SubAuthority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l01286">1286</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00447">DisplayAccountSid()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01915">GetMangledSiteSid()</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00511">InitVars()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00307">SepVariableInitialization()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, and <a class="el" href="../../d5/d5/tsevars_8c-source.html#l00167">TSeVariableInitialization()</a>.
<p>
<pre class="fragment"><div>01292                    :
01293 
01294     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a sub-authority array element of
01295     an SID.
01296 
01297 Arguments:
01298 
01299     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID data structure.
01300 
01301     SubAuthority - An index indicating which sub-authority <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being specified.
01302         This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not compared against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sub-authorities in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01303         SID <span class="keywordflow">for</span> validity.
01304 
01305 Return Value:
01306 
01307 
01308 --*/
01309 {
01310     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01311 
01312     <span class="keywordflow">return</span> RtlpSubAuthoritySid( Sid, SubAuthority );
01313 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="sertl.c::RtlValidRelativeSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlValidRelativeSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptorInput</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptorLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>RequiredInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l11089">11089</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l11020">RtlpValidateSDOffsetAndSize()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>11097                    :
11098 
11099     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> validates a SecurityDescriptor's structure
11100     contained within a flat buffer.  This involves validating
11101     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision levels of each component of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
11102     descriptor.
11103 
11104 Arguments:
11105 
11106     SecurityDescriptor - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SECURITY_DESCRIPTOR structure
11107         to validate.
11108     SecurityDescriptorLength - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of flat buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security
11109         descriptor.
11110     RequiredInformation - Which SD components must be present to be valid.
11111         OWNER_SECURITY_INFORMATION etc as a bit mask.
11112         OWNER_SECURITY_INFORMATION - There must be a valid owner SID
11113         GROUP_SECURITY_INFORMATION - There must be a valid group SID
11114         DACL_SECURITY_INFORMATION - Ignored
11115         SACL_SECURITY_INFORMATION - Ignored
11116 
11117 Return Value:
11118 
11119     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure of SecurityDescriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid.
11120 
11121 
11122 --*/
11123 
11124 {
11125     PISECURITY_DESCRIPTOR_RELATIVE SecurityDescriptor;
11126     PISID OwnerSid;
11127     PISID GroupSid;
11128     PACE_HEADER Ace;
11129     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
11130     PACL Sacl;
11131     ULONG MaxOwnerSidLength;
11132     ULONG MaxGroupSidLength;
11133     ULONG MaxDaclLength;
11134     ULONG MaxSaclLength;
11135 
11136     <span class="keywordflow">if</span> (SecurityDescriptorLength &lt; <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE)) {
11137         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11138     }
11139 
11140     <span class="comment">//</span>
11141     <span class="comment">// Check the revision information.</span>
11142     <span class="comment">//</span>
11143 
11144     <span class="keywordflow">if</span> (((PISECURITY_DESCRIPTOR) SecurityDescriptorInput)-&gt;Revision !=
11145              SECURITY_DESCRIPTOR_REVISION) {
11146         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11147     }
11148 
11149     <span class="comment">//</span>
11150     <span class="comment">// Make sure the passed SecurityDescriptor is in self-relative form</span>
11151     <span class="comment">//</span>
11152 
11153     <span class="keywordflow">if</span> (!(((PISECURITY_DESCRIPTOR) SecurityDescriptorInput)-&gt;Control &amp; SE_SELF_RELATIVE)) {
11154         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11155     }
11156 
11157     SecurityDescriptor = (PISECURITY_DESCRIPTOR_RELATIVE) SecurityDescriptorInput;
11158 
11159     <span class="comment">//</span>
11160     <span class="comment">// Validate the owner if it's there and see if its allowed to be missing</span>
11161     <span class="comment">//</span>
11162     <span class="keywordflow">if</span> (SecurityDescriptor-&gt;Owner == 0) {
11163         <span class="keywordflow">if</span> (RequiredInformation &amp; OWNER_SECURITY_INFORMATION) {
11164             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11165         }
11166     } <span class="keywordflow">else</span> {
11167         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a29">RtlpValidateSDOffsetAndSize</a> (SecurityDescriptor-&gt;Owner,
11168                                           SecurityDescriptorLength,
11169                                           sizeof (SID),
11170                                           &amp;MaxOwnerSidLength)) {
11171             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11172         }
11173         <span class="comment">//</span>
11174         <span class="comment">// It is safe to reference the owner's SubAuthorityCount, compute the</span>
11175         <span class="comment">// expected length of the SID</span>
11176         <span class="comment">//</span>
11177 
11178         OwnerSid = (PSID)RtlOffsetToPointer (SecurityDescriptor,
11179                                              SecurityDescriptor-&gt;Owner);
11180 
11181         <span class="keywordflow">if</span> (OwnerSid-&gt;Revision != SID_REVISION) {
11182             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11183         }
11184 
11185         <span class="keywordflow">if</span> (OwnerSid-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
11186             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11187         }
11188 
11189         <span class="keywordflow">if</span> (MaxOwnerSidLength &lt; (ULONG) <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a> (OwnerSid)) {
11190             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11191         }
11192 
11193     }
11194 
11195     <span class="comment">//</span>
11196     <span class="comment">// The owner appears to be a structurally valid SID that lies within</span>
11197     <span class="comment">// the bounds of the security descriptor.  Do the same for the Group</span>
11198     <span class="comment">// if there is one.</span>
11199     <span class="comment">//</span>
11200     <span class="comment">//</span>
11201     <span class="comment">// Validate the group if it's there and see if its allowed to be missing</span>
11202     <span class="comment">//</span>
11203     <span class="keywordflow">if</span> (SecurityDescriptor-&gt;Group == 0) {
11204         <span class="keywordflow">if</span> (RequiredInformation &amp; GROUP_SECURITY_INFORMATION) {
11205             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11206         }
11207     } <span class="keywordflow">else</span> {
11208         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a29">RtlpValidateSDOffsetAndSize</a> (SecurityDescriptor-&gt;Group,
11209                                           SecurityDescriptorLength,
11210                                           sizeof (SID),
11211                                           &amp;MaxGroupSidLength)) {
11212             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11213         }
11214         <span class="comment">//</span>
11215         <span class="comment">// It is safe to reference the group's SubAuthorityCount, compute the</span>
11216         <span class="comment">// expected length of the SID</span>
11217         <span class="comment">//</span>
11218 
11219         GroupSid = (PSID)RtlOffsetToPointer (SecurityDescriptor,
11220                                              SecurityDescriptor-&gt;Group);
11221 
11222         <span class="keywordflow">if</span> (GroupSid-&gt;Revision != SID_REVISION) {
11223             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11224         }
11225 
11226         <span class="keywordflow">if</span> (GroupSid-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
11227             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11228         }
11229 
11230         <span class="keywordflow">if</span> (MaxGroupSidLength &lt; (ULONG) <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a> (GroupSid)) {
11231              <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11232         }
11233 
11234     }
11235 
11236     <span class="comment">//</span>
11237     <span class="comment">// Validate the DACL if it's there and check if its allowed to be missing.</span>
11238     <span class="comment">//</span>
11239 
11240     <span class="keywordflow">if</span> (!RtlpAreControlBitsSet (SecurityDescriptor, SE_DACL_PRESENT)) {
11241 <span class="comment">//</span>
11242 <span class="comment">// Some code does this kind of thing:</span>
11243 <span class="comment">//</span>
11244 <span class="comment">// InitializeSecurityDescriptor (&amp;sd, SECURITY_DESCRIPTOR_REVISION);</span>
11245 <span class="comment">// RegSetKeySecurity(hKey, DACL_SECURITY_INFORMATION, &amp;sd) )</span>
11246 <span class="comment">//</span>
11247 <span class="comment">// With the current system this works the same as passing in a NULL DACL but it looks</span>
11248 <span class="comment">// almost by accident</span>
11249 <span class="comment">//</span>
11250 <span class="comment">//        if (RequiredInformation &amp; DACL_SECURITY_INFORMATION) {</span>
11251 <span class="comment">//            return FALSE;</span>
11252 <span class="comment">//        }</span>
11253     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SecurityDescriptor-&gt;Dacl) {
11254         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a29">RtlpValidateSDOffsetAndSize</a> (SecurityDescriptor-&gt;Dacl,
11255                                           SecurityDescriptorLength,
11256                                           sizeof (ACL),
11257                                           &amp;MaxDaclLength)) {
11258             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11259         }
11260 
11261         <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = (PACL) RtlOffsetToPointer (SecurityDescriptor,
11262                                           SecurityDescriptor-&gt;Dacl);
11263 
11264         <span class="comment">//</span>
11265         <span class="comment">// Make sure the DACL length fits within the bounds of the security descriptor.</span>
11266         <span class="comment">//</span>
11267         <span class="keywordflow">if</span> (MaxDaclLength &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AclSize) {
11268             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11269         }
11270 
11271         <span class="comment">//</span>
11272         <span class="comment">// Make sure the ACL is structurally valid.</span>
11273         <span class="comment">//</span>
11274         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a> (Dacl)) {
11275             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11276         }
11277     }
11278 
11279     <span class="comment">//</span>
11280     <span class="comment">// Validate the SACL if it's there and check if its allowed to be missing.</span>
11281     <span class="comment">//</span>
11282 
11283     <span class="keywordflow">if</span> (!RtlpAreControlBitsSet (SecurityDescriptor, SE_SACL_PRESENT)) {
11284 <span class="comment">//        if (RequiredInformation &amp; SACL_SECURITY_INFORMATION) {</span>
11285 <span class="comment">//            return FALSE;</span>
11286 <span class="comment">//        }</span>
11287     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SecurityDescriptor-&gt;Sacl) {
11288         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a29">RtlpValidateSDOffsetAndSize</a> (SecurityDescriptor-&gt;Sacl,
11289                                           SecurityDescriptorLength,
11290                                           sizeof (ACL),
11291                                           &amp;MaxSaclLength)) {
11292             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11293         }
11294 
11295         Sacl = (PACL) RtlOffsetToPointer (SecurityDescriptor,
11296                                           SecurityDescriptor-&gt;Sacl);
11297 
11298         <span class="comment">//</span>
11299         <span class="comment">// Make sure the SACL length fits within the bounds of the security descriptor.</span>
11300         <span class="comment">//</span>
11301 
11302         <span class="keywordflow">if</span> (MaxSaclLength &lt; Sacl-&gt;AclSize) {
11303             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11304         }
11305 
11306         <span class="comment">//</span>
11307         <span class="comment">// Make sure the ACL is structurally valid.</span>
11308         <span class="comment">//</span>
11309 
11310         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a> (Sacl)) {
11311             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11312         }
11313     }
11314 
11315     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
11316 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="sertl.c::RtlValidSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlValidSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SecurityDescriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l02066">2066</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00160">Group</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00559">ObpReferenceSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06520">RtlpConvertToAutoInheritSecurityObject()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00503">TestSeSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>02072                    :
02073 
02074     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> validates a SecurityDescriptor's structure.  This
02075     involves validating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision levels of each component of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02076     security descriptor.
02077 
02078 Arguments:
02079 
02080     SecurityDescriptor - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SECURITY_DESCRIPTOR structure
02081         to validate.
02082 
02083 Return Value:
02084 
02085     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure of SecurityDescriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid.
02086 
02087 
02088 --*/
02089 
02090 {
02091     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
02092     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>;
02093     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
02094     PACL Sacl;
02095 
02096     <span class="comment">//</span>
02097     <span class="comment">// Typecast to the opaque SECURITY_DESCRIPTOR structure.</span>
02098     <span class="comment">//</span>
02099 
02100     SECURITY_DESCRIPTOR *ISecurityDescriptor = SecurityDescriptor;
02101 
02102     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02103 
02104     <span class="keywordflow">try</span> {
02105 
02106         <span class="comment">//</span>
02107         <span class="comment">// known revision ?</span>
02108         <span class="comment">//</span>
02109 
02110         <span class="keywordflow">if</span> (ISecurityDescriptor-&gt;Revision != SECURITY_DESCRIPTOR_REVISION) {
02111             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02112         }
02113 
02114 
02115         <span class="comment">//</span>
02116         <span class="comment">// Validate each element contained in the security descriptor</span>
02117         <span class="comment">//</span>
02118 
02119         <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = RtlpOwnerAddrSecurityDescriptor( ISecurityDescriptor );
02120 
02121         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02122             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( Owner )) {
02123                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02124             }
02125         }
02126 
02127         <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> = RtlpGroupAddrSecurityDescriptor( ISecurityDescriptor );
02128 
02129         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02130             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( Group )) {
02131                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02132             }
02133         }
02134 
02135         <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor( ISecurityDescriptor );
02136         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02137 
02138             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( Dacl )) {
02139                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02140             }
02141         }
02142 
02143         Sacl = RtlpSaclAddrSecurityDescriptor( ISecurityDescriptor );
02144         <span class="keywordflow">if</span> ( Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02145             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( Sacl )) {
02146                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02147             }
02148         }
02149 
02150     } except(EXCEPTION_EXECUTE_HANDLER) {
02151         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02152     }
02153 
02154     <span class="comment">//</span>
02155     <span class="comment">// All components are valid</span>
02156     <span class="comment">//</span>
02157 
02158     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02159 
02160 
02161 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="sertl.c::RtlValidSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlValidSid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Sid</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">810</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d6/sertl_8c.html#a3">ProbeAndReadUlongUM</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02874">IoCheckQuotaBufferValidity()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00524">IopCheckGetQuotaBufferValidity()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01098">RtlAddCompoundAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01611">RtlConvertSidToUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01532">RtlLengthSidAsUnicodeString()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01405">RtlpAddKnownObjectAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02066">RtlValidSecurityDescriptor()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00053">SeCaptureSecurityDescriptor()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01141">SeCaptureSid()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01850">SeCaptureSidAndAttributesArray()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00042">TestSeSid()</a>.
<p>
<pre class="fragment"><div>00816                    :
00817 
00818     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> validates an SID's structure.
00819 
00820 Arguments:
00821 
00822     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID structure to validate.
00823 
00824 Return Value:
00825 
00826     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure of Sid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid.
00827 
00828 --*/
00829 
00830 {
00831     PISID Isid = (PISID) Sid;
00832     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00833     <span class="comment">//</span>
00834     <span class="comment">// Make sure revision is SID_REVISION and sub authority count is not</span>
00835     <span class="comment">// greater than maximum number of allowed sub-authorities.</span>
00836     <span class="comment">//</span>
00837 
00838     <span class="keywordflow">try</span> {
00839 
00840         <span class="keywordflow">if</span> ( Isid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (Isid-&gt;Revision &amp; 0x0f) == SID_REVISION) {
00841             <span class="keywordflow">if</span> (Isid-&gt;SubAuthorityCount &lt;= SID_MAX_SUB_AUTHORITIES) {
00842 
00843                 <span class="comment">//</span>
00844                 <span class="comment">// Verify the memory actually contains the last subauthority</span>
00845                 <span class="comment">//</span>
00846 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
00847 <span class="preprocessor"></span><span class="preprocessor">#define ProbeAndReadUlongUM(Address) \</span>
00848 <span class="preprocessor">        (*(volatile ULONG *)(Address))</span>
00849 <span class="preprocessor"></span>
00850                 <span class="keywordflow">if</span> (Isid-&gt;SubAuthorityCount &gt; 0) {
00851                     <a class="code" href="../../d8/d6/sertl_8c.html#a3">ProbeAndReadUlongUM</a>(
00852                         &amp;Isid-&gt;SubAuthority[Isid-&gt;SubAuthorityCount-1]
00853                         );
00854                 }
00855 <span class="preprocessor">#endif // !NTOS_KERNEL_RUNTIME</span>
00856 <span class="preprocessor"></span>                <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00857           }
00858         }
00859 
00860     } except(EXCEPTION_EXECUTE_HANDLER) {
00861         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00862     }
00863 
00864     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00865 
00866 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a7" doxytag="sertl.c::RtlBaseAceType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d8/d6/sertl_8c.html#a7">RtlBaseAceType</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    ACCESS_ALLOWED_ACE_TYPE,    
    ACCESS_DENIED_ACE_TYPE,     
    SYSTEM_AUDIT_ACE_TYPE,      
    SYSTEM_ALARM_ACE_TYPE,      
    ACCESS_ALLOWED_ACE_TYPE,    
    ACCESS_ALLOWED_ACE_TYPE,    
    ACCESS_DENIED_ACE_TYPE,     
    SYSTEM_AUDIT_ACE_TYPE,      
    SYSTEM_ALARM_ACE_TYPE       
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00340">340</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l03880">RtlpCopyEffectiveAce()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="sertl.c::RtlIsSystemAceType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d8/d6/sertl_8c.html#a8">RtlIsSystemAceType</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,    
    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,    
    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,     
    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,     
    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,    
    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,    
    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,    
    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,     
    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>      
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00356">356</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="sertl.c::RtlpVerboseConvert" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d8/d6/sertl_8c.html#a9">RtlpVerboseConvert</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/sertl_8c-source.html#l00368">368</a> of file <a class="el" href="../../d9/d5/sertl_8c-source.html">sertl.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l07033">RtlpCompareKnownAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07209">RtlpCompareKnownObjectAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l08362">RtlpIsDuplicateAce()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
