<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpcsvr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpcsvr.c</h1><a href="../../d7/d7/lpcsvr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//+---------------------------------------------------------------------------</span>
00002 <span class="comment">//</span>
00003 <span class="comment">//  Microsoft Windows</span>
00004 <span class="comment">//  Copyright (C) Microsoft Corporation, 1992 - 1997.</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  File:       lpcsvr.c</span>
00007 <span class="comment">//</span>
00008 <span class="comment">//  Contents:</span>
00009 <span class="comment">//</span>
00010 <span class="comment">//  Classes:</span>
00011 <span class="comment">//</span>
00012 <span class="comment">//  Functions:</span>
00013 <span class="comment">//</span>
00014 <span class="comment">//  History:    12-12-97   RichardW   Created</span>
00015 <span class="comment">//</span>
00016 <span class="comment">//----------------------------------------------------------------------------</span>
00017 
00018 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00019 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00020 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00021 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00022 <span class="preprocessor">#include "<a class="code" href="../../d8/d7/lpcsvr_8h.html">lpcsvr.h</a>"</span>
00023 
<a name="l00024"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a0">00024</a> <span class="preprocessor">#define RtlpLpcLockServer( s ) RtlEnterCriticalSection( &amp;s-&gt;Lock );</span>
<a name="l00025"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define RtlpLpcUnlockServer( s ) RtlLeaveCriticalSection( &amp;s-&gt;Lock );</span>
00026 <span class="preprocessor"></span>
<a name="l00027"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a2">00027</a> <span class="preprocessor">#define RtlpLpcContextFromClient( p ) ( CONTAINING_RECORD( p, LPCSVR_CONTEXT, PrivateContext ) )</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//+---------------------------------------------------------------------------</span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  Function:   RtlpLpcDerefContext</span>
00032 <span class="comment">//</span>
00033 <span class="comment">//  Synopsis:   Deref the context.  If this context is being cleaned up after</span>
00034 <span class="comment">//              the server has been deleted, then the message is freed directly,</span>
00035 <span class="comment">//              rather than being released to the general queue.</span>
00036 <span class="comment">//</span>
00037 <span class="comment">//  Arguments:  [Context] --</span>
00038 <span class="comment">//              [Message] --</span>
00039 <span class="comment">//</span>
00040 <span class="comment">//  History:    2-06-98   RichardW   Created</span>
00041 <span class="comment">//</span>
00042 <span class="comment">//  Notes:</span>
00043 <span class="comment">//</span>
00044 <span class="comment">//----------------------------------------------------------------------------</span>
00045 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00046"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a3">00046</a> <a class="code" href="../../d7/d7/lpcsvr_8c.html#a3">RtlpLpcDerefContext</a>(
00047     <a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html">PLPCSVR_CONTEXT</a> Context,
00048     <a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html">PLPCSVR_MESSAGE</a> Message
00049     )
00050 {
00051     <a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html">PLPCSVR_SERVER</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> ;
00052 
00053     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> = Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o1">Server</a> ;
00054 
00055     <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o3">RefCount</a> ) &lt; 0 )
00056     {
00057         <span class="comment">//</span>
00058         <span class="comment">// All gone, time to clean up:</span>
00059         <span class="comment">//</span>
00060 
00061         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a0">RtlpLpcLockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00062 
00063         <span class="keywordflow">if</span> ( Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o0">List</a>.Flink )
00064         {
00065             RemoveEntryList( &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o0">List</a> );
00066 
00067             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ContextCount -- ;
00068 
00069         }
00070         <span class="keywordflow">else</span>
00071         {
00072             <span class="keywordflow">if</span> ( Message )
00073             {
00074                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(),
00075                              0,
00076                              Message );
00077             }
00078         }
00079 
00080         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00081 
00082         <span class="keywordflow">if</span> ( Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a> )
00083         {
00084             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a> );
00085         }
00086 
00087         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(),
00088                      0,
00089                      Context );
00090     }
00091     <span class="keywordflow">else</span>
00092     {
00093         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a0">RtlpLpcLockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00094 
00095         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePoolSize++ ;
00096 
00097         <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePoolSize &lt; <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePoolLimit )
00098         {
00099             Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o2">Header</a>.Next = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool ;
00100 
00101             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool = Message ;
00102         }
00103         <span class="keywordflow">else</span>
00104         {
00105             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePoolSize-- ;
00106 
00107             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(),
00108                          0,
00109                          Message );
00110 
00111         }
00112 
00113         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00114     }
00115 
00116 }
00117 
00118 <span class="comment">//+---------------------------------------------------------------------------</span>
00119 <span class="comment">//</span>
00120 <span class="comment">//  Function:   RtlpLpcWorkerThread</span>
00121 <span class="comment">//</span>
00122 <span class="comment">//  Synopsis:   General worker thread</span>
00123 <span class="comment">//</span>
00124 <span class="comment">//  Arguments:  [Parameter] --</span>
00125 <span class="comment">//</span>
00126 <span class="comment">//  History:    2-06-98   RichardW   Created</span>
00127 <span class="comment">//</span>
00128 <span class="comment">//  Notes:</span>
00129 <span class="comment">//</span>
00130 <span class="comment">//----------------------------------------------------------------------------</span>
00131 
00132 
00133 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00134"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a4">00134</a> <a class="code" href="../../d7/d7/lpcsvr_8c.html#a4">RtlpLpcWorkerThread</a>(
00135     PVOID Parameter
00136     )
00137 {
00138     <a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html">PLPCSVR_MESSAGE</a> Message ;
00139     <a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html">PLPCSVR_CONTEXT</a> Context ;
00140     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00141     BOOLEAN Accept ;
00142 
00143     Message = (<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html">PLPCSVR_MESSAGE</a>) Parameter ;
00144 
00145     Context = Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o2">Header</a>.Context ;
00146 
00147     <span class="keywordflow">switch</span> ( Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a>.u2.s2.Type &amp; 0xF )
00148     {
00149         <span class="keywordflow">case</span> LPC_REQUEST:
00150         <span class="keywordflow">case</span> LPC_DATAGRAM:
00151             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling Server's Request function\n"</span>);
00152             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o1">Server</a>-&gt;<a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html#o2">Init</a>.RequestFn(
00153                                 &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o4">PrivateContext</a>,
00154                                 &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a>,
00155                                 &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a>
00156                                 );
00157 
00158             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00159             {
00160                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>( Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a>,
00161                                       &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a> );
00162 
00163                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00164                 {
00165                     <span class="comment">//</span>
00166                     <span class="comment">// See what happened.  The client may have gone away already.</span>
00167                     <span class="comment">//</span>
00168 
00169                     <span class="keywordflow">break</span>;
00170 
00171                 }
00172             }
00173             <span class="keywordflow">break</span>;
00174 
00175         <span class="keywordflow">case</span> LPC_CONNECTION_REQUEST:
00176             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling Server's Connect function\n"</span>);
00177             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o1">Server</a>-&gt;<a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html#o2">Init</a>.ConnectFn(
00178                                 &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o4">PrivateContext</a>,
00179                                 &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a>,
00180                                 &amp;Accept
00181                                 );
00182 
00183             <span class="comment">//</span>
00184             <span class="comment">// If the comm port is still null, then do the accept.  Otherwise, the</span>
00185             <span class="comment">// server called RtlAcceptConnectPort() explicitly, to set up a view.</span>
00186             <span class="comment">//</span>
00187 
00188             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00189             {
00190                 <span class="keywordflow">if</span> ( Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00191                 {
00192                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/lpccompl_8c.html#a1">NtAcceptConnectPort</a>(
00193                                     &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a>,
00194                                     Context,
00195                                     &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a>,
00196                                     Accept,
00197                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00198                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00199 
00200                     <span class="keywordflow">if</span> ( !Accept )
00201                     {
00202                         <span class="comment">//</span>
00203                         <span class="comment">// Yank the context out of the list, since it is worthless</span>
00204                         <span class="comment">//</span>
00205 
00206                         Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o3">RefCount</a> = 0 ;
00207 
00208                     }
00209                     <span class="keywordflow">else</span>
00210                     {
00211                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/lpccompl_8c.html#a2">NtCompleteConnectPort</a>( Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a> );
00212                     }
00213                 }
00214 
00215             }
00216             <span class="keywordflow">else</span>
00217             {
00218                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/lpccompl_8c.html#a1">NtAcceptConnectPort</a>(
00219                             &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a>,
00220                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00221                             &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a>,
00222                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00223                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00224                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00225 
00226                 Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o3">RefCount</a> = 0 ;
00227 
00228             }
00229 
00230             <span class="keywordflow">break</span>;
00231 
00232         <span class="keywordflow">case</span> LPC_CLIENT_DIED:
00233             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Calling Server's Rundown function\n"</span> );
00234             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o1">Server</a>-&gt;<a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html#o2">Init</a>.RundownFn(
00235                                     &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o4">PrivateContext</a>,
00236                                     &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a>
00237                                     );
00238 
00239             InterlockedDecrement( &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o3">RefCount</a> );
00240 
00241             <span class="keywordflow">break</span>;
00242 
00243         <span class="keywordflow">default</span>:
00244             <span class="comment">//</span>
00245             <span class="comment">// An unexpected message came through.  Normal LPC servers</span>
00246             <span class="comment">// don't handle the other types of messages.  Drop it.</span>
00247             <span class="comment">//</span>
00248 
00249             <span class="keywordflow">break</span>;
00250     }
00251 
00252     <a class="code" href="../../d7/d7/lpcsvr_8c.html#a3">RtlpLpcDerefContext</a>( Context, Message );
00253 
00254     <span class="keywordflow">return</span> ;
00255 
00256 
00257 }
00258 
00259 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00260"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a5">00260</a> <a class="code" href="../../d7/d7/lpcsvr_8c.html#a5">RtlpLpcServerCallback</a>(
00261     PVOID Parameter,
00262     BOOLEAN TimedOut
00263     )
00264 {
00265     <a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html">PLPCSVR_SERVER</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> ;
00266     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00267     <a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html">PLPCSVR_MESSAGE</a> Message ;
00268     <a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html">PLPCSVR_CONTEXT</a> Context ;
00269     PLARGE_INTEGER RealTimeout ;
00270     LPCSVR_FILTER_RESULT FilterResult ;
00271 
00272     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> = (<a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html">PLPCSVR_SERVER</a>) Parameter ;
00273 
00274     <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;WaitHandle )
00275     {
00276         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;WaitHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00277     }
00278 
00279     <span class="keywordflow">while</span> ( 1 )
00280     {
00281         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Entering LPC server\n"</span> );
00282 
00283         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a0">RtlpLpcLockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00284 
00285         <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Flags &amp; <a class="code" href="../../d8/d7/lpcsvr_8h.html#a1">LPCSVR_SHUTDOWN_PENDING</a> )
00286         {
00287             <span class="keywordflow">break</span>;
00288         }
00289 
00290         <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool )
00291         {
00292             Message = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool ;
00293             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool = Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o2">Header</a>.Next ;
00294         }
00295         <span class="keywordflow">else</span>
00296         {
00297             Message = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(),
00298                                        0,
00299                                        <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessageSize );
00300 
00301         }
00302 
00303         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00304 
00305         <span class="keywordflow">if</span> ( !Message )
00306         {
00307             LARGE_INTEGER SleepInterval ;
00308 
00309             SleepInterval.QuadPart = 125 * 10000 ;
00310 
00311             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;SleepInterval );
00312             <span class="keywordflow">continue</span>;
00313         }
00314 
00315 
00316         <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Timeout.QuadPart )
00317         {
00318             RealTimeout = &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Timeout ;
00319         }
00320         <span class="keywordflow">else</span>
00321         {
00322             RealTimeout = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00323         }
00324 
00325         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a1">NtReplyWaitReceivePortEx</a>(
00326                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Port,
00327                         &amp;Context,
00328                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00329                         &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a>,
00330                         RealTimeout );
00331 
00332         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Server: NtReplyWaitReceivePort completed with %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00333 
00334         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00335         {
00336             <span class="comment">//</span>
00337             <span class="comment">// If we timed out, nobody was waiting for us:</span>
00338             <span class="comment">//</span>
00339 
00340             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT )
00341             {
00342                 <span class="comment">//</span>
00343                 <span class="comment">// Set up a general wait that will call back to this function</span>
00344                 <span class="comment">// when ready.</span>
00345                 <span class="comment">//</span>
00346 
00347                 <a class="code" href="../../d7/d7/lpcsvr_8c.html#a0">RtlpLpcLockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00348 
00349                 <span class="keywordflow">if</span> ( ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Flags &amp; <a class="code" href="../../d8/d7/lpcsvr_8h.html#a1">LPCSVR_SHUTDOWN_PENDING</a> ) == 0 )
00350                 {
00351 
00352                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a5">RtlRegisterWait</a>( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;WaitHandle,
00353                                               <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Port,
00354                                               <a class="code" href="../../d7/d7/lpcsvr_8c.html#a5">RtlpLpcServerCallback</a>,
00355                                               <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>,
00356                                               0xFFFFFFFF,
00357                                               WT_EXECUTEONLYONCE );
00358                 }
00359 
00360                 <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00361 
00362                 <span class="keywordflow">break</span>;
00363 
00364             }
00365 
00366             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS )
00367             {
00368                 <span class="keywordflow">if</span> ( Context )
00369                 {
00370                     InterlockedIncrement( &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o3">RefCount</a> );
00371                 }
00372                 <span class="keywordflow">else</span>
00373                 {
00374                     <span class="comment">//</span>
00375                     <span class="comment">// New connection.  Create a new context record</span>
00376                     <span class="comment">//</span>
00377 
00378                     Context = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(),
00379                                                0,
00380                                                <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html">LPCSVR_CONTEXT</a> ) +
00381                                                     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Init.ContextSize );
00382 
00383                     <span class="keywordflow">if</span> ( !Context )
00384                     {
00385                         HANDLE Bogus ;
00386 
00387                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/lpccompl_8c.html#a1">NtAcceptConnectPort</a>(
00388                                     &amp;Bogus,
00389                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00390                                     &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a>,
00391                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00392                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00393                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00394 
00395                         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a0">RtlpLpcLockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00396 
00397                         Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o2">Header</a>.Next = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool ;
00398                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool = Message ;
00399 
00400                         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00401 
00402                         <span class="keywordflow">continue</span>;
00403                     }
00404 
00405                     Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o1">Server</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> ;
00406                     Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o3">RefCount</a> = 1 ;
00407                     Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00408 
00409                     <a class="code" href="../../d7/d7/lpcsvr_8c.html#a0">RtlpLpcLockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00410 
00411                     InsertTailList( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ContextList, &amp;Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o0">List</a> );
00412                     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ContextCount++ ;
00413 
00414                     <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00415                 }
00416 
00417 
00418                 Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o2">Header</a>.Context = Context ;
00419 
00420                 FilterResult = LpcFilterAsync ;
00421 
00422                 <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Init.FilterFn )
00423                 {
00424                     FilterResult = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Init.FilterFn( Context, &amp;Message-&gt;<a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html#o3">Message</a> );
00425 
00426                     <span class="keywordflow">if</span> (FilterResult == LpcFilterDrop )
00427                     {
00428                         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a3">RtlpLpcDerefContext</a>( Context, Message );
00429 
00430                         <span class="keywordflow">continue</span>;
00431 
00432                     }
00433                 }
00434 
00435                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Flags &amp; <a class="code" href="../../d8/d7/lpcsvr_8h.html#a2">LPCSVR_SYNCHRONOUS</a>) ||
00436                      (FilterResult == LpcFilterSync) )
00437                 {
00438                     <a class="code" href="../../d7/d7/lpcsvr_8c.html#a4">RtlpLpcWorkerThread</a>( Message );
00439                 }
00440                 <span class="keywordflow">else</span>
00441                 {
00442                     <a class="code" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a>( <a class="code" href="../../d7/d7/lpcsvr_8c.html#a4">RtlpLpcWorkerThread</a>,
00443                                       Message,
00444                                       0 );
00445 
00446                 }
00447             }
00448         }
00449         <span class="keywordflow">else</span>
00450         {
00451             <span class="comment">//</span>
00452             <span class="comment">// Error?  Better shut down...</span>
00453             <span class="comment">//</span>
00454 
00455             <span class="keywordflow">break</span>;
00456         }
00457 
00458     }
00459 
00460 }
00461 
00462 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00463"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a6">00463</a> <a class="code" href="../../d7/d7/lpcsvr_8c.html#a6">RtlCreateLpcServer</a>(
00464     POBJECT_ATTRIBUTES PortName,
00465     PLPCSVR_INITIALIZE Init,
00466     PLARGE_INTEGER IdleTimeout,
00467     ULONG MessageSize,
00468     ULONG Options,
00469     PVOID * LpcServer
00470     )
00471 {
00472     <a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html">PLPCSVR_SERVER</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> ;
00473     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00474     HANDLE Thread ;
00475     CLIENT_ID Id ;
00476 
00477     *LpcServer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00478 
00479     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(),
00480                               0,
00481                               <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html">LPCSVR_SERVER</a> ) );
00482 
00483     <span class="keywordflow">if</span> ( !<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> )
00484     {
00485         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES ;
00486     }
00487 
00488     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(
00489             &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Lock,
00490             1000 );
00491 
00492     InitializeListHead( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ContextList );
00493     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ContextCount = 0 ;
00494 
00495     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Init = *Init ;
00496     <span class="keywordflow">if</span> ( !IdleTimeout )
00497     {
00498         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Timeout.QuadPart = 0 ;
00499     }
00500     <span class="keywordflow">else</span>
00501     {
00502         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Timeout = *IdleTimeout ;
00503     }
00504 
00505     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessageSize = MessageSize + <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html">LPCSVR_MESSAGE</a> ) -
00506                             <span class="keyword">sizeof</span>( PORT_MESSAGE );
00507 
00508     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool = 0 ;
00509     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePoolSize = 0 ;
00510     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePoolLimit = 4 ;
00511 
00512     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Flags = Options ;
00513 
00514     <span class="comment">//</span>
00515     <span class="comment">// Create the LPC port:</span>
00516     <span class="comment">//</span>
00517 
00518     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/lpccreat_8c.html#a2">NtCreateWaitablePort</a>(
00519                             &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Port,
00520                             <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a>,
00521                             MessageSize,
00522                             MessageSize,
00523                             MessageSize * 4
00524                             );
00525 
00526     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00527     {
00528         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Lock );
00529         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00530         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00531     }
00532 
00533     *LpcServer = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> ;
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// Now, post the handle over to a wait queue</span>
00537     <span class="comment">//</span>
00538     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a5">RtlRegisterWait</a>(
00539                         &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;WaitHandle,
00540                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Port,
00541                         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a5">RtlpLpcServerCallback</a>,
00542                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>,
00543                         0xFFFFFFFF,
00544                         WT_EXECUTEONLYONCE
00545                         );
00546 
00547     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00548 }
00549 
00550 
00551 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00552"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a7">00552</a> <a class="code" href="../../d7/d7/lpcsvr_8c.html#a7">RtlShutdownLpcServer</a>(
00553     PVOID LpcServer
00554     )
00555 {
00556     <a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html">PLPCSVR_SERVER</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> ;
00557     OBJECT_ATTRIBUTES ObjA ;
00558     PLIST_ENTRY Scan ;
00559     <a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html">PLPCSVR_CONTEXT</a> Context ;
00560     <a class="code" href="../../d3/d5/struct__LPCSVR__MESSAGE.html">PLPCSVR_MESSAGE</a> Message ;
00561     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00562 
00563     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> = (<a class="code" href="../../d5/d5/struct__LPCSVR__SERVER.html">PLPCSVR_SERVER</a>) LpcServer ;
00564 
00565     <a class="code" href="../../d7/d7/lpcsvr_8c.html#a0">RtlpLpcLockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00566 
00567     <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Flags &amp; <a class="code" href="../../d8/d7/lpcsvr_8h.html#a1">LPCSVR_SHUTDOWN_PENDING</a> )
00568     {
00569         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00570 
00571         <span class="keywordflow">return</span> STATUS_PENDING ;
00572     }
00573 
00574     <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;WaitHandle )
00575     {
00576         <a class="code" href="../../d2/d1/threads_8c.html#a6">RtlDeregisterWait</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;WaitHandle );
00577 
00578         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;WaitHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00579     }
00580 
00581     <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Timeout.QuadPart == 0 )
00582     {
00583         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00584 
00585         <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED ;
00586     }
00587 
00588     <span class="comment">//</span>
00589     <span class="comment">// If there are receives still pending, we have to sync</span>
00590     <span class="comment">// with those threads.  To do so, we will tag the shutdown</span>
00591     <span class="comment">// flag, and then wait the timeout amount.</span>
00592     <span class="comment">//</span>
00593 
00594     <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ReceiveThreads != 0 )
00595     {
00596 
00597         InitializeObjectAttributes( &amp;ObjA,
00598                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00599                                     0,
00600                                     0,
00601                                     0 );
00602 
00603         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ShutdownEvent,
00604                                 EVENT_ALL_ACCESS,
00605                                 &amp;ObjA,
00606                                 NotificationEvent,
00607                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00608 
00609         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00610         {
00611             <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00612 
00613             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00614 
00615         }
00616 
00617         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Flags |= <a class="code" href="../../d8/d7/lpcsvr_8h.html#a1">LPCSVR_SHUTDOWN_PENDING</a> ;
00618 
00619         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a1">RtlpLpcUnlockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00620 
00621         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(
00622                             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ShutdownEvent,
00623                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00624                             &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Timeout );
00625 
00626         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT )
00627         {
00628             <span class="comment">//</span>
00629             <span class="comment">// Hmm, the LPC server thread is hung somewhere,</span>
00630             <span class="comment">// press on</span>
00631             <span class="comment">//</span>
00632         }
00633 
00634         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a0">RtlpLpcLockServer</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> );
00635 
00636         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ShutdownEvent );
00637 
00638         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ShutdownEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00639 
00640     }
00641     <span class="keywordflow">else</span>
00642     {
00643         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Flags |= <a class="code" href="../../d8/d7/lpcsvr_8h.html#a1">LPCSVR_SHUTDOWN_PENDING</a> ;
00644     }
00645 
00646     <span class="comment">//</span>
00647     <span class="comment">// The server object is locked, and there are no receives</span>
00648     <span class="comment">// pending.  Or, the receives appear hung.  Skim through the</span>
00649     <span class="comment">// context list, calling the server code.  The disconnect</span>
00650     <span class="comment">// message is NULL, indicating that this is a server initiated</span>
00651     <span class="comment">// shutdown.</span>
00652     <span class="comment">//</span>
00653 
00654 
00655     <span class="keywordflow">while</span> ( ! IsListEmpty( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ContextList ) )
00656     {
00657         Scan = RemoveHeadList( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;ContextList );
00658 
00659         Context = CONTAINING_RECORD( Scan, <a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html">LPCSVR_CONTEXT</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> );
00660 
00661         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;Init.RundownFn(
00662                                 Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o4">PrivateContext</a>,
00663                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00664 
00665         Context-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o0">List</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00666 
00667         <a class="code" href="../../d7/d7/lpcsvr_8c.html#a3">RtlpLpcDerefContext</a>( Context, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00668 
00669     }
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">// All contexts have been deleted:  clean up the messages</span>
00673     <span class="comment">//</span>
00674 
00675     <span class="keywordflow">while</span> ( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool )
00676     {
00677         Message = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool ;
00678 
00679         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a>-&gt;MessagePool = Message ;
00680 
00681         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(),
00682                      0,
00683                      Message );
00684     }
00685 
00686 
00687     <span class="comment">//</span>
00688     <span class="comment">// Clean up server objects</span>
00689     <span class="comment">//</span>
00690 
00691     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00692 
00693 }
00694 
00695 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00696"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a8">00696</a> <a class="code" href="../../d7/d7/lpcsvr_8c.html#a8">RtlImpersonateLpcClient</a>(
00697     PVOID Context,
00698     PPORT_MESSAGE Message
00699     )
00700 {
00701     <a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html">PLPCSVR_CONTEXT</a> LpcContext ;
00702 
00703     LpcContext = <a class="code" href="../../d7/d7/lpcsvr_8c.html#a2">RtlpLpcContextFromClient</a>( Context );
00704 
00705     <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/lpcpriv_8c.html#a0">NtImpersonateClientOfPort</a>(
00706                     LpcContext-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a>,
00707                     Message );
00708 
00709 }
00710 
00711 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00712"></a><a class="code" href="../../d7/d7/lpcsvr_8c.html#a9">00712</a> <a class="code" href="../../d7/d7/lpcsvr_8c.html#a9">RtlCallbackLpcClient</a>(
00713     PVOID Context,
00714     PPORT_MESSAGE Request,
00715     PPORT_MESSAGE Callback
00716     )
00717 {
00718     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00719     <a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html">PLPCSVR_CONTEXT</a> LpcContext ;
00720 
00721     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> != Callback )
00722     {
00723         Callback-&gt;ClientId = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>-&gt;ClientId ;
00724         Callback-&gt;MessageId = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>-&gt;MessageId ;
00725     }
00726 
00727     LpcContext = <a class="code" href="../../d7/d7/lpcsvr_8c.html#a2">RtlpLpcContextFromClient</a>( Context );
00728 
00729     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/lpcsend_8c.html#a1">NtRequestWaitReplyPort</a>(
00730                     LpcContext-&gt;<a class="code" href="../../d2/d5/struct__LPCSVR__CONTEXT.html#o2">CommPort</a>,
00731                     Callback,
00732                     Callback
00733                     );
00734 
00735     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00736 
00737 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
