<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: country2.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>country2.c</h1><a href="../../d7/d7/country2_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">// Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00002 <span class="comment">//</span>
00003 <span class="comment">//  MODULE:   country2.c</span>
00004 <span class="comment">//</span>
00005 <span class="comment">//  PURPOSE:   Console IME control.</span>
00006 <span class="comment">//             FarEast country specific module 2 for conime.</span>
00007 <span class="comment">//</span>
00008 <span class="comment">//  PLATFORMS: Windows NT-FE 3.51</span>
00009 <span class="comment">//</span>
00010 <span class="comment">//  FUNCTIONS:</span>
00011 <span class="comment">//    ImeUIOpenCandidate() - routine for make system line string</span>
00012 <span class="comment">//</span>
00013 <span class="comment">//  History:</span>
00014 <span class="comment">//</span>
00015 <span class="comment">//  15.Jul.1996 v-HirShi (Hirotoshi Shimizu)    Created for TAIWAN &amp; KOREA &amp; PRC</span>
00016 <span class="comment">//</span>
00017 <span class="comment">//  COMMENTS:</span>
00018 <span class="comment">//</span>
00019 <span class="preprocessor">#include "<a class="code" href="../../d5/d3/w32_2ntcon_2conime_2precomp_8h.html">precomp.h</a>"</span>
00020 <span class="preprocessor">#pragma hdrstop</span>
00021 <span class="preprocessor"></span>
00022 
00023 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00024"></a><a class="code" href="../../d7/d7/country2_8c.html#a0">00024</a> <a class="code" href="../../d7/d7/country2_8c.html#a0">ImeUIOpenCandidate</a>(
00025     HWND hwnd,
00026     DWORD CandList,
00027     BOOL OpenFlag
00028     )
00029 {
00030     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
00031     HIMC  hIMC;
00032 
00033     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Get IMN_OPENCANDIDATE Message\n"</span>));
00034 
00035 
00036     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a>);
00037 
00038     <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o25">fNestCandidate</a>)
00039         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00040 
00041     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00042         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
00043         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00044     }
00045 
00046     hIMC = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>( hwnd );
00047     <span class="keywordflow">if</span> ( hIMC == 0 )
00048         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00049 
00050     <span class="comment">//</span>
00051     <span class="comment">// Set fInCandidate variables.</span>
00052     <span class="comment">//</span>
00053     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o16">fInCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00054 
00055     <span class="keywordflow">switch</span> ( <a class="code" href="../../d4/d5/conimep_8h.html#a50">HKL_TO_LANGID</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a>))
00056     {
00057         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a43">LANG_ID_JAPAN</a>:
00058             <a class="code" href="../../d7/d7/country2_8c.html#a1">OpenCandidateJapan</a>(hwnd, hIMC, ConTbl, CandList, OpenFlag );
00059             <span class="keywordflow">break</span>;
00060         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a42">LANG_ID_TAIWAN</a>:
00061             <a class="code" href="../../d7/d7/country2_8c.html#a2">OpenCandidateTaiwan</a>(hwnd, hIMC, ConTbl, CandList, OpenFlag );
00062             <span class="keywordflow">break</span>;
00063         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a45">LANG_ID_PRC</a>:
00064             <a class="code" href="../../d7/d7/country2_8c.html#a3">OpenCandidatePRC</a>(hwnd, hIMC, ConTbl, CandList, OpenFlag );
00065             <span class="keywordflow">break</span>;
00066         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a44">LANG_ID_KOREA</a>:
00067             <a class="code" href="../../d7/d7/country2_8c.html#a4">OpenCandidateKorea</a>(hwnd, hIMC, ConTbl, CandList, OpenFlag );
00068             <span class="keywordflow">break</span>;
00069         <span class="keywordflow">default</span>:
00070             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00071     }
00072 
00073     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00074 
00075     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00076 }
00077 
00078 
00079 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00080"></a><a class="code" href="../../d7/d7/country2_8c.html#a1">00080</a> <a class="code" href="../../d7/d7/country2_8c.html#a1">OpenCandidateJapan</a>(
00081     HWND hwnd,
00082     HIMC  hIMC ,
00083     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
00084     DWORD CandList,
00085     BOOL OpenFlag
00086     )
00087 {
00088     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLength;
00089     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
00090     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00091     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> j;
00092     LPWSTR lpStr;
00093     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDspLen;
00094     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> width;
00095     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> StartIndex;
00096     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CountDispWidth;
00097     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> AllocLength;
00098     LPCANDIDATELIST lpCandList;
00099     <a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a> SystemLine;
00100     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SystemLineSize;
00101     COPYDATASTRUCT CopyData;
00102     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> EnableCodePoint;
00103 
00104     <span class="keywordflow">for</span> (dwIndex = 0; dwIndex &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a> ; dwIndex ++ ) {
00105         <span class="keywordflow">if</span> ( CandList &amp; ( 1 &lt;&lt; dwIndex ) ) {
00106             dwLength = ImmGetCandidateList(hIMC, dwIndex, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00107             <span class="keywordflow">if</span> (dwLength == 0)
00108                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00109             <span class="keywordflow">if</span> ( (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] != dwLength ) &amp;&amp;
00110                  (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00111                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex]);
00112                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = 0;
00113                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00114             }
00115             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00116                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = LocalAlloc(LPTR, dwLength);
00117                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00118                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00119                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = dwLength;
00120             }
00121             lpCandList = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex];
00122             ImmGetCandidateList(hIMC, dwIndex, lpCandList, dwLength);
00123 
00124             <span class="comment">//</span>
00125             <span class="comment">// check each offset value is not over than buffer size.</span>
00126             <span class="comment">//</span>
00127             <span class="keywordflow">if</span> ((lpCandList-&gt;dwCount &gt; 1) &amp;&amp;
00128                 (lpCandList-&gt;dwSelection &gt;= dwLength ||
00129                  lpCandList-&gt;dwPageStart &gt;= dwLength ||
00130                  lpCandList-&gt;dwOffset[lpCandList-&gt;dwSelection] &gt;= dwLength ||
00131                  lpCandList-&gt;dwOffset[lpCandList-&gt;dwPageStart] &gt;= dwLength    )
00132                )
00133                 <span class="keywordflow">break</span>;
00134 
00135             dwLength = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o2">ScreenBufferSize</a>.X;
00136             dwLength = (dwLength &gt; 128) ? 128 : dwLength ;
00137             dwLength = ((dwLength &lt; 12) ? 12 : dwLength );
00138 
00139             j = (dwLength-7)/(<a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>+<span class="keyword">sizeof</span>(WCHAR));
00140             j = ((j &gt; 9)?9:j);
00141             j = lpCandList-&gt;dwCount / j + 10;
00142             AllocLength = (j &gt; <a class="code" href="../../d4/d5/conimep_8h.html#a33">DEFAULTCANDTABLE</a>) ? j : <a class="code" href="../../d4/d5/conimep_8h.html#a33">DEFAULTCANDTABLE</a>;
00143 
00144             <span class="keywordflow">if</span> (lpCandList-&gt;dwStyle == IME_CAND_CODE){
00145                 EnableCodePoint = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00146             }
00147             <span class="keywordflow">else</span>{
00148                 EnableCodePoint = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149             }
00150 
00151             <span class="keywordflow">if</span> (EnableCodePoint){
00152                 CountDispWidth = <a class="code" href="../../d4/d5/conimep_8h.html#a35">CODEDISPLEN</a>;
00153             }
00154             <span class="keywordflow">else</span> {
00155                 <span class="keywordflow">for</span> (CountDispWidth = 0 ,j = 1; j &lt;= lpCandList-&gt;dwCount; CountDispWidth++)
00156                      j *= 10;
00157                 CountDispWidth *= 2;
00158                 CountDispWidth++;
00159             }
00160 
00161             <span class="keywordflow">if</span> ((ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> != <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength) &amp;&amp;
00162                 (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00163                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>);
00164                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00165                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> = 0;
00166             }
00167             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00168                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>= LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength);
00169                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00170                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00171                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength;
00172             }
00173 
00174             <span class="keywordflow">if</span> ( EnableCodePoint ){
00175                 j = 0;
00176                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = 0;
00177                 <span class="keywordflow">if</span> (OpenFlag) {
00178                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a> = lpCandList-&gt;dwSelection % 9;
00179                 }
00180                 i = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a>;
00181                 <span class="keywordflow">for</span> (; i &lt; lpCandList-&gt;dwCount; i+= 9 ) {
00182                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = i;
00183                 }
00184                 <span class="keywordflow">if</span> (i &gt; lpCandList-&gt;dwCount) {
00185                     i = lpCandList-&gt;dwCount;
00186                 }
00187             }
00188             <span class="keywordflow">else</span>{
00189                 j = 0;
00190                 <span class="keywordflow">if</span> (OpenFlag) {
00191                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a> = 0;
00192                 }
00193                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a>;
00194                 lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ 0 ]);
00195                 dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
00196                 width = dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;                  <span class="comment">// '1:xxxx 2:xxxx '</span>
00197                 <span class="keywordflow">for</span>( i = 1; i &lt; lpCandList-&gt;dwCount; i++ ) {
00198                     lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ i ]);
00199                     dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
00200                     width += dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
00201                     <span class="keywordflow">if</span> ((width &gt; dwLength-CountDispWidth) ||
00202                         ( i - ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j-1] &gt;= 9)){
00203                         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = i;
00204                         width = dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
00205                     }
00206                 }
00207             }
00208             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j] = i;
00209             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a> = j;
00210 
00211             SystemLineSize = (<span class="keyword">sizeof</span>(WCHAR)+<span class="keyword">sizeof</span>(UCHAR))*dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00212             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> &lt; SystemLineSize ){
00213                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
00214                     LocalFree( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> );
00215                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00216                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> = 0;
00217                 }
00218                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> = (<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a>)LocalAlloc(LPTR, SystemLineSize );
00219                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00220                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00221                 }
00222                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> = SystemLineSize;
00223             }
00224             SystemLine = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a>;
00225 
00226             SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o0">AttrOff</a> = <span class="keyword">sizeof</span>(WCHAR) * dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00227 
00228             CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a7">CI_CONIMECANDINFO</a>;
00229             CopyData.cbData = (<span class="keyword">sizeof</span>(WCHAR)+<span class="keyword">sizeof</span>(UCHAR))*dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00230             CopyData.lpData = SystemLine;
00231             StartIndex = <a class="code" href="../../d7/d7/country2_8c.html#a6">GetSystemLineJ</a>( lpCandList,
00232                            SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o1">String</a>,
00233                            (LPSTR)SystemLine + SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o0">AttrOff</a>,
00234                            dwLength,
00235                            CountDispWidth,
00236                            ConTbl,
00237                            EnableCodePoint);
00238 
00239             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o25">fNestCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// ImmNotyfyIME call back OpenCandidate Message</span>
00240                                         <span class="comment">// by same data.</span>
00241                                         <span class="comment">// so We ignore this mesage.</span>
00242             <a class="code" href="../../d6/d0/immime_8c.html#a22">ImmNotifyIME</a>(hIMC,
00243                          NI_SETCANDIDATE_PAGESTART,
00244                          dwIndex,
00245                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex]);
00246 
00247             <a class="code" href="../../d6/d0/immime_8c.html#a22">ImmNotifyIME</a>(hIMC,
00248                          NI_SETCANDIDATE_PAGESIZE,
00249                          dwIndex,
00250                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex+1] -
00251                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex]);
00252             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o25">fNestCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00253 
00254             <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00255                                    (WPARAM)hwnd,
00256                                    (LPARAM)&amp;CopyData
00257                                   );
00258         }
00259     }
00260     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00261 }
00262 
00263 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00264"></a><a class="code" href="../../d7/d7/country2_8c.html#a2">00264</a> <a class="code" href="../../d7/d7/country2_8c.html#a2">OpenCandidateTaiwan</a>(
00265     HWND hwnd,
00266     HIMC  hIMC ,
00267     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
00268     DWORD CandList,
00269     BOOL OpenFlag
00270     )
00271 {
00272     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLength;
00273     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
00274     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00275     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> j;
00276     LPWSTR lpStr;
00277     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDspLen;
00278     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> width;
00279     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> StartIndex;
00280     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CountDispWidth;
00281     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> AllocLength;
00282     LPCANDIDATELIST lpCandList;
00283     <a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a> SystemLine;
00284     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SystemLineSize;
00285     COPYDATASTRUCT CopyData;
00286     <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo;
00287 
00288     lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)LocalAlloc( LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>) );
00289     <span class="keywordflow">if</span> ( lpModeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00290         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00291     }
00292 
00293     <span class="keywordflow">for</span> (dwIndex = 0; dwIndex &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a> ; dwIndex ++ ) {
00294         <span class="keywordflow">if</span> ( CandList &amp; ( 1 &lt;&lt; dwIndex ) ) {
00295             dwLength = ImmGetCandidateList(hIMC, dwIndex, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00296             <span class="keywordflow">if</span> (dwLength == 0)
00297                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00298             <span class="keywordflow">if</span> ( (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] != dwLength ) &amp;&amp;
00299                  (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00300                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex]);
00301                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = 0;
00302                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00303             }
00304             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00305                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = LocalAlloc(LPTR, dwLength);
00306                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00307                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00308                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = dwLength;
00309             }
00310             lpCandList = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex];
00311             ImmGetCandidateList(hIMC, dwIndex, lpCandList, dwLength);
00312 
00313             <span class="comment">//</span>
00314             <span class="comment">// check each offset value is not over than buffer size.</span>
00315             <span class="comment">//</span>
00316             <span class="keywordflow">if</span> ((lpCandList-&gt;dwCount &gt; 1) &amp;&amp;
00317                 (lpCandList-&gt;dwSelection &gt;= dwLength ||
00318                  lpCandList-&gt;dwPageStart &gt;= dwLength ||
00319                  lpCandList-&gt;dwOffset[lpCandList-&gt;dwSelection] &gt;= dwLength ||
00320                  lpCandList-&gt;dwOffset[lpCandList-&gt;dwPageStart] &gt;= dwLength    )
00321                )
00322                 <span class="keywordflow">break</span>;
00323 
00324             dwLength = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o2">ScreenBufferSize</a>.X;
00325             dwLength = (dwLength &gt; 128) ? 128 : dwLength ;
00326             dwLength = ((dwLength &lt; 12) ? 12 : dwLength );
00327 <span class="preprocessor">#if defined (CANDCOUNTCHT) //for wider candidate list space v-hirshi Oct.16.1996</span>
00328 <span class="preprocessor"></span>            dwLength -= 28; <span class="comment">// 6+1+4+1+10+1+....+4+1</span>
00329 <span class="preprocessor">#else</span>
00330 <span class="preprocessor"></span>            dwLength -= <a class="code" href="../../d4/d5/conimep_8h.html#a87">IMECNameLength</a>+1+<a class="code" href="../../d4/d5/conimep_8h.html#a82">IMECModeFullShapeLen</a>*2+1; <span class="comment">// 4+1+2+1+....</span>
00331 <span class="preprocessor">#endif</span>
00332 <span class="preprocessor"></span>
00333             j = (dwLength-7)/(<a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>+<span class="keyword">sizeof</span>(WCHAR));
00334             j = ((j &gt; 9)?9:j);
00335             j = lpCandList-&gt;dwCount / j + 10;
00336             AllocLength = (j &gt; <a class="code" href="../../d4/d5/conimep_8h.html#a33">DEFAULTCANDTABLE</a>) ? j : <a class="code" href="../../d4/d5/conimep_8h.html#a33">DEFAULTCANDTABLE</a>;
00337 
00338             <span class="keywordflow">for</span> (CountDispWidth = 0 ,j = 1; j &lt;= lpCandList-&gt;dwCount; CountDispWidth++)
00339                  j *= 10;
00340             CountDispWidth *= 2;
00341             CountDispWidth++;
00342 
00343             <span class="keywordflow">if</span> ((ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> != <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength) &amp;&amp;
00344                 (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00345                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>);
00346                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00347                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> = 0;
00348             }
00349             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00350                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>= LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength);
00351                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00352                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00353                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength;
00354             }
00355 
00356             j = 0;
00357             <span class="keywordflow">if</span> (OpenFlag) {
00358                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a> = 0;
00359             }
00360             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a>;
00361             lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ 0 ]);
00362             dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
00363             width = dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;                  <span class="comment">// '1:xxxx 2:xxxx '</span>
00364             <span class="keywordflow">for</span>( i = 1; i &lt; lpCandList-&gt;dwCount; i++ ) {
00365                 lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ i ]);
00366                 dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
00367                 width += dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
00368                 <span class="keywordflow">if</span> ((width &gt; dwLength-CountDispWidth) ||
00369                     ( i - ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j-1] &gt;= 9)){
00370                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = i;
00371                     width = dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
00372                 }
00373             }
00374             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j] = i;
00375             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a> = j;
00376 
00377             SystemLineSize = (<span class="keyword">sizeof</span>(WCHAR)+<span class="keyword">sizeof</span>(UCHAR))*dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00378             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> &lt; SystemLineSize ){
00379                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
00380                     LocalFree( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> );
00381                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00382                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> = 0;
00383                 }
00384                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> = (<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a>)LocalAlloc(LPTR, SystemLineSize );
00385                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00386                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00387                 }
00388                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> = SystemLineSize;
00389             }
00390             SystemLine = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a>;
00391 
00392             SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o0">AttrOff</a> = <span class="keyword">sizeof</span>(WCHAR) * dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00393 
00394             StartIndex = <a class="code" href="../../d7/d7/country2_8c.html#a7">GetSystemLineT</a>( lpCandList,
00395                            SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o1">String</a>,
00396                            (LPSTR)SystemLine + SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o0">AttrOff</a>,
00397                            dwLength,
00398                            CountDispWidth,
00399                            ConTbl
00400                            );
00401 
00402             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o25">fNestCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// ImmNotyfyIME call back OpenCandidate Message</span>
00403                                         <span class="comment">// by same data.</span>
00404                                         <span class="comment">// so We ignore this mesage.</span>
00405             <a class="code" href="../../d6/d0/immime_8c.html#a22">ImmNotifyIME</a>(hIMC,
00406                          NI_SETCANDIDATE_PAGESTART,
00407                          dwIndex,
00408                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex]);
00409 
00410             <a class="code" href="../../d6/d0/immime_8c.html#a22">ImmNotifyIME</a>(hIMC,
00411                          NI_SETCANDIDATE_PAGESIZE,
00412                          dwIndex,
00413                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex+1] -
00414                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex]);
00415             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o25">fNestCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00416 
00417             CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
00418             CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
00419             CopyData.lpData = lpModeInfo;
00420             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a19">MakeInfoStringTaiwan</a>(ConTbl, lpModeInfo) ) {
00421                 <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00422                                        (WPARAM)hwnd,
00423                                        (LPARAM)&amp;CopyData
00424                                      );
00425             }
00426         }
00427     }
00428     LocalFree( lpModeInfo );
00429     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00430 }
00431 
00432 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00433"></a><a class="code" href="../../d7/d7/country2_8c.html#a3">00433</a> <a class="code" href="../../d7/d7/country2_8c.html#a3">OpenCandidatePRC</a>(
00434     HWND hwnd,
00435     HIMC  hIMC ,
00436     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
00437     DWORD CandList,
00438     BOOL OpenFlag
00439     )
00440 {
00441     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLength;
00442     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
00443     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00444     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> j;
00445     LPWSTR lpStr;
00446     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDspLen;
00447     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> width;
00448     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> StartIndex;
00449     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CountDispWidth;
00450     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> AllocLength;
00451     LPCANDIDATELIST lpCandList;
00452     <a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a> SystemLine;
00453     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SystemLineSize;
00454     COPYDATASTRUCT CopyData;
00455     <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo;
00456 
00457     lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)LocalAlloc( LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>) );
00458     <span class="keywordflow">if</span> ( lpModeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00459         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00460     }
00461 
00462     <span class="keywordflow">for</span> (dwIndex = 0; dwIndex &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a> ; dwIndex ++ ) {
00463         <span class="keywordflow">if</span> ( CandList &amp; ( 1 &lt;&lt; dwIndex ) ) {
00464             dwLength = ImmGetCandidateList(hIMC, dwIndex, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00465             <span class="keywordflow">if</span> (dwLength == 0)
00466                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00467             <span class="keywordflow">if</span> ( (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] != dwLength ) &amp;&amp;
00468                  (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00469                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex]);
00470                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = 0;
00471                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00472             }
00473             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00474                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = LocalAlloc(LPTR, dwLength);
00475                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00476                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00477                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = dwLength;
00478             }
00479             lpCandList = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex];
00480             ImmGetCandidateList(hIMC, dwIndex, lpCandList, dwLength);
00481 
00482             <span class="comment">//</span>
00483             <span class="comment">// check each offset value is not over than buffer size.</span>
00484             <span class="comment">//</span>
00485             <span class="keywordflow">if</span> ((lpCandList-&gt;dwCount &gt; 1) &amp;&amp;
00486                 (lpCandList-&gt;dwSelection &gt;= dwLength ||
00487                  lpCandList-&gt;dwPageStart &gt;= dwLength ||
00488                  lpCandList-&gt;dwOffset[lpCandList-&gt;dwSelection] &gt;= dwLength ||
00489                  lpCandList-&gt;dwOffset[lpCandList-&gt;dwPageStart] &gt;= dwLength    )
00490                )
00491                 <span class="keywordflow">break</span>;
00492 
00493             dwLength = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o2">ScreenBufferSize</a>.X;
00494             dwLength = (dwLength &gt; 128) ? 128 : dwLength ;
00495             dwLength = ((dwLength &lt; 12) ? 12 : dwLength );
00496 <span class="preprocessor">#if defined (CANDCOUNTPRC) //for wider candidate list space v-hirshi Oct.16.1996</span>
00497 <span class="preprocessor"></span>            dwLength -= (20 + <a class="code" href="../../d4/d5/conimep_8h.html#a68">PRCCOMPWIDTH</a>); <span class="comment">//(8+1+4+1+PRCCOMPWIDTH+1+...+5)</span>
00498 <span class="preprocessor">#else</span>
00499 <span class="preprocessor"></span>            dwLength -= (15 + <a class="code" href="../../d4/d5/conimep_8h.html#a68">PRCCOMPWIDTH</a>); <span class="comment">//(8+1+4+1+PRCCOMPWIDTH+1+...)</span>
00500 <span class="preprocessor">#endif</span>
00501 <span class="preprocessor"></span>
00502             j = (dwLength-7)/(<a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>+<span class="keyword">sizeof</span>(WCHAR));
00503             j = ((j &gt; 9)?9:j);
00504             j = lpCandList-&gt;dwCount / j + 10;
00505             AllocLength = (j &gt; <a class="code" href="../../d4/d5/conimep_8h.html#a33">DEFAULTCANDTABLE</a>) ? j : <a class="code" href="../../d4/d5/conimep_8h.html#a33">DEFAULTCANDTABLE</a>;
00506 
00507 <span class="preprocessor">#if defined (CANDCOUNTPRC) //for wider candidate list space v-hirshi Oct.16.1996</span>
00508 <span class="preprocessor"></span>            <span class="keywordflow">for</span> (CountDispWidth = 0 ,j = 1; j &lt;= lpCandList-&gt;dwCount; CountDispWidth++)
00509                  j *= 10;
00510             CountDispWidth *= 2;
00511             CountDispWidth++;
00512 <span class="preprocessor">#else</span>
00513 <span class="preprocessor"></span>            CountDispWidth = 0;
00514 <span class="preprocessor">#endif</span>
00515 <span class="preprocessor"></span>
00516             <span class="keywordflow">if</span> ((ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> != <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength) &amp;&amp;
00517                 (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00518                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>);
00519                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00520                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> = 0;
00521             }
00522             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00523                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>= LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength);
00524                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00525                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00526                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength;
00527             }
00528 
00529             j = 0;
00530             <span class="keywordflow">if</span> (OpenFlag) {
00531                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a> = 0;
00532             }
00533             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a>;
00534             lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ 0 ]);
00535             dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
00536             width = dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;                  <span class="comment">// '1:xxxx 2:xxxx '</span>
00537             <span class="keywordflow">for</span>( i = 1; i &lt; lpCandList-&gt;dwCount; i++ ) {
00538                 lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ i ]);
00539                 dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
00540                 width += dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
00541                 <span class="keywordflow">if</span> ((width &gt; dwLength-CountDispWidth) ||
00542                     ( i - ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j-1] &gt;= 9)){
00543                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = i;
00544                     width = dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
00545                 }
00546             }
00547             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j] = i;
00548             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a> = j;
00549 
00550             SystemLineSize = (<span class="keyword">sizeof</span>(WCHAR)+<span class="keyword">sizeof</span>(UCHAR))*dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00551             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> &lt; SystemLineSize ){
00552                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
00553                     LocalFree( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> );
00554                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00555                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> = 0;
00556                 }
00557                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> = (<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a>)LocalAlloc(LPTR, SystemLineSize );
00558                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00559                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00560                 }
00561                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> = SystemLineSize;
00562             }
00563             SystemLine = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a>;
00564 
00565             SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o0">AttrOff</a> = <span class="keyword">sizeof</span>(WCHAR) * dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00566 
00567             StartIndex = <a class="code" href="../../d7/d7/country2_8c.html#a8">GetSystemLineP</a>( lpCandList,
00568                            SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o1">String</a>,
00569                            (LPSTR)SystemLine + SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o0">AttrOff</a>,
00570                            dwLength,
00571                            CountDispWidth,
00572                            ConTbl
00573                            );
00574 
00575             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o25">fNestCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// ImmNotyfyIME call back OpenCandidate Message</span>
00576                                         <span class="comment">// by same data.</span>
00577                                         <span class="comment">// so We ignore this mesage.</span>
00578             <a class="code" href="../../d6/d0/immime_8c.html#a22">ImmNotifyIME</a>(hIMC,
00579                          NI_SETCANDIDATE_PAGESTART,
00580                          dwIndex,
00581                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex]);
00582 
00583             <a class="code" href="../../d6/d0/immime_8c.html#a22">ImmNotifyIME</a>(hIMC,
00584                          NI_SETCANDIDATE_PAGESIZE,
00585                          dwIndex,
00586                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex+1] -
00587                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex]);
00588             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o25">fNestCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00589 
00590             CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
00591             CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
00592             CopyData.lpData = lpModeInfo;
00593             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a25">MakeInfoStringPRC</a>(ConTbl, lpModeInfo) ) {
00594                 <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00595                                        (WPARAM)hwnd,
00596                                        (LPARAM)&amp;CopyData
00597                                      );
00598             }
00599         }
00600     }
00601     LocalFree( lpModeInfo );
00602     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00603 }
00604 
00605 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00606"></a><a class="code" href="../../d7/d7/country2_8c.html#a4">00606</a> <a class="code" href="../../d7/d7/country2_8c.html#a4">OpenCandidateKorea</a>(
00607     HWND hwnd,
00608     HIMC  hIMC ,
00609     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
00610     DWORD CandList,
00611     BOOL OpenFlag
00612     )
00613 {
00614     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLength;
00615     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
00616     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00617     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> j;
00618     LPWSTR lpStr;
00619     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDspLen;
00620     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> width;
00621     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> StartIndex;
00622     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CountDispWidth;
00623     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> AllocLength;
00624     LPCANDIDATELIST lpCandList;
00625     <a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a> SystemLine;
00626     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SystemLineSize;
00627     COPYDATASTRUCT CopyData;
00628     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> EnableCodePoint;
00629 
00630     <span class="keywordflow">for</span> (dwIndex = 0; dwIndex &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a> ; dwIndex ++ ) {
00631         <span class="keywordflow">if</span> ( CandList &amp; ( 1 &lt;&lt; dwIndex ) ) {
00632             dwLength = ImmGetCandidateList(hIMC, dwIndex, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00633             <span class="keywordflow">if</span> (dwLength == 0)
00634                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00635             <span class="keywordflow">if</span> ( (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] != dwLength ) &amp;&amp;
00636                  (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00637                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex]);
00638                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = 0;
00639                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00640             }
00641             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00642                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = LocalAlloc(LPTR, dwLength);
00643                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00644                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00645                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = dwLength;
00646             }
00647             lpCandList = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex];
00648             ImmGetCandidateList(hIMC, dwIndex, lpCandList, dwLength);
00649 
00650             <span class="comment">//</span>
00651             <span class="comment">// check each offset value is not over than buffer size.</span>
00652             <span class="comment">//</span>
00653             <span class="keywordflow">if</span> ((lpCandList-&gt;dwCount &gt; 1) &amp;&amp;
00654                 (lpCandList-&gt;dwSelection &gt;= dwLength ||
00655                  lpCandList-&gt;dwPageStart &gt;= dwLength ||
00656                  lpCandList-&gt;dwOffset[lpCandList-&gt;dwSelection] &gt;= dwLength ||
00657                  lpCandList-&gt;dwOffset[lpCandList-&gt;dwPageStart] &gt;= dwLength    )
00658                )
00659                 <span class="keywordflow">break</span>;
00660 
00661             dwLength = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o2">ScreenBufferSize</a>.X;
00662             dwLength = (dwLength &gt; 128) ? 128 : dwLength ;
00663             dwLength = ((dwLength &lt; 12) ? 12 : dwLength );
00664 
00665             j = (dwLength-7)/(<a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>+<span class="keyword">sizeof</span>(WCHAR));
00666             j = ((j &gt; 9)?9:j);
00667             j = lpCandList-&gt;dwCount / j + 10;
00668             AllocLength = (j &gt; <a class="code" href="../../d4/d5/conimep_8h.html#a33">DEFAULTCANDTABLE</a>) ? j : <a class="code" href="../../d4/d5/conimep_8h.html#a33">DEFAULTCANDTABLE</a>;
00669 
00670             <span class="keywordflow">if</span> (lpCandList-&gt;dwStyle == IME_CAND_CODE){
00671                 EnableCodePoint = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00672             }
00673             <span class="keywordflow">else</span>{
00674                 EnableCodePoint = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00675             }
00676 
00677             <span class="keywordflow">if</span> (EnableCodePoint){
00678                 CountDispWidth = <a class="code" href="../../d4/d5/conimep_8h.html#a35">CODEDISPLEN</a>;
00679             }
00680             <span class="keywordflow">else</span> {
00681                 <span class="keywordflow">for</span> (CountDispWidth = 0 ,j = 1; j &lt;= lpCandList-&gt;dwCount; CountDispWidth++)
00682                      j *= 10;
00683                 CountDispWidth *= 2;
00684                 CountDispWidth++;
00685             }
00686 
00687             <span class="keywordflow">if</span> ((ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> != <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength) &amp;&amp;
00688                 (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00689                 LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>);
00690                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00691                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> = 0;
00692             }
00693             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00694                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>= LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength);
00695                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00696                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00697                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o24">CandSepAllocSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*AllocLength;
00698             }
00699 
00700             <span class="keywordflow">if</span> ( EnableCodePoint ){
00701                 j = 0;
00702                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = 0;
00703                 <span class="keywordflow">if</span> (OpenFlag) {
00704                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a> = lpCandList-&gt;dwSelection % 9;
00705                 }
00706                 i = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a>;
00707                 <span class="keywordflow">for</span> (; i &lt; lpCandList-&gt;dwCount; i+= 9 ) {
00708                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = i;
00709                 }
00710                 <span class="keywordflow">if</span> (i &gt; lpCandList-&gt;dwCount) {
00711                     i = lpCandList-&gt;dwCount;
00712                 }
00713             }
00714             <span class="keywordflow">else</span>{
00715                 j = 0;
00716                 <span class="keywordflow">if</span> (OpenFlag) {
00717                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a> = 0;
00718                 }
00719                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o21">CandOff</a>;
00720                 lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ 0 ]);
00721                 dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
00722                 width = dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;                  <span class="comment">// '1:xxxx 2:xxxx '</span>
00723                 <span class="keywordflow">for</span>( i = 1; i &lt; lpCandList-&gt;dwCount; i++ ) {
00724                     lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ i ]);
00725                     dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
00726                     width += dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
00727                     <span class="keywordflow">if</span> ((width &gt; dwLength-CountDispWidth) ||
00728                         ( i - ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j-1] &gt;= 9)){
00729                         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j++] = i;
00730                         width = dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
00731                     }
00732                 }
00733             }
00734             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[j] = i;
00735             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a> = j;
00736 
00737             SystemLineSize = (<span class="keyword">sizeof</span>(WCHAR)+<span class="keyword">sizeof</span>(UCHAR))*dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00738             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> &lt; SystemLineSize ){
00739                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
00740                     LocalFree( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> );
00741                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00742                     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> = 0;
00743                 }
00744                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> = (<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html">LPCONIME_CANDMESSAGE</a>)LocalAlloc(LPTR, SystemLineSize );
00745                 <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00746                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00747                 }
00748                 ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o19">SystemLineSize</a> = SystemLineSize;
00749             }
00750             SystemLine = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o18">SystemLine</a>;
00751 
00752             SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o0">AttrOff</a> = <span class="keyword">sizeof</span>(WCHAR) * dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00753 
00754             CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a7">CI_CONIMECANDINFO</a>;
00755             CopyData.cbData = (<span class="keyword">sizeof</span>(WCHAR)+<span class="keyword">sizeof</span>(UCHAR))*dwLength + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00756             CopyData.lpData = SystemLine;
00757             StartIndex = <a class="code" href="../../d7/d7/country2_8c.html#a6">GetSystemLineJ</a>( lpCandList,
00758                            SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o1">String</a>,
00759                            (LPSTR)SystemLine + SystemLine-&gt;<a class="code" href="../../d8/d8/struct__CONIME__CANDMESSAGE.html#o0">AttrOff</a>,
00760                            dwLength,
00761                            CountDispWidth,
00762                            ConTbl,
00763                            EnableCodePoint);
00764 
00765             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o25">fNestCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// ImmNotyfyIME call back OpenCandidate Message</span>
00766                                         <span class="comment">// by same data.</span>
00767                                         <span class="comment">// so We ignore this mesage.</span>
00768             <a class="code" href="../../d6/d0/immime_8c.html#a22">ImmNotifyIME</a>(hIMC,
00769                          NI_SETCANDIDATE_PAGESTART,
00770                          dwIndex,
00771                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex]);
00772 
00773             <a class="code" href="../../d6/d0/immime_8c.html#a22">ImmNotifyIME</a>(hIMC,
00774                          NI_SETCANDIDATE_PAGESIZE,
00775                          dwIndex,
00776                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex+1] -
00777                          ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[StartIndex]);
00778             ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o25">fNestCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00779 
00780             <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00781                                    (WPARAM)hwnd,
00782                                    (LPARAM)&amp;CopyData
00783                                  );
00784         }
00785     }
00786     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00787 }
00788 
00789 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00790"></a><a class="code" href="../../d7/d7/country2_8c.html#a5">00790</a> <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>(
00791     LPWSTR lpString )
00792 {
00793     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00794     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length;
00795 
00796     Length = 0;
00797 
00798     <span class="keywordflow">for</span> ( i = 0; lpString[i] != 0; i++) {
00799         Length += <a class="code" href="../../d0/d6/consubs_8c.html#a5">IsUnicodeFullWidth</a>(lpString[i]) ? 2 : 1;
00800     }
00801     <span class="keywordflow">return</span> Length;
00802 }
00803 
00804 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00805"></a><a class="code" href="../../d7/d7/country2_8c.html#a6">00805</a> <a class="code" href="../../d7/d7/country2_8c.html#a6">GetSystemLineJ</a>(
00806     LPCANDIDATELIST lpCandList ,
00807     LPWSTR String,
00808     LPSTR Attr,
00809     DWORD dwLength,
00810     DWORD CountDispWidth,
00811     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> FocusedConsole,
00812     BOOL EnableCodePoint)
00813 {
00814     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwStrLen;
00815     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDspLen;
00816     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00817     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> j;
00818     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SepIndex;
00819     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SelCount;
00820     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length;
00821     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwWholeLen;
00822     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> lfBreak = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00823     LPWSTR StrToWrite;
00824     LPSTR AttrToSel;
00825     LPWSTR lpStr;
00826     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MultiChar;
00827     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TempMulti;
00828 
00829     <span class="keywordflow">if</span> ((lpCandList-&gt;dwSelection &gt; lpCandList-&gt;dwCount)||
00830         (lpCandList-&gt;dwSelection &lt; 0)) {
00831         lpCandList-&gt;dwSelection  = 0;
00832     }
00833 
00834     <span class="keywordflow">for</span> ( SepIndex = FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a>; SepIndex &gt; 0; SepIndex--) {
00835         <span class="keywordflow">if</span> (lpCandList-&gt;dwSelection &gt;= FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[SepIndex])
00836             <span class="keywordflow">break</span>;
00837     }
00838     <span class="keywordflow">if</span> (SepIndex == FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a>)
00839         SepIndex = 0;
00840 
00841     <span class="keywordflow">for</span> ( i = 0; i &lt; dwLength; i++) {
00842         Attr[i] = 0x0000;
00843     }
00844     StrToWrite = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00845     AttrToSel = Attr;
00846     dwWholeLen = 0;
00847 <span class="preprocessor">#if 1</span>
00848 <span class="preprocessor"></span>    <span class="comment">// HACK HACK ntbug #69699</span>
00849     <span class="comment">// MS-IME97 &amp; MS-IME97A does not return correct value for IME_PROP_CANDLIST_START_FROM_1.</span>
00850     <span class="comment">// These always return its starting from 0.</span>
00851     <span class="comment">// Currently there is not IME starting from 0. So we hack.</span>
00852     <span class="comment">// Actually IME should be fixed.</span>
00853     SelCount = 1;
00854 <span class="preprocessor">#else</span>
00855 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o26">ImmGetProperty</a> &amp; IME_PROP_CANDLIST_START_FROM_1)
00856         SelCount = 1;
00857     <span class="keywordflow">else</span>
00858         SelCount = 0;
00859 <span class="preprocessor">#endif</span>
00860 <span class="preprocessor"></span>
00861     <span class="keywordflow">if</span> (EnableCodePoint){
00862         lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[lpCandList-&gt;dwSelection]);
00863         WideCharToMultiByte(CP_OEMCP, 0, lpStr, 1, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;TempMulti, 2, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00864         *StrToWrite = <a class="code" href="../../d4/d5/conimep_8h.html#a61">UNICODE_LEFT</a>;
00865         StrToWrite++;
00866         MultiChar = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(TempMulti)| <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(TempMulti)&lt;&lt;8);
00867         <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
00868             j = (MultiChar &amp; 0xf000 ) &gt;&gt; 12;
00869             <span class="keywordflow">if</span> ( j &lt;= 9)
00870                 *StrToWrite = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(j + <a class="code" href="../../d4/d5/conimep_8h.html#a58">UNICODE_ZERO</a>);
00871             <span class="keywordflow">else</span>
00872                 *StrToWrite = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(j + <a class="code" href="../../d4/d5/conimep_8h.html#a63">UNICODE_HEXBASE</a>);
00873             StrToWrite++;
00874             MultiChar = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(MultiChar &lt;&lt; 4);
00875         }
00876         *StrToWrite = <a class="code" href="../../d4/d5/conimep_8h.html#a62">UNICODE_RIGHT</a>;
00877         StrToWrite++;
00878         *StrToWrite = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00879         StrToWrite++;
00880         AttrToSel += CountDispWidth;
00881         dwWholeLen += CountDispWidth;
00882         CountDispWidth = 0;
00883     }
00884 
00885     <span class="keywordflow">for</span> (i = FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[SepIndex]; i &lt; FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[SepIndex+1]; i++) {
00886         <span class="comment">//</span>
00887         <span class="comment">// check each offset value is not over than buffer size.</span>
00888         <span class="comment">//</span>
00889         <span class="keywordflow">if</span> (lpCandList-&gt;dwOffset[i] &gt;= lpCandList-&gt;dwSize)
00890             <span class="keywordflow">break</span>;
00891 
00892         lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ i ]);
00893         dwStrLen = lstrlenW( lpStr );
00894         dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
00895 
00896         <span class="keywordflow">if</span> ( dwWholeLen + dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>  &gt; dwLength - CountDispWidth ){
00897             Length = 0;
00898             lfBreak = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00899             <span class="keywordflow">for</span> (j = 0; j &lt; dwStrLen; j++ ){
00900                 Length += <a class="code" href="../../d0/d6/consubs_8c.html#a5">IsUnicodeFullWidth</a>(lpStr[j]) ? 2 : 1;
00901                 <span class="keywordflow">if</span> (dwWholeLen + Length &gt; dwLength - (CountDispWidth + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>)){
00902                     dwStrLen = j-1;
00903                     dwDspLen = Length - <a class="code" href="../../d0/d6/consubs_8c.html#a5">IsUnicodeFullWidth</a>(lpStr[j]) ? 2 : 1;
00904                     <span class="keywordflow">break</span>;
00905                 }
00906             }
00907         }
00908         <span class="keywordflow">if</span> ((dwWholeLen + dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a> + CountDispWidth ) &lt;= dwLength )      <span class="comment">// if minus value</span>
00909             dwWholeLen += (dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>);
00910         <span class="keywordflow">else</span> {
00911             <span class="keywordflow">break</span>;
00912         }
00913 
00914         <span class="keywordflow">if</span> (i == lpCandList-&gt;dwSelection) {
00915             <span class="keywordflow">for</span> (j = 0; j &lt; dwStrLen+2; j++)
00916                 *(AttrToSel+j) = 1;
00917         }
00918         *StrToWrite = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(SelCount + <a class="code" href="../../d4/d5/conimep_8h.html#a58">UNICODE_ZERO</a>);
00919         StrToWrite++;
00920         *StrToWrite = <a class="code" href="../../d4/d5/conimep_8h.html#a60">UNICODE_COLON</a>;
00921         StrToWrite++;
00922         CopyMemory(StrToWrite, lpStr, dwStrLen * <span class="keyword">sizeof</span>(WCHAR));
00923         StrToWrite += dwStrLen;
00924         *StrToWrite = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00925         StrToWrite++;
00926         AttrToSel += dwStrLen+<a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
00927         SelCount++;
00928         <span class="keywordflow">if</span> (lfBreak)
00929             <span class="keywordflow">break</span>;
00930     }
00931     *StrToWrite = 0;
00932     dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> );
00933     <span class="keywordflow">if</span> (dwDspLen &gt; (dwLength - CountDispWidth))
00934         <span class="keywordflow">return</span> SepIndex;
00935 
00936     <span class="keywordflow">if</span> (EnableCodePoint){
00937         <span class="keywordflow">for</span> (i = dwDspLen; i &lt; dwLength; i++) {
00938             *StrToWrite = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00939             StrToWrite++;
00940         }
00941     }
00942     <span class="keywordflow">else</span> {
00943         <span class="keywordflow">for</span> (i = dwDspLen; i &lt; (dwLength - CountDispWidth); i++) {
00944             *StrToWrite = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00945             StrToWrite++;
00946         }
00947 
00948         i = (CountDispWidth-1) / 2;
00949         <a class="code" href="../../d7/d7/country2_8c.html#a9">NumString</a>(StrToWrite,lpCandList-&gt;dwSelection+1,i);
00950         StrToWrite+=i;
00951         *StrToWrite = <a class="code" href="../../d4/d5/conimep_8h.html#a59">UNICODE_SLASH</a>;
00952         StrToWrite++;
00953         <a class="code" href="../../d7/d7/country2_8c.html#a9">NumString</a>(StrToWrite,lpCandList-&gt;dwCount, i);
00954         StrToWrite+=i;
00955     }
00956     *StrToWrite = 0;
00957 
00958     <span class="keywordflow">return</span> SepIndex;
00959 }
00960 
00961 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00962"></a><a class="code" href="../../d7/d7/country2_8c.html#a7">00962</a> <a class="code" href="../../d7/d7/country2_8c.html#a7">GetSystemLineT</a>(
00963     LPCANDIDATELIST lpCandList ,
00964     LPWSTR String,
00965     LPSTR Attr,
00966     DWORD dwLength,
00967     DWORD CountDispWidth,
00968     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> FocusedConsole
00969     )
00970 {
00971     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwStrLen;
00972     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDspLen;
00973     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
00974     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> j;
00975     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SepIndex;
00976     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SelCount;
00977     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length;
00978     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwWholeLen;
00979     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> lfBreak = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00980     LPWSTR StrToWrite;
00981     LPSTR AttrToSel;
00982     LPWSTR lpStr;
00983     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MultiChar;
00984     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TempMulti;
00985 
00986     <span class="keywordflow">if</span> ((lpCandList-&gt;dwSelection &gt; lpCandList-&gt;dwCount)||
00987         (lpCandList-&gt;dwSelection &lt; 0)) {
00988         lpCandList-&gt;dwSelection  = 0;
00989     }
00990 
00991     <span class="keywordflow">for</span> ( SepIndex = FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a>; SepIndex &gt; 0; SepIndex--) {
00992         <span class="keywordflow">if</span> (lpCandList-&gt;dwSelection &gt;= FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[SepIndex])
00993             <span class="keywordflow">break</span>;
00994     }
00995     <span class="keywordflow">if</span> (SepIndex == FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a>)
00996         SepIndex = 0;
00997 
00998     <span class="keywordflow">for</span> ( i = 0; i &lt; dwLength; i++) {
00999         Attr[i] = 0x0000;
01000     }
01001     StrToWrite = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
01002     AttrToSel = Attr;
01003     dwWholeLen = 0;
01004     <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o26">ImmGetProperty</a> &amp; IME_PROP_CANDLIST_START_FROM_1)
01005         SelCount = 1;
01006     <span class="keywordflow">else</span>
01007         SelCount = 0;
01008 
01009 
01010     <span class="keywordflow">for</span> (i = FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[SepIndex]; i &lt; FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[SepIndex+1]; i++) {
01011         lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ i ]);
01012         dwStrLen = lstrlenW( lpStr );
01013         dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
01014 
01015         <span class="keywordflow">if</span> ( dwWholeLen + dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>  &gt; dwLength - CountDispWidth ){
01016             Length = 0;
01017             lfBreak = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01018             <span class="keywordflow">for</span> (j = 0; j &lt; dwStrLen; j++ ){
01019                 Length += <a class="code" href="../../d0/d6/consubs_8c.html#a5">IsUnicodeFullWidth</a>(lpStr[j]) ? 2 : 1;
01020                 <span class="keywordflow">if</span> (dwWholeLen + Length &gt; dwLength - (CountDispWidth + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>)){
01021                     dwStrLen = j-1;
01022                     dwDspLen = Length - <a class="code" href="../../d0/d6/consubs_8c.html#a5">IsUnicodeFullWidth</a>(lpStr[j]) ? 2 : 1;
01023                     <span class="keywordflow">break</span>;
01024                 }
01025             }
01026         }
01027         <span class="keywordflow">if</span> ((dwWholeLen + dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a> + CountDispWidth ) &lt;= dwLength )      <span class="comment">// if minus value</span>
01028             dwWholeLen += (dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>);
01029         <span class="keywordflow">else</span> {
01030             <span class="keywordflow">break</span>;
01031         }
01032 
01033         <span class="keywordflow">if</span> (i == lpCandList-&gt;dwSelection) {
01034             <span class="keywordflow">for</span> (j = 0; j &lt; dwStrLen+2; j++)
01035                 *(AttrToSel+j) = 1;
01036         }
01037         *StrToWrite = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(SelCount + <a class="code" href="../../d4/d5/conimep_8h.html#a58">UNICODE_ZERO</a>);
01038         StrToWrite++;
01039         *StrToWrite = <a class="code" href="../../d4/d5/conimep_8h.html#a60">UNICODE_COLON</a>;
01040         StrToWrite++;
01041         CopyMemory(StrToWrite, lpStr, dwStrLen * <span class="keyword">sizeof</span>(WCHAR));
01042         StrToWrite += dwStrLen;
01043         *StrToWrite = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01044         StrToWrite++;
01045         AttrToSel += dwStrLen+<a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
01046         SelCount++;
01047         <span class="keywordflow">if</span> (lfBreak)
01048             <span class="keywordflow">break</span>;
01049     }
01050     *StrToWrite = 0;
01051     dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> );
01052     <span class="keywordflow">if</span> (dwDspLen &gt; (dwLength - CountDispWidth))
01053         <span class="keywordflow">return</span> SepIndex;
01054 
01055     *StrToWrite = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01056     StrToWrite++;
01057 
01058     i = (CountDispWidth-1) / 2;
01059     <a class="code" href="../../d7/d7/country2_8c.html#a9">NumString</a>(StrToWrite,lpCandList-&gt;dwSelection+1,i);
01060     StrToWrite+=i;
01061     *StrToWrite = <a class="code" href="../../d4/d5/conimep_8h.html#a59">UNICODE_SLASH</a>;
01062     StrToWrite++;
01063     <a class="code" href="../../d7/d7/country2_8c.html#a9">NumString</a>(StrToWrite,lpCandList-&gt;dwCount, i);
01064     StrToWrite+=i;
01065     *StrToWrite = 0;
01066 
01067     <span class="keywordflow">return</span> SepIndex;
01068 }
01069 
01070 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01071"></a><a class="code" href="../../d7/d7/country2_8c.html#a8">01071</a> <a class="code" href="../../d7/d7/country2_8c.html#a8">GetSystemLineP</a>(
01072     LPCANDIDATELIST lpCandList ,
01073     LPWSTR String,
01074     LPSTR Attr,
01075     DWORD dwLength,
01076     DWORD CountDispWidth,
01077     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> FocusedConsole
01078     )
01079 {
01080     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwStrLen;
01081     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDspLen;
01082     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
01083     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> j;
01084     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SepIndex;
01085     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SelCount;
01086     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length;
01087     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwWholeLen;
01088     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> lfBreak = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01089     LPWSTR StrToWrite;
01090     LPSTR AttrToSel;
01091     LPWSTR lpStr;
01092     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MultiChar;
01093     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TempMulti;
01094 
01095     <span class="keywordflow">if</span> ((lpCandList-&gt;dwSelection &gt; lpCandList-&gt;dwCount)||
01096         (lpCandList-&gt;dwSelection &lt; 0)) {
01097         lpCandList-&gt;dwSelection  = 0;
01098     }
01099 
01100     <span class="keywordflow">for</span> ( SepIndex = FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a>; SepIndex &gt; 0; SepIndex--) {
01101         <span class="keywordflow">if</span> (lpCandList-&gt;dwSelection &gt;= FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[SepIndex])
01102             <span class="keywordflow">break</span>;
01103     }
01104     <span class="keywordflow">if</span> (SepIndex == FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o22">CandMax</a>)
01105         SepIndex = 0;
01106 
01107     <span class="keywordflow">for</span> ( i = 0; i &lt; dwLength; i++) {
01108         Attr[i] = 0x0000;
01109     }
01110     StrToWrite = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
01111     AttrToSel = Attr;
01112     dwWholeLen = 0;
01113     <span class="keywordflow">if</span> (FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o26">ImmGetProperty</a> &amp; IME_PROP_CANDLIST_START_FROM_1)
01114         SelCount = 1;
01115     <span class="keywordflow">else</span>
01116         SelCount = 0;
01117 
01118     <span class="keywordflow">for</span> (i = FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[SepIndex]; i &lt; FocusedConsole-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o23">CandSep</a>[SepIndex+1]; i++) {
01119         lpStr = (LPWSTR)((LPSTR)lpCandList + lpCandList-&gt;dwOffset[ i ]);
01120         dwStrLen = lstrlenW( lpStr );
01121         dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( lpStr );
01122 
01123         <span class="keywordflow">if</span> ( dwWholeLen + dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>  &gt; dwLength - CountDispWidth ){
01124             Length = 0;
01125             lfBreak = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01126             <span class="keywordflow">for</span> (j = 0; j &lt; dwStrLen; j++ ){
01127                 Length += <a class="code" href="../../d0/d6/consubs_8c.html#a5">IsUnicodeFullWidth</a>(lpStr[j]) ? 2 : 1;
01128                 <span class="keywordflow">if</span> (dwWholeLen + Length &gt; dwLength - (CountDispWidth + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>)){
01129                     dwStrLen = j-1;
01130                     dwDspLen = Length - <a class="code" href="../../d0/d6/consubs_8c.html#a5">IsUnicodeFullWidth</a>(lpStr[j]) ? 2 : 1;
01131                     <span class="keywordflow">break</span>;
01132                 }
01133             }
01134         }
01135         <span class="keywordflow">if</span> ((dwWholeLen + dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a> + CountDispWidth ) &lt;= dwLength )      <span class="comment">// if minus value</span>
01136             dwWholeLen += (dwDspLen + <a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>);
01137         <span class="keywordflow">else</span> {
01138             <span class="keywordflow">break</span>;
01139         }
01140 
01141         <span class="keywordflow">if</span> (i == lpCandList-&gt;dwSelection) {
01142             <span class="keywordflow">for</span> (j = 0; j &lt; dwStrLen+2; j++)
01143                 *(AttrToSel+j) = 1;
01144         }
01145         *StrToWrite = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(SelCount + <a class="code" href="../../d4/d5/conimep_8h.html#a58">UNICODE_ZERO</a>);
01146         StrToWrite++;
01147         *StrToWrite = <a class="code" href="../../d4/d5/conimep_8h.html#a60">UNICODE_COLON</a>;
01148         StrToWrite++;
01149         CopyMemory(StrToWrite, lpStr, dwStrLen * <span class="keyword">sizeof</span>(WCHAR));
01150         StrToWrite += dwStrLen;
01151         *StrToWrite = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01152         StrToWrite++;
01153         AttrToSel += dwStrLen+<a class="code" href="../../d4/d5/conimep_8h.html#a32">DELIMITERWIDTH</a>;
01154         SelCount++;
01155         <span class="keywordflow">if</span> (lfBreak)
01156             <span class="keywordflow">break</span>;
01157     }
01158     *StrToWrite = 0;
01159     dwDspLen = <a class="code" href="../../d7/d7/country2_8c.html#a5">DispLenUnicode</a>( <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> );
01160     <span class="keywordflow">if</span> (dwDspLen &gt; (dwLength - CountDispWidth))
01161         <span class="keywordflow">return</span> SepIndex;
01162 
01163 <span class="preprocessor">#if defined (CANDCOUNTPRC) //for wider candidate list space v-hirshi Oct.16.1996</span>
01164 <span class="preprocessor"></span>    *StrToWrite = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01165     StrToWrite++;
01166 
01167     i = (CountDispWidth-1) / 2;
01168     <a class="code" href="../../d7/d7/country2_8c.html#a9">NumString</a>(StrToWrite,lpCandList-&gt;dwSelection+1,i);
01169     StrToWrite+=i;
01170     *StrToWrite = <a class="code" href="../../d4/d5/conimep_8h.html#a59">UNICODE_SLASH</a>;
01171     StrToWrite++;
01172     <a class="code" href="../../d7/d7/country2_8c.html#a9">NumString</a>(StrToWrite,lpCandList-&gt;dwCount, i);
01173     StrToWrite+=i;
01174 <span class="preprocessor">#endif</span>
01175 <span class="preprocessor"></span>
01176     *StrToWrite = 0;
01177 
01178     <span class="keywordflow">return</span> SepIndex;
01179 }
01180 
01181 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01182"></a><a class="code" href="../../d7/d7/country2_8c.html#a9">01182</a> <a class="code" href="../../d7/d7/country2_8c.html#a9">NumString</a>(
01183     LPWSTR StrToWrite,
01184     DWORD NumToDisp,
01185     DWORD CountDispWidth)
01186 {
01187     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
01188     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> k;
01189     k = 1;
01190     <span class="keywordflow">for</span> (i = 1; i &lt; CountDispWidth; i++)
01191         k *= 10;
01192     <span class="keywordflow">for</span> (i = k; i &gt; 0; i /= 10){
01193         k = (NumToDisp / i);
01194         *StrToWrite = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(k + <a class="code" href="../../d4/d5/conimep_8h.html#a58">UNICODE_ZERO</a>);
01195         <span class="keywordflow">if</span> ((*StrToWrite == <a class="code" href="../../d4/d5/conimep_8h.html#a58">UNICODE_ZERO</a>) &amp;&amp;
01196             ((*(StrToWrite-1) == <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>)||(*(StrToWrite-1) == <a class="code" href="../../d4/d5/conimep_8h.html#a59">UNICODE_SLASH</a>)) )
01197             *StrToWrite = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01198         StrToWrite++;
01199         NumToDisp -= (i*k);
01200     }
01201 }
01202 
01203 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01204"></a><a class="code" href="../../d7/d7/country2_8c.html#a10">01204</a> <a class="code" href="../../d7/d7/country2_8c.html#a10">ImeUICloseCandidate</a>(
01205    HWND hwnd,
01206    DWORD CandList
01207    )
01208 {
01209     HIMC  hIMC;
01210     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
01211 
01212     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Get IMN_CLOSECANDIDATE Message\n"</span>));
01213 
01214     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a>);
01215     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01216         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
01217         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01218     }
01219 
01220     hIMC = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>( hwnd );
01221     <span class="keywordflow">if</span> ( hIMC == 0 )
01222         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">// Reset fInCandidate variables.</span>
01226     <span class="comment">//</span>
01227     ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o16">fInCandidate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01228 
01229     <span class="keywordflow">switch</span> ( <a class="code" href="../../d4/d5/conimep_8h.html#a50">HKL_TO_LANGID</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a>))
01230     {
01231         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a43">LANG_ID_JAPAN</a>:
01232             <a class="code" href="../../d7/d7/country2_8c.html#a11">CloseCandidateJapan</a>(hwnd, hIMC, ConTbl, CandList );
01233             <span class="keywordflow">break</span>;
01234         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a42">LANG_ID_TAIWAN</a>:
01235             <a class="code" href="../../d7/d7/country2_8c.html#a12">CloseCandidateTaiwan</a>(hwnd, hIMC, ConTbl, CandList );
01236             <span class="keywordflow">break</span>;
01237         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a45">LANG_ID_PRC</a>:
01238             <a class="code" href="../../d7/d7/country2_8c.html#a13">CloseCandidatePRC</a>(hwnd, hIMC, ConTbl, CandList );
01239             <span class="keywordflow">break</span>;
01240         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a44">LANG_ID_KOREA</a>:
01241             <a class="code" href="../../d7/d7/country2_8c.html#a14">CloseCandidateKorea</a>(hwnd, hIMC, ConTbl, CandList );
01242             <span class="keywordflow">break</span>;
01243         <span class="keywordflow">default</span>:
01244             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01245             <span class="keywordflow">break</span>;
01246     }
01247     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
01248 
01249     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01250 }
01251 
01252 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01253"></a><a class="code" href="../../d7/d7/country2_8c.html#a11">01253</a> <a class="code" href="../../d7/d7/country2_8c.html#a11">CloseCandidateJapan</a>(
01254     HWND hwnd,
01255     HIMC hIMC,
01256     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
01257     DWORD CandList
01258    )
01259 {
01260     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
01261     COPYDATASTRUCT CopyData;
01262 
01263     <span class="keywordflow">for</span> (dwIndex = 0; dwIndex &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a> ; dwIndex ++ ) {
01264         <span class="keywordflow">if</span> ( CandList &amp; ( 1 &lt;&lt; dwIndex ) ) {
01265             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01266                  LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex]);
01267                  ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01268                  ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = 0;
01269             }
01270         }
01271     }
01272 
01273     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a7">CI_CONIMECANDINFO</a>;
01274     CopyData.cbData = 0;
01275     CopyData.lpData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01276     <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01277                            (WPARAM)hwnd,
01278                            (LPARAM)&amp;CopyData
01279                           );
01280 
01281     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01282 }
01283 
01284 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01285"></a><a class="code" href="../../d7/d7/country2_8c.html#a12">01285</a> <a class="code" href="../../d7/d7/country2_8c.html#a12">CloseCandidateTaiwan</a>(
01286     HWND hwnd,
01287     HIMC hIMC,
01288     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
01289     DWORD CandList
01290    )
01291 {
01292     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
01293     COPYDATASTRUCT CopyData;
01294     <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo;
01295     lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)LocalAlloc( LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>) );
01296     <span class="keywordflow">if</span> ( lpModeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01297         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01298     }
01299 
01300     <span class="keywordflow">for</span> (dwIndex = 0; dwIndex &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a> ; dwIndex ++ ) {
01301         <span class="keywordflow">if</span> ( CandList &amp; ( 1 &lt;&lt; dwIndex ) ) {
01302             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01303                  LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex]);
01304                  ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01305                  ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = 0;
01306             }
01307         }
01308     }
01309 
01310     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
01311     CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
01312     CopyData.lpData = lpModeInfo;
01313     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a19">MakeInfoStringTaiwan</a>(ConTbl, lpModeInfo) ) {
01314         <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01315                                (WPARAM)hwnd,
01316                                (LPARAM)&amp;CopyData
01317                              );
01318     }
01319 
01320     LocalFree( lpModeInfo );
01321     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01322 
01323 }
01324 
01325 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01326"></a><a class="code" href="../../d7/d7/country2_8c.html#a13">01326</a> <a class="code" href="../../d7/d7/country2_8c.html#a13">CloseCandidatePRC</a>(
01327     HWND hwnd,
01328     HIMC hIMC,
01329     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
01330     DWORD CandList
01331    )
01332 {
01333     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
01334     COPYDATASTRUCT CopyData;
01335     <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo;
01336     lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)LocalAlloc( LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>) );
01337     <span class="keywordflow">if</span> ( lpModeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01338         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01339     }
01340 
01341     <span class="keywordflow">for</span> (dwIndex = 0; dwIndex &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a> ; dwIndex ++ ) {
01342         <span class="keywordflow">if</span> ( CandList &amp; ( 1 &lt;&lt; dwIndex ) ) {
01343             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01344                  LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex]);
01345                  ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01346                  ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = 0;
01347             }
01348         }
01349     }
01350 
01351     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
01352     CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
01353     CopyData.lpData = lpModeInfo;
01354     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a25">MakeInfoStringPRC</a>(ConTbl, lpModeInfo) ) {
01355         <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01356                                (WPARAM)hwnd,
01357                                (LPARAM)&amp;CopyData
01358                              );
01359     }
01360 
01361     LocalFree( lpModeInfo );
01362     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01363 
01364 }
01365 
01366 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01367"></a><a class="code" href="../../d7/d7/country2_8c.html#a14">01367</a> <a class="code" href="../../d7/d7/country2_8c.html#a14">CloseCandidateKorea</a>(
01368     HWND hwnd,
01369     HIMC hIMC,
01370     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
01371     DWORD CandList
01372    )
01373 {
01374     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
01375     COPYDATASTRUCT CopyData;
01376 
01377     <span class="keywordflow">for</span> (dwIndex = 0; dwIndex &lt; <a class="code" href="../../d4/d5/conimep_8h.html#a26">MAX_LISTCAND</a> ; dwIndex ++ ) {
01378         <span class="keywordflow">if</span> ( CandList &amp; ( 1 &lt;&lt; dwIndex ) ) {
01379             <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01380                  LocalFree(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex]);
01381                  ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o17">lpCandListMem</a>[dwIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01382                  ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o20">CandListMemAllocSize</a>[dwIndex] = 0;
01383             }
01384         }
01385     }
01386 
01387     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a7">CI_CONIMECANDINFO</a>;
01388     CopyData.cbData = 0;
01389     CopyData.lpData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01390     <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01391                            (WPARAM)hwnd,
01392                            (LPARAM)&amp;CopyData
01393                           );
01394 
01395     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01396 
01397 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
