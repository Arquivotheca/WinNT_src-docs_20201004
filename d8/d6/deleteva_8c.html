<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: deleteva.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>deleteva.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d9/d5/deleteva_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/deleteva_8c.html#a0">MiDeleteVirtualAddresses</a> (IN PUCHAR StartingAddress, IN PUCHAR EndingAddress, IN ULONG AddressSpaceDeletion, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/deleteva_8c.html#a1">MiDeletePte</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN PVOID VirtualAddress, IN ULONG AddressSpaceDeletion, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="el" href="../../d6/d2/datappc_8c.html#a10">PrototypePte</a>, IN <a class="el" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">PMMPTE_FLUSH_LIST</a> PteFlushList OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/deleteva_8c.html#a2">MiReleasePageFileSpace</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/deleteva_8c.html#a3">MiUpdateModifiedWriterMdls</a> (IN ULONG PageFileNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d6/deleteva_8c.html#a4">MiFlushPteList</a> (IN <a class="el" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">PMMPTE_FLUSH_LIST</a> PteFlushList, IN ULONG AllProcessors, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> FillPte)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="deleteva.c::MiDeletePte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiDeletePte           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AddressSpaceDeletion</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrototypePte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">PMMPTE_FLUSH_LIST</a> PteFlushList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">506</a> of file <a class="el" href="../../d9/d5/deleteva_8c-source.html">deleteva.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01585">_MMWSLE::e1</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01570">_MMWSLENTRY::LockedInMemory</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01569">_MMWSLENTRY::LockedInWs</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02228">MI_CAPTURE_DIRTY_BIT_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02336">MI_PTE_LOOKUP_NEEDED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03125">MiCheckPdeForPagedPool()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01745">MiDecrementCloneBlockReference()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01160">MiFlushPteList()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a968">MiFormatPte()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05700">MiHighestUserPte</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00715">MiLocateCloneAddress</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01016">MiReleaseWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00464">MiRemoveWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00165">MM_DBG_PTE_UPDATE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d4/d8/mi_8h.html#a446">MMWSLENTRY</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02463">PMMCLONE_BLOCK</a>, <a class="el" href="../../d4/d8/mi_8h.html#a501">PMMCLONE_DESCRIPTOR</a>, <a class="el" href="../../d4/d8/mi_8h.html#a523">PMMPTE_FLUSH_LIST</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00075">PrototypePte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01568">_MMWSLENTRY::Valid</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l02361">MiDeletePageTablesForPhysicalRange()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00026">MiDeleteVirtualAddresses()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">MiGrowWsleHash()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00265">MiRemoveMappedView()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04228">MiRemoveWorkingSetPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>00517                    :
00518 
00519     This routine deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PTE.  The PTE
00520     can be in one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following states:
00521 
00522         - active and valid
00523         - transition
00524         - in paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00525         - in prototype PTE <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>
00526 
00527 Arguments:
00528 
00529     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE to <span class="keyword">delete</span>.
00530 
00531     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which corresponds to
00532                      <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set entry
00533                      to eliminate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00534 
00535     AddressSpaceDeletion - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00536                            deleted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.  If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified
00537                            <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not flushed and valid addresses are
00538                            not removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.
00539 
00540 
00541     CurrentProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00542 
00543     <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTE which currently
00544                    or originally mapped <span class="keyword">this</span> page.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to determine
00545                    <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a fork PTE and should have its reference block
00546                    decremented.
00547 
00548 Return Value:
00549 
00550     None.
00551 
00552 Environment:
00553 
00554     Kernel mode, APCs disabled, PFN lock and working set mutex held.
00555 
00556 --*/
00557 
00558 {
00559     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00560     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00561     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00562     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00563     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00564     ULONG WorkingSetIndex;
00565     ULONG Entry;
00566     PVOID SwapVa;
00567     <a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">MMWSLENTRY</a> Locked;
00568     ULONG WsPfnIndex;
00569     <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a> CloneBlock;
00570     <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a> CloneDescriptor;
00571     ULONG Waited;
00572 
00573     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00574 
00575 <span class="preprocessor">#if DBG</span>
00576 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
00577         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"deleting PTE\n"</span>);
00578         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
00579     }
00580 <span class="preprocessor">#endif //DBG</span>
00581 <span class="preprocessor"></span>
00582     PteContents = *PointerPte;
00583 
00584     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00585 
00586 <span class="preprocessor">#ifdef _X86_</span>
00587 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
00588 <span class="preprocessor"></span><span class="preprocessor">#if !defined(NT_UP)</span>
00589 <span class="preprocessor"></span>
00590         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable == 1) {
00591             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty == 1);
00592         }
00593         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Accessed == 1);
00594 <span class="preprocessor">#endif //NTUP</span>
00595 <span class="preprocessor"></span><span class="preprocessor">#endif //DBG</span>
00596 <span class="preprocessor"></span><span class="preprocessor">#endif //X86</span>
00597 <span class="preprocessor"></span>
00598         <span class="comment">//</span>
00599         <span class="comment">// PTE is valid.  Check PFN database to see if this is a prototype PTE.</span>
00600         <span class="comment">//</span>
00601 
00602         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00603         WsPfnIndex = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex;
00604 
00605 <span class="preprocessor">#if DBG</span>
00606 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
00607             <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a>(Pfn1);
00608         }
00609 <span class="preprocessor">#endif //DBG</span>
00610 <span class="preprocessor"></span>
00611         CloneDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00612 
00613         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
00614 
00615             CloneBlock = (<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a>)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
00616 
00617             <span class="comment">//</span>
00618             <span class="comment">// Capture the state of the modified bit for this PTE.</span>
00619             <span class="comment">//</span>
00620 
00621             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (PointerPte, Pfn1);
00622 
00623             <span class="comment">//</span>
00624             <span class="comment">// Decrement the share and valid counts of the page table</span>
00625             <span class="comment">// page which maps this PTE.</span>
00626             <span class="comment">//</span>
00627 
00628             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00629             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00630 <span class="preprocessor">#if !defined (_WIN64)</span>
00631 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(MiCheckPdeForPagedPool (PointerPte))) {
00632 <span class="preprocessor">#endif</span>
00633 <span class="preprocessor"></span>                    <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
00634                                   0x61940, 
00635                                   (ULONG_PTR)PointerPte,
00636                                   (ULONG_PTR)PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00637                                   (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
00638 <span class="preprocessor">#if !defined (_WIN64)</span>
00639 <span class="preprocessor"></span>                }
00640 <span class="preprocessor">#endif</span>
00641 <span class="preprocessor"></span>            }
00642             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPde));
00643 
00644             <span class="comment">//</span>
00645             <span class="comment">// Decrement the share count for the physical page.</span>
00646             <span class="comment">//</span>
00647 
00648             <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (MI_GET_PAGE_FRAME_FROM_PTE (&amp;PteContents));
00649 
00650             <span class="comment">//</span>
00651             <span class="comment">// Check to see if this is a fork prototype PTE and if so</span>
00652             <span class="comment">// update the clone descriptor address.</span>
00653             <span class="comment">//</span>
00654 
00655             <span class="keywordflow">if</span> (PointerPte &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a>) {
00656 
00657                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a> != Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>) {
00658 
00659                     <span class="comment">//</span>
00660                     <span class="comment">// Locate the clone descriptor within the clone tree.</span>
00661                     <span class="comment">//</span>
00662 
00663                     CloneDescriptor = <a class="code" href="../../d4/d8/mi_8h.html#a104">MiLocateCloneAddress</a> ((PVOID)CloneBlock);
00664 
00665 <span class="preprocessor">#if DBG</span>
00666 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (CloneDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00667                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"1PrototypePte %p Clone desc %p pfn pte addr %p\n"</span>,
00668                         PrototypePte, CloneDescriptor, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00669                         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
00670                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
00671                     }
00672 <span class="preprocessor">#endif // DBG</span>
00673 <span class="preprocessor"></span>
00674                 }
00675             }
00676         } <span class="keywordflow">else</span> {
00677 
00678             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
00679 
00680             <span class="comment">//</span>
00681             <span class="comment">// This PTE is a NOT a prototype PTE, delete the physical page.</span>
00682             <span class="comment">//</span>
00683 
00684             <span class="comment">//</span>
00685             <span class="comment">// Decrement the share and valid counts of the page table</span>
00686             <span class="comment">// page which maps this PTE.</span>
00687             <span class="comment">//</span>
00688 
00689             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00690 
00691             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00692 
00693             <span class="comment">//</span>
00694             <span class="comment">// Decrement the share count for the physical page.  As the page</span>
00695             <span class="comment">// is private it will be put on the free list.</span>
00696             <span class="comment">//</span>
00697 
00698             <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (MI_GET_PAGE_FRAME_FROM_PTE (&amp;PteContents));
00699 
00700             <span class="comment">//</span>
00701             <span class="comment">// Decrement the count for the number of private pages.</span>
00702             <span class="comment">//</span>
00703 
00704             CurrentProcess-&gt;NumberOfPrivatePages -= 1;
00705         }
00706 
00707         <span class="comment">//</span>
00708         <span class="comment">// Find the WSLE for this page and eliminate it.</span>
00709         <span class="comment">//</span>
00710 
00711         <span class="comment">//</span>
00712         <span class="comment">// If we are deleting the system portion of the address space, do</span>
00713         <span class="comment">// not remove WSLEs or flush translation buffers as there can be</span>
00714         <span class="comment">// no other usage of this address space.</span>
00715         <span class="comment">//</span>
00716 
00717         <span class="keywordflow">if</span> (AddressSpaceDeletion == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00718 
00719             WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (VirtualAddress,
00720                                             MmWorkingSetList,
00721                                             WsPfnIndex );
00722 
00723             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex != WSLE_NULL_INDEX);
00724 
00725             <span class="comment">//</span>
00726             <span class="comment">// Check to see if this entry is locked in the working set</span>
00727             <span class="comment">// or locked in memory.</span>
00728             <span class="comment">//</span>
00729 
00730             Locked = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1;
00731 
00732             <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WorkingSetIndex, MmWorkingSetList);
00733 
00734             <span class="comment">//</span>
00735             <span class="comment">// Add this entry to the list of free working set entries</span>
00736             <span class="comment">// and adjust the working set count.</span>
00737             <span class="comment">//</span>
00738 
00739             <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (WorkingSetIndex, &amp;CurrentProcess-&gt;Vm);
00740 
00741             <span class="keywordflow">if</span> ((Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o1">LockedInWs</a> == 1) || (Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o2">LockedInMemory</a> == 1)) {
00742 
00743                 <span class="comment">//</span>
00744                 <span class="comment">// This entry is locked.</span>
00745                 <span class="comment">//</span>
00746 
00747                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &lt; MmWorkingSetList-&gt;FirstDynamic);
00748                 <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> -= 1;
00749 
00750                 <span class="keywordflow">if</span> (WorkingSetIndex != <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
00751 
00752                     Entry = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
00753                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmWsle[Entry].u1.e1.Valid);
00754                     SwapVa = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress;
00755                     SwapVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (SwapVa);
00756                     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (
00757                               MiGetPteAddress (SwapVa)-&gt;u.Hard.PageFrameNumber);
00758 <span class="preprocessor">#if 0</span>
00759 <span class="preprocessor"></span>                    Entry = MiLocateWsleAndParent (SwapVa,
00760                                                    &amp;Parent,
00761                                                    MmWorkingSetList,
00762                                                    Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
00763 
00764                     <span class="comment">//</span>
00765                     <span class="comment">// Swap the removed entry with the last locked entry</span>
00766                     <span class="comment">// which is located at first dynamic.</span>
00767                     <span class="comment">//</span>
00768 
00769                     <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry,
00770                                       Parent,
00771                                       WorkingSetIndex,
00772                                       MmWorkingSetList);
00773 <span class="preprocessor">#endif //0</span>
00774 <span class="preprocessor"></span>
00775                     <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry,
00776                                       WorkingSetIndex,
00777                                       &amp;CurrentProcess-&gt;Vm);
00778                 }
00779             } <span class="keywordflow">else</span> {
00780                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
00781             }
00782 
00783             <span class="comment">//</span>
00784             <span class="comment">// Flush the entry out of the TB.</span>
00785             <span class="comment">//</span>
00786 
00787             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT (PteFlushList)) {
00788                 <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (VirtualAddress,
00789                                  TRUE,
00790                                  FALSE,
00791                                  (PHARDWARE_PTE)PointerPte,
00792                                  <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
00793             } <span class="keywordflow">else</span> {
00794                 <span class="keywordflow">if</span> (PteFlushList-&gt;Count != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
00795                     PteFlushList-&gt;FlushPte[PteFlushList-&gt;Count] = PointerPte;
00796                     PteFlushList-&gt;FlushVa[PteFlushList-&gt;Count] = VirtualAddress;
00797                     PteFlushList-&gt;Count += 1;
00798                 }
00799                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroPte);
00800             }
00801 
00802             <span class="keywordflow">if</span> (CloneDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00803 
00804                 <span class="comment">//</span>
00805                 <span class="comment">// Flush PTEs as this could release the PFN_LOCK.</span>
00806                 <span class="comment">//</span>
00807 
00808                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT (PteFlushList)) {
00809                     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (PteFlushList, FALSE, ZeroPte);
00810                 }
00811 
00812                 <span class="comment">//</span>
00813                 <span class="comment">// Decrement the reference count for the clone block,</span>
00814                 <span class="comment">// note that this could release and reacquire</span>
00815                 <span class="comment">// the mutexes hence cannot be done until after the</span>
00816                 <span class="comment">// working set index has been removed.</span>
00817                 <span class="comment">//</span>
00818 
00819                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a854">MiDecrementCloneBlockReference</a> ( CloneDescriptor,
00820                                                      CloneBlock,
00821                                                      CurrentProcess )) {
00822 
00823                     <span class="comment">//</span>
00824                     <span class="comment">// The working set mutex was released.  This may</span>
00825                     <span class="comment">// have removed the current page directory &amp; table page.</span>
00826                     <span class="comment">//</span>
00827 
00828                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00829 
00830                     <span class="keywordflow">do</span> {
00831 
00832                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00833                                                     CurrentProcess,
00834                                                     TRUE,
00835                                                     &amp;Waited);
00836 
00837                         Waited = 0;
00838 
00839                         <span class="comment">//</span>
00840                         <span class="comment">// If the call below results in a PFN release and</span>
00841                         <span class="comment">// reacquire, then we must redo them both.</span>
00842                         <span class="comment">//</span>
00843 
00844                         <a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00845                                                     CurrentProcess,
00846                                                     TRUE,
00847                                                     &amp;Waited);
00848 
00849                     } <span class="keywordflow">while</span> (Waited != 0);
00850                 }
00851             }
00852         }
00853 
00854     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00855 
00856         <span class="comment">//</span>
00857         <span class="comment">// This is a prototype PTE, if it is a fork PTE clean up the</span>
00858         <span class="comment">// fork structures.</span>
00859         <span class="comment">//</span>
00860 
00861         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
00862 
00863             <span class="comment">//</span>
00864             <span class="comment">// Check to see if the prototype PTE is a fork prototype PTE.</span>
00865             <span class="comment">//</span>
00866 
00867             <span class="keywordflow">if</span> (PointerPte &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a>) {
00868 
00869                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte)) {
00870 
00871                     CloneBlock = (<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte);
00872                     CloneDescriptor = <a class="code" href="../../d4/d8/mi_8h.html#a104">MiLocateCloneAddress</a> ((PVOID)CloneBlock);
00873 
00874 
00875 <span class="preprocessor">#if DBG</span>
00876 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (CloneDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00877                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"1PrototypePte %p Clone desc %p \n"</span>,
00878                             PrototypePte, CloneDescriptor);
00879                         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
00880                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
00881                     }
00882 <span class="preprocessor">#endif //DBG</span>
00883 <span class="preprocessor"></span>
00884                     <span class="comment">//</span>
00885                     <span class="comment">// Decrement the reference count for the clone block,</span>
00886                     <span class="comment">// note that this could release and reacquire</span>
00887                     <span class="comment">// the mutexes.</span>
00888                     <span class="comment">//</span>
00889 
00890                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroPte);
00891 
00892                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT (PteFlushList)) {
00893                         <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (PteFlushList, FALSE, ZeroPte);
00894                     }
00895 
00896                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a854">MiDecrementCloneBlockReference</a> ( CloneDescriptor,
00897                                                          CloneBlock,
00898                                                          CurrentProcess )) {
00899 
00900                         <span class="comment">//</span>
00901                         <span class="comment">// The working set mutex was released.  This may</span>
00902                         <span class="comment">// have removed the current page directory &amp; table page.</span>
00903                         <span class="comment">//</span>
00904 
00905                         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00906                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00907 
00908                         <span class="comment">//</span>
00909                         <span class="comment">// If either call below results in a PFN release and</span>
00910                         <span class="comment">// reacquire, then we must redo them both.</span>
00911                         <span class="comment">//</span>
00912 
00913                         <span class="keywordflow">do</span> {
00914 
00915                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00916                                                         CurrentProcess,
00917                                                         TRUE,
00918                                                         &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00919 
00920                                 <span class="comment">//</span>
00921                                 <span class="comment">// The PPE has been deleted when the PFN lock</span>
00922                                 <span class="comment">// was released.  Just bail as the PDE/PTE are</span>
00923                                 <span class="comment">// gone now anyway.</span>
00924                                 <span class="comment">//</span>
00925 
00926                                 <span class="keywordflow">return</span>;
00927                             }
00928 
00929                             Waited = 0;
00930 
00931                             <span class="comment">//</span>
00932                             <span class="comment">// If the call below results in a PFN release and</span>
00933                             <span class="comment">// reacquire, then we must redo them both.  If the</span>
00934                             <span class="comment">// PDE was deleted when the PFN lock was released</span>
00935                             <span class="comment">// then we just bail as the PTE is gone anyway.</span>
00936                             <span class="comment">//</span>
00937 
00938                             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00939                                                         CurrentProcess,
00940                                                         TRUE,
00941                                                         &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00942                                 <span class="keywordflow">return</span>;
00943                             }
00944 
00945                         } <span class="keywordflow">while</span> (Waited != 0);
00946                     }
00947                 }
00948             }
00949         }
00950 
00951     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
00952 
00953         <span class="comment">//</span>
00954         <span class="comment">// This is a transition PTE. (Page is private)</span>
00955         <span class="comment">//</span>
00956 
00957         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
00958 
00959         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00960 
00961         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00962 
00963         <span class="comment">//</span>
00964         <span class="comment">// Check the reference count for the page, if the reference</span>
00965         <span class="comment">// count is zero, move the page to the free list, if the reference</span>
00966         <span class="comment">// count is not zero, ignore this page.  When the reference count</span>
00967         <span class="comment">// goes to zero, it will be placed on the free list.</span>
00968         <span class="comment">//</span>
00969 
00970         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00971             <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
00972             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00973             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
00974                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>(&amp;PteContents));
00975         }
00976 
00977         <span class="comment">//</span>
00978         <span class="comment">// Decrement the count for the number of private pages.</span>
00979         <span class="comment">//</span>
00980 
00981         CurrentProcess-&gt;NumberOfPrivatePages -= 1;
00982 
00983     } <span class="keywordflow">else</span> {
00984 
00985         <span class="comment">//</span>
00986         <span class="comment">// Must be page file space.</span>
00987         <span class="comment">//</span>
00988 
00989         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
00990 
00991             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (*PointerPte)) {
00992 
00993                 <span class="comment">//</span>
00994                 <span class="comment">// Decrement the count for the number of private pages.</span>
00995                 <span class="comment">//</span>
00996 
00997                 CurrentProcess-&gt;NumberOfPrivatePages -= 1;
00998             }
00999         }
01000     }
01001 
01002     <span class="comment">//</span>
01003     <span class="comment">// Zero the PTE contents.</span>
01004     <span class="comment">//</span>
01005 
01006     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroPte);
01007 
01008     <span class="keywordflow">return</span>;
01009 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="deleteva.c::MiDeleteVirtualAddresses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiDeleteVirtualAddresses           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>EndingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AddressSpaceDeletion</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vad</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00026">26</a> of file <a class="el" href="../../d9/d5/deleteva_8c-source.html">deleteva.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02655">_MMPTE_FLUSH_LIST::Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02050">IS_PTE_NOT_DEMAND_ZERO</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01362">MI_DECREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01357">MI_GET_USED_PTES_FROM_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01160">MiFlushPteList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03696">MiGetProtoPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01897">MiIsVirtualAddressOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01873">MiIsVirtualAddressOnPpeBoundary</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00783">MiLocateSubsection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/freevm_8c-source.html#l01586">MiDeleteFreeVm()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00265">MiRemoveMappedView()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>00035                    :
00036 
00037     This routine deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address range within
00038     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00039 
00040 Arguments:
00041 
00042     StartingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first <span class="keyword">virtual</span> address to <span class="keyword">delete</span>.
00043 
00044     EndingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last address to <span class="keyword">delete</span>.
00045 
00046     AddressSpaceDeletion - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00047                            deleted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.  If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified
00048                            <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not flushed and valid addresses are
00049                            not removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.
00050 
00051     Vad - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address descriptor which maps <span class="keyword">this</span> range
00052           or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> we are not concerned about views.  From <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vad <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00053           range of prototype PTEs <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined and <span class="keyword">this</span> information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00054           used to uncover <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE refers to a prototype PTE or a
00055           fork PTE.
00056 
00057 Return Value:
00058 
00059     None.
00060 
00061 
00062 Environment:
00063 
00064     Kernel mode, called with APCs disabled, working set mutex and PFN lock
00065     held.  These mutexes may be released and reacquired to fault pages in.
00066 
00067 --*/
00068 
00069 {
00070     PUCHAR Va;
00071     PUCHAR FirstValidVa;
00072     PVOID TempVa;
00073     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00074     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00075     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00076     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> OriginalPointerPte;
00077     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
00078     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte2;
00079     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastProtoPte;
00080     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastProtoPte2;
00081     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00082     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00083     PVOID UsedPageTableHandle;
00084     PVOID UsedPageDirectoryHandle;
00085     KIRQL OldIrql;
00086     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> FlushList;
00087     ULONG Waited;
00088     LOGICAL Skipped;
00089 
00090     OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00091     FlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
00092 
00093     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00094     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00095 
00096     Va = StartingAddress;
00097     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Va);
00098     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Va);
00099     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
00100     OriginalPointerPte = PointerPte;
00101 
00102     <span class="keywordflow">do</span> {
00103 
00104         <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00105                                            CurrentProcess,
00106                                            TRUE,
00107                                            &amp;Waited)           ==  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00108 
00109             <span class="comment">//</span>
00110             <span class="comment">// This page directory parent entry is empty, go to the next one.</span>
00111             <span class="comment">//</span>
00112 
00113             PointerPpe += 1;
00114             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00115             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00116             Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00117 
00118             <span class="keywordflow">if</span> (Va &gt; EndingAddress) {
00119 
00120                 <span class="comment">//</span>
00121                 <span class="comment">// All done, return.</span>
00122                 <span class="comment">//</span>
00123 
00124                 <span class="keywordflow">return</span>;
00125             }
00126         }
00127 
00128         Waited = 0;
00129 
00130         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00131                                            CurrentProcess,
00132                                            TRUE,
00133                                            &amp;Waited)           ==  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00134 
00135             <span class="comment">//</span>
00136             <span class="comment">// This page directory entry is empty, go to the next one.</span>
00137             <span class="comment">//</span>
00138 
00139             PointerPde += 1;
00140             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00141             Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00142 
00143             <span class="keywordflow">if</span> (Va &gt; EndingAddress) {
00144 
00145                 <span class="comment">//</span>
00146                 <span class="comment">// All done, return.</span>
00147                 <span class="comment">//</span>
00148 
00149                 <span class="keywordflow">return</span>;
00150             }
00151 <span class="preprocessor">#if defined (_WIN64)</span>
00152 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00153                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00154                 Waited = 1;
00155                 <span class="keywordflow">break</span>;
00156             }
00157 <span class="preprocessor">#endif</span>
00158 <span class="preprocessor"></span>        }
00159 
00160     } <span class="keywordflow">while</span> (Waited != 0);
00161 
00162     FirstValidVa = Va;
00163     UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (Va);
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">// A valid PDE has been located, examine each PTE and delete them.</span>
00167     <span class="comment">//</span>
00168 
00169     <span class="keywordflow">if</span> ((Vad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00170         (Vad-&gt;u.VadFlags.PrivateMemory) ||
00171         (Vad-&gt;FirstPrototypePte == (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00172         ProtoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00173         LastProtoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00174     } <span class="keywordflow">else</span> {
00175         ProtoPte = Vad-&gt;FirstPrototypePte;
00176         LastProtoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)4;
00177     }
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Examine each PTE within the address range and delete it.</span>
00181     <span class="comment">//</span>
00182 
00183     <span class="keywordflow">while</span> (Va &lt;= EndingAddress) {
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">// Note that the initial address could be aligned on a PPE or PDE</span>
00187         <span class="comment">// boundary so we must check for it here.</span>
00188         <span class="comment">//</span>
00189 
00190         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a165">MiIsVirtualAddressOnPdeBoundary</a>(Va)) {
00191 
00192             <span class="comment">//</span>
00193             <span class="comment">// The virtual address is on a page directory boundary,</span>
00194             <span class="comment">// check the next PDE for validity and flush PTEs for the</span>
00195             <span class="comment">// previous page table page.</span>
00196             <span class="comment">//</span>
00197 
00198             <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;FlushList, FALSE, ZeroPte);
00199 
00200             <span class="comment">//</span>
00201             <span class="comment">// If all the entries have been eliminated from the previous</span>
00202             <span class="comment">// page table page, delete the page table page itself.</span>
00203             <span class="comment">//</span>
00204 
00205             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageTableHandle) == 0) &amp;&amp;
00206                 (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00207 
00208                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde);
00209                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
00210                              TempVa,
00211                              AddressSpaceDeletion,
00212                              CurrentProcess,
00213                              NULL,
00214                              NULL);
00215 
00216 <span class="preprocessor">#if defined (_WIN64)</span>
00217 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Va == FirstValidVa) {
00218                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00219                 }
00220                 <span class="keywordflow">else</span> {
00221                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte - 1);
00222                 }
00223 
00224                 <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00225 <span class="preprocessor">#endif</span>
00226 <span class="preprocessor"></span>
00227             }
00228 
00229             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a164">MiIsVirtualAddressOnPpeBoundary</a>(Va)) {
00230 
00231                 <span class="keywordflow">if</span> (Va == FirstValidVa) {
00232                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00233                 }
00234                 <span class="keywordflow">else</span> {
00235                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte - 1);
00236                 }
00237 
00238                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0) &amp;&amp;
00239                     (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00240 
00241                         TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe);
00242                         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
00243                                      TempVa,
00244                                      AddressSpaceDeletion,
00245                                      CurrentProcess,
00246                                      NULL,
00247                                      NULL);
00248                 }
00249             }
00250 
00251             <span class="comment">//</span>
00252             <span class="comment">// Release the PFN lock.  This prevents a single thread</span>
00253             <span class="comment">// from forcing other high priority threads from being</span>
00254             <span class="comment">// blocked while a large address range is deleted.  There</span>
00255             <span class="comment">// is nothing magic about the instructions within the</span>
00256             <span class="comment">// lock and unlock.</span>
00257             <span class="comment">//</span>
00258 
00259             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00260             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Va);
00261             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Va);
00262             Skipped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00263             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00264 
00265             <span class="keywordflow">do</span> {
00266                 <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00267                                                    CurrentProcess,
00268                                                    TRUE,
00269                                                    &amp;Waited)       ==  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00270 
00271                     <span class="comment">//</span>
00272                     <span class="comment">// This page directory parent entry is empty,</span>
00273                     <span class="comment">// go to the next one.</span>
00274                     <span class="comment">//</span>
00275 
00276                     Skipped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00277                     PointerPpe += 1;
00278                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00279                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00280                     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00281 
00282                     <span class="keywordflow">if</span> (Va &gt; EndingAddress) {
00283 
00284                         <span class="comment">//</span>
00285                         <span class="comment">// All done, return.</span>
00286                         <span class="comment">//</span>
00287 
00288                         <span class="keywordflow">return</span>;
00289                     }
00290                 }
00291 
00292                 Waited = 0;
00293 
00294                 <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00295                                                    CurrentProcess,
00296                                                    TRUE,
00297                                                    &amp;Waited)       ==  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00298 
00299                     <span class="comment">//</span>
00300                     <span class="comment">// This page directory entry is empty, go to the next one.</span>
00301                     <span class="comment">//</span>
00302 
00303                     Skipped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00304                     PointerPde += 1;
00305                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00306                     Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00307 
00308                     <span class="keywordflow">if</span> (Va &gt; EndingAddress) {
00309 
00310                         <span class="comment">//</span>
00311                         <span class="comment">// All done, remove any straggling page directories and</span>
00312                         <span class="comment">// return.</span>
00313                         <span class="comment">//</span>
00314 
00315 <span class="preprocessor">#if defined (_WIN64)</span>
00316 <span class="preprocessor"></span>
00317                         PointerPde -= 1;
00318                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00319                         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00320 
00321                         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0) &amp;&amp;
00322                             (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00323 
00324                                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe);
00325                                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
00326                                              TempVa,
00327                                              AddressSpaceDeletion,
00328                                              CurrentProcess,
00329                                              NULL,
00330                                              NULL);
00331                         }
00332 <span class="preprocessor">#endif</span>
00333 <span class="preprocessor"></span>
00334                         <span class="keywordflow">return</span>;
00335                     }
00336 
00337 <span class="preprocessor">#if defined (_WIN64)</span>
00338 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00339                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00340                         Waited = 1;
00341                         <span class="keywordflow">break</span>;
00342                     }
00343 <span class="preprocessor">#endif</span>
00344 <span class="preprocessor"></span>
00345 <span class="preprocessor">#if DBG</span>
00346 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> ((LastProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  &amp;&amp;
00347                         (Vad-&gt;u2.VadFlags2.ExtendableFile == 0)) {
00348                         ProtoPte2 = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad, MI_VA_TO_VPN (Va));
00349                         Subsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad,MI_VA_TO_VPN (Va));
00350                         LastProtoPte2 = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00351                         <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.ImageMap != 1) {
00352                             <span class="keywordflow">if</span> ((ProtoPte2 &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) ||
00353                                 (ProtoPte2 &gt;= LastProtoPte2)) {
00354                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"bad proto pte %p va %p Vad %p sub %p\n"</span>,
00355                                     ProtoPte2,Va,Vad,Subsection);
00356                                 DbgBreakPoint();
00357                             }
00358                         }
00359                     }
00360 <span class="preprocessor">#endif //DBG</span>
00361 <span class="preprocessor"></span>                }
00362 
00363             } <span class="keywordflow">while</span> (Waited != 0);
00364 
00365             <span class="comment">//</span>
00366             <span class="comment">// The PPE and PDE are now valid, get the page table use count.</span>
00367             <span class="comment">//</span>
00368 
00369             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (Va);
00370 
00371             <span class="comment">//</span>
00372             <span class="comment">// If we skipped chunks of address space, the prototype PTE pointer</span>
00373             <span class="comment">// must be updated now so VADs that span multiple subsections</span>
00374             <span class="comment">// are handled properly.</span>
00375             <span class="comment">//</span>
00376 
00377             <span class="keywordflow">if</span> ((Skipped == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (LastProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00378 
00379                 ProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(Va));
00380                 Subsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(Va));
00381 
00382                 <span class="keywordflow">if</span> (Subsection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00383                     LastProtoPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00384 <span class="preprocessor">#if DBG</span>
00385 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.ImageMap != 1) {
00386                         <span class="keywordflow">if</span> ((ProtoPte &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) ||
00387                             (ProtoPte &gt;= LastProtoPte)) {
00388                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"bad proto pte %p va %p Vad %p sub %p\n"</span>,
00389                                         ProtoPte,Va,Vad,Subsection);
00390                             DbgBreakPoint();
00391                         }
00392                     }
00393 <span class="preprocessor">#endif //DBG</span>
00394 <span class="preprocessor"></span>                }
00395                 <span class="keywordflow">else</span> {
00396 
00397                     <span class="comment">//</span>
00398                     <span class="comment">// The Vad span is larger than the section being mapped.</span>
00399                     <span class="comment">// Null the proto PTE local as no more proto PTEs will</span>
00400                     <span class="comment">// need to be deleted at this point.</span>
00401                     <span class="comment">//</span>
00402 
00403                     LastProtoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00404                 }
00405             }
00406         }
00407 
00408         <span class="comment">//</span>
00409         <span class="comment">// The PPE and PDE are now valid, delete the PTEs.</span>
00410         <span class="comment">//</span>
00411 
00412         <span class="keywordflow">if</span> (PointerPte-&gt;u.Long != 0) {
00413 
00414             <span class="comment">//</span>
00415             <span class="comment">// One less used page table entry in this page table page.</span>
00416             <span class="comment">//</span>
00417 
00418             <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00419 
00420             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a> (*PointerPte)) {
00421 
00422                 <span class="keywordflow">if</span> (LastProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423                     <span class="keywordflow">if</span> (ProtoPte &gt;= LastProtoPte) {
00424                         ProtoPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(Va));
00425                         Subsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(Va));
00426                         LastProtoPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00427                     }
00428 <span class="preprocessor">#if DBG</span>
00429 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.ImageMap != 1) {
00430                         <span class="keywordflow">if</span> ((ProtoPte &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) ||
00431                             (ProtoPte &gt;= LastProtoPte)) {
00432                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"bad proto pte %p va %p Vad %p sub %p\n"</span>,
00433                                         ProtoPte,Va,Vad,Subsection);
00434                             DbgBreakPoint();
00435                         }
00436                     }
00437 <span class="preprocessor">#endif //DBG</span>
00438 <span class="preprocessor"></span>                }
00439 
00440                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
00441                              (PVOID)Va,
00442                              AddressSpaceDeletion,
00443                              CurrentProcess,
00444                              ProtoPte,
00445                              &amp;FlushList);
00446             } <span class="keywordflow">else</span> {
00447                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroPte);
00448             }
00449         }
00450 
00451         Va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00452         PointerPte += 1;
00453         ProtoPte += 1;
00454     }
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// Flush out entries for the last page table page.</span>
00458     <span class="comment">//</span>
00459 
00460     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;FlushList, FALSE, ZeroPte);
00461 
00462     <span class="comment">//</span>
00463     <span class="comment">// If all the entries have been eliminated from the previous</span>
00464     <span class="comment">// page table page, delete the page table page itself.</span>
00465     <span class="comment">//</span>
00466 
00467     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageTableHandle) == 0) &amp;&amp;
00468         (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00469 
00470         TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde);
00471         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
00472                      TempVa,
00473                      AddressSpaceDeletion,
00474                      CurrentProcess,
00475                      NULL,
00476                      NULL);
00477 
00478 <span class="preprocessor">#if defined (_WIN64)</span>
00479 <span class="preprocessor"></span>        UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte - 1);
00480 
00481         <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00482 
00483         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0) &amp;&amp;
00484             (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0)) {
00485 
00486             TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe);
00487             <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
00488                          TempVa,
00489                          AddressSpaceDeletion,
00490                          CurrentProcess,
00491                          NULL,
00492                          NULL);
00493         }
00494 <span class="preprocessor">#endif</span>
00495 <span class="preprocessor"></span>    }
00496 
00497     <span class="comment">//</span>
00498     <span class="comment">// All done, return.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">return</span>;
00502 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="deleteva.c::MiFlushPteList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiFlushPteList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">PMMPTE_FLUSH_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PteFlushList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllProcessors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FillPte</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01160">1160</a> of file <a class="el" href="../../d9/d5/deleteva_8c-source.html">deleteva.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00104">KeFlushMultipleTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00828">MiLockSystemSpaceAtDpcLevel</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00831">MiUnlockSystemSpaceFromDpcLevel</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00074">MM_FLUSH_COUNTER_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04696">MmFlushCounter</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00026">MiDeleteVirtualAddresses()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l01510">MiProcessValidPteList()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00579">MiRemoveMappedPtes()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04228">MiRemoveWorkingSetPages()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00843">MiReserveSystemPtes2()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>01168                    :
01169 
01170     This routine flushes all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTEs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE flush list.
01171     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list has overflowed, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire TB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flushed.
01172 
01173 Arguments:
01174 
01175     PteFlushList - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list to be flushed.
01176 
01177     AllProcessors - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush occurs on all processors.
01178 
01179     FillPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE to fill with.
01180 
01181 Return Value:
01182 
01183     None.
01184 
01185 Environment:
01186 
01187     Kernel mode, PFN lock held.
01188 
01189 --*/
01190 
01191 {
01192     ULONG count;
01193 
01194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ARGUMENT_PRESENT (PteFlushList));
01195     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a> ();
01196 
01197     count = PteFlushList-&gt;Count;
01198 
01199     <span class="keywordflow">if</span> (count != 0) {
01200         <span class="keywordflow">if</span> (count != 1) {
01201             <span class="keywordflow">if</span> (count &lt; <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01202                 <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a> (count,
01203                                    &amp;PteFlushList-&gt;FlushVa[0],
01204                                    TRUE,
01205                                    (BOOLEAN)AllProcessors,
01206                                    &amp;((PHARDWARE_PTE)PteFlushList-&gt;FlushPte[0]),
01207                                    FillPte.u.Flush);
01208             } <span class="keywordflow">else</span> {
01209 
01210                 <span class="comment">//</span>
01211                 <span class="comment">// Array has overflowed, flush the entire TB.</span>
01212                 <span class="comment">//</span>
01213 
01214                 <span class="keywordflow">if</span> (AllProcessors == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01215                     <a class="code" href="../../d4/d8/mi_8h.html#a119">MiLockSystemSpaceAtDpcLevel</a>();
01216                     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
01217                     <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a> + 1) &amp; <a class="code" href="../../d4/d8/mi_8h.html#a8">MM_FLUSH_COUNTER_MASK</a>;
01218                     <a class="code" href="../../d4/d8/mi_8h.html#a120">MiUnlockSystemSpaceFromDpcLevel</a>();
01219                 } <span class="keywordflow">else</span> {
01220                     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, FALSE);
01221                 }
01222             }
01223         } <span class="keywordflow">else</span> {
01224             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (PteFlushList-&gt;FlushVa[0],
01225                              TRUE,
01226                              (BOOLEAN)AllProcessors,
01227                              (PHARDWARE_PTE)PteFlushList-&gt;FlushPte[0],
01228                              FillPte.u.Flush);
01229         }
01230         PteFlushList-&gt;Count = 0;
01231     }
01232     <span class="keywordflow">return</span>;
01233 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="deleteva.c::MiReleasePageFileSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiReleasePageFileSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PteContents</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">1014</a> of file <a class="el" href="../../d9/d5/deleteva_8c-source.html">deleteva.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02554">_MMPAGING_FILE::CurrentUsage</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02553">_MMPAGING_FILE::FreeSpace</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02003">GET_PAGING_FILE_NUMBER</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02026">GET_PAGING_FILE_OFFSET</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01098">MiUpdateModifiedWriterMdls()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00092">MM_USABLE_PAGES_FREE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05092">MmNumberOfActiveMdlEntries</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04872">MmPagingFileDebug</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01762">MiCompleteProtoPteFault()</a>, <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01745">MiDecrementCloneBlockReference()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00541">MiPurgeImageSection()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l01953">MiResetVirtualMemory()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00191">MiSegmentDelete()</a>, <a class="el" href="../../d8/d6/alpha_2setdirty_8c-source.html#l00028">MiSetDirtyBit()</a>, <a class="el" href="../../d3/d7/setmodfy_8c-source.html#l00026">MiSetModifyBit()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03060">MiSetPageModified()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">MmPurgeSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05920">MmSetAddressRangeModified()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>.
<p>
<pre class="fragment"><div>01020                    :
01021 
01022     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> allocated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PTE
01023     and adjusts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> necessary quotas.
01024 
01025 Arguments:
01026 
01027     PteContents - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
01028 
01029 Return Value:
01030 
01031     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> any paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space was deallocated.
01032 
01033 Environment:
01034 
01035     Kernel mode, APCs disabled, PFN lock held.
01036 
01037 --*/
01038 
01039 {
01040     ULONG FreeBit;
01041     ULONG PageFileNumber;
01042 
01043     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01044 
01045     <span class="keywordflow">if</span> (PteContents.u.Soft.Prototype == 1) {
01046 
01047         <span class="comment">//</span>
01048         <span class="comment">// Not in page file format.</span>
01049         <span class="comment">//</span>
01050 
01051         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01052     }
01053 
01054     FreeBit = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a170">GET_PAGING_FILE_OFFSET</a> (PteContents);
01055 
01056     <span class="keywordflow">if</span> ((FreeBit == 0) || (FreeBit == 0xFFFFF)) {
01057 
01058         <span class="comment">//</span>
01059         <span class="comment">// Page is not in a paging file, just return.</span>
01060         <span class="comment">//</span>
01061 
01062         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01063     }
01064 
01065     PageFileNumber = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a169">GET_PAGING_FILE_NUMBER</a> (PteContents);
01066 
01067     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit( MmPagingFile[PageFileNumber]-&gt;Bitmap, FreeBit) == 1);
01068 
01069 <span class="preprocessor">#if DBG</span>
01070 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((FreeBit &lt; 8192) &amp;&amp; (PageFileNumber == 0)) {
01071         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MmPagingFileDebug[FreeBit] &amp; 1) != 0);
01072         <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[FreeBit] ^= 1;
01073     }
01074 <span class="preprocessor">#endif //DBG</span>
01075 <span class="preprocessor"></span>
01076     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> ( MmPagingFile[PageFileNumber]-&gt;Bitmap, FreeBit, 1);
01077 
01078     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> += 1;
01079     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a> -= 1;
01080 
01081     <span class="comment">//</span>
01082     <span class="comment">// Check to see if we should move some MDL entries for the</span>
01083     <span class="comment">// modified page writer now that more free space is available.</span>
01084     <span class="comment">//</span>
01085 
01086     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> == 0) ||
01087         (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> == <a class="code" href="../../d4/d8/mi_8h.html#a17">MM_USABLE_PAGES_FREE</a>)) {
01088 
01089         <a class="code" href="../../d4/d8/mi_8h.html#a890">MiUpdateModifiedWriterMdls</a> (PageFileNumber);
01090     }
01091 
01092     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01093 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="deleteva.c::MiUpdateModifiedWriterMdls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL MiUpdateModifiedWriterMdls           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PageFileNumber</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01098">1098</a> of file <a class="el" href="../../d9/d5/deleteva_8c-source.html">deleteva.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02537">_MMMOD_WRITER_MDL_ENTRY::CurrentList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02558">_MMPAGING_FILE::Entry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02524">_MMMOD_WRITER_LISTHEAD::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02528">_MMMOD_WRITER_MDL_ENTRY::Links</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02523">_MMMOD_WRITER_LISTHEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00102">MM_IO_IN_PROGRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02547">MM_PAGING_FILE_MDLS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05090">MmFreePagingSpaceLow</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05092">MmNumberOfActiveMdlEntries</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05079">MmPagingFileHeader</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02536">_MMMOD_WRITER_MDL_ENTRY::PagingListHead</a>, and <a class="el" href="../../d4/d8/mi_8h.html#a505">PMMMOD_WRITER_MDL_ENTRY</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01485">MiAttemptPageFileExtension()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01031">MiExtendPagingFileMaximum()</a>, and <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>.
<p>
<pre class="fragment"><div>01104                    :
01105 
01106     This routine ensures <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MDLs <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01107     are in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper state such that paging i/o can <span class="keywordflow">continue</span>.
01108 
01109 Arguments:
01110 
01111     PageFileNumber - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> number to check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MDLs <span class="keywordflow">for</span>.
01112 
01113 Return Value:
01114 
01115     None.
01116 
01117 Environment:
01118 
01119     Kernel mode, PFN lock held.
01120 
01121 --*/
01122 
01123 {
01124     ULONG i;
01125     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> WriterEntry;
01126 
01127     <span class="comment">//</span>
01128     <span class="comment">// Put the MDL entries into the active list.</span>
01129     <span class="comment">//</span>
01130 
01131     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/mi_8h.html#a236">MM_PAGING_FILE_MDLS</a>; i += 1) {
01132 
01133         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[i]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>.Flink !=
01134                                                     <a class="code" href="../../d4/d8/mi_8h.html#a23">MM_IO_IN_PROGRESS</a>)
01135                           &amp;&amp;
01136             (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[i]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> ==
01137                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>)) {
01138 
01139             <span class="comment">//</span>
01140             <span class="comment">// Remove this entry and put it on the active list.</span>
01141             <span class="comment">//</span>
01142 
01143             WriterEntry = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[i];
01144             RemoveEntryList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
01145             WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>;
01146 
01147             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, 0, FALSE);
01148 
01149             InsertTailList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
01150                             &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
01151             <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> += 1;
01152         }
01153     }
01154 
01155     <span class="keywordflow">return</span>;
01156 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
