<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: profinfo.cpp Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>profinfo.cpp</h1><a href="../../d7/d7/profinfo_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/******************************************************************************</span>
00002 <span class="comment"></span>
00003 <span class="comment">  Source File:  Profile Information Page.CPP</span>
00004 <span class="comment"></span>
00005 <span class="comment">  This implements the class used to display the profile information page in the</span>
00006 <span class="comment">  property page handler for the shell extension.</span>
00007 <span class="comment"></span>
00008 <span class="comment">  Copyright (c) 1996 by Microsoft Corporation</span>
00009 <span class="comment"></span>
00010 <span class="comment">  A Pretty Penny Enterprises Production</span>
00011 <span class="comment"></span>
00012 <span class="comment">  Change History:</span>
00013 <span class="comment">  11-01-96  a-robkj@microsoft.com pieced this one together for the first time</span>
00014 <span class="comment"></span>
00015 <span class="comment">******************************************************************************/</span>
00016 
00017 <span class="preprocessor">#include    "ICMUI.H"</span>
00018 
00019 <span class="preprocessor">#include    "Resource.H"</span>
00020 
<a name="l00021"></a><a class="code" href="../../d7/d7/profinfo_8cpp.html#a0">00021</a> <span class="keyword">static</span> <span class="keyword">const</span> TCHAR  <a class="code" href="../../d7/d7/profinfo_8cpp.html#a0">sacDefaultCMM</a>[] = _TEXT(<span class="stringliteral">"icm32.dll"</span>);
00022 
00023 <span class="comment">//  It looks like the way to make the icon draw is to subclass the Icon control</span>
00024 <span class="comment">//  in the window.  So, here's a Window Procedure for the subclass</span>
00025 
00026 <span class="comment">//  CProfileInformationPage member functions</span>
00027 
00028 <span class="comment">//  Class Constructor</span>
00029 
<a name="l00030"></a><a class="code" href="../../d0/d6/classCProfileInformationPage.html#a0">00030</a> <a class="code" href="../../d0/d6/classCProfileInformationPage.html#a0">CProfileInformationPage::CProfileInformationPage</a>(HINSTANCE hiWhere,
00031                                                  LPCTSTR lpstrTarget) {
00032     <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00033     <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r0">m_csProfile</a> = lpstrTarget;
00034     m_psp.dwSize = <span class="keyword">sizeof</span> m_psp;
00035     m_psp.dwFlags |= PSP_USETITLE;
00036     m_psp.hInstance = hiWhere;
00037     m_psp.pszTemplate = MAKEINTRESOURCE(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a50">ProfilePropertyPage</a>);
00038     m_psp.pszTitle = MAKEINTRESOURCE(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a6">ProfilePropertyString</a>);
00039 }
00040 
00041 <span class="comment">//  Class destructor</span>
00042 
<a name="l00043"></a><a class="code" href="../../d0/d6/classCProfileInformationPage.html#a1">00043</a> <a class="code" href="../../d0/d6/classCProfileInformationPage.html#a1">CProfileInformationPage::~CProfileInformationPage</a>() {
00044     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a>) {
00045         <span class="keyword">delete</span> <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a>;
00046     }
00047 }
00048 
00049 <span class="comment">//  Dialog box (property sheet) initialization</span>
00050 
<a name="l00051"></a><a class="code" href="../../d0/d6/classCProfileInformationPage.html#a2">00051</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d0/d6/classCProfileInformationPage.html#a2">CProfileInformationPage::OnInit</a>() {
00052 
00053     <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a> = <span class="keyword">new</span> <a class="code" href="../../d7/d5/classCProfile.html">CProfile</a>(<a class="code" href="../../d0/d6/classCProfileInformationPage.html#r0">m_csProfile</a>);
00054 
00055     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a>) {
00056 
00057         <span class="comment">//  Retrieve the 'desc' key, and put it in the description field</span>
00058         SetDlgItemTextA(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a52">ProfileDescription</a>,
00059             <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a>-&gt;<a class="code" href="../../d7/d5/classCProfile.html#a13">TagContents</a>('desc', 4));
00060 
00061         <span class="comment">//  Get the copyright info from the 'cprt' tag</span>
00062         SetDlgItemTextA(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a54">ProfileProducerInfo</a>,
00063             <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a>-&gt;<a class="code" href="../../d7/d5/classCProfile.html#a13">TagContents</a>('cprt'));
00064 
00065         <span class="comment">//  Get the profile info from the 'vued' tag, not 'K007' tag</span>
00066         LPCSTR lpAdditionalInfo = <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a>-&gt;<a class="code" href="../../d7/d5/classCProfile.html#a13">TagContents</a>('vued',4);
00067 
00068         <span class="keywordflow">if</span> (lpAdditionalInfo) {
00069             SetDlgItemTextA(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a53">AdditionalProfileInfo</a>, lpAdditionalInfo);
00070         } <span class="keywordflow">else</span> {
00071             <a class="code" href="../../d1/d7/classCString.html">CString</a> csNoAdditionalInfo;
00072             csNoAdditionalInfo.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(<a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a26">NoAdditionalInfo</a>);
00073             SetDlgItemTextA(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a53">AdditionalProfileInfo</a>, (LPCSTR)csNoAdditionalInfo);
00074         }
00075 
00076         <span class="comment">//  Set the CMM description and bitmap- these are supposed</span>
00077         <span class="comment">//  to come from the CMM.</span>
00078 
00079         <span class="comment">//  Get the CMM Name- this must be in char form</span>
00080 
00081         <span class="keyword">union </span>{
00082             <span class="keywordtype">char</span>    acCMM[5];
00083             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwCMM;
00084         };
00085 
00086         dwCMM = <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a>-&gt;<a class="code" href="../../d7/d5/classCProfile.html#a4">GetCMM</a>();
00087         acCMM[4] = <span class="charliteral">'\0'</span>;
00088 
00089         <span class="comment">//  Use it to form a key into the ICM registry.  If we find it, get</span>
00090         <span class="comment">//  the CMM name.  If we don't, then use the default CMM name (icm32)</span>
00091 
00092 <span class="preprocessor">#ifdef UNICODE</span>
00093 <span class="preprocessor"></span>        <a class="code" href="../../d1/d7/classCString.html">CString</a> csKey =
00094             <a class="code" href="../../d1/d7/classCString.html">CString</a>(_TEXT(<span class="stringliteral">"Software\\Microsoft\\Windows NT\\CurrentVersion\\ICM\\"</span>)) +
00095             (LPCTSTR) CString(acCMM);
00096 <span class="preprocessor">#else</span>
00097 <span class="preprocessor"></span>        CString csKey =
00098             CString(_TEXT(<span class="stringliteral">"Software\\Microsoft\\Windows\\CurrentVersion\\ICM\\"</span>)) +
00099             (LPCTSTR) CString(acCMM);
00100 <span class="preprocessor">#endif</span>
00101 <span class="preprocessor"></span>
00102         HKEY    hkCMM;
00103 
00104         <span class="keywordflow">if</span>  (ERROR_SUCCESS == RegOpenKey(HKEY_LOCAL_MACHINE, csKey, &amp;hkCMM)) {
00105             TCHAR   acValue[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00106 
00107             dwCMM = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
00108 
00109             <span class="keywordflow">if</span>  (ERROR_SUCCESS == RegEnumValue(hkCMM, 0, acValue, &amp;dwCMM, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00110                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00111                  csKey = acValue;
00112             <span class="keywordflow">else</span>
00113                 csKey = <a class="code" href="../../d7/d7/profinfo_8cpp.html#a0">sacDefaultCMM</a>;
00114 
00115             RegCloseKey(hkCMM);
00116         }
00117         <span class="keywordflow">else</span>
00118             csKey = <a class="code" href="../../d7/d7/profinfo_8cpp.html#a0">sacDefaultCMM</a>;
00119 
00120         <span class="comment">//  See if we can get an instance handle for the DLL...</span>
00121 
00122         HINSTANCE   hi = LoadLibrary(csKey);
00123 
00124         <span class="keywordflow">if</span>  (!hi)
00125             <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;     <span class="comment">//  Nothing to do, here, let the defaults prevail.</span>
00126 
00127         <span class="comment">//  Get description and icon identifier from CMS dll</span>
00128 
00129         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCMMIcon = 0, dwCMMDescription = 0;
00130 
00131 <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (*FPCMGETINFO)(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00132 
00133         FPCMGETINFO fpCMGetInfo;
00134 
00135         fpCMGetInfo = (FPCMGETINFO) GetProcAddress(hi,<span class="stringliteral">"CMGetInfo"</span>);
00136 
00137         <span class="keywordflow">if</span> (fpCMGetInfo) {
00138 
00139             dwCMMIcon = (*fpCMGetInfo)(CMM_LOGOICON);
00140             dwCMMDescription = (*fpCMGetInfo)(CMM_DESCRIPTION);
00141 
00142             <span class="keywordflow">if</span> (dwCMMDescription) {
00143                 <span class="comment">//  Write the description, if there is one.</span>
00144                 csKey.<a class="code" href="../../d1/d7/classCString.html#a16">Load</a>(dwCMMDescription, hi);
00145                 <span class="keywordflow">if</span>  ((LPCTSTR) csKey)
00146                     <a class="code" href="../../d5/d9/cltxt_8h.html#a20">SetDlgItemText</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a75">CMMDescription</a>, csKey);
00147             }
00148 
00149             <span class="keywordflow">if</span> (dwCMMIcon) {
00150                 <span class="comment">//  Change/Create the Icon, if there is one.</span>
00151                 HICON   hiCMM = LoadIcon(hi, MAKEINTRESOURCE(dwCMMIcon));
00152                 <span class="keywordflow">if</span>  (hiCMM)
00153                     <a class="code" href="../../d5/d9/cltxt_8h.html#a18">SendDlgItemMessage</a>(m_hwnd, <a class="code" href="../../d2/d9/ntgdi_2icm_2icmui_2resource_8h.html#a76">CMMIcon</a>, STM_SETICON, (WPARAM) hiCMM, 0);
00154             }
00155         }
00156 
00157         <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00158     } <span class="keywordflow">else</span> {
00159         <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00160     }
00161 }
00162 
<a name="l00163"></a><a class="code" href="../../d0/d6/classCProfileInformationPage.html#a3">00163</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d0/d6/classCProfileInformationPage.html#a3">CProfileInformationPage::OnDestroy</a>() {
00164 
00165     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a>) {
00166         <span class="keyword">delete</span> <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a>;
00167         <a class="code" href="../../d0/d6/classCProfileInformationPage.html#r1">m_pcpTarget</a> = (<a class="code" href="../../d7/d5/classCProfile.html">CProfile</a> *) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00168     }
00169 
00170     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// still need to handle this message by def. proc.</span>
00171 }
00172 
00173 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
