<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: winsta.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>winsta.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d9/d7/winsta_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a1">xxxInitTerminal</a> (<a class="el" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a2">CreateGlobalAtomTable</a> (PVOID *ppAtomTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HWINSTA&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a3">xxxCreateWindowStation</a> (POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> OwnershipMode, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDesiredAccess, HANDLE hKbdLayoutFile, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> offTable, PCWSTR pwszKLID, UINT uKbdInputLocale)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a4">FreeWindowStation</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a5">DestroyWindowStation</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, PVOID pobj, ACCESS_MASK amGranted, ULONG cProcessHandles, ULONG cSystemHandles)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a6">ParseWindowStation</a> (PVOID pContainerObject, <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> pObjectType, <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> pAccessState, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, ULONG Attributes, PUNICODE_STRING pstrCompleteName, PUNICODE_STRING pstrRemainingName, PVOID Context OPTIONAL, PSECURITY_QUALITY_OF_SERVICE pqos, PVOID *pObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a7">OkayToCloseWindowStation</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL, PVOID Object, HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HWINSTA&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a> (POBJECT_ATTRIBUTES pObjA, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDesiredAccess, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a9">_CloseWindowStation</a> (HWINSTA hwinsta)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a10">xxxSetProcessWindowStation</a> (HWINSTA hwinsta, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a> (HWINSTA *phwinsta)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a12">_BuildNameList</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, <a class="el" href="../../d8/d2/structtagNAMELIST.html">PNAMELIST</a> ccxpNameList, UINT cbNameList, <a class="el" href="../../d9/d5/ndismain_8h.html#a266">PUINT</a> pcbNeeded)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a13">ReferenceWindowStation</a> (<a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, HWINSTA hwinsta, ACCESS_MASK amDesiredAccess, <a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> *ppwinsta, BOOL fUseDesktop)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a14">_SetWindowStationUser</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, PLUID pluidUser, PSID ccxpsidUser, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbsidUser)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a15">_LockWorkStation</a> (VOID)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CONST LPCWSTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/winsta_8c.html#a0">lpszStdFormats</a> []</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a12" doxytag="winsta.c::_BuildNameList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS _BuildNameList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d2/structtagNAMELIST.html">PNAMELIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ccxpNameList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>cbNameList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d5/ndismain_8h.html#a266">PUINT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pcbNeeded</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l01264">1264</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00555">AccessCheckObject()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02139">tagNAMELIST::awchNames</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02137">tagNAMELIST::cb</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l02138">tagNAMELIST::cNames</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00823">DesktopMapping</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00648">grpWinStaList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02712">tagWINDOWSTATION::rpdeskList</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00805">WinStaMapping</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l08365">NtUserBuildNameList()</a>.
<p>
<pre class="fragment"><div>01269 {
01270     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>                    pobj;
01271     PWCHAR                   ccxpwchDest, ccxpwchMax;
01272     ACCESS_MASK              amDesired;
01273     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>           pHead;
01274     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> pNameInfo;
01275     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                    iNext;
01276     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01277     CONST GENERIC_MAPPING *pGenericMapping;
01278 
01279 <span class="comment">/*</span>
01280 <span class="comment"> * Note -- NameList is client-side, and so must be protected.</span>
01281 <span class="comment"> */</span>
01282 
01283     <span class="keywordflow">try</span> {
01284         ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o1">cNames</a> = 0;
01285     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
01286         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01287     }
01288 
01289     ccxpwchDest = ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o2">awchNames</a>;
01290     ccxpwchMax = (PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpNameList + cbNameList - <span class="keyword">sizeof</span>(WCHAR));
01291 
01292     <span class="comment">/*</span>
01293 <span class="comment">     * If we're enumerating windowstations, pwinsta is NULL.  Otherwise,</span>
01294 <span class="comment">     * we're enumerating desktops.</span>
01295 <span class="comment">     */</span>
01296     <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01297         pobj  = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
01298         amDesired = WINSTA_ENUMERATE;
01299         pGenericMapping = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>;
01300         iNext = FIELD_OFFSET(<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">WINDOWSTATION</a>, rpwinstaNext);
01301     } <span class="keywordflow">else</span> {
01302         pobj = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
01303         amDesired = DESKTOP_ENUMERATE;
01304         pGenericMapping = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a305">DesktopMapping</a>;
01305         iNext = FIELD_OFFSET(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>, rpdeskNext);
01306     }
01307 
01308     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01309     *pcbNeeded = 0;
01310     <span class="keywordflow">while</span> (pobj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01311 
01312         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1271">AccessCheckObject</a>(pobj, amDesired, KernelMode, pGenericMapping)) {
01313 
01314             <span class="comment">/*</span>
01315 <span class="comment">             * Find object name</span>
01316 <span class="comment">             */</span>
01317             pHead = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj);
01318             pNameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>(pHead);
01319 
01320             <span class="comment">/*</span>
01321 <span class="comment">             * If we run out of space, reset the buffer</span>
01322 <span class="comment">             * and continue so we can compute the needed</span>
01323 <span class="comment">             * space.</span>
01324 <span class="comment">             */</span>
01325             <span class="keywordflow">if</span> ((PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest + pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length +
01326                     <span class="keyword">sizeof</span>(WCHAR)) &gt;= ccxpwchMax) {
01327                 *pcbNeeded += (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpNameList);
01328                 ccxpwchDest = ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o2">awchNames</a>;
01329                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01330             }
01331 
01332             <span class="keywordflow">try</span> {
01333                 ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o1">cNames</a>++;
01334 
01335                 <span class="comment">/*</span>
01336 <span class="comment">                 * Copy and terminate the string</span>
01337 <span class="comment">                 */</span>
01338                 RtlCopyMemory(ccxpwchDest, pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer,
01339                     pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length);
01340                 (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest += pNameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length;
01341                 *ccxpwchDest++ = 0;
01342             } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
01343                 <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01344             }
01345         }
01346 
01347         pobj = *(<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>*)(pobj + iNext);
01348     }
01349 
01350     <span class="comment">/*</span>
01351 <span class="comment">     * Put an empty string on the end.</span>
01352 <span class="comment">     */</span>
01353     <span class="keywordflow">try</span> {
01354         *ccxpwchDest++ = 0;
01355 
01356         ccxpNameList-&gt;<a class="code" href="../../d8/d2/structtagNAMELIST.html#o0">cb</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpNameList);
01357     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
01358         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01359     }
01360 
01361     *pcbNeeded += (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpwchDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpNameList);
01362 
01363     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01364 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="winsta.c::_CloseWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _CloseWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWINSTA&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>hwinsta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l01055">1055</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d9/d7/winsta_8c-source.html#l01240">_GetProcessWindowStation()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01118">NtUserCloseWindowStation()</a>, and <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01365">NtUserResolveDesktop()</a>.
<p>
<pre class="fragment"><div>01057 {
01058     HWINSTA hwinstaCurrent;
01059 
01060     <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(&amp;hwinstaCurrent);
01061     <span class="keywordflow">if</span> (hwinsta != hwinstaCurrent) {
01062         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ZwClose(hwinsta));
01063     }
01064     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01065 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="winsta.c::_GetProcessWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> _GetProcessWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWINSTA *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>phwinsta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l01240">1240</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03489">tagPROCESSINFO::hwinsta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00084">PpiCurrent</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l03488">tagPROCESSINFO::rpwinsta</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/winsta_8c-source.html#l01055">_CloseWindowStation()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l08426">NtUserActivateKeyboardLayout()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12769">NtUserGetImeInfoEx()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09058">NtUserGetKeyboardLayoutList()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01150">NtUserGetProcessWindowStation()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l08449">NtUserLoadKeyboardLayoutEx()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01235">NtUserOpenInputDesktop()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12800">NtUserSetImeInfoEx()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l08494">NtUserUnloadKeyboardLayout()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00985">ResetSharedDesktops()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02053">xxxDW_SendDestroyMessages()</a>, and <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>.
<p>
<pre class="fragment"><div>01242 {
01243     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
01244 
01245     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01246     UserAssert(ppi);
01247 
01248     <span class="keywordflow">if</span> (phwinsta)
01249         *phwinsta = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>;
01250     <span class="keywordflow">return</span> ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>;
01251 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="winsta.c::_LockWorkStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _LockWorkStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l01517">1517</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00981">_PostMessage()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00071">gspwndLogonNotify</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01161">NtUserLockWorkStation()</a>.
<p>
<pre class="fragment"><div>01519 {
01520     UserAssert(gspwndLogonNotify != NULL);
01521 
01522     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(gspwndLogonNotify,
01523                  WM_LOGONNOTIFY, LOGON_LOCKWORKSTATION, 0);
01524 
01525     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01526 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="winsta.c::_OpenWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HWINSTA _OpenWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>pObjA</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwDesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l01019">1019</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00295">_UserTestForWinStaAccess()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01028">NtUserOpenWindowStation()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04821">xxxResolveDesktop()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l04588">xxxResolveDesktopForWOW()</a>.
<p>
<pre class="fragment"><div>01023 {
01024     HWINSTA hwinsta;
01025     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01026 
01027     <span class="comment">/*</span>
01028 <span class="comment">     * Obja is client-side.  Ob interfaces protect and capture is</span>
01029 <span class="comment">     * appropriate.</span>
01030 <span class="comment">     */</span>
01031     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(
01032             pObjA,
01033             *ExWindowStationObjectType,
01034             AccessMode,
01035             NULL,
01036             dwDesiredAccess,
01037             NULL,
01038             &amp;hwinsta);
01039     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01040         RIPNTERR0(Status, RIP_VERBOSE, <span class="stringliteral">""</span>);
01041         hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01042     }
01043     <span class="keywordflow">return</span> hwinsta;
01044 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="winsta.c::_SetWindowStationUser" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT _SetWindowStationUser           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>pluidUser</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ccxpsidUser</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cbsidUser</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l01459">1459</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00092">GetCurrentProcessId</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00793">gpidLogon</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02742">tagWINDOWSTATION::luidUser</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02743">tagWINDOWSTATION::psidUser</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07110">NtUserSetWindowStationUser()</a>.
<p>
<pre class="fragment"><div>01464 {
01465 
01466     <span class="comment">/*</span>
01467 <span class="comment">     * Make sure the caller is the logon process</span>
01468 <span class="comment">     */</span>
01469     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
01470         RIPERR0(ERROR_ACCESS_DENIED,
01471                 RIP_WARNING,
01472                 <span class="stringliteral">"Access denied in _SetWindowStationUser: caller must be in the logon process"</span>);
01473 
01474         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01475     }
01476 
01477     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01478         UserFreePool(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>);
01479 
01480     <span class="keywordflow">if</span> (ccxpsidUser != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01481         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> = UserAllocPoolWithQuota(cbsidUser, TAG_SECURITY);
01482         <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01483             RIPERR0(ERROR_OUTOFMEMORY,
01484                     RIP_WARNING,
01485                     <span class="stringliteral">"Memory allocation failed in _SetWindowStationUser"</span>);
01486 
01487             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01488         }
01489         <span class="keywordflow">try</span> {
01490             RtlCopyMemory(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>, ccxpsidUser, cbsidUser);
01491         } except (W32ExceptionHandler(TRUE, RIP_WARNING)) {
01492 
01493             UserFreePool(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>);
01494             pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01495             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01496         }
01497     } <span class="keywordflow">else</span> {
01498         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01499     }
01500 
01501     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a> = *pluidUser;
01502 
01503     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01504 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="winsta.c::CreateGlobalAtomTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CreateGlobalAtomTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ppAtomTable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l00212">212</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00075">ARRAY_SIZE</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00187">lpszStdFormats</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00516">RtlAddAtomToAtomTable()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00262">RtlCreateAtomTable()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00304">RtlDestroyAtomTable()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00722">RtlPinAtomInAtomTable()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/job_8c-source.html#l00156">CreateW32Job()</a>, and <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>.
<p>
<pre class="fragment"><div>00214 {
00215     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00216     RTL_ATOM Atom;
00217     ULONG    i;
00218 
00219     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a13">RtlCreateAtomTable</a>(0, ppAtomTable);
00220 
00221     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00222         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Global atom table not created"</span>);
00223         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00224     }
00225 
00226     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(lpszStdFormats); i++) {
00227         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a18">RtlAddAtomToAtomTable</a>(*ppAtomTable,
00228                                        (PWSTR)lpszStdFormats[i],
00229                                        &amp;Atom);
00230         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00231             RIPMSG1(RIP_WARNING, <span class="stringliteral">"RtlAddAtomToAtomTable failed to add atom %ws"</span>,
00232                     lpszStdFormats[i]);
00233 
00234             <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a14">RtlDestroyAtomTable</a>(*ppAtomTable);
00235             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00236         }
00237 
00238         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a21">RtlPinAtomInAtomTable</a>(*ppAtomTable, Atom);
00239     }
00240     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00241 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="winsta.c::DestroyWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DestroyWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>pobj</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>amGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>cProcessHandles</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>cSystemHandles</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l00830">830</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02665">tagDESKTOP::dwConsoleThreadId</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00653">grpdeskLogon</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00648">grpWinStaList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01640">LockDesktop</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02712">tagWINDOWSTATION::rpdeskList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02647">tagDESKTOP::rpdeskNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02711">tagWINDOWSTATION::rpwinstaNext</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04420">TerminateConsole()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01649">UnlockDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01628">UnlockWinSta</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>00836 {
00837     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = pobj;
00838     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> *ppwinsta;
00839     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
00840     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdeskLock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00841 
00842     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj)-&gt;Type == *ExWindowStationObjectType);
00843 
00844     <span class="comment">/*</span>
00845 <span class="comment">     * If this is not the last handle, leave</span>
00846 <span class="comment">     */</span>
00847     <span class="keywordflow">if</span> (cSystemHandles != 1)
00848         <span class="keywordflow">return</span>;
00849 
00850     BEGIN_REENTERCRIT();
00851 
00852     <span class="comment">/*</span>
00853 <span class="comment">     * If the window station was linked into the terminal's list,</span>
00854 <span class="comment">     * go ahead and unlink it.</span>
00855 <span class="comment">     */</span>
00856     <span class="keywordflow">for</span> (ppwinsta = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
00857             *ppwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwinsta != *ppwinsta;
00858             ppwinsta = &amp;(*ppwinsta)-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>)
00859         ;
00860     <span class="keywordflow">if</span> (*ppwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00861         <a class="code" href="../../d4/d1/userk_8h.html#a124">UnlockWinSta</a>(ppwinsta);
00862         <span class="comment">/*</span>
00863 <span class="comment">         * Assert that unlocking it didn't destroy it.</span>
00864 <span class="comment">         */</span>
00865         UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pobj)-&gt;Type == *ExWindowStationObjectType);
00866 
00867         *ppwinsta = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>;
00868         <span class="comment">/*</span>
00869 <span class="comment">         * The instruction above transfered rpwinstaNext lock ownership to the previous</span>
00870 <span class="comment">         *  element in the list. Hence the value in pwinsta can no longer be considered valid.</span>
00871 <span class="comment">         */</span>
00872         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00873     }
00874 
00875     <span class="comment">/*</span>
00876 <span class="comment">     * Notify all console threads and wait for them to</span>
00877 <span class="comment">     * terminate.</span>
00878 <span class="comment">     */</span>
00879     pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
00880     <span class="keywordflow">while</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00881         <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a242">grpdeskLogon</a> &amp;&amp; pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a>) {
00882             <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;pdeskLock, pdesk, LDL_FN_DESTROYWINDOWSTATION, 0);
00883             <a class="code" href="../../d4/d1/userk_8h.html#a1284">TerminateConsole</a>(pdesk);
00884 
00885             <span class="comment">/*</span>
00886 <span class="comment">             * Restart scan in case desktop list has changed</span>
00887 <span class="comment">             */</span>
00888             pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
00889             <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;pdeskLock, LDU_FN_DESTROYWINDOWSTATION, 0);
00890         } <span class="keywordflow">else</span>
00891             pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>;
00892     }
00893 
00894     END_REENTERCRIT();
00895 
00896     UNREFERENCED_PARAMETER(Process);
00897     UNREFERENCED_PARAMETER(cProcessHandles);
00898     UNREFERENCED_PARAMETER(amGranted);
00899 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="winsta.c::FreeWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FreeWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwinsta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l00745">745</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02507">tagKL::dwKL_Flags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02718">tagWINDOWSTATION::dwWSF_Flags</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00034">EVENT_INCREMENT</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02779">ForceEmptyClipboard()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00083">gpEventSwitchDesktop</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00071">gspwndLogonNotify</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07399">HH_KBDLYOUTFREEWINSTA</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01237">HMMarkObjectDestroy()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07404">HYDRA_HINT</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02520">KL_UNLOADED</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02739">tagWINDOWSTATION::pGlobalAtomTable</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02505">tagKL::pklNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02743">tagWINDOWSTATION::psidUser</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02712">tagWINDOWSTATION::rpdeskList</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00304">RtlDestroyAtomTable()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02719">tagWINDOWSTATION::spklList</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02706">WSF_DYING</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l02704">WSF_NOIO</a>.
<p>
<pre class="fragment"><div>00747 {
00748     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pwinsta)-&gt;Type == *ExWindowStationObjectType);
00749 
00750     <span class="comment">/*</span>
00751 <span class="comment">     * Mark the windowstation as dying.  Make sure we're not recursing.</span>
00752 <span class="comment">     */</span>
00753     UserAssert(!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; WSF_DYING));
00754     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a318">WSF_DYING</a>;
00755 
00756     UserAssert(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a> == NULL);
00757 
00758     <span class="comment">/*</span>
00759 <span class="comment">     * Free up the other resources</span>
00760 <span class="comment">     */</span>
00761 
00762     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a21">gpEventSwitchDesktop</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00763         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(gpEventSwitchDesktop, EVENT_INCREMENT, FALSE);
00764         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(gpEventSwitchDesktop);
00765         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a21">gpEventSwitchDesktop</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00766     }
00767 
00768     BEGIN_REENTERCRIT();
00769 
00770     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a14">RtlDestroyAtomTable</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o16">pGlobalAtomTable</a>);
00771 
00772     <a class="code" href="../../d4/d1/userk_8h.html#a1192">ForceEmptyClipboard</a>(pwinsta);
00773 
00774     <span class="comment">/*</span>
00775 <span class="comment">     * Free up keyboard layouts</span>
00776 <span class="comment">     */</span>
00777     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) &amp;&amp; pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00778 
00779         <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>;
00780         <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklFirst = pkl;
00781 
00782         RIPMSG2(RIP_WARNING, <span class="stringliteral">"FreeWindowStation: pwinsta(%p)-&gt;spklList is not NULL, %p"</span>, pwinsta, pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>);
00783 
00784         <span class="keywordflow">do</span> {
00785             <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklNext = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00786 
00787             <a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pkl);
00788             pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o3">dwKL_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a276">KL_UNLOADED</a>;
00789 
00790             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>, pklNext);
00791 
00792             pkl = pklNext;
00793 
00794         } <span class="keywordflow">while</span> (pkl != pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> &amp;&amp; pkl != pklFirst);
00795 
00796         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>);
00797 
00798         <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(HH_KBDLYOUTFREEWINSTA);
00799 
00800         <span class="comment">/*</span>
00801 <span class="comment">         * make sure the logon notify window went away</span>
00802 <span class="comment">         */</span>
00803         UserAssert(gspwndLogonNotify == NULL);
00804     } <span class="keywordflow">else</span> {
00805         UserAssert(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a> == NULL);
00806     }
00807 
00808     <span class="comment">/*</span>
00809 <span class="comment">     * Free the USER sid</span>
00810 <span class="comment">     */</span>
00811     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00812         UserFreePool(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>);
00813         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00814     }
00815 
00816     END_REENTERCRIT();
00817 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="winsta.c::OkayToCloseWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN OkayToCloseWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l00981">981</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d0/d6/desktop_8c-source.html#l04464">CheckHandleFlag()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04557">CheckHandleInUse()</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07290">HF_PROTECTED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00985 {
00986     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = (<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>)Object;
00987 
00988     UNREFERENCED_PARAMETER(Process);
00989 
00990     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Object)-&gt;Type == *ExWindowStationObjectType);
00991 
00992     <span class="comment">/*</span>
00993 <span class="comment">     * Kernel mode code can close anything.</span>
00994 <span class="comment">     */</span>
00995     <span class="keywordflow">if</span> (KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00996         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00997     }
00998 
00999     <span class="comment">/*</span>
01000 <span class="comment">     * We can't close a windowstation that's being used.</span>
01001 <span class="comment">     */</span>
01002     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2072">CheckHandleInUse</a>(Handle) || <a class="code" href="../../d4/d1/userk_8h.html#a2070">CheckHandleFlag</a>(Handle, HF_PROTECTED)) {
01003         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Trying to close windowstation %#p while still in use"</span>, pwinsta);
01004         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01005     }
01006 
01007     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01008 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="winsta.c::ParseWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ParseWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>pContainerObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pAccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>pstrCompleteName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>pstrRemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSECURITY_QUALITY_OF_SERVICE&nbsp;</td>
          <td class="mdname" nowrap> <em>pqos</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>pObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l00911">911</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d4/d6/win32_8c-source.html#l00033">ExDesktopObjectType</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, and <a class="el" href="../../d4/d1/userk_8h.html#a1292">ParseDesktop()</a>.
<p>
<pre class="fragment"><div>00922 {
00923     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = pContainerObject;
00924 
00925     UserAssert(<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pContainerObject)-&gt;Type == *ExWindowStationObjectType);
00926 
00927     <span class="comment">/*</span>
00928 <span class="comment">     * If nothing remains to be parsed, return the windowstation.</span>
00929 <span class="comment">     */</span>
00930     *pObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00931     <span class="keywordflow">if</span> (pstrRemainingName-&gt;Length == 0) {
00932         <span class="keywordflow">if</span> (pObjectType != *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>)
00933             <span class="keywordflow">return</span> STATUS_OBJECT_TYPE_MISMATCH;
00934 
00935         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(pwinsta);
00936         *pObject = pwinsta;
00937         <span class="keywordflow">return</span> STATUS_SUCCESS;
00938     }
00939 
00940     <span class="comment">/*</span>
00941 <span class="comment">     * Skip leading path separator, if present.</span>
00942 <span class="comment">     */</span>
00943     <span class="keywordflow">if</span> (*(pstrRemainingName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00944         pstrRemainingName-&gt;Buffer++;
00945         pstrRemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00946         pstrRemainingName-&gt;MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00947     }
00948 
00949     <span class="comment">/*</span>
00950 <span class="comment">     * Validate the desktop name.</span>
00951 <span class="comment">     */</span>
00952     <span class="keywordflow">if</span> (wcschr(pstrRemainingName-&gt;Buffer, L<span class="charliteral">'\\'</span>))
00953         <span class="keywordflow">return</span> STATUS_OBJECT_PATH_INVALID;
00954     <span class="keywordflow">if</span> (pObjectType == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00955         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1292">ParseDesktop</a>(
00956                 pContainerObject,
00957                 pObjectType,
00958                 pAccessState,
00959                 AccessMode,
00960                 Attributes,
00961                 pstrCompleteName,
00962                 pstrRemainingName,
00963                 Context,
00964                 pqos,
00965                 pObject);
00966     }
00967 
00968     <span class="keywordflow">return</span> STATUS_OBJECT_TYPE_MISMATCH;
00969 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="winsta.c::ReferenceWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ReferenceWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HWINSTA&nbsp;</td>
          <td class="mdname" nowrap> <em>hwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>amDesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ppwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fUseDesktop</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l01366">1366</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00555">AccessCheckObject()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03490">tagPROCESSINFO::amwinsta</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00089">PpiFromProcess</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00087">PtiFromThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02364">RETURN_IF_ACCESS_DENIED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03488">tagPROCESSINFO::rpwinsta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02648">tagDESKTOP::rpwinstaParent</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00441">_ETHREAD::ThreadsProcess</a>, and <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00805">WinStaMapping</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l03035">UserGlobalAtomTableCallout()</a>, and <a class="el" href="../../d6/d8/snapshot_8c-source.html#l00023">xxxSnapWindow()</a>.
<p>
<pre class="fragment"><div>01372 {
01373     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
01374     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01375     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01376     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01377 
01378     <span class="comment">/*</span>
01379 <span class="comment">     * We prefer to use the thread's desktop to dictate which</span>
01380 <span class="comment">     * windowstation/Atom table to use rather than the process.</span>
01381 <span class="comment">     * This allows NetDDE, which has threads running under</span>
01382 <span class="comment">     * different desktops on different windowstations but whos</span>
01383 <span class="comment">     * process is set to only one of these windowstations, to</span>
01384 <span class="comment">     * get global atoms properly without having to change its</span>
01385 <span class="comment">     * process windowstation a billion times and synchronize.</span>
01386 <span class="comment">     */</span>
01387     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o28">ThreadsProcess</a>);
01388     pti = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread);
01389 
01390     <span class="comment">/*</span>
01391 <span class="comment">     * First, try to get the windowstation from the pti, and then</span>
01392 <span class="comment">     * from the ppi.</span>
01393 <span class="comment">     */</span>
01394     <span class="keywordflow">if</span> (ppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01395         <span class="keywordflow">if</span> (!fUseDesktop || pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01396                 ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a> == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>) {
01397 
01398             <span class="comment">/*</span>
01399 <span class="comment">             * Use the windowstation assigned to the process.</span>
01400 <span class="comment">             */</span>
01401             pwinsta = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>;
01402             <span class="keywordflow">if</span> (pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01403                 <a class="code" href="../../d4/d1/userk_8h.html#a263">RETURN_IF_ACCESS_DENIED</a>(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o16">amwinsta</a>, amDesiredAccess,
01404                         STATUS_ACCESS_DENIED);
01405             }
01406         }
01407 
01408         <span class="comment">/*</span>
01409 <span class="comment">         * If we aren't using the process' windowstation, try to</span>
01410 <span class="comment">         * go through the thread's desktop.</span>
01411 <span class="comment">         */</span>
01412         <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01413 
01414             <span class="comment">/*</span>
01415 <span class="comment">             * Perform access check the parent windowstation.  This</span>
01416 <span class="comment">             * is an expensive operation.</span>
01417 <span class="comment">             */</span>
01418             pwinsta = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>;
01419             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1271">AccessCheckObject</a>(pwinsta, amDesiredAccess, KernelMode, &amp;WinStaMapping))
01420                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01421         }
01422     }
01423 
01424     <span class="comment">/*</span>
01425 <span class="comment">     * If we still don't have a windowstation and a handle was</span>
01426 <span class="comment">     * passed in, use it.</span>
01427 <span class="comment">     */</span>
01428     <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01429         <span class="keywordflow">if</span> (hwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01430             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01431                     hwinsta,
01432                     amDesiredAccess,
01433                     *ExWindowStationObjectType,
01434                     KernelMode,
01435                     &amp;pwinsta,
01436                     NULL);
01437             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01438                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01439             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
01440         } <span class="keywordflow">else</span> {
01441             <span class="keywordflow">return</span> STATUS_NOT_FOUND;
01442         }
01443     }
01444 
01445     *ppwinsta = pwinsta;
01446 
01447     <span class="keywordflow">return</span> STATUS_SUCCESS;
01448 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="winsta.c::xxxCreateWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HWINSTA xxxCreateWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnershipMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwDesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hKbdLayoutFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>offTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PCWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>pwszKLID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>uKbdInputLocale</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">243</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l01838">BEGINATOMICCHECK</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01515">_HANDLEENTRY::bFlags</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00212">CreateGlobalAtomTable()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06469">DeferWinEventNotify</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00289">DESKTOPCLASS</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02746">tagWINDOWSTATION::dwSessionId</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02015">tagTERMINAL::dwTERMF_Flags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02718">tagWINDOWSTATION::dwWSF_Flags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01842">ENDATOMICCHECK</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01846">EXITATOMICCHECK</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00932">gbRemoteSession</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00082">ghEventSwitchDesktop</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00794">gpepCSRSS</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00083">gpEventSwitchDesktop</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00793">gpidLogon</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00648">grpWinStaList</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00931">gSessionId</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00645">gTermIO</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00646">gTermNOIO</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01500">HANDLEF_POOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03345">tagTHREADINFO::hdesk</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02112">HMChangeOwnerThread()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00734">hModuleWin</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01510">HMPheFromObject</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06472">IsWinEventNotifyDeferredOK</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01631">LockWinSta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01539">LogDesktop</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00056">MAX_SESSION_PATH</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02739">tagWINDOWSTATION::pGlobalAtomTable</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02714">tagWINDOWSTATION::pTerm</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02023">tagTERMINAL::ptiDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02711">tagWINDOWSTATION::rpwinstaNext</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00089">SeAssignSecurity()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00373">SeDeassignSecurity()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01590">SeExports</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l05237">SetVisible()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00360">_SE_EXPORTS::SeWorldSid</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02020">tagTERMINAL::spwndDesktopOwner</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02586">SV_SET</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02006">TERMF_INITIALIZED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02007">TERMF_NOIO</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02855">TIF_DISABLEHOOKS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00476">VER31</a>, <a class="el" href="../../d4/d1/userk_8h.html#a838">WINDOWSTATION</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00805">WinStaMapping</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02704">WSF_NOIO</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l00033">xxxCreateWindowEx()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00026">xxxInitTerminal()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01319">xxxInitWindowStation()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00654">xxxLoadKeyboardLayoutEx()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06473">zzzEndDeferWinEventNotify</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l03823">zzzSetDesktop()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00891">NtUserCreateWindowStation()</a>, and <a class="el" href="../../d3/d6/service_8c-source.html#l00025">xxxConnectService()</a>.
<p>
<pre class="fragment"><div>00251 {
00252     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>          pwinsta;
00253     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>             ptiCurrent;
00254     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>                pdeskTemp;
00255     HDESK                   hdeskTemp;
00256     PSECURITY_DESCRIPTOR    psd;
00257     PSECURITY_DESCRIPTOR    psdCapture;
00258     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>            ppiSave;
00259     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00260     PACCESS_ALLOWED_ACE     paceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pace;
00261     ULONG                   ulLength, ulLengthSid;
00262     HANDLE                  hEvent;
00263     HWINSTA                 hwinsta;
00264     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                   dwDisableHooks;
00265     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a>               pTerm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00266     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>                    pwnd;
00267     WCHAR                   szBaseNamedObjectDirectory[<a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a>];
00268 
00269     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00270 
00271     <span class="comment">/*</span>
00272 <span class="comment">     * Get the pointer to the security descriptor so we can</span>
00273 <span class="comment">     * assign it to the new object later.</span>
00274 <span class="comment">     */</span>
00275     psdCapture = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;SecurityDescriptor;
00276 
00277     <span class="comment">/*</span>
00278 <span class="comment">     * The first windowstation that gets created is Winsta0 and</span>
00279 <span class="comment">     * it's the only interactive one.</span>
00280 <span class="comment">     */</span>
00281     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00282 
00283         <span class="comment">/*</span>
00284 <span class="comment">         * Assert that winlogon is the first to call CreateWindowStation</span>
00285 <span class="comment">         */</span>
00286         UserAssert(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId == gpidLogon);
00287 
00288         pTerm = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>;
00289     } <span class="keywordflow">else</span> {
00290         pTerm = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a240">gTermNOIO</a>;
00291 
00292         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a> == NULL ||
00293                    pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; TERMF_NOIO);
00294 
00295         pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>;
00296     }
00297 
00298     <span class="comment">/*</span>
00299 <span class="comment">     * Create the WindowStation object</span>
00300 <span class="comment">     */</span>
00301     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(KernelMode, *ExWindowStationObjectType,
00302             ObjectAttributes, OwnershipMode, NULL, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">WINDOWSTATION</a>),
00303             0, 0, &amp;pwinsta);
00304 
00305     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00306         RIPNTERR0(Status, RIP_WARNING, <span class="stringliteral">"Failed to create windowstation"</span>);
00307         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00308     }
00309 
00310     <span class="comment">/*</span>
00311 <span class="comment">     * Initialize everything</span>
00312 <span class="comment">     */</span>
00313     RtlZeroMemory(pwinsta, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">WINDOWSTATION</a>));
00314 
00315     <span class="comment">/*</span>
00316 <span class="comment">     * Store the session id of the session who created the windowstation</span>
00317 <span class="comment">     */</span>
00318     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o21">dwSessionId</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>;
00319 
00320     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a> = pTerm;
00321 
00322     <span class="comment">/*</span>
00323 <span class="comment">     * All the windowstations in the system terminal are non-interactive.</span>
00324 <span class="comment">     */</span>
00325     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>) {
00326         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> = <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>;
00327     }
00328 
00329     <span class="comment">/*</span>
00330 <span class="comment">     * Create the global atom table and populate it with the default OLE atoms</span>
00331 <span class="comment">     * Pin each atom so they can't be deleted by bogus applications like Winword</span>
00332 <span class="comment">     */</span>
00333     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/winsta_8c.html#a2">CreateGlobalAtomTable</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o16">pGlobalAtomTable</a>);
00334 
00335     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o16">pGlobalAtomTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00336         UserAssert(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00337         RIPNTERR0(Status, RIP_WARNING, <span class="stringliteral">"CreateGlobalAtomTable failed"</span>);
00338         <span class="keywordflow">goto</span> create_error;
00339     }
00340 
00341     <span class="comment">/*</span>
00342 <span class="comment">     * create the desktop thread</span>
00343 <span class="comment">     * and the RIT (only for the IO terminal)</span>
00344 <span class="comment">     */</span>
00345     <span class="keywordflow">if</span> (!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a200">TERMF_INITIALIZED</a>)) {
00346 
00347         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/winsta_8c.html#a1">xxxInitTerminal</a>(pTerm);
00348 
00349         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00350             RIPNTERR0(Status, RIP_WARNING, <span class="stringliteral">"xxxInitTerminal failed"</span>);
00351             <span class="keywordflow">goto</span> create_error;
00352         }
00353     }
00354 
00355     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
00356         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1178">xxxInitWindowStation</a>(pwinsta)) {
00357             RIPNTERR0(STATUS_NO_MEMORY, RIP_WARNING, <span class="stringliteral">"xxxInitWindowStation failed"</span>);
00358             <span class="keywordflow">goto</span> create_error;
00359         }
00360     }
00361 
00362     <span class="comment">/*</span>
00363 <span class="comment">     * Create only one desktop owner window per terminal.</span>
00364 <span class="comment">     */</span>
00365     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00366 
00367         <span class="comment">/*</span>
00368 <span class="comment">         * Switch ppi values so window will be created using the</span>
00369 <span class="comment">         * system's desktop window class.</span>
00370 <span class="comment">         */</span>
00371         ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00372         ppiSave = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00373         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> = pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00374 
00375         UserAssert(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_CLASSESREGISTERED);
00376 
00377         pdeskTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;            <span class="comment">/* save current desktop */</span>
00378         hdeskTemp = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o18">hdesk</a>;
00379         <span class="keywordflow">if</span> (pdeskTemp) {
00380             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(pdeskTemp);
00381             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdeskTemp, LD_REF_FN_CREATEWINDOWSTATION, TRUE, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00382         }
00383 
00384         <span class="comment">/*</span>
00385 <span class="comment">         * The following code is not supposed to leave the critical section because</span>
00386 <span class="comment">         * CreateWindowStation is an API so the current thread can be on any state</span>
00387 <span class="comment">         *  setting its pdesk to NULL it's kind of bogus</span>
00388 <span class="comment">         */</span>
00389         <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00390         <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00391         <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, NULL, NULL);
00392 
00393 
00394         <span class="comment">/*</span>
00395 <span class="comment">         * HACK HACK HACK!!! (adams) In order to create the desktop window</span>
00396 <span class="comment">         * with the correct desktop, we set the desktop of the current thread</span>
00397 <span class="comment">         * to the new desktop. But in so doing we allow hooks on the current</span>
00398 <span class="comment">         * thread to also hook this new desktop. This is bad, because we don't</span>
00399 <span class="comment">         * want the desktop window to be hooked while it is created. So we</span>
00400 <span class="comment">         * temporarily disable hooks of the current thread and desktop, and</span>
00401 <span class="comment">         * reenable them after switching back to the original desktop.</span>
00402 <span class="comment">         */</span>
00403 
00404         dwDisableHooks = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>;
00405         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>;
00406 
00407         <span class="comment">/*</span>
00408 <span class="comment">         * Create the desktop owner window</span>
00409 <span class="comment">         *</span>
00410 <span class="comment">         * CONSIDER (adams): Do we want to limit the desktop size so that the</span>
00411 <span class="comment">         * width and height of a rect will fit in 16bit coordinates?</span>
00412 <span class="comment">         *</span>
00413 <span class="comment">         *         SHRT_MIN / 2, SHRT_MIN / 2, SHRT_MAX, SHRT_MAX,</span>
00414 <span class="comment">         *</span>
00415 <span class="comment">         * Or do we want to limit it so just any point has 16bit coordinates?</span>
00416 <span class="comment">         *</span>
00417 <span class="comment">         *         -SHRT_MIN, -SHRT_MIN, SHRT_MAX * 2, SHRT_MAX * 2</span>
00418 <span class="comment">         */</span>
00419 
00420         pwnd =  <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(
00421                 (DWORD)0,
00422                 (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)DESKTOPCLASS,
00423                 NULL,
00424                 (WS_POPUP | WS_CLIPCHILDREN),
00425                 SHRT_MIN / 2,
00426                 SHRT_MIN / 2,
00427                 SHRT_MAX,
00428                 SHRT_MAX,
00429                 NULL,
00430                 NULL,
00431                 hModuleWin,
00432                 (LPWSTR)NULL,
00433                 VER31
00434                 );
00435 
00436         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00437             RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxCreateWindowStation: Failed to create mother desktop window"</span>);
00438             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00439             <a class="code" href="../../d4/d1/userk_8h.html#a167">EXITATOMICCHECK</a>();
00440             <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00441             <span class="comment">/*</span>
00442 <span class="comment">             * Restore caller's ppi</span>
00443 <span class="comment">             */</span>
00444             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> = ppiSave;
00445 
00446             <span class="comment">/*</span>
00447 <span class="comment">             * Restore the previous desktop</span>
00448 <span class="comment">             */</span>
00449             <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, pdeskTemp, hdeskTemp);
00450 
00451             <span class="keywordflow">goto</span> create_error;
00452         }
00453 
00454         <span class="comment">/*</span>
00455 <span class="comment">         * Mark this handle entry that is allocated out of pool</span>
00456 <span class="comment">         */</span>
00457         {
00458             <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe;
00459 
00460             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == NULL);
00461 
00462             phe = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pwnd);
00463             phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> |= <a class="code" href="../../d1/d0/inc_2user_8h.html#a417">HANDLEF_POOL</a>;
00464         }
00465 
00466         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>), pwnd);
00467 
00468         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; TIF_DISABLEHOOKS);
00469         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>) | dwDisableHooks;
00470 
00471         <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>, SV_SET);
00472         <a class="code" href="../../d4/d1/userk_8h.html#a980">HMChangeOwnerThread</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o1">spwndDesktopOwner</a>, pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>);
00473 
00474         <span class="comment">/*</span>
00475 <span class="comment">         * Restore caller's ppi</span>
00476 <span class="comment">         */</span>
00477         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> = ppiSave;
00478 
00479         <span class="comment">/*</span>
00480 <span class="comment">         * Restore the previous desktop</span>
00481 <span class="comment">         */</span>
00482         <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, pdeskTemp, hdeskTemp);
00483 
00484         <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00485         <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00486 
00487         <span class="keywordflow">if</span> (pdeskTemp) {
00488             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdeskTemp, LD_DEREF_FN_CREATEWINDOWSTATION, FALSE, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00489             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdeskTemp);
00490         }
00491     }
00492 
00493     <span class="comment">/*</span>
00494 <span class="comment">     * If this is the visible windowstation, assign it to</span>
00495 <span class="comment">     * the server and create the desktop switch notification</span>
00496 <span class="comment">     * event.</span>
00497 <span class="comment">     */</span>
00498     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
00499         UNICODE_STRING strName;
00500         HANDLE hRootDir;
00501         OBJECT_ATTRIBUTES obja;
00502 
00503         <span class="comment">/*</span>
00504 <span class="comment">         * Create desktop switch notification event.</span>
00505 <span class="comment">         */</span>
00506         ulLengthSid = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(<a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>);
00507         ulLength = ulLengthSid + <span class="keyword">sizeof</span>(ACE_HEADER) + <span class="keyword">sizeof</span>(ACCESS_MASK);
00508 
00509         <span class="comment">/*</span>
00510 <span class="comment">         * Allocate the ACE list</span>
00511 <span class="comment">         */</span>
00512         paceList = (PACCESS_ALLOWED_ACE)UserAllocPoolWithQuota(ulLength, TAG_SECURITY);
00513 
00514         <span class="keywordflow">if</span> (paceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00515             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00516             <span class="keywordflow">goto</span> create_error;
00517         }
00518 
00519         <span class="comment">/*</span>
00520 <span class="comment">         * Initialize ACE 0</span>
00521 <span class="comment">         */</span>
00522         pace = paceList;
00523         pace-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00524         pace-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ulLength;
00525         pace-&gt;Header.AceFlags = 0;
00526         pace-&gt;Mask = SYNCHRONIZE;
00527         <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(ulLengthSid, &amp;pace-&gt;SidStart, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>);
00528 
00529         <span class="comment">/*</span>
00530 <span class="comment">         * Create the SD</span>
00531 <span class="comment">         */</span>
00532         psd = <a class="code" href="../../d4/d1/userk_8h.html#a1268">CreateSecurityDescriptor</a>(paceList, ulLength, FALSE);
00533 
00534         UserFreePool(paceList);
00535 
00536         <span class="keywordflow">if</span> (psd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00537             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00538             <span class="keywordflow">goto</span> create_error;
00539         }
00540 
00541         <span class="comment">/*</span>
00542 <span class="comment">         * Create the named event.</span>
00543 <span class="comment">         */</span>
00544         UserAssert(ghEventSwitchDesktop == NULL);
00545 
00546         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00547             swprintf(szBaseNamedObjectDirectory, L<span class="stringliteral">"\\Sessions\\%ld\\BaseNamedObjects"</span>,
00548                      gSessionId);
00549             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, szBaseNamedObjectDirectory);
00550         } <span class="keywordflow">else</span> {
00551             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, L<span class="stringliteral">"\\BaseNamedObjects"</span>);
00552         }
00553 
00554         InitializeObjectAttributes( &amp;obja,
00555                                     &amp;strName,
00556                                     OBJ_CASE_INSENSITIVE,
00557                                     NULL,
00558                                     NULL
00559                                     );
00560         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenDirectoryObject( &amp;hRootDir,
00561                                         DIRECTORY_ALL_ACCESS &amp;
00562                                             ~(DELETE | WRITE_DAC | WRITE_OWNER),
00563                                         &amp;obja
00564                                     );
00565         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00566             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, L<span class="stringliteral">"WinSta0_DesktopSwitch"</span>);
00567             InitializeObjectAttributes(&amp;obja, &amp;strName, OBJ_OPENIF, hRootDir, psd);
00568             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(&amp;hEvent, EVENT_ALL_ACCESS, &amp;obja,
00569                     NotificationEvent, FALSE);
00570             ZwClose(hRootDir);
00571 
00572             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00573                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hEvent, EVENT_ALL_ACCESS, *ExEventObjectType,
00574                         KernelMode, &amp;gpEventSwitchDesktop, NULL);
00575                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00576 
00577                     <span class="comment">/*</span>
00578 <span class="comment">                     * Attach to the system process and create a handle to the</span>
00579 <span class="comment">                     * object.  This will ensure that the object name is retained</span>
00580 <span class="comment">                     * when hEvent is closed.  This is simpler than creating a</span>
00581 <span class="comment">                     * permanent object, which takes the</span>
00582 <span class="comment">                     * SeCreatePermanentPrivilege.</span>
00583 <span class="comment">                     */</span>
00584                     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00585 
00586                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
00587                             gpEventSwitchDesktop,
00588                             0,
00589                             NULL,
00590                             EVENT_ALL_ACCESS,
00591                             NULL,
00592                             KernelMode,
00593                             &amp;ghEventSwitchDesktop);
00594                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00595                 }
00596                 ZwClose(hEvent);
00597             }
00598         }
00599         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00600             <span class="keywordflow">goto</span> create_error;
00601 
00602         UserFreePool(psd);
00603     }
00604 
00605     <span class="comment">/*</span>
00606 <span class="comment">     * Create a handle to the windowstation</span>
00607 <span class="comment">     */</span>
00608     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(pwinsta, NULL, dwDesiredAccess, 1,
00609             &amp;pwinsta, &amp;hwinsta);
00610 
00611     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_EXISTS) {
00612 
00613         <span class="comment">/*</span>
00614 <span class="comment">         * The windowstation already exists, so deref and leave.</span>
00615 <span class="comment">         */</span>
00616         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
00617 
00618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00619         PSECURITY_DESCRIPTOR psdParent, psdNew;
00620         <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> Context;
00621         <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> pParentDirectory;
00622         SECURITY_INFORMATION siNew;
00623 
00624         <span class="comment">/*</span>
00625 <span class="comment">         * Create security descriptor for the windowstation.</span>
00626 <span class="comment">         * ObInsertObject only supports non-container</span>
00627 <span class="comment">         * objects, so we must assign our own security descriptor.</span>
00628 <span class="comment">         */</span>
00629         <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>(&amp;Context);
00630         <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>(&amp;Context);
00631 
00632         pParentDirectory = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>(
00633                 <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pwinsta))-&gt;Directory;
00634         <span class="keywordflow">if</span> (pParentDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00635             psdParent = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pParentDirectory)-&gt;SecurityDescriptor;
00636         <span class="keywordflow">else</span>
00637             psdParent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00638 
00639         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/seassign_8c.html#a1">SeAssignSecurity</a>(
00640                 psdParent,
00641                 psdCapture,
00642                 &amp;psdNew,
00643                 TRUE,
00644                 &amp;Context,
00645                 (PGENERIC_MAPPING)&amp;WinStaMapping,
00646                 PagedPool);
00647 
00648         <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>(&amp;Context);
00649         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>(&amp;Context);
00650 
00651         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00652 <span class="preprocessor">#if DBG</span>
00653 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ACCESS_DENIED) {
00654                 RIPNTERR0(Status, RIP_WARNING, <span class="stringliteral">"Access denied during object creation"</span>);
00655             } <span class="keywordflow">else</span> {
00656                 RIPNTERR1(Status, RIP_ERROR,
00657                             <span class="stringliteral">"Can't create security descriptor! Status = %#lx"</span>,
00658                             Status);
00659             }
00660 <span class="preprocessor">#endif</span>
00661 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
00662 
00663             <span class="comment">/*</span>
00664 <span class="comment">             * Call the security method to copy the security descriptor</span>
00665 <span class="comment">             */</span>
00666             siNew = (OWNER_SECURITY_INFORMATION | GROUP_SECURITY_INFORMATION |
00667                     DACL_SECURITY_INFORMATION | SACL_SECURITY_INFORMATION);
00668             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a13">ObSetSecurityDescriptorInfo</a>(
00669                     pwinsta,
00670                     &amp;siNew,
00671                     psdNew,
00672                     &amp;<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pwinsta)-&gt;SecurityDescriptor,
00673                     PagedPool,
00674                     (PGENERIC_MAPPING)&amp;WinStaMapping);
00675             <a class="code" href="../../d1/d5/seassign_8c.html#a3">SeDeassignSecurity</a>(&amp;psdNew);
00676 
00677             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00678 
00679                 <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>* ppwinsta;
00680 
00681                 <span class="comment">/*</span>
00682 <span class="comment">                 * Put it on the tail of the global windowstation list</span>
00683 <span class="comment">                 */</span>
00684                 ppwinsta = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
00685                 <span class="keywordflow">while</span> (*ppwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00686                     ppwinsta = &amp;(*ppwinsta)-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>;
00687                 <a class="code" href="../../d4/d1/userk_8h.html#a125">LockWinSta</a>(ppwinsta, pwinsta);
00688 
00689                 <span class="comment">/*</span>
00690 <span class="comment">                 * For interactive window stations load the keyboard</span>
00691 <span class="comment">                 * layout. !!!</span>
00692 <span class="comment">                 */</span>
00693                 <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) &amp;&amp; pwszKLID != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00694                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1302">xxxLoadKeyboardLayoutEx</a>(
00695                                 pwinsta,
00696                                 hKbdLayoutFile,
00697                                 (HKL)NULL,
00698                                 offTable,
00699                                 pwszKLID,
00700                                 uKbdInputLocale,
00701                                 KLF_ACTIVATE | KLF_INITTIME) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00702                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00703                     }
00704                 }
00705             }
00706         }
00707         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
00708     }
00709 
00710     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00711         RIPNTERR1(Status,
00712                   RIP_WARNING,
00713                   <span class="stringliteral">"CreateWindowStation: Failed with Status 0x%x"</span>,
00714                   Status);
00715         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00716     }
00717 
00718     <span class="keywordflow">return</span> hwinsta;
00719 
00720     <span class="comment">/*</span>
00721 <span class="comment">     * Goto here if an error occurs so things can be cleaned up</span>
00722 <span class="comment">     */</span>
00723 create_error:
00724 
00725     RIPNTERR1(Status,
00726               RIP_WARNING,
00727               <span class="stringliteral">"CreateWindowStation: Failed with Status 0x%x"</span>,
00728               Status);
00729 
00730     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
00731 
00732     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00733 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="winsta.c::xxxInitTerminal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS xxxInitTerminal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pTerm</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l00026">26</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00131">CreateSystemThread()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l01376">CreateTerminalInput()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02015">tagTERMINAL::dwTERMF_Flags</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00201">EnterCrit</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d8/d0/usersrv_8h-source.html#l00202">LeaveCrit</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02031">tagTERMINAL::pEventInputReady</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02026">tagTERMINAL::pEventTermInit</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00367">PKSTART_ROUTINE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02010">TERMF_DTINITFAILED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02006">TERMF_INITIALIZED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02007">TERMF_NOIO</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l00114">xxxDesktopThread()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>.
<p>
<pre class="fragment"><div>00028 {
00029     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00030     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>  pEventTermInit;
00031     HANDLE   hEventInputReady, hEventTermInit;
00032     HANDLE   hThreadDesktop;
00033 
00034     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00035 
00036     UserAssert(!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; TERMF_INITIALIZED));
00037 
00038     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00039 
00040         <span class="comment">/*</span>
00041 <span class="comment">         * if we make it here it means that another thread is</span>
00042 <span class="comment">         * executing xxxInitTerminal for the same terminal and it</span>
00043 <span class="comment">         * left the critical section.</span>
00044 <span class="comment">         */</span>
00045         UserAssert(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a> != NULL);
00046 
00047         <span class="comment">/*</span>
00048 <span class="comment">         * use a local variable so we can safely reset</span>
00049 <span class="comment">         * pTerm-&gt;pEventTermInit when we're done with it</span>
00050 <span class="comment">         */</span>
00051         pEventTermInit = pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>;
00052 
00053         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(pEventTermInit);
00054 
00055         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00056 
00057         <span class="keywordflow">goto</span> Wait;
00058     }
00059 
00060     <span class="comment">/*</span>
00061 <span class="comment">     * Create the input ready event. RIT and desktop thread will wait for it.</span>
00062 <span class="comment">     * It will be set when the first desktop in this terminal will be created.</span>
00063 <span class="comment">     */</span>
00064     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(
00065                      &amp;hEventInputReady,
00066                      EVENT_ALL_ACCESS,
00067                      NULL,
00068                      NotificationEvent,
00069                      FALSE);
00070 
00071     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00072         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00073 
00074     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00075                      hEventInputReady,
00076                      EVENT_ALL_ACCESS,
00077                      *ExEventObjectType,
00078                      KernelMode,
00079                      &amp;pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>, NULL);
00080 
00081     ZwClose(hEventInputReady);
00082 
00083     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00084         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00085 
00086     <span class="comment">/*</span>
00087 <span class="comment">     * Device and RIT initialization. Don't do it for</span>
00088 <span class="comment">     * the system terminal.</span>
00089 <span class="comment">     */</span>
00090     <span class="keywordflow">if</span> (!(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a201">TERMF_NOIO</a>)) {
00091         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1835">CreateTerminalInput</a>(pTerm)) {
00092             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>);
00093             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00094         }
00095     }
00096 
00097     <span class="comment">/*</span>
00098 <span class="comment">     * create an event to syncronize the terminal initialization</span>
00099 <span class="comment">     */</span>
00100     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(
00101                      &amp;hEventTermInit,
00102                      EVENT_ALL_ACCESS,
00103                      NULL,
00104                      NotificationEvent,
00105                      FALSE);
00106 
00107     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00108         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>);
00109         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00110     }
00111 
00112     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00113                      hEventTermInit,
00114                      EVENT_ALL_ACCESS,
00115                      *ExEventObjectType,
00116                      KernelMode,
00117                      &amp;pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>, NULL);
00118 
00119     ZwClose(hEventTermInit);
00120 
00121     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00122         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>);
00123         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00124     }
00125 
00126     <span class="comment">/*</span>
00127 <span class="comment">     * use a local variable so we can safely reset</span>
00128 <span class="comment">     * pTerm-&gt;pEventTermInit when we're done with it</span>
00129 <span class="comment">     */</span>
00130     pEventTermInit = pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a>;
00131 
00132     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00133 
00134     <span class="comment">/*</span>
00135 <span class="comment">     * Create the desktop thread.</span>
00136 <span class="comment">     */</span>
00137     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a963">CreateSystemThread</a>(
00138                      (PKSTART_ROUTINE)xxxDesktopThread,
00139                      pTerm,
00140                      &amp;hThreadDesktop);
00141 
00142     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00143         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00144         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o7">pEventInputReady</a>);
00145         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEventTermInit);
00146         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00147     }
00148 
00149     ZwClose(hThreadDesktop);
00150 
00151 Wait:
00152     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEventTermInit,
00153                           WrUserRequest,
00154                           KernelMode,
00155                           FALSE,
00156                           NULL);
00157 
00158     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00159 
00160     <span class="comment">/*</span>
00161 <span class="comment">     * dereference the terminal init event. It will eventually</span>
00162 <span class="comment">     * go away.</span>
00163 <span class="comment">     */</span>
00164     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEventTermInit);
00165 
00166     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o4">pEventTermInit</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00167 
00168     <span class="keywordflow">if</span> (pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a204">TERMF_DTINITFAILED</a>) {
00169         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00170     }
00171 
00172     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o0">dwTERMF_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a200">TERMF_INITIALIZED</a>;
00173     <span class="keywordflow">return</span> STATUS_SUCCESS;
00174 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="winsta.c::xxxSetProcessWindowStation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxSetProcessWindowStation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWINSTA&nbsp;</td>
          <td class="mdname" nowrap> <em>hwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l01077">1077</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03490">tagPROCESSINFO::amwinsta</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02718">tagWINDOWSTATION::dwWSF_Flags</a>, <a class="el" href="../../d4/d6/win32_8c-source.html#l00032">ExWindowStationObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07290">HF_PROTECTED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03489">tagPROCESSINFO::hwinsta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01631">LockWinSta</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00089">PpiFromProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03488">tagPROCESSINFO::rpwinsta</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03309">RtlAreAllAccessesGranted()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04494">SetHandleFlag()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00252">_EPROCESS::Win32WindowStation</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02704">WSF_NOIO</a>, and <a class="el" href="../../d4/d1/userk_8h.html#a1275">xxxUserDuplicateObject()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01139">NtUserSetProcessWindowStation()</a>, and <a class="el" href="../../d7/d2/queue_8c-source.html#l01501">xxxCreateThreadInfo()</a>.
<p>
<pre class="fragment"><div>01080 {
01081     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>                    Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01082     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>                   Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01083     HWINSTA                     hwinstaDup;
01084     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01085     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>                ppi;
01086     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>              pwinsta;
01087     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>              pwinstaOld;
01088     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a>   ohi;
01089     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a>   ohiOld;
01090 
01091     <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01092         UserAssert(Process);
01093         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01094     }
01095 
01096     <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01097         UserAssert(Thread);
01098         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01099     }
01100 
01101     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread));
01102 
01103     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01104             hwinsta,
01105             0,
01106             *ExWindowStationObjectType,
01107             AccessMode,
01108             &amp;pwinsta,
01109             &amp;ohi))) {
01110         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01111     }
01112 
01113    <span class="comment">/*</span>
01114 <span class="comment">    * Bug 38780. Lock the handle to window station so that an app cannot free the</span>
01115 <span class="comment">    * this handle by calling  GetProcessWindowStation() &amp; CloseHandle()</span>
01116 <span class="comment">    */</span>
01117 
01118     <span class="comment">/*</span>
01119 <span class="comment">     * Unprotect the old hwinsta</span>
01120 <span class="comment">     */</span>
01121     <span class="keywordflow">if</span> (ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>) {
01122         <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>, HF_PROTECTED, FALSE);
01123     }
01124 
01125     <span class="comment">/*</span>
01126 <span class="comment">     * Save the WindowStation information</span>
01127 <span class="comment">     */</span>
01128     <a class="code" href="../../d4/d1/userk_8h.html#a125">LockWinSta</a>(&amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>, pwinsta);
01129     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinsta);
01130     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a> = hwinsta;
01131 
01132     <span class="comment">/*</span>
01133 <span class="comment">     * Protect the new Window Station Handle</span>
01134 <span class="comment">     */</span>
01135     <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o15">hwinsta</a>, HF_PROTECTED, TRUE);
01136 
01137     <span class="comment">/*</span>
01138 <span class="comment">     * Check the old Atom Manager WindowStation to see if we are</span>
01139 <span class="comment">     * changing this process' WindowStation.</span>
01140 <span class="comment">     */</span>
01141     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a>) {
01142         <span class="comment">/*</span>
01143 <span class="comment">         * Get a pointer to the old WindowStation object to see if it's</span>
01144 <span class="comment">         * the same WindowStation that we are setting.</span>
01145 <span class="comment">         */</span>
01146         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01147             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a>,
01148             0,
01149             *ExWindowStationObjectType,
01150             AccessMode,
01151             &amp;pwinstaOld,
01152             &amp;ohiOld);
01153         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01154             <span class="comment">/*</span>
01155 <span class="comment">             * Are they different WindowStations?  If so, NULL out the</span>
01156 <span class="comment">             * atom manager cache so we will reset it below.</span>
01157 <span class="comment">             */</span>
01158             <span class="keywordflow">if</span> (pwinsta != pwinstaOld) {
01159                 ZwClose(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a>);
01160                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01161             }
01162             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwinstaOld);
01163 
01164         } <span class="keywordflow">else</span> {
01165             <span class="comment">/*</span>
01166 <span class="comment">             * Their Atom Manager handle is bad?  Give them a new one.</span>
01167 <span class="comment">             */</span>
01168             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01169 <span class="preprocessor">#if DBG</span>
01170 <span class="preprocessor"></span>            RIPMSG2(RIP_WARNING,
01171                     <span class="stringliteral">"SetProcessWindowStation: Couldn't reference old WindowStation (0x%X) Status=0x%X"</span>,
01172                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a>,
01173                     Status);
01174 <span class="preprocessor">#endif</span>
01175 <span class="preprocessor"></span>        }
01176     }
01177 
01178     <span class="comment">/*</span>
01179 <span class="comment">     * Duplicate the WindowStation handle and stash it in the atom</span>
01180 <span class="comment">     * manager's cache (Process-&gt;Win32WindowStation).  We duplicate</span>
01181 <span class="comment">     * the handle in case</span>
01182 <span class="comment">     */</span>
01183     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01184         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1275">xxxUserDuplicateObject</a>(
01185                      NtCurrentProcess(),
01186                      hwinsta,
01187                      NtCurrentProcess(),
01188                      &amp;hwinstaDup,
01189                      0,
01190                      0,
01191                      DUPLICATE_SAME_ACCESS);
01192 
01193         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01194             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a> = hwinstaDup;
01195         }
01196 <span class="preprocessor">#if DBG</span>
01197 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
01198             RIPMSG2(RIP_WARNING,
01199                     <span class="stringliteral">"SetProcessWindowStation: Couldn't duplicate WindowStation handle (0x%X) Status=0x%X"</span>,
01200                     hwinsta,
01201                     Status);
01202         }
01203 <span class="preprocessor">#endif</span>
01204 <span class="preprocessor"></span>    }
01205 
01206     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o16">amwinsta</a> = ohi.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>;
01207 
01208     <span class="comment">/*</span>
01209 <span class="comment">     * Cache WSF_NOIO flag in the W32PROCESS so that GDI can access it.</span>
01210 <span class="comment">     */</span>
01211     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
01212         ppi-&gt;W32PF_Flags &amp;= ~W32PF_IOWINSTA;
01213     } <span class="keywordflow">else</span> {
01214         ppi-&gt;W32PF_Flags |= W32PF_IOWINSTA;
01215     }
01216 
01217     <span class="comment">/*</span>
01218 <span class="comment">     * Do the access check now for readscreen so that</span>
01219 <span class="comment">     * blts off of the display will be as fast as possible.</span>
01220 <span class="comment">     */</span>
01221     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(ohi.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>, WINSTA_READSCREEN)) {
01222         ppi-&gt;W32PF_Flags |= W32PF_READSCREENACCESSGRANTED;
01223     } <span class="keywordflow">else</span> {
01224         ppi-&gt;W32PF_Flags &amp;= ~W32PF_READSCREENACCESSGRANTED;
01225     }
01226 
01227     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01228 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="winsta.c::lpszStdFormats" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST LPCWSTR <a class="el" href="../../d8/d8/winsta_8c.html#a0">lpszStdFormats</a>[]<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdExit"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdNewDocument"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdOpenDocument"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdEditDocument"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdNewfromTemplate"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdCloseDocument"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdShowItem"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdDoVerbItem"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"System"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OLEsystem"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StdDocumentName"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Protocols"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Topics"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Formats"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Status"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EditEnvItems"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"True"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"False"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Change"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Save"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Close"</span>,
    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MSDraw"</span>
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d7/winsta_8c-source.html#l00187">187</a> of file <a class="el" href="../../d9/d7/winsta_8c-source.html">winsta.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/winsta_8c-source.html#l00212">CreateGlobalAtomTable()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
