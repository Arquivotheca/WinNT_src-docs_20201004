<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: alpha/exceptn.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exceptn.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d9/d7/alpha_2exceptn_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/alpha_2exceptn_8c.html#a0">DEFAULT_NO_ALIGNMENT_FIXUPS</a>&nbsp;&nbsp;&nbsp;FALSE</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/alpha_2exceptn_8c.html#a2">KiMachineCheck</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN PKEXCEPTION_FRAME ExceptionFrame, IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/alpha_2exceptn_8c.html#a3">KeContextFromKframes</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame, IN OUT PCONTEXT ContextFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/alpha_2exceptn_8c.html#a4">KeContextToKframes</a> (IN OUT PKTRAP_FRAME TrapFrame, IN OUT PKEXCEPTION_FRAME ExceptionFrame, IN PCONTEXT ContextFrame, IN ULONG ContextFlags, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/alpha_2exceptn_8c.html#a5">KiDispatchException</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN PKEXCEPTION_FRAME ExceptionFrame, IN PKTRAP_FRAME TrapFrame, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN BOOLEAN FirstChance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/alpha_2exceptn_8c.html#a6">KiCopyInformation</a> (IN OUT PEXCEPTION_RECORD ExceptionRecord1, IN PEXCEPTION_RECORD ExceptionRecord2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/alpha_2exceptn_8c.html#a7">KeRaiseUserException</a> (IN NTSTATUS ExceptionCode)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> = DEFAULT_NO_ALIGNMENT_FIXUPS ? 1 : 0</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="alpha/exceptn.c::DEFAULT_NO_ALIGNMENT_FIXUPS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_NO_ALIGNMENT_FIXUPS&nbsp;&nbsp;&nbsp;FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00074">74</a> of file <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html">alpha/exceptn.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="alpha/exceptn.c::KeContextFromKframes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeContextFromKframes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00104">104</a> of file <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html">alpha/exceptn.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00241">CONTEXT_FLOATING_POINT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00242">CONTEXT_INTEGER</a>.
<p>
<pre class="fragment"><div>00112                    :
00113 
00114     This routine moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> selected contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap and exception
00115     frames into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context frame according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context
00116     flags.
00117 
00118 Arguments:
00119 
00120     TrapFrame - Supplies a pointer to a trap frame from which <span class="keyword">volatile</span> context
00121         should be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00122 
00123     ExceptionFrame - Supplies a pointer to an exception frame from which context
00124         should be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00125 
00126     ContextFrame - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context frame that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00127         context copied from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap and exception frames.
00128 
00129 Return Value:
00130 
00131     None.
00132 
00133 --*/
00134 
00135 {
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Set control information if specified.</span>
00139     <span class="comment">//</span>
00140 
00141     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00142 
00143         <span class="comment">//</span>
00144         <span class="comment">// Set integer register gp, ra, sp, FIR, and PSR from trap frame.</span>
00145         <span class="comment">//</span>
00146 
00147         ContextFrame-&gt;IntGp = TrapFrame-&gt;IntGp;
00148         ContextFrame-&gt;IntSp = TrapFrame-&gt;IntSp;
00149         ContextFrame-&gt;IntRa = TrapFrame-&gt;IntRa;
00150         ContextFrame-&gt;Fir = TrapFrame-&gt;Fir;
00151         ContextFrame-&gt;Psr = TrapFrame-&gt;Psr;
00152     }
00153 
00154     <span class="comment">//</span>
00155     <span class="comment">// Set integer register contents if specified.</span>
00156     <span class="comment">//</span>
00157 
00158     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00159 
00160         <span class="comment">//</span>
00161         <span class="comment">// Set volatile integer registers v0 and t0 - t7 from trap frame.</span>
00162         <span class="comment">//</span>
00163 
00164         ContextFrame-&gt;IntV0 = TrapFrame-&gt;IntV0;
00165         ContextFrame-&gt;IntT0 = TrapFrame-&gt;IntT0;
00166         ContextFrame-&gt;IntT1 = TrapFrame-&gt;IntT1;
00167         ContextFrame-&gt;IntT2 = TrapFrame-&gt;IntT2;
00168         ContextFrame-&gt;IntT3 = TrapFrame-&gt;IntT3;
00169         ContextFrame-&gt;IntT4 = TrapFrame-&gt;IntT4;
00170         ContextFrame-&gt;IntT5 = TrapFrame-&gt;IntT5;
00171         ContextFrame-&gt;IntT6 = TrapFrame-&gt;IntT6;
00172         ContextFrame-&gt;IntT7 = TrapFrame-&gt;IntT7;
00173 
00174         <span class="comment">//</span>
00175         <span class="comment">// Set nonvolatile integer registers s0 - s5 from exception frame.</span>
00176         <span class="comment">//</span>
00177 
00178         ContextFrame-&gt;IntS0 = ExceptionFrame-&gt;IntS0;
00179         ContextFrame-&gt;IntS1 = ExceptionFrame-&gt;IntS1;
00180         ContextFrame-&gt;IntS2 = ExceptionFrame-&gt;IntS2;
00181         ContextFrame-&gt;IntS3 = ExceptionFrame-&gt;IntS3;
00182         ContextFrame-&gt;IntS4 = ExceptionFrame-&gt;IntS4;
00183         ContextFrame-&gt;IntS5 = ExceptionFrame-&gt;IntS5;
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">// Set volatile integer registers a0 - a5, and t8 - t11 from trap</span>
00187         <span class="comment">// frame.</span>
00188         <span class="comment">//</span>
00189 
00190         ContextFrame-&gt;IntA0 = TrapFrame-&gt;IntA0;
00191         ContextFrame-&gt;IntA1 = TrapFrame-&gt;IntA1;
00192         ContextFrame-&gt;IntA2 = TrapFrame-&gt;IntA2;
00193         ContextFrame-&gt;IntA3 = TrapFrame-&gt;IntA3;
00194         ContextFrame-&gt;IntA4 = TrapFrame-&gt;IntA4;
00195         ContextFrame-&gt;IntA5 = TrapFrame-&gt;IntA5;
00196 
00197         ContextFrame-&gt;IntT8 = TrapFrame-&gt;IntT8;
00198         ContextFrame-&gt;IntT9 = TrapFrame-&gt;IntT9;
00199         ContextFrame-&gt;IntT10 = TrapFrame-&gt;IntT10;
00200         ContextFrame-&gt;IntT11 = TrapFrame-&gt;IntT11;
00201 
00202         <span class="comment">//</span>
00203         <span class="comment">// Set volatile integer registers fp, t12 and at from trap frame.</span>
00204         <span class="comment">// Set integer register zero.</span>
00205         <span class="comment">//</span>
00206 
00207         ContextFrame-&gt;IntFp = TrapFrame-&gt;IntFp;
00208         ContextFrame-&gt;IntT12 = TrapFrame-&gt;IntT12;
00209         ContextFrame-&gt;IntAt = TrapFrame-&gt;IntAt;
00210         ContextFrame-&gt;IntZero = 0;
00211     }
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// Set floating register contents if specified.</span>
00215     <span class="comment">//</span>
00216 
00217     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">// Set volatile floating registers f0 - f1 from trap frame.</span>
00221         <span class="comment">// Set volatile floating registers f10 - f30 from trap frame.</span>
00222         <span class="comment">// Set floating zero register f31 to 0.</span>
00223         <span class="comment">//</span>
00224 
00225         ContextFrame-&gt;FltF0 = TrapFrame-&gt;FltF0;
00226         ContextFrame-&gt;FltF1 = TrapFrame-&gt;FltF1;
00227         RtlMoveMemory(&amp;ContextFrame-&gt;FltF10, &amp;TrapFrame-&gt;FltF10,
00228                       <span class="keyword">sizeof</span>(ULONGLONG) * 21);
00229         ContextFrame-&gt;FltF31 = 0;
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// Set nonvolatile floating registers f2 - f9 from exception frame.</span>
00233         <span class="comment">//</span>
00234 
00235         ContextFrame-&gt;FltF2 = ExceptionFrame-&gt;FltF2;
00236         ContextFrame-&gt;FltF3 = ExceptionFrame-&gt;FltF3;
00237         ContextFrame-&gt;FltF4 = ExceptionFrame-&gt;FltF4;
00238         ContextFrame-&gt;FltF5 = ExceptionFrame-&gt;FltF5;
00239         ContextFrame-&gt;FltF6 = ExceptionFrame-&gt;FltF6;
00240         ContextFrame-&gt;FltF7 = ExceptionFrame-&gt;FltF7;
00241         ContextFrame-&gt;FltF8 = ExceptionFrame-&gt;FltF8;
00242         ContextFrame-&gt;FltF9 = ExceptionFrame-&gt;FltF9;
00243 
00244         <span class="comment">//</span>
00245         <span class="comment">// Set floating point control register from trap frame.</span>
00246         <span class="comment">// Clear software floating point control register in context frame</span>
00247         <span class="comment">// (if necessary, it can be set to the proper value by the caller).</span>
00248         <span class="comment">//</span>
00249 
00250         ContextFrame-&gt;Fpcr = TrapFrame-&gt;Fpcr;
00251         ContextFrame-&gt;SoftFpcr = 0;
00252     }
00253 
00254     <span class="keywordflow">return</span>;
00255 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="alpha/exceptn.c::KeContextToKframes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeContextToKframes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00258">258</a> of file <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html">alpha/exceptn.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00241">CONTEXT_FLOATING_POINT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00242">CONTEXT_INTEGER</a>.
<p>
<pre class="fragment"><div>00268                    :
00269 
00270     This routine moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> selected contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context frame into
00271     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap and exception frames according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context
00272     flags.
00273 
00274 Arguments:
00275 
00276     TrapFrame - Supplies a pointer to a trap frame that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">volatile</span>
00277         context from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00278 
00279     ExceptionFrame - Supplies a pointer to an exception frame that receives
00280         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nonvolatile context from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00281 
00282     ContextFrame - Supplies a pointer to a context frame that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00283         context that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap and exception frames.
00284 
00285     ContextFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of flags that specify which parts of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00286         context frame are to be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap and exception frames.
00287 
00288     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap and exception
00289         frames are being built.
00290 
00291 Return Value:
00292 
00293     None.
00294 
00295 --*/
00296 
00297 {
00298 
00299     <span class="comment">//</span>
00300     <span class="comment">// Set control information if specified.</span>
00301     <span class="comment">//</span>
00302 
00303     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00304 
00305         <span class="comment">//</span>
00306         <span class="comment">// Set integer register gp, sp, ra, FIR, and PSR in trap frame.</span>
00307         <span class="comment">//</span>
00308 
00309         TrapFrame-&gt;IntGp = ContextFrame-&gt;IntGp;
00310         TrapFrame-&gt;IntSp = ContextFrame-&gt;IntSp;
00311         TrapFrame-&gt;IntRa = ContextFrame-&gt;IntRa;
00312         TrapFrame-&gt;Fir = ContextFrame-&gt;Fir;
00313         TrapFrame-&gt;Psr = SANITIZE_PSR(ContextFrame-&gt;Psr, PreviousMode);
00314     }
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">// Set integer register contents if specified.</span>
00318     <span class="comment">//</span>
00319 
00320     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">// Set volatile integer registers v0 and t0 - t7 in trap frame.</span>
00324         <span class="comment">//</span>
00325 
00326         TrapFrame-&gt;IntV0 = ContextFrame-&gt;IntV0;
00327         TrapFrame-&gt;IntT0 = ContextFrame-&gt;IntT0;
00328         TrapFrame-&gt;IntT1 = ContextFrame-&gt;IntT1;
00329         TrapFrame-&gt;IntT2 = ContextFrame-&gt;IntT2;
00330         TrapFrame-&gt;IntT3 = ContextFrame-&gt;IntT3;
00331         TrapFrame-&gt;IntT4 = ContextFrame-&gt;IntT4;
00332         TrapFrame-&gt;IntT5 = ContextFrame-&gt;IntT5;
00333         TrapFrame-&gt;IntT6 = ContextFrame-&gt;IntT6;
00334         TrapFrame-&gt;IntT7 = ContextFrame-&gt;IntT7;
00335 
00336         <span class="comment">//</span>
00337         <span class="comment">// Set nonvolatile integer registers s0 - s5 in exception frame.</span>
00338         <span class="comment">//</span>
00339 
00340         ExceptionFrame-&gt;IntS0 = ContextFrame-&gt;IntS0;
00341         ExceptionFrame-&gt;IntS1 = ContextFrame-&gt;IntS1;
00342         ExceptionFrame-&gt;IntS2 = ContextFrame-&gt;IntS2;
00343         ExceptionFrame-&gt;IntS3 = ContextFrame-&gt;IntS3;
00344         ExceptionFrame-&gt;IntS4 = ContextFrame-&gt;IntS4;
00345         ExceptionFrame-&gt;IntS5 = ContextFrame-&gt;IntS5;
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">// Set volatile integer registers a0 - a5, and t8 - t11 in trap frame.</span>
00349         <span class="comment">//</span>
00350 
00351         TrapFrame-&gt;IntA0 = ContextFrame-&gt;IntA0;
00352         TrapFrame-&gt;IntA1 = ContextFrame-&gt;IntA1;
00353         TrapFrame-&gt;IntA2 = ContextFrame-&gt;IntA2;
00354         TrapFrame-&gt;IntA3 = ContextFrame-&gt;IntA3;
00355         TrapFrame-&gt;IntA4 = ContextFrame-&gt;IntA4;
00356         TrapFrame-&gt;IntA5 = ContextFrame-&gt;IntA5;
00357 
00358         TrapFrame-&gt;IntT8 = ContextFrame-&gt;IntT8;
00359         TrapFrame-&gt;IntT9 = ContextFrame-&gt;IntT9;
00360         TrapFrame-&gt;IntT10 = ContextFrame-&gt;IntT10;
00361         TrapFrame-&gt;IntT11 = ContextFrame-&gt;IntT11;
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">// Set volatile integer registers fp, t12 and at in trap frame.</span>
00365         <span class="comment">//</span>
00366 
00367         TrapFrame-&gt;IntFp = ContextFrame-&gt;IntFp;
00368         TrapFrame-&gt;IntT12 = ContextFrame-&gt;IntT12;
00369         TrapFrame-&gt;IntAt = ContextFrame-&gt;IntAt;
00370     }
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Set floating register contents if specified.</span>
00374     <span class="comment">//</span>
00375 
00376     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00377 
00378         <span class="comment">//</span>
00379         <span class="comment">// Set volatile floating registers f0 - f1 in trap frame.</span>
00380         <span class="comment">// Set volatile floating registers f10 - f30 in trap frame.</span>
00381         <span class="comment">//</span>
00382 
00383         TrapFrame-&gt;FltF0 = ContextFrame-&gt;FltF0;
00384         TrapFrame-&gt;FltF1 = ContextFrame-&gt;FltF1;
00385         RtlMoveMemory(&amp;TrapFrame-&gt;FltF10, &amp;ContextFrame-&gt;FltF10,
00386                       <span class="keyword">sizeof</span>(ULONGLONG) * 21);
00387 
00388         <span class="comment">//</span>
00389         <span class="comment">// Set nonvolatile floating registers f2 - f9 in exception frame.</span>
00390         <span class="comment">//</span>
00391 
00392         ExceptionFrame-&gt;FltF2 = ContextFrame-&gt;FltF2;
00393         ExceptionFrame-&gt;FltF3 = ContextFrame-&gt;FltF3;
00394         ExceptionFrame-&gt;FltF4 = ContextFrame-&gt;FltF4;
00395         ExceptionFrame-&gt;FltF5 = ContextFrame-&gt;FltF5;
00396         ExceptionFrame-&gt;FltF6 = ContextFrame-&gt;FltF6;
00397         ExceptionFrame-&gt;FltF7 = ContextFrame-&gt;FltF7;
00398         ExceptionFrame-&gt;FltF8 = ContextFrame-&gt;FltF8;
00399         ExceptionFrame-&gt;FltF9 = ContextFrame-&gt;FltF9;
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Set floating point control register in trap frame.</span>
00403         <span class="comment">//</span>
00404 
00405         TrapFrame-&gt;Fpcr = ContextFrame-&gt;Fpcr;
00406     }
00407 
00408     <span class="keywordflow">return</span>;
00409 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="alpha/exceptn.c::KeRaiseUserException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KeRaiseUserException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionCode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l01024">1024</a> of file <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html">alpha/exceptn.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02811">KeRaiseUserExceptionDispatcher</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>01030                    :
01031 
01032     This function causes an exception to be raised in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread's user-mode
01033     context. It does <span class="keyword">this</span> by editing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel was entered with to
01034     point to trampoline code that raises <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested exception.
01035 
01036 Arguments:
01037 
01038     ExceptionCode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status value to be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
01039         code <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be raised.
01040 
01041 Return Value:
01042 
01043     The status value that should be returned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01044 
01045 --*/
01046 
01047 {
01048 
01049     PKTRAP_FRAME TrapFrame;
01050 
01051     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetPreviousMode() == UserMode);
01052 
01053     TrapFrame = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;TrapFrame;
01054 
01055     TrapFrame-&gt;Fir = (ULONGLONG)(LONG_PTR)<a class="code" href="../../d4/d9/ke_8h.html#a151">KeRaiseUserExceptionDispatcher</a>;
01056     <span class="keywordflow">return</span>(ExceptionCode);
01057 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="alpha/exceptn.c::KiCopyInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KiCopyInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00984">984</a> of file <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html">alpha/exceptn.c</a>.
<p>
<pre class="fragment"><div>00991                    :
00992 
00993     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from an exception filter to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00994     information from one exception record to another when an exception occurs.
00995 
00996 Arguments:
00997 
00998     ExceptionRecord1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination exception record.
00999 
01000     ExceptionRecord2 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source exception record.
01001 
01002 Return Value:
01003 
01004     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
01005 
01006 --*/
01007 
01008 {
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// Copy one exception record to another and return value that causes</span>
01012     <span class="comment">// an exception handler to be executed.</span>
01013     <span class="comment">//</span>
01014 
01015     RtlMoveMemory((PVOID)ExceptionRecord1,
01016                   (PVOID)ExceptionRecord2,
01017                   <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
01018 
01019     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
01020 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="alpha/exceptn.c::KiDispatchException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiDispatchException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00412">412</a> of file <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html">alpha/exceptn.c</a>.
<p>
<pre class="fragment"><div>00422                    :
00423 
00424     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to dispatch an exception to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper mode and
00425     to cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception dispatcher to be called.
00426 
00427     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a data misalignment, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> user, <span class="keyword">this</span>
00428     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first chance <span class="keywordflow">for</span> handling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread
00429     has enabled automatic alignment fixup, then an attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to emulate
00430     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unaligned reference. Data misalignment exceptions are never emulated
00431     <span class="keywordflow">for</span> kernel mode.
00432 
00433     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a floating not implemented exception, then an attempt
00434     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to emulate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> floating operation. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an
00435     arithmetic exception, then an attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to convert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> imprecise
00436     exception into a precise exception, and then emulate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> floating
00437     operation in order to obtain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper IEEE results and exceptions.
00438     Floating exceptions are never emulated <span class="keywordflow">for</span> kernel mode.
00439 
00440     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> neither a data misalignment nor a floating point
00441     exception and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> kernel, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00442     dispatcher <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called directly to process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00443     exception record, exception frame, and trap frame contents are copied
00444     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user mode stack. The contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception frame and trap
00445     are then modified such that when <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned, execution will
00446     commence in user mode in a routine which will call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00447     dispatcher.
00448 
00449 Arguments:
00450 
00451     ExceptionRecord - Supplies a pointer to an exception record.
00452 
00453     ExceptionFrame - Supplies a pointer to an exception frame.
00454 
00455     TrapFrame - Supplies a pointer to a trap frame.
00456 
00457     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00458 
00459     FirstChance - Supplies a <span class="keywordtype">boolean</span> variable that specifies whether <span class="keyword">this</span>
00460         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first (TRUE) or second (FALSE) time that this exception has
00461         been processed.
00462 
00463 Return Value:
00464 
00465     None.
00466 
00467 --*/
00468 
00469 {
00470 
00471     CONTEXT ContextFrame;
00472     EXCEPTION_RECORD ExceptionRecord1;
00473     PEXC_SUM ExceptionSummary;
00474     LONG Length;
00475     ULONG SoftFpcr;
00476     ULONGLONG UserStack1;
00477     ULONGLONG UserStack2;
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// If the exception is an illegal instruction exception, then check for</span>
00481     <span class="comment">// a byte/word instruction that should be emulated.</span>
00482     <span class="comment">//</span>
00483     <span class="comment">// N.B. The exception code STATUS_ILLEGAL_INSTRUCTION may be converted</span>
00484     <span class="comment">//      into STATUS_DATATYPE_MISALIGNMENT in the case of unaligned word</span>
00485     <span class="comment">//      access.</span>
00486     <span class="comment">//</span>
00487 
00488     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_ILLEGAL_INSTRUCTION) {
00489         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/byteem_8c.html#a2">KiEmulateByteWord</a>(ExceptionRecord,
00490                               ExceptionFrame,
00491                               TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00492             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeByteWordEmulationCount += 1;
00493             <span class="keywordflow">goto</span> Handled2;
00494         }
00495     }
00496 
00497 <span class="preprocessor">#if DBG</span>
00498 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (KiBreakOnAlignmentFault != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00499 
00500         <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) {
00501 
00502             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: Alignment fault exr = %p Pc = %p Address = %p\n"</span>,
00503                      ExceptionRecord,
00504                      ExceptionRecord-&gt;ExceptionAddress,
00505                      ExceptionRecord-&gt;ExceptionInformation[2]);
00506     
00507             DbgBreakPoint();
00508         }
00509     }
00510 <span class="preprocessor">#endif</span>
00511 <span class="preprocessor"></span>
00512     <span class="comment">//</span>
00513     <span class="comment">// If the exception is a data misalignment, the previous mode was user,</span>
00514     <span class="comment">// this is the first chance for handling the exception, and the current</span>
00515     <span class="comment">// thread has enabled automatic alignment fixup, then attempt to emulate</span>
00516     <span class="comment">// the unaligned reference.</span>
00517     <span class="comment">//</span>
00518 
00519     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) &amp;&amp;
00520         (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00521 
00522 <span class="preprocessor">#if DBG</span>
00523 <span class="preprocessor"></span>
00524         <span class="comment">//</span>
00525         <span class="comment">// Count alignment faults by mode and display them at intervals.</span>
00526         <span class="comment">//</span>
00527 
00528         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00529             KiKernelFixupCount += 1;
00530             <span class="keywordflow">if</span> ((KiKernelFixupCount &amp; KiKernelFixupMask) == 0) {
00531                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: Kernel Fixup: Pid=0x%.3lx, Pc=%.16p, Address=%.16p ... Total=%ld\n"</span>,
00532                          <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId,
00533                          ExceptionRecord-&gt;ExceptionAddress,
00534                          ExceptionRecord-&gt;ExceptionInformation[2],
00535                          KiKernelFixupCount);
00536             }
00537 
00538         } <span class="keywordflow">else</span> {
00539             KiUserFixupCount += 1;
00540             <span class="keywordflow">if</span> ((KiUserFixupCount &amp; KiUserFixupMask) == 0) {
00541                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KI: User  Fixup: Pid=0x%.3lx, Pc=%.16p, Address=%.16p ... Total=%ld\n"</span>,
00542                          <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId,
00543                          ExceptionRecord-&gt;ExceptionAddress,
00544                          ExceptionRecord-&gt;ExceptionInformation[2],
00545                          KiUserFixupCount);
00546             }
00547         }
00548 
00549 <span class="preprocessor">#endif</span>
00550 <span class="preprocessor"></span>
00551         <span class="comment">//</span>
00552         <span class="comment">// If alignment fault exceptions are not enabled, then no exception</span>
00553         <span class="comment">// should be raised and the data reference should be emulated.</span>
00554         <span class="comment">//</span>
00555         <span class="comment">// We will emulate the reference if</span>
00556         <span class="comment">//      KiEnableAlignmentFaultExceptions == 0 (always fix up all faults, the default)</span>
00557         <span class="comment">// OR   The thread has explicitly enabled alignment fixups</span>
00558         <span class="comment">// OR   KiEnableAlignmentFaultExceptions == 2 and the process is not being debugged</span>
00559         <span class="comment">//</span>
00560 
00561         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> == 0) ||
00562 
00563              ((<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00564               (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) ||
00565 
00566              (((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) &amp;&amp;
00567               (<a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> == 2)) ) {
00568 
00569             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a>(ExceptionRecord,
00570                                    ExceptionFrame,
00571                                    TrapFrame,
00572                                    FALSE) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00573                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeAlignmentFixupCount += 1;
00574                 <span class="keywordflow">goto</span> Handled2;
00575             }
00576         }
00577     }
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">// If the exception is a data bus error then a machine check has</span>
00581     <span class="comment">// been trapped by the PALcode. The error will be forwarded to the</span>
00582     <span class="comment">// HAL eventually for logging or handling. If the handler returns</span>
00583     <span class="comment">// it is assumed that the HAL successfully handled the error and</span>
00584     <span class="comment">// execution may resume.</span>
00585     <span class="comment">//</span>
00586     <span class="comment">// N.B. A special exception code is used to signal a data bus error.</span>
00587     <span class="comment">//      This code is equivalent to the bug check code merged with a</span>
00588     <span class="comment">//      reserved facility code and the reserved bit set.</span>
00589     <span class="comment">//</span>
00590 
00591     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == (<a class="code" href="../../d6/d7/halmips_8h.html#a2">DATA_BUS_ERROR</a> | 0xdfff0000)) {
00592         <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a2">KiMachineCheck</a>(ExceptionRecord, ExceptionFrame, TrapFrame);
00593         <span class="keywordflow">goto</span> Handled2;
00594     }
00595 
00596     <span class="comment">//</span>
00597     <span class="comment">// Initialize the copy of the software FPCR. The proper value is set</span>
00598     <span class="comment">// if a floating emulation operation is performed. Case on arithmetic</span>
00599     <span class="comment">// exception codes that require special handling by the kernel.</span>
00600     <span class="comment">//</span>
00601 
00602     SoftFpcr = 0;
00603     <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionCode) {
00604 
00605         <span class="comment">//</span>
00606         <span class="comment">// If the exception is a gentrap, then attempt to translate the</span>
00607         <span class="comment">// Alpha specific gentrap value to a status code value. This</span>
00608         <span class="comment">// exception is a precise trap.</span>
00609         <span class="comment">//</span>
00610         <span class="comment">// N.B. STATUS_ALPHA_GENTRAP is a pseudo status code generated by</span>
00611         <span class="comment">//      PALcode when a callpal gentrap is executed. The status is</span>
00612         <span class="comment">//      visible in user mode only when the gentrap code value is</span>
00613         <span class="comment">//      unrecognized.</span>
00614         <span class="comment">//</span>
00615 
00616     <span class="keywordflow">case</span> STATUS_ALPHA_GENTRAP :
00617         <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionInformation[0]) {
00618         <span class="keywordflow">case</span> GENTRAP_INTEGER_OVERFLOW :
00619             ExceptionRecord-&gt;ExceptionCode = STATUS_INTEGER_OVERFLOW;
00620             <span class="keywordflow">break</span>;
00621 
00622         <span class="keywordflow">case</span> GENTRAP_INTEGER_DIVIDE_BY_ZERO :
00623             ExceptionRecord-&gt;ExceptionCode = STATUS_INTEGER_DIVIDE_BY_ZERO;
00624             <span class="keywordflow">break</span>;
00625 
00626         <span class="keywordflow">case</span> GENTRAP_FLOATING_OVERFLOW :
00627             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_OVERFLOW;
00628             <span class="keywordflow">break</span>;
00629 
00630         <span class="keywordflow">case</span> GENTRAP_FLOATING_DIVIDE_BY_ZERO :
00631             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_DIVIDE_BY_ZERO;
00632             <span class="keywordflow">break</span>;
00633 
00634         <span class="keywordflow">case</span> GENTRAP_FLOATING_UNDERFLOW :
00635             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_UNDERFLOW;
00636             <span class="keywordflow">break</span>;
00637 
00638         <span class="keywordflow">case</span> GENTRAP_FLOATING_INVALID_OPERAND :
00639             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INVALID_OPERATION;
00640             <span class="keywordflow">break</span>;
00641 
00642         <span class="keywordflow">case</span> GENTRAP_FLOATING_INEXACT_RESULT :
00643             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INEXACT_RESULT;
00644             <span class="keywordflow">break</span>;
00645         }
00646         <span class="keywordflow">break</span>;
00647 
00648         <span class="comment">//</span>
00649         <span class="comment">// If the exception is an unimplemented floating operation, then</span>
00650         <span class="comment">// PALcode has detected a subsetted floating point operation. These</span>
00651         <span class="comment">// include attempts to use round to plus or minus infinity rounding</span>
00652         <span class="comment">// modes on EV4. This exception is a fault.</span>
00653         <span class="comment">//</span>
00654         <span class="comment">// If the previous mode was user, an attempt is made to emulate the</span>
00655         <span class="comment">// operation. If the emulation is successful, the continuation</span>
00656         <span class="comment">// address is incremented to the next instruction.</span>
00657         <span class="comment">//</span>
00658         <span class="comment">// N.B. STATUS_ALPHA_FLOATING_NOT_IMPLEMENTED is a pseudo status code</span>
00659         <span class="comment">//      generated by PALcode. The status is never visible outside of</span>
00660         <span class="comment">//      this handler because the floating emulation routine converts</span>
00661         <span class="comment">//      the status code to the proper floating status value.</span>
00662         <span class="comment">//</span>
00663 
00664     <span class="keywordflow">case</span> STATUS_ALPHA_FLOATING_NOT_IMPLEMENTED :
00665         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00666             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/trigger_8c.html#a11">KiFloatingException</a>(ExceptionRecord,
00667                                     ExceptionFrame,
00668                                     TrapFrame,
00669                                     FALSE,
00670                                     &amp;SoftFpcr) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00671                 TrapFrame-&gt;Fir += 4;
00672                 <span class="keywordflow">goto</span> Handled2;
00673             }
00674 
00675         } <span class="keywordflow">else</span> {
00676             ExceptionRecord-&gt;ExceptionCode = STATUS_ILLEGAL_INSTRUCTION;
00677         }
00678 
00679         <span class="keywordflow">break</span>;
00680 
00681         <span class="comment">//</span>
00682         <span class="comment">// If the exception is an arithmetic exception, then one or more</span>
00683         <span class="comment">// integer overflow or floating point traps has occurred. This</span>
00684         <span class="comment">// exception is an imprecise (asynchronous) trap. Attempt to locate </span>
00685         <span class="comment">// the original trapping instruction and emulate the instruction.</span>
00686         <span class="comment">//</span>
00687         <span class="comment">// N.B. STATUS_ALPHA_ARITHMETIC_EXCEPTION is a pseudo status code</span>
00688         <span class="comment">//      generated by PALcode. The status is never visible outside of</span>
00689         <span class="comment">//      this handler because the floating emulation routine converts</span>
00690         <span class="comment">//      the status code to the proper floating status value.</span>
00691         <span class="comment">//</span>
00692 
00693     <span class="keywordflow">case</span> STATUS_ALPHA_ARITHMETIC_EXCEPTION :
00694         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/trigger_8c.html#a11">KiFloatingException</a>(ExceptionRecord,
00695                                 ExceptionFrame,
00696                                 TrapFrame,
00697                                 TRUE,
00698                                 &amp;SoftFpcr) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00699             <span class="keywordflow">goto</span> Handled2;
00700         }
00701         <span class="keywordflow">break</span>;
00702     }
00703 
00704     <span class="comment">//</span>
00705     <span class="comment">// Move machine state from trap and exception frames to a context frame,</span>
00706     <span class="comment">// and increment the number of exceptions dispatched.</span>
00707     <span class="comment">//</span>
00708     <span class="comment">// Explicitly set the value of the software FPCR in the context frame</span>
00709     <span class="comment">// (because it is not a hardware register and thus not present in the</span>
00710     <span class="comment">// trap or exception frames).</span>
00711     <span class="comment">//</span>
00712 
00713     ContextFrame.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00714     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame);
00715     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeExceptionDispatchCount += 1;
00716     ContextFrame.SoftFpcr = (ULONGLONG)SoftFpcr;
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Select the method of handling the exception based on the previous mode.</span>
00720     <span class="comment">//</span>
00721 
00722     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00723 
00724         <span class="comment">//</span>
00725         <span class="comment">// If the kernel debugger is active, the exception is a breakpoint,</span>
00726         <span class="comment">// the breakpoint is handled by the kernel debugger, and this is the</span>
00727         <span class="comment">// first chance, then give the kernel debugger a chance to handle</span>
00728         <span class="comment">// the exception.</span>
00729         <span class="comment">//</span>
00730 
00731         <span class="keywordflow">if</span> ((FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00732            (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00733            (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00734                             &amp;ContextFrame,
00735                             KernelMode) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00736 
00737            (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00738                                ExceptionFrame,
00739                                ExceptionRecord,
00740                                &amp;ContextFrame,
00741                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00742                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00743 
00744             <span class="keywordflow">goto</span> Handled1;
00745         }
00746 
00747 
00748         <span class="comment">//</span>
00749         <span class="comment">// Previous mode was kernel.</span>
00750         <span class="comment">//</span>
00751         <span class="comment">// If this is the first chance, then attempt to dispatch the exception</span>
00752         <span class="comment">// to a frame based handler. If the exception is handled, then continue</span>
00753         <span class="comment">// execution.</span>
00754         <span class="comment">//</span>
00755         <span class="comment">// If this is the second chance or the exception is not handled,</span>
00756         <span class="comment">// then if the kernel debugger is active, then give the kernel</span>
00757         <span class="comment">// debugger a second chance to handle the exception. If the kernel</span>
00758         <span class="comment">// debugger handles the exception, then continue execution. Otherwise</span>
00759         <span class="comment">// bug check.</span>
00760         <span class="comment">//</span>
00761 
00762         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00763 
00764             <span class="comment">//</span>
00765             <span class="comment">// This is the first chance to handle the exception.</span>
00766             <span class="comment">//</span>
00767 
00768             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a7">RtlDispatchException</a>(ExceptionRecord, &amp;ContextFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00769                 <span class="keywordflow">goto</span> Handled1;
00770             }
00771         }
00772 
00773         <span class="comment">//</span>
00774         <span class="comment">// This is the second chance to handle the exception.</span>
00775         <span class="comment">//</span>
00776 
00777         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00778            (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00779                                ExceptionFrame,
00780                                ExceptionRecord,
00781                                &amp;ContextFrame,
00782                                PreviousMode,
00783                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00784 
00785             <span class="keywordflow">goto</span> Handled1;
00786         }
00787 
00788         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(KMODE_EXCEPTION_NOT_HANDLED,
00789                      ExceptionRecord-&gt;ExceptionCode,
00790                      (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress,
00791                      ExceptionRecord-&gt;ExceptionInformation[0],
00792                      ExceptionRecord-&gt;ExceptionInformation[1]);
00793 
00794     } <span class="keywordflow">else</span> {
00795 
00796         <span class="comment">//</span>
00797         <span class="comment">// If the kernel debugger is active, the exception is a breakpoint,</span>
00798         <span class="comment">// the breakpoint is handled by the kernel debugger, and this is the</span>
00799         <span class="comment">// first chance, then give the kernel debugger a chance to handle</span>
00800         <span class="comment">// the exception.</span>
00801         <span class="comment">//</span>
00802 
00803         <span class="keywordflow">if</span> ((FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00804             (<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00805             (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00806             (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00807                              &amp;ContextFrame,
00808                              UserMode) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00809 
00810             ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00811              ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00812               (ExceptionRecord-&gt;ExceptionInformation[0] !=
00813                                             DEBUG_STOP_BREAKPOINT)))) {
00814 
00815               <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00816                                      ExceptionFrame,
00817                                      ExceptionRecord,
00818                                      &amp;ContextFrame,
00819                                      <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00820                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00821 
00822                      <span class="keywordflow">goto</span> Handled1;
00823               }
00824         }
00825 
00826         <span class="comment">//</span>
00827         <span class="comment">// Previous mode was user.</span>
00828         <span class="comment">//</span>
00829         <span class="comment">// If this is the first chance and the current process has a debugger</span>
00830         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00831         <span class="comment">// If the debugger handles the exception, then continue execution. Otherwise</span>
00832         <span class="comment">// transfer the exception information to the user stack, transition to</span>
00833         <span class="comment">// user mode, and attempt to dispatch the exception to a frame based</span>
00834         <span class="comment">// handler. If a frame based handler handles the exception, then continue</span>
00835         <span class="comment">// execution. Otherwise, execute the raise exception system service</span>
00836         <span class="comment">// which will call this routine a second time to process the exception.</span>
00837         <span class="comment">//</span>
00838         <span class="comment">// If this is the second chance and the current process has a debugger</span>
00839         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00840         <span class="comment">// If the debugger handles the exception, then continue execution. Otherwise</span>
00841         <span class="comment">// if the current process has a subsystem port, then send a message to</span>
00842         <span class="comment">// the subsystem port and wait for a reply. If the subsystem handles the</span>
00843         <span class="comment">// exception, then continue execution. Otherwise terminate the thread.</span>
00844         <span class="comment">//</span>
00845 
00846         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00847 
00848             <span class="comment">//</span>
00849             <span class="comment">// This is the first chance to handle the exception.</span>
00850             <span class="comment">//</span>
00851 
00852             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, TRUE, FALSE)) {
00853                 <span class="keywordflow">goto</span> Handled2;
00854             }
00855 
00856             <span class="comment">//</span>
00857             <span class="comment">// Transfer exception information to the user stack, transition</span>
00858             <span class="comment">// to user mode, and attempt to dispatch the exception to a frame</span>
00859             <span class="comment">// based handler.</span>
00860             <span class="comment">//</span>
00861 
00862         repeat:
00863             <span class="keywordflow">try</span> {
00864 
00865                 <span class="comment">//</span>
00866                 <span class="comment">// Compute length of exception record and new aligned stack</span>
00867                 <span class="comment">// address.</span>
00868                 <span class="comment">//</span>
00869 
00870                 Length = (<span class="keyword">sizeof</span>(EXCEPTION_RECORD) + 15) &amp; (~15);
00871                 UserStack1 = (ContextFrame.IntSp &amp; ~((ULONG_PTR)15)) - Length;
00872 
00873                 <span class="comment">//</span>
00874                 <span class="comment">// Probe user stack area for writability and then transfer the</span>
00875                 <span class="comment">// exception record to the user stack area.</span>
00876                 <span class="comment">//</span>
00877 
00878                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PCHAR)UserStack1, Length, <span class="keyword">sizeof</span>(QUAD));
00879                 RtlMoveMemory((PVOID)UserStack1, ExceptionRecord, Length);
00880 
00881                 <span class="comment">//</span>
00882                 <span class="comment">// Compute length of context record and new aligned user stack</span>
00883                 <span class="comment">// pointer.</span>
00884                 <span class="comment">//</span>
00885 
00886                 Length = (<span class="keyword">sizeof</span>(CONTEXT) + 15) &amp; (~15);
00887                 UserStack2 = UserStack1 - Length;
00888 
00889                 <span class="comment">//</span>
00890                 <span class="comment">// Probe user stack area for writability and then transfer the</span>
00891                 <span class="comment">// context record to the user stack.</span>
00892                 <span class="comment">//</span>
00893 
00894                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PCHAR)UserStack2, Length, <span class="keyword">sizeof</span>(QUAD));
00895                 RtlMoveMemory((PVOID)UserStack2, &amp;ContextFrame, <span class="keyword">sizeof</span>(CONTEXT));
00896 
00897                 <span class="comment">//</span>
00898                 <span class="comment">// Set address of exception record, context record, and the</span>
00899                 <span class="comment">// and the new stack pointer in the current trap frame.</span>
00900                 <span class="comment">//</span>
00901 
00902                 TrapFrame-&gt;IntSp = UserStack2;
00903                 TrapFrame-&gt;IntFp = UserStack2;
00904                 ExceptionFrame-&gt;IntS0 = UserStack1;
00905                 ExceptionFrame-&gt;IntS1 = UserStack2;
00906 
00907                 <span class="comment">//</span>
00908                 <span class="comment">// Set the address of the exception routine that will call the</span>
00909                 <span class="comment">// exception dispatcher and then return to the trap handler.</span>
00910                 <span class="comment">// The trap handler will restore the exception and trap frame</span>
00911                 <span class="comment">// context and continue execution in the routine that will</span>
00912                 <span class="comment">// call the exception dispatcher.</span>
00913                 <span class="comment">//</span>
00914 
00915                 TrapFrame-&gt;Fir = (ULONGLONG)(LONG_PTR)<a class="code" href="../../d4/d9/ke_8h.html#a150">KeUserExceptionDispatcher</a>;
00916                 <span class="keywordflow">return</span>;
00917 
00918             <span class="comment">//</span>
00919             <span class="comment">// If an exception occurs, then copy the new exception information</span>
00920             <span class="comment">// to an exception record and handle the exception.</span>
00921             <span class="comment">//</span>
00922 
00923             } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(&amp;ExceptionRecord1,
00924                                (GetExceptionInformation())-&gt;ExceptionRecord)) {
00925 
00926                 <span class="comment">//</span>
00927                 <span class="comment">// If the exception is a stack overflow, then attempt</span>
00928                 <span class="comment">// to raise the stack overflow exception. Otherwise,</span>
00929                 <span class="comment">// the user's stack is not accessible, or is misaligned,</span>
00930                 <span class="comment">// and second chance processing is performed.</span>
00931                 <span class="comment">//</span>
00932 
00933                 <span class="keywordflow">if</span> (ExceptionRecord1.ExceptionCode == STATUS_STACK_OVERFLOW) {
00934                     ExceptionRecord1.ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00935                     RtlMoveMemory((PVOID)ExceptionRecord,
00936                                   &amp;ExceptionRecord1, <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00937                     <span class="keywordflow">goto</span> repeat;
00938                 }
00939             }
00940         }
00941 
00942         <span class="comment">//</span>
00943         <span class="comment">// This is the second chance to handle the exception.</span>
00944         <span class="comment">//</span>
00945 
00946         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, TRUE, TRUE)) {
00947             <span class="keywordflow">goto</span> Handled2;
00948 
00949         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, FALSE, TRUE)) {
00950             <span class="keywordflow">goto</span> Handled2;
00951 
00952         } <span class="keywordflow">else</span> {
00953             ZwTerminateProcess(NtCurrentProcess(), ExceptionRecord-&gt;ExceptionCode);
00954             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(KMODE_EXCEPTION_NOT_HANDLED,
00955                          ExceptionRecord-&gt;ExceptionCode,
00956                          (ULONG_PTR)ExceptionRecord-&gt;ExceptionAddress,
00957                          ExceptionRecord-&gt;ExceptionInformation[0],
00958                          ExceptionRecord-&gt;ExceptionInformation[1]);
00959 
00960         }
00961     }
00962 
00963     <span class="comment">//</span>
00964     <span class="comment">// Move machine state from context frame to trap and exception frames and</span>
00965     <span class="comment">// then return to continue execution with the restored state.</span>
00966     <span class="comment">//</span>
00967 
00968 Handled1:
00969     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame,
00970                        ContextFrame.ContextFlags, PreviousMode);
00971 
00972     <span class="comment">//</span>
00973     <span class="comment">// Exception was handled by the debugger or the associated subsystem</span>
00974     <span class="comment">// and state was modified, if necessary, using the get state and set</span>
00975     <span class="comment">// state capabilities. Therefore the context frame does not need to</span>
00976     <span class="comment">// be transferred to the trap and exception frames.</span>
00977     <span class="comment">//</span>
00978 
00979 Handled2:
00980     <span class="keywordflow">return</span>;
00981 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="alpha/exceptn.c::KiMachineCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiMachineCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/alpha_2buserror_8c-source.html#l00031">31</a> of file <a class="el" href="../../d1/d1/alpha_2buserror_8c-source.html">alpha/buserror.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00014">DATA_BUS_ERROR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, and <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00412">KiDispatchException()</a>.
<p>
<pre class="fragment"><div>00039                    :
00040 
00041     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to process a machine check.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> vendor
00042     has supplied a machine check handler with its <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a> then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> machine
00043     check handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicating
00044     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error has been handled then execution resumes, otherwise,
00045     a bugcheck <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
00046 
00047     If no machine check handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> registered or <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not indicate
00048     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error has been handled, then <span class="keyword">this</span> routine will attempt
00049     <span class="keywordflow">default</span> handling.  Default handling consists of checking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00050     machine check status in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception record.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status indicates
00051     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> machine check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> correctable or retryable then <span class="keywordflow">return</span> and
00052     resume execution, otherwise a bugcheck <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
00053 
00054 Arguments:
00055 
00056     ExceptionRecord - Supplies a pointer to an exception record.
00057 
00058     ExceptionFrame - Supplies a pointer to an exception frame.
00059 
00060     TrapFrame - Supplies a pointer to a trap frame.
00061 
00062 Return Value:
00063 
00064     None.
00065 
00066 --*/
00067 
00068 {
00069 
00070     <span class="keywordflow">if</span>( ((ULONG_PTR)PCR-&gt;MachineCheckError != 0) &amp;&amp;
00071           (PCR-&gt;MachineCheckError)(ExceptionRecord,
00072                                    ExceptionFrame,
00073                                    TrapFrame) ) {
00074 
00075         <span class="comment">//</span>
00076         <span class="comment">// The HAL has handled the error.</span>
00077         <span class="comment">//</span>
00078 
00079         <span class="keywordflow">return</span>;
00080 
00081     } <span class="keywordflow">else</span> {
00082 
00083         <span class="comment">//</span>
00084         <span class="comment">// Either there is no HAL handler, or it did not handle the</span>
00085         <span class="comment">// error.</span>
00086         <span class="comment">//</span>
00087 
00088         <span class="keywordflow">if</span>( ExceptionRecord-&gt;ExceptionInformation[0] != 0 ){
00089 
00090             <span class="comment">//</span>
00091             <span class="comment">// The error is either correctable or retryable, resume</span>
00092             <span class="comment">// execution.</span>
00093             <span class="comment">//</span>
00094 
00095 <span class="preprocessor">#if DBG</span>
00096 <span class="preprocessor"></span>
00097             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MCHK: resuming correctable or retryable error\n"</span> );
00098 
00099 <span class="preprocessor">#endif //DBG</span>
00100 <span class="preprocessor"></span>
00101             <span class="keywordflow">return</span>;
00102 
00103         }
00104     }
00105 
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">// The error was not handled and is not correctable or retryable.</span>
00109     <span class="comment">//</span>
00110 
00111     <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(DATA_BUS_ERROR);
00112 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="alpha/exceptn.c::KiEnableAlignmentFaultExceptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d9/ppc_2exceptn_8c.html#a6">KiEnableAlignmentFaultExceptions</a> = DEFAULT_NO_ALIGNMENT_FIXUPS ? 1 : 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00077">77</a> of file <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html">alpha/exceptn.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/alpha_2alignem_8c-source.html#l00125">KiDisableAlignmentExceptions()</a>, and <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00412">KiDispatchException()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
