<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sysload.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sysload.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d9/d7/sysload_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">_LOAD_IMPORTS</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)-2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a2">SINGLE_ENTRY</a>(ImportVoid)&nbsp;&nbsp;&nbsp;((ULONG)((ULONG_PTR)(ImportVoid) &amp; 0x1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a3">SINGLE_ENTRY_TO_POINTER</a>(ImportVoid)&nbsp;&nbsp;&nbsp;((PLDR_DATA_TABLE_ENTRY)((ULONG_PTR)(ImportVoid) &amp; ~0x1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a4">POINTER_TO_SINGLE_ENTRY</a>(Pointer)&nbsp;&nbsp;&nbsp;((PLDR_DATA_TABLE_ENTRY)((ULONG_PTR)(Pointer) | 0x1))</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">_LOAD_IMPORTS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a5">LOAD_IMPORTS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">_LOAD_IMPORTS</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a29">LdrDoubleRelocateImage</a> (IN PVOID NewBase, IN PVOID CurrentBase, IN PUCHAR LoaderName, IN ULONG Success, IN ULONG Conflict, IN ULONG Invalid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols</a> (IN PVOID ImageBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a31">MiResolveImageReferences</a> (PVOID ImageBase, IN PUNICODE_STRING ImageFileDirectory, IN PUNICODE_STRING NamePrefix OPTIONAL, IN BOOLEAN LoadInSessionSpace, OUT PCHAR *MissingProcedureName, OUT PWSTR *MissingDriverName, OUT <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a> *LoadedImports)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a32">MiSnapThunk</a> (IN PVOID DllBase, IN PVOID ImageBase, IN PIMAGE_THUNK_DATA NameThunk, OUT PIMAGE_THUNK_DATA AddrThunk, IN PIMAGE_EXPORT_DIRECTORY ExportDirectory, IN ULONG ExportSize, IN BOOLEAN SnapForwarder, OUT PCHAR *MissingProcedureName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a33">MiLoadImageSection</a> (IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a> SectionPointer, OUT PVOID *ImageBase, IN PUNICODE_STRING ImageFileName, IN BOOLEAN LoadInSessionSpace)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a34">MiEnablePagingOfDriver</a> (IN PVOID ImageHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte, IN BOOLEAN SessionSpace)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a36">MiLookupImageSectionByName</a> (IN PVOID Base, IN BOOLEAN MappedAsImage, IN PCHAR SectionName, OUT PULONG SectionSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a37">MiClearImports</a> (IN PLDR_DATA_TABLE_ENTRY DataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a38">MiBuildImportsForBootDrivers</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a39">MmCheckSystemImage</a> (IN HANDLE ImageFileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a40">MiMapCacheExceptionFilter</a> (OUT PNTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, IN PEXCEPTION_POINTERS ExceptionPointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN ULONG ProtectionMask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (IN <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a> ImportList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a43">MiCallDllUnloadAndUnloadDll</a> (IN PLDR_DATA_TABLE_ENTRY DataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (IN PVOID DllBase, IN PCHAR FunctionName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a45">MiLoadSystemImage</a> (IN PUNICODE_STRING ImageFileName, IN PUNICODE_STRING NamePrefix OPTIONAL, IN PUNICODE_STRING LoadedBaseName OPTIONAL, IN BOOLEAN LoadInSessionSpace, OUT PVOID *ImageHandle, OUT PVOID *ImageBaseAddress, IN BOOLEAN LockDownPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a46">MiRememberUnloadedDriver</a> (IN PUNICODE_STRING DriverName, IN PVOID Address, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage</a> (IN PVOID DllBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a48">MiLocateKernelSections</a> (IN PLDR_DATA_TABLE_ENTRY DataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a49">MiUpdateThunks</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, IN PVOID OldAddress, IN PVOID NewAddress, IN ULONG NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a50">MiCheckPageFilePath</a> (<a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a51">MiFindExportedRoutineByName</a> (IN PLDR_DATA_TABLE_ENTRY DataTableEntry, IN PANSI_STRING AnsiImageRoutineName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a52">MiRemoveLowPages</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a53">MmLoadSystemImage</a> (IN PUNICODE_STRING ImageFileName, IN PUNICODE_STRING NamePrefix OPTIONAL, IN PUNICODE_STRING LoadedBaseName OPTIONAL, IN BOOLEAN LoadInSessionSpace, OUT PVOID *ImageHandle, OUT PVOID *ImageBaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a54">MmLoadAndLockSystemImage</a> (IN PUNICODE_STRING ImageFileName, IN PUNICODE_STRING NamePrefix OPTIONAL, IN PUNICODE_STRING LoadedBaseName OPTIONAL, OUT PVOID *ImageHandle, OUT PVOID *ImageBaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a55">MmFreeDriverInitialization</a> (IN PVOID ImageHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a56">MmPageEntireDriver</a> (IN PVOID AddressWithinSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a57">MmResetDriverPaging</a> (IN PVOID AddressWithinSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PUNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a58">MmLocateUnloadedDriver</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> (IN PVOID ImageHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a60">MmVerifyImageIsOkForMpUse</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN PFN_NUMBER NumberOfPtes, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewPteValue, IN LOGICAL SessionAllocation, OUT PPFN_NUMBER ResidentPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a62">MiSetImageProtect</a> (IN <a class="el" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a> Segment, IN ULONG Protection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a63">MiSetSystemCodeProtection</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a64">MiReloadBootLoadedDrivers</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a65">MmMakeKernelResourceSectionWritable</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a66">MiInitializeLoadedModuleList</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a67">MmCallDllInitialize</a> (IN PLDR_DATA_TABLE_ENTRY DataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a68">MmGetSystemRoutineAddress</a> (IN PUNICODE_STRING SystemRoutineName)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a7">MmSystemLoadLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a8">MmTotalSystemDriverPages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a9">MmDriverCommit</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a10">MiFirstDriverLoadEver</a> = TRUE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a11">MmMakeLowMemory</a> = TRUE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a12">MiUnloadedDrivers</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a13">MiLastUnloadedDriver</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a14">MiTotalUnloads</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a15">MiUnloadsSkipped</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a16">MmEnforceWriteProtection</a> = 1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a17">ExPoolCodeStart</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a18">ExPoolCodeEnd</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a19">MmPoolCodeStart</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a20">MmPoolCodeEnd</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a21">MmPteCodeStart</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a22">MmPteCodeEnd</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a23">PsLoadedModuleSpinLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a24">MiNoLowMemory</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d1/bench_8h.html#a8">CHAR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a25">MiPteStr</a> [] = "\0"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a26">PsNtosImageBase</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a27">PsLoadedModuleList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/sysload_8c.html#a28">PsLoadedModuleResource</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="sysload.c::LOADED_AT_BOOT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOADED_AT_BOOT&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)0)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00046">46</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03326">MiBuildImportsForBootDrivers()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02693">MiClearImports()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">MiDereferenceImports()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="sysload.c::NO_IMPORTS_USED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NO_IMPORTS_USED&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)-2)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00047">47</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03326">MiBuildImportsForBootDrivers()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02693">MiClearImports()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">MiDereferenceImports()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="sysload.c::POINTER_TO_SINGLE_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define POINTER_TO_SINGLE_ENTRY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Pointer&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PLDR_DATA_TABLE_ENTRY)((ULONG_PTR)(Pointer) | 0x1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00053">53</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03326">MiBuildImportsForBootDrivers()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="sysload.c::SINGLE_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SINGLE_ENTRY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ImportVoid&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)((ULONG_PTR)(ImportVoid) &amp; 0x1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00049">49</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03326">MiBuildImportsForBootDrivers()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02693">MiClearImports()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">MiDereferenceImports()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="sysload.c::SINGLE_ENTRY_TO_POINTER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SINGLE_ENTRY_TO_POINTER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ImportVoid&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PLDR_DATA_TABLE_ENTRY)((ULONG_PTR)(ImportVoid) &amp; ~0x1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00051">51</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">MiDereferenceImports()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a5" doxytag="sysload.c::LOAD_IMPORTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">_LOAD_IMPORTS</a>  <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">LOAD_IMPORTS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="sysload.c::PLOAD_IMPORTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">_LOAD_IMPORTS</a> * <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03326">MiBuildImportsForBootDrivers()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">MiDereferenceImports()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a30" doxytag="sysload.c::CacheImageSymbols" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CacheImageSymbols           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="sysload.c::LdrDoubleRelocateImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG LdrDoubleRelocateImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NewBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Success</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Conflict</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Invalid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="sysload.c::MiBuildImportsForBootDrivers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiBuildImportsForBootDrivers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l03326">3326</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00042">_LOAD_IMPORTS::Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00043">_LOAD_IMPORTS::Entry</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00046">LOADED_AT_BOOT</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00047">NO_IMPORTS_USED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00053">POINTER_TO_SINGLE_ENTRY</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00049">SINGLE_ENTRY</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l06591">MiInitializeLoadedModuleList()</a>.
<p>
<pre class="fragment"><div>03332                    :
03333 
03334     Construct an <span class="keyword">import</span> list chain <span class="keywordflow">for</span> boot-loaded drivers.
03335     If <span class="keyword">this</span> cannot be done <span class="keywordflow">for</span> an entry, its chain <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>.
03336 
03337     If a chain can be successfully built, then <span class="keyword">this</span> driver's DLLs
03338     will be automatically unloaded <span class="keywordflow">if</span> <span class="keyword">this</span> driver goes away (provided
03339     no other driver is also <span class="keyword">using</span> them).  Otherwise, on driver unload,
03340     its dependent DLLs would have to be explicitly unloaded.
03341 
03342     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> incoming LoadCount values are not correct and thus, they
03343     are reinitialized here.
03344 
03345 Arguments:
03346 
03347     None.
03348 
03349 Return Value:
03350 
03351     Various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> codes.
03352 
03353 --*/
03354 
03355 {
03356     PLDR_DATA_TABLE_ENTRY DataTableEntry;
03357     PLIST_ENTRY NextEntry;
03358     PLDR_DATA_TABLE_ENTRY DataTableEntry2;
03359     PLIST_ENTRY NextEntry2;
03360     ULONG i;
03361     ULONG j;
03362     ULONG ImageCount;
03363     PVOID *ImageReferences;
03364     PVOID LastImageReference;
03365     PULONG_PTR ImportThunk;
03366     ULONG_PTR BaseAddress;
03367     ULONG_PTR LastAddress;
03368     ULONG ImportSize;
03369     ULONG ImportListSize;
03370     <a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a> ImportList;
03371     LOGICAL UndoEverything;
03372     PLDR_DATA_TABLE_ENTRY KernelDataTableEntry;
03373     PLDR_DATA_TABLE_ENTRY HalDataTableEntry;
03374     UNICODE_STRING KernelString;
03375     UNICODE_STRING HalString;
03376 
03377     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03378 
03379     ImageCount = 0;
03380 
03381     KernelDataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03382     HalDataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03383 
03384     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;KernelString, L<span class="stringliteral">"ntoskrnl.exe"</span>);
03385     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;HalString, L<span class="stringliteral">"hal.dll"</span>);
03386 
03387     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03388     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
03389 
03390         DataTableEntry = CONTAINING_RECORD(NextEntry,
03391                                            LDR_DATA_TABLE_ENTRY,
03392                                            InLoadOrderLinks);
03393 
03394         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;KernelString,
03395                                    &amp;DataTableEntry-&gt;BaseDllName,
03396                                    TRUE)) {
03397 
03398             KernelDataTableEntry = CONTAINING_RECORD(NextEntry,
03399                                                      LDR_DATA_TABLE_ENTRY,
03400                                                      InLoadOrderLinks);
03401         }
03402         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;HalString,
03403                                         &amp;DataTableEntry-&gt;BaseDllName,
03404                                         TRUE)) {
03405 
03406             HalDataTableEntry = CONTAINING_RECORD(NextEntry,
03407                                                   LDR_DATA_TABLE_ENTRY,
03408                                                   InLoadOrderLinks);
03409         }
03410 
03411         <span class="comment">//</span>
03412         <span class="comment">// Initialize these properly so error recovery is simplified.</span>
03413         <span class="comment">//</span>
03414 
03415         DataTableEntry-&gt;LoadCount = 1;
03416         DataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
03417 
03418         ImageCount += 1;
03419         NextEntry = NextEntry-&gt;Flink;
03420     }
03421 
03422     <span class="keywordflow">if</span> (KernelDataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || HalDataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03423         <span class="keywordflow">return</span> STATUS_NOT_FOUND;
03424     }
03425 
03426     ImageReferences = (PVOID *) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
03427                                                        ImageCount * <span class="keyword">sizeof</span> (PVOID),
03428                                                        'TDmM');
03429 
03430     <span class="keywordflow">if</span> (ImageReferences == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03431         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03432     }
03433 
03434     UndoEverything = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03435 
03436     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03437 
03438     <span class="keywordflow">for</span> ( ; NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>; NextEntry = NextEntry-&gt;Flink) {
03439 
03440         DataTableEntry = CONTAINING_RECORD(NextEntry,
03441                                            LDR_DATA_TABLE_ENTRY,
03442                                            InLoadOrderLinks);
03443 
03444         ImportThunk = (PULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
03445                                            DataTableEntry-&gt;DllBase,
03446                                            TRUE,
03447                                            IMAGE_DIRECTORY_ENTRY_IAT,
03448                                            &amp;ImportSize);
03449     
03450         <span class="keywordflow">if</span> (ImportThunk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03451             DataTableEntry-&gt;LoadedImports = <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
03452             <span class="keywordflow">continue</span>;
03453         }
03454     
03455         RtlZeroMemory (ImageReferences, ImageCount * <span class="keyword">sizeof</span> (PVOID));
03456 
03457         ImportSize /= <span class="keyword">sizeof</span>(PULONG_PTR);
03458 
03459         BaseAddress = 0;
03460         <span class="keywordflow">for</span> (i = 0; i &lt; ImportSize; i += 1, ImportThunk += 1) {
03461 
03462             <span class="comment">//</span>
03463             <span class="comment">// Check the hint first.</span>
03464             <span class="comment">//</span>
03465 
03466             <span class="keywordflow">if</span> (BaseAddress) {
03467                 <span class="keywordflow">if</span> (*ImportThunk &gt;= BaseAddress &amp;&amp; *ImportThunk &lt; LastAddress) {
03468                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ImageReferences[j]);
03469                     <span class="keywordflow">continue</span>;
03470                 }
03471             }
03472 
03473             j = 0;
03474             NextEntry2 = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03475 
03476             <span class="keywordflow">while</span> (NextEntry2 != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
03477 
03478                 DataTableEntry2 = CONTAINING_RECORD(NextEntry2,
03479                                                     LDR_DATA_TABLE_ENTRY,
03480                                                     InLoadOrderLinks);
03481     
03482                 BaseAddress = (ULONG_PTR) DataTableEntry2-&gt;DllBase;
03483                 LastAddress = BaseAddress + DataTableEntry2-&gt;SizeOfImage;
03484 
03485                 <span class="keywordflow">if</span> (*ImportThunk &gt;= BaseAddress &amp;&amp; *ImportThunk &lt; LastAddress) {
03486                     ImageReferences[j] = DataTableEntry2;
03487                     <span class="keywordflow">break</span>;
03488                 }
03489 
03490                 NextEntry2 = NextEntry2-&gt;Flink;
03491                 j += 1;
03492             }
03493 
03494             <span class="keywordflow">if</span> (*ImportThunk &lt; BaseAddress || *ImportThunk &gt;= LastAddress) {
03495                 <span class="keywordflow">if</span> (*ImportThunk) {
03496 <span class="preprocessor">#if DBG</span>
03497 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: broken import linkage %p %p %p\n"</span>,
03498                         DataTableEntry,
03499                         ImportThunk,
03500                         *ImportThunk);
03501                     DbgBreakPoint ();
03502 <span class="preprocessor">#endif</span>
03503 <span class="preprocessor"></span>                    UndoEverything = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03504                     <span class="keywordflow">goto</span> finished;
03505                 }
03506 
03507                 BaseAddress = 0;
03508             }
03509         }
03510 
03511         ImportSize = 0;
03512 
03513         <span class="keywordflow">for</span> (i = 0; i &lt; ImageCount; i += 1) {
03514 
03515             <span class="keywordflow">if</span> ((ImageReferences[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03516                 (ImageReferences[i] != KernelDataTableEntry) &amp;&amp;
03517                 (ImageReferences[i] != HalDataTableEntry)) {
03518 
03519                     LastImageReference = ImageReferences[i];
03520                     ImportSize += 1;
03521             }
03522         }
03523 
03524         <span class="keywordflow">if</span> (ImportSize == 0) {
03525             DataTableEntry-&gt;LoadedImports = <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
03526         }
03527         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ImportSize == 1) {
03528 <span class="preprocessor">#if DBG_SYSLOAD</span>
03529 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ imports %wZ\n"</span>,
03530                 &amp;DataTableEntry-&gt;FullDllName,
03531                 &amp;((PLDR_DATA_TABLE_ENTRY)LastImageReference)-&gt;FullDllName);
03532 <span class="preprocessor">#endif</span>
03533 <span class="preprocessor"></span>
03534             DataTableEntry-&gt;LoadedImports = <a class="code" href="../../d8/d8/sysload_8c.html#a4">POINTER_TO_SINGLE_ENTRY</a> (LastImageReference);
03535             ((PLDR_DATA_TABLE_ENTRY)LastImageReference)-&gt;LoadCount += 1;
03536         }
03537         <span class="keywordflow">else</span> {
03538 <span class="preprocessor">#if DBG_SYSLOAD</span>
03539 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ imports many\n"</span>, &amp;DataTableEntry-&gt;FullDllName);
03540 <span class="preprocessor">#endif</span>
03541 <span class="preprocessor"></span>
03542             ImportListSize = ImportSize * <span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(SIZE_T);
03543 
03544             ImportList = (<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
03545                                                                 ImportListSize,
03546                                                                 'TDmM');
03547 
03548             <span class="keywordflow">if</span> (ImportList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03549                 UndoEverything = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03550                 <span class="keywordflow">break</span>;
03551             }
03552 
03553             ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a> = ImportSize;
03554 
03555             j = 0;
03556             <span class="keywordflow">for</span> (i = 0; i &lt; ImageCount; i += 1) {
03557     
03558                 <span class="keywordflow">if</span> ((ImageReferences[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03559                     (ImageReferences[i] != KernelDataTableEntry) &amp;&amp;
03560                     (ImageReferences[i] != HalDataTableEntry)) {
03561     
03562 <span class="preprocessor">#if DBG_SYSLOAD</span>
03563 <span class="preprocessor"></span>                        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ imports %wZ\n"</span>,
03564                             &amp;DataTableEntry-&gt;FullDllName,
03565                             &amp;((PLDR_DATA_TABLE_ENTRY)ImageReferences[i])-&gt;FullDllName);
03566 <span class="preprocessor">#endif</span>
03567 <span class="preprocessor"></span>
03568                         ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[j] = ImageReferences[i];
03569                         ((PLDR_DATA_TABLE_ENTRY)ImageReferences[i])-&gt;LoadCount += 1;
03570                         j += 1;
03571                 }
03572             }
03573 
03574             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (j == ImportSize);
03575 
03576             DataTableEntry-&gt;LoadedImports = ImportList;
03577         }
03578 <span class="preprocessor">#if DBG_SYSLOAD</span>
03579 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
03580 <span class="preprocessor">#endif</span>
03581 <span class="preprocessor"></span>    }
03582 
03583 finished:
03584 
03585     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((PVOID)ImageReferences);
03586 
03587     <span class="comment">//</span>
03588     <span class="comment">// The kernel and HAL are never unloaded.</span>
03589     <span class="comment">//</span>
03590 
03591     <span class="keywordflow">if</span> ((KernelDataTableEntry-&gt;LoadedImports != <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) &amp;&amp;
03592         (!<a class="code" href="../../d8/d8/sysload_8c.html#a4">POINTER_TO_SINGLE_ENTRY</a>(KernelDataTableEntry-&gt;LoadedImports))) {
03593             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((PVOID)KernelDataTableEntry-&gt;LoadedImports);
03594     }
03595 
03596     <span class="keywordflow">if</span> ((HalDataTableEntry-&gt;LoadedImports != <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) &amp;&amp;
03597         (!<a class="code" href="../../d8/d8/sysload_8c.html#a4">POINTER_TO_SINGLE_ENTRY</a>(HalDataTableEntry-&gt;LoadedImports))) {
03598             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((PVOID)HalDataTableEntry-&gt;LoadedImports);
03599     }
03600 
03601     KernelDataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
03602     HalDataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
03603 
03604     <span class="keywordflow">if</span> (UndoEverything == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03605 
03606 <span class="preprocessor">#if DBG_SYSLOAD</span>
03607 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ import rebuild failed\n"</span>,
03608             &amp;DataTableEntry-&gt;FullDllName);
03609         DbgBreakPoint();
03610 <span class="preprocessor">#endif</span>
03611 <span class="preprocessor"></span>
03612         <span class="comment">//</span>
03613         <span class="comment">// An error occurred and this is an all or nothing operation so</span>
03614         <span class="comment">// roll everything back.</span>
03615         <span class="comment">//</span>
03616     
03617         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03618         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
03619             DataTableEntry = CONTAINING_RECORD(NextEntry,
03620                                                LDR_DATA_TABLE_ENTRY,
03621                                                InLoadOrderLinks);
03622 
03623             ImportList = DataTableEntry-&gt;LoadedImports;
03624             <span class="keywordflow">if</span> (ImportList == <a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a> || ImportList == <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a> ||
03625                 <a class="code" href="../../d8/d8/sysload_8c.html#a2">SINGLE_ENTRY</a>(ImportList)) {
03626                     NOTHING;
03627             }
03628             <span class="keywordflow">else</span> {
03629                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
03630             }
03631 
03632             DataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
03633             DataTableEntry-&gt;LoadCount = 1;
03634             NextEntry = NextEntry-&gt;Flink;
03635         }
03636 
03637         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03638     }
03639 
03640     <span class="keywordflow">return</span> STATUS_SUCCESS;
03641 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="sysload.c::MiCallDllUnloadAndUnloadDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCallDllUnloadAndUnloadDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DataTableEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l03645">3645</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03712">MiLocateExportName()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01914">PMM_DLL_UNLOAD</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">MiDereferenceImports()</a>.
<p>
<pre class="fragment"><div>03651                    :
03652 
03653     All <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> references from other drivers to <span class="keyword">this</span> DLL have been cleared.
03654     The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> remaining issue <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that <span class="keyword">this</span> DLL must support being unloaded.
03655     This means having no outstanding DPCs, allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, etc.
03656 
03657     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL has an unload routine that returns SUCCESS, then we clean
03658     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> up and free up its memory now.
03659 
03660     Note <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NEVER called <span class="keywordflow">for</span> drivers - <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">for</span> DLLs that were
03661     loaded due to <span class="keyword">import</span> references from various drivers.
03662 
03663 Arguments:
03664 
03665     DataTableEntry - provided <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
03666 
03667 Return Value:
03668 
03669     None.
03670 
03671 --*/
03672 
03673 {
03674     <a class="code" href="../../d2/d1/mm_8h.html#a158">PMM_DLL_UNLOAD</a> Func;
03675     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03676     LOGICAL Unloaded;
03677 
03678     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03679 
03680     Unloaded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03681 
03682     Func = <a class="code" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (DataTableEntry-&gt;DllBase, <span class="stringliteral">"DllUnload"</span>);
03683 
03684     <span class="keywordflow">if</span> (Func) {
03685 
03686         <span class="comment">//</span>
03687         <span class="comment">// The unload function was found in the DLL so unload it now.</span>
03688         <span class="comment">//</span>
03689 
03690         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Func();
03691 
03692         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03693 
03694             <span class="comment">//</span>
03695             <span class="comment">// Set up the reference count so the import DLL looks like a regular</span>
03696             <span class="comment">// driver image is being unloaded.</span>
03697             <span class="comment">//</span>
03698 
03699             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount == 0);
03700             DataTableEntry-&gt;LoadCount = 1;
03701 
03702             <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> ((PVOID)DataTableEntry);
03703             Unloaded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03704         }
03705     }
03706 
03707     <span class="keywordflow">return</span> Unloaded;
03708 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="sysload.c::MiCheckPageFilePath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiCheckPageFilePath           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00166">166</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d0/d5/io_8h.html#a603a418">DeviceUsageTypePaging</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08738">IoQueueThreadIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00183">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>.
<p>
<pre class="fragment"><div>00169 {
00170     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00171     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00172     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00173     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00174     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00175     IO_STATUS_BLOCK localIoStatus;
00176 
00177     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Reference the file object here so that no special checks need be made</span>
00181     <span class="comment">// in I/O completion to determine whether or not to dereference the file</span>
00182     <span class="comment">// object.</span>
00183     <span class="comment">//</span>
00184 
00185     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Initialize the local event.</span>
00189     <span class="comment">//</span>
00190 
00191     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Get the address of the target device object.</span>
00195     <span class="comment">//</span>
00196 
00197     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
00198 
00199     <span class="comment">//</span>
00200     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00201     <span class="comment">//</span>
00202 
00203     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE );
00204     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( irp != NULL );
00205 
00206     <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">// Don't dereference the file object, our caller will take care of that.</span>
00210         <span class="comment">//</span>
00211 
00212         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00213     }
00214 
00215     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
00216     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00217     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00221     <span class="comment">//</span>
00222 
00223     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
00224     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00225     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00226     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
00230     <span class="comment">// used to pass the original function codes and parameters.</span>
00231     <span class="comment">//</span>
00232 
00233     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00234     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00235     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>;
00236     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
00237     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_NOT_SUPPORTED;
00238     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00239     <span class="comment">// irp-&gt;Flags = 0;</span>
00240 
00241     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.InPath = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00242     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.Type = <a class="code" href="../../d0/d5/io_8h.html#a603a418">DeviceUsageTypePaging</a>;
00243 
00244     <span class="comment">//</span>
00245     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
00246     <span class="comment">//</span>
00247 
00248     <a class="code" href="../../d4/d6/iosubs_8c.html#a92">IoQueueThreadIrp</a>( irp );
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">// Now simply invoke the driver at its dispatch entry with the IRP.</span>
00252     <span class="comment">//</span>
00253 
00254     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">// Wait for the local event and copy the final status information</span>
00258     <span class="comment">// back to the caller.</span>
00259     <span class="comment">//</span>
00260 
00261     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00262         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00263                                       Executive,
00264                                       KernelMode,
00265                                       FALSE,
00266                                       (PLARGE_INTEGER) NULL );
00267         status = localIoStatus.Status;
00268     }
00269 
00270     <span class="keywordflow">return</span> status;
00271 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="sysload.c::MiClearImports" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiClearImports           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DataTableEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02693">2693</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00046">LOADED_AT_BOOT</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00047">NO_IMPORTS_USED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l00049">SINGLE_ENTRY</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.
<p>
<pre class="fragment"><div>02698                    :
02699 
02700     Free up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">import</span> list and clear <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer.  This stops <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02701     recursion performed in <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a>().
02702 
02703 Arguments:
02704 
02705     DataTableEntry - provided <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
02706 
02707 Return Value:
02708 
02709     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">import</span> list construction operation.
02710 
02711 --*/
02712 
02713 {
02714     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02715 
02716     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadedImports == (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>) {
02717         <span class="keywordflow">return</span>;
02718     }
02719 
02720     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadedImports == (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) {
02721         NOTHING;
02722     }
02723     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a2">SINGLE_ENTRY</a>(DataTableEntry-&gt;LoadedImports)) {
02724         NOTHING;
02725     }
02726     <span class="keywordflow">else</span> {
02727         <span class="comment">//</span>
02728         <span class="comment">// free the memory</span>
02729         <span class="comment">//</span>
02730         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((PVOID)DataTableEntry-&gt;LoadedImports);
02731     }
02732 
02733     <span class="comment">//</span>
02734     <span class="comment">// stop the recursion</span>
02735     <span class="comment">//</span>
02736     DataTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>;
02737 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="sysload.c::MiDeleteSystemPagableVm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER MiDeleteSystemPagableVm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewPteValue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>SessionAllocation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>ResidentPages</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">4950</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02655">_MMPTE_FLUSH_LIST::Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02656">_MMPTE_FLUSH_LIST::FlushPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02657">_MMPTE_FLUSH_LIST::FlushVa</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01570">_MMWSLENTRY::LockedInMemory</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01569">_MMWSLENTRY::LockedInWs</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02228">MI_CAPTURE_DIRTY_BIT_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02870">MI_FLUSH_ENTIRE_SESSION_TB</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03125">MiCheckPdeForPagedPool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01160">MiFlushPteList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05700">MiHighestUserPte</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01016">MiReleaseWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00464">MiRemoveWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05557">_MM_SESSION_SPACE::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l02664">MiFreeInitializationCode()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">MiFreePoolPages()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">MmFreeDriverInitialization()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03742">MmFreeSpecialPool()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.
<p>
<pre class="fragment"><div>04960                    :
04961 
04962     This function deletes pagable system address space (paged pool
04963     or driver pagable sections).
04964 
04965 Arguments:
04966 
04967     PointerPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE range to <span class="keyword">delete</span>.
04968 
04969     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of PTEs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
04970 
04971     NewPteValue - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE.
04972 
04973     SessionAllocation - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a range in session space.  If
04974                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has
04975                         already attached to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relevant session.
04976 
04977                         If <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied, then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range
04978                         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> systemwide global space instead.
04979 
04980     ResidentPages - If not <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of resident pages freed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04981                     returned here.
04982 
04983 Return Value:
04984 
04985     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages actually freed.
04986 
04987 --*/
04988 
04989 {
04990     PFN_NUMBER PageFrameIndex;
04991     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
04992     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04993     PFN_NUMBER ValidPages;
04994     PFN_NUMBER PagesRequired;
04995     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewContents;
04996     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WsIndex;
04997     KIRQL OldIrql;
04998     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
04999     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> JunkPte;
05000     <a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">MMWSLENTRY</a> Locked;
05001 
05002     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= APC_LEVEL);
05003 
05004     ValidPages = 0;
05005     PagesRequired = 0;
05006     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
05007     NewContents = NewPteValue;
05008     <span class="keywordflow">while</span> (NumberOfPtes != 0) {
05009         PteContents = *PointerPte;
05010 
05011         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
05012 
05013             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
05014 
05015                 <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05016                     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
05017                 }
05018                 <span class="keywordflow">else</span> {
05019                     <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql);
05020                 }
05021 
05022                 PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
05023                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
05024                     <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05025                         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
05026                     }
05027                     <span class="keywordflow">else</span> {
05028                         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
05029                     }
05030 
05031                     <span class="keywordflow">continue</span>;
05032                 }
05033 
05034                 <span class="comment">//</span>
05035                 <span class="comment">// Delete the page.</span>
05036                 <span class="comment">//</span>
05037 
05038                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents);
05039 
05040                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05041 
05042                 <span class="comment">//</span>
05043                 <span class="comment">// Check to see if this is a pagable page in which</span>
05044                 <span class="comment">// case it needs to be removed from the working set list.</span>
05045                 <span class="comment">//</span>
05046 
05047                 WsIndex = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex;
05048                 <span class="keywordflow">if</span> (WsIndex == 0) {
05049                     ValidPages += 1;
05050                 } <span class="keywordflow">else</span> {
05051                     <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05052                         <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WsIndex,
05053                                       MmSystemCacheWorkingSetList );
05054                         <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (WsIndex, &amp;MmSystemCacheWs);
05055                     }
05056                     <span class="keywordflow">else</span> {
05057                         WsIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a>(
05058                                               <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte),
05059                                               <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>,
05060                                               WsIndex
05061                                               );
05062 
05063                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsIndex != WSLE_NULL_INDEX);
05064 
05065                         <span class="comment">//</span>
05066                         <span class="comment">// Check to see if this entry is locked in</span>
05067                         <span class="comment">// the working set or locked in memory.</span>
05068                         <span class="comment">//</span>
05069 
05070                         Locked = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[WsIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1;
05071 
05072                         <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WsIndex, <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>);
05073 
05074                         <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (WsIndex, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>);
05075 
05076                         <span class="keywordflow">if</span> (Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o1">LockedInWs</a> == 1 || Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o2">LockedInMemory</a> == 1) {
05077 
05078                             <span class="comment">//</span>
05079                             <span class="comment">// This entry is locked.</span>
05080                             <span class="comment">//</span>
05081 <span class="preprocessor">#if DBG</span>
05082 <span class="preprocessor"></span>                            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiDeleteSystemPagableVm: Session PointerPte 0x%p, Pfn 0x%p Locked in memory\n"</span>,
05083                                 PointerPte,
05084                                 Pfn1);
05085 
05086                             DbgBreakPoint();
05087 <span class="preprocessor">#endif</span>
05088 <span class="preprocessor"></span>                            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsIndex &lt; MmSessionSpace-&gt;Vm.VmWorkingSetList-&gt;FirstDynamic);
05089                             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> -= 1;
05090 
05091                             <span class="keywordflow">if</span> (WsIndex != <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
05092                                 ULONG Entry;
05093                                 PVOID SwapVa;
05094 
05095                                 Entry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
05096                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid);
05097                                 SwapVa = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress;
05098                                 SwapVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (SwapVa);
05099 
05100                                 <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry,
05101                                                   WsIndex,
05102                                                   &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>);
05103                             }
05104                         }
05105                         <span class="keywordflow">else</span> {
05106                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsIndex &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
05107                         }
05108                     }
05109                 }
05110 
05111                 <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05112                     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
05113                 }
05114                 <span class="keywordflow">else</span> {
05115                     <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
05116                 }
05117 
05118                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05119 <span class="preprocessor">#if DBG</span>
05120 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) &amp;&amp;
05121                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
05122                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM:SYSLOAD - deleting pool locked for I/O pte %p, pfn %p, share=%x, refcount=%x, wsindex=%x\n"</span>,
05123                              PointerPte,
05124                              PageFrameIndex,
05125                              Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
05126                              Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount,
05127                              Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
05128                     <span class="comment">//</span>
05129                     <span class="comment">// This case is valid only if the page being deleted</span>
05130                     <span class="comment">// contained a lookaside free list entry that wasn't mapped</span>
05131                     <span class="comment">// and multiple threads faulted on it and waited together.</span>
05132                     <span class="comment">// Some of the faulted threads are still on the ready</span>
05133                     <span class="comment">// list but haven't run yet, and so still have references</span>
05134                     <span class="comment">// to this page that they picked up during the fault.</span>
05135                     <span class="comment">// But this current thread has already allocated the</span>
05136                     <span class="comment">// lookaside entry and is now freeing the entire page.</span>
05137                     <span class="comment">//</span>
05138                     <span class="comment">// BUT - if it is NOT the above case, we really should</span>
05139                     <span class="comment">// trap here.  However, we don't have a good way to</span>
05140                     <span class="comment">// distinguish between the two cases.  Note</span>
05141                     <span class="comment">// that this complication was inserted when we went to</span>
05142                     <span class="comment">// cmpxchg8 because using locks would prevent anyone from</span>
05143                     <span class="comment">// accessing the lookaside freelist flinks like this.</span>
05144                     <span class="comment">//</span>
05145                     <span class="comment">// So, the ASSERT below comes out, but we leave the print</span>
05146                     <span class="comment">// above in (with more data added) for the case where it's</span>
05147                     <span class="comment">// not a lookaside contender with the reference count, but</span>
05148                     <span class="comment">// is instead a truly bad reference that needs to be</span>
05149                     <span class="comment">// debugged.  The system should crash shortly thereafter</span>
05150                     <span class="comment">// and we'll at least have the above print to help us out.</span>
05151                     <span class="comment">//</span>
05152                     <span class="comment">// ASSERT (Pfn1-&gt;u3.e2.ReferenceCount == 1);</span>
05153                 }
05154 <span class="preprocessor">#endif //DBG</span>
05155 <span class="preprocessor"></span>                <span class="comment">//</span>
05156                 <span class="comment">// Check if this is a prototype PTE</span>
05157                 <span class="comment">//</span>
05158                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
05159 
05160                     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
05161 
05162                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SessionAllocation == TRUE);
05163 
05164                     <span class="comment">//</span>
05165                     <span class="comment">// Capture the state of the modified bit for this</span>
05166                     <span class="comment">// PTE.</span>
05167                     <span class="comment">//</span>
05168 
05169                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (PointerPte, Pfn1);
05170 
05171                     <span class="comment">//</span>
05172                     <span class="comment">// Decrement the share and valid counts of the page table</span>
05173                     <span class="comment">// page which maps this PTE.</span>
05174                     <span class="comment">//</span>
05175 
05176                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
05177                     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
05178 <span class="preprocessor">#if !defined (_WIN64)</span>
05179 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(MiCheckPdeForPagedPool (PointerPte))) {
05180 <span class="preprocessor">#endif</span>
05181 <span class="preprocessor"></span>                            <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
05182                                           0x61940, 
05183                                           (ULONG_PTR)PointerPte,
05184                                           (ULONG_PTR)PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
05185                                           (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
05186 <span class="preprocessor">#if !defined (_WIN64)</span>
05187 <span class="preprocessor"></span>                        }
05188 <span class="preprocessor">#endif</span>
05189 <span class="preprocessor"></span>                    }
05190 
05191                     <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPde));
05192 
05193                     <span class="comment">//</span>
05194                     <span class="comment">// Decrement the share count for the physical page.</span>
05195                     <span class="comment">//</span>
05196 
05197                     <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
05198 
05199                     <span class="comment">//</span>
05200                     <span class="comment">// No need to worry about fork prototype PTEs</span>
05201                     <span class="comment">// for kernel addresses.</span>
05202                     <span class="comment">//</span>
05203 
05204                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &gt; MiHighestUserPte);
05205 
05206                 } <span class="keywordflow">else</span> {
05207                     <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
05208                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
05209                     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
05210                 }
05211 
05212                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
05213                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05214 
05215                 <span class="comment">//</span>
05216                 <span class="comment">// Flush the TB for this page.</span>
05217                 <span class="comment">//</span>
05218 
05219                 <span class="keywordflow">if</span> (PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
05220 
05221                     <span class="comment">//</span>
05222                     <span class="comment">// We cannot rewrite the PTE without creating a race</span>
05223                     <span class="comment">// condition.  So don't let the TB flush do it anymore.</span>
05224                     <span class="comment">//</span>
05225                     <span class="comment">// PteFlushList.FlushPte[PteFlushList.Count] = PointerPte;</span>
05226                     <span class="comment">//</span>
05227 
05228                     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o1">FlushPte</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] =
05229                         (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;JunkPte;
05230 
05231                     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o2">FlushVa</a>[PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a>] =
05232                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
05233                     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> += 1;
05234                 }
05235 
05236             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype) {
05237 
05238                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SessionAllocation == TRUE);
05239 
05240                 <span class="comment">//</span>
05241                 <span class="comment">// No need to worry about fork prototype PTEs</span>
05242                 <span class="comment">// for kernel addresses.</span>
05243                 <span class="comment">//</span>
05244 
05245                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &gt;= MiHighestUserPte);
05246 
05247                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
05248 
05249                 <span class="comment">//</span>
05250                 <span class="comment">// We currently commit for all prototype kernel mappings since</span>
05251                 <span class="comment">// we could copy-on-write.</span>
05252                 <span class="comment">//</span>
05253 
05254             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
05255 
05256                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05257 
05258                 PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
05259 
05260                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0) {
05261                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05262                     <span class="keywordflow">continue</span>;
05263                 }
05264 
05265                 <span class="comment">//</span>
05266                 <span class="comment">// Transition, release page.</span>
05267                 <span class="comment">//</span>
05268 
05269                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
05270 
05271                 <span class="comment">//</span>
05272                 <span class="comment">// Set the pointer to PTE as empty so the page</span>
05273                 <span class="comment">// is deleted when the reference count goes to zero.</span>
05274                 <span class="comment">//</span>
05275 
05276                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05277 
05278                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
05279 
05280                 <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
05281 
05282                 <span class="comment">//</span>
05283                 <span class="comment">// Check the reference count for the page, if the reference</span>
05284                 <span class="comment">// count is zero, move the page to the free list, if the</span>
05285                 <span class="comment">// reference count is not zero, ignore this page.  When the</span>
05286                 <span class="comment">// reference count goes to zero, it will be placed on the</span>
05287                 <span class="comment">// free list.</span>
05288                 <span class="comment">//</span>
05289 
05290                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
05291                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
05292                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
05293                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
05294                                         PageFrameIndex);
05295                 }
05296 <span class="preprocessor">#if DBG</span>
05297 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) &amp;&amp;
05298                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
05299                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM:SYSLOAD - deleting pool locked for I/O %p\n"</span>,
05300                              PageFrameIndex);
05301                     DbgBreakPoint();
05302                 }
05303 <span class="preprocessor">#endif //DBG</span>
05304 <span class="preprocessor"></span>
05305                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
05306                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05307             } <span class="keywordflow">else</span> {
05308 
05309                 <span class="comment">//</span>
05310                 <span class="comment">// Demand zero, release page file space.</span>
05311                 <span class="comment">//</span>
05312                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh != 0) {
05313                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05314                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (PteContents);
05315                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05316                 }
05317 
05318                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
05319             }
05320 
05321             PagesRequired += 1;
05322         }
05323 
05324         NumberOfPtes -= 1;
05325         PointerPte += 1;
05326     }
05327 
05328     <span class="comment">//</span>
05329     <span class="comment">// There is the thorny case where one of the pages we just deleted could</span>
05330     <span class="comment">// get faulted back in when we released the PFN lock above within the loop.</span>
05331     <span class="comment">// The only time when this can happen is if a thread faulted during an</span>
05332     <span class="comment">// interlocked pool allocation for an address that we've just deleted.</span>
05333     <span class="comment">//</span>
05334     <span class="comment">// If this thread sees the NewContents in the PTE, it will treat it as</span>
05335     <span class="comment">// demand zero, and incorrectly allocate a page, PTE and WSL.  It will</span>
05336     <span class="comment">// reference it once and realize it needs to reread the lookaside listhead</span>
05337     <span class="comment">// and restart the operation.  But this page would live on in paged pool</span>
05338     <span class="comment">// as modified (but unused) until the paged pool allocator chose to give</span>
05339     <span class="comment">// out its virtual address again.</span>
05340     <span class="comment">//</span>
05341     <span class="comment">// The code below rewrites the PTEs which is really bad if another thread</span>
05342     <span class="comment">// gets a zero page between our first setting of the PTEs above and our</span>
05343     <span class="comment">// second setting below - because we'll reset the PTE to demand zero, but</span>
05344     <span class="comment">// we'll still have a WSL entry that's valid, and we spiral from there.</span>
05345     <span class="comment">//</span>
05346     <span class="comment">// We really should remove the writing of the PTE below since we've already</span>
05347     <span class="comment">// done it above.  But for now, we're leaving it in - it's harmless because</span>
05348     <span class="comment">// we've chosen to fix this problem by checking for this case when we</span>
05349     <span class="comment">// materialize demand zero pages.  Note that we have to fix this problem</span>
05350     <span class="comment">// by checking in the demand zero path because a thread could be coming into</span>
05351     <span class="comment">// that path any time before or after we flush the PTE list and any fixes</span>
05352     <span class="comment">// here could only address the before case, not the after.</span>
05353     <span class="comment">//</span>
05354 
05355     <span class="keywordflow">if</span> (SessionAllocation == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05356 
05357         <span class="comment">//</span>
05358         <span class="comment">// Session space has no ASN - flush the entire TB.</span>
05359         <span class="comment">//</span>
05360     
05361         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a200">MI_FLUSH_ENTIRE_SESSION_TB</a> (TRUE, TRUE);
05362     }
05363 
05364     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05365     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, TRUE, NewContents);
05366     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05367 
05368     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ResidentPages)) {
05369         *ResidentPages = ValidPages;
05370     }
05371 
05372     <span class="keywordflow">return</span> PagesRequired;
05373 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="sysload.c::MiDereferenceImports" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiDereferenceImports           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImportList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">3822</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00042">_LOAD_IMPORTS::Count</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00043">_LOAD_IMPORTS::Entry</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00046">LOADED_AT_BOOT</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03645">MiCallDllUnloadAndUnloadDll()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00047">NO_IMPORTS_USED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00049">SINGLE_ENTRY</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00051">SINGLE_ENTRY_TO_POINTER</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.
<p>
<pre class="fragment"><div>03828                    :
03829 
03830     Decrement <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count on each DLL specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image <span class="keyword">import</span>
03831     list.  If any DLL's reference count reaches zero, then free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
03832 
03833     No locks may be held on entry as <a class="code" href="../../d2/d1/mm_8h.html#a233">MmUnloadSystemImage</a> may be called.
03834 
03835     The parameter list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed here as well.
03836 
03837 Arguments:
03838 
03839     ImportList - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of DLLs to dereference.
03840 
03841 Return Value:
03842 
03843     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dereference operation.
03844 
03845 --*/
03846 
03847 {
03848     ULONG i;
03849     LOGICAL Unloaded;
03850     PVOID SavedImports;
03851     <a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">LOAD_IMPORTS</a> SingleTableEntry;
03852     PLDR_DATA_TABLE_ENTRY ImportTableEntry;
03853 
03854     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03855 
03856     <span class="keywordflow">if</span> (ImportList == <a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a> || ImportList == <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) {
03857         <span class="keywordflow">return</span> STATUS_SUCCESS;
03858     }
03859 
03860     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a2">SINGLE_ENTRY</a>(ImportList)) {
03861         SingleTableEntry.<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a> = 1;
03862         SingleTableEntry.<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[0] = <a class="code" href="../../d8/d8/sysload_8c.html#a3">SINGLE_ENTRY_TO_POINTER</a>(ImportList);
03863         ImportList = &amp;SingleTableEntry;
03864     }
03865 
03866     <span class="keywordflow">for</span> (i = 0; i &lt; ImportList-&gt;Count &amp;&amp; ImportList-&gt;Entry[i]; i += 1) {
03867         ImportTableEntry = ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i];
03868 
03869         <span class="keywordflow">if</span> (ImportTableEntry-&gt;LoadedImports == (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>) {
03870 
03871             <span class="comment">//</span>
03872             <span class="comment">// Skip this one - it was loaded by ntldr.</span>
03873             <span class="comment">//</span>
03874 
03875             <span class="keywordflow">continue</span>;
03876         }
03877 
03878 <span class="preprocessor">#if DBG</span>
03879 <span class="preprocessor"></span>        {
03880             ULONG ImageCount;
03881             PLIST_ENTRY NextEntry;
03882             PLDR_DATA_TABLE_ENTRY DataTableEntry;
03883 
03884             <span class="comment">//</span>
03885             <span class="comment">// Assert that the first 2 entries are never dereferenced as</span>
03886             <span class="comment">// unloading the kernel or HAL would be fatal.</span>
03887             <span class="comment">//</span>
03888 
03889             NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03890 
03891             ImageCount = 0;
03892             <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a> &amp;&amp; ImageCount &lt; 2) {
03893                 DataTableEntry = CONTAINING_RECORD(NextEntry,
03894                                                    LDR_DATA_TABLE_ENTRY,
03895                                                    InLoadOrderLinks);
03896                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ImportTableEntry != DataTableEntry);
03897                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount == 1);
03898                 NextEntry = NextEntry-&gt;Flink;
03899                 ImageCount += 1;
03900             }
03901         }
03902 <span class="preprocessor">#endif</span>
03903 <span class="preprocessor"></span>
03904         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ImportTableEntry-&gt;LoadCount &gt;= 1);
03905 
03906         ImportTableEntry-&gt;LoadCount -= 1;
03907 
03908         <span class="keywordflow">if</span> (ImportTableEntry-&gt;LoadCount == 0) {
03909 
03910             <span class="comment">//</span>
03911             <span class="comment">// Unload this dependent DLL - we only do this to non-referenced</span>
03912             <span class="comment">// non-boot-loaded drivers.  Stop the import list recursion prior</span>
03913             <span class="comment">// to unloading - we know we're done at this point.</span>
03914             <span class="comment">//</span>
03915             <span class="comment">// Note we can continue on afterwards without restarting</span>
03916             <span class="comment">// regardless of which locks get released and reacquired</span>
03917             <span class="comment">// because this chain is private.</span>
03918             <span class="comment">//</span>
03919 
03920             SavedImports = ImportTableEntry-&gt;LoadedImports;
03921 
03922             ImportTableEntry-&gt;LoadedImports = (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
03923 
03924             Unloaded = <a class="code" href="../../d8/d8/sysload_8c.html#a43">MiCallDllUnloadAndUnloadDll</a> ((PVOID)ImportTableEntry);
03925 
03926             <span class="keywordflow">if</span> (Unloaded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03927 
03928                 <span class="comment">//</span>
03929                 <span class="comment">// This DLL was unloaded so recurse through its imports and</span>
03930                 <span class="comment">// attempt to unload all of those too.</span>
03931                 <span class="comment">//</span>
03932 
03933                 <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> ((<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)SavedImports);
03934 
03935                 <span class="keywordflow">if</span> ((SavedImports != (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>) &amp;&amp;
03936                     (SavedImports != (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>) &amp;&amp;
03937                     (!<a class="code" href="../../d8/d8/sysload_8c.html#a2">SINGLE_ENTRY</a>(SavedImports))) {
03938 
03939                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (SavedImports);
03940                 }
03941             }
03942             <span class="keywordflow">else</span> {
03943                 ImportTableEntry-&gt;LoadedImports = SavedImports;
03944             }
03945         }
03946     }
03947 
03948     <span class="keywordflow">return</span> STATUS_SUCCESS;
03949 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="sysload.c::MiEnablePagingOfDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiEnablePagingOfDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02208">2208</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">MiSetPagingOfDriver()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00082">MmDisablePagingExecutive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, and <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>.
<p>
<pre class="fragment"><div>02212 {
02213     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02214     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02215     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02216     PVOID Base;
02217     ULONG i;
02218     PIMAGE_NT_HEADERS NtHeaders;
02219     PIMAGE_SECTION_HEADER FoundSection;
02220     PIMAGE_OPTIONAL_HEADER OptionalHeader;
02221 
02222     <span class="comment">//</span>
02223     <span class="comment">// Don't page kernel mode code if customer does not want it paged.</span>
02224     <span class="comment">//</span>
02225 
02226     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>) {
02227         <span class="keywordflow">return</span>;
02228     }
02229 
02230     <span class="comment">//</span>
02231     <span class="comment">// If the driver has pagable code, make it paged.</span>
02232     <span class="comment">//</span>
02233 
02234     DataTableEntry = (PLDR_DATA_TABLE_ENTRY)ImageHandle;
02235     Base = DataTableEntry-&gt;DllBase;
02236 
02237     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
02238 
02239     OptionalHeader = (PIMAGE_OPTIONAL_HEADER)((PCHAR)NtHeaders +
02240 <span class="preprocessor">#if defined (_WIN64)</span>
02241 <span class="preprocessor"></span>                        FIELD_OFFSET (IMAGE_NT_HEADERS64, OptionalHeader));
02242 <span class="preprocessor">#else</span>
02243 <span class="preprocessor"></span>                        FIELD_OFFSET (IMAGE_NT_HEADERS32, OptionalHeader));
02244 <span class="preprocessor">#endif</span>
02245 <span class="preprocessor"></span>
02246     FoundSection = IMAGE_FIRST_SECTION (NtHeaders);
02247 
02248     i = NtHeaders-&gt;FileHeader.NumberOfSections;
02249 
02250     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02251 
02252     <span class="keywordflow">while</span> (i &gt; 0) {
02253 <span class="preprocessor">#if DBG</span>
02254 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((*(PULONG)FoundSection-&gt;Name == 'tini') ||
02255                 (*(PULONG)FoundSection-&gt;Name == 'egap')) {
02256                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ has lower case sections (init or pagexxx)\n"</span>,
02257                     &amp;DataTableEntry-&gt;FullDllName);
02258             }
02259 <span class="preprocessor">#endif //DBG</span>
02260 <span class="preprocessor"></span>
02261         <span class="comment">//</span>
02262         <span class="comment">// Mark as pagable any section which starts with the</span>
02263         <span class="comment">// first 4 characters PAGE or .eda (for the .edata section).</span>
02264         <span class="comment">//</span>
02265 
02266         <span class="keywordflow">if</span> ((*(PULONG)FoundSection-&gt;Name == 'EGAP') ||
02267            (*(PULONG)FoundSection-&gt;Name == 'ade.')) {
02268 
02269             <span class="comment">//</span>
02270             <span class="comment">// This section is pagable, save away the start and end.</span>
02271             <span class="comment">//</span>
02272 
02273             <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02274 
02275                 <span class="comment">//</span>
02276                 <span class="comment">// Previous section was NOT pagable, get the start address.</span>
02277                 <span class="comment">//</span>
02278 
02279                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (ROUND_TO_PAGES (
02280                                    (PCHAR)Base + FoundSection-&gt;VirtualAddress));
02281             }
02282             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)Base +
02283                                        FoundSection-&gt;VirtualAddress +
02284                                        (OptionalHeader-&gt;SectionAlignment - 1) +
02285                                        FoundSection-&gt;SizeOfRawData - PAGE_SIZE);
02286 
02287         } <span class="keywordflow">else</span> {
02288 
02289             <span class="comment">//</span>
02290             <span class="comment">// This section is not pagable, if the previous section was</span>
02291             <span class="comment">// pagable, enable it.</span>
02292             <span class="comment">//</span>
02293 
02294             <span class="keywordflow">if</span> (PointerPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02295                 <a class="code" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (PointerPte, LastPte, FALSE);
02296                 PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02297             }
02298         }
02299         i -= 1;
02300         FoundSection += 1;
02301     }
02302     <span class="keywordflow">if</span> (PointerPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02303         <a class="code" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (PointerPte, LastPte, FALSE);
02304     }
02305 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="sysload.c::MiFindExportedRoutineByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiFindExportedRoutineByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DataTableEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>AnsiImageRoutineName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06928">6928</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l06808">MmGetSystemRoutineAddress()</a>.
<p>
<pre class="fragment"><div>06935                    :
06936 
06937     This function snaps a thunk <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Export Section data.
06938     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section data does not support <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
06939     partially snapped (Dll field is still non-null, but snap address is
06940     set).
06941 
06942 Arguments:
06943 
06944     DllBase - Base of DLL being snapped to.
06945 
06946     ImageBase - Base of image that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunks to snap.
06947 
06948     Thunk - On input, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk to snap.  When successfully
06949         snapped, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address in
06950         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
06951 
06952     ExportDirectory - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Export Section data from a DLL.
06953 
06954     SnapForwarder - determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> snap <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a forwarder, and therefore
06955        Address of Data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already setup.
06956 
06957 Return Value:
06958 
06959 
06960     STATUS_SUCCESS or STATUS_DRIVER_ENTRYPOINT_NOT_FOUND or
06961         STATUS_DRIVER_ORDINAL_NOT_FOUND
06962 
06963 --*/
06964 
06965 {
06966     PCHAR DllBase;
06967     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> OrdinalNumber;
06968     PULONG NameTableBase;
06969     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> NameOrdinalTableBase;
06970     PULONG Addr;
06971     ULONG High;
06972     ULONG Low;
06973     ULONG Middle;
06974     LONG Result;
06975     ULONG ExportSize;
06976     PVOID FunctionAddress;
06977     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
06978 
06979     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06980 
06981     DllBase = DataTableEntry-&gt;DllBase;
06982 
06983     ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
06984                                 DllBase,
06985                                 TRUE,
06986                                 IMAGE_DIRECTORY_ENTRY_EXPORT,
06987                                 &amp;ExportSize
06988                                 );
06989 
06990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ExportDirectory != NULL);
06991 
06992     <span class="comment">//</span>
06993     <span class="comment">// Initialize the pointer to the array of RVA-based ansi export strings.</span>
06994     <span class="comment">//</span>
06995 
06996     NameTableBase = (PULONG)(DllBase + (ULONG)ExportDirectory-&gt;AddressOfNames);
06997 
06998     <span class="comment">//</span>
06999     <span class="comment">// Initialize the pointer to the array of USHORT ordinal numbers.</span>
07000     <span class="comment">//</span>
07001 
07002     NameOrdinalTableBase = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(DllBase + (ULONG)ExportDirectory-&gt;AddressOfNameOrdinals);
07003 
07004     <span class="comment">//</span>
07005     <span class="comment">// Lookup the desired name in the name table using a binary search.</span>
07006     <span class="comment">//</span>
07007 
07008     Low = 0;
07009     High = ExportDirectory-&gt;NumberOfNames - 1;
07010 
07011     <span class="keywordflow">while</span> (High &gt;= Low) {
07012 
07013         <span class="comment">//</span>
07014         <span class="comment">// Compute the next probe index and compare the import name</span>
07015         <span class="comment">// with the export name entry.</span>
07016         <span class="comment">//</span>
07017 
07018         Middle = (Low + High) &gt;&gt; 1;
07019 
07020         Result = strcmp(AnsiImageRoutineName-&gt;Buffer,
07021                         (PCHAR)(DllBase + NameTableBase[Middle]));
07022 
07023         <span class="keywordflow">if</span> (Result &lt; 0) {
07024             High = Middle - 1;
07025         }
07026         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &gt; 0) {
07027             Low = Middle + 1;
07028         }
07029         <span class="keywordflow">else</span> {
07030             <span class="keywordflow">break</span>;
07031         }
07032     }
07033 
07034     <span class="comment">//</span>
07035     <span class="comment">// If the high index is less than the low index, then a matching</span>
07036     <span class="comment">// table entry was not found. Otherwise, get the ordinal number</span>
07037     <span class="comment">// from the ordinal table.</span>
07038     <span class="comment">//</span>
07039 
07040     <span class="keywordflow">if</span> (High &lt; Low) {
07041         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07042     }
07043 
07044     OrdinalNumber = NameOrdinalTableBase[Middle];
07045 
07046     <span class="comment">//</span>
07047     <span class="comment">// If the OrdinalNumber is not within the Export Address Table,</span>
07048     <span class="comment">// then this image does not implement the function.  Return not found.</span>
07049     <span class="comment">//</span>
07050 
07051     <span class="keywordflow">if</span> ((ULONG)OrdinalNumber &gt;= ExportDirectory-&gt;NumberOfFunctions) {
07052         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07053     }
07054 
07055     <span class="comment">//</span>
07056     <span class="comment">// Index into the array of RVA export addresses by ordinal number.</span>
07057     <span class="comment">//</span>
07058 
07059     Addr = (PULONG)(DllBase + (ULONG)ExportDirectory-&gt;AddressOfFunctions);
07060 
07061     FunctionAddress = (PVOID)(DllBase + Addr[OrdinalNumber]);
07062 
07063     <span class="comment">//</span>
07064     <span class="comment">// Forwarders are not used by the kernel and HAL to each other.</span>
07065     <span class="comment">//</span>
07066 
07067     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((FunctionAddress &lt;= (PVOID)ExportDirectory) ||
07068             (FunctionAddress &gt;= (PVOID)((PCHAR)ExportDirectory + ExportSize)));
07069 
07070     <span class="keywordflow">return</span> FunctionAddress;
07071 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="sysload.c::MiInitializeLoadedModuleList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiInitializeLoadedModuleList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06591">6591</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03326">MiBuildImportsForBootDrivers()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06395">MiLocateKernelSections()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00080">PsLoadedModuleSpinLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00580">PsNtosImageBase</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>06597                    :
06598 
06599     This function initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loaded module list based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LoaderBlock.
06600 
06601 Arguments:
06602 
06603     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system loader block.
06604 
06605 Return Value:
06606 
06607     None.
06608 
06609 Environment:
06610 
06611     Kernel mode, Phase 0 Initialization.
06612 
06613 --*/
06614 
06615 {
06616     PLIST_ENTRY NextEntry;
06617     PLDR_DATA_TABLE_ENTRY DataTableEntry1;
06618     PLDR_DATA_TABLE_ENTRY DataTableEntry2;
06619 
06620     <span class="comment">//</span>
06621     <span class="comment">// Initialize the loaded module list executive resource and spin lock.</span>
06622     <span class="comment">//</span>
06623 
06624     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;PsLoadedModuleResource);
06625     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;PsLoadedModuleSpinLock);
06626 
06627     InitializeListHead (&amp;PsLoadedModuleList);
06628 
06629     <span class="comment">//</span>
06630     <span class="comment">// Scan the loaded module list and allocate and initialize a data table</span>
06631     <span class="comment">// entry for each module. The data table entry is inserted in the loaded</span>
06632     <span class="comment">// module list and the initialization order list in the order specified</span>
06633     <span class="comment">// in the loader parameter block. The data table entry is inserted in the</span>
06634     <span class="comment">// memory order list in memory order.</span>
06635     <span class="comment">//</span>
06636 
06637     NextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
06638     DataTableEntry2 = CONTAINING_RECORD(NextEntry,
06639                                         LDR_DATA_TABLE_ENTRY,
06640                                         InLoadOrderLinks);
06641     <a class="code" href="../../d1/d9/ps_8h.html#a54">PsNtosImageBase</a> = DataTableEntry2-&gt;DllBase;
06642 
06643     <a class="code" href="../../d8/d8/sysload_8c.html#a48">MiLocateKernelSections</a> (DataTableEntry2);
06644 
06645     <span class="keywordflow">while</span> (NextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead) {
06646 
06647         DataTableEntry2 = CONTAINING_RECORD(NextEntry,
06648                                             LDR_DATA_TABLE_ENTRY,
06649                                             InLoadOrderLinks);
06650 
06651         <span class="comment">//</span>
06652         <span class="comment">// Allocate a data table entry.</span>
06653         <span class="comment">//</span>
06654 
06655         DataTableEntry1 = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
06656                                                  <span class="keyword">sizeof</span>(LDR_DATA_TABLE_ENTRY),
06657                                                  'dLmM');
06658 
06659         <span class="keywordflow">if</span> (DataTableEntry1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06660             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06661         }
06662 
06663         <span class="comment">//</span>
06664         <span class="comment">// Copy the data table entry.</span>
06665         <span class="comment">//</span>
06666 
06667         *DataTableEntry1 = *DataTableEntry2;
06668 
06669         DataTableEntry1-&gt;FullDllName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
06670             DataTableEntry2-&gt;FullDllName.MaximumLength + <span class="keyword">sizeof</span>(UNICODE_NULL),
06671             'TDmM');
06672 
06673         <span class="keywordflow">if</span> (DataTableEntry1-&gt;FullDllName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06674             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry1);
06675             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06676         }
06677 
06678         DataTableEntry1-&gt;BaseDllName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
06679             DataTableEntry2-&gt;BaseDllName.MaximumLength + <span class="keyword">sizeof</span>(UNICODE_NULL),
06680             'dLmM');
06681 
06682         <span class="keywordflow">if</span> (DataTableEntry1-&gt;BaseDllName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06683             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry1-&gt;FullDllName.Buffer);
06684             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry1);
06685             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06686         }
06687 
06688         <span class="comment">//</span>
06689         <span class="comment">// Copy the strings.</span>
06690         <span class="comment">//</span>
06691 
06692         RtlMoveMemory (DataTableEntry1-&gt;FullDllName.Buffer,
06693                        DataTableEntry2-&gt;FullDllName.Buffer,
06694                        DataTableEntry1-&gt;FullDllName.MaximumLength);
06695 
06696         RtlMoveMemory (DataTableEntry1-&gt;BaseDllName.Buffer,
06697                        DataTableEntry2-&gt;BaseDllName.Buffer,
06698                        DataTableEntry1-&gt;BaseDllName.MaximumLength);
06699 
06700         <span class="comment">//</span>
06701         <span class="comment">// Insert the data table entry in the load order list in the order</span>
06702         <span class="comment">// they are specified.</span>
06703         <span class="comment">//</span>
06704 
06705         InsertTailList(&amp;PsLoadedModuleList,
06706                        &amp;DataTableEntry1-&gt;InLoadOrderLinks);
06707 
06708         NextEntry = NextEntry-&gt;Flink;
06709     }
06710 
06711     <a class="code" href="../../d8/d8/sysload_8c.html#a38">MiBuildImportsForBootDrivers</a> ();
06712 
06713     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06714 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="sysload.c::MiLoadImageSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiLoadImageSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadInSessionSpace</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">1474</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00057">ExpDefaultErrorPortProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01779">MiMapCacheExceptionFilter()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l01223">MiRemoveImageSessionWide()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02144">MiSessionCommitImagePages()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00936">MiSessionWideReserveImageAddress()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04270">MM_DBG_COMMIT_DRIVER_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04307">MM_DBG_COMMIT_RETURN_SESSION_DRIVER_LOAD_FAILURE1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05327">MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05328">MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05329">MM_DBG_SESSION_COMMIT_IMAGELOAD_NOACCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00135">MM_EXECUTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00145">MM_NOACCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00386">MM_PTE_EXECUTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00075">MmDriverCommit</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05444">_MM_SESSION_SPACE::ProcessList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05300">SESSION_GLOBAL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">_MM_SESSION_SPACE::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01128">ZERO_LARGE</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>.
<p>
<pre class="fragment"><div>01483                    :
01484 
01485     This routine loads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified image into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01486     address space.
01487 
01488 Arguments:
01489 
01490     SectionPointer - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image.
01491 
01492     ImageBaseAddress - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image header <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> at.
01493 
01494     ImageFileName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name (including the image name)
01495                     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
01496 
01497     LoadInSessionSpace - Supplies whether to load <span class="keyword">this</span> image in session space.
01498                          Each session gets a different copy of <span class="keyword">this</span> driver with
01499                          pages shared as much as possible via copy on write.
01500 
01501 Return Value:
01502 
01503     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01504 
01505 --*/
01506 
01507 {
01508     PFN_NUMBER PagesRequired;
01509     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
01510     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
01511     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01512     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01513     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01514     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess;
01515     ULONG NumberOfPtes;
01516     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01517     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01518     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01519     PFN_NUMBER PageFrameIndex;
01520     KIRQL OldIrql;
01521     PVOID UserVa;
01522     PVOID SystemVa;
01523     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01524     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExceptionStatus;
01525     PVOID Base;
01526     ULONG_PTR ViewSize;
01527     LARGE_INTEGER SectionOffset;
01528     BOOLEAN LoadSymbols;
01529     PVOID BaseAddress;
01530     PFN_NUMBER CommittedPages;
01531     SIZE_T SectionSize;
01532     BOOLEAN AlreadyLoaded;
01533     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
01534     LOGICAL ProcessReferenced;
01535     PLIST_ENTRY NextProcessEntry;
01536 
01537     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01538 
01539     PagesRequired = 0;
01540 
01541     <span class="comment">//</span>
01542     <span class="comment">// Calculate the number of pages required to load this image.</span>
01543     <span class="comment">//</span>
01544 
01545     ProtoPte = SectionPointer-&gt;Segment-&gt;PrototypePte;
01546     NumberOfPtes = SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes;
01547 
01548     <span class="keywordflow">while</span> (NumberOfPtes != 0) {
01549         PteContents = *ProtoPte;
01550 
01551         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
01552             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>)) {
01553             PagesRequired += 1;
01554         }
01555         NumberOfPtes -= 1;
01556         ProtoPte += 1;
01557     }
01558 
01559     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01560 
01561         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
01562 
01563         SectionSize = (ULONG_PTR)SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01564 
01565         <span class="comment">//</span>
01566         <span class="comment">// Allocate a unique systemwide session space virtual address for</span>
01567         <span class="comment">// the driver.</span>
01568         <span class="comment">//</span>
01569 
01570         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a17">MiSessionWideReserveImageAddress</a> (ImageFileName,
01571                                                    SectionPointer,
01572                                                    PAGE_SIZE,
01573                                                    &amp;BaseAddress,
01574                                                    &amp;AlreadyLoaded);
01575 
01576         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01577 <span class="preprocessor">#if DBG</span>
01578 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01579                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiLoadImageSection: Error 0x%x Allocating session space %p Bytes\n"</span>,Status,SectionSize);
01580             }
01581 <span class="preprocessor">#endif</span>
01582 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01583         }
01584 
01585         <span class="comment">//</span>
01586         <span class="comment">// This is a request to load an existing driver.  This can</span>
01587         <span class="comment">// occur with printer drivers for example.</span>
01588         <span class="comment">//</span>
01589 
01590         <span class="keywordflow">if</span> (AlreadyLoaded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01591             *ImageBaseAddress = BaseAddress;
01592             <span class="keywordflow">return</span> STATUS_ALREADY_COMMITTED;
01593         }
01594 
01595 <span class="preprocessor">#if DBG</span>
01596 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01597             <span class="keywordflow">if</span> (ImageFileName) {
01598                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Image %wZ, BasedAddress 0x%p, SegmentBaseAddress 0x%p, Allocated Session BaseAddress 0x%p\n"</span>,
01599                     ImageFileName,
01600                     SectionPointer-&gt;Segment-&gt;BasedAddress,
01601                     SectionPointer-&gt;Segment-&gt;SegmentBaseAddress,
01602                     BaseAddress);
01603             }
01604             <span class="keywordflow">else</span> {
01605                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Image &lt;NULL&gt; BasedAddress 0x%p, SegmentBaseAddress 0x%p, Allocated Session BaseAddress 0x%p\n"</span>,
01606                     SectionPointer-&gt;Segment-&gt;BasedAddress,
01607                     SectionPointer-&gt;Segment-&gt;SegmentBaseAddress,
01608                     BaseAddress);
01609             }
01610         }
01611 <span class="preprocessor">#endif</span>
01612 <span class="preprocessor"></span>
01613         <span class="keywordflow">if</span> (BaseAddress == SectionPointer-&gt;Segment-&gt;BasedAddress) {
01614 
01615             <span class="comment">//</span>
01616             <span class="comment">// We were able to load the image at its based address, so</span>
01617             <span class="comment">// map its image segments as backed directly by the file image.</span>
01618             <span class="comment">// All pristine pages of the image will be shared across all</span>
01619             <span class="comment">// sessions, with each page treated as copy-on-write on first write.</span>
01620             <span class="comment">//</span>
01621             <span class="comment">// NOTE: This makes the file image "busy", a different behavior</span>
01622             <span class="comment">// as normal kernel drivers are backed by the paging file only.</span>
01623             <span class="comment">//</span>
01624 
01625 <span class="preprocessor">#if DBG</span>
01626 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (SectionPointer-&gt;Segment-&gt;SystemImageBase != 0) {
01627                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BaseAddress == SectionPointer-&gt;Segment-&gt;SystemImageBase);
01628             }
01629 <span class="preprocessor">#endif</span>
01630 <span class="preprocessor"></span>
01631             <span class="comment">//</span>
01632             <span class="comment">// Map the image into session space.</span>
01633             <span class="comment">//</span>
01634 
01635             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a11">MiShareSessionImage</a> (SectionPointer, &amp;SectionSize);
01636 
01637             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01638 <span class="preprocessor">#if DBG</span>
01639 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01640                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Error 0x%x Allocating session space %p Bytes\n"</span>, Status, SectionSize);
01641                 }
01642 <span class="preprocessor">#endif</span>
01643 <span class="preprocessor"></span>                <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
01644                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01645             }
01646 
01647             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BaseAddress == SectionPointer-&gt;Segment-&gt;BasedAddress);
01648 
01649             *ImageBaseAddress = BaseAddress;
01650 
01651             <span class="comment">//</span>
01652             <span class="comment">// Indicate that this section has been loaded into the system.</span>
01653             <span class="comment">//</span>
01654 
01655             SectionPointer-&gt;Segment-&gt;SystemImageBase = BaseAddress;
01656 
01657 <span class="preprocessor">#if DBG</span>
01658 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01659                 <span class="keywordflow">if</span> (ImageFileName) {
01660                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Mapped image %wZ at requested session address 0x%p\n"</span>,
01661                         ImageFileName,
01662                         BaseAddress);
01663                 }
01664                 <span class="keywordflow">else</span> {
01665                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Mapped a session image at requested address 0x%p\n"</span>,
01666                         BaseAddress);
01667                 }
01668             }
01669 <span class="preprocessor">#endif</span>
01670 <span class="preprocessor"></span>
01671             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01672         }
01673 
01674         <span class="comment">//</span>
01675         <span class="comment">// The image could not be loaded at its based address.  It must be</span>
01676         <span class="comment">// copied to its new address using private page file backed pages.</span>
01677         <span class="comment">// Our caller will relocate the internal references and then bind the</span>
01678         <span class="comment">// image.  Allocate the pages and page tables for the image now.</span>
01679         <span class="comment">//</span>
01680 
01681         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a18">MiSessionCommitImagePages</a> (BaseAddress, SectionSize);
01682 
01683         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01684 <span class="preprocessor">#if DBG</span>
01685 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01686                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiLoadImageSection: Error 0x%x Allocating session space %p Bytes\n"</span>, Status, SectionSize);
01687             }
01688 <span class="preprocessor">#endif</span>
01689 <span class="preprocessor"></span>            <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
01690             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01691         }
01692         SystemVa = BaseAddress;
01693     }
01694     <span class="keywordflow">else</span> {
01695 
01696         <span class="comment">//</span>
01697         <span class="comment">// See if ample pages exist to load this image.</span>
01698         <span class="comment">//</span>
01699 
01700 <span class="preprocessor">#if DBG</span>
01701 <span class="preprocessor"></span>        MiPagesConsumed = PagesRequired;
01702 <span class="preprocessor">#endif</span>
01703 <span class="preprocessor"></span>
01704         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01705 
01706         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> &lt;= (SPFN_NUMBER)PagesRequired) {
01707             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01708             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01709         }
01710         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= PagesRequired;
01711         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(14, PagesRequired);
01712         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01713 
01714         <span class="comment">//</span>
01715         <span class="comment">// Reserve the necessary system address space.</span>
01716         <span class="comment">//</span>
01717 
01718         FirstPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes,
01719                                         SystemPteSpace,
01720                                         0,
01721                                         0,
01722                                         FALSE );
01723 
01724         <span class="keywordflow">if</span> (FirstPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01725             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01726             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesRequired;
01727             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(15, PagesRequired);
01728             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01729             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01730         }
01731         PointerPte = FirstPte;
01732         SystemVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01733     }
01734 
01735     <span class="comment">//</span>
01736     <span class="comment">// Map a view into the user portion of the address space.</span>
01737     <span class="comment">//</span>
01738 
01739     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01740 
01741     <span class="comment">//</span>
01742     <span class="comment">// Since callees are not always in the context of the system process,</span>
01743     <span class="comment">// attach here when necessary to guarantee the driver load occurs in a</span>
01744     <span class="comment">// known safe address space to prevent security holes.</span>
01745     <span class="comment">//</span>
01746 
01747     ProcessReferenced = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01748     TargetProcess = Process;
01749     <span class="keywordflow">if</span> (Process-&gt;Peb &amp;&amp; Process-&gt;Vm.u.Flags.SessionLeader == 0) {
01750         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01751             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a> &amp;&amp; (Process != <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a>)) {
01752                 TargetProcess = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a>;
01753                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
01754             }
01755         }
01756         <span class="keywordflow">else</span> {
01757 
01758             SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a>(MmSessionSpace);
01759             <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01760             NextProcessEntry = SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>.Flink;
01761 
01762             <span class="keywordflow">if</span> ((SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.DeletePending == 0) &amp;&amp;
01763                 (NextProcessEntry != &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>)) {
01764 
01765                 TargetProcess = CONTAINING_RECORD (NextProcessEntry,
01766                                                    <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
01767                                                    SessionProcessLinks);
01768 
01769                 <span class="keywordflow">if</span> (Process != TargetProcess) {
01770                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a> (TargetProcess);
01771                     ProcessReferenced = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01772                 }
01773             }
01774             <span class="keywordflow">else</span> {
01775                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01776 
01777                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01778                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesRequired;
01779                 <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(15, PagesRequired);
01780                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01781 
01782                 CommittedPages = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
01783                                           MiGetPteAddress (BaseAddress),
01784                                           BYTES_TO_PAGES (SectionSize),
01785                                           ZeroKernelPte,
01786                                           TRUE,
01787                                           NULL);
01788     
01789                 <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
01790                 <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
01791     
01792                 <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED1,
01793                     CommittedPages);
01794     
01795                 <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
01796     
01797                 <span class="comment">//</span>
01798                 <span class="comment">// Return the commitment we took out on the pagefile when</span>
01799                 <span class="comment">// the page was allocated.  This is needed for collided images</span>
01800                 <span class="comment">// since all the pages get committed regardless of writability.</span>
01801                 <span class="comment">//</span>
01802     
01803                 <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
01804 
01805                 <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
01806             }
01807 
01808             <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01809 
01810             <span class="keywordflow">if</span> (Process != TargetProcess) {
01811                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
01812             }
01813         }
01814     }
01815 
01816     <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (SectionOffset);
01817     Base = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01818     ViewSize = 0;
01819 
01820     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_KDEBUG_SYMBOL_LOAD) {
01821         LoadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01822         <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp;= ~FLG_ENABLE_KDEBUG_SYMBOL_LOAD;
01823     }
01824     <span class="keywordflow">else</span> {
01825         LoadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01826     }
01827 
01828     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> ( SectionPointer,
01829                                   TargetProcess,
01830                                   &amp;Base,
01831                                   0,
01832                                   0,
01833                                   &amp;SectionOffset,
01834                                   &amp;ViewSize,
01835                                   ViewUnmap,
01836                                   0,
01837                                   PAGE_EXECUTE);
01838 
01839     <span class="keywordflow">if</span> (LoadSymbols) {
01840         <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> |= FLG_ENABLE_KDEBUG_SYMBOL_LOAD;
01841     }
01842 
01843     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_IMAGE_MACHINE_TYPE_MISMATCH) {
01844         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_IMAGE_FORMAT;
01845     }
01846 
01847     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01848         <span class="keywordflow">if</span> (TargetProcess != Process) {
01849             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01850             <span class="keywordflow">if</span> (ProcessReferenced == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01851                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
01852             }
01853         }
01854 
01855         <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01856 
01857 <span class="preprocessor">#if DBG</span>
01858 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01859                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiLoadImageSection: Error 0x%x in session space mapping via MmMapViewOfSection\n"</span>, Status);
01860             }
01861 <span class="preprocessor">#endif</span>
01862 <span class="preprocessor"></span>
01863             CommittedPages = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
01864                                       MiGetPteAddress (BaseAddress),
01865                                       BYTES_TO_PAGES (SectionSize),
01866                                       ZeroKernelPte,
01867                                       TRUE,
01868                                       NULL);
01869 
01870             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
01871             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
01872 
01873             <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED1,
01874                 CommittedPages);
01875 
01876             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
01877 
01878             <span class="comment">//</span>
01879             <span class="comment">// Return the commitment we took out on the pagefile when</span>
01880             <span class="comment">// the page was allocated.  This is needed for collided images</span>
01881             <span class="comment">// since all the pages get committed regardless of writability.</span>
01882             <span class="comment">//</span>
01883 
01884             <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
01885         }
01886         <span class="keywordflow">else</span> {
01887             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01888             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesRequired;
01889             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(16, PagesRequired);
01890             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01891             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (FirstPte,
01892                                  SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes,
01893                                  SystemPteSpace);
01894         }
01895 
01896         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01897     }
01898 
01899     <span class="comment">//</span>
01900     <span class="comment">// Allocate a physical page(s) and copy the image data.</span>
01901     <span class="comment">// Note Hydra has already allocated the physical pages and just does</span>
01902     <span class="comment">// data copying here.</span>
01903     <span class="comment">//</span>
01904 
01905     ProtoPte = SectionPointer-&gt;Segment-&gt;PrototypePte;
01906     NumberOfPtes = SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes;
01907 
01908     *ImageBaseAddress = SystemVa;
01909 
01910     UserVa = Base;
01911     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
01912 <span class="preprocessor">#if defined(_IA64_)</span>
01913 <span class="preprocessor"></span>    TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a84">MM_PTE_EXECUTE</a>;
01914 <span class="preprocessor">#endif</span>
01915 <span class="preprocessor"></span>
01916     <span class="keywordflow">while</span> (NumberOfPtes != 0) {
01917         PteContents = *ProtoPte;
01918         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
01919             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>)) {
01920 
01921             <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01922                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01923                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
01924                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
01925                                     MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
01926                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
01927 <span class="preprocessor">#if defined(_IA64_)</span>
01928 <span class="preprocessor"></span>
01929                 <span class="comment">//</span>
01930                 <span class="comment">// EM needs execute permission.</span>
01931                 <span class="comment">//</span>
01932 
01933                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection |= <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>;
01934 
01935 <span class="preprocessor">#endif</span>
01936 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
01937 
01938                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01939                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
01940                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01941                 LastPte = PointerPte;
01942 
01943                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_PFN_ELEMENT (PageFrameIndex)-&gt;u1.WsIndex == 0);
01944             }
01945 
01946             <span class="keywordflow">try</span> {
01947 
01948                 RtlMoveMemory (SystemVa, UserVa, PAGE_SIZE);
01949 
01950             } except (MiMapCacheExceptionFilter (&amp;ExceptionStatus,
01951                                                  GetExceptionInformation())) {
01952 
01953                 <span class="comment">//</span>
01954                 <span class="comment">// An exception occurred, unmap the view and</span>
01955                 <span class="comment">// return the error to the caller.</span>
01956                 <span class="comment">//</span>
01957 
01958 <span class="preprocessor">#if DBG</span>
01959 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiLoadImageSection: Exception 0x%x copying driver SystemVa 0x%p, UserVa 0x%p\n"</span>,ExceptionStatus,SystemVa,UserVa);
01960 <span class="preprocessor">#endif</span>
01961 <span class="preprocessor"></span>
01962                 <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01963                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
01964                     CommittedPages = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
01965                                               MiGetPteAddress (BaseAddress),
01966                                               BYTES_TO_PAGES (SectionSize),
01967                                               ZeroKernelPte,
01968                                               TRUE,
01969                                               NULL);
01970 
01971                     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
01972                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
01973 
01974                     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED2,
01975                         CommittedPages);
01976 
01977                     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
01978 
01979                     <span class="comment">//</span>
01980                     <span class="comment">// Return the commitment we took out on the pagefile when</span>
01981                     <span class="comment">// the page was allocated.  This is needed for collided</span>
01982                     <span class="comment">// images since all the pages get committed regardless</span>
01983                     <span class="comment">// of writability.</span>
01984                     <span class="comment">//</span>
01985 
01986                     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommittedPages);
01987                     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_SESSION_DRIVER_LOAD_FAILURE1, CommittedPages);
01988                 }
01989                 <span class="keywordflow">else</span> {
01990                     ProtoPte = FirstPte;
01991                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01992                     <span class="keywordflow">while</span> (ProtoPte &lt;= PointerPte) {
01993                         <span class="keywordflow">if</span> (ProtoPte-&gt;u.Hard.Valid == 1) {
01994 
01995                             <span class="comment">//</span>
01996                             <span class="comment">// Delete the page.</span>
01997                             <span class="comment">//</span>
01998 
01999                             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (ProtoPte);
02000 
02001                             <span class="comment">//</span>
02002                             <span class="comment">// Set the pointer to PTE as empty so the page</span>
02003                             <span class="comment">// is deleted when the reference count goes to zero.</span>
02004                             <span class="comment">//</span>
02005 
02006                             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02007                             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
02008                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02009                             <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
02010 
02011                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (ProtoPte, ZeroPte);
02012                         }
02013                         ProtoPte += 1;
02014                     }
02015 
02016                     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesRequired;
02017                     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(17, PagesRequired);
02018                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02019                     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (FirstPte,
02020                                          SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes,
02021                                          SystemPteSpace);
02022                 }
02023 
02024                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a> (TargetProcess, Base);
02025 
02026                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NT_SUCCESS (Status));
02027 
02028                 <span class="keywordflow">if</span> (TargetProcess != Process) {
02029                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02030                     <span class="keywordflow">if</span> (ProcessReferenced == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02031                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
02032                     }
02033                 }
02034 
02035                 <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02036                     <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BaseAddress);
02037                 }
02038 
02039                 <span class="keywordflow">return</span> ExceptionStatus;
02040             }
02041 
02042         }
02043         <span class="keywordflow">else</span> {
02044 
02045             <span class="comment">//</span>
02046             <span class="comment">// The PTE is no access - if this driver is being loaded in session</span>
02047             <span class="comment">// space we already preloaded the page so free it now.  The</span>
02048             <span class="comment">// commitment is returned when the whole image is unmapped.</span>
02049             <span class="comment">//</span>
02050 
02051             <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02052                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
02053                 CommittedPages = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
02054                                           MiGetPteAddress (SystemVa),
02055                                           1,
02056                                           ZeroKernelPte,
02057                                           TRUE,
02058                                           NULL);
02059 
02060                 <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_COMMIT_IMAGELOAD_NOACCESS,
02061                     1);
02062             }
02063             <span class="keywordflow">else</span> {
02064                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroKernelPte);
02065             }
02066         }
02067 
02068         NumberOfPtes -= 1;
02069         ProtoPte += 1;
02070         PointerPte += 1;
02071         SystemVa = ((PCHAR)SystemVa + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02072         UserVa = ((PCHAR)UserVa + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02073     }
02074 
02075     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a> (TargetProcess, Base);
02076     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NT_SUCCESS (Status));
02077 
02078     <span class="keywordflow">if</span> (TargetProcess != Process) {
02079         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02080         <span class="keywordflow">if</span> (ProcessReferenced == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02081             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
02082         }
02083     }
02084 
02085     <span class="comment">//</span>
02086     <span class="comment">// Indicate that this section has been loaded into the system.</span>
02087     <span class="comment">//</span>
02088 
02089     SectionPointer-&gt;Segment-&gt;SystemImageBase = *ImageBaseAddress;
02090 
02091     <span class="comment">//</span>
02092     <span class="comment">// Charge commitment for the number of pages that were used by</span>
02093     <span class="comment">// the driver.</span>
02094     <span class="comment">//</span>
02095 
02096     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02097         <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (PagesRequired, TRUE);
02098         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_DRIVER_PAGES, PagesRequired);
02099         <a class="code" href="../../d8/d5/kddata_8c.html#a32">MmDriverCommit</a> += (ULONG)PagesRequired;
02100     }
02101 
02102     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02103 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="sysload.c::MiLoadSystemImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiLoadSystemImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING NamePrefix&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING LoadedBaseName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadInSessionSpace</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageBaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LockDownPages</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">443</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00062">BaseName</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols()</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00769">IMAGE_ADDRESSING_MODE_32BIT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00757">_IMAGE_INFO::ImageAddressingMode</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00763">_IMAGE_INFO::ImageBase</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00766">_IMAGE_INFO::ImageSectionNumber</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00764">_IMAGE_INFO::ImageSelector</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00765">_IMAGE_INFO::ImageSize</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d4/ppc_2flush_8c-source.html#l00356">KeSweepIcache()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00091">LdrRelocateImage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03448">MiApplyDriverVerifier()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00166">MiCheckPageFilePath()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02208">MiEnablePagingOfDriver()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00061">MiFirstDriverLoadEver</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05376">MiSetImageProtect()</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00139">MM_EXECUTE_READWRITE</a>, <a class="el" href="../../d0/d1/psinit_8c.html#a39">MmCheckSystemImage()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03164">MmMapViewInSystemSpace()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02472">MmPageEntireDriver()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00381">MmSectionObjectType</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00928">MmSystemLoadLock</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00047">NO_IMPORTS_USED</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02183">PERFINFO_IMAGE_LOAD</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00755">_IMAGE_INFO::Properties</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02396">PsCallImageNotifyRoutines()</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00880">PsImageNotifyEnabled</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00080">PsLoadedModuleSpinLock</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00056">RtlInitString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05575">_MM_SESSION_SPACE::Session</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00758">_IMAGE_INFO::SystemModeImage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02633">_MMSESSION::SystemSpaceViewStart</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00379">MmLoadAndLockSystemImage()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l00315">MmLoadSystemImage()</a>.
<p>
<pre class="fragment"><div>00455                    :
00456 
00457     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section into
00458     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL's header.
00459 
00460     At successful completion, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> remains
00461     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unloaded.
00462 
00463 Arguments:
00464 
00465     ImageFileName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name (including the image name)
00466                     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
00467 
00468     NamePrefix - If present, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix to use with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image name on
00469                  load operations.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to load <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same image multiple
00470                  times, by <span class="keyword">using</span> different prefixes.
00471 
00472     LoadedBaseName - If present, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name to use on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00473                      loaded image instead of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name found on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00474                      image name.
00475 
00476     LoadInSessionSpace - Supplies whether to load <span class="keyword">this</span> image in session space.
00477                          Each session gets a different copy of <span class="keyword">this</span> driver with
00478                          pages shared as much as possible via copy on write.
00479 
00480     ImageHandle - Returns an opaque pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced section object
00481                   of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image that was loaded.
00482 
00483     ImageBaseAddress - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image base within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00484 
00485     LockDownPages - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image pages should be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> nonpagable.
00486 
00487 Return Value:
00488 
00489     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load operation.
00490 
00491 --*/
00492 
00493 {
00494     KIRQL OldIrql;
00495     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00496     LDR_DATA_TABLE_ENTRY TempDataTableEntry;
00497     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00498     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer;
00499     PIMAGE_NT_HEADERS NtHeaders;
00500     UNICODE_STRING PrefixedImageName;
00501     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>;
00502     UNICODE_STRING BaseDirectory;
00503     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00504     HANDLE FileHandle;
00505     HANDLE SectionHandle;
00506     IO_STATUS_BLOCK IoStatus;
00507     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> NameBuffer[ MAXIMUM_FILENAME_LENGTH ];
00508     PLIST_ENTRY NextEntry;
00509     ULONG NumberOfPtes;
00510     ULONG_PTR ViewSize;
00511     PCHAR MissingProcedureName;
00512     PWSTR MissingDriverName;
00513     <a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a> LoadedImports;
00514     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session;
00515     BOOLEAN AlreadyOpen;
00516     BOOLEAN IssueUnloadOnFailure;
00517     ULONG SectionAccess;
00518     <span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00519     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PpeContents;
00520 
00521     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00522 
00523     LoadedImports = (<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)<a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
00524     SectionPointer = (PVOID)-1;
00525     FileHandle = (HANDLE)0;
00526     MissingProcedureName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00527     MissingDriverName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00528     IssueUnloadOnFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00529 
00530     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00531 
00532         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NamePrefix == NULL);
00533         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LoadedBaseName == NULL);
00534 
00535         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00536 
00537             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
00538 <span class="preprocessor">#if DBG</span>
00539 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiLoadSystemImage: no session space!\n"</span>);
00540 <span class="preprocessor">#endif</span>
00541 <span class="preprocessor"></span>                <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00542             }
00543 
00544             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmIsAddressValid (MmSessionSpace) == TRUE);
00545 
00546             Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
00547         }
00548         <span class="keywordflow">else</span> {
00549             Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
00550             LoadInSessionSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00551         }
00552     }
00553     <span class="keywordflow">else</span> {
00554         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
00555     }
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">// Get name roots</span>
00559     <span class="comment">//</span>
00560 
00561     <span class="keywordflow">if</span> (ImageFileName-&gt;Buffer[0] == OBJ_NAME_PATH_SEPARATOR) {
00562         PWCHAR p;
00563         ULONG l;
00564 
00565         p = &amp;ImageFileName-&gt;Buffer[ImageFileName-&gt;Length&gt;&gt;1];
00566         <span class="keywordflow">while</span> (*(p-1) != OBJ_NAME_PATH_SEPARATOR) {
00567             p--;
00568         }
00569         l = (ULONG)(&amp;ImageFileName-&gt;Buffer[ImageFileName-&gt;Length&gt;&gt;1] - p);
00570         l *= <span class="keyword">sizeof</span>(WCHAR);
00571         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)l;
00572         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer = p;
00573     } <span class="keywordflow">else</span> {
00574         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length = ImageFileName-&gt;Length;
00575         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer = ImageFileName-&gt;Buffer;
00576     }
00577 
00578     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
00579     BaseDirectory = *ImageFileName;
00580     BaseDirectory.Length -= <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
00581     BaseDirectory.MaximumLength = BaseDirectory.Length;
00582     PrefixedImageName = *ImageFileName;
00583 
00584     <span class="comment">//</span>
00585     <span class="comment">// If there's a name prefix, add it to the PrefixedImageName.</span>
00586     <span class="comment">//</span>
00587 
00588     <span class="keywordflow">if</span> (NamePrefix) {
00589         PrefixedImageName.MaximumLength =
00590                 BaseDirectory.Length + NamePrefix-&gt;Length + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
00591 
00592         PrefixedImageName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00593                                     NonPagedPool,
00594                                     PrefixedImageName.MaximumLength,
00595                                     'dLmM'
00596                                     );
00597 
00598         <span class="keywordflow">if</span> (!PrefixedImageName.Buffer) {
00599             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00600         }
00601 
00602         PrefixedImageName.Length = 0;
00603         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;PrefixedImageName, &amp;BaseDirectory);
00604         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;PrefixedImageName, NamePrefix);
00605         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;PrefixedImageName, &amp;BaseName);
00606 
00607         <span class="comment">//</span>
00608         <span class="comment">// Alter the basename to match</span>
00609         <span class="comment">//</span>
00610 
00611         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer = PrefixedImageName.Buffer + BaseDirectory.Length / <span class="keyword">sizeof</span>(WCHAR);
00612         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length += NamePrefix-&gt;Length;
00613         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.MaximumLength += NamePrefix-&gt;Length;
00614     }
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// If there's a loaded base name, use it instead of the base name.</span>
00618     <span class="comment">//</span>
00619 
00620     <span class="keywordflow">if</span> (LoadedBaseName) {
00621         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> = *LoadedBaseName;
00622     }
00623 
00624 <span class="preprocessor">#if DBG</span>
00625 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS ) {
00626         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM:SYSLDR Loading %wZ (%wZ) %s\n"</span>,
00627             &amp;PrefixedImageName,
00628             &amp;BaseName,
00629             LoadInSessionSpace ? <span class="stringliteral">"in session space"</span> : <span class="stringliteral">" "</span>);
00630     }
00631 <span class="preprocessor">#endif</span>
00632 <span class="preprocessor"></span>
00633     AlreadyOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// Arbitrary process context so prevent suspend APCs now.</span>
00637     <span class="comment">//</span>
00638 
00639     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00640 
00641     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MmSystemLoadLock,
00642                            WrVirtualMemory,
00643                            KernelMode,
00644                            FALSE,
00645                            (PLARGE_INTEGER)NULL);
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// Check to see if this name already exists in the loader database.</span>
00649     <span class="comment">//</span>
00650 
00651     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
00652     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
00653 
00654         DataTableEntry = CONTAINING_RECORD(NextEntry,
00655                                            LDR_DATA_TABLE_ENTRY,
00656                                            InLoadOrderLinks);
00657 
00658         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;PrefixedImageName,
00659                                    &amp;DataTableEntry-&gt;FullDllName,
00660                                    TRUE)) {
00661 
00662             <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00663 
00664                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (DataTableEntry-&gt;DllBase) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00665 
00666                     <span class="comment">//</span>
00667                     <span class="comment">// The caller is trying to load a driver in session space</span>
00668                     <span class="comment">// that has already been loaded in system space.  This is</span>
00669                     <span class="comment">// not allowed.</span>
00670                     <span class="comment">//</span>
00671 
00672                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00673                     <span class="keywordflow">goto</span> return2;
00674                 }
00675 
00676                 AlreadyOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00677 
00678                 <span class="comment">//</span>
00679                 <span class="comment">// The LoadCount should generally not be 0 here, but it is</span>
00680                 <span class="comment">// possible in the case where an attempt has been made to</span>
00681                 <span class="comment">// unload a DLL on last dereference, but the DLL refused to</span>
00682                 <span class="comment">// unload.</span>
00683                 <span class="comment">//</span>
00684 
00685                 DataTableEntry-&gt;LoadCount += 1;
00686                 SectionPointer = DataTableEntry-&gt;SectionPointer;
00687                 <span class="keywordflow">break</span>;
00688             }
00689             <span class="keywordflow">else</span> {
00690                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (DataTableEntry-&gt;DllBase) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00691 
00692                     <span class="comment">//</span>
00693                     <span class="comment">// The caller is trying to load a driver in systemwide space</span>
00694                     <span class="comment">// that has already been loaded in session space.  This is</span>
00695                     <span class="comment">// not allowed.</span>
00696                     <span class="comment">//</span>
00697 
00698                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00699                     <span class="keywordflow">goto</span> return2;
00700                 }
00701             }
00702 
00703             *ImageHandle = DataTableEntry;
00704             *ImageBaseAddress = DataTableEntry-&gt;DllBase;
00705             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_IMAGE_ALREADY_LOADED;
00706             <span class="keywordflow">goto</span> return2;
00707         }
00708 
00709         NextEntry = NextEntry-&gt;Flink;
00710     }
00711 
00712     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AlreadyOpen == TRUE || NextEntry == &amp;PsLoadedModuleList);
00713 
00714     <span class="keywordflow">if</span> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00715 
00716         DataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00717 
00718         <span class="comment">//</span>
00719         <span class="comment">// Attempt to open the driver image itself.  If this fails, then the</span>
00720         <span class="comment">// driver image cannot be located, so nothing else matters.</span>
00721         <span class="comment">//</span>
00722 
00723         InitializeObjectAttributes (&amp;ObjectAttributes,
00724                                     ImageFileName,
00725                                     OBJ_CASE_INSENSITIVE,
00726                                     NULL,
00727                                     NULL );
00728 
00729         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a> (&amp;FileHandle,
00730                              FILE_EXECUTE,
00731                              &amp;ObjectAttributes,
00732                              &amp;IoStatus,
00733                              FILE_SHARE_READ | FILE_SHARE_DELETE,
00734                              0 );
00735 
00736         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00737 
00738 <span class="preprocessor">#if DBG</span>
00739 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
00740                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiLoadImageSection: cannot open %wZ\n"</span>,
00741                     ImageFileName);
00742             }
00743 <span class="preprocessor">#endif</span>
00744 <span class="preprocessor"></span>            <span class="comment">//</span>
00745             <span class="comment">// Don't raise hard error status for file not found.</span>
00746             <span class="comment">//</span>
00747 
00748             <span class="keywordflow">goto</span> return2;
00749         }
00750 
00751         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a39">MmCheckSystemImage</a>(FileHandle);
00752         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_IMAGE_CHECKSUM_MISMATCH) ||
00753             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_IMAGE_MP_UP_MISMATCH) ||
00754             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_IMAGE_PROTECT)) {
00755             <span class="keywordflow">goto</span> return1;
00756         }
00757 
00758         <span class="comment">//</span>
00759         <span class="comment">// Now attempt to create an image section for the file.  If this fails,</span>
00760         <span class="comment">// then the driver file is not an image.  Session space drivers are</span>
00761         <span class="comment">// shared text with copy on write data, so don't allow writes here.</span>
00762         <span class="comment">//</span>
00763 
00764         <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00765             SectionAccess = SECTION_MAP_READ | SECTION_MAP_EXECUTE;
00766         }
00767         <span class="keywordflow">else</span> {
00768             SectionAccess = SECTION_ALL_ACCESS;
00769         }
00770 
00771         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateSection (&amp;SectionHandle,
00772                                   SectionAccess,
00773                                   (POBJECT_ATTRIBUTES) NULL,
00774                                   (PLARGE_INTEGER) NULL,
00775                                   PAGE_EXECUTE,
00776                                   SEC_IMAGE,
00777                                   FileHandle );
00778 
00779         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00780             <span class="keywordflow">goto</span> return1;
00781         }
00782 
00783         <span class="comment">//</span>
00784         <span class="comment">// Now reference the section handle.</span>
00785         <span class="comment">//</span>
00786 
00787         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (SectionHandle,
00788                                         SECTION_MAP_EXECUTE,
00789                                         MmSectionObjectType,
00790                                         KernelMode,
00791                                         (PVOID *) &amp;SectionPointer,
00792                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
00793 
00794         ZwClose (SectionHandle);
00795         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
00796             <span class="keywordflow">goto</span> return1;
00797         }
00798 
00799         <span class="keywordflow">if</span> (SectionPointer-&gt;Segment-&gt;ControlArea-&gt;NumberOfSubsections == 1) {
00800             <span class="keywordflow">if</span> ((LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00801                 (SectionPointer-&gt;Segment-&gt;BasedAddress != (PVOID)Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o2">SystemSpaceViewStart</a>)) {
00802 
00803                 <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer2;
00804 
00805                 <span class="comment">//</span>
00806                 <span class="comment">// The driver was linked with subsection alignment such that</span>
00807                 <span class="comment">// it is mapped with one subsection.  Since the CreateSection</span>
00808                 <span class="comment">// above guarantees that the driver image is indeed a</span>
00809                 <span class="comment">// satisfactory executable, map it directly now to reuse the</span>
00810                 <span class="comment">// cache from the MmCheckSystemImage call above.</span>
00811                 <span class="comment">//</span>
00812 
00813                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateSection (&amp;SectionHandle,
00814                                           SectionAccess,
00815                                           (POBJECT_ATTRIBUTES) NULL,
00816                                           (PLARGE_INTEGER) NULL,
00817                                           PAGE_EXECUTE,
00818                                           SEC_COMMIT,
00819                                           FileHandle );
00820 
00821                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00822 
00823                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
00824                                             SectionHandle,
00825                                             SECTION_MAP_EXECUTE,
00826                                             MmSectionObjectType,
00827                                             KernelMode,
00828                                             (PVOID *) &amp;SectionPointer2,
00829                                             (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
00830 
00831                     ZwClose (SectionHandle);
00832 
00833                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
00834 
00835                         <span class="comment">//</span>
00836                         <span class="comment">// The number of PTEs won't match if the image is</span>
00837                         <span class="comment">// stripped and the debug directory crosses the last</span>
00838                         <span class="comment">// sector boundary of the file.  We could still use the</span>
00839                         <span class="comment">// new section, but these cases are under 2% of all the</span>
00840                         <span class="comment">// drivers loaded so don't bother.</span>
00841                         <span class="comment">//</span>
00842 
00843                         <span class="keywordflow">if</span> (SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes == SectionPointer2-&gt;Segment-&gt;TotalNumberOfPtes) {
00844                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionPointer);
00845                             SectionPointer = SectionPointer2;
00846                         }
00847                         <span class="keywordflow">else</span> {
00848                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionPointer2);
00849                         }
00850                     }
00851                 }
00852             }
00853         }
00854 
00855     }
00856 
00857     <span class="keywordflow">if</span> ((LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00858         (SectionPointer-&gt;Segment-&gt;BasedAddress == (PVOID)Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o2">SystemSpaceViewStart</a>) &amp;&amp;
00859         (SectionPointer-&gt;Segment-&gt;ControlArea-&gt;NumberOfMappedViews == 0)) {
00860         NumberOfPtes = 0;
00861         ViewSize = 0;
00862 
00863         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a27">MmMapViewInSystemSpace</a> (SectionPointer,
00864                                          ImageBaseAddress,
00865                                          &amp;ViewSize);
00866         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp;
00867             (*ImageBaseAddress == SectionPointer-&gt;Segment-&gt;BasedAddress))) {
00868 
00869             SectionPointer-&gt;Segment-&gt;SystemImageBase = *ImageBaseAddress;
00870             SectionPointer-&gt;Segment-&gt;ControlArea-&gt;u.Flags.ImageMappedInSystemSpace = 1;
00871             NumberOfPtes = (ULONG)((ViewSize + 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00872             <a class="code" href="../../d8/d8/sysload_8c.html#a62">MiSetImageProtect</a>(SectionPointer-&gt;Segment, MM_EXECUTE_READWRITE);
00873 
00874 <span class="preprocessor">#if defined (_AXP64_)</span>
00875 <span class="preprocessor"></span>
00876             <span class="comment">//</span>
00877             <span class="comment">// This is needed because win32k calls are made from the system</span>
00878             <span class="comment">// process on non-Hydra systems.  On Hydra systems, these calls</span>
00879             <span class="comment">// are always made from the relevant session's csrss process.</span>
00880             <span class="comment">// If these were the same, this PPE duplication could be removed.</span>
00881             <span class="comment">//</span>
00882 
00883             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (*ImageBaseAddress);
00884             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0);
00885             PpeContents = *PointerPpe;
00886             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00887             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;u.Long == 0);
00888             *PointerPpe = PpeContents;
00889             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00890 <span class="preprocessor">#endif</span>
00891 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> BindImage;
00892         }
00893     }
00894 
00895     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
00896 
00897     <span class="comment">//</span>
00898     <span class="comment">// Load the driver from the filesystem and pick a virtual address for it.</span>
00899     <span class="comment">// For Hydra, this means also allocating session virtual space, and</span>
00900     <span class="comment">// after mapping a view of the image, either copying or sharing the</span>
00901     <span class="comment">// driver's code and data in the session virtual space.</span>
00902     <span class="comment">//</span>
00903     <span class="comment">// If it is a share map because the image was loaded at its based address,</span>
00904     <span class="comment">// the disk image will remain busy.</span>
00905     <span class="comment">//</span>
00906 
00907     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a33">MiLoadImageSection</a> (SectionPointer,
00908                                  ImageBaseAddress,
00909                                  ImageFileName,
00910                                  LoadInSessionSpace);
00911 
00912     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
00913 
00914     NumberOfPtes = SectionPointer-&gt;Segment-&gt;TotalNumberOfPtes;
00915 
00916     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ALREADY_COMMITTED) {
00917 
00918         <span class="comment">//</span>
00919         <span class="comment">// This is a driver that was relocated that is being loaded into</span>
00920         <span class="comment">// the same session space twice.  Don't increment the overall load</span>
00921         <span class="comment">// count - just the image count in the session which has already been</span>
00922         <span class="comment">// done.</span>
00923         <span class="comment">//</span>
00924 
00925         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
00926         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AlreadyOpen == TRUE);
00927         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LoadInSessionSpace == TRUE);
00928         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry != NULL);
00929         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount &gt; 1);
00930 
00931         *ImageHandle = DataTableEntry;
00932         *ImageBaseAddress = DataTableEntry-&gt;DllBase;
00933 
00934         DataTableEntry-&gt;LoadCount -= 1;
00935         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00936         <span class="keywordflow">goto</span> return1;
00937     }
00938 
00939     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a10">MiFirstDriverLoadEver</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00940 
00941         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> PagingPathStatus;
00942 
00943         <span class="comment">//</span>
00944         <span class="comment">// Check with all of the drivers along the path to win32k.sys to</span>
00945         <span class="comment">// ensure that they are willing to follow the rules required</span>
00946         <span class="comment">// of them and to give them a chance to lock down code and data</span>
00947         <span class="comment">// that needs to be locked.  If any of the drivers along the path</span>
00948         <span class="comment">// refuses to participate, fail the win32k.sys load.</span>
00949         <span class="comment">//</span>
00950 
00951         <span class="comment">//</span>
00952         <span class="comment">// It is assumed that all drivers live on the same physical drive, so</span>
00953         <span class="comment">// when the very first driver is loaded, this check can be made.</span>
00954         <span class="comment">// This eliminates the need to check for things like relocated win32ks,</span>
00955         <span class="comment">// Terminal Server systems, etc.</span>
00956         <span class="comment">//</span>
00957 
00958         PagingPathStatus = <a class="code" href="../../d8/d8/sysload_8c.html#a50">MiCheckPageFilePath</a> (SectionPointer-&gt;Segment-&gt;ControlArea-&gt;FilePointer);
00959 
00960         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(PagingPathStatus)) {
00961 
00962             KdPrint(( <span class="stringliteral">"MiCheckPageFilePath FAILED for win32k.sys: %x\n"</span>,
00963                 PagingPathStatus ));
00964 
00965             <span class="comment">//</span>
00966             <span class="comment">// BUGBUG: Failing the insertion of win32k.sys' device in the</span>
00967             <span class="comment">// pagefile path is commented out until the storage drivers have</span>
00968             <span class="comment">// been modified to correctly handle this request.  Add code</span>
00969             <span class="comment">// here to release relevant resources for the error path.</span>
00970             <span class="comment">//</span>
00971         }
00972 
00973         <a class="code" href="../../d8/d8/sysload_8c.html#a10">MiFirstDriverLoadEver</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00974     }
00975 
00976     <span class="comment">//</span>
00977     <span class="comment">// Normal drivers are dereferenced here and their images can then be</span>
00978     <span class="comment">// overwritten.  This is ok because we've already read the whole thing</span>
00979     <span class="comment">// into memory and from here until reboot (or unload), we back them</span>
00980     <span class="comment">// with the pagefile.</span>
00981     <span class="comment">//</span>
00982     <span class="comment">// win32k.sys and session space drivers are the exception - these images</span>
00983     <span class="comment">// are inpaged from the filesystem and we need to keep our reference to</span>
00984     <span class="comment">// the file so that it doesn't get overwritten.</span>
00985     <span class="comment">//</span>
00986 
00987     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00988         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionPointer);
00989         SectionPointer = (PVOID)-1;
00990     }
00991 
00992     <span class="comment">//</span>
00993     <span class="comment">// The module LoadCount will be 1 here if the module was just loaded.</span>
00994     <span class="comment">// The LoadCount will be &gt;1 if it was attached to by a session (as opposed</span>
00995     <span class="comment">// to just loaded).</span>
00996     <span class="comment">//</span>
00997 
00998     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00999         <span class="keywordflow">if</span> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01000 
01001             <span class="comment">//</span>
01002             <span class="comment">// We're failing and we were just attaching to an already loaded</span>
01003             <span class="comment">// driver.  We don't want to go through the forced unload path</span>
01004             <span class="comment">// because we've already deleted the address space.  Simply</span>
01005             <span class="comment">// decrement our reference and null the DataTableEntry</span>
01006             <span class="comment">// so we don't go through the forced unload path.</span>
01007             <span class="comment">//</span>
01008 
01009             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry != NULL);
01010             DataTableEntry-&gt;LoadCount -= 1;
01011             DataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01012         }
01013         <span class="keywordflow">goto</span> return1;
01014     }
01015 
01016     <span class="comment">//</span>
01017     <span class="comment">// Error recovery from this point out for sessions works as follows:</span>
01018     <span class="comment">//</span>
01019     <span class="comment">// For sessions, we may or may not have a DataTableEntry at this point.</span>
01020     <span class="comment">// If we do, it's because we're attaching to a driver that has already</span>
01021     <span class="comment">// been loaded - and the DataTableEntry-&gt;LoadCount has been bumped - so</span>
01022     <span class="comment">// the error recovery from here on out is to just call</span>
01023     <span class="comment">// MmUnloadSystemImage with the DataTableEntry.</span>
01024     <span class="comment">//</span>
01025     <span class="comment">// If this is the first load of a given driver into a session space, we</span>
01026     <span class="comment">// have no DataTableEntry at this point.  The view has already been mapped</span>
01027     <span class="comment">// and committed and the group/session addresses reserved for this DLL.</span>
01028     <span class="comment">// The error recovery path handles all this because</span>
01029     <span class="comment">// MmUnloadSystemImage will zero the relevant fields in the</span>
01030     <span class="comment">// LDR_DATA_TABLE_ENTRY so that MmUnloadSystemImage will work properly.</span>
01031     <span class="comment">//</span>
01032 
01033     IssueUnloadOnFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01034 
01035     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || *ImageBaseAddress != SectionPointer-&gt;Segment-&gt;BasedAddress) {
01036 
01037 <span class="preprocessor">#if DBG</span>
01038 <span class="preprocessor"></span>
01039         <span class="comment">//</span>
01040         <span class="comment">// Warn users about session images that cannot be shared</span>
01041         <span class="comment">// because they were linked at a bad address.</span>
01042         <span class="comment">//</span>
01043 
01044         <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>) {
01045             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Session %d image %wZ is linked at a nonsharable address (%p)\n"</span>,
01046                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
01047                     ImageFileName,
01048                     SectionPointer-&gt;Segment-&gt;BasedAddress);
01049             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Image %wZ has been moved to address (%p) by the system so it can run,\n"</span>,
01050                     ImageFileName,
01051                     *ImageBaseAddress);
01052             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">" but this needs to be fixed in the image for sharing to occur.\n"</span>);
01053         }
01054 <span class="preprocessor">#endif</span>
01055 <span class="preprocessor"></span>
01056         <span class="comment">//</span>
01057         <span class="comment">// Apply the fixups to the section and resolve its image references.</span>
01058         <span class="comment">//</span>
01059 
01060         <span class="keywordflow">try</span> {
01061             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d3/ldrreloc_8c.html#a5">LdrRelocateImage</a>(*ImageBaseAddress,
01062                                                 <span class="stringliteral">"SYSLDR"</span>,
01063                                                 (ULONG)STATUS_SUCCESS,
01064                                                 (ULONG)STATUS_CONFLICTING_ADDRESSES,
01065                                                 (ULONG)STATUS_INVALID_IMAGE_FORMAT
01066                                                 );
01067         } except (EXCEPTION_EXECUTE_HANDLER) {
01068             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01069             KdPrint((<span class="stringliteral">"MM:sysload - LdrRelocateImage failed status %lx\n"</span>,
01070                       Status));
01071         }
01072 
01073         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01074 
01075             <span class="comment">//</span>
01076             <span class="comment">// Unload the system image and dereference the section.</span>
01077             <span class="comment">//</span>
01078 
01079             <span class="keywordflow">goto</span> return1;
01080         }
01081     }
01082 
01083 BindImage:
01084 
01085     <span class="keywordflow">try</span> {
01086         MissingProcedureName = NameBuffer;
01087 
01088         <span class="comment">//</span>
01089         <span class="comment">// Resolving the image references results in other DLLs being</span>
01090         <span class="comment">// loaded if they are referenced by the module that was just loaded.</span>
01091         <span class="comment">// An example is when an OEM printer or FAX driver links with</span>
01092         <span class="comment">// other general libraries.  This is not a problem for session space</span>
01093         <span class="comment">// because the general libraries do not have the global data issues</span>
01094         <span class="comment">// that win32k.sys and the video drivers do.  So we just call the</span>
01095         <span class="comment">// standard kernel reference resolver and any referenced libraries</span>
01096         <span class="comment">// get loaded into system global space.  Code in the routine</span>
01097         <span class="comment">// restricts which libraries can be referenced by a driver.</span>
01098         <span class="comment">//</span>
01099 
01100         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a31">MiResolveImageReferences</a>(*ImageBaseAddress,
01101                                           &amp;BaseDirectory,
01102                                           NamePrefix,
01103                                           FALSE,
01104                                           &amp;MissingProcedureName,
01105                                           &amp;MissingDriverName,
01106                                           &amp;LoadedImports
01107                                          );
01108     } except (EXCEPTION_EXECUTE_HANDLER) {
01109         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01110         KdPrint((<span class="stringliteral">"MM:sysload - ResolveImageReferences failed status %x\n"</span>,
01111                     Status));
01112     }
01113 
01114     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01115 <span class="preprocessor">#if DBG</span>
01116 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_DRIVER_ORDINAL_NOT_FOUND ||
01117             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_DRIVER_ENTRYPOINT_NOT_FOUND) {
01118 
01119             <span class="keywordflow">if</span> ((ULONG_PTR)MissingProcedureName &amp; ~((ULONG_PTR) (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>-1))) {
01120                 <span class="comment">//</span>
01121                 <span class="comment">// If not an ordinal, print string</span>
01122                 <span class="comment">//</span>
01123                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MissingProcedureName %s\n"</span>, MissingProcedureName);
01124             }
01125             <span class="keywordflow">else</span> {
01126                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MissingProcedureName 0x%p\n"</span>, MissingProcedureName);
01127             }
01128 
01129             <span class="keywordflow">if</span> (MissingDriverName) {
01130                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MissingDriverName %ws\n"</span>, MissingDriverName);
01131             }
01132         }
01133 <span class="preprocessor">#endif</span>
01134 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> return1;
01135     }
01136 
01137 <span class="preprocessor">#if DBG</span>
01138 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
01139         KdPrint ((<span class="stringliteral">"MM:loaded driver - consumed %ld. pages\n"</span>,MiPagesConsumed));
01140     }
01141 <span class="preprocessor">#endif</span>
01142 <span class="preprocessor"></span>
01143     <span class="keywordflow">if</span> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01144 
01145         <span class="comment">//</span>
01146         <span class="comment">// Since there was no loaded module list entry for this driver, create</span>
01147         <span class="comment">// one now.</span>
01148         <span class="comment">//</span>
01149 
01150 <span class="preprocessor">#if DBG</span>
01151 <span class="preprocessor"></span>        NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
01152         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
01153             DataTableEntry = CONTAINING_RECORD(NextEntry,
01154                                                LDR_DATA_TABLE_ENTRY,
01155                                                InLoadOrderLinks);
01156 
01157             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (ImageFileName,
01158                                        &amp;DataTableEntry-&gt;FullDllName,
01159                                        TRUE)) {
01160 
01161                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM SYSLDR: Image already loaded! RefCount %x\n"</span>,
01162                     DataTableEntry-&gt;LoadCount);
01163                 DbgBreakPoint();
01164             }
01165 
01166             NextEntry = NextEntry-&gt;Flink;
01167         }
01168 <span class="preprocessor">#endif</span>
01169 <span class="preprocessor"></span>
01170         <span class="comment">//</span>
01171         <span class="comment">// Allocate a data table entry for structured exception handling.</span>
01172         <span class="comment">//</span>
01173 
01174         DataTableEntry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01175                                                 <span class="keyword">sizeof</span>(LDR_DATA_TABLE_ENTRY),
01176                                                 'dLmM');
01177 
01178         <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01179             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01180             <span class="keywordflow">goto</span> return1;
01181         }
01182 
01183         DataTableEntry-&gt;BaseDllName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
01184                                         NonPagedPool,
01185                                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length + <span class="keyword">sizeof</span>(UNICODE_NULL),
01186                                         'dLmM');
01187 
01188         <span class="keywordflow">if</span> (DataTableEntry-&gt;BaseDllName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01189             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry);
01190             DataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01191             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01192             <span class="keywordflow">goto</span> return1;
01193         }
01194 
01195         <span class="comment">//</span>
01196         <span class="comment">// Initialize the address of the DLL image file header and the entry</span>
01197         <span class="comment">// point address.</span>
01198         <span class="comment">//</span>
01199 
01200         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(*ImageBaseAddress);
01201 
01202         DataTableEntry-&gt;DllBase = *ImageBaseAddress;
01203         DataTableEntry-&gt;EntryPoint =
01204             ((PCHAR)*ImageBaseAddress + NtHeaders-&gt;OptionalHeader.AddressOfEntryPoint);
01205         DataTableEntry-&gt;SizeOfImage = NumberOfPtes &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01206         DataTableEntry-&gt;CheckSum = NtHeaders-&gt;OptionalHeader.CheckSum;
01207         DataTableEntry-&gt;SectionPointer = (PVOID)SectionPointer;
01208 
01209         <span class="comment">//</span>
01210         <span class="comment">// Store the DLL name.</span>
01211         <span class="comment">//</span>
01212 
01213         DataTableEntry-&gt;BaseDllName.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
01214         DataTableEntry-&gt;BaseDllName.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
01215         RtlMoveMemory (DataTableEntry-&gt;BaseDllName.Buffer,
01216                        <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer,
01217                        <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length );
01218         DataTableEntry-&gt;BaseDllName.Buffer[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
01219 
01220         DataTableEntry-&gt;FullDllName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
01221                                                          PrefixedImageName.Length + <span class="keyword">sizeof</span>(UNICODE_NULL),
01222                                                          'TDmM');
01223         <span class="keywordflow">if</span> (DataTableEntry-&gt;FullDllName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01224 
01225             <span class="comment">//</span>
01226             <span class="comment">// Pool could not be allocated, just set the length to 0.</span>
01227             <span class="comment">//</span>
01228 
01229             DataTableEntry-&gt;FullDllName.Length = 0;
01230             DataTableEntry-&gt;FullDllName.MaximumLength = 0;
01231         } <span class="keywordflow">else</span> {
01232             DataTableEntry-&gt;FullDllName.Length = PrefixedImageName.Length;
01233             DataTableEntry-&gt;FullDllName.MaximumLength = PrefixedImageName.Length;
01234             RtlMoveMemory (DataTableEntry-&gt;FullDllName.Buffer,
01235                            PrefixedImageName.Buffer,
01236                            PrefixedImageName.Length);
01237             DataTableEntry-&gt;FullDllName.Buffer[PrefixedImageName.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
01238         }
01239 
01240         <a class="code" href="../../d2/d1/mm_8h.html#a62">PERFINFO_IMAGE_LOAD</a>(DataTableEntry);
01241 
01242         <span class="comment">//</span>
01243         <span class="comment">// Initialize the flags, load count, and insert the data table entry</span>
01244         <span class="comment">// in the loaded module list.</span>
01245         <span class="comment">//</span>
01246 
01247         DataTableEntry-&gt;Flags = LDRP_ENTRY_PROCESSED | LDRP_SYSTEM_MAPPED;
01248         DataTableEntry-&gt;LoadCount = 1;
01249         DataTableEntry-&gt;LoadedImports = (PVOID)LoadedImports;
01250 
01251         <span class="keywordflow">if</span> ((NtHeaders-&gt;OptionalHeader.MajorOperatingSystemVersion &gt;= 5) &amp;&amp;
01252             (NtHeaders-&gt;OptionalHeader.MajorImageVersion &gt;= 5)) {
01253             DataTableEntry-&gt;Flags |= LDRP_ENTRY_NATIVE;
01254         }
01255 
01256         <a class="code" href="../../d9/d5/verifier_8c.html#a110">MiApplyDriverVerifier</a> (DataTableEntry, NULL);
01257 
01258         <a class="code" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage</a> (DataTableEntry-&gt;DllBase);
01259 
01260         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a72">PsImageNotifyEnabled</a>) {
01261             <a class="code" href="../../d2/d1/struct__IMAGE__INFO.html">IMAGE_INFO</a> ImageInfo;
01262 
01263             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o0">Properties</a> = 0;
01264             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o1">ImageAddressingMode</a> = <a class="code" href="../../d1/d9/ps_8h.html#a23">IMAGE_ADDRESSING_MODE_32BIT</a>;
01265             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o2">SystemModeImage</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01266             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = DataTableEntry-&gt;SizeOfImage;
01267             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o5">ImageBase</a> = *ImageBaseAddress;
01268             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o6">ImageSelector</a> = 0;
01269             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o8">ImageSectionNumber</a> = 0;
01270 
01271             <a class="code" href="../../d2/d8/ps_2create_8c.html#a28">PsCallImageNotifyRoutines</a>(ImageFileName, (HANDLE)NULL, &amp;ImageInfo);
01272         }
01273 
01274         <span class="comment">//</span>
01275         <span class="comment">// Acquire the loaded module list resource and insert this entry</span>
01276         <span class="comment">// into the list.</span>
01277         <span class="comment">//</span>
01278 
01279         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01280         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;PsLoadedModuleResource, TRUE);
01281 
01282         ExAcquireSpinLock (&amp;PsLoadedModuleSpinLock, &amp;OldIrql);
01283 
01284         InsertTailList(&amp;PsLoadedModuleList, &amp;DataTableEntry-&gt;InLoadOrderLinks);
01285 
01286         ExReleaseSpinLock (&amp;PsLoadedModuleSpinLock, OldIrql);
01287 
01288         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
01289         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01290 
01291         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols</a> (*ImageBaseAddress)) {
01292 
01293             <span class="comment">//</span>
01294             <span class="comment">//  TEMP TEMP TEMP rip out when debugger converted</span>
01295             <span class="comment">//</span>
01296 
01297             ANSI_STRING AnsiName;
01298             UNICODE_STRING UnicodeName;
01299 
01300             <span class="comment">//</span>
01301             <span class="comment">//  \SystemRoot is 11 characters in length</span>
01302             <span class="comment">//</span>
01303             <span class="keywordflow">if</span> (PrefixedImageName.Length &gt; (11 * <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp;
01304                 !_wcsnicmp( PrefixedImageName.Buffer, L<span class="stringliteral">"\\SystemRoot"</span>, 11 )
01305                ) {
01306                 UnicodeName = PrefixedImageName;
01307                 UnicodeName.Buffer += 11;
01308                 UnicodeName.Length -= (11 * <span class="keyword">sizeof</span>( WCHAR ));
01309                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (NameBuffer, <span class="stringliteral">"%ws%wZ"</span>, &amp;SharedUserData-&gt;NtSystemRoot[2], &amp;UnicodeName);
01310             } <span class="keywordflow">else</span> {
01311                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (NameBuffer, <span class="stringliteral">"%wZ"</span>, &amp;BaseName);
01312             }
01313             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a> (&amp;AnsiName, NameBuffer);
01314             DbgLoadImageSymbols (&amp;AnsiName,
01315                                  *ImageBaseAddress,
01316                                  (ULONG_PTR) -1
01317                                );
01318             DataTableEntry-&gt;Flags |= LDRP_DEBUG_SYMBOLS_LOADED;
01319         }
01320     }
01321 
01322     <span class="comment">//</span>
01323     <span class="comment">// Flush the instruction cache on all systems in the configuration.</span>
01324     <span class="comment">//</span>
01325 
01326     <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a7">KeSweepIcache</a> (TRUE);
01327     *ImageHandle = DataTableEntry;
01328     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01329 
01330     <span class="keywordflow">if</span> (LoadInSessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01331         <a class="code" href="../../d8/d8/sysload_8c.html#a56">MmPageEntireDriver</a> (DataTableEntry-&gt;EntryPoint);
01332     }
01333     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SectionPointer == (PVOID)-1 &amp;&amp; LockDownPages == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01334         <a class="code" href="../../d8/d8/sysload_8c.html#a34">MiEnablePagingOfDriver</a> (DataTableEntry);
01335     }
01336 
01337 return1:
01338 
01339     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01340 
01341 <span class="preprocessor">#if DBG</span>
01342 <span class="preprocessor"></span>
01343         <span class="comment">//</span>
01344         <span class="comment">// Only way we should fail after we get a valid DataTableEntry is if</span>
01345         <span class="comment">// we're Hydra loading a 2nd instance of a driver.</span>
01346         <span class="comment">//</span>
01347 
01348         <span class="keywordflow">if</span> (DataTableEntry) {
01349             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE &amp;&amp; AlreadyOpen == TRUE &amp;&amp; DataTableEntry-&gt;LoadCount &gt; 1);
01350         }
01351 <span class="preprocessor">#endif</span>
01352 <span class="preprocessor"></span>
01353         <span class="keywordflow">if</span> (AlreadyOpen == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; SectionPointer != (PVOID)-1) {
01354 
01355             <span class="comment">//</span>
01356             <span class="comment">// This is needed for failed win32k.sys loads or any Hydra session's</span>
01357             <span class="comment">// load of the first instance of a driver.</span>
01358             <span class="comment">//</span>
01359 
01360             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionPointer);
01361         }
01362 
01363         <span class="keywordflow">if</span> (IssueUnloadOnFailure == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01364             
01365             <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01366                 RtlZeroMemory (&amp;TempDataTableEntry, <span class="keyword">sizeof</span>(LDR_DATA_TABLE_ENTRY));
01367             
01368                 DataTableEntry = &amp;TempDataTableEntry;
01369         
01370                 DataTableEntry-&gt;DllBase = *ImageBaseAddress;
01371                 DataTableEntry-&gt;SizeOfImage = NumberOfPtes &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01372                 DataTableEntry-&gt;LoadCount = 1;
01373                 DataTableEntry-&gt;LoadedImports = LoadedImports;
01374             }
01375 <span class="preprocessor">#if DBG</span>
01376 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
01377         
01378                 <span class="comment">//</span>
01379                 <span class="comment">// If DataTableEntry is NULL, then we are unloading before one</span>
01380                 <span class="comment">// got created.  Once a LDR_DATA_TABLE_ENTRY is created, the</span>
01381                 <span class="comment">// load cannot fail, so if exists here, at least one other</span>
01382                 <span class="comment">// session contains this image as well.</span>
01383                 <span class="comment">//</span>
01384         
01385                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
01386                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount &gt; 1);
01387             }
01388 <span class="preprocessor">#endif</span>
01389 <span class="preprocessor"></span>            
01390             <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> ((PVOID)DataTableEntry);
01391         }
01392     }
01393 
01394     <span class="keywordflow">if</span> (FileHandle) {
01395         ZwClose (FileHandle);
01396     }
01397     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01398 
01399         ULONG_PTR ErrorParameters[ 3 ];
01400         ULONG NumberOfParameters;
01401         ULONG UnicodeStringParameterMask;
01402         ULONG ErrorResponse;
01403         ANSI_STRING AnsiString;
01404         UNICODE_STRING ProcedureName;
01405         UNICODE_STRING DriverName;
01406 
01407         <span class="comment">//</span>
01408         <span class="comment">// Hard error time.  A driver could not be loaded.</span>
01409         <span class="comment">//</span>
01410 
01411         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
01412         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01413         ErrorParameters[ 0 ] = (ULONG_PTR)ImageFileName;
01414         NumberOfParameters = 1;
01415         UnicodeStringParameterMask = 1;
01416 
01417         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ProcedureName, NULL );
01418         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_DRIVER_ORDINAL_NOT_FOUND ||
01419             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_DRIVER_ENTRYPOINT_NOT_FOUND ||
01420             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PROCEDURE_NOT_FOUND
01421            ) {
01422             NumberOfParameters = 3;
01423             UnicodeStringParameterMask = 0x5;
01424             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;DriverName, MissingDriverName );
01425             ErrorParameters[ 2 ] = (ULONG_PTR)&amp;DriverName;
01426 
01427             <span class="keywordflow">if</span> ((ULONG_PTR)MissingProcedureName &amp; ~((ULONG_PTR) (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>-1))) {
01428                 <span class="comment">//</span>
01429                 <span class="comment">// If not an ordinal, pass as a Unicode string</span>
01430                 <span class="comment">//</span>
01431 
01432                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, MissingProcedureName );
01433                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;ProcedureName, &amp;AnsiString, TRUE );
01434                 ErrorParameters[ 1 ] = (ULONG_PTR)&amp;ProcedureName;
01435                 UnicodeStringParameterMask |= 0x2;
01436             } <span class="keywordflow">else</span> {
01437                 <span class="comment">//</span>
01438                 <span class="comment">// Just pass ordinal values as is.</span>
01439                 <span class="comment">//</span>
01440 
01441                 ErrorParameters[ 1 ] = (ULONG_PTR)MissingProcedureName;
01442             }
01443         } <span class="keywordflow">else</span> {
01444             NumberOfParameters = 2;
01445             ErrorParameters[ 1 ] = (ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01446             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_DRIVER_UNABLE_TO_LOAD;
01447             }
01448 
01449         ZwRaiseHardError (Status,
01450                           NumberOfParameters,
01451                           UnicodeStringParameterMask,
01452                           ErrorParameters,
01453                           OptionOkNoWait,
01454                           &amp;ErrorResponse);
01455 
01456         <span class="keywordflow">if</span> (ProcedureName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01457             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;ProcedureName );
01458         }
01459         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01460     }
01461 
01462 return2:
01463     <span class="keywordflow">if</span> (NamePrefix) {
01464         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PrefixedImageName.Buffer);
01465     }
01466 
01467     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
01468     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01469     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01470 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="sysload.c::MiLocateExportName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiLocateExportName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>FunctionName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l03712">3712</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03645">MiCallDllUnloadAndUnloadDll()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l06717">MmCallDllInitialize()</a>.
<p>
<pre class="fragment"><div>03719                    :
03720 
03721     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to locate a function name in an export directory.
03722 
03723 Arguments:
03724 
03725     DllBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image base.
03726 
03727     FunctionName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name to be located.
03728 
03729 Return Value:
03730 
03731     The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> located function or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
03732 
03733 --*/
03734 
03735 {
03736     PVOID Func = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03737     PULONG NameTableBase;
03738     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> NameOrdinalTableBase;
03739     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
03740     PULONG Addr;
03741     ULONG ExportSize;
03742     ULONG Low;
03743     ULONG Middle;
03744     ULONG High;
03745     LONG Result;
03746     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> OrdinalNumber;
03747 
03748     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03749 
03750     <span class="comment">//</span>
03751     <span class="comment">// Locate the DLL's export directory.</span>
03752     <span class="comment">//</span>
03753 
03754     ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
03755                                 DllBase,
03756                                 TRUE,
03757                                 IMAGE_DIRECTORY_ENTRY_EXPORT,
03758                                 &amp;ExportSize
03759                                 );
03760     <span class="keywordflow">if</span> (ExportDirectory) {
03761 
03762         NameTableBase =  (PULONG)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNames);
03763         NameOrdinalTableBase = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNameOrdinals);
03764 
03765         <span class="comment">//</span>
03766         <span class="comment">// Look in the export name table for the specified function name.</span>
03767         <span class="comment">//</span>
03768 
03769         Low = 0;
03770         High = ExportDirectory-&gt;NumberOfNames - 1;
03771 
03772         <span class="keywordflow">while</span> (High &gt;= Low &amp;&amp; (LONG)High &gt;= 0) {
03773 
03774             <span class="comment">//</span>
03775             <span class="comment">// Compute the next probe index and compare the export name entry</span>
03776             <span class="comment">// with the specified function name.</span>
03777             <span class="comment">//</span>
03778 
03779             Middle = (Low + High) &gt;&gt; 1;
03780             Result = strcmp(FunctionName,
03781                             (PCHAR)((PCHAR)DllBase + NameTableBase[Middle]));
03782 
03783             <span class="keywordflow">if</span> (Result &lt; 0) {
03784                 High = Middle - 1;
03785             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &gt; 0) {
03786                 Low = Middle + 1;
03787             } <span class="keywordflow">else</span> {
03788                 <span class="keywordflow">break</span>;
03789             }
03790         }
03791 
03792         <span class="comment">//</span>
03793         <span class="comment">// If the high index is less than the low index, then a matching table</span>
03794         <span class="comment">// entry was not found.  Otherwise, get the ordinal number from the</span>
03795         <span class="comment">// ordinal table and location the function address.</span>
03796         <span class="comment">//</span>
03797 
03798         <span class="keywordflow">if</span> ((LONG)High &gt;= (LONG)Low) {
03799 
03800             OrdinalNumber = NameOrdinalTableBase[Middle];
03801             Addr = (PULONG)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfFunctions);
03802             Func = (PVOID)((PCHAR)DllBase + Addr[OrdinalNumber]);
03803 
03804             <span class="comment">//</span>
03805             <span class="comment">// If the function address is w/in range of the export directory,</span>
03806             <span class="comment">// then the function is forwarded, which is not allowed, so ignore</span>
03807             <span class="comment">// it.</span>
03808             <span class="comment">//</span>
03809 
03810             <span class="keywordflow">if</span> ((ULONG_PTR)Func &gt; (ULONG_PTR)ExportDirectory &amp;&amp;
03811                 (ULONG_PTR)Func &lt; ((ULONG_PTR)ExportDirectory + ExportSize)) {
03812                 Func = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03813             }
03814         }
03815     }
03816 
03817     <span class="keywordflow">return</span> Func;
03818 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="sysload.c::MiLocateKernelSections" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiLocateKernelSections           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DataTableEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06395">6395</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00037">ExPoolCodeEnd</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00036">ExPoolCodeStart</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00039">MmPoolCodeEnd</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00038">MmPoolCodeStart</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00041">MmPteCodeEnd</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00040">MmPteCodeStart</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01985">SECTION_BASE_ADDRESS</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l06591">MiInitializeLoadedModuleList()</a>.
<p>
<pre class="fragment"><div>06401                    :
06402 
06403     This function locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource section in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be
06404     <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> readwrite <span class="keywordflow">if</span> we bugcheck later, as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bugcheck code will write
06405     into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
06406 
06407 Arguments:
06408 
06409     DataTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel's data table entry.
06410 
06411 Return Value:
06412 
06413     None.
06414 
06415 Environment:
06416 
06417     Kernel mode, Phase 0 Initialization.
06418 
06419 --*/
06420 
06421 {
06422     PVOID CurrentBase;
06423     PIMAGE_NT_HEADERS NtHeader;
06424     PIMAGE_SECTION_HEADER SectionTableEntry;
06425     LONG i;
06426     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06427     PVOID SectionBaseAddress;
06428 
06429     CurrentBase = (PVOID)DataTableEntry-&gt;DllBase;
06430 
06431     NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(CurrentBase);
06432 
06433     SectionTableEntry = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeader +
06434                             <span class="keyword">sizeof</span>(ULONG) +
06435                             <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
06436                             NtHeader-&gt;FileHeader.SizeOfOptionalHeader);
06437 
06438     <span class="comment">//</span>
06439     <span class="comment">// From the image header, locate the section named '.rsrc'.</span>
06440     <span class="comment">//</span>
06441 
06442     i = NtHeader-&gt;FileHeader.NumberOfSections;
06443 
06444     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06445 
06446     <span class="keywordflow">while</span> (i &gt; 0) {
06447 
06448         SectionBaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(SectionTableEntry);
06449 
06450 <span class="preprocessor">#if defined (_X86_)</span>
06451 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*(PULONG)SectionTableEntry-&gt;Name == 'rsr.') {
06452 
06453             MiKernelResourceStartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((ULONG_PTR)CurrentBase +
06454                                              SectionTableEntry-&gt;VirtualAddress);
06455 
06456             MiKernelResourceEndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>((ULONG_PTR)CurrentBase +
06457                          SectionTableEntry-&gt;VirtualAddress +
06458                          (NtHeader-&gt;OptionalHeader.SectionAlignment - 1) +
06459                          SectionTableEntry-&gt;SizeOfRawData -
06460                          PAGE_SIZE));
06461             <span class="keywordflow">break</span>;
06462         }
06463 <span class="preprocessor">#endif</span>
06464 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*(PULONG)SectionTableEntry-&gt;Name == 'LOOP') {
06465             <span class="keywordflow">if</span> (*(PULONG)&amp;SectionTableEntry-&gt;Name[4] == 'EDOC') {
06466                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a3">ExPoolCodeStart</a> = (PVOID)((ULONG_PTR)CurrentBase +
06467                                              SectionTableEntry-&gt;VirtualAddress);
06468                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a4">ExPoolCodeEnd</a> = (PVOID)((ULONG_PTR)CurrentBase +
06469                                              SectionTableEntry-&gt;VirtualAddress +
06470                                              SectionTableEntry-&gt;SizeOfRawData);
06471             }
06472             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)&amp;SectionTableEntry-&gt;Name[4] == 'IM') {
06473                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a5">MmPoolCodeStart</a> = (PVOID)((ULONG_PTR)CurrentBase +
06474                                              SectionTableEntry-&gt;VirtualAddress);
06475                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a6">MmPoolCodeEnd</a> = (PVOID)((ULONG_PTR)CurrentBase +
06476                                              SectionTableEntry-&gt;VirtualAddress +
06477                                              SectionTableEntry-&gt;SizeOfRawData);
06478             }
06479         }
06480         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*(PULONG)SectionTableEntry-&gt;Name == 'YSIM') &amp;&amp;
06481                  (*(PULONG)&amp;SectionTableEntry-&gt;Name[4] == 'ETPS')) {
06482                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a7">MmPteCodeStart</a> = (PVOID)((ULONG_PTR)CurrentBase +
06483                                              SectionTableEntry-&gt;VirtualAddress);
06484                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a8">MmPteCodeEnd</a> = (PVOID)((ULONG_PTR)CurrentBase +
06485                                              SectionTableEntry-&gt;VirtualAddress +
06486                                              SectionTableEntry-&gt;SizeOfRawData);
06487         }
06488 
06489         i -= 1;
06490         SectionTableEntry += 1;
06491     }
06492 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="sysload.c::MiLookupImageSectionByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiLookupImageSectionByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MappedAsImage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="sysload.c::MiMapCacheExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG MiMapCacheExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionPointer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="sysload.c::MiReloadBootLoadedDrivers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiReloadBootLoadedDrivers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">5956</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00070">InitializationPhase</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a29">LdrDoubleRelocateImage()</a>, <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00091">LdrRelocateImage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01313">MI_SET_ACCESSED_IN_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00141">MiNoLowMemory</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a52">MiRemoveLowPages()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05878">MiUpdateThunks()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00139">MM_EXECUTE_READWRITE</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00090">MmMakeLowMemory</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>05962                    :
05963 
05964     The kernel, <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a> and boot drivers are relocated by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader.
05965     All <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot drivers are then relocated again here.
05966 
05967     This function relocates osloader-loaded images into system PTEs.  This
05968     gives these images <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> benefits that all other drivers already enjoy,
05969     including :
05970 
05971     1. Paging of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drivers (<span class="keyword">this</span> is more than 500K today).
05972     2. Write-protection of their <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a> sections.
05973     3. Automatic unload of drivers on last dereference.
05974 
05975     Note care must be taken when processing HIGHADJ relocations more than once.
05976 
05977 Arguments:
05978 
05979     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system loader block.
05980 
05981 Return Value:
05982 
05983     None.
05984 
05985 Environment:
05986 
05987     Kernel mode, Phase 0 Initialization.
05988 
05989 --*/
05990 
05991 {
05992     PLDR_DATA_TABLE_ENTRY DataTableEntry;
05993     PLIST_ENTRY NextEntry;
05994     PIMAGE_NT_HEADERS NtHeader;
05995     PIMAGE_DATA_DIRECTORY DataDirectory;
05996     ULONG_PTR i;
05997     ULONG NumberOfPtes;
05998     ULONG NumberOfLoaderPtes;
05999     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06000     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
06001     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LoaderPte;
06002     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
06003     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
06004     PVOID LoaderImageAddress;
06005     PVOID NewImageAddress;
06006     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06007     PFN_NUMBER PageFrameIndex;
06008     PFN_NUMBER PteFramePage;
06009     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PteFramePointer;
06010     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
06011     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
06012     KIRQL OldIrql;
06013     PCHAR RelocatedVa;
06014     PCHAR NonRelocatedVa;
06015     LOGICAL StopMoving;
06016 
06017 <span class="preprocessor">#if !defined (_X86_)</span>
06018 <span class="preprocessor"></span>
06019     <span class="comment">//</span>
06020     <span class="comment">// Non-x86 platforms have map registers so no memory shuffling is needed.</span>
06021     <span class="comment">//</span>
06022 
06023     <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06024 <span class="preprocessor">#endif</span>
06025 <span class="preprocessor"></span>    StopMoving = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06026 
06027     i = 0;
06028     NextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
06029 
06030     <span class="keywordflow">for</span> ( ; NextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead; NextEntry = NextEntry-&gt;Flink) {
06031 
06032         <span class="comment">//</span>
06033         <span class="comment">// Skip the kernel and the HAL.  Note their relocation sections will</span>
06034         <span class="comment">// be automatically reclaimed.</span>
06035         <span class="comment">//</span>
06036 
06037         i += 1;
06038         <span class="keywordflow">if</span> (i &lt;= 2) {
06039             <span class="keywordflow">continue</span>;
06040         }
06041 
06042         DataTableEntry = CONTAINING_RECORD(NextEntry,
06043                                            LDR_DATA_TABLE_ENTRY,
06044                                            InLoadOrderLinks);
06045 
06046         <span class="comment">//</span>
06047         <span class="comment">// Ensure that the relocation section exists and that the loader</span>
06048         <span class="comment">// hasn't freed it already.</span>
06049         <span class="comment">//</span>
06050 
06051         NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
06052 
06053         <span class="keywordflow">if</span> (NtHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06054             <span class="keywordflow">continue</span>;
06055         }
06056 
06057         <span class="keywordflow">if</span> (IMAGE_DIRECTORY_ENTRY_BASERELOC &gt;= NtHeader-&gt;OptionalHeader.NumberOfRvaAndSizes) {
06058             <span class="keywordflow">continue</span>;
06059         }
06060     
06061         DataDirectory = &amp;NtHeader-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];
06062 
06063         <span class="keywordflow">if</span> (DataDirectory-&gt;VirtualAddress == 0) {
06064             <span class="keywordflow">continue</span>;
06065         }
06066 
06067         <span class="keywordflow">if</span> (DataDirectory-&gt;VirtualAddress + DataDirectory-&gt;Size &gt; DataTableEntry-&gt;SizeOfImage) {
06068 
06069             <span class="comment">//</span>
06070             <span class="comment">// The relocation section has already been freed, the user must</span>
06071             <span class="comment">// be using an old loader that didn't save the relocations.</span>
06072             <span class="comment">//</span>
06073 
06074             <span class="keywordflow">continue</span>;
06075         }
06076 
06077         LoaderImageAddress = DataTableEntry-&gt;DllBase;
06078         LoaderPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(DataTableEntry-&gt;DllBase);
06079         NumberOfLoaderPtes = (ULONG)((<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(DataTableEntry-&gt;SizeOfImage)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
06080 
06081         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
06082 
06083         PointerPte = LoaderPte;
06084         LastPte = PointerPte + NumberOfLoaderPtes;
06085 
06086         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
06087             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
06088             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
06089             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06090 
06091             <span class="comment">//</span>
06092             <span class="comment">// Mark the page as modified so boot drivers that call</span>
06093             <span class="comment">// MmPageEntireDriver don't lose their unmodified data !</span>
06094             <span class="comment">//</span>
06095         
06096             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
06097             PointerPte += 1;
06098         }
06099 
06100         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
06101 
06102         <span class="comment">//</span>
06103         <span class="comment">// Extra PTEs are allocated here to map the relocation section at the</span>
06104         <span class="comment">// new address so the image can be relocated.</span>
06105         <span class="comment">//</span>
06106 
06107         NumberOfPtes = NumberOfLoaderPtes;
06108 
06109         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (NumberOfPtes,
06110                                           SystemPteSpace,
06111                                           0,
06112                                           0,
06113                                           FALSE);
06114 
06115         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06116             <span class="keywordflow">continue</span>;
06117         }
06118 
06119         LastPte = PointerPte + NumberOfPtes;
06120 
06121         NewImageAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
06122 
06123 <span class="preprocessor">#if DBG_SYSLOAD</span>
06124 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Relocating %wZ from %p to %p, %x bytes\n"</span>,
06125                         &amp;DataTableEntry-&gt;FullDllName,
06126                         DataTableEntry-&gt;DllBase,
06127                         NewImageAddress,
06128                         DataTableEntry-&gt;SizeOfImage
06129                         );
06130 <span class="preprocessor">#endif</span>
06131 <span class="preprocessor"></span>
06132         <span class="comment">//</span>
06133         <span class="comment">// This assert is important because the assumption is made that PTEs</span>
06134         <span class="comment">// (not superpages) are mapping these drivers.</span>
06135         <span class="comment">//</span>
06136 
06137         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (InitializationPhase == 0);
06138 
06139         <span class="comment">//</span>
06140         <span class="comment">// If the system is configured to make low memory available for ISA</span>
06141         <span class="comment">// type drivers, then copy the boot loaded drivers now.  Otherwise</span>
06142         <span class="comment">// only PTE adjustment is done.  Presumably some day when ISA goes</span>
06143         <span class="comment">// away this code can be removed.</span>
06144         <span class="comment">//</span>
06145 
06146         RelocatedVa = NewImageAddress;
06147         NonRelocatedVa = (PCHAR) DataTableEntry-&gt;DllBase;
06148 
06149         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
06150 
06151             PteContents = *LoaderPte;
06152             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
06153 
06154             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06155 <span class="preprocessor">#if DBG</span>
06156 <span class="preprocessor"></span>                PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (LoaderPte);
06157                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06158                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
06159 <span class="preprocessor">#endif</span>
06160 <span class="preprocessor"></span>                <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
06161                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
06162                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
06163                                     MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
06164 
06165                 <span class="keywordflow">if</span> (PageFrameIndex &lt; (16*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
06166 
06167                     <span class="comment">//</span>
06168                     <span class="comment">// If the frames cannot be replaced with high pages</span>
06169                     <span class="comment">// then stop copying.</span>
06170                     <span class="comment">//</span>
06171 
06172 <span class="preprocessor">#if defined (_X86PAE_)</span>
06173 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
06174 <span class="preprocessor">#endif</span>
06175 <span class="preprocessor"></span>                    StopMoving = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06176                 }
06177 
06178                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
06179                                    PageFrameIndex,
06180                                    MM_EXECUTE_READWRITE,
06181                                    PointerPte);
06182 
06183                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
06184                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (&amp;TempPte, 1);
06185                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
06186 
06187                 <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
06188                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06189                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
06190 
06191                 <span class="comment">//</span>
06192                 <span class="comment">// Initialize the WsIndex just like the original page had it.</span>
06193                 <span class="comment">//</span>
06194 
06195                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = 0;
06196 
06197                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
06198                 RtlMoveMemory (RelocatedVa, NonRelocatedVa, PAGE_SIZE);
06199                 RelocatedVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
06200                 NonRelocatedVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
06201             }
06202             <span class="keywordflow">else</span> {
06203                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
06204                                    PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
06205                                    MM_EXECUTE_READWRITE,
06206                                    PointerPte);
06207     
06208                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
06209             }
06210 
06211             PointerPte += 1;
06212             LoaderPte += 1;
06213         }
06214         PointerPte -= NumberOfPtes;
06215 
06216         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*(PULONG)NewImageAddress == *(PULONG)LoaderImageAddress);
06217 
06218         <span class="comment">//</span>
06219         <span class="comment">// Image is now mapped at the new address.  Relocate it (again).</span>
06220         <span class="comment">//</span>
06221 
06222 <span class="preprocessor">#if defined(_ALPHA_)</span>
06223 <span class="preprocessor"></span>
06224         <span class="comment">//</span>
06225         <span class="comment">// HIGHADJ relocations need special re-processing.  This needs to be</span>
06226         <span class="comment">// done before resetting ImageBase.</span>
06227         <span class="comment">//</span>
06228 
06229         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d8/d8/sysload_8c.html#a29">LdrDoubleRelocateImage</a>(NewImageAddress,
06230                                             LoaderImageAddress,
06231                                             <span class="stringliteral">"SYSLDR"</span>,
06232                                             (ULONG)STATUS_SUCCESS,
06233                                             (ULONG)STATUS_CONFLICTING_ADDRESSES,
06234                                             (ULONG)STATUS_INVALID_IMAGE_FORMAT
06235                                             );
06236 <span class="preprocessor">#endif</span>
06237 <span class="preprocessor"></span>
06238         NtHeader-&gt;OptionalHeader.ImageBase = (ULONG_PTR)LoaderImageAddress;
06239         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06240             PIMAGE_NT_HEADERS NtHeader2;
06241 
06242             NtHeader2 = (PIMAGE_NT_HEADERS)((PCHAR)NtHeader + (RelocatedVa - NonRelocatedVa));
06243             NtHeader2-&gt;OptionalHeader.ImageBase = (ULONG_PTR)LoaderImageAddress;
06244         }
06245 
06246         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d3/ldrreloc_8c.html#a5">LdrRelocateImage</a>(NewImageAddress,
06247                                             <span class="stringliteral">"SYSLDR"</span>,
06248                                             (ULONG)STATUS_SUCCESS,
06249                                             (ULONG)STATUS_CONFLICTING_ADDRESSES,
06250                                             (ULONG)STATUS_INVALID_IMAGE_FORMAT
06251                                             );
06252 
06253         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
06254 
06255             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06256                 <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
06257                     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
06258                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06259                     <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
06260                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
06261                     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
06262                     PointerPte += 1;
06263                 }
06264             }
06265 
06266             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
06267                                  NumberOfPtes,
06268                                  SystemPteSpace);
06269 
06270             <span class="keywordflow">if</span> (StopMoving == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06271                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06272             }
06273 
06274             <span class="keywordflow">continue</span>;
06275         }
06276 
06277         <span class="comment">//</span>
06278         <span class="comment">// Update the IATs for all other loaded modules that reference this one.</span>
06279         <span class="comment">//</span>
06280 
06281         NonRelocatedVa = (PCHAR) DataTableEntry-&gt;DllBase;
06282         DataTableEntry-&gt;DllBase = NewImageAddress;
06283 
06284         <a class="code" href="../../d8/d8/sysload_8c.html#a49">MiUpdateThunks</a> (LoaderBlock,
06285                         LoaderImageAddress,
06286                         NewImageAddress,
06287                         DataTableEntry-&gt;SizeOfImage);
06288 
06289 
06290         <span class="comment">//</span>
06291         <span class="comment">// Update the loaded module list entry.</span>
06292         <span class="comment">//</span>
06293 
06294         DataTableEntry-&gt;Flags |= LDRP_SYSTEM_MAPPED;
06295         DataTableEntry-&gt;DllBase = NewImageAddress;
06296         DataTableEntry-&gt;EntryPoint =
06297             (PVOID)((PCHAR)NewImageAddress + NtHeader-&gt;OptionalHeader.AddressOfEntryPoint);
06298         DataTableEntry-&gt;SizeOfImage = NumberOfPtes &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
06299 
06300         <span class="comment">//</span>
06301         <span class="comment">// Update the PFNs of the image to support trimming.</span>
06302         <span class="comment">// Note that the loader addresses are freed now so no references</span>
06303         <span class="comment">// to it are permitted after this point.</span>
06304         <span class="comment">//</span>
06305 
06306         LoaderPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (NonRelocatedVa);
06307 
06308         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
06309 
06310         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
06311             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
06312 
06313             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06314                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LoaderPte-&gt;u.Hard.Valid == 1);
06315                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (LoaderPte);
06316                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06317 
06318 <span class="preprocessor">#if defined (_X86_) || defined (_IA64_)</span>
06319 <span class="preprocessor"></span>
06320                 <span class="comment">//</span>
06321                 <span class="comment">// Decrement the share count on the original page table</span>
06322                 <span class="comment">// page so it can be freed.</span>
06323                 <span class="comment">//</span>
06324 
06325                 <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
06326 <span class="preprocessor">#endif</span>
06327 <span class="preprocessor"></span>
06328                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
06329                 <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
06330                 LoaderPte += 1;
06331             }
06332             <span class="keywordflow">else</span> {
06333 
06334                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
06335                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06336 
06337 <span class="preprocessor">#if defined (_X86_) || defined (_IA64_)</span>
06338 <span class="preprocessor"></span>
06339                 <span class="comment">//</span>
06340                 <span class="comment">// Decrement the share count on the original page table</span>
06341                 <span class="comment">// page so it can be freed.</span>
06342                 <span class="comment">//</span>
06343 
06344                 <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
06345                 *Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
06346 <span class="preprocessor">#endif</span>
06347 <span class="preprocessor"></span>
06348                 <span class="comment">//</span>
06349                 <span class="comment">// Chain the PFN entry to its new page table.</span>
06350                 <span class="comment">//</span>
06351     
06352                 PteFramePointer = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
06353                 PteFramePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PteFramePointer);
06354     
06355                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PteFramePage;
06356                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
06357     
06358                 <span class="comment">//</span>
06359                 <span class="comment">// Increment the share count for the page table page that now</span>
06360                 <span class="comment">// contains the PTE that was copied.</span>
06361                 <span class="comment">//</span>
06362             
06363                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteFramePage);
06364                 Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
06365             }
06366 
06367             PointerPte += 1;
06368         }
06369 
06370         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
06371 
06372         <span class="comment">//</span>
06373         <span class="comment">// The physical pages mapping the relocation section are freed</span>
06374         <span class="comment">// later with the rest of the initialization code spanned by the</span>
06375         <span class="comment">// DataTableEntry-&gt;SizeOfImage.</span>
06376         <span class="comment">//</span>
06377 
06378         <span class="keywordflow">if</span> (StopMoving == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06379             <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06380         }
06381     }
06382 <span class="preprocessor">#if defined (_X86PAE_)</span>
06383 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06384         <a class="code" href="../../d8/d8/sysload_8c.html#a52">MiRemoveLowPages</a> ();
06385     }
06386 <span class="preprocessor">#endif</span>
06387 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="sysload.c::MiRememberUnloadedDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiRememberUnloadedDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02740">2740</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02691">_UNLOADED_DRIVERS::CurrentTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02690">_UNLOADED_DRIVERS::EndAddress</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02685">MI_UNLOADED_DRIVERS</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00093">MiLastUnloadedDriver</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00078">MiTotalUnloads</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00092">MiUnloadedDrivers</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00079">MiUnloadsSkipped</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02688">_UNLOADED_DRIVERS::Name</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02689">_UNLOADED_DRIVERS::StartAddress</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.
<p>
<pre class="fragment"><div>02748                    :
02749 
02750     This routine saves information about unloaded drivers so that ones that
02751     forget to <span class="keyword">delete</span> lookaside lists or queues can be caught.
02752 
02753 Arguments:
02754 
02755     DriverName - Supplies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's name.
02756 
02757     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver was loaded at.
02758 
02759     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver load spanned.
02760 
02761 Return Value:
02762 
02763     None.
02764 
02765 --*/
02766 
02767 {
02768     <a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a> Entry;
02769     ULONG NumberOfBytes;
02770 
02771     <span class="keywordflow">if</span> (DriverName-&gt;Length == 0) {
02772 
02773         <span class="comment">//</span>
02774         <span class="comment">// This is an aborted load and the driver name hasn't been filled</span>
02775         <span class="comment">// in yet.  No need to save it.</span>
02776         <span class="comment">//</span>
02777 
02778         <span class="keywordflow">return</span>;
02779     }
02780 
02781     <span class="comment">//</span>
02782     <span class="comment">// Serialization is provided by the caller, so just update the list now.</span>
02783     <span class="comment">// Note the allocations are nonpaged so they can be searched at bugcheck</span>
02784     <span class="comment">// time.</span>
02785     <span class="comment">//</span>
02786 
02787     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02788         NumberOfBytes = <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a> * <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">UNLOADED_DRIVERS</a>);
02789 
02790         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a> = (<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
02791                                                                       NumberOfBytes,
02792                                                                       'TDmM');
02793         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02794             <span class="keywordflow">return</span>;
02795         }
02796         RtlZeroMemory (MiUnloadedDrivers, NumberOfBytes);
02797         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> = 0;
02798     }
02799     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a>) {
02800         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> = 0;
02801     }
02802 
02803     Entry = &amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a>[<a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a>];
02804 
02805     <span class="comment">//</span>
02806     <span class="comment">// Free the old entry as we recycle into the new.</span>
02807     <span class="comment">//</span>
02808 
02809     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a> (&amp;Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>);
02810 
02811     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
02812                                                 DriverName-&gt;Length,
02813                                                 'TDmM');
02814 
02815     <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02816         Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.MaximumLength = 0;
02817         Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Length = 0;
02818         <a class="code" href="../../d8/d8/sysload_8c.html#a15">MiUnloadsSkipped</a> += 1;
02819         <span class="keywordflow">return</span>;
02820     }
02821 
02822     RtlMoveMemory(Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Buffer, DriverName-&gt;Buffer, DriverName-&gt;Length);
02823     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Length = DriverName-&gt;Length;
02824     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.MaximumLength = DriverName-&gt;MaximumLength;
02825 
02826     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o1">StartAddress</a> = Address;
02827     Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o2">EndAddress</a> = (PVOID)((PCHAR)Address + Length);
02828 
02829     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o3">CurrentTime</a>);
02830 
02831     <a class="code" href="../../d8/d8/sysload_8c.html#a14">MiTotalUnloads</a> += 1;
02832     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> += 1;
02833 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="sysload.c::MiRemoveLowPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiRemoveLowPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="sysload.c::MiResolveImageReferences" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiResolveImageReferences           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageFileDirectory</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING NamePrefix&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadInSessionSpace</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>MissingProcedureName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWSTR *&nbsp;</td>
          <td class="mdname" nowrap> <em>MissingDriverName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadedImports</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">3953</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00178">CmRegistryMachineSystemCurrentControlSetServices</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00042">_LOAD_IMPORTS::Count</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00043">_LOAD_IMPORTS::Entry</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">MiDereferenceImports()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03712">MiLocateExportName()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04464">MiSnapThunk()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00315">MmLoadSystemImage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00047">NO_IMPORTS_USED</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01910">PMM_DLL_INITIALIZE</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00053">POINTER_TO_SINGLE_ENTRY</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00663">RtlAppendStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>.
<p>
<pre class="fragment"><div>03965                    :
03966 
03967     This routine resolves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> references from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly loaded driver
03968     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel, <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a> and other drivers.
03969 
03970 Arguments:
03971 
03972     ImageBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image header resides.
03973 
03974     ImageFileDirectory - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory to load referenced DLLs.
03975 
03976 Return Value:
03977 
03978     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image reference resolution.
03979 
03980 --*/
03981 
03982 {
03983     PCHAR MissingProcedureStorageArea;
03984     PVOID ImportBase;
03985     ULONG ImportSize;
03986     ULONG ImportListSize;
03987     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03988     ULONG i;
03989     PIMAGE_IMPORT_DESCRIPTOR ImportDescriptor;
03990     PIMAGE_IMPORT_DESCRIPTOR Imp;
03991     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
03992     ULONG ExportSize;
03993     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
03994     PIMAGE_THUNK_DATA NameThunk;
03995     PIMAGE_THUNK_DATA AddrThunk;
03996     PSZ ImportName;
03997     PLIST_ENTRY NextEntry;
03998     PLDR_DATA_TABLE_ENTRY DataTableEntry;
03999     PLDR_DATA_TABLE_ENTRY SingleEntry;
04000     ANSI_STRING AnsiString;
04001     UNICODE_STRING ImportName_U;
04002     UNICODE_STRING ImportDescriptorName_U;
04003     UNICODE_STRING DllToLoad;
04004     PVOID Section;
04005     PVOID BaseAddress;
04006     BOOLEAN PrefixedNameAllocated;
04007     BOOLEAN ReferenceImport;
04008     ULONG LinkWin32k = 0;
04009     ULONG LinkNonWin32k = 0;
04010     <a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a> ImportList;
04011     <a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a> CompactedImportList;
04012     BOOLEAN Loaded;
04013 
04014     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04015 
04016     *LoadedImports = <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
04017 
04018     MissingProcedureStorageArea = *MissingProcedureName;
04019 
04020     ImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
04021                         ImageBase,
04022                         TRUE,
04023                         IMAGE_DIRECTORY_ENTRY_IMPORT,
04024                         &amp;ImportSize);
04025 
04026     <span class="keywordflow">if</span> (ImportDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04027         <span class="keywordflow">return</span> STATUS_SUCCESS;
04028     }
04029 
04030     <span class="comment">// Count the number of imports so we can allocate enough room to</span>
04031     <span class="comment">// store them all chained off this module's LDR_DATA_TABLE_ENTRY.</span>
04032     <span class="comment">//</span>
04033 
04034     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04035     <span class="keywordflow">for</span> (Imp = ImportDescriptor; Imp-&gt;Name &amp;&amp; Imp-&gt;OriginalFirstThunk; Imp += 1) {
04036         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04037     }
04038 
04039     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>) {
04040         ImportListSize = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> * <span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(SIZE_T);
04041 
04042         ImportList = (<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
04043                                              ImportListSize,
04044                                              'TDmM');
04045 
04046         <span class="comment">//</span>
04047         <span class="comment">// Zero it so we can recover gracefully if we fail in the middle.</span>
04048         <span class="comment">// If the allocation failed, just don't build the import list.</span>
04049         <span class="comment">//</span>
04050     
04051         <span class="keywordflow">if</span> (ImportList) {
04052             RtlZeroMemory (ImportList, ImportListSize);
04053             ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
04054         }
04055     }
04056     <span class="keywordflow">else</span> {
04057         ImportList = (<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>) 0;
04058     }
04059 
04060     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04061     <span class="keywordflow">while</span> (ImportDescriptor-&gt;Name &amp;&amp; ImportDescriptor-&gt;OriginalFirstThunk) {
04062 
04063         ImportName = (PSZ)((PCHAR)ImageBase + ImportDescriptor-&gt;Name);
04064 
04065         <span class="comment">//</span>
04066         <span class="comment">// A driver can link with win32k.sys if and only if it is a GDI</span>
04067         <span class="comment">// driver.</span>
04068         <span class="comment">// Also display drivers can only link to win32k.sys (and lego ...).</span>
04069         <span class="comment">//</span>
04070         <span class="comment">// So if we get a driver that links to win32k.sys and has more</span>
04071         <span class="comment">// than one set of imports, we will fail to load it.</span>
04072         <span class="comment">//</span>
04073 
04074         LinkWin32k = LinkWin32k |
04075              (!_strnicmp(ImportName, <span class="stringliteral">"win32k"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"win32k"</span>) - 1));
04076 
04077         <span class="comment">//</span>
04078         <span class="comment">// We don't want to count coverage, win32k and irt (lego) since</span>
04079         <span class="comment">// display drivers CAN link against these.</span>
04080         <span class="comment">//</span>
04081 
04082         LinkNonWin32k = LinkNonWin32k |
04083             ((_strnicmp(ImportName, <span class="stringliteral">"win32k"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"win32k"</span>) - 1)) &amp;&amp;
04084              (_strnicmp(ImportName, <span class="stringliteral">"dxapi"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"dxapi"</span>) - 1)) &amp;&amp;
04085              (_strnicmp(ImportName, <span class="stringliteral">"coverage"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"coverage"</span>) - 1)) &amp;&amp;
04086              (_strnicmp(ImportName, <span class="stringliteral">"irt"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"irt"</span>) - 1)));
04087 
04088 
04089         <span class="keywordflow">if</span> (LinkNonWin32k &amp;&amp; LinkWin32k) {
04090             <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04091             <span class="keywordflow">if</span> (ImportList) {
04092                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04093             }
04094             <span class="keywordflow">return</span> (STATUS_PROCEDURE_NOT_FOUND);
04095         }
04096 
04097         <span class="keywordflow">if</span> ((!_strnicmp(ImportName, <span class="stringliteral">"ntdll"</span>,    <span class="keyword">sizeof</span>(<span class="stringliteral">"ntdll"</span>) - 1))    ||
04098             (!_strnicmp(ImportName, <span class="stringliteral">"winsrv"</span>,   <span class="keyword">sizeof</span>(<span class="stringliteral">"winsrv"</span>) - 1))   ||
04099             (!_strnicmp(ImportName, <span class="stringliteral">"advapi32"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"advapi32"</span>) - 1)) ||
04100             (!_strnicmp(ImportName, <span class="stringliteral">"kernel32"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"kernel32"</span>) - 1)) ||
04101             (!_strnicmp(ImportName, <span class="stringliteral">"user32"</span>,   <span class="keyword">sizeof</span>(<span class="stringliteral">"user32"</span>) - 1))   ||
04102             (!_strnicmp(ImportName, <span class="stringliteral">"gdi32"</span>,    <span class="keyword">sizeof</span>(<span class="stringliteral">"gdi32"</span>) - 1)) ) {
04103 
04104             <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04105 
04106             <span class="keywordflow">if</span> (ImportList) {
04107                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04108             }
04109             <span class="keywordflow">return</span> (STATUS_PROCEDURE_NOT_FOUND);
04110         }
04111 
04112         <span class="keywordflow">if</span> ((!_strnicmp(ImportName, <span class="stringliteral">"ntoskrnl"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"ntoskrnl"</span>) - 1)) ||
04113             (!_strnicmp(ImportName, <span class="stringliteral">"win32k"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"win32k"</span>) - 1))     ||
04114             (!_strnicmp(ImportName, <span class="stringliteral">"hal"</span>,   <span class="keyword">sizeof</span>(<span class="stringliteral">"hal"</span>) - 1))) {
04115 
04116                 <span class="comment">//</span>
04117                 <span class="comment">// These imports don't get refcounted because we don't</span>
04118                 <span class="comment">// ever want to unload them.</span>
04119                 <span class="comment">//</span>
04120 
04121                 ReferenceImport = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04122         }
04123         <span class="keywordflow">else</span> {
04124                 ReferenceImport = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04125         }
04126 
04127         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, ImportName);
04128         st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;ImportName_U, &amp;AnsiString, TRUE);
04129         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
04130             <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04131             <span class="keywordflow">if</span> (ImportList) {
04132                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04133             }
04134             <span class="keywordflow">return</span> st;
04135         }
04136 
04137         <span class="keywordflow">if</span> (NamePrefix  &amp;&amp;
04138             (_strnicmp(ImportName, <span class="stringliteral">"ntoskrnl"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"ntoskrnl"</span>) - 1) &amp;&amp;
04139              _strnicmp(ImportName, <span class="stringliteral">"hal"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"hal"</span>) - 1))) {
04140 
04141             ImportDescriptorName_U.MaximumLength = ImportName_U.Length + NamePrefix-&gt;Length;
04142             ImportDescriptorName_U.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04143                                                 ImportDescriptorName_U.MaximumLength,
04144                                                 'TDmM');
04145             <span class="keywordflow">if</span> (!ImportDescriptorName_U.Buffer) {
04146                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ImportName_U);
04147                 <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04148                 <span class="keywordflow">if</span> (ImportList) {
04149                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04150                 }
04151                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04152             }
04153 
04154             ImportDescriptorName_U.Length = 0;
04155             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;ImportDescriptorName_U, NamePrefix);
04156             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;ImportDescriptorName_U, &amp;ImportName_U);
04157             PrefixedNameAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04158         } <span class="keywordflow">else</span> {
04159             ImportDescriptorName_U = ImportName_U;
04160             PrefixedNameAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04161         }
04162 
04163         Loaded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04164 
04165 ReCheck:
04166         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
04167         ImportBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04168 
04169         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
04170 
04171             DataTableEntry = CONTAINING_RECORD(NextEntry,
04172                                                LDR_DATA_TABLE_ENTRY,
04173                                                InLoadOrderLinks);
04174 
04175             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;ImportDescriptorName_U,
04176                                        &amp;DataTableEntry-&gt;BaseDllName,
04177                                        TRUE
04178                                        )) {
04179 
04180                 ImportBase = DataTableEntry-&gt;DllBase;
04181 
04182                 <span class="comment">//</span>
04183                 <span class="comment">// Only bump the LoadCount if this thread did not initiate</span>
04184                 <span class="comment">// the load below.  If this thread initiated the load, then</span>
04185                 <span class="comment">// the LoadCount has already been bumped as part of the</span>
04186                 <span class="comment">// load - we only want to increment it here if we are</span>
04187                 <span class="comment">// "attaching" to a previously loaded DLL.</span>
04188                 <span class="comment">//</span>
04189 
04190                 <span class="keywordflow">if</span> (Loaded == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; ReferenceImport == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04191                     DataTableEntry-&gt;LoadCount += 1;
04192                 }
04193 
04194                 <span class="keywordflow">break</span>;
04195             }
04196             NextEntry = NextEntry-&gt;Flink;
04197         }
04198 
04199         <span class="keywordflow">if</span> (!ImportBase) {
04200 
04201             <span class="comment">//</span>
04202             <span class="comment">// The DLL name was not located, attempt to load this dll.</span>
04203             <span class="comment">//</span>
04204 
04205             DllToLoad.MaximumLength = ImportName_U.Length +
04206                                         ImageFileDirectory-&gt;Length +
04207                                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(WCHAR);
04208 
04209             DllToLoad.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04210                                                DllToLoad.MaximumLength,
04211                                                'TDmM');
04212 
04213             <span class="keywordflow">if</span> (DllToLoad.Buffer) {
04214                 DllToLoad.Length = ImageFileDirectory-&gt;Length;
04215                 RtlMoveMemory (DllToLoad.Buffer,
04216                                ImageFileDirectory-&gt;Buffer,
04217                                ImageFileDirectory-&gt;Length);
04218 
04219                 <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a> ((PSTRING)&amp;DllToLoad,
04220                                          (PSTRING)&amp;ImportName_U);
04221 
04222                 st = <a class="code" href="../../d8/d8/sysload_8c.html#a53">MmLoadSystemImage</a> (&amp;DllToLoad,
04223                                         NamePrefix,
04224                                         NULL,
04225                                         LoadInSessionSpace,
04226                                         &amp;Section,
04227                                         &amp;BaseAddress);
04228 
04229                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DllToLoad.Buffer);
04230             } <span class="keywordflow">else</span> {
04231                 st = STATUS_INSUFFICIENT_RESOURCES;
04232             }
04233 
04234             <span class="comment">//</span>
04235             <span class="comment">// Call any needed DLL initialization now.</span>
04236             <span class="comment">//</span>
04237 
04238             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
04239 
04240                 <a class="code" href="../../d2/d1/mm_8h.html#a157">PMM_DLL_INITIALIZE</a> Func;
04241                 UNICODE_STRING RegistryPath;
04242 
04243                 Loaded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04244 
04245                 Func = <a class="code" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (BaseAddress, <span class="stringliteral">"DllInitialize"</span>);
04246                 <span class="keywordflow">if</span> (Func) {
04247 
04248                     <span class="comment">//</span>
04249                     <span class="comment">// This DLL has an initialization routine.  Manufacture</span>
04250                     <span class="comment">// the service name string and invoke the function with</span>
04251                     <span class="comment">// it.</span>
04252                     <span class="comment">//</span>
04253 
04254                     RegistryPath.MaximumLength = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length +
04255                                                     ImportName_U.Length +
04256                                                     (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(2*<span class="keyword">sizeof</span>(WCHAR));
04257                     RegistryPath.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04258                                                     RegistryPath.MaximumLength,
04259                                                     'TDmM');
04260                     <span class="keywordflow">if</span> (RegistryPath.Buffer) {
04261                         PWCHAR Dot;
04262 
04263                         RegistryPath.Length = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length;
04264                         RtlMoveMemory (RegistryPath.Buffer,
04265                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Buffer,
04266                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length);
04267 
04268                         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;RegistryPath, L<span class="stringliteral">"\\"</span>);
04269                         Dot = wcschr (ImportName_U.Buffer, L<span class="charliteral">'.'</span>);
04270                         <span class="keywordflow">if</span> (Dot) {
04271                             ImportName_U.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((Dot - ImportName_U.Buffer)*<span class="keyword">sizeof</span>(WCHAR));
04272                         }
04273                         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a> (&amp;RegistryPath,
04274                                                         &amp;ImportName_U);
04275 
04276                         <span class="comment">//</span>
04277                         <span class="comment">// Now invoke the DLL's initialization routine.</span>
04278                         <span class="comment">//</span>
04279 
04280                         st = Func (&amp;RegistryPath);
04281                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (RegistryPath.Buffer);
04282 
04283                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
04284 
04285                             <span class="comment">//</span>
04286                             <span class="comment">// Unload the DLL now as its initialization</span>
04287                             <span class="comment">// routine failed.</span>
04288                             <span class="comment">//</span>
04289 
04290                             BOOLEAN Found;
04291                             PLIST_ENTRY Entry;
04292                             PLDR_DATA_TABLE_ENTRY DataTableEntry2;
04293 
04294                             Entry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
04295 
04296                             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04297                             <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
04298 
04299                                 DataTableEntry2 = CONTAINING_RECORD(
04300                                                        Entry,
04301                                                        LDR_DATA_TABLE_ENTRY,
04302                                                        InLoadOrderLinks);
04303 
04304                                 <span class="keywordflow">if</span> (BaseAddress == DataTableEntry2-&gt;DllBase) {
04305 
04306                                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04307                                     <span class="keywordflow">break</span>;
04308                                 }
04309 
04310                                 Entry = Entry-&gt;Flink;
04311                             }
04312 
04313                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Found == TRUE);
04314                             <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> ((PVOID)DataTableEntry2);
04315                         }
04316                     }
04317 
04318                 }
04319             }
04320 
04321             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
04322 
04323                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;ImportName_U );
04324                 <span class="keywordflow">if</span> (PrefixedNameAllocated) {
04325                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ImportDescriptorName_U.Buffer );
04326                 }
04327                 <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04328                 <span class="keywordflow">if</span> (ImportList) {
04329                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04330                 }
04331                 <span class="keywordflow">return</span> st;
04332             }
04333 
04334             <span class="keywordflow">goto</span> ReCheck;
04335         }
04336 
04337         <span class="keywordflow">if</span> (ReferenceImport == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; ImportList) {
04338             ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = DataTableEntry;
04339             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04340         }
04341 
04342         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;ImportName_U );
04343         <span class="keywordflow">if</span> (PrefixedNameAllocated) {
04344             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ( ImportDescriptorName_U.Buffer );
04345         }
04346 
04347         *MissingDriverName = DataTableEntry-&gt;BaseDllName.Buffer;
04348 
04349         ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
04350                                     ImportBase,
04351                                     TRUE,
04352                                     IMAGE_DIRECTORY_ENTRY_EXPORT,
04353                                     &amp;ExportSize
04354                                     );
04355 
04356         <span class="keywordflow">if</span> (!ExportDirectory) {
04357             <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04358             <span class="keywordflow">if</span> (ImportList) {
04359                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04360             }
04361             <span class="keywordflow">return</span> STATUS_DRIVER_ENTRYPOINT_NOT_FOUND;
04362         }
04363 
04364         <span class="comment">//</span>
04365         <span class="comment">// Walk through the IAT and snap all the thunks.</span>
04366         <span class="comment">//</span>
04367 
04368         <span class="keywordflow">if</span> (ImportDescriptor-&gt;OriginalFirstThunk) {
04369 
04370             NameThunk = (PIMAGE_THUNK_DATA)((PCHAR)ImageBase + (ULONG)ImportDescriptor-&gt;OriginalFirstThunk);
04371             AddrThunk = (PIMAGE_THUNK_DATA)((PCHAR)ImageBase + (ULONG)ImportDescriptor-&gt;FirstThunk);
04372 
04373             <span class="keywordflow">while</span> (NameThunk-&gt;u1.AddressOfData) {
04374                 st = <a class="code" href="../../d8/d8/sysload_8c.html#a32">MiSnapThunk</a>(ImportBase,
04375                        ImageBase,
04376                        NameThunk++,
04377                        AddrThunk++,
04378                        ExportDirectory,
04379                        ExportSize,
04380                        FALSE,
04381                        MissingProcedureName
04382                        );
04383                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
04384                     <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> (ImportList);
04385                     <span class="keywordflow">if</span> (ImportList) {
04386                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportList);
04387                     }
04388                     <span class="keywordflow">return</span> st;
04389                 }
04390                 *MissingProcedureName = MissingProcedureStorageArea;
04391             }
04392         }
04393 
04394         ImportDescriptor += 1;
04395     }
04396 
04397     <span class="comment">//</span>
04398     <span class="comment">// All the imports are successfully loaded so establish and compact</span>
04399     <span class="comment">// the import unload list.</span>
04400     <span class="comment">//</span>
04401 
04402     <span class="keywordflow">if</span> (ImportList) {
04403 
04404         <span class="comment">//</span>
04405         <span class="comment">// Blank entries occur for things like the kernel, HAL &amp; win32k.sys</span>
04406         <span class="comment">// that we never want to unload.  Especially for things like</span>
04407         <span class="comment">// win32k.sys where the reference count can really hit 0.</span>
04408         <span class="comment">//</span>
04409 
04410         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04411         <span class="keywordflow">for</span> (i = 0; i &lt; ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a>; i += 1) {
04412             <span class="keywordflow">if</span> (ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i]) {
04413                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04414             }
04415         }
04416 
04417         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 0) {
04418 
04419             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ImportList);
04420             ImportList = <a class="code" href="../../d8/d8/sysload_8c.html#a1">NO_IMPORTS_USED</a>;
04421         }
04422         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 1) {
04423             <span class="keywordflow">for</span> (i = 0; i &lt; ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a>; i += 1) {
04424                 <span class="keywordflow">if</span> (ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i]) {
04425                     SingleEntry = <a class="code" href="../../d8/d8/sysload_8c.html#a4">POINTER_TO_SINGLE_ENTRY</a>(ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i]);
04426                     <span class="keywordflow">break</span>;
04427                 }
04428             }
04429 
04430             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ImportList);
04431             ImportList = (<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)SingleEntry;
04432         }
04433         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a>) {
04434 
04435             ImportListSize = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> * <span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(SIZE_T);
04436 
04437             CompactedImportList = (<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)
04438                                         <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
04439                                         ImportListSize,
04440                                         'TDmM');
04441             <span class="keywordflow">if</span> (CompactedImportList) {
04442                 CompactedImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
04443 
04444                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04445                 <span class="keywordflow">for</span> (i = 0; i &lt; ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o0">Count</a>; i += 1) {
04446                     <span class="keywordflow">if</span> (ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i]) {
04447                         CompactedImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = ImportList-&gt;<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html#o1">Entry</a>[i];
04448                         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04449                     }
04450                 }
04451 
04452                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ImportList);
04453                 ImportList = CompactedImportList;
04454             }
04455         }
04456 
04457         *LoadedImports = ImportList;
04458     }
04459     <span class="keywordflow">return</span> STATUS_SUCCESS;
04460 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="sysload.c::MiSetImageProtect" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSetImageProtect           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Segment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Protection</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l05376">5376</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00153">MM_PROTECTION_WRITE_MASK</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07821">MmLockPagedPool()</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07869">MmUnlockPagedPool()</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d7/struct__SUBSECTION.html#o3">_SUBSECTION::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>.
<p>
<pre class="fragment"><div>05383                    :
05384 
05385     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection of all prototype PTEs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
05386     protection.
05387 
05388 Arguments:
05389 
05390      Segment - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment to protect.
05391 
05392      Protection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection value to set.
05393 
05394 Return Value:
05395 
05396      None.
05397 
05398 --*/
05399 
05400 {
05401     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05402     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
05403     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
05404     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> SubSection;
05405 
05406     <span class="comment">//</span>
05407     <span class="comment">// Set the subsection protections.</span>
05408     <span class="comment">//</span>
05409 
05410     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Segment-&gt;ControlArea-&gt;u.Flags.GlobalOnlyPerSession == 0);
05411 
05412     <span class="keywordflow">if</span> ((Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a51">MM_PROTECTION_WRITE_MASK</a>) == 0) {
05413         SubSection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(Segment-&gt;ControlArea + 1);
05414         SubSection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection = Protection;
05415         SubSection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.ReadOnly = 1;
05416     }
05417 
05418     PointerPte = Segment-&gt;PrototypePte;
05419     LastPte = PointerPte + Segment-&gt;NonExtendedPtes;
05420 
05421     <a class="code" href="../../d5/d6/iosup_8c.html#a87">MmLockPagedPool</a> (PointerPte, (LastPte - PointerPte) * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
05422 
05423     <span class="keywordflow">do</span> {
05424         PteContents = *PointerPte;
05425         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
05426         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
05427             <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
05428                 (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
05429                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (PointerPte, Protection)) {
05430                     <span class="keywordflow">continue</span>;
05431                 }
05432             }
05433             <span class="keywordflow">else</span> {
05434                 PointerPte-&gt;u.Soft.Protection = Protection;
05435             }
05436         }
05437         PointerPte += 1;
05438     } <span class="keywordflow">while</span> (PointerPte &lt; LastPte);
05439 
05440     PointerPte = Segment-&gt;PrototypePte;
05441     <a class="code" href="../../d5/d6/iosup_8c.html#a88">MmUnlockPagedPool</a> (PointerPte, (LastPte - PointerPte) * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
05442 
05443     <span class="keywordflow">return</span>;
05444 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="sysload.c::MiSetPagingOfDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSetPagingOfDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LastPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SessionSpace</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">2309</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02228">MI_CAPTURE_DIRTY_BIT_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02870">MI_FLUSH_ENTIRE_SESSION_TB</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00535">MI_MAKE_VALID_PTE_TRANSITION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05319">MM_DBG_SESSION_DRIVER_PAGES_UNLOCKED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00135">MM_EXECUTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00051">MmTotalSystemDriverPages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05463">_MM_SESSION_SPACE::NonPagablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l02208">MiEnablePagingOfDriver()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02472">MmPageEntireDriver()</a>.
<p>
<pre class="fragment"><div>02317                    :
02318 
02319     This routine marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range of PTEs as pagable.
02320 
02321 Arguments:
02322 
02323     PointerPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting PTE.
02324 
02325     LastPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending PTE.
02326 
02327 Return Value:
02328 
02329     None.
02330 
02331 --*/
02332 
02333 {
02334     PVOID Base;
02335     PFN_NUMBER PageCount;
02336     PFN_NUMBER PageFrameIndex;
02337     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
02338     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02339     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
02340     KIRQL OldIrql1;
02341     KIRQL OldIrql;
02342 
02343     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02344 
02345     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((SessionSpace == FALSE) ||
02346             (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE));
02347 
02348     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte))) {
02349 
02350         <span class="comment">//</span>
02351         <span class="comment">// No need to lock physical addresses.</span>
02352         <span class="comment">//</span>
02353 
02354         <span class="keywordflow">return</span>;
02355     }
02356 
02357     PageCount = 0;
02358 
02359     <span class="comment">//</span>
02360     <span class="comment">// Lock this routine into memory.</span>
02361     <span class="comment">//</span>
02362 
02363     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
02364 
02365     <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02366         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql1);
02367     }
02368     <span class="keywordflow">else</span> {
02369         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql1);
02370     }
02371 
02372     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02373 
02374     Base = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02375 
02376     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
02377 
02378         <span class="comment">//</span>
02379         <span class="comment">// Check to make sure this PTE has not already been</span>
02380         <span class="comment">// made pagable (or deleted).  It is pagable if it</span>
02381         <span class="comment">// is not valid, or if the PFN database wsindex element</span>
02382         <span class="comment">// is non zero.</span>
02383         <span class="comment">//</span>
02384 
02385         <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
02386             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
02387             Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02388             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
02389 
02390             <span class="keywordflow">if</span> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0) {
02391 
02392                 <span class="comment">//</span>
02393                 <span class="comment">// Original PTE may need to be set for drivers loaded</span>
02394                 <span class="comment">// via ntldr.</span>
02395                 <span class="comment">//</span>
02396     
02397                 <span class="keywordflow">if</span> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
02398                     Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
02399 <span class="preprocessor">#if defined(_IA64_)</span>
02400 <span class="preprocessor"></span>                    Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection |= <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>;
02401 <span class="preprocessor">#endif</span>
02402 <span class="preprocessor"></span>                }
02403     
02404                 TempPte = *PointerPte;
02405 
02406                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
02407                                            Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
02408 
02409                 PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (Base,
02410                                                        TRUE,
02411                                                        TRUE,
02412                                                        (PHARDWARE_PTE)PointerPte,
02413                                                        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
02414 
02415                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (&amp;PreviousPte, Pfn);
02416 
02417                 <span class="comment">//</span>
02418                 <span class="comment">// Flush the translation buffer and decrement the number of valid</span>
02419                 <span class="comment">// PTEs within the containing page table page.  Note that for a</span>
02420                 <span class="comment">// private page, the page table page is still needed because the</span>
02421                 <span class="comment">// page is in transition.</span>
02422                 <span class="comment">//</span>
02423 
02424                 <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
02425                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += 1;
02426                 <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(19, 1);
02427                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> += 1;
02428                 PageCount += 1;
02429             }
02430             <span class="keywordflow">else</span> {
02431                 <span class="comment">//</span>
02432                 <span class="comment">// This page is already pagable and has a WSLE entry.</span>
02433                 <span class="comment">// Ignore it here and let the trimmer take it if memory</span>
02434                 <span class="comment">// comes under pressure.</span>
02435                 <span class="comment">//</span>
02436             }
02437         }
02438         Base = (PVOID)((PCHAR)Base + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02439         PointerPte += 1;
02440     }
02441 
02442     <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02443 
02444         <span class="comment">//</span>
02445         <span class="comment">// Session space has no ASN - flush the entire TB.</span>
02446         <span class="comment">//</span>
02447     
02448         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a200">MI_FLUSH_ENTIRE_SESSION_TB</a> (TRUE, TRUE);
02449     }
02450 
02451     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02452 
02453     <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02454 
02455         <span class="comment">//</span>
02456         <span class="comment">// These pages are no longer locked down.</span>
02457         <span class="comment">//</span>
02458 
02459         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> -= PageCount;
02460         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_DRIVER_PAGES_UNLOCKED, PageCount);
02461 
02462         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql1);
02463     }
02464     <span class="keywordflow">else</span> {
02465         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql1);
02466     }
02467     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
02468 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="sysload.c::MiSetProtectionOnTransitionPte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiSetProtectionOnTransitionPte           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05376">MiSetImageProtect()</a>, and <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="sysload.c::MiSetSystemCodeProtection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSetSystemCodeProtection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LastPte</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l05448">5448</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01417">MI_ADD_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02228">MI_CAPTURE_DIRTY_BIT_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02841">MI_FLUSH_SINGLE_SESSION_TB</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00757">MI_IS_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00155">MiPteStr</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00136">MM_EXECUTE_READ</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l05633">MiWriteProtectSystemImage()</a>.
<p>
<pre class="fragment"><div>05455                    :
05456 
05457     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection of system code to read <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
05458     Note <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> different from protecting section-backed code like win32k.
05459 
05460 Arguments:
05461 
05462     FirstPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting PTE.
05463 
05464     LastPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending PTE.
05465 
05466 Return Value:
05467 
05468     None.
05469 
05470 --*/
05471 
05472 {
05473     KIRQL OldIrql;
05474     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
05475     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
05476     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
05477     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05478     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
05479     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte;
05480     ULONG ProtectionMask;
05481     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05482     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> ProtoPfn;
05483     LOGICAL SessionAddress;
05484 
05485 <span class="preprocessor">#if defined(_X86_)</span>
05486 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(FirstPte)) == 0);
05487 <span class="preprocessor">#endif</span>
05488 <span class="preprocessor"></span>
05489     SessionAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05490 
05491     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(FirstPte))) {
05492         SessionAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05493     }
05494     
05495     ProtectionMask = <a class="code" href="../../d4/d8/mi_8h.html#a38">MM_EXECUTE_READ</a>;
05496 
05497     <span class="comment">//</span>
05498     <span class="comment">// Make these PTEs read only.</span>
05499     <span class="comment">//</span>
05500     <span class="comment">// Note that the write bit may already be off (in the valid PTE) if the</span>
05501     <span class="comment">// page has already been inpaged from the paging file and has not since</span>
05502     <span class="comment">// been dirtied.</span>
05503     <span class="comment">//</span>
05504 
05505     PointerPte = FirstPte;
05506 
05507     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05508 
05509     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
05510 
05511         PteContents = *PointerPte;
05512 
05513         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) || (!*<a class="code" href="../../d5/d1/mminit_8c.html#a32">MiPteStr</a>)) {
05514             PointerPte += 1;
05515             <span class="keywordflow">continue</span>;
05516         }
05517 
05518         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
05519 
05520             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
05521             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
05522 
05523             <span class="comment">//</span>
05524             <span class="comment">// Note the dirty and write bits get turned off here.</span>
05525             <span class="comment">// Any existing pagefile addresses for clean pages are preserved.</span>
05526             <span class="comment">//</span>
05527 
05528             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a>(PteContents)) {
05529                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (&amp;PteContents, Pfn1);
05530             }
05531 
05532             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
05533                                PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
05534                                Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
05535                                PointerPte);
05536 
05537             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05538         
05539                 <span class="comment">//</span>
05540                 <span class="comment">// Session space has no ASN - flush the entire TB.</span>
05541                 <span class="comment">//</span>
05542             
05543                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (MiGetVirtualAddressMappedByPte (PointerPte),
05544                              TRUE,
05545                              TRUE,
05546                              (PHARDWARE_PTE)PointerPte,
05547                              TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
05548                              PreviousPte);
05549             }
05550             <span class="keywordflow">else</span> {
05551                 <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (MiGetVirtualAddressMappedByPte (PointerPte),
05552                                  TRUE,
05553                                  TRUE,
05554                                  (PHARDWARE_PTE)PointerPte,
05555                                  TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
05556             }
05557         }
05558         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
05559 
05560             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05561                 PointerPte-&gt;u.Proto.ReadOnly = 1;
05562             }
05563             <span class="keywordflow">else</span> {
05564                 PointerProtoPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(PointerPte);
05565     
05566                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(PointerProtoPte)) {
05567                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerProtoPte);
05568                     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
05569                         <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerProtoPte);
05570     
05571                         <span class="comment">//</span>
05572                         <span class="comment">// The world may change if we had to wait.</span>
05573                         <span class="comment">//</span>
05574         
05575                         PteContents = *PointerPte;
05576                         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
05577                             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
05578                                 <span class="keywordflow">continue</span>;
05579                         }
05580                     }
05581     
05582                     ProtoPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
05583                     <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(ProtoPfn, 12);
05584                     ProtoPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
05585                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProtoPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
05586                 }
05587     
05588                 PteContents = *PointerProtoPte;
05589     
05590                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
05591     
05592                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
05593     
05594                     PointerProtoPte-&gt;u.Soft.Protection = ProtectionMask;
05595     
05596                     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
05597                         (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
05598                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
05599                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
05600                     }
05601                 }
05602 
05603                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(PointerProtoPte)) {
05604                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProtoPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
05605                     <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(ProtoPfn, 13);
05606                     ProtoPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
05607                 }
05608             }
05609         }
05610         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
05611 
05612             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
05613             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
05614             PointerPte-&gt;u.Soft.Protection = ProtectionMask;
05615 
05616         }
05617         <span class="keywordflow">else</span> {
05618 
05619             <span class="comment">//</span>
05620             <span class="comment">// Must be page file space or demand zero.</span>
05621             <span class="comment">//</span>
05622 
05623             PointerPte-&gt;u.Soft.Protection = ProtectionMask;
05624         }
05625         PointerPte += 1;
05626     }
05627 
05628     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05629 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="sysload.c::MiSnapThunk" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSnapThunk           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIMAGE_THUNK_DATA&nbsp;</td>
          <td class="mdname" nowrap> <em>NameThunk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIMAGE_THUNK_DATA&nbsp;</td>
          <td class="mdname" nowrap> <em>AddrThunk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIMAGE_EXPORT_DIRECTORY&nbsp;</td>
          <td class="mdname" nowrap> <em>ExportDirectory</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ExportSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SnapForwarder</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>MissingProcedureName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l04464">4464</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00474">RtlPrefixString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>.
<p>
<pre class="fragment"><div>04477                    :
04478 
04479     This function snaps a thunk <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Export Section data.
04480     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section data does not support <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04481     partially snapped (Dll field is still non-null, but snap address is
04482     set).
04483 
04484 Arguments:
04485 
04486     DllBase - Base of DLL being snapped to.
04487 
04488     ImageBase - Base of image that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunks to snap.
04489 
04490     Thunk - On input, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk to snap.  When successfully
04491         snapped, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address in
04492         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
04493 
04494     ExportDirectory - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Export Section data from a DLL.
04495 
04496     SnapForwarder - determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> snap <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a forwarder, and therefore
04497        Address of Data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already setup.
04498 
04499 Return Value:
04500 
04501 
04502     STATUS_SUCCESS or STATUS_DRIVER_ENTRYPOINT_NOT_FOUND or
04503         STATUS_DRIVER_ORDINAL_NOT_FOUND
04504 
04505 --*/
04506 
04507 {
04508     BOOLEAN Ordinal;
04509     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> OrdinalNumber;
04510     PULONG NameTableBase;
04511     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> NameOrdinalTableBase;
04512     PULONG Addr;
04513     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> HintIndex;
04514     ULONG High;
04515     ULONG Low;
04516     ULONG Middle;
04517     LONG Result;
04518     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04519     PCHAR MissingProcedureName2;
04520     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> NameBuffer[ MAXIMUM_FILENAME_LENGTH ];
04521 
04522     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04523 
04524     <span class="comment">//</span>
04525     <span class="comment">// Determine if snap is by name, or by ordinal</span>
04526     <span class="comment">//</span>
04527 
04528     Ordinal = (BOOLEAN)IMAGE_SNAP_BY_ORDINAL(NameThunk-&gt;u1.Ordinal);
04529 
04530     <span class="keywordflow">if</span> (Ordinal &amp;&amp; !SnapForwarder) {
04531 
04532         OrdinalNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(IMAGE_ORDINAL(NameThunk-&gt;u1.Ordinal) -
04533                          ExportDirectory-&gt;Base);
04534 
04535         *MissingProcedureName = (PCHAR)(ULONG_PTR)OrdinalNumber;
04536 
04537     } <span class="keywordflow">else</span> {
04538 
04539         <span class="comment">//</span>
04540         <span class="comment">// Change AddressOfData from an RVA to a VA.</span>
04541         <span class="comment">//</span>
04542 
04543         <span class="keywordflow">if</span> (!SnapForwarder) {
04544             NameThunk-&gt;u1.AddressOfData = (ULONG_PTR)ImageBase + NameThunk-&gt;u1.AddressOfData;
04545         }
04546 
04547         strncpy( *MissingProcedureName,
04548                  &amp;((PIMAGE_IMPORT_BY_NAME)NameThunk-&gt;u1.AddressOfData)-&gt;Name[0],
04549                  MAXIMUM_FILENAME_LENGTH - 1
04550                );
04551 
04552         <span class="comment">//</span>
04553         <span class="comment">// Lookup Name in NameTable</span>
04554         <span class="comment">//</span>
04555 
04556         NameTableBase = (PULONG)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNames);
04557         NameOrdinalTableBase = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNameOrdinals);
04558 
04559         <span class="comment">//</span>
04560         <span class="comment">// Before dropping into binary search, see if</span>
04561         <span class="comment">// the hint index results in a successful</span>
04562         <span class="comment">// match. If the hint index is zero, then</span>
04563         <span class="comment">// drop into binary search.</span>
04564         <span class="comment">//</span>
04565 
04566         HintIndex = ((PIMAGE_IMPORT_BY_NAME)NameThunk-&gt;u1.AddressOfData)-&gt;Hint;
04567         <span class="keywordflow">if</span> ((ULONG)HintIndex &lt; ExportDirectory-&gt;NumberOfNames &amp;&amp;
04568             !strcmp((PSZ)((PIMAGE_IMPORT_BY_NAME)NameThunk-&gt;u1.AddressOfData)-&gt;Name,
04569              (PSZ)((PCHAR)DllBase + NameTableBase[HintIndex]))) {
04570             OrdinalNumber = NameOrdinalTableBase[HintIndex];
04571 
04572         } <span class="keywordflow">else</span> {
04573 
04574             <span class="comment">//</span>
04575             <span class="comment">// Lookup the import name in the name table using a binary search.</span>
04576             <span class="comment">//</span>
04577 
04578             Low = 0;
04579             High = ExportDirectory-&gt;NumberOfNames - 1;
04580 
04581             <span class="keywordflow">while</span> (High &gt;= Low) {
04582 
04583                 <span class="comment">//</span>
04584                 <span class="comment">// Compute the next probe index and compare the import name</span>
04585                 <span class="comment">// with the export name entry.</span>
04586                 <span class="comment">//</span>
04587 
04588                 Middle = (Low + High) &gt;&gt; 1;
04589                 Result = strcmp(&amp;((PIMAGE_IMPORT_BY_NAME)NameThunk-&gt;u1.AddressOfData)-&gt;Name[0],
04590                                 (PCHAR)((PCHAR)DllBase + NameTableBase[Middle]));
04591 
04592                 <span class="keywordflow">if</span> (Result &lt; 0) {
04593                     High = Middle - 1;
04594 
04595                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &gt; 0) {
04596                     Low = Middle + 1;
04597 
04598                 } <span class="keywordflow">else</span> {
04599                     <span class="keywordflow">break</span>;
04600                 }
04601             }
04602 
04603             <span class="comment">//</span>
04604             <span class="comment">// If the high index is less than the low index, then a matching</span>
04605             <span class="comment">// table entry was not found. Otherwise, get the ordinal number</span>
04606             <span class="comment">// from the ordinal table.</span>
04607             <span class="comment">//</span>
04608 
04609             <span class="keywordflow">if</span> (High &lt; Low) {
04610                 <span class="keywordflow">return</span> STATUS_DRIVER_ENTRYPOINT_NOT_FOUND;
04611             } <span class="keywordflow">else</span> {
04612                 OrdinalNumber = NameOrdinalTableBase[Middle];
04613             }
04614         }
04615     }
04616 
04617     <span class="comment">//</span>
04618     <span class="comment">// If OrdinalNumber is not within the Export Address Table,</span>
04619     <span class="comment">// then DLL does not implement function. Snap to LDRP_BAD_DLL.</span>
04620     <span class="comment">//</span>
04621 
04622     <span class="keywordflow">if</span> ((ULONG)OrdinalNumber &gt;= ExportDirectory-&gt;NumberOfFunctions) {
04623         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_DRIVER_ORDINAL_NOT_FOUND;
04624 
04625     } <span class="keywordflow">else</span> {
04626 
04627         MissingProcedureName2 = NameBuffer;
04628 
04629         Addr = (PULONG)((PCHAR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfFunctions);
04630         (PULONG)(AddrThunk-&gt;u1.Function) = (PULONG)((PCHAR)DllBase + Addr[OrdinalNumber]);
04631 
04632         <span class="comment">// AddrThunk s/b used from here on.</span>
04633 
04634         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04635 
04636         <span class="keywordflow">if</span> ( ((ULONG_PTR)AddrThunk-&gt;u1.Function &gt; (ULONG_PTR)ExportDirectory) &amp;&amp;
04637              ((ULONG_PTR)AddrThunk-&gt;u1.Function &lt; ((ULONG_PTR)ExportDirectory + ExportSize)) ) {
04638 
04639             UNICODE_STRING UnicodeString;
04640             ANSI_STRING ForwardDllName;
04641 
04642             PLIST_ENTRY NextEntry;
04643             PLDR_DATA_TABLE_ENTRY DataTableEntry;
04644             ULONG ExportSize;
04645             PIMAGE_EXPORT_DIRECTORY ExportDirectory;
04646 
04647             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_DRIVER_ENTRYPOINT_NOT_FOUND;
04648 
04649             <span class="comment">//</span>
04650             <span class="comment">// Include the dot in the length so we can do prefix later on.</span>
04651             <span class="comment">//</span>
04652 
04653             ForwardDllName.Buffer = (PCHAR)AddrThunk-&gt;u1.Function;
04654             ForwardDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(strchr(ForwardDllName.Buffer, <span class="charliteral">'.'</span>) -
04655                                            ForwardDllName.Buffer + 1);
04656             ForwardDllName.MaximumLength = ForwardDllName.Length;
04657 
04658             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeString,
04659                                                         &amp;ForwardDllName,
04660                                                         TRUE))) {
04661 
04662                 NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
04663 
04664                 <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
04665 
04666                     DataTableEntry = CONTAINING_RECORD(NextEntry,
04667                                                        LDR_DATA_TABLE_ENTRY,
04668                                                        InLoadOrderLinks);
04669 
04670                     <span class="comment">//</span>
04671                     <span class="comment">// We have to do a case INSENSITIVE comparison for</span>
04672                     <span class="comment">// forwarder because the linker just took what is in the</span>
04673                     <span class="comment">// def file, as opposed to looking in the exporting</span>
04674                     <span class="comment">// image for the name.</span>
04675                     <span class="comment">// we also use the prefix function to ignore the .exe or</span>
04676                     <span class="comment">// .sys or .dll at the end.</span>
04677                     <span class="comment">//</span>
04678 
04679                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a12">RtlPrefixString</a>((PSTRING)&amp;UnicodeString,
04680                                         (PSTRING)&amp;DataTableEntry-&gt;BaseDllName,
04681                                         TRUE)) {
04682 
04683                         ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)
04684                             <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(DataTableEntry-&gt;DllBase,
04685                                                          TRUE,
04686                                                          IMAGE_DIRECTORY_ENTRY_EXPORT,
04687                                                          &amp;ExportSize);
04688 
04689                         <span class="keywordflow">if</span> (ExportDirectory) {
04690 
04691                             IMAGE_THUNK_DATA thunkData;
04692                             PIMAGE_IMPORT_BY_NAME addressOfData;
04693                             ULONG length;
04694 
04695                             <span class="comment">// one extra byte for NULL,</span>
04696 
04697                             length = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(ForwardDllName.Buffer +
04698                                                 ForwardDllName.Length) + 1;
04699 
04700                             addressOfData = (PIMAGE_IMPORT_BY_NAME)
04701                                 <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
04702                                                       length +
04703                                                    <span class="keyword">sizeof</span>(IMAGE_IMPORT_BY_NAME),
04704                                                    '  mM');
04705 
04706                             <span class="keywordflow">if</span> (addressOfData) {
04707 
04708                                 RtlCopyMemory(&amp;(addressOfData-&gt;Name[0]),
04709                                               ForwardDllName.Buffer +
04710                                                   ForwardDllName.Length,
04711                                               length);
04712 
04713                                 addressOfData-&gt;Hint = 0;
04714 
04715                                 (PIMAGE_IMPORT_BY_NAME)(thunkData.u1.AddressOfData) = addressOfData;
04716 
04717                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a32">MiSnapThunk</a>(DataTableEntry-&gt;DllBase,
04718                                                      ImageBase,
04719                                                      &amp;thunkData,
04720                                                      &amp;thunkData,
04721                                                      ExportDirectory,
04722                                                      ExportSize,
04723                                                      TRUE,
04724                                                      &amp;MissingProcedureName2
04725                                                     );
04726 
04727                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(addressOfData);
04728 
04729                                 AddrThunk-&gt;u1 = thunkData.u1;
04730                             }
04731                         }
04732 
04733                         <span class="keywordflow">break</span>;
04734                     }
04735 
04736                     NextEntry = NextEntry-&gt;Flink;
04737                 }
04738 
04739                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeString);
04740             }
04741 
04742         }
04743 
04744     }
04745     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04746 }
<span class="preprocessor">#if 0</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="sysload.c::MiUpdateThunks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiUpdateThunks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>OldAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l05878">5878</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>.
<p>
<pre class="fragment"><div>05887                    :
05888 
05889     This function updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IATs of all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loaded modules in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
05890     to handle a newly relocated image.
05891 
05892 Arguments:
05893 
05894     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system loader block.
05895 
05896     OldAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL which was just relocated.
05897 
05898     NewAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL which was just relocated.
05899 
05900     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes spanned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
05901 
05902 Return Value:
05903 
05904     None.
05905 
05906 --*/
05907 
05908 {
05909     PULONG_PTR ImportThunk;
05910     ULONG_PTR OldAddressHigh;
05911     ULONG_PTR AddressDifference;
05912     PLDR_DATA_TABLE_ENTRY DataTableEntry;
05913     PLIST_ENTRY NextEntry;
05914     ULONG_PTR i;
05915     ULONG ImportSize;
05916 
05917     <span class="comment">//</span>
05918     <span class="comment">// Note this routine must not call any modules outside the kernel.</span>
05919     <span class="comment">// This is because that module may itself be the one being relocated right</span>
05920     <span class="comment">// now.</span>
05921     <span class="comment">//</span>
05922 
05923     OldAddressHigh = (ULONG_PTR)((PCHAR)OldAddress + NumberOfBytes - 1);
05924     AddressDifference = (ULONG_PTR)NewAddress - (ULONG_PTR)OldAddress;
05925 
05926     NextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
05927 
05928     <span class="keywordflow">for</span> ( ; NextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead; NextEntry = NextEntry-&gt;Flink) {
05929 
05930         DataTableEntry = CONTAINING_RECORD(NextEntry,
05931                                            LDR_DATA_TABLE_ENTRY,
05932                                            InLoadOrderLinks);
05933 
05934         ImportThunk = (PULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
05935                                            DataTableEntry-&gt;DllBase,
05936                                            TRUE,
05937                                            IMAGE_DIRECTORY_ENTRY_IAT,
05938                                            &amp;ImportSize);
05939     
05940         <span class="keywordflow">if</span> (ImportThunk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05941             <span class="keywordflow">continue</span>;
05942         }
05943 
05944         ImportSize /= <span class="keyword">sizeof</span>(PULONG_PTR);
05945 
05946         <span class="keywordflow">for</span> (i = 0; i &lt; ImportSize; i += 1, ImportThunk += 1) {
05947             <span class="keywordflow">if</span> (*ImportThunk &gt;= (ULONG_PTR)OldAddress &amp;&amp; *ImportThunk &lt;= OldAddressHigh) {
05948                 *ImportThunk += AddressDifference;
05949             }
05950         }
05951     }
05952 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="sysload.c::MiWriteProtectSystemImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiWriteProtectSystemImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DllBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="sysload.c::MmCallDllInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmCallDllInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DataTableEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06717">6717</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00178">CmRegistryMachineSystemCurrentControlSetServices</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03712">MiLocateExportName()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01910">PMM_DLL_INITIALIZE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>06723                    :
06724 
06725     This function calls <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL's initialize routine.
06726 
06727 Arguments:
06728 
06729     DataTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel's data table entry.
06730 
06731 Return Value:
06732 
06733     Various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> error codes.
06734 
06735 Environment:
06736 
06737     Kernel mode.
06738 
06739 --*/
06740 
06741 {
06742     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
06743     PWCHAR Dot;
06744     <a class="code" href="../../d2/d1/mm_8h.html#a157">PMM_DLL_INITIALIZE</a> Func;
06745     UNICODE_STRING RegistryPath;
06746     UNICODE_STRING ImportName;
06747 
06748     Func = <a class="code" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (DataTableEntry-&gt;DllBase, <span class="stringliteral">"DllInitialize"</span>);
06749 
06750     <span class="keywordflow">if</span> (!Func) {
06751         <span class="keywordflow">return</span> STATUS_SUCCESS;
06752     }
06753 
06754     ImportName.MaximumLength = DataTableEntry-&gt;BaseDllName.Length;
06755     ImportName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
06756                                                ImportName.MaximumLength,
06757                                                'TDmM');
06758 
06759     <span class="keywordflow">if</span> (ImportName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06760         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06761     }
06762 
06763     ImportName.Length = DataTableEntry-&gt;BaseDllName.Length;
06764     RtlMoveMemory (ImportName.Buffer,
06765                    DataTableEntry-&gt;BaseDllName.Buffer,
06766                    ImportName.Length);
06767 
06768     RegistryPath.MaximumLength = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length +
06769                                     ImportName.Length +
06770                                     (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(2*<span class="keyword">sizeof</span>(WCHAR));
06771 
06772     RegistryPath.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
06773                                                  RegistryPath.MaximumLength,
06774                                                  'TDmM');
06775 
06776     <span class="keywordflow">if</span> (RegistryPath.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06777         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportName.Buffer);
06778         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06779     }
06780 
06781     RegistryPath.Length = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length;
06782     RtlMoveMemory (RegistryPath.Buffer,
06783                    <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Buffer,
06784                    <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length);
06785 
06786     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;RegistryPath, L<span class="stringliteral">"\\"</span>);
06787     Dot = wcschr (ImportName.Buffer, L<span class="charliteral">'.'</span>);
06788     <span class="keywordflow">if</span> (Dot) {
06789         ImportName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((Dot - ImportName.Buffer) * <span class="keyword">sizeof</span>(WCHAR));
06790     }
06791 
06792     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a> (&amp;RegistryPath, &amp;ImportName);
06793     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportName.Buffer);
06794 
06795     <span class="comment">//</span>
06796     <span class="comment">// Invoke the DLL's initialization routine.</span>
06797     <span class="comment">//</span>
06798 
06799     st = Func (&amp;RegistryPath);
06800 
06801     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (RegistryPath.Buffer);
06802 
06803     <span class="keywordflow">return</span> st;
06804 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="sysload.c::MmCheckSystemImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmCheckSystemImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageFileHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l04820">4820</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d6/checksum_8c-source.html#l00099">LdrVerifyMappedImageMatchesChecksum()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04923">MmVerifyImageIsOkForMpUse()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>04826                    :
04827 
04828     This function ensures <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> checksum <span class="keywordflow">for</span> a system image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> correct
04829     and matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image.
04830 
04831 Arguments:
04832 
04833     ImageFileHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image.
04834 
04835 Return Value:
04836 
04837     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value.
04838 
04839 --*/
04840 
04841 {
04842 
04843     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04844     HANDLE Section;
04845     PVOID ViewBase;
04846     SIZE_T ViewSize;
04847     IO_STATUS_BLOCK IoStatusBlock;
04848     FILE_STANDARD_INFORMATION StandardInfo;
04849 
04850     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04851 
04852     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateSection(
04853                 &amp;Section,
04854                 SECTION_MAP_EXECUTE,
04855                 NULL,
04856                 NULL,
04857                 PAGE_EXECUTE,
04858                 SEC_COMMIT,
04859                 ImageFileHandle
04860                 );
04861 
04862     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04863         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04864     }
04865 
04866     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04867     ViewSize = 0;
04868 
04869     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwMapViewOfSection(
04870                 Section,
04871                 NtCurrentProcess(),
04872                 (PVOID *)&amp;ViewBase,
04873                 0L,
04874                 0L,
04875                 NULL,
04876                 &amp;ViewSize,
04877                 ViewShare,
04878                 0L,
04879                 PAGE_EXECUTE
04880                 );
04881 
04882     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04883         ZwClose(Section);
04884         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04885     }
04886 
04887     <span class="comment">//</span>
04888     <span class="comment">// Now the image is mapped as a data file... Calculate its size and then</span>
04889     <span class="comment">// check its checksum.</span>
04890     <span class="comment">//</span>
04891 
04892     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationFile(
04893                 ImageFileHandle,
04894                 &amp;IoStatusBlock,
04895                 &amp;StandardInfo,
04896                 <span class="keyword">sizeof</span>(StandardInfo),
04897                 FileStandardInformation
04898                 );
04899 
04900     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04901 
04902         <span class="keywordflow">try</span> {
04903             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7/checksum_8c.html#a1">LdrVerifyMappedImageMatchesChecksum</a>(ViewBase,StandardInfo.EndOfFile.LowPart)) {
04904                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_IMAGE_CHECKSUM_MISMATCH;
04905             }
04906 <span class="preprocessor">#if !defined(NT_UP)</span>
04907 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d8/sysload_8c.html#a60">MmVerifyImageIsOkForMpUse</a>(ViewBase) ) {
04908                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_IMAGE_MP_UP_MISMATCH;
04909                 }
04910 <span class="preprocessor">#endif // NT_UP</span>
04911 <span class="preprocessor"></span>        } except (EXCEPTION_EXECUTE_HANDLER) {
04912             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_IMAGE_CHECKSUM_MISMATCH;
04913         }
04914     }
04915 
04916     ZwUnmapViewOfSection(NtCurrentProcess(),ViewBase);
04917     ZwClose(Section);
04918     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04919 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="sysload.c::MmFreeDriverInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmFreeDriverInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">2106</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04308">MM_DBG_COMMIT_RETURN_DRIVER_INIT_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00075">MmDriverCommit</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>02112                    :
02113 
02114     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages that relocate and debug information from
02115     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
02116 
02117     NOTE:  This routine looks at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last sections defined in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image
02118            header and <span class="keywordflow">if</span> that section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> marked as DISCARDABLE in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02119            characteristics, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image.  This means
02120            that all discardable sections at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver are
02121            deleted.
02122 
02123 Arguments:
02124 
02125     SectionObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image.
02126 
02127 Return Value:
02128 
02129     None.
02130 
02131 --*/
02132 
02133 {
02134     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02135     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02136     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02137     PFN_NUMBER NumberOfPtes;
02138     PVOID Base;
02139     ULONG i;
02140     PIMAGE_NT_HEADERS NtHeaders;
02141     PIMAGE_SECTION_HEADER NtSection;
02142     PIMAGE_SECTION_HEADER FoundSection;
02143     PFN_NUMBER PagesDeleted;
02144 
02145     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
02146     DataTableEntry = (PLDR_DATA_TABLE_ENTRY)ImageHandle;
02147     Base = DataTableEntry-&gt;DllBase;
02148 
02149     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_IS_SESSION_ADDRESS (Base) == FALSE);
02150 
02151     NumberOfPtes = DataTableEntry-&gt;SizeOfImage &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02152     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Base) + NumberOfPtes;
02153 
02154     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
02155 
02156     NtSection = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeaders +
02157                         <span class="keyword">sizeof</span>(ULONG) +
02158                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
02159                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
02160                         );
02161 
02162     NtSection += NtHeaders-&gt;FileHeader.NumberOfSections;
02163 
02164     FoundSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02165     <span class="keywordflow">for</span> (i = 0; i &lt; NtHeaders-&gt;FileHeader.NumberOfSections; i += 1) {
02166         NtSection -= 1;
02167         <span class="keywordflow">if</span> ((NtSection-&gt;Characteristics &amp; IMAGE_SCN_MEM_DISCARDABLE) != 0) {
02168             FoundSection = NtSection;
02169         } <span class="keywordflow">else</span> {
02170 
02171             <span class="comment">//</span>
02172             <span class="comment">// There was a non discardable section between the this</span>
02173             <span class="comment">// section and the last non discardable section, don't</span>
02174             <span class="comment">// discard this section and don't look any more.</span>
02175             <span class="comment">//</span>
02176 
02177             <span class="keywordflow">break</span>;
02178         }
02179     }
02180 
02181     <span class="keywordflow">if</span> (FoundSection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02182 
02183         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (ROUND_TO_PAGES (
02184                                     (PCHAR)Base + FoundSection-&gt;VirtualAddress));
02185         NumberOfPtes = (PFN_NUMBER)(LastPte - PointerPte);
02186 
02187         PagesDeleted = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
02188                                                 NumberOfPtes,
02189                                                 ZeroKernelPte,
02190                                                 FALSE,
02191                                                 NULL);
02192 
02193         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesDeleted;
02194         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(18, PagesDeleted);
02195         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesDeleted);
02196         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_DRIVER_INIT_CODE, PagesDeleted);
02197         <a class="code" href="../../d8/d5/kddata_8c.html#a32">MmDriverCommit</a> -= (ULONG)PagesDeleted;
02198 <span class="preprocessor">#if DBG</span>
02199 <span class="preprocessor"></span>        MiPagesConsumed -= PagesDeleted;
02200 <span class="preprocessor">#endif</span>
02201 <span class="preprocessor"></span>    }
02202 
02203     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
02204     <span class="keywordflow">return</span>;
02205 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="sysload.c::MmGetSystemRoutineAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmGetSystemRoutineAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SystemRoutineName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06808">6808</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06928">MiFindExportedRoutineByName()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01249">RtlFreeAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>06814                    :
06815 
06816     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument function pointer <span class="keywordflow">if</span>
06817     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel or <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not.
06818 
06819 Arguments:
06820 
06821     SystemRoutineName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired routine.
06822 
06823 Return Value:
06824 
06825     Non-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> function pointer <span class="keywordflow">if</span> successful.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> not.
06826 
06827 Environment:
06828 
06829     Kernel mode.
06830 
06831 --*/
06832 
06833 {
06834     ULONG AnsiLength;
06835     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06836     PLDR_DATA_TABLE_ENTRY DataTableEntry;
06837     ANSI_STRING AnsiString;
06838     PLIST_ENTRY NextEntry;
06839     UNICODE_STRING KernelString;
06840     UNICODE_STRING HalString;
06841     PVOID FunctionAddress;
06842     LOGICAL Found;
06843     ULONG EntriesChecked;
06844 
06845     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
06846 
06847     EntriesChecked = 0;
06848     FunctionAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06849 
06850     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;KernelString, L<span class="stringliteral">"ntoskrnl.exe"</span>);
06851     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;HalString, L<span class="stringliteral">"hal.dll"</span>);
06852 
06853     <span class="keywordflow">do</span> {
06854         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiString,
06855                                                SystemRoutineName,
06856                                                TRUE );
06857     
06858         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status)) {
06859             <span class="keywordflow">break</span>;
06860         }
06861 
06862         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
06863 
06864     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
06865     
06866     <span class="comment">//</span>
06867     <span class="comment">// Arbitrary process context so prevent suspend APCs now.</span>
06868     <span class="comment">//</span>
06869 
06870     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06871     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a> (&amp;PsLoadedModuleResource, TRUE);
06872 
06873     <span class="comment">//</span>
06874     <span class="comment">// Check only the kernel and the HAL for exports.</span>
06875     <span class="comment">//</span>
06876 
06877     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
06878     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
06879 
06880         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06881 
06882         DataTableEntry = CONTAINING_RECORD(NextEntry,
06883                                            LDR_DATA_TABLE_ENTRY,
06884                                            InLoadOrderLinks);
06885 
06886         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;KernelString,
06887                                    &amp;DataTableEntry-&gt;BaseDllName,
06888                                    TRUE)) {
06889 
06890             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06891             EntriesChecked += 1;
06892 
06893         }
06894         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;HalString,
06895                                         &amp;DataTableEntry-&gt;BaseDllName,
06896                                         TRUE)) {
06897 
06898             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06899             EntriesChecked += 1;
06900         }
06901 
06902         <span class="keywordflow">if</span> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06903 
06904             FunctionAddress = <a class="code" href="../../d8/d8/sysload_8c.html#a51">MiFindExportedRoutineByName</a> (DataTableEntry,
06905                                                            &amp;AnsiString);
06906 
06907             <span class="keywordflow">if</span> (FunctionAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06908                 <span class="keywordflow">break</span>;
06909             }
06910 
06911             <span class="keywordflow">if</span> (EntriesChecked == 2) {
06912                 <span class="keywordflow">break</span>;
06913             }
06914         }
06915 
06916         NextEntry = NextEntry-&gt;Flink;
06917     }
06918 
06919     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
06920     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06921 
06922     <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a> (&amp;AnsiString);
06923 
06924     <span class="keywordflow">return</span> FunctionAddress;
06925 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="sysload.c::MmLoadAndLockSystemImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmLoadAndLockSystemImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING NamePrefix&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING LoadedBaseName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageBaseAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00379">379</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00954">IopLoadDumpDriver()</a>.
<p>
<pre class="fragment"><div>00389                    :
00390 
00391     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section into
00392     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL's header.  Very similar
00393     to <a class="code" href="../../d2/d1/mm_8h.html#a230">MmLoadSystemImage</a>, except that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> also locks down <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver pages.
00394     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed <span class="keywordflow">for</span> things like <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump driver because we cannot page <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00395     back in after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has crashed (when we want to write the system
00396     dump to the pagefile).
00397 
00398     At successful completion, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> remains
00399     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unloaded.
00400 
00401 Arguments:
00402 
00403     ImageName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
00404 
00405     ImageFileName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name (including the image name)
00406                     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
00407 
00408     NamePrefix - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix to use with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image name on load
00409                  operations.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to load <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same image multiple
00410                  times, by <span class="keyword">using</span> different prefixes
00411 
00412     LoadedBaseName - If present, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name to use on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00413                      loaded image instead of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name found on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00414                      image name.
00415 
00416     ImageHandle - Returns an opaque pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced section object
00417                   of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image that was loaded.
00418 
00419     ImageBaseAddress - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image base within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00420 
00421 Return Value:
00422 
00423     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load operation.
00424 
00425 --*/
00426 
00427 {
00428     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00429 
00430     <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/sysload_8c.html#a45">MiLoadSystemImage</a> (
00431         ImageFileName,
00432         NamePrefix,
00433         LoadedBaseName,
00434         FALSE,
00435         ImageHandle,
00436         ImageBaseAddress,
00437         TRUE
00438         );
00439 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="sysload.c::MmLoadSystemImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmLoadSystemImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING NamePrefix&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING LoadedBaseName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadInSessionSpace</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageBaseAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00315">315</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, and <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>00326                    :
00327 
00328     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section into
00329     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL's header.
00330 
00331     At successful completion, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> remains
00332     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unloaded.
00333 
00334 Arguments:
00335 
00336     ImageName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
00337 
00338     ImageFileName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name (including the image name)
00339                     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
00340 
00341     NamePrefix - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix to use with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image name on load
00342                  operations.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to load <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same image multiple
00343                  times, by <span class="keyword">using</span> different prefixes
00344 
00345     LoadedBaseName - If present, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name to use on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00346                      loaded image instead of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name found on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00347                      image name.
00348 
00349     LoadInSessionSpace - Supplies whether to load <span class="keyword">this</span> image in session space -
00350                      ie: each session will have a different copy of <span class="keyword">this</span> driver
00351                      with pages shared as much as possible via copy on write.
00352 
00353     ImageHandle - Returns an opaque pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced section object
00354                   of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image that was loaded.
00355 
00356     ImageBaseAddress - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image base within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00357 
00358 Return Value:
00359 
00360     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load operation.
00361 
00362 --*/
00363 
00364 {
00365     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00366 
00367     <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/sysload_8c.html#a45">MiLoadSystemImage</a> (
00368         ImageFileName,
00369         NamePrefix,
00370         LoadedBaseName,
00371         LoadInSessionSpace,
00372         ImageHandle,
00373         ImageBaseAddress,
00374         FALSE
00375         );
00376 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="sysload.c::MmLocateUnloadedDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUNICODE_STRING MmLocateUnloadedDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02836">2836</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02690">_UNLOADED_DRIVERS::EndAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02685">MI_UNLOADED_DRIVERS</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00093">MiLastUnloadedDriver</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00092">MiUnloadedDrivers</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02688">_UNLOADED_DRIVERS::Name</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02689">_UNLOADED_DRIVERS::StartAddress</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00317">KiDumpParameterImages()</a>.
<p>
<pre class="fragment"><div>02842                    :
02843 
02844     This routine attempts to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02845     unloaded driver list.
02846 
02847 Arguments:
02848 
02849     VirtualAddress - Supplies a <span class="keyword">virtual</span> address that might be within a driver
02850                      that has already unloaded.
02851 
02852 Return Value:
02853 
02854     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unloaded driver's name.
02855 
02856 Environment:
02857 
02858     Kernel mode, bugcheck time.
02859 
02860 --*/
02861 
02862 {
02863     <a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a> Entry;
02864     ULONG i;
02865     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02866 
02867     <span class="comment">//</span>
02868     <span class="comment">// No serialization is needed because we've crashed.</span>
02869     <span class="comment">//</span>
02870 
02871     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02872         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02873     }
02874 
02875     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> - 1;
02876 
02877     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a>; i += 1) {
02878         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a>) {
02879             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a> - 1;
02880         }
02881         Entry = &amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
02882         <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02883             <span class="keywordflow">if</span> ((VirtualAddress &gt;= Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o1">StartAddress</a>) &amp;&amp;
02884                 (VirtualAddress &lt; Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o2">EndAddress</a>)) {
02885                     <span class="keywordflow">return</span> &amp;Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>;
02886             }
02887         }
02888         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> -= 1;
02889     }
02890 
02891     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02892 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="sysload.c::MmMakeKernelResourceSectionWritable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmMakeKernelResourceSectionWritable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06495">6495</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02513">MI_WRITE_VALID_PTE_NEW_PROTECTION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00097">KeGetBugMessageText()</a>.
<p>
<pre class="fragment"><div>06501                    :
06502 
06503     This function makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel's resource section readwrite so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bugcheck
06504     code can write into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
06505 
06506 Arguments:
06507 
06508     None.
06509 
06510 Return Value:
06511 
06512     None.
06513 
06514 Environment:
06515 
06516     Kernel mode.  Any IRQL.
06517 
06518 --*/
06519 
06520 {
06521 <span class="preprocessor">#if defined (_X86_)</span>
06522 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
06523     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
06524     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06525 
06526     <span class="keywordflow">if</span> (MiKernelResourceStartPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06527         <span class="keywordflow">return</span>;
06528     }
06529 
06530     PointerPte = MiKernelResourceStartPte;
06531 
06532     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (MiGetVirtualAddressMappedByPte (PointerPte))) {
06533 
06534         <span class="comment">//</span>
06535         <span class="comment">// Mapped physically, doesn't need to be made readwrite.</span>
06536         <span class="comment">//</span>
06537 
06538         <span class="keywordflow">return</span>;
06539     }
06540 
06541     <span class="comment">//</span>
06542     <span class="comment">// Since the entry state and IRQL are unknown, just go through the</span>
06543     <span class="comment">// PTEs without a lock and make them all readwrite.</span>
06544     <span class="comment">//</span>
06545 
06546     <span class="keywordflow">do</span> {
06547         PteContents = *PointerPte;
06548 <span class="preprocessor">#if defined(NT_UP)</span>
06549 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0)
06550 <span class="preprocessor">#else</span>
06551 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable == 0)
06552 <span class="preprocessor">#endif</span>
06553 <span class="preprocessor"></span>        {
06554             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
06555                                PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
06556                                MM_READWRITE,
06557                                PointerPte);
06558 <span class="preprocessor">#if !defined(NT_UP)</span>
06559 <span class="preprocessor"></span>            TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable = 1;
06560 <span class="preprocessor">#endif</span>
06561 <span class="preprocessor"></span>            <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a> (PointerPte, TempPte);
06562         }
06563         PointerPte += 1;
06564     } <span class="keywordflow">while</span> (PointerPte &lt;= MiKernelResourceEndPte); 
06565 
06566     <span class="comment">//</span>
06567     <span class="comment">// Don't do this more than once.</span>
06568     <span class="comment">//</span>
06569 
06570     MiKernelResourceStartPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06571 
06572     <span class="comment">//</span>
06573     <span class="comment">// Only flush this processor as the state of the others is unknown.</span>
06574     <span class="comment">//</span>
06575 
06576     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a> ();
06577 <span class="preprocessor">#endif</span>
06578 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="sysload.c::MmPageEntireDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmPageEntireDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AddressWithinSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02472">2472</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05287">MI_IS_SESSION_IMAGE_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">MiSetPagingOfDriver()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00082">MmDisablePagingExecutive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>02478                    :
02479 
02480     This routine allows a driver to page <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> all of its code and
02481     data regardless of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> various image sections.
02482 
02483     Note, <span class="keyword">this</span> routine can be called multiple times with no
02484     intervening calls to <a class="code" href="../../d2/d1/mm_8h.html#a310">MmResetDriverPaging</a>.
02485 
02486 Arguments:
02487 
02488     AddressWithinSection - Supplies an address within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver, e.g.
02489                            <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>.
02490 
02491 Return Value:
02492 
02493     Base address of driver.
02494 
02495 Environment:
02496 
02497     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
02498 
02499 --*/
02500 
02501 {
02502     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02503     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
02504     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02505     PVOID BaseAddress;
02506     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer;
02507     BOOLEAN SessionSpace;
02508 
02509     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02510 
02511     <span class="comment">//</span>
02512     <span class="comment">// Don't page kernel mode code if disabled via registry.</span>
02513     <span class="comment">//</span>
02514 
02515     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, FALSE);
02516 
02517     <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02518         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02519     }
02520 
02521     SectionPointer = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)DataTableEntry-&gt;SectionPointer;
02522 
02523     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>) {
02524         <span class="keywordflow">return</span> DataTableEntry-&gt;DllBase;
02525     }
02526 
02527     SessionSpace = <a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (AddressWithinSection);
02528 
02529     <span class="keywordflow">if</span> ((SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (SectionPointer != (PVOID)-1)) {
02530 
02531         <span class="comment">//</span>
02532         <span class="comment">// Driver is mapped as an image (ie: win32k), this is always pagable.</span>
02533         <span class="comment">// For session space, an image that has been loaded at its desired</span>
02534         <span class="comment">// address is also always pagable.  If there was an address collision,</span>
02535         <span class="comment">// then we fall through because we have to explicitly page it.</span>
02536         <span class="comment">//</span>
02537 
02538         <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02539             <span class="keywordflow">if</span> (SectionPointer-&gt;Segment &amp;&amp;
02540                 SectionPointer-&gt;Segment-&gt;BasedAddress == SectionPointer-&gt;Segment-&gt;SystemImageBase) {
02541                 <span class="keywordflow">return</span> DataTableEntry-&gt;DllBase;
02542             }
02543         }
02544         <span class="keywordflow">else</span> {
02545             <span class="keywordflow">return</span> DataTableEntry-&gt;DllBase;
02546         }
02547     }
02548 
02549     BaseAddress = DataTableEntry-&gt;DllBase;
02550     FirstPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
02551     LastPte = (FirstPte - 1) + (DataTableEntry-&gt;SizeOfImage &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02552 
02553     <a class="code" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (FirstPte, LastPte, SessionSpace);
02554 
02555     <span class="keywordflow">return</span> BaseAddress;
02556 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="sysload.c::MmResetDriverPaging" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmResetDriverPaging           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AddressWithinSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02560">2560</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00115">MM_LOCK_BY_NONPAGE</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00082">MmDisablePagingExecutive</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>.
<p>
<pre class="fragment"><div>02566                    :
02567 
02568     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver paging to what <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image specified.
02569     Hence image sections such as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IAT, .text, .data will be locked
02570     down in memory.
02571 
02572     Note, there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no requirement that <a class="code" href="../../d2/d1/mm_8h.html#a311">MmPageEntireDriver</a> was called.
02573 
02574 Arguments:
02575 
02576      AddressWithinSection - Supplies an address within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver, e.g.
02577                             <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>.
02578 
02579 Return Value:
02580 
02581     None.
02582 
02583 Environment:
02584 
02585     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
02586 
02587 --*/
02588 
02589 {
02590     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02591     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02592     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02593     PVOID Base;
02594     ULONG i;
02595     PIMAGE_NT_HEADERS NtHeaders;
02596     PIMAGE_SECTION_HEADER FoundSection;
02597     KIRQL OldIrql;
02598     KIRQL OldIrqlWs;
02599 
02600     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02601 
02602     <span class="comment">//</span>
02603     <span class="comment">// Don't page kernel mode code if disabled via registry.</span>
02604     <span class="comment">//</span>
02605 
02606     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>) {
02607         <span class="keywordflow">return</span>;
02608     }
02609 
02610     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(AddressWithinSection)) {
02611         <span class="keywordflow">return</span>;
02612     }
02613 
02614     <span class="comment">//</span>
02615     <span class="comment">// If the driver has pagable code, make it paged.</span>
02616     <span class="comment">//</span>
02617 
02618     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, FALSE);
02619 
02620     <span class="keywordflow">if</span> ((DataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02621         (DataTableEntry-&gt;SectionPointer != (PVOID)-1)) {
02622 
02623         <span class="comment">//</span>
02624         <span class="comment">// Driver is mapped by image hence already paged.</span>
02625         <span class="comment">//</span>
02626 
02627         <span class="keywordflow">return</span>;
02628     }
02629 
02630     Base = DataTableEntry-&gt;DllBase;
02631 
02632     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
02633 
02634     FoundSection = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeaders +
02635                         <span class="keyword">sizeof</span>(ULONG) +
02636                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
02637                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
02638                         );
02639 
02640     i = NtHeaders-&gt;FileHeader.NumberOfSections;
02641     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02642 
02643     <span class="keywordflow">while</span> (i &gt; 0) {
02644 <span class="preprocessor">#if DBG</span>
02645 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((*(PULONG)FoundSection-&gt;Name == 'tini') ||
02646                 (*(PULONG)FoundSection-&gt;Name == 'egap')) {
02647                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ has lower case sections (init or pagexxx)\n"</span>,
02648                     &amp;DataTableEntry-&gt;FullDllName);
02649             }
02650 <span class="preprocessor">#endif</span>
02651 <span class="preprocessor"></span>
02652         <span class="comment">//</span>
02653         <span class="comment">// Don't lock down code for sections marked as discardable or</span>
02654         <span class="comment">// sections marked with the first 4 characters PAGE or .eda</span>
02655         <span class="comment">// (for the .edata section) or INIT.</span>
02656         <span class="comment">//</span>
02657 
02658         <span class="keywordflow">if</span> (((FoundSection-&gt;Characteristics &amp; IMAGE_SCN_MEM_DISCARDABLE) != 0) ||
02659            (*(PULONG)FoundSection-&gt;Name == 'EGAP') ||
02660            (*(PULONG)FoundSection-&gt;Name == 'ade.') ||
02661            (*(PULONG)FoundSection-&gt;Name == 'TINI')) {
02662 
02663             NOTHING;
02664 
02665         } <span class="keywordflow">else</span> {
02666 
02667             <span class="comment">//</span>
02668             <span class="comment">// This section is nonpagable.</span>
02669             <span class="comment">//</span>
02670 
02671             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
02672                                    (PCHAR)Base + FoundSection-&gt;VirtualAddress);
02673             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)Base +
02674                                        FoundSection-&gt;VirtualAddress +
02675                                       (FoundSection-&gt;SizeOfRawData - 1));
02676             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &lt;= LastPte);
02677             <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
02678             <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrqlWs);
02679             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02680             <a class="code" href="../../d4/d8/mi_8h.html#a873">MiLockCode</a> (PointerPte, LastPte, MM_LOCK_BY_NONPAGE);
02681             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02682             <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
02683             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
02684         }
02685         i -= 1;
02686         FoundSection += 1;
02687     }
02688     <span class="keywordflow">return</span>;
02689 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="sysload.c::MmUnloadSystemImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmUnloadSystemImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">2896</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02894">ExpCheckForResource()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05766">_IMAGE_ENTRY_IN_SESSION::ImageCountInThisSession</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00467">KeCheckForTimer()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00046">LOADED_AT_BOOT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05287">MI_IS_SESSION_IMAGE_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04192">MiActiveVerifierThunks</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02693">MiClearImports()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">MiDereferenceImports()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02740">MiRememberUnloadedDriver()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l01223">MiRemoveImageSessionWide()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00518">MiSessionLookupImage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00866">MiSessionWideGetImageSize()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a106">MiVerifierCheckThunks()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03625">MiVerifyingDriverUnloading()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04309">MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04310">MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05326">MM_DBG_SESSION_COMMIT_IMAGE_UNLOAD</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00082">MmDisablePagingExecutive</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00075">MmDriverCommit</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00088">MmSnapUnloads</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00928">MmSystemLoadLock</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00051">MmTotalSystemDriverPages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02184">PERFINFO_IMAGE_UNLOAD</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00080">PsLoadedModuleSpinLock</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01249">RtlFreeAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00698">IopDeleteDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03645">MiCallDllUnloadAndUnloadDll()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00572">MiSessionUnloadAllImages()</a>, and <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>02902                    :
02903 
02904     This routine unloads a previously loaded system image and returns
02905     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated resources.
02906 
02907 Arguments:
02908 
02909     ImageHandle - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02910                   image to unload.
02911 
02912 Return Value:
02913 
02914     Various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> codes.
02915 
02916 --*/
02917 
02918 {
02919     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02920     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02921     PFN_NUMBER PagesRequired;
02922     PFN_NUMBER ResidentPages;
02923     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02924     PFN_NUMBER NumberOfPtes;
02925     KIRQL OldIrql;
02926     PVOID BasedAddress;
02927     SIZE_T NumberOfBytes;
02928     BOOLEAN MustFree;
02929     SIZE_T CommittedPages;
02930     BOOLEAN ViewDeleted;
02931     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> DriverImage;
02932     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02933     PVOID StillQueued;
02934     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer;
02935 
02936     <span class="comment">//</span>
02937     <span class="comment">// Arbitrary process context so prevent suspend APCs now.</span>
02938     <span class="comment">//</span>
02939 
02940     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02941 
02942     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MmSystemLoadLock,
02943                            WrVirtualMemory,
02944                            KernelMode,
02945                            FALSE,
02946                            (PLARGE_INTEGER)NULL);
02947 
02948     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
02949 
02950     ViewDeleted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02951     DataTableEntry = (PLDR_DATA_TABLE_ENTRY)ImageHandle;
02952     BasedAddress = DataTableEntry-&gt;DllBase;
02953 
02954 <span class="preprocessor">#if DBGXX</span>
02955 <span class="preprocessor"></span>    <span class="comment">//</span>
02956     <span class="comment">// MiUnloadSystemImageByForce violates this check so remove it for now.</span>
02957     <span class="comment">//</span>
02958 
02959     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink) {
02960         LOGICAL Found;
02961         PLIST_ENTRY NextEntry;
02962         PLDR_DATA_TABLE_ENTRY DataTableEntry2;
02963 
02964         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02965         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02966         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
02967     
02968             DataTableEntry2 = CONTAINING_RECORD(NextEntry,
02969                                                 LDR_DATA_TABLE_ENTRY,
02970                                                 InLoadOrderLinks);
02971             <span class="keywordflow">if</span> (DataTableEntry == DataTableEntry2) {
02972                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02973                 <span class="keywordflow">break</span>;
02974             }
02975             NextEntry = NextEntry-&gt;Flink;
02976         }
02977         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Found == TRUE);
02978     }
02979 <span class="preprocessor">#endif</span>
02980 <span class="preprocessor"></span>
02981 <span class="preprocessor">#if DBG_SYSLOAD</span>
02982 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (DataTableEntry-&gt;SectionPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02983         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Called to unload boot driver %wZ\n"</span>,
02984             &amp;DataTableEntry-&gt;FullDllName);
02985     }
02986     <span class="keywordflow">else</span> {
02987         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Called to unload non-boot driver %wZ\n"</span>,
02988             &amp;DataTableEntry-&gt;FullDllName);
02989     }
02990 <span class="preprocessor">#endif</span>
02991 <span class="preprocessor"></span>
02992     <span class="comment">//</span>
02993     <span class="comment">// Any driver loaded at boot that did not have its import list</span>
02994     <span class="comment">// and LoadCount reconstructed cannot be unloaded because we don't</span>
02995     <span class="comment">// know how many other drivers may be linked to it.</span>
02996     <span class="comment">//</span>
02997 
02998     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadedImports == (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>) {
02999         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03000         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03001         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03002         <span class="keywordflow">return</span> STATUS_SUCCESS;
03003     }
03004 
03005     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount != 0);
03006 
03007     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (BasedAddress)) {
03008 
03009         <span class="comment">//</span>
03010         <span class="comment">// A printer driver may be referenced multiple times for the</span>
03011         <span class="comment">// same session space.  Only unload the last reference.</span>
03012         <span class="comment">//</span>
03013 
03014         DriverImage = <a class="code" href="../../d4/d7/sessload_8c.html#a13">MiSessionLookupImage</a> (BasedAddress);
03015 
03016         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverImage);
03017 
03018         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a>);
03019 
03020         <span class="keywordflow">if</span> (DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> &gt; 1) {
03021 
03022             DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> -= 1;
03023             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03024             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03025             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03026 
03027             <span class="keywordflow">return</span> STATUS_SUCCESS;
03028         }
03029 
03030         <span class="comment">//</span>
03031         <span class="comment">// The reference count for this image has dropped to zero in this</span>
03032         <span class="comment">// session, so we can delete this session's view of the image.</span>
03033         <span class="comment">//</span>
03034 
03035         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a16">MiSessionWideGetImageSize</a> (BasedAddress,
03036                                             &amp;NumberOfBytes,
03037                                             &amp;CommittedPages);
03038 
03039         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03040 
03041             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
03042                           0x41286,
03043                           (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
03044                           (ULONG_PTR)BasedAddress,
03045                           0);
03046         }
03047 
03048         <span class="comment">//</span>
03049         <span class="comment">// Free the session space taken up by the image, unmapping it from</span>
03050         <span class="comment">// the current VA space - note this does not remove page table pages</span>
03051         <span class="comment">// from the session PageTables[].  Each data page is only freed</span>
03052         <span class="comment">// if there are no other references to it (ie: from any other</span>
03053         <span class="comment">// sessions).</span>
03054         <span class="comment">//</span>
03055 
03056         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BasedAddress);
03057         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((ULONG_PTR)BasedAddress + NumberOfBytes);
03058 
03059         PagesRequired = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
03060                                                  (PFN_NUMBER)(LastPte - PointerPte),
03061                                                  ZeroKernelPte,
03062                                                  TRUE,
03063                                                  &amp;ResidentPages);
03064 
03065         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a> == 0) {
03066 
03067             SectionPointer = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)DataTableEntry-&gt;SectionPointer;
03068         
03069             <span class="keywordflow">if</span> ((SectionPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03070                 (SectionPointer == (PVOID)-1) ||
03071                 (SectionPointer-&gt;Segment == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03072                 (SectionPointer-&gt;Segment-&gt;BasedAddress != SectionPointer-&gt;Segment-&gt;SystemImageBase)) {
03073 
03074                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> -= (ULONG)(PagesRequired - ResidentPages);
03075             }
03076         }
03077 
03078         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
03079         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
03080 
03081         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_COMMIT_IMAGE_UNLOAD,
03082             CommittedPages);
03083 
03084         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
03085 
03086         ViewDeleted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03087 
03088         <span class="comment">//</span>
03089         <span class="comment">// Return the commitment we took out on the pagefile when the</span>
03090         <span class="comment">// image was allocated.</span>
03091         <span class="comment">//</span>
03092 
03093         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommittedPages);
03094         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD, CommittedPages);
03095 
03096         <span class="comment">//</span>
03097         <span class="comment">// Tell the session space image handler that we are releasing</span>
03098         <span class="comment">// our claim to the image.</span>
03099         <span class="comment">//</span>
03100 
03101         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BasedAddress);
03102 
03103         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NT_SUCCESS (Status));
03104     }
03105 
03106     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount != 0);
03107 
03108     DataTableEntry-&gt;LoadCount -= 1;
03109 
03110     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadCount != 0) {
03111         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03112         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03113         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03114         <span class="keywordflow">return</span> STATUS_SUCCESS;
03115     }
03116 
03117 <span class="preprocessor">#if DBG</span>
03118 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (BasedAddress)) {
03119         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiSessionLookupImage (BasedAddress) == NULL);
03120     }
03121 <span class="preprocessor">#endif</span>
03122 <span class="preprocessor"></span>
03123     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a>) {
03124 <span class="preprocessor">#if 0</span>
03125 <span class="preprocessor"></span>        StillQueued = <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a> (DataTableEntry-&gt;DllBase,
03126                                        DataTableEntry-&gt;SizeOfImage);
03127 
03128         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03129             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03130                           0x18,
03131                           (ULONG_PTR)StillQueued,
03132                           (ULONG_PTR)-1,
03133                           (ULONG_PTR)DataTableEntry-&gt;DllBase);
03134         }
03135 
03136         StillQueued = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a> (DataTableEntry-&gt;DllBase,
03137                                            DataTableEntry-&gt;SizeOfImage);
03138 
03139         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03140             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03141                           0x19,
03142                           (ULONG_PTR)StillQueued,
03143                           (ULONG_PTR)-1,
03144                           (ULONG_PTR)DataTableEntry-&gt;DllBase);
03145         }
03146 <span class="preprocessor">#endif</span>
03147 <span class="preprocessor"></span>    }
03148 
03149     <span class="keywordflow">if</span> (DataTableEntry-&gt;Flags &amp; LDRP_IMAGE_VERIFYING) {
03150         <a class="code" href="../../d9/d5/verifier_8c.html#a111">MiVerifyingDriverUnloading</a> (DataTableEntry);
03151     }
03152 
03153     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a554">MiActiveVerifierThunks</a> != 0) {
03154         <a class="code" href="../../d9/d5/verifier_8c.html#a106">MiVerifierCheckThunks</a> (DataTableEntry);
03155     }
03156 
03157     <span class="comment">//</span>
03158     <span class="comment">// Unload symbols from debugger.</span>
03159     <span class="comment">//</span>
03160 
03161     <span class="keywordflow">if</span> (DataTableEntry-&gt;Flags &amp; LDRP_DEBUG_SYMBOLS_LOADED) {
03162 
03163         <span class="comment">//</span>
03164         <span class="comment">//  TEMP TEMP TEMP rip out when debugger converted</span>
03165         <span class="comment">//</span>
03166 
03167         ANSI_STRING AnsiName;
03168         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03169 
03170         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiName,
03171                                                &amp;DataTableEntry-&gt;BaseDllName,
03172                                                TRUE );
03173 
03174         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status)) {
03175             DbgUnLoadImageSymbols( &amp;AnsiName,
03176                                    BasedAddress,
03177                                    (ULONG)-1);
03178             <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a>( &amp;AnsiName );
03179         }
03180     }
03181 
03182     <span class="comment">//</span>
03183     <span class="comment">// No unload can happen till after Mm has finished Phase 1 initialization.</span>
03184     <span class="comment">// Therefore, large pages are already in effect (if this platform supports</span>
03185     <span class="comment">// it).</span>
03186     <span class="comment">//</span>
03187 
03188     <span class="keywordflow">if</span> (ViewDeleted == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03189 
03190         NumberOfPtes = DataTableEntry-&gt;SizeOfImage &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03191 
03192         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a>) {
03193             <a class="code" href="../../d8/d8/sysload_8c.html#a46">MiRememberUnloadedDriver</a> (&amp;DataTableEntry-&gt;BaseDllName,
03194                                       BasedAddress,
03195                                       (ULONG)(NumberOfPtes &lt;&lt; PAGE_SHIFT));
03196         }
03197 
03198         <span class="keywordflow">if</span> (DataTableEntry-&gt;Flags &amp; LDRP_SYSTEM_MAPPED) {
03199 
03200             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BasedAddress);
03201 
03202             PagesRequired = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
03203                                                      NumberOfPtes,
03204                                                      ZeroKernelPte,
03205                                                      FALSE,
03206                                                      &amp;ResidentPages);
03207     
03208             <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> -= (ULONG)(PagesRequired - ResidentPages);
03209 
03210             <span class="comment">//</span>
03211             <span class="comment">// Note that drivers loaded at boot that have not been relocated</span>
03212             <span class="comment">// have no system PTEs or commit charged.</span>
03213             <span class="comment">//</span>
03214     
03215             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
03216                                  (ULONG)NumberOfPtes,
03217                                  SystemPteSpace);
03218 
03219             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03220             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += ResidentPages;
03221             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(21, ResidentPages);
03222             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03223 
03224             <span class="comment">//</span>
03225             <span class="comment">// Only return commitment for drivers that weren't loaded by the</span>
03226             <span class="comment">// boot loader.</span>
03227             <span class="comment">//</span>
03228     
03229             <span class="keywordflow">if</span> (DataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03230                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesRequired);
03231                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD1, PagesRequired);
03232                 <a class="code" href="../../d8/d5/kddata_8c.html#a32">MmDriverCommit</a> -= (ULONG)PagesRequired;
03233             }
03234         }
03235         <span class="keywordflow">else</span> {
03236 
03237             <span class="comment">//</span>
03238             <span class="comment">// This must be a boot driver that was not relocated into</span>
03239             <span class="comment">// system PTEs.  If large or super pages are enabled, the</span>
03240             <span class="comment">// image pages must be freed without referencing the</span>
03241             <span class="comment">// non-existent page table pages.  If large/super pages are</span>
03242             <span class="comment">// not enabled, note that system PTEs were not used to map the</span>
03243             <span class="comment">// image and thus, cannot be freed.</span>
03244 
03245             <span class="comment">//</span>
03246             <span class="comment">// This is further complicated by the fact that the INIT and/or</span>
03247             <span class="comment">// discardable portions of these images may have already been freed.</span>
03248             <span class="comment">//</span>
03249         }
03250     }
03251 
03252     <span class="comment">//</span>
03253     <span class="comment">// Search the loaded module list for the data table entry that describes</span>
03254     <span class="comment">// the DLL that was just unloaded. It is possible an entry is not in the</span>
03255     <span class="comment">// list if a failure occurred at a point in loading the DLL just before</span>
03256     <span class="comment">// the data table entry was generated.</span>
03257     <span class="comment">//</span>
03258 
03259     <span class="keywordflow">if</span> (DataTableEntry-&gt;InLoadOrderLinks.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03260         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03261         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;PsLoadedModuleResource, TRUE);
03262 
03263         ExAcquireSpinLock (&amp;PsLoadedModuleSpinLock, &amp;OldIrql);
03264 
03265         RemoveEntryList(&amp;DataTableEntry-&gt;InLoadOrderLinks);
03266         ExReleaseSpinLock (&amp;PsLoadedModuleSpinLock, OldIrql);
03267 
03268         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
03269         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03270 
03271         MustFree = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03272     }
03273     <span class="keywordflow">else</span> {
03274         MustFree = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03275     }
03276 
03277     <span class="comment">//</span>
03278     <span class="comment">// Handle unloading of any dependent DLLs that we loaded automatically</span>
03279     <span class="comment">// for this image.</span>
03280     <span class="comment">//</span>
03281 
03282     <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> ((<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)DataTableEntry-&gt;LoadedImports);
03283 
03284     <a class="code" href="../../d8/d8/sysload_8c.html#a37">MiClearImports</a> (DataTableEntry);
03285 
03286     <span class="comment">//</span>
03287     <span class="comment">// Free this loader entry.</span>
03288     <span class="comment">//</span>
03289 
03290     <span class="keywordflow">if</span> (MustFree == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03291 
03292         <span class="keywordflow">if</span> (DataTableEntry-&gt;FullDllName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03293             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry-&gt;FullDllName.Buffer);
03294         }
03295 
03296         <span class="keywordflow">if</span> (DataTableEntry-&gt;BaseDllName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03297             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry-&gt;BaseDllName.Buffer);
03298         }
03299 
03300         <span class="comment">//</span>
03301         <span class="comment">// Dereference the section object if there is one.</span>
03302         <span class="comment">// There should only be one for win32k.sys and Hydra session images.</span>
03303         <span class="comment">//</span>
03304 
03305         <span class="keywordflow">if</span> ((DataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03306             (DataTableEntry-&gt;SectionPointer != (PVOID)-1)) {
03307 
03308             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (DataTableEntry-&gt;SectionPointer);
03309         }
03310 
03311         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)DataTableEntry);
03312     }
03313 
03314     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03315 
03316     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03317     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03318 
03319     <a class="code" href="../../d2/d1/mm_8h.html#a63">PERFINFO_IMAGE_UNLOAD</a>(BasedAddress);
03320 
03321     <span class="keywordflow">return</span> STATUS_SUCCESS;
03322 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="sysload.c::MmVerifyImageIsOkForMpUse" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmVerifyImageIsOkForMpUse           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l04923">4923</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l04820">MmCheckSystemImage()</a>.
<p>
<pre class="fragment"><div>04926 {
04927     PIMAGE_NT_HEADERS NtHeaders;
04928 
04929     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04930 
04931     <span class="comment">//</span>
04932     <span class="comment">// If the file is an image file, then subtract the two checksum words</span>
04933     <span class="comment">// in the optional header from the computed checksum before adding</span>
04934     <span class="comment">// the file length, and set the value of the header checksum.</span>
04935     <span class="comment">//</span>
04936 
04937     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(BaseAddress);
04938     <span class="keywordflow">if</span> (NtHeaders != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04939         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> &gt; 1 &amp;&amp;
04940              (NtHeaders-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_UP_SYSTEM_ONLY) ) {
04941             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04942         }
04943     }
04944     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04945 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a18" doxytag="sysload.c::ExPoolCodeEnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d8/d8/sysload_8c.html#a18">ExPoolCodeEnd</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00092">92</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l06395">MiLocateKernelSections()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="sysload.c::ExPoolCodeStart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d8/d8/sysload_8c.html#a17">ExPoolCodeStart</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00091">91</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l06395">MiLocateKernelSections()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="sysload.c::MiFirstDriverLoadEver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d8/d8/sysload_8c.html#a10">MiFirstDriverLoadEver</a> = TRUE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00061">61</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="sysload.c::MiLastUnloadedDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d8/sysload_8c.html#a13">MiLastUnloadedDriver</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00077">77</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l02740">MiRememberUnloadedDriver()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02836">MmLocateUnloadedDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="sysload.c::MiNoLowMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d8/d8/sysload_8c.html#a24">MiNoLowMemory</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00268">268</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="sysload.c::MiPteStr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d1/bench_8h.html#a8">CHAR</a> <a class="el" href="../../d8/d8/sysload_8c.html#a25">MiPteStr</a>[] = "\0"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00311">311</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l05448">MiSetSystemCodeProtection()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="sysload.c::MiTotalUnloads" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d8/sysload_8c.html#a14">MiTotalUnloads</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00078">78</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l02740">MiRememberUnloadedDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="sysload.c::MiUnloadedDrivers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a> <a class="el" href="../../d8/d8/sysload_8c.html#a12">MiUnloadedDrivers</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00075">75</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="sysload.c::MiUnloadsSkipped" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d8/sysload_8c.html#a15">MiUnloadsSkipped</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00079">79</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l02740">MiRememberUnloadedDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="sysload.c::MmDriverCommit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d8/sysload_8c.html#a9">MmDriverCommit</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00059">59</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="sysload.c::MmEnforceWriteProtection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d8/sysload_8c.html#a16">MmEnforceWriteProtection</a> = 1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00085">85</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="sysload.c::MmMakeLowMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d8/d8/sysload_8c.html#a11">MmMakeLowMemory</a> = TRUE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00068">68</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="sysload.c::MmPoolCodeEnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d8/d8/sysload_8c.html#a20">MmPoolCodeEnd</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00094">94</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l06395">MiLocateKernelSections()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="sysload.c::MmPoolCodeStart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d8/d8/sysload_8c.html#a19">MmPoolCodeStart</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00093">93</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l06395">MiLocateKernelSections()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="sysload.c::MmPteCodeEnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d8/d8/sysload_8c.html#a22">MmPteCodeEnd</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00096">96</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l06395">MiLocateKernelSections()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="sysload.c::MmPteCodeStart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d8/d8/sysload_8c.html#a21">MmPteCodeStart</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00095">95</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l06395">MiLocateKernelSections()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="sysload.c::MmSystemLoadLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a> <a class="el" href="../../d8/d8/sysload_8c.html#a7">MmSystemLoadLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00055">55</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="sysload.c::MmTotalSystemDriverPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d8/sysload_8c.html#a8">MmTotalSystemDriverPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00057">57</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="sysload.c::PsLoadedModuleList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d8/d8/sysload_8c.html#a27">PsLoadedModuleList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06586">6586</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="sysload.c::PsLoadedModuleResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d8/d8/sysload_8c.html#a28">PsLoadedModuleResource</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06587">6587</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l08928">IopInitializeBootLogging()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02735">MiEnablePagingTheExecutive()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02474">MiFindInitializationCode()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06591">MiInitializeLoadedModuleList()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l01273">MiLookupPsLoadedModule()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06797">MmGetSectionRange()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06808">MmGetSystemRoutineAddress()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06864">MmLockPagableDataSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>, and <a class="el" href="../../d3/d2/dbgctrl_8c-source.html#l00036">NtSystemDebugControl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="sysload.c::PsLoadedModuleSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d8/d8/sysload_8c.html#a23">PsLoadedModuleSpinLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00106">106</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="sysload.c::PsNtosImageBase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d8/d8/sysload_8c.html#a26">PsNtosImageBase</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06583">6583</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02838">KdpGetVersion()</a>, <a class="el" href="../../d9/d1/ia64_2initkr_8c-source.html#l00078">KiInitializeKernel()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l06591">MiInitializeLoadedModuleList()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
