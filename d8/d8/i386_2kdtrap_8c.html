<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: i386/kdtrap.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdtrap.c File Reference</h1><code>#include "<a class="el" href="../../d2/d6/4_2kdp_8h-source.html">kdp.h</a>"</code><br>

<p>
<a href="../../d9/d7/i386_2kdtrap_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PUCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/i386_2kdtrap_8c.html#a0">KdpCopyDataToStack</a> (PUCHAR, ULONG)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/i386_2kdtrap_8c.html#a1">KdpTrap</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame, IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN BOOLEAN SecondChance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/i386_2kdtrap_8c.html#a2">KdIsThisAKdTrap</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/i386_2kdtrap_8c.html#a3">KdpCheckTracePoint</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN OUT PCONTEXT ContextRecord)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/i386_2kdtrap_8c.html#a4">SaveSymLoad</a> (IN PSTRING PathName, IN PVOID BaseOfDll, IN LONG ProcessId, IN BOOLEAN UnloadSymbols)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/i386_2kdtrap_8c.html#a5">KdpStub</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame, IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN BOOLEAN SecondChance)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="i386/kdtrap.c::KdIsThisAKdTrap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdIsThisAKdTrap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/i386_2kdtrap_8c-source.html#l00406">406</a> of file <a class="el" href="../../d9/d7/i386_2kdtrap_8c-source.html">i386/kdtrap.c</a>.
<p>
References <a class="el" href="../../d9/d2/ia32def_8h-source.html#l00051">BREAKPOINT_BREAK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00414                    :
00415 
00416     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a user-mode exception occurs and
00417     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> might be a kernel debugger exception (Like DbgPrint/DbgPrompt ).
00418 
00419 Arguments:
00420 
00421     ExceptionRecord - Supplies a pointer to an exception record that
00422         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00423 
00424     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00425 
00426     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00427 
00428 Return Value:
00429 
00430     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger.
00431     Otherwise, a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00432 
00433 --*/
00434 
00435 {
00436     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00437         (ExceptionRecord-&gt;NumberParameters &gt; 0) &amp;&amp;
00438         (ExceptionRecord-&gt;ExceptionInformation[0] != <a class="code" href="../../d8/d3/ia32def_8h.html#a17">BREAKPOINT_BREAK</a>)) {
00439 
00440         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00441     } <span class="keywordflow">else</span> {
00442         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00443     }
00444     UNREFERENCED_PARAMETER(ContextRecord);
00445 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="i386/kdtrap.c::KdpCheckTracePoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpCheckTracePoint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="i386/kdtrap.c::KdpCopyDataToStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUCHAR KdpCopyDataToStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUCHAR&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="i386/kdtrap.c::KdpStub" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpStub           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/i386_2kdtrap_8c-source.html#l00462">462</a> of file <a class="el" href="../../d9/d7/i386_2kdtrap_8c-source.html">i386/kdtrap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a3">KdpCheckTracePoint()</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00066">KdPitchDebugger</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00473                    :
00474 
00475     This routine provides a kernel debugger stub routine to <span class="keywordflow">catch</span> debug
00476     prints in a checked system when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not active.
00477 
00478 Arguments:
00479 
00480     TrapFrame - Supplies a pointer to a trap frame that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00481         trap.
00482 
00483     ExceptionFrame - Supplies a pointer to a exception frame that describes
00484         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap.
00485 
00486     ExceptionRecord - Supplies a pointer to an exception record that
00487         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00488 
00489     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00490 
00491     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00492 
00493     SecondChance - Supplies a <span class="keywordtype">boolean</span> value that determines whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00494         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second chance (TRUE) that the exception has been raised.
00495 
00496 Return Value:
00497 
00498     A value of TRUE is returned if the exception is handled. Otherwise a
00499     value of FALSE is returned.
00500 
00501 --*/
00502 
00503 {
00504     PULONG  SymbolArgs;
00505     <span class="comment">//</span>
00506     <span class="comment">// If the breakpoint is a debug print, then return TRUE. Otherwise,</span>
00507     <span class="comment">// return FALSE.</span>
00508     <span class="comment">//</span>
00509 
00510     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00511         (ExceptionRecord-&gt;NumberParameters &gt; 0) &amp;&amp;
00512         ((ExceptionRecord-&gt;ExceptionInformation[0] == BREAKPOINT_LOAD_SYMBOLS)||
00513          (ExceptionRecord-&gt;ExceptionInformation[0] == BREAKPOINT_UNLOAD_SYMBOLS)||
00514          (ExceptionRecord-&gt;ExceptionInformation[0] == BREAKPOINT_PRINT))) {
00515 
00516         ContextRecord-&gt;Eip++;
00517         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00518     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00519         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00520     } <span class="keywordflow">else</span> {
00521         <span class="keywordflow">return</span>(<a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a3">KdpCheckTracePoint</a>(ExceptionRecord,ContextRecord));
00522     }
00523 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="i386/kdtrap.c::KdpTrap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpTrap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/i386_2kdtrap_8c-source.html#l00038">38</a> of file <a class="el" href="../../d9/d7/i386_2kdtrap_8c-source.html">i386/kdtrap.c</a>.
<p>
References <a class="el" href="../../d9/d2/ia32def_8h-source.html#l00051">BREAKPOINT_BREAK</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00133">KdDebuggerNotPresent</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00277">KdEnterDebugger()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00355">KdExitDebugger()</a>, <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00414">KdLogDbgPrint()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00261">KdpControlCPressed</a>, <a class="el" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a0">KdpCopyDataToStack()</a>, <a class="el" href="../../d1/d5/kddbgio_8c-source.html#l00030">KdpPrintString()</a>, <a class="el" href="../../d1/d5/kddbgio_8c-source.html#l00110">KdpPromptString()</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00150">KdpQuickMoveMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02351">KdpReportExceptionStateChange()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02434">KdpReportLoadSymbolsStateChange()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d9/d6/ppc_2ipi_8c.html#a0">KiRestoreProcessorControlState()</a>, <a class="el" href="../../d6/d0/xxmpipi_8c-source.html#l00124">KiSaveProcessorControlState()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dispatched and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel
00052     debugger <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> active.
00053 
00054 Arguments:
00055 
00056     TrapFrame - Supplies a pointer to a trap frame that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00057         trap.
00058 
00059     ExceptionFrame - Supplies a pointer to a exception frame that describes
00060         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap.
00061 
00062     ExceptionRecord - Supplies a pointer to an exception record that
00063         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00064 
00065     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00066 
00067     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00068 
00069     SecondChance - Supplies a <span class="keywordtype">boolean</span> value that determines whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00070         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second chance (TRUE) that the exception has been raised.
00071 
00072 Return Value:
00073 
00074     A value of TRUE is returned if the exception is handled. Otherwise a
00075     value of FALSE is returned.
00076 
00077 --*/
00078 
00079 {
00080 
00081     BOOLEAN Completion = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00082     BOOLEAN Enable;
00083     BOOLEAN UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00084     ULONG   RetValue;
00085     STRING  <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, ReplyString;
00086     PUCHAR  <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00087     <a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a> SymbolInfo;
00088     PVOID   SavedEsp;
00089     PKPRCB  Prcb;
00090     ULONG   OldEip;
00091 
00092     _asm {
00093         <span class="comment">//</span>
00094         <span class="comment">// Save esp on ebp frame so c-runtime registers are restored correctly</span>
00095         <span class="comment">//</span>
00096 
00097         mov     SavedEsp, esp
00098     }
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">// Print, Prompt, Load symbols, Unload symbols, are all special</span>
00102     <span class="comment">// cases of STATUS_BREAKPOINT</span>
00103     <span class="comment">//</span>
00104 
00105     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00106         (ExceptionRecord-&gt;ExceptionInformation[0] != <a class="code" href="../../d8/d3/ia32def_8h.html#a17">BREAKPOINT_BREAK</a>)) {
00107 
00108         <span class="comment">//</span>
00109         <span class="comment">// We have one of the support functions.</span>
00110         <span class="comment">//</span>
00111 
00112         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a>  &amp;&amp;
00113             ExceptionRecord-&gt;ExceptionInformation[0] != BREAKPOINT_PROMPT) {
00114             ContextRecord-&gt;Eip++;
00115             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00116         }
00117 
00118 
00119         <span class="comment">//</span>
00120         <span class="comment">// Since some of these functions can be entered from user mode,</span>
00121         <span class="comment">// we hold off entering the debugger until the user mode buffers</span>
00122         <span class="comment">// are copied.  (Because they may not be present in memory, and</span>
00123         <span class="comment">// they must be paged in before we raise Irql to the</span>
00124         <span class="comment">// Highest level.)</span>
00125         <span class="comment">//</span>
00126         <span class="comment">//</span>
00127 
00128         OldEip = ContextRecord-&gt;Eip;
00129 
00130         <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionInformation[0]) {
00131 
00132             <span class="comment">//</span>
00133             <span class="comment">//  ExceptionInformation[1] is PSTRING to print</span>
00134             <span class="comment">//</span>
00135 
00136             <span class="keywordflow">case</span> BREAKPOINT_PRINT:
00137 
00138                 <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00139 
00140                     EXCEPTION_RECORD exr;
00141                     <span class="comment">//</span>
00142                     <span class="comment">// Move user mode parameters to kernel stack</span>
00143                     <span class="comment">//</span>
00144 
00145                     <span class="keywordflow">try</span> {
00146                         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1]);
00147                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length &gt; 512) {
00148                             <span class="keywordflow">break</span>;
00149                         }
00150                         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length, <span class="keyword">sizeof</span>(UCHAR));
00151                         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer =
00152                             <a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a0">KdpCopyDataToStack</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length);
00153 
00154                     } except ((exr = *((GetExceptionInformation())-&gt;ExceptionRecord), EXCEPTION_EXECUTE_HANDLER)) {
00155 
00156                         <span class="comment">//</span>
00157                         <span class="comment">// If an exception occurs then don't handle</span>
00158                         <span class="comment">// this DebugService request.</span>
00159                         <span class="comment">//</span>
00160 
00161                         <span class="keywordflow">break</span>;
00162                     }
00163 
00164                 } <span class="keywordflow">else</span> {
00165                     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1]);
00166                 }
00167 
00168                 <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(&amp;String);
00169 
00170                 <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_DISABLE_DBGPRINT) == 0) {
00171                     Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00172                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a102">KdpPrintString</a>(&amp;String)) {
00173                         ContextRecord-&gt;Eax = (ULONG)(STATUS_BREAKPOINT);
00174                     } <span class="keywordflow">else</span> {
00175                         ContextRecord-&gt;Eax = STATUS_SUCCESS;
00176                     }
00177                     <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00178                 }
00179 
00180                 Completion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00181                 <span class="keywordflow">break</span>;
00182 
00183             <span class="comment">//</span>
00184             <span class="comment">//  ExceptionInformation[1] is prompt string,</span>
00185             <span class="comment">//  ExceptionInformation[2] is return string</span>
00186             <span class="comment">//</span>
00187 
00188             <span class="keywordflow">case</span> BREAKPOINT_PROMPT:
00189                 <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00190 
00191                     <span class="comment">//</span>
00192                     <span class="comment">// Move user mode parameters to kernel stack</span>
00193                     <span class="comment">//</span>
00194 
00195 
00196                     <span class="keywordflow">try</span> {
00197                         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1]);
00198                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length &gt; 512) {
00199                             <span class="keywordflow">break</span>;
00200                         }
00201                         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length, <span class="keyword">sizeof</span>(CHAR));
00202                         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer =
00203                             <a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a0">KdpCopyDataToStack</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length);
00204 
00205                         ReplyString = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[2]);
00206                         <span class="keywordflow">if</span> (ReplyString.MaximumLength &gt; 512) {
00207                             <span class="keywordflow">break</span>;
00208                         }
00209                         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ReplyString.Buffer,
00210                                       ReplyString.MaximumLength,
00211                                       <span class="keyword">sizeof</span>(CHAR));
00212                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = ReplyString.Buffer;
00213                         ReplyString.Buffer =
00214                             <a class="code" href="../../d2/d9/4_2i386_2kdtrap_8c.html#a0">KdpCopyDataToStack</a>(
00215                                 ReplyString.Buffer,
00216                                 ReplyString.MaximumLength
00217                             );
00218 
00219                     } except (EXCEPTION_EXECUTE_HANDLER) {
00220 
00221                         <span class="comment">//</span>
00222                         <span class="comment">// If an exception occurs then don't handle</span>
00223                         <span class="comment">// this DebugService request.</span>
00224                         <span class="comment">//</span>
00225 
00226                         <span class="keywordflow">break</span>;
00227                     }
00228                 } <span class="keywordflow">else</span> {
00229                     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1]);
00230                     ReplyString = *((PSTRING)ExceptionRecord-&gt;ExceptionInformation[2]);
00231                 }
00232 
00233                 <span class="comment">//</span>
00234                 <span class="comment">// Prompt, keep prompting until no breakin seen.</span>
00235                 <span class="comment">//</span>
00236 
00237                 <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(&amp;String);
00238 
00239                 Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00240                 <span class="keywordflow">do</span> {
00241                     RetValue = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a103">KdpPromptString</a>(&amp;String, &amp;ReplyString);
00242                 } <span class="keywordflow">while</span> (RetValue == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00243 
00244                 ContextRecord-&gt;Eax = ReplyString.Length;
00245                 <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00246 
00247                 <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00248 
00249                     <span class="comment">//</span>
00250                     <span class="comment">// Restore user mode return parameters</span>
00251                     <span class="comment">//</span>
00252 
00253                     <span class="keywordflow">try</span> {
00254                         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>(
00255                             Buffer,
00256                             ReplyString.Buffer,
00257                             ReplyString.Length
00258                         );
00259                     } except (EXCEPTION_EXECUTE_HANDLER) {
00260 
00261                         <span class="comment">//</span>
00262                         <span class="comment">// If an exception occurs then don't handle</span>
00263                         <span class="comment">// this DebugService request.</span>
00264                         <span class="comment">//</span>
00265 
00266                         <span class="keywordflow">break</span>;
00267                     }
00268                 }
00269 
00270                 Completion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00271                 <span class="keywordflow">break</span>;
00272 
00273             <span class="comment">//</span>
00274             <span class="comment">//  ExceptionInformation[1] is file name of new module</span>
00275             <span class="comment">//  ExceptionInformaiton[2] is the base of the dll</span>
00276             <span class="comment">//</span>
00277 
00278             <span class="keywordflow">case</span> BREAKPOINT_UNLOAD_SYMBOLS:
00279                 UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00280 
00281                 <span class="comment">//</span>
00282                 <span class="comment">// Fall through</span>
00283                 <span class="comment">//</span>
00284 
00285             <span class="keywordflow">case</span> BREAKPOINT_LOAD_SYMBOLS:
00286 
00287                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00288                     <span class="keywordflow">break</span>;
00289                 }
00290 
00291                 Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00292 
00293                 <span class="comment">//</span>
00294                 <span class="comment">// Save and restore the processor context in case the</span>
00295                 <span class="comment">// kernel debugger has been configured to stop on dll</span>
00296                 <span class="comment">// loads.</span>
00297                 <span class="comment">//</span>
00298 
00299                 Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00300                 <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00301                 RtlCopyMemory(&amp;Prcb-&gt;ProcessorState.ContextFrame,
00302                               ContextRecord,
00303                               <span class="keyword">sizeof</span>(CONTEXT));
00304 
00305                 SymbolInfo = (<a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a>)ExceptionRecord-&gt;ExceptionInformation[2];
00306                 Completion =
00307                     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a121">KdpReportLoadSymbolsStateChange</a>((PSTRING)ExceptionRecord-&gt;ExceptionInformation[1],
00308                                                     SymbolInfo,
00309                                                     UnloadSymbols,
00310                                                     &amp;Prcb-&gt;ProcessorState.ContextFrame);
00311 
00312                 RtlCopyMemory(ContextRecord,
00313                               &amp;Prcb-&gt;ProcessorState.ContextFrame,
00314                               sizeof (CONTEXT) );
00315 
00316                 <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a0">KiRestoreProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00317 
00318                 <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00319                 <span class="keywordflow">break</span>;
00320 
00321             <span class="comment">//</span>
00322             <span class="comment">//  Unknown command</span>
00323             <span class="comment">//</span>
00324 
00325             <span class="keywordflow">default</span>:
00326                 <span class="comment">// return FALSE</span>
00327                 <span class="keywordflow">break</span>;
00328         }
00329         <span class="comment">//</span>
00330         <span class="comment">// If the kernel debugger did not update the EIP, then increment</span>
00331         <span class="comment">// past the breakpoint instruction.</span>
00332         <span class="comment">//</span>
00333 
00334         <span class="keywordflow">if</span> (ContextRecord-&gt;Eip == OldEip) {
00335             ContextRecord-&gt;Eip++;
00336         }
00337 
00338 
00339     } <span class="keywordflow">else</span> {
00340 
00341         <span class="keywordflow">if</span>  ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) ||
00342              (ExceptionRecord-&gt;ExceptionCode == STATUS_SINGLE_STEP)  ||
00343              (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_STOP_ON_EXCEPTION) ||
00344              SecondChance) {
00345 
00346             <span class="keywordflow">if</span> (!SecondChance &amp;&amp;
00347                 (ExceptionRecord-&gt;ExceptionCode == STATUS_PORT_DISCONNECTED ||
00348                  <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( ExceptionRecord-&gt;ExceptionCode )
00349                 )
00350                ) {
00351                 <span class="comment">//</span>
00352                 <span class="comment">// User does not really want to see these either.</span>
00353                 <span class="comment">// so do NOT report it to debugger.</span>
00354                 <span class="comment">//</span>
00355 
00356                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00357                 }
00358 
00359             <span class="comment">//</span>
00360             <span class="comment">// Report state change to kernel debugger on host</span>
00361             <span class="comment">//</span>
00362 
00363 
00364             Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00365             Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00366             <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a1">KiSaveProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00367             RtlCopyMemory(&amp;Prcb-&gt;ProcessorState.ContextFrame,
00368                           ContextRecord,
00369                           sizeof (CONTEXT));
00370 
00371             Completion =
00372                 <a class="code" href="../../d1/d7/4_2kdp_8h.html#a120">KdpReportExceptionStateChange</a>(ExceptionRecord,
00373                                               &amp;Prcb-&gt;ProcessorState.ContextFrame,
00374                                               SecondChance);
00375 
00376             RtlCopyMemory(ContextRecord,
00377                           &amp;Prcb-&gt;ProcessorState.ContextFrame,
00378                           <span class="keyword">sizeof</span>(CONTEXT));
00379 
00380             <a class="code" href="../../d9/d6/ppc_2ipi_8c.html#a0">KiRestoreProcessorControlState</a>(&amp;Prcb-&gt;ProcessorState);
00381             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00382 
00383             <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00384 
00385         } <span class="keywordflow">else</span> {
00386 
00387             <span class="comment">//</span>
00388             <span class="comment">// This is real exception that user doesn't want to see,</span>
00389             <span class="comment">// so do NOT report it to debugger.</span>
00390             <span class="comment">//</span>
00391 
00392             <span class="comment">// return FALSE;</span>
00393         }
00394     }
00395 
00396     _asm {
00397         mov     esp, SavedEsp
00398     }
00399     <span class="keywordflow">return</span> Completion;
00400 
00401     UNREFERENCED_PARAMETER(PreviousMode);
00402 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="i386/kdtrap.c::SaveSymLoad" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SaveSymLoad           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>PathName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseOfDll</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UnloadSymbols</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
