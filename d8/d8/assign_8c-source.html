<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: assign.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>assign.c</h1><a href="../../d7/d9/assign_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    assign.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    IoAssignResources</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Ken Reneris</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment">    EDIT IN 110 COLUMN MODE</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Add PnP support - shielint</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00027 
<a name="l00028"></a><a class="code" href="../../d7/d9/assign_8c.html#a0">00028</a> <span class="preprocessor">#define IDBG    DBG</span>
<a name="l00029"></a><a class="code" href="../../d7/d9/assign_8c.html#a1">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGED   1</span>
<a name="l00030"></a><a class="code" href="../../d7/d9/assign_8c.html#a2">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define INLINE  __inline</span>
<a name="l00031"></a><a class="code" href="../../d7/d9/assign_8c.html#a3">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define STATIC  static</span>
00032 <span class="preprocessor"></span>
00033 <span class="comment">//#define IDBG    1</span>
00034 <span class="comment">//#define DBG     1</span>
00035 <span class="comment">//#define PAGED</span>
00036 <span class="comment">//#define INLINE</span>
00037 <span class="comment">//#define STATIC</span>
00038 
00039 
00040 <span class="comment">/*</span>
00041 <span class="comment"> *  IDBG    - Internal debugging.  Turn on for runtime DbgPrints of calls to IoAssignResources</span>
00042 <span class="comment"> *  PAGED   - Declare functions as pageable or not.  (usefull for debugging)</span>
00043 <span class="comment"> *  INLINE  - Inline functions</span>
00044 <span class="comment"> *  STATIC  - internal functions to this module which are static</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> */</span>
00047 
00048 
<a name="l00049"></a><a class="code" href="../../d7/d9/assign_8c.html#a21">00049</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a21">IopWstrOtherDrivers</a>[];
<a name="l00050"></a><a class="code" href="../../d7/d9/assign_8c.html#a22">00050</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a22">IopWstrAssignedResources</a>[];
<a name="l00051"></a><a class="code" href="../../d7/d9/assign_8c.html#a23">00051</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a23">IopWstrRequestedResources</a>[];
<a name="l00052"></a><a class="code" href="../../d7/d9/assign_8c.html#a24">00052</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a24">IopWstrSystemResources</a>[];
<a name="l00053"></a><a class="code" href="../../d7/d9/assign_8c.html#a25">00053</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a25">IopWstrReservedResources</a>[];
<a name="l00054"></a><a class="code" href="../../d7/d9/assign_8c.html#a26">00054</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a26">IopWstrAssignmentOrdering</a>[];
<a name="l00055"></a><a class="code" href="../../d7/d9/assign_8c.html#a27">00055</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a27">IopWstrBusValues</a>[];
<a name="l00056"></a><a class="code" href="../../d7/d9/assign_8c.html#a28">00056</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a28">IopWstrTranslated</a>[];
<a name="l00057"></a><a class="code" href="../../d7/d9/assign_8c.html#a29">00057</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a29">IopWstrBusTranslated</a>[];
00058 
<a name="l00059"></a><a class="code" href="../../d7/d9/assign_8c.html#a4">00059</a> <span class="preprocessor">#define HRESOURCE_MAP           0</span>
<a name="l00060"></a><a class="code" href="../../d7/d9/assign_8c.html#a5">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define HDEVICE_STORAGE         1</span>
<a name="l00061"></a><a class="code" href="../../d7/d9/assign_8c.html#a6">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define HCURRENT_CONTROL_SET    2</span>
<a name="l00062"></a><a class="code" href="../../d7/d9/assign_8c.html#a7">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define HSYSTEMRESOURCES        3</span>
<a name="l00063"></a><a class="code" href="../../d7/d9/assign_8c.html#a8">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define HORDERING               4</span>
<a name="l00064"></a><a class="code" href="../../d7/d9/assign_8c.html#a9">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define HRESERVEDRESOURCES      5</span>
<a name="l00065"></a><a class="code" href="../../d7/d9/assign_8c.html#a10">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define HBUSVALUES              6</span>
<a name="l00066"></a><a class="code" href="../../d7/d9/assign_8c.html#a11">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define HOWNER_MAP              7</span>
<a name="l00067"></a><a class="code" href="../../d7/d9/assign_8c.html#a12">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_REG_HANDLES         8</span>
00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="../../d7/d9/assign_8c.html#a13">00069</a> <span class="preprocessor">#define INVALID_HANDLE      (HANDLE) -1</span>
00070 <span class="preprocessor"></span>
<a name="l00071"></a><a class="code" href="../../d7/d9/assign_8c.html#a14">00071</a> <span class="preprocessor">#define BUFFERSIZE              (2048 + sizeof( KEY_FULL_INFORMATION ))</span>
<a name="l00072"></a><a class="code" href="../../d7/d9/assign_8c.html#a15">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_ENTRIES             50</span>
<a name="l00073"></a><a class="code" href="../../d7/d9/assign_8c.html#a16">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define SCONFLICT               5</span>
00074 <span class="preprocessor"></span>
00075 <span class="comment">//</span>
00076 <span class="comment">// Wrapper structures around IO_RESOURCE lists</span>
00077 <span class="comment">//</span>
00078 
00079 <span class="comment">// owner of TENTRY</span>
<a name="l00080"></a><a class="code" href="../../d9/d5/structPOWNER.html">00080</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span>{
<a name="l00081"></a><a class="code" href="../../d9/d5/structPOWNER.html#o0">00081</a>     LIST_ENTRY                  InConflict;
<a name="l00082"></a><a class="code" href="../../d9/d5/structPOWNER.html#o1">00082</a>     UNICODE_STRING              <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
<a name="l00083"></a><a class="code" href="../../d9/d5/structPOWNER.html#o2">00083</a>     UNICODE_STRING              DeviceName;
<a name="l00084"></a><a class="code" href="../../d9/d5/structPOWNER.html#o3">00084</a>     WCHAR                       UnicodeBuffer[1];           <span class="comment">// Must be last!</span>
00085 } *<a class="code" href="../../d9/d5/structPOWNER.html">POWNER</a>;
00086 
00087 <span class="comment">// translated entry</span>
<a name="l00088"></a><a class="code" href="../../d4/d0/structTENTRY.html">00088</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span>{
<a name="l00089"></a><a class="code" href="../../d4/d0/structTENTRY.html#o0">00089</a>     LONGLONG                    BAddr;                      <span class="comment">// Beginning address</span>
<a name="l00090"></a><a class="code" href="../../d4/d0/structTENTRY.html#o1">00090</a>     LONGLONG                    EAddr;                      <span class="comment">// Ending address</span>
<a name="l00091"></a><a class="code" href="../../d4/d0/structTENTRY.html#o2">00091</a>     KAFFINITY                   Affinity;                   <span class="comment">// Processor affinity of resource</span>
<a name="l00092"></a><a class="code" href="../../d4/d0/structTENTRY.html#o3">00092</a>     <a class="code" href="../../d9/d5/structPOWNER.html">POWNER</a>                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;                      <span class="comment">// Owner of this resource</span>
00093 <span class="preprocessor">#if IDBG</span>
00094 <span class="preprocessor"></span>    ULONG                       na[2];
00095 <span class="preprocessor">#endif</span>
00096 <span class="preprocessor"></span>} <a class="code" href="../../d4/d0/structTENTRY.html">TENTRY</a>, *<a class="code" href="../../d7/d9/assign_8c.html#a30">PTENTRY</a>;                                         <span class="comment">// Translated resource</span>
00097 
<a name="l00098"></a><a class="code" href="../../d7/d9/assign_8c.html#a17">00098</a> <span class="preprocessor">#define DoesTEntryCollide(a,b)                                         \</span>
00099 <span class="preprocessor">  ( (a).EAddr &gt;= (b).BAddr &amp;&amp; (a).BAddr &lt;= (b).EAddr &amp;&amp; ((a).Affinity &amp; (b).Affinity) )</span>
00100 <span class="preprocessor"></span>
00101 
00102 <span class="comment">// list of translated entries</span>
<a name="l00103"></a><a class="code" href="../../d7/d5/struct__LTENTRY.html">00103</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span><a class="code" href="../../d7/d5/struct__LTENTRY.html">_LTENTRY</a> {
<a name="l00104"></a><a class="code" href="../../d7/d5/struct__LTENTRY.html#o0">00104</a>     <span class="keyword">struct </span><a class="code" href="../../d7/d5/struct__LTENTRY.html">_LTENTRY</a>             *<a class="code" href="../../d7/d5/struct__LTENTRY.html#o0">Next</a>;                      <span class="comment">// Allocated table size</span>
<a name="l00105"></a><a class="code" href="../../d7/d5/struct__LTENTRY.html#o1">00105</a>     ULONG                       <a class="code" href="../../d7/d5/struct__LTENTRY.html#o1">CurEntries</a>;                 <span class="comment">// No entries in table</span>
<a name="l00106"></a><a class="code" href="../../d7/d5/struct__LTENTRY.html#o2">00106</a>     ULONG                       <a class="code" href="../../d7/d5/struct__LTENTRY.html#o2">na</a>[2];
<a name="l00107"></a><a class="code" href="../../d7/d5/struct__LTENTRY.html#o3">00107</a>     <a class="code" href="../../d4/d0/structTENTRY.html">TENTRY</a>                      <a class="code" href="../../d7/d5/struct__LTENTRY.html#o3">Table</a>[<a class="code" href="../../d7/d9/assign_8c.html#a15">MAX_ENTRIES</a>];
00108 } <a class="code" href="../../d7/d5/struct__LTENTRY.html">LTENTRY</a>, *<a class="code" href="../../d7/d5/struct__LTENTRY.html">PLTENTRY</a>;                                       <span class="comment">// List of translated resources</span>
00109 
00110 <span class="comment">// list of translated entries by CmResourceType</span>
<a name="l00111"></a><a class="code" href="../../d3/d0/structTENTRIESBYTYPE.html">00111</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span>{
<a name="l00112"></a><a class="code" href="../../d3/d0/structTENTRIESBYTYPE.html#o0">00112</a>     <a class="code" href="../../d7/d9/assign_8c.html#a32">PLTENTRY</a>                    ByType[CmResourceTypeMaximum];
00113 } <a class="code" href="../../d3/d0/structTENTRIESBYTYPE.html">TENTRIESBYTYPE</a>, *<a class="code" href="../../d7/d9/assign_8c.html#a33">PTENTRIESBYTYPE</a>;
00114 
00115 <span class="comment">// information about conflict</span>
<a name="l00116"></a><a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html">00116</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span>{
<a name="l00117"></a><a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o0">00117</a>     ULONG                       NoConflicts;                <span class="comment">// # of BAddrs</span>
00118     <span class="keyword">struct </span>{
<a name="l00119"></a><a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o1">00119</a>         UCHAR                   Type;
<a name="l00120"></a><a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o2">00120</a>         LONGLONG                BAddr;
<a name="l00121"></a><a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o3">00121</a>         <a class="code" href="../../d9/d5/structPOWNER.html">POWNER</a>                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00122     } EasyConflict[<a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>];
00123 
<a name="l00124"></a><a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o5">00124</a>     LIST_ENTRY                  OtherConflicts;
00125 } <a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html">IO_TRACK_CONFLICT</a>, *<a class="code" href="../../d7/d9/assign_8c.html#a34">PIO_TRACK_CONFLICT</a>;
00126 
00127 <span class="comment">// a required resource with it's alternatives</span>
<a name="l00128"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html">00128</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span>{
00129     <span class="comment">// work in progress...</span>
<a name="l00130"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o0">00130</a>     ULONG                       CurLoc;                     <span class="comment">// Which IoResourceDescriptor</span>
<a name="l00131"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o1">00131</a>     ULONG                       RunLen;                     <span class="comment">// length of alternative run</span>
<a name="l00132"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o2">00132</a>     ULONG                       PassNo;
00133 
00134     <span class="comment">// current bus specific ordering location</span>
<a name="l00135"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o3">00135</a>     ULONG                       CurBusLoc;                  <span class="comment">// Current Bus descriptor location</span>
<a name="l00136"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o4">00136</a>     LONGLONG                    CurBusMin;                  <span class="comment">// Current bus desc min</span>
<a name="l00137"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o5">00137</a>     LONGLONG                    CurBusMax;                  <span class="comment">// Current bus desc max</span>
00138 
00139     <span class="comment">// raw selection being considered...</span>
<a name="l00140"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o6">00140</a>     UCHAR                       Type;                       <span class="comment">// type of descriptor</span>
<a name="l00141"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o7">00141</a>     ULONG                       CurBLoc;
<a name="l00142"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o8">00142</a>     LONGLONG                    CurBAddr;                   <span class="comment">// bus native BAddr</span>
00143 
00144     <span class="comment">// the raw selection's translation</span>
<a name="l00145"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o9">00145</a>     UCHAR                       TType;                      <span class="comment">// Translated type</span>
<a name="l00146"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o10">00146</a>     <a class="code" href="../../d4/d0/structTENTRY.html">TENTRY</a>                      Trans;                      <span class="comment">// Translated info</span>
00147 
<a name="l00148"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o11">00148</a>     LONG                        BestPref;                   <span class="comment">// only has meaning on first pass</span>
<a name="l00149"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o12">00149</a>     LONG                        CurPref;                    <span class="comment">// Prefernce of current selection</span>
00150 
00151     <span class="comment">// Phase 3</span>
<a name="l00152"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o13">00152</a>     ULONG                       PrefCnt;                    <span class="comment">// # of times this level skipped</span>
<a name="l00153"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o14">00153</a>     ULONG                       Pass2HoldCurLoc;            <span class="comment">// CurBLoc of best selection so far</span>
<a name="l00154"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o15">00154</a>     LONGLONG                    Pass2HoldBAddr;             <span class="comment">// CurBAddr of best selection so far</span>
00155 
00156     <span class="comment">// resource options</span>
<a name="l00157"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o16">00157</a>     ULONG                       NoAlternatives;             <span class="comment">// entries in IoResourceDescriptor</span>
<a name="l00158"></a><a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html#o17">00158</a>     PIO_RESOURCE_DESCRIPTOR     IoResourceDescriptor[1];    <span class="comment">// MUST BE LAST ENTRY</span>
00159 } <a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html">DIR_REQUIRED_RESOURCE</a>, *<a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>;
00160 
00161 <span class="comment">// a list of required resources for the alternative list</span>
<a name="l00162"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html">00162</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html">_DIR_RESOURCE_LIST</a> {
<a name="l00163"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">00163</a>     <span class="keyword">struct </span><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html">_DIR_RESOURCE_LIST</a>   *<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">Next</a>;                      <span class="comment">// next alternative list</span>
<a name="l00164"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o1">00164</a>     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>      <a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o1">ResourceByType</a>[CmResourceTypeMaximum];  <span class="comment">// catagorized list</span>
<a name="l00165"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o2">00165</a>     LONG                        <a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o2">CurPref</a>;
<a name="l00166"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o3">00166</a>     ULONG                       <a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o3">LastLevel</a>;                  <span class="comment">// last level tried</span>
<a name="l00167"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o4">00167</a>     ULONG                       <a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o4">FailedLevel</a>;                <span class="comment">// which level had conflict</span>
<a name="l00168"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">00168</a>     <a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html">IO_TRACK_CONFLICT</a>           <a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>;                   <span class="comment">// pass3</span>
<a name="l00169"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o6">00169</a>     PIO_RESOURCE_LIST           <a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o6">IoResourceList</a>;             <span class="comment">// this IO_RESOURCE_LIST</span>
<a name="l00170"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">00170</a>     ULONG                       <a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>;        <span class="comment">// entries in RequiredResource</span>
<a name="l00171"></a><a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">00171</a>     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>      <a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[1];        <span class="comment">// MUST BE LAST ENTRY</span>
00172 } <a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html">DIR_RESOURCE_LIST</a>, *<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html">PDIR_RESOURCE_LIST</a>;
00173 
00174 <span class="comment">// top level structure</span>
<a name="l00175"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html">00175</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html">_DIR_RESREQ_LIST</a> {
<a name="l00176"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o0">00176</a>     HANDLE                      <a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o0">RegHandle</a>[<a class="code" href="../../d7/d9/assign_8c.html#a12">MAX_REG_HANDLES</a>]; <span class="comment">// handles to different registry locations</span>
<a name="l00177"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o1">00177</a>     <span class="keyword">struct </span><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html">_DIR_RESREQ_LIST</a>     *<a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o1">UserDir</a>;
<a name="l00178"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o2">00178</a>     <span class="keyword">struct </span><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html">_DIR_RESREQ_LIST</a>     *<a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o2">BusDir</a>;
<a name="l00179"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o3">00179</a>     <span class="keyword">struct </span><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html">_DIR_RESREQ_LIST</a>     *<a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o3">FreeResReqList</a>;            <span class="comment">// other DIR_RESREQ_LIST which need freed</span>
<a name="l00180"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o4">00180</a>     SINGLE_LIST_ENTRY           <a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o4">AllocatedHeap</a>;              <span class="comment">// heap which needs freed</span>
<a name="l00181"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o5">00181</a>     <a class="code" href="../../d3/d0/structTENTRIESBYTYPE.html">TENTRIESBYTYPE</a>              <a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o5">InUseResources</a>;
<a name="l00182"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o6">00182</a>     <a class="code" href="../../d3/d0/structTENTRIESBYTYPE.html">TENTRIESBYTYPE</a>              <a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o6">InUseSharableResources</a>;
<a name="l00183"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o7">00183</a>     <a class="code" href="../../d3/d0/structTENTRIESBYTYPE.html">TENTRIESBYTYPE</a>              <a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o7">ReservedSharableResources</a>;
<a name="l00184"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o8">00184</a>     PIO_RESOURCE_REQUIREMENTS_LIST  <a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o8">IoResourceReq</a>;          <span class="comment">// this IO_RESOURCES_REQUIREMENTS_LIST</span>
<a name="l00185"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o9">00185</a>     <a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>          <a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o9">Alternative</a>;                <span class="comment">// list of alternatives</span>
<a name="l00186"></a><a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o10">00186</a>     PWCHAR                      <a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o10">Buffer</a>;                     <span class="comment">// Scratch memory</span>
00187 } <a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html">DIR_RESREQ_LIST</a>, *<a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html">PDIR_RESREQ_LIST</a>;
00188 
00189 <span class="comment">// a list of heap which was allocated</span>
<a name="l00190"></a><a class="code" href="../../d9/d1/structUSED__HEAP.html">00190</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00191"></a><a class="code" href="../../d9/d1/structUSED__HEAP.html#o0">00191</a>     SINGLE_LIST_ENTRY               FreeLink;               <span class="comment">// List of heap to free</span>
<a name="l00192"></a><a class="code" href="../../d9/d1/structUSED__HEAP.html#o1">00192</a>     PVOID                           FreeHeap;               <span class="comment">// pointer to heap to free</span>
00193 } <a class="code" href="../../d9/d1/structUSED__HEAP.html">USED_HEAP</a>, *<a class="code" href="../../d7/d9/assign_8c.html#a40">PUSED_HEAP</a>;
00194 
00195 <span class="comment">//</span>
00196 <span class="comment">// Internal prototypes</span>
00197 <span class="comment">//</span>
00198 
00199 PIO_RESOURCE_REQUIREMENTS_LIST
00200 <a class="code" href="../../d7/d9/assign_8c.html#a41">IopGetResourceReqRegistryValue</a> (
00201     IN PDIR_RESREQ_LIST     Dir,
00202     IN HANDLE               KeyHandle,
00203     IN PWSTR                ValueName
00204     );
00205 
00206 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00207 <a class="code" href="../../d7/d9/assign_8c.html#a42">IopAssignResourcesPhase1</a> (
00208     IN PIO_RESOURCE_REQUIREMENTS_LIST   IoResources,
00209     IN PIO_RESOURCE_REQUIREMENTS_LIST   *CopiedList
00210     );
00211 
00212 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00213 <a class="code" href="../../d7/d9/assign_8c.html#a43">IopAssignResourcesPhase2</a> (
00214     IN PDIR_RESREQ_LIST     Dir,
00215     IN PUNICODE_STRING      DriverClassName,
00216     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>       DriverObject,
00217     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>       DeviceObject
00218     );
00219 
00220 <a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>
00221 <a class="code" href="../../d7/d9/assign_8c.html#a44">IopAssignResourcesPhase3</a> (
00222     IN PDIR_RESREQ_LIST     Dir
00223     );
00224 
00225 PCM_RESOURCE_LIST
00226 <a class="code" href="../../d7/d9/assign_8c.html#a45">IopAssignResourcesPhase4</a> (
00227     IN PDIR_RESREQ_LIST     Dir,
00228     IN PDIR_RESOURCE_LIST   CurList,
00229     OUT PULONG              Length
00230     );
00231 
00232 <a class="code" href="../../d7/d9/assign_8c.html#a3">STATIC</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00233 <a class="code" href="../../d7/d9/assign_8c.html#a46">IopLogConflict</a> (
00234     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>       DriverObject,
00235     IN PDIR_RESREQ_LIST     Dir,
00236     IN NTSTATUS             FinalStatus
00237     );
00238 
00239 <a class="code" href="../../d7/d9/assign_8c.html#a3">STATIC</a> PVOID
00240 <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (
00241     IN PDIR_RESREQ_LIST     Dir,
00242     IN ULONG                Length
00243     );
00244 
00245 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a> <a class="code" href="../../d7/d9/assign_8c.html#a30">PTENTRY</a>
00246 <a class="code" href="../../d7/d9/assign_8c.html#a48">IopNewTransEntry</a> (
00247     IN PDIR_RESREQ_LIST Dir,
00248     IN PTENTRIESBYTYPE  pTypes,
00249     IN ULONG            Type
00250     );
00251 
00252 <a class="code" href="../../d7/d9/assign_8c.html#a3">STATIC</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00253 <a class="code" href="../../d7/d9/assign_8c.html#a49">IopAddCmDescriptorToInUseList</a> (
00254     IN PDIR_RESREQ_LIST                Dir,
00255     IN PTENTRIESBYTYPE                 pTypes,
00256     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR CmDesc,
00257     IN <a class="code" href="../../d9/d5/structPOWNER.html">POWNER</a>                          Owner
00258     );
00259 
00260 ULONG
00261 <a class="code" href="../../d7/d9/assign_8c.html#a50">IopFindCollisionInTList</a> (
00262     IN PTENTRY SEntry,
00263     IN PLTENTRY List
00264     );
00265 
00266 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00267 <a class="code" href="../../d7/d9/assign_8c.html#a51">IopPickupCollisionInTList</a> (
00268     IN PDIR_RESOURCE_LIST   CurList,
00269     IN UCHAR                Type,
00270     IN LONGLONG             BAddr,
00271     IN PTENTRY              SEntry,
00272     IN PLTENTRY             List
00273     );
00274 
00275 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00276 <a class="code" href="../../d7/d9/assign_8c.html#a52">IopBuildResourceDir</a> (
00277     IN PDIR_RESREQ_LIST                 ParentDir,
00278     IN PDIR_RESREQ_LIST                 *DirResourceList,
00279     IN PIO_RESOURCE_REQUIREMENTS_LIST   IoResources
00280     );
00281 
00282 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00283 <a class="code" href="../../d7/d9/assign_8c.html#a53">IopFreeResourceDir</a> (
00284     IN PDIR_RESREQ_LIST  DirResourceList
00285     );
00286 
00287 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00288 <a class="code" href="../../d7/d9/assign_8c.html#a54">IopSortDescriptors</a> (
00289     IN OUT PDIR_RESREQ_LIST Dir
00290     );
00291 
00292 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00293 <a class="code" href="../../d7/d9/assign_8c.html#a55">IopCatagorizeDescriptors</a> (
00294     IN OUT PDIR_RESREQ_LIST Dir
00295     );
00296 
00297 ULONG
00298 <a class="code" href="../../d7/d9/assign_8c.html#a56">IopDescriptorSortingWeight</a> (
00299     IN PIO_RESOURCE_DESCRIPTOR Descriptor
00300     );
00301 
00302 BOOLEAN
00303 <a class="code" href="../../d7/d9/assign_8c.html#a57">IopGenNextValidResourceList</a> (
00304     IN ULONG                level,
00305     IN PDIR_RESOURCE_LIST   CurList,
00306     IN PDIR_RESREQ_LIST     Dir
00307     );
00308 
00309 BOOLEAN
00310 <a class="code" href="../../d7/d9/assign_8c.html#a58">IopGenNextValidDescriptor</a> (
00311     IN ULONG                level,
00312     IN PDIR_RESOURCE_LIST   CurList,
00313     IN PDIR_RESREQ_LIST     Dir,
00314     IN PULONG               collisionlevel
00315     );
00316 
00317 BOOLEAN
00318 <a class="code" href="../../d7/d9/assign_8c.html#a59">IopSlotResourceOwner</a> (
00319     IN PDIR_RESREQ_LIST Dir,
00320     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00321     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
00322     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResources,
00323     IN BOOLEAN  AddOwner
00324     );
00325 
00326 <span class="preprocessor">#if IDBG</span>
00327 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00328 IopDumpIoResourceDir (
00329     IN PDIR_RESREQ_LIST Dir
00330     );
00331 
00332 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00333 IopDumpIoResourceDescriptor (
00334     IN PUCHAR                   Indent,
00335     IN PIO_RESOURCE_DESCRIPTOR  Desc
00336     );
00337 <span class="preprocessor">#endif</span>
00338 <span class="preprocessor"></span>
00339 <span class="preprocessor">#if DBG</span>
00340 <span class="preprocessor"></span><span class="preprocessor">#define CHECK_STATUS(a,b) { if(!NT_SUCCESS(a)) { DebugString = b; goto Exit; } }</span>
00341 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00342"></a><a class="code" href="../../d7/d9/assign_8c.html#a18">00342</a> <span class="preprocessor"></span><span class="preprocessor">#define CHECK_STATUS(a,b) { if(!NT_SUCCESS(a)) goto Exit; }</span>
00343 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00344 <span class="preprocessor"></span>
00345 <span class="preprocessor">#if DBG</span>
00346 <span class="preprocessor"></span><span class="preprocessor">#define DBGMSG(a)   DbgPrint(a)</span>
00347 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00348"></a><a class="code" href="../../d7/d9/assign_8c.html#a19">00348</a> <span class="preprocessor"></span><span class="preprocessor">#define DBGMSG(a)</span>
00349 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00350 <span class="preprocessor"></span>
00351 <span class="preprocessor">#if IDBG</span>
00352 <span class="preprocessor"></span><span class="preprocessor">#define IDBGMSG(a)   DbgPrint(a)</span>
00353 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00354"></a><a class="code" href="../../d7/d9/assign_8c.html#a20">00354</a> <span class="preprocessor"></span><span class="preprocessor">#define IDBGMSG(a)</span>
00355 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00356 <span class="preprocessor"></span>
00357 <span class="preprocessor">#ifdef PAGED</span>
00358 <span class="preprocessor"></span><span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00359 <span class="preprocessor"></span>
00360 <span class="preprocessor">#pragma alloc_text(PAGE,IoAssignResources)</span>
00361 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopAssignResourcesPhase1)</span>
00362 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopAssignResourcesPhase2)</span>
00363 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopAssignResourcesPhase3)</span>
00364 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopAssignResourcesPhase4)</span>
00365 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopLogConflict)</span>
00366 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopGenNextValidResourceList)</span>
00367 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopGenNextValidDescriptor)</span>
00368 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopFindCollisionInTList)</span>
00369 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopPickupCollisionInTList)</span>
00370 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopAllocateDirPool)</span>
00371 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopGetResourceReqRegistryValue)</span>
00372 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopBuildResourceDir)</span>
00373 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopFreeResourceDir)</span>
00374 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopCatagorizeDescriptors)</span>
00375 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopSortDescriptors)</span>
00376 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopAddCmDescriptorToInUseList)</span>
00377 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopSlotResourceOwner)</span>
00378 <span class="preprocessor"></span><span class="preprocessor">#if IDBG</span>
00379 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopDumpIoResourceDir)</span>
00380 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopDumpIoResourceDescriptor)</span>
00381 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00382 <span class="preprocessor"></span>
00383 <span class="preprocessor">#ifndef INLINE</span>
00384 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IO_DESC_MIN)</span>
00385 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IO_DESC_MAX)</span>
00386 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopDescriptorSortingWeight)</span>
00387 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopNewTransEntry)</span>
00388 <span class="preprocessor"></span><span class="preprocessor">#endif  // INLINE</span>
00389 <span class="preprocessor"></span>
00390 <span class="preprocessor">#endif  // ALLOC_PRAGMA</span>
00391 <span class="preprocessor"></span><span class="preprocessor">#endif  // PAGED</span>
00392 <span class="preprocessor"></span>
00393 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00394"></a><a class="code" href="../../d7/d9/assign_8c.html#a60">00394</a> <a class="code" href="../../d7/d9/assign_8c.html#a60">IoAssignResources</a> (
00395     IN PUNICODE_STRING RegistryPath,
00396     IN PUNICODE_STRING DriverClassName OPTIONAL,
00397     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00398     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
00399     IN PIO_RESOURCE_REQUIREMENTS_LIST RequestedResources,
00400     IN OUT PCM_RESOURCE_LIST *pAllocatedResources
00401     )
00402 <span class="comment">/*++</span>
00403 <span class="comment"></span>
00404 <span class="comment">Routine Description:</span>
00405 <span class="comment"></span>
00406 <span class="comment">    This routine takes an input request of RequestedResources, and returned</span>
00407 <span class="comment">    allocated resources in pAllocatedResources.   The allocated resources are</span>
00408 <span class="comment">    automatically recorded in the registry under the ResourceMap for the</span>
00409 <span class="comment">    DriverClassName/DriverObject/DeviceObject requestor.</span>
00410 <span class="comment"></span>
00411 <span class="comment">Arguments:</span>
00412 <span class="comment"></span>
00413 <span class="comment">    RegistryPath</span>
00414 <span class="comment">        For a simple driver, this would be the value passed to the drivers</span>
00415 <span class="comment">        initialization function.  For drivers call IoAssignResources with</span>
00416 <span class="comment">        multiple DeviceObjects are responsible for passing in a unique</span>
00417 <span class="comment">        RegistryPath for each object.</span>
00418 <span class="comment"></span>
00419 <span class="comment">        The registry path is checked for:</span>
00420 <span class="comment">            RegitryPath:</span>
00421 <span class="comment">                AssignedSystemResources.</span>
00422 <span class="comment"></span>
00423 <span class="comment">        AssignSystemResources is of type REG_RESOURCE_REQUIREMENTS_LIST</span>
00424 <span class="comment"></span>
00425 <span class="comment">        If present, IoAssignResources will attempt to use these settings to</span>
00426 <span class="comment">        satisify the requested resources.  If the listed settings do</span>
00427 <span class="comment">        not conform to the resource requirements, then IoAssignResources</span>
00428 <span class="comment">        will fail.</span>
00429 <span class="comment"></span>
00430 <span class="comment">        Note: IoAssignResources may store other internal binary information</span>
00431 <span class="comment">        in the supplied RegisteryPath.</span>
00432 <span class="comment"></span>
00433 <span class="comment">    DriverObject:</span>
00434 <span class="comment">        The driver object of the caller.</span>
00435 <span class="comment"></span>
00436 <span class="comment">    DeviceObject:</span>
00437 <span class="comment">        If non-null, then requested resoruce list refers to this device.</span>
00438 <span class="comment">        If null, the requested resource list refers to the driver.</span>
00439 <span class="comment"></span>
00440 <span class="comment">    DriverClassName</span>
00441 <span class="comment">        Used to partition allocated resources into different device classes.</span>
00442 <span class="comment"></span>
00443 <span class="comment">    RequestedResources</span>
00444 <span class="comment">        A list of resources to allocate.</span>
00445 <span class="comment"></span>
00446 <span class="comment">        Allocated resources may be appended or freed by re-invoking</span>
00447 <span class="comment">        IoAssignResources with the same RegistryPath, DriverObject and</span>
00448 <span class="comment">        DeviceObject.  (editing requirements on a resource list by using</span>
00449 <span class="comment">        sucessive calls is not preferred driver behaviour).</span>
00450 <span class="comment"></span>
00451 <span class="comment">    AllocatedResources</span>
00452 <span class="comment">        Returns the allocated resources for the requested resource list.</span>
00453 <span class="comment"></span>
00454 <span class="comment">        Note that the driver is responsible for passing in a pointer to</span>
00455 <span class="comment">        an uninitialized pointer.  IoAssignResources will initialize the</span>
00456 <span class="comment">        pointer to point to the allocated CM_RESOURCE_LIST.  The driver</span>
00457 <span class="comment">        is responisble for returning the memory back to pool when it is</span>
00458 <span class="comment">        done with them structure.</span>
00459 <span class="comment"></span>
00460 <span class="comment">Return Value:</span>
00461 <span class="comment"></span>
00462 <span class="comment">    The status returned is the final completion status of the operation.</span>
00463 <span class="comment"></span>
00464 <span class="comment">--*/</span>
00465 {
00466     <span class="keywordflow">if</span> (DeviceObject) {
00467 
00468         <span class="keywordflow">if</span> (    DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode &amp;&amp;
00469                 !(((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>)) {
00470 
00471             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PNP_DETECTED_FATAL_ERROR, <a class="code" href="../../d9/d0/pnpiop_8h.html#a48">PNP_ERR_INVALID_PDO</a>, (ULONG_PTR)DeviceObject, 0, 0);
00472 
00473         }
00474 
00475     }
00476 
00477     <span class="keywordflow">if</span> (RequestedResources) {
00478 
00479         <span class="keywordflow">if</span> (RequestedResources-&gt;AlternativeLists == 0 ||
00480             RequestedResources-&gt;List[0].Count == 0) {
00481 
00482             RequestedResources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00483 
00484         }
00485     }
00486 
00487     <span class="keywordflow">if</span> (pAllocatedResources) {
00488 
00489         *pAllocatedResources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00490 
00491     }
00492 
00493     <span class="keywordflow">return</span> <a class="code" href="../../d5/d1/pnpres_8c.html#a107">IopLegacyResourceAllocation</a> (    <a class="code" href="../../d6/d9/pnp_8h.html#a174a128">ArbiterRequestLegacyAssigned</a>,
00494                                             DriverObject,
00495                                             DeviceObject,
00496                                             RequestedResources,
00497                                             pAllocatedResources);
00498 }
00499 <span class="preprocessor">#if 0</span>
00500 <span class="preprocessor"></span>BOOLEAN
00501 <a class="code" href="../../d7/d9/assign_8c.html#a59">IopSlotResourceOwner</a> (
00502     IN PDIR_RESREQ_LIST Dir,
00503     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00504     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
00505     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResources,
00506     IN BOOLEAN  AddOwner
00507     )
00508 {
00509     ULONG                           busflags, len, i;
00510     PWCHAR                          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00511     UNICODE_STRING                  KeyString, ValueString;
00512     POBJECT_NAME_INFORMATION        ObjectName;
00513     PKEY_VALUE_PARTIAL_INFORMATION  PartInf;
00514     BOOLEAN                         Match;
00515     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
00516 
00517     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00518 
00519     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, BUFFERSIZE * 2);
00520     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>) {
00521         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00522     }
00523 
00524     ObjectName = (POBJECT_NAME_INFORMATION) ((PCHAR)<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> + <a class="code" href="../../d7/d9/assign_8c.html#a14">BUFFERSIZE</a>);
00525     Match = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00526 
00527     <span class="comment">//</span>
00528     <span class="comment">// Find bus specific ordering</span>
00529     <span class="comment">//</span>
00530 
00531     status = <a class="code" href="../../d0/d6/iop_8h.html#a194">IopLookupBusStringFromID</a> (
00532                 Dir-&gt;RegHandle[HBUSVALUES],
00533                 IoResources-&gt;InterfaceType,
00534                 KeyName,
00535                 BUFFERSIZE-40,
00536                 &amp;busflags
00537                 );
00538 
00539     <span class="comment">//</span>
00540     <span class="comment">// Does this bus have unique SlotNumber ownership?</span>
00541     <span class="comment">//</span>
00542 
00543     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (busflags &amp; 0x1)) {
00544 
00545         <span class="comment">//</span>
00546         <span class="comment">// Build keyname</span>
00547         <span class="comment">//</span>
00548 
00549         <span class="keywordflow">for</span> (i=0; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>[i]; i++) ;
00550         swprintf (KeyName+i, L<span class="stringliteral">"_%d_%x"</span>, IoResources-&gt;BusNumber, IoResources-&gt;SlotNumber);
00551         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyString, KeyName );
00552 
00553         <span class="comment">//</span>
00554         <span class="comment">// Build valuename</span>
00555         <span class="comment">//</span>
00556 
00557         status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>(
00558                         DeviceObject ? (PVOID) DeviceObject : (PVOID) DriverObject,
00559                         ObjectName,
00560                         BUFFERSIZE,
00561                         &amp;len
00562                     );
00563 
00564         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00565 
00566             <span class="comment">//</span>
00567             <span class="comment">// Look it up</span>
00568             <span class="comment">//</span>
00569 
00570             PartInf = (PKEY_VALUE_PARTIAL_INFORMATION) Dir-&gt;Buffer;
00571             status = ZwQueryValueKey (
00572                         Dir-&gt;RegHandle[HOWNER_MAP],
00573                         &amp;KeyString,
00574                         KeyValuePartialInformation,
00575                         Dir-&gt;Buffer,
00576                         BUFFERSIZE,
00577                         &amp;len
00578                     );
00579 
00580             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00581 
00582                 <span class="comment">//</span>
00583                 <span class="comment">// No owner listed, see if we should add ourselves</span>
00584                 <span class="comment">//</span>
00585 
00586                 <span class="keywordflow">if</span> (AddOwner) {
00587                     <span class="comment">//</span>
00588                     <span class="comment">// Add the key</span>
00589                     <span class="comment">//</span>
00590 
00591                     ZwSetValueKey (
00592                         Dir-&gt;RegHandle[HOWNER_MAP],
00593                         &amp;KeyString,
00594                         0L,
00595                         REG_SZ,
00596                         ObjectName-&gt;Name.Buffer,
00597                         ObjectName-&gt;Name.Length
00598                         );
00599                 }
00600 
00601             } <span class="keywordflow">else</span> {
00602 
00603                 <span class="comment">//</span>
00604                 <span class="comment">// Owner is listed, see if it's us</span>
00605                 <span class="comment">//</span>
00606 
00607                 ValueString.Buffer = (PWCHAR) PartInf-&gt;Data;
00608                 ValueString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) len - (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data);
00609                 ValueString.MaximumLength = ValueString.Length;
00610 
00611                 Match = <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;ObjectName-&gt;Name, &amp;ValueString, TRUE);
00612                 <span class="keywordflow">if</span> (Match  &amp;&amp;  !AddOwner) {
00613 
00614                     <span class="comment">//</span>
00615                     <span class="comment">// Free ownership</span>
00616                     <span class="comment">//</span>
00617 
00618                     ZwDeleteValueKey( Dir-&gt;RegHandle[HOWNER_MAP], &amp;KeyString);
00619                 }
00620             }
00621         }
00622     }
00623 
00624     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (KeyName);
00625     <span class="keywordflow">return</span> Match;
00626 }
00627 
00628 <span class="comment">/*++</span>
00629 <span class="comment"></span>
00630 <span class="comment">Routine Description:</span>
00631 <span class="comment"></span>
00632 <span class="comment">    IO_DESC_MIN     - Returns the descriptor's MIN,MAX or ALIGMENT requirements</span>
00633 <span class="comment">    IO_DESC_MAX</span>
00634 <span class="comment"></span>
00635 <span class="comment">--*/</span>
00636 
00637 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a> LONGLONG
00638 IO_DESC_MIN (
00639     IN PIO_RESOURCE_DESCRIPTOR   Desc
00640     )
00641 {
00642     LONGLONG        li;
00643 
00644     <span class="keywordflow">switch</span> (Desc-&gt;Type) {
00645         <span class="keywordflow">case</span> CmResourceTypePort:
00646             li = Desc-&gt;u.Port.MinimumAddress.QuadPart;
00647             <span class="keywordflow">break</span>;
00648 
00649         <span class="keywordflow">case</span> CmResourceTypeMemory:
00650             li = Desc-&gt;u.Memory.MinimumAddress.QuadPart;
00651             <span class="keywordflow">break</span>;
00652 
00653         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00654             li = Desc-&gt;u.Interrupt.MinimumVector;
00655             <span class="keywordflow">break</span>;
00656 
00657         <span class="keywordflow">case</span> CmResourceTypeDma:
00658             li = Desc-&gt;u.Dma.MinimumChannel;
00659             <span class="keywordflow">break</span>;
00660     }
00661 
00662     <span class="keywordflow">return</span> li;
00663 }
00664 
00665 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a> LONGLONG
00666 IO_DESC_MAX (
00667     IN PIO_RESOURCE_DESCRIPTOR   Desc
00668     )
00669 <span class="comment">/*++</span>
00670 <span class="comment"></span>
00671 <span class="comment">Routine Description:</span>
00672 <span class="comment"></span>
00673 <span class="comment">    Returns the IO_RESORUCE_DESCRIPTOR's maximum value</span>
00674 <span class="comment"></span>
00675 <span class="comment">--*/</span>
00676 {
00677     LONGLONG        li;
00678 
00679     <span class="keywordflow">switch</span> (Desc-&gt;Type) {
00680         <span class="keywordflow">case</span> CmResourceTypePort:
00681             li = Desc-&gt;u.Port.MaximumAddress.QuadPart;
00682             <span class="keywordflow">break</span>;
00683 
00684         <span class="keywordflow">case</span> CmResourceTypeMemory:
00685             li = Desc-&gt;u.Memory.MaximumAddress.QuadPart;
00686             <span class="keywordflow">break</span>;
00687 
00688         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00689             li = Desc-&gt;u.Interrupt.MaximumVector;
00690             <span class="keywordflow">break</span>;
00691 
00692         <span class="keywordflow">case</span> CmResourceTypeDma:
00693             li = Desc-&gt;u.Dma.MaximumChannel;
00694             <span class="keywordflow">break</span>;
00695     }
00696 
00697     <span class="keywordflow">return</span> li;
00698 }
00699 
00700 
00701 BOOLEAN
00702 <a class="code" href="../../d7/d9/assign_8c.html#a57">IopGenNextValidResourceList</a> (
00703     IN ULONG                level,
00704     IN PDIR_RESOURCE_LIST   CurList,
00705     IN PDIR_RESREQ_LIST     Dir
00706     )
00707 <span class="comment">/*++</span>
00708 <span class="comment"></span>
00709 <span class="comment">Routine Description:</span>
00710 <span class="comment">    Attempts to find a setting for every required resource in the CurList</span>
00711 <span class="comment"></span>
00712 <span class="comment">Arguments:</span>
00713 <span class="comment"></span>
00714 <span class="comment">    level   - Index to which required resource list to start finding resources from</span>
00715 <span class="comment">    CurList - List of required resources being processed</span>
00716 <span class="comment">    Dir     - The top directory of resources</span>
00717 <span class="comment"></span>
00718 <span class="comment">    PassNo  - The pass #</span>
00719 <span class="comment">        1 - Preferred settings only</span>
00720 <span class="comment">        2 - Available settings</span>
00721 <span class="comment">        3 - Available settings, find conflict to report</span>
00722 <span class="comment"></span>
00723 <span class="comment">Return Value</span>
00724 <span class="comment"></span>
00725 <span class="comment">    TRUE if all required resources found available settings</span>
00726 <span class="comment"></span>
00727 <span class="comment">--*/</span>
00728 {
00729     ULONG               collisionlevel;
00730     BOOLEAN             flag;
00731 
00732     <span class="keywordflow">do</span> {
00733         <span class="keywordflow">if</span> (level &gt; CurList-&gt;LastLevel) {
00734             CurList-&gt;LastLevel = level;
00735         }
00736 
00737         flag = <a class="code" href="../../d7/d9/assign_8c.html#a58">IopGenNextValidDescriptor</a> (
00738                     level,
00739                     CurList,
00740                     Dir,
00741                     &amp;collisionlevel
00742                 );
00743 
00744         <span class="keywordflow">if</span> (flag == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00745             <span class="comment">//</span>
00746             <span class="comment">// Could not generate a valid descriptor setting</span>
00747             <span class="comment">//</span>
00748 
00749             <span class="keywordflow">if</span> (level == 0  ||  collisionlevel == -1) {
00750                 <span class="comment">//</span>
00751                 <span class="comment">// No more settings</span>
00752                 <span class="comment">//</span>
00753 
00754                 CurList-&gt;FailedLevel = level;
00755                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00756             }
00757 
00758             <span class="comment">//</span>
00759             <span class="comment">// Backup to the collision level and try anew</span>
00760             <span class="comment">//</span>
00761 
00762             <span class="keywordflow">while</span> (level &gt; collisionlevel) {
00763                 CurList-&gt;RequiredResource[level]-&gt;CurLoc = 0;
00764                 CurList-&gt;RequiredResource[level]-&gt;RunLen = 0;
00765                 level--;
00766             }
00767             <span class="keywordflow">continue</span>;
00768         }
00769 
00770         <span class="keywordflow">if</span> (CurList-&gt;RequiredResource[level]-&gt;PassNo == 1  &amp;&amp;
00771             CurList-&gt;RequiredResource[level]-&gt;CurPref &lt;
00772             CurList-&gt;RequiredResource[level]-&gt;BestPref) {
00773 
00774             <span class="comment">//</span>
00775             <span class="comment">// First time through don't mess with unpreferred settings, continue</span>
00776             <span class="comment">// looking at this level</span>
00777             <span class="comment">//</span>
00778 
00779             <span class="keywordflow">continue</span>;
00780         }
00781 
00782         <span class="comment">//</span>
00783         <span class="comment">// Go to next level</span>
00784         <span class="comment">//</span>
00785 
00786         level++;
00787     } <span class="keywordflow">while</span> (level &lt; CurList-&gt;NoRequiredResources);
00788 
00789     <span class="comment">//</span>
00790     <span class="comment">// Determine list's preference</span>
00791     <span class="comment">// (only used on PassNo &gt; 1 since PassNo == 1 only suceedes when</span>
00792     <span class="comment">// preferred settings are used)</span>
00793     <span class="comment">//</span>
00794 
00795     CurList-&gt;CurPref = 0;
00796     <span class="keywordflow">for</span> (level = 0; level &lt; CurList-&gt;NoRequiredResources; level++) {
00797         CurList-&gt;CurPref  += CurList-&gt;RequiredResource[level]-&gt;CurPref;
00798     }
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// Got a setting for each requested resource, return TRUE</span>
00802     <span class="comment">//</span>
00803 
00804     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00805 }
00806 
00807 
00808 
00809 BOOLEAN
00810 <a class="code" href="../../d7/d9/assign_8c.html#a58">IopGenNextValidDescriptor</a> (
00811     IN ULONG                level,
00812     IN PDIR_RESOURCE_LIST   CurList,
00813     IN PDIR_RESREQ_LIST     Dir,
00814     OUT PULONG              collisionlevel
00815     )
00816 <span class="comment">/*++</span>
00817 <span class="comment"></span>
00818 <span class="comment">Routine Description:</span>
00819 <span class="comment"></span>
00820 <span class="comment">Arguments:</span>
00821 <span class="comment"></span>
00822 <span class="comment">Return Value</span>
00823 <span class="comment"></span>
00824 <span class="comment">    TRUE if descriptor setting was found</span>
00825 <span class="comment">    FALSE if no setting found</span>
00826 <span class="comment"></span>
00827 <span class="comment">--*/</span>
00828 {
00829     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>      Res, CRes;
00830     PIO_RESOURCE_DESCRIPTOR     *Desc, DescTmp;
00831     LONGLONG                    BAddr,  EAddr;
00832     LONGLONG                    NBAddr;
00833     LONGLONG                    DescMax, MinAddr, LiILen, LiELen, LiTmp;
00834     LONGLONG                    NAddr, BusMax, BusMin, PBAddr;
00835     ULONG                       indx, j, k, NBLoc;
00836     ULONG                       DescLen, Align, len;
00837     BOOLEAN                     NBSet, flag, flag2;
00838     LONG                        Preference, NPref;
00839     UCHAR                       TType, NTType;
00840     <a class="code" href="../../d4/d0/structTENTRY.html">TENTRY</a>                      Trans, NTrans;
00841 
00842     Res  = CurList-&gt;RequiredResource[level];
00843 
00844     *collisionlevel = (ULONG) -1;       <span class="comment">// assume no collision</span>
00845     NBSet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00846 
00847     <span class="keywordflow">do</span> {
00848         Desc = &amp;Res-&gt;IoResourceDescriptor[Res-&gt;CurLoc];
00849 
00850         <span class="keywordflow">if</span> (!Res-&gt;RunLen) {
00851 
00852             <span class="keywordflow">if</span> (Res-&gt;CurLoc &gt;= Res-&gt;NoAlternatives) {
00853                 <span class="comment">//</span>
00854                 <span class="comment">// No more runs</span>
00855                 <span class="comment">//</span>
00856                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00857             }
00858 
00859             <span class="comment">//</span>
00860             <span class="comment">// Get number of alternatives which are of the same type</span>
00861             <span class="comment">// (alternatives have been sorted into types).</span>
00862             <span class="comment">//</span>
00863 
00864             Res-&gt;Type = Desc[0]-&gt;Type;
00865             <span class="keywordflow">for</span> (j=Res-&gt;CurLoc; j &lt; Res-&gt;NoAlternatives; j++) {
00866                 <span class="keywordflow">if</span> (Res-&gt;Type != Res-&gt;IoResourceDescriptor[j]-&gt;Type) {
00867                     <span class="keywordflow">break</span>;
00868                 }
00869             }
00870 
00871             Res-&gt;RunLen = j - Res-&gt;CurLoc;
00872             <span class="keywordflow">if</span> (!Res-&gt;RunLen) {
00873                 <span class="comment">//</span>
00874                 <span class="comment">// Out of alternatives for this resource</span>
00875                 <span class="comment">//</span>
00876 
00877                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00878             }
00879 
00880             <span class="comment">//</span>
00881             <span class="comment">// Start at beginning of bus options</span>
00882             <span class="comment">//</span>
00883 
00884             Res-&gt;CurBusLoc = 0;
00885 
00886             DescTmp = Dir-&gt;BusDir-&gt;Alternative-&gt;ResourceByType[Res-&gt;Type]-&gt;IoResourceDescriptor[0];
00887 
00888             <span class="keywordflow">if</span> (!DescTmp) {
00889                 <span class="comment">//</span>
00890                 <span class="comment">// There are no bus settings for this type of resource</span>
00891                 <span class="comment">//</span>
00892 
00893                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00894             }
00895 
00896             Res-&gt;CurBusMin = IO_DESC_MIN (DescTmp);
00897             Res-&gt;CurBusMax = IO_DESC_MAX (DescTmp);
00898             NAddr = Res-&gt;CurBusMax;
00899 
00900         } <span class="keywordflow">else</span> {
00901 
00902             <span class="comment">//</span>
00903             <span class="comment">// Decrease current value by one - this will cause this</span>
00904             <span class="comment">// function to find the next acceptable value.</span>
00905             <span class="comment">//</span>
00906 
00907             NAddr = Res-&gt;CurBAddr - 1;
00908         }
00909 
00910         <span class="comment">//</span>
00911         <span class="comment">// Return the next available address from NAddr</span>
00912         <span class="comment">//</span>
00913 
00914         DescLen = Res-&gt;RunLen;
00915         BusMax  = Res-&gt;CurBusMax;
00916         BusMin  = Res-&gt;CurBusMin;
00917 
00918         NBAddr = 0;
00919 
00920         <span class="keywordflow">for</span> (; ;) {
00921 
00922             <span class="comment">//</span>
00923             <span class="comment">// Loop for each descriptor in this run and pick the numerical highest</span>
00924             <span class="comment">// value available for this resource</span>
00925             <span class="comment">//</span>
00926 
00927             <span class="keywordflow">for</span> (indx=0; indx &lt; DescLen ; indx++) {
00928 
00929                 <span class="comment">//</span>
00930                 <span class="comment">// Set len, Align, MinAddr, DescMax</span>
00931                 <span class="comment">//</span>
00932 
00933                 DescTmp = Desc[indx];
00934                 <span class="keywordflow">switch</span> (DescTmp-&gt;Type) {
00935                     <span class="keywordflow">case</span> CmResourceTypePort:
00936                         len     = DescTmp-&gt;u.Port.Length;
00937                         Align   = DescTmp-&gt;u.Port.Alignment;
00938                         MinAddr = DescTmp-&gt;u.Port.MinimumAddress.QuadPart;
00939                         DescMax = DescTmp-&gt;u.Port.MaximumAddress.QuadPart;
00940                         <span class="keywordflow">break</span>;
00941 
00942                     <span class="keywordflow">case</span> CmResourceTypeMemory:
00943                         len     = DescTmp-&gt;u.Memory.Length;
00944                         Align   = DescTmp-&gt;u.Memory.Alignment;
00945                         MinAddr = DescTmp-&gt;u.Memory.MinimumAddress.QuadPart;
00946                         DescMax = DescTmp-&gt;u.Memory.MaximumAddress.QuadPart;
00947                         <span class="keywordflow">break</span>;
00948 
00949                     <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00950                         len   = 1;
00951                         Align = 1;
00952                         MinAddr = DescTmp-&gt;u.Interrupt.MinimumVector;
00953                         DescMax = DescTmp-&gt;u.Interrupt.MaximumVector;
00954                         <span class="keywordflow">break</span>;
00955 
00956                     <span class="keywordflow">case</span> CmResourceTypeDma:
00957                         len   = 1;
00958                         Align = 1;
00959                         MinAddr = DescTmp-&gt;u.Dma.MinimumChannel;
00960                         DescMax = DescTmp-&gt;u.Dma.MaximumChannel;
00961                         <span class="keywordflow">break</span>;
00962 
00963                 }
00964 
00965                 <span class="comment">//</span>
00966                 <span class="comment">// MinAddr is the largest of Descriptor-MinAddr, Bus-MinAddr, or</span>
00967                 <span class="comment">// NextBest-MinAddr.  Don't go below the last MinAddr (NBAddr).</span>
00968                 <span class="comment">// So the search is from NAddr -to-&gt; NBAddr</span>
00969                 <span class="comment">//</span>
00970 
00971                 <span class="keywordflow">if</span> (BusMin &gt; MinAddr) {
00972                     MinAddr = BusMin;
00973                 }
00974 
00975                 <span class="keywordflow">if</span> (NBAddr &gt; MinAddr) {
00976                     MinAddr = NBAddr;
00977                 }
00978 
00979                 BAddr = NAddr;
00980                 LiELen = len;           <span class="comment">// Exclusive length</span>
00981                 LiILen = len - 1;       <span class="comment">// Inclusive length</span>
00982 
00983                 <span class="comment">//</span>
00984                 <span class="comment">// Set initial preference</span>
00985                 <span class="comment">//</span>
00986 
00987                 Preference = 0;
00988                 <span class="keywordflow">if</span> (Res-&gt;PassNo == 1) {
00989                     <span class="keywordflow">if</span> (DescTmp-&gt;Option &amp; IO_RESOURCE_PREFERRED) {
00990                         <span class="comment">// Account for device's preference durning first pass</span>
00991                         Preference = 1;
00992 
00993                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Res-&gt;BestPref) {
00994                         <span class="comment">// Some resource in this list has a prefernce, but it's not</span>
00995                         <span class="comment">// this one.  Since this is the PassNo == 1 skip non-preferred.</span>
00996                         <span class="keywordflow">continue</span>;
00997                     }
00998                 }
00999 
01000 
01001                 <span class="comment">//</span>
01002                 <span class="comment">// Loop while BAddr being tested is above MinAddr</span>
01003                 <span class="comment">//</span>
01004 
01005                 <span class="keywordflow">while</span> (BAddr &gt;= MinAddr) {
01006 
01007                     EAddr = BAddr + LiILen;
01008                     <span class="keywordflow">if</span> (EAddr &gt; DescMax) {
01009                         <span class="comment">//</span>
01010                         <span class="comment">// The ending address is above the requested limit</span>
01011                         <span class="comment">// compute the best possible beginning address</span>
01012                         <span class="comment">//</span>
01013 
01014                         BAddr = DescMax - LiILen;
01015                         <span class="keywordflow">continue</span>;
01016                     }
01017 
01018                     <span class="keywordflow">if</span> (EAddr &gt; BusMax) {
01019                         <span class="comment">//</span>
01020                         <span class="comment">// The ending address is above the bus'es limit</span>
01021                         <span class="comment">// compute best possible beginning address</span>
01022                         <span class="comment">//</span>
01023 
01024                         BAddr = BusMax - LiILen;
01025                         <span class="keywordflow">continue</span>;
01026                     }
01027 
01028                     <span class="comment">//</span>
01029                     <span class="comment">// Verify selection is within any user supplied requirements</span>
01030                     <span class="comment">// (this is from RegistryPath\AssignResources)</span>
01031                     <span class="comment">//</span>
01032 
01033                     <span class="keywordflow">if</span> (Dir-&gt;UserDir) {
01034                         CRes = Dir-&gt;UserDir-&gt;Alternative-&gt;ResourceByType[Res-&gt;Type];
01035                         flag = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01036                         PBAddr = -1;
01037 
01038                         <span class="keywordflow">for</span> (j=0; j &lt; CRes-&gt;NoAlternatives; j++) {
01039                             LiTmp = IO_DESC_MIN (CRes-&gt;IoResourceDescriptor[j]);
01040 
01041                             <span class="keywordflow">if</span> (BAddr &lt; LiTmp) {
01042                                 <span class="comment">//</span>
01043                                 <span class="comment">// Beginning address is before user's range, check</span>
01044                                 <span class="comment">// next descriptor</span>
01045                                 <span class="comment">//</span>
01046 
01047                                 <span class="keywordflow">continue</span>;
01048                             }
01049 
01050                             LiTmp = IO_DESC_MAX (CRes-&gt;IoResourceDescriptor[j]);
01051                             <span class="keywordflow">if</span> (EAddr &gt; LiTmp) {
01052 
01053                                 <span class="comment">//</span>
01054                                 <span class="comment">// Ending address is above user's range.</span>
01055                                 <span class="comment">// Check for new BAddr to continue from</span>
01056                                 <span class="comment">//</span>
01057 
01058                                 LiTmp = LiTmp - LiILen;
01059                                 <span class="keywordflow">if</span> (LiTmp &gt; PBAddr  &amp;&amp;  LiTmp &lt; BAddr) {
01060 
01061                                     <span class="comment">//</span>
01062                                     <span class="comment">// Update next possible setting</span>
01063                                     <span class="comment">//</span>
01064 
01065                                     PBAddr = LiTmp;
01066                                 }
01067                                 <span class="keywordflow">continue</span>;
01068                             }
01069 
01070                             <span class="comment">//</span>
01071                             <span class="comment">// Within user's requested range</span>
01072                             <span class="comment">//</span>
01073 
01074                             flag = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01075                             <span class="keywordflow">break</span>;
01076                         }
01077 
01078                         <span class="keywordflow">if</span> (!flag) {
01079                             BAddr = PBAddr;
01080                             <span class="keywordflow">continue</span>;
01081                         }
01082                     }
01083 
01084                     <span class="comment">//</span>
01085                     <span class="comment">// So far resource looks good - translate it to system global</span>
01086                     <span class="comment">// settings and verify resource is available</span>
01087                     <span class="comment">//</span>
01088 
01089                     LiTmp = 0;
01090                     <span class="keywordflow">switch</span> (Res-&gt;Type) {
01091                         <span class="keywordflow">case</span> CmResourceTypePort:
01092                         <span class="keywordflow">case</span> CmResourceTypeMemory:
01093                             j = k = Res-&gt;Type == CmResourceTypePort ? 1 : 0;
01094                             flag = <a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a> (
01095                                 Dir-&gt;IoResourceReq-&gt;InterfaceType,
01096                                 Dir-&gt;IoResourceReq-&gt;BusNumber,
01097                                 *((PPHYSICAL_ADDRESS) &amp;BAddr),
01098                                 &amp;j,
01099                                 (PPHYSICAL_ADDRESS) &amp;Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o0">BAddr</a>
01100                                 );
01101 
01102                             <span class="comment">// precheck alignment on first half</span>
01103                             <span class="keywordflow">if</span> (Align &gt; 1  &amp;&amp;  (Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o0">BAddr</a> &amp; 0xffffffff00000000) == 0) {
01104                                 RtlEnlargedUnsignedDivide (
01105                                     *((PULARGE_INTEGER) &amp;Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o0">BAddr</a>), Align, (PULONG) &amp;LiTmp);
01106 
01107                                 <span class="keywordflow">if</span> (LiTmp &amp; 0xffffffff) {
01108                                     <span class="keywordflow">break</span>;      <span class="comment">// alignment is off - don't bother with second translation</span>
01109                                 }
01110                             }
01111 
01112                             flag2 = <a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a> (
01113                                 Dir-&gt;IoResourceReq-&gt;InterfaceType,
01114                                 Dir-&gt;IoResourceReq-&gt;BusNumber,
01115                                 *((PPHYSICAL_ADDRESS) &amp;EAddr),
01116                                 &amp;k,
01117                                 (PPHYSICAL_ADDRESS) &amp;Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o1">EAddr</a>
01118                                 );
01119 
01120                             TType = j == 1 ? CmResourceTypePort : CmResourceTypeMemory;
01121                             Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o2">Affinity</a> = (KAFFINITY) -1;
01122 
01123                             <span class="keywordflow">if</span> (flag == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || flag2 == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>  ||  j != k) {
01124                                 <span class="comment">// HalAdjustResourceList should ensure that the returned range</span>
01125                                 <span class="comment">// for the bus is within the bus limits and no translation</span>
01126                                 <span class="comment">// within those limits should ever fail</span>
01127 
01128                                 <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopGenNextValidDescriptor: Error return for HalTranslateBusAddress\n"</span>);
01129                                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01130                             }
01131                             <span class="keywordflow">break</span>;
01132 
01133                         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
01134                             TType = CmResourceTypeInterrupt;
01135 
01136                             Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o2">Affinity</a> = 0;
01137                             Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o0">BAddr</a> = <a class="code" href="../../d2/d7/hal_8h.html#a181">HalGetInterruptVector</a> (
01138                                 Dir-&gt;IoResourceReq-&gt;InterfaceType,
01139                                 Dir-&gt;IoResourceReq-&gt;BusNumber,
01140                                 (ULONG) BAddr,                  <span class="comment">// bus level</span>
01141                                 (ULONG) BAddr,                  <span class="comment">// bus vector</span>
01142                                 (PKIRQL) &amp;j,                    <span class="comment">// translated level</span>
01143                                 &amp;Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o2">Affinity</a>
01144                                 );
01145 
01146                             Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o1">EAddr</a> = Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o0">BAddr</a>;
01147 
01148                             <span class="keywordflow">if</span> (Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o2">Affinity</a> == 0) {
01149                                 <span class="comment">// skip vectors which can not be translated</span>
01150                                 LiTmp = 1;
01151                             }
01152                             <span class="keywordflow">break</span>;
01153 
01154                         <span class="keywordflow">case</span> CmResourceTypeDma:
01155                             TType           = CmResourceTypeDma;
01156                             Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o0">BAddr</a>     = BAddr;
01157                             Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o1">EAddr</a>     = EAddr;
01158                             Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o2">Affinity</a>  = (KAFFINITY) -1;
01159                             <span class="keywordflow">break</span>;
01160 
01161                         <span class="keywordflow">default</span>:
01162                             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopGenNextValidDescriptor: Invalid resource type\n"</span>);
01163                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01164                     }
01165 
01166                     <span class="comment">//</span>
01167                     <span class="comment">// Check bias from translation</span>
01168                     <span class="comment">//</span>
01169 
01170                     <span class="keywordflow">if</span> (LiTmp != 0) {
01171 
01172                         <span class="comment">// move to next address</span>
01173                         BAddr = BAddr - LiTmp;
01174                         <span class="keywordflow">continue</span>;
01175                     }
01176 
01177                     <span class="comment">//</span>
01178                     <span class="comment">// Check alignment restrictions</span>
01179                     <span class="comment">//</span>
01180 
01181                     <span class="keywordflow">if</span> (Align &gt; 1) {
01182                         <span class="keywordflow">if</span> ((Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o0">BAddr</a> &amp; 0xffffffff00000000) == 0) {
01183                             RtlEnlargedUnsignedDivide (
01184                                 *((PULARGE_INTEGER) &amp;Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o0">BAddr</a>), Align, (PULONG) &amp;LiTmp);
01185                         } <span class="keywordflow">else</span> {
01186                             <a class="code" href="../../d0/d1/largeic_8c.html#a0">RtlExtendedLargeIntegerDivide</a> (
01187                                 *((PLARGE_INTEGER) &amp;Trans.<a class="code" href="../../d4/d0/structTENTRY.html#o0">BAddr</a>), Align, (PULONG) &amp;LiTmp);
01188 
01189                         }
01190 
01191                         <span class="keywordflow">if</span> (LiTmp != 0) {
01192                             <span class="comment">//</span>
01193                             <span class="comment">// Starting address not on proper alignment, move to next</span>
01194                             <span class="comment">// aligned address</span>
01195                             <span class="comment">//</span>
01196 
01197                             BAddr = BAddr - LiTmp;
01198                             <span class="keywordflow">continue</span>;
01199                         }
01200                     }
01201 
01202                     <span class="comment">//</span>
01203                     <span class="comment">// Check for collision with other settings being considered</span>
01204                     <span class="comment">//</span>
01205 
01206                     <span class="keywordflow">for</span> (j=0; j &lt; level; j++) {
01207                         <span class="keywordflow">if</span> (CurList-&gt;RequiredResource[j]-&gt;TType == TType) {
01208                             CRes = CurList-&gt;RequiredResource[j];
01209                             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/assign_8c.html#a17">DoesTEntryCollide</a> (Trans, CRes-&gt;Trans)) {
01210                                 <span class="comment">// collision</span>
01211                                 <span class="keywordflow">break</span>;
01212                             }
01213                         }
01214                     }
01215 
01216                     <span class="keywordflow">if</span> (j &lt; level) {
01217                         <span class="comment">//</span>
01218                         <span class="comment">// Current BAddr - EAddr collides with CRes selection</span>
01219                         <span class="comment">//</span>
01220 
01221                         <span class="keywordflow">if</span> (j &lt; *collisionlevel) {
01222 
01223                             <span class="comment">//</span>
01224                             <span class="comment">// If we fail, back up to this level</span>
01225                             <span class="comment">//</span>
01226 
01227                             *collisionlevel = j;
01228                         }
01229 
01230                         <span class="comment">//</span>
01231                         <span class="comment">// Try BAddr just best address before collision range</span>
01232                         <span class="comment">//</span>
01233 
01234                         BAddr = CRes-&gt;CurBAddr - LiELen;
01235                         <span class="keywordflow">continue</span>;
01236                     }
01237 
01238                     <span class="comment">//</span>
01239                     <span class="comment">// Check InUse system resources to verify this range is available.</span>
01240                     <span class="comment">//</span>
01241 
01242                     j = <a class="code" href="../../d7/d9/assign_8c.html#a50">IopFindCollisionInTList</a> (&amp;Trans, Dir-&gt;InUseResources.ByType[TType]);
01243                     <span class="keywordflow">if</span> (j) {
01244                         <span class="keywordflow">if</span> (Res-&gt;PassNo == 3) {
01245                             <span class="comment">//</span>
01246                             <span class="comment">// Track this collision</span>
01247                             <span class="comment">//</span>
01248 
01249                             <a class="code" href="../../d7/d9/assign_8c.html#a51">IopPickupCollisionInTList</a> (
01250                                 CurList,
01251                                 Res-&gt;Type,
01252                                 BAddr,
01253                                 &amp;Trans,
01254                                 Dir-&gt;InUseResources.ByType[TType]
01255                                 );
01256                         }
01257 
01258                         <span class="comment">//</span>
01259                         <span class="comment">// This range collides with a resource which is already in use.</span>
01260                         <span class="comment">// Moving begining address to next possible setting</span>
01261                         <span class="comment">//</span>
01262 
01263                         BAddr = BAddr - j;
01264                         <span class="keywordflow">continue</span>;
01265                     }
01266 
01267                     <span class="comment">//</span>
01268                     <span class="comment">// Check to see if this resource selection is being shared</span>
01269                     <span class="comment">//</span>
01270 
01271                     j = <a class="code" href="../../d7/d9/assign_8c.html#a50">IopFindCollisionInTList</a> (&amp;Trans, Dir-&gt;InUseSharableResources.ByType[TType]);
01272                     <span class="keywordflow">if</span> (j) {
01273                         <span class="comment">//</span>
01274                         <span class="comment">// Current range collided with a resource which is already in use,</span>
01275                         <span class="comment">// but is sharable.  If the current required resource is not sharable,</span>
01276                         <span class="comment">// then skip this range; otherwise, reduce the preference for this setting.</span>
01277                         <span class="comment">//</span>
01278 
01279                         <span class="keywordflow">if</span> (Res-&gt;PassNo == 1 || Desc[indx]-&gt;ShareDisposition != CmResourceShareShared) {
01280                             <span class="keywordflow">if</span> (Res-&gt;PassNo == 3) {
01281                                 <span class="comment">//</span>
01282                                 <span class="comment">// Track this collision</span>
01283                                 <span class="comment">//</span>
01284 
01285                                 <a class="code" href="../../d7/d9/assign_8c.html#a51">IopPickupCollisionInTList</a> (
01286                                     CurList,
01287                                     Res-&gt;Type,
01288                                     BAddr,
01289                                     &amp;Trans,
01290                                     Dir-&gt;InUseSharableResources.ByType[TType]
01291                                     );
01292                             }
01293 
01294                             <span class="comment">// required resource can't be shared, move to next possible setting or</span>
01295                             <span class="comment">// this is the Pass#1 and we don't bother with non-preferred settings</span>
01296 
01297                             BAddr = BAddr - j;
01298                             <span class="keywordflow">continue</span>;
01299                         }
01300 
01301                         Preference -= 4;
01302                     }
01303 
01304                     <span class="comment">//</span>
01305                     <span class="comment">// Check to see if this resource reserved, but sharable</span>
01306                     <span class="comment">//</span>
01307 
01308                     j = <a class="code" href="../../d7/d9/assign_8c.html#a50">IopFindCollisionInTList</a> (&amp;Trans, Dir-&gt;ReservedSharableResources.ByType[TType]);
01309                     <span class="keywordflow">if</span> (j) {
01310                         <span class="comment">//</span>
01311                         <span class="comment">// Current range collosided with a resource which is in the</span>
01312                         <span class="comment">// ReservedResource list, but is marked sharable.  These resources</span>
01313                         <span class="comment">// are treated as non-preferred regions.</span>
01314                         <span class="comment">//</span>
01315 
01316                         <span class="keywordflow">if</span> (Res-&gt;PassNo == 1) {
01317                             <span class="comment">// don't bother with non-preferred settings on the first pass.</span>
01318 
01319                             BAddr = BAddr - j;
01320                             <span class="keywordflow">continue</span>;
01321                         }
01322 
01323                         Preference -= 2;
01324                     }
01325 
01326                     <span class="comment">//</span>
01327                     <span class="comment">// BAddr - EAddr is a good selection</span>
01328                     <span class="comment">// (BAddr is greater than NBAddr)</span>
01329                     <span class="comment">//</span>
01330 
01331                     NBSet   = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01332                     NBAddr  = BAddr;
01333 
01334                     NTType  = TType;
01335                     NTrans  = Trans;
01336                     NPref   = Preference;
01337                     NBLoc   = Res-&gt;CurLoc + indx;
01338                     <span class="keywordflow">break</span>;                  <span class="comment">// check next selector in run</span>
01339 
01340                 } <span class="comment">// next BAddr</span>
01341             }   <span class="comment">// next descriptor in run</span>
01342 
01343             <span class="keywordflow">if</span> (NBSet) {
01344                 <span class="comment">// SUCCESS We have a hit</span>
01345                 <span class="keywordflow">break</span>;
01346             }
01347 
01348             <span class="comment">//</span>
01349             <span class="comment">// No setting so far, move to next bus ordering descriptor</span>
01350             <span class="comment">//</span>
01351 
01352             Res-&gt;CurBusLoc++;
01353             CRes = Dir-&gt;BusDir-&gt;Alternative-&gt;ResourceByType[Res-&gt;Type];
01354 
01355             <span class="keywordflow">if</span> (Res-&gt;CurBusLoc &gt;= CRes-&gt;NoAlternatives) {
01356                 <span class="comment">//</span>
01357                 <span class="comment">// no more bus ordering descriptors, move to next ResRun</span>
01358                 <span class="comment">//</span>
01359 
01360                 Res-&gt;CurLoc += Res-&gt;RunLen;
01361                 Res-&gt;RunLen = 0;
01362                 <span class="keywordflow">break</span>;
01363             }
01364 
01365             DescTmp = CRes-&gt;IoResourceDescriptor[Res-&gt;CurBusLoc];
01366             Res-&gt;CurBusMin = IO_DESC_MIN (DescTmp);
01367             Res-&gt;CurBusMax = IO_DESC_MAX (DescTmp);
01368             BusMin  = Res-&gt;CurBusMin;
01369             BusMax  = Res-&gt;CurBusMax;
01370             NAddr   = Res-&gt;CurBusMax;
01371         }   <span class="comment">// next bus ordering descriptor</span>
01372 
01373     } <span class="keywordflow">while</span> (!NBSet);
01374 
01375     <span class="comment">//</span>
01376     <span class="comment">// We have a setting for this resource.  Remember it and return.</span>
01377     <span class="comment">//</span>
01378 
01379     Res-&gt;TType     = NTType;    <span class="comment">// used to detect internal conflicts of translated values</span>
01380     Res-&gt;Trans     = NTrans;    <span class="comment">// "</span>
01381 
01382     Res-&gt;CurPref   = NPref;     <span class="comment">// Return prefernce of setting</span>
01383     Res-&gt;CurBAddr  = NBAddr;    <span class="comment">// Return raw BAddr of resource (used by Phase3&amp;4)</span>
01384     Res-&gt;CurBLoc   = NBLoc;     <span class="comment">// Return location of resource (used by Phase3&amp;4)</span>
01385     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01386 }
01387 
01388 
01389 ULONG
01390 <a class="code" href="../../d7/d9/assign_8c.html#a50">IopFindCollisionInTList</a> (
01391     IN PTENTRY SEntry,
01392     IN PLTENTRY List
01393     )
01394 <span class="comment">/*++</span>
01395 <span class="comment"></span>
01396 <span class="comment">Routine Description:</span>
01397 <span class="comment"></span>
01398 <span class="comment">    Checks to see if there's a collision between the source TENTRY and the list</span>
01399 <span class="comment">    of TENTRIES passed by PLTENTRY.</span>
01400 <span class="comment"></span>
01401 <span class="comment">Arguments:</span>
01402 <span class="comment"></span>
01403 <span class="comment">Return Value</span>
01404 <span class="comment"></span>
01405 <span class="comment">    Returns the skew amount required to continue searching for next possible</span>
01406 <span class="comment">    setting and a pointer to the conflicted entry.</span>
01407 <span class="comment">    A zero skew means no collision occured.</span>
01408 <span class="comment"></span>
01409 <span class="comment">--*/</span>
01410 {
01411     LONGLONG        LiTmp;
01412     <a class="code" href="../../d4/d0/structTENTRY.html">TENTRY</a>          Source;
01413     ULONG           i, j;
01414 
01415     Source = *SEntry;
01416     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) {
01417         j = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;CurEntries;
01418         <span class="keywordflow">for</span> (i=0; i &lt; j; i++) {
01419             SEntry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Table+i;
01420             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/assign_8c.html#a17">DoesTEntryCollide</a> (Source, *SEntry)) {
01421 
01422                 LiTmp = Source.<a class="code" href="../../d4/d0/structTENTRY.html#o1">EAddr</a> - SEntry-&gt;BAddr;
01423                 <span class="keywordflow">return</span> (ULONG) LiTmp + 1;
01424             }
01425         }
01426         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Next;
01427     }
01428     <span class="keywordflow">return</span> 0;
01429 }
01430 
01431 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01432 <a class="code" href="../../d7/d9/assign_8c.html#a51">IopPickupCollisionInTList</a> (
01433     IN PDIR_RESOURCE_LIST   CurList,
01434     IN UCHAR                Type,
01435     IN LONGLONG             BAddr,
01436     IN PTENTRY              SEntry,
01437     IN PLTENTRY             List
01438     )
01439 {
01440     <a class="code" href="../../d4/d0/structTENTRY.html">TENTRY</a>          Source;
01441     ULONG           i, j, conflicts;
01442 
01443     Source = *SEntry;
01444 
01445     <span class="comment">//</span>
01446     <span class="comment">// If resource already listed in easy collision list, skip it</span>
01447     <span class="comment">//</span>
01448 
01449     j = CurList-&gt;Conflict.NoConflicts;
01450     <span class="keywordflow">if</span> (j &gt; <a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>) {
01451         j = <a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>;
01452     }
01453 
01454     <span class="keywordflow">for</span> (i=0; i &lt; j; i++) {
01455         <span class="keywordflow">if</span> (CurList-&gt;Conflict.EasyConflict[i].BAddr == BAddr  &amp;&amp;
01456             CurList-&gt;Conflict.EasyConflict[i].Type == Type) {
01457                 <span class="keywordflow">return</span> ;
01458         }
01459     }
01460 
01461     <span class="comment">//</span>
01462     <span class="comment">// Add valid, but conflicting, resource setting to failed list</span>
01463     <span class="comment">//</span>
01464 
01465     conflicts = CurList-&gt;Conflict.NoConflicts;
01466     <span class="keywordflow">if</span> (conflicts &lt; <a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>) {
01467         CurList-&gt;Conflict.EasyConflict[conflicts].Type  = Type;
01468         CurList-&gt;Conflict.EasyConflict[conflicts].BAddr = BAddr;
01469     }
01470 
01471     <span class="comment">//</span>
01472     <span class="comment">// Find collision</span>
01473     <span class="comment">//</span>
01474 
01475     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) {
01476         j = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;CurEntries;
01477         <span class="keywordflow">for</span> (i=0; i &lt; j; i++) {
01478             SEntry = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Table+i;
01479             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/assign_8c.html#a17">DoesTEntryCollide</a> (Source, *SEntry)) {
01480 
01481                 <span class="keywordflow">if</span> (SEntry-&gt;Owner) {
01482                     <span class="keywordflow">if</span> (conflicts &lt; <a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>) {
01483                         CurList-&gt;Conflict.EasyConflict[conflicts].Owner = SEntry-&gt;Owner;
01484                         SEntry-&gt;Owner-&gt;InConflict.Flink = (PVOID) -1;
01485                     }
01486 
01487                     <span class="keywordflow">if</span> (SEntry-&gt;Owner-&gt;InConflict.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01488                         <span class="comment">//</span>
01489                         <span class="comment">// Add owner of this conflict to list of colliding owners</span>
01490                         <span class="comment">//</span>
01491 
01492                         InsertTailList (&amp;CurList-&gt;Conflict.OtherConflicts, &amp;SEntry-&gt;Owner-&gt;InConflict);
01493                     }
01494 
01495                 }
01496 
01497                 CurList-&gt;Conflict.NoConflicts += 1;
01498                 <span class="keywordflow">return</span> ;
01499             }
01500         }
01501         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Next;
01502     }
01503 }
01504 
01505 
01506 <a class="code" href="../../d7/d9/assign_8c.html#a3">STATIC</a> PVOID
01507 <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (
01508     IN PDIR_RESREQ_LIST     Dir,
01509     IN ULONG                Length
01510     )
01511 <span class="comment">/*++</span>
01512 <span class="comment"></span>
01513 <span class="comment">Routine Description:</span>
01514 <span class="comment"></span>
01515 <span class="comment">    Allocates pool and links the allocation to the DIR_RESREQ_LIST structure so it will be freed</span>
01516 <span class="comment">    when the DIR_RESRES_LIST is freed.</span>
01517 <span class="comment"></span>
01518 <span class="comment">    WARNING: Just like ExAllocatePool this function needs to return memory aligned on 8 byte</span>
01519 <span class="comment">    boundaries.</span>
01520 <span class="comment"></span>
01521 <span class="comment">--*/</span>
01522 {
01523     <a class="code" href="../../d7/d9/assign_8c.html#a40">PUSED_HEAP</a>      ph;
01524 
01525     ph = (<a class="code" href="../../d7/d9/assign_8c.html#a40">PUSED_HEAP</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, Length+<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/structUSED__HEAP.html">USED_HEAP</a>));
01526     <span class="keywordflow">if</span> (!ph) {
01527         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01528     }
01529 
01530     ph-&gt;FreeHeap = (PVOID) ph;
01531     PushEntryList (&amp;Dir-&gt;AllocatedHeap, &amp;ph-&gt;FreeLink);
01532     <span class="keywordflow">return</span> (PVOID) (ph+1);
01533 }
01534 
01535 
01536 
01537 PIO_RESOURCE_REQUIREMENTS_LIST
01538 <a class="code" href="../../d7/d9/assign_8c.html#a41">IopGetResourceReqRegistryValue</a> (
01539     IN PDIR_RESREQ_LIST     Dir,
01540     IN HANDLE               KeyHandle,
01541     IN PWSTR                ValueName
01542     )
01543 <span class="comment">/*++</span>
01544 <span class="comment"></span>
01545 <span class="comment">Routine Description:</span>
01546 <span class="comment"></span>
01547 <span class="comment">    Looks up the setting for ValueKey in KeyHandle and returns the</span>
01548 <span class="comment">    data or NULL.  If non-null, the memory was obtained via pool.</span>
01549 <span class="comment"></span>
01550 <span class="comment">Arguments:</span>
01551 <span class="comment"></span>
01552 <span class="comment">Return Value:</span>
01553 <span class="comment"></span>
01554 <span class="comment">--*/</span>
01555 {
01556     PKEY_VALUE_FULL_INFORMATION     KeyInformation;
01557     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
01558     PUCHAR                          Data;
01559     ULONG                           DataLength, Type;
01560     PIO_RESOURCE_REQUIREMENTS_LIST  p;
01561 
01562     <span class="keywordflow">for</span> (; ;) {
01563         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (KeyHandle, ValueName, &amp;KeyInformation);
01564         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01565             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01566         }
01567 
01568         <span class="comment">//</span>
01569         <span class="comment">// Get pointer to data &amp; length</span>
01570         <span class="comment">//</span>
01571 
01572         Type = KeyInformation-&gt;Type;
01573         Data = ((PUCHAR) KeyInformation + KeyInformation-&gt;DataOffset);
01574         DataLength = KeyInformation-&gt;DataLength;
01575 
01576         <span class="comment">//</span>
01577         <span class="comment">// Copy data to aligned paged pool buffer, and free non-paged pool</span>
01578         <span class="comment">//</span>
01579 
01580         p = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (Dir, DataLength + <span class="keyword">sizeof</span> (WCHAR));
01581         <span class="keywordflow">if</span> (!p) {
01582             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (KeyInformation);
01583             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01584         }
01585 
01586         RtlCopyMemory (p, Data, DataLength);
01587         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (KeyInformation);
01588 
01589         <span class="keywordflow">if</span> (Type == REG_SZ) {
01590             <span class="comment">//</span>
01591             <span class="comment">// Forward to different entry - Need to copy name in order to get</span>
01592             <span class="comment">// space at the end to add the NULL terminator</span>
01593             <span class="comment">//</span>
01594 
01595             <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> = (PWSTR) p;
01596             <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> [DataLength / <span class="keyword">sizeof</span> (WCHAR)] = 0;
01597             <span class="keywordflow">continue</span>;
01598         }
01599 
01600         <span class="comment">// verify registry entry is of expected type</span>
01601         <span class="keywordflow">if</span> (Type != REG_RESOURCE_REQUIREMENTS_LIST) {
01602             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01603         }
01604 
01605         p-&gt;ListSize = DataLength;
01606         <span class="keywordflow">return</span> p;
01607     }
01608 }
01609 
01610 <span class="preprocessor">#endif</span>
01611 <span class="preprocessor"></span>
01612 <span class="preprocessor">#if 0</span>
01613 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01614 <a class="code" href="../../d7/d9/assign_8c.html#a42">IopAssignResourcesPhase1</a> (
01615     IN PIO_RESOURCE_REQUIREMENTS_LIST   IoResources,
01616     IN PIO_RESOURCE_REQUIREMENTS_LIST   *pCopiedList
01617     )
01618 <span class="comment">/*++</span>
01619 <span class="comment"></span>
01620 <span class="comment">Routine Description:</span>
01621 <span class="comment"></span>
01622 <span class="comment">    Copies the callers supplied resource list and passes it to the HAL.  The HAL</span>
01623 <span class="comment">    then adjusts the requested resource list to be within any bus/system requirements</span>
01624 <span class="comment">    the system may have.</span>
01625 <span class="comment"></span>
01626 <span class="comment">Arguments:</span>
01627 <span class="comment">    IoResources     - Callers requested resource list</span>
01628 <span class="comment">    *pCopiedList    - Returned resource list (allocated from heap)</span>
01629 <span class="comment"></span>
01630 <span class="comment"></span>
01631 <span class="comment">--*/</span>
01632 {
01633     PIO_RESOURCE_LIST                   ResourceList;
01634     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                            status;
01635     ULONG                               cnt, length;
01636     PUCHAR                              FirstAddress, LastAddress;
01637 
01638     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01639 
01640 
01641     <span class="comment">//</span>
01642     <span class="comment">// Verify Version &amp; Revision of data structure is set correctly</span>
01643     <span class="comment">//</span>
01644 
01645     <span class="keywordflow">if</span> (IoResources-&gt;AlternativeLists == 0  ||
01646         IoResources-&gt;Reserved[0] != 0  ||
01647         IoResources-&gt;Reserved[1] != 0  ||
01648         IoResources-&gt;Reserved[2] != 0) {
01649         <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopAssignResourcesPhase1: Bad structure format\n"</span>);
01650         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01651     }
01652 
01653     <span class="comment">//</span>
01654     <span class="comment">// Pass a copy of the list to the HAL for any adjustments</span>
01655     <span class="comment">//</span>
01656 
01657     <span class="comment">//</span>
01658     <span class="comment">// Simple sanity check for size of callers RequestedResource list</span>
01659     <span class="comment">//</span>
01660 
01661     ResourceList = IoResources-&gt;List;
01662     FirstAddress = (PUCHAR) ResourceList;
01663     LastAddress  = (PUCHAR) IoResources + IoResources-&gt;ListSize;
01664 
01665     <span class="keywordflow">for</span> (cnt=0; cnt &lt; IoResources-&gt;AlternativeLists; cnt++) {
01666         <span class="keywordflow">if</span> (ResourceList-&gt;Version != 1 || ResourceList-&gt;Revision &lt; 1) {
01667             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopAssignResourcesPhase1: Invalid version #\n"</span>);
01668             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01669         }
01670 
01671         ResourceList = (PIO_RESOURCE_LIST)
01672             (&amp;ResourceList-&gt;Descriptors[ResourceList-&gt;Count]);
01673 
01674 
01675         <span class="keywordflow">if</span> ((PUCHAR) ResourceList &lt; FirstAddress ||
01676             (PUCHAR) ResourceList &gt; LastAddress) {
01677             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopAssignResourcesPhase1: IO_RESOURCE_LIST.ListSize too small\n"</span>);
01678             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01679         }
01680     }
01681 
01682     length = (ULONG) ((PUCHAR) ResourceList - (PUCHAR) IoResources);
01683 
01684     <span class="comment">//</span>
01685     <span class="comment">// Copy user's passed in list</span>
01686     <span class="comment">//</span>
01687 
01688     *pCopiedList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, length);
01689 
01690     <span class="keywordflow">if</span> (!*pCopiedList) {
01691         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01692     }
01693 
01694     RtlCopyMemory (*pCopiedList, IoResources, length);
01695     (*pCopiedList)-&gt;ListSize = length;
01696 
01697     <span class="comment">//</span>
01698     <span class="comment">// Let hal adjust the requested list</span>
01699     <span class="comment">//</span>
01700 
01701     status = <a class="code" href="../../d2/d7/hal_8h.html#a189">HalAdjustResourceList</a> (pCopiedList);
01702     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01703         <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopAssignResourcesPhase1: HalAdjustResourceList failed\n"</span>);
01704         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (*pCopiedList);
01705         <span class="keywordflow">return</span> status;
01706     }
01707 
01708     <span class="keywordflow">return</span> STATUS_SUCCESS;
01709 }
01710 
01711 
01712 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01713 <a class="code" href="../../d7/d9/assign_8c.html#a43">IopAssignResourcesPhase2</a> (
01714     IN PDIR_RESREQ_LIST     Dir,
01715     IN PUNICODE_STRING      DriverClassName,
01716     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>       DriverObject,
01717     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>       DeviceObject
01718     )
01719 <span class="comment">/*</span>
01720 <span class="comment"></span>
01721 <span class="comment">Routine Description:</span>
01722 <span class="comment"></span>
01723 <span class="comment">    Reads the ResourceMap in the registry and builds a canonical list of</span>
01724 <span class="comment">    all in use resources ranges by resource type.</span>
01725 <span class="comment"></span>
01726 <span class="comment">Arguments:</span>
01727 <span class="comment"></span>
01728 <span class="comment">    Dir     - InUseResources &amp; InUseShareableResources are filled in by this call.</span>
01729 <span class="comment"></span>
01730 <span class="comment">*/</span>
01731 {
01732     HANDLE                          ResourceMap, ClassKeyHandle, DriverKeyHandle;
01733     ULONG                           ClassKeyIndex, DriverKeyIndex, DriverValueIndex, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01734     POBJECT_NAME_INFORMATION        ObNameInfo;
01735     PCM_RESOURCE_LIST               CmResList;
01736     PCM_FULL_RESOURCE_DESCRIPTOR    CmFResDesc;
01737     PCM_PARTIAL_RESOURCE_DESCRIPTOR CmDesc;
01738     UNICODE_STRING                  unicodeString;
01739     UNICODE_STRING                  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, TranslatedName, DriverName, DClassName;
01740     PVOID                           p2;
01741     ULONG                           <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01742     <span class="keyword">union </span>{
01743         PVOID                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01744         PKEY_BASIC_INFORMATION      KeyBInf;
01745         PKEY_FULL_INFORMATION       KeyFInf;
01746         PKEY_VALUE_FULL_INFORMATION VKeyFInf;
01747     } U;
01748     PUCHAR                          LastAddr;
01749     ULONG                           junk, Length, i, j, TranslatedStrLen, BusTranslatedStrLen;
01750     PWSTR                           pw;
01751     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
01752     BOOLEAN                         sameClass, sameDriver;
01753     BOOLEAN                         flag;
01754     <a class="code" href="../../d9/d5/structPOWNER.html">POWNER</a>                          <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
01755     LONGLONG                        li;
01756 
01757     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01758 
01759     <span class="comment">//</span>
01760     <span class="comment">// Allocate a scratch buffer.  Use BUFFSERSIZE or the sizeof the largest</span>
01761     <span class="comment">// value in SystemResources\ReservedResources</span>
01762     <span class="comment">//</span>
01763 
01764     U.Buffer = Dir-&gt;Buffer;
01765     U.KeyFInf-&gt;MaxValueNameLen = U.KeyFInf-&gt;MaxValueDataLen = 0;
01766     ZwQueryKey( Dir-&gt;RegHandle[HRESERVEDRESOURCES],
01767                 KeyFullInformation,
01768                 U.KeyFInf,
01769                 BUFFERSIZE,
01770                 &amp;junk );
01771 
01772     Length = <span class="keyword">sizeof</span>( KEY_VALUE_FULL_INFORMATION ) +
01773         U.KeyFInf-&gt;MaxValueNameLen + U.KeyFInf-&gt;MaxValueDataLen + <span class="keyword">sizeof</span>(UNICODE_NULL);
01774 
01775     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = Length &gt; <a class="code" href="../../d7/d9/assign_8c.html#a14">BUFFERSIZE</a> ? Length : <a class="code" href="../../d7/d9/assign_8c.html#a14">BUFFERSIZE</a>;
01776     U.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, BufferSize);
01777     <span class="keywordflow">if</span> (!U.Buffer) {
01778         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01779     }
01780 
01781     <span class="comment">//</span>
01782     <span class="comment">// Build translated registry name to watch for</span>
01783     <span class="comment">//</span>
01784 
01785     ObNameInfo = (POBJECT_NAME_INFORMATION) Dir-&gt;Buffer;
01786     <span class="keywordflow">if</span> (DeviceObject) {
01787         status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a> (DeviceObject, ObNameInfo, BUFFERSIZE, &amp;Length);
01788         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01789             <span class="keywordflow">return</span> status;
01790         }
01791     } <span class="keywordflow">else</span> {
01792         ObNameInfo-&gt;Name.Length = 0;
01793         ObNameInfo-&gt;Name.Buffer = (PVOID) ((PUCHAR) Dir-&gt;Buffer + <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION));
01794     }
01795 
01796     <span class="comment">//</span>
01797     <span class="comment">// Handle the case when the DeviceObject was created</span>
01798     <span class="comment">// without a name</span>
01799     <span class="comment">//</span>
01800     <span class="keywordflow">if</span> (ObNameInfo-&gt;Name.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01801         ObNameInfo-&gt;Name.Length = 0;
01802         ObNameInfo-&gt;Name.Buffer = (PVOID) ((PUCHAR) Dir-&gt;Buffer + <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION));
01803     }
01804 
01805     ObNameInfo-&gt;Name.MaximumLength = <a class="code" href="../../d7/d9/assign_8c.html#a14">BUFFERSIZE</a> - <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION);
01806     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;ObNameInfo-&gt;Name, IopWstrTranslated);
01807 
01808     TranslatedName.Length = ObNameInfo-&gt;Name.Length;
01809     TranslatedName.MaximumLength = ObNameInfo-&gt;Name.Length;
01810     TranslatedName.Buffer = <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (Dir, TranslatedName.Length);
01811     <span class="keywordflow">if</span> (!TranslatedName.Buffer) {
01812         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01813     }
01814     RtlCopyMemory (TranslatedName.Buffer, ObNameInfo-&gt;Name.Buffer, TranslatedName.Length);
01815     <span class="keywordflow">for</span> (TranslatedStrLen=0; <a class="code" href="../../d7/d9/assign_8c.html#a28">IopWstrTranslated</a>[TranslatedStrLen]; TranslatedStrLen++) ;
01816     <span class="keywordflow">for</span> (BusTranslatedStrLen=0; <a class="code" href="../../d7/d9/assign_8c.html#a29">IopWstrBusTranslated</a>[BusTranslatedStrLen]; BusTranslatedStrLen++) ;
01817     TranslatedStrLen    *= <span class="keyword">sizeof</span> (WCHAR);
01818     BusTranslatedStrLen *= <span class="keyword">sizeof</span> (WCHAR);
01819 
01820     <span class="comment">//</span>
01821     <span class="comment">// Build driver name to watch for</span>
01822     <span class="comment">//</span>
01823 
01824     status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a> (DriverObject, ObNameInfo, BUFFERSIZE, &amp;Length);
01825     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01826         <span class="keywordflow">return</span> status;
01827     }
01828 
01829     i = 0;
01830     pw = ObNameInfo-&gt;Name.Buffer;
01831     <span class="keywordflow">while</span> (*pw) {
01832         <span class="keywordflow">if</span> (*pw++ == OBJ_NAME_PATH_SEPARATOR) {
01833             i = pw - ObNameInfo-&gt;Name.Buffer;
01834         }
01835     }
01836 
01837     Length = ObNameInfo-&gt;Name.Length - i * <span class="keyword">sizeof</span> (WCHAR);
01838     DriverName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) Length;
01839     DriverName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) Length;
01840     DriverName.Buffer = <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (Dir, Length);
01841     <span class="keywordflow">if</span> (!DriverName.Buffer) {
01842         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01843     }
01844     RtlCopyMemory (DriverName.Buffer, ObNameInfo-&gt;Name.Buffer + i, Length);
01845 
01846     <span class="comment">//</span>
01847     <span class="comment">// If no give driver class, use default</span>
01848     <span class="comment">//</span>
01849 
01850     <span class="keywordflow">if</span> (!DriverClassName) {
01851         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;DClassName, IopWstrOtherDrivers );
01852         DriverClassName = &amp;DClassName;
01853     }
01854 
01855     <span class="comment">//</span>
01856     <span class="comment">// Walk resource map and collect any inuse resources</span>
01857     <span class="comment">//</span>
01858 
01859     ResourceMap =  Dir-&gt;RegHandle[<a class="code" href="../../d7/d9/assign_8c.html#a4">HRESOURCE_MAP</a>];
01860     ClassKeyIndex = 0;
01861 
01862     ClassKeyHandle  = <a class="code" href="../../d7/d9/assign_8c.html#a13">INVALID_HANDLE</a>;
01863     DriverKeyHandle = <a class="code" href="../../d7/d9/assign_8c.html#a13">INVALID_HANDLE</a>;
01864 
01865     <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01866 
01867         <span class="comment">//</span>
01868         <span class="comment">// Get the class information</span>
01869         <span class="comment">//</span>
01870 
01871         status = ZwEnumerateKey( ResourceMap,
01872                                  ClassKeyIndex++,
01873                                  KeyBasicInformation,
01874                                  U.KeyBInf,
01875                                  BufferSize,
01876                                  &amp;junk );
01877 
01878         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01879             <span class="keywordflow">break</span>;
01880         }
01881 
01882 
01883         <span class="comment">//</span>
01884         <span class="comment">// Create a UNICODE_STRING using the counted string passed back to</span>
01885         <span class="comment">// us in the information structure, and open the class key.</span>
01886         <span class="comment">//</span>
01887 
01888         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = (PWSTR)  U.KeyBInf-&gt;Name;
01889         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) U.KeyBInf-&gt;NameLength;
01890         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) U.KeyBInf-&gt;NameLength;
01891 
01892         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;ClassKeyHandle,
01893                                      ResourceMap,
01894                                      &amp;KeyName,
01895                                      KEY_READ,
01896                                      FALSE );
01897 
01898         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01899             <span class="keywordflow">break</span>;
01900         }
01901 
01902         <span class="comment">//</span>
01903         <span class="comment">// Check if we are in the same call node.</span>
01904         <span class="comment">//</span>
01905 
01906         sameClass = <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( DriverClassName, &amp;KeyName, TRUE );
01907 
01908         DriverKeyIndex = 0;
01909         <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01910 
01911             <span class="comment">//</span>
01912             <span class="comment">// Get the class information</span>
01913             <span class="comment">//</span>
01914 
01915             status = ZwEnumerateKey( ClassKeyHandle,
01916                                      DriverKeyIndex++,
01917                                      KeyBasicInformation,
01918                                      U.KeyBInf,
01919                                      BufferSize,
01920                                      &amp;junk );
01921 
01922             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01923                 <span class="keywordflow">break</span>;
01924             }
01925 
01926             <span class="comment">//</span>
01927             <span class="comment">// Create a UNICODE_STRING using the counted string passed back to</span>
01928             <span class="comment">// us in the information structure, and open the class key.</span>
01929             <span class="comment">//</span>
01930             <span class="comment">// This is read from the key we created, and the name</span>
01931             <span class="comment">// was NULL terminated.</span>
01932             <span class="comment">//</span>
01933 
01934             <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = (PWSTR) <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (Dir, U.KeyBInf-&gt;NameLength);
01935             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer) {
01936                 status = STATUS_INSUFFICIENT_RESOURCES;
01937                 <span class="keywordflow">break</span>;
01938             }
01939 
01940             RtlCopyMemory (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer, U.KeyBInf-&gt;Name, U.KeyBInf-&gt;NameLength);
01941             <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) U.KeyBInf-&gt;NameLength;
01942             <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) U.KeyBInf-&gt;NameLength;
01943 
01944             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;DriverKeyHandle,
01945                                          ClassKeyHandle,
01946                                          &amp;KeyName,
01947                                          KEY_READ,
01948                                          FALSE );
01949 
01950             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01951                 <span class="keywordflow">break</span>;
01952             }
01953             <span class="comment">//</span>
01954             <span class="comment">// Check if we are in the same call node.</span>
01955             <span class="comment">//</span>
01956 
01957             sameDriver = sameClass &amp;&amp; <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( &amp;DriverName, &amp;KeyName, TRUE );
01958 
01959             <span class="comment">//</span>
01960             <span class="comment">// Get full information for that key so we can get the</span>
01961             <span class="comment">// information about the data stored in the key.</span>
01962             <span class="comment">//</span>
01963 
01964             status = ZwQueryKey( DriverKeyHandle,
01965                                  KeyFullInformation,
01966                                  U.KeyFInf,
01967                                  BufferSize,
01968                                  &amp;junk );
01969 
01970             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01971                 <span class="keywordflow">break</span>;
01972             }
01973 
01974             Length = <span class="keyword">sizeof</span>( KEY_VALUE_FULL_INFORMATION ) +
01975                 U.KeyFInf-&gt;MaxValueNameLen + U.KeyFInf-&gt;MaxValueDataLen + <span class="keyword">sizeof</span>(UNICODE_NULL);
01976 
01977             <span class="keywordflow">if</span> (Length &gt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
01978 
01979                 <span class="comment">//</span>
01980                 <span class="comment">// Get a larger buffer</span>
01981                 <span class="comment">//</span>
01982 
01983                 p2 = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, Length);
01984                 <span class="keywordflow">if</span> (!p2) {
01985                     status = STATUS_INSUFFICIENT_RESOURCES;
01986                     <span class="keywordflow">break</span>;
01987                 }
01988 
01989                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (U.Buffer);
01990                 U.Buffer = p2;
01991                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = Length;
01992             }
01993 
01994             DriverValueIndex = 0;
01995             <span class="keywordflow">for</span> (; ;) {
01996                 status = ZwEnumerateValueKey( DriverKeyHandle,
01997                                               DriverValueIndex++,
01998                                               KeyValueFullInformation,
01999                                               U.VKeyFInf,
02000                                               BufferSize,
02001                                               &amp;junk );
02002 
02003                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02004                     <span class="keywordflow">break</span>;
02005                 }
02006 
02007                 <span class="comment">//</span>
02008                 <span class="comment">// If this is not a translated resource list, skip it.</span>
02009                 <span class="comment">//</span>
02010 
02011                 i = U.VKeyFInf-&gt;NameLength;
02012                 <span class="keywordflow">if</span> (i &lt; TranslatedStrLen ||
02013                     RtlCompareMemory (
02014                         ((PUCHAR) U.VKeyFInf-&gt;Name) + i - TranslatedStrLen,
02015                         IopWstrTranslated,
02016                         TranslatedStrLen
02017                         ) != TranslatedStrLen
02018                     ) {
02019                     <span class="comment">// does not end in IopWstrTranslated</span>
02020                     <span class="keywordflow">continue</span>;
02021                 }
02022 
02023                 <span class="comment">//</span>
02024                 <span class="comment">// If this is a bus translated resource list, ????</span>
02025                 <span class="comment">//</span>
02026 
02027                 <span class="keywordflow">if</span> (i &gt;= BusTranslatedStrLen &amp;&amp;
02028                     RtlCompareMemory (
02029                         ((PUCHAR) U.VKeyFInf-&gt;Name) + i - BusTranslatedStrLen,
02030                         IopWstrBusTranslated,
02031                         BusTranslatedStrLen
02032                         ) == BusTranslatedStrLen
02033                     ) {
02034 
02035                     <span class="comment">// ends in IopWstrBusTranslated</span>
02036                     <span class="keywordflow">continue</span>;
02037                 }
02038 
02039                 <span class="comment">//</span>
02040                 <span class="comment">// If these used resources are from the caller, then skip them</span>
02041                 <span class="comment">//</span>
02042 
02043                 <span class="keywordflow">if</span> (sameDriver) {
02044                     unicodeString.Buffer = (PWSTR)  U.VKeyFInf-&gt;Name;
02045                     unicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) U.VKeyFInf-&gt;NameLength;
02046                     unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) U.VKeyFInf-&gt;NameLength;
02047                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;unicodeString, &amp;TranslatedName, TRUE)) {
02048                         <span class="comment">// it's the current allocated resources for this caller.</span>
02049                         <span class="comment">// skip this entry.</span>
02050                         <span class="keywordflow">continue</span>;
02051                     }
02052                 }
02053 
02054                 <span class="comment">//</span>
02055                 <span class="comment">// Build Owner structure for TLIST entries</span>
02056                 <span class="comment">//</span>
02057 
02058                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (Dir, <span class="keyword">sizeof</span> (*Owner) + U.VKeyFInf-&gt;NameLength);
02059                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>) {
02060                     status = STATUS_INSUFFICIENT_RESOURCES;
02061                     <span class="keywordflow">break</span>;
02062                 }
02063 
02064                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;InConflict.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02065                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;DeviceName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02066 
02067                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;KeyName.Buffer = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer;
02068                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;KeyName.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length;
02069                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;KeyName.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength;
02070 
02071                 <span class="keywordflow">if</span> (U.VKeyFInf-&gt;Name[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>) {
02072                     <span class="comment">// strip off the .Translated part of the string</span>
02073                     U.VKeyFInf-&gt;NameLength -= TranslatedStrLen;
02074 
02075                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;DeviceName.Buffer = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;UnicodeBuffer;
02076                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;DeviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) U.VKeyFInf-&gt;NameLength;
02077                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;DeviceName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) U.VKeyFInf-&gt;NameLength;
02078                     RtlCopyMemory (<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;UnicodeBuffer, U.VKeyFInf-&gt;Name, U.VKeyFInf-&gt;NameLength);
02079                 }
02080 
02081                 <span class="comment">//</span>
02082                 <span class="comment">// Run the CmResourceList and save each InUse resource</span>
02083                 <span class="comment">//</span>
02084 
02085                 CmResList = (PCM_RESOURCE_LIST) ( (PUCHAR) U.VKeyFInf + U.VKeyFInf-&gt;DataOffset);
02086                 LastAddr  = (PUCHAR) CmResList + U.VKeyFInf-&gt;DataLength;
02087 
02088                 CmFResDesc = CmResList-&gt;List;
02089                 <span class="keywordflow">for</span> (i=0; i &lt; CmResList-&gt;Count &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ; i++) {
02090                     CmDesc = CmFResDesc-&gt;PartialResourceList.PartialDescriptors;
02091                     <span class="keywordflow">if</span> ((PUCHAR) (CmDesc+1) &gt; LastAddr) {
02092                         <span class="keywordflow">if</span> (i) {
02093                             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopAssignResourcesPhase2: a. CmResourceList in regitry too short\n"</span>);
02094                         }
02095                         <span class="keywordflow">break</span>;
02096                     }
02097 
02098                     <span class="keywordflow">for</span> (j=0; j &lt; CmFResDesc-&gt;PartialResourceList.Count &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status); j++) {
02099                         <span class="keywordflow">if</span> ((PUCHAR) (CmDesc+1) &gt; LastAddr) {
02100                             i = CmResList-&gt;Count;
02101                             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopAssignResourcesPhase2: b. CmResourceList in regitry too short\n"</span>);
02102                             <span class="keywordflow">break</span>;
02103                         }
02104 
02105                         <span class="comment">//</span>
02106                         <span class="comment">// Add this CmDesc to the InUse list</span>
02107                         <span class="comment">//</span>
02108 
02109                         <span class="keywordflow">if</span> (CmDesc-&gt;ShareDisposition == CmResourceShareShared) {
02110                             status = <a class="code" href="../../d7/d9/assign_8c.html#a49">IopAddCmDescriptorToInUseList</a> (
02111                                         Dir,
02112                                         &amp;Dir-&gt;InUseSharableResources,
02113                                         CmDesc,
02114                                         Owner
02115                                     );
02116                         } <span class="keywordflow">else</span> {
02117                             status = <a class="code" href="../../d7/d9/assign_8c.html#a49">IopAddCmDescriptorToInUseList</a> (
02118                                         Dir,
02119                                         &amp;Dir-&gt;InUseResources,
02120                                         CmDesc,
02121                                         Owner
02122                                     );
02123 
02124                         }
02125                         CmDesc++;
02126                     }
02127 
02128                     CmFResDesc = (PCM_FULL_RESOURCE_DESCRIPTOR) CmDesc;
02129                 }
02130 
02131             }   <span class="comment">// next DriverValueIndex</span>
02132 
02133             <span class="keywordflow">if</span> (DriverKeyHandle != <a class="code" href="../../d7/d9/assign_8c.html#a13">INVALID_HANDLE</a>) {
02134                 ZwClose (DriverKeyHandle);
02135                 DriverKeyHandle = <a class="code" href="../../d7/d9/assign_8c.html#a13">INVALID_HANDLE</a>;
02136             }
02137 
02138             <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
02139                 status = STATUS_SUCCESS;
02140             }
02141 
02142             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02143                 <span class="keywordflow">break</span>;
02144             }
02145         }   <span class="comment">// next DriverKeyIndex</span>
02146 
02147         <span class="keywordflow">if</span> (ClassKeyHandle != <a class="code" href="../../d7/d9/assign_8c.html#a13">INVALID_HANDLE</a>) {
02148             ZwClose (ClassKeyHandle);
02149             ClassKeyHandle = <a class="code" href="../../d7/d9/assign_8c.html#a13">INVALID_HANDLE</a>;
02150         }
02151 
02152         <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
02153             status = STATUS_SUCCESS;
02154         }
02155 
02156     }   <span class="comment">// next ClassKeyIndex</span>
02157 
02158     <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
02159         status = STATUS_SUCCESS;
02160     }
02161 
02162 
02163     <span class="comment">//</span>
02164     <span class="comment">// All reported resources are read in.</span>
02165     <span class="comment">// Now read in ...SystemResources\ReservedResources</span>
02166     <span class="comment">//  (note: this infomration could easily be cached if needed)</span>
02167     <span class="comment">//</span>
02168 
02169     <span class="comment">//</span>
02170     <span class="comment">// Build owner for all ResevedResources</span>
02171     <span class="comment">//</span>
02172 
02173     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (Dir, <span class="keyword">sizeof</span> (*Owner) + U.VKeyFInf-&gt;NameLength);
02174     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>) {
02175         <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;InConflict.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02176         <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;DeviceName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02177         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;KeyName, IopWstrReservedResources);
02178     }
02179 
02180     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
02181     <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02182         status = ZwEnumerateValueKey( Dir-&gt;RegHandle[HRESERVEDRESOURCES],
02183                                       Index++,
02184                                       KeyValueFullInformation,
02185                                       U.VKeyFInf,
02186                                       BufferSize,
02187                                       &amp;junk );
02188 
02189         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02190             <span class="keywordflow">break</span>;
02191         }
02192 
02193         <span class="comment">//</span>
02194         <span class="comment">// Run the CmResourceList and save each InUse resource</span>
02195         <span class="comment">//</span>
02196 
02197         CmResList = (PCM_RESOURCE_LIST) ( (PUCHAR) U.VKeyFInf + U.VKeyFInf-&gt;DataOffset);
02198         LastAddr  = (PUCHAR) CmResList + U.VKeyFInf-&gt;DataLength;
02199 
02200         CmFResDesc = CmResList-&gt;List;
02201         <span class="keywordflow">for</span> (i=0; i &lt; CmResList-&gt;Count &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ; i++) {
02202             CmDesc = CmFResDesc-&gt;PartialResourceList.PartialDescriptors;
02203             <span class="keywordflow">if</span> ((PUCHAR) (CmDesc+1) &gt; LastAddr) {
02204                 <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopAssignResourcesPhase2: c. CmResourceList in regitry too short\n"</span>);
02205                 <span class="keywordflow">break</span>;
02206             }
02207 
02208             <span class="keywordflow">for</span> (j=0; j &lt; CmFResDesc-&gt;PartialResourceList.Count &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status); j++) {
02209                 <span class="keywordflow">if</span> ((PUCHAR) (CmDesc+1) &gt; LastAddr) {
02210                     i = CmResList-&gt;Count;
02211                     <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopAssignResourcesPhase2: d. CmResourceList in regitry too short\n"</span>);
02212                     <span class="keywordflow">break</span>;
02213                 }
02214 
02215                 <span class="comment">//</span>
02216                 <span class="comment">// Translate this descriptor to it's TRANSLATED values</span>
02217                 <span class="comment">//</span>
02218 
02219                 <span class="keywordflow">switch</span> (CmDesc-&gt;Type) {
02220                     <span class="keywordflow">case</span> CmResourceTypePort:
02221                     <span class="keywordflow">case</span> CmResourceTypeMemory:
02222                         junk = CmDesc-&gt;Type == CmResourceTypePort ? 1 : 0;
02223                         li = *((LONGLONG UNALIGNED *) &amp;CmDesc-&gt;u.Port.Start);
02224                         flag = <a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a> (
02225                             CmFResDesc-&gt;InterfaceType,
02226                             CmFResDesc-&gt;BusNumber,
02227                             *((PPHYSICAL_ADDRESS) &amp;li),
02228                             &amp;junk,
02229                             (PPHYSICAL_ADDRESS) &amp;li
02230                             );
02231                         *((LONGLONG UNALIGNED *) &amp;CmDesc-&gt;u.Port.Start) = li;
02232                         CmDesc-&gt;Type = junk == 1 ? CmResourceTypePort : CmResourceTypeMemory;
02233                         <span class="keywordflow">break</span>;
02234 
02235                     <span class="keywordflow">case</span> CmResourceTypeInterrupt:
02236                         CmDesc-&gt;u.Interrupt.Vector = <a class="code" href="../../d2/d7/hal_8h.html#a181">HalGetInterruptVector</a> (
02237                             CmFResDesc-&gt;InterfaceType,
02238                             CmFResDesc-&gt;BusNumber,
02239                             CmDesc-&gt;u.Interrupt.Vector,     <span class="comment">// bus level</span>
02240                             CmDesc-&gt;u.Interrupt.Vector,     <span class="comment">// bus vector</span>
02241                             (PKIRQL) &amp;junk,                 <span class="comment">// translated level</span>
02242                             &amp;CmDesc-&gt;u.Interrupt.Affinity
02243                             );
02244                        flag = CmDesc-&gt;u.Interrupt.Affinity == 0 ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02245                        <span class="keywordflow">break</span>;
02246 
02247                     <span class="keywordflow">case</span> CmResourceTypeDma:
02248                         <span class="comment">// no translation</span>
02249                         flag = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02250                         <span class="keywordflow">break</span>;
02251 
02252                     <span class="keywordflow">default</span>:
02253                         flag = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02254                         <span class="keywordflow">break</span>;
02255                 }
02256 
02257                 <span class="keywordflow">if</span> (flag) {
02258 
02259                     <span class="comment">//</span>
02260                     <span class="comment">// Add it to the appropiate tlist</span>
02261                     <span class="comment">//</span>
02262 
02263                     <span class="keywordflow">if</span> (CmDesc-&gt;ShareDisposition == CmResourceShareShared) {
02264                         status = <a class="code" href="../../d7/d9/assign_8c.html#a49">IopAddCmDescriptorToInUseList</a> (
02265                                     Dir,
02266                                     &amp;Dir-&gt;ReservedSharableResources,
02267                                     CmDesc,
02268                                     Owner
02269                                 );
02270                     } <span class="keywordflow">else</span> {
02271                         status = <a class="code" href="../../d7/d9/assign_8c.html#a49">IopAddCmDescriptorToInUseList</a> (
02272                                     Dir,
02273                                     &amp;Dir-&gt;InUseResources,
02274                                     CmDesc,
02275                                     Owner
02276                                 );
02277                     }
02278                 }
02279 
02280                 CmDesc++;
02281             }
02282 
02283             CmFResDesc = (PCM_FULL_RESOURCE_DESCRIPTOR) CmDesc;
02284         }
02285 
02286     }   <span class="comment">// Next ReservedResource</span>
02287 
02288     <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
02289         status = STATUS_SUCCESS;
02290     }
02291 
02292     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (U.Buffer);
02293     <span class="keywordflow">return</span> status;
02294 }
02295 
02296 <span class="preprocessor">#if 0</span>
02297 <span class="preprocessor"></span><a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>
02298 <a class="code" href="../../d7/d9/assign_8c.html#a44">IopAssignResourcesPhase3</a> (
02299     IN PDIR_RESREQ_LIST     Dir
02300     )
02301 <span class="comment">/*++</span>
02302 <span class="comment"></span>
02303 <span class="comment">Routine Description:</span>
02304 <span class="comment"></span>
02305 <span class="comment">    All the information to process the requested resource assignments has</span>
02306 <span class="comment">    been read in &amp; parsed.  Phase3 cranks out the resource assignments.</span>
02307 <span class="comment"></span>
02308 <span class="comment">Arguments:</span>
02309 <span class="comment"></span>
02310 <span class="comment">--*/</span>
02311 {
02312     <a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>      CurList, BestList;
02313     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>  ReqRes;
02314     ULONG                   level, i, j;
02315     LONG                    BestPref, Pref;
02316 
02317     <span class="comment">//</span>
02318     <span class="comment">// Run each list as pass 1</span>
02319     <span class="comment">//</span>
02320 
02321     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02322 
02323     <span class="keywordflow">for</span> (CurList = Dir-&gt;Alternative; CurList; CurList = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">Next</a>) {
02324 
02325         <span class="comment">// set to pass 1</span>
02326         <span class="keywordflow">for</span> (i=0; i &lt; CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>; i++) {
02327             CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[i]-&gt;PassNo = 1;
02328         }
02329 
02330         <span class="comment">// find resouce settings for this list</span>
02331         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/assign_8c.html#a57">IopGenNextValidResourceList</a> (0, CurList, Dir)) {
02332 
02333             <span class="comment">// found good settings, return them</span>
02334             <span class="keywordflow">return</span> CurList;
02335         }
02336     }
02337 
02338     <span class="comment">//</span>
02339     <span class="comment">// Try again - set last checked resource in any given list to pass2 to see if that will</span>
02340     <span class="comment">// unclog the problem.</span>
02341     <span class="comment">//</span>
02342 
02343     <a class="code" href="../../d7/d9/assign_8c.html#a20">IDBGMSG</a> (<span class="stringliteral">"First pass attempt at resource settings failed\n"</span>);
02344 
02345     <span class="keywordflow">for</span> (CurList = Dir-&gt;Alternative; CurList; CurList = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">Next</a>) {
02346         <span class="keywordflow">for</span> (; ;) {
02347             <span class="comment">//</span>
02348             <span class="comment">// Reset last level tried to look for any settings</span>
02349             <span class="comment">//</span>
02350 
02351             level = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o3">LastLevel</a>;
02352             ReqRes = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level];
02353             <span class="keywordflow">if</span> (ReqRes-&gt;PassNo != 1) {
02354                 <span class="comment">// already trying pass 2 on this level</span>
02355                 <span class="keywordflow">break</span>;
02356             }
02357 
02358             ReqRes-&gt;PassNo = 2;
02359             <span class="keywordflow">for</span> (j=0; j &lt; ReqRes-&gt;NoAlternatives; j++) {
02360                 ReqRes-&gt;IoResourceDescriptor[j]-&gt;Option &amp;= ~IO_RESOURCE_PREFERRED;
02361             }
02362 
02363             <span class="comment">//</span>
02364             <span class="comment">// Back up to failed level and see if this list can now be satisfied</span>
02365             <span class="comment">//</span>
02366 
02367             level = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>;
02368             <span class="keywordflow">while</span> (level &gt; CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o4">FailedLevel</a>) {
02369                 level--;
02370                 CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;CurLoc = 0;
02371                 CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;RunLen = 0;
02372             }
02373 
02374             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/assign_8c.html#a57">IopGenNextValidResourceList</a> (level, CurList, Dir)) {
02375                 <span class="comment">// found good settings, return them</span>
02376                 <span class="keywordflow">return</span> CurList;
02377             }
02378 
02379         }   <span class="comment">// loop and clear next failed level</span>
02380     }   <span class="comment">// loop and try next list</span>
02381 
02382     <span class="comment">//</span>
02383     <span class="comment">// Try again, this time allow for a complete search.  Clear all preferred settings and</span>
02384     <span class="comment">// move all levels to Pass2</span>
02385     <span class="comment">//</span>
02386 
02387     <a class="code" href="../../d7/d9/assign_8c.html#a20">IDBGMSG</a> (<span class="stringliteral">"Pass 2 attempt at resource settings failed\n"</span>);
02388 
02389     <span class="keywordflow">for</span> (CurList = Dir-&gt;Alternative; CurList; CurList = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">Next</a>) {
02390         <span class="keywordflow">for</span> (i=0; i &lt; CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>; i++) {
02391             ReqRes = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[i];
02392             ReqRes-&gt;CurLoc = 0;
02393             ReqRes-&gt;RunLen = 0;
02394             ReqRes-&gt;PassNo = 2;
02395 
02396             <span class="keywordflow">for</span> (j=0; j &lt; ReqRes-&gt;NoAlternatives; j++) {
02397                 ReqRes-&gt;IoResourceDescriptor[j]-&gt;Option &amp;= ~IO_RESOURCE_PREFERRED;
02398             }
02399         }
02400     }
02401 
02402     BestPref = -999999;
02403     BestList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02404     CurList  = Dir-&gt;Alternative;
02405     level    = 0;
02406 
02407     <span class="keywordflow">while</span> (CurList) {
02408 
02409         <span class="comment">// find resouce settings for this list</span>
02410         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/assign_8c.html#a57">IopGenNextValidResourceList</a> (level, CurList, Dir)) {
02411 
02412             <span class="comment">//</span>
02413             <span class="comment">// We have useable settings, check to see how useable</span>
02414             <span class="comment">//</span>
02415 
02416             <span class="keywordflow">if</span> (CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o2">CurPref</a> &gt;= 0) {
02417                 <span class="comment">//</span>
02418                 <span class="comment">// Nothing wrong with these settings, go use them</span>
02419                 <span class="comment">//</span>
02420 
02421                 <a class="code" href="../../d7/d9/assign_8c.html#a20">IDBGMSG</a> (<span class="stringliteral">"Pass3: Good hit\n"</span>);
02422                 <span class="keywordflow">return</span> CurList;
02423             }
02424 
02425             <span class="keywordflow">if</span> (CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o2">CurPref</a> &gt; BestPref) {
02426 
02427                 <span class="comment">//</span>
02428                 <span class="comment">// These are the best so far, remember them</span>
02429                 <span class="comment">//</span>
02430 
02431                 BestPref = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o2">CurPref</a>;
02432                 BestList = CurList;
02433 
02434                 <span class="keywordflow">for</span> (i = 0; i &lt; CurList-&gt;NoRequiredResources; i++) {
02435                     ReqRes = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[i];
02436                     ReqRes-&gt;Pass2HoldCurLoc = ReqRes-&gt;CurBLoc;
02437                     ReqRes-&gt;Pass2HoldBAddr  = ReqRes-&gt;CurBAddr;
02438                 }
02439             }
02440 
02441             <span class="comment">//</span>
02442             <span class="comment">// Determine which level to back up too to continue searching from</span>
02443             <span class="comment">//</span>
02444 
02445             Pref  = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o2">CurPref</a>;
02446             level = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>;
02447             <span class="keywordflow">while</span> (level  &amp;&amp;  Pref &lt;= BestPref) {
02448                 level--;
02449                 Pref -= CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;CurPref;
02450                 CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;CurLoc = 0;
02451                 CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;RunLen = 0;
02452             }
02453 
02454             <span class="keywordflow">if</span> (CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;PrefCnt &gt; 16) {
02455                 <span class="keywordflow">while</span> (level  &amp;&amp;  CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;PrefCnt &gt; 16) {
02456                     level--;
02457                     Pref -= CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;CurPref;
02458                     CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;CurLoc = 0;
02459                     CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;RunLen = 0;
02460                 }
02461 
02462                 <span class="keywordflow">if</span> (level == 0) {
02463                     <span class="comment">// go with best setting so far</span>
02464                     <span class="keywordflow">break</span>;
02465                 }
02466             }
02467 
02468             CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[level]-&gt;PrefCnt++;
02469             <span class="keywordflow">continue</span> ;
02470         }
02471 
02472         <span class="comment">// no (more) valid settings found on this list, try the next</span>
02473         CurList = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">Next</a>;
02474         level = 0;
02475     }
02476 
02477     <span class="keywordflow">if</span> (!BestList) {
02478         <span class="comment">// failure</span>
02479         <a class="code" href="../../d7/d9/assign_8c.html#a20">IDBGMSG</a> (<span class="stringliteral">"Pass3: No settings found\n"</span>);
02480         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02481     }
02482 
02483     <span class="comment">//</span>
02484     <span class="comment">// Return best settings which were found</span>
02485     <span class="comment">//</span>
02486 
02487     <span class="keywordflow">for</span> (i = 0; i &lt; BestList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>; i++) {
02488         ReqRes = BestList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[i];
02489         ReqRes-&gt;CurBLoc  = ReqRes-&gt;Pass2HoldCurLoc;
02490         ReqRes-&gt;CurBAddr = ReqRes-&gt;Pass2HoldBAddr;
02491     }
02492 
02493     <span class="keywordflow">return</span> BestList;
02494 }
02495 
02496 PCM_RESOURCE_LIST
02497 <a class="code" href="../../d7/d9/assign_8c.html#a45">IopAssignResourcesPhase4</a> (
02498     IN PDIR_RESREQ_LIST     Dir,
02499     IN PDIR_RESOURCE_LIST   CurList,
02500     OUT PULONG              Length
02501     )
02502 <span class="comment">/*++</span>
02503 <span class="comment"></span>
02504 <span class="comment">Routine Description:</span>
02505 <span class="comment"></span>
02506 <span class="comment">    The callers request for resources has been calculated.  Phase 4 builds</span>
02507 <span class="comment">    a CM_RESOURCE_LIST of the allocated resources.</span>
02508 <span class="comment"></span>
02509 <span class="comment">    This functions need CurDesc-&gt;CurBLoc &amp; CurDesc-&gt;CurBAddr as passed from Phase3.</span>
02510 <span class="comment"></span>
02511 <span class="comment">Arguments:</span>
02512 <span class="comment"></span>
02513 <span class="comment">--*/</span>
02514 {
02515     PCM_RESOURCE_LIST                   CmRes;
02516     PCM_PARTIAL_RESOURCE_DESCRIPTOR     CmDesc;
02517     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>              DirDesc, *pDirDesc;
02518     PIO_RESOURCE_DESCRIPTOR             IoDesc;
02519     ULONG                               i, cnt, len;
02520 
02521     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02522 
02523     cnt = CurList-&gt;NoRequiredResources;
02524     len = <span class="keyword">sizeof</span> (CM_RESOURCE_LIST) + cnt * <span class="keyword">sizeof</span> (CM_PARTIAL_RESOURCE_DESCRIPTOR);
02525     *Length = len;
02526 
02527     CmRes = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, len);
02528     <span class="keywordflow">if</span> (!CmRes) {
02529         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02530     }
02531 
02532     RtlZeroMemory (CmRes, len);
02533 
02534     CmRes-&gt;Count = 1;
02535     CmRes-&gt;List[0].InterfaceType = Dir-&gt;IoResourceReq-&gt;InterfaceType;
02536     CmRes-&gt;List[0].BusNumber = Dir-&gt;IoResourceReq-&gt;BusNumber;
02537     CmRes-&gt;List[0].PartialResourceList.Count = CurList-&gt;NoRequiredResources;
02538 
02539     CmDesc   = CmRes-&gt;List[0].PartialResourceList.PartialDescriptors;
02540     pDirDesc = CurList-&gt;RequiredResource;       <span class="comment">// return resources in same order they</span>
02541                                                 <span class="comment">// where requested</span>
02542 <span class="preprocessor">#if IDBG</span>
02543 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Acquired Resourses - %d\n"</span>, CurList-&gt;NoRequiredResources);
02544 <span class="preprocessor">#endif</span>
02545 <span class="preprocessor"></span>
02546     <span class="keywordflow">for</span> (i=0; i &lt; cnt; i++, CmDesc++, pDirDesc++) {
02547         DirDesc = *pDirDesc;
02548         IoDesc  = DirDesc-&gt;IoResourceDescriptor[DirDesc-&gt;CurBLoc];
02549 
02550         CmDesc-&gt;Type = IoDesc-&gt;Type;
02551         CmDesc-&gt;ShareDisposition = IoDesc-&gt;ShareDisposition;
02552         CmDesc-&gt;Flags = IoDesc-&gt;Flags;
02553 
02554         <span class="keywordflow">switch</span> (CmDesc-&gt;Type) {
02555             <span class="keywordflow">case</span> CmResourceTypePort:
02556                 CmDesc-&gt;u.Port.Start.QuadPart = DirDesc-&gt;CurBAddr;
02557                 CmDesc-&gt;u.Port.Length         = IoDesc-&gt;u.Port.Length;
02558 <span class="preprocessor">#if IDBG</span>
02559 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"    IO  Start %x:%08x, Len %x\n"</span>,
02560                     CmDesc-&gt;u.Port.Start.HighPart, CmDesc-&gt;u.Port.Start.LowPart,
02561                     CmDesc-&gt;u.Port.Length );
02562 <span class="preprocessor">#endif</span>
02563 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
02564 
02565             <span class="keywordflow">case</span> CmResourceTypeMemory:
02566                 CmDesc-&gt;u.Memory.Start.QuadPart = DirDesc-&gt;CurBAddr;
02567                 CmDesc-&gt;u.Memory.Length         = IoDesc-&gt;u.Memory.Length;
02568 <span class="preprocessor">#if IDBG</span>
02569 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"    MEM Start %x:%08x, Len %x\n"</span>,
02570                     CmDesc-&gt;u.Memory.Start.HighPart, CmDesc-&gt;u.Memory.Start.LowPart,
02571                     CmDesc-&gt;u.Memory.Length );
02572 <span class="preprocessor">#endif</span>
02573 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
02574 
02575             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
02576                 CmDesc-&gt;u.Interrupt.Level  = (ULONG) DirDesc-&gt;CurBAddr;
02577                 CmDesc-&gt;u.Interrupt.Vector = (ULONG) DirDesc-&gt;CurBAddr;
02578 <span class="preprocessor">#if IDBG</span>
02579 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"    INT Level %x, Vector %x\n"</span>,
02580                     CmDesc-&gt;u.Interrupt.Level, CmDesc-&gt;u.Interrupt.Vector );
02581 <span class="preprocessor">#endif</span>
02582 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
02583 
02584             <span class="keywordflow">case</span> CmResourceTypeDma:
02585                 CmDesc-&gt;u.Dma.Channel = (ULONG) DirDesc-&gt;CurBAddr;
02586 <span class="preprocessor">#if IDBG</span>
02587 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"    DMA Channel %x\n"</span>, CmDesc-&gt;u.Dma.Channel);
02588 <span class="preprocessor">#endif</span>
02589 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
02590 
02591             <span class="keywordflow">default</span>:
02592                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CmRes);
02593                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02594         }
02595     }
02596 
02597     <span class="keywordflow">return</span> CmRes;
02598 }
02599 
02600 <a class="code" href="../../d7/d9/assign_8c.html#a3">STATIC</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02601 <a class="code" href="../../d7/d9/assign_8c.html#a46">IopLogConflict</a> (
02602     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>       DriverObject,
02603     IN PDIR_RESREQ_LIST     Dir,
02604     IN NTSTATUS             FinalStatus
02605     )
02606 <span class="comment">/*++</span>
02607 <span class="comment"></span>
02608 <span class="comment">Routine Description:</span>
02609 <span class="comment"></span>
02610 <span class="comment">    Resource settings could not be satisfied.  Locate first resource</span>
02611 <span class="comment">    which can not be assigned and report the conflict.</span>
02612 <span class="comment"></span>
02613 <span class="comment">Arguments:</span>
02614 <span class="comment"></span>
02615 <span class="comment">--*/</span>
02616 {
02617     PIO_ERROR_LOG_PACKET    ErrLog;
02618     <a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>      CurList;
02619     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>  ReqRes;
02620     ULONG                   i, j;
02621     ULONG                   len, ErrorLogNumber, ErrLogBufferLeft;
02622     ULONG                   ConflictLevel;
02623     UCHAR                   s[8];
02624     PWCHAR                  pLog;
02625     <a class="code" href="../../d9/d5/structPOWNER.html">POWNER</a>                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
02626 
02627     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02628 
02629     <a class="code" href="../../d7/d9/assign_8c.html#a20">IDBGMSG</a> (<span class="stringliteral">"\n****\n"</span>);
02630     <a class="code" href="../../d7/d9/assign_8c.html#a20">IDBGMSG</a> (<span class="stringliteral">"Failed to satisfy the following required resource\n"</span>);
02631 
02632     ErrLog = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02633     ErrorLogNumber = 0;
02634 
02635     <span class="comment">//</span>
02636     <span class="comment">// There's a conflict in each alternative list</span>
02637     <span class="comment">//</span>
02638 
02639     <span class="keywordflow">for</span> (CurList = Dir-&gt;Alternative; CurList; CurList = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">Next</a>) {
02640 
02641         <span class="comment">//</span>
02642         <span class="comment">// Clear position  (already on pass 2)</span>
02643         <span class="comment">//</span>
02644 
02645         <span class="keywordflow">for</span> (i=0; i &lt; CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>; i++) {
02646             CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[i]-&gt;CurLoc = 0;
02647             CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[i]-&gt;RunLen = 0;
02648             CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[i]-&gt;PassNo = 2;
02649         }
02650 
02651         <span class="comment">//</span>
02652         <span class="comment">// Look for settings - set ConflictLevel to pass 3 to track where the problem is</span>
02653         <span class="comment">//</span>
02654 
02655         ConflictLevel = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o4">FailedLevel</a>;
02656         CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[ConflictLevel]-&gt;PassNo = 3;
02657 
02658         InitializeListHead (&amp;CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o5">OtherConflicts</a>);
02659 
02660         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/assign_8c.html#a57">IopGenNextValidResourceList</a> (0, CurList, Dir)) {
02661             <a class="code" href="../../d7/d9/assign_8c.html#a20">IDBGMSG</a> (<span class="stringliteral">"IopLogConflict: internal error\n"</span>);
02662             <span class="keywordflow">continue</span> ;
02663         }
02664 
02665 <span class="preprocessor">#if IDBG</span>
02666 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CurList != Dir-&gt;Alternative) {
02667             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"the following alternate resource also failed\n"</span>);
02668         }
02669 
02670         s[0] = s[1] = s[2] = s[3] = <span class="charliteral">' '</span>;
02671         s[4] = 0;
02672 
02673         ReqRes = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[ConflictLevel];
02674         <span class="keywordflow">for</span> (j=0; j &lt; ReqRes-&gt;NoAlternatives; j++) {
02675             IopDumpIoResourceDescriptor (s, ReqRes-&gt;IoResourceDescriptor[j]);
02676         }
02677 
02678 
02679         i = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o0">NoConflicts</a>;
02680         <span class="keywordflow">if</span> (i &gt; <a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>) {
02681             i = <a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>;
02682         }
02683         <span class="keywordflow">for</span> (j=0; j &lt; i; j++) {
02684             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"  Conflict # %d. "</span>, j+1);
02685             <span class="keywordflow">switch</span> (CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].Type) {
02686                 <span class="keywordflow">case</span> CmResourceTypePort:
02687                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"IO  Base %08x"</span>,  (ULONG) CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].BAddr);
02688                     <span class="keywordflow">break</span>;
02689 
02690                 <span class="keywordflow">case</span> CmResourceTypeMemory:
02691                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MEM Base %08x"</span>,  (ULONG) CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].BAddr);
02692                     <span class="keywordflow">break</span>;
02693 
02694                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
02695                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"INT Line %x"</span>,    (ULONG) CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].BAddr);
02696                     <span class="keywordflow">break</span>;
02697 
02698                 <span class="keywordflow">case</span> CmResourceTypeDma:
02699                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"DMA Channel %x"</span>, (ULONG) CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].BAddr);
02700                     <span class="keywordflow">break</span>;
02701             }
02702 
02703             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">" with '%wZ' "</span>, &amp;CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].Owner-&gt;KeyName);
02704             <span class="keywordflow">if</span> (CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].Owner-&gt;DeviceName.Buffer) {
02705                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"'%wZ'"</span>, &amp;CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].Owner-&gt;DeviceName);
02706             }
02707             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"\n"</span>);
02708         }
02709 
02710         <span class="keywordflow">if</span> (CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o0">NoConflicts</a> &gt; <a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>) {
02711             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"  ...\n"</span>);
02712             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Total Conflicts = %d\n"</span>, CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o0">NoConflicts</a>);
02713         }
02714 
02715         <span class="keywordflow">if</span> (!IsListEmpty (&amp;CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o5">OtherConflicts</a>)) {
02716             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Possible settings also conflicts with the following list\n"</span>);
02717             <span class="comment">// bugbug - not done</span>
02718         }
02719 <span class="preprocessor">#endif</span>
02720 <span class="preprocessor"></span>
02721         <span class="comment">//</span>
02722         <span class="comment">// Loop for each easy conflict</span>
02723         <span class="comment">//</span>
02724 
02725         i = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o0">NoConflicts</a>;
02726         <span class="keywordflow">if</span> (i &gt; <a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>) {
02727             i = <a class="code" href="../../d7/d9/assign_8c.html#a16">SCONFLICT</a>;
02728         }
02729 
02730         <span class="keywordflow">for</span> (j=0; j &lt; i; j++) {
02731             <span class="keywordflow">if</span> (ErrorLogNumber &gt;= 3) {
02732                 <span class="comment">//</span>
02733                 <span class="comment">// only add n logs for a given problem</span>
02734                 <span class="comment">//</span>
02735                 <span class="keywordflow">break</span>;
02736             }
02737 
02738             <span class="comment">//</span>
02739             <span class="comment">// Allocate a new error log structure</span>
02740             <span class="comment">//</span>
02741 
02742             ErrorLogNumber += 1;
02743             ErrLog = <a class="code" href="../../d4/d6/iosubs_8c.html#a14">IoAllocateErrorLogEntry</a> (DriverObject, ERROR_LOG_MAXIMUM_SIZE);
02744             <span class="keywordflow">if</span> (!ErrLog) {
02745                 <span class="keywordflow">break</span>;
02746             }
02747 
02748             <span class="comment">//</span>
02749             <span class="comment">// Initialize errorlog field and counts to append strings</span>
02750             <span class="comment">//</span>
02751 
02752             RtlZeroMemory (ErrLog, <span class="keyword">sizeof</span> (*ErrLog));
02753             ErrLog-&gt;FinalStatus = FinalStatus;
02754             ErrLog-&gt;UniqueErrorValue = ErrorLogNumber;
02755             ErrLog-&gt;NumberOfStrings = 2;
02756             pLog = (PWCHAR) ErrLog-&gt;DumpData;
02757             ErrLog-&gt;StringOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ( ((PUCHAR) pLog) - ((PUCHAR) ErrLog) );
02758             ErrLogBufferLeft = (ERROR_LOG_MAXIMUM_SIZE - ErrLog-&gt;StringOffset) / <span class="keyword">sizeof</span>(WCHAR);
02759 
02760             <span class="keywordflow">switch</span> (CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].Type) {
02761                 <span class="keywordflow">case</span> CmResourceTypePort:
02762                     ErrLog-&gt;ErrorCode = IO_ERR_PORT_RESOURCE_CONFLICT;
02763                     <span class="keywordflow">break</span>;
02764 
02765                 <span class="keywordflow">case</span> CmResourceTypeMemory:
02766                     ErrLog-&gt;ErrorCode = IO_ERR_MEMORY_RESOURCE_CONFLICT;
02767                     <span class="keywordflow">break</span>;
02768 
02769                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
02770                     ErrLog-&gt;ErrorCode = IO_ERR_INTERRUPT_RESOURCE_CONFLICT;
02771                     <span class="keywordflow">break</span>;
02772 
02773                 <span class="keywordflow">case</span> CmResourceTypeDma:
02774                     ErrLog-&gt;ErrorCode = IO_ERR_DMA_RESOURCE_CONFLICT;
02775                     <span class="keywordflow">break</span>;
02776             }
02777 
02778             <span class="keywordflow">if</span> (CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].BAddr &amp; 0xffffffff00000000) {
02779                 len = swprintf (pLog, L<span class="stringliteral">"%X:%08X"</span>,
02780                         (ULONG) (CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].BAddr &gt;&gt; 32),
02781                         (ULONG) CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].BAddr
02782                         );
02783             } <span class="keywordflow">else</span> {
02784                 len = swprintf (pLog, L<span class="stringliteral">"%X"</span>, (ULONG) CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].BAddr);
02785             }
02786 
02787             len += 1;       <span class="comment">// include null</span>
02788             pLog += len;
02789             ErrLogBufferLeft -= len;
02790 
02791             <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = CurList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o5">Conflict</a>.<a class="code" href="../../d8/d7/structIO__TRACK__CONFLICT.html#o4">EasyConflict</a>[j].Owner;
02792 
02793             len = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;KeyName.Length / <span class="keyword">sizeof</span>(WCHAR);
02794             <span class="keywordflow">if</span> (len &gt; ErrLogBufferLeft) {
02795                 len = ErrLogBufferLeft;
02796             }
02797 
02798             RtlCopyMemory (pLog, <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;KeyName.Buffer, len * <span class="keyword">sizeof</span>(WCHAR) );
02799             pLog += len;
02800             ErrLogBufferLeft -= len;
02801 
02802             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;DeviceName.Buffer  &amp;&amp;  ErrLogBufferLeft &gt; 11) {
02803                 len = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;DeviceName.Length / <span class="keyword">sizeof</span>(WCHAR);
02804                 <span class="keywordflow">if</span> (len &gt; ErrLogBufferLeft) {
02805                     len = ErrLogBufferLeft;
02806                 }
02807 
02808                 *(pLog++) = <span class="charliteral">' '</span>;
02809                 RtlCopyMemory (pLog, <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;DeviceName.Buffer, len * <span class="keyword">sizeof</span>(WCHAR));
02810                 pLog += len;
02811                 ErrLogBufferLeft -= len;
02812             }
02813 
02814             *(pLog++) = 0;      <span class="comment">// null terminate</span>
02815 
02816             <a class="code" href="../../d4/d6/iosubs_8c.html#a123">IoWriteErrorLogEntry</a> ( ErrLog );
02817         }
02818     }
02819 
02820     <a class="code" href="../../d7/d9/assign_8c.html#a20">IDBGMSG</a> (<span class="stringliteral">"****\n"</span>);
02821 }
02822 <span class="preprocessor">#endif</span>
02823 <span class="preprocessor"></span>
02824 
02825 <a class="code" href="../../d7/d9/assign_8c.html#a3">STATIC</a> <a class="code" href="../../d7/d9/assign_8c.html#a30">PTENTRY</a>
02826 <a class="code" href="../../d7/d9/assign_8c.html#a48">IopNewTransEntry</a> (
02827     IN PDIR_RESREQ_LIST Dir,
02828     IN PTENTRIESBYTYPE  pTypes,
02829     IN ULONG            Type
02830     )
02831 {
02832     <a class="code" href="../../d7/d9/assign_8c.html#a32">PLTENTRY</a>    LEntry, NewTable;
02833 
02834     LEntry = pTypes-&gt;ByType[Type];
02835 
02836     <span class="keywordflow">if</span> (!LEntry  ||  LEntry-&gt;<a class="code" href="../../d7/d5/struct__LTENTRY.html#o1">CurEntries</a> == <a class="code" href="../../d7/d9/assign_8c.html#a15">MAX_ENTRIES</a>) {
02837         <span class="comment">//</span>
02838         <span class="comment">// Build a new table</span>
02839         <span class="comment">//</span>
02840 
02841         NewTable = <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (Dir, <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d5/struct__LTENTRY.html">LTENTRY</a>));
02842 
02843         <span class="keywordflow">if</span> (!NewTable) {
02844             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02845         }
02846 
02847         pTypes-&gt;ByType[Type] = NewTable;
02848         NewTable-&gt;<a class="code" href="../../d7/d5/struct__LTENTRY.html#o0">Next</a> = LEntry;
02849         NewTable-&gt;<a class="code" href="../../d7/d5/struct__LTENTRY.html#o1">CurEntries</a> = 0;
02850 
02851         LEntry = NewTable;
02852     }
02853 
02854     <span class="keywordflow">return</span> LEntry-&gt;<a class="code" href="../../d7/d5/struct__LTENTRY.html#o3">Table</a> + (LEntry-&gt;<a class="code" href="../../d7/d5/struct__LTENTRY.html#o1">CurEntries</a>++);
02855 }
02856 
02857 
02858 <a class="code" href="../../d7/d9/assign_8c.html#a3">STATIC</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02859 <a class="code" href="../../d7/d9/assign_8c.html#a49">IopAddCmDescriptorToInUseList</a> (
02860     IN PDIR_RESREQ_LIST                Dir,
02861     IN PTENTRIESBYTYPE                 pTypes,
02862     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR CmDesc,
02863     IN <a class="code" href="../../d9/d5/structPOWNER.html">POWNER</a>                          Owner
02864     )
02865 <span class="comment">/*++</span>
02866 <span class="comment"></span>
02867 <span class="comment">Routine Description:</span>
02868 <span class="comment"></span>
02869 <span class="comment">    Adds Translated CmDescriptor to TLIST.</span>
02870 <span class="comment"></span>
02871 <span class="comment">Arguments:</span>
02872 <span class="comment"></span>
02873 <span class="comment">Return Value:</span>
02874 <span class="comment"></span>
02875 <span class="comment">--*/</span>
02876 {
02877     <a class="code" href="../../d7/d9/assign_8c.html#a30">PTENTRY</a>             Trans;
02878     LONGLONG            li;
02879 
02880     <span class="keywordflow">if</span> ((CmDesc-&gt;Type == CmResourceTypePort  &amp;&amp; CmDesc-&gt;u.Port.Length == 0) ||
02881         (CmDesc-&gt;Type == CmResourceTypeMemory  &amp;&amp; CmDesc-&gt;u.Memory.Length == 0)) {
02882         <span class="comment">// no length?</span>
02883         <a class="code" href="../../d7/d9/assign_8c.html#a20">IDBGMSG</a> (<span class="stringliteral">"IopAddCmDescriptor: Skipping zero length descriptor\n"</span>);
02884         <span class="keywordflow">return</span> STATUS_SUCCESS;
02885     }
02886 
02887     <span class="comment">//</span>
02888     <span class="comment">// Get a new Trans entry in the InUseResource list or the</span>
02889     <span class="comment">// InUseSharableResource list</span>
02890     <span class="comment">//</span>
02891 
02892     Trans = <a class="code" href="../../d7/d9/assign_8c.html#a48">IopNewTransEntry</a> (Dir, pTypes, CmDesc-&gt;Type);
02893     <span class="keywordflow">if</span> (!Trans) {
02894         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02895     }
02896 
02897     <span class="comment">//</span>
02898     <span class="comment">// Fill in the Trans structure</span>
02899     <span class="comment">//</span>
02900 
02901     <span class="comment">// NOTE: turning TEntries into a splay tree would speed up the collision</span>
02902     <span class="comment">// detect process.</span>
02903 
02904     Trans-&gt;Owner = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
02905     <span class="keywordflow">switch</span> (CmDesc-&gt;Type) {
02906         <span class="keywordflow">case</span> CmResourceTypePort:
02907             li = CmDesc-&gt;u.Port.Length - 1;
02908             Trans-&gt;BAddr = *((LONGLONG UNALIGNED *) &amp;CmDesc-&gt;u.Port.Start);
02909             Trans-&gt;EAddr = Trans-&gt;BAddr + li;
02910             Trans-&gt;Affinity = (KAFFINITY) -1;
02911             <span class="keywordflow">break</span>;
02912 
02913         <span class="keywordflow">case</span> CmResourceTypeMemory:
02914             li = CmDesc-&gt;u.Memory.Length - 1;
02915             Trans-&gt;BAddr = *((LONGLONG UNALIGNED *) &amp;CmDesc-&gt;u.Memory.Start);
02916             Trans-&gt;EAddr = Trans-&gt;BAddr + li;
02917             Trans-&gt;Affinity = (KAFFINITY) -1;
02918             <span class="keywordflow">break</span>;
02919 
02920         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
02921             Trans-&gt;BAddr = CmDesc-&gt;u.Interrupt.Vector;
02922             Trans-&gt;EAddr = CmDesc-&gt;u.Interrupt.Vector;
02923             Trans-&gt;Affinity = CmDesc-&gt;u.Interrupt.Affinity;
02924             <span class="keywordflow">break</span>;
02925 
02926         <span class="keywordflow">case</span> CmResourceTypeDma:
02927             Trans-&gt;BAddr = CmDesc-&gt;u.Dma.Channel;
02928             Trans-&gt;EAddr = CmDesc-&gt;u.Dma.Channel;
02929             Trans-&gt;Affinity = (KAFFINITY) -1;
02930             <span class="keywordflow">break</span>;
02931     }
02932     <span class="keywordflow">return</span> STATUS_SUCCESS;
02933 }
02934 
02935 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02936 <a class="code" href="../../d7/d9/assign_8c.html#a52">IopBuildResourceDir</a> (
02937     IN PDIR_RESREQ_LIST                 ParentDir,
02938     IN PDIR_RESREQ_LIST                 *pDir,
02939     IN PIO_RESOURCE_REQUIREMENTS_LIST   IoResources
02940     )
02941 <span class="comment">/*++</span>
02942 <span class="comment"></span>
02943 <span class="comment">Routine Description:</span>
02944 <span class="comment"></span>
02945 <span class="comment">    Takes an IO_RESOURCE_REQUIREMENTS list and builds a directory for</span>
02946 <span class="comment">    it's contents.</span>
02947 <span class="comment"></span>
02948 <span class="comment">Arguments:</span>
02949 <span class="comment"></span>
02950 <span class="comment">Return Value:</span>
02951 <span class="comment"></span>
02952 <span class="comment">--*/</span>
02953 {
02954     <a class="code" href="../../d7/d9/assign_8c.html#a39">PDIR_RESREQ_LIST</a>                Dir;
02955     PIO_RESOURCE_LIST               ResourceList;
02956     PIO_RESOURCE_DESCRIPTOR         Descriptor, ADescriptor;
02957     <a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>              DirResourceList, *AltListTail;
02958     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>          ReqRes;
02959     ULONG                           i, j, alt, cnt, acnt;
02960     PUCHAR                          FirstAddress, LastAddress;
02961 
02962     <span class="comment">//</span>
02963     <span class="comment">// Allocate and initialize DIR structure</span>
02964     <span class="comment">//</span>
02965 
02966     Dir = (<a class="code" href="../../d7/d9/assign_8c.html#a39">PDIR_RESREQ_LIST</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html">DIR_RESREQ_LIST</a>));
02967     *pDir = Dir;
02968     <span class="keywordflow">if</span> (!Dir) {
02969         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02970     }
02971 
02972     RtlZeroMemory (Dir, <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html">DIR_RESREQ_LIST</a>));
02973     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d7/d9/assign_8c.html#a12">MAX_REG_HANDLES</a>; i++) {
02974         Dir-&gt;RegHandle[i] = <a class="code" href="../../d7/d9/assign_8c.html#a13">INVALID_HANDLE</a>;
02975     }
02976 
02977     <span class="keywordflow">if</span> (ParentDir) {
02978         Dir-&gt;FreeResReqList = ParentDir-&gt;FreeResReqList;
02979         ParentDir-&gt;FreeResReqList = Dir;
02980     }
02981 
02982     <span class="comment">//</span>
02983     <span class="comment">// If no IoResources to process, the Dir structure is done</span>
02984     <span class="comment">//</span>
02985 
02986     <span class="keywordflow">if</span> (!IoResources) {
02987         <span class="keywordflow">return</span> STATUS_SUCCESS;
02988     }
02989 
02990     <span class="comment">//</span>
02991     <span class="comment">// Verify ResourceList does not exceede ListSize</span>
02992     <span class="comment">//</span>
02993 
02994     ResourceList = IoResources-&gt;List;
02995     FirstAddress = (PUCHAR) ResourceList;
02996     LastAddress  = (PUCHAR) IoResources + IoResources-&gt;ListSize;
02997     <span class="keywordflow">for</span> (cnt=0; cnt &lt; IoResources-&gt;AlternativeLists; cnt++) {
02998         ResourceList = (PIO_RESOURCE_LIST)
02999             (&amp;ResourceList-&gt;Descriptors[ResourceList-&gt;Count]);
03000 
03001         <span class="keywordflow">if</span> ((PUCHAR) ResourceList &lt; FirstAddress ||
03002             (PUCHAR) ResourceList &gt; LastAddress) {
03003             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopBuildResourceDir: IO_RESOURCE_LIST.ListSize too small\n"</span>);
03004             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03005         }
03006     }
03007 
03008     <span class="comment">//</span>
03009     <span class="comment">// Build a directory of the block stlye structure IO_RESOURCE_REQUIREMENTS_LIST</span>
03010     <span class="comment">//</span>
03011 
03012     Dir-&gt;IoResourceReq = IoResources;
03013     AltListTail  = &amp;Dir-&gt;Alternative;
03014     ResourceList = IoResources-&gt;List;
03015 
03016     <span class="keywordflow">for</span> (alt=0; alt &lt; IoResources-&gt;AlternativeLists; alt++) {
03017 
03018         <span class="comment">//</span>
03019         <span class="comment">// Count number of non-alternative descriptors on this</span>
03020         <span class="comment">// alternative list</span>
03021         <span class="comment">//</span>
03022 
03023         cnt = 0;
03024         Descriptor = ResourceList-&gt;Descriptors;
03025         <span class="keywordflow">for</span> (i = ResourceList-&gt;Count; i; i--) {
03026             <span class="keywordflow">if</span> (!(Descriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE)) {
03027                 cnt++;
03028             }
03029             Descriptor++;
03030         }
03031 
03032         <span class="comment">//</span>
03033         <span class="comment">// Build alternative list structure</span>
03034         <span class="comment">//</span>
03035 
03036         i = <span class="keyword">sizeof</span> (<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html">DIR_RESOURCE_LIST</a>) + cnt * <span class="keyword">sizeof</span>(PVOID) * 2;
03037         DirResourceList = (<a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>) <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (Dir, i);
03038 
03039         <span class="keywordflow">if</span> (!DirResourceList) {
03040             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03041         }
03042 
03043         <span class="comment">//</span>
03044         <span class="comment">// Initialize structure</span>
03045         <span class="comment">//</span>
03046 
03047         RtlZeroMemory (DirResourceList, i);
03048         DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o6">IoResourceList</a> = ResourceList;
03049 
03050         <span class="comment">// add to tail of single linked list</span>
03051         *(AltListTail) = DirResourceList;
03052         AltListTail = &amp;DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">Next</a>;
03053 
03054         Descriptor = ResourceList-&gt;Descriptors;
03055         <span class="keywordflow">for</span> (i = ResourceList-&gt;Count; i; i--) {
03056             <span class="keywordflow">if</span> (!(Descriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE)) {
03057                 <span class="comment">//</span>
03058                 <span class="comment">// Count number of alternative descriptors</span>
03059                 <span class="comment">//</span>
03060 
03061                 acnt = 1;
03062                 ADescriptor = Descriptor + 1;
03063                 <span class="keywordflow">while</span> (acnt &lt; i  &amp;&amp;  ADescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
03064                     ADescriptor++;
03065                     acnt++;
03066                 }
03067 
03068                 <span class="comment">//</span>
03069                 <span class="comment">// Allocate a required resource list</span>
03070                 <span class="comment">//</span>
03071 
03072                 ReqRes = (<a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>) <a class="code" href="../../d7/d9/assign_8c.html#a47">IopAllocateDirPool</a> (Dir,
03073                             <span class="keyword">sizeof</span> (<a class="code" href="../../d8/d7/structDIR__REQUIRED__RESOURCE.html">DIR_REQUIRED_RESOURCE</a>) + acnt * <span class="keyword">sizeof</span>(PVOID));
03074 
03075                 <span class="keywordflow">if</span> (!ReqRes) {
03076                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03077                 }
03078 
03079                 RtlZeroMemory (ReqRes, <span class="keyword">sizeof</span> (DIR_REQUIRED_RESOURCE));
03080                 DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>] = ReqRes;
03081                 DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>++;
03082 
03083                 <span class="comment">//</span>
03084                 <span class="comment">// Fill in all the alternatives for this required resource</span>
03085                 <span class="comment">//</span>
03086 
03087                 ReqRes-&gt;NoAlternatives = acnt;
03088                 ADescriptor = Descriptor;
03089                 <span class="keywordflow">for</span> (j=0; j &lt; acnt; j++) {
03090                     ReqRes-&gt;IoResourceDescriptor[j] = ADescriptor;
03091                     <span class="keywordflow">if</span> (ADescriptor-&gt;Option &amp; IO_RESOURCE_PREFERRED) {
03092                         ReqRes-&gt;BestPref = 1;
03093                     }
03094                     ADescriptor++;
03095                 }
03096             }
03097 
03098             <span class="comment">//</span>
03099             <span class="comment">// Next descriptor</span>
03100             <span class="comment">//</span>
03101             Descriptor++;
03102         }
03103 
03104 
03105         <span class="comment">//</span>
03106         <span class="comment">// Next alternative resource list</span>
03107         <span class="comment">//</span>
03108 
03109         ResourceList = (PIO_RESOURCE_LIST) Descriptor;
03110     }
03111     <span class="keywordflow">return</span> STATUS_SUCCESS;
03112 }
03113 
03114 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03115 <a class="code" href="../../d7/d9/assign_8c.html#a53">IopFreeResourceDir</a> (
03116     IN PDIR_RESREQ_LIST  DirResourceList
03117     )
03118 <span class="comment">/*++</span>
03119 <span class="comment"></span>
03120 <span class="comment">Routine Description:</span>
03121 <span class="comment"></span>
03122 <span class="comment">    Frees pool used to track a DIR_RESREQ_LIST and other assiocated</span>
03123 <span class="comment">    resources.  Also free's all pool for DIR_RESREQ_LIST's on a</span>
03124 <span class="comment">    free list.</span>
03125 <span class="comment"></span>
03126 <span class="comment">Arguments:</span>
03127 <span class="comment"></span>
03128 <span class="comment">Return Value:</span>
03129 <span class="comment"></span>
03130 <span class="comment">--*/</span>
03131 {
03132     <a class="code" href="../../d7/d9/assign_8c.html#a39">PDIR_RESREQ_LIST</a>                NextResourceList;
03133     ULONG                           i;
03134     PSINGLE_LIST_ENTRY              pe;
03135     <a class="code" href="../../d7/d9/assign_8c.html#a40">PUSED_HEAP</a>                      ph;
03136 
03137     <span class="comment">//</span>
03138     <span class="comment">// Free any allocated lists</span>
03139     <span class="comment">//</span>
03140 
03141     <span class="keywordflow">while</span> (DirResourceList) {
03142         NextResourceList = DirResourceList-&gt;<a class="code" href="../../d7/d5/struct__DIR__RESREQ__LIST.html#o3">FreeResReqList</a>;
03143 
03144         <span class="comment">//</span>
03145         <span class="comment">// Free any allocated heap</span>
03146         <span class="comment">//</span>
03147 
03148         <span class="keywordflow">while</span> (DirResourceList-&gt;AllocatedHeap.Next) {
03149             pe = PopEntryList (&amp;DirResourceList-&gt;AllocatedHeap);
03150             ph = CONTAINING_RECORD(pe, <a class="code" href="../../d9/d1/structUSED__HEAP.html">USED_HEAP</a>, FreeLink);
03151             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ph-&gt;FreeHeap);
03152         }
03153 
03154         <span class="comment">//</span>
03155         <span class="comment">// Close any opened handles</span>
03156         <span class="comment">//</span>
03157 
03158         <span class="keywordflow">for</span> (i=0; i&lt; <a class="code" href="../../d7/d9/assign_8c.html#a12">MAX_REG_HANDLES</a>; i++) {
03159             <span class="keywordflow">if</span> (DirResourceList-&gt;RegHandle[i] != <a class="code" href="../../d7/d9/assign_8c.html#a13">INVALID_HANDLE</a>) {
03160                 ZwClose (DirResourceList-&gt;RegHandle[i]);
03161             }
03162         }
03163 
03164 
03165         <span class="comment">//</span>
03166         <span class="comment">// Free header</span>
03167         <span class="comment">//</span>
03168 
03169         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DirResourceList);
03170 
03171         <span class="comment">//</span>
03172         <span class="comment">// Next list</span>
03173         <span class="comment">//</span>
03174 
03175         DirResourceList = NextResourceList;
03176     }
03177 }
03178 
03179 <span class="preprocessor">#if IDBG</span>
03180 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03181 IopDumpIoResourceDir (
03182     IN PDIR_RESREQ_LIST Dir
03183     )
03184 {
03185     <a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>              ResourceList;
03186     PIO_RESOURCE_DESCRIPTOR         Desc;
03187     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>          ReqRes;
03188     ULONG                           alt, i, j;
03189     UCHAR                           s[10];
03190 
03191 
03192     alt = 0;
03193     <span class="keywordflow">for</span> (ResourceList = Dir-&gt;Alternative; ResourceList; ResourceList = ResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">Next</a>) {
03194         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Alternative #%d  - %d required resources\n"</span>,
03195             alt++, ResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a> );
03196 
03197         <span class="keywordflow">for</span> (i=0; i &lt; ResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>; i++) {
03198             ReqRes = ResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[i];
03199             <span class="keywordflow">for</span> (j=0; j &lt; ReqRes-&gt;NoAlternatives; j++) {
03200                 Desc = ReqRes-&gt;IoResourceDescriptor[j];
03201                 <span class="keywordflow">if</span> (j == 0) {
03202                     s[0] = s[1] = s[2] = <span class="charliteral">'*'</span>;
03203                     s[3] = <span class="charliteral">' '</span>;
03204                 } <span class="keywordflow">else</span> {
03205                     s[0] = s[1] = s[2] = s[3] = <span class="charliteral">' '</span>;
03206                 }
03207 
03208                 s[4] = Desc-&gt;Option &amp; IO_RESOURCE_PREFERRED ? <span class="charliteral">'P'</span> : <span class="charliteral">' '</span>;
03209                 s[5] = <span class="charliteral">' '</span>;
03210                 s[6] = 0;
03211 
03212                 IopDumpIoResourceDescriptor (s, Desc);
03213             }
03214         }
03215     }
03216 }
03217 
03218 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03219 IopDumpIoResourceDescriptor (
03220     IN PUCHAR                   Indent,
03221     IN PIO_RESOURCE_DESCRIPTOR  Desc
03222     )
03223 {
03224     <span class="keywordflow">switch</span> (Desc-&gt;Type) {
03225         <span class="keywordflow">case</span> CmResourceTypePort:
03226             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sIO  Min: %x:%08x, Max: %x:%08x, Algn: %x, Len %x\n"</span>,
03227                 Indent,
03228                 Desc-&gt;u.Port.MinimumAddress.HighPart, Desc-&gt;u.Port.MinimumAddress.LowPart,
03229                 Desc-&gt;u.Port.MaximumAddress.HighPart, Desc-&gt;u.Port.MaximumAddress.LowPart,
03230                 Desc-&gt;u.Port.Alignment,
03231                 Desc-&gt;u.Port.Length
03232                 );
03233             <span class="keywordflow">break</span>;
03234 
03235         <span class="keywordflow">case</span> CmResourceTypeMemory:
03236             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sMEM Min: %x:%08x, Max: %x:%08x, Algn: %x, Len %x\n"</span>,
03237                 Indent,
03238                 Desc-&gt;u.Memory.MinimumAddress.HighPart, Desc-&gt;u.Memory.MinimumAddress.LowPart,
03239                 Desc-&gt;u.Memory.MaximumAddress.HighPart, Desc-&gt;u.Memory.MaximumAddress.LowPart,
03240                 Desc-&gt;u.Memory.Alignment,
03241                 Desc-&gt;u.Memory.Length
03242                 );
03243             <span class="keywordflow">break</span>;
03244 
03245         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
03246             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sINT Min: %x, Max: %x\n"</span>,
03247                 Indent,
03248                 Desc-&gt;u.Interrupt.MinimumVector,
03249                 Desc-&gt;u.Interrupt.MaximumVector
03250                 );
03251             <span class="keywordflow">break</span>;
03252 
03253         <span class="keywordflow">case</span> CmResourceTypeDma:
03254             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sDMA Min: %x, Max: %x\n"</span>,
03255                 Indent,
03256                 Desc-&gt;u.Dma.MinimumChannel,
03257                 Desc-&gt;u.Dma.MaximumChannel
03258                 );
03259             <span class="keywordflow">break</span>;
03260     }
03261 }
03262 
03263 
03264 <span class="preprocessor">#endif</span>
03265 <span class="preprocessor"></span>
03266 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03267 <a class="code" href="../../d7/d9/assign_8c.html#a55">IopCatagorizeDescriptors</a> (
03268     IN OUT PDIR_RESREQ_LIST Dir
03269     )
03270 <span class="comment">/*++</span>
03271 <span class="comment"></span>
03272 <span class="comment">Routine Description:</span>
03273 <span class="comment"></span>
03274 <span class="comment">    Takes a DIR_RESREQ_LIST and returns a list of resources by</span>
03275 <span class="comment">    catagory.  It is assumed that such a directory has one list</span>
03276 <span class="comment">    of alternative descriptors per resource type.</span>
03277 <span class="comment"></span>
03278 <span class="comment">Arguments:</span>
03279 <span class="comment"></span>
03280 <span class="comment">Return Value:</span>
03281 <span class="comment"></span>
03282 <span class="comment">--*/</span>
03283 {
03284     <a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>              DirResourceList;
03285     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>          ReqRes;
03286     ULONG                           i, j, acnt;
03287     CM_RESOURCE_TYPE                <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>;
03288 
03289     <span class="keywordflow">if</span> (!Dir-&gt;Alternative ||  Dir-&gt;Alternative-&gt;Next) {
03290         <span class="comment">// there can only be one list</span>
03291         <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopCatagorizeDescriptors: too many altenative lists\n"</span>);
03292         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_MIX;
03293     }
03294 
03295     DirResourceList = Dir-&gt;Alternative;
03296     <span class="keywordflow">for</span> (i=0; i &lt; DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>; i++) {
03297         ReqRes = DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[i];
03298 
03299         acnt = ReqRes-&gt;NoAlternatives;
03300         <span class="keywordflow">if</span> (!acnt) {
03301             <span class="comment">// shouldn't have a zero count</span>
03302             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopCatagorizeDescriptors: no entries\n"</span>);
03303             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_MIX;
03304         }
03305 
03306         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> = ReqRes-&gt;IoResourceDescriptor[0]-&gt;Type;
03307 
03308         <span class="comment">// verify all entries in this list are of the same type</span>
03309         <span class="keywordflow">for</span> (j=1; j &lt; acnt; j++) {
03310             <span class="keywordflow">if</span> (ReqRes-&gt;IoResourceDescriptor[j]-&gt;Type != <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>) {
03311                 <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopCatagorizeDescriptors: mixed types in alternatives\n"</span>);
03312                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_MIX;
03313             }
03314         }
03315 
03316         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> &gt;= CmResourceTypeMaximum) {
03317             <span class="comment">// unkown catagory</span>
03318             <span class="keywordflow">continue</span>;
03319         }
03320 
03321         <span class="keywordflow">if</span> (DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o1">ResourceByType</a>[<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>]) {
03322             <span class="comment">// should only have one list per type</span>
03323             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"IopCatagorizeDescriptors: multiple lists per resource type\n"</span>);
03324             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_MIX;
03325         }
03326 
03327         DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o1">ResourceByType</a>[<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>] = ReqRes;
03328     }
03329 
03330     <span class="keywordflow">return</span> STATUS_SUCCESS;
03331 }
03332 
03333 
03334 
03335 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a> ULONG
03336 <a class="code" href="../../d7/d9/assign_8c.html#a56">IopDescriptorSortingWeight</a> (
03337     IN PIO_RESOURCE_DESCRIPTOR Descriptor
03338     )
03339 <span class="comment">/*++</span>
03340 <span class="comment"></span>
03341 <span class="comment">Routine Description:</span>
03342 <span class="comment">    Used by IopSortDescriptors</span>
03343 <span class="comment"></span>
03344 <span class="comment">--*/</span>
03345 {
03346     ULONG       w;
03347 
03348     <span class="keywordflow">switch</span> (Descriptor-&gt;Type) {
03349         <span class="keywordflow">case</span> CmResourceTypeMemory:          w = 4;      <span class="keywordflow">break</span>;
03350         <span class="keywordflow">case</span> CmResourceTypeInterrupt:       w = 3;      <span class="keywordflow">break</span>;
03351         <span class="keywordflow">case</span> CmResourceTypeDma:             w = 2;      <span class="keywordflow">break</span>;
03352         <span class="keywordflow">case</span> CmResourceTypePort:            w = 1;      <span class="keywordflow">break</span>;
03353         <span class="keywordflow">default</span>:                            w = 0;      <span class="keywordflow">break</span>;
03354     }
03355 
03356     <span class="keywordflow">return</span> w;
03357 }
03358 
03359 
03360 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03361 <a class="code" href="../../d7/d9/assign_8c.html#a54">IopSortDescriptors</a> (
03362     IN OUT PDIR_RESREQ_LIST Dir
03363     )
03364 <span class="comment">/*++</span>
03365 <span class="comment"></span>
03366 <span class="comment">Routine Description:</span>
03367 <span class="comment"></span>
03368 <span class="comment">    Sorts the directory entries for each decsriptor such that they</span>
03369 <span class="comment">    descriptors are order by resource type.</span>
03370 <span class="comment"></span>
03371 <span class="comment">Arguments:</span>
03372 <span class="comment"></span>
03373 <span class="comment">Return Value:</span>
03374 <span class="comment"></span>
03375 <span class="comment">--*/</span>
03376 {
03377     PIO_RESOURCE_DESCRIPTOR         Descriptor;
03378     <a class="code" href="../../d7/d9/assign_8c.html#a37">PDIR_RESOURCE_LIST</a>              DirResourceList;
03379     <a class="code" href="../../d7/d9/assign_8c.html#a35">PDIR_REQUIRED_RESOURCE</a>          ReqRes;
03380     ULONG                           i, j, k, acnt;
03381     ULONG                           w1, w2;
03382 
03383     <span class="comment">//</span>
03384     <span class="comment">// Sort each require resource list by descriptor type</span>
03385     <span class="comment">//</span>
03386 
03387     <span class="keywordflow">for</span> (DirResourceList = Dir-&gt;Alternative; DirResourceList; DirResourceList = DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o0">Next</a>) {
03388 
03389         <span class="comment">//</span>
03390         <span class="comment">// Sort the descriptors by type</span>
03391         <span class="comment">//</span>
03392 
03393         <span class="keywordflow">for</span> (k=0; k &lt; DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o7">NoRequiredResources</a>; k++) {
03394             ReqRes = DirResourceList-&gt;<a class="code" href="../../d6/d5/struct__DIR__RESOURCE__LIST.html#o8">RequiredResource</a>[k];
03395 
03396             acnt = ReqRes-&gt;NoAlternatives;
03397             <span class="keywordflow">for</span> (i=0; i &lt; acnt; i++) {
03398                 w1 = <a class="code" href="../../d7/d9/assign_8c.html#a56">IopDescriptorSortingWeight</a> (ReqRes-&gt;IoResourceDescriptor[i]);
03399 
03400                 <span class="keywordflow">for</span> (j = i+1; j &lt; acnt; j++) {
03401                     w2 = <a class="code" href="../../d7/d9/assign_8c.html#a56">IopDescriptorSortingWeight</a> (ReqRes-&gt;IoResourceDescriptor[j]);
03402 
03403                     <span class="keywordflow">if</span> (w2 &gt; w1) {
03404                         Descriptor = ReqRes-&gt;IoResourceDescriptor[i];
03405                         ReqRes-&gt;IoResourceDescriptor[i] = ReqRes-&gt;IoResourceDescriptor[j];
03406                         ReqRes-&gt;IoResourceDescriptor[j] = Descriptor;
03407                         w1 = w2;
03408                     }
03409                 }
03410             }
03411         }
03412     }
03413 }
03414 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
