<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ex/resource.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>resource.c File Reference</h1><code>#include "<a class="el" href="../../d5/d9/exp_8h-source.html">exp.h</a>"</code><br>
<code>#include "nturtl.h"</code><br>

<p>
<a href="../../d9/d7/ex_2resource_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a0">IsExclusiveWaiting</a>(a)&nbsp;&nbsp;&nbsp;((a)-&gt;NumberOfExclusiveWaiters != 0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(a)&nbsp;&nbsp;&nbsp;((a)-&gt;NumberOfSharedWaiters != 0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a2">IsOwnedExclusive</a>(a)&nbsp;&nbsp;&nbsp;(((a)-&gt;Flag &amp; ResourceOwnedExclusive) != 0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a3">IsBoostAllowed</a>(a)&nbsp;&nbsp;&nbsp;(((a)-&gt;Flag &amp; DisablePriorityBoost) == 0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a4">DisablePriorityBoost</a>&nbsp;&nbsp;&nbsp;0x08</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a5">ASSERT_RESOURCE</a>(_Resource)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(Member)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN <a class="el" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a13">ExpResourceInitialization</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a14">ExInitializeResourceLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a15">ExReinitializeResourceLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a16">ExDisableResourceBoostLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a17">ExpAcquireResourceExclusiveLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN KIRQL OldIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a18">ExAcquireResourceExclusiveLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a19">ExTryToAcquireResourceExclusiveLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a20">ExAcquireResourceSharedLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a21">ExAcquireSharedStarveExclusive</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a22">ExAcquireSharedWaitForExclusive</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a23">ExReleaseResourceLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a24">ExReleaseResourceForThreadLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN <a class="el" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a25">ExSetResourceOwnerPointer</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN PVOID OwnerPointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a26">ExConvertExclusiveToSharedLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a27">ExDeleteResourceLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a28">ExGetExclusiveWaiterCount</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a29">ExGetSharedWaiterCount</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a30">ExIsResourceAcquiredExclusiveLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a31">ExIsResourceAcquiredSharedLite</a> (IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a32">ExQuerySystemLockInformation</a> (OUT PRTL_PROCESS_LOCKS LockInformation, IN ULONG LockInformationLength, OUT PULONG ReturnLength OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a33">ExpBoostOwnerThread</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> CurrentThread, IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> OwnerThread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a> (IN PVOID p, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a7">ExpTimeout</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a8">ExpResourceTimeoutCount</a> = 648000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ex_2resource_8c.html#a10">ExpSystemResourcesList</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a5" doxytag="ex/resource.c::ASSERT_RESOURCE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_RESOURCE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_Resource&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00074">74</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ex/resource.c::DisablePriorityBoost" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DisablePriorityBoost&nbsp;&nbsp;&nbsp;0x08          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00057">57</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ex/resource.c::ExpIncrementCounter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExpIncrementCounter          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Member&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00134">134</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00492">ExAcquireResourceExclusiveLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00762">ExAcquireResourceSharedLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01014">ExAcquireSharedStarveExclusive()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01165">ExAcquireSharedWaitForExclusive()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02683">ExpFindCurrentThread()</a>, and <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00598">ExTryToAcquireResourceExclusiveLite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ex/resource.c::IsBoostAllowed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsBoostAllowed          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((a)-&gt;Flag &amp; DisablePriorityBoost) == 0)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00051">51</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ex/resource.c::IsExclusiveWaiting" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsExclusiveWaiting          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((a)-&gt;NumberOfExclusiveWaiters != 0)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00048">48</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ex/resource.c::IsOwnedExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsOwnedExclusive          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((a)-&gt;Flag &amp; ResourceOwnedExclusive) != 0)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00050">50</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ex/resource.c::IsSharedWaiting" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsSharedWaiting          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((a)-&gt;NumberOfSharedWaiters != 0)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00049">49</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01942">ExConvertExclusiveToSharedLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02005">ExDeleteResourceLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">ExpWaitForResource()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01607">ExReleaseResourceForThreadLite()</a>, and <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01389">ExReleaseResourceLite()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a18" doxytag="ex/resource.c::ExAcquireResourceExclusiveLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExAcquireResourceExclusiveLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00492">492</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00410">ExpAcquireResourceExclusiveLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00134">ExpIncrementCounter</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02290">_ERESOURCE::Flag</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02309">ResourceNeverExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02311">ResourceOwnedExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/validate_8c-source.html#l00887">ChangeAcquireResourceType()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00798">EnterCrit()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00410">ExpAcquireResourceExclusiveLite()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07239">LeaveMouseCrit()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l02182">VerifierExAcquireResourceExclusive()</a>.
<p>
<pre class="fragment"><div>00499                    :
00500 
00501     The routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource <span class="keywordflow">for</span> exclusive access.
00502 
00503     N.B. This routine uses fast locking.
00504 
00505 Arguments:
00506 
00507     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired
00508         <span class="keywordflow">for</span> exclusive access.
00509 
00510     Wait - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value that specifies whether to wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00511         resource to become available <span class="keywordflow">if</span> access cannot be granted
00512         immediately.
00513 
00514 Return Value:
00515 
00516     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00517 
00518 --*/
00519 
00520 {
00521 
00522     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
00523     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00524     KIRQL OldIrql = 0;
00525     BOOLEAN Result;
00526 
00527     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp; ResourceNeverExclusive) == 0);
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">// Acquire exclusive access to the specified resource.</span>
00531     <span class="comment">//</span>
00532 
00533     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00534     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00535 
00536     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == FALSE);
00537     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
00538 
00539     <span class="comment">//</span>
00540     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
00541     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
00542     <span class="comment">// be immediately granted. Otherwise, there is either a shared owner or</span>
00543     <span class="comment">// an exclusive owner.</span>
00544     <span class="comment">//</span>
00545 
00546     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(ExclusiveAcquire);
00547     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> != 0) {
00548 
00549         <span class="comment">//</span>
00550         <span class="comment">// The resource is either owned exclusive or shared.</span>
00551         <span class="comment">//</span>
00552         <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
00553         <span class="comment">// owner, then increment the recursion count.</span>
00554         <span class="comment">//</span>
00555 
00556         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource) &amp;&amp;
00557             (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread)) {
00558             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00559             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00560 
00561         } <span class="keywordflow">else</span> {
00562 
00563             <span class="comment">//</span>
00564             <span class="comment">// The resource is either owned exclusive by some other thread,</span>
00565             <span class="comment">// or owned shared.</span>
00566             <span class="comment">//</span>
00567             <span class="comment">// If wait is not specified, then return that the resource was</span>
00568             <span class="comment">// not acquired. Otherwise, wait for exclusive access to the</span>
00569             <span class="comment">// resource to be granted.</span>
00570             <span class="comment">//</span>
00571 
00572             <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00573                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574 
00575             } <span class="keywordflow">else</span> {
00576                 <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/ex_2resource_8c.html#a17">ExpAcquireResourceExclusiveLite</a>(Resource, OldIrql);
00577             }
00578         }
00579 
00580     } <span class="keywordflow">else</span> {
00581 
00582         <span class="comment">//</span>
00583         <span class="comment">// The resource is not owned.</span>
00584         <span class="comment">//</span>
00585 
00586         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
00587         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00588         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00589         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
00590         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00591     }
00592 
00593     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00594     <span class="keywordflow">return</span> Result;
00595 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="ex/resource.c::ExAcquireResourceSharedLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExAcquireResourceSharedLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00762">762</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02683">ExpFindCurrentThread()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00134">ExpIncrementCounter</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">ExpWaitForResource()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00089">IsExclusiveWaiting</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00039">KeInitializeSemaphore()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02295">_ERESOURCE::NumberOfSharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02291">_ERESOURCE::SharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/validate_8c-source.html#l00833">EnterSharedCrit()</a>.
<p>
<pre class="fragment"><div>00769                    :
00770 
00771     The routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource <span class="keywordflow">for</span> shared access.
00772 
00773 Arguments:
00774 
00775     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired
00776         <span class="keywordflow">for</span> shared access.
00777 
00778     Wait - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value that specifies whether to wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00779         resource to become available <span class="keywordflow">if</span> access cannot be granted
00780         immediately.
00781 
00782 Return Value:
00783 
00784     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
00785 
00786 --*/
00787 
00788 {
00789 
00790     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
00791     KIRQL OldIrql;
00792     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
00793     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> Semaphore;
00794 
00795     <span class="comment">//</span>
00796     <span class="comment">// Acquire exclusive access to the specified resource.</span>
00797     <span class="comment">//</span>
00798 
00799     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00800     ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00801 
00802     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == FALSE);
00803     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
00804 
00805     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(SharedSecondLevel);
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
00809     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
00810     <span class="comment">// be immediately granted.</span>
00811     <span class="comment">//</span>
00812 
00813     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
00814         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00815         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00816         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
00817         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00818         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00819     }
00820 
00821     <span class="comment">//</span>
00822     <span class="comment">// The resource is either owned exclusive or shared.</span>
00823     <span class="comment">//</span>
00824     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
00825     <span class="comment">// owner, then treat the shared request as an exclusive request and</span>
00826     <span class="comment">// increment the recursion count. Otherwise, it is owned shared.</span>
00827     <span class="comment">//</span>
00828 
00829     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource)) {
00830         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
00831             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00832             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00833             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00834         }
00835 
00836         <span class="comment">//</span>
00837         <span class="comment">// Find an empty entry in the thread array.</span>
00838         <span class="comment">//</span>
00839 
00840         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(Resource, 0);
00841 
00842     } <span class="keywordflow">else</span> {
00843 
00844         <span class="comment">//</span>
00845         <span class="comment">// The resource is owned shared.</span>
00846         <span class="comment">//</span>
00847         <span class="comment">// If the current thread already has acquired the resource for</span>
00848         <span class="comment">// shared access, then increment the recursion count. Otherwise</span>
00849         <span class="comment">// grant shared access if there are no exclusive waiters.</span>
00850         <span class="comment">//</span>
00851 
00852         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(Resource, CurrentThread);
00853         <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
00854             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00855 
00856             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0);
00857 
00858             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00859             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00860         }
00861 
00862         <span class="comment">//</span>
00863         <span class="comment">// If there are no exclusive waiters, then grant shared access</span>
00864         <span class="comment">// to the resource. Otherwise, wait for the resource to become</span>
00865         <span class="comment">// available.</span>
00866         <span class="comment">//</span>
00867 
00868         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(Resource) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00869             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00870             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00871             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> += 1;
00872             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00873             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00874         }
00875     }
00876 
00877     <span class="comment">//</span>
00878     <span class="comment">// The resource is either owned exclusive by some other thread, or</span>
00879     <span class="comment">// owned shared by some other threads, but there is an exclusive</span>
00880     <span class="comment">// waiter and the current thread does not already have shared access</span>
00881     <span class="comment">// to the resource.</span>
00882     <span class="comment">//</span>
00883     <span class="comment">// If wait is not specified, then return that the resource was</span>
00884     <span class="comment">// not acquired.</span>
00885     <span class="comment">//</span>
00886 
00887     <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00888         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00889         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00890     }
00891 
00892     <span class="comment">//</span>
00893     <span class="comment">// If the shared wait semaphore has not yet been allocated, then allocate</span>
00894     <span class="comment">// and initialize it.</span>
00895     <span class="comment">//</span>
00896 
00897     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00898         Semaphore = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPoolMustSucceed,
00899                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>),
00900                                           'eSeR');
00901 
00902         <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
00903         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> = Semaphore;
00904     }
00905 
00906     <span class="comment">//</span>
00907     <span class="comment">// Wait for shared access to the resource to be granted and increment</span>
00908     <span class="comment">// the recursion count.</span>
00909     <span class="comment">//</span>
00910 
00911     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00912     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00913     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> += 1;
00914     ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00915     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(Resource, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
00916     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00917 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="ex/resource.c::ExAcquireSharedStarveExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExAcquireSharedStarveExclusive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01014">1014</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02683">ExpFindCurrentThread()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00134">ExpIncrementCounter</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">ExpWaitForResource()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00039">KeInitializeSemaphore()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02295">_ERESOURCE::NumberOfSharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02291">_ERESOURCE::SharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00116">CcPinFileData()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00271">CcPinMappedData()</a>, and <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00047">UdfAcquireResource()</a>.
<p>
<pre class="fragment"><div>01020                    :
01021 
01022     This routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource <span class="keywordflow">for</span> shared access and
01023     does not wait <span class="keywordflow">for</span> any pending exclusive owners.
01024 
01025 Arguments:
01026 
01027     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired
01028         <span class="keywordflow">for</span> shared access.
01029 
01030     Wait - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value that specifies whether to wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01031         resource to become available <span class="keywordflow">if</span> access cannot be granted
01032         immediately.
01033 
01034 Return Value:
01035 
01036     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01037 
01038 --*/
01039 
01040 {
01041 
01042     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
01043     KIRQL OldIrql;
01044     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
01045     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> Semaphore;
01046 
01047     <span class="comment">//</span>
01048     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01049     <span class="comment">//</span>
01050 
01051     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01052     ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01053 
01054     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == FALSE);
01055     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
01056 
01057     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(StarveSecondLevel);
01058 
01059     <span class="comment">//</span>
01060     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
01061     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
01062     <span class="comment">// be immediately granted.</span>
01063     <span class="comment">//</span>
01064 
01065     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01066         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01067         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01068         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01069         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01070         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01071     }
01072 
01073     <span class="comment">//</span>
01074     <span class="comment">// The resource is either owned exclusive or shared.</span>
01075     <span class="comment">//</span>
01076     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
01077     <span class="comment">// owner, then treat the shared request as an exclusive request and</span>
01078     <span class="comment">// increment the recursion count. Otherwise, it is owned shared.</span>
01079     <span class="comment">//</span>
01080 
01081     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource)) {
01082         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01083             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
01084             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01085             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01086         }
01087 
01088         <span class="comment">//</span>
01089         <span class="comment">// Find an empty entry in the thread array.</span>
01090         <span class="comment">//</span>
01091 
01092         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(Resource, 0);
01093 
01094     } <span class="keywordflow">else</span> {
01095 
01096         <span class="comment">//</span>
01097         <span class="comment">// The resource is owned shared.</span>
01098         <span class="comment">//</span>
01099         <span class="comment">// If the current thread already has acquired the resource for</span>
01100         <span class="comment">// shared access, then increment the recursion count. Otherwise</span>
01101         <span class="comment">// grant shared access to the current thread</span>
01102         <span class="comment">//</span>
01103 
01104         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(Resource, CurrentThread);
01105         <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01106             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
01107 
01108             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0);
01109 
01110             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01111             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01112         }
01113 
01114         <span class="comment">//</span>
01115         <span class="comment">// Grant the current thread shared access to the resource.</span>
01116         <span class="comment">//</span>
01117 
01118         OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01119         OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01120         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> += 1;
01121         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01122         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01123     }
01124 
01125     <span class="comment">//</span>
01126     <span class="comment">// The resource is owned exclusive by some other thread.</span>
01127     <span class="comment">//</span>
01128     <span class="comment">// If wait is not specified, then return that the resource was</span>
01129     <span class="comment">// not acquired.</span>
01130     <span class="comment">//</span>
01131 
01132     <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01133         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01134         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01135     }
01136 
01137     <span class="comment">//</span>
01138     <span class="comment">// If the shared wait semaphore has not yet been allocated, then allocate</span>
01139     <span class="comment">// and initialize it.</span>
01140     <span class="comment">//</span>
01141 
01142     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01143         Semaphore = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPoolMustSucceed,
01144                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>),
01145                                           'eSeR');
01146 
01147         <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
01148         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> = Semaphore;
01149     }
01150 
01151     <span class="comment">//</span>
01152     <span class="comment">// Wait for shared access to the resource to be granted and increment</span>
01153     <span class="comment">// the recursion count.</span>
01154     <span class="comment">//</span>
01155 
01156     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01157     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01158     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> += 1;
01159     ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01160     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(Resource, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
01161     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01162 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="ex/resource.c::ExAcquireSharedWaitForExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExAcquireSharedWaitForExclusive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01165">1165</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02683">ExpFindCurrentThread()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00134">ExpIncrementCounter</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">ExpWaitForResource()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00089">IsExclusiveWaiting</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00039">KeInitializeSemaphore()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02295">_ERESOURCE::NumberOfSharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02291">_ERESOURCE::SharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/fastio_8c-source.html#l02064">FsRtlAcquireFileForModWrite()</a>.
<p>
<pre class="fragment"><div>01171                    :
01172 
01173     This routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource <span class="keywordflow">for</span> shared access, but
01174     waits <span class="keywordflow">for</span> any pending exclusive owners.
01175 
01176 Arguments:
01177 
01178     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired
01179         <span class="keywordflow">for</span> shared access.
01180 
01181     Wait - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value that specifies whether to wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01182         resource to become available <span class="keywordflow">if</span> access cannot be granted
01183         immediately.
01184 
01185 Return Value:
01186 
01187     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01188 
01189 --*/
01190 
01191 {
01192 
01193     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
01194     KIRQL OldIrql;
01195     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
01196     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> Semaphore;
01197 
01198     <span class="comment">//</span>
01199     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01200     <span class="comment">//</span>
01201 
01202     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01203     ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01204 
01205     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == FALSE);
01206     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
01207 
01208     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(WaitForExclusive);
01209 
01210     <span class="comment">//</span>
01211     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
01212     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
01213     <span class="comment">// be immediately granted.</span>
01214     <span class="comment">//</span>
01215 
01216     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01217         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01218         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01219         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01220         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01221         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01222     }
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">// The resource is either owned exclusive or shared.</span>
01226     <span class="comment">//</span>
01227     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
01228     <span class="comment">// owner, then treat the shared request as an exclusive request and</span>
01229     <span class="comment">// increment the recursion count. Otherwise, it is owned shared.</span>
01230     <span class="comment">//</span>
01231 
01232     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource)) {
01233         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01234             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
01235             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01236             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01237         }
01238 
01239         <span class="comment">//</span>
01240         <span class="comment">// Find an empty entry in the thread array.</span>
01241         <span class="comment">//</span>
01242 
01243         OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(Resource, 0);
01244 
01245     } <span class="keywordflow">else</span> {
01246 
01247         <span class="comment">//</span>
01248         <span class="comment">// The resource is owned shared.</span>
01249         <span class="comment">//</span>
01250         <span class="comment">// If there is an exclusive waiter, then wait for the exclusive</span>
01251         <span class="comment">// waiter to gain access to the resource, then acquire the resource</span>
01252         <span class="comment">// shared without regard to exclusive waiters. Otherwise, if the</span>
01253         <span class="comment">// current thread already has acquired the resource for shared access,</span>
01254         <span class="comment">// then increment the recursion count. Otherwise grant shared access</span>
01255         <span class="comment">// to the current thread</span>
01256         <span class="comment">//</span>
01257 
01258         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(Resource)) {
01259 
01260             <span class="comment">//</span>
01261             <span class="comment">// The resource is shared, but there is an exclusive waiter.</span>
01262             <span class="comment">//</span>
01263             <span class="comment">// If wait is not specified, then return that the resource was</span>
01264             <span class="comment">// not acquired.</span>
01265             <span class="comment">//</span>
01266 
01267             <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01268                 ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01269                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01270             }
01271 
01272             <span class="comment">//</span>
01273             <span class="comment">// If the shared wait semaphore has not yet been allocated, then</span>
01274             <span class="comment">// allocate and initialize it.</span>
01275             <span class="comment">//</span>
01276 
01277             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01278                 Semaphore = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPoolMustSucceed,
01279                                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>),
01280                                                   'eSeR');
01281 
01282                 <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
01283                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> = Semaphore;
01284             }
01285 
01286             <span class="comment">//</span>
01287             <span class="comment">// Increment the number of shared waiters and wait for shared</span>
01288             <span class="comment">// access to the resource to be granted to some other set of</span>
01289             <span class="comment">// threads, and then acquire the resource shared without regard</span>
01290             <span class="comment">// to exclusive access.</span>
01291             <span class="comment">//</span>
01292             <span class="comment">// N.B. The resource is left in a state such that the calling</span>
01293             <span class="comment">//      thread does not have a reference in the owner table</span>
01294             <span class="comment">//      for the requested access even though the active count</span>
01295             <span class="comment">//      is incremented when control is returned. However, the</span>
01296             <span class="comment">//      resource is owned shared at this point, so an owner</span>
01297             <span class="comment">//      entry can simply be allocated and the owner count set</span>
01298             <span class="comment">//      to one.</span>
01299             <span class="comment">//</span>
01300 
01301             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> += 1;
01302             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01303             <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(Resource, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
01304 
01305             <span class="comment">//</span>
01306             <span class="comment">// Reacquire the resource spin lock, allocate an owner entry,</span>
01307             <span class="comment">// and initialize the owner count to one. The active count</span>
01308             <span class="comment">// was already incremented when shared access was granted.</span>
01309             <span class="comment">//</span>
01310 
01311             ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01312 
01313             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource) == FALSE);
01314             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01315 
01316             OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(Resource, CurrentThread);
01317 
01318             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != CurrentThread);
01319 
01320             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01321             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01322             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01323             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01324 
01325         } <span class="keywordflow">else</span> {
01326             OwnerEntry = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a12">ExpFindCurrentThread</a>(Resource, CurrentThread);
01327             <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01328                 OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
01329 
01330                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0);
01331 
01332                 ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01333                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01334             }
01335 
01336             <span class="comment">//</span>
01337             <span class="comment">// Grant the current thread shared access to the resource.</span>
01338             <span class="comment">//</span>
01339 
01340             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01341             OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01342             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> += 1;
01343             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01344             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01345         }
01346     }
01347 
01348     <span class="comment">//</span>
01349     <span class="comment">// The resource is owned exclusive by some other thread.</span>
01350     <span class="comment">//</span>
01351     <span class="comment">// If wait is not specified, then return that the resource was</span>
01352     <span class="comment">// not acquired.</span>
01353     <span class="comment">//</span>
01354 
01355     <span class="keywordflow">if</span> (Wait == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01356         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01357         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01358     }
01359 
01360     <span class="comment">//</span>
01361     <span class="comment">// If the shared wait semaphore has not yet been allocated, then allocate</span>
01362     <span class="comment">// and initialize it.</span>
01363     <span class="comment">//</span>
01364 
01365     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01366         Semaphore = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPoolMustSucceed,
01367                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>),
01368                                           'eSeR');
01369 
01370         <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
01371         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a> = Semaphore;
01372     }
01373 
01374     <span class="comment">//</span>
01375     <span class="comment">// Wait for shared access to the resource to be granted and increment</span>
01376     <span class="comment">// the recursion count.</span>
01377     <span class="comment">//</span>
01378 
01379     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
01380     OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01381     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> += 1;
01382     ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01383     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(Resource, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
01384     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01385 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="ex/resource.c::ExConvertExclusiveToSharedLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExConvertExclusiveToSharedLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01942">1942</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02290">_ERESOURCE::Flag</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00049">IsSharedWaiting</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02295">_ERESOURCE::NumberOfSharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02311">ResourceOwnedExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02291">_ERESOURCE::SharedWaiters</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>.
<p>
<pre class="fragment"><div>01948                    :
01949 
01950     This routine converts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource from acquired <span class="keywordflow">for</span> exclusive
01951     access to acquired <span class="keywordflow">for</span> shared access.
01952 
01953     N.B. This routine uses fast locking.
01954 
01955 Arguments:
01956 
01957     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to acquire <span class="keywordflow">for</span> shared access. <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
01958 
01959 Return Value:
01960 
01961     None.
01962 
01963 --*/
01964 
01965 {
01966 
01967     ULONG Number;
01968     KIRQL OldIrql;
01969 
01970     <span class="comment">//</span>
01971     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01972     <span class="comment">//</span>
01973 
01974     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01975 
01976     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == FALSE);
01977     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
01978     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource));
01979     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == (ERESOURCE_THREAD)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>());
01980 
01981     <span class="comment">//</span>
01982     <span class="comment">// Convert the granted access from exclusive to shared.</span>
01983     <span class="comment">//</span>
01984 
01985     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01986 
01987     <span class="comment">//</span>
01988     <span class="comment">// If there are any shared waiters, then grant them shared access.</span>
01989     <span class="comment">//</span>
01990 
01991     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(Resource)) {
01992         Number = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
01993         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> +=  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)Number;
01994         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> = 0;
01995         ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01996         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>, 0, Number, FALSE);
01997         <span class="keywordflow">return</span>;
01998     }
01999 
02000     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
02001     <span class="keywordflow">return</span>;
02002 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="ex/resource.c::ExDeleteResourceLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ExDeleteResourceLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02005">2005</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02323">_RESOURCE_PERFORMANCE_DATA::ActiveResourceCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02298">_ERESOURCE::Address</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02317">_RESOURCE_HASH_ENTRY::Address</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02318">_RESOURCE_HASH_ENTRY::ContentionCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02294">_ERESOURCE::ContentionCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02292">_ERESOURCE::ExclusiveWaiters</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00114">ExpResourceSpinLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02333">_RESOURCE_PERFORMANCE_DATA::HashTable</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00089">IsExclusiveWaiting</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00049">IsSharedWaiting</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02316">_RESOURCE_HASH_ENTRY::ListEntry</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02319">_RESOURCE_HASH_ENTRY::Number</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02288">_ERESOURCE::OwnerTable</a>, <a class="el" href="../../d5/d8/ex_8h.html#a128">PRESOURCE_HASH_ENTRY</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d5/d8/ex_8h.html#a127">RESOURCE_HASH_ENTRY</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02313">RESOURCE_HASH_TABLE_SIZE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02291">_ERESOURCE::SharedWaiters</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02287">_ERESOURCE::SystemResourcesList</a>.
<p>
<pre class="fragment"><div>02011                    :
02012 
02013     This routine deallocates any <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocated to support <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
02014     resource.
02015 
02016 
02017 Arguments:
02018 
02019     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource whose allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
02020         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
02021 
02022 Return Value:
02023 
02024     STATUS_SUCCESS.
02025 
02026 --*/
02027 
02028 {
02029 
02030     <a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html">PRESOURCE_HASH_ENTRY</a> HashEntry;
02031     ULONG Hash;
02032     <a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html">PRESOURCE_HASH_ENTRY</a> MatchEntry;
02033     PLIST_ENTRY NextEntry;
02034     KIRQL OldIrql;
02035 
02036     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(Resource) == FALSE);
02037     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(Resource) == FALSE);
02038 
02039     <span class="comment">//</span>
02040     <span class="comment">// Acquire the executive resource spinlock and remove the resource from</span>
02041     <span class="comment">// the system resource list.</span>
02042     <span class="comment">//</span>
02043 
02044     ExAcquireSpinLock(&amp;ExpResourceSpinLock, &amp;OldIrql);
02045 
02046     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == FALSE);
02047     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
02048 
02049     RemoveEntryList(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o0">SystemResourcesList</a>);
02050 
02051 <span class="preprocessor">#if defined(_COLLECT_RESOURCE_DATA_)</span>
02052 <span class="preprocessor"></span>
02053     <span class="comment">//</span>
02054     <span class="comment">// Lookup resource initialization address in resource hash table. If</span>
02055     <span class="comment">// the address does not exist in the table, then create a new entry.</span>
02056     <span class="comment">//</span>
02057 
02058     Hash = (ULONG)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o10">Address</a>;
02059     Hash = ((Hash &gt; 24) ^ (Hash &gt; 16) ^ (Hash &gt; 8) ^ (Hash)) &amp; (<a class="code" href="../../d5/d8/ex_8h.html#a65">RESOURCE_HASH_TABLE_SIZE</a> - 1);
02060     MatchEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02061     NextEntry = ExpResourcePerformanceData.HashTable[Hash].Flink;
02062     <span class="keywordflow">while</span> (NextEntry != &amp;ExpResourcePerformanceData.HashTable[Hash]) {
02063         HashEntry = CONTAINING_RECORD(NextEntry,
02064                                       <a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html">RESOURCE_HASH_ENTRY</a>,
02065                                       ListEntry);
02066 
02067         <span class="keywordflow">if</span> (HashEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o1">Address</a> == <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o10">Address</a>) {
02068             MatchEntry = HashEntry;
02069             <span class="keywordflow">break</span>;
02070         }
02071 
02072         NextEntry = NextEntry-&gt;Flink;
02073     }
02074 
02075     <span class="comment">//</span>
02076     <span class="comment">// If a matching initialization address was found, then update the call</span>
02077     <span class="comment">// site statistics. Otherwise, allocate a new hash entry and initialize</span>
02078     <span class="comment">// call site statistics.</span>
02079     <span class="comment">//</span>
02080 
02081     <span class="keywordflow">if</span> (MatchEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02082         MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o2">ContentionCount</a> += <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>;
02083         MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o3">Number</a> += 1;
02084 
02085     } <span class="keywordflow">else</span> {
02086         MatchEntry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
02087                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html">RESOURCE_HASH_ENTRY</a>),
02088                                           'vEpR');
02089 
02090         <span class="keywordflow">if</span> (MatchEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02091             MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o1">Address</a> = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o10">Address</a>;
02092             MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o2">ContentionCount</a> = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>;
02093             MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o3">Number</a> = 1;
02094             InsertTailList(&amp;ExpResourcePerformanceData.HashTable[Hash],
02095                            &amp;MatchEntry-&gt;<a class="code" href="../../d3/d4/struct__RESOURCE__HASH__ENTRY.html#o0">ListEntry</a>);
02096         }
02097     }
02098 
02099     ExpResourcePerformanceData.ActiveResourceCount -= 1;
02100 
02101 <span class="preprocessor">#endif</span>
02102 <span class="preprocessor"></span>
02103     ExReleaseSpinLock(&amp;ExpResourceSpinLock, OldIrql);
02104 
02105     <span class="comment">//</span>
02106     <span class="comment">// If an owner table was allocated, then free it to pool.</span>
02107     <span class="comment">//</span>
02108 
02109     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02110         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>);
02111     }
02112 
02113     <span class="comment">//</span>
02114     <span class="comment">// If a semaphore was allocated, then free it to pool.</span>
02115     <span class="comment">//</span>
02116 
02117     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>) {
02118         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>);
02119     }
02120 
02121     <span class="comment">//</span>
02122     <span class="comment">// If an event was allocated, then free it to pool.</span>
02123     <span class="comment">//</span>
02124 
02125     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>) {
02126         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>);
02127     }
02128 
02129     <span class="keywordflow">return</span> STATUS_SUCCESS;
02130 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="ex/resource.c::ExDisableResourceBoostLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExDisableResourceBoostLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00370">370</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00080">DisablePriorityBoost</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02290">_ERESOURCE::Flag</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>.
<p>
<pre class="fragment"><div>00376                    :
00377 
00378     This routine disables priority inversion boosting <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00379     resource.
00380 
00381 Arguments:
00382 
00383     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <span class="keywordflow">for</span> which priority
00384         boosting <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> disabled.
00385 
00386 Return Value:
00387 
00388     None.
00389 
00390 --*/
00391 
00392 {
00393 
00394     KIRQL OldIrql;
00395 
00396     <span class="comment">//</span>
00397     <span class="comment">// Disable priority boosts for the specified resource.</span>
00398     <span class="comment">//</span>
00399 
00400     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00401 
00402     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
00403 
00404     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d7/d4/ddkresrc_8c.html#a3">DisablePriorityBoost</a>;
00405     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00406 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="ex/resource.c::ExGetExclusiveWaiterCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ExGetExclusiveWaiterCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02133">2133</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02296">_ERESOURCE::NumberOfExclusiveWaiters</a>, and <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/mndraw_8c-source.html#l00290">MNAnimate()</a>.
<p>
<pre class="fragment"><div>02139                    :
02140 
02141     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exclusive waiter count.
02142 
02143 
02144 Arguments:
02145 
02146     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to and executive resource.
02147 
02148 Return Value:
02149 
02150     The current number of exclusive waiters <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
02151     value.
02152 
02153 --*/
02154 
02155 {
02156     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a>;
02157 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="ex/resource.c::ExGetSharedWaiterCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ExGetSharedWaiterCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02160">2160</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02295">_ERESOURCE::NumberOfSharedWaiters</a>, and <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/mndraw_8c-source.html#l00290">MNAnimate()</a>.
<p>
<pre class="fragment"><div>02166                    :
02167 
02168     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shared waiter count.
02169 
02170 
02171 Arguments:
02172 
02173     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to and executive resource.
02174 
02175 Return Value:
02176 
02177     The current number of shared waiters <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
02178     value.
02179 
02180 --*/
02181 
02182 {
02183     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
02184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ex/resource.c::ExInitializeResourceLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ExInitializeResourceLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00209">209</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02323">_RESOURCE_PERFORMANCE_DATA::ActiveResourceCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02298">_ERESOURCE::Address</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02299">_ERESOURCE::CreatorBackTraceIndex</a>, <a class="el" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00114">ExpResourceSpinLock</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00157">ExpSystemResourcesList</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00437">MmDeterminePoolType()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02287">_ERESOURCE::SystemResourcesList</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02324">_RESOURCE_PERFORMANCE_DATA::TotalResourceCount</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01322">InitCreateUserCrit()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, and <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.
<p>
<pre class="fragment"><div>00215                    :
00216 
00217     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource.
00218 
00219 Arguments:
00220 
00221     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to initialize.
00222 
00223 Return Value:
00224 
00225     STATUS_SUCCESS.
00226 
00227 --*/
00228 
00229 {
00230 
00231     PVOID CallersCaller;
00232 
00233     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d6/allocpag_8c.html#a48">MmDeterminePoolType</a>(Resource) == NonPagedPool);
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">// Initialize the specified resource.</span>
00237     <span class="comment">//</span>
00238     <span class="comment">// N.B. All fields are initialized to zero (NULL pointers) except</span>
00239     <span class="comment">//      the list entry and spinlock.</span>
00240     <span class="comment">//</span>
00241 
00242     RtlZeroMemory(Resource, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>));
00243     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>);
00244 
00245 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00246 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00247         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
00248         }
00249     <span class="keywordflow">else</span> {
00250         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a> = 0;
00251         }
00252 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00253 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a>(&amp;ExpSystemResourcesList,
00254                                 &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o0">SystemResourcesList</a>,
00255                                 &amp;ExpResourceSpinLock);
00256 
00257     <span class="comment">//</span>
00258     <span class="comment">// Initialize performance data entry for the resource.</span>
00259     <span class="comment">//</span>
00260 
00261 <span class="preprocessor">#if defined(_COLLECT_RESOURCE_DATA_)</span>
00262 <span class="preprocessor"></span>
00263     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o10">Address</a>, &amp;CallersCaller);
00264     ExpResourcePerformanceData.TotalResourceCount += 1;
00265     ExpResourcePerformanceData.ActiveResourceCount += 1;
00266 
00267 <span class="preprocessor">#endif</span>
00268 <span class="preprocessor"></span>
00269     <span class="keywordflow">return</span> STATUS_SUCCESS;
00270 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="ex/resource.c::ExIsResourceAcquiredExclusiveLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExIsResourceAcquiredExclusiveLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02187">2187</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l01535">RequestDeviceChange()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l01099">StartDeviceRead()</a>, <a class="el" href="../../d4/d7/job_8c-source.html#l00206">UpdateJob()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00773">UserIsUserCritSecIn()</a>, <a class="el" href="../../d4/d7/job_8c-source.html#l00026">UserJobCallout()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l04171">xxxUserFindHandleForObject()</a>.
<p>
<pre class="fragment"><div>02193                    :
02194 
02195     This routine determines <span class="keywordflow">if</span> a resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired exclusive by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02196     calling thread.
02197 
02198 Arguments:
02199 
02200     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to query.
02201 
02202 Return Value:
02203 
02204     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread has acquired <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource exclusive, a value of
02205     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise, a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02206 
02207 --*/
02208 
02209 {
02210 
02211     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
02212     KIRQL OldIrql;
02213     BOOLEAN Result;
02214 
02215     <span class="comment">//</span>
02216     <span class="comment">// Acquire exclusive access to the specified resource.</span>
02217     <span class="comment">//</span>
02218 
02219     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02220     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
02221 
02222     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
02223 
02224     <span class="comment">//</span>
02225     <span class="comment">// If the resource is owned exclusive and the current thread is the</span>
02226     <span class="comment">// owner, then set the return value of TRUE. Otherwise, set the return</span>
02227     <span class="comment">// value to FALSE.</span>
02228     <span class="comment">//</span>
02229 
02230     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02231     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource)) &amp;&amp;
02232         (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread)) {
02233         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02234     }
02235 
02236     <span class="comment">//</span>
02237     <span class="comment">// Release exclusive access to the specified resource.</span>
02238     <span class="comment">//</span>
02239 
02240     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
02241     <span class="keywordflow">return</span> Result;
02242 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="ex/resource.c::ExIsResourceAcquiredSharedLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ExIsResourceAcquiredSharedLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02245">2245</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02288">_ERESOURCE::OwnerTable</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02281">_OWNER_ENTRY::TableSize</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/validate_8c-source.html#l00773">UserIsUserCritSecIn()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l04171">xxxUserFindHandleForObject()</a>.
<p>
<pre class="fragment"><div>02251                    :
02252 
02253     This routine determines <span class="keywordflow">if</span> a resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired either shared or
02254     exclusive by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread.
02255 
02256 Arguments:
02257 
02258     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to query.
02259 
02260 Return Value:
02261 
02262     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread has not acquired <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource a value of zero
02263     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's acquire count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02264 
02265 --*/
02266 
02267 {
02268 
02269     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
02270     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02271     ULONG Number;
02272     KIRQL OldIrql;
02273     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
02274     ULONG Result;
02275 
02276     <span class="comment">//</span>
02277     <span class="comment">// Acquire exclusive access to the specified resource.</span>
02278     <span class="comment">//</span>
02279 
02280     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02281     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
02282 
02283     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
02284 
02285     <span class="comment">//</span>
02286     <span class="comment">// Find the current thread in the thread array and return the count.</span>
02287     <span class="comment">//</span>
02288     <span class="comment">// N.B. If the thread is not found a value of zero will be returned.</span>
02289     <span class="comment">//</span>
02290 
02291     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02292         Result = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>;
02293 
02294     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02295         Result = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>;
02296 
02297     } <span class="keywordflow">else</span> {
02298 
02299         <span class="comment">//</span>
02300         <span class="comment">// If the resource hint is not within range or the resource table</span>
02301         <span class="comment">// entry does not match the current thread, then search the owner</span>
02302         <span class="comment">// table for a match.</span>
02303         <span class="comment">//</span>
02304 
02305         OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02306         Result = 0;
02307         <span class="keywordflow">if</span> (OwnerEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02308             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)(CurrentThread))-&gt;ResourceIndex;
02309             Number = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
02310             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= Number) ||
02311                 (OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != CurrentThread)) {
02312                 <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
02313                     OwnerEntry += 1;
02314                     <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02315                         Result = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>;
02316                         <span class="keywordflow">break</span>;
02317                     }
02318                 }
02319 
02320             } <span class="keywordflow">else</span> {
02321                 Result = OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>;
02322             }
02323         }
02324     }
02325 
02326     <span class="comment">//</span>
02327     <span class="comment">// Release exclusive access to the specified resource.</span>
02328     <span class="comment">//</span>
02329 
02330     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
02331     <span class="keywordflow">return</span> Result;
02332 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="ex/resource.c::ExpAcquireResourceExclusiveLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FASTCALL ExpAcquireResourceExclusiveLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>OldIrql</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00410">410</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00492">ExAcquireResourceExclusiveLite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02292">_ERESOURCE::ExclusiveWaiters</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">ExpWaitForResource()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02296">_ERESOURCE::NumberOfExclusiveWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00492">ExAcquireResourceExclusiveLite()</a>.
<p>
<pre class="fragment"><div>00417                    :
00418 
00419     This routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource <span class="keywordflow">for</span> exclusive access.
00420 
00421     N.B. This routine uses fast locking.
00422 
00423     N.B. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast lock <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource
00424         held.
00425 
00426 Arguments:
00427 
00428     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired
00429         <span class="keywordflow">for</span> exclusive access.
00430 
00431     OldIrql - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous IRQL.
00432 
00433 Return Value:
00434 
00435     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00436 
00437 --*/
00438 
00439 {
00440 
00441     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00442 
00443     <span class="comment">//</span>
00444     <span class="comment">// If the exclusive wait event has not yet been allocated, then the</span>
00445     <span class="comment">// long path code must be taken.</span>
00446     <span class="comment">//</span>
00447 
00448     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00449 
00450         <span class="comment">//</span>
00451         <span class="comment">// Allocate an exclusive wait event.</span>
00452         <span class="comment">//</span>
00453         <span class="comment">// N.B. This path is not optimal, but is only ever executed once</span>
00454         <span class="comment">//      per resource.</span>
00455         <span class="comment">//</span>
00456 
00457         ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00458         ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00459         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00460             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPoolMustSucceed,
00461                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>),
00462                                           'vEeR');
00463 
00464             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(Event, SynchronizationEvent, FALSE);
00465             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a> = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00466         }
00467 
00468         ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00469         <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a269">ExAcquireResourceExclusiveLite</a>(Resource, TRUE);
00470     }
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// Wait for exclusive access to the resource to be granted and set the</span>
00474     <span class="comment">// owner thread.</span>
00475     <span class="comment">//</span>
00476 
00477     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> += 1;
00478     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00479     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a11">ExpWaitForResource</a>(Resource, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>);
00480 
00481     <span class="comment">//</span>
00482     <span class="comment">// N.B. It is "safe" to store the owner thread without obtaining any</span>
00483     <span class="comment">//      locks since the thread has already been granted exclusive</span>
00484     <span class="comment">//      ownership.</span>
00485     <span class="comment">//</span>
00486 
00487     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00488     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="ex/resource.c::ExpBoostOwnerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL ExpBoostOwnerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentThread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerThread</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02453">2453</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00576">KiSetPriorityThread()</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00042">ROUND_TRIP_DECREMENT_COUNT</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">ExpWaitForResource()</a>.
<p>
<pre class="fragment"><div>02459                    :
02460 
02461     This function boots <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified owner thread iff
02462     its priority <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> less than that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also
02463     less than fourteen.
02464 
02465     N.B. <span class="keyword">this</span> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dispatcher database lock held.
02466 
02467 Arguments:
02468 
02469     CurrentThread - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread object.
02470 
02471     OwnerThread - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner thread object.
02472 
02473 Return Value:
02474 
02475     None.
02476 
02477 --*/
02478 
02479 {
02480 
02481     <span class="comment">//</span>
02482     <span class="comment">// If the owner thread is lower priority than the current thread, the</span>
02483     <span class="comment">// current thread is running at a priority less than 14, then boost the</span>
02484     <span class="comment">// priority of the owner thread for a quantum.</span>
02485     <span class="comment">//</span>
02486     <span class="comment">// N.B. A thread that has already been boosted may be reboosted to allow</span>
02487     <span class="comment">//      it to execute and release resources. When the boost is removed,</span>
02488     <span class="comment">//      the thread will return to its priority before any boosting.</span>
02489     <span class="comment">//</span>
02490 
02491     <span class="keywordflow">if</span> (((ULONG_PTR)OwnerThread &amp; 0x3) == 0) {
02492         <span class="keywordflow">if</span> ((OwnerThread-&gt;Priority &lt; CurrentThread-&gt;Priority) &amp;&amp;
02493             (OwnerThread-&gt;Priority &lt; 14)) {
02494             OwnerThread-&gt;PriorityDecrement += 14 - OwnerThread-&gt;Priority;
02495             OwnerThread-&gt;DecrementCount = <a class="code" href="../../d4/d9/ke_8h.html#a4">ROUND_TRIP_DECREMENT_COUNT</a>;
02496             <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(OwnerThread, 14);
02497             OwnerThread-&gt;Quantum = OwnerThread-&gt;ApcState.Process-&gt;ThreadQuantum;
02498         }
02499     }
02500 
02501     <span class="keywordflow">return</span>;
02502 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="ex/resource.c::ExpCheckForResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ExpCheckForResource           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>p</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02894">2894</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00114">ExpResourceSpinLock</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00157">ExpSystemResourcesList</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03892">ExFreePoolSanityChecks()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.
<p>
<pre class="fragment"><div>02899 {
02900 
02901     KIRQL OldIrql;
02902     PLIST_ENTRY Head, Next;
02903     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02904     PCHAR BeginBlock;
02905     PCHAR EndBlock;
02906 
02907     <span class="comment">//</span>
02908     <span class="comment">// This can cause a deadlock on MP machines.</span>
02909     <span class="comment">//</span>
02910 
02911     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> &gt; 1) {
02912         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02913     }
02914 
02915     BeginBlock = (PCHAR)p;
02916     EndBlock = (PCHAR)p + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02917 
02918     ExAcquireSpinLock( &amp;ExpResourceSpinLock, &amp;OldIrql );
02919     Head = &amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">ExpSystemResourcesList</a>;
02920     Next = Head-&gt;Flink;
02921     <span class="keywordflow">while</span> (Next != Head) {
02922         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = CONTAINING_RECORD( Next,
02923                                       <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>,
02924                                       SystemResourcesList
02925                                     );
02926 
02927         <span class="keywordflow">if</span> ((PCHAR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> &gt;= BeginBlock &amp;&amp; (PCHAR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> &lt; EndBlock) {
02928             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: ExFreePool( %lx, %lx ) contains an ERESOURCE structure that has not been ExDeleteResourced\n"</span>,
02929                       p, Size
02930                     );
02931             DbgBreakPoint();
02932             ExReleaseSpinLock( &amp;ExpResourceSpinLock, OldIrql );
02933             <span class="keywordflow">return</span> (PVOID)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02934         }
02935 
02936         Next = Next-&gt;Flink;
02937     }
02938 
02939     ExReleaseSpinLock( &amp;ExpResourceSpinLock, OldIrql );
02940     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02941 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ex/resource.c::ExpFindCurrentThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> FASTCALL ExpFindCurrentThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentThread</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02683">2683</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00134">ExpIncrementCounter</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02332">_RESOURCE_PERFORMANCE_DATA::MaximumTableExpand</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a123">OWNER_ENTRY</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02288">_ERESOURCE::OwnerTable</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02281">_OWNER_ENTRY::TableSize</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00762">ExAcquireResourceSharedLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01014">ExAcquireSharedStarveExclusive()</a>, and <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01165">ExAcquireSharedWaitForExclusive()</a>.
<p>
<pre class="fragment"><div>02690                    :
02691 
02692     This function searches <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource
02693     thread array. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> located, then a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02694     array entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value. Otherwise, a pointer
02695     to a free entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02696 
02697 Arguments:
02698 
02699     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search
02700         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed.
02701 
02702     CurrentThread - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> identification of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread to search
02703         <span class="keywordflow">for</span>.
02704 
02705 Return Value:
02706 
02707     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to an owner entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02708 
02709 --*/
02710 
02711 {
02712 
02713     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> FreeEntry;
02714     ULONG NewSize;
02715     ULONG OldSize;
02716     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
02717     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerBound;
02718     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerTable, OldTable;
02719     KIRQL OldIrql;
02720 
02721     <span class="comment">//</span>
02722     <span class="comment">// Search the owner threads for the specified thread and return either</span>
02723     <span class="comment">// a pointer to the found thread or a pointer to a free thread table</span>
02724     <span class="comment">// entry.</span>
02725     <span class="comment">//</span>
02726 
02727     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02728         <span class="keywordflow">return</span> &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0];
02729 
02730     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
02731         <span class="keywordflow">return</span> &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1];
02732 
02733     } <span class="keywordflow">else</span> {
02734         FreeEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02735         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == 0) {
02736             FreeEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1];
02737         }
02738 
02739         OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02740         <span class="keywordflow">if</span> (OwnerEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02741             OldSize = 0;
02742 
02743         } <span class="keywordflow">else</span> {
02744             OldSize = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
02745             OwnerBound = &amp;OwnerEntry[OldSize];
02746             OwnerEntry += 1;
02747             <span class="keywordflow">do</span> {
02748                 <span class="keywordflow">if</span> (OwnerEntry-&gt;OwnerThread == CurrentThread) {
02749                     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ResourceIndex = (UCHAR)(OwnerEntry - <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>);
02750                     <span class="keywordflow">return</span> OwnerEntry;
02751                 }
02752 
02753                 <span class="keywordflow">if</span> ((FreeEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02754                     (OwnerEntry-&gt;OwnerThread == 0)) {
02755                     FreeEntry = OwnerEntry;
02756                 }
02757 
02758                 OwnerEntry += 1;
02759             } <span class="keywordflow">while</span> (OwnerEntry != OwnerBound);
02760         }
02761     }
02762 
02763     <span class="comment">//</span>
02764     <span class="comment">// If a free entry was found in the table, then return the address of the</span>
02765     <span class="comment">// free entry. Otherwise, expand the size of the owner thread table.</span>
02766     <span class="comment">//</span>
02767 
02768     <span class="keywordflow">if</span> (FreeEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02769         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ResourceIndex = (UCHAR)(FreeEntry - <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>);
02770         <span class="keywordflow">return</span> FreeEntry;
02771     }
02772 
02773     <span class="comment">//</span>
02774     <span class="comment">// Allocate an expanded owner table.</span>
02775     <span class="comment">//</span>
02776 
02777     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(OwnerTableExpands);
02778     <span class="keywordflow">if</span> (OldSize == 0 ) {
02779         NewSize = 3;
02780 
02781     } <span class="keywordflow">else</span> {
02782         NewSize = OldSize + 4;
02783     }
02784 
02785     <span class="keywordflow">if</span> (NewSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">OWNER_ENTRY</a>) &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
02786         
02787         OwnerTable = (<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02788             NonPagedPoolMustSucceed,
02789             NewSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">OWNER_ENTRY</a>),
02790             'aTeR');
02791     }
02792     <span class="keywordflow">else</span> {
02793 
02794         <span class="comment">//</span>
02795         <span class="comment">// If allocation is bigger than one page we need to</span>
02796         <span class="comment">// allocate from normal pool. If we fail then we will</span>
02797         <span class="comment">// bugcheck with `must_succeed_pool_empty' because logically</span>
02798         <span class="comment">// this is what we do.</span>
02799         <span class="comment">//</span>
02800 
02801         OwnerTable = (<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02802             NonPagedPool,
02803             NewSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">OWNER_ENTRY</a>),
02804             'aTeR');
02805 
02806         <span class="keywordflow">if</span> (OwnerTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02807             
02808             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a> (MUST_SUCCEED_POOL_EMPTY); 
02809         }
02810 
02811     }
02812 
02813     <span class="comment">//</span>
02814     <span class="comment">// Zero the expanded owner table, compute the address of the owner</span>
02815     <span class="comment">// count and thread tables, and copy the old table to the new table.</span>
02816     <span class="comment">//</span>
02817 
02818     RtlZeroMemory((PVOID)(OwnerTable + OldSize),
02819                   (NewSize - OldSize) * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">OWNER_ENTRY</a>));
02820 
02821     RtlCopyMemory((PVOID)OwnerTable,
02822                    <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>,
02823                    OldSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">OWNER_ENTRY</a>));
02824 
02825     <span class="comment">//</span>
02826     <span class="comment">// If an expanded table was previously allocated, then save it so it can be freed.</span>
02827     <span class="comment">//</span>
02828     OldTable = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02829 
02830     <span class="comment">//</span>
02831     <span class="comment">// Set new owner table parameters and return the address of the first</span>
02832     <span class="comment">// free entry. We need the dispatcher lock here to prevent table expansion while we are boosting</span>
02833     <span class="comment">// thread priorities.</span>
02834     <span class="comment">//</span>
02835     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
02836     OwnerTable-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a> = NewSize;
02837     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a> = OwnerTable;
02838     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
02839 
02840     <span class="keywordflow">if</span> (OldTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02841         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OldTable);
02842     }
02843 
02844     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
02845 
02846 <span class="preprocessor">#if defined(_COLLECT_RESOURCE_DATA_)</span>
02847 <span class="preprocessor"></span>
02848     <span class="keywordflow">if</span> (NewSize &gt; ExpResourcePerformanceData.MaximumTableExpand) {
02849         ExpResourcePerformanceData.MaximumTableExpand = NewSize;
02850     }
02851 
02852 <span class="preprocessor">#endif</span>
02853 <span class="preprocessor"></span>
02854     <span class="keywordflow">if</span> (OldSize == 0) {
02855         OldSize = 1;
02856     }
02857 
02858     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ResourceIndex = (CCHAR)OldSize;
02859     <span class="keywordflow">return</span> &amp;OwnerTable[OldSize];
02860 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ex/resource.c::ExpResourceInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExpResourceInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00150">150</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02323">_RESOURCE_PERFORMANCE_DATA::ActiveResourceCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02325">_RESOURCE_PERFORMANCE_DATA::ExclusiveAcquire</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00114">ExpResourceSpinLock</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00157">ExpSystemResourcesList</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00035">ExpTimeout</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02333">_RESOURCE_PERFORMANCE_DATA::HashTable</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02332">_RESOURCE_PERFORMANCE_DATA::MaximumTableExpand</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02331">_RESOURCE_PERFORMANCE_DATA::OwnerTableExpands</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02313">RESOURCE_HASH_TABLE_SIZE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02326">_RESOURCE_PERFORMANCE_DATA::SharedFirstLevel</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02327">_RESOURCE_PERFORMANCE_DATA::SharedSecondLevel</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02328">_RESOURCE_PERFORMANCE_DATA::StarveFirstLevel</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02329">_RESOURCE_PERFORMANCE_DATA::StarveSecondLevel</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02324">_RESOURCE_PERFORMANCE_DATA::TotalResourceCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02330">_RESOURCE_PERFORMANCE_DATA::WaitForExclusive</a>.
<p>
<pre class="fragment"><div>00156                    :
00157 
00158     This function initializes global data during system initialization.
00159 
00160 Arguments:
00161 
00162     None.
00163 
00164 Return Value:
00165 
00166     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00167 
00168 --*/
00169 
00170 {
00171 
00172     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00173 
00174     <span class="comment">//</span>
00175     <span class="comment">// Initialize resource timeout value, the system resource listhead,</span>
00176     <span class="comment">// and the resource spinlock.</span>
00177     <span class="comment">//</span>
00178 
00179     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a14">ExpTimeout</a>.QuadPart = Int32x32To64(4 * 1000, -10000);
00180     InitializeListHead(&amp;ExpSystemResourcesList);
00181     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;ExpResourceSpinLock);
00182 
00183     <span class="comment">//</span>
00184     <span class="comment">// Initialize resource performance data.</span>
00185     <span class="comment">//</span>
00186 
00187 <span class="preprocessor">#if defined(_COLLECT_RESOURCE_DATA_)</span>
00188 <span class="preprocessor"></span>
00189     ExpResourcePerformanceData.ActiveResourceCount = 0;
00190     ExpResourcePerformanceData.TotalResourceCount = 0;
00191     ExpResourcePerformanceData.ExclusiveAcquire = 0;
00192     ExpResourcePerformanceData.SharedFirstLevel = 0;
00193     ExpResourcePerformanceData.SharedSecondLevel = 0;
00194     ExpResourcePerformanceData.StarveFirstLevel = 0;
00195     ExpResourcePerformanceData.StarveSecondLevel = 0;
00196     ExpResourcePerformanceData.WaitForExclusive = 0;
00197     ExpResourcePerformanceData.OwnerTableExpands = 0;
00198     ExpResourcePerformanceData.MaximumTableExpand = 0;
00199     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d5/d8/ex_8h.html#a65">RESOURCE_HASH_TABLE_SIZE</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00200         InitializeListHead(&amp;ExpResourcePerformanceData.HashTable[Index]);
00201     }
00202 
00203 <span class="preprocessor">#endif</span>
00204 <span class="preprocessor"></span>
00205     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00206 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ex/resource.c::ExpWaitForResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL ExpWaitForResource           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">2506</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02294">_ERESOURCE::ContentionCount</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02453">ExpBoostOwnerThread()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00100">ExpResourceTimeoutCount</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00035">ExpTimeout</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00092">IsBoostAllowed</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00089">IsExclusiveWaiting</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00049">IsSharedWaiting</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02296">_ERESOURCE::NumberOfExclusiveWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02288">_ERESOURCE::OwnerTable</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02281">_OWNER_ENTRY::TableSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00583">_KTHREAD::WaitIrql</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00585">_KTHREAD::WaitNext</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00762">ExAcquireResourceSharedLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01014">ExAcquireSharedStarveExclusive()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01165">ExAcquireSharedWaitForExclusive()</a>, and <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00410">ExpAcquireResourceExclusiveLite()</a>.
<p>
<pre class="fragment"><div>02512                    :
02513 
02514     The routine waits <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource object to be set. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02515     wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too <span class="keywordtype">long</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current owners of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource
02516     are boosted.
02517 
02518 Arguments:
02519 
02520     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to wait <span class="keywordflow">for</span>.
02521 
02522     Object - Supplies a pointer to an event (exclusive) or semaphore
02523        (shared) to wait for.
02524 
02525 Return Value:
02526 
02527     None.
02528 
02529 --*/
02530 
02531 {
02532 
02533     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02534     ULONG Limit;
02535     ULONG Number;
02536     KIRQL OldIrql;
02537     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
02538     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> OwnerThread;
02539     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02540     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> CurrentThread;
02541     LARGE_INTEGER Timeout;
02542 
02543     <span class="comment">//</span>
02544     <span class="comment">// Increment the contention count for the resource, set the initial</span>
02545     <span class="comment">// timeout value, and wait for the specified object to be signalled</span>
02546     <span class="comment">// or a timeout to occur.</span>
02547     <span class="comment">//</span>
02548 
02549     Limit = 0;
02550     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a> += 1;
02551     Timeout.QuadPart = 500 * -10000;
02552     <span class="keywordflow">do</span> {
02553         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (
02554                         Object,
02555                         Executive,
02556                         KernelMode,
02557                         FALSE,
02558                         &amp;Timeout );
02559 
02560         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_TIMEOUT) {
02561             <span class="keywordflow">break</span>;
02562         }
02563 
02564         <span class="comment">//</span>
02565         <span class="comment">// The limit has been exceeded, then output status information.</span>
02566         <span class="comment">//</span>
02567 
02568         Limit += 1;
02569         Timeout = <a class="code" href="../../d7/d4/ddkresrc_8c.html#a14">ExpTimeout</a>;
02570         <span class="keywordflow">if</span> (Limit &gt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a44">ExpResourceTimeoutCount</a>) {
02571             Limit = 0;
02572 
02573             <span class="comment">//</span>
02574             <span class="comment">// Output information for the specified resource.</span>
02575             <span class="comment">//</span>
02576 
02577             ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
02578             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Resource @ %lx\n"</span>, Resource);
02579             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" ActiveCount = %04lx  Flags = %s%s%s\n"</span>,
02580                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a>,
02581                      <a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource) ? <span class="stringliteral">"IsOwnedExclusive "</span> : <span class="stringliteral">""</span>,
02582                      <a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(Resource) ? <span class="stringliteral">"SharedWaiter "</span>     : <span class="stringliteral">""</span>,
02583                      <a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(Resource) ? <span class="stringliteral">"ExclusiveWaiter "</span>  : <span class="stringliteral">""</span>);
02584 
02585             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" NumberOfExclusiveWaiters = %04lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a>);
02586 
02587             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  Thread = %08lx, Count = %02x\n"</span>,
02588                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>,
02589                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>);
02590 
02591             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  Thread = %08lx, Count = %02x\n"</span>,
02592                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>,
02593                      <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>);
02594 
02595             OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02596             <span class="keywordflow">if</span> (OwnerEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02597                 Number = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
02598                 <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
02599                     OwnerEntry += 1;
02600                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  Thread = %08lx, Count = %02x\n"</span>,
02601                              OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>,
02602                              OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a>);
02603                 }
02604             }
02605 
02606             DbgBreakPoint();
02607             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EX - Rewaiting\n"</span>);
02608             ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
02609         }
02610 
02611         <span class="comment">//</span>
02612         <span class="comment">// If priority boosts are allowed, then attempt to boost the priority</span>
02613         <span class="comment">// of owner threads.</span>
02614         <span class="comment">//</span>
02615 
02616         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a8">IsBoostAllowed</a>(Resource)) {
02617 
02618             <span class="comment">//</span>
02619             <span class="comment">// Get the current thread address, lock the dispatcher database,</span>
02620             <span class="comment">// and set wait next in the current thread so the dispatcher</span>
02621             <span class="comment">// database lock does not need to be released before waiting</span>
02622             <span class="comment">// for the resource.</span>
02623             <span class="comment">//</span>
02624             <span class="comment">// N.B. Since the dispatcher database lock instead of the resource</span>
02625             <span class="comment">//      lock is being used to synchronize access to the resource,</span>
02626             <span class="comment">//      it is possible for the information being read from the</span>
02627             <span class="comment">//      resource to be stale. However, the important thing that</span>
02628             <span class="comment">//      cannot change is a valid thread address. Thus a thread</span>
02629             <span class="comment">//      could possibly get boosted that actually has dropped its</span>
02630             <span class="comment">//      access to the resource, but it guaranteed that the thread</span>
02631             <span class="comment">//      cannot be terminated or otherwise deleted.</span>
02632             <span class="comment">//</span>
02633             <span class="comment">// N.B. The dispatcher lock is released by the wait at the top of</span>
02634             <span class="comment">//      loop.</span>
02635             <span class="comment">//</span>
02636 
02637             CurrentThread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
02638 
02639             <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a>);
02640             CurrentThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02641 
02642             <span class="comment">//</span>
02643             <span class="comment">// Attempt to boost the one owner that can be shared or exclusive.</span>
02644             <span class="comment">//</span>
02645 
02646             OwnerThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>;
02647             <span class="keywordflow">if</span> (OwnerThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02648                 <a class="code" href="../../d8/d8/ex_2resource_8c.html#a33">ExpBoostOwnerThread</a>(CurrentThread, OwnerThread);
02649             }
02650 
02651             <span class="comment">//</span>
02652             <span class="comment">// If the specified resource is not owned exclusive, then attempt</span>
02653             <span class="comment">// to boost all the owning shared threads priority.</span>
02654             <span class="comment">//</span>
02655 
02656             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource)) {
02657                 OwnerThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>;
02658                 <span class="keywordflow">if</span> (OwnerThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02659                     <a class="code" href="../../d8/d8/ex_2resource_8c.html#a33">ExpBoostOwnerThread</a>(CurrentThread, OwnerThread);
02660                 }
02661 
02662                 OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
02663                 <span class="keywordflow">if</span> (OwnerEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02664                     Number = OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
02665                     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
02666                         OwnerEntry += 1;
02667                         OwnerThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>;
02668                         <span class="keywordflow">if</span> (OwnerThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02669                             <a class="code" href="../../d8/d8/ex_2resource_8c.html#a33">ExpBoostOwnerThread</a>(CurrentThread, OwnerThread);
02670                         }
02671                     }
02672                 }
02673             }
02674         }
02675 
02676     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02677 
02678     <span class="keywordflow">return</span>;
02679 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="ex/resource.c::ExQuerySystemLockInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ExQuerySystemLockInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PRTL_PROCESS_LOCKS&nbsp;</td>
          <td class="mdname" nowrap> <em>LockInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LockInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02335">2335</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02520">_NTDDK_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00388">_ETHREAD::Cid</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02294">_ERESOURCE::ContentionCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02541">_NTDDK_ERESOURCE::ContentionCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02551">_NTDDK_ERESOURCE::CreatorBackTraceIndex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02299">_ERESOURCE::CreatorBackTraceIndex</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00114">ExpResourceSpinLock</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00157">ExpSystemResourcesList</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02531">_NTDDK_ERESOURCE::InitialOwnerThreads</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02296">_ERESOURCE::NumberOfExclusiveWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02543">_NTDDK_ERESOURCE::NumberOfExclusiveWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02295">_ERESOURCE::NumberOfSharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02544">_NTDDK_ERESOURCE::NumberOfSharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02516">_NTDDK_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02555">PNTDDK_ERESOURCE</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03579">ExpGetLockInformation()</a>.
<p>
<pre class="fragment"><div>02341 {
02342 
02343     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02344     KIRQL OldIrql;
02345     ULONG RequiredLength;
02346     PLIST_ENTRY Head, Next;
02347     PRTL_PROCESS_LOCK_INFORMATION LockInfo;
02348     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02349     <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a> NtDdkResource;
02350     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> OwningThread;
02351 
02352     RequiredLength = FIELD_OFFSET(RTL_PROCESS_LOCKS, Locks);
02353     <span class="keywordflow">if</span> (LockInformationLength &lt; RequiredLength) {
02354         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
02355 
02356     } <span class="keywordflow">else</span> {
02357         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02358         ExAcquireSpinLock(&amp;ExpResourceSpinLock, &amp;OldIrql);
02359         <span class="keywordflow">try</span> {
02360             LockInformation-&gt;NumberOfLocks = 0;
02361             LockInfo = &amp;LockInformation-&gt;Locks[0];
02362             Head = &amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">ExpSystemResourcesList</a>;
02363             Next = Head-&gt;Flink;
02364             <span class="keywordflow">while</span> (Next != Head) {
02365                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = CONTAINING_RECORD(Next,
02366                                              <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>,
02367                                              SystemResourcesList);
02368 
02369                 LockInformation-&gt;NumberOfLocks += 1;
02370                 RequiredLength += <span class="keyword">sizeof</span>(RTL_PROCESS_LOCK_INFORMATION);
02371 
02372                 <span class="comment">//</span>
02373                 <span class="comment">// Detect if this is an NtDdk resource. New lite resources</span>
02374                 <span class="comment">// never contain pointers to themselves.</span>
02375                 <span class="comment">//</span>
02376 
02377                 NtDdkResource = (<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a>)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02378                 <span class="keywordflow">if</span> (NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o1">OwnerThreads</a> != &amp;NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o8">InitialOwnerThreads</a>[0]) {
02379                     NtDdkResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02380                 }
02381 
02382                 <span class="keywordflow">if</span> (LockInformationLength &lt; RequiredLength) {
02383                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
02384 
02385                 } <span class="keywordflow">else</span> {
02386                     LockInfo-&gt;Address = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02387                     LockInfo-&gt;Type = RTL_RESOURCE_TYPE;
02388                     LockInfo-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a> = 0;
02389 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02390 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (NtDdkResource) {
02391                         LockInfo-&gt;CreatorBackTraceIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o16">CreatorBackTraceIndex</a>;
02392                     } <span class="keywordflow">else</span> {
02393                         LockInfo-&gt;CreatorBackTraceIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a>;
02394                     }
02395 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02396 <span class="preprocessor"></span>
02397                     <span class="keywordflow">if</span> (NtDdkResource) {
02398                         <span class="keywordflow">if</span> ((NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o1">OwnerThreads</a>[0] != 0) &amp;&amp;
02399                             ((NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o1">OwnerThreads</a>[0] &amp; 3) == 0)) {
02400                             OwningThread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o1">OwnerThreads</a>[0]);
02401                             LockInfo-&gt;OwningThread = OwningThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread;
02402 
02403                         } <span class="keywordflow">else</span> {
02404                             LockInfo-&gt;OwningThread = 0;
02405                         }
02406 
02407                         LockInfo-&gt;LockCount = NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o4">ActiveCount</a>;
02408                         LockInfo-&gt;ContentionCount = NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o10">ContentionCount</a>;
02409                         LockInfo-&gt;NumberOfWaitingShared = NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o12">NumberOfSharedWaiters</a>;
02410                         LockInfo-&gt;NumberOfWaitingExclusive = NtDdkResource-&gt;<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html#o11">NumberOfExclusiveWaiters</a>;
02411 
02412                     } <span class="keywordflow">else</span> {
02413                         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != 0) &amp;&amp;
02414                             ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> &amp; 3) == 0)) {
02415                             OwningThread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
02416                             LockInfo-&gt;OwningThread = OwningThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread;
02417 
02418                         } <span class="keywordflow">else</span> {
02419                             LockInfo-&gt;OwningThread = 0;
02420                         }
02421 
02422                         LockInfo-&gt;LockCount = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a>;
02423                         LockInfo-&gt;ContentionCount = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>;
02424                         LockInfo-&gt;NumberOfWaitingShared = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
02425                         LockInfo-&gt;NumberOfWaitingExclusive = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a>;
02426                     }
02427 
02428                     LockInfo += 1;
02429                 }
02430 
02431                 <span class="keywordflow">if</span> (Next == Next-&gt;Flink) {
02432                     Next = Head;
02433 
02434                 } <span class="keywordflow">else</span> {
02435                     Next = Next-&gt;Flink;
02436                 }
02437             }
02438 
02439         } finally {
02440             ExReleaseSpinLock(&amp;ExpResourceSpinLock, OldIrql);
02441         }
02442     }
02443 
02444     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
02445         *ReturnLength = RequiredLength;
02446     }
02447 
02448     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02449 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="ex/resource.c::ExReinitializeResourceLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ExReinitializeResourceLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00273">273</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02294">_ERESOURCE::ContentionCount</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02292">_ERESOURCE::ExclusiveWaiters</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02290">_ERESOURCE::Flag</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00039">KeInitializeSemaphore()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00437">MmDeterminePoolType()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02296">_ERESOURCE::NumberOfExclusiveWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02295">_ERESOURCE::NumberOfSharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02288">_ERESOURCE::OwnerTable</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02291">_ERESOURCE::SharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02281">_OWNER_ENTRY::TableSize</a>.
<p>
<pre class="fragment"><div>00279                    :
00280 
00281     This routine reinitializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource.
00282 
00283 Arguments:
00284 
00285     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to initialize.
00286 
00287 Return Value:
00288 
00289     STATUS_SUCCESS.
00290 
00291 --*/
00292 
00293 {
00294 
00295     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00296     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00297     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerTable;
00298     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> Semaphore;
00299     ULONG TableSize;
00300 
00301     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d6/allocpag_8c.html#a48">MmDeterminePoolType</a>(Resource) == NonPagedPool);
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">// If the resource has an owner table, then zero the owner table.</span>
00305     <span class="comment">//</span>
00306 
00307     OwnerTable = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
00308     <span class="keywordflow">if</span> (OwnerTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00309         TableSize = OwnerTable-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>;
00310         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; TableSize; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00311             OwnerTable[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
00312             OwnerTable[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 0;
00313         }
00314     }
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">// Set the active count and flags to zero.</span>
00318     <span class="comment">//</span>
00319 
00320     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 0;
00321     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> = 0;
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">// If the resource has a shared waiter semaphore, then reinitialize</span>
00325     <span class="comment">// it.</span>
00326     <span class="comment">//</span>
00327 
00328     Semaphore = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>;
00329     <span class="keywordflow">if</span> (Semaphore != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00330         <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(Semaphore, 0, MAXLONG);
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// If the resource has a exclusive waiter event, then reinitialize</span>
00335     <span class="comment">// it.</span>
00336     <span class="comment">//</span>
00337 
00338     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>;
00339     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00340         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(Event, SynchronizationEvent, FALSE);
00341     }
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Initialize the builtin owner table.</span>
00345     <span class="comment">//</span>
00346 
00347     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
00348     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 0;
00349     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
00350     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 0;
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">// Set the contention count, number of shared waiters, and number</span>
00354     <span class="comment">// of exclusive waiters to zero.</span>
00355     <span class="comment">//</span>
00356 
00357     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a> = 0;
00358     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> = 0;
00359     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> = 0;
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">// Reinitialize the resource spinlock.</span>
00363     <span class="comment">//</span>
00364 
00365     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>);
00366     <span class="keywordflow">return</span> STATUS_SUCCESS;
00367 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="ex/resource.c::ExReleaseResourceForThreadLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExReleaseResourceForThreadLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentThread</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01607">1607</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02292">_ERESOURCE::ExclusiveWaiters</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02290">_ERESOURCE::Flag</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00089">IsExclusiveWaiting</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00049">IsSharedWaiting</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00458">KeSetEventBoostPriority()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02296">_ERESOURCE::NumberOfExclusiveWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02295">_ERESOURCE::NumberOfSharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02288">_ERESOURCE::OwnerTable</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02311">ResourceOwnedExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02291">_ERESOURCE::SharedWaiters</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02281">_OWNER_ENTRY::TableSize</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01614                    :
01615 
01616     This routine release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread
01617     and decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> recursion count. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count reaches zero, then
01618     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource may also be released.
01619 
01620     N.B. This routine uses fast locking.
01621 
01622 Arguments:
01623 
01624     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to release.
01625 
01626     Thread - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread that originally acquired <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource.
01627 
01628 Return Value:
01629 
01630     None.
01631 
01632 --*/
01633 
01634 {
01635 
01636     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01637     ULONG Number;
01638     KIRQL OldIrql;
01639     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
01640 
01641     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CurrentThread != 0);
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01645     <span class="comment">//</span>
01646 
01647     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01648 
01649     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
01650 
01651     <span class="comment">//</span>
01652     <span class="comment">// If the resource is exclusively owned, then release exclusive</span>
01653     <span class="comment">// ownership. Otherwise, release shared ownership.</span>
01654     <span class="comment">//</span>
01655     <span class="comment">// N.B. The two release paths are split since this is such a high</span>
01656     <span class="comment">//      frequency function.</span>
01657     <span class="comment">//</span>
01658 
01659     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource)) {
01660 
01661         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread);
01662 
01663         <span class="comment">//</span>
01664         <span class="comment">// Decrement the recursion count and check if ownership can be</span>
01665         <span class="comment">// released.</span>
01666         <span class="comment">//</span>
01667 
01668         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> &gt; 0);
01669 
01670         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0) {
01671             ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01672             <span class="keywordflow">return</span>;
01673         }
01674 
01675         <span class="comment">//</span>
01676         <span class="comment">// Clear the owner thread.</span>
01677         <span class="comment">//</span>
01678 
01679         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
01680 
01681         <span class="comment">//</span>
01682         <span class="comment">// The thread recursion count reached zero so decrement the resource</span>
01683         <span class="comment">// active count. If the active count reaches zero, then the resource</span>
01684         <span class="comment">// is no longer owned and an attempt should be made to grant access to</span>
01685         <span class="comment">// another thread.</span>
01686         <span class="comment">//</span>
01687 
01688         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01689 
01690         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01691 
01692             <span class="comment">//</span>
01693             <span class="comment">// If there are shared waiters, then grant shared access to the</span>
01694             <span class="comment">// resource. Otherwise, grant exclusive ownership if there are</span>
01695             <span class="comment">// exclusive waiters.</span>
01696             <span class="comment">//</span>
01697 
01698             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(Resource)) {
01699                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01700                 Number = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
01701                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> =  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)Number;
01702                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> = 0;
01703                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01704                 <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>, 0, Number, FALSE);
01705                 <span class="keywordflow">return</span>;
01706 
01707             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(Resource)) {
01708                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 1;
01709                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01710                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01711                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> -= 1;
01712                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01713                 <a class="code" href="../../d2/d8/eventobj_8c.html#a9">KeSetEventBoostPriority</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>,
01714                                         (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> *)&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
01715                 <span class="keywordflow">return</span>;
01716             }
01717 
01718             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01719         }
01720 
01721     } <span class="keywordflow">else</span> {
01722         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01723             OwnerEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1];
01724 
01725         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01726             OwnerEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0];
01727 
01728         } <span class="keywordflow">else</span> {
01729 
01730             <span class="comment">//</span>
01731             <span class="comment">// If the specified current thread is an owner address (low</span>
01732             <span class="comment">// bits are nonzero), then set the hint index to the first</span>
01733             <span class="comment">// entry. Otherwise, set the hint index from the owner thread.</span>
01734             <span class="comment">//</span>
01735 
01736             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
01737             <span class="keywordflow">if</span> (((ULONG)CurrentThread &amp; 3) == 0) {
01738                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)(CurrentThread))-&gt;ResourceIndex;
01739             }
01740 
01741             OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
01742 
01743             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry != NULL);
01744 
01745             <span class="comment">//</span>
01746             <span class="comment">// If the resource hint is not within range or the resource</span>
01747             <span class="comment">// table entry does match the current thread, then search</span>
01748             <span class="comment">// the owner table for a match.</span>
01749             <span class="comment">//</span>
01750 
01751             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>) ||
01752                 (OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != CurrentThread)) {
01753                 <span class="keywordflow">do</span> {
01754                     OwnerEntry += 1;
01755                     <span class="keywordflow">if</span> (OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01756                         <span class="keywordflow">break</span>;
01757                     }
01758 
01759                 } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01760 
01761             } <span class="keywordflow">else</span> {
01762                 OwnerEntry = &amp;OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01763             }
01764         }
01765 
01766         <span class="comment">//</span>
01767         <span class="comment">// Decrement the recursion count and check if ownership can be</span>
01768         <span class="comment">// released.</span>
01769         <span class="comment">//</span>
01770 
01771         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread);
01772         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> &gt; 0);
01773 
01774         <span class="keywordflow">if</span> (--OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0) {
01775             ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01776             <span class="keywordflow">return</span>;
01777         }
01778 
01779         <span class="comment">//</span>
01780         <span class="comment">// Clear the owner thread.</span>
01781         <span class="comment">//</span>
01782 
01783         OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
01784 
01785         <span class="comment">//</span>
01786         <span class="comment">// The thread recursion count reached zero so decrement the resource</span>
01787         <span class="comment">// active count. If the active count reaches zero, then the resource</span>
01788         <span class="comment">// is no longer owned and an attempt should be made to grant access to</span>
01789         <span class="comment">// another thread.</span>
01790         <span class="comment">//</span>
01791 
01792         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01793 
01794         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01795 
01796             <span class="comment">//</span>
01797             <span class="comment">// If there are exclusive waiters, then grant exclusive access</span>
01798             <span class="comment">// to the resource.</span>
01799             <span class="comment">//</span>
01800 
01801             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(Resource)) {
01802                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01803                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 1;
01804                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01805                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01806                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> -= 1;
01807                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01808                 <a class="code" href="../../d2/d8/eventobj_8c.html#a9">KeSetEventBoostPriority</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>,
01809                                         (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> *)&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
01810                 <span class="keywordflow">return</span>;
01811             }
01812         }
01813     }
01814 
01815     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01816     <span class="keywordflow">return</span>;
01817 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="ex/resource.c::ExReleaseResourceLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL ExReleaseResourceLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01389">1389</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02292">_ERESOURCE::ExclusiveWaiters</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02290">_ERESOURCE::Flag</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00089">IsExclusiveWaiting</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00049">IsSharedWaiting</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00458">KeSetEventBoostPriority()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02296">_ERESOURCE::NumberOfExclusiveWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02295">_ERESOURCE::NumberOfSharedWaiters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02288">_ERESOURCE::OwnerTable</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02311">ResourceOwnedExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02291">_ERESOURCE::SharedWaiters</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l02281">_OWNER_ENTRY::TableSize</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02986">MmTrimAllSystemPagableMemory()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l02208">VerifierExReleaseResource()</a>.
<p>
<pre class="fragment"><div>01395                    :
01396 
01397     This routine releases <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread
01398     and decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> recursion count. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count reaches zero, then
01399     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource may also be released.
01400 
01401     N.B. This routine uses fast locking.
01402 
01403 Arguments:
01404 
01405     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to release.
01406 
01407 Return Value:
01408 
01409     None.
01410 
01411 --*/
01412 
01413 {
01414 
01415     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
01416     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01417     ULONG Number;
01418     KIRQL OldIrql;
01419     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry, OwnerEnd;
01420 
01421     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01422 
01423     <span class="comment">//</span>
01424     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01425     <span class="comment">//</span>
01426 
01427     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01428 
01429     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
01430 
01431     <span class="comment">//</span>
01432     <span class="comment">// If the resource is exclusively owned, then release exclusive</span>
01433     <span class="comment">// ownership. Otherwise, release shared ownership.</span>
01434     <span class="comment">//</span>
01435     <span class="comment">// N.B. The two release paths are split since this is such a high</span>
01436     <span class="comment">//      frequency function.</span>
01437     <span class="comment">//</span>
01438 
01439     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource)) {
01440 
01441 <span class="comment">//        if (Resource-&gt;OwnerThreads[0].OwnerThread != CurrentThread) {</span>
01442 <span class="comment">//            KeBugCheckEx(RESOURCE_NOT_OWNED,</span>
01443 <span class="comment">//                         (ULONG_PTR)Resource,</span>
01444 <span class="comment">//                         (ULONG_PTR)CurrentThread,</span>
01445 <span class="comment">//                         (ULONG_PTR)Resource-&gt;OwnerTable,</span>
01446 <span class="comment">//                         0x1);</span>
01447 <span class="comment">//        }</span>
01448 
01449         <span class="comment">//</span>
01450         <span class="comment">// Decrement the recursion count and check if ownership can be</span>
01451         <span class="comment">// released.</span>
01452         <span class="comment">//</span>
01453 
01454         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> &gt; 0);
01455 
01456         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> != 0) {
01457             ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01458             <span class="keywordflow">return</span>;
01459         }
01460 
01461         <span class="comment">//</span>
01462         <span class="comment">// Clear the owner thread.</span>
01463         <span class="comment">//</span>
01464 
01465         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 0;
01466 
01467         <span class="comment">//</span>
01468         <span class="comment">// The thread recursion count reached zero so decrement the resource</span>
01469         <span class="comment">// active count. If the active count reaches zero, then the resource</span>
01470         <span class="comment">// is no longer owned and an attempt should be made to grant access to</span>
01471         <span class="comment">// another thread.</span>
01472         <span class="comment">//</span>
01473 
01474         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01475 
01476         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01477 
01478             <span class="comment">//</span>
01479             <span class="comment">// If there are shared waiters, then grant shared access to the</span>
01480             <span class="comment">// resource. Otherwise, grant exclusive ownership if there are</span>
01481             <span class="comment">// exclusive waiters.</span>
01482             <span class="comment">//</span>
01483 
01484             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/ex_2resource_8c.html#a1">IsSharedWaiting</a>(Resource)) {
01485                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01486                 Number = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>;
01487                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> =  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)Number;
01488                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a> = 0;
01489                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01490                 <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>, 0, Number, FALSE);
01491                 <span class="keywordflow">return</span>;
01492 
01493             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(Resource)) {
01494                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 1;
01495                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01496                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01497                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> -= 1;
01498                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01499                 <a class="code" href="../../d2/d8/eventobj_8c.html#a9">KeSetEventBoostPriority</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>,
01500                                         (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> *)&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
01501                 <span class="keywordflow">return</span>;
01502             }
01503 
01504             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01505         }
01506 
01507     } <span class="keywordflow">else</span> {
01508         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01509             OwnerEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1];
01510 
01511         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01512             OwnerEntry = &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0];
01513 
01514         } <span class="keywordflow">else</span> {
01515             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)(CurrentThread))-&gt;ResourceIndex;
01516             OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
01517 
01518             <span class="keywordflow">if</span> (OwnerEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01519                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(RESOURCE_NOT_OWNED,
01520                              (ULONG_PTR)Resource,
01521                              (ULONG_PTR)CurrentThread,
01522                              (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>,
01523                              0x2);
01524             }
01525 
01526             <span class="comment">//</span>
01527             <span class="comment">// If the resource hint is not within range or the resource</span>
01528             <span class="comment">// table entry does match the current thread, then search</span>
01529             <span class="comment">// the owner table for a match.</span>
01530             <span class="comment">//</span>
01531 
01532             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= OwnerEntry-&gt;<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o2">TableSize</a>) ||
01533                 (OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> != CurrentThread)) {
01534                 OwnerEnd = &amp;OwnerEntry[OwnerEntry-&gt;TableSize];
01535                 <span class="keywordflow">while</span> (1) {
01536                     OwnerEntry += 1;
01537                     <span class="keywordflow">if</span> (OwnerEntry &gt;= OwnerEnd) {
01538                        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(RESOURCE_NOT_OWNED,
01539                              (ULONG_PTR)Resource,
01540                              (ULONG_PTR)CurrentThread,
01541                              (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>,
01542                              0x3);
01543                     }
01544                     <span class="keywordflow">if</span> (OwnerEntry-&gt;OwnerThread == CurrentThread) {
01545                         <span class="keywordflow">break</span>;
01546                     }
01547                 };
01548             } <span class="keywordflow">else</span> {
01549                 OwnerEntry = &amp;OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01550             }
01551         }
01552 
01553         <span class="comment">//</span>
01554         <span class="comment">// Decrement the recursion count and check if ownership can be</span>
01555         <span class="comment">// released.</span>
01556         <span class="comment">//</span>
01557 
01558         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;OwnerThread == CurrentThread);
01559         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry-&gt;OwnerCount &gt; 0);
01560 
01561         <span class="keywordflow">if</span> (--OwnerEntry-&gt;OwnerCount != 0) {
01562             ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01563             <span class="keywordflow">return</span>;
01564         }
01565 
01566         <span class="comment">//</span>
01567         <span class="comment">// Clear the owner thread.</span>
01568         <span class="comment">//</span>
01569 
01570         OwnerEntry-&gt;OwnerThread = 0;
01571 
01572         <span class="comment">//</span>
01573         <span class="comment">// The thread recursion count reached zero so decrement the resource</span>
01574         <span class="comment">// active count. If the active count reaches zero, then the resource</span>
01575         <span class="comment">// is no longer owned and an attempt should be made to grant access to</span>
01576         <span class="comment">// another thread.</span>
01577         <span class="comment">//</span>
01578 
01579         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> &gt; 0);
01580 
01581         <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
01582 
01583             <span class="comment">//</span>
01584             <span class="comment">// If there are exclusive waiters, then grant exclusive access</span>
01585             <span class="comment">// to the resource.</span>
01586             <span class="comment">//</span>
01587 
01588             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(Resource)) {
01589                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
01590                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = 1;
01591                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
01592                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
01593                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> -= 1;
01594                 ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01595                 <a class="code" href="../../d2/d8/eventobj_8c.html#a9">KeSetEventBoostPriority</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>,
01596                                         (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> *)&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a>);
01597                 <span class="keywordflow">return</span>;
01598             }
01599         }
01600     }
01601 
01602     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01603     <span class="keywordflow">return</span>;
01604 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="ex/resource.c::ExSetResourceOwnerPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExSetResourceOwnerPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerPointer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01820">1820</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02288">_ERESOURCE::OwnerTable</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02281">_OWNER_ENTRY::TableSize</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01078">CcSetBcbOwnerPointer()</a>.
<p>
<pre class="fragment"><div>01827                    :
01828 
01829     This routine locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread and stores
01830     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified owner address as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner thread. Subsequent to calling
01831     <span class="keyword">this</span> routine, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> routine which may be called <span class="keywordflow">for</span> <span class="keyword">this</span> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01832     <a class="code" href="../../d5/d8/ex_8h.html#a71">ExReleaseResourceForThread</a>, supplying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner address as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"thread"</span>.
01833 
01834     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> addresses must obey <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following rules:
01835 
01836         They must be a unique pointer to a structure allocated in system space,
01837         and they must point to a structure which remains allocated until after
01838         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to <a class="code" href="../../d5/d8/ex_8h.html#a71">ExReleaseResourceForThread</a>. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to eliminate aliasing
01839         with a thread or other owner address.
01840 
01841         The <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> order two bits of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner address must be set by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller,
01842         so that other <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <span class="keyword">package </span>can distinguish owner
01843         address from thread addresses.
01844 
01845     N.B. This routine uses fast locking.
01846 
01847 Arguments:
01848 
01849     Resource - Supplies a pointer to the resource to release.
01850 
01851     OwnerPointer - Supplies a pointer to an allocated structure with the low
01852         order two bits set.
01853 
01854 Return Value:
01855 
01856     None.
01857 
01858 --*/
01859 
01860 {
01861 
01862     ERESOURCE_THREAD CurrentThread;
01863     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01864     KIRQL OldIrql;
01865     <a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html">POWNER_ENTRY</a> OwnerEntry;
01866 
01867     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((OwnerPointer != 0) &amp;&amp; (((ULONG_PTR)OwnerPointer &amp; 3) == 3));
01868 
01869     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01870 
01871     <span class="comment">//</span>
01872     <span class="comment">// Acquire exclusive access to the specified resource.</span>
01873     <span class="comment">//</span>
01874 
01875     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
01876 
01877     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
01878 
01879     <span class="comment">//</span>
01880     <span class="comment">// If the resource is exclusively owned, then it is the first owner entry.</span>
01881     <span class="comment">//</span>
01882 
01883     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource)) {
01884 
01885         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread);
01886 
01887         <span class="comment">//</span>
01888         <span class="comment">// Set the owner address.</span>
01889         <span class="comment">//</span>
01890 
01891         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> &gt; 0);
01892 
01893         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = (ULONG_PTR)OwnerPointer;
01894 
01895     <span class="comment">//</span>
01896     <span class="comment">//  For shared access we have to search for the current thread to set</span>
01897     <span class="comment">//  the owner address.</span>
01898     <span class="comment">//</span>
01899 
01900     } <span class="keywordflow">else</span> {
01901         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01902             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[1].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = (ULONG_PTR)OwnerPointer;
01903 
01904         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread) {
01905             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = (ULONG_PTR)OwnerPointer;
01906 
01907         } <span class="keywordflow">else</span> {
01908             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)(CurrentThread))-&gt;ResourceIndex;
01909             OwnerEntry = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o1">OwnerTable</a>;
01910 
01911             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OwnerEntry != NULL);
01912 
01913             <span class="comment">//</span>
01914             <span class="comment">// If the resource hint is not within range or the resource</span>
01915             <span class="comment">// table entry does match the current thread, then search</span>
01916             <span class="comment">// the owner table for a match.</span>
01917             <span class="comment">//</span>
01918 
01919             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= OwnerEntry-&gt;TableSize) ||
01920                 (OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwnerThread != CurrentThread)) {
01921                 <span class="keywordflow">do</span> {
01922                     OwnerEntry += 1;
01923                     <span class="keywordflow">if</span> (OwnerEntry-&gt;OwnerThread == CurrentThread) {
01924                         <span class="keywordflow">break</span>;
01925                     }
01926 
01927                 } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01928 
01929             } <span class="keywordflow">else</span> {
01930                 OwnerEntry = &amp;OwnerEntry[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01931             }
01932 
01933             OwnerEntry-&gt;OwnerThread = (ULONG_PTR)OwnerPointer;
01934         }
01935     }
01936 
01937     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
01938     <span class="keywordflow">return</span>;
01939 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="ex/resource.c::ExTryToAcquireResourceExclusiveLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExTryToAcquireResourceExclusiveLite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00598">598</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02289">_ERESOURCE::ActiveCount</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00070">ASSERT_RESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00134">ExpIncrementCounter</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02290">_ERESOURCE::Flag</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00091">IsOwnedExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02280">_OWNER_ENTRY::OwnerCount</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02278">_OWNER_ENTRY::OwnerThread</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02293">_ERESOURCE::OwnerThreads</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02309">ResourceNeverExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02311">ResourceOwnedExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02302">_ERESOURCE::SpinLock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02986">MmTrimAllSystemPagableMemory()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>00604                    :
00605 
00606     The routine attempts to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource <span class="keywordflow">for</span> exclusive
00607     access.
00608 
00609     N.B. This routine uses fast locking.
00610 
00611 Arguments:
00612 
00613     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired
00614         <span class="keywordflow">for</span> exclusive access.
00615 
00616 Return Value:
00617 
00618     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00619 
00620 --*/
00621 
00622 {
00623 
00624     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> CurrentThread;
00625     KIRQL OldIrql;
00626     BOOLEAN Result;
00627 
00628     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp; ResourceNeverExclusive) == 0);
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">// Attempt to acquire exclusive access to the specified resource.</span>
00632     <span class="comment">//</span>
00633 
00634     CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00635     ExAcquireFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, &amp;OldIrql);
00636 
00637     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeIsExecutingDpc() == FALSE);
00638     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>(Resource);
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">// If the active count of the resource is zero, then there is neither</span>
00642     <span class="comment">// an exclusive owner nor a shared owner and access to the resource can</span>
00643     <span class="comment">// be immediately granted. Otherwise, if the resource is owned exclusive</span>
00644     <span class="comment">// and the current thread is the owner, then access to the resource can</span>
00645     <span class="comment">// be immediately granted. Otherwise, access cannot be granted.</span>
00646     <span class="comment">//</span>
00647 
00648     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00649     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
00650         <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(ExclusiveAcquire);
00651         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> |= <a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
00652         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> = CurrentThread;
00653         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> = 1;
00654         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> = 1;
00655         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00656 
00657     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource) &amp;&amp;
00658         (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o0">OwnerThread</a> == CurrentThread)) {
00659         <a class="code" href="../../d8/d8/ex_2resource_8c.html#a6">ExpIncrementCounter</a>(ExclusiveAcquire);
00660         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0].<a class="code" href="../../d6/d7/struct__OWNER__ENTRY.html#o1">OwnerCount</a> += 1;
00661         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00662     }
00663 
00664     ExReleaseFastLock(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a>, OldIrql);
00665     <span class="keywordflow">return</span> Result;
00666 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a9" doxytag="ex/resource.c::ExpResourceSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d8/d8/ex_2resource_8c.html#a9">ExpResourceSpinLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00114">114</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02005">ExDeleteResourceLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00209">ExInitializeResourceLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02894">ExpCheckForResource()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00150">ExpResourceInitialization()</a>, and <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02335">ExQuerySystemLockInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ex/resource.c::ExpResourceTimeoutCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d8/ex_2resource_8c.html#a8">ExpResourceTimeoutCount</a> = 648000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00108">108</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ex/resource.c::ExpSystemResourcesList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d5/4_2kddata_8c.html#a2">ExpSystemResourcesList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00120">120</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ex/resource.c::ExpTimeout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LARGE_INTEGER <a class="el" href="../../d8/d8/ex_2resource_8c.html#a7">ExpTimeout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00102">102</a> of file <a class="el" href="../../d9/d7/ex_2resource_8c-source.html">ex/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00150">ExpResourceInitialization()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02506">ExpWaitForResource()</a>, and <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00463">ExpWaitForResourceDdk()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
