<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntuser/kernel/clipbrd.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>clipbrd.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a0">DUMMY_TEXT_HANDLE</a>&nbsp;&nbsp;&nbsp;(HANDLE)0x0001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>&nbsp;&nbsp;&nbsp;(HANDLE)0x0002</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a2">DUMMY_METARENDER_HANDLE</a>&nbsp;&nbsp;&nbsp;(HANDLE)0x0003</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a3">DUMMY_METACLONE_HANDLE</a>&nbsp;&nbsp;&nbsp;(HANDLE)0x0004</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a4">DUMMY_MAX_HANDLE</a>&nbsp;&nbsp;&nbsp;(HANDLE)0x0004</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a5">PRIVATEFORMAT</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a6">GDIFORMAT</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a7">HANDLEFORMAT</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a8">METAFILEFORMAT</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a9">IsTextHandle</a>(fmt, hdata)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a10">IsDibHandle</a>(fmt, hdata)&nbsp;&nbsp;&nbsp;(((fmt) == CF_DIB) &amp;&amp; ((hdata) != DUMMY_DIB_HANDLE))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a11">IsMetaDummyHandle</a>(hdata)&nbsp;&nbsp;&nbsp;((hdata == DUMMY_METACLONE_HANDLE) || (hdata == DUMMY_METARENDER_HANDLE))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a12">CCHFORMATNAME</a>&nbsp;&nbsp;&nbsp;256</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a13">lpbch</a>&nbsp;&nbsp;&nbsp;((LPBITMAPCOREHEADER)lpbih)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a15">_ConvertMemHandle</a> (LPBYTE ccxlpData, int cbData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a16">xxxOpenClipboard</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, LPBOOL lpfEmptyClient)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a17">xxxDrawClipboard</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a18">PasteScreenPalette</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a19">MungeClipData</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a20">xxxCloseClipboard</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UINT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a21">_EnumClipboardFormats</a> (UINT fmt)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a22">UT_GetFormatType</a> (<a class="el" href="../../d5/d0/structtagCLIP.html">PCLIP</a> pClip)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a23">UT_FreeCBFormat</a> (<a class="el" href="../../d5/d0/structtagCLIP.html">PCLIP</a> pClip)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a24">xxxSendClipboardMessage</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, UINT message)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a25">xxxEmptyClipboard</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a26">_SetClipboardData</a> (UINT fmt, HANDLE hData, BOOL fGlobalHandle, BOOL fIncSerialNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a27">InternalSetClipboardData</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, UINT fmt, HANDLE hData, BOOL fGlobalHandle, BOOL fIncSerialNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HBITMAP&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a28">CreateScreenBitmap</a> (int cx, int <a class="el" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, UINT bpp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a29">SizeOfDib</a> (LPBITMAPINFOHEADER lpDib)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HBITMAP&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a30">DIBtoBMP</a> (LPBITMAPINFOHEADER lpbih, HPALETTE hpal)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LPBITMAPINFOHEADER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a31">BMPtoDIB</a> (HBITMAP hbmp, HPALETTE hpal, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *pcbSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LPBITMAPV5HEADER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a32">DIBtoDIBV5</a> (LPBITMAPINFOHEADER lpDib, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LPBITMAPV5HEADER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a33">BMPtoDIBV5</a> (HBITMAP hbmp, HPALETTE hpal)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a34">xxxGetDummyBitmap</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, <a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a> pgcd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a35">xxxGetDummyDib</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, <a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a> pgcd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a36">xxxGetDummyDibV5</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, <a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a> pgcd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HPALETTE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a37">CreateDIBPalette</a> (LPBITMAPINFOHEADER pbmih, UINT colors)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a38">xxxGetDummyPalette</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, <a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a> pgcd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a39">xxxGetDummyText</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, UINT fmt, <a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a> pgcd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a40">xxxGetRenderData</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, UINT fmt)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a41">xxxGetClipboardData</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, UINT fmt, <a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a> pgcd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d0/structtagCLIP.html">PCLIP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a42">FindClipFormat</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, UINT <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a8">format</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a43">_GetPriorityClipboardFormat</a> (<a class="el" href="../../d9/d5/ndismain_8h.html#a266">PUINT</a> lpPriorityList, int cfmts)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a44">xxxSetClipboardViewer</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndClipViewerNew)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a45">xxxChangeClipboardChain</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndRemove, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndNewNext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a46">DisownClipboard</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndClipOwner)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a47">ForceEmptyClipboard</a> (<a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a12" doxytag="ntuser/kernel/clipbrd.c::CCHFORMATNAME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CCHFORMATNAME&nbsp;&nbsp;&nbsp;256          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01005">1005</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01007">InternalSetClipboardData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ntuser/kernel/clipbrd.c::DUMMY_DIB_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DUMMY_DIB_HANDLE&nbsp;&nbsp;&nbsp;(HANDLE)0x0002          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00020">20</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01658">xxxGetDummyBitmap()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">xxxGetDummyDib()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02111">xxxGetDummyPalette()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ntuser/kernel/clipbrd.c::DUMMY_MAX_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DUMMY_MAX_HANDLE&nbsp;&nbsp;&nbsp;(HANDLE)0x0004          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00023">23</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00953">_SetClipboardData()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02111">xxxGetDummyPalette()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ntuser/kernel/clipbrd.c::DUMMY_METACLONE_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DUMMY_METACLONE_HANDLE&nbsp;&nbsp;&nbsp;(HANDLE)0x0004          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00022">22</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ntuser/kernel/clipbrd.c::DUMMY_METARENDER_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DUMMY_METARENDER_HANDLE&nbsp;&nbsp;&nbsp;(HANDLE)0x0003          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00021">21</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ntuser/kernel/clipbrd.c::DUMMY_TEXT_HANDLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DUMMY_TEXT_HANDLE&nbsp;&nbsp;&nbsp;(HANDLE)0x0001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00019">19</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00953">_SetClipboardData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02687">DisownClipboard()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02200">xxxGetDummyText()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ntuser/kernel/clipbrd.c::GDIFORMAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GDIFORMAT&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00026">26</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00668">UT_GetFormatType()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ntuser/kernel/clipbrd.c::HANDLEFORMAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HANDLEFORMAT&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00027">27</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00668">UT_GetFormatType()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ntuser/kernel/clipbrd.c::IsDibHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsDibHandle          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">fmt,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>hdata&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((fmt) == CF_DIB) &amp;&amp; ((hdata) != DUMMY_DIB_HANDLE))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00034">34</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ntuser/kernel/clipbrd.c::IsMetaDummyHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsMetaDummyHandle          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">hdata&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((hdata == DUMMY_METACLONE_HANDLE) || (hdata == DUMMY_METARENDER_HANDLE))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00036">36</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ntuser/kernel/clipbrd.c::IsTextHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsTextHandle          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">fmt,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>hdata&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(((hdata) != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a0">DUMMY_TEXT_HANDLE</a>) &amp;&amp; \
     (((fmt) == CF_TEXT) || ((fmt) == CF_OEMTEXT) || ((fmt) == CF_UNICODETEXT)))
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00030">30</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02687">DisownClipboard()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ntuser/kernel/clipbrd.c::lpbch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define lpbch&nbsp;&nbsp;&nbsp;((LPBITMAPCOREHEADER)lpbih)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ntuser/kernel/clipbrd.c::METAFILEFORMAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define METAFILEFORMAT&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00028">28</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00668">UT_GetFormatType()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ntuser/kernel/clipbrd.c::PRIVATEFORMAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PRIVATEFORMAT&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00025">25</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00668">UT_GetFormatType()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a15" doxytag="ntuser/kernel/clipbrd.c::_ConvertMemHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE _ConvertMemHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPBYTE&nbsp;</td>
          <td class="mdname" nowrap> <em>ccxlpData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>cbData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00088">88</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02453">tagCLIPDATA::abData</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02452">tagCLIPDATA::cbData</a>, <a class="el" href="../../d4/d1/userk_8h.html#a824">CLIPDATA</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d1/userk_8h.html#a825">PCLIPDATA</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01513">PtoHq</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00911">TYPE_CLIPDATA</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03310">NtUserConvertMemHandle()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">xxxGetDummyDib()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>.
<p>
<pre class="fragment"><div>00091 {
00092     <a class="code" href="../../d6/d0/structtagCLIPDATA.html">PCLIPDATA</a> pClipData;
00093 
00094     pClipData = <a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(NULL,
00095                               NULL,
00096                               TYPE_CLIPDATA,
00097                               FIELD_OFFSET(<a class="code" href="../../d6/d0/structtagCLIPDATA.html">CLIPDATA</a>, abData) + cbData);
00098 
00099     <span class="keywordflow">if</span> (pClipData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00100         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00101 
00102     pClipData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o1">cbData</a> = cbData;
00103 
00104     <span class="keywordflow">try</span> {
00105         RtlCopyMemory(&amp;pClipData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o2">abData</a>, ccxlpData, cbData);
00106     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
00107         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pClipData);
00108         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00109     }
00110 
00111     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pClipData);
00112 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="ntuser/kernel/clipbrd.c::_EnumClipboardFormats" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UINT _EnumClipboardFormats           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">UINT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>fmt</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00597">597</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02730">tagWINDOWSTATION::cNumClipFormats</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02938">tagCLIP::fmt</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02729">tagWINDOWSTATION::pClipBase</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02724">tagWINDOWSTATION::ptiClipLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
<pre class="fragment"><div>00599 {
00600     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00601     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>           fmtRet;
00602 
00603     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00604         <span class="keywordflow">return</span> 0;
00605 
00606     <span class="comment">/*</span>
00607 <span class="comment">     * If the current thread doesn't have the clipboard open or if there</span>
00608 <span class="comment">     * is no clipboard, return 0 for no formats.</span>
00609 <span class="comment">     */</span>
00610     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
00611         RIPERR0(ERROR_CLIPBOARD_NOT_OPEN, RIP_WARNING, <span class="stringliteral">"EnumClipboardFormat: clipboard not open"</span>);
00612         <span class="keywordflow">return</span> 0;
00613     }
00614 
00615     fmtRet = 0;
00616 
00617     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00618 
00619         <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a> pClip;
00620 
00621         <span class="comment">/*</span>
00622 <span class="comment">         * Find the next clipboard format.  If the format is 0, start from</span>
00623 <span class="comment">         * the beginning.</span>
00624 <span class="comment">         */</span>
00625         <span class="keywordflow">if</span> (fmt != 0) {
00626 
00627             <span class="comment">/*</span>
00628 <span class="comment">             * Find the next clipboard format.  NOTE that this routine locks</span>
00629 <span class="comment">             * the clipboard handle and updates pwinsta-&gt;pClipBase with the</span>
00630 <span class="comment">             * starting address of the clipboard.</span>
00631 <span class="comment">             */</span>
00632             <span class="keywordflow">if</span> ((pClip = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, fmt)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00633                 pClip++;
00634 
00635         } <span class="keywordflow">else</span> {
00636             pClip = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a>;
00637         }
00638 
00639         <span class="comment">/*</span>
00640 <span class="comment">         * Find the new format before unlocking the clipboard.</span>
00641 <span class="comment">         */</span>
00642         <span class="keywordflow">if</span> (pClip &amp;&amp; (pClip &lt; &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a>[pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a>])) {
00643 
00644             fmtRet = pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o0">fmt</a>;
00645         }
00646     }
00647 
00648     <span class="comment">/*</span>
00649 <span class="comment">     * Return the new clipboard format.</span>
00650 <span class="comment">     */</span>
00651     <span class="keywordflow">return</span> fmtRet;
00652 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="ntuser/kernel/clipbrd.c::_GetPriorityClipboardFormat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int _GetPriorityClipboardFormat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d5/ndismain_8h.html#a266">PUINT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>lpPriorityList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>cfmts</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02514">2514</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02730">tagWINDOWSTATION::cNumClipFormats</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02938">tagCLIP::fmt</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02729">tagWINDOWSTATION::pClipBase</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
<pre class="fragment"><div>02517 {
02518     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
02519     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>          pClip;
02520     <span class="keywordtype">int</span>            iFmt;
02521     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>           fmt;
02522 
02523     <span class="comment">/*</span>
02524 <span class="comment">     * Blow it off is the caller does not have the proper access rights</span>
02525 <span class="comment">     */</span>
02526     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02527         <span class="keywordflow">return</span> 0;
02528 
02529     <span class="comment">/*</span>
02530 <span class="comment">     * If there is no clipboard or no objects in the clipboard, return 0.</span>
02531 <span class="comment">     */</span>
02532     <span class="keywordflow">if</span> ((pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a> == 0) || (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
02533         <span class="keywordflow">return</span> 0;
02534 
02535     <span class="comment">/*</span>
02536 <span class="comment">     * Look through the list for any of the formats in lpPriorityList.</span>
02537 <span class="comment">     */</span>
02538     <span class="keywordflow">while</span> (cfmts-- &gt; 0) {
02539 
02540         fmt = *lpPriorityList;
02541 
02542         <span class="keywordflow">if</span> (fmt != 0) {
02543 
02544             pClip = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a>;
02545 
02546             <span class="keywordflow">for</span> (iFmt = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a>; iFmt-- != 0; pClip++) {
02547 
02548                 <span class="keywordflow">if</span> (pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o0">fmt</a> == fmt)
02549                     <span class="keywordflow">return</span> fmt;
02550             }
02551         }
02552 
02553         lpPriorityList++;
02554     }
02555 
02556     <span class="comment">/*</span>
02557 <span class="comment">     * There is no matching format.  Return -1.</span>
02558 <span class="comment">     */</span>
02559     <span class="keywordflow">return</span> -1;
02560 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="ntuser/kernel/clipbrd.c::_SetClipboardData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _SetClipboardData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>fmt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fGlobalHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fIncSerialNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00953">953</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00023">DUMMY_MAX_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00019">DUMMY_TEXT_HANDLE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01007">InternalSetClipboardData()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03274">NtUserSetClipboardData()</a>, and <a class="el" href="../../d6/d8/snapshot_8c-source.html#l00023">xxxSnapWindow()</a>.
<p>
<pre class="fragment"><div>00958 {
00959     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00960     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00961 
00962     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00963         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00964 
00965     <span class="comment">/*</span>
00966 <span class="comment">     * Check if the Data handle is DUMMY_TEXT_HANDLE; If so, return an</span>
00967 <span class="comment">     * error.  DUMMY_TEXT_HANDLE will be used as a valid clipboard handle</span>
00968 <span class="comment">     * only by USER.  If any app tries to pass it as a handle, it should</span>
00969 <span class="comment">     * get an error!</span>
00970 <span class="comment">     */</span>
00971     <span class="keywordflow">if</span> ((hData &gt;= <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a0">DUMMY_TEXT_HANDLE</a>) &amp;&amp; (hData &lt;= <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a4">DUMMY_MAX_HANDLE</a>)) {
00972         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Clipboard: SetClipboardData called with dummy-handle"</span>);
00973         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00974     }
00975 
00976     <span class="keywordflow">if</span> (fRet = <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta, fmt, hData, fGlobalHandle, fIncSerialNumber)) {
00977 
00978         <span class="comment">/*</span>
00979 <span class="comment">         * The set object must remain PUBLIC, so that other processes</span>
00980 <span class="comment">         * can view/manipulate the handles when requested.</span>
00981 <span class="comment">         */</span>
00982         <span class="keywordflow">switch</span> (fmt) {
00983         <span class="keywordflow">case</span> CF_BITMAP:
00984             GreSetBitmapOwner(hData, OBJECT_OWNER_PUBLIC);
00985             <span class="keywordflow">break</span>;
00986 
00987         <span class="keywordflow">case</span> CF_PALETTE:
00988             GreSetPaletteOwner(hData, OBJECT_OWNER_PUBLIC);
00989             <span class="keywordflow">break</span>;
00990         }
00991     }
00992 
00993     <span class="keywordflow">return</span> fRet;
00994 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="ntuser/kernel/clipbrd.c::BMPtoDIB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LPBITMAPINFOHEADER BMPtoDIB           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HBITMAP&nbsp;</td>
          <td class="mdname" nowrap> <em>hbmp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HPALETTE&nbsp;</td>
          <td class="mdname" nowrap> <em>hpal</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pcbSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01286">1286</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d1/d2/palette_8c-source.html#l00051">_SelectPalette()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d8/d5/consrv_8h.html#a314">GreGetDIBitsInternal()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02099">tagDISPLAYINFO::hdcScreen</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01704">ThreadLockPool</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01707">ThreadUnlockPool</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00475">VER40</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02223">WIDTHBYTES</a>, and <a class="el" href="../../d1/d2/palette_8c-source.html#l00146">xxxRealizePalette()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01616">BMPtoDIBV5()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">xxxGetDummyDib()</a>.
<p>
<pre class="fragment"><div>01290 {
01291     BITMAP             bmp;
01292     BITMAPINFOHEADER   bi;
01293     LPBITMAPINFOHEADER lpbi;
01294     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbBits;
01295     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbPalette;
01296     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbTotal;
01297     WORD               cBits;
01298     HDC                hdc;
01299 
01300     UserAssert(hbmp);
01301 
01302     <span class="comment">/*</span>
01303 <span class="comment">     * Get physical information</span>
01304 <span class="comment">     */</span>
01305     <span class="keywordflow">if</span> (!GreExtGetObjectW(hbmp, <span class="keyword">sizeof</span>(BITMAP), &amp;bmp)) {
01306         UserAssert(FALSE);
01307         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01308     }
01309 
01310     <span class="comment">/*</span>
01311 <span class="comment">     * Adjust the bit count since we only allow DIBS with 1,4,8,16,24 and</span>
01312 <span class="comment">     * 32 bits.</span>
01313 <span class="comment">     */</span>
01314     cBits = ((WORD)bmp.bmPlanes * (WORD)bmp.bmBitsPixel);
01315 
01316     <span class="keywordflow">if</span> (cBits &lt;= 1) {
01317 
01318         cBits = 1;
01319 
01320     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cBits &lt;= 4) {
01321 
01322         cBits = 4;
01323 
01324     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cBits &lt;= 8) {
01325 
01326         cBits = 8;
01327 
01328     } <span class="keywordflow">else</span> {
01329 
01330         <span class="comment">/*</span>
01331 <span class="comment">         * We're not going to recognize 16/32bpp formats for</span>
01332 <span class="comment">         * apps that are not 4.00 or greater.  Paint-Shop has</span>
01333 <span class="comment">         * a bug in it where they only recognize (1,4,8,24).  This</span>
01334 <span class="comment">         * really stinks that we need to do this type of thing as</span>
01335 <span class="comment">         * not to break them bad-apps.</span>
01336 <span class="comment">         */</span>
01337         <span class="keywordflow">if</span> (LOWORD(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;dwExpWinVer) &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
01338 
01339             <span class="keywordflow">if</span> (cBits &lt;= 16)
01340                 cBits = 16;
01341             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cBits &lt;= 24)
01342                 cBits = 24;
01343             <span class="keywordflow">else</span>
01344                 cBits = 32;
01345 
01346         } <span class="keywordflow">else</span> {
01347             cBits = 24;
01348         }
01349     }
01350 
01351     <span class="comment">/*</span>
01352 <span class="comment">     * Fill in BITMAPINFOHEADER with DIB data</span>
01353 <span class="comment">     */</span>
01354     RtlZeroMemory(&amp;bi, <span class="keyword">sizeof</span>(bi));
01355 
01356     bi.biSize        = <span class="keyword">sizeof</span>(bi);
01357     bi.biWidth       = bmp.bmWidth;
01358     bi.biHeight      = bmp.bmHeight;
01359     bi.biPlanes      = 1;
01360     bi.biBitCount    = cBits;
01361     bi.biCompression = BI_RGB;
01362 
01363     <span class="comment">/*</span>
01364 <span class="comment">     * DWORD align the bits-size since dibs must be so.</span>
01365 <span class="comment">     */</span>
01366     cbBits = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a548">WIDTHBYTES</a>((WORD)bi.biWidth * cBits) * (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)bi.biHeight;
01367 
01368     <span class="comment">/*</span>
01369 <span class="comment">     * How big is the palette color table?</span>
01370 <span class="comment">     */</span>
01371     cbPalette = 0;
01372 
01373     <span class="keywordflow">if</span> (cBits &lt;= 8) {
01374 
01375         cbPalette = (1 &lt;&lt; cBits) * <span class="keyword">sizeof</span>(RGBQUAD);
01376 
01377     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cBits == 16) || (cBits == 32)) {
01378 
01379         cbPalette = (3 * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01380         bi.biCompression = BI_BITFIELDS;
01381     }
01382 
01383     <span class="comment">/*</span>
01384 <span class="comment">     * How much space do we need for the entire DIB?</span>
01385 <span class="comment">     */</span>
01386     cbTotal = bi.biSize + cbPalette + cbBits;
01387 
01388     lpbi = (LPBITMAPINFOHEADER)UserAllocPool(cbTotal, TAG_CLIPBOARD);
01389     <span class="keywordflow">if</span> (lpbi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01390         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01391     }
01392 
01393     <span class="comment">/*</span>
01394 <span class="comment">     * Have the total allocated size returned in pcbSize</span>
01395 <span class="comment">     */</span>
01396     <span class="keywordflow">if</span> (pcbSize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01397         *pcbSize = cbTotal;
01398     }
01399 
01400     <span class="comment">/*</span>
01401 <span class="comment">     * Setup DIB header</span>
01402 <span class="comment">     */</span>
01403     memcpy(lpbi, &amp;bi, <span class="keyword">sizeof</span>(bi));
01404 
01405     <span class="keywordflow">if</span> (hdc = GreCreateCompatibleDC(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>)) {
01406         HPALETTE           hpalT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01407         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPool;
01408 
01409         <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), lpbi, &amp;tlPool);
01410 
01411         <span class="keywordflow">if</span> (hpal) {
01412             hpalT = <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(hdc, hpal, FALSE);
01413             <a class="code" href="../../d4/d1/userk_8h.html#a1104">xxxRealizePalette</a>(hdc);
01414         }
01415 
01416         <span class="comment">/*</span>
01417 <span class="comment">         * Get old bitmap's DIB bits, using the current DC.</span>
01418 <span class="comment">         */</span>
01419         <a class="code" href="../../d8/d5/consrv_8h.html#a314">GreGetDIBitsInternal</a>(hdc,
01420                              hbmp,
01421                              0,
01422                              (WORD)bi.biHeight,
01423                              (LPSTR)((LPSTR)lpbi + lpbi-&gt;biSize + cbPalette),
01424                              (LPBITMAPINFO)lpbi,
01425                              DIB_RGB_COLORS,
01426                              cbBits,
01427                              lpbi-&gt;biSize + cbPalette);
01428 
01429 
01430         <span class="keywordflow">if</span> (hpalT) {
01431             <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(hdc, hpalT, FALSE);
01432             <a class="code" href="../../d4/d1/userk_8h.html#a1104">xxxRealizePalette</a>(hdc);
01433         }
01434 
01435         GreDeleteDC(hdc);
01436 
01437         <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPool);
01438     }
01439 
01440     <span class="keywordflow">return</span> lpbi;
01441 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="ntuser/kernel/clipbrd.c::BMPtoDIBV5" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LPBITMAPV5HEADER BMPtoDIBV5           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HBITMAP&nbsp;</td>
          <td class="mdname" nowrap> <em>hbmp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HPALETTE&nbsp;</td>
          <td class="mdname" nowrap> <em>hpal</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01616">1616</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01286">BMPtoDIB()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01450">DIBtoDIBV5()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>.
<p>
<pre class="fragment"><div>01619 {
01620     LPBITMAPV5HEADER   lpV5h;
01621     LPBITMAPINFOHEADER lpbih;
01622     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              cbSize;
01623 
01624     <span class="comment">/*</span>
01625 <span class="comment">     * Convert bitmap handle to BITMAPINFOHEADER first.</span>
01626 <span class="comment">     */</span>
01627     lpbih = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a31">BMPtoDIB</a>(hbmp, hpal, &amp;cbSize);
01628 
01629     <span class="keywordflow">if</span> (lpbih) {
01630 
01631         <span class="comment">/*</span>
01632 <span class="comment">         * Then, convert BITMAPINFOHEADER to BITMAPV5HEADER.</span>
01633 <span class="comment">         */</span>
01634         lpV5h = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a32">DIBtoDIBV5</a>(lpbih, cbSize);
01635 
01636         <span class="comment">/*</span>
01637 <span class="comment">         * Free memory which contains BITMAPINFOHEADER temporary.</span>
01638 <span class="comment">         */</span>
01639         UserFreePool(lpbih);
01640 
01641         <span class="keywordflow">return</span> (lpV5h);
01642     } <span class="keywordflow">else</span> {
01643 
01644         RIPMSG0(RIP_ERROR,<span class="stringliteral">"Failed on BMPtoDIB(), Why ??"</span>);
01645         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01646     }
01647 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ntuser/kernel/clipbrd.c::CheckClipboardAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> CheckClipboardAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">49</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00059">PtiCurrentShared</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l01366">ReferenceWindowStation()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02829">TIF_CSRSSTHREAD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00597">_EnumClipboardFormats()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02514">_GetPriorityClipboardFormat()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00953">_SetClipboardData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02687">DisownClipboard()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05042">NtUserCountClipboardFormats()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04050">NtUserGetClipboardData()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05102">NtUserGetClipboardOwner()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05062">NtUserGetClipboardSequenceNumber()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05122">NtUserGetClipboardViewer()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05183">NtUserGetOpenClipboardWindow()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05368">NtUserIsClipboardFormatAvailable()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02618">xxxChangeClipboardChain()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00538">xxxCloseClipboard()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00851">xxxEmptyClipboard()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00124">xxxOpenClipboard()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02572">xxxSetClipboardViewer()</a>.
<p>
<pre class="fragment"><div>00050 {
00051     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00052     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00053     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUseDesktop;
00054     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00055 
00056     pti = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00057 
00058     <span class="comment">/*</span>
00059 <span class="comment">     * CSR process use to have NULL pwinsta. Now that it's assigned to</span>
00060 <span class="comment">     * the services windowstation we have to explicitly use the desktop</span>
00061 <span class="comment">     * for checking the access.</span>
00062 <span class="comment">     */</span>
00063     fUseDesktop = (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00064 
00065     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d8/d8/winsta_8c.html#a13">ReferenceWindowStation</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00066                                      NULL,
00067                                      WINSTA_ACCESSCLIPBOARD,
00068                                      &amp;pwinsta,
00069                                      fUseDesktop);
00070     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00071         RIPNTERR0(Status, RIP_WARNING,<span class="stringliteral">"Access to clipboard denied."</span>);
00072         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00073     }
00074 
00075     <span class="keywordflow">return</span> pwinsta;
00076 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="ntuser/kernel/clipbrd.c::CreateDIBPalette" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HPALETTE CreateDIBPalette           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPBITMAPINFOHEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>pbmih</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>colors</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02041">2041</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02138">HDCBITS</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02111">xxxGetDummyPalette()</a>.
<p>
<pre class="fragment"><div>02044 {
02045     HPALETTE hpal;
02046 
02047     <span class="keywordflow">if</span> (colors != 0) {
02048 
02049         <span class="keywordtype">int</span>         i;
02050         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fOldDIB = (pbmih-&gt;biSize == <span class="keyword">sizeof</span>(BITMAPCOREHEADER));
02051         RGBTRIPLE   *pColorTable;
02052         PLOGPALETTE plp;
02053 
02054         <span class="comment">/*</span>
02055 <span class="comment">         * Allocate memory for palette creation.</span>
02056 <span class="comment">         */</span>
02057         plp = (PLOGPALETTE)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(LOGPALETTE) +
02058                                                   (<span class="keyword">sizeof</span>(PALETTEENTRY) * 256),
02059                                                   TAG_CLIPBOARDPALETTE);
02060 
02061         <span class="keywordflow">if</span> (plp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02062             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02063         }
02064 
02065         pColorTable = (RGBTRIPLE *)((LPSTR)pbmih + (WORD)pbmih-&gt;biSize);
02066         plp-&gt;palVersion = 0x300;
02067 
02068         <span class="keywordflow">if</span> (fOldDIB || (pbmih-&gt;biClrUsed == 0)) {
02069             UserAssert(colors &lt;= 0xFFFF);
02070             plp-&gt;palNumEntries = (WORD)colors;
02071         } <span class="keywordflow">else</span> {
02072             UserAssert(pbmih-&gt;biClrUsed &lt;= 0xFFFF);
02073             plp-&gt;palNumEntries = (WORD)pbmih-&gt;biClrUsed;
02074         }
02075 
02076         <span class="keywordflow">for</span> (i = 0; i &lt; (<span class="keywordtype">int</span>)(plp-&gt;palNumEntries); i++) {
02077 
02078             plp-&gt;palPalEntry[i].peRed   = pColorTable-&gt;rgbtRed;
02079             plp-&gt;palPalEntry[i].peGreen = pColorTable-&gt;rgbtGreen;
02080             plp-&gt;palPalEntry[i].peBlue  = pColorTable-&gt;rgbtBlue;
02081             plp-&gt;palPalEntry[i].peFlags = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)PC_NOCOLLAPSE;
02082 
02083             <span class="keywordflow">if</span> (fOldDIB) {
02084                 pColorTable++;
02085             } <span class="keywordflow">else</span> {
02086                 pColorTable = (RGBTRIPLE *)((LPSTR)pColorTable+<span class="keyword">sizeof</span>(RGBQUAD));
02087             }
02088         }
02089 
02090         hpal = GreCreatePalette((LPLOGPALETTE)plp);
02091         UserFreePool(plp);
02092 
02093     } <span class="keywordflow">else</span> {
02094         hpal = GreCreateHalftonePalette(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a527">HDCBITS</a>());
02095     }
02096 
02097     GreSetPaletteOwner(hpal, OBJECT_OWNER_PUBLIC);
02098 
02099     <span class="keywordflow">return</span> hpal;
02100 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="ntuser/kernel/clipbrd.c::CreateScreenBitmap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HBITMAP CreateScreenBitmap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>cx</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>cy</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>bpp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01114">1114</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d2/d0/inctlpan_8c-source.html#l00480">cy</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02099">tagDISPLAYINFO::hdcScreen</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/clres_8c-source.html#l02950">BitmapFromDIB()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01189">DIBtoBMP()</a>, and <a class="el" href="../../d5/d8/clres_8c-source.html#l01899">LoadBmp()</a>.
<p>
<pre class="fragment"><div>01118 {
01119     <span class="keywordflow">if</span> (bpp == 1)
01120         <span class="keywordflow">return</span> GreCreateBitmap(cx, cy, 1, 1, NULL);
01121 
01122     <span class="keywordflow">return</span> GreCreateCompatibleBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, cx, cy);
01123 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="ntuser/kernel/clipbrd.c::DIBtoBMP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HBITMAP DIBtoBMP           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPBITMAPINFOHEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>lpbih</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HPALETTE&nbsp;</td>
          <td class="mdname" nowrap> <em>hpal</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01189">1189</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d1/d2/palette_8c-source.html#l00051">_SelectPalette()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01114">CreateScreenBitmap()</a>, <a class="el" href="../../d2/d0/inctlpan_8c-source.html#l00480">cy</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02099">tagDISPLAYINFO::hdcScreen</a>, <a class="el" href="../../d4/d9/clres_8c.html#a15">lpbch</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, and <a class="el" href="../../d1/d2/palette_8c-source.html#l00146">xxxRealizePalette()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01658">xxxGetDummyBitmap()</a>.
<p>
<pre class="fragment"><div>01192 {
01193     HDC      hdc;
01194     <span class="keywordtype">int</span>      cx;
01195     <span class="keywordtype">int</span>      <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01196     <span class="keywordtype">int</span>      bpp;
01197     LPSTR    lpbits;
01198     HBITMAP  hbmp;
01199 
01200 <span class="preprocessor">    #define lpbch ((LPBITMAPCOREHEADER)lpbih)</span>
01201 <span class="preprocessor"></span>
01202     <span class="comment">/*</span>
01203 <span class="comment">     * Gather the dib-info for the convert.</span>
01204 <span class="comment">     */</span>
01205     <span class="keywordflow">if</span> (lpbih-&gt;biSize == <span class="keyword">sizeof</span>(BITMAPINFOHEADER)) {
01206 
01207         cx  = (<span class="keywordtype">int</span>)lpbih-&gt;biWidth;
01208         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>  = (<span class="keywordtype">int</span>)lpbih-&gt;biHeight;
01209         bpp = (<span class="keywordtype">int</span>)lpbih-&gt;biBitCount;
01210 
01211         lpbits = ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpbih) + <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
01212 
01213         <span class="keywordflow">if</span> (lpbih-&gt;biClrUsed) {
01214             lpbits += (lpbih-&gt;biClrUsed * <span class="keyword">sizeof</span>(RGBQUAD));
01215         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bpp &lt;= 8) {
01216             lpbits += ((1 &lt;&lt; bpp) * <span class="keyword">sizeof</span>(RGBQUAD));
01217         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bpp == 16) || (bpp == 32)) {
01218             lpbits += (3 * <span class="keyword">sizeof</span>(RGBQUAD));
01219         }
01220 
01221     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcSize == <span class="keyword">sizeof</span>(BITMAPCOREHEADER)) {
01222 
01223         cx  = (<span class="keywordtype">int</span>)<a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcWidth;
01224         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>  = (<span class="keywordtype">int</span>)<a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcHeight;
01225         bpp = (<span class="keywordtype">int</span>)<a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcBitCount;
01226 
01227         lpbits = ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>) + <span class="keyword">sizeof</span>(BITMAPCOREHEADER);
01228 
01229         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a15">lpbch</a>-&gt;bcBitCount &lt;= 8)
01230             lpbits += (1 &lt;&lt; bpp);
01231 
01232     } <span class="keywordflow">else</span> {
01233         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01234     }
01235 
01236     hbmp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01237 
01238     <span class="keywordflow">if</span> (hdc = GreCreateCompatibleDC(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>)) {
01239 
01240         <span class="keywordflow">if</span> (hbmp = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a28">CreateScreenBitmap</a>(cx, cy, bpp)) {
01241 
01242             HBITMAP  hbmT;
01243             HPALETTE hpalT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01244 
01245             hbmT = GreSelectBitmap(hdc, hbmp);
01246 
01247             <span class="keywordflow">if</span> (hpal) {
01248                 hpalT = <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(hdc, hpal, FALSE);
01249                 <a class="code" href="../../d4/d1/userk_8h.html#a1104">xxxRealizePalette</a>(hdc);
01250             }
01251 
01252             GreSetDIBits(hdc,
01253                          hbmp,
01254                          0,
01255                          cy,
01256                          lpbits,
01257                          (LPBITMAPINFO)lpbih,
01258                          DIB_RGB_COLORS);
01259 
01260             <span class="keywordflow">if</span> (hpalT) {
01261                 <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(hdc, hpalT, FALSE);
01262                 <a class="code" href="../../d4/d1/userk_8h.html#a1104">xxxRealizePalette</a>(hdc);
01263             }
01264 
01265             GreSelectBitmap(hdc, hbmT);
01266         }
01267 
01268         GreDeleteDC(hdc);
01269     }
01270 
01271 <span class="preprocessor">    #undef lpbch</span>
01272 <span class="preprocessor"></span>
01273     <span class="keywordflow">return</span> hbmp;
01274 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="ntuser/kernel/clipbrd.c::DIBtoDIBV5" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LPBITMAPV5HEADER DIBtoDIBV5           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPBITMAPINFOHEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>lpDib</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cbSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01450">1450</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02354">abs</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d5/aug98_2dll32_2icm_8h-source.html#l00038">LCS_GM_IMAGES</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02223">WIDTHBYTES</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01616">BMPtoDIBV5()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>.
<p>
<pre class="fragment"><div>01453 {
01454     LPBITMAPV5HEADER lpV5h;
01455     ULONG            cjBits;
01456     ULONG            cjColor, cjColorV5;
01457     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>             bBitMasks = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01458 
01459     <span class="keywordflow">if</span> (cbSize &lt; <span class="keyword">sizeof</span>(BITMAPINFOHEADER)) {
01460         RIPMSG2(RIP_WARNING, <span class="stringliteral">"DIBtoDIBV5: buffer %d too small for header %d"</span>,
01461                 cbSize, <span class="keyword">sizeof</span>(BITMAPINFOHEADER));
01462         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01463     }
01464 
01465     <span class="comment">/*</span>
01466 <span class="comment">     * Support only convert from BITMAPINFOHEADER</span>
01467 <span class="comment">     */</span>
01468     <span class="keywordflow">if</span> (lpDib-&gt;biSize != <span class="keyword">sizeof</span>(BITMAPINFOHEADER))
01469         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01470 
01471     <span class="comment">/*</span>
01472 <span class="comment">     * Calculate size of bitmap bits.</span>
01473 <span class="comment">     */</span>
01474     cjBits = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a548">WIDTHBYTES</a>(lpDib-&gt;biWidth * lpDib-&gt;biBitCount) * <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(lpDib-&gt;biHeight);
01475 
01476     <span class="comment">/*</span>
01477 <span class="comment">     * Calculate size of color table.</span>
01478 <span class="comment">     */</span>
01479     <span class="keywordflow">if</span> (lpDib-&gt;biCompression == BI_BITFIELDS) {
01480 
01481         <span class="keywordflow">if</span> ((lpDib-&gt;biBitCount == 16) || (lpDib-&gt;biBitCount == 32)) {
01482             <span class="comment">/*</span>
01483 <span class="comment">             * Color bit masks for R,G,B.</span>
01484 <span class="comment">             */</span>
01485             cjColor   = (3 * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01486 
01487             <span class="comment">/*</span>
01488 <span class="comment">             * Bit fields data is a part of BITMAPV5HEADER</span>
01489 <span class="comment">             */</span>
01490             cjColorV5 = 0;
01491             bBitMasks = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01492         } <span class="keywordflow">else</span> {
01493             <span class="comment">/*</span>
01494 <span class="comment">             * Actually, thi shouldn't happen.</span>
01495 <span class="comment">             */</span>
01496             RIPMSG0(RIP_ERROR,<span class="stringliteral">"Bad BITMAPINFOHEADER."</span>);
01497             cjColor = cjColorV5 = 0;
01498         }
01499 
01500     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpDib-&gt;biCompression == BI_RGB) {
01501 
01502         <span class="keywordflow">if</span> (lpDib-&gt;biClrUsed) {
01503             cjColor = cjColorV5 = lpDib-&gt;biClrUsed * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01504         } <span class="keywordflow">else</span> {
01505             <span class="keywordflow">if</span> (lpDib-&gt;biBitCount &lt;= 8) {
01506                 cjColor = cjColorV5 = (1 &lt;&lt; lpDib-&gt;biBitCount) * <span class="keyword">sizeof</span>(RGBQUAD);
01507             } <span class="keywordflow">else</span> {
01508                 cjColor = cjColorV5 = 0;
01509             }
01510         }
01511 
01512     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpDib-&gt;biCompression == BI_RLE4) {
01513 
01514         cjColor = cjColorV5 = 16 * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01515 
01516     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpDib-&gt;biCompression == BI_RLE8) {
01517 
01518         cjColor = cjColorV5 = 256 * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01519 
01520     } <span class="keywordflow">else</span> {
01521 
01522         cjColor = cjColorV5 = 0;
01523 
01524     }
01525 
01526     <span class="keywordflow">if</span> (cbSize &lt; <span class="keyword">sizeof</span>(BITMAPINFOHEADER) + cjColorV5 + cjBits) {
01527         RIPMSG5(RIP_WARNING, <span class="stringliteral">"DIBtoDIBV5: buffer %d too small for bitmap %d Header"</span>
01528                              <span class="stringliteral">" %d cjColorV5 %d cjBits %d"</span>,
01529                 cbSize,
01530                 <span class="keyword">sizeof</span>(BITMAPINFOHEADER) + cjColorV5 + cjBits,
01531                 <span class="keyword">sizeof</span>(BITMAPINFOHEADER),
01532                 cjColorV5,
01533                 cjBits);
01534         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01535     }
01536 
01537     <span class="comment">/*</span>
01538 <span class="comment">     * Allocate memory for BITMAPV5HEADER</span>
01539 <span class="comment">     */</span>
01540     lpV5h = (LPBITMAPV5HEADER)UserAllocPool(<span class="keyword">sizeof</span>(BITMAPV5HEADER) + cjColorV5 + cjBits,
01541                                             TAG_CLIPBOARD);
01542 
01543     <span class="keywordflow">if</span> (lpV5h == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01544         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01545 
01546     <span class="comment">/*</span>
01547 <span class="comment">     * fill allocated memory with zero.</span>
01548 <span class="comment">     */</span>
01549     RtlZeroMemory((PVOID)lpV5h,<span class="keyword">sizeof</span>(BITMAPV5HEADER));
01550 
01551     <span class="keywordflow">try</span> {
01552 
01553         <span class="comment">/*</span>
01554 <span class="comment">         * Copy BITMAPINFOHEADER to BITMAPV5HEADER</span>
01555 <span class="comment">         */</span>
01556         RtlCopyMemory((PVOID)lpV5h,(PVOID)lpDib,<span class="keyword">sizeof</span>(BITMAPINFOHEADER));
01557 
01558     } except (W32ExceptionHandler(FALSE, RIP_ERROR)) {
01559         UserFreePool(lpV5h);
01560         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01561     }
01562 
01563     <span class="comment">/*</span>
01564 <span class="comment">     * Adjust the header size to BITMAPV5HEADER.</span>
01565 <span class="comment">     */</span>
01566     lpV5h-&gt;bV5Size = <span class="keyword">sizeof</span>(BITMAPV5HEADER);
01567 
01568     <span class="comment">/*</span>
01569 <span class="comment">     * Bitmap is in sRGB color space.</span>
01570 <span class="comment">     */</span>
01571     lpV5h-&gt;bV5CSType = LCS_sRGB;
01572 
01573     <span class="comment">/*</span>
01574 <span class="comment">     * Set rendering intent.</span>
01575 <span class="comment">     */</span>
01576     lpV5h-&gt;bV5Intent = <a class="code" href="../../d1/d6/aug98_2dll32_2icm_8h.html#a23">LCS_GM_IMAGES</a>;
01577 
01578     <span class="keywordflow">if</span> (bBitMasks) {
01579 
01580         <span class="comment">/*</span>
01581 <span class="comment">         * If there is bitfields mask, copy it to BITMAPV5HEADER.</span>
01582 <span class="comment">         */</span>
01583         lpV5h-&gt;bV5RedMask = *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)&amp;(((BITMAPINFO *)lpDib)-&gt;bmiColors[0]);
01584         lpV5h-&gt;bV5GreenMask = *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)&amp;(((BITMAPINFO *)lpDib)-&gt;bmiColors[1]);
01585         lpV5h-&gt;bV5BlueMask = *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)&amp;(((BITMAPINFO *)lpDib)-&gt;bmiColors[2]);
01586 
01587     } <span class="keywordflow">else</span> {
01588 
01589         <span class="comment">/*</span>
01590 <span class="comment">         * Otherwise, copy color table if there is.</span>
01591 <span class="comment">         */</span>
01592         <span class="keywordflow">if</span> (cjColorV5) {
01593             RtlCopyMemory((BYTE *)lpV5h + <span class="keyword">sizeof</span>(BITMAPV5HEADER),
01594                           (BYTE *)lpDib + <span class="keyword">sizeof</span>(BITMAPINFOHEADER),
01595                           cjColorV5);
01596         }
01597     }
01598 
01599     <span class="comment">/*</span>
01600 <span class="comment">     * Copy bitmap bits</span>
01601 <span class="comment">     */</span>
01602     RtlCopyMemory((BYTE *)lpV5h + <span class="keyword">sizeof</span>(BITMAPV5HEADER) + cjColorV5,
01603                   (BYTE *)lpDib + <span class="keyword">sizeof</span>(BITMAPINFOHEADER) + cjColorV5,
01604                   cjBits);
01605 
01606     <span class="keywordflow">return</span> lpV5h;
01607 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="ntuser/kernel/clipbrd.c::DisownClipboard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DisownClipboard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwndClipOwner</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02687">2687</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02730">tagWINDOWSTATION::cNumClipFormats</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00019">DUMMY_TEXT_HANDLE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02733">tagWINDOWSTATION::fClipboardChanged</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02732">tagWINDOWSTATION::iClipSequenceNumber</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00030">IsTextHandle</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02729">tagWINDOWSTATION::pClipBase</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02728">tagWINDOWSTATION::spwndClipOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01668">ThreadLockWinSta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01698">ThreadUnlockWinSta</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00220">xxxDrawClipboard()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00783">xxxSendClipboardMessage()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/createw_8c-source.html#l02053">xxxDW_SendDestroyMessages()</a>.
<p>
<pre class="fragment"><div>02688 {
02689     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>             tlpwinsta;
02690     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
02691     <span class="keywordtype">int</span>            iFmt;
02692     <span class="keywordtype">int</span>            cFmts;
02693     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>          pClip;
02694     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>          pClipOut;
02695     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fKeepDummyHandle;
02696     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    ptiCurrent;
02697 
02698     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02699         <span class="keywordflow">return</span>;
02700 
02701     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02702 
02703     <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, pwinsta, &amp;tlpwinsta);
02704 
02705     <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a24">xxxSendClipboardMessage</a>(pwinsta, WM_RENDERALLFORMATS);
02706 
02707     pClipOut = pClip = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a>;
02708     fKeepDummyHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02709 
02710     <span class="keywordflow">for</span> (cFmts = 0, iFmt = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a>; iFmt-- != 0;) {
02711 
02712         <span class="comment">/*</span>
02713 <span class="comment">         * We have to remove the Dummy handles also if the corresponding</span>
02714 <span class="comment">         * valid handles are NULL; We should not remove the dummy handles if</span>
02715 <span class="comment">         * the corresponding valid handles are not NULL;</span>
02716 <span class="comment">         * The following code assumes that only one dummy handle is possible</span>
02717 <span class="comment">         * and that can appear only after the corresponding valid handle in</span>
02718 <span class="comment">         * the pClip linked list;</span>
02719 <span class="comment">         * Fix for Bug #???? --SANKAR-- 10-19-89 --OPUS BUG #3252--</span>
02720 <span class="comment">         */</span>
02721         <span class="keywordflow">if</span> (pClip-&gt;hData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02722 
02723             <span class="keywordflow">if</span> ((pClip-&gt;hData != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a0">DUMMY_TEXT_HANDLE</a>) ||
02724                 ((pClip-&gt;hData == <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a0">DUMMY_TEXT_HANDLE</a>) &amp;&amp; fKeepDummyHandle)) {
02725 
02726                 cFmts++;
02727                 *pClipOut++ = *pClip;
02728 
02729                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a9">IsTextHandle</a>(pClip-&gt;fmt, pClip-&gt;hData)) {
02730                     fKeepDummyHandle  = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02731                 }
02732             }
02733         }
02734 
02735         pClip++;
02736     }
02737 
02738     <span class="comment">/*</span>
02739 <span class="comment">     * Unlock the clipboard owner if the owner is still the window we were cleaning</span>
02740 <span class="comment">     * up for.</span>
02741 <span class="comment">     */</span>
02742     <span class="keywordflow">if</span> (pwndClipOwner == pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>) {
02743         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>);
02744     } <span class="keywordflow">else</span> {
02745         RIPMSG2(RIP_WARNING, <span class="stringliteral">"DisownClipboard: pwndClipOwner changed from %#p to %#p"</span>,
02746                 pwndClipOwner, pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>);
02747     }
02748 
02749     <span class="comment">/*</span>
02750 <span class="comment">     * If number of formats changed, redraw.</span>
02751 <span class="comment">     */</span>
02752     <span class="keywordflow">if</span> (cFmts != pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a>) {
02753         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o14">fClipboardChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02754         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o13">iClipSequenceNumber</a>++;
02755     }
02756 
02757     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a> = cFmts;
02758 
02759     <span class="comment">/*</span>
02760 <span class="comment">     * If anything changed, redraw.  And make sure the data type munging is done.  Or else we will lose</span>
02761 <span class="comment">     * them when xxxDrawClipboard clears the fClipboardChanged flag</span>
02762 <span class="comment">     */</span>
02763     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o14">fClipboardChanged</a>) {
02764         <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a17">xxxDrawClipboard</a>(pwinsta);
02765         <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a19">MungeClipData</a>(pwinsta);
02766     }
02767 
02768     <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
02769 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="ntuser/kernel/clipbrd.c::FindClipFormat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d0/structtagCLIP.html">PCLIP</a> FindClipFormat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>format</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">2482</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02730">tagWINDOWSTATION::cNumClipFormats</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02938">tagCLIP::fmt</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00064">format</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l02729">tagWINDOWSTATION::pClipBase</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00597">_EnumClipboardFormats()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01007">InternalSetClipboardData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05368">NtUserIsClipboardFormatAvailable()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01658">xxxGetDummyBitmap()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">xxxGetDummyDib()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02111">xxxGetDummyPalette()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02200">xxxGetDummyText()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02303">xxxGetRenderData()</a>.
<p>
<pre class="fragment"><div>02485 {
02486     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a> pClip;
02487     <span class="keywordtype">int</span>   iFmt;
02488 
02489     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> != 0) &amp;&amp; ((pClip = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02490 
02491         <span class="keywordflow">for</span> (iFmt = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a>; iFmt-- != 0;) {
02492 
02493             <span class="keywordflow">if</span> (pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o0">fmt</a> == <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>)
02494                 <span class="keywordflow">return</span> pClip;
02495 
02496             pClip++;
02497         }
02498     }
02499 
02500     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02501 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="ntuser/kernel/clipbrd.c::ForceEmptyClipboard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ForceEmptyClipboard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwinsta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02779">2779</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02718">tagWINDOWSTATION::dwWSF_Flags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02724">tagWINDOWSTATION::ptiClipLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02726">tagWINDOWSTATION::spwndClipOpen</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02728">tagWINDOWSTATION::spwndClipOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02727">tagWINDOWSTATION::spwndClipViewer</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02706">WSF_DYING</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00538">xxxCloseClipboard()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00851">xxxEmptyClipboard()</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00324">EndShutdown()</a>, and <a class="el" href="../../d9/d7/winsta_8c-source.html#l00745">FreeWindowStation()</a>.
<p>
<pre class="fragment"><div>02781 {
02782 
02783     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> =  ((<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)(W32GetCurrentThread())); <span class="comment">/*</span>
02784 <span class="comment">                                                                     * This will be NULL</span>
02785 <span class="comment">                                                                     *   for a non-GUI thread.</span>
02786 <span class="comment">                                                                     */</span>
02787     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>);
02788     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>);
02789     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o7">spwndClipOpen</a>);
02790 
02791     <a class="code" href="../../d4/d1/userk_8h.html#a1738">xxxEmptyClipboard</a>(pwinsta);
02792 
02793     <span class="comment">/*</span>
02794 <span class="comment">     * If the windowstation is dying, don't bother closing</span>
02795 <span class="comment">     * the clipboard.</span>
02796 <span class="comment">     */</span>
02797     <span class="keywordflow">if</span> (!(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a318">WSF_DYING</a>))
02798         <a class="code" href="../../d4/d1/userk_8h.html#a1736">xxxCloseClipboard</a>(pwinsta);
02799 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="ntuser/kernel/clipbrd.c::InternalSetClipboardData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL InternalSetClipboardData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>fmt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fGlobalHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fIncSerialNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01007">1007</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01005">CCHFORMATNAME</a>, <a class="el" href="../../d4/d1/userk_8h.html#a848">CLIP</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02730">tagWINDOWSTATION::cNumClipFormats</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02733">tagWINDOWSTATION::fClipboardChanged</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02940">tagCLIP::fGlobalHandle</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02734">tagWINDOWSTATION::fInDelayedRendering</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02938">tagCLIP::fmt</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02732">tagWINDOWSTATION::iClipSequenceNumber</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02731">tagWINDOWSTATION::iClipSerialNumber</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02729">tagWINDOWSTATION::pClipBase</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02724">tagWINDOWSTATION::ptiClipLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02728">tagWINDOWSTATION::spwndClipOwner</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00035">UserAddAtom()</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00101">UserGetAtomName()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00953">_SetClipboardData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00270">PasteScreenPalette()</a>.
<p>
<pre class="fragment"><div>01013 {
01014     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a> pClip;
01015     WCHAR achFormatName[<a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a12">CCHFORMATNAME</a>];
01016 
01017     <span class="comment">/*</span>
01018 <span class="comment">     * Just check for pwinsta-&gt;ptiClipLock being NULL instead of checking</span>
01019 <span class="comment">     * against PtiCurrent because an app needs to call SetClipboardData if</span>
01020 <span class="comment">     * he's rendering data while another app has the clipboard open.</span>
01021 <span class="comment">     */</span>
01022     <span class="keywordflow">if</span> ((pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (fmt == 0)) {
01023         RIPERR0(ERROR_CLIPBOARD_NOT_OPEN, RIP_WARNING, <span class="stringliteral">"SetClipboardData: Clipboard not open"</span>);
01024         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01025     }
01026 
01027     <span class="keywordflow">if</span> ((pClip = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, fmt)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01028 
01029         <span class="comment">/*</span>
01030 <span class="comment">         * If data already exists, free it before we replace it.</span>
01031 <span class="comment">         */</span>
01032         <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a23">UT_FreeCBFormat</a>(pClip);
01033 
01034     } <span class="keywordflow">else</span> {
01035 
01036         <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01037             pClip = (<a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/structtagCLIP.html">CLIP</a>), TAG_CLIPBOARD);
01038         } <span class="keywordflow">else</span> {
01039             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/structtagCLIP.html">CLIP</a>) * pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a>;
01040 
01041             pClip = (<a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>)UserReAllocPool(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a>,
01042                                            dwSize,
01043                                            dwSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/structtagCLIP.html">CLIP</a>),
01044                                            TAG_CLIPBOARD);
01045         }
01046 
01047         <span class="comment">/*</span>
01048 <span class="comment">         * Out of memory...  return.</span>
01049 <span class="comment">         */</span>
01050         <span class="keywordflow">if</span> (pClip == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01051             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetClipboardData: Out of memory"</span>);
01052             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01053         }
01054 
01055         <span class="comment">/*</span>
01056 <span class="comment">         * Just in case the data moved</span>
01057 <span class="comment">         */</span>
01058         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a> = pClip;
01059 
01060         <span class="comment">/*</span>
01061 <span class="comment">         * Increment the reference count of this atom format so that if</span>
01062 <span class="comment">         * the application frees this atom we don't get stuck with a</span>
01063 <span class="comment">         * bogus atom. We call DeleteAtom in the EmptyClipboard() code,</span>
01064 <span class="comment">         * which decrements this count when we're done with this clipboard</span>
01065 <span class="comment">         * data.</span>
01066 <span class="comment">         */</span>
01067         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1300">UserGetAtomName</a>((ATOM)fmt, achFormatName, CCHFORMATNAME) != 0)
01068             <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(achFormatName, FALSE);
01069 
01070         <span class="comment">/*</span>
01071 <span class="comment">         * Point to the new entry in the clipboard.</span>
01072 <span class="comment">         */</span>
01073         pClip += pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a>++;
01074         pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o0">fmt</a> = fmt;
01075     }
01076 
01077     <span class="comment">/*</span>
01078 <span class="comment">     * Start updating the new entry in the clipboard.</span>
01079 <span class="comment">     */</span>
01080     pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>         = hData;
01081     pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o2">fGlobalHandle</a> = fGlobalHandle;
01082 
01083     <span class="keywordflow">if</span> (fIncSerialNumber)
01084         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o14">fClipboardChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01085 
01086     <span class="keywordflow">if</span> (fIncSerialNumber &amp;&amp; !pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o15">fInDelayedRendering</a>) {
01087         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o13">iClipSequenceNumber</a>++;
01088     }
01089 
01090     <span class="comment">/*</span>
01091 <span class="comment">     * If the thread didn't bother emptying the clipboard before</span>
01092 <span class="comment">     * writing to it, change the clipboard serial number</span>
01093 <span class="comment">     * so that the client-side clipboard caches of all the</span>
01094 <span class="comment">     * processes will get flushed on the next OpenClipboard.</span>
01095 <span class="comment">     */</span>
01096     <span class="keywordflow">if</span> ((pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01097         (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>())) {
01098 
01099         RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"Clipboard: SetClipboardData called without emptying clipboard"</span>);
01100 
01101         <span class="keywordflow">if</span> (fIncSerialNumber)
01102             pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o12">iClipSerialNumber</a>++;
01103     }
01104 
01105     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01106 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="ntuser/kernel/clipbrd.c::MungeClipData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MungeClipData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwinsta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">335</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00088">_ConvertMemHandle()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00020">DUMMY_DIB_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00022">DUMMY_METACLONE_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00021">DUMMY_METARENDER_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00019">DUMMY_TEXT_HANDLE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02508">tagKL::hkl</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00353">HMValidateHandleNoRip()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01007">InternalSetClipboardData()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00270">PasteScreenPalette()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01071">PUSIF_PALETTEDISPLAY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03323">tagTHREADINFO::spklActive</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01076">TEST_PUSIF</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00911">TYPE_CLIPDATA</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02687">DisownClipboard()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00538">xxxCloseClipboard()</a>.
<p>
<pre class="fragment"><div>00337 {
00338     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>  pOEM;
00339     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>  pTXT;
00340     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>  pUNI;
00341     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>  pBMP;
00342     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>  pDIB;
00343     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>  pDV5;
00344 
00345     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a> pClip;
00346 
00347     <span class="comment">/*</span>
00348 <span class="comment">     * If only CF_OEMTEXT, CF_TEXT or CF_UNICODE are available, make the</span>
00349 <span class="comment">     * other formats available too.</span>
00350 <span class="comment">     */</span>
00351     pTXT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_TEXT);
00352     pOEM = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_OEMTEXT);
00353     pUNI = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_UNICODETEXT);
00354 
00355     <span class="keywordflow">if</span> (pTXT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pOEM != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pUNI != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00356 
00357         <span class="comment">/*</span>
00358 <span class="comment">         * Make dummy text formats.</span>
00359 <span class="comment">         */</span>
00360         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_LOCALE)) {
00361 
00362             <span class="comment">/*</span>
00363 <span class="comment">             * CF_LOCALE not currently stored.  Save the locale</span>
00364 <span class="comment">             * information while it's still available.</span>
00365 <span class="comment">             */</span>
00366             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00367             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       lcid;
00368             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       lang;
00369             HANDLE      hLocale;
00370 
00371             <span class="comment">/*</span>
00372 <span class="comment">             * The LOCALE format is an HGLOBAL to a DWORD lcid.  The</span>
00373 <span class="comment">             * spklActive-&gt;hkl actually stores more than just the locale,</span>
00374 <span class="comment">             * so we need to mask the value.</span>
00375 <span class="comment">             * (#99321 spklActive is NULL before winlogon loads kbd layouts)</span>
00376 <span class="comment">             */</span>
00377             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>) {
00378                 lang = HandleToUlong(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>);
00379 
00380                 lcid = MAKELCID(LOWORD(lang), SORT_DEFAULT);
00381 
00382                 <span class="keywordflow">if</span> (hLocale = <a class="code" href="../../d4/d1/userk_8h.html#a1487">_ConvertMemHandle</a>((LPBYTE)&amp;lcid, <span class="keyword">sizeof</span>(DWORD))) {
00383                     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00384                                                   CF_LOCALE,
00385                                                   hLocale,
00386                                                   FALSE,
00387                                                   TRUE)) {
00388                         PVOID pObj;
00389 
00390                         pObj = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(hLocale, TYPE_CLIPDATA);
00391                         <span class="keywordflow">if</span> (pObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00392                             <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pObj);
00393                         }
00394                     }
00395                 }
00396             }
00397         }
00398 
00399         <span class="keywordflow">if</span> (pTXT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00400             <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00401                                      CF_TEXT,
00402                                      (HANDLE)DUMMY_TEXT_HANDLE,
00403                                      FALSE,
00404                                      TRUE);
00405 
00406         <span class="keywordflow">if</span> (pOEM == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00407             <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00408                                      CF_OEMTEXT,
00409                                      (HANDLE)DUMMY_TEXT_HANDLE,
00410                                      FALSE,
00411                                      TRUE);
00412 
00413         <span class="keywordflow">if</span> (pUNI == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00414             <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00415                                      CF_UNICODETEXT,
00416                                      (HANDLE)DUMMY_TEXT_HANDLE,
00417                                      FALSE,
00418                                      TRUE);
00419     }
00420 
00421     <span class="comment">/*</span>
00422 <span class="comment">     * For the metafile formats we also want to add its cousin if its</span>
00423 <span class="comment">     * not alread present.  We pass the same data because GDI knows</span>
00424 <span class="comment">     * how to convert between the two.</span>
00425 <span class="comment">     */</span>
00426     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_METAFILEPICT) &amp;&amp;
00427         (pClip = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_ENHMETAFILE))) {
00428 
00429         <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00430                                 CF_METAFILEPICT,
00431                                 pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> ? DUMMY_METACLONE_HANDLE :
00432                                     DUMMY_METARENDER_HANDLE,
00433                                 FALSE,
00434                                 TRUE);
00435 
00436     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_ENHMETAFILE) &amp;&amp;
00437                (pClip = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_METAFILEPICT))) {
00438 
00439         <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00440                                  CF_ENHMETAFILE,
00441                                  pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> ? DUMMY_METACLONE_HANDLE :
00442                                      DUMMY_METARENDER_HANDLE,
00443                                  FALSE,
00444                                  TRUE);
00445     }
00446 
00447     <span class="comment">/*</span>
00448 <span class="comment">     * Convert bitmap formats.</span>
00449 <span class="comment">     *</span>
00450 <span class="comment">     * If only CF_BITMAP, CF_DIB or CF_DIBV5 are available, make the</span>
00451 <span class="comment">     * other formats available too. And check palette if screen is</span>
00452 <span class="comment">     * palette managed.</span>
00453 <span class="comment">     */</span>
00454     pBMP = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_BITMAP);
00455     pDIB = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_DIB);
00456     pDV5 = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_DIBV5);
00457 
00458     <span class="keywordflow">if</span> (pBMP != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pDIB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pDV5 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00459 
00460         <span class="comment">/*</span>
00461 <span class="comment">         * If there is no CF_BITMAP, set dummy.</span>
00462 <span class="comment">         */</span>
00463         <span class="keywordflow">if</span> (pBMP == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00464             <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00465                                      CF_BITMAP,
00466                                      DUMMY_DIB_HANDLE,
00467                                      FALSE,
00468                                      TRUE);
00469         }
00470 
00471         <span class="comment">/*</span>
00472 <span class="comment">         * If there is no CF_DIB, set dummy.</span>
00473 <span class="comment">         */</span>
00474         <span class="keywordflow">if</span> (pDIB == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00475             <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00476                                      CF_DIB,
00477                                      DUMMY_DIB_HANDLE,
00478                                      FALSE,
00479                                      TRUE);
00480         }
00481 
00482         <span class="comment">/*</span>
00483 <span class="comment">         * If there is no CF_DIBV5, set dummy.</span>
00484 <span class="comment">         */</span>
00485         <span class="keywordflow">if</span> (pDV5 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00486             <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00487                                      CF_DIBV5,
00488                                      DUMMY_DIB_HANDLE,
00489                                      FALSE,
00490                                      TRUE);
00491         }
00492 
00493         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(PUSIF_PALETTEDISPLAY) &amp;&amp;
00494             !<a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_PALETTE)) {
00495 
00496             <span class="comment">/*</span>
00497 <span class="comment">             * Displays are palettized and there is no palette data in clipboard, yet.</span>
00498 <span class="comment">             */</span>
00499             <span class="keywordflow">if</span> (pDIB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pDV5 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00500             {
00501                 <span class="comment">/*</span>
00502 <span class="comment">                 * Store a dummy dib and palette (if one not already there).</span>
00503 <span class="comment">                 */</span>
00504                 <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta,
00505                                          CF_PALETTE,
00506                                          DUMMY_DIB_HANDLE,
00507                                          FALSE,
00508                                          TRUE);
00509             } <span class="keywordflow">else</span> {
00510                 <span class="comment">/*</span>
00511 <span class="comment">                 * if only CF_BITMAP is avalilable, perserve Screen palette.</span>
00512 <span class="comment">                 */</span>
00513                 <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a18">PasteScreenPalette</a>(pwinsta);
00514             }
00515         }
00516     }
00517 
00518     <span class="keywordflow">return</span>;
00519 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="ntuser/kernel/clipbrd.c::PasteScreenPalette" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PasteScreenPalette           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwinsta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00270">270</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02099">tagDISPLAYINFO::hdcScreen</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01007">InternalSetClipboardData()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01071">PUSIF_PALETTEDISPLAY</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01076">TEST_PUSIF</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>.
<p>
<pre class="fragment"><div>00272 {
00273     <span class="keywordtype">int</span>          irgb;
00274     <span class="keywordtype">int</span>          crgbPal;
00275     LPLOGPALETTE lppal;
00276     HPALETTE     hpal = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00277     <span class="keywordtype">int</span>          crgbFixed;
00278 
00279     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(PUSIF_PALETTEDISPLAY));
00280 
00281     <span class="comment">/*</span>
00282 <span class="comment">     * Use current state of screen.</span>
00283 <span class="comment">     */</span>
00284     crgbPal = GreGetDeviceCaps(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, SIZEPALETTE);
00285 
00286     <span class="keywordflow">if</span> (GreGetSystemPaletteUse(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>) == SYSPAL_STATIC) {
00287         crgbFixed = GreGetDeviceCaps(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, NUMRESERVED) / 2;
00288     } <span class="keywordflow">else</span> {
00289         crgbFixed = 1;
00290     }
00291 
00292     lppal = (LPLOGPALETTE)UserAllocPool(<span class="keyword">sizeof</span>(LOGPALETTE) +
00293                                               (<span class="keyword">sizeof</span>(PALETTEENTRY) * crgbPal),
00294                                               TAG_CLIPBOARD);
00295 
00296     <span class="keywordflow">if</span> (lppal == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00297         <span class="keywordflow">return</span>;
00298 
00299     lppal-&gt;palVersion    = 0x300;
00300     lppal-&gt;palNumEntries = (WORD)crgbPal;
00301 
00302     <span class="keywordflow">if</span> (GreGetSystemPaletteEntries(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, 0, crgbPal, lppal-&gt;palPalEntry)) {
00303 
00304         crgbPal -= crgbFixed;
00305 
00306         <span class="keywordflow">for</span> (irgb = crgbFixed; irgb &lt; crgbPal; irgb++) {
00307 
00308             <span class="comment">/*</span>
00309 <span class="comment">             * Any non-system palette entries need to have PC_NOCOLLAPSE</span>
00310 <span class="comment">             * flag set.</span>
00311 <span class="comment">             */</span>
00312             lppal-&gt;palPalEntry[irgb].peFlags = PC_NOCOLLAPSE;
00313         }
00314 
00315         hpal = GreCreatePalette(lppal);
00316     }
00317 
00318     UserFreePool((HANDLE)lppal);
00319 
00320     <span class="keywordflow">if</span> (hpal) {
00321         <a class="code" href="../../d4/d1/userk_8h.html#a1496">InternalSetClipboardData</a>(pwinsta, CF_PALETTE, hpal, FALSE, TRUE);
00322         GreSetPaletteOwner(hpal, OBJECT_OWNER_PUBLIC);
00323     }
00324 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="ntuser/kernel/clipbrd.c::SizeOfDib" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> SizeOfDib           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPBITMAPINFOHEADER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>lpDib</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01132">1132</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02354">abs</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02223">WIDTHBYTES</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">xxxGetDummyDib()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>.
<p>
<pre class="fragment"><div>01134 {
01135     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwColor;
01136     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwBits;
01137 
01138     <span class="comment">/*</span>
01139 <span class="comment">     * Calculate size of bitmap bits.</span>
01140 <span class="comment">     */</span>
01141     dwBits = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a548">WIDTHBYTES</a>(lpDib-&gt;biWidth * lpDib-&gt;biBitCount) * <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(lpDib-&gt;biHeight);
01142 
01143     <span class="comment">/*</span>
01144 <span class="comment">     * Calculate size of color table.</span>
01145 <span class="comment">     */</span>
01146     <span class="keywordflow">if</span> ((lpDib-&gt;biCompression == BI_RGB) ||
01147         (lpDib-&gt;biCompression == BI_BITFIELDS)) {
01148 
01149         <span class="keywordflow">if</span> (lpDib-&gt;biClrUsed) {
01150             dwColor = lpDib-&gt;biClrUsed * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01151         } <span class="keywordflow">else</span> {
01152             <span class="keywordflow">if</span> (lpDib-&gt;biBitCount &lt;= 8) {
01153                 dwColor = (1 &lt;&lt; lpDib-&gt;biBitCount) * <span class="keyword">sizeof</span>(RGBQUAD);
01154             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lpDib-&gt;biBitCount == 16) || (lpDib-&gt;biBitCount == 32)) {
01155                 <span class="keywordflow">if</span> (lpDib-&gt;biCompression == BI_BITFIELDS) {
01156                     dwColor = (3 * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
01157                 } <span class="keywordflow">else</span> {
01158                     dwColor = 0;
01159                 }
01160             } <span class="keywordflow">else</span> {
01161                 dwColor = 0;
01162             }
01163         }
01164 
01165     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpDib-&gt;biCompression == BI_RLE4) {
01166 
01167         dwColor = 16 * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01168 
01169     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpDib-&gt;biCompression == BI_RLE8) {
01170 
01171         dwColor = 256 * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01172 
01173     } <span class="keywordflow">else</span> {
01174 
01175         dwColor = 0;
01176 
01177     }
01178 
01179     <span class="keywordflow">return</span> (lpDib-&gt;biSize + dwColor + dwBits);
01180 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="ntuser/kernel/clipbrd.c::UT_FreeCBFormat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UT_FreeCBFormat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d0/structtagCLIP.html">PCLIP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pClip</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">701</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00020">DUMMY_DIB_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00019">DUMMY_TEXT_HANDLE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02940">tagCLIP::fGlobalHandle</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00026">GDIFORMAT</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00027">HANDLEFORMAT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00353">HMValidateHandleNoRip()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00036">IsMetaDummyHandle</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00028">METAFILEFORMAT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00025">PRIVATEFORMAT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00911">TYPE_CLIPDATA</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00668">UT_GetFormatType()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01007">InternalSetClipboardData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00851">xxxEmptyClipboard()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01658">xxxGetDummyBitmap()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">xxxGetDummyDib()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02111">xxxGetDummyPalette()</a>.
<p>
<pre class="fragment"><div>00703 {
00704     PVOID pObj;
00705 
00706     <span class="comment">/*</span>
00707 <span class="comment">     * No Data, then no point.</span>
00708 <span class="comment">     */</span>
00709     <span class="keywordflow">if</span> (pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00710         <span class="keywordflow">return</span>;
00711 
00712     <span class="comment">/*</span>
00713 <span class="comment">     * Free the object given the type.</span>
00714 <span class="comment">     */</span>
00715     <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a22">UT_GetFormatType</a>(pClip)) {
00716 
00717     <span class="keywordflow">case</span> <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a8">METAFILEFORMAT</a>:
00718 
00719         <span class="comment">/*</span>
00720 <span class="comment">         * GDI stores the metafile on the server side for the clipboard.</span>
00721 <span class="comment">         * Notify the GDI server to free the metafile data.</span>
00722 <span class="comment">         */</span>
00723         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a11">IsMetaDummyHandle</a>(pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>)) {
00724             GreDeleteServerMetaFile(pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>);
00725         }
00726         <span class="keywordflow">break</span>;
00727 
00728     <span class="keywordflow">case</span> <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a7">HANDLEFORMAT</a>:
00729 
00730         <span class="comment">/*</span>
00731 <span class="comment">         * It's a simple global object.  Text/Dib handles can be</span>
00732 <span class="comment">         * dummy handles, so check for those first.  We need to</span>
00733 <span class="comment">         * perform extra-checks on the format since HANDLEFORMATS</span>
00734 <span class="comment">         * are the default-type.  We only want to delete those obects</span>
00735 <span class="comment">         * we can quarentee are handle-types.</span>
00736 <span class="comment">         */</span>
00737         <span class="keywordflow">if</span> ((pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a0">DUMMY_TEXT_HANDLE</a>) &amp;&amp;
00738             (pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>)) {
00739 
00740             pObj = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>, TYPE_CLIPDATA);
00741             <span class="keywordflow">if</span> (pObj) {
00742                 <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pObj);
00743             }
00744         }
00745         <span class="keywordflow">break</span>;
00746 
00747     <span class="keywordflow">case</span> <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a6">GDIFORMAT</a>:
00748 
00749         <span class="comment">/*</span>
00750 <span class="comment">         * Bitmaps can be marked as dummy-handles.</span>
00751 <span class="comment">         */</span>
00752         <span class="keywordflow">if</span> (pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>) {
00753             GreDeleteObject(pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>);
00754         }
00755         <span class="keywordflow">break</span>;
00756 
00757     <span class="keywordflow">case</span> <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a5">PRIVATEFORMAT</a>:
00758 
00759         <span class="comment">/*</span>
00760 <span class="comment">         * Destroy the private data here if it is a global handle: we</span>
00761 <span class="comment">         * aren't destroying the client's copy here, only the server's,</span>
00762 <span class="comment">         * which nobody wants (including the server!)</span>
00763 <span class="comment">         */</span>
00764         <span class="keywordflow">if</span> (pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o2">fGlobalHandle</a>) {
00765             pObj = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>, TYPE_CLIPDATA);
00766             <span class="keywordflow">if</span> (pObj) {
00767                 <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pObj);
00768             }
00769         }
00770         <span class="keywordflow">break</span>;
00771     }
00772 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="ntuser/kernel/clipbrd.c::UT_GetFormatType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int UT_GetFormatType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d0/structtagCLIP.html">PCLIP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pClip</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00668">668</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02938">tagCLIP::fmt</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00026">GDIFORMAT</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00027">HANDLEFORMAT</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00028">METAFILEFORMAT</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00025">PRIVATEFORMAT</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>.
<p>
<pre class="fragment"><div>00670 {
00671     <span class="keywordflow">switch</span> (pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o0">fmt</a>) {
00672 
00673     <span class="keywordflow">case</span> CF_BITMAP:
00674     <span class="keywordflow">case</span> CF_DSPBITMAP:
00675     <span class="keywordflow">case</span> CF_PALETTE:
00676         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a6">GDIFORMAT</a>;
00677 
00678     <span class="keywordflow">case</span> CF_METAFILEPICT:
00679     <span class="keywordflow">case</span> CF_DSPMETAFILEPICT:
00680     <span class="keywordflow">case</span> CF_ENHMETAFILE:
00681     <span class="keywordflow">case</span> CF_DSPENHMETAFILE:
00682         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a8">METAFILEFORMAT</a>;
00683 
00684     <span class="keywordflow">case</span> CF_OWNERDISPLAY:
00685         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a5">PRIVATEFORMAT</a>;
00686 
00687     <span class="keywordflow">default</span>:
00688         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a7">HANDLEFORMAT</a>;
00689     }
00690 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="ntuser/kernel/clipbrd.c::xxxChangeClipboardChain" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxChangeClipboardChain           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwndRemove</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwndNewNext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02618">2618</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02727">tagWINDOWSTATION::spwndClipViewer</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01668">ThreadLockWinSta</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01698">ThreadUnlockWinSta</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03864">NtUserChangeClipboardChain()</a>.
<p>
<pre class="fragment"><div>02621 {
02622     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>             tlpwinsta;
02623     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
02624     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           result;
02625     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>             tlpwndClipViewer;
02626     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    ptiCurrent;
02627 
02628     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndRemove);
02629     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndNewNext);
02630 
02631     <span class="comment">/*</span>
02632 <span class="comment">     * Blow it off is the caller does not have the proper access rights.</span>
02633 <span class="comment">     */</span>
02634     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02635         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02636 
02637     <span class="comment">/*</span>
02638 <span class="comment">     * pwndRemove should be this thread's window, pwndNewNext will</span>
02639 <span class="comment">     * either be NULL or another thread's window.</span>
02640 <span class="comment">     */</span>
02641     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02642 
02643     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndRemove) != ptiCurrent) {
02644         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Clipboard: ChangeClipboardChain will not remove cross threads"</span>);
02645         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02646     }
02647 
02648     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02649         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Clipboard: ChangeClipboardChain has no viewer window"</span>);
02650         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02651     }
02652 
02653     <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, pwinsta, &amp;tlpwinsta);
02654 
02655     <span class="keywordflow">if</span> (pwndRemove == pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>) {
02656 
02657         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>, pwndNewNext);
02658         result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02659 
02660     } <span class="keywordflow">else</span> {
02661 
02662         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>, &amp;tlpwndClipViewer);
02663         result = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>,
02664                                       WM_CHANGECBCHAIN,
02665                                       (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndRemove),
02666                                       (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndNewNext));
02667         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndClipViewer);
02668     }
02669 
02670     <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
02671 
02672     <span class="keywordflow">return</span> result;
02673 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="ntuser/kernel/clipbrd.c::xxxCloseClipboard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxCloseClipboard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwinsta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00538">538</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02733">tagWINDOWSTATION::fClipboardChanged</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02724">tagWINDOWSTATION::ptiClipLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02726">tagWINDOWSTATION::spwndClipOpen</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01668">ThreadLockWinSta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01698">ThreadUnlockWinSta</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00220">xxxDrawClipboard()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02779">ForceEmptyClipboard()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03252">NtUserCloseClipboard()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>, and <a class="el" href="../../d6/d8/snapshot_8c-source.html#l00023">xxxSnapWindow()</a>.
<p>
<pre class="fragment"><div>00540 {
00541     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00542     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwinsta;
00543 
00544     <span class="keywordflow">if</span> ((pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00545         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00546     }
00547 
00548     <span class="comment">/*</span>
00549 <span class="comment">     * If the current thread does not have the clipboard open, return</span>
00550 <span class="comment">     * FALSE.</span>
00551 <span class="comment">     */</span>
00552     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00553 
00554     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> != ptiCurrent) {
00555         RIPERR0(ERROR_CLIPBOARD_NOT_OPEN, RIP_WARNING, <span class="stringliteral">"xxxCloseClipboard not open"</span>);
00556         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00557     }
00558 
00559     <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, pwinsta, &amp;tlpwinsta);
00560 
00561     <span class="comment">/*</span>
00562 <span class="comment">     * Convert data to independent formats.</span>
00563 <span class="comment">     */</span>
00564     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o14">fClipboardChanged</a>)
00565         <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a19">MungeClipData</a>(pwinsta);
00566 
00567     <span class="comment">/*</span>
00568 <span class="comment">     * Release the clipboard explicitly after we're finished calling</span>
00569 <span class="comment">     * SetClipboardData().</span>
00570 <span class="comment">     */</span>
00571     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o7">spwndClipOpen</a>);
00572     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00573 
00574     <span class="comment">/*</span>
00575 <span class="comment">     * Notify any clipboard viewers that the clipboard contents have</span>
00576 <span class="comment">     * changed.</span>
00577 <span class="comment">     */</span>
00578     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o14">fClipboardChanged</a>)
00579         <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a17">xxxDrawClipboard</a>(pwinsta);
00580 
00581     <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
00582 
00583     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00584 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="ntuser/kernel/clipbrd.c::xxxDrawClipboard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxDrawClipboard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwinsta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00220">220</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02733">tagWINDOWSTATION::fClipboardChanged</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02725">tagWINDOWSTATION::ptiDrawingClipboard</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02728">tagWINDOWSTATION::spwndClipOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02727">tagWINDOWSTATION::spwndClipViewer</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01069">xxxSendNotifyMessage()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02687">DisownClipboard()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00538">xxxCloseClipboard()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02572">xxxSetClipboardViewer()</a>.
<p>
<pre class="fragment"><div>00222 {
00223     <span class="comment">/*</span>
00224 <span class="comment">     * This is what pwinsta-&gt;fClipboardChanged is for - to tell us to</span>
00225 <span class="comment">     * update the clipboard viewers.</span>
00226 <span class="comment">     */</span>
00227     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o14">fClipboardChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00228 
00229     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o6">ptiDrawingClipboard</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00230 
00231         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndClipViewer;
00232 
00233         <span class="comment">/*</span>
00234 <span class="comment">         * Send the message that causes clipboard viewers to redraw.</span>
00235 <span class="comment">         * Remember that we're sending this message so we don't send</span>
00236 <span class="comment">         * this message twice.</span>
00237 <span class="comment">         */</span>
00238         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o6">ptiDrawingClipboard</a> = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00239         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>, &amp;tlpwndClipViewer);
00240 
00241         <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00242             <span class="comment">/*</span>
00243 <span class="comment">             * Desynchronize 32 bit apps.</span>
00244 <span class="comment">             */</span>
00245             <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>,
00246                                  WM_DRAWCLIPBOARD,
00247                                  (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>),
00248                                  0L);
00249         } <span class="keywordflow">else</span> {
00250             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>,
00251                            WM_DRAWCLIPBOARD,
00252                            (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>),
00253                            0L);
00254         }
00255 
00256         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndClipViewer);
00257         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o6">ptiDrawingClipboard</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00258     }
00259 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="ntuser/kernel/clipbrd.c::xxxEmptyClipboard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxEmptyClipboard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwinsta</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00851">851</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02730">tagWINDOWSTATION::cNumClipFormats</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02718">tagWINDOWSTATION::dwWSF_Flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02733">tagWINDOWSTATION::fClipboardChanged</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02734">tagWINDOWSTATION::fInDelayedRendering</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02938">tagCLIP::fmt</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02732">tagWINDOWSTATION::iClipSequenceNumber</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02731">tagWINDOWSTATION::iClipSerialNumber</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02729">tagWINDOWSTATION::pClipBase</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02724">tagWINDOWSTATION::ptiClipLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02726">tagWINDOWSTATION::spwndClipOpen</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02728">tagWINDOWSTATION::spwndClipOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01668">ThreadLockWinSta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01698">ThreadUnlockWinSta</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00084">UserDeleteAtom()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02706">WSF_DYING</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00783">xxxSendClipboardMessage()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02779">ForceEmptyClipboard()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03263">NtUserEmptyClipboard()</a>, and <a class="el" href="../../d6/d8/snapshot_8c-source.html#l00023">xxxSnapWindow()</a>.
<p>
<pre class="fragment"><div>00853 {
00854     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwinsta;
00855     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>       pClip;
00856     <span class="keywordtype">int</span>         cFmts;
00857     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fDying;
00858     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)(W32GetCurrentThread());
00859     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bInternal = !(pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00860 
00861     <span class="comment">/*</span>
00862 <span class="comment">     * Check access.</span>
00863 <span class="comment">     */</span>
00864     <span class="keywordflow">if</span> ((pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00865         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00866 
00867     <span class="comment">/*</span>
00868 <span class="comment">     * If the current thread doesn't have the clipboard open, it can't be</span>
00869 <span class="comment">     * be emptied!</span>
00870 <span class="comment">     */</span>
00871 
00872     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00873         UserAssert(bInternal);
00874     }
00875 
00876     <span class="keywordflow">if</span> (!bInternal) {
00877         <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> != ptiCurrent) {
00878             RIPERR0(ERROR_CLIPBOARD_NOT_OPEN, RIP_WARNING, <span class="stringliteral">"xxxEmptyClipboard: clipboard not open"</span>);
00879             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00880         }
00881     }
00882 
00883     <span class="comment">/*</span>
00884 <span class="comment">     * Only send messages at logoff.</span>
00885 <span class="comment">     */</span>
00886     fDying = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a318">WSF_DYING</a>;
00887 
00888     <span class="keywordflow">if</span> (!fDying &amp;&amp; ptiCurrent) {
00889         <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, pwinsta, &amp;tlpwinsta);
00890 
00891         <span class="comment">/*</span>
00892 <span class="comment">         * Let the clipboard owner know that the clipboard is</span>
00893 <span class="comment">         * being destroyed.</span>
00894 <span class="comment">         */</span>
00895         <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a24">xxxSendClipboardMessage</a>(pwinsta, WM_DESTROYCLIPBOARD);
00896     }
00897 
00898     <span class="keywordflow">if</span> ((pClip = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00899 
00900         <span class="comment">/*</span>
00901 <span class="comment">         * Loop through all the clipboard entries and free their data</span>
00902 <span class="comment">         * objects.  Only call DeleteAtom for real atoms.</span>
00903 <span class="comment">         */</span>
00904         <span class="keywordflow">for</span> (cFmts = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a>; cFmts-- != 0;) {
00905 
00906             <span class="keywordflow">if</span> ((ATOM)pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o0">fmt</a> &gt;= MAXINTATOM)
00907                 <a class="code" href="../../d4/d1/userk_8h.html#a1299">UserDeleteAtom</a>((ATOM)pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o0">fmt</a>);
00908 
00909             <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a23">UT_FreeCBFormat</a>(pClip++);
00910         }
00911 
00912         <span class="comment">/*</span>
00913 <span class="comment">         * Free the clipboard itself.</span>
00914 <span class="comment">         */</span>
00915         UserFreePool((HANDLE)pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a>);
00916         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o10">pClipBase</a>       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00917         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o11">cNumClipFormats</a> = 0;
00918     }
00919 
00920     <span class="comment">/*</span>
00921 <span class="comment">     * The "empty" succeeds.  The owner is now the thread that has the</span>
00922 <span class="comment">     * clipboard open.  Remember the clipboard has changed; this will</span>
00923 <span class="comment">     * cause the viewer to redraw at CloseClipboard time.</span>
00924 <span class="comment">     */</span>
00925     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o14">fClipboardChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00926     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>, pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o7">spwndClipOpen</a>);
00927 
00928     <span class="comment">/*</span>
00929 <span class="comment">     * Change the clipboard serial number so that the client-side</span>
00930 <span class="comment">     * clipboard caches of all the processes will get</span>
00931 <span class="comment">     * flushed on the next OpenClipboard.</span>
00932 <span class="comment">     */</span>
00933     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o12">iClipSerialNumber</a>++;
00934     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o13">iClipSequenceNumber</a>++;
00935     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o15">fInDelayedRendering</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00936 
00937     <span class="keywordflow">if</span> (!fDying &amp;&amp; ptiCurrent)
00938         <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
00939 
00940     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00941 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="ntuser/kernel/clipbrd.c::xxxGetClipboardData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE xxxGetClipboardData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>fmt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pgcd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">2356</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00020">DUMMY_DIB_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00021">DUMMY_METARENDER_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00019">DUMMY_TEXT_HANDLE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01388">tagGETCLIPBDATA::fGlobalHandle</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02940">tagCLIP::fGlobalHandle</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00036">IsMetaDummyHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02724">tagWINDOWSTATION::ptiClipLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01658">xxxGetDummyBitmap()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">xxxGetDummyDib()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02111">xxxGetDummyPalette()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02200">xxxGetDummyText()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02303">xxxGetRenderData()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04050">NtUserGetClipboardData()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01658">xxxGetDummyBitmap()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">xxxGetDummyDib()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02111">xxxGetDummyPalette()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02200">xxxGetDummyText()</a>.
<p>
<pre class="fragment"><div>02360 {
02361     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>  pClip;
02362     HANDLE hData;
02363 
02364     <span class="comment">/*</span>
02365 <span class="comment">     * Check the clipboard owner.</span>
02366 <span class="comment">     */</span>
02367     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
02368         RIPERR0(ERROR_CLIPBOARD_NOT_OPEN, RIP_VERBOSE, <span class="stringliteral">"GetClipboardData: clipboard not open"</span>);
02369         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02370     }
02371 
02372     <span class="comment">/*</span>
02373 <span class="comment">     * Make sure the format is available.</span>
02374 <span class="comment">     */</span>
02375     <span class="keywordflow">if</span> ((pClip = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, fmt)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02376         RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"Clipboard: Requested format 0x%lX not available"</span>, fmt);
02377         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02378     }
02379 
02380     <span class="comment">/*</span>
02381 <span class="comment">     * If this is a DUMMY_META*_HANDLE it means that the other</span>
02382 <span class="comment">     * metafile format was set in as a delay render format and we should</span>
02383 <span class="comment">     * as for that format to get the metafile because the app has not told</span>
02384 <span class="comment">     * us they now about this format.</span>
02385 <span class="comment">     */</span>
02386     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a11">IsMetaDummyHandle</a>(pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>)) {
02387 
02388         <span class="keywordflow">if</span> (fmt == CF_ENHMETAFILE) {
02389             fmt = CF_METAFILEPICT;
02390         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fmt == CF_METAFILEPICT) {
02391             fmt = CF_ENHMETAFILE;
02392         } <span class="keywordflow">else</span> {
02393             RIPMSG0(RIP_WARNING,
02394                   <span class="stringliteral">"Clipboard: Meta Render/Clone expects a metafile type"</span>);
02395         }
02396 
02397         <span class="keywordflow">if</span> ((pClip = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, fmt)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02398             RIPMSG1(RIP_WARNING,
02399                   <span class="stringliteral">"Clipboard: Meta Render/Clone format 0x%lX not available"</span>, fmt);
02400             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02401         }
02402     }
02403 
02404     <span class="comment">/*</span>
02405 <span class="comment">     * This is the data we're returning, unless it's a dummy or</span>
02406 <span class="comment">     * render handle.</span>
02407 <span class="comment">     */</span>
02408     hData = pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>;
02409 
02410     <span class="comment">/*</span>
02411 <span class="comment">     * We are dealing with non-handles.  Retrieve the real data</span>
02412 <span class="comment">     * through these inline-routines.  NOTE: these make recursive</span>
02413 <span class="comment">     * calls to xxxGetClipboardData().  So care must be taken to</span>
02414 <span class="comment">     * assure the pClip is pointing to what we think it's pointing</span>
02415 <span class="comment">     * to.</span>
02416 <span class="comment">     */</span>
02417     <span class="keywordflow">if</span> ((hData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (hData == <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a2">DUMMY_METARENDER_HANDLE</a>)) {
02418 
02419         hData = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a40">xxxGetRenderData</a>(pwinsta, fmt);
02420 
02421     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hData == <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>) {
02422 
02423         <span class="keywordflow">switch</span> (fmt) {
02424         <span class="keywordflow">case</span> CF_DIB:
02425             hData = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a35">xxxGetDummyDib</a>(pwinsta, pgcd);
02426             <span class="keywordflow">break</span>;
02427         <span class="keywordflow">case</span> CF_DIBV5:
02428             hData = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a36">xxxGetDummyDibV5</a>(pwinsta, pgcd);
02429             <span class="keywordflow">break</span>;
02430         <span class="keywordflow">case</span> CF_BITMAP:
02431             hData = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a34">xxxGetDummyBitmap</a>(pwinsta, pgcd);
02432             <span class="keywordflow">break</span>;
02433         <span class="keywordflow">case</span> CF_PALETTE:
02434             hData = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a38">xxxGetDummyPalette</a>(pwinsta, pgcd);
02435             <span class="keywordflow">break</span>;
02436         }
02437 
02438     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hData == <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a0">DUMMY_TEXT_HANDLE</a>) {
02439 
02440         hData = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a39">xxxGetDummyText</a>(pwinsta, fmt, pgcd);
02441     } <span class="keywordflow">else</span> {
02442         <span class="comment">/*</span>
02443 <span class="comment">         * This path took no callbacks, so we know pClip is OK.</span>
02444 <span class="comment">         */</span>
02445         <span class="keywordflow">if</span> (pgcd)
02446             pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o1">fGlobalHandle</a> = pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o2">fGlobalHandle</a>;
02447 
02448         <span class="keywordflow">return</span> hData;
02449     }
02450 
02451     <span class="comment">/*</span>
02452 <span class="comment">     * The callbacks for dummy handle resolution have possibly</span>
02453 <span class="comment">     * invalidated pClip -- recreate it.</span>
02454 <span class="comment">     */</span>
02455 
02456     <span class="keywordflow">if</span> ((pClip = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, fmt)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02457         RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"Clipboard: Requested format 0x%lX not available"</span>, fmt);
02458         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02459     }
02460 
02461     <span class="comment">/*</span>
02462 <span class="comment">     * Return if this is a global-handle.</span>
02463 <span class="comment">     */</span>
02464     <span class="keywordflow">if</span> (pgcd)
02465         pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o1">fGlobalHandle</a> = pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o2">fGlobalHandle</a>;
02466 
02467     <span class="keywordflow">return</span> hData;
02468 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="ntuser/kernel/clipbrd.c::xxxGetDummyBitmap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE xxxGetDummyBitmap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pgcd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01658">1658</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02453">tagCLIPDATA::abData</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02452">tagCLIPDATA::cbData</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01189">DIBtoBMP()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00020">DUMMY_DIB_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00353">HMValidateHandleNoRip()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01391">tagGETCLIPBDATA::hPalette</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1008">PGETCLIPBDATA</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01071">PUSIF_PALETTEDISPLAY</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01076">TEST_PUSIF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00911">TYPE_CLIPDATA</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01387">tagGETCLIPBDATA::uFmtRet</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
<pre class="fragment"><div>01661 {
01662     HANDLE             hData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01663     <a class="code" href="../../d6/d0/structtagCLIPDATA.html">PCLIPDATA</a>          pData;
01664     HBITMAP            hBitmap;
01665     LPBITMAPINFOHEADER lpbih;
01666     ULONG              cjBitmap;
01667     HPALETTE           hPal = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01668 
01669     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>              pClipT;
01670 
01671     <span class="comment">/*</span>
01672 <span class="comment">     * If palette display, then first attempt to get the palette</span>
01673 <span class="comment">     * for this bitmap.</span>
01674 <span class="comment">     */</span>
01675     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(PUSIF_PALETTEDISPLAY)) {
01676         hPal = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, CF_PALETTE, pgcd);
01677     }
01678 
01679     <span class="comment">/*</span>
01680 <span class="comment">     * The convertion priority is CF_DIBV5 and then CF_DIB,</span>
01681 <span class="comment">     * so, check we have CF_DIBV5 first.</span>
01682 <span class="comment">     */</span>
01683     pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_DIBV5);
01684     <span class="keywordflow">if</span> (pClipT &amp;&amp; (pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>)) {
01685 
01686         <span class="comment">/*</span>
01687 <span class="comment">         * Ok, we have *real* CF_DIBV5 data, At this moment, just</span>
01688 <span class="comment">         * go back to client side, then create bitmap handle for</span>
01689 <span class="comment">         * CF_BITMAP. Since color conversion only can do it on</span>
01690 <span class="comment">         * user-mode.</span>
01691 <span class="comment">         */</span>
01692         <span class="keywordflow">if</span> (hData = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, CF_DIBV5, pgcd)) {
01693 
01694             <span class="comment">/*</span>
01695 <span class="comment">             * Return the type of the returned data.</span>
01696 <span class="comment">             * Again, convertion will happen in client side.</span>
01697 <span class="comment">             */</span>
01698             pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a>  = CF_DIBV5;
01699             pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o3">hPalette</a> = hPal;
01700 
01701             <span class="keywordflow">return</span> (hData);
01702         }
01703     }
01704 
01705     <span class="comment">/*</span>
01706 <span class="comment">     * If the bitmap is a dummy, then we have a problem.  We can't</span>
01707 <span class="comment">     * retrieve a bitmap if we only have dummys to work with.</span>
01708 <span class="comment">     */</span>
01709     pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_DIB);
01710     <span class="keywordflow">if</span> (pClipT &amp;&amp; (pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>)) {
01711         hData = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, CF_DIB, pgcd);
01712 
01713     }
01714     <span class="keywordflow">if</span> (hData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01715         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01716 
01717     <span class="comment">/*</span>
01718 <span class="comment">     * Since dibs (memory-handles) are stored in a special</span>
01719 <span class="comment">     * format (size,base,data), we need to offet the pointer</span>
01720 <span class="comment">     * to the right offset (2 uints).</span>
01721 <span class="comment">     */</span>
01722     <span class="keywordflow">if</span> (pData = (<a class="code" href="../../d6/d0/structtagCLIPDATA.html">PCLIPDATA</a>)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(hData, TYPE_CLIPDATA)) {
01723         lpbih = (LPBITMAPINFOHEADER)&amp;pData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o2">abData</a>;
01724         cjBitmap = pData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o1">cbData</a>;
01725     } <span class="keywordflow">else</span> {
01726         UserAssert(pData != NULL);
01727         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01728     }
01729 
01730     <span class="comment">/*</span>
01731 <span class="comment">     * Convert the dib to a bitmap.</span>
01732 <span class="comment">     */</span>
01733     <span class="comment">/*</span>
01734 <span class="comment">     * The buffer size for bitmap should be larger than</span>
01735 <span class="comment">     * bitmap header + color table + bitmap bits data.</span>
01736 <span class="comment">     */</span>
01737     <span class="keywordflow">if</span> ((cjBitmap &gt;= <span class="keyword">sizeof</span>(BITMAPCOREHEADER)) &amp;&amp;
01738         (cjBitmap &gt;= (GreGetBitmapSize((CONST BITMAPINFO *)lpbih,DIB_RGB_COLORS) +
01739                       GreGetBitmapBitsSize((CONST BITMAPINFO *)lpbih)))) {
01740 
01741         <span class="keywordflow">if</span> (hBitmap = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a30">DIBtoBMP</a>(lpbih, hPal)) {
01742             <span class="comment">/*</span>
01743 <span class="comment">             * Once, we create *real* bitmap, overwrite dummy handle.</span>
01744 <span class="comment">             */</span>
01745 
01746             pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_BITMAP);
01747             <span class="keywordflow">if</span> (pClipT) {
01748                 <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a23">UT_FreeCBFormat</a>(pClipT);
01749                 pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> = hBitmap;
01750                 GreSetBitmapOwner(hBitmap, OBJECT_OWNER_PUBLIC);
01751 
01752                 <span class="comment">/*</span>
01753 <span class="comment">                 * Let callee know we can obtain CF_BITMAP</span>
01754 <span class="comment">                 */</span>
01755                 pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> = CF_BITMAP;
01756             } <span class="keywordflow">else</span> {
01757                 <span class="comment">/*</span>
01758 <span class="comment">                 * Bleh -- now we can't find the BITMAP entry anymore.  Bail.</span>
01759 <span class="comment">                 */</span>
01760                 RIPMSG0(RIP_WARNING,
01761                       <span class="stringliteral">"Clipboard: CF_BITMAP format not available"</span>);
01762                 GreDeleteObject(hBitmap);
01763                 hBitmap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01764             }
01765         }
01766         <span class="keywordflow">return</span> (HANDLE)hBitmap;
01767     } <span class="keywordflow">else</span> {
01768         RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetClipboardData, bad DIB format\n"</span>);
01769         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01770     }
01771 
01772 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="ntuser/kernel/clipbrd.c::xxxGetDummyDib" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE xxxGetDummyDib           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pgcd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">1784</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00088">_ConvertMemHandle()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01286">BMPtoDIB()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00020">DUMMY_DIB_HANDLE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00353">HMValidateHandleNoRip()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01391">tagGETCLIPBDATA::hPalette</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01071">PUSIF_PALETTEDISPLAY</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01132">SizeOfDib()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01076">TEST_PUSIF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00911">TYPE_CLIPDATA</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01387">tagGETCLIPBDATA::uFmtRet</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
<pre class="fragment"><div>01787 {
01788     HANDLE             hData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01789     HBITMAP            hBitmap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01790     LPBITMAPINFOHEADER lpDib;
01791     HANDLE             hDib;
01792     HPALETTE           hPal = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01793 
01794     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>              pClipT;
01795 
01796     <span class="comment">/*</span>
01797 <span class="comment">     * If palette display, then first attempt to get the palette</span>
01798 <span class="comment">     * for this bitmap.  For palette devices, we must have a palette.</span>
01799 <span class="comment">     */</span>
01800     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(PUSIF_PALETTEDISPLAY)) {
01801         hPal = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, CF_PALETTE, pgcd);
01802 
01803         <span class="keywordflow">if</span> (hPal == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01804             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01805     }
01806 
01807     <span class="comment">/*</span>
01808 <span class="comment">     * The convertion priority is CF_DIBV5 and then CF_BITMAP,</span>
01809 <span class="comment">     * so, check we have CF_DIBV5 first.</span>
01810 <span class="comment">     */</span>
01811     pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_DIBV5);
01812     <span class="keywordflow">if</span> (pClipT &amp;&amp; (pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>)) {
01813 
01814         <span class="comment">/*</span>
01815 <span class="comment">         * Ok, we have *real* CF_DIBV5 data, At this moment, just</span>
01816 <span class="comment">         * go back to client side, then create bitmap data for</span>
01817 <span class="comment">         * CF_DIB. Since color conversion only can do it on</span>
01818 <span class="comment">         * user-mode.</span>
01819 <span class="comment">         */</span>
01820         <span class="keywordflow">if</span> (hData = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, CF_DIBV5, pgcd)) {
01821 
01822             <span class="comment">/*</span>
01823 <span class="comment">             * Return the type of the returned data.</span>
01824 <span class="comment">             * Again, convertion will happen in client side.</span>
01825 <span class="comment">             */</span>
01826             pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a>  = CF_DIBV5;
01827             pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o3">hPalette</a> = hPal;
01828 
01829             <span class="keywordflow">return</span> (hData);
01830         }
01831     }
01832 
01833     <span class="comment">/*</span>
01834 <span class="comment">     * Get the real-bitmap.  We must have one in order to convert</span>
01835 <span class="comment">     * to the dib.  If there's no bitmap, then we have something</span>
01836 <span class="comment">     * wrong.</span>
01837 <span class="comment">     */</span>
01838     pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_BITMAP);
01839     <span class="keywordflow">if</span> (pClipT &amp;&amp; (pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>)) {
01840         hBitmap = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, CF_BITMAP, pgcd);
01841     }
01842 
01843     <span class="keywordflow">if</span> (hBitmap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01844         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01845     }
01846 
01847     <span class="comment">/*</span>
01848 <span class="comment">     * Convert the bitmap to a dib-spec.</span>
01849 <span class="comment">     */</span>
01850     hDib = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01851     <span class="keywordflow">if</span> (lpDib = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a31">BMPtoDIB</a>(hBitmap, hPal, NULL)) {
01852 
01853         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbData = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a29">SizeOfDib</a>(lpDib);;
01854 
01855         <span class="comment">/*</span>
01856 <span class="comment">         * Convert the dib-spec to the special-clipboard</span>
01857 <span class="comment">         * memory-handle (size,base,data).  This so</span>
01858 <span class="comment">         * the client is able to convert properly when</span>
01859 <span class="comment">         * handled a dib.</span>
01860 <span class="comment">         */</span>
01861         hDib = <a class="code" href="../../d4/d1/userk_8h.html#a1487">_ConvertMemHandle</a>((LPBYTE)lpDib, cbData);
01862         UserFreePool(lpDib);
01863 
01864         <span class="keywordflow">if</span> (hDib != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01865             <span class="comment">/*</span>
01866 <span class="comment">             * Once, we create *real* bitmap, overwrite dummy handle.</span>
01867 <span class="comment">             */</span>
01868 
01869             pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_DIB);
01870             <span class="keywordflow">if</span> (pClipT) {
01871                 <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a23">UT_FreeCBFormat</a>(pClipT);
01872                 pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> = hDib;
01873 
01874                 <span class="comment">/*</span>
01875 <span class="comment">                 * Let callee know we can obtain CF_DIB</span>
01876 <span class="comment">                 */</span>
01877                 pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> = CF_DIB;
01878             } <span class="keywordflow">else</span> {
01879                 PVOID pObj;
01880                 <span class="comment">/*</span>
01881 <span class="comment">                 * Bleh -- now we can't find the DIB entry anymore.  Bail.</span>
01882 <span class="comment">                 */</span>
01883                 RIPMSG0(RIP_WARNING,
01884                       <span class="stringliteral">"Clipboard: CF_PDIB format not available"</span>);
01885                 pObj = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(hDib, TYPE_CLIPDATA);
01886                 <span class="keywordflow">if</span> (pObj) {
01887                     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pObj);
01888                 }
01889                 hDib = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01890             }
01891         }
01892     }
01893 
01894     <span class="keywordflow">return</span> hDib;
01895 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="ntuser/kernel/clipbrd.c::xxxGetDummyDibV5" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE xxxGetDummyDibV5           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pgcd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">1907</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00088">_ConvertMemHandle()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02453">tagCLIPDATA::abData</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01616">BMPtoDIBV5()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02452">tagCLIPDATA::cbData</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01450">DIBtoDIBV5()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00020">DUMMY_DIB_HANDLE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00353">HMValidateHandleNoRip()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01071">PUSIF_PALETTEDISPLAY</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01132">SizeOfDib()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01076">TEST_PUSIF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00911">TYPE_CLIPDATA</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01387">tagGETCLIPBDATA::uFmtRet</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
<pre class="fragment"><div>01910 {
01911     HANDLE             hData;
01912     <a class="code" href="../../d6/d0/structtagCLIPDATA.html">PCLIPDATA</a>          pData;
01913     LPBITMAPV5HEADER   lpDibV5 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01914     HANDLE             hDibV5 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01915 
01916     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>              pClipT;
01917 
01918     <span class="comment">/*</span>
01919 <span class="comment">     * The convertion priority is CF_DIB and then CF_BITMAP,</span>
01920 <span class="comment">     * so, check we have CF_DIB first.</span>
01921 <span class="comment">     */</span>
01922     pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_DIB);
01923     <span class="keywordflow">if</span> (pClipT &amp;&amp; (pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>)) {
01924 
01925         <span class="comment">/*</span>
01926 <span class="comment">         * Ok, we have *real* CF_DIB data, get it.</span>
01927 <span class="comment">         */</span>
01928         <span class="keywordflow">if</span> (hData = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, CF_DIB, pgcd)) {
01929 
01930             <span class="comment">/*</span>
01931 <span class="comment">             * Since dibs (memory-handles) are stored in a special</span>
01932 <span class="comment">             * format (size,base,data), we need to offet the pointer</span>
01933 <span class="comment">             * to the right offset (2 uints).</span>
01934 <span class="comment">             */</span>
01935             <span class="keywordflow">if</span> (pData = (<a class="code" href="../../d6/d0/structtagCLIPDATA.html">PCLIPDATA</a>)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(hData, TYPE_CLIPDATA)) {
01936 
01937                 LPBITMAPINFOHEADER lpDib = (LPBITMAPINFOHEADER)&amp;pData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o2">abData</a>;
01938 
01939                 <span class="comment">/*</span>
01940 <span class="comment">                 * Convert the BITMAPINFOHEADER to BITMAPV5HEADER.</span>
01941 <span class="comment">                 */</span>
01942                 lpDibV5 = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a32">DIBtoDIBV5</a>(lpDib, pData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o1">cbData</a>);
01943 
01944             } <span class="keywordflow">else</span> {
01945                 UserAssert(pData != NULL);
01946             }
01947         }
01948     }
01949 
01950     <span class="keywordflow">if</span> (lpDibV5 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01951 
01952         <span class="comment">/*</span>
01953 <span class="comment">         * Try CF_BITMAP, here</span>
01954 <span class="comment">         */</span>
01955         pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_BITMAP);
01956         <span class="keywordflow">if</span> ((pClipT) &amp;&amp;
01957             (pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>) &amp;&amp;
01958             (hData = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, CF_BITMAP, pgcd))) {
01959 
01960             HPALETTE hPal = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01961 
01962             <span class="comment">/*</span>
01963 <span class="comment">             * If palette display, then first attempt to get the palette</span>
01964 <span class="comment">             * for this bitmap.  For palette devices, we must have a palette.</span>
01965 <span class="comment">             */</span>
01966             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a368">TEST_PUSIF</a>(PUSIF_PALETTEDISPLAY)) {
01967 
01968                 hPal = <a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, CF_PALETTE, pgcd);
01969 
01970                 <span class="keywordflow">if</span> (hPal == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01971                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01972             }
01973 
01974             <span class="comment">/*</span>
01975 <span class="comment">             * hData is GDI bitmap handle, Convert the bitmap to a dib-spec.</span>
01976 <span class="comment">             */</span>
01977             lpDibV5 = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a33">BMPtoDIBV5</a>((HBITMAP)hData, hPal);
01978         }
01979     }
01980 
01981     <span class="keywordflow">if</span> (lpDibV5 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01982 
01983         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbData = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a29">SizeOfDib</a>((LPBITMAPINFOHEADER)lpDibV5);
01984 
01985         <span class="comment">/*</span>
01986 <span class="comment">         * Convert the dib-spec to the special-clipboard</span>
01987 <span class="comment">         * memory-handle (size,base,data).  This so</span>
01988 <span class="comment">         * the client is able to convert properly when</span>
01989 <span class="comment">         * handled a dib.</span>
01990 <span class="comment">         */</span>
01991         hDibV5 = <a class="code" href="../../d4/d1/userk_8h.html#a1487">_ConvertMemHandle</a>((LPBYTE)lpDibV5, cbData);
01992         UserFreePool(lpDibV5);
01993 
01994         <span class="keywordflow">if</span> (hDibV5 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01995 
01996             <span class="comment">/*</span>
01997 <span class="comment">             * Once, we create *real* bitmap, overwrite dummy handle.</span>
01998 <span class="comment">             */</span>
01999 
02000             pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_DIBV5);
02001             <span class="keywordflow">if</span> (pClipT) {
02002                 <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a23">UT_FreeCBFormat</a>(pClipT);
02003                 pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> = hDibV5;
02004 
02005                 <span class="comment">/*</span>
02006 <span class="comment">                 * Let callee know we can obtain CF_DIBV5</span>
02007 <span class="comment">                 */</span>
02008                 pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> = CF_DIBV5;
02009             } <span class="keywordflow">else</span> {
02010                 PVOID pObj;
02011                 <span class="comment">/*</span>
02012 <span class="comment">                 * Bleh -- now we can't find the DIB entry anymore.  Bail.</span>
02013 <span class="comment">                 */</span>
02014                 RIPMSG0(RIP_WARNING,
02015                       <span class="stringliteral">"Clipboard: CF_DIBV5 format not available"</span>);
02016                 pObj = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(hDibV5, TYPE_CLIPDATA);
02017                 <span class="keywordflow">if</span> (pObj) {
02018                     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pObj);
02019                 }
02020                 hDibV5 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02021             }
02022         }
02023     }
02024 
02025     <span class="keywordflow">return</span> hDibV5;
02026 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="ntuser/kernel/clipbrd.c::xxxGetDummyPalette" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE xxxGetDummyPalette           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pgcd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02111">2111</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l02453">tagCLIPDATA::abData</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02041">CreateDIBPalette()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00020">DUMMY_DIB_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00023">DUMMY_MAX_HANDLE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00150">HMValidateHandle()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00911">TYPE_CLIPDATA</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
<pre class="fragment"><div>02114 {
02115     HANDLE             hData;
02116     <a class="code" href="../../d6/d0/structtagCLIPDATA.html">PCLIPDATA</a>          pData;
02117     LPBITMAPINFOHEADER lpbih;
02118     HPALETTE           hPal;
02119 
02120     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>              pClipT;
02121 
02122     <span class="comment">/*</span>
02123 <span class="comment">     * Since CF_DIBV5 has higher priority than CF_DIB, so look into</span>
02124 <span class="comment">     * CF_DIBV5 first, to find DIB palette.</span>
02125 <span class="comment">     */</span>
02126     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>               uFmt = CF_DIBV5;
02127 
02128     <span class="keywordflow">if</span> ((pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, uFmt)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02129     {
02130         <span class="keywordflow">if</span> (pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a1">DUMMY_DIB_HANDLE</a>) {
02131 
02132             <span class="comment">/*</span>
02133 <span class="comment">             * Ok, we have real CF_DIBV5, let extract palette from DIBV5.</span>
02134 <span class="comment">             */</span>
02135         } <span class="keywordflow">else</span> {
02136 
02137             <span class="comment">/*</span>
02138 <span class="comment">             * Otherwise, try CF_DIB.</span>
02139 <span class="comment">             */</span>
02140             uFmt = CF_DIB;
02141         }
02142     }
02143 
02144     <span class="comment">/*</span>
02145 <span class="comment">     * Get the DIB by which we derive the palette.  If the DIB comes</span>
02146 <span class="comment">     * back as a dummy, then there's something wrong.  Me must have</span>
02147 <span class="comment">     * a real dib at this point.</span>
02148 <span class="comment">     */</span>
02149     hData = (HANDLE)<a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, uFmt, pgcd);
02150     UserAssert(hData &gt; DUMMY_MAX_HANDLE);
02151 
02152     <span class="keywordflow">if</span> (hData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02153         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02154 
02155     <span class="comment">/*</span>
02156 <span class="comment">     * Since dibs (memory-handles) are stored in a special</span>
02157 <span class="comment">     * format (size,base,data), we need to offet the pointer</span>
02158 <span class="comment">     * to the right offset (2 uints).</span>
02159 <span class="comment">     */</span>
02160     <span class="keywordflow">if</span> (pData = (<a class="code" href="../../d6/d0/structtagCLIPDATA.html">PCLIPDATA</a>)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>(hData, TYPE_CLIPDATA)) {
02161         lpbih = (LPBITMAPINFOHEADER)&amp;pData-&gt;<a class="code" href="../../d6/d0/structtagCLIPDATA.html#o2">abData</a>;
02162     } <span class="keywordflow">else</span> {
02163         UserAssert(pData != NULL);
02164         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02165     }
02166 
02167     <span class="keywordflow">if</span> ((pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_PALETTE)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02168         RIPMSG0(RIP_WARNING,
02169               <span class="stringliteral">"Clipboard: CF_PALETTE format not available"</span>);
02170         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02171     }
02172 
02173     <span class="comment">/*</span>
02174 <span class="comment">     * Note -- if CreateDIBPalette ever changes to leave the crit sect,</span>
02175 <span class="comment">     * we will need to move the above FindClipFormat to after the create</span>
02176 <span class="comment">     * call and deal with gracefully freeing hPal on failure.  pClipT</span>
02177 <span class="comment">     * can change during callbacks.</span>
02178 <span class="comment">     */</span>
02179 
02180     hPal = <a class="code" href="../../d4/d1/userk_8h.html#a1187">CreateDIBPalette</a>(lpbih, lpbih-&gt;biClrUsed);
02181 
02182     <span class="keywordflow">if</span> (hPal != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02183         <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a23">UT_FreeCBFormat</a>(pClipT);
02184         pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> = hPal;
02185         GreSetPaletteOwner(hPal, OBJECT_OWNER_PUBLIC);
02186     }
02187 
02188     <span class="keywordflow">return</span> (HANDLE)hPal;
02189 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="ntuser/kernel/clipbrd.c::xxxGetDummyText" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE xxxGetDummyText           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>fmt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d5/structtagGETCLIPBDATA.html">PGETCLIPBDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pgcd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02200">2200</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00019">DUMMY_TEXT_HANDLE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02938">tagCLIP::fmt</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01390">tagGETCLIPBDATA::hLocale</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01387">tagGETCLIPBDATA::uFmtRet</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
<pre class="fragment"><div>02204 {
02205     HANDLE hText;
02206     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>  pClipT;
02207     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   uFmtMain;
02208     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   uFmtAlt;
02209     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bMain = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02210 
02211     <span class="comment">/*</span>
02212 <span class="comment">     * Get the handle of the other text format available.</span>
02213 <span class="comment">     */</span>
02214     <span class="keywordflow">switch</span> (fmt) {
02215     <span class="keywordflow">case</span> CF_TEXT:
02216         uFmtMain = CF_UNICODETEXT;
02217         uFmtAlt  = CF_OEMTEXT;
02218         <span class="keywordflow">goto</span> GetRealText;
02219 
02220     <span class="keywordflow">case</span> CF_OEMTEXT:
02221         uFmtMain = CF_UNICODETEXT;
02222         uFmtAlt  = CF_TEXT;
02223         <span class="keywordflow">goto</span> GetRealText;
02224 
02225     <span class="keywordflow">case</span> CF_UNICODETEXT:
02226         uFmtMain = CF_TEXT;
02227         uFmtAlt  = CF_OEMTEXT;
02228 
02229 GetRealText:
02230 
02231         <span class="keywordflow">if</span> ((pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, uFmtMain)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02232             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02233 
02234         <span class="keywordflow">if</span> (pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a0">DUMMY_TEXT_HANDLE</a>) {
02235 
02236             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, uFmtMain, pgcd))
02237                 <span class="keywordflow">break</span>;
02238 
02239             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02240         }
02241 
02242         <span class="keywordflow">if</span> ((pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, uFmtAlt)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02243             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02244 
02245         <span class="keywordflow">if</span> (pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a> != <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a0">DUMMY_TEXT_HANDLE</a>) {
02246             bMain = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02247 
02248             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1739">xxxGetClipboardData</a>(pwinsta, uFmtAlt, pgcd))
02249                 <span class="keywordflow">break</span>;
02250         }
02251 
02252         <span class="comment">/*</span>
02253 <span class="comment">         * Fall through to return a dummy handle.</span>
02254 <span class="comment">         */</span>
02255 
02256     <span class="keywordflow">default</span>:
02257         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02258     }
02259 
02260     <span class="comment">/*</span>
02261 <span class="comment">     * Since xxxGetClipboardData leaves the critsect, we need to</span>
02262 <span class="comment">     * reacquire pClipT.</span>
02263 <span class="comment">     */</span>
02264 
02265     pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, bMain? uFmtMain:uFmtAlt);
02266 
02267     <span class="keywordflow">if</span> (pClipT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02268         RIPMSG1(RIP_WARNING,
02269               <span class="stringliteral">"Clipboard: GetDummyText, format 0x%lX not available"</span>, bMain? uFmtMain:uFmtAlt);
02270         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02271     }
02272 
02273     <span class="comment">/*</span>
02274 <span class="comment">     * Return the type of the returned data.</span>
02275 <span class="comment">     */</span>
02276     pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> = pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o0">fmt</a>;
02277     hText         = pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>;
02278 
02279     <span class="comment">/*</span>
02280 <span class="comment">     * Set the locale, since the text will need to be</span>
02281 <span class="comment">     * converted to another format.</span>
02282 <span class="comment">     */</span>
02283     <span class="keywordflow">if</span>(pClipT = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, CF_LOCALE)) {
02284         pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o2">hLocale</a> = pClipT-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>;
02285     } <span class="keywordflow">else</span> {
02286         pgcd-&gt;<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o2">hLocale</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02287     }
02288 
02289     <span class="keywordflow">return</span> hText;
02290 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="ntuser/kernel/clipbrd.c::xxxGetRenderData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE xxxGetRenderData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>fmt</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02303">2303</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02733">tagWINDOWSTATION::fClipboardChanged</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02482">FindClipFormat()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02734">tagWINDOWSTATION::fInDelayedRendering</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02939">tagCLIP::hData</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02728">tagWINDOWSTATION::spwndClipOwner</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02356">xxxGetClipboardData()</a>.
<p>
<pre class="fragment"><div>02306 {
02307     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fClipboardChangedOld;
02308     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>     tlpwndClipOwner;
02309     <a class="code" href="../../d5/d0/structtagCLIP.html">PCLIP</a>          pClip;
02310 
02311     <span class="comment">/*</span>
02312 <span class="comment">     * If the handle is NULL, the data is delay rendered.  This means</span>
02313 <span class="comment">     * we send a message to the current clipboard owner and have</span>
02314 <span class="comment">     * it render the data for us.</span>
02315 <span class="comment">     */</span>
02316     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02317 
02318         <span class="comment">/*</span>
02319 <span class="comment">         * Preserve the pwinsta-&gt;fClipboardChanged flag before SendMessage</span>
02320 <span class="comment">         * and restore the flag later; Thus we ignore the changes</span>
02321 <span class="comment">         * done to the pwinsta-&gt;fClipboardChanged flag by apps while</span>
02322 <span class="comment">         * rendering data in the delayed rendering scheme; This</span>
02323 <span class="comment">         * avoids clipboard viewers from painting twice.</span>
02324 <span class="comment">         */</span>
02325         fClipboardChangedOld = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o14">fClipboardChanged</a>;
02326         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o15">fInDelayedRendering</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02327         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>, &amp;tlpwndClipOwner);
02328         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>, WM_RENDERFORMAT, fmt, 0L);
02329         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndClipOwner);
02330         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o14">fClipboardChanged</a> = fClipboardChangedOld;
02331         pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o15">fInDelayedRendering</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02332 
02333     }
02334 
02335     <span class="keywordflow">if</span> ((pClip = <a class="code" href="../../d4/d1/userk_8h.html#a1495">FindClipFormat</a>(pwinsta, fmt)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02336         RIPMSG1(RIP_WARNING,
02337               <span class="stringliteral">"Clipboard: Meta Render/Clone format 0x%lX not available"</span>, fmt);
02338         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02339     }
02340     <span class="comment">/*</span>
02341 <span class="comment">     * We should have the handle now since it has been rendered.</span>
02342 <span class="comment">     */</span>
02343     <span class="keywordflow">return</span> pClip-&gt;<a class="code" href="../../d5/d0/structtagCLIP.html#o1">hData</a>;
02344 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="ntuser/kernel/clipbrd.c::xxxOpenClipboard" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxOpenClipboard           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPBOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>lpfEmptyClient</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00124">124</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03495">tagPROCESSINFO::iClipSerialNumber</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02731">tagWINDOWSTATION::iClipSerialNumber</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02724">tagWINDOWSTATION::ptiClipLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02726">tagWINDOWSTATION::spwndClipOpen</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02728">tagWINDOWSTATION::spwndClipOwner</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02304">WFDESTROYED</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05481">NtUserOpenClipboard()</a>, and <a class="el" href="../../d6/d8/snapshot_8c-source.html#l00023">xxxSnapWindow()</a>.
<p>
<pre class="fragment"><div>00127 {
00128     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    pti;
00129     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00130 
00131     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00132 
00133     <span class="keywordflow">if</span> (lpfEmptyClient != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00134         *lpfEmptyClient = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00135 
00136     <span class="comment">/*</span>
00137 <span class="comment">     * Blow it off is the caller does not have the proper access rights</span>
00138 <span class="comment">     */</span>
00139     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00140         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00141 
00142     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00143 
00144     <span class="comment">/*</span>
00145 <span class="comment">     * If this thread already has the clipboard open, then there's no</span>
00146 <span class="comment">     * need to proceed further.</span>
00147 <span class="comment">     */</span>
00148     <span class="keywordflow">if</span> ((pwnd == pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o7">spwndClipOpen</a>) &amp;&amp; (pti == pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a>))
00149         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00150 
00151     <span class="keywordflow">if</span> ((pwnd != pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o7">spwndClipOpen</a>) &amp;&amp; (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00152 
00153 <span class="preprocessor">#if DBG</span>
00154 <span class="preprocessor"></span>        <span class="comment">/*</span>
00155 <span class="comment">         * Only rip if the current-thread doesn't have the clipboard</span>
00156 <span class="comment">         * open.</span>
00157 <span class="comment">         */</span>
00158         <span class="keywordflow">if</span> (pti != pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a>) {
00159 
00160             RIPMSG0(RIP_VERBOSE,
00161                   <span class="stringliteral">"Clipboard: OpenClipboard already out by another thread"</span>);
00162         }
00163 <span class="preprocessor">#endif</span>
00164 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00165     }
00166 
00167     <span class="comment">/*</span>
00168 <span class="comment">     * If the window is already destroyed, then the clipboard will not</span>
00169 <span class="comment">     * get disowned when the window is finally unlocked.  FritzS</span>
00170 <span class="comment">     */</span>
00171 
00172     UserAssert((pwnd == NULL ) || (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFDESTROYED)));
00173 
00174     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o7">spwndClipOpen</a>, pwnd);
00175     pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> = pti;
00176 
00177     <span class="comment">/*</span>
00178 <span class="comment">     * The client side clipboard cache needs to be emptied if this thread</span>
00179 <span class="comment">     * doesn't own the data in the clipboard.</span>
00180 <span class="comment">     * Note: We only empty the 16bit clipboard if a 32bit guy owns the</span>
00181 <span class="comment">     * clipboard.</span>
00182 <span class="comment">     * Harvard graphics uses a handle put into the clipboard</span>
00183 <span class="comment">     * by another app, and it expects that handle to still be good after the</span>
00184 <span class="comment">     * clipboard has opened and closed mutilple times</span>
00185 <span class="comment">     * There may be a problem here if app A puts in format foo and app B opens</span>
00186 <span class="comment">     * the clipboard for format foo and then closes it and opens it again</span>
00187 <span class="comment">     * format foo client side handle may not be valid.  We may need some</span>
00188 <span class="comment">     * sort of uniqueness counter to tell if the client side handle is</span>
00189 <span class="comment">     * in sync with the server and always call the server or put the data</span>
00190 <span class="comment">     * in share memory with some semaphore.</span>
00191 <span class="comment">     *</span>
00192 <span class="comment">     * pwinsta-&gt;spwndClipOwner: window that last called EmptyClipboard</span>
00193 <span class="comment">     * pwinsta-&gt;ptiClipLock   : thread that currently has the clipboard open</span>
00194 <span class="comment">     */</span>
00195     <span class="keywordflow">if</span> (lpfEmptyClient != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00196 
00197         <span class="keywordflow">if</span> (!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) ||
00198             (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o20">iClipSerialNumber</a> != pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o12">iClipSerialNumber</a>)) {
00199 
00200             *lpfEmptyClient = (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00201                     (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> !=
00202                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>)-&gt;ppi);
00203 
00204             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o20">iClipSerialNumber</a> = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o12">iClipSerialNumber</a>;
00205         }
00206     }
00207 
00208     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00209 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="ntuser/kernel/clipbrd.c::xxxSendClipboardMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxSendClipboardMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwinsta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00783">783</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02728">tagWINDOWSTATION::spwndClipOwner</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01069">xxxSendNotifyMessage()</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02687">DisownClipboard()</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00851">xxxEmptyClipboard()</a>.
<p>
<pre class="fragment"><div>00786 {
00787     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwndClipOwner;
00788     LONG_PTR dwResult;
00789     LRESULT lRet;
00790 
00791     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00792 
00793         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndClipOwner = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o9">spwndClipOwner</a>;
00794 
00795         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndClipOwner, &amp;tlpwndClipOwner);
00796 
00797         <span class="comment">/*</span>
00798 <span class="comment">         * We use SendNotifyMessage so the apps don't have to synchronize</span>
00799 <span class="comment">         * but some 16 bit apps break because of the different message</span>
00800 <span class="comment">         * ordering so we allow 16 bit apps to synchronize to other apps</span>
00801 <span class="comment">         * Word 6 and Excel 5 with OLE.  Do a copy in Word and then another</span>
00802 <span class="comment">         * copy in Excel and Word faults.</span>
00803 <span class="comment">         */</span>
00804         <span class="keywordflow">if</span> ((message == WM_DESTROYCLIPBOARD) &amp;&amp;
00805             !(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00806 
00807             <span class="comment">/*</span>
00808 <span class="comment">             * Let the app think it's the clipboard owner during</span>
00809 <span class="comment">             * the processing of this message by waiting for it</span>
00810 <span class="comment">             * to be processed before setting the new owner.</span>
00811 <span class="comment">             */</span>
00812             lRet = <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(
00813                     pwndClipOwner,
00814                     WM_DESTROYCLIPBOARD,
00815                     0,
00816                     0L,
00817                     SMTO_ABORTIFHUNG | SMTO_NORMAL,
00818                     5 * 1000,
00819                     &amp;dwResult);
00820 
00821             <span class="keywordflow">if</span> (lRet == 0) {
00822 
00823                 <span class="comment">/*</span>
00824 <span class="comment">                 * The message timed out and wasn't sent, so</span>
00825 <span class="comment">                 * let the app handle it when it's ready.</span>
00826 <span class="comment">                 */</span>
00827                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Sending WM_DESTROYCLIPBOARD timed-out, resending via SendNotifyMessage"</span>);
00828                 <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(pwndClipOwner, WM_DESTROYCLIPBOARD, 0, 0L);
00829             }
00830 
00831         } <span class="keywordflow">else</span> {
00832 
00833             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndClipOwner, message, 0, 0L);
00834         }
00835 
00836         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndClipOwner);
00837     }
00838 
00839 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="ntuser/kernel/clipbrd.c::xxxSetClipboardViewer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> xxxSetClipboardViewer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwndClipViewerNew</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l02572">2572</a> of file <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html">ntuser/kernel/clipbrd.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00049">CheckClipboardAccess()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00194">RevalidateHwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02727">tagWINDOWSTATION::spwndClipViewer</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01668">ThreadLockWinSta</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01698">ThreadUnlockWinSta</a>, and <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00220">xxxDrawClipboard()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l05865">NtUserSetClipboardViewer()</a>.
<p>
<pre class="fragment"><div>02574 {
02575     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>             tlpwinsta;
02576     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
02577     HWND           hwndClipViewerOld;
02578     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    ptiCurrent;
02579 
02580     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndClipViewerNew);
02581 
02582     <span class="comment">/*</span>
02583 <span class="comment">     * Blow it off is the caller does not have the proper access rights.</span>
02584 <span class="comment">     * The NULL return really doesn't indicate an error but the</span>
02585 <span class="comment">     * supposed viewer will never receive any clipboard messages, so</span>
02586 <span class="comment">     * it shouldn't cause any problems.</span>
02587 <span class="comment">     */</span>
02588     <span class="keywordflow">if</span> ((pwinsta = <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a14">CheckClipboardAccess</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02589         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02590 
02591     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02592 
02593     <a class="code" href="../../d4/d1/userk_8h.html#a131">ThreadLockWinSta</a>(ptiCurrent, pwinsta, &amp;tlpwinsta);
02594 
02595     hwndClipViewerOld = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>);
02596     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o8">spwndClipViewer</a>, pwndClipViewerNew);
02597 
02598     <a class="code" href="../../d8/d8/ntuser_2kernel_2clipbrd_8c.html#a17">xxxDrawClipboard</a>(pwinsta);
02599 
02600     <a class="code" href="../../d4/d1/userk_8h.html#a135">ThreadUnlockWinSta</a>(ptiCurrent, &amp;tlpwinsta);
02601 
02602     <span class="keywordflow">if</span> (hwndClipViewerOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02603         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndClipViewerOld);
02604 
02605     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02606 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
