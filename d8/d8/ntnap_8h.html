<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntnap.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntnap.h File Reference</h1>
<p>
<a href="../../d9/d7/ntnap_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d1/struct__NAPCONTROL.html">_NAPCONTROL</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a0">MAX_LONG</a>&nbsp;&nbsp;&nbsp;0x7FFFFFFFL</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a1">MAX_ULONG</a>&nbsp;&nbsp;&nbsp;0xFFFFFFFFL</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a2">NUM_ITERATIONS</a>&nbsp;&nbsp;&nbsp;2000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a3">MIN_ACCEPTABLEOVERHEAD</a>&nbsp;&nbsp;&nbsp;10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a4">NAP_CALIBRATION_SERVICE_NUMBER</a>&nbsp;&nbsp;&nbsp;-1L</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d1/struct__NAPCONTROL.html">_NAPCONTROL</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a5">NAPCONTROL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d1/struct__NAPCONTROL.html">_NAPCONTROL</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a6">PNAPCONTROL</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a8">NapDllInit</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a9">NapRecordInfo</a> (IN ULONG, IN LARGE_INTEGER[])</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a10">NapCreateDataSection</a> (<a class="el" href="../../d4/d1/struct__NAPCONTROL.html">PNAPCONTROL</a> *)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a11">NapCalibrate</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a12">NapSpinOnSpinLock</a> (ULONG *)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a13">NapReleaseSpinLock</a> (ULONG *)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d8/ntnap_8h.html#a7">NapNames</a> []</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ntnap.h::MAX_LONG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_LONG&nbsp;&nbsp;&nbsp;0x7FFFFFFFL          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00025">25</a> of file <a class="el" href="../../d9/d7/ntnap_8h-source.html">ntnap.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00378">NapClearData()</a>, and <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00061">NapDllInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ntnap.h::MAX_ULONG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_ULONG&nbsp;&nbsp;&nbsp;0xFFFFFFFFL          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00026">26</a> of file <a class="el" href="../../d9/d7/ntnap_8h-source.html">ntnap.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00378">NapClearData()</a>, and <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00061">NapDllInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ntnap.h::MIN_ACCEPTABLEOVERHEAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MIN_ACCEPTABLEOVERHEAD&nbsp;&nbsp;&nbsp;10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00033">33</a> of file <a class="el" href="../../d9/d7/ntnap_8h-source.html">ntnap.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ntnap.h::NAP_CALIBRATION_SERVICE_NUMBER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NAP_CALIBRATION_SERVICE_NUMBER&nbsp;&nbsp;&nbsp;-1L          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00034">34</a> of file <a class="el" href="../../d9/d7/ntnap_8h-source.html">ntnap.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ntnap.h::NUM_ITERATIONS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NUM_ITERATIONS&nbsp;&nbsp;&nbsp;2000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00032">32</a> of file <a class="el" href="../../d9/d7/ntnap_8h-source.html">ntnap.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00061">NapDllInit()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a5" doxytag="ntnap.h::NAPCONTROL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d1/struct__NAPCONTROL.html">_NAPCONTROL</a>  <a class="el" href="../../d4/d1/struct__NAPCONTROL.html">NAPCONTROL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ntnap.h::PNAPCONTROL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d1/struct__NAPCONTROL.html">_NAPCONTROL</a> * <a class="el" href="../../d4/d1/struct__NAPCONTROL.html">PNAPCONTROL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a11" doxytag="ntnap.h::NapCalibrate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID NapCalibrate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00061">NapDllInit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ntnap.h::NapCreateDataSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NapCreateDataSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d1/struct__NAPCONTROL.html">PNAPCONTROL</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00164">164</a> of file <a class="el" href="../../d8/d7/ntnap_8c-source.html">ntnap.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00134">NtCreateSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00061">NapDllInit()</a>.
<p>
<pre class="fragment"><div>00169                    :
00170 
00171     NapCreateData() is called to create the profiling data section.
00172     One section, named "\NapDataSection", is used for the whole system.
00173     It is accessible by anyone, so don't mess it up.
00174 
00175 Arguments:
00176 
00177     NapSectionPointer - a pointer to a pointer which will be set to
00178                         to point to the beginning of the section.
00179 
00180 Return Value:
00181 
00182     Status
00183 
00184 --*/
00185 
00186 
00187 {
00188     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00189     HANDLE NapSectionHandle;
00190     HANDLE MyProcess;
00191     STRING NapSectionName;
00192     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00193     LARGE_INTEGER AllocationSize;
00194     ULONG ViewSize;
00195     <a class="code" href="../../d4/d1/struct__NAPCONTROL.html">PNAPCONTROL</a> SectionPointer;
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">// Initialize object attributes for the dump file</span>
00199     <span class="comment">//</span>
00200 
00201     NapSectionName.Length = 15;
00202     NapSectionName.MaximumLength = 15;
00203     NapSectionName.Buffer = <span class="stringliteral">"\\NapDataSection"</span>;
00204 
00205     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Length = <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES);
00206     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.ObjectName = &amp;NapSectionName;
00207     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.RootDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00208     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00209     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.SecurityQualityOfService = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00210     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes = OBJ_OPENIF |
00211                                   OBJ_CASE_INSENSITIVE;
00212 
00213 
00214     AllocationSize.HighPart = 0;
00215     AllocationSize.LowPart = (NAP_API_COUNT + 1) * <span class="keyword">sizeof</span>(NAPDATA);
00216 
00217     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>(&amp;NapSectionHandle,
00218                              SECTION_MAP_READ |
00219                              SECTION_MAP_WRITE,
00220                              &amp;ObjectAttributes,
00221                              &amp;AllocationSize,
00222                              PAGE_READWRITE,
00223                              SEC_COMMIT,
00224                              NULL);
00225 
00226     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00227 
00228         MyProcess = NtCurrentProcess();
00229 
00230         ViewSize = AllocationSize.LowPart;
00231 
00232         SectionPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00233 
00234         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(NapSectionHandle,
00235                                     MyProcess,
00236                                     (PVOID *)&amp;SectionPointer,
00237                                     0,
00238                                     AllocationSize.LowPart,
00239                                     NULL,
00240                                     &amp;ViewSize,
00241                                     ViewUnmap,
00242                                     MEM_TOP_DOWN,
00243                                     PAGE_READWRITE);
00244 
00245         *NapSectionPointer = SectionPointer;
00246     }
00247 
00248     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00249 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ntnap.h::NapDllInit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID NapDllInit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00061">61</a> of file <a class="el" href="../../d8/d7/ntnap_8c-source.html">ntnap.c</a>.
<p>
References <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00043">_NAPCONTROL::Initialized</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00025">MAX_LONG</a>, <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00026">MAX_ULONG</a>, <a class="el" href="../../d8/d8/ntnap_8h.html#a11">NapCalibrate()</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00378">NapClearData()</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00048">NapControl</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00164">NapCreateDataSection()</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00042">NapFrequency</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00036">NapInitialized</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00057">NapProfilingData</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00851">NtQueryPerformanceCounter()</a>, <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00032">NUM_ITERATIONS</a>, <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00051">_NAPCONTROL::Paused</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00067                    :
00068 
00069     <a class="code" href="../../d8/d8/ntnap_8h.html#a8">NapDllInit</a>() is called before calling any profiling api.  It
00070     initializes profiling for the NT native API's.
00071 
00072     NOTE:  Initialization occurs only once and is controlled by
00073            the NapInitDone global flag.
00074 
00075 Arguments:
00076 
00077     None
00078 
00079 Return Value:
00080 
00081     None
00082 
00083 --*/
00084 
00085 {
00086     ULONG i;
00087     LARGE_INTEGER CurrentCounter;
00088 
00089     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d8/ntnap_8c.html#a0">NapInitialized</a>) {
00090 
00091         <span class="comment">//</span>
00092         <span class="comment">// Instance data for this process's ntdll.dll not yet initialized.</span>
00093         <span class="comment">//</span>
00094 
00095         <a class="code" href="../../d7/d8/ntnap_8c.html#a0">NapInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00096 
00097         <span class="comment">//</span>
00098         <span class="comment">// Get Counter frequency (current counter value is thrown away)</span>
00099         <span class="comment">// This call is not profiled because NapControl == NULL here.</span>
00100         <span class="comment">//</span>
00101 
00102         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;CurrentCounter,
00103                                   &amp;NapFrequency);
00104 
00105         <span class="comment">//</span>
00106         <span class="comment">// Allocate or open data section for api profiling data.</span>
00107         <span class="comment">//</span>
00108 
00109         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d8/ntnap_8h.html#a10">NapCreateDataSection</a>(&amp;NapControl))) {
00110 
00111             <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a> = (PNAPDATA)(<a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a> + 1);
00112 
00113             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o0">Initialized</a>) {
00114 
00115                 <span class="comment">//</span>
00116                 <span class="comment">// We are the first process to get here: we jsut</span>
00117                 <span class="comment">// allocated the section, so must initialize it.</span>
00118                 <span class="comment">//</span>
00119 
00120                 <a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o0">Initialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00121 
00122                 <a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o1">Paused</a> = 0;
00123 
00124                 <span class="comment">//</span>
00125                 <span class="comment">// Clear the data area used for calibration data.</span>
00126                 <span class="comment">//</span>
00127 
00128                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].NapLock = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00129                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].Calls = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00130                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].TimingErrors = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00131                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].TotalTime.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00132                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].TotalTime.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00133                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].FirstTime.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00134                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].FirstTime.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00135                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].MaxTime.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00136                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].MaxTime.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00137                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].MinTime.HighPart = <a class="code" href="../../d8/d8/ntnap_8h.html#a0">MAX_LONG</a>;
00138                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].MinTime.LowPart = <a class="code" href="../../d8/d8/ntnap_8h.html#a1">MAX_ULONG</a>;
00139 
00140                 <span class="comment">//</span>
00141                 <span class="comment">// Clear the rest of the data collection area</span>
00142                 <span class="comment">//</span>
00143 
00144                 <a class="code" href="../../d7/d8/ntnap_8c.html#a7">NapClearData</a>();
00145 
00146                 <span class="comment">//</span>
00147                 <span class="comment">//   Calibrate time overhead from profiling.  We care mostly</span>
00148                 <span class="comment">//   about the minimum time here, to avoid extra time from</span>
00149                 <span class="comment">//   interrupts etc.</span>
00150                 <span class="comment">//</span>
00151 
00152                 <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d8/ntnap_8h.html#a2">NUM_ITERATIONS</a>; i++) {
00153                     <a class="code" href="../../d8/d8/ntnap_8h.html#a11">NapCalibrate</a>();
00154                 }
00155             }
00156         }
00157     }
00158 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ntnap.h::NapRecordInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID NapRecordInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN&nbsp;</td>
          <td class="mdname" nowrap> <em>ULONG</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN&nbsp;</td>
          <td class="mdname" nowrap> <em>LARGE_INTEGER</em>[]</td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00255">255</a> of file <a class="el" href="../../d8/d7/ntnap_8c-source.html">ntnap.c</a>.
<p>
References <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00048">NapControl</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00057">NapProfilingData</a>, <a class="el" href="../../d8/d8/ntnap_8h.html#a13">NapReleaseSpinLock()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00051">_NAPCONTROL::Paused</a>.
<p>
<pre class="fragment"><div>00262                    :
00263 
00264     <a class="code" href="../../d8/d8/ntnap_8h.html#a9">NapRecordInfo</a>() is called after the API being measured has
00265     returned, and the value of the performance counter has been
00266     obtained.
00267 
00268     NOTE:  Initialization occurs only once and is controlled by
00269            the NapInitDone global flag.
00270 
00271 Arguments:
00272 
00273     ServiceNumber - the number of the service being measured.
00274                     -1 is reserved for calibration.
00275 
00276     Counters      - a pointer to the value of the counter after the call
00277                     to the measured routine.  Followed immediately
00278                     in memory by the value of the counter before the
00279                     call to the measured routine.
00280 
00281 Return Value:
00282 
00283     None
00284 
00285 --*/
00286 
00287 
00288 {
00289     LARGE_INTEGER ElapsedTime;
00290     LARGE_INTEGER Difference;
00291 
00292 
00293     <span class="comment">//</span>
00294     <span class="comment">// First make sure we have been initialized</span>
00295     <span class="comment">//</span>
00296 
00297     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00298 
00299         <span class="comment">//</span>
00300         <span class="comment">// Check to be sure profiling is not paused</span>
00301 
00302         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o1">Paused</a> == 0) {
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">// Since ServiceNumber -1 is used for calibration, bump same</span>
00306             <span class="comment">// so indexes start at 0.</span>
00307             <span class="comment">//</span>
00308 
00309             ServiceNumber++;
00310 
00311             <span class="comment">//</span>
00312             <span class="comment">// Prevent others from changing data at the same time</span>
00313             <span class="comment">// we are.</span>
00314             <span class="comment">//</span>
00315 
00316             NapAcquireSpinLock(&amp;(NapProfilingData[ServiceNumber].NapLock));
00317 
00318             <span class="comment">//</span>
00319             <span class="comment">// Record API info</span>
00320             <span class="comment">//</span>
00321 
00322             <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].Calls++;
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">// Elapsed time is end time minus start time</span>
00326             <span class="comment">//</span>
00327 
00328             ElapsedTime =
00329                 RtlLargeIntegerSubtract(Counters[0],Counters[1]);
00330 
00331             <span class="comment">//</span>
00332             <span class="comment">// Now add elapsed time to total time</span>
00333             <span class="comment">//</span>
00334 
00335             <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].TotalTime =
00336                 RtlLargeIntegerAdd(NapProfilingData[ServiceNumber].TotalTime,
00337                                    ElapsedTime);
00338 
00339             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].Calls == 1) {
00340                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].FirstTime = ElapsedTime;
00341             }
00342             <span class="keywordflow">else</span> {
00343                 Difference =
00344                     RtlLargeIntegerSubtract(
00345                         NapProfilingData[ServiceNumber].MaxTime,
00346                         ElapsedTime);
00347                 <span class="keywordflow">if</span> (Difference.HighPart &lt; 0) {
00348 
00349                     <span class="comment">//</span>
00350                     <span class="comment">// A new maximum was attained</span>
00351                     <span class="comment">//</span>
00352 
00353                     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].MaxTime = ElapsedTime;
00354 
00355                 }
00356                 Difference =
00357                     RtlLargeIntegerSubtract(
00358                         ElapsedTime,
00359                         NapProfilingData[ServiceNumber].MinTime);
00360                 <span class="keywordflow">if</span> (Difference.HighPart &lt; 0) {
00361 
00362                     <span class="comment">//</span>
00363                     <span class="comment">// A new minimum was attained</span>
00364                     <span class="comment">//</span>
00365 
00366                     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].MinTime = ElapsedTime;
00367                 }
00368             }
00369 
00370             <a class="code" href="../../d8/d8/ntnap_8h.html#a13">NapReleaseSpinLock</a>(&amp;(NapProfilingData[ServiceNumber].NapLock));
00371         }
00372     }
00373 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ntnap.h::NapReleaseSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID NapReleaseSpinLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00378">NapClearData()</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00255">NapRecordInfo()</a>, and <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00442">NapRetrieveData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ntnap.h::NapSpinOnSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID NapSpinOnSpinLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a7" doxytag="ntnap.h::NapNames" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PCHAR <a class="el" href="../../d8/d8/ntnap_8h.html#a7">NapNames</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/ntnap_8h-source.html#l00057">57</a> of file <a class="el" href="../../d9/d7/ntnap_8h-source.html">ntnap.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00442">NapRetrieveData()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:53 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
