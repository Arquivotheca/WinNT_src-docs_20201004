<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: qsfs.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>qsfs.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>
<code>#include &lt;ioevent.h&gt;</code><br>

<p>
<a href="../../d9/d1/qsfs_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/qsfs_8c.html#a0">NtQueryVolumeInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, OUT PVOID FsInformation, IN ULONG Length, IN FS_INFORMATION_CLASS FsInformationClass)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/qsfs_8c.html#a1">NtSetVolumeInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PVOID FsInformation, IN ULONG Length, IN FS_INFORMATION_CLASS FsInformationClass)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="qsfs.c::NtQueryVolumeInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryVolumeInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FS_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>FsInformationClass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">37</a> of file <a class="el" href="../../d9/d1/qsfs_8c-source.html">qsfs.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01185">_DEVICE_OBJECT::Characteristics</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01188">_DEVICE_OBJECT::DeviceType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01501">FO_DIRECT_DEVICE_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02414">IopGetMountFlag()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00659">IopQueryFsOperationAccess</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00613">IopQueryFsOperationLength</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00705">IopQuerySetFsAlignmentRequirement</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01564">IRP_DEFER_IO_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00065">IRP_MJ_QUERY_VOLUME_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/curdir_8c-source.html#l00225">RtlSetCurrentDirectory_U()</a>.
<p>
<pre class="fragment"><div>00047                    :
00048 
00049     This service returns information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00050     FileHandle parameter.  The information returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> defined
00051     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FsInformationClass parameter.  The legal values <span class="keywordflow">for</span> <span class="keyword">this</span> parameter
00052     are as follows:
00053 
00054         o  FileFsVolumeInformation
00055 
00056         o  FileFsSizeInformation
00057 
00058         o  FileFsDeviceInformation
00059 
00060         o  FileFsAttributeInformation
00061 
00062 Arguments:
00063 
00064     FileHandle - Supplies a handle to an open volume, directory, or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00065         <span class="keywordflow">for</span> which information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00066 
00067     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00068 
00069     FsInformation - Supplies a buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information
00070         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00071 
00072     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FsInformation buffer.
00073 
00074     FsInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information which should be
00075         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00076 
00077 Return Value:
00078 
00079     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00080 
00081 --*/
00082 
00083 {
00084     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00085     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00086     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00087     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00088     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00089     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00090     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00091     IO_STATUS_BLOCK localIoStatus;
00092     BOOLEAN synchronousIo;
00093 
00094     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00095 
00096 
00097     <span class="comment">//</span>
00098     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00099     <span class="comment">//</span>
00100 
00101     requestorMode = KeGetPreviousMode();
00102 
00103     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00104 
00105         <span class="comment">//</span>
00106         <span class="comment">// Ensure that the FsInformationClass parameter is legal for querying</span>
00107         <span class="comment">// information about the volume.</span>
00108         <span class="comment">//</span>
00109 
00110         <span class="keywordflow">if</span> ((ULONG) FsInformationClass &gt;= FileFsMaximumInformation ||
00111             <a class="code" href="../../d3/d5/iodata_8c.html#a68">IopQueryFsOperationLength</a>[FsInformationClass] == 0) {
00112             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00113         }
00114 
00115         <span class="comment">//</span>
00116         <span class="comment">// Finally, ensure that the supplied buffer is large enough to contain</span>
00117         <span class="comment">// the information associated with the specified query operation that</span>
00118         <span class="comment">// is to be performed.</span>
00119         <span class="comment">//</span>
00120 
00121         <span class="keywordflow">if</span> (Length &lt; (ULONG) <a class="code" href="../../d3/d5/iodata_8c.html#a68">IopQueryFsOperationLength</a>[FsInformationClass]) {
00122             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00123         }
00124 
00125         <span class="comment">//</span>
00126         <span class="comment">// The caller's access mode is not kernel so probe each of the arguments</span>
00127         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00128         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00129         <span class="comment">// return an access violation status code back to the system service</span>
00130         <span class="comment">// dispatcher.</span>
00131         <span class="comment">//</span>
00132 
00133         <span class="keywordflow">try</span> {
00134 
00135             <span class="comment">//</span>
00136             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00137             <span class="comment">//</span>
00138 
00139             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00140 
00141             <span class="comment">//</span>
00142             <span class="comment">// The FsInformation buffer must be writeable by the caller.</span>
00143             <span class="comment">//</span>
00144 
00145 <span class="preprocessor">#if defined(_X86_)</span>
00146 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FsInformation, Length, <span class="keyword">sizeof</span>( ULONG ) );
00147 <span class="preprocessor">#elif defined(_WIN64)</span>
00148 <span class="preprocessor"></span>
00149             <span class="comment">//</span>
00150             <span class="comment">// If we are a wow64 process, follow the X86 rules</span>
00151             <span class="comment">//</span>
00152 
00153             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process) {
00154                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FsInformation, Length, <span class="keyword">sizeof</span>( ULONG ) );
00155             } <span class="keywordflow">else</span> {
00156                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FsInformation,
00157                                Length,
00158                                IopQuerySetFsAlignmentRequirement[FsInformationClass] );
00159 
00160             }
00161 <span class="preprocessor">#else</span>
00162 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FsInformation,
00163                            Length,
00164                            IopQuerySetFsAlignmentRequirement[FsInformationClass] );
00165 <span class="preprocessor">#endif</span>
00166 <span class="preprocessor"></span>
00167         } except(EXCEPTION_EXECUTE_HANDLER) {
00168 
00169             <span class="comment">//</span>
00170             <span class="comment">// An exception was incurred probing the caller's parameters.</span>
00171             <span class="comment">// Simply return an appropriate error status code.</span>
00172             <span class="comment">//</span>
00173 
00174 <span class="preprocessor">#if DBG</span>
00175 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (GetExceptionCode() == STATUS_DATATYPE_MISALIGNMENT) {
00176                 DbgBreakPoint();
00177             }
00178 <span class="preprocessor">#endif // DBG</span>
00179 <span class="preprocessor"></span>
00180             <span class="keywordflow">return</span> GetExceptionCode();
00181 
00182         }
00183     }
00184 
00185     <span class="comment">//</span>
00186     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00187     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00188     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00189     <span class="comment">// access to the file, then it will fail.</span>
00190     <span class="comment">//</span>
00191 
00192     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00193                                         IopQueryFsOperationAccess[FsInformationClass],
00194                                         IoFileObjectType,
00195                                         requestorMode,
00196                                         (PVOID *) &amp;fileObject,
00197                                         NULL );
00198     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00199         <span class="keywordflow">return</span> status;
00200     }
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// If this open file object represents an open device that was explicitly</span>
00204     <span class="comment">// opened for querying the device's attributes, then ensure that the type</span>
00205     <span class="comment">// of information class was device information.</span>
00206     <span class="comment">//</span>
00207 
00208     <span class="keywordflow">if</span> ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>) &amp;&amp;
00209         FsInformationClass != FileFsDeviceInformation) {
00210         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00211         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
00212     }
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
00216     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
00217     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
00218     <span class="comment">// operation, then allocate and initialize the local event.</span>
00219     <span class="comment">//</span>
00220 
00221     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00222 
00223         BOOLEAN interrupted;
00224 
00225         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00226             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00227                                                requestorMode,
00228                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
00229                                                &amp;interrupted );
00230             <span class="keywordflow">if</span> (interrupted) {
00231                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00232                 <span class="keywordflow">return</span> status;
00233             }
00234         }
00235         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00236     } <span class="keywordflow">else</span> {
00237         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00238     }
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// Get the address of the target device object.  A special check is made</span>
00242     <span class="comment">// here to determine whether this query is for device information.  If</span>
00243     <span class="comment">// it is, and either:</span>
00244     <span class="comment">//</span>
00245     <span class="comment">//     a)  The open was for the device itself, or</span>
00246     <span class="comment">//</span>
00247     <span class="comment">//     b)  The open was for a file but this is not a redirected device,</span>
00248     <span class="comment">//</span>
00249     <span class="comment">// then perform the query operation in-line.  That is, do not allocate</span>
00250     <span class="comment">// an IRP and call the driver, rather, simply copy the device type and</span>
00251     <span class="comment">// characteristics information from the target device object pointed</span>
00252     <span class="comment">// to by the device object in the file object (the "real" device object</span>
00253     <span class="comment">// in a mass storage device stack).</span>
00254     <span class="comment">//</span>
00255 
00256     <span class="keywordflow">if</span> (FsInformationClass == FileFsDeviceInformation &amp;&amp;
00257         (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a> ||
00258         fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_NETWORK_FILE_SYSTEM)) {
00259 
00260         PFILE_FS_DEVICE_INFORMATION deviceAttributes;
00261         BOOLEAN deviceMounted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">// This query operation can be performed in-line.  Simply copy the</span>
00265         <span class="comment">// information directly from the target device object and indicate</span>
00266         <span class="comment">// that the operation was successful.  Begin, however, by determining</span>
00267         <span class="comment">// whether or not the device is mounted.  This cannot be done at the</span>
00268         <span class="comment">// same time as attempting to touch the user's buffer, as looking at</span>
00269         <span class="comment">// the mounted bit occurs at raised IRQL.</span>
00270         <span class="comment">//</span>
00271 
00272         deviceObject = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
00273         <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a>) {
00274             deviceMounted = <a class="code" href="../../d0/d6/iop_8h.html#a178">IopGetMountFlag</a>( deviceObject );
00275         }
00276 
00277         <span class="comment">//</span>
00278         <span class="comment">// Copy the characteristics information from the device's object</span>
00279         <span class="comment">// into the caller's buffer.</span>
00280         <span class="comment">//</span>
00281 
00282         deviceAttributes = (PFILE_FS_DEVICE_INFORMATION) FsInformation;
00283 
00284         <span class="keywordflow">try</span> {
00285 
00286             deviceAttributes-&gt;DeviceType = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a>;
00287             deviceAttributes-&gt;Characteristics = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o9">Characteristics</a>;
00288             <span class="keywordflow">if</span> (deviceMounted) {
00289                 deviceAttributes-&gt;Characteristics |= FILE_DEVICE_IS_MOUNTED;
00290             }
00291 
00292             IoStatusBlock-&gt;Status = STATUS_SUCCESS;
00293             IoStatusBlock-&gt;Information = <span class="keyword">sizeof</span>( FILE_FS_DEVICE_INFORMATION );
00294             status = STATUS_SUCCESS;
00295 
00296         } except( EXCEPTION_EXECUTE_HANDLER ) {
00297 
00298             <span class="comment">//</span>
00299             <span class="comment">// An error occurred attempting to write into one of the caller's</span>
00300             <span class="comment">// buffers.  Simply indicate that the error occurred, and fall</span>
00301             <span class="comment">// through.</span>
00302             <span class="comment">//</span>
00303 
00304             status = GetExceptionCode();
00305         }
00306 
00307         <span class="comment">//</span>
00308         <span class="comment">// If this operation was performed as synchronous I/O, then release</span>
00309         <span class="comment">// the file object lock.</span>
00310         <span class="comment">//</span>
00311 
00312         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00313             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
00314         }
00315 
00316         <span class="comment">//</span>
00317         <span class="comment">// Now simply cleanup and return the final status of the operation.</span>
00318         <span class="comment">//</span>
00319 
00320         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00321         <span class="keywordflow">return</span> status;
00322 
00323     }
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// This is either a query that is not for device characteristics</span>
00327     <span class="comment">// information, or it is a query for device information, but it is</span>
00328     <span class="comment">// a query for a redirected device.  Take the long route and actually</span>
00329     <span class="comment">// invoke the driver for the target device to get the information.</span>
00330     <span class="comment">//</span>
00331     <span class="comment">// Set the file object to the Not-Signaled state.</span>
00332     <span class="comment">//</span>
00333 
00334     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Get a pointer to the device object for the target device.</span>
00338     <span class="comment">//</span>
00339 
00340     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00341 
00342     <span class="comment">//</span>
00343     <span class="comment">// If this I/O operation is not being performed as synchronous I/O,</span>
00344     <span class="comment">// then allocate an event that will be used to synchronize the</span>
00345     <span class="comment">// completion of this operation.  That is, this system service is</span>
00346     <span class="comment">// a synchronous API being invoked for a file that is opened for</span>
00347     <span class="comment">// asynchronous I/O.</span>
00348     <span class="comment">//</span>
00349 
00350     <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
00351         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
00352         <span class="keywordflow">if</span> (event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00353             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00354             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00355         }
00356         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, FALSE );
00357     }
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this</span>
00361     <span class="comment">// operation.  The allocation is performed with an exception handler</span>
00362     <span class="comment">// in case the caller does not have enough quota to allocate the packet.</span>
00363 
00364     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
00365     <span class="keywordflow">if</span> (!irp) {
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// An IRP could not be allocated.  Cleanup and return an</span>
00369         <span class="comment">// appropriate error status code.</span>
00370         <span class="comment">//</span>
00371 
00372         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
00373             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
00374         }
00375 
00376         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
00377 
00378         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00379     }
00380     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00381     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00382     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> (synchronousIo) {
00389         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00390         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
00391     } <span class="keywordflow">else</span> {
00392         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
00393         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00394         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00395     }
00396     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00397 
00398     <span class="comment">//</span>
00399     <span class="comment">// Get a pointer to the stack location for the first driver.  This will</span>
00400     <span class="comment">// be used to pass the original function codes and parameters.</span>
00401     <span class="comment">//</span>
00402 
00403     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00404     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a23">IRP_MJ_QUERY_VOLUME_INFORMATION</a>;
00405     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00406 
00407     <span class="comment">//</span>
00408     <span class="comment">// Allocate a buffer which should be used to put the information into</span>
00409     <span class="comment">// by the driver.  This will be copied back to the caller's buffer when</span>
00410     <span class="comment">// the service completes.  This is done by setting the flag which says</span>
00411     <span class="comment">// that this is an input operation.</span>
00412     <span class="comment">//</span>
00413 
00414     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = FsInformation;
00415     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00416     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00417 
00418     <span class="comment">//</span>
00419     <span class="comment">// Allocate the system buffer using an exception handler in case the</span>
00420     <span class="comment">// caller doesn't have enough quota remaining.</span>
00421     <span class="comment">//</span>
00422 
00423     <span class="keywordflow">try</span> {
00424 
00425         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool,
00426                                                                    Length );
00427     } except(EXCEPTION_EXECUTE_HANDLER) {
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">// An exception was incurred attempting to allocate the inter-</span>
00431         <span class="comment">// mediary buffer.  Cleanup and return with an appropriate error</span>
00432         <span class="comment">// status code.</span>
00433         <span class="comment">//</span>
00434 
00435         <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00436                              irp,
00437                              (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
00438                              event );
00439 
00440         <span class="keywordflow">return</span> GetExceptionCode();
00441 
00442     }
00443 
00444     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= (ULONG) (<a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> |
00445                            <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a> |
00446                            <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a> |
00447                            <a class="code" href="../../d0/d5/io_8h.html#a186">IRP_DEFER_IO_COMPLETION</a>);
00448 
00449     <span class="comment">//</span>
00450     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
00451     <span class="comment">// IRP.</span>
00452     <span class="comment">//</span>
00453 
00454     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryVolume.Length = Length;
00455     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryVolume.FsInformationClass = FsInformationClass;
00456 
00457     <span class="comment">//</span>
00458     <span class="comment">// Queue the packet, call the driver, and synchronize appopriately with</span>
00459     <span class="comment">// I/O completion.</span>
00460     <span class="comment">//</span>
00461 
00462     status = <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
00463                                         irp,
00464                                         fileObject,
00465                                         TRUE,
00466                                         requestorMode,
00467                                         synchronousIo,
00468                                         OtherTransfer );
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">// If the file for this operation was not opened for synchronous I/O, then</span>
00472     <span class="comment">// synchronization of completion of the I/O operation has not yet occurred</span>
00473     <span class="comment">// since the allocated event must be used for synchronous APIs on files</span>
00474     <span class="comment">// opened for asynchronous I/O.  Synchronize the completion of the I/O</span>
00475     <span class="comment">// operation now.</span>
00476     <span class="comment">//</span>
00477 
00478     <span class="keywordflow">if</span> (!synchronousIo) {
00479 
00480         status = <a class="code" href="../../d0/d6/iop_8h.html#a211">IopSynchronousApiServiceTail</a>( status,
00481                                                event,
00482                                                irp,
00483                                                requestorMode,
00484                                                &amp;localIoStatus,
00485                                                IoStatusBlock );
00486     }
00487 
00488     <span class="keywordflow">return</span> status;
00489 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="qsfs.c::NtSetVolumeInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetVolumeInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FS_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>FsInformationClass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">492</a> of file <a class="el" href="../../d9/d1/qsfs_8c-source.html">qsfs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l01005">_TARGET_DEVICE_CUSTOM_NOTIFICATION::Event</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l01009">_TARGET_DEVICE_CUSTOM_NOTIFICATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08120">IoGetRelatedTargetDevice()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00705">IopQuerySetFsAlignmentRequirement</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00682">IopSetFsOperationAccess</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00636">IopSetFsOperationLength</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06017">IoReportTargetDeviceChange()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00066">IRP_MJ_SET_VOLUME_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l01016">_TARGET_DEVICE_CUSTOM_NOTIFICATION::NameBufferOffset</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l01004">_TARGET_DEVICE_CUSTOM_NOTIFICATION::Size</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d7/d8/pnp_8h-source.html#l01003">_TARGET_DEVICE_CUSTOM_NOTIFICATION::Version</a>.
<p>
<pre class="fragment"><div>00502                    :
00503 
00504     This service changes information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <span class="stringliteral">"mounted"</span> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
00505     specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileHandle parameter.  The information to be changed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00506     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FsInformation buffer.  Its contents are defined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FsInformation-
00507     Class parameter, whose values may be as follows:
00508 
00509         o  FileFsLabelInformation
00510 
00511 Arguments:
00512 
00513     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume whose information should be
00514         changed.
00515 
00516     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00517 
00518     FsInformation - Supplies a buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information which should
00519         be changed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00520 
00521     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FsInformation buffer.
00522 
00523     FsInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information which should be
00524         changed about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00525 
00526 Return Value:
00527 
00528     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00529     block.
00530 
00531 --*/
00532 
00533 {
00534     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00535     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00536     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00537     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00538     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00539     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00540     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00541     IO_STATUS_BLOCK localIoStatus;
00542     PFILE_FS_LABEL_INFORMATION labelInformation;
00543     BOOLEAN synchronousIo;
00544     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetDeviceObject;
00545 
00546     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00547 
00548     <span class="comment">//</span>
00549     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00550     <span class="comment">//</span>
00551 
00552     requestorMode = KeGetPreviousMode();
00553 
00554     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00555 
00556         <span class="comment">//</span>
00557         <span class="comment">// Ensure that the FsInformationClass parameter is legal for setting</span>
00558         <span class="comment">// information about the volume.</span>
00559         <span class="comment">//</span>
00560 
00561         <span class="keywordflow">if</span> ((ULONG) FsInformationClass &gt;= FileFsMaximumInformation ||
00562             <a class="code" href="../../d3/d5/iodata_8c.html#a69">IopSetFsOperationLength</a>[FsInformationClass] == 0) {
00563             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00564         }
00565 
00566         <span class="comment">//</span>
00567         <span class="comment">// Finally, ensure that the supplied buffer is large enough to contain</span>
00568         <span class="comment">// the information associated with the specified set operation that is</span>
00569         <span class="comment">// to be performed.</span>
00570         <span class="comment">//</span>
00571 
00572         <span class="keywordflow">if</span> (Length &lt; (ULONG) <a class="code" href="../../d3/d5/iodata_8c.html#a69">IopSetFsOperationLength</a>[FsInformationClass]) {
00573             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00574         }
00575 
00576         <span class="comment">//</span>
00577         <span class="comment">// The caller's access mode is user, so probe each of the arguments</span>
00578         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00579         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00580         <span class="comment">// return an access violation status code back to the system service</span>
00581         <span class="comment">// dispatcher.</span>
00582         <span class="comment">//</span>
00583 
00584         <span class="keywordflow">try</span> {
00585 
00586             <span class="comment">//</span>
00587             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00588             <span class="comment">//</span>
00589 
00590             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00591 
00592             <span class="comment">//</span>
00593             <span class="comment">// The FsInformation buffer must be readable by the caller.</span>
00594             <span class="comment">//</span>
00595 
00596 <span class="preprocessor">#if defined(_X86_)</span>
00597 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( FsInformation, Length, <span class="keyword">sizeof</span>( ULONG ) );
00598 <span class="preprocessor">#elif defined(_IA64_)</span>
00599 <span class="preprocessor"></span>            <span class="comment">// If we are a wow64 process, follow the X86 rules</span>
00600             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process) {
00601                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( FsInformation, Length, <span class="keyword">sizeof</span>( ULONG ) );
00602             }
00603             <span class="keywordflow">else</span> {
00604                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( FsInformation,
00605                               Length,
00606                               IopQuerySetFsAlignmentRequirement[FsInformationClass] );
00607 
00608             }
00609 <span class="preprocessor">#else</span>
00610 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( FsInformation,
00611                           Length,
00612                           IopQuerySetFsAlignmentRequirement[FsInformationClass] );
00613 <span class="preprocessor">#endif</span>
00614 <span class="preprocessor"></span>
00615         } except(EXCEPTION_EXECUTE_HANDLER) {
00616 
00617             <span class="comment">//</span>
00618             <span class="comment">// An exception was incurred probing the caller's parameters.</span>
00619             <span class="comment">// Simply return an appropriate error status code.</span>
00620             <span class="comment">//</span>
00621 
00622 
00623 <span class="preprocessor">#if DBG</span>
00624 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (GetExceptionCode() == STATUS_DATATYPE_MISALIGNMENT) {
00625                 DbgBreakPoint();
00626             }
00627 <span class="preprocessor">#endif DBG</span>
00628 <span class="preprocessor"></span>
00629             <span class="keywordflow">return</span> GetExceptionCode();
00630 
00631         }
00632     }
00633 
00634     <span class="comment">//</span>
00635     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00636     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00637     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00638     <span class="comment">// access to the file, then it will fail.</span>
00639     <span class="comment">//</span>
00640 
00641     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00642                                         IopSetFsOperationAccess[FsInformationClass],
00643                                         IoFileObjectType,
00644                                         requestorMode,
00645                                         (PVOID *) &amp;fileObject,
00646                                         NULL );
00647     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00648         <span class="keywordflow">return</span> status;
00649     }
00650 
00651     <span class="comment">//</span>
00652     <span class="comment">// Retrieve the device object associated with this file handle.</span>
00653     <span class="comment">//</span>
00654     
00655     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a108">IoGetRelatedTargetDevice</a>( fileObject, &amp;targetDeviceObject );
00656 
00657     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00658         <span class="comment">//</span>
00659         <span class="comment">// The PDO associated with the devnode we got back from</span>
00660         <span class="comment">// IoGetRelatedTargetDevice has already been referenced by that</span>
00661         <span class="comment">// routine.  Store this reference away in the notification entry,</span>
00662         <span class="comment">// so we can deref it later when the notification entry is unregistered.</span>
00663         <span class="comment">//</span>
00664     
00665         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(targetDeviceObject);
00666     
00667     } <span class="keywordflow">else</span> {
00668         targetDeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00669     }
00670 
00671 
00672     <span class="comment">//</span>
00673     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
00674     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
00675     <span class="comment">// the current thread.  if this is not a (serialized) synchronous I/O</span>
00676     <span class="comment">// operation, then allocate and initialize the local event.</span>
00677     <span class="comment">//</span>
00678 
00679     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00680 
00681         BOOLEAN interrupted;
00682 
00683         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00684             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00685                                                requestorMode,
00686                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
00687                                                &amp;interrupted );
00688             <span class="keywordflow">if</span> (interrupted) {
00689                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00690                 <span class="keywordflow">if</span> (targetDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00691                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( targetDeviceObject );
00692                 }
00693                 <span class="keywordflow">return</span> status;
00694             }
00695         }
00696         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00697     } <span class="keywordflow">else</span> {
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// This is a synchronous API being invoked for a file that is opened</span>
00701         <span class="comment">// for asynchronous I/O.  This means that this system service is</span>
00702         <span class="comment">// to synchronize the completion of the operation before returning</span>
00703         <span class="comment">// to the caller.  A local event is used to do this.</span>
00704         <span class="comment">//</span>
00705 
00706         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
00707         <span class="keywordflow">if</span> (event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00708             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00709             <span class="keywordflow">if</span> (targetDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00710                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( targetDeviceObject );
00711             }
00712             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00713         }
00714         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, FALSE );
00715         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00716     }
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Set the file object to the Not-Signaled state.</span>
00720     <span class="comment">//</span>
00721 
00722     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
00723 
00724     <span class="comment">//</span>
00725     <span class="comment">// Get the address of the target device object.</span>
00726     <span class="comment">//</span>
00727 
00728     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00729 
00730     <span class="comment">//</span>
00731     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00732     <span class="comment">// The allocation is performed with an exception handler in case the</span>
00733     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
00734 
00735     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
00736     <span class="keywordflow">if</span> (!irp) {
00737 
00738         <span class="comment">//</span>
00739         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
00740         <span class="comment">// error status code.</span>
00741         <span class="comment">//</span>
00742 
00743         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
00744             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
00745         }
00746 
00747         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
00748 
00749         <span class="keywordflow">if</span> (targetDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00750             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( targetDeviceObject );
00751         }
00752         
00753         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00754     }
00755     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00756     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00757     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
00758 
00759     <span class="comment">//</span>
00760     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00761     <span class="comment">//</span>
00762 
00763     <span class="keywordflow">if</span> (synchronousIo) {
00764         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00765         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
00766     } <span class="keywordflow">else</span> {
00767         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
00768         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00769         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00770     }
00771     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00772 
00773     <span class="comment">//</span>
00774     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
00775     <span class="comment">// used to pass the original function codes and parameters.</span>
00776     <span class="comment">//</span>
00777 
00778     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00779     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a24">IRP_MJ_SET_VOLUME_INFORMATION</a>;
00780     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00781 
00782     <span class="comment">//</span>
00783     <span class="comment">// Allocate a buffer and copy the information that is to be set on the</span>
00784     <span class="comment">// file into it.  Also, set the flags so that the completion code will</span>
00785     <span class="comment">// properly handle getting rid of the buffer and will not attempt to</span>
00786     <span class="comment">// copy data.</span>
00787     <span class="comment">//</span>
00788 
00789     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00790     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00791 
00792     <span class="keywordflow">try</span> {
00793 
00794         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool,
00795                                                                    Length );
00796         RtlCopyMemory( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer, FsInformation, Length );
00797 
00798     } except(EXCEPTION_EXECUTE_HANDLER) {
00799 
00800         <span class="comment">//</span>
00801         <span class="comment">// An exception was incurred attempting to allocate the intermediary</span>
00802         <span class="comment">// buffer or while copying the caller's data to the buffer. Determine</span>
00803         <span class="comment">// what happened, cleanup, and return an appropriate error status</span>
00804         <span class="comment">// code.</span>
00805         <span class="comment">//</span>
00806 
00807         <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00808                              irp,
00809                              (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
00810                              event );
00811 
00812         <span class="keywordflow">if</span> (targetDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00813             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( targetDeviceObject );
00814         }
00815         
00816         <span class="keywordflow">return</span> GetExceptionCode();
00817 
00818     }
00819 
00820     <span class="comment">//</span>
00821     <span class="comment">// If the previous mode was not kernel, check the captured label buffer</span>
00822     <span class="comment">// for consistency.</span>
00823     <span class="comment">//</span>
00824 
00825     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> &amp;&amp;
00826         FsInformationClass == FileFsLabelInformation) {
00827 
00828         <span class="comment">//</span>
00829         <span class="comment">// The previous mode was something other than kernel.  Check to see</span>
00830         <span class="comment">// whether or not the length of the label specified within the label</span>
00831         <span class="comment">// structure is consistent with the overall length of the structure</span>
00832         <span class="comment">// itself.  If not, then cleanup and get out.</span>
00833         <span class="comment">//</span>
00834 
00835         labelInformation = (PFILE_FS_LABEL_INFORMATION) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00836 
00837         <span class="keywordflow">if</span> ((LONG) labelInformation-&gt;VolumeLabelLength &lt; 0 ||
00838             labelInformation-&gt;VolumeLabelLength +
00839             FIELD_OFFSET( FILE_FS_LABEL_INFORMATION, VolumeLabel ) &gt; Length) {
00840 
00841             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00842                                  irp,
00843                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
00844                                  event );
00845 
00846             <span class="keywordflow">if</span> (targetDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00847                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( targetDeviceObject );
00848             }
00849             
00850             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00851         }
00852     }
00853 
00854     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= (ULONG) (<a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>);
00855 
00856     <span class="comment">//</span>
00857     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
00858     <span class="comment">// IRP.</span>
00859     <span class="comment">//</span>
00860 
00861     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetVolume.Length = Length;
00862     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetVolume.FsInformationClass = FsInformationClass;
00863 
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">// Queue the packet, call the driver, and synchronize appopriately with</span>
00867     <span class="comment">// I/O completion.</span>
00868     <span class="comment">//</span>
00869 
00870     status = <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
00871                                         irp,
00872                                         fileObject,
00873                                         FALSE,
00874                                         requestorMode,
00875                                         synchronousIo,
00876                                         OtherTransfer );
00877 
00878     <span class="comment">//</span>
00879     <span class="comment">// If the file for this operation was not opened for synchronous I/O, then</span>
00880     <span class="comment">// synchronization of completion of the I/O operation has not yet occurred</span>
00881     <span class="comment">// since the allocated event must be used for synchronous APIs on files</span>
00882     <span class="comment">// opened for asynchronous I/O.  Synchronize the completion of the I/O</span>
00883     <span class="comment">// operation now.</span>
00884     <span class="comment">//</span>
00885 
00886     <span class="keywordflow">if</span> (!synchronousIo) {
00887 
00888         status = <a class="code" href="../../d0/d6/iop_8h.html#a211">IopSynchronousApiServiceTail</a>( status,
00889                                                event,
00890                                                irp,
00891                                                requestorMode,
00892                                                &amp;localIoStatus,
00893                                                IoStatusBlock );
00894     }
00895 
00896     <span class="comment">//</span>
00897     <span class="comment">//  Notify anyone who cares about the label change</span>
00898     <span class="comment">//</span>
00899 
00900     <span class="keywordflow">if</span> (targetDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00901         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00902             <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a> ChangeEvent;
00903     
00904             ChangeEvent.<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o0">Version</a> = 1;
00905             ChangeEvent.<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o3">FileObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00906             ChangeEvent.<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o4">NameBufferOffset</a> = -1;
00907             ChangeEvent.<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o1">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)FIELD_OFFSET( <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a>, CustomDataBuffer );
00908             
00909             RtlCopyMemory( &amp;ChangeEvent.<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o2">Event</a>, &amp;GUID_IO_VOLUME_CHANGE, <span class="keyword">sizeof</span>( GUID_IO_VOLUME_CHANGE ));
00910             
00911             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a98">IoReportTargetDeviceChange</a>( targetDeviceObject, &amp;ChangeEvent );
00912         }
00913 
00914         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( targetDeviceObject );
00915     }
00916 
00917     <span class="keywordflow">return</span> status;
00918 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
