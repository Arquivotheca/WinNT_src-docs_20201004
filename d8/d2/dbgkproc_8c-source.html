<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dbgkproc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dbgkproc.c</h1><a href="../../d7/d3/dbgkproc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dbgkproc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements process control primitives for the</span>
00012 <span class="comment">    Dbg component of NT</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Mark Lucovsky (markl) 19-Jan-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d5/d3/dbgkp_8h.html">dbgkp.h</a>"</span>
00023 
00024 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkpSuspendProcess)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkpResumeProcess)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkpSectionHandleToFileHandle)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkCreateThread)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkExitThread)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkExitProcess)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkMapViewOfSection)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkUnMapViewOfSection)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00036"></a><a class="code" href="../../d7/d3/dbgkproc_8c.html#a0">00036</a> <a class="code" href="../../d7/d3/dbgkproc_8c.html#a0">DbgkpSuspendProcess</a>(
00037     IN BOOLEAN CreateDeleteLockHeld
00038     )
00039 
00040 <span class="comment">/*++</span>
00041 <span class="comment"></span>
00042 <span class="comment">Routine Description:</span>
00043 <span class="comment"></span>
00044 <span class="comment">    This function causes all threads in the calling process except for</span>
00045 <span class="comment">    the calling thread to suspend.</span>
00046 <span class="comment"></span>
00047 <span class="comment">Arguments:</span>
00048 <span class="comment"></span>
00049 <span class="comment">    CreateDeleteLockHeld - Supplies a flag that specifies whether or not</span>
00050 <span class="comment">        the caller is holding the process create delete lock.  If the</span>
00051 <span class="comment">        caller holds the lock, than this function will not aquire the</span>
00052 <span class="comment">        lock before suspending the process.</span>
00053 <span class="comment"></span>
00054 <span class="comment">Return Value:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    None.</span>
00057 <span class="comment"></span>
00058 <span class="comment">--*/</span>
00059 
00060 {
00061     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00062 
00063     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00064 
00065     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00066 
00067     <span class="comment">//</span>
00068     <span class="comment">// Freeze the execution of all threads in the current process, but</span>
00069     <span class="comment">// the calling thread.</span>
00070     <span class="comment">//</span>
00071     <span class="keywordflow">if</span> ( !CreateDeleteLockHeld ) {
00072         <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,<a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>);
00073         }
00074 
00075     <a class="code" href="../../d9/d1/thredobj_8c.html#a9">KeFreezeAllThreads</a>();
00076 
00077     <span class="keywordflow">if</span> ( !CreateDeleteLockHeld ) {
00078         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00079         }
00080 
00081 
00082     <span class="keywordflow">return</span>;
00083 }
00084 
00085 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00086"></a><a class="code" href="../../d7/d3/dbgkproc_8c.html#a1">00086</a> <a class="code" href="../../d7/d3/dbgkproc_8c.html#a1">DbgkpResumeProcess</a>(
00087     IN BOOLEAN CreateDeleteLockHeld
00088     )
00089 
00090 <span class="comment">/*++</span>
00091 <span class="comment"></span>
00092 <span class="comment">Routine Description:</span>
00093 <span class="comment"></span>
00094 <span class="comment">    This function causes all threads in the calling process except for</span>
00095 <span class="comment">    the calling thread to resume.</span>
00096 <span class="comment"></span>
00097 <span class="comment">Arguments:</span>
00098 <span class="comment"></span>
00099 <span class="comment">    CreateDeleteLockHeld - Supplies a flag that specifies whether or not</span>
00100 <span class="comment">        the caller is holding the process create delete lock.  If the</span>
00101 <span class="comment">        caller holds the lock, than this function will not aquire the</span>
00102 <span class="comment">        lock before suspending the process.</span>
00103 <span class="comment"></span>
00104 <span class="comment">Return Value:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    None.</span>
00107 <span class="comment"></span>
00108 <span class="comment">--*/</span>
00109 
00110 {
00111 
00112     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00113 
00114     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00115 
00116     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00117     <span class="comment">//</span>
00118     <span class="comment">// Thaw the execution of all threads in the current process, but</span>
00119     <span class="comment">// the calling thread.</span>
00120     <span class="comment">//</span>
00121 
00122     <span class="keywordflow">if</span> ( !CreateDeleteLockHeld ) {
00123         <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,<a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>);
00124         }
00125 
00126     <a class="code" href="../../d9/d1/thredobj_8c.html#a28">KeThawAllThreads</a>();
00127 
00128     <span class="keywordflow">if</span> ( !CreateDeleteLockHeld ) {
00129         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00130         }
00131 
00132     <span class="keywordflow">return</span>;
00133 }
00134 
00135 HANDLE
<a name="l00136"></a><a class="code" href="../../d7/d3/dbgkproc_8c.html#a2">00136</a> <a class="code" href="../../d7/d3/dbgkproc_8c.html#a2">DbgkpSectionHandleToFileHandle</a>(
00137     IN HANDLE SectionHandle
00138     )
00139 
00140 <span class="comment">/*++</span>
00141 <span class="comment"></span>
00142 <span class="comment">Routine Description:</span>
00143 <span class="comment"></span>
00144 <span class="comment">    This function Opens a handle to the file associated with the processes</span>
00145 <span class="comment">    section. The file is opened such that it can be dupped all the way to</span>
00146 <span class="comment">    the UI where the UI can either map the file or read the file to get</span>
00147 <span class="comment">    the debug info.</span>
00148 <span class="comment"></span>
00149 <span class="comment">Arguments:</span>
00150 <span class="comment"></span>
00151 <span class="comment">    SectionHandle - Supplies a handle to the section whose associated file</span>
00152 <span class="comment">        is to be opened.</span>
00153 <span class="comment"></span>
00154 <span class="comment">Return Value:</span>
00155 <span class="comment"></span>
00156 <span class="comment">    NULL - The file could not be opened.</span>
00157 <span class="comment"></span>
00158 <span class="comment">    NON-NULL - Returns a handle to the file associated with the specified</span>
00159 <span class="comment">        section.</span>
00160 <span class="comment"></span>
00161 <span class="comment">--*/</span>
00162 
00163 {
00164     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00165     ANSI_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00166     UNICODE_STRING UnicodeFileName;
00167     OBJECT_ATTRIBUTES Obja;
00168     IO_STATUS_BLOCK IoStatusBlock;
00169     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00170 
00171     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00172 
00173     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d5/sectsup_8c.html#a23">MmGetFileNameForSection</a>(SectionHandle, (PSTRING)&amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
00174     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00175         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00176         }
00177 
00178     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeFileName,&amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00179     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
00180     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00181         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00182         }
00183 
00184     InitializeObjectAttributes(
00185         &amp;Obja,
00186         &amp;UnicodeFileName,
00187         OBJ_CASE_INSENSITIVE,
00188         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00189         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00190         );
00191 
00192     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00193                 &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00194                 (ACCESS_MASK)(GENERIC_READ | SYNCHRONIZE),
00195                 &amp;Obja,
00196                 &amp;IoStatusBlock,
00197                 FILE_SHARE_DELETE | FILE_SHARE_READ | FILE_SHARE_WRITE,
00198                 FILE_SYNCHRONOUS_IO_NONALERT
00199                 );
00200     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeFileName);
00201     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00202         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00203         }
00204     <span class="keywordflow">else</span> {
00205         <span class="keywordflow">return</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00206         }
00207 }
00208 
00209 
00210 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00211"></a><a class="code" href="../../d4/d3/dbgk_8h.html#a0">00211</a> <a class="code" href="../../d4/d3/dbgk_8h.html#a0">DbgkCreateThread</a>(
00212     PVOID StartAddress
00213     )
00214 
00215 <span class="comment">/*++</span>
00216 <span class="comment"></span>
00217 <span class="comment">Routine Description:</span>
00218 <span class="comment"></span>
00219 <span class="comment">    This function is called when a new thread begins to execute. If the</span>
00220 <span class="comment">    thread has an associated DebugPort, then a message is sent thru the</span>
00221 <span class="comment">    port.</span>
00222 <span class="comment"></span>
00223 <span class="comment">    If this thread is the first thread in the process, then this event</span>
00224 <span class="comment">    is translated into a CreateProcessInfo message.</span>
00225 <span class="comment"></span>
00226 <span class="comment">    If a message is sent, then while the thread is awaiting a reply,</span>
00227 <span class="comment">    all other threads in the process are suspended.</span>
00228 <span class="comment"></span>
00229 <span class="comment">Arguments:</span>
00230 <span class="comment"></span>
00231 <span class="comment">    StartAddress - Supplies the start address for the thread that is</span>
00232 <span class="comment">        starting.</span>
00233 <span class="comment"></span>
00234 <span class="comment">Return Value:</span>
00235 <span class="comment"></span>
00236 <span class="comment">    None.</span>
00237 <span class="comment"></span>
00238 <span class="comment">--*/</span>
00239 
00240 {
00241     PVOID Port;
00242     DBGKM_APIMSG m;
00243     PDBGKM_CREATE_THREAD CreateThreadArgs;
00244     PDBGKM_CREATE_PROCESS CreateProcessArgs;
00245     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00246     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00247     PDBGKM_LOAD_DLL LoadDllArgs;
00248     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00249     OBJECT_ATTRIBUTES Obja;
00250     IO_STATUS_BLOCK IoStatusBlock;
00251     PIMAGE_NT_HEADERS NtHeaders;
00252 
00253     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00254 
00255     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00256 
00257     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00258 
00259     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a72">PsImageNotifyEnabled</a> &amp;&amp; !Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a>) {
00260         <a class="code" href="../../d2/d1/struct__IMAGE__INFO.html">IMAGE_INFO</a> ImageInfo;
00261         PIMAGE_NT_HEADERS NtHeaders;
00262         ANSI_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00263         UNICODE_STRING UnicodeFileName;
00264         PUNICODE_STRING pUnicodeFileName;
00265 
00266         <span class="comment">//</span>
00267         <span class="comment">// notification of main .exe</span>
00268         <span class="comment">//</span>
00269         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o0">Properties</a> = 0;
00270         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o1">ImageAddressingMode</a> = <a class="code" href="../../d1/d9/ps_8h.html#a23">IMAGE_ADDRESSING_MODE_32BIT</a>;
00271         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o5">ImageBase</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>;
00272         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = 0;
00273 
00274         <span class="keywordflow">try</span> {
00275             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>);
00276     
00277             <span class="keywordflow">if</span> ( NtHeaders ) {
00278                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = NtHeaders-&gt;OptionalHeader.SizeOfImage;
00279                 }
00280             }
00281         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00282             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = 0;
00283         }
00284         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o6">ImageSelector</a> = 0;
00285         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o8">ImageSectionNumber</a> = 0;
00286 
00287         pUnicodeFileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00288         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d5/sectsup_8c.html#a23">MmGetFileNameForSection</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o46">SectionHandle</a>, (PSTRING)&amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>);
00289         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00290             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeFileName,&amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00291             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
00292             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00293                 pUnicodeFileName = &amp;UnicodeFileName;
00294                 }
00295             }
00296         <a class="code" href="../../d2/d8/ps_2create_8c.html#a28">PsCallImageNotifyRoutines</a>(
00297                     pUnicodeFileName,
00298                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00299                     &amp;ImageInfo
00300                     );
00301         <span class="keywordflow">if</span> ( pUnicodeFileName ) {
00302             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(pUnicodeFileName);
00303             }
00304 
00305         <span class="comment">//</span>
00306         <span class="comment">// and of ntdll.dll</span>
00307         <span class="comment">//</span>
00308         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o0">Properties</a> = 0;
00309         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o1">ImageAddressingMode</a> = <a class="code" href="../../d1/d9/ps_8h.html#a23">IMAGE_ADDRESSING_MODE_32BIT</a>;
00310         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o5">ImageBase</a> = <a class="code" href="../../d1/d9/ps_8h.html#a51">PsSystemDllBase</a>;
00311         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = 0;
00312 
00313         <span class="keywordflow">try</span> {
00314             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(<a class="code" href="../../d1/d9/ps_8h.html#a51">PsSystemDllBase</a>);
00315             <span class="keywordflow">if</span> ( NtHeaders ) {
00316                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = NtHeaders-&gt;OptionalHeader.SizeOfImage;
00317                 }
00318             }
00319         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00320             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = 0;
00321             }
00322 
00323         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o6">ImageSelector</a> = 0;
00324         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o8">ImageSectionNumber</a> = 0;
00325 
00326         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeFileName,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\SystemRoot\\System32\\ntdll.dll"</span>);
00327         <a class="code" href="../../d2/d8/ps_2create_8c.html#a28">PsCallImageNotifyRoutines</a>(
00328                     &amp;UnicodeFileName,
00329                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00330                     &amp;ImageInfo
00331                     );
00332         }
00333 
00334 
00335     <span class="keywordflow">if</span> ( !Port ) {
00336 
00337         <span class="keywordflow">return</span>;
00338     }
00339 
00340     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00341 
00342     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> ) {
00343         <span class="keywordflow">return</span>;
00344     }
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// To determine if this should be turned into a create process,</span>
00348     <span class="comment">// all threads in the process are suspended. The process list</span>
00349     <span class="comment">// is then examined to see if the curent thread is the only thread</span>
00350     <span class="comment">// on the list. If so, this becomes a create process message</span>
00351     <span class="comment">//</span>
00352 
00353     <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,<a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>);
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// If we are doing a debug attach, then the create process has</span>
00357     <span class="comment">// already occured. If this is the case, then the process has</span>
00358     <span class="comment">// accumulated some time, so set reported to true</span>
00359     <span class="comment">//</span>
00360 
00361     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a> ) {
00362         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o45">CreateProcessReported</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00363         }
00364 
00365     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o45">CreateProcessReported</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// This is a create process</span>
00369         <span class="comment">//</span>
00370 
00371         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o45">CreateProcessReported</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00372 
00373         CreateThreadArgs = &amp;m.u.CreateProcessInfo.InitialThread;
00374         CreateThreadArgs-&gt;SubSystemKey = 0;
00375 
00376         CreateProcessArgs = &amp;m.u.CreateProcessInfo;
00377         CreateProcessArgs-&gt;SubSystemKey = 0;
00378         CreateProcessArgs-&gt;FileHandle = <a class="code" href="../../d7/d3/dbgkproc_8c.html#a2">DbgkpSectionHandleToFileHandle</a>(
00379                                             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o46">SectionHandle</a>
00380                                             );
00381         CreateProcessArgs-&gt;BaseOfImage = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>;
00382         CreateThreadArgs-&gt;StartAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00383         CreateProcessArgs-&gt;DebugInfoFileOffset = 0;
00384         CreateProcessArgs-&gt;DebugInfoSize = 0;
00385 
00386         <span class="keywordflow">try</span> {
00387             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>);
00388             <span class="keywordflow">if</span> ( NtHeaders ) {
00389                 CreateThreadArgs-&gt;StartAddress = (PVOID)(
00390                     NtHeaders-&gt;OptionalHeader.ImageBase +
00391                     NtHeaders-&gt;OptionalHeader.AddressOfEntryPoint);
00392 
00393                 CreateProcessArgs-&gt;DebugInfoFileOffset = NtHeaders-&gt;FileHeader.PointerToSymbolTable;
00394                 CreateProcessArgs-&gt;DebugInfoSize = NtHeaders-&gt;FileHeader.NumberOfSymbols;
00395                 }
00396             }
00397         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00398             CreateThreadArgs-&gt;StartAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00399             CreateProcessArgs-&gt;DebugInfoFileOffset = 0;
00400             CreateProcessArgs-&gt;DebugInfoSize = 0;
00401         }
00402 
00403         DBGKM_FORMAT_API_MSG(m,DbgKmCreateProcessApi,<span class="keyword">sizeof</span>(*CreateProcessArgs));
00404 
00405         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00406 
00407         <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00408         ZwClose(CreateProcessArgs-&gt;FileHandle);
00409 
00410         LoadDllArgs = &amp;m.u.LoadDll;
00411         LoadDllArgs-&gt;BaseOfDll = <a class="code" href="../../d1/d9/ps_8h.html#a51">PsSystemDllBase</a>;
00412         LoadDllArgs-&gt;DebugInfoFileOffset = 0;
00413         LoadDllArgs-&gt;DebugInfoSize = 0;
00414 
00415         <span class="keywordflow">try</span> {
00416             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(<a class="code" href="../../d1/d9/ps_8h.html#a51">PsSystemDllBase</a>);
00417             <span class="keywordflow">if</span> ( NtHeaders ) {
00418                 LoadDllArgs-&gt;DebugInfoFileOffset = NtHeaders-&gt;FileHeader.PointerToSymbolTable;
00419                 LoadDllArgs-&gt;DebugInfoSize = NtHeaders-&gt;FileHeader.NumberOfSymbols;
00420                 }
00421             }
00422         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00423             LoadDllArgs-&gt;DebugInfoFileOffset = 0;
00424             LoadDllArgs-&gt;DebugInfoSize = 0;
00425         }
00426 
00427         <span class="comment">//</span>
00428         <span class="comment">// Send load dll section for NT dll !</span>
00429         <span class="comment">//</span>
00430 
00431         InitializeObjectAttributes(
00432             &amp;Obja,
00433             &amp;<a class="code" href="../../d1/d9/ps_8h.html#a50">PsNtDllPathName</a>,
00434             OBJ_CASE_INSENSITIVE,
00435             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00436             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00437             );
00438 
00439         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00440                     &amp;LoadDllArgs-&gt;FileHandle,
00441                     (ACCESS_MASK)(GENERIC_READ | SYNCHRONIZE),
00442                     &amp;Obja,
00443                     &amp;IoStatusBlock,
00444                     FILE_SHARE_DELETE | FILE_SHARE_READ | FILE_SHARE_WRITE,
00445                     FILE_SYNCHRONOUS_IO_NONALERT
00446                     );
00447 
00448         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00449             DBGKM_FORMAT_API_MSG(m,DbgKmLoadDllApi,<span class="keyword">sizeof</span>(*LoadDllArgs));
00450             <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00451         }
00452         ZwClose(LoadDllArgs-&gt;FileHandle);
00453 
00454     } <span class="keywordflow">else</span> {
00455 
00456         CreateThreadArgs = &amp;m.u.CreateThread;
00457         CreateThreadArgs-&gt;SubSystemKey = 0;
00458         CreateThreadArgs-&gt;StartAddress = StartAddress;
00459 
00460         DBGKM_FORMAT_API_MSG(m,DbgKmCreateThreadApi,<span class="keyword">sizeof</span>(*CreateThreadArgs));
00461 
00462         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00463 
00464         <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00465     }
00466 
00467 
00468 }
00469 
00470 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00471"></a><a class="code" href="../../d4/d3/dbgk_8h.html#a1">00471</a> <a class="code" href="../../d4/d3/dbgk_8h.html#a1">DbgkExitThread</a>(
00472     NTSTATUS ExitStatus
00473     )
00474 
00475 <span class="comment">/*++</span>
00476 <span class="comment"></span>
00477 <span class="comment">Routine Description:</span>
00478 <span class="comment"></span>
00479 <span class="comment">    This function is called when a new thread terminates. At this</span>
00480 <span class="comment">    point, the thread will no longer execute in user-mode. No other</span>
00481 <span class="comment">    exit processing has occured.</span>
00482 <span class="comment"></span>
00483 <span class="comment">    If a message is sent, then while the thread is awaiting a reply,</span>
00484 <span class="comment">    all other threads in the process are suspended.</span>
00485 <span class="comment"></span>
00486 <span class="comment">Arguments:</span>
00487 <span class="comment"></span>
00488 <span class="comment">    ExitStatus - Supplies the ExitStatus of the exiting thread.</span>
00489 <span class="comment"></span>
00490 <span class="comment">Return Value:</span>
00491 <span class="comment"></span>
00492 <span class="comment">    None.</span>
00493 <span class="comment"></span>
00494 <span class="comment">--*/</span>
00495 
00496 {
00497     PVOID Port;
00498     DBGKM_APIMSG m;
00499     PDBGKM_EXIT_THREAD args;
00500     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00501 
00502     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00503 
00504     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00505     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00506 
00507     <span class="keywordflow">if</span> ( !Port ) {
00508         <span class="keywordflow">return</span>;
00509     }
00510 
00511     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;DeadThread ) {
00512         <span class="keywordflow">return</span>;
00513     }
00514 
00515     args = &amp;m.u.ExitThread;
00516     args-&gt;ExitStatus = ExitStatus;
00517 
00518     DBGKM_FORMAT_API_MSG(m,DbgKmExitThreadApi,<span class="keyword">sizeof</span>(*args));
00519 
00520     <a class="code" href="../../d7/d3/dbgkproc_8c.html#a0">DbgkpSuspendProcess</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00521 
00522     <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00523 
00524     <a class="code" href="../../d7/d3/dbgkproc_8c.html#a1">DbgkpResumeProcess</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00525 }
00526 
00527 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00528"></a><a class="code" href="../../d4/d3/dbgk_8h.html#a2">00528</a> <a class="code" href="../../d4/d3/dbgk_8h.html#a2">DbgkExitProcess</a>(
00529     NTSTATUS ExitStatus
00530     )
00531 
00532 <span class="comment">/*++</span>
00533 <span class="comment"></span>
00534 <span class="comment">Routine Description:</span>
00535 <span class="comment"></span>
00536 <span class="comment">    This function is called when a process terminates. The address</span>
00537 <span class="comment">    space of the process is still intact, but no threads exist in</span>
00538 <span class="comment">    the process.</span>
00539 <span class="comment"></span>
00540 <span class="comment">Arguments:</span>
00541 <span class="comment"></span>
00542 <span class="comment">    ExitStatus - Supplies the ExitStatus of the exiting process.</span>
00543 <span class="comment"></span>
00544 <span class="comment">Return Value:</span>
00545 <span class="comment"></span>
00546 <span class="comment">    None.</span>
00547 <span class="comment"></span>
00548 <span class="comment">--*/</span>
00549 
00550 {
00551     PVOID Port;
00552     DBGKM_APIMSG m;
00553     PDBGKM_EXIT_PROCESS args;
00554     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00555 
00556     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00557 
00558     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00559     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00560 
00561     <span class="keywordflow">if</span> ( !Port ) {
00562         <span class="keywordflow">return</span>;
00563     }
00564 
00565     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;DeadThread ) {
00566         <span class="keywordflow">return</span>;
00567     }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// this ensures that other timed lockers of the process will bail</span>
00571     <span class="comment">// since this call is done while holding the process lock, and lock duration</span>
00572     <span class="comment">// is controlled by debugger</span>
00573     <span class="comment">//</span>
00574     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ExitTime);
00575 
00576     args = &amp;m.u.ExitProcess;
00577     args-&gt;ExitStatus = ExitStatus;
00578 
00579     DBGKM_FORMAT_API_MSG(m,DbgKmExitProcessApi,<span class="keyword">sizeof</span>(*args));
00580 
00581     <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00582 
00583 }
00584 
00585 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00586"></a><a class="code" href="../../d4/d3/dbgk_8h.html#a3">00586</a> <a class="code" href="../../d4/d3/dbgk_8h.html#a3">DbgkMapViewOfSection</a>(
00587     IN HANDLE SectionHandle,
00588     IN PVOID BaseAddress,
00589     IN ULONG SectionOffset,
00590     IN ULONG_PTR ViewSize
00591     )
00592 
00593 <span class="comment">/*++</span>
00594 <span class="comment"></span>
00595 <span class="comment">Routine Description:</span>
00596 <span class="comment"></span>
00597 <span class="comment">    This function is called when the current process successfully</span>
00598 <span class="comment">    maps a view of an image section. If the process has an associated</span>
00599 <span class="comment">    debug port, then a load dll message is sent.</span>
00600 <span class="comment"></span>
00601 <span class="comment">Arguments:</span>
00602 <span class="comment"></span>
00603 <span class="comment">    SectionHandle - Supplies a handle to the section mapped by the</span>
00604 <span class="comment">        process.</span>
00605 <span class="comment"></span>
00606 <span class="comment">    BaseAddress - Supplies the base address of where the section is</span>
00607 <span class="comment">        mapped in the current process address space.</span>
00608 <span class="comment"></span>
00609 <span class="comment">    SectionOffset - Supplies the offset in the section where the</span>
00610 <span class="comment">        processes mapped view begins.</span>
00611 <span class="comment"></span>
00612 <span class="comment">    ViewSize - Supplies the size of the mapped view.</span>
00613 <span class="comment"></span>
00614 <span class="comment">Return Value:</span>
00615 <span class="comment"></span>
00616 <span class="comment">    None.</span>
00617 <span class="comment"></span>
00618 <span class="comment">--*/</span>
00619 
00620 {
00621 
00622     PVOID Port;
00623     DBGKM_APIMSG m;
00624     PDBGKM_LOAD_DLL LoadDllArgs;
00625     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00626     PIMAGE_NT_HEADERS NtHeaders;
00627 
00628     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00629 
00630     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00631 
00632     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00633 
00634     <span class="keywordflow">if</span> ( !Port || KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00635         <span class="keywordflow">return</span>;
00636     }
00637 
00638     LoadDllArgs = &amp;m.u.LoadDll;
00639     LoadDllArgs-&gt;FileHandle = <a class="code" href="../../d7/d3/dbgkproc_8c.html#a2">DbgkpSectionHandleToFileHandle</a>(SectionHandle);
00640     LoadDllArgs-&gt;BaseOfDll = BaseAddress;
00641     LoadDllArgs-&gt;DebugInfoFileOffset = 0;
00642     LoadDllArgs-&gt;DebugInfoSize = 0;
00643 
00644     <span class="keywordflow">try</span> {
00645         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(BaseAddress);
00646         <span class="keywordflow">if</span> ( NtHeaders ) {
00647             LoadDllArgs-&gt;DebugInfoFileOffset = NtHeaders-&gt;FileHeader.PointerToSymbolTable;
00648             LoadDllArgs-&gt;DebugInfoSize = NtHeaders-&gt;FileHeader.NumberOfSymbols;
00649             }
00650         }
00651     except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00652         LoadDllArgs-&gt;DebugInfoFileOffset = 0;
00653         LoadDllArgs-&gt;DebugInfoSize = 0;
00654     }
00655 
00656     DBGKM_FORMAT_API_MSG(m,DbgKmLoadDllApi,<span class="keyword">sizeof</span>(*LoadDllArgs));
00657 
00658     <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00659     ZwClose(LoadDllArgs-&gt;FileHandle);
00660 
00661 }
00662 
00663 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00664"></a><a class="code" href="../../d4/d3/dbgk_8h.html#a4">00664</a> <a class="code" href="../../d4/d3/dbgk_8h.html#a4">DbgkUnMapViewOfSection</a>(
00665     IN PVOID BaseAddress
00666     )
00667 
00668 <span class="comment">/*++</span>
00669 <span class="comment"></span>
00670 <span class="comment">Routine Description:</span>
00671 <span class="comment"></span>
00672 <span class="comment">    This function is called when the current process successfully</span>
00673 <span class="comment">    un maps a view of an image section. If the process has an associated</span>
00674 <span class="comment">    debug port, then an "unmap view of section" message is sent.</span>
00675 <span class="comment"></span>
00676 <span class="comment">Arguments:</span>
00677 <span class="comment"></span>
00678 <span class="comment">    BaseAddress - Supplies the base address of the section being</span>
00679 <span class="comment">        unmapped.</span>
00680 <span class="comment"></span>
00681 <span class="comment">Return Value:</span>
00682 <span class="comment"></span>
00683 <span class="comment">    None.</span>
00684 <span class="comment"></span>
00685 <span class="comment">--*/</span>
00686 
00687 {
00688 
00689     PVOID Port;
00690     DBGKM_APIMSG m;
00691     PDBGKM_UNLOAD_DLL UnloadDllArgs;
00692     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00693 
00694     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00695 
00696     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00697 
00698     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00699 
00700     <span class="keywordflow">if</span> ( !Port || KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00701         <span class="keywordflow">return</span>;
00702     }
00703 
00704     UnloadDllArgs = &amp;m.u.UnloadDll;
00705     UnloadDllArgs-&gt;BaseAddress = BaseAddress;
00706 
00707     DBGKM_FORMAT_API_MSG(m,DbgKmUnloadDllApi,<span class="keyword">sizeof</span>(*UnloadDllArgs));
00708 
00709     <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00710 
00711 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
