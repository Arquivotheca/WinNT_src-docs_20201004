<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: validate.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>validate.c</h1><a href="../../d7/d3/validate_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: validate.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains functions for validating windows, menus, cursors, etc.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 01-02-91 DarrinM      Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ntsdexts.h&gt;</span>
00015 
00016 <span class="comment">/*</span>
00017 <span class="comment"> * these defines are used for using the validation macros</span>
00018 <span class="comment"> * StartValidateHandleMacro and EndValidateHandleMacro</span>
00019 <span class="comment"> */</span>
<a name="l00020"></a><a class="code" href="../../d7/d3/validate_8c.html#a0">00020</a> <span class="preprocessor">#define ClientSharedInfo()  (&amp;gSharedInfo)</span>
<a name="l00021"></a><a class="code" href="../../d7/d3/validate_8c.html#a1">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define ServerInfo()  (gpsi)</span>
00022 <span class="preprocessor"></span>
00023 <span class="preprocessor">#include "<a class="code" href="../../d7/d9/wow_8h.html">wow.h</a>"</span>
00024 
00025 <span class="preprocessor">#if DBG</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#if defined(_X86_)</span>
00027 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/structtagCRITSTACK.html">CRITSTACK</a>  gCritStack;
00028 <span class="preprocessor">#endif // defined(_X86_)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#endif // DBG</span>
00030 <span class="preprocessor"></span>
00031 <span class="comment">/*</span>
00032 <span class="comment"> * Globals used only in his file.</span>
00033 <span class="comment"> */</span>
<a name="l00034"></a><a class="code" href="../../d7/d3/validate_8c.html#a5">00034</a> __int64   <a class="code" href="../../d7/d3/validate_8c.html#a5">gCSTimeExclusiveWhenEntering</a>;
00035 
00036 <span class="comment">/***************************************************************************\</span>
00037 <span class="comment">* ValidateHwinsta</span>
00038 <span class="comment">*</span>
00039 <span class="comment">* Validate windowstation handle</span>
00040 <span class="comment">*</span>
00041 <span class="comment">* History:</span>
00042 <span class="comment">* 03-29-91 JimA             Created.</span>
00043 <span class="comment">* 06-20-95 JimA             Kernel-mode objects.</span>
00044 <span class="comment">\***************************************************************************/</span>
00045 
<a name="l00046"></a><a class="code" href="../../d7/d3/validate_8c.html#a6">00046</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d7/d3/validate_8c.html#a6">ValidateHwinsta</a>(
00047     HWINSTA         hwinsta,
00048     KPROCESSOR_MODE AccessMode,
00049     ACCESS_MASK     amDesired,
00050     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>* ppwinsta)
00051 {
00052     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00053 
00054     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00055             hwinsta,
00056             amDesired,
00057             *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>,
00058             AccessMode,
00059             ppwinsta,
00060             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00061 
00062     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00063         RIPNTERR1(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">"ValidateHwinsta failed for %#p"</span>, hwinsta);
00064 
00065     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*ppwinsta)-&gt;dwSessionId != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>) {
00066 
00067         RIPNTERR3(STATUS_INVALID_HANDLE, RIP_WARNING,
00068                   <span class="stringliteral">"SessionId %d. Wrong session id %d for pwinsta %#p"</span>,
00069                   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>, (*ppwinsta)-&gt;dwSessionId, *ppwinsta);
00070 
00071         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*ppwinsta);
00072 <span class="preprocessor">#if DBG</span>
00073 <span class="preprocessor"></span>        *ppwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00074 <span class="preprocessor">#endif // DBG</span>
00075 <span class="preprocessor"></span>
00076         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00077     }
00078 
00079     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00080 }
00081 
00082 <span class="comment">/***************************************************************************\</span>
00083 <span class="comment">* ValidateHdesk</span>
00084 <span class="comment">*</span>
00085 <span class="comment">* Validate desktop handle</span>
00086 <span class="comment">*</span>
00087 <span class="comment">* History:</span>
00088 <span class="comment">* 03-29-91 JimA             Created.</span>
00089 <span class="comment">* 06-20-95 JimA             Kernel-mode objects.</span>
00090 <span class="comment">\***************************************************************************/</span>
00091 
<a name="l00092"></a><a class="code" href="../../d7/d3/validate_8c.html#a7">00092</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d7/d3/validate_8c.html#a7">ValidateHdesk</a>(
00093     HDESK           hdesk,
00094     KPROCESSOR_MODE AccessMode,
00095     ACCESS_MASK     amDesired,
00096     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>*       ppdesk)
00097 {
00098     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00099 
00100     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00101             hdesk,
00102             amDesired,
00103             *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
00104             AccessMode,
00105             ppdesk,
00106             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00107 
00108     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00109 
00110         <span class="keywordflow">if</span> ((*ppdesk)-&gt;dwSessionId != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>) {
00111 
00112             RIPNTERR3(STATUS_INVALID_HANDLE, RIP_WARNING,
00113                       <span class="stringliteral">"SessionId %d. Wrong session id %d for pdesk %#p"</span>,
00114                       <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a>, (*ppdesk)-&gt;dwSessionId, *ppdesk);
00115 
00116             <span class="keywordflow">goto</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>;
00117         }
00118 
00119         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(*ppdesk, LDL_VALIDATE_HDESK, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00120 
00121         <span class="keywordflow">if</span> ((*ppdesk)-&gt;dwDTFlags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a287">DF_DESTROYED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a286">DF_DESKWNDDESTROYED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a285">DF_DYING</a>)) {
00122             RIPNTERR1(STATUS_INVALID_HANDLE, RIP_ERROR,
00123                       <span class="stringliteral">"ValidateHdesk: destroyed desktop %#p"</span>,
00124                       *ppdesk);
00125 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>:
00126             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*ppdesk);
00127 <span class="preprocessor">#if DBG</span>
00128 <span class="preprocessor"></span>            *ppdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00129 <span class="preprocessor">#endif // DBG</span>
00130 <span class="preprocessor"></span>
00131             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00132         }
00133     } <span class="keywordflow">else</span> {
00134         RIPNTERR1(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">"ValidateHdesk failed for %#p"</span>, hdesk);
00135     }
00136 
00137     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00138 }
00139 
00140 <span class="comment">/***************************************************************************\</span>
00141 <span class="comment">* UserValidateCopyRgn</span>
00142 <span class="comment">*</span>
00143 <span class="comment">* Validates a region-handle.  This essentially tries to copy the region</span>
00144 <span class="comment">* in order to verify the region is valid.  If hrgn isn't a valid region,</span>
00145 <span class="comment">* then the combine will fail.  We return a copy of the region.</span>
00146 <span class="comment">*</span>
00147 <span class="comment">* History:</span>
00148 <span class="comment">* 24=Jan-1996   ChrisWil    Created.</span>
00149 <span class="comment">\***************************************************************************/</span>
00150 
<a name="l00151"></a><a class="code" href="../../d7/d3/validate_8c.html#a8">00151</a> HRGN <a class="code" href="../../d7/d3/validate_8c.html#a8">UserValidateCopyRgn</a>(
00152     HRGN hrgn)
00153 {
00154     HRGN hrgnCopy = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00155 
00156 
00157     <span class="keywordflow">if</span> (hrgn &amp;&amp; (GreValidateServerHandle(hrgn, RGN_TYPE))) {
00158 
00159         hrgnCopy = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
00160 
00161         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(hrgnCopy, hrgn) == ERROR) {
00162 
00163             GreDeleteObject(hrgnCopy);
00164 
00165             hrgnCopy = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00166         }
00167     }
00168 
00169     <span class="keywordflow">return</span> hrgnCopy;
00170 }
00171 
00172 <span class="comment">/***************************************************************************\</span>
00173 <span class="comment">* ValidateHmenu</span>
00174 <span class="comment">*</span>
00175 <span class="comment">* Validate menu handle and open it</span>
00176 <span class="comment">*</span>
00177 <span class="comment">* History:</span>
00178 <span class="comment">* 03-29-91 JimA             Created.</span>
00179 <span class="comment">\***************************************************************************/</span>
00180 
<a name="l00181"></a><a class="code" href="../../d7/d3/validate_8c.html#a9">00181</a> <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d7/d3/validate_8c.html#a9">ValidateHmenu</a>(
00182     HMENU hmenu)
00183 {
00184     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00185     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenuRet;
00186 
00187     pmenuRet = (<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>(hmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a238">TYPE_MENU</a>);
00188 
00189     <span class="keywordflow">if</span> (pmenuRet != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00190             ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;  <span class="comment">// hack so console initialization works.</span>
00191             pmenuRet-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o0">head</a>.rpdesk != pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>))) {
00192         RIPERR1(ERROR_INVALID_MENU_HANDLE, RIP_WARNING, <span class="stringliteral">"Invalid menu handle (%#p)"</span>, hmenu);
00193         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00194     }
00195 
00196     <span class="keywordflow">return</span> pmenuRet;
00197 }
00198 
00199 
00200 
00201 <span class="comment">/***************************************************************************\</span>
00202 <span class="comment">* ValidateHmonitor</span>
00203 <span class="comment">*</span>
00204 <span class="comment">* Validate monitor handle and open it.</span>
00205 <span class="comment">*</span>
00206 <span class="comment">* History:</span>
00207 <span class="comment">* 03-29-91 JimA             Created.</span>
00208 <span class="comment">\***************************************************************************/</span>
00209 
<a name="l00210"></a><a class="code" href="../../d7/d3/validate_8c.html#a10">00210</a> <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> <a class="code" href="../../d7/d3/validate_8c.html#a10">ValidateHmonitor</a>(
00211         HMONITOR hmonitor)
00212 {
00213     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a9">HMValidateSharedHandle</a>(hmonitor, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a248">TYPE_MONITOR</a>);
00214 }
00215 
00216 <span class="comment">/*</span>
00217 <span class="comment"> * The handle validation routines should be optimized for time, not size,</span>
00218 <span class="comment"> * since they get called so often.</span>
00219 <span class="comment"> */</span>
00220 <span class="preprocessor">#pragma optimize("t", on)</span>
00221 <span class="preprocessor"></span>
00222 <span class="comment">/***************************************************************************\</span>
00223 <span class="comment">* IsHandleEntrySecure</span>
00224 <span class="comment">*</span>
00225 <span class="comment">* Validate a user handle for a restricted process bypassing the routine to</span>
00226 <span class="comment">* get the handle entry.</span>
00227 <span class="comment">*</span>
00228 <span class="comment">* History:</span>
00229 <span class="comment">* August 22, 97   CLupu      Created.</span>
00230 <span class="comment">\***************************************************************************/</span>
00231 
<a name="l00232"></a><a class="code" href="../../d7/d3/validate_8c.html#a11">00232</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d3/validate_8c.html#a11">IsHandleEntrySecure</a>(
00233     HANDLE h,
00234     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>    phe)
00235 {
00236     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        bCreateFlags;
00237     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiOwner;
00238     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiCurrent;
00239     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a>      pW32Job;
00240     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        ind;
00241     PULONG_PTR    pgh;
00242 
00243     <span class="comment">/*</span>
00244 <span class="comment">     * get the current process</span>
00245 <span class="comment">     */</span>
00246     ppiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
00247 
00248     <span class="keywordflow">if</span> (ppiCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00249         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00250 
00251     UserAssert(ppiCurrent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00252 
00253     UserAssert(ppiCurrent-&gt;W32PF_Flags &amp; W32PF_RESTRICTED);
00254 
00255     <span class="comment">/*</span>
00256 <span class="comment">     * get the process that owns the handle</span>
00257 <span class="comment">     */</span>
00258 
00259     bCreateFlags = <a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a>;
00260 
00261     ppiOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00262 
00263     <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a>) {
00264         ppiOwner = (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>;
00265     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a413">OCF_THREADOWNED</a>) {
00266 
00267         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00268 
00269         pti = (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>;
00270 
00271         <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00272             ppiOwner = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00273         }
00274     }
00275 
00276     <span class="comment">/*</span>
00277 <span class="comment">     * if the owner is NULL then consider the handle secure</span>
00278 <span class="comment">     */</span>
00279     <span class="keywordflow">if</span> (ppiOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00280         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00281 
00282 
00283     <span class="comment">/*</span>
00284 <span class="comment">     * if the handle is owned by a process in the same job, then it's secure</span>
00285 <span class="comment">     */</span>
00286     <span class="keywordflow">if</span> (ppiOwner-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a> == ppiCurrent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a>)
00287         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00288 
00289     <span class="comment">/*</span>
00290 <span class="comment">     * the handle is not owned by the current process</span>
00291 <span class="comment">     */</span>
00292 
00293     pW32Job = ppiCurrent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a>;
00294 
00295     <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o9">pgh</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00296         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00297 
00298     pgh = pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o9">pgh</a>;
00299 
00300     UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a> &lt;= pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o8">ughMax</a>);
00301 
00302     <span class="keywordflow">for</span> (ind = 0; ind &lt; pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>; ind++) {
00303         <span class="keywordflow">if</span> (*(pgh + ind) == (ULONG_PTR)h) {
00304             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00305         }
00306     }
00307 
00308     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00309 }
00310 
00311 
00312 <span class="comment">/***************************************************************************\</span>
00313 <span class="comment">* ValidateHandleSecure</span>
00314 <span class="comment">*</span>
00315 <span class="comment">* Validate a user handle for a restricted process.</span>
00316 <span class="comment">*</span>
00317 <span class="comment">* History:</span>
00318 <span class="comment">* July 29, 97   CLupu      Created.</span>
00319 <span class="comment">\***************************************************************************/</span>
00320 
<a name="l00321"></a><a class="code" href="../../d7/d3/validate_8c.html#a12">00321</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d3/validate_8c.html#a12">ValidateHandleSecure</a>(
00322     HANDLE h)
00323 {
00324     PVOID pobj;
00325 
00326     <a class="code" href="../../d4/d1/userk_8h.html#a156">CheckCritInShared</a>();
00327 
00328     <a class="code" href="../../d7/d9/wow_8h.html#a0">StartValidateHandleMacro</a>(h)
00329     <a class="code" href="../../d7/d9/wow_8h.html#a3">BeginTypeValidateHandleMacro</a>(pobj, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a255">TYPE_GENERIC</a>)
00330 
00331         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/validate_8c.html#a11">IsHandleEntrySecure</a>(h, phe)) {
00332             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00333         }
00334 
00335     <a class="code" href="../../d7/d9/wow_8h.html#a4">EndTypeValidateHandleMacro</a>
00336     <a class="code" href="../../d7/d9/wow_8h.html#a5">EndValidateHandleMacro</a>
00337 
00338     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00339 }
00340 
00341 <span class="comment">/***************************************************************************\</span>
00342 <span class="comment">* ValidateHwnd</span>
00343 <span class="comment">*</span>
00344 <span class="comment">* History:</span>
00345 <span class="comment">* 08-Feb-1991 mikeke</span>
00346 <span class="comment">\***************************************************************************/</span>
00347 
<a name="l00348"></a><a class="code" href="../../d7/d3/validate_8c.html#a13">00348</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(
00349     HWND hwnd)
00350 {
00351     <a class="code" href="../../d7/d9/wow_8h.html#a0">StartValidateHandleMacro</a>(hwnd)
00352 
00353         <span class="comment">/*</span>
00354 <span class="comment">         * Now make sure the app is</span>
00355 <span class="comment">         * passing the right handle</span>
00356 <span class="comment">         * type for this api. If the</span>
00357 <span class="comment">         * handle is TYPE_FREE, this'll</span>
00358 <span class="comment">         * catch it.</span>
00359 <span class="comment">         */</span>
00360         <span class="keywordflow">if</span> (phe-&gt;bType == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a>) {
00361 
00362             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00363 
00364             <span class="comment">/*</span>
00365 <span class="comment">             * This is called from thunks for routines in the shared critsec.</span>
00366 <span class="comment">             */</span>
00367             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndRet = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)phe-&gt;phead;
00368 
00369             <span class="comment">/*</span>
00370 <span class="comment">             * This test establishes that the window belongs to the current</span>
00371 <span class="comment">             * 'desktop'.. The two exceptions are for the desktop-window of</span>
00372 <span class="comment">             * the current desktop, which ends up belonging to another desktop,</span>
00373 <span class="comment">             * and when pti-&gt;rpdesk is NULL.  This last case happens for</span>
00374 <span class="comment">             * initialization of TIF_SYSTEMTHREAD threads (ie. console windows).</span>
00375 <span class="comment">             * IanJa doesn't know if we should be test TIF_CSRSSTHREAD here, but</span>
00376 <span class="comment">             * JohnC thinks the whole test below is no longer required ??? LATER</span>
00377 <span class="comment">             */</span>
00378 
00379             <span class="keywordflow">if</span> (pwndRet != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00380                 <span class="keywordflow">if</span> (phe-&gt;bFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>) {
00381                     RIPERR2(ERROR_INVALID_WINDOW_HANDLE,
00382                         RIP_WARNING,<span class="stringliteral">"ValidateHwnd, hwnd %#p, pwnd %#p already destroyed\n"</span>,
00383                             hwnd, pwndRet);
00384                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00385                 }
00386                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndRet) == pti ||
00387                        (
00388                         (pwndRet-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> ||
00389                          (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>) ||  <span class="comment">// | TIF_CSRSSTHREAD I think</span>
00390                          <a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, pwndRet-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk) !=
00391                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00392 
00393                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a382">IS_THREAD_RESTRICTED</a>(pti, JOB_OBJECT_UILIMIT_HANDLES)) {
00394 
00395                         <span class="comment">/*</span>
00396 <span class="comment">                         * make sure this window belongs to this process</span>
00397 <span class="comment">                         */</span>
00398                         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d3/validate_8c.html#a11">IsHandleEntrySecure</a>(hwnd, phe)) {
00399                             RIPERR1(ERROR_INVALID_WINDOW_HANDLE,
00400                                     RIP_WARNING,
00401                                     <span class="stringliteral">"ValidateHwnd: Invalid hwnd (%#p) for restricted process\n"</span>,
00402                                     hwnd);
00403                             pwndRet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00404                         }
00405                     }
00406                     <span class="keywordflow">return</span> pwndRet;
00407                 }
00408             }
00409         }
00410 
00411     <a class="code" href="../../d7/d9/wow_8h.html#a5">EndValidateHandleMacro</a>
00412 
00413     RIPERR1(ERROR_INVALID_WINDOW_HANDLE,
00414             RIP_WARNING,
00415             <span class="stringliteral">"ValidateHwnd: Invalid hwnd (%#p)"</span>,
00416             hwnd);
00417     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00418 }
00419 
00420 <span class="comment">/*</span>
00421 <span class="comment"> * Switch back to default optimization.</span>
00422 <span class="comment"> */</span>
00423 <span class="preprocessor">#pragma optimize("", on)</span>
00424 <span class="preprocessor"></span>
00425 <span class="comment">/******************************Public*Routine******************************\</span>
00426 <span class="comment">*</span>
00427 <span class="comment">* UserCritSec routines</span>
00428 <span class="comment">*</span>
00429 <span class="comment">* Exposes an opaque interface to the user critical section for</span>
00430 <span class="comment">* the WNDOBJ code in GRE</span>
00431 <span class="comment">*</span>
00432 <span class="comment">* Exposed as functions because they aren't time critical and it</span>
00433 <span class="comment">* insulates GRE from rebuilding if the definitions of Enter/LeaveCrit change</span>
00434 <span class="comment">*</span>
00435 <span class="comment">* History:</span>
00436 <span class="comment">*  Wed Sep 20 11:19:14 1995 -by-    Drew Bliss [drewb]</span>
00437 <span class="comment">*   Created</span>
00438 <span class="comment">*</span>
00439 <span class="comment">\**************************************************************************/</span>
00440 
00441 <span class="preprocessor">#if DBG</span>
00442 <span class="preprocessor"></span>
00443 <span class="preprocessor">#if defined(_X86_)</span>
00444 <span class="preprocessor"></span>
00445 <span class="preprocessor">    #define GetCallStack()  \</span>
00446 <span class="preprocessor">    {                                                               \</span>
00447 <span class="preprocessor">        ULONG Hash;                                                 \</span>
00448 <span class="preprocessor">                                                                    \</span>
00449 <span class="preprocessor">        gCritStack.thread  = PsGetCurrentThread();                  \</span>
00450 <span class="preprocessor">        gCritStack.nFrames = GetStackTrace(1,                       \</span>
00451 <span class="preprocessor">                                           MAX_STACK_CALLS,         \</span>
00452 <span class="preprocessor">                                           gCritStack.trace,        \</span>
00453 <span class="preprocessor">                                           &amp;Hash);                  \</span>
00454 <span class="preprocessor">    }</span>
00455 <span class="preprocessor"></span>
00456 <span class="preprocessor">    #define FlushCallStack()    \</span>
00457 <span class="preprocessor">    {                                                               \</span>
00458 <span class="preprocessor">        gCritStack.thread  = NULL;                                  \</span>
00459 <span class="preprocessor">        gCritStack.nFrames = 0;                                     \</span>
00460 <span class="preprocessor">    }</span>
00461 <span class="preprocessor"></span>
00462 <span class="preprocessor">#else // defined(_X86_)</span>
00463 <span class="preprocessor"></span>
00464 <span class="preprocessor">    #define GetCallStack()</span>
00465 <span class="preprocessor"></span><span class="preprocessor">    #define FlushCallStack()</span>
00466 <span class="preprocessor"></span>
00467 <span class="preprocessor">#endif // defined(_X86_)</span>
00468 <span class="preprocessor"></span>
00469 
00470 <span class="preprocessor">#endif // DBG</span>
00471 <span class="preprocessor"></span>
<a name="l00472"></a><a class="code" href="../../d7/d3/validate_8c.html#a14">00472</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d3/validate_8c.html#a14">UserEnterUserCritSec</a>(VOID)
00473 {
00474     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00475 }
00476 
<a name="l00477"></a><a class="code" href="../../d7/d3/validate_8c.html#a15">00477</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d3/validate_8c.html#a15">UserLeaveUserCritSec</a>(VOID)
00478 {
00479     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00480 }
00481 
00482 <span class="preprocessor">#if DBG</span>
00483 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> UserAssertUserCritSecIn(VOID)
00484 {
00485     <a class="code" href="../../d4/d1/userk_8h.html#a1254">_AssertCritInShared</a>();
00486 }
00487 
00488 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> UserAssertUserCritSecOut(VOID)
00489 {
00490     <a class="code" href="../../d4/d1/userk_8h.html#a1255">_AssertCritOut</a>();
00491 }
00492 <span class="preprocessor">#endif // DBG</span>
00493 <span class="preprocessor"></span>
<a name="l00494"></a><a class="code" href="../../d7/d3/validate_8c.html#a16">00494</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d3/validate_8c.html#a16">UserGetCurrentDesktopId</a>(DWORD* pdwDesktopId)
00495 {
00496     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesktop;
00497 
00498     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00499 
00500     <span class="comment">/*</span>
00501 <span class="comment">     * PtiCurrent()-&gt;rpdesk can be NULL !!! (in the case of thread shutdown).</span>
00502 <span class="comment">     */</span>
00503 
00504     pdesktop = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk;
00505 
00506     <span class="keywordflow">if</span> (pdesktop != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
00507         RIPMSG0(RIP_WARNING, <span class="stringliteral">"UserGetCurrentDesktopId on wrong desktop pdesk\n"</span>);
00508         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00509     }
00510 
00511     *pdwDesktopId = pdesktop-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o5">dwDesktopId</a>;
00512 
00513     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00514 }
00515 
00516 <span class="preprocessor">#if 0</span>
00517 <span class="preprocessor"></span>
00518 <span class="comment">//</span>
00519 <span class="comment">// Temporary arrays used to track critsec frees</span>
00520 <span class="comment">//</span>
00521 
00522 <span class="preprocessor">#define ARRAY_SIZE 20</span>
00523 <span class="preprocessor"></span><span class="preprocessor">#define LEAVE_TYPE 0xf00d0000</span>
00524 <span class="preprocessor"></span><span class="preprocessor">#define ENTER_TYPE 0x0000dead</span>
00525 <span class="preprocessor"></span>
00526 <span class="keyword">typedef</span> <span class="keyword">struct </span>_DEBUG_STASHCS {
00527     RTL_CRITICAL_SECTION <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
00528     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Type;
00529 } DEBUG_STASHCS, *PDEBUG_STASHCS;
00530 
00531 DEBUG_STASHCS UserSrvArray[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>];
00532 
00533 ULONG UserSrvIndex;
00534 
00535 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00536 DumpArray(
00537     HANDLE hCurrentProcess,
00538     HANDLE hCurrentThread,
00539     DWORD dwCurrentPc,
00540     PNTSD_EXTENSION_APIS lpExtensionApis,
00541     LPSTR lpArgumentString,
00542     LPDWORD IndexAddress,
00543     LPDWORD ArrayAddress
00544     )
00545 {
00546     PNTSD_OUTPUT_ROUTINE Print;
00547     PNTSD_GET_EXPRESSION EvalExpression;
00548     PNTSD_GET_SYMBOL GetSymbol;
00549 
00550     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
00551     <span class="keywordtype">int</span> InitialIndex;
00552     PDEBUG_STASHCS Array;
00553     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> b;
00554     PRTL_CRITICAL_SECTION CriticalSection;
00555     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Symbol[64], Symbol2[64];
00556     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Displacement, Displacement2;
00557     <span class="keywordtype">int</span> Position;
00558     LPSTR p;
00559 
00560     DBG_UNREFERENCED_PARAMETER(hCurrentThread);
00561     DBG_UNREFERENCED_PARAMETER(dwCurrentPc);
00562 
00563     Print = lpExtensionApis-&gt;lpOutputRoutine;
00564     EvalExpression = lpExtensionApis-&gt;lpGetExpressionRoutine;
00565     GetSymbol = lpExtensionApis-&gt;lpGetSymbolRoutine;
00566 
00567     p = lpArgumentString;
00568 
00569     <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = 0;
00570 
00571     <span class="keywordflow">if</span> ( *p ) {
00572         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = EvalExpression(p);
00573         }
00574     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> == 0 || <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a> ) {
00575         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = 10;
00576         }
00577 
00578     <span class="comment">//</span>
00579     <span class="comment">// Get the Current Index and the array.</span>
00580     <span class="comment">//</span>
00581 
00582     b = ReadProcessMemory(
00583             hCurrentProcess,
00584             (LPVOID)IndexAddress,
00585             &amp;InitialIndex,
00586             <span class="keyword">sizeof</span>(InitialIndex),
00587             NULL
00588             );
00589     <span class="keywordflow">if</span> ( !b ) {
00590         <span class="keywordflow">return</span>;
00591         }
00592 
00593     Array = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, <span class="keyword">sizeof</span>(UserSrvArray));
00594     <span class="keywordflow">if</span> ( !Array ) {
00595         <span class="keywordflow">return</span>;
00596         }
00597 
00598     b = ReadProcessMemory(
00599             hCurrentProcess,
00600             (LPVOID)ArrayAddress,
00601             Array,
00602             <span class="keyword">sizeof</span>(UserSrvArray),
00603             NULL
00604             );
00605     <span class="keywordflow">if</span> ( !b ) {
00606         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, Array);
00607         <span class="keywordflow">return</span>;
00608         }
00609 
00610     Position = 0;
00611     <span class="keywordflow">while</span> ( <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> ) {
00612         InitialIndex--;
00613         <span class="keywordflow">if</span> ( InitialIndex &lt; 0 ) {
00614             InitialIndex = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>-1;
00615             }
00616 
00617         <span class="keywordflow">if</span> (Array[InitialIndex].Type == LEAVE_TYPE ) {
00618             (Print)(<span class="stringliteral">"\n(%d) LEAVING Critical Section \n"</span>, Position);
00619             } <span class="keywordflow">else</span> {
00620             (Print)(<span class="stringliteral">"\n(%d) ENTERING Critical Section \n"</span>, Position);
00621             }
00622 
00623         CriticalSection = &amp;Array[InitialIndex].Lock;
00624 
00625         <span class="keywordflow">if</span> ( CriticalSection-&gt;LockCount == -1) {
00626             (Print)(<span class="stringliteral">"\tLockCount NOT LOCKED\n"</span>);
00627             } <span class="keywordflow">else</span> {
00628             (Print)(<span class="stringliteral">"\tLockCount %ld\n"</span>, CriticalSection-&gt;LockCount);
00629             }
00630         (Print)(<span class="stringliteral">"\tRecursionCount %ld\n"</span>, CriticalSection-&gt;RecursionCount);
00631         (Print)(<span class="stringliteral">"\tOwningThread %lx\n"</span>, CriticalSection-&gt;OwningThread );
00632 <span class="preprocessor">#if DBG</span>
00633 <span class="preprocessor"></span>        (GetSymbol)(CriticalSection-&gt;OwnerBackTrace[ 0 ], Symbol, &amp;Displacement);
00634         (GetSymbol)(CriticalSection-&gt;OwnerBackTrace[ 1 ], Symbol2, &amp;Displacement2);
00635         (Print)(<span class="stringliteral">"\tCalling Address %s+%lx\n"</span>, Symbol, Displacement);
00636         (Print)(<span class="stringliteral">"\tCallers Caller %s+%lx\n"</span>, Symbol2, Displacement2);
00637 <span class="preprocessor">#endif // DBG</span>
00638 <span class="preprocessor"></span>        Position--;
00639         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>--;
00640         }
00641     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, Array);
00642 }
00643 
00644 
00645 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00646 dsrv(
00647     HANDLE hCurrentProcess,
00648     HANDLE hCurrentThread,
00649     DWORD dwCurrentPc,
00650     PNTSD_EXTENSION_APIS lpExtensionApis,
00651     LPSTR lpArgumentString
00652     )
00653 {
00654     DumpArray(
00655         hCurrentProcess,
00656         hCurrentThread,
00657         dwCurrentPc,
00658         lpExtensionApis,
00659         lpArgumentString,
00660         &amp;UserSrvIndex,
00661         (LPDWORD)&amp;UserSrvArray[0]
00662         );
00663 }
00664 
00665 <span class="preprocessor">#endif // if 0</span>
00666 <span class="preprocessor"></span>
00667 <span class="preprocessor">#if DBG</span>
00668 <span class="preprocessor"></span>
00669 <span class="preprocessor">#ifdef EXTRAHEAPCHECKING</span>
00670 <span class="preprocessor"></span>
00671 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> ValidateUserHeaps( VOID )
00672 {
00673     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>  pwinsta;
00674     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
00675 
00676     <span class="keywordflow">for</span> (pwinsta = grpwinstaList; pwinsta; pwinsta = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>) {
00677         <span class="keywordflow">for</span> (pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk; pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>) {
00678             <span class="keywordflow">if</span> (!wcscmp(pdesk-&gt;lpszDeskName, L<span class="stringliteral">"Default"</span>)) {
00679                 <a class="code" href="../../d5/d9/heapdll_8c.html#a32">RtlValidateHeap</a>(Win32HeapGetHandle(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>), 0, NULL);  <span class="comment">// desktop heaps</span>
00680             }
00681         }
00682     }
00683 }
00684 
00685 <span class="preprocessor">#endif // EXTRAHEAPCHECKING</span>
00686 <span class="preprocessor"></span>
00687 <span class="comment">/***************************************************************************\</span>
00688 <span class="comment">* _EnterCrit</span>
00689 <span class="comment">* _LeaveCrit</span>
00690 <span class="comment">*</span>
00691 <span class="comment">* These are temporary routines that are used by USER.DLL until the critsect,</span>
00692 <span class="comment">* validation, mapping code is moved to the server-side stubs generated by</span>
00693 <span class="comment">* SMeans' Thank compiler.</span>
00694 <span class="comment">*</span>
00695 <span class="comment">* History:</span>
00696 <span class="comment">* 01-02-91 DarrinM      Created.</span>
00697 <span class="comment">\***************************************************************************/</span>
00698 
00699 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1252">_AssertCritIn</a>()
00700 {
00701     UserAssert(gpresUser != NULL);
00702     UserAssert(<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(gpresUser) == TRUE);
00703 }
00704 
00705 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1253">_AssertDeviceInfoListCritIn</a>()
00706 {
00707     UserAssert(gpresDeviceInfoList != NULL);
00708     UserAssert(<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(gpresDeviceInfoList) == TRUE);
00709 }
00710 
00711 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1254">_AssertCritInShared</a>()
00712 {
00713     UserAssert(gpresUser != NULL);
00714     UserAssert( (<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(gpresUser) == TRUE) ||
00715             (<a class="code" href="../../d5/d8/ex_8h.html#a282">ExIsResourceAcquiredSharedLite</a>(gpresUser) == TRUE));
00716 }
00717 
00718 
00719 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1255">_AssertCritOut</a>()
00720 {
00721     UserAssert(gpresUser != NULL);
00722     UserAssert(<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(gpresUser) == FALSE);
00723 }
00724 
00725 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1256">_AssertDeviceInfoListCritOut</a>()
00726 {
00727     UserAssert(gpresDeviceInfoList != NULL);
00728     UserAssert(<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(gpresDeviceInfoList) == FALSE);
00729 }
00730 
00731 <span class="comment">/***************************************************************************\</span>
00732 <span class="comment">* BeginAtomicCheck()</span>
00733 <span class="comment">* EndAtomicCheck()</span>
00734 <span class="comment">*</span>
00735 <span class="comment">* Routine that verify we never leave the critical section and that an</span>
00736 <span class="comment">* operation is truely atomic with the possiblity of other code being run</span>
00737 <span class="comment">* because we left the critical section</span>
00738 <span class="comment">*</span>
00739 <span class="comment">\***************************************************************************/</span>
00740 
00741 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a161">BeginAtomicCheck</a>()
00742 {
00743     gdwInAtomicOperation++;
00744 }
00745 
00746 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a165">EndAtomicCheck</a>()
00747 {
00748     UserAssert(gdwInAtomicOperation &gt; 0);
00749     gdwInAtomicOperation--;
00750 }
00751 
00752 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a162">BeginAtomicDeviceInfoListCheck</a>()
00753 {
00754     gdwInAtomicDeviceInfoListOperation++;
00755 }
00756 
00757 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a166">EndAtomicDeviceInfoListCheck</a>()
00758 {
00759     UserAssert(gdwInAtomicDeviceInfoListOperation &gt; 0);
00760     gdwInAtomicDeviceInfoListOperation--;
00761 }
00762 
00763 <span class="preprocessor">#define INCCRITSECCOUNT (gdwCritSecUseCount++)</span>
00764 <span class="preprocessor"></span><span class="preprocessor">#define INCDEVICEINFOLISTCRITSECCOUNT (gdwDeviceInfoListCritSecUseCount++)</span>
00765 <span class="preprocessor"></span>
00766 <span class="preprocessor">#else // else DBG</span>
00767 <span class="preprocessor"></span>
<a name="l00768"></a><a class="code" href="../../d7/d3/validate_8c.html#a2">00768</a> <span class="preprocessor">#define INCCRITSECCOUNT</span>
<a name="l00769"></a><a class="code" href="../../d7/d3/validate_8c.html#a3">00769</a> <span class="preprocessor"></span><span class="preprocessor">#define INCDEVICEINFOLISTCRITSECCOUNT</span>
00770 <span class="preprocessor"></span>
00771 <span class="preprocessor">#endif // endif DBG</span>
00772 <span class="preprocessor"></span>
<a name="l00773"></a><a class="code" href="../../d7/d3/validate_8c.html#a17">00773</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d3/validate_8c.html#a17">UserIsUserCritSecIn</a>()
00774 {
00775     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00776     <span class="keywordflow">return</span>( (<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ||
00777             (<a class="code" href="../../d5/d8/ex_8h.html#a282">ExIsResourceAcquiredSharedLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00778 
00779     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00780 }
00781 
00782 <span class="preprocessor">#if DBG</span>
00783 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d7/d3/validate_8c.html#a4">CheckDevLockOut</a>()
00784 {
00785     <span class="comment">/*</span>
00786 <span class="comment">     * gpDispInfo can be NULL if Win32UserInitialize fails before allocationg it.</span>
00787 <span class="comment">     * hDev is initialized later in InitVideo, after the critical section has been</span>
00788 <span class="comment">     *  released at least once; so we better check it too.</span>
00789 <span class="comment">     */</span>
00790     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00791         UserAssert(!GreIsDisplayLocked(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>));
00792     }
00793 }
00794 <span class="preprocessor">#else</span>
<a name="l00795"></a><a class="code" href="../../d7/d3/validate_8c.html#a4">00795</a> <span class="preprocessor"></span><span class="preprocessor">#define CheckDevLockOut()</span>
00796 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00797 <span class="preprocessor"></span>
<a name="l00798"></a><a class="code" href="../../d7/d3/validate_8c.html#a18">00798</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>(<span class="keywordtype">void</span>)
00799 {
00800     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
00801     <a class="code" href="../../d4/d1/userk_8h.html#a158">CheckDeviceInfoListCritOut</a>();
00802     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00803     <a class="code" href="../../d5/d8/ex_8h.html#a269">ExAcquireResourceExclusiveLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00804     <a class="code" href="../../d7/d3/validate_8c.html#a4">CheckDevLockOut</a>();
00805     UserAssert(!<a class="code" href="../../d4/d1/userk_8h.html#a168">ISATOMICCHECK</a>());
00806     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a246">gptiCurrent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00807     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a246">gptiCurrent</a> = ((<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)(W32GetCurrentThread()));
00808     <a class="code" href="../../d7/d3/validate_8c.html#a2">INCCRITSECCOUNT</a>;
00809 <span class="preprocessor">#if defined (USER_PERFORMANCE)</span>
00810 <span class="preprocessor"></span>    {
00811         __int64 i64Frecv;
00812         *(LARGE_INTEGER*)(&amp;<a class="code" href="../../d7/d3/validate_8c.html#a5">gCSTimeExclusiveWhenEntering</a>) = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>((LARGE_INTEGER*)&amp;i64Frecv);
00813         InterlockedIncrement(&amp;gCSStatistics.cExclusive);
00814     }
00815 <span class="preprocessor">#endif // (USER_PERFORMANCE)</span>
00816 <span class="preprocessor"></span>
00817 <span class="preprocessor">#if DBG</span>
00818 <span class="preprocessor"></span>    GetCallStack();
00819 <span class="preprocessor">#endif // DBG</span>
00820 <span class="preprocessor"></span>}
00821 
00822 <span class="preprocessor">#if DBG</span>
00823 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>(<span class="keywordtype">void</span>)
00824 {
00825     <a class="code" href="../../d4/d1/userk_8h.html#a158">CheckDeviceInfoListCritOut</a>();
00826     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00827     <a class="code" href="../../d5/d8/ex_8h.html#a269">ExAcquireResourceExclusiveLite</a>(gpresDeviceInfoList, TRUE);
00828     UserAssert(!<a class="code" href="../../d4/d1/userk_8h.html#a169">ISATOMICDEVICEINFOLISTCHECK</a>());
00829     <a class="code" href="../../d7/d3/validate_8c.html#a3">INCDEVICEINFOLISTCRITSECCOUNT</a>;
00830 }
00831 <span class="preprocessor">#endif // DBG</span>
00832 <span class="preprocessor"></span>
<a name="l00833"></a><a class="code" href="../../d7/d3/validate_8c.html#a19">00833</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d3/validate_8c.html#a19">EnterSharedCrit</a>(<span class="keywordtype">void</span>)
00834 {
00835     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00836     <a class="code" href="../../d5/d8/ex_8h.html#a268">ExAcquireResourceSharedLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00837     <a class="code" href="../../d7/d3/validate_8c.html#a4">CheckDevLockOut</a>();
00838     UserAssert(!<a class="code" href="../../d4/d1/userk_8h.html#a168">ISATOMICCHECK</a>());
00839 <span class="preprocessor">#if defined (USER_PERFORMANCE)</span>
00840 <span class="preprocessor"></span>    InterlockedIncrement(&amp;gCSStatistics.cShared);
00841 <span class="preprocessor">#endif // (USER_PERFORMANCE)</span>
00842 <span class="preprocessor"></span>
00843     <a class="code" href="../../d7/d3/validate_8c.html#a2">INCCRITSECCOUNT</a>;
00844 }
00845 
<a name="l00846"></a><a class="code" href="../../d7/d3/validate_8c.html#a20">00846</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>(<span class="keywordtype">void</span>)
00847 {
00848     <a class="code" href="../../d7/d3/validate_8c.html#a2">INCCRITSECCOUNT</a>;
00849 <span class="preprocessor">#if DBG</span>
00850 <span class="preprocessor"></span>    UserAssert(!<a class="code" href="../../d4/d1/userk_8h.html#a168">ISATOMICCHECK</a>());
00851     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00852     <a class="code" href="../../d7/d3/validate_8c.html#a4">CheckDevLockOut</a>();
00853     FlushCallStack();
00854     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a246">gptiCurrent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00855 <span class="preprocessor">#endif // DBG</span>
00856 <span class="preprocessor"></span>
00857 <span class="preprocessor">#if defined (USER_PERFORMANCE)</span>
00858 <span class="preprocessor"></span>    <span class="comment">/*</span>
00859 <span class="comment">     * A non null gCSTimeExclusiveWhenEntering means the</span>
00860 <span class="comment">     * critical section is owned exclusive</span>
00861 <span class="comment">     */</span>
00862     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/validate_8c.html#a5">gCSTimeExclusiveWhenEntering</a>) {
00863         __int64 i64Temp, i64Frecv;
00864 
00865         *(LARGE_INTEGER*)(&amp;i64Temp) = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>((LARGE_INTEGER*)&amp;i64Frecv);
00866         gCSStatistics.i64TimeExclusive += i64Temp - <a class="code" href="../../d7/d3/validate_8c.html#a5">gCSTimeExclusiveWhenEntering</a>;
00867         <a class="code" href="../../d7/d3/validate_8c.html#a5">gCSTimeExclusiveWhenEntering</a> = 0;
00868     }
00869 <span class="preprocessor">#endif // (USER_PERFORMANCE)</span>
00870 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>);
00871     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00872     <a class="code" href="../../d4/d1/userk_8h.html#a157">CheckCritOut</a>();
00873 }
00874 
00875 <span class="preprocessor">#if DBG</span>
00876 <span class="preprocessor"></span><span class="keywordtype">void</span> _LeaveDeviceInfoListCrit(<span class="keywordtype">void</span>)
00877 {
00878     <a class="code" href="../../d7/d3/validate_8c.html#a3">INCDEVICEINFOLISTCRITSECCOUNT</a>;
00879     UserAssert(!<a class="code" href="../../d4/d1/userk_8h.html#a169">ISATOMICDEVICEINFOLISTCHECK</a>());
00880 
00881     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(gpresDeviceInfoList);
00882     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00883     <a class="code" href="../../d4/d1/userk_8h.html#a158">CheckDeviceInfoListCritOut</a>();
00884 }
00885 <span class="preprocessor">#endif // DBG</span>
00886 <span class="preprocessor"></span>
<a name="l00887"></a><a class="code" href="../../d7/d3/validate_8c.html#a21">00887</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d3/validate_8c.html#a21">ChangeAcquireResourceType</a>(
00888     VOID)
00889 {
00890 <span class="preprocessor">#if DBG</span>
00891 <span class="preprocessor"></span>    FlushCallStack();
00892     <a class="code" href="../../d7/d3/validate_8c.html#a4">CheckDevLockOut</a>();
00893     UserAssert(!<a class="code" href="../../d4/d1/userk_8h.html#a168">ISATOMICCHECK</a>());
00894 <span class="preprocessor">#endif // DBG</span>
00895 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>);
00896     <a class="code" href="../../d5/d8/ex_8h.html#a269">ExAcquireResourceExclusiveLite</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00897     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a246">gptiCurrent</a> = ((<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)(W32GetCurrentThread()));
00898 <span class="preprocessor">#if DBG</span>
00899 <span class="preprocessor"></span>    GetCallStack();
00900 <span class="preprocessor">#endif // DBG</span>
00901 <span class="preprocessor"></span>}
00902 
00903 
00904 <span class="preprocessor">#if DBG</span>
00905 <span class="preprocessor"></span>
00906 <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> <a class="code" href="../../d4/d1/userk_8h.html#a780">_ptiCrit</a>(<span class="keywordtype">void</span>)
00907 {
00908     UserAssert(gpresUser);
00909     UserAssert(<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(gpresUser) == TRUE);
00910     UserAssert(gptiCurrent);
00911     UserAssert(gptiCurrent == ((<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)(W32GetCurrentThread())));
00912     UserAssert(gptiCurrent);
00913     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a246">gptiCurrent</a>;
00914 }
00915 
00916 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a951">PTHREADINFO</a> <a class="code" href="../../d4/d1/userk_8h.html#a781">_ptiCritShared</a>(<span class="keywordtype">void</span>)
00917 {
00918     UserAssert(W32GetCurrentThread());
00919     <span class="keywordflow">return</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a951">PTHREADINFO</a>)(W32GetCurrentThread()));
00920 }
00921 
00922 <span class="preprocessor">#undef KeUserModeCallback</span>
00923 <span class="preprocessor"></span>
00924 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00925 <a class="code" href="../../d4/d1/userk_8h.html#a1257">_KeUserModeCallback</a> (
00926     IN ULONG ApiNumber,
00927     IN PVOID InputBuffer,
00928     IN ULONG InputLength,
00929     OUT PVOID *OutputBuffer,
00930     OUT PULONG OutputLength
00931     )
00932 {
00933 
00934     UserAssert(<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(gpresUser) == FALSE);
00935 
00936     <span class="comment">/*</span>
00937 <span class="comment">     * Added this so we can detect an erroneous user mode callback</span>
00938 <span class="comment">     * with a checked win32k on top of a free system.</span>
00939 <span class="comment">     */</span>
00940     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetPreviousMode() == UserMode);
00941 
00942     <span class="keywordflow">return</span> <a class="code" href="../../d7/d4/ke_2ppc_2callback_8c.html#a0">KeUserModeCallback</a>( ApiNumber, InputBuffer, InputLength,
00943             OutputBuffer, OutputLength);
00944 }
00945 
00946 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:21 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
