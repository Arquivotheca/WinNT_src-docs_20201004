<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokenopn.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokenopn.c</h1><a href="../../d7/d3/tokenopn_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    tokenopn.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This module implements the open thread and process token services.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Jim Kelly (JimK) 2-Aug-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="comment">//#ifndef TOKEN_DEBUG</span>
00026 <span class="comment">//#define TOKEN_DEBUG</span>
00027 <span class="comment">//#endif</span>
00028 
00029 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00030 <span class="preprocessor">#include "seopaque.h"</span>
00031 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/tokenp_8h.html">tokenp.h</a>"</span>
00032 
00033 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00034 <a class="code" href="../../d7/d3/tokenopn_8c.html#a0">SepCreateImpersonationTokenDacl</a>(
00035     IN PTOKEN Token,
00036     IN PACCESS_TOKEN PrimaryToken,
00037     OUT PACL *Acl
00038     );
00039 
00040 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtOpenProcessToken)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtOpenThreadToken)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepCreateImpersonationTokenDacl)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span>
00046 
00047 
00048 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00049"></a><a class="code" href="../../d7/d3/tokenopn_8c.html#a0">00049</a> <a class="code" href="../../d7/d3/tokenopn_8c.html#a0">SepCreateImpersonationTokenDacl</a>(
00050     IN PTOKEN Token,
00051     IN PACCESS_TOKEN PrimaryToken,
00052     OUT PACL *Acl
00053     )
00054 <span class="comment">/*++</span>
00055 <span class="comment"></span>
00056 <span class="comment">Routine Description:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    This routine modifies the DACL protecting the passed token to allow</span>
00059 <span class="comment">    the current user (described by the PrimaryToken parameter) full access.</span>
00060 <span class="comment">    This permits callers of NtOpenThreadToken to call with OpenAsSelf==TRUE</span>
00061 <span class="comment">    and succeed.</span>
00062 <span class="comment"></span>
00063 <span class="comment">    The new DACL placed on the token is as follows:</span>
00064 <span class="comment"></span>
00065 <span class="comment">    ACE 0 - Server gets TOKEN_ALL_ACCESS</span>
00066 <span class="comment"></span>
00067 <span class="comment">    ACE 1 - Client gets TOKEN_ALL_ACCESS</span>
00068 <span class="comment"></span>
00069 <span class="comment">    ACE 2 - Admins gets TOKEN_ALL_ACCESS</span>
00070 <span class="comment"></span>
00071 <span class="comment">    ACE 3 - System gets TOKEN_ALL_ACCESS</span>
00072 <span class="comment"></span>
00073 <span class="comment">    ACE 4 - Restricted gets TOKEN_ALL_ACCESS</span>
00074 <span class="comment"></span>
00075 <span class="comment"></span>
00076 <span class="comment">Arguments:</span>
00077 <span class="comment"></span>
00078 <span class="comment">    Token - The token whose protection is to be modified.</span>
00079 <span class="comment"></span>
00080 <span class="comment">    PrimaryToken - Token representing the subject to be granted access.</span>
00081 <span class="comment"></span>
00082 <span class="comment">    Acl - Returns the modified ACL, allocated out of PagedPool.</span>
00083 <span class="comment"></span>
00084 <span class="comment"></span>
00085 <span class="comment">Return Value:</span>
00086 <span class="comment"></span>
00087 <span class="comment"></span>
00088 <span class="comment">--*/</span>
00089 
00090 {
00091     PSID ServerUserSid;
00092     PSID ClientUserSid;
00093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00094     ULONG AclLength;
00095     PACL NewDacl;
00096     PSECURITY_DESCRIPTOR OldDescriptor;
00097     BOOLEAN MemoryAllocated;
00098     PACL OldDacl;
00099     BOOLEAN DaclPresent;
00100     BOOLEAN DaclDefaulted;
00101 
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00103 
00104     ServerUserSid = ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>)-&gt;UserAndGroups[0].Sid;
00105 
00106     ClientUserSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[0].Sid;
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Compute how much space we'll need for the new DACL.</span>
00110     <span class="comment">//</span>
00111 
00112     AclLength = 5 * <span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - 5 * <span class="keyword">sizeof</span>( ULONG ) +
00113                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( ServerUserSid ) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a> ) +
00114                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( ClientUserSid ) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a> ) +
00115                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a57">SeRestrictedSid</a> ) + <span class="keyword">sizeof</span>( ACL );
00116 
00117     NewDacl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AclLength );
00118 
00119     <span class="keywordflow">if</span> (NewDacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00120 
00121         *Acl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00122         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00123     }
00124 
00125     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( NewDacl, AclLength, ACL_REVISION2 );
00126     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00127 
00128     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00129                  NewDacl,
00130                  ACL_REVISION2,
00131                  TOKEN_ALL_ACCESS,
00132                  ServerUserSid
00133                  );
00134     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00135 
00136     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00137                  NewDacl,
00138                  ACL_REVISION2,
00139                  TOKEN_ALL_ACCESS,
00140                  ClientUserSid
00141                  );
00142     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00143 
00144     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00145                  NewDacl,
00146                  ACL_REVISION2,
00147                  TOKEN_ALL_ACCESS,
00148                  <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>
00149                  );
00150     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00151 
00152     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00153                  NewDacl,
00154                  ACL_REVISION2,
00155                  TOKEN_ALL_ACCESS,
00156                  <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>
00157                  );
00158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00159 
00160     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>)-&gt;RestrictedSids) ||
00161        ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids)) {
00162         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00163                      NewDacl,
00164                      ACL_REVISION2,
00165                      TOKEN_ALL_ACCESS,
00166                      <a class="code" href="../../d0/d5/se_8h.html#a57">SeRestrictedSid</a>
00167                      );
00168         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00169     }
00170 
00171     *Acl = NewDacl;
00172     <span class="keywordflow">return</span> STATUS_SUCCESS;
00173 }
00174 
00175 
00176 
00177 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00178"></a><a class="code" href="../../d7/d3/tokenopn_8c.html#a1">00178</a> <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
00179     IN HANDLE ProcessHandle,
00180     IN ACCESS_MASK DesiredAccess,
00181     OUT PHANDLE TokenHandle
00182     )
00183 
00184 <span class="comment">/*++</span>
00185 <span class="comment"></span>
00186 <span class="comment">Routine Description:</span>
00187 <span class="comment"></span>
00188 <span class="comment">    Open a token object associated with a process and return a handle</span>
00189 <span class="comment">    that may be used to access that token.</span>
00190 <span class="comment"></span>
00191 <span class="comment">Arguments:</span>
00192 <span class="comment"></span>
00193 <span class="comment">    ProcessHandle - Specifies the process whose token is to be</span>
00194 <span class="comment">        opened.</span>
00195 <span class="comment"></span>
00196 <span class="comment">    DesiredAccess - Is an access mask indicating which access types</span>
00197 <span class="comment">        are desired to the token.  These access types are reconciled</span>
00198 <span class="comment">        with the Discretionary Access Control list of the token to</span>
00199 <span class="comment">        determine whether the accesses will be granted or denied.</span>
00200 <span class="comment"></span>
00201 <span class="comment">    TokenHandle - Receives the handle of the newly opened token.</span>
00202 <span class="comment"></span>
00203 <span class="comment">Return Value:</span>
00204 <span class="comment"></span>
00205 <span class="comment">    STATUS_SUCCESS - Indicates the operation was successful.</span>
00206 <span class="comment"></span>
00207 <span class="comment">--*/</span>
00208 {
00209 
00210     PVOID <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00211     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00212     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00213 
00214     HANDLE LocalHandle;
00215 
00216     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00217 
00218     PreviousMode = KeGetPreviousMode();
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">//  Probe parameters</span>
00222     <span class="comment">//</span>
00223 
00224     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00225 
00226         <span class="keywordflow">try</span> {
00227 
00228             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(TokenHandle);
00229 
00230         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00231             <span class="keywordflow">return</span> GetExceptionCode();
00232         }  <span class="comment">// end_try</span>
00233 
00234     } <span class="comment">//end_if</span>
00235 
00236 
00237     <span class="comment">//</span>
00238     <span class="comment">// Valdiate access to the process and obtain a pointer to the</span>
00239     <span class="comment">// process's token.  If successful, this will cause the token's</span>
00240     <span class="comment">// reference count to be incremented.</span>
00241     <span class="comment">//</span>
00242 
00243     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a4">PsOpenTokenOfProcess</a>( ProcessHandle, ((PACCESS_TOKEN *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>));
00244 
00245     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00246         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00247     }
00248 
00249     <span class="comment">//</span>
00250     <span class="comment">//  Now try to open the token for the specified desired access</span>
00251     <span class="comment">//</span>
00252 
00253     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
00254                  (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,         <span class="comment">// Object</span>
00255                  0,                    <span class="comment">// HandleAttributes</span>
00256                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                 <span class="comment">// AccessState</span>
00257                  DesiredAccess,        <span class="comment">// DesiredAccess</span>
00258                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,   <span class="comment">// ObjectType</span>
00259                  PreviousMode,         <span class="comment">// AccessMode</span>
00260                  &amp;LocalHandle          <span class="comment">// Handle</span>
00261                  );
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">//  And decrement the reference count of the token to counter</span>
00265     <span class="comment">//  the action performed by PsOpenTokenOfProcess().  If the open</span>
00266     <span class="comment">//  was successful, the handle will have caused the token's</span>
00267     <span class="comment">//  reference count to have been incremented.</span>
00268     <span class="comment">//</span>
00269 
00270     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  Return the new handle</span>
00274     <span class="comment">//</span>
00275 
00276     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00277 
00278         <span class="keywordflow">try</span> {
00279 
00280             *TokenHandle = LocalHandle;
00281 
00282         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00283 
00284             <span class="keywordflow">return</span> GetExceptionCode();
00285 
00286         }
00287     }
00288 
00289     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00290 
00291 }
00292 
00293 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00294"></a><a class="code" href="../../d7/d3/tokenopn_8c.html#a2">00294</a> <a class="code" href="../../d7/d3/tokenopn_8c.html#a2">SepOpenTokenOfThread</a>(
00295     IN HANDLE ThreadHandle,
00296     IN BOOLEAN OpenAsSelf,
00297     OUT PACCESS_TOKEN *Token,
00298     OUT <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> *Thread,
00299     OUT PBOOLEAN CopyOnOpen,
00300     OUT PBOOLEAN EffectiveOnly,
00301     OUT PSECURITY_IMPERSONATION_LEVEL ImpersonationLevel
00302     )
00303 
00304 <span class="comment">/*++</span>
00305 <span class="comment"></span>
00306 <span class="comment">Routine Description:</span>
00307 <span class="comment"></span>
00308 <span class="comment">    This function does the thread specific processing of</span>
00309 <span class="comment">    an NtOpenThreadToken() service.</span>
00310 <span class="comment"></span>
00311 <span class="comment">    The service validates that the handle has appropriate access</span>
00312 <span class="comment">    to reference the thread.  If so, it goes on to increment</span>
00313 <span class="comment">    the reference count of the token object to prevent it from</span>
00314 <span class="comment">    going away while the rest of the NtOpenThreadToken() request</span>
00315 <span class="comment">    is processed.</span>
00316 <span class="comment"></span>
00317 <span class="comment">    NOTE: If this call completes successfully, the caller is responsible</span>
00318 <span class="comment">          for decrementing the reference count of the target token.</span>
00319 <span class="comment">          This must be done using PsDereferenceImpersonationToken().</span>
00320 <span class="comment"></span>
00321 <span class="comment">Arguments:</span>
00322 <span class="comment"></span>
00323 <span class="comment">    ThreadHandle - Supplies a handle to a thread object.</span>
00324 <span class="comment"></span>
00325 <span class="comment">    OpenAsSelf - Is a boolean value indicating whether the access should</span>
00326 <span class="comment">        be made using the calling thread's current security context, which</span>
00327 <span class="comment">        may be that of a client (if impersonating), or using the caller's</span>
00328 <span class="comment">        process-level security context.  A value of FALSE indicates the</span>
00329 <span class="comment">        caller's current context should be used un-modified.  A value of</span>
00330 <span class="comment">        TRUE indicates the request should be fulfilled using the process</span>
00331 <span class="comment">        level security context.</span>
00332 <span class="comment"></span>
00333 <span class="comment">    Token - If successful, receives a pointer to the thread's token</span>
00334 <span class="comment">        object.</span>
00335 <span class="comment"></span>
00336 <span class="comment">    CopyOnOpen - The current value of the Thread-&gt;Client-&gt;CopyOnOpen field.</span>
00337 <span class="comment"></span>
00338 <span class="comment">    EffectiveOnly - The current value of the Thread-&gt;Client-&gt;EffectiveOnly field.</span>
00339 <span class="comment"></span>
00340 <span class="comment">    ImpersonationLevel - The current value of the Thread-&gt;Client-&gt;ImpersonationLevel</span>
00341 <span class="comment">        field.</span>
00342 <span class="comment"></span>
00343 <span class="comment">Return Value:</span>
00344 <span class="comment"></span>
00345 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span>
00346 <span class="comment"></span>
00347 <span class="comment">    STATUS_NO_TOKEN - Indicates the referenced thread is not currently</span>
00348 <span class="comment">        impersonating a client.</span>
00349 <span class="comment"></span>
00350 <span class="comment">    STATUS_CANT_OPEN_ANONYMOUS - Indicates the client requested anonymous</span>
00351 <span class="comment">        impersonation level.  An anonymous token can not be openned.</span>
00352 <span class="comment"></span>
00353 <span class="comment">    status may also be any value returned by an attemp the reference</span>
00354 <span class="comment">    the thread object for THREAD_QUERY_INFORMATION access.</span>
00355 <span class="comment"></span>
00356 <span class="comment">--*/</span>
00357 
00358 {
00359 
00360     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00361         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00362 
00363     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
00364         PreviousMode;
00365 
00366     SE_IMPERSONATION_STATE
00367         DisabledImpersonationState;
00368 
00369     BOOLEAN
00370         RestoreImpersonationState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00371 
00372     PreviousMode = KeGetPreviousMode();
00373 
00374 
00375     <span class="comment">//</span>
00376     <span class="comment">// Disable impersonation if necessary</span>
00377     <span class="comment">//</span>
00378 
00379     <span class="keywordflow">if</span> (OpenAsSelf) {
00380          RestoreImpersonationState = <a class="code" href="../../d6/d5/ps_2security_8c.html#a7">PsDisableImpersonation</a>(
00381                                          <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00382                                          &amp;DisabledImpersonationState
00383                                          );
00384     }
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">//  Make sure the handle grants the appropriate access to the specified</span>
00388     <span class="comment">//  thread.</span>
00389     <span class="comment">//</span>
00390 
00391     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00392                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00393                  THREAD_QUERY_INFORMATION,
00394                  <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00395                  PreviousMode,
00396                  (PVOID *)Thread,
00397                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00398                  );
00399 
00400 
00401 
00402 
00403     <span class="keywordflow">if</span> (RestoreImpersonationState) {
00404         <a class="code" href="../../d6/d5/ps_2security_8c.html#a8">PsRestoreImpersonation</a>(
00405             <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00406             &amp;DisabledImpersonationState
00407             );
00408     }
00409 
00410     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00411         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00412     }
00413 
00414     <span class="comment">//</span>
00415     <span class="comment">//  Reference the impersonation token, if there is one</span>
00416     <span class="comment">//</span>
00417 
00418     (*Token) = <a class="code" href="../../d6/d5/ps_2security_8c.html#a1">PsReferenceImpersonationToken</a>( *Thread,
00419                                               CopyOnOpen,
00420                                               EffectiveOnly,
00421                                               ImpersonationLevel
00422                                               );
00423 
00424 
00425 
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Make sure there is a token</span>
00429     <span class="comment">//</span>
00430 
00431     <span class="keywordflow">if</span> ((*Token) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( *Thread );
00433         (*Thread) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00434         <span class="keywordflow">return</span> STATUS_NO_TOKEN;
00435     }
00436 
00437 
00438     <span class="comment">//</span>
00439     <span class="comment">//  Make sure the ImpersonationLevel is high enough to allow</span>
00440     <span class="comment">//  the token to be openned.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> ((*ImpersonationLevel) &lt;= SecurityAnonymous) {
00444         <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( (*<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>) );
00445         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( *Thread );
00446         (*Thread) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00447         (*Token) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00448         <span class="keywordflow">return</span> STATUS_CANT_OPEN_ANONYMOUS;
00449     }
00450 
00451 
00452     <span class="keywordflow">return</span> STATUS_SUCCESS;
00453 
00454 }
00455 
00456 
00457 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00458"></a><a class="code" href="../../d7/d3/tokenopn_8c.html#a3">00458</a> <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
00459     IN HANDLE ThreadHandle,
00460     IN ACCESS_MASK DesiredAccess,
00461     IN BOOLEAN OpenAsSelf,
00462     OUT PHANDLE TokenHandle
00463     )
00464 
00465 <span class="comment">/*++</span>
00466 <span class="comment"></span>
00467 <span class="comment"></span>
00468 <span class="comment">Routine Description:</span>
00469 <span class="comment"></span>
00470 <span class="comment">Open a token object associated with a thread and return a handle that</span>
00471 <span class="comment">may be used to access that token.</span>
00472 <span class="comment"></span>
00473 <span class="comment">Arguments:</span>
00474 <span class="comment"></span>
00475 <span class="comment">    ThreadHandle - Specifies the thread whose token is to be opened.</span>
00476 <span class="comment"></span>
00477 <span class="comment">    DesiredAccess - Is an access mask indicating which access types</span>
00478 <span class="comment">        are desired to the token.  These access types are reconciled</span>
00479 <span class="comment">        with the Discretionary Access Control list of the token to</span>
00480 <span class="comment">        determine whether the accesses will be granted or denied.</span>
00481 <span class="comment"></span>
00482 <span class="comment">    OpenAsSelf - Is a boolean value indicating whether the access should</span>
00483 <span class="comment">        be made using the calling thread's current security context, which</span>
00484 <span class="comment">        may be that of a client if impersonating, or using the caller's</span>
00485 <span class="comment">        process-level security context.  A value of FALSE indicates the</span>
00486 <span class="comment">        caller's current context should be used un-modified.  A value of</span>
00487 <span class="comment">        TRUE indicates the request should be fulfilled using the process</span>
00488 <span class="comment">        level security context.</span>
00489 <span class="comment"></span>
00490 <span class="comment">        This parameter is necessary to allow a server process to open</span>
00491 <span class="comment">        a client's token when the client specified IDENTIFICATION level</span>
00492 <span class="comment">        impersonation.  In this case, the caller would not be able to</span>
00493 <span class="comment">        open the client's token using the client's context (because you</span>
00494 <span class="comment">        can't create executive level objects using IDENTIFICATION level</span>
00495 <span class="comment">        impersonation).</span>
00496 <span class="comment"></span>
00497 <span class="comment">    TokenHandle - Receives the handle of the newly opened token.</span>
00498 <span class="comment"></span>
00499 <span class="comment">Return Value:</span>
00500 <span class="comment"></span>
00501 <span class="comment">    STATUS_SUCCESS - Indicates the operation was successful.</span>
00502 <span class="comment"></span>
00503 <span class="comment">    STATUS_NO_TOKEN - Indicates an attempt has been made to open a</span>
00504 <span class="comment">        token associated with a thread that is not currently</span>
00505 <span class="comment">        impersonating a client.</span>
00506 <span class="comment"></span>
00507 <span class="comment">    STATUS_CANT_OPEN_ANONYMOUS - Indicates the client requested anonymous</span>
00508 <span class="comment">        impersonation level.  An anonymous token can not be openned.</span>
00509 <span class="comment"></span>
00510 <span class="comment">--*/</span>
00511 {
00512 
00513     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00514     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00515 
00516     PVOID <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00517     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00518     BOOLEAN CopyOnOpen;
00519     BOOLEAN EffectiveOnly;
00520     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel;
00521     SE_IMPERSONATION_STATE DisabledImpersonationState;
00522     BOOLEAN RestoreImpersonationState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00523 
00524     HANDLE LocalHandle;
00525     SECURITY_DESCRIPTOR SecurityDescriptor;
00526     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00527     PACL NewAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00528     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00529     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> OriginalThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00530     PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
00531     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
00532 
00533     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00534 
00535     PreviousMode = KeGetPreviousMode();
00536 
00537     <span class="comment">//</span>
00538     <span class="comment">//  Probe parameters</span>
00539     <span class="comment">//</span>
00540 
00541     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00542 
00543         <span class="keywordflow">try</span> {
00544 
00545             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(TokenHandle);
00546 
00547         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00548             <span class="keywordflow">return</span> GetExceptionCode();
00549         }  <span class="comment">// end_try</span>
00550 
00551     } <span class="comment">//end_if</span>
00552 
00553     <span class="comment">//</span>
00554     <span class="comment">// Valdiate access to the thread and obtain a pointer to the</span>
00555     <span class="comment">// thread's token (if there is one).  If successful, this will</span>
00556     <span class="comment">// cause the token's reference count to be incremented.</span>
00557     <span class="comment">//</span>
00558     <span class="comment">// This routine disabled impersonation as necessary to properly</span>
00559     <span class="comment">// honor the OpenAsSelf flag.</span>
00560     <span class="comment">//</span>
00561 
00562     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a2">SepOpenTokenOfThread</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00563                                   OpenAsSelf,
00564                                   ((PACCESS_TOKEN *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>),
00565                                   &amp;OriginalThread,
00566                                   &amp;CopyOnOpen,
00567                                   &amp;EffectiveOnly,
00568                                   &amp;ImpersonationLevel
00569                                   );
00570 
00571     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00572         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00573     }
00574 
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">//  The token was successfully referenced.</span>
00578     <span class="comment">//</span>
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// We need to create and/or open a token object, so disable impersonation</span>
00582     <span class="comment">// if necessary.</span>
00583     <span class="comment">//</span>
00584 
00585     <span class="keywordflow">if</span> (OpenAsSelf) {
00586          RestoreImpersonationState = <a class="code" href="../../d6/d5/ps_2security_8c.html#a7">PsDisableImpersonation</a>(
00587                                          <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00588                                          &amp;DisabledImpersonationState
00589                                          );
00590     }
00591 
00592     <span class="comment">//</span>
00593     <span class="comment">//  If the CopyOnOpen flag is not set, then the token can be</span>
00594     <span class="comment">//  opened directly.  Otherwise, the token must be duplicated,</span>
00595     <span class="comment">//  and a handle to the duplicate returned.</span>
00596     <span class="comment">//</span>
00597 
00598     <span class="keywordflow">if</span> (CopyOnOpen) {
00599 
00600         <span class="comment">//</span>
00601         <span class="comment">// Create the new security descriptor for the token.</span>
00602         <span class="comment">//</span>
00603         <span class="comment">// We must obtain the correct SID to put into the Dacl.  Do this</span>
00604         <span class="comment">// by finding the process associated with the passed thread</span>
00605         <span class="comment">// and grabbing the User SID out of that process's token.</span>
00606         <span class="comment">// If we just use the current SubjectContext, we'll get the</span>
00607         <span class="comment">// SID of whoever is calling us, which isn't what we want.</span>
00608         <span class="comment">//</span>
00609 
00610         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00611                      <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00612                      THREAD_ALL_ACCESS,
00613                      <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00614                      <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00615                      (PVOID)&amp;Thread,
00616                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00617                      );
00618 
00619         <span class="comment">//</span>
00620         <span class="comment">// Verify that the handle is still pointer to the same thread\</span>
00621         <span class="comment">// BUGBUG: wrong error code.</span>
00622         <span class="comment">//</span>
00623 
00624         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; (Thread != OriginalThread)) {
00625             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00626         }
00627 
00628         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00629 
00630             <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(Thread-&gt;ThreadsProcess);
00631 
00632             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a0">SepCreateImpersonationTokenDacl</a>(
00633                          (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00634                          <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
00635                          &amp;NewAcl
00636                          );
00637 
00638             <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
00639 
00640             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00641 
00642                 <span class="keywordflow">if</span> (NewAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00643 
00644                     <span class="comment">//</span>
00645                     <span class="comment">// There exist tokens that either do not have security descriptors at all,</span>
00646                     <span class="comment">// or have security descriptors, but do not have DACLs.  In either case, do</span>
00647                     <span class="comment">// nothing.</span>
00648                     <span class="comment">//</span>
00649 
00650                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a> ( &amp;SecurityDescriptor, SECURITY_DESCRIPTOR_REVISION );
00651                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00652 
00653                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a> (
00654                                  &amp;SecurityDescriptor,
00655                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00656                                  NewAcl,
00657                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00658                                  );
00659 
00660                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00661                 }
00662 
00663                 InitializeObjectAttributes(
00664                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00665                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00666                     0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00667                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00668                     NewAcl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : &amp;SecurityDescriptor
00669                     );
00670 
00671                 <span class="comment">//</span>
00672                 <span class="comment">// Open a copy of the token</span>
00673                 <span class="comment">//</span>
00674 
00675                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a27">SepDuplicateToken</a>(
00676                              (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,        <span class="comment">// ExistingToken</span>
00677                              &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,    <span class="comment">// ObjectAttributes</span>
00678                              EffectiveOnly,        <span class="comment">// EffectiveOnly</span>
00679                              TokenImpersonation,   <span class="comment">// TokenType</span>
00680                              ImpersonationLevel,   <span class="comment">// ImpersonationLevel</span>
00681                              <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,           <span class="comment">// RequestorMode must be kernel mode</span>
00682                              &amp;NewToken
00683                              );
00684 
00685                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00686 
00687                     <span class="comment">//</span>
00688                     <span class="comment">// Reference the token so it doesn't go away</span>
00689                     <span class="comment">//</span>
00690 
00691                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(NewToken);
00692 
00693                     <span class="comment">//</span>
00694                     <span class="comment">//  Insert the new token</span>
00695                     <span class="comment">//</span>
00696 
00697                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( NewToken,
00698                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00699                                              DesiredAccess,
00700                                              0,
00701                                              (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00702                                              &amp;LocalHandle
00703                                              );
00704                 }
00705             }
00706         }
00707 
00708 
00709     } <span class="keywordflow">else</span> {
00710 
00711         <span class="comment">//</span>
00712         <span class="comment">// We do not have to modify the security on the token in the static case,</span>
00713         <span class="comment">// because in all the places in the system where impersonation takes place</span>
00714         <span class="comment">// over a secure transport (e.g., LPC), CopyOnOpen is set.  The only reason</span>
00715         <span class="comment">// we'be be here is if the impersonation is taking place because someone did</span>
00716         <span class="comment">// an NtSetInformationThread and passed in a token.</span>
00717         <span class="comment">//</span>
00718         <span class="comment">// In that case, we absolutely do not want to give the caller guaranteed</span>
00719         <span class="comment">// access, because that would allow anyone who has access to a thread to</span>
00720         <span class="comment">// impersonate any of that thread's clients for any access.</span>
00721         <span class="comment">//</span>
00722 
00723         <span class="comment">//</span>
00724         <span class="comment">//  Open the existing token</span>
00725         <span class="comment">//</span>
00726 
00727         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
00728                      (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,         <span class="comment">// Object</span>
00729                      0,                    <span class="comment">// HandleAttributes</span>
00730                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                 <span class="comment">// AccessState</span>
00731                      DesiredAccess,        <span class="comment">// DesiredAccess</span>
00732                      <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,   <span class="comment">// ObjectType</span>
00733                      PreviousMode,         <span class="comment">// AccessMode</span>
00734                      &amp;LocalHandle          <span class="comment">// Handle</span>
00735                      );
00736     }
00737 
00738     <span class="keywordflow">if</span> (NewAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00739         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewAcl );
00740     }
00741 
00742     <span class="keywordflow">if</span> (RestoreImpersonationState) {
00743         <a class="code" href="../../d6/d5/ps_2security_8c.html#a8">PsRestoreImpersonation</a>(
00744             <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00745             &amp;DisabledImpersonationState
00746             );
00747     }
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">//  And decrement the reference count of the existing token to counter</span>
00751     <span class="comment">//  the action performed by PsOpenTokenOfThread.  If the open</span>
00752     <span class="comment">//  was successful, the handle will have caused the token's</span>
00753     <span class="comment">//  reference count to have been incremented.</span>
00754     <span class="comment">//</span>
00755 
00756     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00757 
00758     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) &amp;&amp; CopyOnOpen) {
00759 
00760         <span class="comment">//</span>
00761         <span class="comment">// Assign the newly duplicated token to the thread.</span>
00762         <span class="comment">//</span>
00763 
00764         <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>( Thread,
00765                              NewToken,
00766                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,  <span class="comment">// turn off CopyOnOpen flag</span>
00767                              EffectiveOnly,
00768                              ImpersonationLevel
00769                              );
00770 
00771     }
00772 
00773     <span class="comment">//</span>
00774     <span class="comment">// We've impersonated the token so let go of oure reference</span>
00775     <span class="comment">//</span>
00776 
00777     <span class="keywordflow">if</span> (NewToken != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00778         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
00779     }
00780 
00781     <span class="keywordflow">if</span> (CopyOnOpen &amp;&amp; (Thread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00782 
00783         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Thread );
00784     }
00785 
00786     <span class="keywordflow">if</span> (OriginalThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00787         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(OriginalThread);
00788     }
00789 
00790     <span class="comment">//</span>
00791     <span class="comment">//  Return the new handle</span>
00792     <span class="comment">//</span>
00793 
00794     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00795         <span class="keywordflow">try</span> { *TokenHandle = LocalHandle; }
00796             except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) { <span class="keywordflow">return</span> GetExceptionCode(); }
00797     }
00798 
00799     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00800 
00801 }
00802 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
