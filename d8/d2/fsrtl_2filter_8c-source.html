<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: filter.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>filter.c</h1><a href="../../d7/d3/fsrtl_2filter_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Filter.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    The Exception filter is used by the file system and cache manager</span>
00012 <span class="comment">    to handle error recovery.  The basic idea is to have the top level</span>
00013 <span class="comment">    file system entry points (i.e., the FSD entry points and FSP dispatch</span>
00014 <span class="comment">    loop) have a try-except around their code, and then whenever the</span>
00015 <span class="comment">    file system or cache manager reach an error case they raise an</span>
00016 <span class="comment">    appropriate status.  Then the exception handler catches the exception</span>
00017 <span class="comment">    and can either complete the request, send it off to the fsp, verify the</span>
00018 <span class="comment">    volume, or bugcheck.  We only bugcheck if the raised exception is</span>
00019 <span class="comment">    unexpected (i.e., unhandled).</span>
00020 <span class="comment"></span>
00021 <span class="comment">    This module provides two routines for filtering out exceptions.  The</span>
00022 <span class="comment">    first routine is used to normalize status values to be one of the</span>
00023 <span class="comment">    value handled by the filter.  That way if we get an exception not handled</span>
00024 <span class="comment">    by the filter then we know that the system is in real trouble and we</span>
00025 <span class="comment">    just bugcheck the machine.  The second routine is used to ask if</span>
00026 <span class="comment">    a status value is within the set of values handled by the filter.</span>
00027 <span class="comment"></span>
00028 <span class="comment">    The value of status handled by this filter are listed in the routine</span>
00029 <span class="comment">    FsRtlIsNtstatusExpected.</span>
00030 <span class="comment"></span>
00031 <span class="comment">Author:</span>
00032 <span class="comment"></span>
00033 <span class="comment">    Gary Kimura     [GaryKi]    4-Jan-1991</span>
00034 <span class="comment"></span>
00035 <span class="comment">Revision History:</span>
00036 <span class="comment"></span>
00037 <span class="comment">--*/</span>
00038 
00039 <span class="preprocessor">#include "FsRtlP.h"</span>
00040 
00041 <span class="comment">//</span>
00042 <span class="comment">//  Trace level for the module</span>
00043 <span class="comment">//</span>
00044 
<a name="l00045"></a><a class="code" href="../../d7/d3/fsrtl_2filter_8c.html#a0">00045</a> <span class="preprocessor">#define Dbg                              (0x80000000)</span>
00046 <span class="preprocessor"></span>
00047 
00048 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00049"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a136">00049</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a136">FsRtlNormalizeNtstatus</a> (
00050     IN NTSTATUS Exception,
00051     IN NTSTATUS GenericException
00052     )
00053 
00054 <span class="comment">/*++</span>
00055 <span class="comment"></span>
00056 <span class="comment">Routine Description:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    This routine is used to normalize an NTSTATUS into a status</span>
00059 <span class="comment">    that is handled by the file system's top level exception handlers.</span>
00060 <span class="comment"></span>
00061 <span class="comment">Arguments:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    Exception - Supplies the exception being normalized</span>
00064 <span class="comment"></span>
00065 <span class="comment">    GenericException - Supplies a second exception to translate to</span>
00066 <span class="comment">        if the first exception is not within the set of exceptions</span>
00067 <span class="comment">        handled by the filter</span>
00068 <span class="comment"></span>
00069 <span class="comment">Return Value:</span>
00070 <span class="comment"></span>
00071 <span class="comment">    NTSTATUS - Returns Exception if the value is already handled</span>
00072 <span class="comment">        by the filter, and GenericException otherwise.</span>
00073 <span class="comment"></span>
00074 <span class="comment">--*/</span>
00075 
00076 {
00077     <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(Exception) ? Exception : GenericException);
00078 }
00079 
00080 
00081 BOOLEAN
<a name="l00082"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a137">00082</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a> (
00083     IN NTSTATUS Exception
00084     )
00085 
00086 <span class="comment">/*++</span>
00087 <span class="comment"></span>
00088 <span class="comment">Routine Description:</span>
00089 <span class="comment"></span>
00090 <span class="comment">    This routine is used to decide if a status is within the set of values</span>
00091 <span class="comment">    handled by the exception filter.</span>
00092 <span class="comment"></span>
00093 <span class="comment">Arguments:</span>
00094 <span class="comment"></span>
00095 <span class="comment">    Exception - Supplies the exception being queried</span>
00096 <span class="comment"></span>
00097 <span class="comment">Return Value:</span>
00098 <span class="comment"></span>
00099 <span class="comment">    BOOLEAN - Returns TRUE if the value is handled by the filter, and</span>
00100 <span class="comment">        FALSE otherwise.</span>
00101 <span class="comment"></span>
00102 <span class="comment">--*/</span>
00103 
00104 {
00105     <span class="keywordflow">switch</span> (Exception) {
00106 
00107     <span class="keywordflow">case</span> STATUS_DATATYPE_MISALIGNMENT:
00108     <span class="keywordflow">case</span> STATUS_ACCESS_VIOLATION:
00109     <span class="keywordflow">case</span> STATUS_ILLEGAL_INSTRUCTION:
00110     <span class="keywordflow">case</span> STATUS_INSTRUCTION_MISALIGNMENT:
00111 
00112         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00113 
00114     <span class="keywordflow">default</span>:
00115 
00116         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00117     }
00118 }
00119 
00120 
00121 <span class="preprocessor">#undef FsRtlAllocatePool</span>
00122 <span class="preprocessor"></span>
00123 PVOID
<a name="l00124"></a><a class="code" href="../../d7/d3/fsrtl_2filter_8c.html#a3">00124</a> <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a> (
00125     IN POOL_TYPE PoolType,
00126     IN ULONG NumberOfBytes
00127     )
00128 
00129 <span class="comment">/*++</span>
00130 <span class="comment"></span>
00131 <span class="comment">Routine Description:</span>
00132 <span class="comment"></span>
00133 <span class="comment">    This routine is used to allocate executive level pool.  It either</span>
00134 <span class="comment">    returns a non null pointer to the newly allocated pool or it raises</span>
00135 <span class="comment">    a status of insufficient resources.</span>
00136 <span class="comment"></span>
00137 <span class="comment">Arguments:</span>
00138 <span class="comment"></span>
00139 <span class="comment">    PoolType - Supplies the type of executive pool to allocate</span>
00140 <span class="comment"></span>
00141 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate</span>
00142 <span class="comment"></span>
00143 <span class="comment">Return Value:</span>
00144 <span class="comment"></span>
00145 <span class="comment">    PVOID - Returns a non null pointer to the newly allocated pool.</span>
00146 <span class="comment"></span>
00147 <span class="comment">--*/</span>
00148 
00149 {
00150     PVOID p;
00151 
00152     <span class="comment">//</span>
00153     <span class="comment">//  Allocate executive pool and if we get back null then raise</span>
00154     <span class="comment">//  a status of insufficient resources</span>
00155     <span class="comment">//</span>
00156 
00157     <span class="keywordflow">if</span> ((p = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PoolType, NumberOfBytes, 'trSF')) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00158 
00159         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00160     }
00161 
00162     <span class="keywordflow">return</span> p;
00163 }
00164 
00165 <span class="preprocessor">#undef FsRtlAllocatePoolWithQuota</span>
00166 <span class="preprocessor"></span>
00167 
00168 PVOID
<a name="l00169"></a><a class="code" href="../../d7/d3/fsrtl_2filter_8c.html#a4">00169</a> <a class="code" href="../../d5/d5/cc_8h.html#a9">FsRtlAllocatePoolWithQuota</a> (
00170     IN POOL_TYPE PoolType,
00171     IN ULONG NumberOfBytes
00172     )
00173 
00174 <span class="comment">/*++</span>
00175 <span class="comment"></span>
00176 <span class="comment">Routine Description:</span>
00177 <span class="comment"></span>
00178 <span class="comment">    This routine is used to allocate executive level pool with quota.  It</span>
00179 <span class="comment">    either returns a non null pointer to the newly allocated pool or it raises</span>
00180 <span class="comment">    a status of insufficient resources.</span>
00181 <span class="comment"></span>
00182 <span class="comment">Arguments:</span>
00183 <span class="comment"></span>
00184 <span class="comment">    PoolType - Supplies the type of executive pool to allocate</span>
00185 <span class="comment"></span>
00186 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate</span>
00187 <span class="comment"></span>
00188 <span class="comment">Return Value:</span>
00189 <span class="comment"></span>
00190 <span class="comment">    PVOID - Returns a non null pointer to the newly allocated pool.</span>
00191 <span class="comment"></span>
00192 <span class="comment">--*/</span>
00193 
00194 {
00195     PVOID p;
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">//  Allocate executive pool and if we get back null then raise</span>
00199     <span class="comment">//  a status of insufficient resources</span>
00200     <span class="comment">//</span>
00201 
00202     <span class="keywordflow">if</span> ((p = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a> ( PoolType, NumberOfBytes, 'trSF')) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00203 
00204         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00205     }
00206 
00207     <span class="keywordflow">return</span> p;
00208 }
00209 
00210 
00211 <span class="preprocessor">#undef FsRtlAllocatePoolWithTag</span>
00212 <span class="preprocessor"></span>
00213 PVOID
<a name="l00214"></a><a class="code" href="../../d7/d3/fsrtl_2filter_8c.html#a5">00214</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a> (
00215     IN POOL_TYPE PoolType,
00216     IN ULONG NumberOfBytes,
00217     IN ULONG Tag
00218     )
00219 
00220 <span class="comment">/*++</span>
00221 <span class="comment"></span>
00222 <span class="comment">Routine Description:</span>
00223 <span class="comment"></span>
00224 <span class="comment">    This routine is used to allocate executive level pool with a tag.</span>
00225 <span class="comment"></span>
00226 <span class="comment">Arguments:</span>
00227 <span class="comment"></span>
00228 <span class="comment">    PoolType - Supplies the type of executive pool to allocate</span>
00229 <span class="comment"></span>
00230 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate</span>
00231 <span class="comment"></span>
00232 <span class="comment">    Tag - Supplies the tag for the pool block</span>
00233 <span class="comment"></span>
00234 <span class="comment">Return Value:</span>
00235 <span class="comment"></span>
00236 <span class="comment">    PVOID - Returns a non null pointer to the newly allocated pool.</span>
00237 <span class="comment"></span>
00238 <span class="comment">--*/</span>
00239 
00240 {
00241     PVOID p;
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">//  Allocate executive pool and if we get back null then raise</span>
00245     <span class="comment">//  a status of insufficient resources</span>
00246     <span class="comment">//</span>
00247 
00248     <span class="keywordflow">if</span> ((p = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PoolType, NumberOfBytes, Tag)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00249 
00250         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00251     }
00252 
00253     <span class="keywordflow">return</span> p;
00254 }
00255 
00256 
00257 <span class="preprocessor">#undef FsRtlAllocatePoolWithQuotaTag</span>
00258 <span class="preprocessor"></span>
00259 PVOID
<a name="l00260"></a><a class="code" href="../../d7/d3/fsrtl_2filter_8c.html#a6">00260</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a38">FsRtlAllocatePoolWithQuotaTag</a> (
00261     IN POOL_TYPE PoolType,
00262     IN ULONG NumberOfBytes,
00263     IN ULONG Tag
00264     )
00265 
00266 <span class="comment">/*++</span>
00267 <span class="comment"></span>
00268 <span class="comment">Routine Description:</span>
00269 <span class="comment"></span>
00270 <span class="comment">    This routine is used to allocate executive level pool with a quota tag.</span>
00271 <span class="comment"></span>
00272 <span class="comment">Arguments:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    PoolType - Supplies the type of executive pool to allocate</span>
00275 <span class="comment"></span>
00276 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate</span>
00277 <span class="comment"></span>
00278 <span class="comment">    Tag - Supplies the tag for the pool block</span>
00279 <span class="comment"></span>
00280 <span class="comment">Return Value:</span>
00281 <span class="comment"></span>
00282 <span class="comment">    PVOID - Returns a non null pointer to the newly allocated pool.</span>
00283 <span class="comment"></span>
00284 <span class="comment">--*/</span>
00285 
00286 {
00287     PVOID p;
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">//  Allocate executive pool and if we get back null then raise</span>
00291     <span class="comment">//  a status of insufficient resources</span>
00292     <span class="comment">//</span>
00293 
00294     <span class="keywordflow">if</span> ((p = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>( PoolType, NumberOfBytes, Tag)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00295 
00296         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00297     }
00298 
00299     <span class="keywordflow">return</span> p;
00300 }
00301 
00302 
00303 BOOLEAN
<a name="l00304"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a111">00304</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a111">FsRtlIsTotalDeviceFailure</a>(
00305     IN NTSTATUS Status
00306     )
00307 
00308 <span class="comment">/*++</span>
00309 <span class="comment"></span>
00310 <span class="comment">Routine Description:</span>
00311 <span class="comment"></span>
00312 <span class="comment">    This routine is given an NTSTATUS value and make a determination as to</span>
00313 <span class="comment">    if this value indicates that the complete device has failed and therefore</span>
00314 <span class="comment">    should no longer be used, or if the failure is one that indicates that</span>
00315 <span class="comment">    continued use of the device is ok (i.e. a sector failure).</span>
00316 <span class="comment"></span>
00317 <span class="comment">Arguments:</span>
00318 <span class="comment"></span>
00319 <span class="comment">    Status - the NTSTATUS value to test.</span>
00320 <span class="comment"></span>
00321 <span class="comment">Return Value:</span>
00322 <span class="comment"></span>
00323 <span class="comment">    TRUE  - The status value given is believed to be a fatal device error.</span>
00324 <span class="comment">    FALSE - The status value given is believed to be a sector failure, but not</span>
00325 <span class="comment">            a complete device failure.</span>
00326 <span class="comment">--*/</span>
00327 
00328 {
00329     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00330 
00331         <span class="comment">//</span>
00332         <span class="comment">// All warning and informational errors will be resolved here.</span>
00333         <span class="comment">//</span>
00334 
00335         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00336     }
00337 
00338     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00339     <span class="keywordflow">case</span> STATUS_CRC_ERROR:
00340     <span class="keywordflow">case</span> STATUS_DEVICE_DATA_ERROR:
00341         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00342     <span class="keywordflow">default</span>:
00343         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00344     }
00345 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:00 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
