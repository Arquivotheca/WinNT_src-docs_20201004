<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: partit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>partit.c</h1><a href="../../d7/d3/partit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    partit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains entry points to perform the</span>
00012 <span class="comment">    'configure system partition' and 'create OS loader'</span>
00013 <span class="comment">    options of the ARC installer.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Ted Miller        (tedm)    Nov-1991</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d3/d3/arcinst_2precomp_8h.html">precomp.h</a>"</span>
00025 <span class="preprocessor">#pragma hdrstop</span>
00026 <span class="preprocessor"></span>
00027 
00028 PCHAR
00029 <a class="code" href="../../d7/d3/partit_8c.html#a26">AlGetNextArcNamToken</a> (
00030     IN PCHAR TokenString,
00031     OUT PCHAR OutputToken,
00032     OUT PULONG UnitNumber
00033     );
00034 
<a name="l00035"></a><a class="code" href="../../d7/d3/partit_8c.html#a0">00035</a> <span class="preprocessor">#define STATUS_ROW_TOP     13</span>
<a name="l00036"></a><a class="code" href="../../d7/d3/partit_8c.html#a1">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define STATUS_ROW_BOTTOM  17</span>
00037 <span class="preprocessor"></span>
<a name="l00038"></a><a class="code" href="../../d7/d3/partit_8c.html#a8">00038</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a8">NOMEMMSG</a>[] = <span class="stringliteral">"Insufficient memory"</span>;
<a name="l00039"></a><a class="code" href="../../d7/d3/partit_8c.html#a9">00039</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a9">NOCNFMSG</a>[] = <span class="stringliteral">"Unable to determine disk configuration (ARC status = %u)"</span>;
<a name="l00040"></a><a class="code" href="../../d7/d3/partit_8c.html#a10">00040</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a10">NOFMTMSG</a>[] = <span class="stringliteral">"Format failed (ARC status = %u)"</span>;
<a name="l00041"></a><a class="code" href="../../d7/d3/partit_8c.html#a11">00041</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a11">DSKFLMSG</a>[] = <span class="stringliteral">"Disk is full"</span>;
<a name="l00042"></a><a class="code" href="../../d7/d3/partit_8c.html#a12">00042</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a12">NOCREMSG</a>[] = <span class="stringliteral">"Could not create partition (ARC status = %u)"</span>;
<a name="l00043"></a><a class="code" href="../../d7/d3/partit_8c.html#a13">00043</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a13">NODELMSG</a>[] = <span class="stringliteral">"Could not delete partition (ARC status = %u)"</span>;
<a name="l00044"></a><a class="code" href="../../d7/d3/partit_8c.html#a14">00044</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a14">ALREAMSG</a>[] = <span class="stringliteral">"Partition is already a system partition"</span>;
<a name="l00045"></a><a class="code" href="../../d7/d3/partit_8c.html#a15">00045</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a15">NOFILMSG</a>[] = <span class="stringliteral">"Unable to determine filesystem on partition (ARC status = %u)"</span>;
<a name="l00046"></a><a class="code" href="../../d7/d3/partit_8c.html#a16">00046</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a16">NOENVMSG</a>[] = <span class="stringliteral">"Error (ARC status = %u) determining environment"</span>;
<a name="l00047"></a><a class="code" href="../../d7/d3/partit_8c.html#a17">00047</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a17">NOEVAMSG</a>[] = <span class="stringliteral">"Could not add partition to environment (ARC status = %u)"</span>;
<a name="l00048"></a><a class="code" href="../../d7/d3/partit_8c.html#a18">00048</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a18">NOEVDMSG</a>[] = <span class="stringliteral">"Could not remove partition from environment (ARC status = %u)"</span>;
<a name="l00049"></a><a class="code" href="../../d7/d3/partit_8c.html#a19">00049</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a19">NOSYSMSG</a>[] = <span class="stringliteral">"No system partitions defined"</span>;
<a name="l00050"></a><a class="code" href="../../d7/d3/partit_8c.html#a20">00050</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a20">NOPARMSG</a>[] = <span class="stringliteral">"No partitions on this disk"</span>;
00051 
<a name="l00052"></a><a class="code" href="../../d7/d3/partit_8c.html#a21">00052</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a21">SYSPARTVAR</a>[] = <span class="stringliteral">"SYSTEMPARTITION"</span>;
<a name="l00053"></a><a class="code" href="../../d7/d3/partit_8c.html#a22">00053</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a22">OSLOADERVAR</a>[] = <span class="stringliteral">"OSLOADER"</span>;
<a name="l00054"></a><a class="code" href="../../d7/d3/partit_8c.html#a23">00054</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a23">OSLOADPARTVAR</a>[] = <span class="stringliteral">"OSLOADPARTITION"</span>;
00055 
<a name="l00056"></a><a class="code" href="../../d7/d3/partit_8c.html#a2">00056</a> <span class="preprocessor">#define MsgNoMem()  AlStatusMsg(STATUS_ROW_TOP,STATUS_ROW_BOTTOM,TRUE,NOMEMMSG);</span>
00057 <span class="preprocessor"></span>
<a name="l00058"></a><a class="code" href="../../d7/d3/partit_8c.html#a24">00058</a> PCHAR <a class="code" href="../../d7/d3/partit_8c.html#a24">SysPartMenu</a>[] = {   <span class="stringliteral">"Create System Partition"</span>,
00059                           <span class="stringliteral">"Delete Partition"</span>,
00060                           <span class="stringliteral">"Make Existing Partition into System Partition"</span>,
00061                           <span class="stringliteral">"Exit"</span>
00062                       };
00063 
<a name="l00064"></a><a class="code" href="../../d7/d3/partit_8c.html#a3">00064</a> <span class="preprocessor">#define SYSPARTMENU_CREATE 0</span>
<a name="l00065"></a><a class="code" href="../../d7/d3/partit_8c.html#a4">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSPARTMENU_DELETE 1</span>
<a name="l00066"></a><a class="code" href="../../d7/d3/partit_8c.html#a5">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSPARTMENU_ADD    2</span>
<a name="l00067"></a><a class="code" href="../../d7/d3/partit_8c.html#a6">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSPARTMENU_EXIT   3</span>
00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="../../d7/d3/partit_8c.html#a7">00069</a> <span class="preprocessor">#define MENU_ROW 4</span>
00070 <span class="preprocessor"></span>
<a name="l00071"></a><a class="code" href="../../d7/d3/partit_8c.html#a25">00071</a> <span class="keywordtype">char</span>  <a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>[256];
00072 
00073 BOOLEAN
<a name="l00074"></a><a class="code" href="../../d7/d3/partit_8c.html#a27">00074</a> <a class="code" href="../../d7/d3/partit_8c.html#a27">Confirm</a>(
00075     PCHAR Warning
00076     )
00077 {
00078     <span class="keywordtype">char</span>  <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00079     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00080 
00081     <a class="code" href="../../d4/d9/arcinst_8h.html#a103">AlClearStatusArea</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d7/d3/partit_8c.html#a1">STATUS_ROW_BOTTOM</a>);
00082     <a class="code" href="../../d4/d9/arcinst_8h.html#a114">AlPrint</a>(<span class="stringliteral">"%s%s (y/n)?"</span>,<a class="code" href="../../d9/d6/almisc_8c.html#a7">MSGMARGIN</a>,Warning);
00083     <a class="code" href="../../d1/d9/arc_8h.html#a33">ArcRead</a>(<a class="code" href="../../d1/d9/arc_8h.html#a0">ARC_CONSOLE_INPUT</a>,&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>,1,&amp;<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00084     <span class="keywordflow">while</span>((<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> != <span class="charliteral">'y'</span>) &amp;&amp; (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> != <span class="charliteral">'Y'</span>) &amp;&amp; (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> != <span class="charliteral">'n'</span>) &amp;&amp; (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> != <span class="charliteral">'N'</span>) &amp;&amp; (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> != <a class="code" href="../../d4/d9/arcinst_8h.html#a9">ASCI_ESC</a>)) {
00085         <a class="code" href="../../d1/d9/arc_8h.html#a33">ArcRead</a>(<a class="code" href="../../d1/d9/arc_8h.html#a0">ARC_CONSOLE_INPUT</a>,&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>,1,&amp;<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00086     }
00087     <a class="code" href="../../d4/d9/arcinst_8h.html#a103">AlClearStatusArea</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d7/d3/partit_8c.html#a1">STATUS_ROW_BOTTOM</a>);
00088     <span class="keywordflow">return</span>((BOOLEAN)((<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> == <span class="charliteral">'y'</span>) || (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> == <span class="charliteral">'Y'</span>)));
00089 }
00090 
00091 
00092 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00093"></a><a class="code" href="../../d7/d3/partit_8c.html#a28">00093</a> <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(
00094     PCHAR   FormatString,
00095     ...
00096     )
00097 {
00098     va_list ArgList;
00099 
00100     va_start(ArgList,FormatString);
00101 
00102     <a class="code" href="../../d4/d9/arcinst_8h.html#a103">AlClearStatusArea</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d7/d3/partit_8c.html#a1">STATUS_ROW_BOTTOM</a>);
00103     <a class="code" href="../../d4/d9/arcinst_8h.html#a100">vAlStatusMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,FormatString,ArgList);
00104 
00105     <a class="code" href="../../d4/d9/arcinst_8h.html#a99">AlWaitKey</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00106     <a class="code" href="../../d4/d9/arcinst_8h.html#a103">AlClearStatusArea</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d7/d3/partit_8c.html#a1">STATUS_ROW_BOTTOM</a>);
00107 }
00108 
00109 
00110 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00111"></a><a class="code" href="../../d7/d3/partit_8c.html#a29">00111</a> <a class="code" href="../../d7/d3/partit_8c.html#a29">PrintMsg</a>(
00112     PCHAR   FormatString,
00113     ...
00114     )
00115 {
00116     va_list ArgList;
00117 
00118     va_start(ArgList,FormatString);
00119 
00120     <a class="code" href="../../d4/d9/arcinst_8h.html#a103">AlClearStatusArea</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d7/d3/partit_8c.html#a1">STATUS_ROW_BOTTOM</a>);
00121     <a class="code" href="../../d4/d9/arcinst_8h.html#a100">vAlStatusMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,FormatString,ArgList);
00122 
00123     <a class="code" href="../../d4/d9/arcinst_8h.html#a99">AlWaitKey</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00124     <a class="code" href="../../d4/d9/arcinst_8h.html#a103">AlClearStatusArea</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d7/d3/partit_8c.html#a1">STATUS_ROW_BOTTOM</a>);
00125 }
00126 
00127 
00128 BOOLEAN
<a name="l00129"></a><a class="code" href="../../d7/d3/partit_8c.html#a30">00129</a> <a class="code" href="../../d7/d3/partit_8c.html#a30">IsBootSelectionPartition</a>(
00130     PCHAR Variable,
00131     ULONG Disk,
00132     ULONG Partition,
00133     PULONG MatchNumber OPTIONAL
00134     )
00135 {
00136     <span class="keywordtype">char</span>  <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a>[256];
00137     PCHAR Var = <a class="code" href="../../d1/d9/arc_8h.html#a39">ArcGetEnvironmentVariable</a>(Variable);
00138 
00139     <span class="keywordflow">if</span> (Var == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00140         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00141     }
00142 
00143     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a>,<span class="stringliteral">"%spartition(%u)"</span>,<a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(Disk),Partition);
00144     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d9/arcinst_8h.html#a83">AlFindNextMatchComponent</a>(Var,<a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a>,0,MatchNumber));
00145 }
00146 
00147 
00148 LONG
<a name="l00149"></a><a class="code" href="../../d7/d3/partit_8c.html#a31">00149</a> <a class="code" href="../../d7/d3/partit_8c.html#a31">ChooseDisk</a>(
00150     VOID
00151     )
00152 {
00153     ULONG DiskCount = <a class="code" href="../../d8/d1/fdengine_8c.html#a61">GetDiskCount</a>();
00154     PVOID MenuID;
00155     LONG Disk;
00156     ULONG ChosenDisk;
00157     PCHAR DiskName,TempDiskName;
00158     ULONG UnitNumber,ScsiNumber,ScsiId,DiskNumber;
00159     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>[32];
00160 
00161     <span class="keywordflow">if</span> (DiskCount == 1) {
00162         <span class="keywordflow">return</span>(0);
00163     }
00164 
00165     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a91">AlNewMenu</a>(&amp;MenuID)) {
00166         <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00167         <span class="keywordflow">return</span>(-1);
00168     }
00169 
00170     <span class="keywordflow">for</span>(Disk = DiskCount - 1; Disk &gt;= 0; Disk--) {
00171 
00172         DiskName = <a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(Disk);
00173 
00174         <span class="keywordflow">if</span> ((strstr(DiskName, <span class="stringliteral">"scsi"</span>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00175             (strstr(DiskName, <span class="stringliteral">"disk"</span>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00176 
00177             ScsiNumber = ScsiId = DiskNumber = 0;
00178             TempDiskName = DiskName;
00179 
00180             <span class="keywordflow">while</span> (TempDiskName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00181                 TempDiskName = <a class="code" href="../../d7/d3/partit_8c.html#a26">AlGetNextArcNamToken</a>(TempDiskName,
00182                                                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00183                                                     &amp;UnitNumber);
00184 
00185                 <span class="keywordflow">if</span> (strcmp(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,<span class="stringliteral">"scsi"</span>) == 0) {
00186                     ScsiNumber = UnitNumber;
00187                 }
00188 
00189                 <span class="keywordflow">if</span> (strcmp(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,<span class="stringliteral">"disk"</span>) == 0) {
00190                     ScsiId = UnitNumber;
00191                 }
00192 
00193                 <span class="keywordflow">if</span> (strcmp(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,<span class="stringliteral">"rdisk"</span>) == 0) {
00194                     DiskNumber = UnitNumber;
00195                 }
00196             }
00197 
00198             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,
00199                     <span class="stringliteral">"Scsi bus %d, Identifier %d, Disk %d (%s)"</span>,
00200                     ScsiNumber,
00201                     ScsiId,
00202                     DiskNumber,
00203                     <a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(Disk));
00204         } <span class="keywordflow">else</span> {
00205             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,<span class="stringliteral">"Disk %d (%s)"</span>,Disk,<a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(Disk));
00206         }
00207 
00208 
00209         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a93">AlAddMenuItem</a>(MenuID,<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,Disk,0)) {
00210             <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00211             <span class="keywordflow">return</span>(-1);
00212         }
00213     }
00214 
00215     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a95">AlDisplayMenu</a>(MenuID,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,0,&amp;ChosenDisk,<a class="code" href="../../d7/d3/partit_8c.html#a7">MENU_ROW</a>,<span class="stringliteral">"Select Disk"</span>)) {
00216         <span class="keywordflow">return</span>(-1);
00217     } <span class="keywordflow">else</span> {
00218         <span class="keywordflow">return</span>(ChosenDisk);
00219     }
00220 }
00221 
00222 
00223 BOOLEAN         <span class="comment">// true if partition was created</span>
<a name="l00224"></a><a class="code" href="../../d7/d3/partit_8c.html#a32">00224</a> <a class="code" href="../../d7/d3/partit_8c.html#a32">DoPartitionCreate</a>(
00225     OUT PULONG DiskNo,
00226     OUT PULONG PartitionNo
00227     )
00228 {
00229     ULONG              Disk,i;
00230     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Regions;
00231     ULONG              RegionCount,Choice;
00232     ULONG              ChosenSize;
00233     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>         status;
00234     BOOLEAN            xAny,xP,xE,xL,PrimaryExists;
00235     PVOID              MenuID;
00236     ULONG              PartitionNumber;
00237     <span class="keywordtype">char</span>               PartitionPath[256];
00238 
00239 
00240     <span class="keywordflow">if</span> ((Disk = <a class="code" href="../../d7/d3/partit_8c.html#a31">ChooseDisk</a>()) == -1) {
00241         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00242     }
00243 
00244     <span class="keywordflow">if</span> ((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a58">DoesAnyPrimaryExist</a>(Disk,&amp;PrimaryExists)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00245         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a9">NOCNFMSG</a>,status);
00246         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00247     }
00248 
00249     <span class="keywordflow">if</span> ((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a53">IsAnyCreationAllowed</a>(Disk,
00250                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00251                                       &amp;xAny,
00252                                       &amp;xP,
00253                                       &amp;xE,
00254                                       &amp;xL
00255                                      )
00256        )
00257       != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>)
00258     {
00259         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a9">NOCNFMSG</a>,status);
00260         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00261     }
00262 
00263     <span class="comment">// in order for a creation to be allowed there must be</span>
00264     <span class="comment">// - free space on the disk and a free mbr entry OR</span>
00265     <span class="comment">// - free space in an existing extended partition.</span>
00266 
00267     <span class="keywordflow">if</span> (!xAny) {
00268         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a11">DSKFLMSG</a>);
00269         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00270     }
00271 
00272     <span class="keywordflow">if</span> ((status = <a class="code" href="../../d4/d9/arcinst_8h.html#a30">GetFreeDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00273         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a9">NOCNFMSG</a>,status);
00274         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00275     }
00276 
00277     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a91">AlNewMenu</a>(&amp;MenuID)) {
00278         <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00279         <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00280         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00281     }
00282 
00283     <span class="comment">// Present the user with a list of the free spaces</span>
00284     <span class="comment">// on the disk (and within the extended partition, if it</span>
00285     <span class="comment">// exists).</span>
00286 
00287     <span class="keywordflow">if</span> (RegionCount &gt; 1) {
00288 
00289         <span class="keywordflow">for</span>(i=0; i&lt;RegionCount; i++) {
00290 
00291             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,<span class="stringliteral">"%u MB space"</span>,Regions[i].SizeMB);
00292             <span class="keywordflow">if</span> (Regions[i].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o5">RegionType</a> == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>) {
00293                 strcat(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,<span class="stringliteral">" (in extended partition)"</span>);
00294             }
00295             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a93">AlAddMenuItem</a>(MenuID,<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,i,0)) {
00296                 <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00297                 <a class="code" href="../../d4/d9/arcinst_8h.html#a92">AlFreeMenu</a>(MenuID);
00298                 <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00299                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00300             }
00301         }
00302 
00303         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a95">AlDisplayMenu</a>(MenuID,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,0,&amp;Choice,<a class="code" href="../../d7/d3/partit_8c.html#a7">MENU_ROW</a>,<span class="stringliteral">"Available Free Spaces"</span>)) {
00304             <span class="comment">// user escaped</span>
00305             <a class="code" href="../../d4/d9/arcinst_8h.html#a103">AlClearStatusArea</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d7/d3/partit_8c.html#a1">STATUS_ROW_BOTTOM</a>);
00306             <a class="code" href="../../d4/d9/arcinst_8h.html#a92">AlFreeMenu</a>(MenuID);
00307             <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00308             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00309         }
00310     } <span class="keywordflow">else</span> {
00311         Choice = 0;
00312     }
00313 
00314     <a class="code" href="../../d4/d9/arcinst_8h.html#a92">AlFreeMenu</a>(MenuID);
00315 
00316     <span class="comment">// now ask the user for the size of the partition to create in the chosen space.</span>
00317 
00318     <span class="keywordflow">do</span> {
00319         <a class="code" href="../../d4/d9/arcinst_8h.html#a103">AlClearStatusArea</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d7/d3/partit_8c.html#a1">STATUS_ROW_BOTTOM</a>);
00320         <a class="code" href="../../d4/d9/arcinst_8h.html#a114">AlPrint</a>(<span class="stringliteral">"%sEnter size in MB (1-%u): "</span>,<a class="code" href="../../d9/d6/almisc_8c.html#a7">MSGMARGIN</a>,Regions[Choice].SizeMB);
00321         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a115">AlGetString</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>))) {
00322             <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00323             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00324         }
00325         ChosenSize = atoi(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>);
00326         <span class="keywordflow">if</span> (!ChosenSize || (ChosenSize &gt; Regions[Choice].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o2">SizeMB</a>)) {
00327             <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<span class="stringliteral">"Invalid size."</span>);
00328         } <span class="keywordflow">else</span> {
00329             <span class="keywordflow">break</span>;
00330         }
00331     } <span class="keywordflow">while</span>(1);
00332 
00333     <span class="comment">// The chosen space is either in the extended partition or not.</span>
00334     <span class="comment">// If it is, just create the requested partition.</span>
00335 
00336     <span class="keywordflow">if</span> (Regions[Choice].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o5">RegionType</a> == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>) {
00337 
00338         status = <a class="code" href="../../d8/d1/fdengine_8c.html#a34">CreatePartition</a>(&amp;Regions[Choice],ChosenSize,<a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>);
00339         PartitionNumber = Regions[Choice].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o3">PartitionNumber</a>;
00340 
00341     } <span class="keywordflow">else</span> {
00342 
00343         <span class="comment">// The chosen space is not in an extended partition.</span>
00344         <span class="comment">// If there's already a primary and we can create</span>
00345         <span class="comment">// an extended partition, then first create an</span>
00346         <span class="comment">// extended partition spanning the entire space chosen</span>
00347         <span class="comment">// by the user, and then a logical volume within it of</span>
00348         <span class="comment">// size entered by the user.  Otherwise [ie, there's no primary</span>
00349         <span class="comment">// or we're not allowed to create an extended partition]</span>
00350         <span class="comment">// create a primary of the size entered by the user.</span>
00351 
00352 
00353         <span class="keywordflow">if</span> (PrimaryExists &amp;&amp; xE) {
00354 
00355             <span class="comment">// create extended partition first.</span>
00356             status = <a class="code" href="../../d8/d1/fdengine_8c.html#a34">CreatePartition</a>(&amp;Regions[Choice],Regions[Choice].SizeMB,<a class="code" href="../../d4/d9/arcinst_8h.html#a175a68">REGION_EXTENDED</a>);
00357             <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00358 
00359             <span class="keywordflow">if</span> ((status = <a class="code" href="../../d4/d9/arcinst_8h.html#a37">GetFreeLogicalDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00360                 <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a9">NOCNFMSG</a>,status);
00361                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00362             }
00363             <span class="comment">// since we just created the extended partition, there will be one free</span>
00364             <span class="comment">// region in it.</span>
00365 
00366             status = <a class="code" href="../../d8/d1/fdengine_8c.html#a34">CreatePartition</a>(Regions,ChosenSize,<a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a>);
00367             PartitionNumber = Regions[0].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o3">PartitionNumber</a>;
00368 
00369         } <span class="keywordflow">else</span> {
00370 
00371             status = <a class="code" href="../../d8/d1/fdengine_8c.html#a34">CreatePartition</a>(&amp;Regions[Choice],ChosenSize,<a class="code" href="../../d4/d9/arcinst_8h.html#a175a67">REGION_PRIMARY</a>);
00372             PartitionNumber = Regions[Choice].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o3">PartitionNumber</a>;
00373         }
00374     }
00375     <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00376 
00377     <span class="keywordflow">if</span> ( (status                                 == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>)
00378     &amp;&amp; ((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a68">CommitPartitionChanges</a>(Disk)) == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>))
00379     {
00380         <a class="code" href="../../d7/d3/partit_8c.html#a29">PrintMsg</a>(<span class="stringliteral">"Partition successfully created."</span>);
00381 
00382 <span class="preprocessor">#if 0</span>
00383 <span class="preprocessor"></span>        <span class="comment">//</span>
00384         <span class="comment">// This is bogus since this routine is called in the code path where</span>
00385         <span class="comment">// the user is creating a system partition.</span>
00386         <span class="comment">//</span>
00387         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/arc_8h.html#a39">ArcGetEnvironmentVariable</a>(<a class="code" href="../../d7/d3/partit_8c.html#a21">SYSPARTVAR</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00388             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/partit_8c.html#a27">Confirm</a>(<span class="stringliteral">"Do you want to make this the system partition"</span>)) {
00389                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(PartitionPath,<span class="stringliteral">"%spartition(%u)"</span>,<a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(Disk),PartitionNumber);
00390                 <span class="keywordflow">if</span> ((status = <a class="code" href="../../d1/d9/arc_8h.html#a40">ArcSetEnvironmentVariable</a>(<a class="code" href="../../d7/d3/partit_8c.html#a21">SYSPARTVAR</a>,PartitionPath)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00391                     <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a17">NOEVAMSG</a>,status);
00392                 }
00393             }
00394         }
00395 <span class="preprocessor">#endif</span>
00396 <span class="preprocessor"></span>
00397         *DiskNo      = Disk;
00398         *PartitionNo = PartitionNumber;
00399         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00400 
00401     } <span class="keywordflow">else</span> {
00402         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a12">NOCREMSG</a>,status);
00403         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00404     }
00405 }
00406 
00407 
00408 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00409"></a><a class="code" href="../../d7/d3/partit_8c.html#a33">00409</a> <a class="code" href="../../d7/d3/partit_8c.html#a33">DoPartitionDelete</a>(
00410     VOID
00411     )
00412 {
00413     BOOLEAN            xAny,xPrimary,xExtended,xLogical;
00414     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>         status;
00415     PVOID              MenuID;
00416     ULONG              i,RegionCount,Choice;
00417     ULONG              MatchNumber,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00418     LONG               Disk;
00419     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Regions;
00420     BOOLEAN            err,Confirmation;
00421 
00422 
00423     <span class="keywordflow">if</span> ((Disk = <a class="code" href="../../d7/d3/partit_8c.html#a31">ChooseDisk</a>()) == -1) {
00424         <span class="keywordflow">return</span>;
00425     }
00426 
00427     <span class="keywordflow">if</span> ((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a57">DoesAnyPartitionExist</a>(Disk,&amp;xAny,&amp;xPrimary,&amp;xExtended,&amp;xLogical)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00428         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a9">NOCNFMSG</a>,status);
00429         <span class="keywordflow">return</span>;
00430     }
00431 
00432     <span class="keywordflow">if</span> (xAny) {
00433 
00434         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a91">AlNewMenu</a>(&amp;MenuID)) {
00435             <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00436             <span class="keywordflow">return</span>;
00437         }
00438 
00439         <span class="keywordflow">if</span> ((status = <a class="code" href="../../d4/d9/arcinst_8h.html#a31">GetUsedDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00440 
00441             <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a9">NOCNFMSG</a>,status);
00442 
00443         } <span class="keywordflow">else</span> {
00444 
00445             err = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00446 
00447             <span class="keywordflow">for</span>(i=0; i&lt;RegionCount; i++) {
00448 
00449                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,<span class="stringliteral">"%s%u MB "</span>,Regions[i].RegionType == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a> ? <span class="stringliteral">"    "</span> : <span class="stringliteral">""</span>,Regions[i].SizeMB);
00450                 strcat(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,<a class="code" href="../../d8/d1/fdengine_8c.html#a63">GetSysIDName</a>(Regions[i].SysID));
00451                 strcat(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,Regions[i].RegionType == <a class="code" href="../../d4/d9/arcinst_8h.html#a175a69">REGION_LOGICAL</a> ? <span class="stringliteral">" Logical Volume"</span> : <span class="stringliteral">" Partition"</span>);
00452                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(Regions[i].SysID) &amp;&amp; xLogical) {
00453                     strcat(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,<span class="stringliteral">", also resulting in the deletion of:"</span>);
00454                 }
00455 
00456                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a93">AlAddMenuItem</a>(MenuID,<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,i,0)) {
00457                     <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00458                     err = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00459                     <span class="keywordflow">break</span>;
00460                 }
00461             }
00462 
00463             <span class="keywordflow">if</span> (!err) {
00464 
00465                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/arcinst_8h.html#a95">AlDisplayMenu</a>(MenuID,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,0,&amp;Choice,<a class="code" href="../../d7/d3/partit_8c.html#a7">MENU_ROW</a>,<span class="stringliteral">"Select Partition to Delete"</span>)) {
00466 
00467                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/partit_8c.html#a30">IsBootSelectionPartition</a>(<a class="code" href="../../d7/d3/partit_8c.html#a21">SYSPARTVAR</a>,Disk,Regions[Choice].PartitionNumber,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00468                         Confirmation = <a class="code" href="../../d7/d3/partit_8c.html#a27">Confirm</a>(<span class="stringliteral">"The selected partition is (or contains) a system partition.\r\n Are you sure you want to delete it"</span>);
00469                     } <span class="keywordflow">else</span> {
00470                         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/partit_8c.html#a30">IsBootSelectionPartition</a>(<a class="code" href="../../d7/d3/partit_8c.html#a23">OSLOADPARTVAR</a>,Disk,Regions[Choice].PartitionNumber,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00471                             Confirmation = <a class="code" href="../../d7/d3/partit_8c.html#a27">Confirm</a>(<span class="stringliteral">"The selected partition contains an operating system.\r\n Are you sure you want to delete it"</span>);
00472                         } <span class="keywordflow">else</span> {
00473                             Confirmation = <a class="code" href="../../d7/d3/partit_8c.html#a27">Confirm</a>(<span class="stringliteral">"Are you sure"</span>);
00474                         }
00475                     }
00476                     <span class="keywordflow">if</span> (Confirmation) {
00477                         <span class="keywordflow">if</span> (((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a35">DeletePartition</a>(&amp;Regions[Choice])) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>)
00478                         || ((status = <a class="code" href="../../d8/d1/fdengine_8c.html#a68">CommitPartitionChanges</a>(Disk)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>))
00479                         {
00480                             <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a13">NODELMSG</a>,status);
00481                         } <span class="keywordflow">else</span> {
00482                             <a class="code" href="../../d7/d3/partit_8c.html#a29">PrintMsg</a>(<span class="stringliteral">"Partition deleted successfully."</span>);
00483 
00484                             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,
00485                                     <span class="stringliteral">"%spartition(%u)"</span>,
00486                                     <a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(Disk),
00487                                     Regions[Choice].PartitionNumber
00488                                    );
00489 
00490                             <span class="comment">//</span>
00491                             <span class="comment">// If there are any boot selections and the deleted partition</span>
00492                             <span class="comment">// was used, ask if the associated boot selections should be</span>
00493                             <span class="comment">// deleted.</span>
00494                             <span class="comment">//</span>
00495 
00496                             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/arc_8h.html#a39">ArcGetEnvironmentVariable</a>(<a class="code" href="../../d7/d3/partit_8c.html#a23">OSLOADPARTVAR</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00497                                 <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d3/partit_8c.html#a30">IsBootSelectionPartition</a>(<a class="code" href="../../d7/d3/partit_8c.html#a21">SYSPARTVAR</a>,Disk,Regions[Choice].PartitionNumber,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00498                                      <a class="code" href="../../d7/d3/partit_8c.html#a30">IsBootSelectionPartition</a>(<a class="code" href="../../d7/d3/partit_8c.html#a23">OSLOADPARTVAR</a>,Disk,Regions[Choice].PartitionNumber,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) &amp;&amp;
00499                                      <a class="code" href="../../d7/d3/partit_8c.html#a27">Confirm</a>(<span class="stringliteral">"Do you want to delete the boot selection(s) associated\r\n with the deleted partition?"</span>)) {
00500 
00501                                     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d3/partit_8c.html#a30">IsBootSelectionPartition</a>(<a class="code" href="../../d7/d3/partit_8c.html#a21">SYSPARTVAR</a>,Disk,Regions[Choice].PartitionNumber,&amp;MatchNumber)) {
00502                                         <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0 ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d9/arcinst_8h.html#a177a80">MaximumBootVariable</a> ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00503                                             <a class="code" href="../../d6/d8/jzcrap_8c.html#a1">JzDeleteVariableSegment</a>(<a class="code" href="../../d4/d9/arcinst_8h.html#a53">BootString</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],MatchNumber);
00504                                         }
00505                                     }
00506 
00507                                     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d3/partit_8c.html#a30">IsBootSelectionPartition</a>(<a class="code" href="../../d7/d3/partit_8c.html#a23">OSLOADPARTVAR</a>,Disk,Regions[Choice].PartitionNumber,&amp;MatchNumber)) {
00508                                         <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0 ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d9/arcinst_8h.html#a177a80">MaximumBootVariable</a> ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00509                                             <a class="code" href="../../d6/d8/jzcrap_8c.html#a1">JzDeleteVariableSegment</a>(<a class="code" href="../../d4/d9/arcinst_8h.html#a53">BootString</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>],MatchNumber);
00510                                         }
00511                                     }
00512                                 }
00513 
00514                             } <span class="keywordflow">else</span> {
00515 
00516                                 <span class="comment">//</span>
00517                                 <span class="comment">// There are no boot selections but delete all segments</span>
00518                                 <span class="comment">// of the SystemPartition variable that pointed to the</span>
00519                                 <span class="comment">// deleted partition.</span>
00520                                 <span class="comment">//</span>
00521 
00522                                 <span class="keywordflow">while</span> (<a class="code" href="../../d7/d3/partit_8c.html#a30">IsBootSelectionPartition</a>(<a class="code" href="../../d7/d3/partit_8c.html#a21">SYSPARTVAR</a>,Disk,Regions[Choice].PartitionNumber,&amp;MatchNumber)) {
00523                                     <a class="code" href="../../d6/d8/jzcrap_8c.html#a1">JzDeleteVariableSegment</a>(<a class="code" href="../../d4/d9/arcinst_8h.html#a53">BootString</a>[<a class="code" href="../../d4/d9/arcinst_8h.html#a177a75">SystemPartitionVariable</a>],MatchNumber);
00524                                 }
00525                             }
00526                         }
00527                     }
00528                 }
00529             }
00530 
00531             <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00532         }
00533         <a class="code" href="../../d4/d9/arcinst_8h.html#a92">AlFreeMenu</a>(MenuID);
00534 
00535     } <span class="keywordflow">else</span> {
00536         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<span class="stringliteral">"No partitions on this disk"</span>);
00537     }
00538 }
00539 
00540 
00541 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00542"></a><a class="code" href="../../d7/d3/partit_8c.html#a34">00542</a> <a class="code" href="../../d7/d3/partit_8c.html#a34">DoSystemPartitionCreate</a>(
00543     VOID
00544     )
00545 {
00546     ULONG      DiskNo,PartitionNo;
00547     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> status;
00548 
00549     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/partit_8c.html#a32">DoPartitionCreate</a>(&amp;DiskNo,&amp;PartitionNo)) {
00550 
00551         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,<span class="stringliteral">"%spartition(%u)"</span>,<a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(DiskNo),PartitionNo);
00552 
00553         <span class="comment">// add the partition to the SYSTEMPARTITION NVRAM environment variable</span>
00554 
00555         <span class="keywordflow">if</span> ((status = <a class="code" href="../../d4/d9/arcinst_8h.html#a84">AlAddSystemPartition</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00556             <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a17">NOEVAMSG</a>,status);
00557             <span class="keywordflow">return</span>;
00558         }
00559 
00560         <a class="code" href="../../d4/d9/arcinst_8h.html#a102">AlStatusMsgNoWait</a>(<a class="code" href="../../d7/d3/partit_8c.html#a0">STATUS_ROW_TOP</a>,<a class="code" href="../../d7/d3/partit_8c.html#a1">STATUS_ROW_BOTTOM</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<span class="stringliteral">"Formatting %s"</span>,<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>);
00561         status = <a class="code" href="../../d1/d6/fmtexp_8c.html#a16">FmtFatFormat</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,<a class="code" href="../../d8/d1/fdengine_8c.html#a44">GetHiddenSectorCount</a>(DiskNo,PartitionNo));
00562         <span class="keywordflow">if</span> (status == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00563             <a class="code" href="../../d8/d1/fdengine_8c.html#a42">SetSysID</a>(DiskNo,PartitionNo,<a class="code" href="../../d4/d9/arcinst_8h.html#a176a72">SYSID_BIGFAT</a>);
00564             <a class="code" href="../../d7/d3/partit_8c.html#a29">PrintMsg</a>(<span class="stringliteral">"Partition formatted successfully."</span>);
00565         } <span class="keywordflow">else</span> {
00566             <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a10">NOFMTMSG</a>,status);
00567         }
00568     }
00569 }
00570 
00571 
00572 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00573"></a><a class="code" href="../../d7/d3/partit_8c.html#a35">00573</a> <a class="code" href="../../d7/d3/partit_8c.html#a35">DoMakePartitionSystemPartition</a>(
00574     VOID
00575     )
00576 {
00577     BOOLEAN            f,IsFAT;
00578     ULONG              Disk,i,Choice;
00579     PVOID              MenuID;
00580     <a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html">PREGION_DESCRIPTOR</a> Regions;
00581     ULONG              RegionCount;
00582     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>         status;
00583     <span class="keywordtype">char</span>               PartitionPath[256];
00584     ULONG              PartitionNumber;
00585 
00586 
00587     <span class="comment">// take an existing partition and add it to the</span>
00588     <span class="comment">// list of system partitions.  Also make sure it's</span>
00589     <span class="comment">// formatted as FAT.</span>
00590 
00591     <span class="keywordflow">if</span> ((Disk = <a class="code" href="../../d7/d3/partit_8c.html#a31">ChooseDisk</a>()) == -1) {
00592         <span class="keywordflow">return</span>;
00593     }
00594 
00595     status = <a class="code" href="../../d4/d9/arcinst_8h.html#a31">GetUsedDiskRegions</a>(Disk,&amp;Regions,&amp;RegionCount);
00596     <span class="keywordflow">if</span> (status != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00597         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a9">NOCNFMSG</a>,status);
00598         <span class="keywordflow">return</span>;
00599     }
00600 
00601     <span class="keywordflow">if</span> (!RegionCount) {
00602         <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00603         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a20">NOPARMSG</a>);
00604         <span class="keywordflow">return</span>;
00605     }
00606 
00607     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a91">AlNewMenu</a>(&amp;MenuID)) {
00608         <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00609         <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00610         <span class="keywordflow">return</span>;
00611     }
00612 
00613     <span class="keywordflow">for</span>(i=0; i&lt;RegionCount; i++) {
00614         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d1/fdengine_8c.html#a52">IsExtended</a>(Regions[i].SysID)) {
00615             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,
00616                     <span class="stringliteral">"Partition %u (%u MB %s)"</span>,
00617                     Regions[i].PartitionNumber,
00618                     Regions[i].SizeMB,
00619                     <a class="code" href="../../d8/d1/fdengine_8c.html#a63">GetSysIDName</a>(Regions[i].SysID)
00620                    );
00621             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a93">AlAddMenuItem</a>(MenuID,<a class="code" href="../../d7/d3/partit_8c.html#a25">sprintfBuffer</a>,i,0)) {
00622                 <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00623                 <a class="code" href="../../d4/d9/arcinst_8h.html#a92">AlFreeMenu</a>(MenuID);
00624                 <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00625                 <span class="keywordflow">return</span>;
00626             }
00627         }
00628     }
00629 
00630     f = <a class="code" href="../../d4/d9/arcinst_8h.html#a95">AlDisplayMenu</a>(MenuID,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,0,&amp;Choice,<a class="code" href="../../d7/d3/partit_8c.html#a7">MENU_ROW</a>,<span class="stringliteral">"Choose Partition"</span>);
00631     <a class="code" href="../../d4/d9/arcinst_8h.html#a92">AlFreeMenu</a>(MenuID);
00632     <span class="keywordflow">if</span> (!f) {            <span class="comment">// user escaped</span>
00633         <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00634         <span class="keywordflow">return</span>;
00635     }
00636 
00637     PartitionNumber = Regions[Choice].<a class="code" href="../../d4/d9/struct__tagREGION__DESCRIPTOR.html#o3">PartitionNumber</a>;
00638     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(PartitionPath,<span class="stringliteral">"%spartition(%u)"</span>,<a class="code" href="../../d8/d1/fdengine_8c.html#a62">GetDiskName</a>(Disk),PartitionNumber);
00639 
00640     <a class="code" href="../../d8/d1/fdengine_8c.html#a38">FreeRegionArray</a>(Regions,RegionCount);
00641 
00642     <span class="keywordflow">if</span>(<a class="code" href="../../d7/d3/partit_8c.html#a30">IsBootSelectionPartition</a>(<a class="code" href="../../d7/d3/partit_8c.html#a21">SYSPARTVAR</a>,Disk,PartitionNumber,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00643         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a14">ALREAMSG</a>);
00644         <span class="keywordflow">return</span>;
00645     }
00646 
00647     status = <a class="code" href="../../d1/d6/fmtexp_8c.html#a10">FmtIsFat</a>(PartitionPath,&amp;IsFAT);
00648     <span class="keywordflow">if</span> (status != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00649         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a15">NOFILMSG</a>,status);
00650         <span class="keywordflow">return</span>;
00651     }
00652 
00653     <span class="keywordflow">if</span> (!IsFAT) {
00654         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/partit_8c.html#a27">Confirm</a>(<span class="stringliteral">"System partitions must be formatted with the FAT filesystem.\r\n Do you wish to format the chosen partition"</span>)
00655             &amp;&amp; <a class="code" href="../../d7/d3/partit_8c.html#a27">Confirm</a>(<span class="stringliteral">"All existing data will be lost.  Are you sure"</span>))
00656         {
00657             status = <a class="code" href="../../d1/d6/fmtexp_8c.html#a16">FmtFatFormat</a>(PartitionPath,<a class="code" href="../../d8/d1/fdengine_8c.html#a44">GetHiddenSectorCount</a>(Disk,PartitionNumber));
00658             <span class="keywordflow">if</span> (status != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00659                 <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a10">NOFMTMSG</a>,status);
00660                 <span class="keywordflow">return</span>;
00661             }
00662             <a class="code" href="../../d8/d1/fdengine_8c.html#a42">SetSysID</a>(Disk,PartitionNumber,<a class="code" href="../../d4/d9/arcinst_8h.html#a176a72">SYSID_BIGFAT</a>);
00663         } <span class="keywordflow">else</span> {
00664             <span class="keywordflow">return</span>;
00665         }
00666     }
00667 
00668     <span class="comment">//</span>
00669     <span class="comment">// Add to list of system partitions.</span>
00670     <span class="comment">//</span>
00671     <span class="keywordflow">if</span> ((status = <a class="code" href="../../d4/d9/arcinst_8h.html#a84">AlAddSystemPartition</a>(PartitionPath)) == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00672         <a class="code" href="../../d7/d3/partit_8c.html#a29">PrintMsg</a>(<span class="stringliteral">"Partition added successfully."</span>);
00673     } <span class="keywordflow">else</span> {
00674         <a class="code" href="../../d7/d3/partit_8c.html#a28">PrintErrorMsg</a>(<a class="code" href="../../d7/d3/partit_8c.html#a17">NOEVAMSG</a>,status);
00675     }
00676 }
00677 
00678 
00679 
00680 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00681"></a><a class="code" href="../../d7/d3/partit_8c.html#a36">00681</a> <a class="code" href="../../d7/d3/partit_8c.html#a36">ConfigureSystemPartitions</a>(
00682     VOID
00683     )
00684 {
00685     ULONG Choice=0,DiskCount=<a class="code" href="../../d8/d1/fdengine_8c.html#a61">GetDiskCount</a>();
00686     PVOID MenuID;
00687 
00688     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a91">AlNewMenu</a>(&amp;MenuID)) {
00689         <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00690         <span class="keywordflow">return</span>;
00691     }
00692 
00693     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/arcinst_8h.html#a94">AlAddMenuItems</a>(MenuID,<a class="code" href="../../d7/d3/partit_8c.html#a24">SysPartMenu</a>,<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/partit_8c.html#a24">SysPartMenu</a>)/<span class="keyword">sizeof</span>(PCHAR))) {
00694         <a class="code" href="../../d7/d3/partit_8c.html#a2">MsgNoMem</a>();
00695         <a class="code" href="../../d4/d9/arcinst_8h.html#a92">AlFreeMenu</a>(MenuID);
00696         <span class="keywordflow">return</span>;
00697     }
00698 
00699     <span class="keywordflow">while</span>(1) {
00700 
00701         <span class="keywordflow">if</span> ((!<a class="code" href="../../d4/d9/arcinst_8h.html#a95">AlDisplayMenu</a>(MenuID,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,Choice,&amp;Choice,<a class="code" href="../../d7/d3/partit_8c.html#a7">MENU_ROW</a>,<span class="stringliteral">"Configure System Partitions"</span>))
00702             || (Choice == <a class="code" href="../../d7/d3/partit_8c.html#a6">SYSPARTMENU_EXIT</a>))
00703         {
00704             <span class="keywordflow">break</span>;
00705         }
00706 
00707         <span class="keywordflow">switch</span>(Choice) {
00708 
00709         <span class="keywordflow">case</span> <a class="code" href="../../d7/d3/partit_8c.html#a3">SYSPARTMENU_CREATE</a>:
00710             <span class="comment">// create system partition.</span>
00711             <a class="code" href="../../d7/d3/partit_8c.html#a34">DoSystemPartitionCreate</a>();
00712             <span class="keywordflow">break</span>;
00713 
00714         <span class="keywordflow">case</span> <a class="code" href="../../d7/d3/partit_8c.html#a4">SYSPARTMENU_DELETE</a>:
00715             <span class="comment">// delete partition</span>
00716             <a class="code" href="../../d7/d3/partit_8c.html#a33">DoPartitionDelete</a>();
00717             <span class="keywordflow">break</span>;
00718 
00719         <span class="keywordflow">case</span> <a class="code" href="../../d7/d3/partit_8c.html#a5">SYSPARTMENU_ADD</a>:
00720             <span class="comment">// make existing into a system partition</span>
00721             <a class="code" href="../../d7/d3/partit_8c.html#a35">DoMakePartitionSystemPartition</a>();
00722             <span class="keywordflow">break</span>;
00723         }
00724     }
00725 
00726     <a class="code" href="../../d4/d9/arcinst_8h.html#a92">AlFreeMenu</a>(MenuID);
00727 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
