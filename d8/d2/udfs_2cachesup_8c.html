<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfs/cachesup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cachesup.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d9/d1/udfs_2cachesup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/udfs_2cachesup_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_CACHESUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/udfs_2cachesup_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_CACHESUP)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/udfs_2cachesup_8c.html#a2">UdfCreateInternalStream</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/udfs_2cachesup_8c.html#a3">UdfDeleteInternalStream</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/udfs_2cachesup_8c.html#a4">UdfCompleteMdl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/udfs_2cachesup_8c.html#a5">UdfMapMetadataView</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d6/d6/struct__MAPPED__PVIEW.html">PMAPPED_PVIEW</a> View, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Partition, IN ULONG Lbn, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/udfs_2cachesup_8c.html#a6">UdfPurgeVolume</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN BOOLEAN DismountUnderway)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="udfs/cachesup.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_CACHESUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00028">28</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="udfs/cachesup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_CACHESUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00034">34</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="udfs/cachesup.c::UdfCompleteMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCompleteMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00285">285</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00381">CcMdlReadComplete()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>.
<p>
<pre class="fragment"><div>00292                    :
00293 
00294     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function of completing Mdl reads.
00295     It should be called <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> from <a class="code" href="../../d7/d5/udfs_2read_8c.html#a4">UdfCommonRead</a>.
00296 
00297 Arguments:
00298 
00299     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> originating <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
00300 
00301 Return Value:
00302 
00303     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Will always be STATUS_SUCCESS.
00304 
00305 --*/
00306 
00307 {
00308     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00309 
00310     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// Do completion processing.</span>
00314     <span class="comment">//</span>
00315 
00316     FileObject = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject;
00317 
00318     <a class="code" href="../../d4/d2/cache_8h.html#a79">CcMdlReadComplete</a>( FileObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
00319 
00320     <span class="comment">//</span>
00321     <span class="comment">// Mdl is now deallocated.</span>
00322     <span class="comment">//</span>
00323 
00324     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Complete the request and exit right away.</span>
00328     <span class="comment">//</span>
00329 
00330     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00331 
00332     <span class="keywordflow">return</span> STATUS_SUCCESS;
00333 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="udfs/cachesup.c::UdfCreateInternalStream" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfCreateInternalStream           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">46</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00342">ASSERT_FCB_INDEX</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00287">_UDF_DATA::CacheManagerCallbacks</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01529">_FILE_OBJECT::DeleteAccess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05378">IoCreateStreamFileObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01527">_FILE_OBJECT::ReadAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01521">_FILE_OBJECT::SectionObjectPointer</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00042">UdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01770">UdfDecrementReferenceCounts</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01762">UdfIncrementReferenceCounts</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00049">UdfSetFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01528">_FILE_OBJECT::WriteAccess</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.
<p>
<pre class="fragment"><div>00054                    :
00055 
00056     This function creates an internal stream <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> interaction
00057     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache manager.  The Fcb here will be <span class="keywordflow">for</span> a directory
00058     stream.
00059 
00060 Arguments:
00061 
00062     Vcb - Vcb <span class="keywordflow">for</span> <span class="keyword">this</span> volume.
00063 
00064     Fcb - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> Fcb.
00065 
00066 Return Value:
00067 
00068     None.
00069 
00070 --*/
00071 
00072 {
00073     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> StreamFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00074     BOOLEAN DecrementReference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00075 
00076     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">//  Check inputs.</span>
00080     <span class="comment">//</span>
00081 
00082     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00083     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">//  We may only have the Fcb shared.  Lock the Fcb and do a</span>
00087     <span class="comment">//  safe test to see if we need to really create the file object.</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00091 
00092     <span class="keywordflow">if</span> (Fcb-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00093 
00094         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00095         <span class="keywordflow">return</span>;
00096     }
00097 
00098     <span class="comment">//</span>
00099     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00100     <span class="comment">//</span>
00101 
00102     <span class="keywordflow">try</span> {
00103 
00104         <span class="comment">//</span>
00105         <span class="comment">//  Create the internal stream.  The Vpb should be pointing at our volume</span>
00106         <span class="comment">//  device object at this point.</span>
00107         <span class="comment">//</span>
00108 
00109         StreamFile = <a class="code" href="../../d4/d6/iosubs_8c.html#a48">IoCreateStreamFileObject</a>( NULL, Vcb-&gt;Vpb-&gt;RealDevice );
00110 
00111         <span class="keywordflow">if</span> (StreamFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00112 
00113             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES );
00114         }
00115 
00116         <span class="comment">//</span>
00117         <span class="comment">//  Initialize the fields of the file object.</span>
00118         <span class="comment">//</span>
00119 
00120         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o12">ReadAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00121         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o13">WriteAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00122         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o14">DeleteAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00123 
00124         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a> = &amp;Fcb-&gt;FcbNonpaged-&gt;SegmentObject;
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">//  Set the file object type and increment the Vcb counts.</span>
00128         <span class="comment">//</span>
00129 
00130         <a class="code" href="../../d3/d8/udfprocs_8h.html#a173">UdfSetFileObject</a>( IrpContext,
00131                          StreamFile,
00132                          StreamFileOpen,
00133                          Fcb,
00134                          NULL );
00135 
00136         <span class="comment">//</span>
00137         <span class="comment">//  We will reference the current Fcb twice to keep it from going</span>
00138         <span class="comment">//  away in the error path.  Otherwise if we dereference it</span>
00139         <span class="comment">//  below in the finally clause a close could cause the Fcb to</span>
00140         <span class="comment">//  be deallocated.</span>
00141         <span class="comment">//</span>
00142 
00143         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00144         
00145         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, 
00146                      <span class="stringliteral">"UdfCreateInternalStream, Fcb %08x Vcb %d/%d Fcb %d/%d\n"</span>,
00147                      Fcb,
00148                      Vcb-&gt;VcbReference,
00149                      Vcb-&gt;VcbUserReference,
00150                      Fcb-&gt;FcbReference,
00151                      Fcb-&gt;FcbUserReference ));
00152 
00153         <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, Fcb, 2, 0 );
00154         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00155         DecrementReference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">//  Initialize the cache map for the file.</span>
00159         <span class="comment">//</span>
00160 
00161         <a class="code" href="../../d4/d2/cache_8h.html#a58">CcInitializeCacheMap</a>( StreamFile,
00162                               (<a class="code" href="../../d1/d9/struct__CC__FILE__SIZES.html">PCC_FILE_SIZES</a>)&amp;Fcb-&gt;AllocationSize,
00163                               TRUE,
00164                               &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>,
00165                               Fcb );
00166 
00167         <span class="comment">//</span>
00168         <span class="comment">//  Go ahead and store the stream file into the Fcb.</span>
00169         <span class="comment">//</span>
00170 
00171         Fcb-&gt;FileObject = StreamFile;
00172         StreamFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00173 
00174     } finally {
00175 
00176         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfCreateInternalStream"</span> );
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">//  If we raised then we need to dereference the file object.</span>
00180         <span class="comment">//</span>
00181 
00182         <span class="keywordflow">if</span> (StreamFile != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00183 
00184             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( StreamFile );
00185             Fcb-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00186         }
00187 
00188         <span class="comment">//</span>
00189         <span class="comment">//  Dereference and unlock the Fcb.</span>
00190         <span class="comment">//</span>
00191 
00192         <span class="keywordflow">if</span> (DecrementReference) {
00193 
00194             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00195             <a class="code" href="../../d3/d8/udfprocs_8h.html#a99">UdfDecrementReferenceCounts</a>( IrpContext, Fcb, 1, 0 );
00196             
00197             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, 
00198                          <span class="stringliteral">"UdfCreateInternalStream, Vcb %d/%d Fcb %d/%d\n"</span>,
00199                          Vcb-&gt;VcbReference,
00200                          Vcb-&gt;VcbUserReference,
00201                          Fcb-&gt;FcbReference,
00202                          Fcb-&gt;FcbUserReference ));
00203 
00204             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00205         }
00206 
00207         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00208     }
00209 
00210     <span class="keywordflow">return</span>;
00211 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="udfs/cachesup.c::UdfDeleteInternalStream" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfDeleteInternalStream           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00215">215</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01522">_FILE_OBJECT::PrivateCacheMap</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.
<p>
<pre class="fragment"><div>00222                    :
00223 
00224     This function creates an internal stream <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> interaction
00225     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache manager.  The Fcb here can be <span class="keywordflow">for</span> either a
00226     directory stream or <span class="keywordflow">for</span> a metadata stream.
00227 
00228 Arguments:
00229 
00230     Fcb - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either an <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> or
00231         Metadata Fcb.
00232 
00233 Return Value:
00234 
00235     None.
00236 
00237 --*/
00238 
00239 {
00240     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00241 
00242     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00243 
00244     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00245     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
00246 
00247     <span class="comment">//</span>
00248     <span class="comment">//  Lock the Fcb.</span>
00249     <span class="comment">//</span>
00250 
00251     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">//  Capture the file object.</span>
00255     <span class="comment">//</span>
00256 
00257     FileObject = Fcb-&gt;FileObject;
00258     Fcb-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">//  It is now safe to unlock the Fcb.</span>
00262     <span class="comment">//</span>
00263 
00264     <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">//  Dereference the file object if present.</span>
00268     <span class="comment">//</span>
00269 
00270     <span class="keywordflow">if</span> (FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00271 
00272         <span class="keywordflow">if</span> (FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o7">PrivateCacheMap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00273 
00274             <a class="code" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap</a>( FileObject, NULL, NULL );
00275         }
00276 
00277         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
00278     }
00279 
00280     <span class="keywordflow">return</span>;
00281 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="udfs/cachesup.c::UdfMapMetadataView" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfMapMetadataView           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MAPPED__PVIEW.html">PMAPPED_PVIEW</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>View</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Partition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00337">337</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00220">LlBytesFromSectors</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a103">PMAPPED_PVIEW</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00828">UdfUnpinView</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04144">UdfGetNextAllocationPostProcessing()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03060">UdfInitializeIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">UdfInitializeIcbContextFromFcb()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03790">UdfLookupActiveIcbInExtent()</a>.
<p>
<pre class="fragment"><div>00348                    :
00349 
00350     Perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common work of mapping an extent of metadata into a mapped view.
00351 
00352 Arguments:
00353 
00354     View - View structure to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes into
00355     
00356     Vcb - Vcb of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> on
00357     
00358     Partition - Partition of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent
00359     
00360     Lbn - Lbn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent
00361     
00362     Length - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent
00363 
00364 Return Value:
00365 
00366     None.
00367 
00368 --*/
00369 
00370 {
00371     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00372     ULONG Vsn;
00373 
00374     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">//  Remove any existing mapping</span>
00378     <span class="comment">//</span>
00379     
00380     <a class="code" href="../../d3/d8/udfprocs_8h.html#a68">UdfUnpinView</a>( IrpContext, View );
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">//  Update the view information.</span>
00384     <span class="comment">//</span>
00385 
00386     View-&gt;Partition = Partition;
00387     View-&gt;Lbn = Lbn;
00388     View-&gt;Length = Length;
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">//  Find the mapping of this extent in the Metadata stream.</span>
00392     <span class="comment">//</span>
00393 
00394     Vsn = <a class="code" href="../../d3/d8/udfprocs_8h.html#a153">UdfLookupMetaVsnOfExtent</a>( IrpContext,
00395                                     Vcb,
00396                                     Partition,
00397                                     Lbn,
00398                                     Length,
00399                                     FALSE );
00400 
00401     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Vcb, Vsn );
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  Map the extent</span>
00405     <span class="comment">//</span>
00406 
00407     <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Vcb-&gt;MetadataFcb-&gt;FileObject,
00408                &amp;Offset,
00409                Length,
00410                TRUE,
00411                &amp;View-&gt;Bcb,
00412                &amp;View-&gt;View );
00413 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="udfs/cachesup.c::UdfPurgeVolume" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPurgeVolume           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DismountUnderway</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">417</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d6/d7/fssup_8c-source.html#l02331">CcPurgeCacheSection()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01471">_SECTION_OBJECT_POINTERS::DataSectionObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01027">_FCB::FcbNonpaged</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00979">_FCB::FcbReference</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01473">_SECTION_OBJECT_POINTERS::ImageSectionObject</a>, <a class="el" href="../../d2/d1/mm_8h.html#a346a180">MmFlushForWrite</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02094">MmFlushImageSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00853">_FCB_NONPAGED::SegmentObject</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01524">UdfAcquireAllFiles</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00215">UdfDeleteInternalStream()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01997">UdfGetNextFcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01527">UdfReleaseAllFiles</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">UdfDismountVcb()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00621">UdfLockVolumeInternal()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00425                    :
00426 
00427     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to purge <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.  The purpose <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to make all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stale <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00428     objects in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system go away, minimizing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference counts, so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume may
00429     be locked or deleted.
00430 
00431     The Vcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already acquired exclusively.  We will lock <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> all <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> operations by
00432     acquiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> resource.  Then we will walk through all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb's and
00433     perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge.
00434 
00435 Arguments:
00436 
00437     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to purge.
00438 
00439     DismountUnderway - Indicates that we are trying to <span class="keyword">delete</span> all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects.
00440         We will purge <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Metadata and VolumeDasd and dereference all internal streams.
00441 
00442 Return Value:
00443 
00444     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The first <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge operation.
00445 
00446 --*/
00447 
00448 {
00449     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00450 
00451     PVOID RestartKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00452     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> ThisFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00453     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb;
00454 
00455     BOOLEAN RemovedFcb;
00456 
00457     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">//  Force any remaining Fcb's in the delayed close queue to be closed.</span>
00461     <span class="comment">//</span>
00462 
00463     <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">//  Acquire the global file resource.</span>
00467     <span class="comment">//</span>
00468 
00469     <a class="code" href="../../d3/d8/udfprocs_8h.html#a77">UdfAcquireAllFiles</a>( IrpContext, Vcb );
00470 
00471     <span class="comment">//</span>
00472     <span class="comment">//  Loop through each Fcb in the Fcb Table and perform the flush.</span>
00473     <span class="comment">//</span>
00474 
00475     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00476 
00477         <span class="comment">//</span>
00478         <span class="comment">//  Lock the Vcb to lookup the next Fcb.</span>
00479         <span class="comment">//</span>
00480 
00481         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00482         NextFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a212">UdfGetNextFcb</a>( IrpContext, Vcb, &amp;RestartKey );
00483 
00484         <span class="comment">//</span>
00485         <span class="comment">//  Reference the NextFcb if present.</span>
00486         <span class="comment">//</span>
00487 
00488         <span class="keywordflow">if</span> (NextFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00489 
00490             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> += 1;
00491         }
00492 
00493         <span class="comment">//</span>
00494         <span class="comment">//  If the last Fcb is present then decrement reference count and call teardown</span>
00495         <span class="comment">//  to see if it should be removed.</span>
00496         <span class="comment">//</span>
00497 
00498         <span class="keywordflow">if</span> (ThisFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00499 
00500             ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> -= 1;
00501 
00502             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00503 
00504             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00505 
00506         } <span class="keywordflow">else</span> {
00507 
00508             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00509         }
00510 
00511         <span class="comment">//</span>
00512         <span class="comment">//  Break out of the loop if no more Fcb's.</span>
00513         <span class="comment">//</span>
00514 
00515         <span class="keywordflow">if</span> (NextFcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00516 
00517             <span class="keywordflow">break</span>;
00518         }
00519 
00520         <span class="comment">//</span>
00521         <span class="comment">//  Move to the next Fcb.</span>
00522         <span class="comment">//</span>
00523 
00524         ThisFcb = NextFcb;
00525 
00526         <span class="comment">//</span>
00527         <span class="comment">//  If there is a image section then see if that can be closed.</span>
00528         <span class="comment">//</span>
00529 
00530         <span class="keywordflow">if</span> (ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o2">ImageSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00531 
00532             <a class="code" href="../../d6/d5/flushsec_8c.html#a13">MmFlushImageSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>, MmFlushForWrite );
00533         }
00534 
00535         <span class="comment">//</span>
00536         <span class="comment">//  If there is a data section then purge this.  If there is an image</span>
00537         <span class="comment">//  section then we won't be able to.  Remember this if it is our first</span>
00538         <span class="comment">//  error.</span>
00539         <span class="comment">//</span>
00540 
00541         <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00542             !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00543                                    NULL,
00544                                    0,
00545                                    FALSE ) &amp;&amp;
00546             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00547 
00548             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00549         }
00550 
00551         <span class="comment">//</span>
00552         <span class="comment">//  Dereference the internal stream if dismounting.</span>
00553         <span class="comment">//</span>
00554 
00555         <span class="keywordflow">if</span> (DismountUnderway &amp;&amp;
00556             (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( ThisFcb ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>) &amp;&amp;
00557             (ThisFcb-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00558 
00559             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00560         }
00561     }
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">//  Now look at the Root Index, Metadata, Volume Dasd and VAT Fcbs.</span>
00565     <span class="comment">//  Note that we usually hit the Root Index in the loop above, but</span>
00566     <span class="comment">//  it is possible miss it if it didn't get into the Fcb table in the</span>
00567     <span class="comment">//  first place!</span>
00568     <span class="comment">//</span>
00569 
00570     <span class="keywordflow">if</span> (DismountUnderway) {
00571 
00572         <span class="keywordflow">if</span> (Vcb-&gt;RootIndexFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00573 
00574             ThisFcb = Vcb-&gt;RootIndexFcb;
00575             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00576 
00577             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00578                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00579                                        NULL,
00580                                        0,
00581                                        FALSE ) &amp;&amp;
00582                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00583 
00584                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00585             }
00586 
00587             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00588             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00589             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00590         }
00591         
00592         <span class="keywordflow">if</span> (Vcb-&gt;MetadataFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00593 
00594             ThisFcb = Vcb-&gt;MetadataFcb;
00595             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00596 
00597             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00598                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00599                                        NULL,
00600                                        0,
00601                                        FALSE ) &amp;&amp;
00602                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00603 
00604                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00605             }
00606 
00607             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00608             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00609             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00610         }
00611 
00612         <span class="keywordflow">if</span> (Vcb-&gt;VatFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00613 
00614             ThisFcb = Vcb-&gt;VatFcb;
00615             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00616 
00617             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00618                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00619                                        NULL,
00620                                        0,
00621                                        FALSE ) &amp;&amp;
00622                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00623 
00624                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00625             }
00626 
00627             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00628             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00629             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00630         }
00631 
00632         <span class="keywordflow">if</span> (Vcb-&gt;VolumeDasdFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00633 
00634             ThisFcb = Vcb-&gt;VolumeDasdFcb;
00635             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00636 
00637             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00638                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00639                                        NULL,
00640                                        0,
00641                                        FALSE ) &amp;&amp;
00642                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00643 
00644                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00645             }
00646 
00647             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00648             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00649         }
00650     }
00651 
00652     <span class="comment">//</span>
00653     <span class="comment">//  Release all of the files.</span>
00654     <span class="comment">//</span>
00655 
00656     <a class="code" href="../../d3/d8/udfprocs_8h.html#a78">UdfReleaseAllFiles</a>( IrpContext, Vcb );
00657 
00658     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00659 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
