<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: drivesup.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>drivesup.h File Reference</h1>
<p>
<a href="../../d9/d1/drivesup_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/drivesup_8h.html#a0">BOOTABLE_PARTITION</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/drivesup_8h.html#a1">PRIMARY_PARTITION</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/drivesup_8h.html#a2">LOGICAL_PARTITION</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/drivesup_8h.html#a3">FT_PARTITION</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/drivesup_8h.html#a4">OTHER_PARTITION</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/drivesup_8h.html#a5">xHalIoClearPartitionTable</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG SectorSize, IN ULONG SectorsPerTrack, IN ULONG NumberOfHeads)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="drivesup.h::BOOTABLE_PARTITION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BOOTABLE_PARTITION&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/drivesup_8h-source.html#l00020">20</a> of file <a class="el" href="../../d9/d1/drivesup_8h-source.html">drivesup.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="drivesup.h::FT_PARTITION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FT_PARTITION&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/drivesup_8h-source.html#l00023">23</a> of file <a class="el" href="../../d9/d1/drivesup_8h-source.html">drivesup.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="drivesup.h::LOGICAL_PARTITION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOGICAL_PARTITION&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/drivesup_8h-source.html#l00022">22</a> of file <a class="el" href="../../d9/d1/drivesup_8h-source.html">drivesup.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="drivesup.h::OTHER_PARTITION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OTHER_PARTITION&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/drivesup_8h-source.html#l00024">24</a> of file <a class="el" href="../../d9/d1/drivesup_8h-source.html">drivesup.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="drivesup.h::PRIMARY_PARTITION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PRIMARY_PARTITION&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/drivesup_8h-source.html#l00021">21</a> of file <a class="el" href="../../d9/d1/drivesup_8h-source.html">drivesup.h</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="drivesup.h::xHalIoClearPartitionTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FASTCALL xHalIoClearPartitionTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorsPerTrack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfHeads</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/drivesup_8c-source.html#l03486">3486</a> of file <a class="el" href="../../d8/d1/drivesup_8c-source.html">drivesup.c</a>.
<p>
References <a class="el" href="../../d3/d6/hal_8h-source.html#l00157">BOOT_RECORD_SIGNATURE</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l00151">BOOT_SIGNATURE_OFFSET</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01545">HalExamineMBR</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01933">IoBuildSynchronousFsdRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00059">IRP_MJ_WRITE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a177">NonPagedPoolCacheAligned</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01874">SL_OVERRIDE_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d7/d2/drivesup_8c.html#a9">WHICH_BIT</a>, and <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00382">xHalGetPartialGeometry()</a>.
<p>
<pre class="fragment"><div>03495                    :
03496 
03497     This routine walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk writing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition tables from
03498     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition list buffer <span class="keywordflow">for</span> each partition.
03499 
03500     Applications that create and <span class="keyword">delete</span> partitions should issue a
03501     <a class="code" href="../../d2/d7/hal_8h.html#a192">IoReadPartitionTable</a> call with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> '<span class="keywordflow">return</span> recognized partitions'
03502     <span class="keywordtype">boolean</span> set to <span class="keyword">false</span> to get a full description of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
03503 
03504     Then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drive layout structure can be modified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> application to
03505     reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> configuration of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk and then <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> written back
03506     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk <span class="keyword">using</span> <span class="keyword">this</span> routine.
03507 
03508 Arguments:
03509 
03510     DeviceObject - Pointer to device object <span class="keywordflow">for</span> <span class="keyword">this</span> disk.
03511 
03512     <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> - Sector size on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device.
03513 
03514     SectorsPerTrack - Track size on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device.
03515 
03516     NumberOfHeads - Same as tracks per cylinder.
03517 
03518 Return Value:
03519 
03520     The functional value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> STATUS_SUCCESS <span class="keywordflow">if</span> all writes are completed
03521     without error.
03522 
03523 --*/
03524 
03525 {
03526 <span class="keyword">typedef</span> <span class="keyword">struct </span>_PARTITION_TABLE {
03527     PARTITION_INFORMATION PartitionEntry[4];
03528 } PARTITION_TABLE, *PPARTITION_TABLE;
03529 
03530 <span class="keyword">typedef</span> <span class="keyword">struct </span>_DISK_LAYOUT {
03531     ULONG TableCount;
03532     ULONG Signature;
03533     PARTITION_TABLE PartitionTable[1];
03534 } DISK_LAYOUT, *PDISK_LAYOUT;
03535 
03536 <span class="keyword">typedef</span> <span class="keyword">struct </span>_PTE {
03537     UCHAR ActiveFlag;               <span class="comment">// Bootable or not</span>
03538     UCHAR StartingTrack;            <span class="comment">// Not used</span>
03539     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> StartingCylinder;        <span class="comment">// Not used</span>
03540     UCHAR PartitionType;            <span class="comment">// 12 bit FAT, 16 bit FAT etc.</span>
03541     UCHAR EndingTrack;              <span class="comment">// Not used</span>
03542     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> EndingCylinder;          <span class="comment">// Not used</span>
03543     ULONG StartingSector;           <span class="comment">// Hidden sectors</span>
03544     ULONG PartitionLength;          <span class="comment">// Sectors in this partition</span>
03545 } PTE;
03546 <span class="keyword">typedef</span> PTE UNALIGNED *PPTE;
03547 
03548 <span class="comment">//</span>
03549 <span class="comment">// This macro has the effect of Bit = log2(Data)</span>
03550 <span class="comment">//</span>
03551 
03552 <span class="preprocessor">#define WHICH_BIT(Data, Bit) {                      \</span>
03553 <span class="preprocessor">    for (Bit = 0; Bit &lt; 32; Bit++) {                \</span>
03554 <span class="preprocessor">        if ((Data &gt;&gt; Bit) == 1) {                   \</span>
03555 <span class="preprocessor">            break;                                  \</span>
03556 <span class="preprocessor">        }                                           \</span>
03557 <span class="preprocessor">    }                                               \</span>
03558 <span class="preprocessor">}</span>
03559 <span class="preprocessor"></span>
03560     ULONG writeSize;
03561     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> writeBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03562     PPARTITION_TABLE partitionTable;
03563     CCHAR shiftCount;
03564     LARGE_INTEGER partitionTableOffset;
03565     LARGE_INTEGER nextRecordOffset;
03566     ULONG partitionTableCount;
03567     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
03568     IO_STATUS_BLOCK ioStatus;
03569     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
03570     BOOLEAN rewritePartition = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03571     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
03572     LARGE_INTEGER tempInt;
03573     BOOLEAN foundEZHooker = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03574     ULONG conventionalCylinders;
03575     LONGLONG diskSize;
03576 
03577     BOOLEAN isSuperFloppy = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03578 
03579     <span class="comment">//</span>
03580     <span class="comment">// Ensure that no one is calling this function illegally.</span>
03581     <span class="comment">//</span>
03582 
03583     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03584 
03585     <span class="comment">//</span>
03586     <span class="comment">// Determine the size of a write operation to ensure that at least 512</span>
03587     <span class="comment">// bytes are written.  This will guarantee that enough data is written to</span>
03588     <span class="comment">// include an entire partition table.  Note that this code assumes that</span>
03589     <span class="comment">// the actual sector size of the disk (if less than 512 bytes) is a</span>
03590     <span class="comment">// multiple of 2, a fairly reasonable assumption.</span>
03591     <span class="comment">//</span>
03592 
03593     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> &gt;= 512) {
03594         writeSize = <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
03595     } <span class="keywordflow">else</span> {
03596         writeSize = 512;
03597     }
03598 
03599     <a class="code" href="../../d7/d2/drivesup_8c.html#a21">xHalGetPartialGeometry</a>( DeviceObject,
03600                             &amp;conventionalCylinders,
03601                             &amp;diskSize );
03602 
03603     <span class="comment">//</span>
03604     <span class="comment">// Look to see if this is an EZDrive Disk.  If it is then get the</span>
03605     <span class="comment">// real partititon table at 1.</span>
03606     <span class="comment">//</span>
03607 
03608     {
03609 
03610         PVOID buff;
03611 
03612         <a class="code" href="../../d2/d7/hal_8h.html#a23">HalExamineMBR</a>(
03613             DeviceObject,
03614             writeSize,
03615             (ULONG)0x55,
03616             &amp;buff
03617             );
03618 
03619         <span class="keywordflow">if</span> (buff) {
03620 
03621             foundEZHooker = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03622             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buff);
03623             partitionTableOffset.QuadPart = 512;
03624 
03625         } <span class="keywordflow">else</span> {
03626 
03627             partitionTableOffset.QuadPart = 0;
03628 
03629         }
03630 
03631     }
03632 
03633     <span class="comment">//</span>
03634     <span class="comment">// Calculate shift count for converting between byte and sector.</span>
03635     <span class="comment">//</span>
03636 
03637     <a class="code" href="../../d7/d2/drivesup_8c.html#a9">WHICH_BIT</a>( SectorSize, shiftCount );
03638 
03639     <span class="comment">//</span>
03640     <span class="comment">// Allocate a buffer for the sector writes.</span>
03641     <span class="comment">//</span>
03642 
03643     writeBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPoolCacheAligned, PAGE_SIZE, 'btsF');
03644 
03645     <span class="keywordflow">if</span> (writeBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03646         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03647     }
03648 
03649     <span class="comment">//</span>
03650     <span class="comment">// Read the boot record that's already there into the write buffer</span>
03651     <span class="comment">// and save its boot code area if the signature is valid.  This way</span>
03652     <span class="comment">// we don't clobber any boot code that might be there already.</span>
03653     <span class="comment">//</span>
03654 
03655     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
03656 
03657     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( IRP_MJ_READ,
03658                                         DeviceObject,
03659                                         writeBuffer,
03660                                         writeSize,
03661                                         &amp;partitionTableOffset,
03662                                         &amp;event,
03663                                         &amp;ioStatus );
03664 
03665     <span class="keywordflow">if</span> (!irp) {
03666         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(writeBuffer);
03667         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03668     }
03669 
03670     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, irp );
03671 
03672     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
03673         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
03674                                   Executive,
03675                                   KernelMode,
03676                                   FALSE,
03677                                   (PLARGE_INTEGER) NULL);
03678         status = ioStatus.Status;
03679     }
03680 
03681     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03682         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(writeBuffer);
03683         <span class="keywordflow">return</span> status;
03684     }
03685 
03686     <span class="comment">//</span>
03687     <span class="comment">// If there's an 0xaa55 in the MBR signature, clear it out.  </span>
03688     <span class="comment">//</span>
03689 
03690     <span class="keywordflow">if</span>(writeBuffer[<a class="code" href="../../d2/d7/hal_8h.html#a11">BOOT_SIGNATURE_OFFSET</a>] == <a class="code" href="../../d2/d7/hal_8h.html#a12">BOOT_RECORD_SIGNATURE</a>) {
03691         writeBuffer[<a class="code" href="../../d2/d7/hal_8h.html#a11">BOOT_SIGNATURE_OFFSET</a>] += 0x1111;
03692     }
03693     
03694     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( IRP_MJ_WRITE,
03695                                     DeviceObject,
03696                                     writeBuffer,
03697                                     writeSize,
03698                                     &amp;partitionTableOffset,
03699                                     &amp;event,
03700                                     &amp;ioStatus );
03701 
03702     <span class="keywordflow">if</span> (!irp) {
03703         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(writeBuffer);
03704         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03705     } <span class="keywordflow">else</span> {
03706         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpStack;
03707         irpStack = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(irp);
03708         irpStack-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a203">SL_OVERRIDE_VERIFY_VOLUME</a>;
03709     }
03710 
03711     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, irp );
03712 
03713     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
03714         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
03715                                   Executive,
03716                                   KernelMode,
03717                                   FALSE,
03718                                   (PLARGE_INTEGER) NULL);
03719         status = ioStatus.Status;
03720     }
03721 
03722     <span class="comment">//</span>
03723     <span class="comment">// Deallocate write buffer if it was allocated it.</span>
03724     <span class="comment">//</span>
03725 
03726     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( writeBuffer );
03727 
03728     <span class="keywordflow">return</span> status;
03729 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
