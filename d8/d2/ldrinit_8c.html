<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ldrinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ldrinit.c File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;nt.h&gt;</code><br>
<code>#include &lt;ntrtl.h&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d4/d8/heap_8h-source.html">heap.h</a>&gt;</code><br>
<code>#include &lt;apcompat.h&gt;</code><br>
<code>#include "<a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>"</code><br>
<code>#include &lt;ctype.h&gt;</code><br>

<p>
<a href="../../d9/d1/ldrinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a14">LdrpRelocateStartContext</a> (IN PCONTEXT Context, IN LONG_PTR Diff)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a15">LdrpForkProcess</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a16">LdrpInitializeThread</a> (IN PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a17">NtdllOkayToLockRoutine</a> (IN PVOID Lock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a18">RtlpInitDeferedCriticalSection</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a19">LdrQueryApplicationCompatibilityGoo</a> (IN PUNICODE_STRING UnicodeImageName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a20">LdrFindAppCompatVariableInfo</a> (IN ULONG dwTypeSeeking, OUT PAPP_VARIABLE_INFO *AppVariableInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a21">LdrpSearchResourceSection_U</a> (IN PVOID DllHandle, IN PULONG_PTR ResourceIdPath, IN ULONG ResourceIdPathLength, IN BOOLEAN FindDirectoryEntry, IN BOOLEAN ExactLangMatchOnly, OUT PVOID *ResourceDirectoryOrData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a22">LdrpAccessResourceData</a> (IN PVOID DllHandle, IN PIMAGE_RESOURCE_DATA_ENTRY ResourceDataEntry, OUT PVOID *Address OPTIONAL, OUT PULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a23">NtdllpAllocateStringRoutine</a> (SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a24">NtdllpFreeStringRoutine</a> (PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a25">LdrpInitializationFailure</a> (IN NTSTATUS FailureCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a26">LdrpInitialize</a> (IN PCONTEXT Context, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a27">LdrpInitializeProcess</a> (IN PCONTEXT Context OPTIONAL, IN PVOID SystemDllBase, IN PUNICODE_STRING UnicodeImageName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a28">LdrShutdownProcess</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a29">LdrShutdownThread</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a> (IN PUNICODE_STRING ImagePathName, IN PWSTR OptionName, IN ULONG Type, OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, OUT PULONG ResultSize OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a31">LdrpInitializeTls</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a32">LdrpAllocateTls</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a33">LdrpFreeTls</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a34">LdrpCallTlsInitializers</a> (PVOID DllBase, ULONG Reason)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a35">GetNextCommaValue</a> (IN OUT WCHAR **p, IN OUT ULONG *len)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a2">LdrpVerifyDlls</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a3">LdrpLdrDatabaseIsSetup</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a6">RtlpDisableHeapLookaside</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_ALLOCATE_STRING_ROUTINE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_FREE_STRING_ROUTINE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>RTL_BITMAP&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a9">TlsBitMap</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>RTL_BITMAP&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a10">TlsExpansionBitMap</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>RTL_CRITICAL_SECTION_DEBUG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a11">LoaderLockDebug</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>RTL_CRITICAL_SECTION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/ldrinit_8c.html#a13">LoaderLockInitialized</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a35" doxytag="ldrinit.c::GetNextCommaValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG GetNextCommaValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT WCHAR **&nbsp;</td>
          <td class="mdname" nowrap> <em>p</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02246">2246</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02277">LdrQueryApplicationCompatibilityGoo()</a>.
<p>
<pre class="fragment"><div>02247 {
02248     ULONG Number = 0;
02249 
02250     <span class="keywordflow">while</span> (*len &amp;&amp; (UNICODE_NULL != **p) &amp;&amp; **p != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">','</span>)
02251     {
02252         <span class="comment">// Let's ignore spaces</span>
02253         <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span> != **p )
02254         {
02255             Number = (Number * 10) + ( (ULONG)**p - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span> );
02256         }
02257 
02258         (*p)++;
02259         (*len)--;
02260     }
02261 
02262     <span class="comment">//</span>
02263     <span class="comment">// If we're at a comma, get past it for the next call</span>
02264     <span class="comment">//</span>
02265     <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">','</span> == **p )
02266     {
02267         (*p)++;
02268         (*len)--;
02269     }
02270 
02271     <span class="keywordflow">return</span> Number;
02272 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="ldrinit.c::LdrFindAppCompatVariableInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrFindAppCompatVariableInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwTypeSeeking</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PAPP_VARIABLE_INFO *&nbsp;</td>
          <td class="mdname" nowrap> <em>AppVariableInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02683">2683</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02277">LdrQueryApplicationCompatibilityGoo()</a>.
<p>
<pre class="fragment"><div>02690                    :
02691 
02692     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to find a variable length <span class="keyword">struct </span>by its <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
02693     The caller specifies what <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> its looking for and this function chews
02694     thru all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> variable length structs to find <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns
02695     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer and <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a85">else</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
02696 
02697 Arguments:
02698 
02699     dwTypeSeeking - AVT that you are looking for
02700 
02701     AppVariableInfo - pointer to pointer of variable info to be returned
02702 
02703 Return Value:
02704 
02705     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> if entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found
02706 
02707 --*/
02708 
02709 {
02710     PPEB Peb;
02711     ULONG TotalSize;
02712     ULONG CurOffset;
02713     PAPP_VARIABLE_INFO pCurrentEntry;
02714 
02715     Peb = NtCurrentPeb();
02716     <span class="keywordflow">if</span> (Peb-&gt;AppCompatInfo) {
02717 
02718         <span class="comment">//</span>
02719         <span class="comment">// Since we're not dealing with a fixed-size structure, TotalSize</span>
02720         <span class="comment">// will keep us from running off the end of the data list</span>
02721         <span class="comment">//</span>
02722         TotalSize = ((PAPP_COMPAT_INFO) Peb-&gt;AppCompatInfo)-&gt;dwTotalSize;
02723 
02724         <span class="comment">//</span>
02725         <span class="comment">// The first variable structure (if there is one) will start</span>
02726         <span class="comment">// immediately after the fixed stuff</span>
02727         <span class="comment">//</span>
02728         CurOffset = <span class="keyword">sizeof</span>(APP_COMPAT_INFO);
02729 
02730         <span class="keywordflow">while</span> (CurOffset &lt; TotalSize) {
02731 
02732             pCurrentEntry = (PAPP_VARIABLE_INFO) ((PUCHAR)(Peb-&gt;AppCompatInfo) + CurOffset);
02733 
02734             <span class="comment">//</span>
02735             <span class="comment">// Have we found what we're looking for?</span>
02736             <span class="comment">//</span>
02737             <span class="keywordflow">if</span> (dwTypeSeeking == pCurrentEntry-&gt;dwVariableType) {
02738                 *AppVariableInfo = pCurrentEntry;
02739                 <span class="keywordflow">return</span> (STATUS_SUCCESS);
02740             }
02741 
02742             <span class="comment">//</span>
02743             <span class="comment">// Let's go look at the next blob</span>
02744             <span class="comment">//</span>
02745             CurOffset += (ULONG)(pCurrentEntry-&gt;dwVariableInfoSize);
02746         }
02747 
02748     }
02749 
02750     <span class="keywordflow">return</span> (STATUS_NOT_FOUND);
02751 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="ldrinit.c::LdrpAccessResourceData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpAccessResourceData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIMAGE_RESOURCE_DATA_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceDataEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *Address&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l00096">96</a> of file <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html">ldrrsrc.c</a>.
<p>
<pre class="fragment"><div>00105                    :
00106 
00107     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data necessary to actually examine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00108     contents of a particular resource.
00109 
00110 Arguments:
00111 
00112     DllHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00113         contained in.
00114 
00115     ResourceDataEntry - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource data entry in
00116    <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource data directory of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00117         DllHandle parameter.  This pointer should have been one returned
00118         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LdrFindResource function.
00119 
00120     Address - Optional pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00121         address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first two parameters.
00122 
00123     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Optional pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of
00124         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first two parameters.
00125 
00126 
00127 Return Value:
00128 
00129     TBD
00130 
00131 --*/
00132 
00133 {
00134     PIMAGE_RESOURCE_DIRECTORY ResourceDirectory;
00135     ULONG ResourceSize;
00136     PIMAGE_NT_HEADERS NtHeaders;
00137     ULONG_PTR VirtualAddressOffset;
00138     PIMAGE_SECTION_HEADER NtSection;
00139 
00140     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00141 
00142 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
00143 <span class="preprocessor"></span>    ResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00144         <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(DllHandle,
00145                                      TRUE,
00146                                      IMAGE_DIRECTORY_ENTRY_RESOURCE,
00147                                      &amp;ResourceSize
00148                                      );
00149     <span class="keywordflow">if</span> (!ResourceDirectory) {
00150         <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00151     }
00152 
00153     <span class="keywordflow">if</span> ((ULONG_PTR)ResourceDataEntry &lt; (ULONG_PTR) ResourceDirectory ){
00154         DllHandle = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a21">LdrLoadAlternateResourceModule</a> (DllHandle, NULL);
00155     } <span class="keywordflow">else</span>{
00156         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(
00157                         (PVOID)((ULONG_PTR)DllHandle &amp; ~0x00000001)
00158                         );
00159         <span class="keywordflow">if</span> (NtHeaders) {
00160             <span class="comment">// Find the bounds of the image so we can see if this resource entry is in an alternate</span>
00161             <span class="comment">// resource dll.</span>
00162 
00163             ULONG_PTR ImageStart = (ULONG_PTR)DllHandle &amp; ~0x00000001;
00164             SIZE_T ImageSize = 0;
00165 
00166             <span class="keywordflow">if</span> ((ULONG_PTR)DllHandle &amp; 0x00000001) {
00167                 <span class="comment">// mapped as datafile.  Ask mm for the size</span>
00168                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00169                 MEMORY_BASIC_INFORMATION MemInfo;
00170 
00171                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/queryvm_8c.html#a4">NtQueryVirtualMemory</a>(
00172                             NtCurrentProcess(),
00173                             (PVOID) ImageStart,
00174                             MemoryBasicInformation,
00175                             (PVOID)&amp;MemInfo,
00176                             <span class="keyword">sizeof</span>(MemInfo),
00177                             NULL
00178                             );
00179 
00180                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00181                     ImageSize = 0;
00182                 } <span class="keywordflow">else</span> {
00183                     ImageSize = MemInfo.RegionSize;
00184                 }
00185             } <span class="keywordflow">else</span> {
00186                 ImageSize = ((PIMAGE_NT_HEADERS32)NtHeaders)-&gt;OptionalHeader.SizeOfImage;
00187             }
00188 
00189             <span class="keywordflow">if</span> (!(((ULONG_PTR)ResourceDataEntry &gt;= ImageStart) &amp;&amp; ((ULONG_PTR)ResourceDataEntry &lt; (ImageStart + ImageSize)))) {
00190                 <span class="comment">// Doesn't fall within the specified image.  Must be an alternate dll.</span>
00191                 DllHandle = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a21">LdrLoadAlternateResourceModule</a> (DllHandle, NULL);
00192             }
00193         }
00194     }
00195 
00196     <span class="keywordflow">if</span> (!DllHandle){
00197         <span class="keywordflow">return</span> ( STATUS_RESOURCE_DATA_NOT_FOUND );
00198     }
00199 
00200 <span class="preprocessor">#endif</span>
00201 <span class="preprocessor"></span>    <span class="keywordflow">try</span> {
00202         ResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00203             <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(DllHandle,
00204                                          TRUE,
00205                                          IMAGE_DIRECTORY_ENTRY_RESOURCE,
00206                                          &amp;ResourceSize
00207                                          );
00208         <span class="keywordflow">if</span> (!ResourceDirectory) {
00209             <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00210             }
00211 
00212         <span class="keywordflow">if</span> ((ULONG_PTR)DllHandle &amp; 0x00000001) {
00213             ULONG ResourceRVA;
00214             DllHandle = (PVOID)((ULONG_PTR)DllHandle &amp; ~0x00000001);
00215             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( DllHandle );
00216             <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR32_MAGIC) {
00217                 ResourceRVA=((PIMAGE_NT_HEADERS32)NtHeaders)-&gt;OptionalHeader.DataDirectory[ IMAGE_DIRECTORY_ENTRY_RESOURCE ].VirtualAddress;
00218             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC) {
00219                 ResourceRVA=((PIMAGE_NT_HEADERS64)NtHeaders)-&gt;OptionalHeader.DataDirectory[ IMAGE_DIRECTORY_ENTRY_RESOURCE ].VirtualAddress;
00220             } <span class="keywordflow">else</span> {
00221                 ResourceRVA = 0;
00222             }
00223 
00224             <span class="keywordflow">if</span> (!ResourceRVA) {
00225                 <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00226                 }
00227 
00228             VirtualAddressOffset = (ULONG_PTR)DllHandle + ResourceRVA - (ULONG_PTR)ResourceDirectory;
00229 
00230             <span class="comment">//</span>
00231             <span class="comment">// Now, we must check to see if the resource is not in the</span>
00232             <span class="comment">// same section as the resource table.  If it's in .rsrc1,</span>
00233             <span class="comment">// we've got to adjust the RVA in the ResourceDataEntry</span>
00234             <span class="comment">// to point to the correct place in the non-VA data file.</span>
00235             <span class="comment">//</span>
00236             NtSection= <a class="code" href="../../d8/d9/imagedir_8c.html#a1">RtlSectionTableFromVirtualAddress</a>( NtHeaders, DllHandle, ResourceRVA);
00237 
00238             <span class="keywordflow">if</span> (!NtSection) {
00239                 <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00240                 }
00241 
00242             <span class="keywordflow">if</span> ( ResourceDataEntry-&gt;OffsetToData &gt; NtSection-&gt;Misc.VirtualSize ) {
00243                 ULONG rva;
00244 
00245                 rva = NtSection-&gt;VirtualAddress;
00246                 NtSection= <a class="code" href="../../d8/d9/imagedir_8c.html#a1">RtlSectionTableFromVirtualAddress</a>(NtHeaders,
00247                                                              DllHandle,
00248                                                              ResourceDataEntry-&gt;OffsetToData
00249                                                              );
00250                 VirtualAddressOffset +=
00251                         ((ULONG_PTR)NtSection-&gt;VirtualAddress - rva) -
00252                         ((ULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a2">RtlAddressInSectionTable</a> ( NtHeaders, DllHandle, NtSection-&gt;VirtualAddress ) - (ULONG_PTR)ResourceDirectory);
00253                 }
00254             }
00255         <span class="keywordflow">else</span> {
00256             VirtualAddressOffset = 0;
00257             }
00258 
00259         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Address )) {
00260             *Address = (PVOID)( (PCHAR)DllHandle +
00261                                 (ResourceDataEntry-&gt;OffsetToData - VirtualAddressOffset)
00262                               );
00263             }
00264 
00265         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Size )) {
00266             *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = ResourceDataEntry-&gt;Size;
00267             }
00268         }
00269     except (EXCEPTION_EXECUTE_HANDLER) {
00270         <span class="keywordflow">return</span> GetExceptionCode();
00271         }
00272 
00273     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00274 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="ldrinit.c::LdrpAllocateTls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpAllocateTls           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">2071</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d2/ldrp_8h.html#a49">LDRP_TLS_ENTRY</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00401">LdrpNumberOfTlsEntries</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00400">LdrpTlsList</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00397">_LDRP_TLS_ENTRY::Tls</a>, and <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00462">TLS_TAG</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>.
<p>
<pre class="fragment"><div>02074 {
02075     PTEB Teb;
02076     PLIST_ENTRY Head, Next;
02077     <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">PLDRP_TLS_ENTRY</a> TlsEntry;
02078     PVOID *TlsVector;
02079 
02080     Teb = NtCurrentTeb();
02081 
02082     <span class="comment">//</span>
02083     <span class="comment">// Allocate the array of thread local storage pointers</span>
02084     <span class="comment">//</span>
02085 
02086     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a52">LdrpNumberOfTlsEntries</a> ) {
02087         TlsVector = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TLS_TAG ),<span class="keyword">sizeof</span>(PVOID)*LdrpNumberOfTlsEntries);
02088         <span class="keywordflow">if</span> ( !TlsVector ) {
02089             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02090             }
02091 
02092         Teb-&gt;ThreadLocalStoragePointer = TlsVector;
02093         Head = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a51">LdrpTlsList</a>;
02094         Next = Head-&gt;Flink;
02095 
02096         <span class="keywordflow">while</span> ( Next != Head ) {
02097             TlsEntry = CONTAINING_RECORD(Next, <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">LDRP_TLS_ENTRY</a>, Links);
02098             Next = Next-&gt;Flink;
02099             TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics] = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
02100                                                         RtlProcessHeap(),
02101                                                         <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TLS_TAG ),
02102                                                         TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.EndAddressOfRawData - TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.StartAddressOfRawData
02103                                                         );
02104             <span class="keywordflow">if</span> (!TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics] ) {
02105                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02106                 }
02107 
02108             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02109                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: TlsVector %x Index %d = %x copied from %x to %x\n"</span>,
02110                     TlsVector,
02111                     TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics,
02112                     &amp;TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics],
02113                     TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.StartAddressOfRawData,
02114                     TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics]
02115                     );
02116                 }
02117 
02118             RtlCopyMemory(
02119                 TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics],
02120                 (PVOID)TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.StartAddressOfRawData,
02121                 TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.EndAddressOfRawData - TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.StartAddressOfRawData
02122                 );
02123 
02124             <span class="comment">//</span>
02125             <span class="comment">// Do the TLS Callouts</span>
02126             <span class="comment">//</span>
02127 
02128             }
02129         }
02130     <span class="keywordflow">return</span> STATUS_SUCCESS;
02131 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="ldrinit.c::LdrpCallTlsInitializers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpCallTlsInitializers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Reason</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02178">2178</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00484">LdrpCallInitRoutine</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01602">LdrShutdownThread()</a>.
<p>
<pre class="fragment"><div>02182 {
02183     PIMAGE_TLS_DIRECTORY TlsImage;
02184     ULONG TlsSize;
02185     PIMAGE_TLS_CALLBACK *CallBackArray;
02186     PIMAGE_TLS_CALLBACK InitRoutine;
02187 
02188     TlsImage = (PIMAGE_TLS_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02189                        DllBase,
02190                        TRUE,
02191                        IMAGE_DIRECTORY_ENTRY_TLS,
02192                        &amp;TlsSize
02193                        );
02194 
02195 
02196     <span class="keywordflow">try</span> {
02197         <span class="keywordflow">if</span> ( TlsImage ) {
02198             CallBackArray = (PIMAGE_TLS_CALLBACK *)TlsImage-&gt;AddressOfCallBacks;
02199             <span class="keywordflow">if</span> ( CallBackArray ) {
02200                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02201                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: Tls Callbacks Found. Imagebase %lx Tls %lx CallBacks %lx\n"</span>,
02202                                 DllBase,
02203                                 TlsImage,
02204                                 CallBackArray
02205                             );
02206                     }
02207 
02208                 <span class="keywordflow">while</span>(*CallBackArray){
02209                     InitRoutine = *CallBackArray++;
02210 
02211                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02212                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: Calling Tls Callback Imagebase %lx Function %lx\n"</span>,
02213                                     DllBase,
02214                                     InitRoutine
02215                                 );
02216                         }
02217 
02218 <span class="preprocessor">#if defined (WX86)</span>
02219 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (!Wx86ProcessInit ||
02220                         LdrpRunWx86DllEntryPoint(
02221                              (PDLL_INIT_ROUTINE)InitRoutine,
02222                              NULL,
02223                              DllBase,
02224                              Reason,
02225                              NULL
02226                              ) ==  STATUS_IMAGE_MACHINE_TYPE_MISMATCH)
02227 <span class="preprocessor">#endif</span>
02228 <span class="preprocessor"></span>                       {
02229                         <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>((PDLL_INIT_ROUTINE)InitRoutine,
02230                                             DllBase,
02231                                             Reason,
02232                                             0);
02233                         }
02234 
02235                     }
02236                 }
02237             }
02238         }
02239     except (EXCEPTION_EXECUTE_HANDLER) {
02240         ;
02241         }
02242 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="ldrinit.c::LdrpForkProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpForkProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">575</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00388">FastPebLock</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00146">LoaderLockInitialized</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00371">RtlCriticalSectionList</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00179">RtlInitializeHeapManager()</a>, <a class="el" href="../../d7/d8/dll_2resource_8c.html#a11">RtlpInitDeferedCriticalSection()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>.
<p>
<pre class="fragment"><div>00576 {
00577     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00578     PPEB Peb;
00579 
00580     Peb = NtCurrentPeb();
00581 
00582     <span class="comment">//</span>
00583     <span class="comment">// Initialize the critical section package.</span>
00584     <span class="comment">//</span>
00585 
00586     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a11">RtlpInitDeferedCriticalSection</a>();
00587 
00588     InsertTailList(&amp;RtlCriticalSectionList, &amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>.DebugInfo-&gt;ProcessLocksList);
00589     <a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>.DebugInfo-&gt;CriticalSection = &amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>;
00590     <a class="code" href="../../d8/d2/ldrinit_8c.html#a13">LoaderLockInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00591 
00592     st = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;FastPebLock);
00593     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00594         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(st);
00595         }
00596     Peb-&gt;FastPebLock = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a46">FastPebLock</a>;
00597     Peb-&gt;FastPebLockRoutine = (PVOID)&amp;RtlEnterCriticalSection;
00598     Peb-&gt;FastPebUnlockRoutine = (PVOID)&amp;RtlLeaveCriticalSection;
00599     Peb-&gt;InheritedAddressSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00600     <a class="code" href="../../d5/d9/heapdll_8c.html#a20">RtlInitializeHeapManager</a>();
00601     Peb-&gt;ProcessHeap = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>( HEAP_GROWABLE,    <span class="comment">// Flags</span>
00602                                       NULL,             <span class="comment">// HeapBase</span>
00603                                       64 * 1024,        <span class="comment">// ReserveSize</span>
00604                                       4096,             <span class="comment">// CommitSize</span>
00605                                       NULL,             <span class="comment">// Lock to use for serialization</span>
00606                                       NULL              <span class="comment">// GrowthThreshold</span>
00607                                     );
00608     <span class="keywordflow">if</span> (Peb-&gt;ProcessHeap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00609         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00610     }
00611 
00612     <span class="keywordflow">return</span> st;
00613 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="ldrinit.c::LdrpFreeTls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpFreeTls           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02134">2134</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00400">LdrpTlsList</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, and <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00397">_LDRP_TLS_ENTRY::Tls</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01602">LdrShutdownThread()</a>.
<p>
<pre class="fragment"><div>02137 {
02138     PTEB Teb;
02139     PLIST_ENTRY Head, Next;
02140     <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">PLDRP_TLS_ENTRY</a> TlsEntry;
02141     PVOID *TlsVector;
02142 
02143     Teb = NtCurrentTeb();
02144 
02145     TlsVector = Teb-&gt;ThreadLocalStoragePointer;
02146 
02147     <span class="keywordflow">if</span> ( TlsVector ) {
02148         Head = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a51">LdrpTlsList</a>;
02149         Next = Head-&gt;Flink;
02150 
02151         <span class="keywordflow">while</span> ( Next != Head ) {
02152             TlsEntry = CONTAINING_RECORD(Next, <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">LDRP_TLS_ENTRY</a>, Links);
02153             Next = Next-&gt;Flink;
02154 
02155             <span class="comment">//</span>
02156             <span class="comment">// Do the TLS callouts</span>
02157             <span class="comment">//</span>
02158 
02159             <span class="keywordflow">if</span> ( TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics] ) {
02160                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(
02161                     RtlProcessHeap(),
02162                     0,
02163                     TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics]
02164                     );
02165 
02166                 }
02167             }
02168 
02169         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(
02170             RtlProcessHeap(),
02171             0,
02172             TlsVector
02173             );
02174         }
02175 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="ldrinit.c::LdrpInitializationFailure" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpInitializationFailure           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FailureCode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00157">157</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00386">LdrpFatalHardErrorCount</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00532">NtRaiseHardError()</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.
<p>
<pre class="fragment"><div>00160 {
00161 
00162     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ErrorStatus;
00163     ULONG_PTR ErrorParameter;
00164     ULONG ErrorResponse;
00165 
00166     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a> ) {
00167         <span class="keywordflow">return</span>;
00168         }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// Its error time...</span>
00172     <span class="comment">//</span>
00173     ErrorParameter = (ULONG_PTR)FailureCode;
00174     ErrorStatus = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
00175                     STATUS_APP_INIT_FAILURE,
00176                     1,
00177                     0,
00178                     &amp;ErrorParameter,
00179                     OptionOk,
00180                     &amp;ErrorResponse
00181                     );
00182 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="ldrinit.c::LdrpInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">186</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00157">LdrpInitializationFailure()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00146">LoaderLockInitialized</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00851">NtQueryPerformanceCounter()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00345">NtTestAlert()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00189">RtlpDebugPageHeap</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00047">RtlpDisableHeapLookaside</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00242">RtlpDphDllRangeEnd</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00241">RtlpDphDllRangeStart</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00231">RtlpDphGlobalFlags</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00243">RtlpDphRandomProbability</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00240">RtlpDphSizeRangeEnd</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00239">RtlpDphSizeRangeStart</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00244">RtlpDphTargetDlls</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00194                    :
00195 
00196     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called as a User-Mode APC routine as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first
00197     user-mode code executed by a <span class="keyword">new</span> thread. It's function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to initialize
00198     loader context, perform module initialization callouts...
00199 
00200 Arguments:
00201 
00202     Context - Supplies an optional context buffer that will be restore
00203               after all DLL initialization has been completed.  If <span class="keyword">this</span>
00204               parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a dynamic snap of <span class="keyword">this</span> module.
00205               Otherwise <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">static</span> snap prior to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user process
00206               gaining <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
00207 
00208     SystemArgument1 - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> System Dll.
00209 
00210     SystemArgument2 - not used.
00211 
00212 Return Value:
00213 
00214     None.
00215 
00216 --*/
00217 
00218 {
00219     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st, InitStatus;
00220     PPEB Peb;
00221     PTEB Teb;
00222     UNICODE_STRING UnicodeImageName;
00223     MEMORY_BASIC_INFORMATION MemInfo;
00224     BOOLEAN AlreadyFailed;
00225     LARGE_INTEGER DelayValue;
00226 <span class="preprocessor">#if defined(_WIN64)</span>
00227 <span class="preprocessor"></span>    PIMAGE_NT_HEADERS NtHeader;
00228 <span class="preprocessor">#endif</span>
00229 <span class="preprocessor"></span>
00230     SystemArgument2;
00231 
00232     AlreadyFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00233     Peb = NtCurrentPeb();
00234     Teb = NtCurrentTeb();
00235 
00236     <span class="keywordflow">if</span> (!Peb-&gt;Ldr) {
00237 <span class="preprocessor">#if defined(_ALPHA_)</span>
00238 <span class="preprocessor"></span>        ULONG temp;
00239 
00240         <span class="comment">//</span>
00241         <span class="comment">// Set GP register</span>
00242         <span class="comment">//</span>
00243 
00244         LdrpGpValue = (ULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00245                 Peb-&gt;ImageBaseAddress,
00246                 TRUE,
00247                 IMAGE_DIRECTORY_ENTRY_GLOBALPTR,
00248                 &amp;temp
00249                 );
00250         <span class="keywordflow">if</span> (Context != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00251             LdrpSetGp( LdrpGpValue );
00252             Context-&gt;IntGp = LdrpGpValue;
00253         }
00254 <span class="preprocessor">#endif // ALPHA</span>
00255 <span class="preprocessor"></span>
00256 <span class="comment">//#if DBG</span>
00257         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00258 <span class="comment">//#else</span>
00259 <span class="comment">//        if (Peb-&gt;BeingDebugged || Peb-&gt;ReadImageFileExecOptions)</span>
00260 <span class="comment">//#endif</span>
00261         {
00262             PWSTR pw;
00263 
00264             pw = (PWSTR)Peb-&gt;ProcessParameters-&gt;ImagePathName.Buffer;
00265             <span class="keywordflow">if</span> (!(Peb-&gt;ProcessParameters-&gt;Flags &amp; RTL_USER_PROC_PARAMS_NORMALIZED)) {
00266                 pw = (PWSTR)((PCHAR)pw + (ULONG_PTR)(Peb-&gt;ProcessParameters));
00267                 }
00268             UnicodeImageName.Buffer = pw;
00269             UnicodeImageName.Length = Peb-&gt;ProcessParameters-&gt;ImagePathName.Length;
00270             UnicodeImageName.MaximumLength = UnicodeImageName.Length;
00271 
00272             <span class="comment">//</span>
00273             <span class="comment">//  Hack for NT4 SP4.  So we don't overload another GlobalFlag</span>
00274             <span class="comment">//  bit that we have to be "compatible" with for NT5, look for</span>
00275             <span class="comment">//  another value named "DisableHeapLookaside".</span>
00276             <span class="comment">//</span>
00277 
00278             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( &amp;UnicodeImageName,
00279                                                L<span class="stringliteral">"DisableHeapLookaside"</span>,
00280                                                REG_DWORD,
00281                                                &amp;RtlpDisableHeapLookaside,
00282                                                <span class="keyword">sizeof</span>( RtlpDisableHeapLookaside ),
00283                                                NULL
00284                                              );
00285 
00286             st = <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( &amp;UnicodeImageName,
00287                                                     L<span class="stringliteral">"GlobalFlag"</span>,
00288                                                     REG_DWORD,
00289                                                     &amp;Peb-&gt;NtGlobalFlag,
00290                                                     <span class="keyword">sizeof</span>( Peb-&gt;NtGlobalFlag ),
00291                                                     NULL
00292                                                   );
00293             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
00294 
00295                 <span class="keywordflow">if</span> (Peb-&gt;BeingDebugged) {
00296                     Peb-&gt;NtGlobalFlag |= FLG_HEAP_ENABLE_FREE_CHECK |
00297                                          FLG_HEAP_ENABLE_TAIL_CHECK |
00298                                          FLG_HEAP_VALIDATE_PARAMETERS;
00299                     }
00300                 }
00301 
00302 <span class="preprocessor">#if defined(_WIN64)</span>
00303 <span class="preprocessor"></span>            NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Peb-&gt;ImageBaseAddress);
00304             <span class="keywordflow">if</span> (NtHeader &amp;&amp; NtHeader-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR32_MAGIC) {
00305                 UseWOW64 = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00306             }
00307 <span class="preprocessor">#endif</span>
00308 <span class="preprocessor"></span>        }
00309 
00310         <span class="keywordflow">if</span> ( Peb-&gt;NtGlobalFlag &amp; FLG_HEAP_PAGE_ALLOCS ) {
00311 
00312             <span class="comment">//</span>
00313             <span class="comment">// We will enable page heap (RtlpDebugPageHeap) only after</span>
00314             <span class="comment">// all other initializations for page heap are finished.</span>
00315             <span class="comment">//</span>
00316 
00317             <span class="comment">//</span>
00318             <span class="comment">// If page heap is enabled we need to disable any flag that</span>
00319             <span class="comment">// might force creation of debug heaps for normal NT heaps.</span>
00320             <span class="comment">// This is due to a dependency between page heap and NT heap</span>
00321             <span class="comment">// where the page heap within PageHeapCreate tries to create</span>
00322             <span class="comment">// a normal NT heap to accomodate some of the allocations.</span>
00323             <span class="comment">// If we do not disable these flags we will get an infinite</span>
00324             <span class="comment">// recursion between RtlpDebugPageHeapCreate and RtlCreateHeap.</span>
00325             <span class="comment">//</span>
00326 
00327             Peb-&gt;NtGlobalFlag &amp;= ~( FLG_HEAP_ENABLE_TAGGING      |
00328                 FLG_HEAP_ENABLE_TAG_BY_DLL   |
00329                 FLG_HEAP_ENABLE_TAIL_CHECK   |
00330                 FLG_HEAP_ENABLE_FREE_CHECK   |
00331                 FLG_HEAP_VALIDATE_PARAMETERS |
00332                 FLG_HEAP_VALIDATE_ALL        |
00333                 FLG_USER_STACK_TRACE_DB      );
00334 
00335             <span class="comment">//</span>
00336             <span class="comment">// Read page heap per process global flags. If we fail</span>
00337             <span class="comment">// to read a value, the default ones are kept.</span>
00338             <span class="comment">//</span>
00339 
00340             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00341                 &amp;UnicodeImageName,
00342                 L<span class="stringliteral">"PageHeapFlags"</span>,
00343                 REG_DWORD,
00344                 &amp;RtlpDphGlobalFlags,
00345                 <span class="keyword">sizeof</span>(RtlpDphGlobalFlags),
00346                 NULL
00347                 );
00348 
00349             <span class="comment">//</span>
00350             <span class="comment">// Read several page heap parameters.</span>
00351             <span class="comment">//</span>
00352 
00353             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00354                 &amp;UnicodeImageName,
00355                 L<span class="stringliteral">"PageHeapSizeRangeStart"</span>,
00356                 REG_DWORD,
00357                 &amp;RtlpDphSizeRangeStart,
00358                 <span class="keyword">sizeof</span>(RtlpDphSizeRangeStart),
00359                 NULL
00360                 );
00361 
00362             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00363                 &amp;UnicodeImageName,
00364                 L<span class="stringliteral">"PageHeapSizeRangeEnd"</span>,
00365                 REG_DWORD,
00366                 &amp;RtlpDphSizeRangeEnd,
00367                 <span class="keyword">sizeof</span>(RtlpDphSizeRangeEnd),
00368                 NULL
00369                 );
00370 
00371             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00372                 &amp;UnicodeImageName,
00373                 L<span class="stringliteral">"PageHeapRandomProbability"</span>,
00374                 REG_DWORD,
00375                 &amp;RtlpDphRandomProbability,
00376                 <span class="keyword">sizeof</span>(RtlpDphRandomProbability),
00377                 NULL
00378                 );
00379 
00380             <span class="comment">//</span>
00381             <span class="comment">// The two values below should be read as PVOIDs so that</span>
00382             <span class="comment">// this works on 64-bit architetures. However since this</span>
00383             <span class="comment">// feature relies on good stack traces and since we can get</span>
00384             <span class="comment">// reliable stack traces only on X86 architectures we will</span>
00385             <span class="comment">// leave it as it is.</span>
00386             <span class="comment">//</span>
00387 
00388             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00389                 &amp;UnicodeImageName,
00390                 L<span class="stringliteral">"PageHeapDllRangeStart"</span>,
00391                 REG_DWORD,       
00392                 &amp;RtlpDphDllRangeStart,
00393                 <span class="keyword">sizeof</span>(RtlpDphDllRangeStart),
00394                 NULL
00395                 );
00396 
00397             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00398                 &amp;UnicodeImageName,
00399                 L<span class="stringliteral">"PageHeapDllRangeEnd"</span>,
00400                 REG_DWORD,       
00401                 &amp;RtlpDphDllRangeEnd,
00402                 <span class="keyword">sizeof</span>(RtlpDphDllRangeEnd),
00403                 NULL
00404                 );
00405 
00406             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00407                 &amp;UnicodeImageName,
00408                 L<span class="stringliteral">"PageHeapTargetDlls"</span>,
00409                 REG_SZ,
00410                 &amp;RtlpDphTargetDlls,
00411                 512,
00412                 NULL
00413                 );
00414 
00415             <span class="comment">//</span>
00416             <span class="comment">//  Turn on BOOLEAN RtlpDebugPageHeap to indicate that</span>
00417             <span class="comment">//  new heaps should be created with debug page heap manager</span>
00418             <span class="comment">//  when possible.</span>
00419             <span class="comment">//</span>
00420 
00421             <a class="code" href="../../d6/d9/heappage_8c.html#a36">RtlpDebugPageHeap</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00422         }
00423     }
00424 <span class="preprocessor">#if defined(_ALPHA_)</span>
00425 <span class="preprocessor"></span>    <span class="keywordflow">else</span>
00426     <span class="keywordflow">if</span> (Context != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00427         LdrpSetGp( LdrpGpValue );
00428         Context-&gt;IntGp = LdrpGpValue;
00429     }
00430 <span class="preprocessor">#endif // ALPHA</span>
00431 <span class="preprocessor"></span>
00432     <span class="comment">//</span>
00433     <span class="comment">// Serialize for here on out</span>
00434     <span class="comment">//</span>
00435 
00436     Peb-&gt;LoaderLock = (PVOID)&amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>;
00437 
00438     <span class="keywordflow">if</span> ( !RtlTryEnterCriticalSection(&amp;LoaderLock) ) {
00439         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a13">LoaderLockInitialized</a> ) {
00440             RtlEnterCriticalSection(&amp;LoaderLock);
00441             }
00442         <span class="keywordflow">else</span> {
00443 
00444             <span class="comment">//</span>
00445             <span class="comment">// drop into a 30ms delay loop</span>
00446             <span class="comment">//</span>
00447 
00448             DelayValue.QuadPart = Int32x32To64( 30, -10000 );
00449             <span class="keywordflow">while</span> ( !<a class="code" href="../../d8/d2/ldrinit_8c.html#a13">LoaderLockInitialized</a> ) {
00450                 <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a>(FALSE,&amp;DelayValue);
00451                 }
00452             RtlEnterCriticalSection(&amp;LoaderLock);
00453             }
00454         }
00455 
00456     <span class="keywordflow">if</span> (Teb-&gt;DeallocationStack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00457         st = <a class="code" href="../../d5/d3/queryvm_8c.html#a4">NtQueryVirtualMemory</a>(
00458                 NtCurrentProcess(),
00459                 Teb-&gt;NtTib.StackLimit,
00460                 MemoryBasicInformation,
00461                 (PVOID)&amp;MemInfo,
00462                 <span class="keyword">sizeof</span>(MemInfo),
00463                 NULL
00464                 );
00465         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00466             <a class="code" href="../../d8/d2/ldrinit_8c.html#a25">LdrpInitializationFailure</a>(st);
00467             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(st);
00468             <span class="keywordflow">return</span>;
00469             }
00470         <span class="keywordflow">else</span> {
00471             Teb-&gt;DeallocationStack = MemInfo.AllocationBase;
00472 <span class="preprocessor">#if defined(_IA64_)</span>
00473 <span class="preprocessor"></span>            Teb-&gt;DeallocationBStore = (PVOID)((ULONG_PTR)MemInfo.AllocationBase + MemInfo.RegionSize);
00474 <span class="preprocessor">#endif // defined(_IA64_)</span>
00475 <span class="preprocessor"></span>        }
00476     }
00477 
00478     InitStatus = STATUS_SUCCESS;
00479     <span class="keywordflow">try</span> {
00480         <span class="keywordflow">if</span> (!Peb-&gt;Ldr) {
00481             <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00482 <span class="preprocessor">#if DBG</span>
00483 <span class="preprocessor"></span>            <span class="comment">//</span>
00484             <span class="comment">// Time the load.</span>
00485             <span class="comment">//</span>
00486 
00487             <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
00488                 <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;BeginTime, NULL);
00489             }
00490 <span class="preprocessor">#endif // DBG</span>
00491 <span class="preprocessor"></span>
00492             <span class="keywordflow">try</span> {
00493                 InitStatus = <a class="code" href="../../d9/d2/ldrp_8h.html#a65">LdrpInitializeProcess</a>( Context,
00494                                                     SystemArgument1,
00495                                                     &amp;UnicodeImageName
00496                                                   );
00497                 }
00498             except ( EXCEPTION_EXECUTE_HANDLER ) {
00499                 InitStatus = GetExceptionCode();
00500                 AlreadyFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00501                 <a class="code" href="../../d8/d2/ldrinit_8c.html#a25">LdrpInitializationFailure</a>(GetExceptionCode());
00502                 }
00503 
00504 <span class="preprocessor">#if DBG</span>
00505 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
00506                 <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;EndTime, NULL);
00507                 <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;ElapsedTime, &amp;Interval);
00508                 ElapsedTime.QuadPart = EndTime.QuadPart - BeginTime.QuadPart;
00509                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nLoadTime %ld In units of %ld cycles/second \n"</span>,
00510                     ElapsedTime.LowPart,
00511                     Interval.LowPart
00512                     );
00513 
00514                 ElapsedTime.QuadPart = EndTime.QuadPart - InitbTime.QuadPart;
00515                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"InitTime %ld\n"</span>,
00516                     ElapsedTime.LowPart
00517                     );
00518                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Compares %d Bypasses %d Normal Snaps %d\nSecOpens %d SecCreates %d Maps %d Relocates %d\n"</span>,
00519                     LdrpCompareCount,
00520                     LdrpSnapBypass,
00521                     LdrpNormalSnap,
00522                     LdrpSectionOpens,
00523                     LdrpSectionCreates,
00524                     LdrpSectionMaps,
00525                     LdrpSectionRelocates
00526                     );
00527             }
00528 <span class="preprocessor">#endif // DBG</span>
00529 <span class="preprocessor"></span>
00530 
00531         } <span class="keywordflow">else</span> {
00532             <span class="keywordflow">if</span> ( Peb-&gt;InheritedAddressSpace ) {
00533                 InitStatus = <a class="code" href="../../d8/d2/ldrinit_8c.html#a15">LdrpForkProcess</a>();
00534                 }
00535             <span class="keywordflow">else</span> {
00536 
00537 <span class="preprocessor">#if defined (WX86)</span>
00538 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Teb-&gt;Vdm) {
00539                     InitStatus = LdrpInitWx86(Teb-&gt;Vdm, Context, TRUE);
00540                     }
00541 <span class="preprocessor">#endif</span>
00542 <span class="preprocessor"></span>
00543 <span class="preprocessor">#if defined(_WIN64)</span>
00544 <span class="preprocessor"></span>                <span class="comment">//</span>
00545                 <span class="comment">// Load in WOW64 if the image is supposed to run simulated</span>
00546                 <span class="comment">//</span>
00547                 <span class="keywordflow">if</span> (UseWOW64) {
00548                     RtlLeaveCriticalSection(&amp;LoaderLock);
00549                     (*Wow64LdrpInitialize)(Context);
00550                     <span class="comment">// This never returns.  It will destroy the process.</span>
00551                 }
00552 <span class="preprocessor">#endif</span>
00553 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/ldrinit_8c.html#a16">LdrpInitializeThread</a>(Context);
00554                 }
00555         }
00556     } finally {
00557         <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00558         RtlLeaveCriticalSection(&amp;LoaderLock);
00559         }
00560 
00561     <a class="code" href="../../d1/d2/psspnd_8c.html#a4">NtTestAlert</a>();
00562 
00563     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(InitStatus)) {
00564 
00565         <span class="keywordflow">if</span> ( AlreadyFailed == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00566             <a class="code" href="../../d8/d2/ldrinit_8c.html#a25">LdrpInitializationFailure</a>(InitStatus);
00567             }
00568         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(InitStatus);
00569     }
00570 
00571 
00572 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="ldrinit.c::LdrpInitializeProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpInitializeProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemDllBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeImageName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">616</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00466">ATOM_TAG</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00314">CommandLine</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00388">FastPebLock</a>, <a class="el" href="../../d2/d0/theap_8c-source.html#l00055">HeapParameters</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00036">InitTableInfo</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00460">LDR_TAG</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00838">LdrGetProcedureAddress()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00035">LdrLoadDll()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00159">LDRP_HASH_TABLE_SIZE</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03043">LdrpAllocateDataTableEntry()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00387">LdrpDefaultPath</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03249">LdrpFetchAddressOfEntryPoint()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00162">LdrpHashTable</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00390">LdrpImageEntry</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00157">LdrpInitializationFailure()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03084">LdrpInsertMemoryTableEntry()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00034">LdrpKnownDllObjectDirectory</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00037">LdrpKnownDllPath</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00036">LdrpKnownDllPathBuffer</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00034">LdrpLdrDatabaseIsSetup</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00391">LdrpNumberOfProcessors</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00253">LdrpReferenceLoadedDll</a>, <a class="el" href="../../d6/d1/alpha_2ldrctx_8c-source.html#l00028">LdrpRelocateStartContext()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03417">LdrpSetProtection()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00033">LdrpVerifyDlls</a>, <a class="el" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02277">LdrQueryApplicationCompatibilityGoo()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00091">LdrRelocateImage()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00146">LoaderLockInitialized</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00153">NATIVE_PAGE_SIZE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00045">NtDllBase</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00455">NtdllBaseTag</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00121">NtdllpAllocateStringRoutine()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00129">NtdllpFreeStringRoutine()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00144">NtOpenDirectoryObject()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00247">NtOpenSymbolicLinkObject()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00851">NtQueryPerformanceCounter()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00028">NtSystemRoot</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00136">RtlAllocateStringRoutine</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00371">RtlCriticalSectionList</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00137">RtlFreeStringRoutine</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00253">RtlInitializeAtomPackage()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00179">RtlInitializeHeapManager()</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l02438">RtlInitNlsTables()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00395">RtlNormalizeProcessParams()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00189">RtlpDebugPageHeap</a>, <a class="el" href="../../d7/d8/dll_2resource_8c.html#a11">RtlpInitDeferedCriticalSection()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00369">RtlpTimeout</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00368">RtlpTimoutDisable</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l02454">RtlResetRtlTranslations()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l00225">RtlSetCurrentDirectory_U()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00138">TlsBitMap</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00139">TlsExpansionBitMap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00844">Unicode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>.
<p>
<pre class="fragment"><div>00624                    :
00625 
00626     This function initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00627     This includes:
00628 
00629         - Initializing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table
00630 
00631         - Connecting to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader subsystem
00632 
00633         - Initializing all staticly linked DLLs
00634 
00635 Arguments:
00636 
00637     Context - Supplies an optional context buffer that will be restore
00638               after all DLL initialization has been completed.  If <span class="keyword">this</span>
00639               parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a dynamic snap of <span class="keyword">this</span> module.
00640               Otherwise <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">static</span> snap prior to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user process
00641               gaining <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
00642 
00643     SystemDllBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system dll.
00644 
00645 Return Value:
00646 
00647     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value
00648 
00649 --*/
00650 
00651 {
00652     PPEB Peb;
00653     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00654     PWCH p, pp;
00655     UNICODE_STRING CurDir;
00656     UNICODE_STRING FullImageName;
00657     UNICODE_STRING <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>;
00658     ULONG DebugProcessHeapOnly = 0 ;
00659     HANDLE LinkHandle;
00660     WCHAR SystemDllPathBuffer[DOS_MAX_PATH_LENGTH];
00661     UNICODE_STRING SystemDllPath;
00662     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00663     PRTL_USER_PROCESS_PARAMETERS ProcessParameters;
00664     UNICODE_STRING <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>;
00665     OBJECT_ATTRIBUTES Obja;
00666     BOOLEAN StaticCurDir = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00667     ULONG i;
00668     PIMAGE_NT_HEADERS NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( NtCurrentPeb()-&gt;ImageBaseAddress );
00669     PIMAGE_LOAD_CONFIG_DIRECTORY ImageConfigData;
00670     ULONG ProcessHeapFlags;
00671     RTL_HEAP_PARAMETERS <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>;
00672     NLSTABLEINFO <a class="code" href="../../d8/d1/init_8h.html#a10">InitTableInfo</a>;
00673     LARGE_INTEGER LongTimeout;
00674     UNICODE_STRING <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>;
00675     LONG_PTR Diff;
00676     ULONG_PTR OldBase;
00677 
00678     <a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a> = SystemDllBase;
00679 
00680     <span class="keywordflow">if</span> (
00681 <span class="preprocessor">#if defined(_WIN64)</span>
00682 <span class="preprocessor"></span>        NtHeader-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC &amp;&amp;
00683 <span class="preprocessor">#endif</span>
00684 <span class="preprocessor"></span>        NtHeader-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_NATIVE ) {
00685 
00686         <span class="comment">//</span>
00687         <span class="comment">// Native subsystems load slower, but validate their DLLs</span>
00688         <span class="comment">// This is to help CSR detect bad images faster</span>
00689         <span class="comment">//</span>
00690 
00691         <a class="code" href="../../d8/d2/ldrinit_8c.html#a2">LdrpVerifyDlls</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00692 
00693         }
00694 
00695 
00696     Peb = NtCurrentPeb();
00697 
00698 <span class="preprocessor">#if defined(BUILD_WOW6432)</span>
00699 <span class="preprocessor"></span>    {
00700         <span class="comment">//</span>
00701         <span class="comment">// The process is running in WOW64.  Sort out the optional header</span>
00702         <span class="comment">// format and reformat the image if its page size is smaller than</span>
00703         <span class="comment">// the native page size.</span>
00704         <span class="comment">//</span>
00705         PIMAGE_NT_HEADERS32 NtHeader32 = (PIMAGE_NT_HEADERS32)NtHeader;
00706 
00707         <span class="keywordflow">if</span> (NtHeader32-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386 &amp;&amp;
00708             NtHeader32-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d9/d2/ldrp_8h.html#a2">NATIVE_PAGE_SIZE</a> &amp;&amp;
00709             !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st = LdrpWx86FormatVirtualImage(NtHeader32,
00710                                  NtCurrentPeb()-&gt;ImageBaseAddress
00711                                  <span class="comment">//bugbug: should be:  (PVOID)NtHeader32-&gt;OptionalHeader.ImageBase</span>
00712                                  ))) {
00713             <span class="keywordflow">return</span> st;
00714         }
00715     }
00716 <span class="preprocessor">#elif defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
00717 <span class="preprocessor"></span>     <span class="comment">//</span>
00718      <span class="comment">// Deal with the native page size which is larger than x86</span>
00719      <span class="comment">// This needs to be done before any code reads beyond the file headers.</span>
00720      <span class="comment">//</span>
00721     <span class="keywordflow">if</span> (NtHeader-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386 &amp;&amp;
00722         NtHeader-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &amp;&amp;
00723         !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st = LdrpWx86FormatVirtualImage((PIMAGE_NT_HEADERS32)NtHeader,
00724                              (PVOID)NtHeader-&gt;OptionalHeader.ImageBase
00725                              )))
00726       {
00727         <span class="keywordflow">return</span> st;
00728         }
00729 <span class="preprocessor">#endif</span>
00730 <span class="preprocessor"></span>
00731 
00732     <a class="code" href="../../d9/d2/ldrp_8h.html#a48">LdrpNumberOfProcessors</a> = Peb-&gt;NumberOfProcessors;
00733     <a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a> = Peb-&gt;CriticalSectionTimeout;
00734     LongTimeout.QuadPart = Int32x32To64( 3600, -10000000 );
00735 
00736     <span class="keywordflow">if</span> (ProcessParameters = <a class="code" href="../../d0/d2/rtlexec_8c.html#a10">RtlNormalizeProcessParams</a>(Peb-&gt;ProcessParameters)) {
00737         FullImageName = *(PUNICODE_STRING)&amp;ProcessParameters-&gt;ImagePathName;
00738         <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a> = *(PUNICODE_STRING)&amp;ProcessParameters-&gt;CommandLine;
00739         }
00740     <span class="keywordflow">else</span> {
00741         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;FullImageName, NULL );
00742         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CommandLine, NULL );
00743         }
00744 
00745 
00746     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a46">RtlInitNlsTables</a>(
00747         Peb-&gt;AnsiCodePageData,
00748         Peb-&gt;OemCodePageData,
00749         Peb-&gt;UnicodeCaseTableData,
00750         &amp;InitTableInfo
00751         );
00752 
00753     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a47">RtlResetRtlTranslations</a>(&amp;InitTableInfo);
00754 
00755 <span class="preprocessor">#if defined(_WIN64)</span>
00756 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (UseWOW64) {
00757         <span class="comment">//</span>
00758         <span class="comment">// Ignore image config data when initializing the 64-bit loader.</span>
00759         <span class="comment">// The 32-bit loader in ntdll32 will look at the config data</span>
00760         <span class="comment">// and do the right thing.</span>
00761         <span class="comment">//</span>
00762         ImageConfigData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00763     } <span class="keywordflow">else</span>
00764 <span class="preprocessor">#endif</span>
00765 <span class="preprocessor"></span>    {
00766 
00767         ImageConfigData = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( Peb-&gt;ImageBaseAddress,
00768                                                         TRUE,
00769                                                         IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG,
00770                                                         &amp;i
00771                                                       );
00772     }
00773 
00774     RtlZeroMemory( &amp;HeapParameters, <span class="keyword">sizeof</span>( HeapParameters ) );
00775     ProcessHeapFlags = HEAP_GROWABLE | HEAP_CLASS_0;
00776     <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.Length = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a> );
00777     <span class="keywordflow">if</span> (ImageConfigData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; i == <span class="keyword">sizeof</span>( *ImageConfigData )) {
00778         Peb-&gt;NtGlobalFlag &amp;= ~ImageConfigData-&gt;GlobalFlagsClear;
00779         Peb-&gt;NtGlobalFlag |= ImageConfigData-&gt;GlobalFlagsSet;
00780 
00781         <span class="keywordflow">if</span> (ImageConfigData-&gt;CriticalSectionDefaultTimeout != 0) {
00782             <span class="comment">//</span>
00783             <span class="comment">// Convert from milliseconds to NT time scale (100ns)</span>
00784             <span class="comment">//</span>
00785             <a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>.QuadPart = Int32x32To64( (LONG)ImageConfigData-&gt;CriticalSectionDefaultTimeout,
00786                                                  -10000
00787                                                );
00788 
00789             }
00790 
00791         <span class="keywordflow">if</span> (ImageConfigData-&gt;ProcessHeapFlags != 0) {
00792             ProcessHeapFlags = ImageConfigData-&gt;ProcessHeapFlags;
00793             }
00794 
00795         <span class="keywordflow">if</span> (ImageConfigData-&gt;DeCommitFreeBlockThreshold != 0) {
00796             <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.DeCommitFreeBlockThreshold = ImageConfigData-&gt;DeCommitFreeBlockThreshold;
00797             }
00798 
00799         <span class="keywordflow">if</span> (ImageConfigData-&gt;DeCommitTotalFreeThreshold != 0) {
00800             <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.DeCommitTotalFreeThreshold = ImageConfigData-&gt;DeCommitTotalFreeThreshold;
00801             }
00802 
00803         <span class="keywordflow">if</span> (ImageConfigData-&gt;MaximumAllocationSize != 0) {
00804             <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.MaximumAllocationSize = ImageConfigData-&gt;MaximumAllocationSize;
00805             }
00806 
00807         <span class="keywordflow">if</span> (ImageConfigData-&gt;VirtualMemoryThreshold != 0) {
00808             <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.VirtualMemoryThreshold = ImageConfigData-&gt;VirtualMemoryThreshold;
00809             }
00810         }
00811 
00812 <span class="comment">//    //</span>
00813 <span class="comment">//    // Check if the image has the fast heap flag set</span>
00814 <span class="comment">//    //</span>
00815 <span class="comment">//</span>
00816 <span class="comment">//    if (NtHeader-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_FAST_HEAP) {</span>
00817 <span class="comment">//        RtlpDisableHeapLookaside = 0;</span>
00818 <span class="comment">//    } else {</span>
00819 <span class="comment">//        RtlpDisableHeapLookaside = 1;</span>
00820 <span class="comment">//    }</span>
00821 
00822     <a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a> = (BOOLEAN)(FLG_SHOW_LDR_SNAPS &amp; Peb-&gt;NtGlobalFlag);
00823 
00824 
00825 
00826     <span class="comment">//</span>
00827     <span class="comment">// This field is non-zero if the image file that was used to create this</span>
00828     <span class="comment">// process contained a non-zero value in its image header.  If so, then</span>
00829     <span class="comment">// set the affinity mask for the process using this value.  It could also</span>
00830     <span class="comment">// be non-zero if the parent process created us suspended and poked our</span>
00831     <span class="comment">// PEB with a non-zero value before resuming.</span>
00832     <span class="comment">//</span>
00833     <span class="keywordflow">if</span> (Peb-&gt;ImageProcessAffinityMask) {
00834         st = <a class="code" href="../../d9/d1/psquery_8c.html#a19">NtSetInformationProcess</a>( NtCurrentProcess(),
00835                                       ProcessAffinityMask,
00836                                       &amp;Peb-&gt;ImageProcessAffinityMask,
00837                                       <span class="keyword">sizeof</span>( Peb-&gt;ImageProcessAffinityMask )
00838                                     );
00839         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
00840             KdPrint(( <span class="stringliteral">"LDR: Using ProcessAffinityMask of 0x%x from image.\n"</span>,
00841                       Peb-&gt;ImageProcessAffinityMask
00842                    ));
00843             }
00844         <span class="keywordflow">else</span> {
00845             KdPrint(( <span class="stringliteral">"LDR: Failed to set ProcessAffinityMask of 0x%x from image (Status == %08x).\n"</span>,
00846                       Peb-&gt;ImageProcessAffinityMask, st
00847                    ));
00848             }
00849         }
00850 
00851     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>.QuadPart &lt; LongTimeout.QuadPart) {
00852         <a class="code" href="../../d9/d2/ldrp_8h.html#a31">RtlpTimoutDisable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00853         }
00854 
00855     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00856         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: PID: 0x%x started - '%wZ'\n"</span>,
00857                   NtCurrentTeb()-&gt;ClientId.UniqueProcess,
00858                   &amp;CommandLine
00859                 );
00860     }
00861 
00862     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../d9/d2/ldrp_8h.html#a5">LDRP_HASH_TABLE_SIZE</a>;i++) {
00863         InitializeListHead(&amp;LdrpHashTable[i]);
00864     }
00865 
00866     <span class="comment">//</span>
00867     <span class="comment">// Initialize the critical section package.</span>
00868     <span class="comment">//</span>
00869 
00870     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a11">RtlpInitDeferedCriticalSection</a>();
00871 
00872     Peb-&gt;TlsBitmap = (PVOID)&amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a9">TlsBitMap</a>;
00873     Peb-&gt;TlsExpansionBitmap = (PVOID)&amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a10">TlsExpansionBitMap</a>;
00874 
00875     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a> (
00876         &amp;TlsBitMap,
00877         &amp;Peb-&gt;TlsBitmapBits[0],
00878         TLS_MINIMUM_AVAILABLE
00879         );
00880 
00881     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a> (
00882         &amp;TlsExpansionBitMap,
00883         &amp;Peb-&gt;TlsExpansionBitmapBits[0],
00884         TLS_EXPANSION_SLOTS
00885         );
00886 
00887     InsertTailList(&amp;RtlCriticalSectionList, &amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>.DebugInfo-&gt;ProcessLocksList);
00888     <a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>.DebugInfo-&gt;CriticalSection = &amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>;
00889     <a class="code" href="../../d8/d2/ldrinit_8c.html#a13">LoaderLockInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00890 
00891     <span class="comment">//</span>
00892     <span class="comment">// Initialize the stack trace data base if requested</span>
00893     <span class="comment">//</span>
00894 
00895 <span class="preprocessor">#if i386</span>
00896 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Peb-&gt;NtGlobalFlag &amp; FLG_USER_STACK_TRACE_DB) {
00897         PVOID BaseAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00898         ULONG ReserveSize = 2 * 1024 * 1024;
00899 
00900         st = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>( NtCurrentProcess(),
00901                                       (PVOID *)&amp;BaseAddress,
00902                                       0,
00903                                       &amp;ReserveSize,
00904                                       MEM_RESERVE,
00905                                       PAGE_READWRITE
00906                                     );
00907         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) ) {
00908             st = RtlInitializeStackTraceDataBase( BaseAddress,
00909                                                   0,
00910                                                   ReserveSize
00911                                                 );
00912             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) ) {
00913                 <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( NtCurrentProcess(),
00914                                      (PVOID *)&amp;BaseAddress,
00915                                      &amp;ReserveSize,
00916                                      MEM_RELEASE
00917                                    );
00918                 }
00919             <span class="keywordflow">else</span> {
00920                 Peb-&gt;NtGlobalFlag |= FLG_HEAP_VALIDATE_PARAMETERS;
00921                 }
00922             }
00923         }
00924 <span class="preprocessor">#endif // i386</span>
00925 <span class="preprocessor"></span>
00926     <span class="comment">//</span>
00927     <span class="comment">// Initialize the loader data based in the PEB.</span>
00928     <span class="comment">//</span>
00929 
00930     st = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;FastPebLock);
00931     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00932         <span class="keywordflow">return</span> st;
00933         }
00934     Peb-&gt;FastPebLock = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a46">FastPebLock</a>;
00935     Peb-&gt;FastPebLockRoutine = (PVOID)&amp;RtlEnterCriticalSection;
00936     Peb-&gt;FastPebUnlockRoutine = (PVOID)&amp;RtlLeaveCriticalSection;
00937 
00938     <a class="code" href="../../d5/d9/heapdll_8c.html#a20">RtlInitializeHeapManager</a>();
00939 <span class="preprocessor">#if defined(_WIN64)</span>
00940 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (UseWOW64) {
00941         <span class="comment">//</span>
00942         <span class="comment">// Create a heap using all defaults.  The 32-bit process heap</span>
00943         <span class="comment">// will be created later by ntdll32 using the parameters from the exe.</span>
00944         <span class="comment">//</span>
00945         Peb-&gt;ProcessHeap = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>( ProcessHeapFlags,
00946                                           NULL,
00947                                           0,
00948                                           0,
00949                                           NULL,
00950                                           &amp;HeapParameters
00951                                         );
00952     } <span class="keywordflow">else</span>
00953 <span class="preprocessor">#endif</span>
00954 <span class="preprocessor"></span>    {
00955 
00956         <span class="keywordflow">if</span> (NtHeader-&gt;OptionalHeader.MajorSubsystemVersion &lt;= 3 &amp;&amp;
00957             NtHeader-&gt;OptionalHeader.MinorSubsystemVersion &lt; 51
00958            ) {
00959             ProcessHeapFlags |= HEAP_CREATE_ALIGN_16;
00960             }
00961 
00962         Peb-&gt;ProcessHeap = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>( ProcessHeapFlags,
00963                                           NULL,
00964                                           NtHeader-&gt;OptionalHeader.SizeOfHeapReserve,
00965                                           NtHeader-&gt;OptionalHeader.SizeOfHeapCommit,
00966                                           NULL,             <span class="comment">// Lock to use for serialization</span>
00967                                           &amp;HeapParameters
00968                                         );
00969     }
00970     <span class="keywordflow">if</span> (Peb-&gt;ProcessHeap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00971         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00972     }
00973 
00974     <a class="code" href="../../d9/d2/ldrp_8h.html#a53">NtdllBaseTag</a> = <a class="code" href="../../d5/d9/heapdll_8c.html#a28">RtlCreateTagHeap</a>( Peb-&gt;ProcessHeap,
00975                                      0,
00976                                      L<span class="stringliteral">"NTDLL!"</span>,
00977                                      L<span class="stringliteral">"!Process\0"</span>                  <span class="comment">// Heap Name</span>
00978                                      L<span class="stringliteral">"CSRSS Client\0"</span>
00979                                      L<span class="stringliteral">"LDR Database\0"</span>
00980                                      L<span class="stringliteral">"Current Directory\0"</span>
00981                                      L<span class="stringliteral">"TLS Storage\0"</span>
00982                                      L<span class="stringliteral">"DBGSS Client\0"</span>
00983                                      L<span class="stringliteral">"SE Temporary\0"</span>
00984                                      L<span class="stringliteral">"Temporary\0"</span>
00985                                      L<span class="stringliteral">"LocalAtom\0"</span>
00986                                    );
00987 
00988     <a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a> = <a class="code" href="../../d8/d2/ldrinit_8c.html#a23">NtdllpAllocateStringRoutine</a>;
00989     <a class="code" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a> = <a class="code" href="../../d8/d2/ldrinit_8c.html#a24">NtdllpFreeStringRoutine</a>;
00990 
00991     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a12">RtlInitializeAtomPackage</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( ATOM_TAG ) );
00992 
00993     <span class="comment">//</span>
00994     <span class="comment">// Allow only the process heap to have page allocations turned on</span>
00995     <span class="comment">//</span>
00996 
00997     st = <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( UnicodeImageName,
00998                                             L<span class="stringliteral">"DebugProcessHeapOnly"</span>,
00999                                             REG_DWORD,
01000                                             &amp;DebugProcessHeapOnly,
01001                                             <span class="keyword">sizeof</span>( DebugProcessHeapOnly ),
01002                                             NULL
01003                                           );
01004     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
01005 
01006         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d9/heappage_8c.html#a36">RtlpDebugPageHeap</a> &amp;&amp;
01007              ( DebugProcessHeapOnly != 0 ) ) {
01008 
01009             <a class="code" href="../../d6/d9/heappage_8c.html#a36">RtlpDebugPageHeap</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01010 
01011             }
01012 
01013         }
01014 
01015     SystemDllPath.Buffer = SystemDllPathBuffer;
01016     SystemDllPath.Length = 0;
01017     SystemDllPath.MaximumLength = <span class="keyword">sizeof</span>( SystemDllPathBuffer );
01018     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;NtSystemRoot, USER_SHARED_DATA-&gt;NtSystemRoot );
01019     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;SystemDllPath, &amp;NtSystemRoot );
01020     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;SystemDllPath, L<span class="stringliteral">"\\System32\\"</span> );
01021 
01022     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Unicode,L<span class="stringliteral">"\\KnownDlls"</span>);
01023     InitializeObjectAttributes( &amp;Obja,
01024                                   &amp;Unicode,
01025                                   OBJ_CASE_INSENSITIVE,
01026                                   NULL,
01027                                   NULL
01028                                 );
01029     st = <a class="code" href="../../d8/d0/obdir_8c.html#a1">NtOpenDirectoryObject</a>(
01030             &amp;LdrpKnownDllObjectDirectory,
01031             DIRECTORY_QUERY | DIRECTORY_TRAVERSE,
01032             &amp;Obja
01033             );
01034     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01035         <a class="code" href="../../d9/d2/ldrp_8h.html#a23">LdrpKnownDllObjectDirectory</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01036         <span class="comment">// KnownDlls directory doesn't exist - assume it's system32.</span>
01037         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;LdrpKnownDllPath, SystemDllPath.Buffer);
01038         <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length -= <span class="keyword">sizeof</span>(WCHAR);    <span class="comment">// remove trailing '\'</span>
01039         }
01040     <span class="keywordflow">else</span> {
01041 
01042         <span class="comment">//</span>
01043         <span class="comment">// Open up the known dll pathname link</span>
01044         <span class="comment">// and query its value</span>
01045         <span class="comment">//</span>
01046 
01047         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Unicode,L<span class="stringliteral">"KnownDllPath"</span>);
01048         InitializeObjectAttributes( &amp;Obja,
01049                                       &amp;Unicode,
01050                                       OBJ_CASE_INSENSITIVE,
01051                                       LdrpKnownDllObjectDirectory,
01052                                       NULL
01053                                     );
01054         st = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>( &amp;LinkHandle,
01055                                        SYMBOLIC_LINK_QUERY,
01056                                        &amp;Obja
01057                                      );
01058         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
01059             <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length = 0;
01060             <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d2/ldrp_8h.html#a24">LdrpKnownDllPathBuffer</a>);
01061             <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Buffer = <a class="code" href="../../d9/d2/ldrp_8h.html#a24">LdrpKnownDllPathBuffer</a>;
01062             st = <a class="code" href="../../d4/d1/oblink_8c.html#a7">NtQuerySymbolicLinkObject</a>( LinkHandle,
01063                                             &amp;LdrpKnownDllPath,
01064                                             NULL
01065                                           );
01066             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LinkHandle);
01067             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01068                 <span class="keywordflow">return</span> st;
01069                 }
01070             }
01071         <span class="keywordflow">else</span> {
01072             <span class="keywordflow">return</span> st;
01073             }
01074         }
01075 
01076     <span class="keywordflow">if</span> (ProcessParameters) {
01077 
01078         <span class="comment">//</span>
01079         <span class="comment">// If the process was created with process parameters,</span>
01080         <span class="comment">// than extract:</span>
01081         <span class="comment">//</span>
01082         <span class="comment">//      - Library Search Path</span>
01083         <span class="comment">//</span>
01084         <span class="comment">//      - Starting Current Directory</span>
01085         <span class="comment">//</span>
01086 
01087         <span class="keywordflow">if</span> (ProcessParameters-&gt;DllPath.Length) {
01088             <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a> = *(PUNICODE_STRING)&amp;ProcessParameters-&gt;DllPath;
01089             }
01090         <span class="keywordflow">else</span> {
01091             <a class="code" href="../../d8/d2/ldrinit_8c.html#a25">LdrpInitializationFailure</a>( STATUS_INVALID_PARAMETER );
01092             }
01093 
01094         StaticCurDir = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01095         CurDir = ProcessParameters-&gt;CurrentDirectory.DosPath;
01096         <span class="keywordflow">if</span> (CurDir.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || CurDir.Buffer[ 0 ] == UNICODE_NULL || CurDir.Length == 0) {
01097             CurDir.Buffer = (<a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a>)( (3+1) * <span class="keyword">sizeof</span>( WCHAR ) );
01098             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CurDir.Buffer != NULL);
01099             RtlMoveMemory( CurDir.Buffer,
01100                            USER_SHARED_DATA-&gt;NtSystemRoot,
01101                            3 * <span class="keyword">sizeof</span>( WCHAR )
01102                          );
01103             CurDir.Buffer[ 3 ] = UNICODE_NULL;
01104             }
01105         }
01106 
01107     <span class="comment">//</span>
01108     <span class="comment">// Make sure the module data base is initialized before we take any</span>
01109     <span class="comment">// exceptions.</span>
01110     <span class="comment">//</span>
01111 
01112     Peb-&gt;Ldr = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(Peb-&gt;ProcessHeap, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( LDR_TAG ), <span class="keyword">sizeof</span>(PEB_LDR_DATA));
01113     <span class="keywordflow">if</span> ( !Peb-&gt;Ldr ) {
01114         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_NO_MEMORY);
01115         }
01116 
01117     Peb-&gt;Ldr-&gt;Length = <span class="keyword">sizeof</span>(PEB_LDR_DATA);
01118     Peb-&gt;Ldr-&gt;Initialized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01119     Peb-&gt;Ldr-&gt;SsHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01120     InitializeListHead(&amp;Peb-&gt;Ldr-&gt;InLoadOrderModuleList);
01121     InitializeListHead(&amp;Peb-&gt;Ldr-&gt;InMemoryOrderModuleList);
01122     InitializeListHead(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList);
01123 
01124     <span class="comment">//</span>
01125     <span class="comment">// Allocate the first data table entry for the image. Since we</span>
01126     <span class="comment">// have already mapped this one, we need to do the allocation by hand.</span>
01127     <span class="comment">// Its characteristics identify it as not a Dll, but it is linked</span>
01128     <span class="comment">// into the table so that pc correlation searching doesn't have to</span>
01129     <span class="comment">// be special cased.</span>
01130     <span class="comment">//</span>
01131 
01132     LdrDataTableEntry = <a class="code" href="../../d9/d2/ldrp_8h.html#a40">LdrpImageEntry</a> = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">LdrpAllocateDataTableEntry</a>(Peb-&gt;ImageBaseAddress);
01133     LdrDataTableEntry-&gt;LoadCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xffff;
01134     LdrDataTableEntry-&gt;EntryPoint = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">LdrpFetchAddressOfEntryPoint</a>(LdrDataTableEntry-&gt;DllBase);
01135     LdrDataTableEntry-&gt;FullDllName = FullImageName;
01136     LdrDataTableEntry-&gt;Flags = 0;
01137 
01138     <span class="comment">// p = strrchr(FullImageName, '\\');</span>
01139     pp = UNICODE_NULL;
01140     p = FullImageName.Buffer;
01141     <span class="keywordflow">while</span> (*p) {
01142         <span class="keywordflow">if</span> (*p++ == (WCHAR)<span class="charliteral">'\\'</span>) {
01143             pp = p;
01144         }
01145     }
01146 
01147     LdrDataTableEntry-&gt;FullDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)p - (ULONG_PTR)FullImageName.Buffer);
01148     LdrDataTableEntry-&gt;FullDllName.MaximumLength = LdrDataTableEntry-&gt;FullDllName.Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
01149 
01150     <span class="keywordflow">if</span> (pp) {
01151        LdrDataTableEntry-&gt;BaseDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)p - (ULONG_PTR)pp);
01152        LdrDataTableEntry-&gt;BaseDllName.MaximumLength = LdrDataTableEntry-&gt;BaseDllName.Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
01153        LdrDataTableEntry-&gt;BaseDllName.Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(Peb-&gt;ProcessHeap, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( LDR_TAG ),
01154                                                                LdrDataTableEntry-&gt;BaseDllName.MaximumLength
01155                                                               );
01156        RtlMoveMemory(LdrDataTableEntry-&gt;BaseDllName.Buffer,
01157                      pp,
01158                      LdrDataTableEntry-&gt;BaseDllName.MaximumLength
01159                     );
01160     }  <span class="keywordflow">else</span> {
01161               LdrDataTableEntry-&gt;BaseDllName = LdrDataTableEntry-&gt;FullDllName;
01162             }
01163     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">LdrpInsertMemoryTableEntry</a>(LdrDataTableEntry);
01164     LdrDataTableEntry-&gt;Flags |= LDRP_ENTRY_PROCESSED;
01165 
01166     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01167         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: NEW PROCESS\n"</span> );
01168         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"     Image Path: %wZ (%wZ)\n"</span>,
01169                   &amp;LdrDataTableEntry-&gt;FullDllName,
01170                   &amp;LdrDataTableEntry-&gt;BaseDllName
01171                 );
01172         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"     Current Directory: %wZ\n"</span>, &amp;CurDir );
01173         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"     Search Path: %wZ\n"</span>, &amp;LdrpDefaultPath );
01174     }
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">// The process references the system DLL, so map this one next. Since</span>
01178     <span class="comment">// we have already mapped this one, we need to do the allocation by</span>
01179     <span class="comment">// hand. Since every application will be statically linked to the</span>
01180     <span class="comment">// system Dll, we'll keep the LoadCount initialized to 0.</span>
01181     <span class="comment">//</span>
01182 
01183     LdrDataTableEntry = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">LdrpAllocateDataTableEntry</a>(SystemDllBase);
01184     LdrDataTableEntry-&gt;Flags = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)LDRP_IMAGE_DLL;
01185     LdrDataTableEntry-&gt;EntryPoint = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">LdrpFetchAddressOfEntryPoint</a>(LdrDataTableEntry-&gt;DllBase);
01186     LdrDataTableEntry-&gt;LoadCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xffff;
01187 
01188     LdrDataTableEntry-&gt;BaseDllName.Length = SystemDllPath.Length;
01189     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;SystemDllPath, L<span class="stringliteral">"ntdll.dll"</span> );
01190     LdrDataTableEntry-&gt;BaseDllName.Length = SystemDllPath.Length - LdrDataTableEntry-&gt;BaseDllName.Length;
01191     LdrDataTableEntry-&gt;BaseDllName.MaximumLength = LdrDataTableEntry-&gt;BaseDllName.Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
01192 
01193     LdrDataTableEntry-&gt;FullDllName.Buffer =
01194         (<a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a>)( SystemDllPath.Length + <span class="keyword">sizeof</span>( UNICODE_NULL ) );
01195     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LdrDataTableEntry-&gt;FullDllName.Buffer != NULL);
01196     RtlMoveMemory( LdrDataTableEntry-&gt;FullDllName.Buffer,
01197                    SystemDllPath.Buffer,
01198                    SystemDllPath.Length
01199                  );
01200     LdrDataTableEntry-&gt;FullDllName.Buffer[ SystemDllPath.Length / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
01201     LdrDataTableEntry-&gt;FullDllName.Length = SystemDllPath.Length;
01202     LdrDataTableEntry-&gt;FullDllName.MaximumLength = SystemDllPath.Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
01203     LdrDataTableEntry-&gt;BaseDllName.Buffer = (PWSTR)
01204         ((PCHAR)(LdrDataTableEntry-&gt;FullDllName.Buffer) +
01205          LdrDataTableEntry-&gt;FullDllName.Length -
01206          LdrDataTableEntry-&gt;BaseDllName.Length
01207         );
01208     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">LdrpInsertMemoryTableEntry</a>(LdrDataTableEntry);
01209 
01210     <span class="comment">//</span>
01211     <span class="comment">// Add init routine to list</span>
01212     <span class="comment">//</span>
01213 
01214     InsertHeadList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
01215                    &amp;LdrDataTableEntry-&gt;InInitializationOrderLinks);
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">// Inherit the current directory</span>
01219     <span class="comment">//</span>
01220 
01221     st = <a class="code" href="../../d5/d1/curdir_8c.html#a22">RtlSetCurrentDirectory_U</a>(&amp;CurDir);
01222     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01223         <span class="keywordflow">if</span> ( !StaticCurDir ) {
01224             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;CurDir);
01225             }
01226         CurDir = <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>;
01227         st = <a class="code" href="../../d5/d1/curdir_8c.html#a22">RtlSetCurrentDirectory_U</a>(&amp;CurDir);
01228         }
01229     <span class="keywordflow">else</span> {
01230         <span class="keywordflow">if</span> ( !StaticCurDir ) {
01231             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;CurDir);
01232             }
01233         }
01234 
01235 <span class="preprocessor">#if defined(WX86)</span>
01236 <span class="preprocessor"></span>
01237     <span class="comment">//</span>
01238     <span class="comment">// Load in x86 emulator for risc (Wx86.dll)</span>
01239     <span class="comment">//</span>
01240 
01241     <span class="keywordflow">if</span> (NtHeader-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386) {
01242         st = LdrpLoadWx86Dll(Context);
01243         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01244             <span class="keywordflow">return</span> st;
01245             }
01246         }
01247 
01248 <span class="preprocessor">#endif</span>
01249 <span class="preprocessor"></span>
01250 <span class="preprocessor">#if defined(_WIN64)</span>
01251 <span class="preprocessor"></span>    <span class="comment">//</span>
01252     <span class="comment">// Load in WOW64 if the image is supposed to run simulated</span>
01253     <span class="comment">//</span>
01254     <span class="keywordflow">if</span> (UseWOW64) {
01255         UNICODE_STRING Wow64Name;
01256         ANSI_STRING ProcName;
01257         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Wow64Name, L<span class="stringliteral">"wow64.dll"</span>);
01258         st = <a class="code" href="../../d4/d2/ldrapi_8c.html#a2">LdrLoadDll</a>(NULL, NULL, &amp;Wow64Name, &amp;Wow64Handle);
01259         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01260             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01261                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"wow64.dll not found.  Status=%x\n"</span>, st);
01262             }
01263             <span class="keywordflow">return</span> st;
01264         }
01265 
01266         <span class="comment">//</span>
01267         <span class="comment">// Get the entrypoints.  They are roughly cloned from ntos\ps\psinit.c</span>
01268         <span class="comment">// PspInitSystemDll().</span>
01269         <span class="comment">//</span>
01270         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ProcName, <span class="stringliteral">"Wow64LdrpInitialize"</span>);
01271         st = <a class="code" href="../../d4/d2/ldrapi_8c.html#a7">LdrGetProcedureAddress</a>(Wow64Handle,
01272                                     &amp;ProcName,
01273                                     0,
01274                                     (PVOID *)&amp;Wow64LdrpInitialize);
01275         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01276             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01277                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Wow64LdrpInitialize not found.  Status=%x\n"</span>, st);
01278             }
01279             <span class="keywordflow">return</span> st;
01280         }
01281 
01282         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ProcName, <span class="stringliteral">"Wow64PrepareForException"</span>);
01283         st = <a class="code" href="../../d4/d2/ldrapi_8c.html#a7">LdrGetProcedureAddress</a>(Wow64Handle,
01284                                     &amp;ProcName,
01285                                     0,
01286                                     (PVOID *)&amp;Wow64PrepareForException);
01287         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01288             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01289                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Wow64PrepareForException not found.  Status=%x\n"</span>, st);
01290             }
01291             <span class="keywordflow">return</span> st;
01292         }
01293 
01294         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WARNING:  PROCESS HAS BEEN CONVERTED TO WOW64!!!\n"</span>);
01295         <span class="keywordflow">if</span> (Peb-&gt;ProcessParameters) {
01296            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CommandLine: %wZ\n"</span>, &amp;Peb-&gt;ProcessParameters-&gt;CommandLine);
01297            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ImagePathName: %wZ\n"</span>, &amp;Peb-&gt;ProcessParameters-&gt;ImagePathName);
01298         }
01299 
01300         <span class="comment">//</span>
01301         <span class="comment">// Now that all DLLs are loaded, if the process is being debugged,</span>
01302         <span class="comment">// signal the debugger with an exception</span>
01303         <span class="comment">//</span>
01304 
01305         <span class="keywordflow">if</span> ( Peb-&gt;BeingDebugged ) {
01306              DbgBreakPoint();
01307         }
01308 
01309         <span class="comment">//</span>
01310         <span class="comment">// Release the loaderlock now - this thread doesn't need it any more.</span>
01311         <span class="comment">//</span>
01312         RtlLeaveCriticalSection(&amp;LoaderLock);
01313 
01314         <span class="comment">//</span>
01315         <span class="comment">// Call wow64 to load and run 32-bit ntdll.dll.</span>
01316         <span class="comment">//</span>
01317         (*Wow64LdrpInitialize)(Context);
01318         <span class="comment">// This never returns.  It will destroy the process.</span>
01319     }
01320 <span class="preprocessor">#endif</span>
01321 <span class="preprocessor"></span>
01322 
01323     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor</a>(
01324             <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer,
01325             LdrpImageEntry
01326             );
01327 
01328     <span class="keywordflow">if</span> ((PVOID)NtHeader-&gt;OptionalHeader.ImageBase != NtCurrentPeb()-&gt;ImageBaseAddress ) {
01329 
01330         <span class="comment">//</span>
01331         <span class="comment">// The executable is not at its original address.  It must be</span>
01332         <span class="comment">// relocated now.</span>
01333         <span class="comment">//</span>
01334 
01335         PVOID ViewBase;
01336         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01337 
01338         ViewBase = NtCurrentPeb()-&gt;ImageBaseAddress;
01339 
01340         status = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, FALSE, TRUE);
01341 
01342         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01343             <span class="keywordflow">return</span> status;
01344         }
01345 
01346         status = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d3/ldrreloc_8c.html#a5">LdrRelocateImage</a>(ViewBase,
01347                     <span class="stringliteral">"LDR"</span>,
01348                     (ULONG)STATUS_SUCCESS,
01349                     (ULONG)STATUS_CONFLICTING_ADDRESSES,
01350                     (ULONG)STATUS_INVALID_IMAGE_FORMAT
01351                     );
01352 
01353         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01354             <span class="keywordflow">return</span> status;
01355         }
01356 
01357         <span class="comment">//</span>
01358         <span class="comment">// Update the initial thread context record as per the relocation.</span>
01359         <span class="comment">//</span>
01360 
01361         <span class="keywordflow">if</span> (Context) {
01362 
01363             OldBase = NtHeader-&gt;OptionalHeader.ImageBase;
01364             Diff = (PCHAR)ViewBase - (PCHAR)OldBase;
01365 
01366             <a class="code" href="../../d8/d2/ldrinit_8c.html#a14">LdrpRelocateStartContext</a>(Context, Diff);
01367         }
01368 
01369         status = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, TRUE, TRUE);
01370 
01371         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01372             <span class="keywordflow">return</span> status;
01373         }
01374     }
01375 
01376 <span class="preprocessor">#if defined (_ALPHA_)</span>
01377 <span class="preprocessor"></span>
01378     <span class="comment">//</span>
01379     <span class="comment">// Find and apply Alpha architecture fixups for this image</span>
01380     <span class="comment">//</span>
01381 
01382     AlphaFindArchitectureFixups(NtHeader, NtCurrentPeb()-&gt;ImageBaseAddress, TRUE);
01383 <span class="preprocessor">#endif</span>
01384 <span class="preprocessor"></span>
01385     <a class="code" href="../../d9/d2/ldrp_8h.html#a9">LdrpReferenceLoadedDll</a>(LdrpImageEntry);
01386 
01387     <span class="comment">//</span>
01388     <span class="comment">// Lock the loaded DLLs to prevent dlls that back link to the exe to</span>
01389     <span class="comment">// cause problems when they are unloaded.</span>
01390     <span class="comment">//</span>
01391 
01392     {
01393         PLDR_DATA_TABLE_ENTRY Entry;
01394         PLIST_ENTRY Head,Next;
01395 
01396         Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01397         Next = Head-&gt;Flink;
01398 
01399         <span class="keywordflow">while</span> ( Next != Head ) {
01400             Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01401             Entry-&gt;LoadCount = 0xffff;
01402             Next = Next-&gt;Flink;
01403         }
01404     }
01405 
01406     <span class="comment">//</span>
01407     <span class="comment">// All static DLLs are now pinned in place. No init routines have been run yet</span>
01408     <span class="comment">//</span>
01409 
01410     <a class="code" href="../../d8/d2/ldrinit_8c.html#a3">LdrpLdrDatabaseIsSetup</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01411 
01412 
01413     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01414 <span class="preprocessor">#if DBG</span>
01415 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Initialize of image failed. Returning Error Status\n"</span>);
01416 <span class="preprocessor">#endif</span>
01417 <span class="preprocessor"></span>        <span class="keywordflow">return</span> st;
01418     }
01419 
01420     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a78">LdrpInitializeTls</a>()) ) {
01421         <span class="keywordflow">return</span> st;
01422         }
01423 
01424     <span class="comment">//</span>
01425     <span class="comment">// Now that all DLLs are loaded, if the process is being debugged,</span>
01426     <span class="comment">// signal the debugger with an exception</span>
01427     <span class="comment">//</span>
01428 
01429     <span class="keywordflow">if</span> ( Peb-&gt;BeingDebugged ) {
01430          DbgBreakPoint();
01431          <a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a> = (BOOLEAN)(FLG_SHOW_LDR_SNAPS &amp; Peb-&gt;NtGlobalFlag);
01432     }
01433 
01434 <span class="preprocessor">#if defined (_X86_)</span>
01435 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a48">LdrpNumberOfProcessors</a> &gt; 1 ) {
01436         LdrpValidateImageForMp(LdrDataTableEntry);
01437         }
01438 <span class="preprocessor">#endif</span>
01439 <span class="preprocessor"></span>
01440 <span class="preprocessor">#if DBG</span>
01441 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
01442         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;InitbTime, NULL);
01443     }
01444 <span class="preprocessor">#endif // DBG</span>
01445 <span class="preprocessor"></span>
01446     <span class="comment">//</span>
01447     <span class="comment">// Get all application goo here (hacks, flags, etc.)</span>
01448     <span class="comment">//</span>
01449     <a class="code" href="../../d8/d2/ldrinit_8c.html#a19">LdrQueryApplicationCompatibilityGoo</a>(UnicodeImageName);
01450 
01451     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a43">LdrpRunInitializeRoutines</a>(Context);
01452 
01453     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) &amp;&amp; Peb-&gt;PostProcessInitRoutine ) {
01454         (Peb-&gt;PostProcessInitRoutine)();
01455         }
01456 
01457     <span class="keywordflow">return</span> st;
01458 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="ldrinit.c::LdrpInitializeThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpInitializeThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">1702</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">LdrpAllocateTls()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00484">LdrpCallInitRoutine</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02178">LdrpCallTlsInitializers()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00032">LdrpImageHasTls</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00031">LdrpShutdownInProgress</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>.
<p>
<pre class="fragment"><div>01708                    :
01709 
01710     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a thread that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> terminating cleanly.
01711     It's purpose <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to call all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processes DLLs to notify them
01712     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> detaching.
01713 
01714 Arguments:
01715 
01716     Context - Context that will be restored after loader initializes.
01717 
01718 Return Value:
01719 
01720     None.
01721 
01722 --*/
01723 
01724 {
01725     PPEB Peb;
01726     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
01727     PDLL_INIT_ROUTINE InitRoutine;
01728     PLIST_ENTRY Next;
01729 
01730     Peb = NtCurrentPeb();
01731 
01732     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> ) {
01733         <span class="keywordflow">return</span>;
01734         }
01735 
01736     <a class="code" href="../../d9/d2/ldrp_8h.html#a79">LdrpAllocateTls</a>();
01737 
01738     Next = Peb-&gt;Ldr-&gt;InMemoryOrderModuleList.Flink;
01739     <span class="keywordflow">while</span> (Next != &amp;Peb-&gt;Ldr-&gt;InMemoryOrderModuleList) {
01740         LdrDataTableEntry
01741             = (PLDR_DATA_TABLE_ENTRY)
01742               (CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks));
01743 
01744         <span class="comment">//</span>
01745         <span class="comment">// Walk through the entire list looking for</span>
01746         <span class="comment">// entries. For each entry, that has an init</span>
01747         <span class="comment">// routine, call it.</span>
01748         <span class="comment">//</span>
01749         <span class="keywordflow">if</span> (Peb-&gt;ImageBaseAddress != LdrDataTableEntry-&gt;DllBase) {
01750             <span class="keywordflow">if</span> ( !(LdrDataTableEntry-&gt;Flags &amp; LDRP_DONT_CALL_FOR_THREADS)) {
01751                 InitRoutine = (PDLL_INIT_ROUTINE)LdrDataTableEntry-&gt;EntryPoint;
01752                 <span class="keywordflow">if</span> (InitRoutine &amp;&amp; (LdrDataTableEntry-&gt;Flags &amp; LDRP_PROCESS_ATTACH_CALLED) ) {
01753                     <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;Flags &amp; LDRP_IMAGE_DLL) {
01754                         <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;TlsIndex ) {
01755                             <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> ) {
01756                                 <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(LdrDataTableEntry-&gt;DllBase,DLL_THREAD_ATTACH);
01757                                 }
01758                             }
01759 
01760 <span class="preprocessor">#if defined (WX86)</span>
01761 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (!Wx86ProcessInit ||
01762                             LdrpRunWx86DllEntryPoint(InitRoutine,
01763                                                     NULL,
01764                                                     LdrDataTableEntry-&gt;DllBase,
01765                                                     DLL_THREAD_ATTACH,
01766                                                     NULL
01767                                                     ) ==  STATUS_IMAGE_MACHINE_TYPE_MISMATCH)
01768 <span class="preprocessor">#endif</span>
01769 <span class="preprocessor"></span>                           {
01770                             <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> ) {
01771                                 <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>(InitRoutine,
01772                                                     LdrDataTableEntry-&gt;DllBase,
01773                                                     DLL_THREAD_ATTACH,
01774                                                     NULL);
01775                                 }
01776                             }
01777                         }
01778                     }
01779                 }
01780             }
01781         Next = Next-&gt;Flink;
01782         }
01783 
01784     <span class="comment">//</span>
01785     <span class="comment">// If the image has tls than call its initializers</span>
01786     <span class="comment">//</span>
01787 
01788     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a> &amp;&amp; !<a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> ) {
01789         <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(NtCurrentPeb()-&gt;ImageBaseAddress,DLL_THREAD_ATTACH);
01790         }
01791 
01792 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="ldrinit.c::LdrpInitializeTls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpInitializeTls           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">1978</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">LdrpAllocateTls()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00032">LdrpImageHasTls</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00401">LdrpNumberOfTlsEntries</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00400">LdrpTlsList</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d9/d2/ldrp_8h.html#a50">PLDRP_TLS_ENTRY</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00323">RtlpSerializeHeap()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00462">TLS_TAG</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.
<p>
<pre class="fragment"><div>01981 {
01982     PLDR_DATA_TABLE_ENTRY Entry;
01983     PLIST_ENTRY Head,Next;
01984     PIMAGE_TLS_DIRECTORY TlsImage;
01985     <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">PLDRP_TLS_ENTRY</a> TlsEntry;
01986     ULONG TlsSize;
01987     BOOLEAN FirstTimeThru = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01988 
01989     InitializeListHead(&amp;LdrpTlsList);
01990 
01991     <span class="comment">//</span>
01992     <span class="comment">// Walk through the loaded modules an look for TLS. If we find TLS,</span>
01993     <span class="comment">// lock in the module and add to the TLS chain.</span>
01994     <span class="comment">//</span>
01995 
01996     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01997     Next = Head-&gt;Flink;
01998 
01999     <span class="keywordflow">while</span> ( Next != Head ) {
02000         Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
02001         Next = Next-&gt;Flink;
02002 
02003         TlsImage = (PIMAGE_TLS_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02004                            Entry-&gt;DllBase,
02005                            TRUE,
02006                            IMAGE_DIRECTORY_ENTRY_TLS,
02007                            &amp;TlsSize
02008                            );
02009 
02010         <span class="comment">//</span>
02011         <span class="comment">// mark whether or not the image file has TLS</span>
02012         <span class="comment">//</span>
02013 
02014         <span class="keywordflow">if</span> ( FirstTimeThru ) {
02015             FirstTimeThru = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02016             <span class="keywordflow">if</span> ( TlsImage &amp;&amp; !<a class="code" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a>) {
02017                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a11">RtlpSerializeHeap</a>( RtlProcessHeap() );
02018                 <a class="code" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02019                 }
02020             }
02021 
02022         <span class="keywordflow">if</span> ( TlsImage ) {
02023             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02024                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: Tls Found in %wZ at %lx\n"</span>,
02025                             &amp;Entry-&gt;BaseDllName,
02026                             TlsImage
02027                         );
02028                 }
02029 
02030             TlsEntry = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TLS_TAG ),<span class="keyword">sizeof</span>(*TlsEntry));
02031             <span class="keywordflow">if</span> ( !TlsEntry ) {
02032                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02033                 }
02034 
02035             <span class="comment">//</span>
02036             <span class="comment">// Since this DLL has TLS, lock it in</span>
02037             <span class="comment">//</span>
02038 
02039             Entry-&gt;LoadCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xffff;
02040 
02041             <span class="comment">//</span>
02042             <span class="comment">// Mark this as having thread local storage</span>
02043             <span class="comment">//</span>
02044 
02045             Entry-&gt;TlsIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xffff;
02046 
02047             TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a> = *TlsImage;
02048             InsertTailList(&amp;LdrpTlsList,&amp;TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o0">Links</a>);
02049 
02050             <span class="comment">//</span>
02051             <span class="comment">// Update the index for this dll's thread local storage</span>
02052             <span class="comment">//</span>
02053 
02054 
02055             *(PLONG)TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.AddressOfIndex = <a class="code" href="../../d9/d2/ldrp_8h.html#a52">LdrpNumberOfTlsEntries</a>;
02056             TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics = <a class="code" href="../../d9/d2/ldrp_8h.html#a52">LdrpNumberOfTlsEntries</a>++;
02057             }
02058         }
02059 
02060     <span class="comment">//</span>
02061     <span class="comment">// We now have walked through all static DLLs and know</span>
02062     <span class="comment">// all DLLs that reference thread local storage. Now we</span>
02063     <span class="comment">// just have to allocate the thread local storage for the current</span>
02064     <span class="comment">// thread and for all subsequent threads</span>
02065     <span class="comment">//</span>
02066 
02067     <span class="keywordflow">return</span> <a class="code" href="../../d9/d2/ldrp_8h.html#a79">LdrpAllocateTls</a>();
02068 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ldrinit.c::LdrpRelocateStartContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpRelocateStartContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Diff</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/alpha_2ldrctx_8c-source.html#l00028">28</a> of file <a class="el" href="../../d6/d1/alpha_2ldrctx_8c-source.html">alpha/ldrctx.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.
<p>
<pre class="fragment"><div>00034                    :
00035 
00036    This routine relocates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start context to mesh with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00037    executable that has just been relocated.
00038 
00039 Arguments:
00040 
00041    Context - Supplies a context that needs editing.
00042 
00043    Diff - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> difference from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> based address to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relocated
00044           address.
00045 
00046 Return Value:
00047 
00048    None.
00049 
00050 --*/
00051 {
00052     Context-&gt;IntA0 += (ULONGLONG)Diff;
00053     Context-&gt;IntGp += (ULONGLONG)Diff;
00054 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="ldrinit.c::LdrpSearchResourceSection_U" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpSearchResourceSection_U           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceIdPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceIdPathLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FindDirectoryEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExactLangMatchOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceDirectoryOrData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l00492">492</a> of file <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html">ldrrsrc.c</a>.
<p>
<pre class="fragment"><div>00503                    :
00504 
00505     This function locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified resource in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00506     specified DLL and returns its address.
00507 
00508 Arguments:
00509 
00510     DllHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00511         contained in.
00512 
00513     ResourceIdPath - Supplies a pointer to an array of 32-bit resource
00514         identifiers.  Each identifier <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either an integer or a pointer
00515         to a null terminated string (PSZ) that specifies a resource
00516         name.  The array is used to traverse the directory structure
00517         contained in the resource section in the image file specified by
00518         the DllHandle parameter.
00519 
00520     ResourceIdPathLength - Supplies the number of elements in the
00521         ResourceIdPath array.
00522 
00523     FindDirectoryEntry - Supplies a <span class="keywordtype">boolean</span> that is TRUE if caller is
00524         searching for a resource directory, otherwise the caller is
00525         searching for a resource data entry.
00526 
00527     ExactLangMatchOnly - Supplies a <span class="keywordtype">boolean</span> that is TRUE if caller is
00528         searching for a resource with, and only with, the language <span class="keywordtype">id</span>
00529         specified in ResourceIdPath, otherwise the caller wants the routine
00530         to come up with default when specified langid is not found.
00531 
00532     ResourceDirectoryOrData - Supplies a pointer to a variable that will
00533         receive the address of the resource directory or data entry in
00534         the resource data section of the image file specified by the
00535         DllHandle parameter.
00536 
00537 Return Value:
00538 
00539     TBD
00540 
00541 --*/
00542 
00543 {
00544     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00545     PIMAGE_RESOURCE_DIRECTORY LanguageResourceDirectory, ResourceDirectory, TopResourceDirectory;
00546     PIMAGE_RESOURCE_DIRECTORY_ENTRY ResourceDirEntLow;
00547     PIMAGE_RESOURCE_DIRECTORY_ENTRY ResourceDirEntMiddle;
00548     PIMAGE_RESOURCE_DIRECTORY_ENTRY ResourceDirEntHigh;
00549     PIMAGE_RESOURCE_DATA_ENTRY ResourceEntry;
00550     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>, half;
00551     LONG <a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a>;
00552     ULONG size;
00553     ULONG_PTR ResourceIdRetry;
00554     ULONG RetryCount;
00555     LANGID NewLangId;
00556     PULONG_PTR IdPath = ResourceIdPath;
00557     ULONG IdPathLength = ResourceIdPathLength;
00558     BOOLEAN fIsNeutral = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00559     LANGID GivenLanguage;
00560 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
00561 <span class="preprocessor"></span>    LCID DefaultThreadLocale, DefaultSystemLocale;
00562     PVOID AltResourceDllHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00563     ULONG_PTR UIResourceIdPath[3];
00564 <span class="preprocessor">#endif</span>
00565 <span class="preprocessor"></span>
00566     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00567 
00568     <span class="keywordflow">try</span> {
00569         TopResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00570             <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(DllHandle,
00571                                          TRUE,
00572                                          IMAGE_DIRECTORY_ENTRY_RESOURCE,
00573                                          &amp;size
00574                                          );
00575         <span class="keywordflow">if</span> (!TopResourceDirectory) {
00576             <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00577             }
00578 
00579         ResourceDirectory = TopResourceDirectory;
00580         ResourceIdRetry = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a>;
00581         RetryCount = 0;
00582         ResourceEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00583         LanguageResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00584         <span class="keywordflow">while</span> (ResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ResourceIdPathLength--) {
00585             <span class="comment">//</span>
00586             <span class="comment">// If search path includes a language id, then attempt to</span>
00587             <span class="comment">// match the following language ids in this order:</span>
00588             <span class="comment">//</span>
00589             <span class="comment">//   (0)  use given language id</span>
00590             <span class="comment">//   (1)  use primary language of given language id</span>
00591             <span class="comment">//   (2)  use id 0  (neutral resource)</span>
00592             <span class="comment">//   (3)  use default UI language id</span>
00593             <span class="comment">//</span>
00594             <span class="comment">// If the PRIMARY language id is ZERO, then ALSO attempt to</span>
00595             <span class="comment">// match the following language ids in this order:</span>
00596             <span class="comment">//</span>
00597             <span class="comment">//   (4)  use lang id of TEB if different from user locale</span>
00598             <span class="comment">//   (5)  use UI lang from exe resource</span>
00599             <span class="comment">//   (6)  use primary UI lang from exe resource</span>
00600             <span class="comment">//   (7)  use Install Language</span>
00601             <span class="comment">//   (8)  use lang id from user's locale id</span>
00602             <span class="comment">//   (9)  use primary language of user's locale id</span>
00603             <span class="comment">//   (10) use lang id from system default locale id</span>
00604             <span class="comment">//   (11) use primary language of system default locale id</span>
00605             <span class="comment">//   (12) use US English lang id</span>
00606             <span class="comment">//   (13) use any lang id that matches requested info</span>
00607             <span class="comment">//</span>
00608             <span class="keywordflow">if</span> (ResourceIdPathLength == 0 &amp;&amp; IdPathLength == 3) {
00609                 LanguageResourceDirectory = ResourceDirectory;
00610                 }
00611 
00612             <span class="keywordflow">if</span> (LanguageResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00613                 GivenLanguage = (LANGID)IdPath[ 2 ];
00614                 fIsNeutral = (PRIMARYLANGID( GivenLanguage ) == LANG_NEUTRAL);
00615 TryNextLangId:
00616                 <span class="keywordflow">switch</span>( RetryCount++ ) {
00617 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
00618 <span class="preprocessor"></span>                    <span class="keywordflow">case</span> 0:     <span class="comment">// Use given language id</span>
00619                         NewLangId = GivenLanguage;
00620                         <span class="keywordflow">break</span>;
00621 
00622                     <span class="keywordflow">case</span> 1:     <span class="comment">// Use primary language of given language id</span>
00623                         NewLangId = PRIMARYLANGID( GivenLanguage );
00624                         <span class="keywordflow">break</span>;
00625 
00626                     <span class="keywordflow">case</span> 2:     <span class="comment">// Use id 0  (neutral resource)</span>
00627                         NewLangId = 0;
00628                         <span class="keywordflow">break</span>;
00629 
00630                     <span class="keywordflow">case</span> 3:     <span class="comment">// Use user's default UI language</span>
00631                         NewLangId = (LANGID)ResourceIdRetry;
00632                         <span class="keywordflow">break</span>;
00633 
00634                     <span class="keywordflow">case</span> 4:     <span class="comment">// Use native UI language</span>
00635                         <span class="keywordflow">if</span> ( !fIsNeutral ) {
00636                             <span class="comment">// Stop looking - Not in the neutral case</span>
00637                             <span class="keywordflow">goto</span> ReturnFailure;
00638                             <span class="keywordflow">break</span>;
00639                         }
00640                         NewLangId = <a class="code" href="../../d1/d9/ps_8h.html#a61">PsInstallUILanguageId</a>;
00641                         <span class="keywordflow">break</span>;
00642 
00643                     <span class="keywordflow">case</span> 5:     <span class="comment">// Use default system locale</span>
00644                         NewLangId = LANGIDFROMLCID(PsDefaultSystemLocaleId);
00645                         <span class="keywordflow">break</span>;
00646 
00647                     <span class="keywordflow">case</span> 6:
00648                         <span class="comment">// Use US English language</span>
00649                         NewLangId = MAKELANGID( LANG_ENGLISH, SUBLANG_ENGLISH_US );
00650                         <span class="keywordflow">break</span>;
00651 
00652                     <span class="keywordflow">case</span> 7:     <span class="comment">// Take any lang id that matches</span>
00653                         NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a>;
00654                         <span class="keywordflow">break</span>;
00655 
00656 <span class="preprocessor">#else</span>
00657 <span class="preprocessor"></span>                    <span class="keywordflow">case</span> 0:     <span class="comment">// Use given language id</span>
00658                         NewLangId = GivenLanguage;
00659                         <span class="keywordflow">break</span>;
00660 
00661                     <span class="keywordflow">case</span> 1:     <span class="comment">// Use primary language of given language id</span>
00662                         <span class="keywordflow">if</span> ( ExactLangMatchOnly) {
00663                             <span class="comment">//</span>
00664                             <span class="comment">//  Did not find an exact language match.</span>
00665                             <span class="comment">//  Stop looking.</span>
00666                             <span class="comment">//</span>
00667                             <span class="keywordflow">goto</span> ReturnFailure;
00668                         }
00669                         NewLangId = PRIMARYLANGID( GivenLanguage );
00670                         <span class="keywordflow">break</span>;
00671 
00672                     <span class="keywordflow">case</span> 2:     <span class="comment">// Use id 0  (neutral resource)</span>
00673                         NewLangId = 0;
00674                         <span class="keywordflow">break</span>;
00675 
00676                     <span class="keywordflow">case</span> 3:     <span class="comment">// Use user's default UI language</span>
00677 
00678                         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>){
00679                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a47">NtQueryDefaultUILanguage</a>( &amp;UILangId );
00680                             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00681                                 <span class="comment">//</span>
00682                                 <span class="comment">// Failed reading key.  Skip this lookup.</span>
00683                                 <span class="comment">//</span>
00684                                 NewLangId = (LANGID)ResourceIdRetry;
00685                                 <span class="keywordflow">break</span>;
00686                             }
00687                         }
00688                         NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>;
00689                         <span class="comment">//</span>
00690                         <span class="comment">// Arabic/Hebrew MUI files may contain resources with LANG ID different than 401/40d.</span>
00691                         <span class="comment">// e.g. Comdlg32.dll has two sets of Arabic/Hebrew resources one mirrored (401/40d)</span>
00692                         <span class="comment">// and one flipped (801/80d).</span>
00693                         <span class="comment">//</span>
00694                         <span class="keywordflow">if</span>( !fIsNeutral &amp;&amp;
00695                             ((PRIMARYLANGID (GivenLanguage) == LANG_ARABIC) || (PRIMARYLANGID (GivenLanguage) == LANG_HEBREW)) &amp;&amp;
00696                             (PRIMARYLANGID (GivenLanguage) == PRIMARYLANGID (NewLangId))
00697                           ) {
00698                             NewLangId = GivenLanguage;
00699                         }
00700 
00701                         <span class="keywordflow">if</span> (fIsNeutral || GivenLanguage == NewLangId){
00702                             <span class="comment">//</span>
00703                             <span class="comment">//  Load alternate resource dll.</span>
00704                             <span class="comment">//</span>
00705                             AltResourceDllHandle=<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a21">LdrLoadAlternateResourceModule</a>(
00706                                                     DllHandle,
00707                                                     NULL);
00708 
00709                             <span class="keywordflow">if</span> (!AltResourceDllHandle){
00710                                 <span class="comment">//</span>
00711                                 <span class="comment">//  Alternate resource dll not available.</span>
00712                                 <span class="comment">//  Skip this lookup.</span>
00713                                 <span class="comment">//</span>
00714                                 NewLangId = (LANGID)ResourceIdRetry;
00715                                 <span class="keywordflow">break</span>;
00716 
00717                             }
00718 
00719                             <span class="comment">//</span>
00720                             <span class="comment">//  Map to alternate resource dll and search</span>
00721                             <span class="comment">//  it instead.</span>
00722                             <span class="comment">//</span>
00723 
00724                             UIResourceIdPath[0]=IdPath[0];
00725                             UIResourceIdPath[1]=IdPath[1];
00726                             UIResourceIdPath[2]=NewLangId;
00727 
00728                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a34">LdrpSearchResourceSection_U</a>(
00729                                         AltResourceDllHandle,
00730                                         UIResourceIdPath,
00731                                         3,
00732                                         FindDirectoryEntry,
00733                                         TRUE,
00734                                         (PVOID *)ResourceDirectoryOrData
00735                                         );
00736 
00737                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)){
00738                                 <span class="comment">//</span>
00739                                 <span class="comment">// We sucessfully found alternate resource,</span>
00740                                 <span class="comment">// return it.</span>
00741                                 <span class="comment">//</span>
00742                                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00743                             }
00744 
00745 
00746                         }
00747                         <span class="comment">//</span>
00748                         <span class="comment">//  Caller does not want alternate resource, or</span>
00749                         <span class="comment">//  alternate resource not found.</span>
00750                         <span class="comment">//</span>
00751                         NewLangId = (LANGID)ResourceIdRetry;
00752                         <span class="keywordflow">break</span>;
00753 
00754 
00755                     <span class="keywordflow">case</span> 4:     <span class="comment">// Use langid of ThreadLocale if different from user locale</span>
00756                         <span class="keywordflow">if</span> ( !fIsNeutral ) {
00757                             <span class="comment">// Stop looking - Not in the neutral case</span>
00758                             <span class="keywordflow">goto</span> ReturnFailure;
00759                             <span class="keywordflow">break</span>;
00760                         }
00761 
00762                         <span class="comment">//</span>
00763                         <span class="comment">// Try the thread locale language-id if it is different from</span>
00764                         <span class="comment">// user locale.</span>
00765                         <span class="comment">//</span>
00766                         <span class="keywordflow">if</span> (NtCurrentTeb()){
00767                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a44">NtQueryDefaultLocale</a>(
00768                                         TRUE,
00769                                         &amp;DefaultThreadLocale
00770                                         );
00771                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp;
00772                                 DefaultThreadLocale !=
00773                                 NtCurrentTeb()-&gt;CurrentLocale) {
00774                                 <span class="comment">//</span>
00775                                 <span class="comment">// Thread locale is different from</span>
00776                                 <span class="comment">// default locale.</span>
00777                                 <span class="comment">//</span>
00778                                 NewLangId = LANGIDFROMLCID(NtCurrentTeb()-&gt;CurrentLocale);
00779                                 <span class="keywordflow">break</span>;
00780                             }
00781                         }
00782 
00783                         NewLangId = (LANGID)ResourceIdRetry;
00784                         <span class="keywordflow">break</span>;
00785 
00786 
00787                     <span class="keywordflow">case</span> 5:   <span class="comment">// UI language from the executable resource</span>
00788 
00789                         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>){
00790                             NewLangId = (LANGID)ResourceIdRetry;
00791                         } <span class="keywordflow">else</span> {
00792                             NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>;
00793                         }
00794                         <span class="keywordflow">break</span>;
00795 
00796                     <span class="keywordflow">case</span> 6:   <span class="comment">// Parimary lang of UI language from the executable resource</span>
00797 
00798                         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>){
00799                             NewLangId = (LANGID)ResourceIdRetry;
00800                         } <span class="keywordflow">else</span> {
00801                             NewLangId = PRIMARYLANGID( (LANGID) UILangId );
00802                         }
00803                         <span class="keywordflow">break</span>;
00804 
00805                     <span class="keywordflow">case</span> 7:   <span class="comment">// Use install -native- language</span>
00806                         <span class="comment">//</span>
00807                         <span class="comment">// Thread locale is the same as the user locale, then let's</span>
00808                         <span class="comment">// try loading the native (install) ui language resources.</span>
00809                         <span class="comment">//</span>
00810                         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>){
00811                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a46">NtQueryInstallUILanguage</a>(&amp;InstallLangId);
00812                             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00813                                 <span class="comment">//</span>
00814                                 <span class="comment">// Failed reading key.  Skip this lookup.</span>
00815                                 <span class="comment">//</span>
00816                                 NewLangId = (LANGID)ResourceIdRetry;
00817                                 <span class="keywordflow">break</span>;
00818 
00819                             }
00820                         }
00821 
00822                         NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>;
00823                         <span class="keywordflow">break</span>;
00824 
00825                     <span class="keywordflow">case</span> 8:     <span class="comment">// Use lang id from locale in TEB</span>
00826                         <span class="keywordflow">if</span> (SUBLANGID( GivenLanguage ) == SUBLANG_SYS_DEFAULT) {
00827                             <span class="comment">// Skip over all USER locale options</span>
00828                             DefaultThreadLocale = 0;
00829                             RetryCount += 2;
00830                             <span class="keywordflow">break</span>;
00831                         }
00832 
00833                         <span class="keywordflow">if</span> (NtCurrentTeb() != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00834                             NewLangId = LANGIDFROMLCID(NtCurrentTeb()-&gt;CurrentLocale);
00835                         }
00836                         <span class="keywordflow">break</span>;
00837 
00838                     <span class="keywordflow">case</span> 9:     <span class="comment">// Use User's default locale</span>
00839                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a44">NtQueryDefaultLocale</a>( TRUE, &amp;DefaultThreadLocale );
00840                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00841                             NewLangId = LANGIDFROMLCID(DefaultThreadLocale);
00842                             <span class="keywordflow">break</span>;
00843                             }
00844 
00845                         RetryCount++;
00846                         <span class="keywordflow">break</span>;
00847 
00848                     <span class="keywordflow">case</span> 10:     <span class="comment">// Use primary language of User's default locale</span>
00849                         NewLangId = PRIMARYLANGID( (LANGID)ResourceIdRetry );
00850                         <span class="keywordflow">break</span>;
00851 
00852                     <span class="keywordflow">case</span> 11:     <span class="comment">// Use System default locale</span>
00853                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a44">NtQueryDefaultLocale</a>( FALSE, &amp;DefaultSystemLocale );
00854                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00855                             RetryCount++;
00856                             <span class="keywordflow">break</span>;
00857                         }
00858                         <span class="keywordflow">if</span> (DefaultSystemLocale != DefaultThreadLocale) {
00859                             NewLangId = LANGIDFROMLCID(DefaultSystemLocale);
00860                             <span class="keywordflow">break</span>;
00861                         }
00862 
00863                         RetryCount += 2;
00864                         <span class="comment">// fall through</span>
00865 
00866                     <span class="keywordflow">case</span> 13:     <span class="comment">// Use US English language</span>
00867                         NewLangId = MAKELANGID( LANG_ENGLISH, SUBLANG_ENGLISH_US );
00868                         <span class="keywordflow">break</span>;
00869 
00870                     <span class="keywordflow">case</span> 12:     <span class="comment">// Use primary language of System default locale</span>
00871                         NewLangId = PRIMARYLANGID( (LANGID)ResourceIdRetry );
00872                         <span class="keywordflow">break</span>;
00873 
00874                     <span class="keywordflow">case</span> 14:     <span class="comment">// Take any lang id that matches</span>
00875                         NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a>;
00876                         <span class="keywordflow">break</span>;
00877 <span class="preprocessor">#endif</span>
00878 <span class="preprocessor"></span>                    <span class="keywordflow">default</span>:    <span class="comment">// No lang ids to match</span>
00879                         <span class="keywordflow">goto</span> ReturnFailure;
00880                         <span class="keywordflow">break</span>;
00881                 }
00882 
00883                 <span class="comment">//</span>
00884                 <span class="comment">// If looking for a specific language id and same as the</span>
00885                 <span class="comment">// one we just looked up, then skip it.</span>
00886                 <span class="comment">//</span>
00887                 <span class="keywordflow">if</span> (NewLangId != <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a> &amp;&amp;
00888                     NewLangId == ResourceIdRetry
00889                    ) {
00890                     <span class="keywordflow">goto</span> TryNextLangId;
00891                     }
00892 
00893                 <span class="comment">//</span>
00894                 <span class="comment">// Try this new language Id</span>
00895                 <span class="comment">//</span>
00896                 ResourceIdRetry = (ULONG_PTR)NewLangId;
00897                 ResourceIdPath = &amp;ResourceIdRetry;
00898                 ResourceDirectory = LanguageResourceDirectory;
00899                 }
00900 
00901             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = ResourceDirectory-&gt;NumberOfNamedEntries;
00902             ResourceDirEntLow = (PIMAGE_RESOURCE_DIRECTORY_ENTRY)(ResourceDirectory+1);
00903             <span class="keywordflow">if</span> (!(*ResourceIdPath &amp; LDR_RESOURCE_ID_NAME_MASK)) {
00904                 ResourceDirEntLow += <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00905                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = ResourceDirectory-&gt;NumberOfIdEntries;
00906                 }
00907 
00908             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>) {
00909                 ResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00910                 <span class="keywordflow">goto</span> NotFound;
00911                 }
00912 
00913             <span class="keywordflow">if</span> (LanguageResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00914                 *ResourceIdPath == <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a>
00915                ) {
00916                 ResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00917                 ResourceIdRetry = ResourceDirEntLow-&gt;Name;
00918                 ResourceEntry = (PIMAGE_RESOURCE_DATA_ENTRY)
00919                     ((PCHAR)TopResourceDirectory +
00920                             ResourceDirEntLow-&gt;OffsetToData
00921                     );
00922 
00923                 <span class="keywordflow">break</span>;
00924                 }
00925 
00926             ResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00927             ResourceDirEntHigh = ResourceDirEntLow + <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> - 1;
00928             <span class="keywordflow">while</span> (ResourceDirEntLow &lt;= ResourceDirEntHigh) {
00929                 <span class="keywordflow">if</span> ((half = (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &gt;&gt; 1)) != 0) {
00930                     ResourceDirEntMiddle = ResourceDirEntLow;
00931                     <span class="keywordflow">if</span> (*(PUCHAR)&amp;<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &amp; 1) {
00932                         ResourceDirEntMiddle += half;
00933                         }
00934                     <span class="keywordflow">else</span> {
00935                         ResourceDirEntMiddle += half - 1;
00936                         }
00937                     <a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a> = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a33">LdrpCompareResourceNames_U</a>( *ResourceIdPath,
00938                                                       TopResourceDirectory,
00939                                                       ResourceDirEntMiddle
00940                                                     );
00941                     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a>) {
00942                         <span class="keywordflow">if</span> (ResourceDirEntMiddle-&gt;DataIsDirectory) {
00943                             ResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00944                     ((PCHAR)TopResourceDirectory +
00945                                     ResourceDirEntMiddle-&gt;OffsetToDirectory
00946                                 );
00947                             }
00948                         <span class="keywordflow">else</span> {
00949                             ResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00950                             ResourceEntry = (PIMAGE_RESOURCE_DATA_ENTRY)
00951                                 ((PCHAR)TopResourceDirectory +
00952                   ResourceDirEntMiddle-&gt;OffsetToData
00953                                 );
00954                             }
00955 
00956                         <span class="keywordflow">break</span>;
00957                         }
00958                     <span class="keywordflow">else</span> {
00959                         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a> &lt; 0) {
00960                             ResourceDirEntHigh = ResourceDirEntMiddle - 1;
00961                             <span class="keywordflow">if</span> (*(PUCHAR)&amp;<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &amp; 1) {
00962                                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = half;
00963                                 }
00964                             <span class="keywordflow">else</span> {
00965                                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = half - 1;
00966                                 }
00967                             }
00968                         <span class="keywordflow">else</span> {
00969                             ResourceDirEntLow = ResourceDirEntMiddle + 1;
00970                             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = half;
00971                             }
00972                         }
00973                     }
00974                 <span class="keywordflow">else</span> {
00975                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> != 0) {
00976                         <a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a> = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a33">LdrpCompareResourceNames_U</a>( *ResourceIdPath,
00977                           TopResourceDirectory,
00978                                                           ResourceDirEntLow
00979                                                         );
00980                         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a>) {
00981                             <span class="keywordflow">if</span> (ResourceDirEntLow-&gt;DataIsDirectory) {
00982                                 ResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00983                                     ((PCHAR)TopResourceDirectory +
00984                                         ResourceDirEntLow-&gt;OffsetToDirectory
00985                                     );
00986                                 }
00987                             <span class="keywordflow">else</span> {
00988                                 ResourceEntry = (PIMAGE_RESOURCE_DATA_ENTRY)
00989                                     ((PCHAR)TopResourceDirectory +
00990                       ResourceDirEntLow-&gt;OffsetToData
00991                                     );
00992                                 }
00993                             }
00994                         }
00995 
00996                     <span class="keywordflow">break</span>;
00997                     }
00998                 }
00999 
01000             ResourceIdPath++;
01001             }
01002 
01003         <span class="keywordflow">if</span> (ResourceEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !FindDirectoryEntry) {
01004             *ResourceDirectoryOrData = (PVOID)ResourceEntry;
01005             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01006             }
01007         <span class="keywordflow">else</span>
01008         <span class="keywordflow">if</span> (ResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; FindDirectoryEntry) {
01009             *ResourceDirectoryOrData = (PVOID)ResourceDirectory;
01010             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01011             }
01012         <span class="keywordflow">else</span> {
01013 NotFound:
01014             <span class="keywordflow">switch</span>( IdPathLength - ResourceIdPathLength) {
01015                 <span class="keywordflow">case</span> 3:     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_RESOURCE_LANG_NOT_FOUND; <span class="keywordflow">break</span>;
01016                 <span class="keywordflow">case</span> 2:     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_RESOURCE_NAME_NOT_FOUND; <span class="keywordflow">break</span>;
01017                 <span class="keywordflow">case</span> 1:     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_RESOURCE_TYPE_NOT_FOUND; <span class="keywordflow">break</span>;
01018                 <span class="keywordflow">default</span>:    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="keywordflow">break</span>;
01019                 }
01020             }
01021 
01022         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_RESOURCE_LANG_NOT_FOUND &amp;&amp;
01023             LanguageResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01024            ) {
01025             ResourceEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01026             <span class="keywordflow">goto</span> TryNextLangId;
01027 ReturnFailure: ;
01028             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_RESOURCE_LANG_NOT_FOUND;
01029             }
01030         }
01031     except (EXCEPTION_EXECUTE_HANDLER) {
01032         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01033         }
01034 
01035     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01036 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="ldrinit.c::LdrQueryApplicationCompatibilityGoo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrQueryApplicationCompatibilityGoo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>UnicodeImageName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02277">2277</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02246">GetNextCommaValue()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02683">LdrFindAppCompatVariableInfo()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l00096">LdrpAccessResourceData()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l00492">LdrpSearchResourceSection_U()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00250">RtlQueryEnvironmentVariable_U()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.
<p>
<pre class="fragment"><div>02283                    :
02284 
02285     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d8/d2/ldrinit_8c.html#a26">LdrpInitialize</a> after its initialized <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02286     process.  It's purpose <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to query any application specific flags,
02287     hacks, etc.  If any app specific information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found, its hung off
02288     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PEB <span class="keywordflow">for</span> other components to test against.
02289 
02290     Besides setting hanging <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AppCompatInfo <span class="keyword">struct </span>off <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PEB, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02291     <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> other action that will occur in here <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> setting OS version
02292     numbers in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PEB if <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate <a class="code" href="../../d2/d5/editreg_8c.html#a50">Version</a> lie app flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set.
02293 
02294 Arguments:
02295 
02296     UnicodeImageName - Actual image name (including path)
02297 
02298 Return Value:
02299 
02300     None.
02301 
02302 --*/
02303 
02304 {
02305 
02306     PPEB Peb;
02307     PVOID ResourceInfo;
02308     ULONG TotalGooLength;
02309     ULONG AppCompatLength;
02310     ULONG ResultSize;
02311     ULONG ResourceSize;
02312     ULONG InputCompareLength;
02313     ULONG OutputCompareLength;
02314     LANGID LangId;
02315     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02316     BOOLEAN bImageContainsVersionResourceInfo;
02317     ULONG_PTR IdPath[3];
02318     APP_COMPAT_GOO LocalAppCompatGoo;
02319     PAPP_COMPAT_GOO AppCompatGoo;
02320     PAPP_COMPAT_INFO AppCompatInfo;
02321     PAPP_VARIABLE_INFO AppVariableInfo;
02322     PPRE_APP_COMPAT_INFO AppCompatEntry;
02323     PIMAGE_RESOURCE_DATA_ENTRY DataEntry;
02324     PEFFICIENTOSVERSIONINFOEXW OSVerInfo;
02325     UNICODE_STRING EnvName;
02326     UNICODE_STRING EnvValue;
02327     WCHAR *NewCSDString;
02328     WCHAR TempString[ 128 ];   <span class="comment">// is the size of szCSDVersion in OSVERSIONINFOW</span>
02329     BOOLEAN fNewCSDVersionBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02330 
02331     <span class="keyword">struct </span>{
02332         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TotalSize;
02333         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> DataSize;
02334         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Type;
02335         WCHAR <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>[16];              <span class="comment">// L"VS_VERSION_INFO" + unicode nul</span>
02336     } *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
02337 
02338 
02339     <span class="comment">//</span>
02340     <span class="comment">// Check execution options to see if there's any Goo for this app.</span>
02341     <span class="comment">// We purposely feed a small struct to LdrQueryImageFileExecOptions,</span>
02342     <span class="comment">// so that it can come back with success/failure, and if success we see</span>
02343     <span class="comment">// how much we need to alloc.  As the results coming back will be of</span>
02344     <span class="comment">// variable length.</span>
02345     <span class="comment">//</span>
02346     Peb = NtCurrentPeb();
02347     Peb-&gt;AppCompatInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02348     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Peb-&gt;CSDVersion, NULL);
02349 
02350     st = <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( UnicodeImageName,
02351                                             L<span class="stringliteral">"ApplicationGoo"</span>,
02352                                             REG_BINARY,
02353                                             &amp;LocalAppCompatGoo,
02354                                             <span class="keyword">sizeof</span>(APP_COMPAT_GOO),
02355                                             &amp;ResultSize
02356                                           );
02357 
02358     <span class="comment">//</span>
02359     <span class="comment">// If there's an entry there, we're guaranteed to get overflow error.</span>
02360     <span class="comment">//</span>
02361     <span class="keywordflow">if</span> (st == STATUS_BUFFER_OVERFLOW) {
02362 
02363         <span class="comment">//</span>
02364         <span class="comment">// Something is there, alloc memory for the "Pre" Goo struct right now</span>
02365         <span class="comment">//</span>
02366         AppCompatGoo = \
02367             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(Peb-&gt;ProcessHeap, HEAP_ZERO_MEMORY, ResultSize);
02368 
02369         <span class="keywordflow">if</span> (!AppCompatGoo) {
02370             <span class="keywordflow">return</span>;
02371         }
02372 
02373         <span class="comment">//</span>
02374         <span class="comment">// Now that we've got the memory, hit it again</span>
02375         <span class="comment">//</span>
02376         st = <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( UnicodeImageName,
02377                                                 L<span class="stringliteral">"ApplicationGoo"</span>,
02378                                                 REG_BINARY,
02379                                                 AppCompatGoo,
02380                                                 ResultSize,
02381                                                 &amp;ResultSize
02382                                               );
02383 
02384         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
02385             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(Peb-&gt;ProcessHeap, 0, AppCompatGoo);
02386             <span class="keywordflow">return</span>;
02387         }
02388 
02389         <span class="comment">//</span>
02390         <span class="comment">// Got a hit on this key, however we don't know fer sure that its</span>
02391         <span class="comment">// an exact match.  There could be multiple App Compat entries</span>
02392         <span class="comment">// within this Goo.  So we get the version resource information out</span>
02393         <span class="comment">// of the Image hdr (if avail) and later we compare it against all of</span>
02394         <span class="comment">// the entries found within the Goo hoping for a match.</span>
02395         <span class="comment">//</span>
02396         <span class="comment">// Need Language Id in order to query the resource info</span>
02397         <span class="comment">//</span>
02398         bImageContainsVersionResourceInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02399 <span class="comment">//        NtQueryDefaultUILanguage(&amp;LangId);</span>
02400         IdPath[0] = 16;                             <span class="comment">// RT_VERSION</span>
02401         IdPath[1] = 1;                              <span class="comment">// VS_VERSION_INFO</span>
02402         IdPath[2] = 0; <span class="comment">// LangId;</span>
02403 
02404         <span class="comment">//</span>
02405         <span class="comment">// Search for version resource information</span>
02406         <span class="comment">//</span>
02407         <span class="keywordflow">try</span> {
02408             st = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a34">LdrpSearchResourceSection_U</a>(
02409                     Peb-&gt;ImageBaseAddress,
02410                     IdPath,
02411                     3,
02412                     FALSE,
02413                     FALSE,   <span class="comment">// TRUE,</span>
02414                     &amp;DataEntry
02415                     );
02416 
02417         } except(EXCEPTION_EXECUTE_HANDLER) {
02418             st = STATUS_UNSUCCESSFUL;
02419         }
02420 
02421         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
02422 
02423             <span class="comment">//</span>
02424             <span class="comment">// Give us a pointer to the resource information</span>
02425             <span class="comment">//</span>
02426             <span class="keywordflow">try</span> {
02427                 st = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a35">LdrpAccessResourceData</a>(
02428                         Peb-&gt;ImageBaseAddress,
02429                         DataEntry,
02430                         &amp;Resource,
02431                         &amp;ResourceSize
02432                         );
02433 
02434             } except(EXCEPTION_EXECUTE_HANDLER) {
02435                 st = STATUS_UNSUCCESSFUL;
02436             }
02437 
02438             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
02439                 bImageContainsVersionResourceInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02440             }
02441 
02442         }
02443 
02444         <span class="comment">//</span>
02445         <span class="comment">// Now that we either have (or have not) the version resource info,</span>
02446         <span class="comment">// bounce down each app compat entry looking for a match.  If there</span>
02447         <span class="comment">// wasn't any version resource info in the image hdr, its going to be</span>
02448         <span class="comment">// an automatic match to an entry that also doesn't have anything for</span>
02449         <span class="comment">// its version resource info.  Obviously there can be only one of these</span>
02450         <span class="comment">// "empty" entries within the Goo (as the first one will always be</span>
02451         <span class="comment">// matched first.</span>
02452         <span class="comment">//</span>
02453         st = STATUS_SUCCESS;
02454         AppCompatEntry = AppCompatGoo-&gt;AppCompatEntry;
02455         TotalGooLength = \
02456             AppCompatGoo-&gt;dwTotalGooSize - <span class="keyword">sizeof</span>(AppCompatGoo-&gt;dwTotalGooSize);
02457         <span class="keywordflow">while</span> (TotalGooLength) {
02458 
02459             <span class="keywordflow">try</span> {
02460 
02461                 <span class="comment">//</span>
02462                 <span class="comment">// Compare what we're told to by the resource info size.  The</span>
02463                 <span class="comment">// ResourceInfo (if avail) is directly behind the AppCompatEntry</span>
02464                 <span class="comment">//</span>
02465                 InputCompareLength = AppCompatEntry-&gt;dwResourceInfoSize;
02466                 ResourceInfo = AppCompatEntry + 1;
02467                 <span class="keywordflow">if</span> (bImageContainsVersionResourceInfo) {
02468 
02469                     <span class="keywordflow">if</span> (InputCompareLength &gt; <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;TotalSize) {
02470                         InputCompareLength = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;TotalSize;
02471                     }
02472 
02473                     OutputCompareLength = \
02474                         (ULONG)RtlCompareMemory(
02475                             ResourceInfo,
02476                             Resource,
02477                             InputCompareLength
02478                             );
02479 
02480                 }
02481 
02482                 <span class="comment">//</span>
02483                 <span class="comment">// In this case, we don't have any version resource info in</span>
02484                 <span class="comment">// the image header, so set OutputCompareLength to zero.</span>
02485                 <span class="comment">// If InputCompareLength was set to zero (above) due to the</span>
02486                 <span class="comment">// AppCompatEntry also having no version resource info, then</span>
02487                 <span class="comment">// the test will succeed (below) and we've found our match.</span>
02488                 <span class="comment">// Otherwise, this is not the same app and it won't be a match.</span>
02489                 <span class="comment">//</span>
02490                 <span class="keywordflow">else</span> {
02491                     OutputCompareLength = 0;
02492                 }
02493 
02494             } except(EXCEPTION_EXECUTE_HANDLER) {
02495                 st = STATUS_UNSUCCESSFUL;
02496             }
02497 
02498             <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) ||
02499                 (InputCompareLength != OutputCompareLength)) {
02500 
02501                 <span class="comment">//</span>
02502                 <span class="comment">// Wasn't a match for some reason or another, goto next entry</span>
02503                 <span class="comment">//</span>
02504                 TotalGooLength -= AppCompatEntry-&gt;dwEntryTotalSize;
02505                 (PUCHAR) AppCompatEntry += AppCompatEntry-&gt;dwEntryTotalSize;
02506                 <span class="keywordflow">continue</span>;
02507             }
02508 
02509             <span class="comment">//</span>
02510             <span class="comment">// We're a match!!!  Now we have to create the final "Post"</span>
02511             <span class="comment">// app compat structure that will be used by everyone to follow.</span>
02512             <span class="comment">// This guy hangs off the Peb and it doesn't have the resource</span>
02513             <span class="comment">// info still lying around in there.</span>
02514             <span class="comment">//</span>
02515             AppCompatLength = AppCompatEntry-&gt;dwEntryTotalSize;
02516             AppCompatLength -= AppCompatEntry-&gt;dwResourceInfoSize;
02517             Peb-&gt;AppCompatInfo = \
02518                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(Peb-&gt;ProcessHeap, HEAP_ZERO_MEMORY, AppCompatLength);
02519 
02520             <span class="keywordflow">if</span> (!Peb-&gt;AppCompatInfo) {
02521                 <span class="keywordflow">break</span>;
02522             }
02523 
02524             AppCompatInfo = Peb-&gt;AppCompatInfo;
02525             AppCompatInfo-&gt;dwTotalSize = AppCompatLength;
02526 
02527             <span class="comment">//</span>
02528             <span class="comment">// Copy what was beyond the resource info to near the top starting at</span>
02529             <span class="comment">// the Application compat flags.</span>
02530             <span class="comment">//</span>
02531             RtlMoveMemory(
02532                 &amp;AppCompatInfo-&gt;CompatibilityFlags,
02533                 (PUCHAR) ResourceInfo + AppCompatEntry-&gt;dwResourceInfoSize,
02534                 AppCompatInfo-&gt;dwTotalSize - FIELD_OFFSET(APP_COMPAT_INFO, CompatibilityFlags)
02535                 );
02536 
02537             <span class="comment">//</span>
02538             <span class="comment">// Now that we've created the "Post" app compat info struct to be</span>
02539             <span class="comment">// used by everyone, we need to check if version lying for this</span>
02540             <span class="comment">// app is requested.  If so, we need to stuff the Peb right now.</span>
02541             <span class="comment">//</span>
02542             <span class="keywordflow">if</span> (AppCompatInfo-&gt;CompatibilityFlags.QuadPart &amp; KACF_VERSIONLIE) {
02543 
02544                 <span class="comment">//</span>
02545                 <span class="comment">// Find the variable version lie struct somwhere within</span>
02546                 <span class="comment">//</span>
02547                 <span class="keywordflow">if</span>( STATUS_SUCCESS != <a class="code" href="../../d8/d2/ldrinit_8c.html#a20">LdrFindAppCompatVariableInfo</a>(AVT_OSVERSIONINFO, &amp;AppVariableInfo)) {
02548                     <span class="keywordflow">break</span>;
02549                 }
02550 
02551                 <span class="comment">//</span>
02552                 <span class="comment">// The variable length information itself comes at the end</span>
02553                 <span class="comment">// of the normal struct and could be of any aribitrary length</span>
02554                 <span class="comment">//</span>
02555                 AppVariableInfo++;
02556                 OSVerInfo = (PEFFICIENTOSVERSIONINFOEXW) AppVariableInfo;
02557                 Peb-&gt;OSMajorVersion = OSVerInfo-&gt;dwMajorVersion;
02558                 Peb-&gt;OSMinorVersion = OSVerInfo-&gt;dwMinorVersion;
02559                 Peb-&gt;OSBuildNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) OSVerInfo-&gt;dwBuildNumber;
02560                 Peb-&gt;OSCSDVersion = (OSVerInfo-&gt;wServicePackMajor &lt;&lt; 8) &amp; 0xFF00;
02561                 Peb-&gt;OSCSDVersion |= OSVerInfo-&gt;wServicePackMinor;
02562                 Peb-&gt;OSPlatformId = OSVerInfo-&gt;dwPlatformId;
02563 
02564                 Peb-&gt;CSDVersion.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)wcslen(&amp;OSVerInfo-&gt;szCSDVersion[0])*<span class="keyword">sizeof</span>(WCHAR);
02565                 Peb-&gt;CSDVersion.MaximumLength = Peb-&gt;CSDVersion.Length + <span class="keyword">sizeof</span>(WCHAR);
02566                 Peb-&gt;CSDVersion.Buffer = \
02567                     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
02568                         Peb-&gt;ProcessHeap,
02569                         HEAP_ZERO_MEMORY,
02570                         Peb-&gt;CSDVersion.MaximumLength
02571                         );
02572 
02573                 <span class="keywordflow">if</span> (!Peb-&gt;CSDVersion.Buffer) {
02574                     <span class="keywordflow">break</span>;
02575                 }
02576                 wcscpy(Peb-&gt;CSDVersion.Buffer, &amp;OSVerInfo-&gt;szCSDVersion[0]);
02577                 fNewCSDVersionBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02578 
02579             }
02580 
02581             <span class="keywordflow">break</span>;
02582 
02583         }
02584 
02585         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(Peb-&gt;ProcessHeap, 0, AppCompatGoo);
02586     }
02587 
02588 
02589     <span class="comment">//</span>
02590     <span class="comment">// Only look at the ENV stuff if haven't already gotten new version info from the registry</span>
02591     <span class="comment">//</span>
02592     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> == fNewCSDVersionBuffer )
02593     {
02594         <span class="comment">//</span>
02595         <span class="comment">// The format of this string is:</span>
02596         <span class="comment">// _COMPAT_VER_NNN = MajOSVer, MinOSVer, OSBldNum, MajCSD, MinCSD, PlatformID, CSDString</span>
02597         <span class="comment">//  eg:  _COMPAT_VER_NNN=4,0,1381,3,0,2,Service Pack 3</span>
02598         <span class="comment">//   (for NT 4 SP3)</span>
02599 
02600         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;EnvName, L<span class="stringliteral">"_COMPAT_VER_NNN"</span>);
02601 
02602         EnvValue.Buffer = TempString;
02603         EnvValue.Length = 0;
02604         EnvValue.MaximumLength = <span class="keyword">sizeof</span>(TempString);
02605 
02606 
02607         st = <a class="code" href="../../d5/d7/environ_8c.html#a6">RtlQueryEnvironmentVariable_U</a>(
02608             NULL,
02609             &amp;EnvName,
02610             &amp;EnvValue
02611             );
02612 
02613         <span class="comment">//</span>
02614         <span class="comment">// One of the possible error codes is BUFFER_TOO_SMALL - this indicates a</span>
02615         <span class="comment">// string that's wacko - they should not be larger than the size we define/expect</span>
02616         <span class="comment">// In this case, we'll ignore that string</span>
02617         <span class="comment">//</span>
02618         <span class="keywordflow">if</span> ( STATUS_SUCCESS == st )
02619         {
02620             WCHAR *p = EnvValue.Buffer;
02621             WCHAR *NewSPString;
02622             ULONG len = EnvValue.Length / <span class="keyword">sizeof</span>(WCHAR);  <span class="comment">// (Length is bytes, not chars)</span>
02623 
02624             <span class="comment">//</span>
02625             <span class="comment">// Ok, someone wants different version info.</span>
02626             <span class="comment">//</span>
02627             Peb-&gt;OSMajorVersion = <a class="code" href="../../d8/d2/ldrinit_8c.html#a35">GetNextCommaValue</a>( &amp;p, &amp;len );
02628             Peb-&gt;OSMinorVersion = <a class="code" href="../../d8/d2/ldrinit_8c.html#a35">GetNextCommaValue</a>( &amp;p, &amp;len );
02629             Peb-&gt;OSBuildNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d8/d2/ldrinit_8c.html#a35">GetNextCommaValue</a>( &amp;p, &amp;len );
02630             Peb-&gt;OSCSDVersion = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d8/d2/ldrinit_8c.html#a35">GetNextCommaValue</a>( &amp;p, &amp;len )) &lt;&lt; 8;
02631             Peb-&gt;OSCSDVersion |= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d8/d2/ldrinit_8c.html#a35">GetNextCommaValue</a>( &amp;p, &amp;len );
02632             Peb-&gt;OSPlatformId = <a class="code" href="../../d8/d2/ldrinit_8c.html#a35">GetNextCommaValue</a>( &amp;p, &amp;len );
02633 
02634 
02635             <span class="comment">//</span>
02636             <span class="comment">// Need to free the old buffer if there is one...</span>
02637             <span class="comment">//</span>
02638             <span class="keywordflow">if</span> ( fNewCSDVersionBuffer )
02639             {
02640                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( Peb-&gt;ProcessHeap, 0, Peb-&gt;CSDVersion.Buffer );
02641                 Peb-&gt;CSDVersion.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02642             }
02643 
02644             <span class="keywordflow">if</span> ( len )
02645             {
02646                 NewCSDString = \
02647                         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
02648                             Peb-&gt;ProcessHeap,
02649                             HEAP_ZERO_MEMORY,
02650                             ( len + 1 ) * <span class="keyword">sizeof</span>(WCHAR)
02651                             );
02652 
02653                 <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == NewCSDString )
02654                 {
02655                     <span class="keywordflow">return</span>;
02656                 }
02657 
02658                 <span class="comment">//</span>
02659                 <span class="comment">// Now copy the string to memory that we'll keep</span>
02660                 <span class="comment">//</span>
02661                 <span class="comment">// We do a movemem here rather than a string copy because current comments in</span>
02662                 <span class="comment">// RtlQueryEnvironmentVariable() indicate that in an edge case, we might not</span>
02663                 <span class="comment">// have a trailing NULL - berniem 7/7/99</span>
02664                 <span class="comment">//</span>
02665                 RtlMoveMemory( NewCSDString, p, len * <span class="keyword">sizeof</span>(WCHAR) );
02666 
02667             }
02668             <span class="keywordflow">else</span>
02669             {
02670                 NewCSDString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02671             }
02672 
02673             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;(Peb-&gt;CSDVersion), NewCSDString );
02674 
02675         }
02676     }
02677 
02678     <span class="keywordflow">return</span>;
02679 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="ldrinit.c::LdrQueryImageFileExecutionOptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrQueryImageFileExecutionOptions           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImagePathName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>OptionName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ResultSize&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">1796</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00058">KeyPath</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00045">KeyPathBuffer</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00225">RtlUnicodeStringToInteger()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00465">TEMP_TAG</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02277">LdrQueryApplicationCompatibilityGoo()</a>.
<p>
<pre class="fragment"><div>01804 {
01805     BOOLEAN bNeedToFree=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01806     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01807     UNICODE_STRING UnicodeString;
01808     PWSTR pw;
01809     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01810     HANDLE KeyHandle;
01811     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>;
01812     WCHAR <a class="code" href="../../d2/d2/rtload_8c.html#a2">KeyPathBuffer</a>[ DOS_MAX_COMPONENT_LENGTH + 100 ];
01813     ULONG KeyValueBuffer[ 256 ];
01814     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
01815     ULONG AllocLength;
01816     ULONG ResultLength;
01817 
01818     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>.Buffer = <a class="code" href="../../d2/d2/rtload_8c.html#a2">KeyPathBuffer</a>;
01819     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>.Length = 0;
01820     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d2/rtload_8c.html#a2">KeyPathBuffer</a> );
01821 
01822     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;KeyPath,
01823         L<span class="stringliteral">"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\"</span>
01824         );
01825 
01826     UnicodeString = *ImagePathName;
01827     pw = (PWSTR)((PCHAR)UnicodeString.Buffer + UnicodeString.Length);
01828     UnicodeString.MaximumLength = UnicodeString.Length;
01829     <span class="keywordflow">while</span> (UnicodeString.Length != 0) {
01830         <span class="keywordflow">if</span> (pw[ -1 ] == OBJ_NAME_PATH_SEPARATOR) {
01831             <span class="keywordflow">break</span>;
01832         }
01833         pw--;
01834         UnicodeString.Length -= <span class="keyword">sizeof</span>( *pw );
01835     }
01836     UnicodeString.Buffer = pw;
01837     UnicodeString.Length = UnicodeString.MaximumLength - UnicodeString.Length;
01838 
01839     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;KeyPath, &amp;UnicodeString );
01840 
01841     InitializeObjectAttributes( &amp;ObjectAttributes,
01842         &amp;KeyPath,
01843         OBJ_CASE_INSENSITIVE,
01844         NULL,
01845         NULL
01846         );
01847 
01848     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;KeyHandle,
01849         GENERIC_READ,
01850         &amp;ObjectAttributes
01851         );
01852 
01853     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01854         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01855     }
01856 
01857     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, OptionName );
01858     KeyValueInformation = (PKEY_VALUE_PARTIAL_INFORMATION)&amp;KeyValueBuffer;
01859     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>( KeyHandle,
01860         &amp;UnicodeString,
01861         KeyValuePartialInformation,
01862         KeyValueInformation,
01863         <span class="keyword">sizeof</span>( KeyValueBuffer ),
01864         &amp;ResultLength
01865         );
01866     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
01867         <span class="comment">//</span>
01868         <span class="comment">// This function can be called before the process heap gets created </span>
01869         <span class="comment">// therefore we need to protect against this case. The majority of the </span>
01870         <span class="comment">// code will not hit this code path because they read just strings</span>
01871         <span class="comment">// containing hex numbers and for this the size of KeyValueBuffer is </span>
01872         <span class="comment">// more than sufficient.</span>
01873         <span class="comment">//</span>
01874 
01875         <span class="keywordflow">if</span> (RtlProcessHeap()) {
01876 
01877             AllocLength = <span class="keyword">sizeof</span>( *KeyValueInformation ) +
01878                 KeyValueInformation-&gt;DataLength;
01879             KeyValueInformation = (PKEY_VALUE_PARTIAL_INFORMATION)
01880             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TEMP_TAG ), AllocLength);
01881 
01882             <span class="keywordflow">if</span> (KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01883                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01884             }
01885             <span class="keywordflow">else</span> {
01886                 bNeedToFree = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01887                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>( KeyHandle,
01888                     &amp;UnicodeString,
01889                     KeyValuePartialInformation,
01890                     KeyValueInformation,
01891                     AllocLength,
01892                     &amp;ResultLength
01893                     );
01894             }
01895         }
01896         <span class="keywordflow">else</span> {
01897 
01898             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01899         }
01900     }
01901 
01902     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01903         <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type == REG_BINARY) {
01904             <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) &amp;&amp;
01905                 (KeyValueInformation-&gt;DataLength &lt;= <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>)) {
01906                 RtlMoveMemory( Buffer, &amp;KeyValueInformation-&gt;Data, KeyValueInformation-&gt;DataLength);
01907             }
01908             <span class="keywordflow">else</span> {
01909                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01910             }
01911             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ResultSize )) {
01912                 *ResultSize = KeyValueInformation-&gt;DataLength;
01913             }
01914         }
01915         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type == REG_DWORD) {
01916 
01917             <span class="keywordflow">if</span> (Type != REG_DWORD) {
01918                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
01919             }
01920             <span class="keywordflow">else</span> {
01921                 <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)
01922                     &amp;&amp; (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> == <span class="keyword">sizeof</span>(ULONG))
01923                     &amp;&amp; (KeyValueInformation-&gt;DataLength == <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>)) {
01924 
01925                     RtlMoveMemory( Buffer, &amp;KeyValueInformation-&gt;Data, KeyValueInformation-&gt;DataLength);
01926                 }
01927                 <span class="keywordflow">else</span> {
01928                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01929                 }
01930 
01931                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ResultSize )) {
01932                     *ResultSize = KeyValueInformation-&gt;DataLength;
01933                 }
01934             }
01935         }
01936         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type != REG_SZ) {
01937             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
01938         }
01939         <span class="keywordflow">else</span> {
01940             <span class="keywordflow">if</span> (Type == REG_DWORD) {
01941                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> != <span class="keyword">sizeof</span>( ULONG )) {
01942                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = 0;
01943                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
01944                 }
01945                 <span class="keywordflow">else</span> {
01946                     UnicodeString.Buffer = (PWSTR)&amp;KeyValueInformation-&gt;Data;
01947                     UnicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
01948                     (KeyValueInformation-&gt;DataLength - <span class="keyword">sizeof</span>( UNICODE_NULL ));
01949                     UnicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)KeyValueInformation-&gt;DataLength;
01950                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>( &amp;UnicodeString, 0, (PULONG)Buffer );
01951                 }
01952             }
01953             <span class="keywordflow">else</span> {
01954                 <span class="keywordflow">if</span> (KeyValueInformation-&gt;DataLength &gt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
01955                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01956                 }
01957                 <span class="keywordflow">else</span> {
01958                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = KeyValueInformation-&gt;DataLength;
01959                 }
01960 
01961                 RtlMoveMemory( Buffer, &amp;KeyValueInformation-&gt;Data, BufferSize );
01962             }
01963 
01964             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ResultSize )) {
01965                 *ResultSize = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01966             }
01967         }
01968     }
01969 
01970     <span class="keywordflow">if</span> (bNeedToFree)
01971         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, KeyValueInformation);
01972     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( KeyHandle );
01973     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01974 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="ldrinit.c::LdrShutdownProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrShutdownProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">1462</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d3/d4/editreg_8c-source.html#l00314">CommandLine</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00484">LdrpCallInitRoutine</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02178">LdrpCallTlsInitializers()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00032">LdrpImageHasTls</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00031">LdrpShutdownInProgress</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00389">LdrpShutdownThreadId</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l06152">RtlpHeapIsLocked()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02680">RtlValidateProcessHeaps()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01468                    :
01469 
01470     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> terminating cleanly.
01471     It's purpose <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to call all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processes DLLs to notify them
01472     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> detaching.
01473 
01474 Arguments:
01475 
01476     None
01477 
01478 Return Value:
01479 
01480     None.
01481 
01482 --*/
01483 
01484 {
01485     PPEB Peb;
01486     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
01487     PDLL_INIT_ROUTINE InitRoutine;
01488     PLIST_ENTRY Next;
01489 
01490     <span class="comment">//</span>
01491     <span class="comment">// only unload once ! DllTerm routines might call exit process in fatal situations</span>
01492     <span class="comment">//</span>
01493 
01494     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> ) {
01495         <span class="keywordflow">return</span>;
01496         }
01497 
01498     Peb = NtCurrentPeb();
01499 
01500     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01501         UNICODE_STRING <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>;
01502 
01503         <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a> = Peb-&gt;ProcessParameters-&gt;CommandLine;
01504         <span class="keywordflow">if</span> (!(Peb-&gt;ProcessParameters-&gt;Flags &amp; RTL_USER_PROC_PARAMS_NORMALIZED)) {
01505             <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>.Buffer = (PWSTR)((PCHAR)<a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>.Buffer + (ULONG_PTR)(Peb-&gt;ProcessParameters));
01506         }
01507 
01508         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: PID: 0x%x finished - '%wZ'\n"</span>,
01509                   NtCurrentTeb()-&gt;ClientId.UniqueProcess,
01510                   &amp;CommandLine
01511                 );
01512     }
01513 
01514     <a class="code" href="../../d9/d2/ldrp_8h.html#a47">LdrpShutdownThreadId</a> = NtCurrentTeb()-&gt;ClientId.UniqueThread;
01515     <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01516     RtlEnterCriticalSection(&amp;LoaderLock);
01517 
01518     <span class="keywordflow">try</span> {
01519 
01520         <span class="comment">//</span>
01521         <span class="comment">// check to see if the heap is locked. If so, do not do ANY</span>
01522         <span class="comment">// dll processing since it is very likely that a dll will need</span>
01523         <span class="comment">// to do heap operations, but that the heap is not in good shape.</span>
01524         <span class="comment">// ExitProcess called in a very active app can leave threads terminated</span>
01525         <span class="comment">// in the middle of the heap code or in other very bad places. Checking the</span>
01526         <span class="comment">// heap lock is a good indication that the process was very active when it</span>
01527         <span class="comment">// called ExitProcess</span>
01528         <span class="comment">//</span>
01529 
01530         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d9/heapdll_8c.html#a46">RtlpHeapIsLocked</a>( RtlProcessHeap() )) {
01531             ;
01532             }
01533         <span class="keywordflow">else</span> {
01534             <span class="keywordflow">if</span> ( Peb-&gt;BeingDebugged ) {
01535                 <a class="code" href="../../d5/d9/heapdll_8c.html#a33">RtlValidateProcessHeaps</a>();
01536                 }
01537 
01538             <span class="comment">//</span>
01539             <span class="comment">// Go in reverse order initialization order and build</span>
01540             <span class="comment">// the unload list</span>
01541             <span class="comment">//</span>
01542 
01543             Next = Peb-&gt;Ldr-&gt;InInitializationOrderModuleList.Blink;
01544             <span class="keywordflow">while</span> ( Next != &amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList) {
01545                 LdrDataTableEntry
01546                     = (PLDR_DATA_TABLE_ENTRY)
01547                       (CONTAINING_RECORD(Next,LDR_DATA_TABLE_ENTRY,InInitializationOrderLinks));
01548 
01549                 Next = Next-&gt;Blink;
01550 
01551                 <span class="comment">//</span>
01552                 <span class="comment">// Walk through the entire list looking for</span>
01553                 <span class="comment">// entries. For each entry, that has an init</span>
01554                 <span class="comment">// routine, call it.</span>
01555                 <span class="comment">//</span>
01556 
01557                 <span class="keywordflow">if</span> (Peb-&gt;ImageBaseAddress != LdrDataTableEntry-&gt;DllBase) {
01558                     InitRoutine = (PDLL_INIT_ROUTINE)LdrDataTableEntry-&gt;EntryPoint;
01559                     <span class="keywordflow">if</span> (InitRoutine &amp;&amp; (LdrDataTableEntry-&gt;Flags &amp; LDRP_PROCESS_ATTACH_CALLED) ) {
01560                         <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;Flags) {
01561                             <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;TlsIndex ) {
01562                                 <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(LdrDataTableEntry-&gt;DllBase,DLL_PROCESS_DETACH);
01563                                 }
01564 
01565 <span class="preprocessor">#if defined (WX86)</span>
01566 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (!Wx86ProcessInit ||
01567                                 LdrpRunWx86DllEntryPoint(InitRoutine,
01568                                                         NULL,
01569                                                         LdrDataTableEntry-&gt;DllBase,
01570                                                         DLL_PROCESS_DETACH,
01571                                                         (PVOID)1
01572                                                         ) ==  STATUS_IMAGE_MACHINE_TYPE_MISMATCH)
01573 <span class="preprocessor">#endif</span>
01574 <span class="preprocessor"></span>                               {
01575                                 <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>(InitRoutine,
01576                                                     LdrDataTableEntry-&gt;DllBase,
01577                                                     DLL_PROCESS_DETACH,
01578                                                     (PVOID)1);
01579                                 }
01580 
01581                             }
01582                         }
01583                     }
01584                 }
01585 
01586             <span class="comment">//</span>
01587             <span class="comment">// If the image has tls than call its initializers</span>
01588             <span class="comment">//</span>
01589 
01590             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a> ) {
01591                 <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(NtCurrentPeb()-&gt;ImageBaseAddress,DLL_PROCESS_DETACH);
01592                 }
01593             }
01594 
01595     } finally {
01596         RtlLeaveCriticalSection(&amp;LoaderLock);
01597     }
01598 
01599 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="ldrinit.c::LdrShutdownThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrShutdownThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01602">1602</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00484">LdrpCallInitRoutine</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02178">LdrpCallTlsInitializers()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02134">LdrpFreeTls()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00032">LdrpImageHasTls</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>01608                    :
01609 
01610     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a thread that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> terminating cleanly.
01611     It's purpose <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to call all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processes DLLs to notify them
01612     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> detaching.
01613 
01614 Arguments:
01615 
01616     None
01617 
01618 Return Value:
01619 
01620     None.
01621 
01622 --*/
01623 
01624 {
01625     PPEB Peb;
01626     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
01627     PDLL_INIT_ROUTINE InitRoutine;
01628     PLIST_ENTRY Next;
01629 
01630     Peb = NtCurrentPeb();
01631 
01632     RtlEnterCriticalSection(&amp;LoaderLock);
01633 
01634     <span class="keywordflow">try</span> {
01635 
01636 
01637         <span class="comment">//</span>
01638         <span class="comment">// Go in reverse order initialization order and build</span>
01639         <span class="comment">// the unload list</span>
01640         <span class="comment">//</span>
01641 
01642         Next = Peb-&gt;Ldr-&gt;InInitializationOrderModuleList.Blink;
01643         <span class="keywordflow">while</span> ( Next != &amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList) {
01644             LdrDataTableEntry
01645                 = (PLDR_DATA_TABLE_ENTRY)
01646                   (CONTAINING_RECORD(Next,LDR_DATA_TABLE_ENTRY,InInitializationOrderLinks));
01647 
01648             Next = Next-&gt;Blink;
01649 
01650             <span class="comment">//</span>
01651             <span class="comment">// Walk through the entire list looking for</span>
01652             <span class="comment">// entries. For each entry, that has an init</span>
01653             <span class="comment">// routine, call it.</span>
01654             <span class="comment">//</span>
01655 
01656             <span class="keywordflow">if</span> (Peb-&gt;ImageBaseAddress != LdrDataTableEntry-&gt;DllBase) {
01657                 <span class="keywordflow">if</span> ( !(LdrDataTableEntry-&gt;Flags &amp; LDRP_DONT_CALL_FOR_THREADS)) {
01658                     InitRoutine = (PDLL_INIT_ROUTINE)LdrDataTableEntry-&gt;EntryPoint;
01659                     <span class="keywordflow">if</span> (InitRoutine &amp;&amp; (LdrDataTableEntry-&gt;Flags &amp; LDRP_PROCESS_ATTACH_CALLED) ) {
01660                         <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;Flags &amp; LDRP_IMAGE_DLL) {
01661                             <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;TlsIndex ) {
01662                                 <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(LdrDataTableEntry-&gt;DllBase,DLL_THREAD_DETACH);
01663                                 }
01664 
01665 <span class="preprocessor">#if defined (WX86)</span>
01666 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (!Wx86ProcessInit ||
01667                                 LdrpRunWx86DllEntryPoint(InitRoutine,
01668                                                         NULL,
01669                                                         LdrDataTableEntry-&gt;DllBase,
01670                                                         DLL_THREAD_DETACH,
01671                                                         NULL
01672                                                         ) ==  STATUS_IMAGE_MACHINE_TYPE_MISMATCH)
01673 <span class="preprocessor">#endif</span>
01674 <span class="preprocessor"></span>                               {
01675                                 <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>(InitRoutine,
01676                                                     LdrDataTableEntry-&gt;DllBase,
01677                                                     DLL_THREAD_DETACH,
01678                                                     NULL);
01679                                 }
01680                             }
01681                         }
01682                     }
01683                 }
01684             }
01685 
01686         <span class="comment">//</span>
01687         <span class="comment">// If the image has tls than call its initializers</span>
01688         <span class="comment">//</span>
01689 
01690         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a> ) {
01691             <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(NtCurrentPeb()-&gt;ImageBaseAddress,DLL_THREAD_DETACH);
01692             }
01693         <a class="code" href="../../d9/d2/ldrp_8h.html#a80">LdrpFreeTls</a>();
01694 
01695     } finally {
01696 
01697         RtlLeaveCriticalSection(&amp;LoaderLock);
01698     }
01699 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="ldrinit.c::NtdllOkayToLockRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN NtdllOkayToLockRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00236">236</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
<pre class="fragment"><div>00239 {
00240     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00241 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="ldrinit.c::NtdllpAllocateStringRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID NtdllpAllocateStringRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">SIZE_T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NumberOfBytes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00121">121</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.
<p>
<pre class="fragment"><div>00124 {
00125     <span class="keywordflow">return</span> <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0, NumberOfBytes);
00126 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="ldrinit.c::NtdllpFreeStringRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID NtdllpFreeStringRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Buffer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00129">129</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, and <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.
<p>
<pre class="fragment"><div>00132 {
00133     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, Buffer);
00134 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="ldrinit.c::RtlpInitDeferedCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpInitDeferedCriticalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">211</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00051">DeferedCriticalSection</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00371">RtlCriticalSectionList</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00372">RtlCriticalSectionLock</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00121">RtlpChainDebugInfo()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01412">RtlpCreateCriticalSectionSem()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00118">RtlpCritSectInitialized</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00117">RtlpDebugInfoFreeList</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00116">RtlpStaticDebugInfo</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00212 {
00213 
00214     InitializeListHead( &amp;RtlCriticalSectionList );
00215 
00216     <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>( RTL_CRITICAL_SECTION_DEBUG ) != <span class="keyword">sizeof</span>( RTL_RESOURCE_DEBUG )) {
00217         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTDLL: Critical Section &amp; Resource Debug Info length mismatch.\n"</span> );
00218         <span class="keywordflow">return</span>;
00219         }
00220 
00221     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a12">RtlpChainDebugInfo</a>( RtlpStaticDebugInfo,
00222                                                 <span class="keyword">sizeof</span>( RtlpStaticDebugInfo )
00223                                               );
00224 
00225     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>( &amp;RtlCriticalSectionLock, 1000 );
00226     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>( &amp;DeferedCriticalSection, 1000 );
00227 
00228     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a15">RtlpCreateCriticalSectionSem</a>(&amp;DeferedCriticalSection);
00229 
00230     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00231     <span class="keywordflow">return</span>;
00232 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="ldrinit.c::LdrpImageHasTls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a21">LdrpImageHasTls</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00032">32</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01602">LdrShutdownThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ldrinit.c::LdrpInLdrInit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a37">LdrpInLdrInit</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">35</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00474">LdrDisableThreadCalloutsForDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">LdrGetDllHandle()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02150">LdrpCreateDllSection()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01210">LdrQueryProcessModuleInformation()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ldrinit.c::LdrpLdrDatabaseIsSetup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a38">LdrpLdrDatabaseIsSetup</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00034">34</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ldrinit.c::LdrpShutdownInProgress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d7/d8/dll_2resource_8c.html#a4">LdrpShutdownInProgress</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00031">31</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00474">LdrDisableThreadCalloutsForDll()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01788">RtlCheckForOrphanedCriticalSections()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01717">RtlpNotOwnerCriticalSection()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ldrinit.c::LdrpVerifyDlls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a39">LdrpVerifyDlls</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00033">33</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ldrinit.c::LoaderLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> RTL_CRITICAL_SECTION <a class="el" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    &amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a11">LoaderLockDebug</a>,
    -1
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">142</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00474">LdrDisableThreadCalloutsForDll()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01989">LdrFlushAlternateResourceModules()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">LdrGetDllHandle()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01563">LdrLoadAlternateResourceModule()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01210">LdrQueryProcessModuleInformation()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01602">LdrShutdownThread()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01882">LdrUnloadAlternateResourceModule()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l02869">RtlAddFunctionTable()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l02971">RtlDeleteFunctionTable()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l03022">RtlLookupDynamicFunctionEntry()</a>, and <a class="el" href="../../d7/d3/pctohdr_8c-source.html#l00042">RtlPcToFileHeader()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ldrinit.c::LoaderLockDebug" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> RTL_CRITICAL_SECTION_DEBUG <a class="el" href="../../d8/d2/ldrinit_8c.html#a11">LoaderLockDebug</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00141">141</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ldrinit.c::LoaderLockInitialized" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d8/d2/ldrinit_8c.html#a13">LoaderLockInitialized</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00146">146</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ldrinit.c::NtDllBase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d6/d4/pctohdr_8c.html#a0">NtDllBase</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00045">45</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d7/d3/pctohdr_8c-source.html#l00042">RtlPcToFileHeader()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ldrinit.c::RtlAllocateStringRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_ALLOCATE_STRING_ROUTINE <a class="el" href="../../d2/d2/ex_2pool_8c.html#a49">RtlAllocateStringRoutine</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00136">136</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01935">RtlCreateUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01108">RtlDowncaseUnicodeString()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01453">RtlFormatCurrentUserKeyPath()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00716">RtlOemStringToCountedUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00439">RtlOemStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00816">RtlUnicodeStringToCountedOemString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00528">RtlUnicodeStringToOemString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00350">RtlUpcaseUnicodeStringToAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00927">RtlUpcaseUnicodeStringToCountedOemString()</a>, and <a class="el" href="../../d7/d5/nls_8c-source.html#l00617">RtlUpcaseUnicodeStringToOemString()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ldrinit.c::RtlFreeStringRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_FREE_STRING_ROUTINE <a class="el" href="../../d2/d2/ex_2pool_8c.html#a50">RtlFreeStringRoutine</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00137">137</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01249">RtlFreeAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01283">RtlFreeOemString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00716">RtlOemStringToCountedUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00439">RtlOemStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00816">RtlUnicodeStringToCountedOemString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00528">RtlUnicodeStringToOemString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00350">RtlUpcaseUnicodeStringToAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00927">RtlUpcaseUnicodeStringToCountedOemString()</a>, and <a class="el" href="../../d7/d5/nls_8c-source.html#l00617">RtlUpcaseUnicodeStringToOemString()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ldrinit.c::RtlpDisableHeapLookaside" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d1/d9/rtl_2heap_8c.html#a2">RtlpDisableHeapLookaside</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00047">47</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, and <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ldrinit.c::TlsBitMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> RTL_BITMAP <a class="el" href="../../d8/d2/ldrinit_8c.html#a9">TlsBitMap</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00138">138</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ldrinit.c::TlsExpansionBitMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> RTL_BITMAP <a class="el" href="../../d8/d2/ldrinit_8c.html#a10">TlsExpansionBitMap</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00139">139</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:31 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
