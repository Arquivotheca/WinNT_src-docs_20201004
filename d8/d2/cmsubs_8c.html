<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmsubs.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmsubs.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d9/d1/cmsubs_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a9">CmpRemoveKeyHash</a> (IN <a class="el" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> KeyHash)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a10">CmpInsertKeyHash</a> (IN <a class="el" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> KeyHash, IN BOOLEAN FakeKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a11">CmpDereferenceNameControlBlockWithLock</a> (<a class="el" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a> Ncb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock, <a class="el" href="../../d9/d0/cmdata_8h.html#a67">SUBKEY_SEARCH_TYPE</a> SearchType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a14">CmpGetNameControlBlock</a> (PUNICODE_STRING NodeName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PUNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb, BOOLEAN FakeKey, PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a21">CmpSearchKeyControlBlockTree</a> (<a class="el" href="../../d1/d2/cmp_8h.html#a184">PKCB_WORKER_ROUTINE</a> WorkerRoutine, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a107">Context1</a>, PVOID <a class="el" href="../../d3/d1/threads_8h.html#a108">Context2</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a> (<a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a25">CmpFreeKeyBody</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a26">CmpInitializeCache</a> ()</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a0">CmpKcbLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a1">CmpPostLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a2">CmpCacheTable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a3">CmpHashTableSize</a> = 2048</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a> = 512</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG_PTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a17" doxytag="cmsubs.c::CmpCleanUpKcbCacheWithLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCleanUpKcbCacheWithLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">629</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00525">ASSERT_KEYBODY_LIST_EMPTY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00255">CM_KCB_SUBKEY_HINT</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00503">CmpDereferenceNameControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00283">_CM_KEY_CONTROL_BLOCK::ExtFlags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00290">_CM_KEY_CONTROL_BLOCK::IndexHint</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00286">_CM_KEY_CONTROL_BLOCK::NameBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00068">SET_KCB_SIGNATURE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.
<p>
<pre class="fragment"><div>00634                    :
00635 
00636     Clean up all cached allocations that are associated to <span class="keyword">this</span> key.
00637     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still open just because of <span class="keyword">this</span> one, Remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent as well.
00638 
00639 Arguments:
00640 
00641     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00642 
00643 Return Value:
00644 
00645     NONE.
00646 
00647 --*/
00648 {
00649     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   Kcb;
00650     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   ParentKcb;
00651 
00652     Kcb = KeyControlBlock;
00653 
00654     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeyControlBlock-&gt;RefCount == 0);
00655 
00656     <span class="keywordflow">while</span> (Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
00657         <span class="comment">//</span>
00658         <span class="comment">// First, free allocations for Value/data.</span>
00659         <span class="comment">//</span>
00660     
00661         <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(Kcb);
00662     
00663         <span class="comment">//</span>
00664         <span class="comment">// Free the kcb and dereference parentkcb and nameblock.</span>
00665         <span class="comment">//</span>
00666     
00667         <a class="code" href="../../d8/d2/cmsubs_8c.html#a11">CmpDereferenceNameControlBlockWithLock</a>(Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>);
00668     
00669         <span class="keywordflow">if</span> (Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>) {
00670             <span class="comment">//</span>
00671             <span class="comment">// Now free the HintIndex allocation</span>
00672             <span class="comment">//</span>
00673             <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o13">IndexHint</a>, CM_CACHE_INDEX_TAG | PROTECTED_POOL);
00674         }
00675 
00676         <span class="comment">//</span>
00677         <span class="comment">// Save the ParentKcb before we free the Kcb</span>
00678         <span class="comment">//</span>
00679         ParentKcb = Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00680         
00681         <span class="comment">//</span>
00682         <span class="comment">// We cannot call CmpDereferenceKeyControlBlockWithLock so we can avoid recurrsion.</span>
00683         <span class="comment">//</span>
00684         
00685         <span class="keywordflow">if</span> (!Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>) {
00686             <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(Kcb);
00687         }
00688         <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(Kcb, '4FmC');
00689         <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(Kcb);
00690         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Kcb, CM_KCB_TAG | PROTECTED_POOL);
00691 
00692         Kcb = ParentKcb;
00693         Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a>--;
00694     }
00695 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="cmsubs.c::CmpCleanUpKcbValueCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCleanUpKcbValueCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">568</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00258">CM_KCB_NO_DELAY_CLOSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00256">CM_KCB_SYM_LINK_FOUND</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00609">CMP_GET_CACHED_ADDRESS</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00610">CMP_GET_CACHED_CELLDATA</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00608">CMP_IS_CELL_CACHED</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00143">CmpMakeSpecialPoolReadWrite</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00234">_CACHED_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00283">_CM_KEY_CONTROL_BLOCK::ExtFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00237">_CACHED_CHILD_LIST::RealKcb</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00288">_CM_KEY_CONTROL_BLOCK::ValueCache</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00236">_CACHED_CHILD_LIST::ValueList</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01087">CmSetValueKey()</a>.
<p>
<pre class="fragment"><div>00573                    :
00574 
00575     Clean up cached value/data that are associated to <span class="keyword">this</span> key.
00576 
00577 Arguments:
00578 
00579     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00580 
00581 Return Value:
00582 
00583     NONE.
00584 
00585 --*/
00586 {
00587     ULONG i;
00588     PULONG_PTR CachedList;
00589     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pcell;
00590     ULONG      realsize;
00591     BOOLEAN    small;
00592 
00593     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/cmdata_8h.html#a45">CMP_IS_CELL_CACHED</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>)) {
00594         CachedList = (PULONG_PTR) <a class="code" href="../../d9/d0/cmdata_8h.html#a47">CMP_GET_CACHED_CELLDATA</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>);
00595         <span class="keywordflow">for</span> (i = 0; i &lt; KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o0">Count</a>; i++) {
00596             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/cmdata_8h.html#a45">CMP_IS_CELL_CACHED</a>(CachedList[i])) {
00597 
00598                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00599                 <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(CachedList[i]) );
00600 
00601                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID) <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(CachedList[i]));
00602                
00603             }
00604         }
00605 
00606         <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00607         <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>) );
00608 
00609         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID) <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>));
00610 
00611         <span class="comment">// Mark the ValueList as NULL </span>
00612         KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00613 
00614     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
00615         <span class="comment">//</span>
00616         <span class="comment">// This is a symbolic link key with symbolic name resolved.</span>
00617         <span class="comment">// Dereference to its real kcb and clear the bit.</span>
00618         <span class="comment">//</span>
00619         <span class="keywordflow">if</span> ((KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 1) &amp;&amp; !(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>)) {
00620             KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a14">CM_KCB_NO_DELAY_CLOSE</a>;
00621         }
00622         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>);
00623         KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
00624     }
00625 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmsubs.c::CmpCleanUpSubKeyInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCleanUpSubKeyInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00537">537</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00251">CM_KCB_NO_SUBKEY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00255">CM_KCB_SUBKEY_HINT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00252">CM_KCB_SUBKEY_ONE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00283">_CM_KEY_CONTROL_BLOCK::ExtFlags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00290">_CM_KEY_CONTROL_BLOCK::IndexHint</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>00541                    :
00542 
00543     Clean up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey information cache due to create or <span class="keyword">delete</span> keys.
00544     Registry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked exclusively and no need to lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB.
00545 
00546 Arguments:
00547 
00548     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00549 
00550 Return Value:
00551 
00552     NONE.
00553 
00554 --*/
00555 {
00556     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00557 
00558     <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; (<a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>)) {
00559         <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; (<a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>)) {
00560             <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o13">IndexHint</a>, CM_CACHE_INDEX_TAG | PROTECTED_POOL);
00561         }
00562         KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp;= ~((<a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>));
00563     }
00564 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="cmsubs.c::CmpConstructName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUNICODE_STRING CmpConstructName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>kcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00699">699</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00215">_CM_NAME_CONTROL_BLOCK::Compressed</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00223">_CM_NAME_CONTROL_BLOCK::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00286">_CM_KEY_CONTROL_BLOCK::NameBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00222">_CM_NAME_CONTROL_BLOCK::NameLength</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">CmpQueryKeyName()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>.
<p>
<pre class="fragment"><div>00704                    :
00705 
00706     Construct <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name given a <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.
00707 
00708 Arguments:
00709 
00710     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> - Kcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key
00711 
00712 Return Value:
00713 
00714     Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode string constructed.  
00715     Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible to free <span class="keyword">this</span> storage space.
00716 
00717 --*/
00718 {
00719     PUNICODE_STRING FullName;
00720     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> TmpKcb;
00721     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
00722     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> size;
00723     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i;
00724     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> BeginPosition;
00725     WCHAR *w1, *w2;
00726     UCHAR *u2;
00727 
00728     <span class="comment">//</span>
00729     <span class="comment">// Calculate the total string length.</span>
00730     <span class="comment">//</span>
00731     Length = 0;
00732     TmpKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00733     <span class="keywordflow">while</span> (TmpKcb) {
00734         <span class="keywordflow">if</span> (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
00735             Length += TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> * <span class="keyword">sizeof</span>(WCHAR);
00736         } <span class="keywordflow">else</span> {
00737             Length += TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; 
00738         }
00739         <span class="comment">//</span>
00740         <span class="comment">// Add the sapce for OBJ_NAME_PATH_SEPARATOR;</span>
00741         <span class="comment">//</span>
00742         Length += <span class="keyword">sizeof</span>(WCHAR);
00743 
00744         TmpKcb = TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00745     }
00746 
00747     <span class="comment">//</span>
00748     <span class="comment">// Allocate the pool for the unicode string</span>
00749     <span class="comment">//</span>
00750     size = <span class="keyword">sizeof</span>(UNICODE_STRING) + Length;
00751 
00752     FullName = (PUNICODE_STRING) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
00753                                                        size,
00754                                                        CM_NAME_TAG | PROTECTED_POOL);
00755 
00756     <span class="keywordflow">if</span> (FullName) {
00757         FullName-&gt;Buffer = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *) ((ULONG_PTR) FullName + <span class="keyword">sizeof</span>(UNICODE_STRING));
00758         FullName-&gt;Length = Length;
00759         FullName-&gt;MaximumLength = Length;
00760 
00761         <span class="comment">//</span>
00762         <span class="comment">// Now fill the name into the buffer.</span>
00763         <span class="comment">//</span>
00764         TmpKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00765         BeginPosition = Length;
00766 
00767         <span class="keywordflow">while</span> (TmpKcb) {
00768             <span class="comment">//</span>
00769             <span class="comment">// Calculate the begin position of each subkey. Then fill in the char.</span>
00770             <span class="comment">//</span>
00771             <span class="comment">//</span>
00772             <span class="keywordflow">if</span> (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
00773                 BeginPosition -= (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> + 1) * <span class="keyword">sizeof</span>(WCHAR);
00774                 w1 = &amp;(FullName-&gt;Buffer[BeginPosition/<span class="keyword">sizeof</span>(WCHAR)]);
00775                 *w1 = OBJ_NAME_PATH_SEPARATOR;
00776                 w1++;
00777 
00778                 u2 = (UCHAR *) &amp;(TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>[0]);
00779 
00780                 <span class="keywordflow">for</span> (i=0; i&lt;TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; i++) {
00781                     *w1 = (WCHAR)(*u2);
00782                     w1++;
00783                     u2++;
00784                 }
00785             } <span class="keywordflow">else</span> {
00786                 BeginPosition -= (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> + <span class="keyword">sizeof</span>(WCHAR));
00787                 w1 = &amp;(FullName-&gt;Buffer[BeginPosition/<span class="keyword">sizeof</span>(WCHAR)]);
00788                 *w1 = OBJ_NAME_PATH_SEPARATOR;
00789                 w1++;
00790 
00791                 w2 = TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>;
00792 
00793                 <span class="keywordflow">for</span> (i=0; i&lt;TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; i=i+<span class="keyword">sizeof</span>(WCHAR)) {
00794                     *w1 = *w2;
00795                     w1++;
00796                     w2++;
00797                 }
00798             }
00799             TmpKcb = TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00800         }
00801     }
00802     <span class="keywordflow">return</span> (FullName);
00803 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="cmsubs.c::CmpCreateKeyControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> CmpCreateKeyControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FakeKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">824</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00069">ASSERT_KCB</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00525">ASSERT_KEYBODY_LIST_EMPTY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00257">CM_KCB_KEY_NON_EXIST</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00368">CmpGetNameControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01350">CmpInsertKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">CmpReferenceKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00277">_CM_KEY_CONTROL_BLOCK::ConvKey</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00524">INIT_KCB_KEYBODY_LIST</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00068">SET_KCB_SIGNATURE</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00294">_CM_KEY_CONTROL_BLOCK::TotalLevels</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>00834                    :
00835 
00836     Allocate and initialize a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block, insert <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into
00837     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> tree.
00838 
00839     Full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> will be <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> + <span class="charliteral">'\'</span> + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, unless <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>
00840     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, in which <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.
00841 
00842     <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> of returned KCB WILL have been incremented to reflect
00843     callers ref.
00844 
00845 Arguments:
00846 
00847     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> that holds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key we are creating a KCB <span class="keywordflow">for</span>.
00848 
00849     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key we are creating a KCB <span class="keywordflow">for</span>.
00850 
00851     Node - Supplies pointer to key node.
00852 
00853     ParentKcb - Parent <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> to be created
00854 
00855     FakeKey - Whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> to be create <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a fake one or not
00856 
00857     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey name to of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB to be created.
00858  
00859     NOTE:  We need <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter instead of just <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KEY_NODE 
00860            because there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell of a hive.
00861 
00862 Return Value:
00863 
00864     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a1">failure</a> (insufficient memory)
00865     <span class="keywordflow">else</span> a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.
00866 
00867 --*/
00868 {
00869     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00870     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   kcbmatch=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00871     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00872     ULONG namelength;
00873     PUNICODE_STRING         fullname;
00874     ULONG       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00875     ULONG i;
00876 
00877     UNICODE_STRING         NodeName;
00878     ULONG ConvKey=0;
00879     ULONG Cnt;
00880     WCHAR *Cp;
00881 
00882     <span class="comment">//</span>
00883     <span class="comment">// ParentKCb has the base hash value.</span>
00884     <span class="comment">//</span>
00885     <span class="keywordflow">if</span> (ParentKcb) {
00886         ConvKey = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o3">ConvKey</a>;
00887     }
00888 
00889     NodeName = *<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00890 
00891     <span class="keywordflow">while</span> ((NodeName.Length &gt; 0) &amp;&amp; (NodeName.Buffer[0] == OBJ_NAME_PATH_SEPARATOR)) {
00892         <span class="comment">//</span>
00893         <span class="comment">// This must be the \REGISTRY.</span>
00894         <span class="comment">// Strip off the leading OBJ_NAME_PATH_SEPARATOR</span>
00895         <span class="comment">//</span>
00896         NodeName.Buffer++;
00897         NodeName.Length -= <span class="keyword">sizeof</span>(WCHAR);
00898     }
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Manually compute the hash to use.</span>
00902     <span class="comment">//</span>
00903     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NodeName.Length &gt; 0);
00904 
00905     <span class="keywordflow">if</span> (NodeName.Length) {
00906         Cp = NodeName.Buffer;
00907         <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;NodeName.Length; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
00908             <span class="keywordflow">if</span> ((*Cp != OBJ_NAME_PATH_SEPARATOR) &amp;&amp;
00909                 (*Cp != UNICODE_NULL)) {
00910                 ConvKey = 37 * ConvKey + (ULONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
00911             }
00912             ++Cp;
00913         }
00914     }
00915 
00916     <span class="comment">//</span>
00917     <span class="comment">// Create a new kcb, which we will free if one already exists</span>
00918     <span class="comment">// for this key.</span>
00919     <span class="comment">// Now it is a fixed size structure.</span>
00920     <span class="comment">//</span>
00921     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
00922                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>),
00923                                 CM_KCB_TAG | PROTECTED_POOL);
00924 
00925 
00926     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00927         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00928     } <span class="keywordflow">else</span> {
00929         <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(kcb, KCB_SIGNATURE);
00930         <a class="code" href="../../d1/d2/cmp_8h.html#a79">INIT_KCB_KEYBODY_LIST</a>(kcb);
00931         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00932         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount = 1;
00933         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00934         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00935         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode = Node;
00936         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ConvKey = ConvKey;
00937 
00938     }
00939 
00940     <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(kcb);
00941     <span class="comment">//</span>
00942     <span class="comment">// Find location to insert kcb in kcb tree.</span>
00943     <span class="comment">//</span>
00944 
00945 
00946     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">// Add the KCB to the hash table</span>
00950     <span class="comment">//</span>
00951     kcbmatch = <a class="code" href="../../d8/d2/cmsubs_8c.html#a10">CmpInsertKeyHash</a>(&amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHash, FakeKey);
00952     <span class="keywordflow">if</span> (kcbmatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00953         <span class="comment">//</span>
00954         <span class="comment">// A match was found.</span>
00955         <span class="comment">//</span>
00956         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!kcbmatch-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>);
00957         <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(kcb, '1FmC');
00958         <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(kcb);
00959         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(kcb, CM_KCB_TAG | PROTECTED_POOL);
00960         <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(kcbmatch);
00961         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = kcbmatch;
00962         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount == 0) {
00963             <span class="comment">//</span>
00964             <span class="comment">// This kcb is on the delayed close list. Remove it from that</span>
00965             <span class="comment">// list.</span>
00966             <span class="comment">//</span>
00967             <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(kcb);
00968         }
00969         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount + 1) == 0) {
00970             <span class="comment">//</span>
00971             <span class="comment">// We have maxed out the ref count on this key. Probably</span>
00972             <span class="comment">// some bogus app has opened the same key 64K times without</span>
00973             <span class="comment">// ever closing it. Just fail the open, they've got enough</span>
00974             <span class="comment">// handles already.</span>
00975             <span class="comment">//</span>
00976             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount + 1 != 0);
00977             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00978         } <span class="keywordflow">else</span> {
00979             ++<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount;
00980         }
00981     }
00982     <span class="keywordflow">else</span> {
00983         <span class="comment">//</span>
00984         <span class="comment">// No kcb created previously, fill in all the data.</span>
00985         <span class="comment">//</span>
00986 
00987         <span class="comment">//</span>
00988         <span class="comment">// Now try to reference the parentkcb</span>
00989         <span class="comment">//</span>
00990         
00991         <span class="keywordflow">if</span> (ParentKcb) {
00992             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(ParentKcb)) {
00993                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb = ParentKcb;
00994                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> + 1;
00995             } <span class="keywordflow">else</span> {
00996                 <span class="comment">//</span>
00997                 <span class="comment">// We have maxed out the ref count on the parent.</span>
00998                 <span class="comment">// Since it has been cached in the cachetable,</span>
00999                 <span class="comment">// remove it first before we free the allocation.</span>
01000                 <span class="comment">//</span>
01001                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
01002                 <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(kcb, '2FmC');
01003                 <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(kcb);
01004                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(kcb, CM_KCB_TAG | PROTECTED_POOL);
01005                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01006             }
01007         } <span class="keywordflow">else</span> {
01008             <span class="comment">//</span>
01009             <span class="comment">// It is the \REGISTRY node.</span>
01010             <span class="comment">//</span>
01011             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01012             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels = 1;
01013         }
01014 
01015         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>) {
01016             <span class="comment">//</span>
01017             <span class="comment">// Now try to find the Name Control block that has the name for this node.</span>
01018             <span class="comment">//</span>
01019     
01020             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameBlock = <a class="code" href="../../d8/d2/cmsubs_8c.html#a14">CmpGetNameControlBlock</a> (&amp;NodeName);
01021 
01022             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameBlock) {
01023                 <span class="comment">//</span>
01024                 <span class="comment">// Now fill in all the data needed for the cache.</span>
01025                 <span class="comment">//</span>
01026                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ValueCache.Count = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01027                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ValueCache.ValueList = (ULONG_PTR) Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>;
01028         
01029                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Flags = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
01030                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags = 0;
01031                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;DelayedCloseIndex = 0;
01032         
01033                 <span class="comment">//</span>
01034                 <span class="comment">// Cache the security cells in the kcb</span>
01035                 <span class="comment">//</span>
01036                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Security = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
01037         
01038                 <span class="keywordflow">if</span> (FakeKey) {
01039                     <span class="comment">//</span>
01040                     <span class="comment">// The KCb to be created is a fake one</span>
01041                     <span class="comment">//</span>
01042                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>;
01043                 }
01044             } <span class="keywordflow">else</span> {
01045                 <span class="comment">//</span>
01046                 <span class="comment">// We have maxed out the ref count on the Name.</span>
01047                 <span class="comment">//</span>
01048                 
01049                 <span class="comment">//</span>
01050                 <span class="comment">// First dereference the parent KCB.</span>
01051                 <span class="comment">//</span>
01052                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(ParentKcb);
01053 
01054                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
01055                 <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(kcb, '3FmC');
01056                 <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(kcb);
01057                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(kcb, CM_KCB_TAG | PROTECTED_POOL);
01058                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01059             }
01060         }
01061     }
01062 
01063 
01064     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01065     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01066 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="cmsubs.c::CmpDereferenceKeyControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDereferenceKeyControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">1153</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>01158                    :
01159 
01160     Decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count on a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block, and frees <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
01161     becomes zero.
01162 
01163     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that no notify <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> blocks remain <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count
01164     becomes zero.
01165 
01166 Arguments:
01167 
01168     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
01169 
01170 Return Value:
01171 
01172     NONE.
01173 
01174 --*/
01175 {
01176     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01177     <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock) ;
01178     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01179     <span class="keywordflow">return</span>;
01180 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="cmsubs.c::CmpDereferenceKeyControlBlockWithLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDereferenceKeyControlBlockWithLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">1184</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00069">ASSERT_KCB</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00258">CM_KCB_NO_DELAY_CLOSE</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00033">CmpDelayedCloseCurrent</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00031">CmpDelayedCloseSize</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00032">CmpDelayedCloseTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00034">CmpDelayedFreeIndex</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00293">_CM_KEY_CONTROL_BLOCK::DelayedCloseIndex</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00283">_CM_KEY_CONTROL_BLOCK::ExtFlags</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">CmpDereferenceKeyControlBlock()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>.
<p>
<pre class="fragment"><div>01187 {
01188     ULONG_PTR FreeIndex;
01189     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KcbToFree;
01190 
01191 
01192 
01193     <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(KeyControlBlock);
01194 
01195     <span class="keywordflow">if</span> (--KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
01196         <span class="comment">//</span>
01197         <span class="comment">// Remove kcb from the tree</span>
01198         <span class="comment">//</span>
01199         <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a14">CM_KCB_NO_DELAY_CLOSE</a>) {
01200             <span class="comment">//</span>
01201             <span class="comment">// Free storage directly so we can clean up junk quickly.</span>
01202             <span class="comment">//</span>
01203             <span class="comment">//</span>
01204             <span class="comment">// Need to free all cached Index List, Index Leaf, Value, etc.</span>
01205             <span class="comment">//</span>
01206             <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(KeyControlBlock);
01207         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>) {
01208 
01209             <span class="comment">//</span>
01210             <span class="comment">// Put this kcb on our delayed close list.</span>
01211             <span class="comment">//</span>
01212             <span class="comment">// First check the free list for a free slot.</span>
01213             <span class="comment">//</span>
01214             FreeIndex = <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a>;
01215             <span class="keywordflow">if</span> (FreeIndex != -1) {
01216                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FreeIndex &lt; CmpDelayedCloseSize);
01217                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = (ULONG_PTR)<a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[FreeIndex];
01218                 KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o15">DelayedCloseIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) FreeIndex;
01219                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((CmpDelayedFreeIndex == -1) ||
01220                        (CmpDelayedFreeIndex &lt; CmpDelayedCloseSize));
01221                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[FreeIndex] = KeyControlBlock;
01222             } <span class="keywordflow">else</span> {
01223 
01224                 <span class="comment">//</span>
01225                 <span class="comment">// Nothing is free, we have to get rid of something.</span>
01226                 <span class="comment">//</span>
01227                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*CmpDelayedCloseCurrent != NULL);
01228                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(*CmpDelayedCloseCurrent)-&gt;Delete);
01229                 <span class="comment">//</span>
01230                 <span class="comment">// Need to free all cached Index List, Index Leaf, Value, etc.</span>
01231                 <span class="comment">// Change the code sequence for the recurrsive call to dereference the parent.</span>
01232                 <span class="comment">//</span>
01233                 KcbToFree = *<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a>;
01234                 *<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> = KeyControlBlock;
01235                 KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o15">DelayedCloseIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> - <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>);
01236                 ++<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a>;
01237                 <span class="keywordflow">if</span> ((ULONG)(<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> - <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>) == <a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>) {
01238                     <a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>;
01239                 }
01240 
01241                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(KcbToFree);
01242             }
01243         } <span class="keywordflow">else</span> {
01244             <span class="comment">//</span>
01245             <span class="comment">// Free storage directly as there is no point in putting this on</span>
01246             <span class="comment">// our delayed close list.</span>
01247             <span class="comment">//</span>
01248             <span class="comment">//</span>
01249             <span class="comment">// Need to free all cached Index List, Index Leaf, Value, etc.</span>
01250             <span class="comment">//</span>
01251             <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(KeyControlBlock);
01252         }
01253     }
01254 
01255     <span class="keywordflow">return</span>;
01256 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="cmsubs.c::CmpDereferenceNameControlBlockWithLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDereferenceNameControlBlockWithLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Ncb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00503">503</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00035">CmpNameCacheTable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00220">_CM_NAME_CONTROL_BLOCK::ConvKey</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00475">GET_HASH_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00218">_CM_NAME_CONTROL_BLOCK::NameHash</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00209">_CM_NAME_HASH::NextHash</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00216">_CM_NAME_CONTROL_BLOCK::RefCount</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>.
<p>
<pre class="fragment"><div>00506 {
00507     <a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a> *Prev;
00508     <a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a> Current;
00509 
00510     <span class="keywordflow">if</span> (--Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
00511 
00512         <span class="comment">//</span>
00513         <span class="comment">// Remove it from the the Hash Table</span>
00514         <span class="comment">//</span>
00515         Prev = &amp;(<a class="code" href="../../d1/d2/cmp_8h.html#a77">GET_HASH_ENTRY</a>(CmpNameCacheTable, Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o3">ConvKey</a>));
00516         
00517         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00518             Current = *Prev;
00519             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Current != NULL);
00520             <span class="keywordflow">if</span> (Current == &amp;(Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o2">NameHash</a>)) {
00521                 *Prev = Current-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a>;
00522                 <span class="keywordflow">break</span>;
00523             }
00524             Prev = &amp;Current-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a>;
00525         }
00526 
00527         <span class="comment">//</span>
00528         <span class="comment">// Free storage</span>
00529         <span class="comment">//</span>
00530         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Ncb, CM_NAME_TAG | PROTECTED_POOL);
00531     }
00532     <span class="keywordflow">return</span>;
00533 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="cmsubs.c::CmpFreeKeyBody" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreeKeyBody           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01297">1297</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00428">KEY_HIVE_EXIT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>.
<p>
<pre class="fragment"><div>01303                    :
01304 
01305     Free storage <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key entry <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.Cell refers to, including
01306     its <span class="keyword">class </span>and security data.  Will NOT free child list or value list.
01307 
01308 Arguments:
01309 
01310     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure for <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
01311 
01312     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of key to free
01313 
01314 Return Value:
01315 
01316     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
01317 
01318         &lt;TBS&gt;
01319 
01320 --*/
01321 {
01322     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> key;
01323 
01324     <span class="comment">//</span>
01325     <span class="comment">// map in the cell</span>
01326     <span class="comment">//</span>
01327     key = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
01328 
01329     <span class="keywordflow">if</span> (!(key-&gt;u.KeyNode.Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>)) {
01330         <span class="keywordflow">if</span> (key-&gt;u.KeyNode.Security != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01331             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, key-&gt;u.KeyNode.Security);
01332         }
01333 
01334         <span class="keywordflow">if</span> (key-&gt;u.KeyNode.ClassLength &gt; 0) {
01335             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, key-&gt;u.KeyNode.Class);
01336         }
01337     }
01338 
01339     <span class="comment">//</span>
01340     <span class="comment">// unmap the cell itself and free it</span>
01341     <span class="comment">//</span>
01342     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, Cell);
01343 
01344     <span class="keywordflow">return</span>;
01345 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmsubs.c::CmpGetNameControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a> CmpGetNameControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NodeName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00368">368</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d0/d1/cmname_8c-source.html#l00195">CmpCompareCompressedName()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00035">CmpNameCacheTable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00215">_CM_NAME_CONTROL_BLOCK::Compressed</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00220">_CM_NAME_CONTROL_BLOCK::ConvKey</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00208">_CM_NAME_HASH::ConvKey</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00474">GET_HASH_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00223">_CM_NAME_CONTROL_BLOCK::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00218">_CM_NAME_CONTROL_BLOCK::NameHash</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00222">_CM_NAME_CONTROL_BLOCK::NameLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00209">_CM_NAME_HASH::NextHash</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00216">_CM_NAME_CONTROL_BLOCK::RefCount</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>.
<p>
<pre class="fragment"><div>00371 {
00372     <a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a>   Ncb;
00373     ULONG  Cnt;
00374     WCHAR *Cp;
00375     WCHAR *Cp2;
00376     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00377     ULONG i;
00378     ULONG      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00379     <a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a> CurrentName;
00380     ULONG rc;
00381     BOOLEAN NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NameSize;
00383     BOOLEAN NameCompressed;
00384     ULONG NameConvKey=0;
00385     LONG Result;
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Calculate the ConvKey for this NadeName;</span>
00389     <span class="comment">//</span>
00390 
00391     Cp = NodeName-&gt;Buffer;
00392     <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;NodeName-&gt;Length; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
00393         <span class="keywordflow">if</span> (*Cp != OBJ_NAME_PATH_SEPARATOR) {
00394             NameConvKey = 37 * NameConvKey + (ULONG) <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
00395         }
00396         ++Cp;
00397     }
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// Find the Name Size;</span>
00401     <span class="comment">// </span>
00402     NameCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00403     NameSize = NodeName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00404     <span class="keywordflow">for</span> (i=0;i&lt;NodeName-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);i++) {
00405         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NodeName-&gt;Buffer[i] &gt; (UCHAR)-1) {
00406             NameSize = NodeName-&gt;Length;
00407             NameCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00408         }
00409     }
00410 
00411     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a76">GET_HASH_INDEX</a>(NameConvKey);
00412     CurrentName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00413 
00414     <span class="keywordflow">while</span> (CurrentName) {
00415         Ncb =  CONTAINING_RECORD(CurrentName, <a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">CM_NAME_CONTROL_BLOCK</a>, NameHash);
00416 
00417         <span class="keywordflow">if</span> ((NameConvKey == CurrentName-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o0">ConvKey</a>) &amp;&amp;
00418             (NameSize == Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>)) {
00419             <span class="comment">//</span>
00420             <span class="comment">// Hash value matches, compare the names.</span>
00421             <span class="comment">//</span>
00422             NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00423             <span class="keywordflow">if</span> (Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
00424                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a>(NodeName, Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>, NameSize)) {
00425                     NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00426                 }
00427             } <span class="keywordflow">else</span> {
00428                 Cp = (WCHAR *) NodeName-&gt;Buffer;
00429                 Cp2 = (WCHAR *) Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>;
00430                 <span class="keywordflow">for</span> (i=0 ;i&lt;Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; i+= <span class="keyword">sizeof</span>(WCHAR)) {
00431                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp) != <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp2)) {
00432                         NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00433                         <span class="keywordflow">break</span>;
00434                     }
00435                     ++Cp;
00436                     ++Cp2;
00437                 }
00438             }
00439             <span class="keywordflow">if</span> (NameFound) {
00440                 <span class="comment">//</span>
00441                 <span class="comment">// Found it, increase the refcount.</span>
00442                 <span class="comment">//</span>
00443                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a> + 1) == 0) {
00444                     <span class="comment">//</span>
00445                     <span class="comment">// We have maxed out the ref count.</span>
00446                     <span class="comment">// fail the call.</span>
00447                     <span class="comment">//</span>
00448                     Ncb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00449                 } <span class="keywordflow">else</span> {
00450                     ++Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a>;
00451                 }
00452                 <span class="keywordflow">break</span>;
00453             }
00454         }
00455         CurrentName = CurrentName-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a>;
00456     }
00457     
00458     <span class="keywordflow">if</span> (NameFound == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00459         <span class="comment">//</span>
00460         <span class="comment">// Now need to create one Name block for this string.</span>
00461         <span class="comment">//</span>
00462         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = FIELD_OFFSET(<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">CM_NAME_CONTROL_BLOCK</a>, Name) + NameSize;
00463  
00464         Ncb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
00465                                     Size,
00466                                     CM_NAME_TAG | PROTECTED_POOL);
00467  
00468         <span class="keywordflow">if</span> (Ncb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00469             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00470         }
00471         RtlZeroMemory(Ncb, Size);
00472  
00473         <span class="comment">//</span>
00474         <span class="comment">// Update all the info for this newly created Name block.</span>
00475         <span class="comment">//</span>
00476         <span class="keywordflow">if</span> (NameCompressed) {
00477             Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00478             <span class="keywordflow">for</span> (i=0;i&lt;NameSize;i++) {
00479                 ((PUCHAR)Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>)[i] = (UCHAR)(NodeName-&gt;Buffer[i]);
00480             }
00481         } <span class="keywordflow">else</span> {
00482             Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00483             RtlCopyMemory((PVOID)(Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>), (PVOID)(NodeName-&gt;Buffer), NameSize);
00484         }
00485 
00486         Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o3">ConvKey</a> = NameConvKey;
00487         Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a> = 1;
00488         Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> = NameSize;
00489         
00490         CurrentName = &amp;(Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o2">NameHash</a>);
00491         <span class="comment">//</span>
00492         <span class="comment">// Insert into Name Hash table.</span>
00493         <span class="comment">//</span>
00494         CurrentName-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00495         <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = CurrentName;
00496     }
00497 
00498     <span class="keywordflow">return</span>(Ncb);
00499 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="cmsubs.c::CmpInitializeCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpInitializeCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">1512</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l01982">CmpCacheTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00033">CmpDelayedCloseCurrent</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00031">CmpDelayedCloseSize</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00032">CmpDelayedCloseTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00034">CmpDelayedFreeIndex</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01981">CmpHashTableSize</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00035">CmpNameCacheTable</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d9/d0/cmdata_8h.html#a64">PCM_KEY_CONTROL_BLOCK</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>01513 {
01514     ULONG TotalCmCacheSize;
01515     ULONG i;
01516 
01517     TotalCmCacheSize = <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a>);
01518 
01519     <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
01520                                           TotalCmCacheSize,
01521                                           'aCMC');
01522     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01523         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,6,1,0,0);
01524         <span class="keywordflow">return</span>;
01525     }
01526     RtlZeroMemory(CmpCacheTable, TotalCmCacheSize);
01527 
01528     TotalCmCacheSize = <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a>);
01529     <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
01530                                               TotalCmCacheSize,
01531                                               'aCMC');
01532     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01533         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,6,1,0,0);
01534         <span class="keywordflow">return</span>;
01535     }
01536     RtlZeroMemory(CmpNameCacheTable, TotalCmCacheSize);
01537 
01538     <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
01539                                                  CmpDelayedCloseSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>),
01540                                                  'cDMC');
01541     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01542         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,6,2,0,0);
01543         <span class="keywordflow">return</span>;
01544     }
01545     <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = 0;
01546     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>-1; i++) {
01547         <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[i] = (<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>)ULongToPtr(i+1);
01548     }
01549     <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[<a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>-1] = (<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>)-1;
01550     <a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>;
01551 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmsubs.c::CmpInsertKeyHash" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> CmpInsertKeyHash           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHash</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FakeKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01350">1350</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00070">ASSERT_KEY_HASH</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00257">CM_KCB_KEY_NON_EXIST</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01982">CmpCacheTable</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01981">CmpHashTableSize</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00055">_CM_KEY_HASH::ConvKey</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00474">GET_HASH_INDEX</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00052">HASH_VALUE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00058">_CM_KEY_HASH::KeyCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00057">_CM_KEY_HASH::KeyHive</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00056">_CM_KEY_HASH::NextHash</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>.
<p>
<pre class="fragment"><div>01356                    :
01357 
01358     Adds a key hash structure to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash table. The hash table
01359     will be checked to see <span class="keywordflow">if</span> a duplicate entry already exists. If
01360     a duplicate <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found, its <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> will be returned. If a duplicate <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
01361     found, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> will be returned.
01362 
01363 Arguments:
01364 
01365     KeyHash - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key hash structure to be added.
01366 
01367 Return Value:
01368 
01369     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied key has was added
01370     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> - The duplicate hash entry, <span class="keywordflow">if</span> one was found
01371 
01372 --*/
01373 
01374 {
01375     <a class="code" href="../../d9/d0/cmdata_8h.html#a52">HASH_VALUE</a> Hash;
01376     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01377     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> Current;
01378 
01379     <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(KeyHash);
01380     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a76">GET_HASH_INDEX</a>(KeyHash-&gt;ConvKey);
01381 
01382     <span class="comment">//</span>
01383     <span class="comment">// If this is a fake key, we will use the cell and hive from its </span>
01384     <span class="comment">// parent for uniqeness.  To deal with the case when the fake</span>
01385     <span class="comment">// has the same ConvKey as its parent (in which case we cannot distingish </span>
01386     <span class="comment">// between the two), we set the lowest bit of the fake key's cell.</span>
01387     <span class="comment">//</span>
01388     <span class="comment">// It's possible (unlikely) that we cannot distingish two fake keys </span>
01389     <span class="comment">// (when their Convkey's are the same) under the same key.  It is not breaking</span>
01390     <span class="comment">// anything, we just cannot find the other one in cache lookup.</span>
01391     <span class="comment">//</span>
01392     <span class="comment">//</span>
01393     <span class="keywordflow">if</span> (FakeKey) {
01394         KeyHash-&gt;KeyCell++;
01395     }
01396 
01397     <span class="comment">//</span>
01398     <span class="comment">// First look for duplicates.</span>
01399     <span class="comment">//</span>
01400     Current = <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01401     <span class="keywordflow">while</span> (Current) {
01402         <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(Current);
01403         <span class="comment">//</span>
01404         <span class="comment">// We must check ConvKey since we can create a fake kcb</span>
01405         <span class="comment">// for keys that does not exist.</span>
01406         <span class="comment">// We will use the Hive and Cell from the parent.</span>
01407         <span class="comment">//</span>
01408 
01409         <span class="keywordflow">if</span> ((KeyHash-&gt;ConvKey == Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o0">ConvKey</a>) &amp;&amp;
01410             (KeyHash-&gt;KeyCell == Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o3">KeyCell</a>) &amp;&amp;
01411             (KeyHash-&gt;KeyHive == Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o2">KeyHive</a>)) {
01412             <span class="comment">//</span>
01413             <span class="comment">// Found a match</span>
01414             <span class="comment">//</span>
01415             <span class="keywordflow">return</span>(CONTAINING_RECORD(Current,
01416                                      <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>,
01417                                      KeyHash));
01418         }
01419         Current = Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01420     }
01421 
01422 <span class="preprocessor">#if DBG</span>
01423 <span class="preprocessor"></span>    <span class="comment">// </span>
01424     <span class="comment">// Make sure this key is not somehow cached in the wrong spot.</span>
01425     <span class="comment">//</span>
01426     {
01427         ULONG DbgIndex;
01428         <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01429         
01430         <span class="keywordflow">for</span> (DbgIndex = 0; DbgIndex &lt; <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; DbgIndex++) {
01431             Current = <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[DbgIndex];
01432             <span class="keywordflow">while</span> (Current) {
01433                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = CONTAINING_RECORD(Current,
01434                                         <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>,
01435                                         KeyHash);
01436                 
01437                 <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(Current);
01438                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((KeyHash-&gt;KeyHive != Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o2">KeyHive</a>) ||
01439                        FakeKey ||
01440                        (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; CM_KCB_KEY_NON_EXIST) ||
01441                        (KeyHash-&gt;KeyCell != Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o3">KeyCell</a>));
01442                 Current = Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01443             }
01444         }
01445     }
01446     
01447 <span class="preprocessor">#endif</span>
01448 <span class="preprocessor"></span>
01449     <span class="comment">//</span>
01450     <span class="comment">// No duplicate was found, add this entry at the head of the list</span>
01451     <span class="comment">//</span>
01452     KeyHash-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01453     <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = KeyHash;
01454     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01455 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="cmsubs.c::CmpReferenceKeyControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpReferenceKeyControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">345</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>00348 {
00349     <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
00350         <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(KeyControlBlock);
00351     }
00352 
00353     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> + 1) == 0) {
00354         <span class="comment">//</span>
00355         <span class="comment">// We have maxed out the ref count on this key. Probably</span>
00356         <span class="comment">// some bogus app has opened the same key 64K times without</span>
00357         <span class="comment">// ever closing it. Just fail the call</span>
00358         <span class="comment">//</span>
00359         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00360     } <span class="keywordflow">else</span> {
00361         ++(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a>);
00362         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00363     }
00364 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="cmsubs.c::CmpRemoveFromDelayedClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpRemoveFromDelayedClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>kcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">807</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00031">CmpDelayedCloseSize</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00032">CmpDelayedCloseTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00034">CmpDelayedFreeIndex</a>, and <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">CmpReferenceKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.
<p>
<pre class="fragment"><div>00810 {
00811     ULONG i;
00812     i = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;DelayedCloseIndex;
00813 
00814     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CmpDelayedCloseTable[i] == kcb);
00815     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(i != CmpDelayedCloseSize);
00816 
00817     <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[i] = (<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>)<a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a>;
00818     <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = i;
00819     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;DelayedCloseIndex = 0;
00820 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="cmsubs.c::CmpRemoveKeyControlBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpRemoveKeyControlBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyControlBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">1260</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00069">ASSERT_KCB</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01459">CmpRemoveKeyHash()</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00275">_CM_KEY_CONTROL_BLOCK::KeyHash</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/cmapi2_8c-source.html#l00031">CmDeleteKey()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>.
<p>
<pre class="fragment"><div>01265                    :
01266 
01267     Remove a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB tree.
01268 
01269     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that no notify <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> blocks remain.
01270 
01271     The <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> will NOT be freed, call DereferenceKeyControlBlock <span class="keywordflow">for</span> that.
01272 
01273     This call assumes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already locked or registry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked exclusively.
01274 
01275 Arguments:
01276 
01277     KeyControlBlock - pointer to a key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
01278 
01279 Return Value:
01280 
01281     NONE.
01282 
01283 --*/
01284 {
01285     <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(KeyControlBlock);
01286 
01287     <span class="comment">//</span>
01288     <span class="comment">// Remove the KCB from the hash table</span>
01289     <span class="comment">//</span>
01290     <a class="code" href="../../d8/d2/cmsubs_8c.html#a9">CmpRemoveKeyHash</a>(&amp;KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o2">KeyHash</a>);
01291 
01292     <span class="keywordflow">return</span>;
01293 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmsubs.c::CmpRemoveKeyHash" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpRemoveKeyHash           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>KeyHash</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01459">1459</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00070">ASSERT_KEY_HASH</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01982">CmpCacheTable</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01981">CmpHashTableSize</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00472">HASH_KEY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00052">HASH_VALUE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00056">_CM_KEY_HASH::NextHash</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>.
<p>
<pre class="fragment"><div>01464                    :
01465 
01466     Removes a key hash structure from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash table.
01467 
01468 Arguments:
01469 
01470     KeyHash - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key hash structure to be deleted.
01471 
01472 Return Value:
01473 
01474     None
01475 
01476 --*/
01477 
01478 {
01479     <a class="code" href="../../d9/d0/cmdata_8h.html#a52">HASH_VALUE</a> Hash;
01480     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01481     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *Prev;
01482     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> Current;
01483 
01484     <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(KeyHash);
01485 
01486     Hash = <a class="code" href="../../d1/d2/cmp_8h.html#a75">HASH_KEY</a>(KeyHash-&gt;ConvKey);
01487     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Hash % <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>;
01488 
01489     <span class="comment">//</span>
01490     <span class="comment">// Find this entry.</span>
01491     <span class="comment">//</span>
01492     Prev = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01493     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01494         Current = *Prev;
01495         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Current != NULL);
01496         <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(Current);
01497         <span class="keywordflow">if</span> (Current == KeyHash) {
01498             *Prev = Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01499 <span class="preprocessor">#if DBG</span>
01500 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (*Prev) {
01501                 <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(*Prev);
01502             }
01503 <span class="preprocessor">#endif</span>
01504 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
01505         }
01506         Prev = &amp;Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01507     }
01508 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmsubs.c::CmpSearchForOpenSubKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpSearchForOpenSubKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyControlBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d0/cmdata_8h.html#a67">SUBKEY_SEARCH_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">180</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01982">CmpCacheTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00537">CmpCleanUpSubKeyInfo()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01981">CmpHashTableSize</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a105a102">SearchAndCount</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a105a101">SearchAndDeref</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a105a100">SearchIfExist</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00294">_CM_KEY_CONTROL_BLOCK::TotalLevels</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>, and <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>.
<p>
<pre class="fragment"><div>00185                    :
00186 
00187     This routine searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KCB tree <span class="keywordflow">for</span> any open handles to keys that
00188     are subkeys of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given key.
00189 
00190     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d1/d2/cmp_8h.html#a234">CmRestoreKey</a> to verify that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree being restored to
00191     has no open handles.
00192 
00193 Arguments:
00194 
00195     KeyControlBlock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <span class="keywordflow">for</span> which
00196         open subkeys are to be found.
00197 
00198     SearchType - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search
00199         <a class="code" href="../../d9/d0/cmdata_8h.html#a105a100">SearchIfExist</a> - exits at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first open subkey found ==&gt; returns 1 <span class="keywordflow">if</span> any subkey <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> open
00200         
00201         <a class="code" href="../../d9/d0/cmdata_8h.html#a105a101">SearchAndDeref</a> - Forces <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keys underneath <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> referenced KeyControlBlock to 
00202                 be marked as not referenced (see the REG_FORCE_RESTORE flag in CmRestoreKey) 
00203                 returns 1 <span class="keywordflow">if</span> at least one deref was <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
00204         
00205         <a class="code" href="../../d9/d0/cmdata_8h.html#a105a102">SearchAndCount</a> - Counts all open subkeys - returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of them
00206 
00207 Return Value:
00208 
00209     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>  - open handles to subkeys of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given key exist
00210 
00211     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - open handles to subkeys of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given key <span class="keywordflow">do</span> not exist.
00212 --*/
00213 {
00214     ULONG i;
00215     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *Current;
00216     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00217     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Realkcb;
00218     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Parent;
00219     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> LevelDiff, l;
00220     ULONG   <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00221     
00222     <span class="comment">//</span>
00223     <span class="comment">// Registry lock should be held exclusively, so no need to KCB lock</span>
00224     <span class="comment">//</span>
00225     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00226 
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// First, clean up all subkeys in the cache</span>
00230     <span class="comment">//</span>
00231     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; i++) {
00232         Current = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
00233         <span class="keywordflow">while</span> (*Current) {
00234             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = CONTAINING_RECORD(*Current, <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>, KeyHash);
00235             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount == 0) {
00236                 <span class="comment">//</span>
00237                 <span class="comment">// This kcb is in DelayClose case, remove it.</span>
00238                 <span class="comment">//</span>
00239                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(kcb);
00240                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(kcb);
00241 
00242                 <span class="comment">//</span>
00243                 <span class="comment">// The HashTable is changed, start over in this index again.</span>
00244                 <span class="comment">//</span>
00245                 Current = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
00246                 <span class="keywordflow">continue</span>;
00247             }
00248             Current = &amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NextHash;
00249         }
00250     }
00251 
00252     <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 1) {
00253         <span class="comment">//</span>
00254         <span class="comment">// There is only one open handle, so there must be no open subkeys.</span>
00255         <span class="comment">//</span>
00256         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00257     } <span class="keywordflow">else</span> {
00258         <span class="comment">//</span>
00259         <span class="comment">// Now search for an open subkey handle.</span>
00260         <span class="comment">//</span>
00261         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00262 
00263      
00264 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
00265 <span class="preprocessor"></span>        <span class="comment">//</span>
00266         <span class="comment">// dump the root first if we were asked to do so.</span>
00267         <span class="comment">//</span>
00268         <span class="keywordflow">if</span>(SearchType == <a class="code" href="../../d9/d0/cmdata_8h.html#a105a102">SearchAndCount</a>) {
00269             CmpDumpKeyBodyList(KeyControlBlock,&amp;Count);
00270         }
00271 <span class="preprocessor">#endif</span>
00272 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; i++) {
00273 
00274 StartDeref:
00275             Current = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
00276             <span class="keywordflow">while</span> (*Current) {
00277                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = CONTAINING_RECORD(*Current, <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>, KeyHash);
00278                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels &gt; KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>) {
00279                     LevelDiff = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels - KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>;
00280                 
00281                     Parent = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00282                     <span class="keywordflow">for</span> (l=0; l&lt;LevelDiff; l++) {
00283                         Parent = Parent-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00284                     }
00285     
00286                     <span class="keywordflow">if</span> (Parent == KeyControlBlock) {
00287                         <span class="comment">//</span>
00288                         <span class="comment">// Found a match;</span>
00289                         <span class="comment">//</span>
00290                         <span class="keywordflow">if</span>( SearchType == <a class="code" href="../../d9/d0/cmdata_8h.html#a105a100">SearchIfExist</a> ) {
00291                             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 1;
00292                             <span class="keywordflow">break</span>;
00293                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(SearchType == <a class="code" href="../../d9/d0/cmdata_8h.html#a105a101">SearchAndDeref</a>) {
00294                             <span class="comment">//</span>
00295                             <span class="comment">// Mark the key as deleted, remove it from cache, but don't add it</span>
00296                             <span class="comment">// to the Delay Close table (we want the key to be visible only to</span>
00297                             <span class="comment">// the one(s) that have open handles on it.</span>
00298                             <span class="comment">//</span>
00299 
00300                             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00301 
00302                             <span class="comment">//</span>
00303                             <span class="comment">// flush any pending notifies as the kcb won't be around any longer</span>
00304                             <span class="comment">//</span>
00305 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
00306 <span class="preprocessor"></span>                            CmpFlushNotifiesOnKeyBodyList(kcb);
00307 <span class="preprocessor">#endif</span>
00308 <span class="preprocessor"></span>                            
00309                             <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb);
00310                             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00311                             <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
00312                             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00313                             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00314                             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
00315                          
00316                             <span class="comment">//</span>
00317                             <span class="comment">// Restart the search </span>
00318                             <span class="comment">// </span>
00319                             <span class="keywordflow">goto</span> StartDeref;
00320                         
00321                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(SearchType == <a class="code" href="../../d9/d0/cmdata_8h.html#a105a102">SearchAndCount</a>) {
00322                             <span class="comment">//</span>
00323                             <span class="comment">// here do the dumping and count incrementing stuff</span>
00324                             <span class="comment">//</span>
00325 <span class="preprocessor">                        #ifdef KCB_TO_KEYBODY_LINK</span>
00326 <span class="preprocessor"></span>                            CmpDumpKeyBodyList(kcb,&amp;Count);
00327 <span class="preprocessor">                        #else</span>
00328 <span class="preprocessor"></span>                            <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
00329 <span class="preprocessor">                        #endif</span>
00330 <span class="preprocessor"></span>                        }
00331                     }   
00332 
00333                 }
00334                 Current = &amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NextHash;
00335             }
00336         }
00337     }
00338     
00339                            
00340     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00341 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="cmsubs.c::CmpSearchKeyControlBlockTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpSearchKeyControlBlockTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/cmp_8h.html#a184">PKCB_WORKER_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkerRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">1071</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00069">ASSERT_KCB</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01982">CmpCacheTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01981">CmpHashTableSize</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00266">Context1</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00266">Context2</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00272">_CM_KEY_CONTROL_BLOCK::Delete</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00855">KCB_WORKER_CONTINUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00857">KCB_WORKER_DELETE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00856">KCB_WORKER_DONE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00278">_CM_KEY_CONTROL_BLOCK::NextHash</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00273">_CM_KEY_CONTROL_BLOCK::RefCount</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00731">CmpRefreshHive()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>.
<p>
<pre class="fragment"><div>01078                    :
01079 
01080     Traverse <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> tree.  We will visit all nodes unless WorkerRoutine
01081     tells us to stop part way through.
01082 
01083     For each node, call WorkerRoutine(..., Context1, Contex2).  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns
01084     <a class="code" href="../../d1/d2/cmp_8h.html#a115">KCB_WORKER_DONE</a>, we are done, simply <span class="keywordflow">return</span>.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns
01085     <a class="code" href="../../d1/d2/cmp_8h.html#a114">KCB_WORKER_CONTINUE</a>, just <span class="keywordflow">continue</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search. If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d1/d2/cmp_8h.html#a116">KCB_WORKER_DELETE</a>,
01086     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified KCB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> marked as deleted.
01087 
01088     This routine has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> side-effect of removing all delayed-close KCBs.
01089 
01090 Arguments:
01091 
01092     WorkerRoutine - applied to nodes witch Match.
01093 
01094     <a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a> - data we pass through
01095 
01096     <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a> - data we pass through
01097 
01098 
01099 Return Value:
01100 
01101     NONE.
01102 
01103 --*/
01104 {
01105     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   Current;
01106     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   Next;
01107     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *Prev;
01108     ULONG                   WorkerResult;
01109     ULONG                   i;
01110 
01111     <span class="comment">//</span>
01112     <span class="comment">// Walk the hash table</span>
01113     <span class="comment">//</span>
01114     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; i++) {
01115         Prev = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
01116         <span class="keywordflow">while</span> (*Prev) {
01117             Current = CONTAINING_RECORD(*Prev,
01118                                         <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>,
01119                                         KeyHash);
01120             <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(Current);
01121             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>);
01122             <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
01123                 <span class="comment">//</span>
01124                 <span class="comment">// This kcb is in DelayClose case, remove it.</span>
01125                 <span class="comment">//</span>
01126                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(Current);
01127                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(Current);
01128 
01129                 <span class="comment">//</span>
01130                 <span class="comment">// The HashTable is changed, start over in this index again.</span>
01131                 <span class="comment">//</span>
01132                 Prev = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
01133                 <span class="keywordflow">continue</span>;
01134             }
01135 
01136             WorkerResult = (WorkerRoutine)(Current, <a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a>, <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a>);
01137             <span class="keywordflow">if</span> (WorkerResult == <a class="code" href="../../d1/d2/cmp_8h.html#a115">KCB_WORKER_DONE</a>) {
01138                 <span class="keywordflow">return</span>;
01139             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WorkerResult == <a class="code" href="../../d1/d2/cmp_8h.html#a116">KCB_WORKER_DELETE</a>) {
01140                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>);
01141                 *Prev = Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o4">NextHash</a>;
01142                 <span class="keywordflow">continue</span>;
01143             } <span class="keywordflow">else</span> {
01144                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(WorkerResult == KCB_WORKER_CONTINUE);
01145                 Prev = &amp;Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o4">NextHash</a>;
01146             }
01147         }
01148     }
01149 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a2" doxytag="cmsubs.c::CmpCacheTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a>* <a class="el" href="../../d8/d2/cmsubs_8c.html#a2">CmpCacheTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00029">29</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01350">CmpInsertKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01459">CmpRemoveKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmsubs.c::CmpDelayedCloseCurrent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>* <a class="el" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00033">33</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmsubs.c::CmpDelayedCloseSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a> = 512          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00031">31</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmsubs.c::CmpDelayedCloseTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>* <a class="el" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00032">32</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="cmsubs.c::CmpDelayedFreeIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG_PTR <a class="el" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00034">34</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmsubs.c::CmpHashTableSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d2/cmsubs_8c.html#a3">CmpHashTableSize</a> = 2048          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00030">30</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01350">CmpInsertKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01459">CmpRemoveKeyHash()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00180">CmpSearchForOpenSubKeys()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01071">CmpSearchKeyControlBlockTree()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="cmsubs.c::CmpKcbLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d1/d3/cmsysini_8c.html#a11">CmpKcbLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00026">26</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmsubs.c::CmpNameCacheTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a>* <a class="el" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00035">35</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00503">CmpDereferenceNameControlBlockWithLock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00368">CmpGetNameControlBlock()</a>, and <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmsubs.c::CmpPostLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d1/d3/cmsysini_8c.html#a12">CmpPostLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00027">27</a> of file <a class="el" href="../../d9/d1/cmsubs_8c-source.html">cmsubs.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
