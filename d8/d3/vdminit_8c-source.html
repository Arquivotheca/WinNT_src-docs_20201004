<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: vdminit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>vdminit.c</h1><a href="../../d7/d4/vdminit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00003 <span class="preprocessor">#include &lt;zwapi.h&gt;</span>
00004 <span class="preprocessor">#include &lt;ntconfig.h&gt;</span>
00005 <span class="preprocessor">#include "<a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html">vdmp.h</a>"</span>
00006 
00007 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00008 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, VdmpInitialize)</span>
00009 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00010 <span class="preprocessor"></span>
<a name="l00011"></a><a class="code" href="../../d7/d4/vdminit_8c.html#a0">00011</a> <span class="preprocessor">#define KEY_VALUE_BUFFER_SIZE 1024</span>
00012 <span class="preprocessor"></span>
00013 <span class="preprocessor">#if DEVL</span>
00014 <span class="preprocessor"></span>ULONG VdmBopCount;
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor"></span>
00017 
00018 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00019"></a><a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a3">00019</a> <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a3">VdmpInitialize</a>(
00020     PVDMICAUSERDATA pIcaUserData
00021     )
00022 
00023 <span class="comment">/*++</span>
00024 <span class="comment"></span>
00025 <span class="comment">Routine Description:</span>
00026 <span class="comment"></span>
00027 <span class="comment">    Initialize the address space of a VDM.</span>
00028 <span class="comment"></span>
00029 <span class="comment">Arguments:</span>
00030 <span class="comment"></span>
00031 <span class="comment">    None,</span>
00032 <span class="comment"></span>
00033 <span class="comment">Return Value:</span>
00034 <span class="comment"></span>
00035 <span class="comment">    NTSTATUS.</span>
00036 <span class="comment"></span>
00037 <span class="comment">--*/</span>
00038 
00039 {
00040     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, StatusCopy;
00041     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00042     UNICODE_STRING SectionName;
00043     UNICODE_STRING WorkString;
00044     ULONG ViewSize;
00045     LARGE_INTEGER ViewBase;
00046     PVOID BaseAddress;
00047     PVOID destination;
00048     HANDLE SectionHandle, RegistryHandle;
00049     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00050     ULONG ResultLength;
00051     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00052     PCM_FULL_RESOURCE_DESCRIPTOR ResourceDescriptor;
00053     PCM_PARTIAL_RESOURCE_DESCRIPTOR PartialResourceDescriptor;
00054     PKEY_VALUE_FULL_INFORMATION KeyValueBuffer;
00055     PCM_ROM_BLOCK BiosBlock;
00056     ULONG LastMappedAddress;
00057     PVDM_PROCESS_OBJECTS pVdmObjects = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00058     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PagedQuotaCharged = 0;
00059     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NonPagedQuotaCharged = 0;
00060     HANDLE hThread;
00061     <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib;
00062 
00063 
00064     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00065 
00066     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib</a>(&amp;VdmTib, <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a1">VDMTIB_PROBE</a>); <span class="comment">// take from user mode and probe</span>
00067 
00068     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00069         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00070     }
00071 
00072     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> &amp; MACHINE_TYPE_PC_9800_COMPATIBLE) == 0) {
00073 
00074         <span class="comment">//</span>
00075         <span class="comment">// This is PC/AT (and FMR in Japan) VDM.</span>
00076         <span class="comment">//</span>
00077 
00078         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00079             &amp;SectionName,
00080             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\PhysicalMemory"</span>
00081             );
00082 
00083         InitializeObjectAttributes(
00084             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00085             &amp;SectionName,
00086             OBJ_CASE_INSENSITIVE|OBJ_KERNEL_HANDLE,
00087             (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00088             (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00089             );
00090 
00091         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenSection(
00092             &amp;SectionHandle,
00093             SECTION_ALL_ACCESS,
00094             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00095             );
00096 
00097         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00098 
00099             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00100 
00101         }
00102 
00103         <span class="comment">//</span>
00104         <span class="comment">// Copy the first page of memory into the VDM's address space</span>
00105         <span class="comment">//</span>
00106 
00107         BaseAddress = 0;
00108         destination = 0;
00109         ViewSize = 0x1000;
00110         ViewBase.LowPart = 0;
00111         ViewBase.HighPart = 0;
00112 
00113         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwMapViewOfSection(
00114             SectionHandle,
00115             NtCurrentProcess(),
00116             &amp;BaseAddress,
00117             0,
00118             ViewSize,
00119             &amp;ViewBase,
00120             &amp;ViewSize,
00121             ViewUnmap,
00122             0,
00123             PAGE_READWRITE
00124             );
00125 
00126         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00127            ZwClose(SectionHandle);
00128            <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00129         }
00130 
00131         <span class="comment">// problem with this statement below --</span>
00132         <span class="comment">// it could be a non-vdm process and copying memory to address 0</span>
00133         <span class="comment">// should be guarded against</span>
00134 
00135         StatusCopy = STATUS_SUCCESS;
00136         <span class="keywordflow">try</span> {
00137             RtlMoveMemory(
00138                destination,
00139                BaseAddress,
00140                ViewSize
00141                );
00142         }
00143         except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00144            StatusCopy = GetExceptionCode();
00145         }
00146 
00147 
00148         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwUnmapViewOfSection(
00149             NtCurrentProcess(),
00150             BaseAddress
00151             );
00152 
00153         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(StatusCopy)) {
00154            ZwClose(SectionHandle);
00155            <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ? StatusCopy : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00156         }
00157 
00158         <span class="comment">//</span>
00159         <span class="comment">// Map Rom into address space</span>
00160         <span class="comment">//</span>
00161 
00162         BaseAddress = (PVOID) 0x000C0000;
00163         ViewSize = 0x40000;
00164         ViewBase.LowPart = 0x000C0000;
00165         ViewBase.HighPart = 0;
00166 
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">// First unmap the reserved memory.  This must be done here to prevent</span>
00170         <span class="comment">// the virtual memory in question from being consumed by some other</span>
00171         <span class="comment">// alloc vm call.</span>
00172         <span class="comment">//</span>
00173 
00174         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory(
00175             NtCurrentProcess(),
00176             &amp;BaseAddress,
00177             &amp;ViewSize,
00178             MEM_RELEASE
00179             );
00180 
00181         <span class="comment">// N.B.  This should probably take into account the fact that there are</span>
00182         <span class="comment">// a handfull of error conditions that are ok.  (such as no memory to</span>
00183         <span class="comment">// release.)</span>
00184 
00185         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00186             ZwClose(SectionHandle);
00187             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00188 
00189         }
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// Set up and open KeyPath</span>
00193         <span class="comment">//</span>
00194 
00195         InitializeObjectAttributes(
00196             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00197             &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a17">CmRegistryMachineHardwareDescriptionSystemName</a>,
00198             OBJ_CASE_INSENSITIVE|OBJ_KERNEL_HANDLE,
00199             (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00200             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00201             );
00202 
00203         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey(
00204             &amp;RegistryHandle,
00205             KEY_READ,
00206             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00207             );
00208 
00209         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00210             ZwClose(SectionHandle);
00211             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00212         }
00213 
00214         <span class="comment">//</span>
00215         <span class="comment">// Allocate space for the data</span>
00216         <span class="comment">//</span>
00217 
00218         KeyValueBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00219             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00220             <a class="code" href="../../d7/d4/vdminit_8c.html#a0">KEY_VALUE_BUFFER_SIZE</a>,
00221             ' MDV'
00222             );
00223 
00224         <span class="keywordflow">if</span> (KeyValueBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00225             ZwClose(RegistryHandle);
00226             ZwClose(SectionHandle);
00227             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00228         }
00229 
00230         <span class="comment">//</span>
00231         <span class="comment">// Get the data for the rom information</span>
00232         <span class="comment">//</span>
00233 
00234         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00235             &amp;WorkString,
00236             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Configuration Data"</span>
00237             );
00238 
00239         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey(
00240             RegistryHandle,
00241             &amp;WorkString,
00242             KeyValueFullInformation,
00243             KeyValueBuffer,
00244             <a class="code" href="../../d7/d4/vdminit_8c.html#a0">KEY_VALUE_BUFFER_SIZE</a>,
00245             &amp;ResultLength
00246             );
00247 
00248         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00249             ZwClose(RegistryHandle);
00250             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueBuffer);
00251             ZwClose(SectionHandle);
00252             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00253         }
00254 
00255         ResourceDescriptor = (PCM_FULL_RESOURCE_DESCRIPTOR)
00256             ((PUCHAR) KeyValueBuffer + KeyValueBuffer-&gt;DataOffset);
00257 
00258         <span class="keywordflow">if</span> ((KeyValueBuffer-&gt;DataLength &lt; <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR)) ||
00259             (ResourceDescriptor-&gt;PartialResourceList.Count &lt; 2)
00260         ) {
00261             ZwClose(RegistryHandle);
00262             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueBuffer);
00263             ZwClose(SectionHandle);
00264             <span class="comment">// No rom blocks.</span>
00265             <span class="keywordflow">return</span> STATUS_SUCCESS;
00266         }
00267 
00268         PartialResourceDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
00269             ((PUCHAR)ResourceDescriptor +
00270             <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR) +
00271             ResourceDescriptor-&gt;PartialResourceList.PartialDescriptors[0]
00272                 .u.DeviceSpecificData.DataSize);
00273 
00274 
00275         <span class="keywordflow">if</span> (KeyValueBuffer-&gt;DataLength &lt; ((PUCHAR)PartialResourceDescriptor -
00276             (PUCHAR)ResourceDescriptor + <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR)
00277             + <span class="keyword">sizeof</span>(CM_ROM_BLOCK))
00278         ) {
00279             ZwClose(RegistryHandle);
00280             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueBuffer);
00281             ZwClose(SectionHandle);
00282             <span class="keywordflow">return</span> STATUS_ILL_FORMED_SERVICE_ENTRY;
00283         }
00284 
00285 
00286         BiosBlock = (PCM_ROM_BLOCK)((PUCHAR)PartialResourceDescriptor +
00287             <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR));
00288 
00289         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = PartialResourceDescriptor-&gt;u.DeviceSpecificData.DataSize /
00290             <span class="keyword">sizeof</span>(CM_ROM_BLOCK);
00291 
00292         <span class="comment">//</span>
00293         <span class="comment">// N.B.  Rom blocks begin on 2K (not necessarily page) boundaries</span>
00294         <span class="comment">//       They end on 512 byte boundaries.  This means that we have</span>
00295         <span class="comment">//       to keep track of the last page mapped, and round the next</span>
00296         <span class="comment">//       Rom block up to the next page boundary if necessary.</span>
00297         <span class="comment">//</span>
00298 
00299         LastMappedAddress = 0xC0000;
00300 
00301         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
00302 <span class="preprocessor">    #if 0</span>
00303 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
00304                 <span class="stringliteral">"Bios Block, PhysAddr = %lx, size = %lx\n"</span>,
00305                 BiosBlock-&gt;Address,
00306                 BiosBlock-&gt;Size
00307                 );
00308 <span class="preprocessor">    #endif</span>
00309 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; 1) &amp;&amp;
00310                 ((BiosBlock-&gt;Address + BiosBlock-&gt;Size) == BiosBlock[1].Address)
00311             ) {
00312                 <span class="comment">//</span>
00313                 <span class="comment">// Coalesce adjacent blocks</span>
00314                 <span class="comment">//</span>
00315                 BiosBlock[1].Address = BiosBlock[0].Address;
00316                 BiosBlock[1].Size += BiosBlock[0].Size;
00317                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>--;
00318                 BiosBlock++;
00319                 <span class="keywordflow">continue</span>;
00320             }
00321 
00322             BaseAddress = (PVOID)(BiosBlock-&gt;Address);
00323             ViewSize = BiosBlock-&gt;Size;
00324 
00325             <span class="keywordflow">if</span> ((ULONG)BaseAddress &lt; LastMappedAddress) {
00326                 <span class="keywordflow">if</span> (ViewSize &gt; (LastMappedAddress - (ULONG)BaseAddress)) {
00327                     ViewSize = ViewSize - (LastMappedAddress - (ULONG)BaseAddress);
00328                     BaseAddress = (PVOID)LastMappedAddress;
00329                 } <span class="keywordflow">else</span> {
00330                     ViewSize = 0;
00331                 }
00332             }
00333 
00334             ViewBase.LowPart = (ULONG)BaseAddress;
00335 
00336             <span class="keywordflow">if</span> (ViewSize &gt; 0) {
00337 
00338                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwMapViewOfSection(
00339                     SectionHandle,
00340                     NtCurrentProcess(),
00341                     &amp;BaseAddress,
00342                     0,
00343                     ViewSize,
00344                     &amp;ViewBase,
00345                     &amp;ViewSize,
00346                     ViewUnmap,
00347                     MEM_DOS_LIM,
00348                     PAGE_READWRITE
00349                     );
00350 
00351                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00352                     <span class="keywordflow">break</span>;
00353                 }
00354 
00355                 LastMappedAddress = (ULONG)BaseAddress + ViewSize;
00356             }
00357 
00358             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>--;
00359             BiosBlock++;
00360         }
00361 
00362         <span class="comment">//</span>
00363         <span class="comment">// Free up the handles</span>
00364         <span class="comment">//</span>
00365 
00366         ZwClose(SectionHandle);
00367         ZwClose(RegistryHandle);
00368         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueBuffer);
00369 
00370     } <span class="keywordflow">else</span> {
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">// This is PC-9800 Series VDM.</span>
00374         <span class="comment">//</span>
00375 
00376         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00377     }
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">// Mark the process as a vdm</span>
00381     <span class="comment">//</span>
00382 
00383     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00384     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.VdmFlag = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00385 
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Create VdmObjects structure</span>
00389     <span class="comment">//</span>
00390     <span class="comment">// N.B.  We don't use ExAllocatePoolWithQuota because it</span>
00391     <span class="comment">//       takes a reference to the process (which ExFreePool</span>
00392     <span class="comment">//       dereferences).  Since we expect to clean up on</span>
00393     <span class="comment">//       process deletion, we don't need or want the reference</span>
00394     <span class="comment">//       (which will prevent the process from being deleted)</span>
00395     <span class="comment">//</span>
00396 
00397     <span class="keywordflow">try</span> {
00398 
00399         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00400             <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00401             <span class="keyword">sizeof</span>(VDM_PROCESS_OBJECTS),
00402             ' MDV'
00403             );
00404 
00405         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00406             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00407         }
00408 
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">// We use NonPagedQuotaCharged to keep track of the quota to return</span>
00412         <span class="comment">// if this function fails</span>
00413         <span class="comment">//</span>
00414         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(Process, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(VDM_PROCESS_OBJECTS));
00415         NonPagedQuotaCharged = <span class="keyword">sizeof</span>(VDM_PROCESS_OBJECTS);
00416 
00417         RtlZeroMemory( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>, <span class="keyword">sizeof</span>(VDM_PROCESS_OBJECTS));
00418         pVdmObjects = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>;
00419         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;pVdmObjects-&gt;DelayIntFastMutex);
00420         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock);
00421         InitializeListHead(&amp;pVdmObjects-&gt;DelayIntListHead);
00422 
00423         pVdmObjects-&gt;pIcaUserData = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00424             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00425             <span class="keyword">sizeof</span>(VDMICAUSERDATA),
00426             ' MDV'
00427             );
00428 
00429         <span class="keywordflow">if</span> (pVdmObjects-&gt;pIcaUserData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00430             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00431         } <span class="keywordflow">else</span> {
00432 
00433             <span class="comment">//</span>
00434             <span class="comment">// We use NonPagedQuotaCharged to keep track of the quota to return</span>
00435             <span class="comment">// if this function fails</span>
00436             <span class="comment">//</span>
00437             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(
00438                 Process,
00439                 <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00440                 <span class="keyword">sizeof</span>(VDMICAUSERDATA)
00441                 );
00442             PagedQuotaCharged = <span class="keyword">sizeof</span>(VDMICAUSERDATA);
00443 
00444             RtlZeroMemory( pVdmObjects-&gt;pIcaUserData, <span class="keyword">sizeof</span>(VDMICAUSERDATA));
00445 
00446 
00447             <span class="comment">//</span>
00448             <span class="comment">// Copy Ica addresses from service data (in user space) into</span>
00449             <span class="comment">// pVdmObjects-&gt;pIcaUserData</span>
00450             <span class="comment">//</span>
00451 
00452             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pIcaUserData, <span class="keyword">sizeof</span>(VDMICAUSERDATA), <span class="keyword">sizeof</span>(UCHAR));
00453             *pVdmObjects-&gt;pIcaUserData  = *pIcaUserData;
00454 
00455 
00456             <span class="comment">//</span>
00457             <span class="comment">// Probe static addresses in IcaUserData.</span>
00458             <span class="comment">//</span>
00459             pIcaUserData = pVdmObjects-&gt;pIcaUserData;
00460 
00461             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(pIcaUserData-&gt;phWowIdleEvent);
00462 
00463             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00464                 pIcaUserData-&gt;pIcaLock,
00465                 <span class="keyword">sizeof</span>(RTL_CRITICAL_SECTION),
00466                 <span class="keyword">sizeof</span>(UCHAR)
00467                 );
00468 
00469             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00470                 pIcaUserData-&gt;pIcaMaster,
00471                 <span class="keyword">sizeof</span>(VDMVIRTUALICA),
00472                 <span class="keyword">sizeof</span>(UCHAR)
00473                 );
00474 
00475             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00476                 pIcaUserData-&gt;pIcaSlave,
00477                 <span class="keyword">sizeof</span>(VDMVIRTUALICA),
00478                 <span class="keyword">sizeof</span>(UCHAR)
00479                 );
00480 
00481             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pIcaUserData-&gt;pIretHooked);
00482             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pIcaUserData-&gt;pDelayIrq);
00483             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pIcaUserData-&gt;pUndelayIrq);
00484             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pIcaUserData-&gt;pDelayIret);
00485 
00486 
00487             <span class="comment">//</span>
00488             <span class="comment">// Save pointer to main thread, for delayed interrupts DPC routine.</span>
00489             <span class="comment">// To keep the pointer to the main thread valid, open a thread handle</span>
00490             <span class="comment">// and keep it open until process cleanup.</span>
00491             <span class="comment">//</span>
00492 
00493             InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00494             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  ZwOpenThread(&amp;hThread,
00495                                    THREAD_QUERY_INFORMATION,
00496                                    &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00497                                    &amp;NtCurrentTeb()-&gt;ClientId
00498                                    );
00499 
00500             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00501                 pVdmObjects-&gt;MainThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00502                 }
00503 
00504 
00505             pVdmObjects-&gt;VdmTib = VdmTib;
00506         }
00507 
00508     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00509         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00510     }
00511 
00512 
00513     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00514         <span class="keywordflow">if</span> (pVdmObjects) {
00515             <span class="keywordflow">if</span> (pVdmObjects-&gt;pIcaUserData) {
00516                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pVdmObjects-&gt;pIcaUserData);
00517             }
00518             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pVdmObjects);
00519         }
00520         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00521 
00522         <span class="comment">//</span>
00523         <span class="comment">// Return Quota charged</span>
00524         <span class="comment">//</span>
00525         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(Process, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, NonPagedQuotaCharged);
00526         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(Process, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, PagedQuotaCharged);
00527         }
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">// following codepath only for PC/AT (and FMR in Japan) vdm</span>
00531     <span class="comment">//</span>
00532 
00533     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> &amp; MACHINE_TYPE_PC_9800_COMPATIBLE) == 0) {
00534 
00535 <span class="preprocessor">#ifdef WHEN_IO_DISPATCHING_IMPROVED</span>
00536 <span class="preprocessor"></span>        <span class="comment">// Sudeepb - Once we improve the IO dispatching we should use this</span>
00537         <span class="comment">// routine. Currently we are dispatching the printer ports directly</span>
00538         <span class="comment">// from emv86.asm and instemul.asm</span>
00539 
00540         VdmInitializePrinter ();
00541 <span class="preprocessor">#endif</span>
00542 <span class="preprocessor"></span>    }
00543 
00544     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00545 
00546 } <span class="comment">// end InitializeVDM()</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:21 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
