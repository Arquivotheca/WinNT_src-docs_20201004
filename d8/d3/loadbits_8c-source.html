<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: loadbits.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>loadbits.c</h1><a href="../../d7/d4/loadbits_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: loadbits.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Loads and creates icons / cursors / bitmaps. All 3 functions can either</span>
00007 <span class="comment">* load from a client resource file, load from user's resource file, or</span>
00008 <span class="comment">* load from the display's resource file. Beware that hmodules are not</span>
00009 <span class="comment">* unique across processes!</span>
00010 <span class="comment">*</span>
00011 <span class="comment">* 05-Apr-1991 ScottLu   Rewrote to work with client/server</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#include &lt;wchar.h&gt;</span>
00017 
00018 <span class="comment">/***************************************************************************\</span>
00019 <span class="comment">* _CreateEmptyCursorObject</span>
00020 <span class="comment">*</span>
00021 <span class="comment">* Creates a cursor object and links it into a cursor list.</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* 08-Feb-92 ScottLu     Created.</span>
00024 <span class="comment">\***************************************************************************/</span>
00025 
<a name="l00026"></a><a class="code" href="../../d4/d1/userk_8h.html#a1117">00026</a> HCURSOR <a class="code" href="../../d4/d1/userk_8h.html#a1117">_CreateEmptyCursorObject</a>(
00027     BOOL fPublic)
00028 {
00029     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurT;
00030 
00031     <span class="comment">/*</span>
00032 <span class="comment">     * Create the cursor object.</span>
00033 <span class="comment">     */</span>
00034     pcurT = (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(),
00035                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00036                                    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>,
00037                                    <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d1/structtagCURSOR.html">CURSOR</a>),
00038                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/structtagACON.html">ACON</a>)));
00039 
00040     <span class="keywordflow">if</span> (fPublic &amp;&amp; (pcurT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00041         pcurT-&gt;head.ppi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00042         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;TIF_flags &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>));
00043     }
00044 
00045     <span class="keywordflow">return</span> (HCURSOR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pcurT);
00046 }
00047 
00048 <span class="comment">/***************************************************************************\</span>
00049 <span class="comment">* DestroyEmptyCursorObject</span>
00050 <span class="comment">* UnlinkCursor</span>
00051 <span class="comment">*</span>
00052 <span class="comment">* Destroys an empty cursor object (structure holds nothing that needs</span>
00053 <span class="comment">* destroying).</span>
00054 <span class="comment">*</span>
00055 <span class="comment">* 08-Feb-1992 ScottLu   Created.</span>
00056 <span class="comment">\***************************************************************************/</span>
<a name="l00057"></a><a class="code" href="../../d7/d4/loadbits_8c.html#a1">00057</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d4/loadbits_8c.html#a1">UnlinkCursor</a>(
00058     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur)
00059 {
00060     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> *ppcurT;
00061     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fTriedPublicCache;
00062     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fTriedThisProcessCache = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00063 
00064     <span class="comment">/*</span>
00065 <span class="comment">     * First unlink this cursor object from the cursor list (it will be the</span>
00066 <span class="comment">     * first one in the list, so this'll be fast...  but just in case, make</span>
00067 <span class="comment">     * it a loop).</span>
00068 <span class="comment">     */</span>
00069     <span class="keywordflow">if</span> (fTriedPublicCache = (pcur-&gt;head.ppi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00070         ppcurT = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a155">gpcurFirst</a>;
00071     } <span class="keywordflow">else</span> {
00072         ppcurT = &amp;pcur-&gt;head.ppi-&gt;pCursorCache;
00073     }
00074 
00075 LookAgain:
00076 
00077     <span class="keywordflow">for</span> (; *ppcurT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ppcurT = &amp;((*ppcurT)-&gt;pcurNext)) {
00078         <span class="keywordflow">if</span> (*ppcurT == pcur) {
00079             *ppcurT = pcur-&gt;pcurNext;
00080 FreeIt:
00081             pcur-&gt;pcurNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00082             pcur-&gt;CURSORF_flags &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a541">CURSORF_LINKED</a>;
00083             <span class="keywordflow">return</span>;
00084         }
00085     }
00086 
00087     <span class="comment">/*</span>
00088 <span class="comment">     * If we get here, it means that the cursor used to be public but</span>
00089 <span class="comment">     * got assigned to the current thread due to being unlocked.  We</span>
00090 <span class="comment">     * have to look for it in the public cache.</span>
00091 <span class="comment">     */</span>
00092     <span class="keywordflow">if</span> (!fTriedPublicCache) {
00093         ppcurT = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a155">gpcurFirst</a>;
00094         fTriedPublicCache = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00095         <span class="keywordflow">goto</span> LookAgain;
00096     }
00097 
00098     <span class="comment">/*</span>
00099 <span class="comment">     * If we got here, it means that it was locked during process</span>
00100 <span class="comment">     * cleanup and got assigned to no owner.  Try the current process</span>
00101 <span class="comment">     * cache.</span>
00102 <span class="comment">     */</span>
00103     <span class="keywordflow">if</span> (!fTriedThisProcessCache) {
00104         ppcurT = &amp;<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;pCursorCache;
00105         fTriedThisProcessCache = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00106         <span class="keywordflow">goto</span> LookAgain;
00107     }
00108 
00109     <span class="comment">/*</span>
00110 <span class="comment">     * Getting Desperate here...  Look through every cursor and process</span>
00111 <span class="comment">     * cache for it.</span>
00112 <span class="comment">     */</span>
00113     {
00114         <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> pheMax, pheT;
00115 
00116         pheMax = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
00117         <span class="keywordflow">for</span> (pheT = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>; pheT &lt;= pheMax; pheT++) {
00118             <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>) {
00119                 <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>)-&gt;pcurNext == pcur) {
00120                     ((<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>)-&gt;pcurNext = pcur-&gt;pcurNext;
00121                     <span class="keywordflow">goto</span> FreeIt;
00122                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> &amp;&amp; ((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>)-&gt;pCursorCache == pcur) {
00123                     ((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>)-&gt;pCursorCache = pcur-&gt;pcurNext;
00124                     <span class="keywordflow">goto</span> FreeIt;
00125                 }
00126             }
00127         }
00128     }
00129 
00130     UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00131 }
00132 
00133 <span class="comment">/***************************************************************************\</span>
00134 <span class="comment">* DestroyEmptyCursorObject</span>
00135 <span class="comment">*</span>
00136 <span class="comment">\***************************************************************************/</span>
00137 
<a name="l00138"></a><a class="code" href="../../d7/d4/loadbits_8c.html#a2">00138</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d4/loadbits_8c.html#a2">DestroyEmptyCursorObject</a>(
00139     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur)
00140 {
00141     <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a541">CURSORF_LINKED</a>) {
00142         <a class="code" href="../../d7/d4/loadbits_8c.html#a1">UnlinkCursor</a>(pcur);
00143     }
00144 
00145     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pcur);
00146 }
00147 
00148 <span class="comment">/***************************************************************************\</span>
00149 <span class="comment">* ZombieCursor</span>
00150 <span class="comment">*</span>
00151 <span class="comment">* Unlink the cursor and set its owner to the system process.</span>
00152 <span class="comment">*</span>
00153 <span class="comment">* 3-Sep-1997    vadimg      created</span>
00154 <span class="comment">\***************************************************************************/</span>
00155 
<a name="l00156"></a><a class="code" href="../../d4/d1/userk_8h.html#a1108">00156</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1108">ZombieCursor</a>(<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur)
00157 {
00158     <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a541">CURSORF_LINKED</a>) {
00159         <a class="code" href="../../d7/d4/loadbits_8c.html#a1">UnlinkCursor</a>(pcur);
00160     }
00161 
00162 <span class="preprocessor">#if DBG</span>
00163 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00164         <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe;
00165         phe = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pcur);
00166 
00167         <span class="keywordflow">if</span> (phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00168             RIPMSG2(RIP_ERROR, <span class="stringliteral">"NULL owner for cursor %x phe %x\n"</span>,
00169                     pcur, phe);
00170         }
00171     }
00172 <span class="preprocessor">#endif // DBG</span>
00173 <span class="preprocessor"></span>
00174     <a class="code" href="../../d4/d1/userk_8h.html#a111">HMChangeOwnerProcess</a>(pcur, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>);
00175 
00176     RIPMSG1(RIP_WARNING, <span class="stringliteral">"ZombieCursor: 0x%08X became a zombie"</span>, pcur);
00177 }
00178 
00179 <span class="comment">/***************************************************************************\</span>
00180 <span class="comment">* ResStrCmp</span>
00181 <span class="comment">*</span>
00182 <span class="comment">* This function compares two strings taking into account that one or both</span>
00183 <span class="comment">* of them may be resource IDs.  The function returns a TRUE if the strings</span>
00184 <span class="comment">* are equal, instead of the zero lstrcmp() returns.</span>
00185 <span class="comment">*</span>
00186 <span class="comment">* History:</span>
00187 <span class="comment">* 20-Apr-91 DavidPe     Created</span>
00188 <span class="comment">\***************************************************************************/</span>
00189 
<a name="l00190"></a><a class="code" href="../../d7/d4/loadbits_8c.html#a4">00190</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d4/loadbits_8c.html#a4">ResStrCmp</a>(
00191     PUNICODE_STRING cczpstr1,
00192     PUNICODE_STRING pstr2)
00193 {
00194     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195     <span class="comment">/*</span>
00196 <span class="comment">     * pstr1 is a STRING that is in kernel space, but the buffer may</span>
00197 <span class="comment">     * be in client space.</span>
00198 <span class="comment">     */</span>
00199 
00200     <span class="keywordflow">if</span> (cczpstr1-&gt;Length == 0) {
00201 
00202         <span class="comment">/*</span>
00203 <span class="comment">         * pstr1 is a resource ID, so just compare the values.</span>
00204 <span class="comment">         */</span>
00205         <span class="keywordflow">if</span> (cczpstr1-&gt;Buffer == pstr2-&gt;Buffer)
00206             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00207 
00208     } <span class="keywordflow">else</span> {
00209 
00210         <span class="keywordflow">try</span> {
00211         <span class="comment">/*</span>
00212 <span class="comment">         * pstr1 is a string.  if pstr2 is an actual string compare the</span>
00213 <span class="comment">         * string values; if pstr2 is not a string then pstr1 may be an</span>
00214 <span class="comment">         * "integer string" of the form "#123456". so convert it to an</span>
00215 <span class="comment">         * integer and compare the integers.</span>
00216 <span class="comment">         * Before calling lstrcmp(), make sure pstr2 is an actual</span>
00217 <span class="comment">         * string, not a resource ID.</span>
00218 <span class="comment">         */</span>
00219             <span class="keywordflow">if</span> (pstr2-&gt;Length != 0) {
00220 
00221                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(cczpstr1, pstr2, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00222                     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00223 
00224             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cczpstr1-&gt;Buffer[0] == <span class="charliteral">'#'</span>) {
00225 
00226                 UNICODE_STRING strId;
00227                 <span class="keywordtype">int</span>            <span class="keywordtype">id</span>;
00228 
00229                 strId.Length        = cczpstr1-&gt;Length - <span class="keyword">sizeof</span>(WCHAR);
00230                 strId.MaximumLength = strId.Length;
00231                 strId.Buffer        = cczpstr1-&gt;Buffer + 1;
00232                 <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;strId, 10, (PULONG)&amp;<span class="keywordtype">id</span>);
00233 
00234                 <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == (LONG_PTR)pstr2-&gt;Buffer)
00235                     retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00236             }
00237         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00238         }
00239     }
00240 
00241     <span class="keywordflow">return</span> retval;
00242 }
00243 
00244 <span class="comment">/***********************************************************************\</span>
00245 <span class="comment">* SearchIconCache</span>
00246 <span class="comment">*</span>
00247 <span class="comment">* Worker routine for FindExistingCursorIcon().</span>
00248 <span class="comment">*</span>
00249 <span class="comment">* Returns: pCurFound</span>
00250 <span class="comment">*</span>
00251 <span class="comment">* 28-Sep-1995 SanfordS  Created.</span>
00252 <span class="comment">\***********************************************************************/</span>
00253 
<a name="l00254"></a><a class="code" href="../../d4/d1/userk_8h.html#a1107">00254</a> <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> <a class="code" href="../../d4/d1/userk_8h.html#a1107">SearchIconCache</a>(
00255     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>         pCursorCache,
00256     ATOM            atomModName,
00257     PUNICODE_STRING cczpstrResName,
00258     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>         pcurSrc,
00259     <a class="code" href="../../d9/d1/structtagCURSORFIND.html">PCURSORFIND</a>     pcfSearch)
00260 {
00261     <span class="comment">/*</span>
00262 <span class="comment">     * Run through the list of 'resource' objects created,</span>
00263 <span class="comment">     * and see if the cursor requested has already been loaded.</span>
00264 <span class="comment">     * If so just return it.  We do this to be consistent with</span>
00265 <span class="comment">     * Win 3.0 where they simply return a pointer to the res-data</span>
00266 <span class="comment">     * for a cursor/icon handle.  Many apps count on this and</span>
00267 <span class="comment">     * call LoadCursor/Icon() often.</span>
00268 <span class="comment">     *</span>
00269 <span class="comment">     * LR_SHARED implies:</span>
00270 <span class="comment">     *   1) icons never get deleted till process (LATER or WOW module)</span>
00271 <span class="comment">     *      goes away.</span>
00272 <span class="comment">     *   2) This cache is consulted before trying to load a res.</span>
00273 <span class="comment">     */</span>
00274     <span class="keywordflow">for</span> (; pCursorCache != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pCursorCache = pCursorCache-&gt;pcurNext) {
00275 
00276         <span class="comment">/*</span>
00277 <span class="comment">         * If we are given a specific cursor to look for, then</span>
00278 <span class="comment">         * search for that first.</span>
00279 <span class="comment">         */</span>
00280         <span class="keywordflow">if</span> (pcurSrc &amp;&amp; (pCursorCache == pcurSrc))
00281             <span class="keywordflow">return</span> pcurSrc;
00282 
00283         <span class="comment">/*</span>
00284 <span class="comment">         * No need to look further if the module name doesn't match.</span>
00285 <span class="comment">         */</span>
00286         <span class="keywordflow">if</span> (atomModName != pCursorCache-&gt;atomModName)
00287             <span class="keywordflow">continue</span>;
00288 
00289         <span class="comment">/*</span>
00290 <span class="comment">         * We only return images that cannot be destroyed by the app.</span>
00291 <span class="comment">         * so we don't have to deal with ref counts.  This is owned</span>
00292 <span class="comment">         * by us, but not LR_SHARED.</span>
00293 <span class="comment">         */</span>
00294         <span class="keywordflow">if</span> (!(pCursorCache-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a536">CURSORF_LRSHARED</a>))
00295             <span class="keywordflow">continue</span>;
00296 
00297         <span class="comment">/*</span>
00298 <span class="comment">         * Check the other distinguishing search criteria for</span>
00299 <span class="comment">         * a match.</span>
00300 <span class="comment">         */</span>
00301         <span class="keywordflow">if</span> ((pCursorCache-&gt;rt == LOWORD(pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o1">rt</a>)) &amp;&amp;
00302             <a class="code" href="../../d7/d4/loadbits_8c.html#a4">ResStrCmp</a>(cczpstrResName, &amp;pCursorCache-&gt;strName)) {
00303 
00304             <span class="comment">/*</span>
00305 <span class="comment">             * Acons don't have a size per se because each frame</span>
00306 <span class="comment">             * can be a different size.  We always make it a hit</span>
00307 <span class="comment">             * on acons so replacement of system icons is possible.</span>
00308 <span class="comment">             */</span>
00309             <span class="keywordflow">if</span> (pCursorCache-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>)
00310                 <span class="keywordflow">return</span> pCursorCache;
00311 
00312             <span class="comment">/*</span>
00313 <span class="comment">             * First hit wins.  Nothing fancy here.  Apps that use</span>
00314 <span class="comment">             * LR_SHARED have to watch out for this.</span>
00315 <span class="comment">             */</span>
00316             <span class="keywordflow">if</span> ((!pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o2">cx</a> || (pCursorCache-&gt;cx == pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o2">cx</a>))       &amp;&amp;
00317                 (!pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o3">cy</a> || ((pCursorCache-&gt;cy / 2) == pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o3">cy</a>)) &amp;&amp;
00318                 (!pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o4">bpp</a> || (pCursorCache-&gt;bpp == pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o4">bpp</a>))) {
00319 
00320                 <span class="keywordflow">return</span> pCursorCache;
00321             }
00322         }
00323     }
00324 
00325     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00326 }
00327 
00328 <span class="comment">/***********************************************************************\</span>
00329 <span class="comment">* _FindExistingCursorIcon</span>
00330 <span class="comment">*</span>
00331 <span class="comment">* This routine searches all existing icons for one matching the properties</span>
00332 <span class="comment">* given.  This routine will only return cursors/icons that are of</span>
00333 <span class="comment">* the type that cannot be destroyed by the app. (CURSORF_LRSHARED or</span>
00334 <span class="comment">* unowned) and will take the first hit it finds.</span>
00335 <span class="comment">*</span>
00336 <span class="comment">* 32bit apps that call LoadImage() will normally not have this cacheing</span>
00337 <span class="comment">* feature unless they specify LR_SHARED.  If they do so, it is the apps</span>
00338 <span class="comment">* responsability to be careful with how they use the cache since wild</span>
00339 <span class="comment">* lookups (ie 0s in cx, cy or bpp) will result in different results</span>
00340 <span class="comment">* depending on the history of icon/cursor creation.  It is thus recommended</span>
00341 <span class="comment">* that apps only use the LR_SHARED option when they are only working</span>
00342 <span class="comment">* with one size/colordepth of icon or when they call LoadImage() with</span>
00343 <span class="comment">* specific size and/or color content requested.</span>
00344 <span class="comment">*</span>
00345 <span class="comment">* For the future it would be nice to have a cacheing scheeme that would</span>
00346 <span class="comment">* simply be used to speed up reloading of images.  To do this right,</span>
00347 <span class="comment">* you would need ref counts to allow deletes to work properly and would</span>
00348 <span class="comment">* have to remember whether the images in the cache had been stretched</span>
00349 <span class="comment">* or color munged so you don't allow restretching.</span>
00350 <span class="comment">*</span>
00351 <span class="comment">* Returns: pcurFound</span>
00352 <span class="comment">*</span>
00353 <span class="comment">*</span>
00354 <span class="comment">* 17-Sep-1995 SanfordS  Created.</span>
00355 <span class="comment">\***********************************************************************/</span>
00356 
<a name="l00357"></a><a class="code" href="../../d4/d1/userk_8h.html#a1116">00357</a> <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> <a class="code" href="../../d4/d1/userk_8h.html#a1116">_FindExistingCursorIcon</a>(
00358     ATOM            atomModName,
00359     PUNICODE_STRING cczpstrResName,
00360     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>         pcurSrc,
00361     <a class="code" href="../../d9/d1/structtagCURSORFIND.html">PCURSORFIND</a>     pcfSearch)
00362 {
00363     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00364 
00365     <span class="comment">/*</span>
00366 <span class="comment">     * If rt is zero we're doing an indirect create, so matching with</span>
00367 <span class="comment">     * a previously loaded cursor/icon would be inappropriate.</span>
00368 <span class="comment">     */</span>
00369     <span class="keywordflow">if</span> (pcfSearch-&gt;<a class="code" href="../../d9/d1/structtagCURSORFIND.html#o1">rt</a> &amp;&amp; atomModName) {
00370 
00371         pcurT = <a class="code" href="../../d4/d1/userk_8h.html#a1107">SearchIconCache</a>(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;pCursorCache,
00372                                 atomModName,
00373                                 cczpstrResName,
00374                                 pcurSrc,
00375                                 pcfSearch);
00376         <span class="keywordflow">if</span> (pcurT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00377             pcurT = <a class="code" href="../../d4/d1/userk_8h.html#a1107">SearchIconCache</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a155">gpcurFirst</a>,
00378                                     atomModName,
00379                                     cczpstrResName,
00380                                     pcurSrc,
00381                                     pcfSearch);
00382         }
00383     }
00384 
00385     <span class="keywordflow">return</span> pcurT;
00386 }
00387 
00388 <span class="comment">/***************************************************************************\</span>
00389 <span class="comment">* _InternalGetIconInfo</span>
00390 <span class="comment">*</span>
00391 <span class="comment">* History:</span>
00392 <span class="comment">* 09-Mar-1993 MikeKe    Created.</span>
00393 <span class="comment">\***************************************************************************/</span>
00394 
<a name="l00395"></a><a class="code" href="../../d4/d1/userk_8h.html#a1112">00395</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1112">_InternalGetIconInfo</a>(
00396     IN  <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>                  pcur,
00397     OUT PICONINFO                ccxpiconinfo,
00398     OUT OPTIONAL PUNICODE_STRING pstrInstanceName,
00399     OUT OPTIONAL PUNICODE_STRING pstrResName,
00400     OUT OPTIONAL LPDWORD         ccxpbpp,
00401     IN  BOOL                     fInternalCursor)
00402 {
00403     HBITMAP hbmBitsT;
00404     HBITMAP hbmDstT;
00405     HBITMAP hbmMask;
00406     HBITMAP hbmColor;
00407 
00408     <span class="comment">/*</span>
00409 <span class="comment">     * Note -- while the STRING structures are in kernel mode memory, the</span>
00410 <span class="comment">     * buffers are in user-mode memory.  So all use of the buffers should</span>
00411 <span class="comment">     * be protected bytry blocks.</span>
00412 <span class="comment">     */</span>
00413 
00414     <span class="comment">/*</span>
00415 <span class="comment">     * If this is an animated cursor, just grab the first frame and return</span>
00416 <span class="comment">     * the info for it.</span>
00417 <span class="comment">     */</span>
00418     <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>)
00419         pcur = ((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcur)-&gt;aspcur[0];
00420 
00421     <span class="comment">/*</span>
00422 <span class="comment">     * Make copies of the bitmaps</span>
00423 <span class="comment">     *</span>
00424 <span class="comment">     * If the color bitmap is around, then there is no XOR mask in the</span>
00425 <span class="comment">     * hbmMask bitmap.</span>
00426 <span class="comment">     */</span>
00427     hbmMask = GreCreateBitmap(
00428             pcur-&gt;cx,
00429             (pcur-&gt;hbmColor &amp;&amp; !fInternalCursor) ? pcur-&gt;cy / 2 : pcur-&gt;cy,
00430             1,
00431             1,
00432             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00433 
00434     <span class="keywordflow">if</span> (hbmMask == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00435         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00436 
00437 
00438     hbmColor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00439 
00440     <span class="keywordflow">if</span> (pcur-&gt;hbmColor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00441 
00442         hbmColor = GreCreateCompatibleBitmap(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a527">HDCBITS</a>(),
00443                                              pcur-&gt;cx,
00444                                              pcur-&gt;cy / 2);
00445 
00446         <span class="keywordflow">if</span> (hbmColor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00447             GreDeleteObject(hbmMask);
00448             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00449         }
00450     }
00451 
00452     hbmBitsT = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, pcur-&gt;hbmMask);
00453     hbmDstT  = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmMask);
00454 
00455     GreBitBlt(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>,
00456               0,
00457               0,
00458               pcur-&gt;cx,
00459               (pcur-&gt;hbmColor &amp;&amp; !fInternalCursor) ? pcur-&gt;cy / 2 : pcur-&gt;cy,
00460               <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>,
00461               0,
00462               0,
00463               SRCCOPY,
00464               0x00ffffff);
00465 
00466     <span class="keywordflow">if</span> (hbmColor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00467 
00468         GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, pcur-&gt;hbmColor);
00469         GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmColor);
00470 
00471         GreBitBlt(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>,
00472                   0,
00473                   0,
00474                   pcur-&gt;cx,
00475                   pcur-&gt;cy / 2,
00476                   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>,
00477                   0,
00478                   0,
00479                   SRCCOPY,
00480                   0);
00481     }
00482 
00483     GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hbmBitsT);
00484     GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmDstT);
00485 
00486     <span class="comment">/*</span>
00487 <span class="comment">     * Fill in the iconinfo structure.  make copies of the bitmaps.</span>
00488 <span class="comment">     */</span>
00489     <span class="keywordflow">try</span> {
00490 
00491         ccxpiconinfo-&gt;fIcon = (pcur-&gt;rt == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(RT_ICON));
00492         ccxpiconinfo-&gt;xHotspot = pcur-&gt;xHotspot;
00493         ccxpiconinfo-&gt;yHotspot = pcur-&gt;yHotspot;
00494         ccxpiconinfo-&gt;hbmMask  = hbmMask;
00495         ccxpiconinfo-&gt;hbmColor = hbmColor;
00496 
00497         <span class="keywordflow">if</span> (pstrInstanceName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00498 
00499             <span class="keywordflow">if</span> (pcur-&gt;atomModName) {
00500                 pstrInstanceName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00501                         <a class="code" href="../../d4/d1/userk_8h.html#a1300">UserGetAtomName</a>(pcur-&gt;atomModName,
00502                                         pstrInstanceName-&gt;Buffer,
00503                                         (<span class="keywordtype">int</span>) (pstrInstanceName-&gt;MaximumLength / <span class="keyword">sizeof</span>(WCHAR))
00504                                         * <span class="keyword">sizeof</span>(WCHAR));
00505             } <span class="keywordflow">else</span> {
00506                 pstrInstanceName-&gt;Length = 0;
00507             }
00508         }
00509 
00510         <span class="keywordflow">if</span> (pstrResName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00511 
00512             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pcur-&gt;strName.Buffer)) {
00513                 <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(pstrResName, &amp;pcur-&gt;strName);
00514             } <span class="keywordflow">else</span> {
00515                 *pstrResName = pcur-&gt;strName;
00516             }
00517         }
00518 
00519         <span class="keywordflow">if</span> (ccxpbpp)
00520             *ccxpbpp = pcur-&gt;bpp;
00521 
00522     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00523         GreDeleteObject(hbmMask);
00524         GreDeleteObject(hbmColor);
00525         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00526     }
00527 
00528     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00529 }
00530 
00531 <span class="comment">/***************************************************************************\</span>
00532 <span class="comment">* _DestroyCursor</span>
00533 <span class="comment">*</span>
00534 <span class="comment">* History:</span>
00535 <span class="comment">* 25-Apr-1991 DavidPe       Created.</span>
00536 <span class="comment">* 04-Aug-1992 DarrinM       Now destroys ACONs as well.</span>
00537 <span class="comment">\***************************************************************************/</span>
00538 
<a name="l00539"></a><a class="code" href="../../d4/d1/userk_8h.html#a1782">00539</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1782">_DestroyCursor</a>(
00540     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur,
00541     DWORD   cmdDestroy)
00542 {
00543     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
00544     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiCursor;
00545     <span class="keywordtype">int</span>          i;
00546     <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a7">DestroyAniIcon</a>(<a class="code" href="../../d1/d8/structtagACON.html">PACON</a> <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>);
00547 
00548     <span class="keywordflow">if</span> (pcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00549         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00550         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00551     }
00552     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
00553     ppiCursor = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a457">GETPPI</a>(pcur);
00554 
00555     <span class="comment">/*</span>
00556 <span class="comment">     * Remove this icon from the caption icon cache.</span>
00557 <span class="comment">     */</span>
00558     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d1/userk_8h.html#a6">CCACHEDCAPTIONS</a>; i++) {
00559         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a105">gcachedCaptions</a>[i].<a class="code" href="../../d5/d9/structtagCAPTIONCACHE.html#o0">spcursor</a> == pcur) {
00560             <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>( &amp;(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a105">gcachedCaptions</a>[i].spcursor) );
00561         }
00562     }
00563 
00564     <span class="comment">/*</span>
00565 <span class="comment">     * First step in destroying an cursor</span>
00566 <span class="comment">     */</span>
00567     <span class="keywordflow">switch</span> (cmdDestroy) {
00568 
00569     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>:
00570 
00571         <span class="comment">/*</span>
00572 <span class="comment">         * Always destroy? then don't do any checking...</span>
00573 <span class="comment">         */</span>
00574         <span class="keywordflow">break</span>;
00575 
00576     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a532">CURSOR_CALLFROMCLIENT</a>:
00577 
00578         <span class="comment">/*</span>
00579 <span class="comment">         * Can't destroy public cursors/icons.</span>
00580 <span class="comment">         */</span>
00581         <span class="keywordflow">if</span> (ppiCursor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00582             <span class="comment">/*</span>
00583 <span class="comment">             * Fake success if its a resource loaded icon because</span>
00584 <span class="comment">             * this is how win95 responded.</span>
00585 <span class="comment">             */</span>
00586             <span class="keywordflow">return</span> !!(pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a534">CURSORF_FROMRESOURCE</a>);
00587 
00588         <span class="comment">/*</span>
00589 <span class="comment">         * If this cursor was loaded from a resource, don't free it till the</span>
00590 <span class="comment">         * process exits.  This is the way we stay compatible with win3.0's</span>
00591 <span class="comment">         * cursors which were actually resources.  Resources under win3 have</span>
00592 <span class="comment">         * reference counting and other "features" like handle values that</span>
00593 <span class="comment">         * never change.  Read more in the comment in</span>
00594 <span class="comment">         * ServerLoadCreateCursorIcon().</span>
00595 <span class="comment">         */</span>
00596         <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a536">CURSORF_LRSHARED</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a540">CURSORF_SECRET</a>)) {
00597             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00598         }
00599 
00600         <span class="comment">/*</span>
00601 <span class="comment">         * One thread can't destroy the objects created by another.</span>
00602 <span class="comment">         */</span>
00603         <span class="keywordflow">if</span> (ppiCursor != ppi) {
00604             RIPERR0(ERROR_DESTROY_OBJECT_OF_OTHER_THREAD, RIP_ERROR, <span class="stringliteral">"DestroyCursor: cursor belongs to another process"</span>);
00605             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00606         }
00607 
00608         <span class="comment">/*</span>
00609 <span class="comment">         * fall through.</span>
00610 <span class="comment">         */</span>
00611 
00612     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a533">CURSOR_THREADCLEANUP</a>:
00613 
00614         <span class="comment">/*</span>
00615 <span class="comment">         * Don't destroy public objects either (pretend it worked though).</span>
00616 <span class="comment">         */</span>
00617         <span class="keywordflow">if</span> (ppiCursor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00618             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00619         <span class="keywordflow">break</span>;
00620     }
00621 
00622     <span class="comment">/*</span>
00623 <span class="comment">     * First mark the object for destruction.  This tells the locking code that</span>
00624 <span class="comment">     * we want to destroy this object when the lock count goes to 0.  If this</span>
00625 <span class="comment">     * returns FALSE, we can't destroy the object yet.</span>
00626 <span class="comment">     */</span>
00627     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)pcur))
00628         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00629 
00630     <span class="keywordflow">if</span> (pcur-&gt;strName.Length != 0) {
00631         UserFreePool((LPSTR)pcur-&gt;strName.Buffer);
00632     }
00633 
00634     <span class="keywordflow">if</span> (pcur-&gt;atomModName != 0) {
00635         <a class="code" href="../../d4/d1/userk_8h.html#a1299">UserDeleteAtom</a>(pcur-&gt;atomModName);
00636     }
00637 
00638     <span class="comment">/*</span>
00639 <span class="comment">     * If this is an ACON call its special routine to destroy it.</span>
00640 <span class="comment">     */</span>
00641     <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
00642         <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a7">DestroyAniIcon</a>((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcur);
00643     } <span class="keywordflow">else</span> {
00644         <span class="keywordflow">if</span> (pcur-&gt;hbmMask != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00645             GreDeleteObject(pcur-&gt;hbmMask);
00646             GreDecQuotaCount((PW32PROCESS)(pcur-&gt;head.ppi));
00647         }
00648         <span class="keywordflow">if</span> (pcur-&gt;hbmColor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00649             GreDeleteObject(pcur-&gt;hbmColor);
00650             GreDecQuotaCount((PW32PROCESS)(pcur-&gt;head.ppi));
00651         }
00652         <span class="keywordflow">if</span> (pcur-&gt;hbmAlpha != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00653             <span class="comment">/*</span>
00654 <span class="comment">             * This is an internal GDI object, and so not covered by quota.</span>
00655 <span class="comment">             */</span>
00656             GreDeleteObject(pcur-&gt;hbmAlpha);
00657         }
00658     }
00659 
00660     <span class="comment">/*</span>
00661 <span class="comment">     * Ok to destroy...  Free the handle (which will free the object and the</span>
00662 <span class="comment">     * handle).</span>
00663 <span class="comment">     */</span>
00664     <a class="code" href="../../d7/d4/loadbits_8c.html#a2">DestroyEmptyCursorObject</a>(pcur);
00665     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00666 }
00667 
00668 
00669 
00670 <span class="comment">/***************************************************************************\</span>
00671 <span class="comment">* DestroyUnlockedCursor</span>
00672 <span class="comment">*</span>
00673 <span class="comment">* Called when a cursor is destoyed due to an unlock.</span>
00674 <span class="comment">*</span>
00675 <span class="comment">* History:</span>
00676 <span class="comment">* 24-Feb-1997 adams     Created.</span>
00677 <span class="comment">\***************************************************************************/</span>
00678 
00679 <span class="keywordtype">void</span>
<a name="l00680"></a><a class="code" href="../../d4/d1/userk_8h.html#a1781">00680</a> <a class="code" href="../../d4/d1/userk_8h.html#a1781">DestroyUnlockedCursor</a>(<span class="keywordtype">void</span> * pv)
00681 {
00682     <a class="code" href="../../d4/d1/userk_8h.html#a1782">_DestroyCursor</a>((<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)pv, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a533">CURSOR_THREADCLEANUP</a>);
00683 }
00684 
00685 
00686 
00687 <span class="comment">/***************************************************************************\</span>
00688 <span class="comment">* _SetCursorContents</span>
00689 <span class="comment">*</span>
00690 <span class="comment">*</span>
00691 <span class="comment">* History:</span>
00692 <span class="comment">* 27-Apr-1992 ScottLu   Created.</span>
00693 <span class="comment">\***************************************************************************/</span>
00694 
<a name="l00695"></a><a class="code" href="../../d4/d1/userk_8h.html#a1789">00695</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1789">_SetCursorContents</a>(
00696     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur,
00697     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurNew)
00698 {
00699     HBITMAP hbmpT;
00700 
00701     <span class="keywordflow">if</span> (!(pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>)) {
00702 
00703         <span class="comment">/*</span>
00704 <span class="comment">         * Swap bitmaps.</span>
00705 <span class="comment">         */</span>
00706         hbmpT = pcur-&gt;hbmMask;
00707         pcur-&gt;hbmMask = pcurNew-&gt;hbmMask;
00708         pcurNew-&gt;hbmMask = hbmpT;
00709 
00710         hbmpT = pcur-&gt;hbmColor;
00711         pcur-&gt;hbmColor = pcurNew-&gt;hbmColor;
00712         pcurNew-&gt;hbmColor = hbmpT;
00713 
00714         <span class="comment">/*</span>
00715 <span class="comment">         * Remember hotspot info and size info</span>
00716 <span class="comment">         */</span>
00717         pcur-&gt;xHotspot = pcurNew-&gt;xHotspot;
00718         pcur-&gt;yHotspot = pcurNew-&gt;yHotspot;
00719         pcur-&gt;cx = pcurNew-&gt;cx;
00720         pcur-&gt;cy = pcurNew-&gt;cy;
00721     }
00722 
00723     <span class="comment">/*</span>
00724 <span class="comment">     * Destroy the cursor we copied from.</span>
00725 <span class="comment">     */</span>
00726     <a class="code" href="../../d4/d1/userk_8h.html#a1782">_DestroyCursor</a>(pcurNew, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a533">CURSOR_THREADCLEANUP</a>);
00727 
00728     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00729 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
