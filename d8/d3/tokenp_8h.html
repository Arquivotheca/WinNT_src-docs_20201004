<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokenp.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokenp.h File Reference</h1><code>#include "<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>"</code><br>
<code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "seopaque.h"</code><br>

<p>
<a href="../../d9/d2/tokenp_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/struct__TOKEN.html">_TOKEN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">_IOBJECT_TYPE_LIST</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a0">IF_TOKEN_GLOBAL</a>(FlagName)&nbsp;&nbsp;&nbsp;if (FALSE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a1">TokenDiagPrint</a>(FlagName, _Text_)&nbsp;&nbsp;&nbsp;;</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a2">TOKEN_DIAG_TOKEN_LOCKS</a>&nbsp;&nbsp;&nbsp;((ULONG) 0x00000001L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a3">TOKEN_DEFAULT_DYNAMIC_CHARGE</a>&nbsp;&nbsp;&nbsp;500</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a4">OBJECT_SUCCESS_AUDIT</a>&nbsp;&nbsp;&nbsp;0x1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a5">OBJECT_FAILURE_AUDIT</a>&nbsp;&nbsp;&nbsp;0x2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>(T)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>(T)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>(T)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>(T, M)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a10">SepArrayPrivilegeAttributes</a>(P, I)&nbsp;&nbsp;&nbsp;( (P)[I].Attributes )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(T, I)&nbsp;&nbsp;&nbsp;( (T)-&gt;Privileges[I].Attributes )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a12">SepArrayGroupAttributes</a>(G, I)&nbsp;&nbsp;&nbsp;( (G)[I].Attributes )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(T, I)&nbsp;&nbsp;&nbsp;( (T)-&gt;UserAndGroups[I].Attributes )</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d1/struct__TOKEN.html">_TOKEN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a14">TOKEN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d1/struct__TOKEN.html">_TOKEN</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">_IOBJECT_TYPE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a16">IOBJECT_TYPE_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">_IOBJECT_TYPE_LIST</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a17">PIOBJECT_TYPE_LIST</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a21">SeCaptureObjectTypeList</a> (IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, OUT <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> *CapturedObjectTypeList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a22">SeFreeCapturedObjectTypeList</a> (IN PVOID ObjectTypeList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a23">SepAdjustGroups</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN BOOLEAN MakeChanges, IN BOOLEAN ResetToDefault, IN ULONG GroupCount OPTIONAL, IN PSID_AND_ATTRIBUTES NewState OPTIONAL, OUT PTOKEN_GROUPS PreviousState OPTIONAL, OUT PSID SidBuffer OPTIONAL, OUT PULONG ReturnLength, OUT PULONG ChangeCount, OUT PBOOLEAN <a class="el" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a24">SepAdjustPrivileges</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN BOOLEAN MakeChanges, IN BOOLEAN DisableAllPrivileges, IN ULONG PrivilegeCount OPTIONAL, IN PLUID_AND_ATTRIBUTES NewState OPTIONAL, OUT PTOKEN_PRIVILEGES PreviousState OPTIONAL, OUT PULONG ReturnLength, OUT PULONG ChangeCount, OUT PBOOLEAN <a class="el" href="../../d8/d1/fdengine_8c.html#a8">ChangesMade</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a25">SepAppendDefaultDacl</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN PACL PAcl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a26">SepAppendPrimaryGroup</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN PSID PSid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a27">SepDuplicateToken</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> ExistingToken, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, IN BOOLEAN EffectiveOnly, IN TOKEN_TYPE TokenType, IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, OUT <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> *DuplicateToken)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a28">SepFilterToken</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> ExistingToken, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN ULONG Flags, IN ULONG GroupCount, IN PSID_AND_ATTRIBUTES GroupsToDisable OPTIONAL, IN ULONG PrivilegeCount, IN PLUID_AND_ATTRIBUTES PrivilegesToDelete OPTIONAL, IN ULONG SidCount, IN PSID_AND_ATTRIBUTES RestrictedSids OPTIONAL, IN ULONG SidLength, OUT <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> *FilteredToken)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a29">SepSidInSidAndAttributes</a> (IN PSID_AND_ATTRIBUTES SidAndAttributes, IN ULONG SidCount, IN PSID PrincipalSelfSid, IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a30">SepRemoveDisabledGroupsAndPrivileges</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN ULONG Flags, IN ULONG GroupCount, IN PSID_AND_ATTRIBUTES GroupsToDisable, IN ULONG PrivilegeCount, IN PLUID_AND_ATTRIBUTES PrivilegesToDelete)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a31">SepFreeDefaultDacl</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a32">SepFreePrimaryGroup</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a33">SepIdAssignableAsOwner</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a34">SepMakeTokenEffectiveOnly</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a35">SepTokenInitialization</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a36">SepTokenDeleteMethod</a> (IN PVOID <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a37">SepPrivilegeCheck</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN OUT PLUID_AND_ATTRIBUTES RequiredPrivileges, IN ULONG RequiredPrivilegeCount, IN ULONG PrivilegeSetControl, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a38">SepAccessCheck</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN PSID PrincipalSelfSid, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a> OPTIONAL, IN ACCESS_MASK DesiredAccess, IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PGENERIC_MAPPING GenericMapping, IN ACCESS_MASK PreviouslyGrantedAccess, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PACCESS_MASK GrantedAccess, OUT PPRIVILEGE_SET *Privileges OPTIONAL, OUT PNTSTATUS AccessStatus, IN BOOLEAN ReturnResultList, OUT PBOOLEAN ReturnSomeAccessGranted, OUT PBOOLEAN ReturnSomeAccessDenied)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a> (IN GUID *ObjectType, IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList, IN ULONG ObjectTypeListLength, OUT PULONG ReturnedIndex)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a18">SepTokenMapping</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a19">SepTokenObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/tokenp_8h.html#a20">SepTokenLock</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="tokenp.h::IF_TOKEN_GLOBAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IF_TOKEN_GLOBAL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">FlagName&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;if (FALSE)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00087">87</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="tokenp.h::OBJECT_FAILURE_AUDIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBJECT_FAILURE_AUDIT&nbsp;&nbsp;&nbsp;0x2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00377">377</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04093">SepAuditTypeList()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04179">SepSetAuditInfoForObjectType()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="tokenp.h::OBJECT_SUCCESS_AUDIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBJECT_SUCCESS_AUDIT&nbsp;&nbsp;&nbsp;0x1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00376">376</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04093">SepAuditTypeList()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04179">SepSetAuditInfoForObjectType()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="tokenp.h::SepAcquireTokenReadLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepAcquireTokenReadLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();          \
                                    <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;SepTokenLock, TRUE)
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">413</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00046">NtDuplicateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01306">NtFilterToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">SeFilterToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00475">SeGetTokenControlInformation()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02867">SeIsChildToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02960">SeIsChildTokenByPointer()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00306">SepIdAssignableAsGroup()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00038">SepPrivilegeCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03796">SepTokenIsOwner()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00381">SepValidOwnerSubjectContext()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01152">SeQueryAuthenticationIdToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01189">SeQueryInformationToken()</a>, and <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01763">SeQuerySessionIdToken()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="tokenp.h::SepAcquireTokenWriteLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepAcquireTokenWriteLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();          \
                                    <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;SepTokenLock, TRUE)
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00416">416</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00432">NtAdjustGroupsToken()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00046">NtAdjustPrivilegesToken()</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>, and <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00851">SeSetSessionIdToken()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="tokenp.h::SepArrayGroupAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepArrayGroupAttributes          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">G,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>I&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( (G)[I].Attributes )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00479">479</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l01099">SepAdjustGroups()</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="tokenp.h::SepArrayPrivilegeAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepArrayPrivilegeAttributes          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">P,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>I&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( (P)[I].Attributes )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00460">460</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00819">SepAdjustPrivileges()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="tokenp.h::SepReleaseTokenReadLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepReleaseTokenReadLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;SepTokenLock);  \
                                    <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>()
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">419</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00046">NtDuplicateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01306">NtFilterToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">SeFilterToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00475">SeGetTokenControlInformation()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02867">SeIsChildToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02960">SeIsChildTokenByPointer()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00306">SepIdAssignableAsGroup()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00038">SepPrivilegeCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03796">SepTokenIsOwner()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00381">SepValidOwnerSubjectContext()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01152">SeQueryAuthenticationIdToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01189">SeQueryInformationToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01763">SeQuerySessionIdToken()</a>, and <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="tokenp.h::SepReleaseTokenWriteLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepReleaseTokenWriteLock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">T,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>M&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                    \
      <span class="keywordflow">if</span> ((M)) {                                                         \
          <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;((PTOKEN)(T))-&gt;ModifiedId  );      \
      }                                                                  \
      <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( T );                                      \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00444">444</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00432">NtAdjustGroupsToken()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00046">NtAdjustPrivilegesToken()</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>, and <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00851">SeSetSessionIdToken()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="tokenp.h::SepTokenGroupAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepTokenGroupAttributes          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">T,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>I&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( (T)-&gt;UserAndGroups[I].Attributes )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00489">489</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l01099">SepAdjustGroups()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02813">SepIdAssignableAsOwner()</a>, and <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00806">SepMakeTokenEffectiveOnly()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="tokenp.h::SepTokenPrivilegeAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepTokenPrivilegeAttributes          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">T,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>I&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( (T)-&gt;Privileges[I].Attributes )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00470">470</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00819">SepAdjustPrivileges()</a>, and <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00806">SepMakeTokenEffectiveOnly()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="tokenp.h::TOKEN_DEFAULT_DYNAMIC_CHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TOKEN_DEFAULT_DYNAMIC_CHARGE&nbsp;&nbsp;&nbsp;500          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00124">124</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="tokenp.h::TOKEN_DIAG_TOKEN_LOCKS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TOKEN_DIAG_TOKEN_LOCKS&nbsp;&nbsp;&nbsp;((ULONG) 0x00000001L)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00108">108</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="tokenp.h::TokenDiagPrint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TokenDiagPrint          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">FlagName,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_Text_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;;</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00093">93</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a16" doxytag="tokenp.h::IOBJECT_TYPE_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">_IOBJECT_TYPE_LIST</a>  <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l00144">SeCaptureObjectTypeList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="tokenp.h::PIOBJECT_TYPE_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">_IOBJECT_TYPE_LIST</a> * <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="tokenp.h::PTOKEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d1/struct__TOKEN.html">_TOKEN</a> *  <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="tokenp.h::TOKEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d1/struct__TOKEN.html">_TOKEN</a>  <a class="el" href="../../d8/d1/struct__TOKEN.html">TOKEN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d2/parseini_8c-source.html#l00744">CmpParseInfBuffer()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a21" doxytag="tokenp.h::SeCaptureObjectTypeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeCaptureObjectTypeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_TYPE_LIST ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedObjectTypeList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00144">144</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00382">_IOBJECT_TYPE_LIST::CurrentDenied</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00381">_IOBJECT_TYPE_LIST::CurrentGranted</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00375">_IOBJECT_TYPE_LIST::Flags</a>, <a class="el" href="../../d8/d3/tokenp_8h.html#a16">IOBJECT_TYPE_LIST</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00242">IsValidElementCount</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00374">_IOBJECT_TYPE_LIST::Level</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00378">_IOBJECT_TYPE_LIST::ObjectType</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00379">_IOBJECT_TYPE_LIST::ParentIndex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00380">_IOBJECT_TYPE_LIST::Remaining</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00152                    :
00153 
00154     This routine probes and captures a copy of any object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list
00155     that might have been provided via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectTypeList argument.
00156 
00157     The object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> converted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> internal form that explicitly
00158     specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hierarchical relationship between <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries.
00159 
00160     The object typs list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> validated to ensure a valid hierarchical
00161     relationship <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> represented.
00162 
00163 Arguments:
00164 
00165     ObjectTypeList - The object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list
00166         information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be retrieved.
00167 
00168     ObjectTypeListLength - Number of elements in ObjectTypeList
00169 
00170     RequestorMode - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode by which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access
00171         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being requested.
00172 
00173     CapturedObjectTypeList - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> captured <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list which
00174         must be freed <span class="keyword">using</span> <a class="code" href="../../d8/d3/tokenp_8h.html#a22">SeFreeCapturedObjectTypeList</a>().
00175 
00176 Return Value:
00177 
00178     STATUS_SUCCESS indicates no exceptions were encountered.
00179 
00180     Any access violations encountered will be returned.
00181 
00182 --*/
00183 
00184 {
00185     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00186     ULONG i;
00187     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00188 
00189     ULONG Levels[ACCESS_MAX_LEVEL+1];
00190 
00191     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">//  Set default return</span>
00195     <span class="comment">//</span>
00196 
00197     *CapturedObjectTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00198 
00199     <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00200         <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00201     }
00202 
00203     <span class="keywordflow">try</span> {
00204 
00205         <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
00206 
00207             <span class="comment">// Drop through</span>
00208 
00209         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT(ObjectTypeList) ) {
00210 
00211             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00212 
00213         } <span class="keywordflow">else</span> {
00214 
00215             <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>( ObjectTypeListLength, <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a> ) )
00216             {
00217                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER ;
00218 
00219                 <span class="comment">//</span>
00220                 <span class="comment">// No more to do, get out of the try statement:</span>
00221                 <span class="comment">//</span>
00222 
00223                 leave ;
00224             }
00225 
00226             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( ObjectTypeList,
00227                           <span class="keyword">sizeof</span>(OBJECT_TYPE_LIST) * ObjectTypeListLength,
00228                           <span class="keyword">sizeof</span>(ULONG)
00229                           );
00230 
00231             <span class="comment">//</span>
00232             <span class="comment">// Allocate a buffer to copy into.</span>
00233             <span class="comment">//</span>
00234 
00235             LocalTypeList = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a>) * ObjectTypeListLength, 'tOeS' );
00236 
00237             <span class="keywordflow">if</span> ( LocalTypeList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00238                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00239 
00240             <span class="comment">//</span>
00241             <span class="comment">// Copy the callers structure to the local structure.</span>
00242             <span class="comment">//</span>
00243 
00244             } <span class="keywordflow">else</span> {
00245                 GUID * CapturedObjectType;
00246                 <span class="keywordflow">for</span> ( i=0; i&lt;ObjectTypeListLength; i++ ) {
00247                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> CurrentLevel;
00248 
00249                     <span class="comment">//</span>
00250                     <span class="comment">// Limit ourselves</span>
00251                     <span class="comment">//</span>
00252                     CurrentLevel = ObjectTypeList[i].Level;
00253                     <span class="keywordflow">if</span> ( CurrentLevel &gt; ACCESS_MAX_LEVEL ) {
00254                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00255                         <span class="keywordflow">break</span>;
00256                     }
00257 
00258                     <span class="comment">//</span>
00259                     <span class="comment">// Copy data the caller passed in</span>
00260                     <span class="comment">//</span>
00261                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o0">Level</a> = CurrentLevel;
00262                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o1">Flags</a> = 0;
00263                     CapturedObjectType = ObjectTypeList[i].ObjectType;
00264                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00265                         CapturedObjectType,
00266                         <span class="keyword">sizeof</span>(GUID),
00267                         <span class="keyword">sizeof</span>(ULONG)
00268                         );
00269                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o2">ObjectType</a> = *CapturedObjectType;
00270                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> = 0;
00271                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a> = 0;
00272                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o6">CurrentDenied</a> = 0;
00273 
00274                     <span class="comment">//</span>
00275                     <span class="comment">// Ensure that the level number is consistent with the</span>
00276                     <span class="comment">//  level number of the previous entry.</span>
00277                     <span class="comment">//</span>
00278 
00279                     <span class="keywordflow">if</span> ( i == 0 ) {
00280                         <span class="keywordflow">if</span> ( CurrentLevel != 0 ) {
00281                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00282                             <span class="keywordflow">break</span>;
00283                         }
00284 
00285                     } <span class="keywordflow">else</span> {
00286 
00287                         <span class="comment">//</span>
00288                         <span class="comment">// The previous entry is either:</span>
00289                         <span class="comment">//  my immediate parent,</span>
00290                         <span class="comment">//  my sibling, or</span>
00291                         <span class="comment">//  the child (or grandchild, etc.) of my sibling.</span>
00292                         <span class="comment">//</span>
00293                         <span class="keywordflow">if</span> ( CurrentLevel &gt; LocalTypeList[i-1].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o0">Level</a> + 1 ) {
00294                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00295                             <span class="keywordflow">break</span>;
00296                         }
00297 
00298                         <span class="comment">//</span>
00299                         <span class="comment">// Don't support two roots.</span>
00300                         <span class="comment">//</span>
00301                         <span class="keywordflow">if</span> ( CurrentLevel == 0 ) {
00302                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00303                             <span class="keywordflow">break</span>;
00304                         }
00305 
00306                     }
00307 
00308                     <span class="comment">//</span>
00309                     <span class="comment">// If the above rules are maintained,</span>
00310                     <span class="comment">//  then my parent object is the last object seen that</span>
00311                     <span class="comment">//  has a level one less than mine.</span>
00312                     <span class="comment">//</span>
00313 
00314                     <span class="keywordflow">if</span> ( CurrentLevel == 0 ) {
00315                         LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o3">ParentIndex</a> = -1;
00316                     } <span class="keywordflow">else</span> {
00317                         LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o3">ParentIndex</a> = Levels[CurrentLevel-1];
00318                     }
00319 
00320                     <span class="comment">//</span>
00321                     <span class="comment">// Save this obect as the last object seen at this level.</span>
00322                     <span class="comment">//</span>
00323 
00324                     Levels[CurrentLevel] = i;
00325 
00326                 }
00327 
00328             }
00329 
00330         } <span class="comment">// end_if</span>
00331 
00332     } except(EXCEPTION_EXECUTE_HANDLER) {
00333 
00334 
00335         <span class="comment">//</span>
00336         <span class="comment">// If we captured any proxy data, we need to free it now.</span>
00337         <span class="comment">//</span>
00338 
00339         <span class="keywordflow">if</span> ( LocalTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00340             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LocalTypeList );
00341             LocalTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00342         }
00343 
00344         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00345     } <span class="comment">// end_try</span>
00346 
00347     *CapturedObjectTypeList = LocalTypeList;
00348     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00349 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="tokenp.h::SeFreeCapturedObjectTypeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeFreeCapturedObjectTypeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectTypeList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00353">353</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00359                    :
00360 
00361     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data associated with a captured ObjectTypeList
00362     structure.
00363 
00364 Arguments:
00365 
00366     ObjectTypeList - Points to a captured object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list structure.
00367 
00368 Return Value:
00369 
00370     None.
00371 
00372 --*/
00373 
00374 {
00375     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00376 
00377     <span class="keywordflow">if</span> ( ObjectTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00378         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectTypeList );
00379     }
00380 
00381     <span class="keywordflow">return</span>;
00382 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="tokenp.h::SepAccessCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAccessCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviouslyGrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET *Privileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnResultList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnSomeAccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnSomeAccessDenied</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">1564</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00381">_IOBJECT_TYPE_LIST::CurrentGranted</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00380">_IOBJECT_TYPE_LIST::Remaining</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00650">SeAssertMappedCanonicalAccess</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00574">SepAddAccessTypeList()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l01071">SepAssemblePrivileges()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00650">SepDumpSecurityDescriptor()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00995">SepDumpTokenInfo()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00992">SepMaximumAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l01304">SepNormalAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00388">SepObjectInTypeList()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00733">SepSidInToken()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00143">SepSinglePrivilegeCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01676">SeSecurityPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01677">SeTakeOwnershipPrivilege</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00181">SeTokenIsRestricted()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>01585                    :
01586 
01587     Worker routine <span class="keywordflow">for</span> <a class="code" href="../../d0/d5/se_8h.html#a135">SeAccessCheck</a> and <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a>.  We actually <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01588     access checking here.
01589 
01590     Whether or not we actually evaluate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following
01591     interaction between <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SE_DACL_PRESENT bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01592     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL pointer itself.
01593 
01594 
01595                           SE_DACL_PRESENT
01596 
01597                         <a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a>          CLEAR
01598 
01599                    +-------------+-------------+
01600                    |             |             |
01601              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  |    GRANT    |    GRANT    |
01602                    |     <a class="code" href="../../d0/d2/usrbench_8h.html#a13">ALL</a>     |     <a class="code" href="../../d0/d2/usrbench_8h.html#a13">ALL</a>     |
01603      DACL          |             |             |
01604      Pointer       +-------------+-------------+
01605                    |             |             |
01606             !<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  |  EVALUATE   |    GRANT    |
01607                    |    ACL      |     <a class="code" href="../../d0/d2/usrbench_8h.html#a13">ALL</a>     |
01608                    |             |             |
01609                    +-------------+-------------+
01610 
01611 Arguments:
01612 
01613     SecurityDescriptor - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01614         being accessed.
01615 
01616     PrincipalSelfSid - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being access checked <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an object which
01617         represents a principal (e.g., a user object), <span class="keyword">this</span> parameter should
01618         be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  Any ACE containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constant
01619         PRINCIPAL_SELF_SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced by <span class="keyword">this</span> SID.
01620 
01621         The parameter should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object does not represent a principal.
01622 
01623     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to user's token object.
01624 
01625     TokenLocked - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> describing whether or not there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a read lock
01626         on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01627 
01628     DesiredAccess - Access mask describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01629         object.  This mask <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed not to contain generic access types.
01630 
01631     ObjectTypeList - Supplies a list of GUIDs representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object (and
01632         sub-objects) being accessed.  If no list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present, AccessCheckByType
01633         behaves identically to AccessCheck.
01634 
01635     ObjectTypeListLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectTypeList.
01636 
01637     GenericMapping - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated
01638         with <span class="keyword">this</span> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
01639 
01640     PreviouslyGrantedAccess - Access mask indicating any access' that have
01641         already been granted by higher level <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
01642 
01643     PrivilgedAccessMask - Mask describing access types that may not be
01644         granted without a privilege.
01645 
01646     GrantedAccess - Returns an access mask describing all granted access',
01647         or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
01648 
01649     Privileges - Optionally supplies a pointer in which will be returned
01650         any privileges that were used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access.  If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> null,
01651         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will be assumed that privilege checks have been done already.
01652 
01653     AccessStatus - Returns STATUS_SUCCESS or other error code to be
01654         propogated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
01655 
01656     ReturnResultList - If <span class="keyword">true</span>, GrantedAccess and AccessStatus <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually
01657         an array of entries ObjectTypeListLength elements <span class="keywordtype">long</span>.
01658 
01659     ReturnSomeAccessGranted - Returns a value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to indicate that some access'
01660         were granted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01661 
01662     ReturnSomeAccessDenied - Returns a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> some of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01663         access was not granted.  This will alway be an inverse of SomeAccessGranted
01664         unless ReturnResultList <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  In that <span class="keywordflow">case</span>,
01665 
01666 Return Value:
01667 
01668     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that some access' were granted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01669     otherwise.
01670 
01671 --*/
01672 {
01673     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01674     ACCESS_MASK Remaining;
01675 
01676 
01677     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01678 
01679     PVOID Ace;
01680     ULONG AceCount;
01681 
01682     ULONG i;
01683     ULONG j;
01684     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01685     ULONG PrivilegeCount = 0;
01686     BOOLEAN Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01687     BOOLEAN SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01688     BOOLEAN WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01689     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> EToken;
01690 
01691     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a> FixedTypeList;
01692     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList;
01693     ULONG LocalTypeListLength;
01694     ULONG ResultListIndex;
01695 
01696     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01697 
01698 <span class="preprocessor">#if DBG</span>
01699 <span class="preprocessor"></span>
01700     <a class="code" href="../../d6/d6/sep_8h.html#a57">SepDumpSecurityDescriptor</a>(
01701         SecurityDescriptor,
01702         <span class="stringliteral">"Input to SeAccessCheck\n"</span>
01703         );
01704 
01705     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientToken )) {
01706         <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>( ClientToken );
01707     }
01708 
01709     <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>( PrimaryToken );
01710 
01711 <span class="preprocessor">#endif</span>
01712 <span class="preprocessor"></span>
01713 
01714     EToken = ARGUMENT_PRESENT( ClientToken ) ? <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> : <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
01715 
01716     <span class="comment">//</span>
01717     <span class="comment">// Assert that there are no generic accesses in the DesiredAccess</span>
01718     <span class="comment">//</span>
01719 
01720     <a class="code" href="../../d0/d5/se_8h.html#a14">SeAssertMappedCanonicalAccess</a>( DesiredAccess );
01721 
01722     Remaining = DesiredAccess;
01723 
01724 
01725     <span class="comment">//</span>
01726     <span class="comment">// Check for ACCESS_SYSTEM_SECURITY here,</span>
01727     <span class="comment">// fail if he's asking for it and doesn't have</span>
01728     <span class="comment">// the privilege.</span>
01729     <span class="comment">//</span>
01730 
01731     <span class="keywordflow">if</span> ( Remaining &amp; ACCESS_SYSTEM_SECURITY ) {
01732 
01733         <span class="comment">//</span>
01734         <span class="comment">// Bugcheck if we weren't given a pointer to return privileges</span>
01735         <span class="comment">// into.  Our caller was supposed to have taken care of this</span>
01736         <span class="comment">// in that case.</span>
01737         <span class="comment">//</span>
01738 
01739         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ARGUMENT_PRESENT( Privileges ));
01740 
01741         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
01742                     SeSecurityPrivilege,
01743                     EToken,
01744                     PreviousMode
01745                     );
01746 
01747         <span class="keywordflow">if</span> (!Success) {
01748             PreviouslyGrantedAccess = 0;
01749             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
01750             <span class="keywordflow">goto</span> ReturnOneStatus;
01751         }
01752 
01753         <span class="comment">//</span>
01754         <span class="comment">// Success, remove ACCESS_SYSTEM_SECURITY from remaining, add it</span>
01755         <span class="comment">// to PreviouslyGrantedAccess</span>
01756         <span class="comment">//</span>
01757 
01758         Remaining &amp;= ~ACCESS_SYSTEM_SECURITY;
01759         PreviouslyGrantedAccess |= ACCESS_SYSTEM_SECURITY;
01760 
01761         PrivilegeCount++;
01762         SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01763 
01764         <span class="keywordflow">if</span> ( Remaining == 0 ) {
01765             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01766             <span class="keywordflow">goto</span> ReturnOneStatus;
01767         }
01768 
01769     }
01770 
01771 
01772     <span class="comment">//</span>
01773     <span class="comment">// Get pointer to client SID's</span>
01774     <span class="comment">//</span>
01775 
01776     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor );
01777 
01778     <span class="comment">//</span>
01779     <span class="comment">//  If the SE_DACL_PRESENT bit is not set, the object has no</span>
01780     <span class="comment">//  security, so all accesses are granted.  If he's asking for</span>
01781     <span class="comment">//  MAXIMUM_ALLOWED, return the GENERIC_ALL field from the generic</span>
01782     <span class="comment">//  mapping.</span>
01783     <span class="comment">//</span>
01784     <span class="comment">//  Also grant all access if the Dacl is NULL.</span>
01785     <span class="comment">//</span>
01786 
01787     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet(
01788              (PISECURITY_DESCRIPTOR)SecurityDescriptor,
01789              SE_DACL_PRESENT) || (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01790 
01791 
01792         <span class="comment">//</span>
01793         <span class="comment">// Restricted tokens treat a NULL dacl the same as a DACL with no</span>
01794         <span class="comment">// ACEs.</span>
01795         <span class="comment">//</span>
01796 <span class="preprocessor">#ifdef SECURE_NULL_DACLS</span>
01797 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( EToken )) {
01798             <span class="comment">//</span>
01799             <span class="comment">// We know that Remaining != 0 here, because we</span>
01800             <span class="comment">// know it was non-zero coming into this routine,</span>
01801             <span class="comment">// and we've checked it against 0 every time we've</span>
01802             <span class="comment">// cleared a bit.</span>
01803             <span class="comment">//</span>
01804 
01805             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Remaining != 0 );
01806 
01807             <span class="comment">//</span>
01808             <span class="comment">// There are ungranted accesses.  Since there is</span>
01809             <span class="comment">// nothing in the DACL, they will not be granted.</span>
01810             <span class="comment">// If, however, the only ungranted access at this</span>
01811             <span class="comment">// point is MAXIMUM_ALLOWED, and something has been</span>
01812             <span class="comment">// granted in the PreviouslyGranted mask, return</span>
01813             <span class="comment">// what has been granted.</span>
01814             <span class="comment">//</span>
01815 
01816             <span class="keywordflow">if</span> ( (Remaining == MAXIMUM_ALLOWED) &amp;&amp; (PreviouslyGrantedAccess != (ACCESS_MASK)0) ) {
01817                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01818                 <span class="keywordflow">goto</span> ReturnOneStatus;
01819 
01820             } <span class="keywordflow">else</span> {
01821                 PreviouslyGrantedAccess = 0;
01822                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01823                 <span class="keywordflow">goto</span> ReturnOneStatus;
01824             }
01825         }
01826 <span class="preprocessor">#endif //SECURE_NULL_DACLS</span>
01827 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (DesiredAccess &amp; MAXIMUM_ALLOWED) {
01828 
01829             <span class="comment">//</span>
01830             <span class="comment">// Give him:</span>
01831             <span class="comment">//   GenericAll</span>
01832             <span class="comment">//   Anything else he asked for</span>
01833             <span class="comment">//</span>
01834 
01835             PreviouslyGrantedAccess =
01836                 GenericMapping-&gt;GenericAll |
01837                 (DesiredAccess | PreviouslyGrantedAccess) &amp; ~MAXIMUM_ALLOWED;
01838 
01839         } <span class="keywordflow">else</span> {
01840 
01841             PreviouslyGrantedAccess |= DesiredAccess;
01842         }
01843 
01844         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01845         <span class="keywordflow">goto</span> ReturnOneStatus;
01846     }
01847 
01848     <span class="comment">//</span>
01849     <span class="comment">// There is security on this object.  Check to see</span>
01850     <span class="comment">// if he's asking for WRITE_OWNER, and perform the</span>
01851     <span class="comment">// privilege check if so.</span>
01852     <span class="comment">//</span>
01853 
01854     <span class="keywordflow">if</span> ( (Remaining &amp; WRITE_OWNER) &amp;&amp; ARGUMENT_PRESENT( Privileges ) ) {
01855 
01856         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
01857                     SeTakeOwnershipPrivilege,
01858                     EToken,
01859                     PreviousMode
01860                     );
01861 
01862         <span class="keywordflow">if</span> (Success) {
01863 
01864             <span class="comment">//</span>
01865             <span class="comment">// Success, remove WRITE_OWNER from remaining, add it</span>
01866             <span class="comment">// to PreviouslyGrantedAccess</span>
01867             <span class="comment">//</span>
01868 
01869             Remaining &amp;= ~WRITE_OWNER;
01870             PreviouslyGrantedAccess |= WRITE_OWNER;
01871 
01872             PrivilegeCount++;
01873             WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01874 
01875             <span class="keywordflow">if</span> ( Remaining == 0 ) {
01876                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01877                 <span class="keywordflow">goto</span> ReturnOneStatus;
01878             }
01879         }
01880     }
01881 
01882 
01883     <span class="comment">//</span>
01884     <span class="comment">// If the DACL is empty,</span>
01885     <span class="comment">// deny all access immediately.</span>
01886     <span class="comment">//</span>
01887 
01888     <span class="keywordflow">if</span> ((AceCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount) == 0) {
01889 
01890         <span class="comment">//</span>
01891         <span class="comment">// We know that Remaining != 0 here, because we</span>
01892         <span class="comment">// know it was non-zero coming into this routine,</span>
01893         <span class="comment">// and we've checked it against 0 every time we've</span>
01894         <span class="comment">// cleared a bit.</span>
01895         <span class="comment">//</span>
01896 
01897         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Remaining != 0 );
01898 
01899         <span class="comment">//</span>
01900         <span class="comment">// There are ungranted accesses.  Since there is</span>
01901         <span class="comment">// nothing in the DACL, they will not be granted.</span>
01902         <span class="comment">// If, however, the only ungranted access at this</span>
01903         <span class="comment">// point is MAXIMUM_ALLOWED, and something has been</span>
01904         <span class="comment">// granted in the PreviouslyGranted mask, return</span>
01905         <span class="comment">// what has been granted.</span>
01906         <span class="comment">//</span>
01907 
01908         <span class="keywordflow">if</span> ( (Remaining == MAXIMUM_ALLOWED) &amp;&amp; (PreviouslyGrantedAccess != (ACCESS_MASK)0) ) {
01909             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01910             <span class="keywordflow">goto</span> ReturnOneStatus;
01911 
01912         } <span class="keywordflow">else</span> {
01913             PreviouslyGrantedAccess = 0;
01914             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01915             <span class="keywordflow">goto</span> ReturnOneStatus;
01916         }
01917     }
01918 
01919     <span class="comment">//</span>
01920     <span class="comment">// Fake out a top level ObjectType list if none is passed by the caller.</span>
01921     <span class="comment">//</span>
01922 
01923     <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01924         LocalTypeList = &amp;FixedTypeList;
01925         LocalTypeListLength = 1;
01926         RtlZeroMemory( &amp;FixedTypeList, <span class="keyword">sizeof</span>(FixedTypeList) );
01927         FixedTypeList.ParentIndex = -1;
01928     } <span class="keywordflow">else</span> {
01929         LocalTypeList = ObjectTypeList;
01930         LocalTypeListLength = ObjectTypeListLength;
01931     }
01932 
01933     <span class="comment">//</span>
01934     <span class="comment">// If the caller wants the MAXIMUM_ALLOWED or the caller wants the</span>
01935     <span class="comment">//  results on all objects and subobjects, use a slower algorithm</span>
01936     <span class="comment">//  that traverses all the ACEs.</span>
01937     <span class="comment">//</span>
01938 
01939     <span class="keywordflow">if</span> ( (DesiredAccess &amp; MAXIMUM_ALLOWED) != 0 ||
01940          ReturnResultList ) {
01941 
01942         <span class="comment">//</span>
01943         <span class="comment">// Do the normal maximum-allowed access check</span>
01944         <span class="comment">//</span>
01945 
01946         <a class="code" href="../../d0/d4/accessck_8c.html#a6">SepMaximumAccessCheck</a>(
01947             EToken,
01948             PrimaryToken,
01949             Dacl,
01950             PrincipalSelfSid,
01951             LocalTypeListLength,
01952             LocalTypeList,
01953             ObjectTypeListLength,
01954             FALSE
01955             );
01956 
01957         <span class="comment">//</span>
01958         <span class="comment">// If this is a restricted token, do the additional access check</span>
01959         <span class="comment">//</span>
01960 
01961         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( EToken ) ) {
01962             <a class="code" href="../../d0/d4/accessck_8c.html#a6">SepMaximumAccessCheck</a>(
01963                 EToken,
01964                 PrimaryToken,
01965                 Dacl,
01966                 PrincipalSelfSid,
01967                 LocalTypeListLength,
01968                 LocalTypeList,
01969                 ObjectTypeListLength,
01970                 TRUE
01971                 );
01972         }
01973 
01974 
01975         <span class="comment">//</span>
01976         <span class="comment">// If the caller wants to know the individual results of each sub-object,</span>
01977         <span class="comment">//  sub-object,</span>
01978         <span class="comment">//  break it down for him.</span>
01979         <span class="comment">//</span>
01980 
01981         <span class="keywordflow">if</span> ( ReturnResultList ) {
01982             ACCESS_MASK GrantedAccessMask;
01983             ACCESS_MASK RequiredAccessMask;
01984             BOOLEAN SomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01985             BOOLEAN SomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01986 
01987             <span class="comment">//</span>
01988             <span class="comment">// Compute mask of Granted access bits to tell the caller about.</span>
01989             <span class="comment">//  If he asked for MAXIMUM_ALLOWED,</span>
01990             <span class="comment">//      tell him everything,</span>
01991             <span class="comment">//  otherwise</span>
01992             <span class="comment">//      tell him what he asked about.</span>
01993             <span class="comment">//</span>
01994 
01995             <span class="keywordflow">if</span> (DesiredAccess &amp; MAXIMUM_ALLOWED) {
01996                 GrantedAccessMask = (ACCESS_MASK) ~MAXIMUM_ALLOWED;
01997                 RequiredAccessMask = (DesiredAccess | PreviouslyGrantedAccess) &amp; ~MAXIMUM_ALLOWED;
01998             } <span class="keywordflow">else</span> {
01999                 GrantedAccessMask = DesiredAccess | PreviouslyGrantedAccess;
02000                 RequiredAccessMask = DesiredAccess | PreviouslyGrantedAccess;
02001             }
02002 
02003 
02004 
02005 
02006             <span class="comment">//</span>
02007             <span class="comment">// Loop computing the access granted to each object and sub-object.</span>
02008             <span class="comment">//</span>
02009             <span class="keywordflow">for</span> ( ResultListIndex=0;
02010                   ResultListIndex&lt;LocalTypeListLength;
02011                   ResultListIndex++ ) {
02012 
02013                 <span class="comment">//</span>
02014                 <span class="comment">// Return the subset of the access granted that the caller</span>
02015                 <span class="comment">//  expressed interest in.</span>
02016                 <span class="comment">//</span>
02017 
02018                 GrantedAccess[ResultListIndex] =
02019                     (LocalTypeList[ResultListIndex].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a> |
02020                      PreviouslyGrantedAccess ) &amp;
02021                     GrantedAccessMask;
02022 
02023                 <span class="comment">//</span>
02024                 <span class="comment">// If absolutely no access was granted,</span>
02025                 <span class="comment">//  indicate so.</span>
02026                 <span class="comment">//</span>
02027                 <span class="keywordflow">if</span> ( GrantedAccess[ResultListIndex] == 0 ) {
02028                     AccessStatus[ResultListIndex] = STATUS_ACCESS_DENIED;
02029                     SomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02030                 } <span class="keywordflow">else</span> {
02031 
02032                     <span class="comment">//</span>
02033                     <span class="comment">// If some requested access is still missing,</span>
02034                     <span class="comment">//  the bottom line is that access is denied.</span>
02035                     <span class="comment">//</span>
02036                     <span class="comment">// Note, that ByTypeResultList actually returns the</span>
02037                     <span class="comment">// partially granted access mask even though the caller</span>
02038                     <span class="comment">// really has no access to the object.</span>
02039                     <span class="comment">//</span>
02040 
02041                     <span class="keywordflow">if</span>  ( ((~GrantedAccess[ResultListIndex]) &amp; RequiredAccessMask ) != 0 ) {
02042                         AccessStatus[ResultListIndex] = STATUS_ACCESS_DENIED;
02043                         SomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02044                     } <span class="keywordflow">else</span> {
02045                         AccessStatus[ResultListIndex] = STATUS_SUCCESS;
02046                         SomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02047                     }
02048                 }
02049             }
02050 
02051             <span class="keywordflow">if</span> ( SomeAccessGranted &amp;&amp; PrivilegeCount != 0 ) {
02052 
02053                 <a class="code" href="../../d6/d6/sep_8h.html#a64">SepAssemblePrivileges</a>(
02054                     PrivilegeCount,
02055                     SystemSecurity,
02056                     WriteOwner,
02057                     Privileges
02058                     );
02059             }
02060 
02061             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessGranted)) {
02062                 *ReturnSomeAccessGranted = SomeAccessGranted;
02063             }
02064             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessDenied)) {
02065                 *ReturnSomeAccessDenied = SomeAccessDenied;
02066             }
02067             <span class="keywordflow">return</span>;
02068 
02069         <span class="comment">//</span>
02070         <span class="comment">// If the caller is only interested in the access to the object itself,</span>
02071         <span class="comment">//  just summarize.</span>
02072         <span class="comment">//</span>
02073 
02074         } <span class="keywordflow">else</span> {
02075 
02076             <span class="comment">//</span>
02077             <span class="comment">// Turn off the MAXIMUM_ALLOWED bit and whatever we found that</span>
02078             <span class="comment">// he was granted.  If the user passed in extra bits in addition</span>
02079             <span class="comment">// to MAXIMUM_ALLOWED, make sure that he was granted those access</span>
02080             <span class="comment">// types.  If not, he didn't get what he wanted, so return failure.</span>
02081             <span class="comment">//</span>
02082 
02083             Remaining &amp;= ~(MAXIMUM_ALLOWED | LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a>);
02084 
02085             <span class="keywordflow">if</span> (Remaining != 0) {
02086 
02087                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02088                 PreviouslyGrantedAccess = 0;
02089                 <span class="keywordflow">goto</span> ReturnOneStatus;
02090 
02091             }
02092 
02093 
02094 
02095             PreviouslyGrantedAccess |= LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a>;
02096             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02097             <span class="keywordflow">goto</span> ReturnOneStatus;
02098 
02099         }
02100 
02101     } <span class="comment">// if MAXIMUM_ALLOWED...</span>
02102 
02103 
02104 <span class="preprocessor">#ifdef notdef</span>
02105 <span class="preprocessor"></span>    <span class="comment">//</span>
02106     <span class="comment">// The remaining bits are "remaining" at all levels</span>
02107 
02108     <span class="keywordflow">for</span> ( j=0; j&lt;LocalTypeListLength; j++ ) {
02109         LocalTypeList[j].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> = Remaining;
02110     }
02111 
02112     <span class="comment">//</span>
02113     <span class="comment">// Process the DACL handling individual access bits.</span>
02114     <span class="comment">//</span>
02115 
02116     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Dacl ) ;
02117           ( i &lt; AceCount ) &amp;&amp; ( LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> != 0 )  ;
02118           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ) ) {
02119 
02120         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
02121 
02122             <span class="comment">//</span>
02123             <span class="comment">// Handle an Access Allowed ACE</span>
02124             <span class="comment">//</span>
02125 
02126             <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) ) {
02127 
02128                <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_ALLOWED_ACE)Ace)-&gt;SidStart, FALSE ) ) {
02129 
02130                    <span class="comment">// Optimize 'normal' case</span>
02131                    <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
02132                        LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
02133                    } <span class="keywordflow">else</span> {
02134                        <span class="comment">//</span>
02135                        <span class="comment">// The zeroeth object type represents the object itself.</span>
02136                        <span class="comment">//</span>
02137                        <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02138                             LocalTypeList,          <span class="comment">// List to modify</span>
02139                             LocalTypeListLength,    <span class="comment">// Length of list</span>
02140                             0,                      <span class="comment">// Element to update</span>
02141                             ((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02142                             UpdateRemaining );
02143                    }
02144 
02145                }
02146 
02147 
02148             <span class="comment">//</span>
02149             <span class="comment">// Handle an object specific Access Allowed ACE</span>
02150             <span class="comment">//</span>
02151             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_OBJECT_ACE_TYPE) ) {
02152                 GUID *ObjectTypeInAce;
02153 
02154                 <span class="comment">//</span>
02155                 <span class="comment">// If no object type is in the ACE,</span>
02156                 <span class="comment">//  treat this as an ACCESS_ALLOWED_ACE.</span>
02157                 <span class="comment">//</span>
02158 
02159                 ObjectTypeInAce = RtlObjectAceObjectType(Ace);
02160 
02161                 <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02162 
02163                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), FALSE ) ) {
02164 
02165                        <span class="comment">// Optimize 'normal' case</span>
02166                        <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
02167                            LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
02168                        } <span class="keywordflow">else</span> {
02169                            <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02170                                 LocalTypeList,          <span class="comment">// List to modify</span>
02171                                 LocalTypeListLength,    <span class="comment">// Length of list</span>
02172                                 0,                      <span class="comment">// Element to update</span>
02173                                 ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02174                                 UpdateRemaining );
02175                        }
02176                     }
02177 
02178                 <span class="comment">//</span>
02179                 <span class="comment">// If no object type list was passed,</span>
02180                 <span class="comment">//  don't grant access to anyone.</span>
02181                 <span class="comment">//</span>
02182 
02183                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
02184 
02185                     <span class="comment">// Drop through</span>
02186 
02187 
02188                <span class="comment">//</span>
02189                <span class="comment">// If an object type is in the ACE,</span>
02190                <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
02191                <span class="comment">//</span>
02192                } <span class="keywordflow">else</span> {
02193 
02194                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), FALSE ) ) {
02195 
02196                         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
02197                                                   LocalTypeList,
02198                                                   LocalTypeListLength,
02199                                                   &amp;Index ) ) {
02200                             <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02201                                  LocalTypeList,          <span class="comment">// List to modify</span>
02202                                  LocalTypeListLength,   <span class="comment">// Length of list</span>
02203                                  Index,                  <span class="comment">// Element already updated</span>
02204                                  ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02205                                  UpdateRemaining );
02206                         }
02207                     }
02208                }
02209 
02210 
02211             <span class="comment">//</span>
02212             <span class="comment">// Handle a compound Access Allowed ACE</span>
02213             <span class="comment">//</span>
02214             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_COMPOUND_ACE_TYPE) ) {
02215 
02216                 <span class="comment">//</span>
02217                 <span class="comment">// See comment in MAXIMUM_ALLOWED case as to why we can use EToken here</span>
02218                 <span class="comment">// for the client.</span>
02219                 <span class="comment">//</span>
02220 
02221                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>(EToken, PrincipalSelfSid, RtlCompoundAceClientSid( Ace ), FALSE) &amp;&amp;
02222                      <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>(PrimaryToken, NULL, RtlCompoundAceServerSid( Ace ), FALSE) ) {
02223 
02224                     <span class="comment">// Optimize 'normal' case</span>
02225                     <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
02226                         LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp;= ~((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
02227                     } <span class="keywordflow">else</span> {
02228                         <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02229                              LocalTypeList,          <span class="comment">// List to modify</span>
02230                              LocalTypeListLength,    <span class="comment">// Length of list</span>
02231                              0,                      <span class="comment">// Element to update</span>
02232                              ((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02233                              UpdateRemaining );
02234                     }
02235                 }
02236 
02237 
02238 
02239             <span class="comment">//</span>
02240             <span class="comment">// Handle an Access Denied ACE</span>
02241             <span class="comment">//</span>
02242 
02243             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_ACE_TYPE) ) {
02244 
02245                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_DENIED_ACE)Ace)-&gt;SidStart, TRUE ) ) {
02246 
02247                     <span class="comment">//</span>
02248                     <span class="comment">// The zeroeth element represents the object itself.</span>
02249                     <span class="comment">//  Just check that element.</span>
02250                     <span class="comment">//</span>
02251                     <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp; ((PACCESS_DENIED_ACE)Ace)-&gt;Mask) {
02252 
02253                         <span class="keywordflow">break</span>;
02254                     }
02255                 }
02256 
02257 
02258             <span class="comment">//</span>
02259             <span class="comment">// Handle an object specific Access Denied ACE</span>
02260             <span class="comment">//</span>
02261             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_OBJECT_ACE_TYPE) ) {
02262 
02263                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), TRUE ) ) {
02264                     GUID *ObjectTypeInAce;
02265 
02266                     <span class="comment">//</span>
02267                     <span class="comment">// If there is no object type in the ACE,</span>
02268                     <span class="comment">//  or if the caller didn't specify an object type list,</span>
02269                     <span class="comment">//  apply this deny ACE to the entire object.</span>
02270                     <span class="comment">//</span>
02271 
02272                     ObjectTypeInAce = RtlObjectAceObjectType(Ace);
02273                     <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
02274                          ObjectTypeListLength == 0 ) {
02275 
02276                         <span class="comment">//</span>
02277                         <span class="comment">// The zeroeth element represents the object itself.</span>
02278                         <span class="comment">//  Just check that element.</span>
02279                         <span class="comment">//</span>
02280                         <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
02281                             <span class="keywordflow">break</span>;
02282                         }
02283 
02284                     <span class="comment">//</span>
02285                     <span class="comment">// Otherwise apply the deny ACE to the object specified</span>
02286                     <span class="comment">//  in the ACE.</span>
02287                     <span class="comment">//</span>
02288 
02289                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
02290                                                   LocalTypeList,
02291                                                   LocalTypeListLength,
02292                                                   &amp;Index ) ) {
02293 
02294                         <span class="keywordflow">if</span> (LocalTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
02295                             <span class="keywordflow">break</span>;
02296                         }
02297 
02298                     }
02299                }
02300             }
02301 
02302         }
02303     }
02304 
02305 <span class="preprocessor">#endif</span>
02306 <span class="preprocessor"></span>
02307     <span class="comment">//</span>
02308     <span class="comment">// Do the normal access check first</span>
02309     <span class="comment">//</span>
02310 
02311     <a class="code" href="../../d0/d4/accessck_8c.html#a7">SepNormalAccessCheck</a>(
02312         Remaining,
02313         EToken,
02314         PrimaryToken,
02315         Dacl,
02316         PrincipalSelfSid,
02317         LocalTypeListLength,
02318         LocalTypeList,
02319         ObjectTypeListLength,
02320         FALSE
02321         );
02322 
02323     <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> != 0) {
02324         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02325         PreviouslyGrantedAccess = 0;
02326         <span class="keywordflow">goto</span> ReturnOneStatus;
02327     }
02328 
02329     <span class="comment">//</span>
02330     <span class="comment">// If this is a restricted token, do the additional access check</span>
02331     <span class="comment">//</span>
02332 
02333     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( EToken ) ) {
02334         <a class="code" href="../../d0/d4/accessck_8c.html#a7">SepNormalAccessCheck</a>(
02335             Remaining,
02336             EToken,
02337             PrimaryToken,
02338             Dacl,
02339             PrincipalSelfSid,
02340             LocalTypeListLength,
02341             LocalTypeList,
02342             ObjectTypeListLength,
02343             TRUE
02344             );
02345     }
02346 
02347 
02348     <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> != 0) {
02349         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02350         PreviouslyGrantedAccess = 0;
02351         <span class="keywordflow">goto</span> ReturnOneStatus;
02352     }
02353 
02354     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02355     PreviouslyGrantedAccess |= DesiredAccess;
02356 
02357     <span class="comment">//</span>
02358     <span class="comment">// Return a single status code to the caller.</span>
02359     <span class="comment">//</span>
02360 
02361     ReturnOneStatus:
02362     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS &amp;&amp; PreviouslyGrantedAccess == 0 ) {
02363         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02364     }
02365 
02366     <span class="comment">//</span>
02367     <span class="comment">// If the caller asked for a list of status',</span>
02368     <span class="comment">//  duplicate the status all over.</span>
02369     <span class="comment">//</span>
02370     <span class="keywordflow">if</span> ( ReturnResultList ) {
02371         <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
02372             AccessStatus[ResultListIndex] = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02373             GrantedAccess[ResultListIndex] = PreviouslyGrantedAccess;
02374         }
02375     } <span class="keywordflow">else</span> {
02376         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02377         *GrantedAccess = PreviouslyGrantedAccess;
02378     }
02379 
02380     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
02381         <span class="keywordflow">if</span> ( PrivilegeCount &gt; 0 ) {
02382 
02383             <a class="code" href="../../d6/d6/sep_8h.html#a64">SepAssemblePrivileges</a>(
02384                 PrivilegeCount,
02385                 SystemSecurity,
02386                 WriteOwner,
02387                 Privileges
02388                 );
02389         }
02390 
02391         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessGranted)) {
02392             *ReturnSomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02393         }
02394         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessDenied)) {
02395             *ReturnSomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02396         }
02397     } <span class="keywordflow">else</span> {
02398         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessGranted)) {
02399             *ReturnSomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02400         }
02401         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessDenied)) {
02402             *ReturnSomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;;
02403         }
02404     }
02405     <span class="keywordflow">return</span>;
02406 
02407 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="tokenp.h::SepAdjustGroups" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepAdjustGroups           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MakeChanges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ResetToDefault</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG GroupCount&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES NewState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_GROUPS PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID SidBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangesMade</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l01099">1099</a> of file <a class="el" href="../../d6/d2/tokenadj_8c-source.html">tokenadj.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00479">SepArrayGroupAttributes</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00489">SepTokenGroupAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00432">NtAdjustGroupsToken()</a>.
<p>
<pre class="fragment"><div>01115                    :
01116 
01117     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to walk <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups array in a token as a
01118     result of a request to adjust groups.
01119 
01120     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MakeChanges parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="keyword">this</span> routine simply determines
01121     what changes are needed and how much space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01122     current state of changed groups.
01123 
01124     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MakeChanges parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> routine will not <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
01125     calculate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space necessary to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state, but will
01126     actually make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes.
01127 
01128     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following assumptions:
01129 
01130       1) The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked <span class="keywordflow">for</span> exclusive access.
01131 
01132       2) The NewState parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> captured and accesses
01133          to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will not result in access violations.
01134 
01135       4) Any access violations encountered may leave <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request
01136          partially completed.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling routine's responsibility
01137          to <span class="keywordflow">catch</span> exceptions.
01138 
01139       5) The calling routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> inrementing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token's
01140          ModifiedId field.
01141 
01142 Arguments:
01143 
01144     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to act upon.
01145 
01146     MakeChanges - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes should
01147         actually be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>, or just evaluated.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates
01148         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes should be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
01149 
01150     ResetToDefault - Indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups are to be reset to their
01151         <span class="keywordflow">default</span> enabled/disabled state.
01152 
01153     GroupCount - This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewState parameter
01154         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  In that <span class="keywordflow">case</span>, <span class="keyword">this</span> parameter indicates how many entries are
01155         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewState parameter.
01156 
01157     NewState - This parameter points to a SID_AND_ATTRIBUTES array
01158         containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups whose states are to be adjusted
01159         (disabled or enabled).  Only <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Enabled flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01160         attributes associated with each group <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  It provides
01161         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01162         token.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ResetToDefault argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01163         then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be passed.
01164 
01165     PreviousState - This (optional) parameter points to a buffer to
01166         receive the state of any groups actually changed by this
01167         request.  This information is formated as a TOKEN_GROUPS data
01168         structure which may be passed as the NewState parameter in a
01169         subsequent call to NtAdjustGroups to restore the original state
01170         of those groups.  It is the caller's responsibility to make
01171         sure this buffer is large enough to receive all the state
01172         information.
01173 
01174     SidBuffer - Pointer to buffer to receive the SID values corresponding
01175         to the groups returned in the PreviousState argument.
01176 
01177     ReturnLength - Points to a buffer to receive the number of bytes needed
01178         to retrieve the previous state information of changed privileges.
01179         This parameter is ignored if the PreviousState argument is not
01180         passed.
01181 
01182     ChangeCount - Points to a ULONG to receive the number of groups
01183         which were adjusted (or would be adjusted, if changes are made).
01184 
01185     ChangesMade - Points to a <span class="keywordtype">boolean</span> flag which is to receive an indication
01186         as to whether any changes were made as a result of this call.  This
01187         is expected to be used to decide whether or not to increment the
01188         token's ModifiedId field.
01189 
01190 Return Value:
01191 
01192     STATUS_SUCCESS - Call completed sccessfully.
01193 
01194     STATUS_NOT_ALL_ASSIGNED - Indicates not all the specified adjustments
01195         have been made (or could be made, if update wasn't requested).
01196 
01197     STATUS_CANT_DISABLE_MANDATORY - Not all adjustments were made (or could
01198         be made, if update not requested) because an attempt was made to
01199         disable a mandatory group.  The state of the groups is left
01200         in an underterministic state if update was requested.
01201 
01202 
01203 --*/
01204 {
01205 
01206     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CompletionStatus = STATUS_SUCCESS;
01207 
01208     ULONG OldIndex;
01209     ULONG NewIndex;
01210     ULONG SidLength;
01211     ULONG LocalReturnLength = 0;
01212     PSID NextSid;
01213     BOOLEAN Found;
01214     ULONG MatchCount = 0;
01215     BOOLEAN EnableGroup;
01216     BOOLEAN DisableGroup;
01217     ULONG TokenGroupAttributes;
01218 
01219     SID_AND_ATTRIBUTES CurrentGroup;
01220 
01221     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01222 
01223     <span class="comment">//</span>
01224     <span class="comment">// NextSid is used to copy group SID values if asked for previous state.</span>
01225     <span class="comment">//</span>
01226 
01227     NextSid = SidBuffer;
01228 
01229 
01230     <span class="comment">//</span>
01231     <span class="comment">//  Walk through the groups array to determine which need to be</span>
01232     <span class="comment">//  adjusted.</span>
01233     <span class="comment">//</span>
01234 
01235     OldIndex = 1;             <span class="comment">// Don't evaluate the 0th entry (user ID)</span>
01236     (*ChangeCount) = 0;
01237 
01238     <span class="keywordflow">while</span> (OldIndex &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
01239 
01240         CurrentGroup = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[OldIndex];
01241 
01242         <span class="keywordflow">if</span> (ResetToDefault) {
01243 
01244             TokenGroupAttributes = <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex);
01245 
01246             <span class="comment">//</span>
01247             <span class="comment">// If the group is enabled by default and currently disabled,</span>
01248             <span class="comment">// then we must enable it.</span>
01249             <span class="comment">//</span>
01250 
01251             EnableGroup = (BOOLEAN)( (TokenGroupAttributes &amp; SE_GROUP_ENABLED_BY_DEFAULT)
01252                 &amp;&amp; !(TokenGroupAttributes &amp; SE_GROUP_ENABLED));
01253 
01254             <span class="comment">//</span>
01255             <span class="comment">// If the group is disabled by default and currently enabled,</span>
01256             <span class="comment">// then we must disable it.</span>
01257             <span class="comment">//</span>
01258 
01259             DisableGroup = (BOOLEAN)( !(TokenGroupAttributes &amp; SE_GROUP_ENABLED_BY_DEFAULT)
01260                 &amp;&amp; (TokenGroupAttributes &amp; SE_GROUP_ENABLED));
01261 
01262             <span class="comment">//</span>
01263             <span class="comment">// Blow up if it's a mandatory group that is not both</span>
01264             <span class="comment">// enabled by default and enabled (SepCreateToken should</span>
01265             <span class="comment">// make sure that this never happens).</span>
01266             <span class="comment">//</span>
01267 
01268             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(TokenGroupAttributes &amp; SE_GROUP_MANDATORY)
01269                    || (TokenGroupAttributes &amp; (SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_ENABLED)
01270                        == (SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_ENABLED)));
01271 
01272             <span class="keywordflow">if</span> ( EnableGroup || DisableGroup ) {
01273 
01274                 SidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( CurrentGroup.Sid );
01275                 SidLength = (ULONG)LongAlignSize(SidLength);
01276                 LocalReturnLength += SidLength;
01277 
01278                 <span class="comment">//</span>
01279                 <span class="comment">// Change, if necessary (saving previous state if</span>
01280                 <span class="comment">// appropriate).</span>
01281                 <span class="comment">//</span>
01282 
01283                 <span class="keywordflow">if</span> (MakeChanges) {
01284 
01285                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01286 
01287                         (*(PreviousState)).Groups[(*ChangeCount)].Attributes =
01288                             CurrentGroup.Attributes;
01289 
01290                         (*(PreviousState)).Groups[(*ChangeCount)].Sid =
01291                             NextSid;
01292 
01293                         <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidLength, NextSid, CurrentGroup.Sid );
01294                         NextSid = (PSID)((ULONG_PTR)NextSid + SidLength);
01295                     }
01296 
01297                     <span class="keywordflow">if</span> (EnableGroup) {
01298                         <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) |= SE_GROUP_ENABLED;
01299                     } <span class="keywordflow">else</span> {
01300                         <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;= ~SE_GROUP_ENABLED;
01301                     }
01302 
01303 
01304 
01305                 } <span class="comment">//endif make changes</span>
01306 
01307                 <span class="comment">//</span>
01308                 <span class="comment">// increment the number of changes</span>
01309                 <span class="comment">//</span>
01310 
01311                 (*ChangeCount) += 1;
01312 
01313             } <span class="comment">// endif group enabled</span>
01314 
01315         } <span class="keywordflow">else</span> {
01316 
01317             <span class="comment">//</span>
01318             <span class="comment">//  Selective adjustments - this is a little trickier</span>
01319             <span class="comment">//  Compare the current group to each of those in</span>
01320             <span class="comment">//  the NewState array.  If a match is found, then adjust</span>
01321             <span class="comment">//  the current group appropriately.</span>
01322             <span class="comment">//</span>
01323 
01324             NewIndex = 0;
01325             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01326 
01327             <span class="keywordflow">while</span> ( (NewIndex &lt; GroupCount) &amp;&amp; !Found)  {
01328 
01329                 <span class="comment">//</span>
01330                 <span class="comment">// Look for a comparison</span>
01331                 <span class="comment">//</span>
01332 
01333                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
01334                         CurrentGroup.Sid,
01335                         NewState[NewIndex].Sid
01336                         ) ) {
01337 
01338                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01339                     MatchCount += 1;
01340 
01341 
01342                     <span class="comment">//</span>
01343                     <span class="comment">// See if it needs to be changed</span>
01344                     <span class="comment">//</span>
01345 
01346                     <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d3/tokenp_8h.html#a12">SepArrayGroupAttributes</a>( NewState, NewIndex ) &amp;
01347                             SE_GROUP_ENABLED ) !=
01348                          (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;
01349                             SE_GROUP_ENABLED ) ) {
01350 
01351                         <span class="comment">//</span>
01352                         <span class="comment">// Make sure group is not mandatory</span>
01353                         <span class="comment">//</span>
01354 
01355                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;
01356                               SE_GROUP_MANDATORY ) {
01357                             <span class="keywordflow">return</span> STATUS_CANT_DISABLE_MANDATORY;
01358                         }
01359 
01360                         <span class="comment">//</span>
01361                         <span class="comment">// Make sure group is not deny-only</span>
01362                         <span class="comment">//</span>
01363 
01364 
01365                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;
01366                               SE_GROUP_USE_FOR_DENY_ONLY ) {
01367                             <span class="keywordflow">return</span> STATUS_CANT_ENABLE_DENY_ONLY;
01368                         }
01369 
01370                         SidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( CurrentGroup.Sid );
01371                         SidLength = (ULONG)LongAlignSize(SidLength);
01372                         LocalReturnLength += SidLength;
01373 
01374                         <span class="comment">//</span>
01375                         <span class="comment">// Change, if necessary (saving previous state if</span>
01376                         <span class="comment">// appropriate).</span>
01377                         <span class="comment">//</span>
01378 
01379                         <span class="keywordflow">if</span> (MakeChanges) {
01380 
01381                             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01382 
01383                                 PreviousState-&gt;Groups[(*ChangeCount)].Attributes =
01384                                     CurrentGroup.Attributes;
01385 
01386                                 PreviousState-&gt;Groups[(*ChangeCount)].Sid =
01387                                     NextSid;
01388 
01389                                 <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidLength, NextSid, CurrentGroup.Sid );
01390 
01391                                 NextSid = (PSID)((ULONG_PTR)NextSid + SidLength);
01392                             }
01393 
01394                             <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) &amp;=
01395                                 ~(<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex)
01396                                   &amp; SE_GROUP_ENABLED);
01397                             <a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,OldIndex) |=
01398                                  (<a class="code" href="../../d8/d3/tokenp_8h.html#a12">SepArrayGroupAttributes</a>(NewState,NewIndex)
01399                                   &amp; SE_GROUP_ENABLED);
01400 
01401 
01402 
01403                         } <span class="comment">//endif make changes</span>
01404 
01405                         <span class="comment">//</span>
01406                         <span class="comment">// increment the number of changes</span>
01407                         <span class="comment">//</span>
01408 
01409                         (*ChangeCount) += 1;
01410 
01411 
01412                     } <span class="comment">// endif change needed</span>
01413 
01414                 } <span class="comment">// endif found</span>
01415 
01416                 NewIndex += 1;
01417 
01418             } <span class="comment">// endwhile searching NewState</span>
01419 
01420         } <span class="comment">// endelse</span>
01421 
01422         OldIndex += 1;
01423 
01424     } <span class="comment">// endwhile more groups in token</span>
01425 
01426     <span class="comment">//</span>
01427     <span class="comment">// Set completion status appropriately if some not assigned</span>
01428     <span class="comment">//</span>
01429 
01430     <span class="keywordflow">if</span> (!ResetToDefault) {
01431 
01432         <span class="keywordflow">if</span> (MatchCount &lt; GroupCount) {
01433             CompletionStatus = STATUS_NOT_ALL_ASSIGNED;
01434         }
01435     }
01436 
01437     <span class="comment">//</span>
01438     <span class="comment">//  Indicate whether changes were made</span>
01439     <span class="comment">//</span>
01440 
01441     <span class="keywordflow">if</span> ((*ChangeCount) &gt; 0  &amp;&amp;  MakeChanges) {
01442         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01443     } <span class="keywordflow">else</span> {
01444         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01445     }
01446 
01447     <span class="comment">//</span>
01448     <span class="comment">// Calculate the space needed to return previous state information</span>
01449     <span class="comment">// (The SID lengths have already been added up in LocalReturnLength).</span>
01450     <span class="comment">//</span>
01451 
01452     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01453 
01454         (*ReturnLength) = LocalReturnLength +
01455                           (ULONG)<span class="keyword">sizeof</span>(TOKEN_GROUPS) +
01456                           ((*ChangeCount) *  (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)) -
01457                           (<a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES));
01458     }
01459 
01460    <span class="keywordflow">return</span> CompletionStatus;
01461 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="tokenp.h::SepAdjustPrivileges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepAdjustPrivileges           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MakeChanges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DisableAllPrivileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG PrivilegeCount&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID_AND_ATTRIBUTES NewState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_PRIVILEGES PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangesMade</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00819">819</a> of file <a class="el" href="../../d6/d2/tokenadj_8c-source.html">tokenadj.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00226">ANYSIZE_ARRAY</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00432">DisableAllPrivileges()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01691">SeChangeNotifyPrivilege</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00460">SepArrayPrivilegeAttributes</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00470">SepTokenPrivilegeAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00072">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00046">NtAdjustPrivilegesToken()</a>.
<p>
<pre class="fragment"><div>00834                    :
00835 
00836     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to walk <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileges array in a token as a
00837     result of a request to adjust privileges.
00838 
00839     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MakeChanges parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="keyword">this</span> routine simply determines
00840     what changes are needed and how much space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00841     current state of changed privileges.
00842 
00843     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MakeChanges parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> routine will not <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
00844     calculate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space necessary to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state, but will
00845     actually make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes.
00846 
00847     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following assumptions:
00848 
00849       1) The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked <span class="keywordflow">for</span> exclusive access.
00850 
00851       2) The PrivilegeCount and NewState parameters (<span class="keywordflow">if</span> passed) are captured
00852          and accesses to them will not result in access violations.
00853 
00854       4) Any access violations encountered may leave <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request
00855          partially completed.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling routine's responsibility
00856          to <span class="keywordflow">catch</span> exceptions.
00857 
00858       5) The calling routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> inrementing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token's
00859          ModifiedId field.
00860 
00861 Arguments:
00862 
00863     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to act upon.
00864 
00865     MakeChanges - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes should
00866         actually be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>, or just evaluated.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates
00867         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changes should be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
00868 
00869     DisableAllPrivilegs - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> value indicating whether all privileges
00870         are to be disabled, or <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> select, specified privileges.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value
00871         of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates all privileges are to be disabled.
00872 
00873     PrivilegeCount - This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewState parameter
00874         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  In that <span class="keywordflow">case</span>, <span class="keyword">this</span> parameter indicates how many entries are
00875         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewState parameter.
00876 
00877     NewState - This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>
00878         argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00879         then <span class="keyword">this</span> parameter must be provided and specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> state
00880         to set privileges to (enabled or disabled).
00881 
00882     PreviousState - This (optional) parameter points to a buffer to
00883         receive the state of any privileges actually changed by this
00884         request.  This information is formated as a TOKEN_PRIVILEGES data
00885         structure which may be passed as the NewState parameter in a
00886         subsequent call to NtAdjustPrivileges to restore the original state
00887         of those privileges.  It is the caller's responsibility to make
00888         sure this buffer is large enough to receive all the state
00889         information.
00890 
00891     ReturnLength - Points to a buffer to receive the number of bytes needed
00892         to retrieve the previous state information of changed privileges.
00893         This parameter is ignored if the PreviousState argument is not
00894         passed.
00895 
00896     ChangeCount - Points to a ULONG to receive the number of privileges
00897         which were adjusted (or would be adjusted, if changes are made).
00898 
00899     ChangesMade - Points to a <span class="keywordtype">boolean</span> flag which is to receive an indication
00900         as to whether any changes were made as a result of this call.  This
00901         is expected to be used to decide whether or not to increment the
00902         token's ModifiedId field.
00903 
00904 Return Value:
00905 
00906     STATUS_SUCCESS - Call completed sccessfully.
00907 
00908     STATUS_NOT_ALL_ASSIGNED - Indicates not all the specified adjustments
00909         have been made (or could be made, if update wasn't requested).
00910 
00911 --*/
00912 {
00913     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CompletionStatus = STATUS_SUCCESS;
00914 
00915     ULONG OldIndex;
00916     ULONG NewIndex;
00917     BOOLEAN Found;
00918     ULONG MatchCount = 0;
00919 
00920     LUID_AND_ATTRIBUTES CurrentPrivilege;
00921 
00922     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00923 
00924     <span class="comment">//</span>
00925     <span class="comment">//  Walk through the privileges array to determine which need to be</span>
00926     <span class="comment">//  adjusted.</span>
00927     <span class="comment">//</span>
00928 
00929     OldIndex = 0;
00930     (*ChangeCount) = 0;
00931 
00932     <span class="keywordflow">while</span> (OldIndex &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount) {
00933 
00934         CurrentPrivilege = (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[OldIndex];
00935 
00936         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
00937 
00938             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) &amp;
00939                SE_PRIVILEGE_ENABLED ) {
00940 
00941                 <span class="comment">//</span>
00942                 <span class="comment">// Change, if necessary (saving previous state if</span>
00943                 <span class="comment">// appropriate).</span>
00944                 <span class="comment">//</span>
00945 
00946                 <span class="keywordflow">if</span> (MakeChanges) {
00947 
00948                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
00949 
00950                         PreviousState-&gt;Privileges[(*ChangeCount)] =
00951                             CurrentPrivilege;
00952                     }
00953 
00954                     <a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) &amp;=
00955                         ~SE_PRIVILEGE_ENABLED;
00956 
00957 
00958 
00959                 } <span class="comment">//endif make changes</span>
00960 
00961                 <span class="comment">//</span>
00962                 <span class="comment">// increment the number of changes</span>
00963                 <span class="comment">//</span>
00964 
00965                 (*ChangeCount) += 1;
00966 
00967             } <span class="comment">// endif privilege enabled</span>
00968 
00969         } <span class="keywordflow">else</span> {
00970 
00971             <span class="comment">//</span>
00972             <span class="comment">//  Selective adjustments - this is a little trickier</span>
00973             <span class="comment">//  Compare the current privilege to each of those in</span>
00974             <span class="comment">//  the NewState array.  If a match is found, then adjust</span>
00975             <span class="comment">//  the current privilege appropriately.</span>
00976             <span class="comment">//</span>
00977 
00978             NewIndex = 0;
00979             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00980 
00981             <span class="keywordflow">while</span> ( (NewIndex &lt; PrivilegeCount) &amp;&amp; !Found)  {
00982 
00983                 <span class="comment">//</span>
00984                 <span class="comment">// Look for a comparison</span>
00985                 <span class="comment">//</span>
00986 
00987                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;CurrentPrivilege.Luid,&amp;NewState[NewIndex].Luid)) {
00988 
00989                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00990                     MatchCount += 1;
00991 
00992                     <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d3/tokenp_8h.html#a10">SepArrayPrivilegeAttributes</a>( NewState, NewIndex ) &amp;
00993                           SE_PRIVILEGE_ENABLED)
00994                         !=
00995                          (<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) &amp;
00996                           SE_PRIVILEGE_ENABLED)  ) {
00997 
00998                         <span class="comment">//</span>
00999                         <span class="comment">// Change, if necessary (saving previous state if</span>
01000                         <span class="comment">// appropriate).</span>
01001                         <span class="comment">//</span>
01002 
01003                         <span class="keywordflow">if</span> (MakeChanges) {
01004 
01005                             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01006 
01007                                 PreviousState-&gt;Privileges[(*ChangeCount)] =
01008                                     CurrentPrivilege;
01009                             }
01010 
01011                             <a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) &amp;=
01012                                 ~(<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex)
01013                                   &amp; SE_PRIVILEGE_ENABLED);
01014                             <a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,OldIndex) |=
01015                                  (<a class="code" href="../../d8/d3/tokenp_8h.html#a10">SepArrayPrivilegeAttributes</a>(NewState,NewIndex)
01016                                   &amp; SE_PRIVILEGE_ENABLED);
01017 
01018                             <span class="comment">//</span>
01019                             <span class="comment">// if this is SeChangeNotifyPrivilege, then</span>
01020                             <span class="comment">// change its corresponding bit in TokenFlags</span>
01021                             <span class="comment">//</span>
01022 
01023                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;CurrentPrivilege.Luid,
01024                                               &amp;SeChangeNotifyPrivilege)) {
01025                                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags ^= <a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
01026                             }
01027 
01028 
01029 
01030                         } <span class="comment">//endif make changes</span>
01031 
01032                         <span class="comment">//</span>
01033                         <span class="comment">// increment the number of changes</span>
01034                         <span class="comment">//</span>
01035 
01036                         (*ChangeCount) += 1;
01037 
01038 
01039                     } <span class="comment">// endif change needed</span>
01040 
01041                 } <span class="comment">// endif found</span>
01042 
01043                 NewIndex += 1;
01044 
01045             } <span class="comment">// endwhile searching NewState</span>
01046 
01047         } <span class="comment">// endelse</span>
01048 
01049         OldIndex += 1;
01050 
01051     } <span class="comment">// endwhile privileges in token</span>
01052 
01053     <span class="comment">//</span>
01054     <span class="comment">// If we disabled all privileges, then clear the TokenFlags flag</span>
01055     <span class="comment">// corresponding to the SeChangeNotifyPrivilege privilege.</span>
01056     <span class="comment">//</span>
01057 
01058 
01059     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
01060         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp;= ~<a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
01061     }
01062 
01063     <span class="comment">//</span>
01064     <span class="comment">// Set completion status appropriately if some not assigned</span>
01065     <span class="comment">//</span>
01066 
01067     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>) {
01068 
01069         <span class="keywordflow">if</span> (MatchCount &lt; PrivilegeCount) {
01070             CompletionStatus = STATUS_NOT_ALL_ASSIGNED;
01071         }
01072     }
01073 
01074     <span class="comment">//</span>
01075     <span class="comment">//  Indicate whether changes were made</span>
01076     <span class="comment">//</span>
01077 
01078     <span class="keywordflow">if</span> ((*ChangeCount) &gt; 0  &amp;&amp;  MakeChanges) {
01079         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01080     } <span class="keywordflow">else</span> {
01081         (*ChangesMade) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01082     }
01083 
01084     <span class="comment">//</span>
01085     <span class="comment">// Calculate the space needed to return previous state information</span>
01086     <span class="comment">//</span>
01087 
01088     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01089 
01090         (*ReturnLength) = (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) +
01091                           ((*ChangeCount) *  (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) -
01092                           (<a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a> * (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES));
01093     }
01094 
01095    <span class="keywordflow">return</span> CompletionStatus;
01096 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="tokenp.h::SepAppendDefaultDacl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAppendDefaultDacl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>PAcl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00778">778</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>.
<p>
<pre class="fragment"><div>00786                    :
00787 
00788     Add a <span class="keywordflow">default</span> discretionary ACL to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available space at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00789     dynamic part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to ensure
00790     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> fits within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic
00791     part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00792 
00793     The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be locked <span class="keywordflow">for</span> write access before calling
00794     <span class="keyword">this</span> routine.
00795 
00796 Arguments:
00797 
00798     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00799 
00800     PAcl - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL to add.
00801 
00802 Return Value:
00803 
00804     None.
00805 
00806 --*/
00807 {
00808    ULONG_PTR NextFree;
00809    ULONG AclSize;
00810 
00811    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00812 
00813     <span class="comment">//</span>
00814     <span class="comment">// Add the size of the primary group to the</span>
00815     <span class="comment">// address of the Dynamic Part of the token to establish</span>
00816     <span class="comment">// where the primary group should be placed.</span>
00817     <span class="comment">//</span>
00818 
00819     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup));
00820 
00821     NextFree = (ULONG_PTR)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup);
00822 
00823     <span class="comment">//</span>
00824     <span class="comment">// Now copy the default Dacl</span>
00825     <span class="comment">//</span>
00826 
00827     AclSize = (ULONG)(PAcl-&gt;AclSize);
00828 <span class="comment">//    ASSERT(AclSize == (ULONG)LongAlignSize(AclSize));</span>
00829 
00830     RtlCopyMemory(
00831         (PVOID)NextFree,
00832         (PVOID)PAcl,
00833         AclSize
00834         );
00835 
00836     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = (PACL)NextFree;
00837 
00838     <span class="comment">//</span>
00839     <span class="comment">// And decrement the amount of the dynamic part that is available.</span>
00840     <span class="comment">//</span>
00841 
00842     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( AclSize &lt;= (Token-&gt;DynamicAvailable) );
00843     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable -= AclSize;
00844 
00845     <span class="keywordflow">return</span>;
00846 
00847 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="tokenp.h::SepAppendPrimaryGroup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAppendPrimaryGroup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PSid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00697">697</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>.
<p>
<pre class="fragment"><div>00705                    :
00706 
00707     Add a primary group SID to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available space at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic
00708     part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to ensure that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00709     primary group SID fits within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> available space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic part of
00710     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00711 
00712     The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be locked <span class="keywordflow">for</span> write access before calling
00713     <span class="keyword">this</span> routine.
00714 
00715 Arguments:
00716 
00717     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00718 
00719     PSid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID to add.
00720 
00721 Return Value:
00722 
00723     None.
00724 
00725 --*/
00726 {
00727    ULONG_PTR NextFree;
00728    ULONG SidSize;
00729 
00730    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">// Add the size of the Default Dacl (if there is one) to the</span>
00734     <span class="comment">// address of the Dynamic Part of the token to establish</span>
00735     <span class="comment">// where the primary group should be placed.</span>
00736     <span class="comment">//</span>
00737 
00738     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00739 
00740 <span class="comment">//        ASSERT( (ULONG)(Token-&gt;DefaultDacl-&gt;AclSize) ==</span>
00741 <span class="comment">//                (ULONG)LongAlignSize(Token-&gt;DefaultDacl-&gt;AclSize) );</span>
00742 
00743         NextFree = (ULONG_PTR)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart) + <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00744 
00745     } <span class="keywordflow">else</span> {
00746 
00747         NextFree = (ULONG_PTR)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart);
00748 
00749     }
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// Now copy the primary group SID.</span>
00753     <span class="comment">//</span>
00754 
00755 
00756     SidSize = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( PSid );
00757 
00758     RtlCopyMemory(
00759         (PVOID)NextFree,
00760         (PVOID)PSid,
00761         SidSize
00762         );
00763 
00764     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup = (PSID)NextFree;
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// And decrement the amount of the dynamic part that is available.</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SidSize &lt;= (Token-&gt;DynamicAvailable) );
00771     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable -= SidSize;
00772 
00773     <span class="keywordflow">return</span>;
00774 
00775 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="tokenp.h::SepDuplicateToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepDuplicateToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ExistingToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TOKEN_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DuplicateToken</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">362</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03024">ExAllocateLocallyUniqueId</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00681">SepCopyProxyData()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00737">SepFreeProxyData()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00806">SepMakeTokenEffectiveOnly()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00278">SepReferenceLogonSession()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00046">NtDuplicateToken()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01227">SeCopyClientToken()</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l01327">SeSubProcessToken()</a>.
<p>
<pre class="fragment"><div>00376                    :
00377 
00378     This routine does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bulk of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work to actually duplicate
00379     a token.  This routine assumes all access validation and argument
00380     probing (except the ObjectAttributes) has been performed.
00381 
00382     THE CALLER IS RESPONSIBLE FOR CHECKING SUBJECT RIGHTS TO <a class="code" href="../../d2/d5/editreg_8c.html#a10">CREATE</a> THE
00383     TYPE OF <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> BEING CREATED.
00384 
00385     This routine acquires a read lock on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token being duplicated.
00386 
00387 Arguments:
00388 
00389     ExistingToken - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be duplicated.
00390 
00391     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standard object attributes data
00392         structure.  Refer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object Management
00393         Specification <span class="keywordflow">for</span> a description of <span class="keyword">this</span> data structure.
00394 
00395         The security Quality Of Service of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object attributes are ignored.
00396         This information must be specified <span class="keyword">using</span> parameters to <span class="keyword">this</span>
00397         routine.
00398 
00399     EffectiveOnly - Is a <span class="keywordtype">boolean</span> flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire
00400         source token should be duplicated into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target token or
00401         just <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective (currently enabled) part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00402         This provides a means <span class="keywordflow">for</span> a caller of a <span class="keyword">protected</span> subsystem
00403         to limit which privileges and optional groups are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
00404         available to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">protected</span> subsystem.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00405         indicates <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> currently enabled parts of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source
00406         token are to be duplicated.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire source
00407         token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> duplicated.
00408 
00409     TokenType - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of token to make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.
00410 
00411     ImpersonationLevel - This value specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation level
00412         to assign to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TokenType of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00413         duplicate <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not TokenImpersonation then <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00414         ignored.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> must be provided.
00415 
00416     RequestorMode - Mode of client requesting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token be duplicated.
00417 
00418     DuplicateToken - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.
00419         The token has not yet been inserted into any object table.
00420         No exceptions are expected when tring to set <span class="keyword">this</span> OUT value.
00421 
00422 Return Value:
00423 
00424     STATUS_SUCCESS - The service successfully completed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00425         operation.
00426 
00427 
00428 --*/
00429 {
00430     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00431 
00432     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken;
00433     PULONG DynamicPart;
00434     ULONG PagedPoolSize;
00435     ULONG NonPagedPoolSize;
00436     ULONG TokenBodyLength;
00437     ULONG FieldOffset;
00438 
00439     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00440 
00441     PSECURITY_TOKEN_PROXY_DATA NewProxyData;
00442     PSECURITY_TOKEN_AUDIT_DATA NewAuditData;
00443 
00444 
00445     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00446 
00447     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL) &lt;= <span class="keyword">sizeof</span>(ULONG) );
00448 
00449 
00450     <span class="keywordflow">if</span> ( TokenType == TokenImpersonation ) {
00451 
00452         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SecurityDelegation     &gt; SecurityImpersonation );
00453         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SecurityImpersonation  &gt; SecurityIdentification );
00454         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SecurityIdentification &gt; SecurityAnonymous );
00455 
00456         <span class="keywordflow">if</span> ( (ImpersonationLevel &gt; SecurityDelegation)  ||
00457              (ImpersonationLevel &lt; SecurityAnonymous) ) {
00458 
00459             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
00460         }
00461     }
00462 
00463 
00464     <span class="comment">//</span>
00465     <span class="comment">// Increment the reference count for this logon session</span>
00466     <span class="comment">// This can not fail, since there is already a token in this logon</span>
00467     <span class="comment">// session.</span>
00468     <span class="comment">//</span>
00469 
00470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a40">SepReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00471     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00472 
00473 
00474 
00475     <span class="comment">//</span>
00476     <span class="comment">// Note that the size of the dynamic portion of a token can not change</span>
00477     <span class="comment">// once established.</span>
00478     <span class="comment">//</span>
00479 
00480     <span class="comment">//</span>
00481     <span class="comment">//  Allocate the dynamic portion</span>
00482     <span class="comment">//</span>
00483 
00484     DynamicPart = (PULONG)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00485                               PagedPool,
00486                               ExistingToken-&gt;DynamicCharged,
00487                               'dTeS'
00488                               );
00489 
00490     <span class="keywordflow">if</span> (DynamicPart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00491         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00492         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00493     }
00494 
00495     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;ProxyData)) {
00496 
00497         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a73">SepCopyProxyData</a>(
00498                     &amp;NewProxyData,
00499                     ExistingToken-&gt;ProxyData
00500                     );
00501 
00502         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00503 
00504             <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00505             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
00506             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00507         }
00508 
00509     } <span class="keywordflow">else</span> {
00510 
00511         NewProxyData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00512     }
00513 
00514     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ExistingToken-&gt;AuditData )) {
00515 
00516         NewAuditData = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( SECURITY_TOKEN_AUDIT_DATA ));
00517 
00518         <span class="keywordflow">if</span> (NewAuditData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00519 
00520             <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( NewProxyData );
00521             <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00522             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
00523 
00524             <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00525 
00526         } <span class="keywordflow">else</span> {
00527 
00528             *NewAuditData = *(ExistingToken-&gt;AuditData);
00529         }
00530 
00531     } <span class="keywordflow">else</span> {
00532 
00533         NewAuditData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00534 
00535     }
00536 
00537     <span class="comment">//</span>
00538     <span class="comment">//  Create a new object</span>
00539     <span class="comment">//</span>
00540 
00541     TokenBodyLength = (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a>) +
00542                       ExistingToken-&gt;VariableLength;
00543 
00544     NonPagedPoolSize = TokenBodyLength;
00545     PagedPoolSize    = ExistingToken-&gt;DynamicCharged;
00546 
00547     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
00548                  RequestorMode,      <span class="comment">// ProbeMode</span>
00549                  SepTokenObjectType, <span class="comment">// ObjectType</span>
00550                  ObjectAttributes,   <span class="comment">// ObjectAttributes</span>
00551                  RequestorMode,      <span class="comment">// OwnershipMode</span>
00552                  NULL,               <span class="comment">// ParseContext</span>
00553                  TokenBodyLength,    <span class="comment">// ObjectBodySize</span>
00554                  PagedPoolSize,      <span class="comment">// PagedPoolCharge</span>
00555                  NonPagedPoolSize,   <span class="comment">// NonPagedPoolCharge</span>
00556                  (PVOID *)&amp;NewToken  <span class="comment">// Return pointer to object</span>
00557                  );
00558 
00559     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00560         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
00561         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
00562         <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( NewProxyData );
00563 
00564         <span class="keywordflow">if</span> (NewAuditData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00565             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewAuditData );
00566         }
00567 
00568         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00569     }
00570 
00571 
00572     <span class="comment">//</span>
00573     <span class="comment">//  acquire exclusive access to the source token</span>
00574     <span class="comment">//</span>
00575 
00576     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( ExistingToken );
00577 
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">// Main Body initialization</span>
00581     <span class="comment">//</span>
00582 
00583     <span class="comment">//</span>
00584     <span class="comment">// The following fields are unchanged from the source token.</span>
00585     <span class="comment">// Although some may change if EffectiveOnly has been specified.</span>
00586     <span class="comment">//</span>
00587 
00588     NewToken-&gt;AuthenticationId = ExistingToken-&gt;AuthenticationId;
00589     NewToken-&gt;ModifiedId = ExistingToken-&gt;ModifiedId;
00590     NewToken-&gt;ExpirationTime = ExistingToken-&gt;ExpirationTime;
00591     NewToken-&gt;TokenSource = ExistingToken-&gt;TokenSource;
00592     NewToken-&gt;DynamicCharged = ExistingToken-&gt;DynamicCharged;
00593     NewToken-&gt;DynamicAvailable = ExistingToken-&gt;DynamicAvailable;
00594     NewToken-&gt;DefaultOwnerIndex = ExistingToken-&gt;DefaultOwnerIndex;
00595     NewToken-&gt;UserAndGroupCount = ExistingToken-&gt;UserAndGroupCount;
00596     NewToken-&gt;RestrictedSidCount = ExistingToken-&gt;RestrictedSidCount;
00597     NewToken-&gt;PrivilegeCount = ExistingToken-&gt;PrivilegeCount;
00598     NewToken-&gt;VariableLength = ExistingToken-&gt;VariableLength;
00599     NewToken-&gt;TokenFlags = ExistingToken-&gt;TokenFlags;
00600     NewToken-&gt;ProxyData = NewProxyData;
00601     NewToken-&gt;AuditData = NewAuditData;
00602     NewToken-&gt;SessionId = ExistingToken-&gt;SessionId;
00603 
00604 
00605     <span class="comment">//</span>
00606     <span class="comment">// The following fields differ in the new token.</span>
00607     <span class="comment">//</span>
00608 
00609     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;(NewToken-&gt;TokenId) );
00610     NewToken-&gt;ParentTokenId = ExistingToken-&gt;ParentTokenId;
00611     NewToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00612     NewToken-&gt;TokenType = TokenType;
00613     NewToken-&gt;ImpersonationLevel = ImpersonationLevel;
00614 
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">//  Copy and initialize the variable part.</span>
00618     <span class="comment">//  The variable part is assumed to be position independent.</span>
00619     <span class="comment">//</span>
00620 
00621     RtlCopyMemory( (PVOID)&amp;(NewToken-&gt;VariablePart),
00622                   (PVOID)&amp;(ExistingToken-&gt;VariablePart),
00623                   ExistingToken-&gt;VariableLength
00624                   );
00625 
00626     <span class="comment">//</span>
00627     <span class="comment">//  Set the address of the UserAndGroups array.</span>
00628     <span class="comment">//</span>
00629 
00630     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ARGUMENT_PRESENT(ExistingToken-&gt;UserAndGroups ) );
00631     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;UserAndGroups) &gt;=
00632             (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)) );
00633 
00634     FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;UserAndGroups) -
00635                           (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00636 
00637     NewToken-&gt;UserAndGroups =
00638         (PSID_AND_ATTRIBUTES)(FieldOffset + (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart)));
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">//  Now go through and change the address of each SID pointer</span>
00642     <span class="comment">//  for the user and groups</span>
00643     <span class="comment">//</span>
00644 
00645     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00646 
00647     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ExistingToken-&gt;UserAndGroupCount) {
00648 
00649         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;UserAndGroups[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid) -
00650                               (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00651 
00652         NewToken-&gt;UserAndGroups[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid =
00653             (PSID)( FieldOffset + (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart)) );
00654 
00655         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00656 
00657     }
00658 
00659     <span class="comment">//</span>
00660     <span class="comment">//  Set the address of the RestrictedSids array.</span>
00661     <span class="comment">//</span>
00662 
00663     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;RestrictedSids ) ) {
00664         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;RestrictedSids) &gt;=
00665                 (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)) );
00666 
00667         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;RestrictedSids) -
00668                               (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00669 
00670         NewToken-&gt;RestrictedSids =
00671             (PSID_AND_ATTRIBUTES)(FieldOffset + (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart)) );
00672 
00673         <span class="comment">//</span>
00674         <span class="comment">//  Now go through and change the address of each SID pointer</span>
00675         <span class="comment">//  for the user and groups</span>
00676         <span class="comment">//</span>
00677 
00678         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00679 
00680         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ExistingToken-&gt;RestrictedSidCount) {
00681 
00682             FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;RestrictedSids[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid) -
00683                                   (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00684 
00685             NewToken-&gt;RestrictedSids[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid =
00686                 (PSID)( FieldOffset + (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart)) );
00687 
00688             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00689 
00690         }
00691     } <span class="keywordflow">else</span> {
00692         NewToken-&gt;RestrictedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00693     }
00694 
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">// If present, set the address of the privileges</span>
00698     <span class="comment">//</span>
00699 
00700     <span class="keywordflow">if</span> (ExistingToken-&gt;PrivilegeCount &gt; 0) {
00701         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ARGUMENT_PRESENT(ExistingToken-&gt;Privileges ) );
00702         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;Privileges) &gt;=
00703                 (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)) );
00704 
00705         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;Privileges) -
00706                               (ULONG_PTR)(&amp;(ExistingToken-&gt;VariablePart)));
00707         NewToken-&gt;Privileges = (PLUID_AND_ATTRIBUTES)(
00708                                    FieldOffset +
00709                                    (ULONG_PTR)(&amp;(NewToken-&gt;VariablePart))
00710                                    );
00711     } <span class="keywordflow">else</span> {
00712 
00713         NewToken-&gt;Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00714 
00715     }
00716 
00717     <span class="comment">//</span>
00718     <span class="comment">//  Copy and initialize the dynamic part.</span>
00719     <span class="comment">//  The dynamic part is assumed to be position independent.</span>
00720     <span class="comment">//</span>
00721 
00722     RtlCopyMemory( (PVOID)DynamicPart,
00723                   (PVOID)(ExistingToken-&gt;DynamicPart),
00724                   ExistingToken-&gt;DynamicCharged
00725                   );
00726 
00727     NewToken-&gt;DynamicPart = DynamicPart;
00728 
00729     <span class="comment">//</span>
00730     <span class="comment">// If present, set the address of the default Dacl</span>
00731     <span class="comment">//</span>
00732 
00733     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;DefaultDacl)) {
00734 
00735         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;DefaultDacl) &gt;=
00736                 (ULONG_PTR)(ExistingToken-&gt;DynamicPart) );
00737 
00738         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;DefaultDacl) -
00739                               (ULONG_PTR)(ExistingToken-&gt;DynamicPart));
00740 
00741         NewToken-&gt;DefaultDacl = (PACL)(FieldOffset + (ULONG_PTR)DynamicPart);
00742 
00743     } <span class="keywordflow">else</span> {
00744 
00745         NewToken-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00746     }
00747 
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">// Set the address of the primary group</span>
00751     <span class="comment">//</span>
00752 
00753     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT(ExistingToken-&gt;PrimaryGroup));
00754 
00755     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;PrimaryGroup) &gt;=
00756             (ULONG_PTR)(ExistingToken-&gt;DynamicPart) );
00757 
00758     FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;PrimaryGroup) -
00759                           (ULONG_PTR)(ExistingToken-&gt;DynamicPart));
00760 
00761     NewToken-&gt;PrimaryGroup = (PACL)(FieldOffset + (ULONG_PTR)(DynamicPart));
00762 
00763 
00764     <span class="comment">//</span>
00765     <span class="comment">// For the time being, take the easy way to generating an "EffectiveOnly"</span>
00766     <span class="comment">// duplicate.  That is, use the same space required of the original, just</span>
00767     <span class="comment">// eliminate any IDs or privileges not active.</span>
00768     <span class="comment">//</span>
00769     <span class="comment">// Ultimately, if duplication becomes a common operation, then it will be</span>
00770     <span class="comment">// worthwhile to recalculate the actual space needed and copy only the</span>
00771     <span class="comment">// effective IDs/privileges into the new token.</span>
00772     <span class="comment">//</span>
00773 
00774     <span class="keywordflow">if</span> (EffectiveOnly) {
00775         <a class="code" href="../../d8/d3/tokenp_8h.html#a34">SepMakeTokenEffectiveOnly</a>( NewToken );
00776     }
00777 
00778 
00779 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
00780 <span class="preprocessor"></span>
00781 <span class="comment">//</span>
00782 <span class="comment">// Debug</span>
00783     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00784     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00785     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00786     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Duplicate token:\n"</span>);
00787     SepDumpToken( NewToken );
00788 <span class="comment">// Debug</span>
00789 <span class="comment">//</span>
00791 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
00792 <span class="preprocessor"></span>
00793     <span class="comment">//</span>
00794     <span class="comment">// Release the source token.</span>
00795     <span class="comment">//</span>
00796 
00797     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ExistingToken );
00798 
00799 
00800     (*DuplicateToken) = NewToken;
00801     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00802 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="tokenp.h::SepFilterToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepFilterToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ExistingToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES GroupsToDisable&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID_AND_ATTRIBUTES PrivilegesToDelete&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SidCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES RestrictedSids&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SidLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>FilteredToken</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">1939</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03024">ExAllocateLocallyUniqueId</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d3/tokendup_8c.html#a0">MAX</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01896">RtlCopyLuidAndAttributesArray()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01436">RtlCopySidAndAttributesArray()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00681">SepCopyProxyData()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00737">SepFreeProxyData()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00278">SepReferenceLogonSession()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01041">SepRemoveDisabledGroupsAndPrivileges()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00933">SepSidInSidAndAttributes()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00076">TOKEN_IS_RESTRICTED</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01306">NtFilterToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01859">SeFastFilterToken()</a>, and <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">SeFilterToken()</a>.
<p>
<pre class="fragment"><div>01955                    :
01956 
01957     This routine does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bulk of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work to actually filter
01958     a token.  This routine assumes all access validation and argument
01959     probing has been performed.
01960 
01961     THE CALLER IS RESPONSIBLE FOR CHECKING SUBJECT RIGHTS TO <a class="code" href="../../d2/d5/editreg_8c.html#a10">CREATE</a> THE
01962     TYPE OF <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> BEING CREATED.
01963 
01964     This routine acquires a read lock on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token being filtered.
01965 
01966 Arguments:
01967 
01968     ExistingToken - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be duplicated.
01969 
01970     RequestorMode - Mode of client requesting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token be duplicated.
01971 
01972     GroupCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of groups to disable
01973 
01974     GroupsToDisable - Contains a list of sids and attributes. All sids with
01975         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY attribute that also exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token will
01976         cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token to have that sid set with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USE_FOR_DENY_ONLY
01977         attribute.
01978 
01979     PrivilegeCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of privileges to <span class="keyword">delete</span>
01980 
01981     PrivilegesToDelete - Privileges in <span class="keyword">this</span> list that are present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01982         existing token will not exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> token. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> similar
01983         to duplicating a token effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> with these privileges set to
01984         disabled.
01985 
01986     SidCount - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of restricted sids to add.
01987 
01988     RestrictedSids - Contains a list of SIDs and attributes that will be
01989         stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RestrictedSids field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> token. These SIDs
01990         are used after a normal access check to futher restrict access.
01991         The attributes of these groups are always SE_GROUP_MANDATORY |
01992         SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT. If there already
01993         exist RestrictedSids in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original token, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> intersection of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01994         two sets will be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> tokense sids will be.
01995 
01996     SidLength - Length of added restricted sids.
01997 
01998     FilteredToken - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicate token.
01999         The token has not yet been inserted into any object table.
02000         No exceptions are expected when tring to set <span class="keyword">this</span> OUT value.
02001 
02002 Return Value:
02003 
02004     STATUS_SUCCESS - The service successfully completed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
02005         operation.
02006 
02007 
02008 --*/
02009 {
02010     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02011 
02012     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken;
02013     PULONG DynamicPart;
02014     ULONG PagedPoolSize;
02015     ULONG NonPagedPoolSize;
02016     ULONG TokenBodyLength;
02017     ULONG FieldOffset;
02018     ULONG_PTR NextFree;
02019     PSID NextSidFree;
02020     ULONG VariableLength;
02021 
02022     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02023 
02024     PSECURITY_TOKEN_PROXY_DATA NewProxyData;
02025     PSECURITY_TOKEN_AUDIT_DATA NewAuditData;
02026     OBJECT_ATTRIBUTES ObjA ;
02027 
02028 
02029     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02030 
02031     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL) &lt;= <span class="keyword">sizeof</span>(ULONG) );
02032 
02033 
02034     <span class="comment">//</span>
02035     <span class="comment">// Increment the reference count for this logon session</span>
02036     <span class="comment">// This can not fail, since there is already a token in this logon</span>
02037     <span class="comment">// session.</span>
02038     <span class="comment">//</span>
02039 
02040     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a40">SepReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02041     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
02042 
02043 
02044 
02045     <span class="comment">//</span>
02046     <span class="comment">// Note that the size of the dynamic portion of a token can not change</span>
02047     <span class="comment">// once established.</span>
02048     <span class="comment">//</span>
02049 
02050     <span class="comment">//</span>
02051     <span class="comment">//  Allocate the dynamic portion</span>
02052     <span class="comment">//</span>
02053 
02054     DynamicPart = (PULONG)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02055                               PagedPool,
02056                               ExistingToken-&gt;DynamicCharged,
02057                               'dTeS'
02058                               );
02059 
02060     <span class="keywordflow">if</span> (DynamicPart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02061         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02062         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02063     }
02064 
02065     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;ProxyData)) {
02066 
02067         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a73">SepCopyProxyData</a>(
02068                     &amp;NewProxyData,
02069                     ExistingToken-&gt;ProxyData
02070                     );
02071 
02072         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02073 
02074             <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02075             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
02076             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02077         }
02078 
02079     } <span class="keywordflow">else</span> {
02080 
02081         NewProxyData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02082     }
02083 
02084     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ExistingToken-&gt;AuditData )) {
02085 
02086         NewAuditData = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( SECURITY_TOKEN_AUDIT_DATA ));
02087 
02088         <span class="keywordflow">if</span> (NewAuditData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02089 
02090             <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( NewProxyData );
02091             <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02092             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
02093 
02094             <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02095 
02096         } <span class="keywordflow">else</span> {
02097 
02098             *NewAuditData = *(ExistingToken-&gt;AuditData);
02099         }
02100 
02101     } <span class="keywordflow">else</span> {
02102 
02103         NewAuditData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02104 
02105     }
02106 
02107     <span class="comment">//</span>
02108     <span class="comment">//  Create a new object</span>
02109     <span class="comment">//</span>
02110 
02111     VariableLength = ExistingToken-&gt;VariableLength + SidLength;
02112 
02113     TokenBodyLength = (ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a>) +
02114                       VariableLength;
02115 
02116     NonPagedPoolSize = TokenBodyLength;
02117     PagedPoolSize    = ExistingToken-&gt;DynamicCharged;
02118 
02119     InitializeObjectAttributes( &amp;ObjA, NULL, 0, NULL, NULL );
02120 
02121     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
02122                  RequestorMode,      <span class="comment">// ProbeMode</span>
02123                  SepTokenObjectType, <span class="comment">// ObjectType</span>
02124                  NULL,               <span class="comment">// ObjectAttributes</span>
02125                  RequestorMode,      <span class="comment">// OwnershipMode</span>
02126                  NULL,               <span class="comment">// ParseContext</span>
02127                  TokenBodyLength,    <span class="comment">// ObjectBodySize</span>
02128                  PagedPoolSize,      <span class="comment">// PagedPoolCharge</span>
02129                  NonPagedPoolSize,   <span class="comment">// NonPagedPoolCharge</span>
02130                  (PVOID *)&amp;NewToken  <span class="comment">// Return pointer to object</span>
02131                  );
02132 
02133     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02134         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(ExistingToken-&gt;AuthenticationId) );
02135         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
02136         <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( NewProxyData );
02137 
02138         <span class="keywordflow">if</span> (NewAuditData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02139             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewAuditData );
02140         }
02141 
02142         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02143     }
02144 
02145 
02146     <span class="comment">//</span>
02147     <span class="comment">//  acquire exclusive access to the source token</span>
02148     <span class="comment">//</span>
02149 
02150     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( ExistingToken );
02151 
02152 
02153     <span class="comment">//</span>
02154     <span class="comment">// Main Body initialization</span>
02155     <span class="comment">//</span>
02156 
02157     <span class="comment">//</span>
02158     <span class="comment">// The following fields are unchanged from the source token.</span>
02159     <span class="comment">// Although some may change if EffectiveOnly has been specified.</span>
02160     <span class="comment">//</span>
02161 
02162     NewToken-&gt;AuthenticationId = ExistingToken-&gt;AuthenticationId;
02163     NewToken-&gt;ExpirationTime = ExistingToken-&gt;ExpirationTime;
02164     NewToken-&gt;TokenSource = ExistingToken-&gt;TokenSource;
02165     NewToken-&gt;DynamicCharged = ExistingToken-&gt;DynamicCharged;
02166     NewToken-&gt;DynamicAvailable = ExistingToken-&gt;DynamicAvailable;
02167     NewToken-&gt;DefaultOwnerIndex = ExistingToken-&gt;DefaultOwnerIndex;
02168     NewToken-&gt;UserAndGroupCount = ExistingToken-&gt;UserAndGroupCount;
02169     NewToken-&gt;SessionId = ExistingToken-&gt;SessionId;
02170     NewToken-&gt;RestrictedSidCount = 0;
02171     NewToken-&gt;PrivilegeCount = ExistingToken-&gt;PrivilegeCount;
02172     NewToken-&gt;VariableLength = VariableLength;
02173     NewToken-&gt;TokenFlags = ExistingToken-&gt;TokenFlags;
02174     NewToken-&gt;ProxyData = NewProxyData;
02175     NewToken-&gt;AuditData = NewAuditData;
02176 
02177 
02178     <span class="comment">//</span>
02179     <span class="comment">// The following fields differ in the new token.</span>
02180     <span class="comment">//</span>
02181 
02182     <span class="comment">//</span>
02183     <span class="comment">// Allocate a new modified Id to distinguish this token from the orignial</span>
02184     <span class="comment">// token.</span>
02185     <span class="comment">//</span>
02186 
02187     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;(NewToken-&gt;ModifiedId) );
02188     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;(NewToken-&gt;TokenId) );
02189     NewToken-&gt;ParentTokenId = ExistingToken-&gt;TokenId;
02190     NewToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02191     NewToken-&gt;TokenType = ExistingToken-&gt;TokenType;
02192     NewToken-&gt;ImpersonationLevel = ExistingToken-&gt;ImpersonationLevel;
02193 
02194 
02195 
02196     <span class="comment">//</span>
02197     <span class="comment">// Compute the beginning portion of the variable part, which contains the</span>
02198     <span class="comment">// sid &amp; attributes arrays and the privilege set.</span>
02199     <span class="comment">//</span>
02200 
02201     <span class="comment">//</span>
02202     <span class="comment">// First copy the privileges. We will later remove the ones that are</span>
02203     <span class="comment">// to be deleted.</span>
02204     <span class="comment">//</span>
02205 
02206     NextFree = (ULONG_PTR)(&amp;NewToken-&gt;VariablePart);
02207     NewToken-&gt;Privileges = (PLUID_AND_ATTRIBUTES)NextFree;
02208     <a class="code" href="../../d8/d6/sertl_8c.html#a52">RtlCopyLuidAndAttributesArray</a>( ExistingToken-&gt;PrivilegeCount,
02209                                    ExistingToken-&gt;Privileges,
02210                                    (PLUID_AND_ATTRIBUTES)NextFree
02211                                    );
02212 
02213     NextFree += (ExistingToken-&gt;PrivilegeCount * (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES));
02214     VariableLength -= ( (ExistingToken-&gt;PrivilegeCount * (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) );
02215 
02216     <span class="comment">//</span>
02217     <span class="comment">// Figure out the count of SIDs. This is the count of users&amp;groups +</span>
02218     <span class="comment">// the number of existing restricuted SIDs plus the number of new</span>
02219     <span class="comment">// restricted Sids</span>
02220     <span class="comment">//</span>
02221 
02222 <span class="preprocessor">#define MAX(_x_,_y_) ((_x_) &gt; (_y_) ? (_x_) : (_y_))</span>
02223 <span class="preprocessor"></span>
02224     NextSidFree = (PSID) (NextFree + (ExistingToken-&gt;UserAndGroupCount +
02225                                       <a class="code" href="../../d6/d3/tokendup_8c.html#a0">MAX</a>(ExistingToken-&gt;RestrictedSidCount,SidCount)) * <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES));
02226 
02227     NewToken-&gt;UserAndGroups = (PSID_AND_ATTRIBUTES) NextFree;
02228 
02229     <span class="comment">//</span>
02230     <span class="comment">// Copy in the existing users &amp; groups. We will later flag the ones</span>
02231     <span class="comment">// to be disabled.</span>
02232     <span class="comment">//</span>
02233 
02234     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
02235                  ExistingToken-&gt;UserAndGroupCount,
02236                  ExistingToken-&gt;UserAndGroups,
02237                  VariableLength,
02238                  (PSID_AND_ATTRIBUTES)NextFree,
02239                  NextSidFree,
02240                  &amp;NextSidFree,
02241                  &amp;VariableLength
02242                  );
02243 
02244 
02245     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
02246     NextFree += (ExistingToken-&gt;UserAndGroupCount * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES));
02247 
02248     <span class="comment">//</span>
02249     <span class="comment">// Now add all the existing restricted sids. We need to take the</span>
02250     <span class="comment">// intersection of the two sets.</span>
02251     <span class="comment">//</span>
02252 
02253     NewToken-&gt;RestrictedSids = (PSID_AND_ATTRIBUTES) NextFree;
02254 
02255 
02256     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; SidCount ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
02257         <span class="keywordflow">if</span> ( ( ExistingToken-&gt;RestrictedSidCount == 0 ) ||
02258             <a class="code" href="../../d8/d3/tokenp_8h.html#a29">SepSidInSidAndAttributes</a>(
02259                 ExistingToken-&gt;RestrictedSids,
02260                 ExistingToken-&gt;RestrictedSidCount,
02261                 NULL,                           <span class="comment">// no self sid</span>
02262                 RestrictedSids[Index].Sid
02263                 )) {
02264 
02265             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
02266                         1,
02267                         &amp;RestrictedSids[Index],
02268                         VariableLength,
02269                         (PSID_AND_ATTRIBUTES)NextFree,
02270                         NextSidFree,
02271                         &amp;NextSidFree,
02272                         &amp;VariableLength
02273                         );
02274             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
02275             NextFree += <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES);
02276             NewToken-&gt;RestrictedSids[NewToken-&gt;RestrictedSidCount].Attributes =
02277                 SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_MANDATORY;
02278             NewToken-&gt;RestrictedSidCount++;
02279 
02280         }
02281     }
02282 
02283     <span class="comment">//</span>
02284     <span class="comment">// Make sure the new token has some restrictions.</span>
02285     <span class="comment">// If it doesn't, then we've ended up with a token</span>
02286     <span class="comment">// that gives us more access than the original,</span>
02287     <span class="comment">// which we don't want.</span>
02288     <span class="comment">//</span>
02289 
02290     <span class="keywordflow">if</span> ((ExistingToken-&gt;RestrictedSidCount != 0) &amp;&amp;
02291         (NewToken-&gt;RestrictedSidCount == 0)) {
02292 
02293         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ExistingToken );
02294 
02295         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02296 
02297         <span class="comment">//</span>
02298         <span class="comment">// Cleanup.  ObDereferenceObject will cause the logon</span>
02299         <span class="comment">// session to be dereferenced, and will free the proxy data</span>
02300         <span class="comment">// as well as the audit data.</span>
02301         <span class="comment">//</span>
02302         <span class="comment">// See SepTokenDeleteMethod(), which is called by</span>
02303         <span class="comment">// the object manager when the token object is</span>
02304         <span class="comment">// being freed.</span>
02305         <span class="comment">//</span>
02306 
02307         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DynamicPart );
02308 
02309         <span class="comment">//</span>
02310         <span class="comment">// Do this so we don't crash trying to free whatever</span>
02311         <span class="comment">// junk is pointed to by DynamicPart.</span>
02312         <span class="comment">//</span>
02313 
02314         NewToken-&gt;DynamicPart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02315 
02316         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
02317 
02318         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02319     }
02320 
02321     <span class="comment">//</span>
02322     <span class="comment">// If there are any restricted sids in the token, turn on the restricted</span>
02323     <span class="comment">// flag</span>
02324     <span class="comment">//</span>
02325 
02326     <span class="keywordflow">if</span> (NewToken-&gt;RestrictedSidCount &gt; 0) {
02327         NewToken-&gt;TokenFlags |= <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>;
02328     }
02329 
02330     <span class="comment">//</span>
02331     <span class="comment">//  Copy and initialize the dynamic part.</span>
02332     <span class="comment">//  The dynamic part is assumed to be position independent.</span>
02333     <span class="comment">//</span>
02334 
02335     RtlCopyMemory( (PVOID)DynamicPart,
02336                   (PVOID)(ExistingToken-&gt;DynamicPart),
02337                   ExistingToken-&gt;DynamicCharged
02338                   );
02339 
02340     NewToken-&gt;DynamicPart = DynamicPart;
02341 
02342     <span class="comment">//</span>
02343     <span class="comment">// If present, set the address of the default Dacl</span>
02344     <span class="comment">//</span>
02345 
02346     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExistingToken-&gt;DefaultDacl)) {
02347 
02348         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;DefaultDacl) &gt;=
02349                 (ULONG_PTR)(ExistingToken-&gt;DynamicPart) );
02350 
02351         FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;DefaultDacl) -
02352                               (ULONG_PTR)(ExistingToken-&gt;DynamicPart));
02353 
02354         NewToken-&gt;DefaultDacl = (PACL)(FieldOffset + (ULONG_PTR)DynamicPart);
02355 
02356     } <span class="keywordflow">else</span> {
02357 
02358         NewToken-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02359     }
02360 
02361 
02362     <span class="comment">//</span>
02363     <span class="comment">// Set the address of the primary group</span>
02364     <span class="comment">//</span>
02365 
02366     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT(ExistingToken-&gt;PrimaryGroup));
02367 
02368     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ULONG_PTR)(ExistingToken-&gt;PrimaryGroup) &gt;=
02369             (ULONG_PTR)(ExistingToken-&gt;DynamicPart) );
02370 
02371     FieldOffset = (ULONG)((ULONG_PTR)(ExistingToken-&gt;PrimaryGroup) -
02372                           (ULONG_PTR)(ExistingToken-&gt;DynamicPart));
02373 
02374     NewToken-&gt;PrimaryGroup = (PACL)(FieldOffset + (ULONG_PTR)(DynamicPart));
02375 
02376 
02377     <span class="comment">//</span>
02378     <span class="comment">// For the time being, take the easy way to generating an "EffectiveOnly"</span>
02379     <span class="comment">// duplicate.  That is, use the same space required of the original, just</span>
02380     <span class="comment">// eliminate any IDs or privileges not active.</span>
02381     <span class="comment">//</span>
02382     <span class="comment">// Ultimately, if duplication becomes a common operation, then it will be</span>
02383     <span class="comment">// worthwhile to recalculate the actual space needed and copy only the</span>
02384     <span class="comment">// effective IDs/privileges into the new token.</span>
02385     <span class="comment">//</span>
02386 
02387     <a class="code" href="../../d8/d3/tokenp_8h.html#a30">SepRemoveDisabledGroupsAndPrivileges</a>(
02388         NewToken,
02389         Flags,
02390         GroupCount,
02391         GroupsToDisable,
02392         PrivilegeCount,
02393         PrivilegesToDelete
02394         );
02395 
02396 
02397 
02398 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02399 <span class="preprocessor"></span>
02400 <span class="comment">//</span>
02401 <span class="comment">// Debug</span>
02402     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
02403     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
02404     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
02405     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Filter token:\n"</span>);
02406     SepDumpToken( NewToken );
02407 <span class="comment">// Debug</span>
02408 <span class="comment">//</span>
02410 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
02411 <span class="preprocessor"></span>
02412     <span class="comment">//</span>
02413     <span class="comment">// Release the source token.</span>
02414     <span class="comment">//</span>
02415 
02416     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( ExistingToken );
02417 
02418 
02419     (*FilteredToken) = NewToken;
02420     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02421 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="tokenp.h::SepFreeDefaultDacl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepFreeDefaultDacl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00635">635</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>.
<p>
<pre class="fragment"><div>00642                    :
00643 
00644     Free up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token take up by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span>
00645     discretionary access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> list.
00646 
00647     The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be locked <span class="keywordflow">for</span> write access before calling
00648     <span class="keyword">this</span> routine.
00649 
00650 Arguments:
00651 
00652     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00653 
00654 Return Value:
00655 
00656     None.
00657 
00658 --*/
00659 {
00660    ULONG PrimaryGroupSize;
00661 
00662    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Add the size of the Default Dacl (if there is one) to the</span>
00666     <span class="comment">// DynamicAvailable field.</span>
00667     <span class="comment">//</span>
00668     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00669 
00670         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable += <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00671         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00672 
00673     }
00674 
00675     <span class="comment">//</span>
00676     <span class="comment">// If it is not already at the beginning of the dynamic part, move</span>
00677     <span class="comment">// the primary group there (remember to update the pointer to it).</span>
00678     <span class="comment">//</span>
00679 
00680     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart != (PULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup)) {
00681 
00682         PrimaryGroupSize = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00683 
00684         RtlMoveMemory(
00685             (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart),
00686             (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup),
00687             PrimaryGroupSize
00688             );
00689 
00690         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup = (PSID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart);
00691     }
00692 
00693     <span class="keywordflow">return</span>;
00694 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="tokenp.h::SepFreePrimaryGroup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepFreePrimaryGroup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00576">576</a> of file <a class="el" href="../../d1/d3/tokenset_8c-source.html">tokenset.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>.
<p>
<pre class="fragment"><div>00583                    :
00584 
00585     Free up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dynamic part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token take up by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary
00586     group.
00587 
00588     The token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be locked <span class="keywordflow">for</span> write access before calling
00589     <span class="keyword">this</span> routine.
00590 
00591 Arguments:
00592 
00593     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00594 
00595 Return Value:
00596 
00597     None.
00598 
00599 --*/
00600 {
00601     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">// Add the size of the primary group to the DynamicAvailable field.</span>
00605     <span class="comment">//</span>
00606 
00607     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// If there is a default discretionary ACL, and it is not already at the</span>
00611     <span class="comment">// beginning of the dynamic part, move it there (remember to update the</span>
00612     <span class="comment">// pointer to it).</span>
00613     <span class="comment">//</span>
00614 
00615     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00616         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart != (PULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00617 
00618             RtlMoveMemory(
00619                 (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart),
00620                 (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl),
00621                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize
00622                 );
00623 
00624             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = (PACL)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart);
00625 
00626         }
00627     }
00628 
00629     <span class="keywordflow">return</span>;
00630 
00631 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="tokenp.h::SepIdAssignableAsOwner" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepIdAssignableAsOwner           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l02813">2813</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00489">SepTokenGroupAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>, and <a class="el" href="../../d1/d7/subject_8c-source.html#l00381">SepValidOwnerSubjectContext()</a>.
<p>
<pre class="fragment"><div>02821                    :
02822 
02823     This routine returns a <span class="keywordtype">boolean</span> value indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user
02824     or group <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified token with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02825     assignable as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of an object.
02826 
02827     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 0, which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USER <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02828     assignable as owner.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that of a group, and
02829     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"Owner"</span> attribute set to be assignable.
02830 
02831 
02832 
02833 Arguments:
02834 
02835     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to a locked <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> to use.
02836 
02837     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>'s UserAndGroupsArray.  This value
02838         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be valid.
02839 
02840 Return Value:
02841 
02842     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>  - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index corresponds to an <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> that may be assigned
02843             as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of objects.
02844 
02845     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index does not correspond to an <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> that may be
02846             assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of objects.
02847 
02848 --*/
02849 {
02850     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02851 
02852     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == 0) {
02853 
02854         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02855 
02856     } <span class="keywordflow">else</span> {
02857 
02858         <span class="keywordflow">return</span> (BOOLEAN)
02859                    ( (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,Index) &amp; SE_GROUP_OWNER)
02860                      != 0
02861                    );
02862     }
02863 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="tokenp.h::SepMakeTokenEffectiveOnly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepMakeTokenEffectiveOnly           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00806">806</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00489">SepTokenGroupAttributes</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00470">SepTokenPrivilegeAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00075">TOKEN_HAS_ADMIN_GROUP</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>.
<p>
<pre class="fragment"><div>00814                    :
00815 
00816     This routine eliminates all but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effective groups and privileges from
00817     a token.  It does <span class="keyword">this</span> by moving elements of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID and privileges arrays
00818     to overwrite lapsed IDs/privileges, and then reducing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array element
00819     counts.  This results in wasted memory within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object.
00820 
00821     One side effect of <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that a token that initially had a
00822     <span class="keywordflow">default</span> owner <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> corresponding to a lapsed group will be changed so
00823     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> owner <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.
00824 
00825     THIS ROUTINE MUST BE CALLED ONLY AS PART OF <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> CREATION (FOR TOKENS
00826     WHICH HAVE NOT YET BEEN INSERTED INTO AN OBJECT TABLE.)  THIS ROUTINE
00827     MODIFIES READ ONLY <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> FIELDS.
00828 
00829     Note that since we are operating on a token that is not yet visible
00830     to the user, we <span class="keywordflow">do</span> not bother acquiring a read lock on the token
00831     being modified.
00832 
00833 Arguments:
00834 
00835     Token - Points to the token to be made effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
00836 
00837 Return Value:
00838 
00839     None.
00840 
00841 --*/
00842 {
00843 
00844     ULONG Index;
00845     ULONG ElementCount;
00846 
00847     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00848 
00849     <span class="comment">//</span>
00850     <span class="comment">// Walk the privilege array, discarding any lapsed privileges</span>
00851     <span class="comment">//</span>
00852 
00853     ElementCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
00854     Index = 0;
00855 
00856     while (Index &lt; ElementCount) {
00857 
00858         <span class="comment">//</span>
00859         <span class="comment">// If this privilege is not enabled, replace it with the one at</span>
00860         <span class="comment">// the end of the array and reduce the size of the array by one.</span>
00861         <span class="comment">// Otherwise, move on to the next entry in the array.</span>
00862         <span class="comment">//</span>
00863 
00864         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d8/d3/tokenp_8h.html#a11">SepTokenPrivilegeAttributes</a>(Token,Index) &amp; SE_PRIVILEGE_ENABLED)
00865             ) {
00866 
00867             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[Index] =
00868                 (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[ElementCount - 1];
00869             ElementCount -= 1;
00870 
00871         } <span class="keywordflow">else</span> {
00872 
00873             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00874 
00875         }
00876 
00877     } <span class="comment">// endwhile</span>
00878 
00879     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount = ElementCount;
00880 
00881     <span class="comment">//</span>
00882     <span class="comment">// Walk the UserAndGroups array (except for the first entry, which is</span>
00883     <span class="comment">// the user - and can't be disabled) discarding any lapsed groups.</span>
00884     <span class="comment">//</span>
00885 
00886     ElementCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount;
00887     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ElementCount &gt;= 1 );        <span class="comment">// Must be at least a user ID</span>
00888     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;   <span class="comment">// Start at the first group, not the user ID.</span>
00889 
00890     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ElementCount) {
00891 
00892         <span class="comment">//</span>
00893         <span class="comment">// If this group is not enabled, replace it with the one at</span>
00894         <span class="comment">// the end of the array and reduce the size of the array by one.</span>
00895         <span class="comment">//</span>
00896 
00897         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token, Index) &amp; SE_GROUP_ENABLED) &amp;&amp;
00898              !(<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token, Index) &amp; SE_GROUP_USE_FOR_DENY_ONLY) ) {
00899 
00900             <span class="comment">//</span>
00901             <span class="comment">// Reset the TOKEN_HAS_ADMIN_GROUP flag</span>
00902             <span class="comment">//</span>
00903 
00904             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
00905                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[Index].Sid,
00906                     SeAliasAdminsSid
00907                     )) {
00908                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp;= ~<a class="code" href="../../d0/d5/se_8h.html#a4">TOKEN_HAS_ADMIN_GROUP</a>;
00909             }
00910 
00911 
00912             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] =
00913                 (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups)[ElementCount - 1];
00914             ElementCount -= 1;
00915 
00916 
00917 
00918         } <span class="keywordflow">else</span> {
00919 
00920             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00921 
00922         }
00923 
00924     } <span class="comment">// endwhile</span>
00925 
00926     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount = ElementCount;
00927 
00928     <span class="keywordflow">return</span>;
00929 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="tokenp.h::SepObjectInTypeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepObjectInTypeList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN GUID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d3/accessck_8c-source.html#l00388">388</a> of file <a class="el" href="../../d1/d3/accessck_8c-source.html">accessck.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04257">SepExamineSaclEx()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l00992">SepMaximumAccessCheck()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l01304">SepNormalAccessCheck()</a>.
<p>
<pre class="fragment"><div>00396                    :
00397 
00398     This routine searches an ObjectTypeList to determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00399     object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00400 
00401 Arguments:
00402 
00403     ObjectType - Object Type to search <span class="keywordflow">for</span>.
00404 
00405     ObjectTypeList - The object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> list to search.
00406 
00407     ObjectTypeListLength - Number of elements in ObjectTypeList
00408 
00409     ReturnedIndex - <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> element ObjectType was found in
00410 
00411 
00412 Return Value:
00413 
00414     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>: ObjectType was found in list.
00415     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>: ObjectType was not found in list.
00416 
00417 --*/
00418 
00419 {
00420     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00421     GUID *LocalObjectType;
00422 
00423     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00424 
00425     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(GUID) == <span class="keyword">sizeof</span>(ULONG) * 4 );
00426     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;ObjectTypeListLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00427 
00428         LocalObjectType = &amp;ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].ObjectType;
00429 
00430         <span class="keywordflow">if</span>  ( RtlpIsEqualGuid( ObjectType, LocalObjectType ) ) {
00431             *ReturnedIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00432             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00433         }
00434     }
00435 
00436     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00437 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="tokenp.h::SepPrivilegeCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepPrivilegeCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLUID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>RequiredPrivileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RequiredPrivilegeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeSetControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/privileg_8c-source.html#l00038">38</a> of file <a class="el" href="../../d9/d3/privileg_8c-source.html">privileg.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/privileg_8c-source.html#l00231">NtPrivilegeCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00199">SeCheckAuditPrivilege()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00158">SePrivilegeCheck()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00143">SepSinglePrivilegeCheck()</a>.
<p>
<pre class="fragment"><div>00047                    :
00048 
00049     Worker routine <span class="keywordflow">for</span> <a class="code" href="../../d0/d5/se_8h.html#a137">SePrivilegeCheck</a>
00050 
00051 Arguments:
00052 
00053     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - The user's effective token.
00054 
00055     RequiredPrivileges - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> privilege set describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required
00056         privileges.  The UsedForAccess bits will be set in any privilege
00057         that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually used (usually all of them).
00058 
00059     RequiredPrivilegeCount - How many privileges are in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00060         RequiredPrivileges set.
00061 
00062     PrivilegeSetControl - Describes how many privileges are required.
00063 
00064     PreviousMode - The previous processor mode.
00065 
00066 Return Value:
00067 
00068     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> requested privileges are granted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00069 
00070 --*/
00071 
00072 {
00073     PLUID_AND_ATTRIBUTES CurrentRequiredPrivilege;
00074     PLUID_AND_ATTRIBUTES CurrentTokenPrivilege;
00075 
00076     BOOLEAN RequiredAll;
00077 
00078     ULONG TokenPrivilegeCount;
00079     ULONG MatchCount = 0;
00080 
00081     ULONG i;
00082     ULONG j;
00083 
00084     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">//   Take care of kernel callers first</span>
00088     <span class="comment">//</span>
00089 
00090     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00091 
00092          <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00093 
00094     }
00095 
00096     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( Token );
00097 
00098     TokenPrivilegeCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">//   Save whether we require ALL of them or ANY</span>
00102     <span class="comment">//</span>
00103 
00104     RequiredAll = (BOOLEAN)(PrivilegeSetControl &amp; PRIVILEGE_SET_ALL_NECESSARY);
00105 
00106     <span class="keywordflow">for</span> ( i = 0 , CurrentRequiredPrivilege = RequiredPrivileges ;
00107           i &lt; RequiredPrivilegeCount ;
00108           i++, CurrentRequiredPrivilege++ ) {
00109 
00110          <span class="keywordflow">for</span> ( j = 0, CurrentTokenPrivilege = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges;
00111                j &lt; TokenPrivilegeCount ;
00112                j++, CurrentTokenPrivilege++ ) {
00113 
00114               <span class="keywordflow">if</span> ((CurrentTokenPrivilege-&gt;Attributes &amp; SE_PRIVILEGE_ENABLED) &amp;&amp;
00115                    (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;CurrentTokenPrivilege-&gt;Luid,
00116                                  &amp;CurrentRequiredPrivilege-&gt;Luid))
00117                  ) {
00118 
00119                        CurrentRequiredPrivilege-&gt;Attributes |=
00120                                                 SE_PRIVILEGE_USED_FOR_ACCESS;
00121                        MatchCount++;
00122                        <span class="keywordflow">break</span>;     <span class="comment">// start looking for next one</span>
00123               }
00124 
00125          }
00126 
00127     }
00128 
00129     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( Token );
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">//   If we wanted ANY and didn't get any, return failure.</span>
00133     <span class="comment">//</span>
00134 
00135     <span class="keywordflow">if</span> (!RequiredAll &amp;&amp; (MatchCount == 0)) {
00136 
00137          <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00138 
00139     }
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">// If we wanted ALL and didn't get all, return failure.</span>
00143     <span class="comment">//</span>
00144 
00145     <span class="keywordflow">if</span> (RequiredAll &amp;&amp; (MatchCount != RequiredPrivilegeCount)) {
00146 
00147          <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00148     }
00149 
00150     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00151 
00152 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="tokenp.h::SepRemoveDisabledGroupsAndPrivileges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepRemoveDisabledGroupsAndPrivileges           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupsToDisable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegesToDelete</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01041">1041</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01691">SeChangeNotifyPrivilege</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00933">SepSidInSidAndAttributes()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00075">TOKEN_HAS_ADMIN_GROUP</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00072">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>.
<p>
<pre class="fragment"><div>01052                    :
01053 
01054     This routine eliminates all groups and privileges that are marked
01055     to be deleted/disabled. It does <span class="keyword">this</span> by looping through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups in
01056     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token and checking each one agains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> groups to disable. Similary
01057     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilegs are compared.  It does <span class="keyword">this</span> by moving elements of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID and privileges arrays
01058     to overwrite lapsed IDs/privileges, and then reducing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array element
01059     counts.  This results in wasted memory within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object.
01060 
01061 
01062     THIS ROUTINE MUST BE CALLED ONLY AS PART OF <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> CREATION (FOR TOKENS
01063     WHICH HAVE NOT YET BEEN INSERTED INTO AN OBJECT TABLE.)  THIS ROUTINE
01064     MODIFIES READ ONLY <a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> FIELDS.
01065 
01066     Note that since we are operating on a token that is not yet visible
01067     to the user, we <span class="keywordflow">do</span> not bother acquiring a read lock on the token
01068     being modified.
01069 
01070 Arguments:
01071 
01072     Token - Points to the token to be made effective <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
01073 
01074     Flags - Flags indicating additional filtering. The flags may be:
01075 
01076                 DISABLE_ALL_GROUPS  - disable all groups in token
01077                 DELETE_ALL_PRIVILEGES - Disable all privileges
01078 
01079     GroupCount - Count of groups to be removed
01080 
01081     GroupsToDisable - Groups to disable and mark with SE_GROUP_USE_FOR_DENY_ONLY
01082 
01083     PrivilegeCount - Count of privileges to remove
01084 
01085     PrivilegesToDelete - List of privileges to remove
01086 
01087 Return Value:
01088 
01089     None.
01090 
01091 --*/
01092 {
01093 
01094     ULONG Index;
01095     ULONG Index2;
01096     ULONG ElementCount;
01097     BOOLEAN Found;
01098 
01099     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01100 
01101     <span class="comment">//</span>
01102     <span class="comment">// Walk the privilege array, discarding any lapsed privileges</span>
01103     <span class="comment">//</span>
01104 
01105     ElementCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount;
01106     Index = 0;
01107 
01108     while (Index &lt; ElementCount) {
01109 
01110         <span class="comment">//</span>
01111         <span class="comment">// If the caller asked us to disable all privileges except change</span>
01112         <span class="comment">// notify, do so now.</span>
01113         <span class="comment">//</span>
01114 
01115         <span class="keywordflow">if</span> (((Flags &amp; DISABLE_MAX_PRIVILEGE) != 0) &amp;&amp;
01116               !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
01117                 &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges[Index].Luid,
01118                 &amp;SeChangeNotifyPrivilege
01119                 )) {
01120 
01121             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[Index] =
01122                 (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[ElementCount - 1];
01123             ElementCount -= 1;
01124 
01125         } <span class="keywordflow">else</span> {
01126 
01127             <span class="comment">//</span>
01128             <span class="comment">// If this privilege is in the list of those to be removed, replace it</span>
01129             <span class="comment">// with the one at the end of the array and reduce the size of the</span>
01130             <span class="comment">// array by one.  Otherwise, move on to the next entry in the array.</span>
01131             <span class="comment">//</span>
01132 
01133             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01134             <span class="keywordflow">for</span> (Index2 = 0; Index2 &lt; PrivilegeCount ; Index2++ ) {
01135                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
01136                         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges[Index].Luid,
01137                         &amp;PrivilegesToDelete[Index2].Luid
01138                         )) {
01139                     (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] =
01140                         (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges)[ElementCount - 1];
01141                     ElementCount -= 1;
01142 
01143                     <span class="comment">//</span>
01144                     <span class="comment">// If this was SeChangeNotifyPrivilege, we need to turn off</span>
01145                     <span class="comment">// the TOKEN_HAS_TRAVERSE_PRIVILEGE in the token</span>
01146                     <span class="comment">//</span>
01147 
01148                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
01149                             &amp;PrivilegesToDelete[Index2].Luid,
01150                             &amp;SeChangeNotifyPrivilege
01151                             )) {
01152                         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp;= ~<a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
01153                     }
01154 
01155 
01156                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01157                     <span class="keywordflow">break</span>;
01158 
01159                 }
01160             }
01161 
01162             <span class="keywordflow">if</span> (!Found) {
01163                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01164             }
01165         }
01166     } <span class="comment">// endwhile</span>
01167 
01168     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount = ElementCount;
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">// Walk the UserAndGroups array marking any disabled groups.</span>
01172     <span class="comment">//</span>
01173 
01174     ElementCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount;
01175     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ElementCount &gt;= 1 );        <span class="comment">// Must be at least a user ID</span>
01176     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;   <span class="comment">// Start at the first group, not the user ID.</span>
01177 
01178     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ElementCount) {
01179 
01180         <span class="comment">//</span>
01181         <span class="comment">// If this group is not enabled, replace it with the one at</span>
01182         <span class="comment">// the end of the array and reduce the size of the array by one.</span>
01183         <span class="comment">//</span>
01184 
01185         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a29">SepSidInSidAndAttributes</a>(
01186                 GroupsToDisable,
01187                 GroupCount,
01188                 NULL,           <span class="comment">// no principal self sid</span>
01189                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[Index].Sid
01190                 )){
01191 
01192             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes &amp;= ~(SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT);
01193             (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups)[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes |= SE_GROUP_USE_FOR_DENY_ONLY;
01194 
01195             <span class="comment">//</span>
01196             <span class="comment">// If this was the owner, reset the owner to be the user</span>
01197             <span class="comment">//</span>
01198 
01199             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex) {
01200                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex = 0;
01201             }
01202 
01203             <span class="comment">//</span>
01204             <span class="comment">// If this is the admins sid, turn off the admin group flag</span>
01205             <span class="comment">//</span>
01206 
01207             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
01208                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[Index].Sid,
01209                     SeAliasAdminsSid
01210                     )) {
01211 
01212                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp;= ~<a class="code" href="../../d0/d5/se_8h.html#a4">TOKEN_HAS_ADMIN_GROUP</a>;
01213             }
01214         }
01215 
01216         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01217 
01218 
01219     } <span class="comment">// endwhile</span>
01220 
01221 
01222     <span class="keywordflow">return</span>;
01223 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="tokenp.h::SepSidInSidAndAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepSidInSidAndAttributes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>SidAndAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SidCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrincipalSelfSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00933">933</a> of file <a class="el" href="../../d7/d2/tokendup_8c-source.html">tokendup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01615">SePrincipalSelfSid</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, and <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01041">SepRemoveDisabledGroupsAndPrivileges()</a>.
<p>
<pre class="fragment"><div>00942                    :
00943 
00944     Checks to see <span class="keywordflow">if</span> a given SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given token.
00945 
00946     N.B. The code to compute <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of a SID and test <span class="keywordflow">for</span> equality
00947          <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> duplicated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security runtime since <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> such a
00948          frequently used routine.
00949 
00950 Arguments:
00951 
00952     SidAndAttributes - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sid and attributes to be examined
00953 
00954     PrincipalSelfSid - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being access checked <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an object which
00955         represents a principal (e.g., a user object), <span class="keyword">this</span> parameter should
00956         be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  Any ACE containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constant
00957         PRINCIPAL_SELF_SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> replaced by <span class="keyword">this</span> SID.
00958 
00959         The parameter should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object does not represent a principal.
00960 
00961 
00962     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of interest
00963 
00964 Return Value:
00965 
00966     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00967     otherwise.
00968 
00969 --*/
00970 
00971 {
00972 
00973     ULONG i;
00974     PISID MatchSid;
00975     ULONG SidLength;
00976     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00977     PSID_AND_ATTRIBUTES TokenSid;
00978     ULONG UserAndGroupCount;
00979 
00980     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00981 
00982 
00983     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( SidAndAttributes ) ) {
00984         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00985     }
00986 
00987     <span class="comment">//</span>
00988     <span class="comment">// If Sid is the constant PrincipalSelfSid,</span>
00989     <span class="comment">//  replace it with the passed in PrincipalSelfSid.</span>
00990     <span class="comment">//</span>
00991 
00992     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00993          <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SePrincipalSelfSid, Sid ) ) {
00994         Sid = PrincipalSelfSid;
00995     }
00996 
00997     <span class="comment">//</span>
00998     <span class="comment">// Get the length of the source SID since this only needs to be computed</span>
00999     <span class="comment">// once.</span>
01000     <span class="comment">//</span>
01001 
01002     SidLength = 8 + (4 * ((PISID)Sid)-&gt;SubAuthorityCount);
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">// Get address of user/group array and number of user/groups.</span>
01006     <span class="comment">//</span>
01007 
01008     TokenSid = SidAndAttributes;
01009     UserAndGroupCount = SidCount;
01010 
01011     <span class="comment">//</span>
01012     <span class="comment">// Scan through the user/groups and attempt to find a match with the</span>
01013     <span class="comment">// specified SID.</span>
01014     <span class="comment">//</span>
01015 
01016     <span class="keywordflow">for</span> (i = 0 ; i &lt; UserAndGroupCount ; i += 1) {
01017         MatchSid = (PISID)TokenSid-&gt;Sid;
01018 
01019         <span class="comment">//</span>
01020         <span class="comment">// If the SID revision and length matches, then compare the SIDs</span>
01021         <span class="comment">// for equality.</span>
01022         <span class="comment">//</span>
01023 
01024         <span class="keywordflow">if</span> ((((PISID)Sid)-&gt;Revision == MatchSid-&gt;Revision) &amp;&amp;
01025             (SidLength == (8 + (4 * (ULONG)MatchSid-&gt;SubAuthorityCount)))) {
01026             <span class="keywordflow">if</span> (RtlEqualMemory(Sid, MatchSid, SidLength)) {
01027 
01028                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01029 
01030             }
01031         }
01032 
01033         TokenSid += 1;
01034     }
01035 
01036     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01037 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="tokenp.h::SepTokenDeleteMethod" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepTokenDeleteMethod           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l02156">2156</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00737">SepFreeProxyData()</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l01460">SepTokenInitialization()</a>.
<p>
<pre class="fragment"><div>02162                    :
02163 
02164     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>-specific <span class="keyword">delete</span> method.
02165     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to ensure that all memory allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token
02166     gets deallocated.
02167 
02168 Arguments:
02169 
02170     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object being deleted.
02171 
02172 Return Value:
02173 
02174     None.
02175 
02176 --*/
02177 
02178 {
02179     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02180 
02181     <span class="comment">//</span>
02182     <span class="comment">// De-reference the logon session referenced by this token object</span>
02183     <span class="comment">//</span>
02184 
02185     <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;AuthenticationId) );
02186 
02187 
02188     <span class="comment">//</span>
02189     <span class="comment">// If the token has an associated Dynamic part, deallocate it.</span>
02190     <span class="comment">//</span>
02191 
02192     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;DynamicPart)) {
02193         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;DynamicPart );
02194     }
02195 
02196     <span class="comment">//</span>
02197     <span class="comment">// Free the Proxy and Global audit structures if present.</span>
02198     <span class="comment">//</span>
02199 
02200     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *) Token)-&gt;ProxyData)) {
02201         <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;ProxyData );
02202     }
02203 
02204     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;AuditData )) {
02205         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;AuditData) );
02206     }
02207 
02208 
02209     <span class="keywordflow">return</span>;
02210 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="tokenp.h::SepTokenInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepTokenInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l01460">1460</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02156">SepTokenDeleteMethod()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00093">SepTokenLock</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00067">SepTokenMapping</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/seinit_8c-source.html#l00078">SepInitializationPhase0()</a>.
<p>
<pre class="fragment"><div>01464                    :
01465 
01466     This function creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor at system
01467     initialization and stores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor
01468     in global storage.  It also created token related global variables.
01469 
01470     Furthermore, some number of pseudo tokens are created during system
01471     initialization.  These tokens are tracked down and replaced with
01472     real tokens.
01473 
01474 Arguments:
01475 
01476     None.
01477 
01478 Return Value:
01479 
01480     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01481     successfully initialized. Otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01482 
01483 --*/
01484 
01485 {
01486 
01487     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
01488     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01489     UNICODE_STRING TypeName;
01490 
01491     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01492 
01493     <span class="comment">//</span>
01494     <span class="comment">// Initialize string descriptor.</span>
01495     <span class="comment">//</span>
01496 
01497     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, L<span class="stringliteral">"Token"</span>);
01498 
01499 
01500     <span class="comment">//</span>
01501     <span class="comment">// Create the global token lock</span>
01502     <span class="comment">//</span>
01503 
01504     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;SepTokenLock);
01505 
01506 
01507 <span class="preprocessor">#if 0</span>
01508 <span class="preprocessor"></span>BUG, BUG   Need to get system <span class="keywordflow">default</span> ACL to protect token object
01509 <span class="preprocessor">#endif</span>
01510 <span class="preprocessor"></span>
01511     <span class="comment">//</span>
01512     <span class="comment">// Create object type descriptor.</span>
01513     <span class="comment">//</span>
01514 
01515     RtlZeroMemory(&amp;ObjectTypeInitializer,<span class="keyword">sizeof</span>(ObjectTypeInitializer));
01516     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
01517     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_OPENLINK;
01518     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d4/d3/token_8c.html#a0">SepTokenMapping</a>;
01519     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o6">SecurityRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01520     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01521     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
01522     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = TOKEN_ALL_ACCESS;
01523     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d4/d3/token_8c.html#a16">SepTokenDeleteMethod</a>;
01524 
01525     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
01526                                 &amp;ObjectTypeInitializer,
01527                                 (PSECURITY_DESCRIPTOR)NULL,   <span class="comment">// BUG, BUG assign real protection</span>
01528                                 &amp;SepTokenObjectType
01529                                 );
01530 
01531 
01532 <span class="preprocessor">#if 0</span>
01533 <span class="preprocessor"></span>BUG, BUG   Now track down all pseudo tokens used during system initialization
01534 BUG, BUG   and replace them with real ones.
01535 #endif
01536 
01537     <span class="comment">//</span>
01538     <span class="comment">// If the object type descriptor was successfully created, then</span>
01539     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
01540     <span class="comment">//</span>
01541 
01542     <span class="keywordflow">return</span> (BOOLEAN)<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status);
01543 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a20" doxytag="tokenp.h::SepTokenLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d8/d3/tokenp_8h.html#a20">SepTokenLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00674">674</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l01460">SepTokenInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="tokenp.h::SepTokenMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d8/d3/tokenp_8h.html#a18">SepTokenMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00671">671</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l01460">SepTokenInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="tokenp.h::SepTokenObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d8/d3/tokenp_8h.html#a19">SepTokenObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00672">672</a> of file <a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
