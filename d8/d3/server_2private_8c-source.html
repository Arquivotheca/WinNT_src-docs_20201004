<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: private.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>private.c</h1><a href="../../d7/d4/server_2private_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    private.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">        This file implements private APIs for Hardware Desktop Support.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 12-13-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">Notes:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00024 <span class="preprocessor">#pragma hdrstop</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#if defined(FE_SB)</span>
00027 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFullScreenGraphics ; <span class="comment">// Do not trun graphics mode.</span>
00028 <span class="preprocessor">#if defined(i386)</span>
00029 <span class="preprocessor"></span><span class="keyword">extern</span> ULONG  gdwMachineId;
00030 <span class="preprocessor">#endif // i386</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
00033 <span class="comment">//</span>
00034 <span class="comment">// initial palette registers</span>
00035 <span class="comment">//</span>
00036 
<a name="l00037"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a0">00037</a> <span class="preprocessor">#define PAL_BLACK       0</span>
<a name="l00038"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a1">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_BLUE        1</span>
<a name="l00039"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a2">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_GREEN       2</span>
<a name="l00040"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a3">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_RED         4</span>
<a name="l00041"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a4">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_YELLOW      (PAL_RED | PAL_GREEN)</span>
<a name="l00042"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a5">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_CYAN        (PAL_GREEN | PAL_BLUE)</span>
<a name="l00043"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a6">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_MAGENTA     (PAL_BLUE | PAL_RED)</span>
<a name="l00044"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a7">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_WHITE       (PAL_RED | PAL_GREEN | PAL_BLUE)</span>
00045 <span class="preprocessor"></span>
<a name="l00046"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a8">00046</a> <span class="preprocessor">#define PAL_I_BLACK     (PAL_BLACK      + (PAL_WHITE    &lt;&lt; 3))</span>
<a name="l00047"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a9">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_I_RED       (PAL_RED        + (PAL_RED      &lt;&lt; 3))</span>
<a name="l00048"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a10">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_I_GREEN     (PAL_GREEN      + (PAL_GREEN    &lt;&lt; 3))</span>
<a name="l00049"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a11">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_I_YELLOW    (PAL_YELLOW     + (PAL_YELLOW   &lt;&lt; 3))</span>
<a name="l00050"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a12">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_I_BLUE      (PAL_BLUE       + (PAL_BLUE     &lt;&lt; 3))</span>
<a name="l00051"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a13">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_I_CYAN      (PAL_CYAN       + (PAL_CYAN     &lt;&lt; 3))</span>
<a name="l00052"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a14">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_I_MAGENTA   (PAL_MAGENTA    + (PAL_MAGENTA  &lt;&lt; 3))</span>
<a name="l00053"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a15">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define PAL_I_WHITE     (PAL_WHITE      + (PAL_WHITE    &lt;&lt; 3))</span>
00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a16">00055</a> <span class="preprocessor">#define INITIAL_PALETTE_SIZE 18</span>
00056 <span class="preprocessor"></span>
<a name="l00057"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a24">00057</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a24">InitialPalette</a>[<a class="code" href="../../d7/d4/server_2private_8c.html#a16">INITIAL_PALETTE_SIZE</a>] = {
00058 
00059         16, <span class="comment">// 16 entries</span>
00060         0,  <span class="comment">// start with first palette register</span>
00061         0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F
00062 };
00063 
00064 <span class="preprocessor">#if defined(FE_SB)</span>
00065 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> <a class="code" href="../../d0/d3/dbcs_8h.html#a20">RegInitialPalette</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a24">InitialPalette</a>;
00066 <span class="preprocessor">#endif</span>
00067 <span class="preprocessor"></span>
<a name="l00068"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a25">00068</a> UCHAR <a class="code" href="../../d7/d4/server_2private_8c.html#a25">ColorBuffer</a>[] = {
00069 
00070         16, <span class="comment">// 16 entries</span>
00071         0,
00072         0,
00073         0,  <span class="comment">// start with first palette register</span>
00074         0x00, 0x00, 0x00, 0x00, <span class="comment">// black</span>
00075         0x00, 0x00, 0x2A, 0x00, <span class="comment">// blue</span>
00076         0x00, 0x2A, 0x00, 0x00, <span class="comment">// green</span>
00077         0x00, 0x2A, 0x2A, 0x00, <span class="comment">// cyan</span>
00078         0x2A, 0x00, 0x00, 0x00, <span class="comment">// red</span>
00079         0x2A, 0x00, 0x2A, 0x00, <span class="comment">// magenta</span>
00080         0x2A, 0x2A, 0x00, 0x00, <span class="comment">// mustard/brown</span>
00081         0x36, 0x36, 0x36, 0x00, <span class="comment">// light gray  39</span>
00082         0x28, 0x28, 0x28, 0x00, <span class="comment">// dark gray   2A</span>
00083         0x00, 0x00, 0x3F, 0x00, <span class="comment">// bright blue</span>
00084         0x00, 0x3F, 0x00, 0x00, <span class="comment">// bright green</span>
00085         0x00, 0x3F, 0x3F, 0x00, <span class="comment">// bright cyan</span>
00086         0x3F, 0x00, 0x00, 0x00, <span class="comment">// bright red</span>
00087         0x3F, 0x00, 0x3F, 0x00, <span class="comment">// bright magenta</span>
00088         0x3F, 0x3F, 0x00, 0x00, <span class="comment">// bright yellow</span>
00089         0x3F, 0x3F, 0x3F, 0x00  <span class="comment">// bright white</span>
00090 };
00091 
00092 <span class="preprocessor">#if defined(FE_SB)</span>
00093 <span class="preprocessor"></span>PUCHAR <a class="code" href="../../d0/d3/dbcs_8h.html#a21">RegColorBuffer</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a25">ColorBuffer</a>;
00094 PUCHAR <a class="code" href="../../d0/d3/dbcs_8h.html#a22">RegColorBufferNoTranslate</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00095 <span class="preprocessor">#endif</span>
00096 <span class="preprocessor"></span>
00097 <span class="preprocessor">#if defined(FE_SB)</span>
00098 <span class="preprocessor"></span><a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html">MODE_FONT_PAIR</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[] = {
00099     {<a class="code" href="../../d0/d3/dbcs_8h.html#a8">FS_MODE_TEXT</a>, 80, 21, 640, 350, 8, 16},
00100     {<a class="code" href="../../d0/d3/dbcs_8h.html#a8">FS_MODE_TEXT</a>, 80, 25, 720, 400, 8, 16},
00101     {<a class="code" href="../../d0/d3/dbcs_8h.html#a8">FS_MODE_TEXT</a>, 80, 28, 720, 400, 8, 14},
00102     {<a class="code" href="../../d0/d3/dbcs_8h.html#a8">FS_MODE_TEXT</a>, 80, 43, 640, 350, 8, 8 },
00103     {<a class="code" href="../../d0/d3/dbcs_8h.html#a8">FS_MODE_TEXT</a>, 80, 50, 720, 400, 8, 8 }
00104 };
00105 
00106 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>)/<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html">MODE_FONT_PAIR</a>);
00107 <a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html">PMODE_FONT_PAIR</a> <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>;
00108 
00109 SINGLE_LIST_ENTRY <a class="code" href="../../d0/d3/dbcs_8h.html#a25">gRegFullScreenCodePage</a>;    <span class="comment">// This list contain FS_CODEPAGE data.</span>
00110 
00111 <span class="preprocessor">#else</span>
00112 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html">_MODE_FONT_PAIR</a> {
<a name="l00113"></a><a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o4">00113</a>     ULONG <a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o4">Height</a>;
<a name="l00114"></a><a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">00114</a>     COORD <a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>;
<a name="l00115"></a><a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">00115</a>     COORD <a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
00116 } <a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html">MODE_FONT_PAIR</a>, <a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html">PMODE_FONT_PAIR</a>;
00117 
<a name="l00118"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a17">00118</a> <span class="preprocessor">#define NUMBER_OF_MODE_FONT_PAIRS 5</span>
00119 <span class="preprocessor"></span>
<a name="l00120"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a28">00120</a> <a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html">MODE_FONT_PAIR</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>] = {
00121     {21, 640, 350, 8, 16},
00122     {25, 720, 400, 8, 16},
00123     {28, 720, 400, 8, 14},
00124     {43, 640, 350, 8, 8 },
00125     {50, 720, 400, 8, 8 }
00126 };
00127 <span class="preprocessor">#endif</span>
00128 <span class="preprocessor"></span>
00129 
<a name="l00130"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a29">00130</a> HANDLE <a class="code" href="../../d7/d4/server_2private_8c.html#a29">hCPIFile</a>;    <span class="comment">// handle to font file</span>
00131 
<a name="l00132"></a><a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html">00132</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html">_FONTFILEHEADER</a> {
<a name="l00133"></a><a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o0">00133</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o0">ffhFileTag</a>[8]; <span class="comment">// SHOULD BE 0FFH,"FONT___"</span>
<a name="l00134"></a><a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o1">00134</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o1">ffhReserved</a>[8];
<a name="l00135"></a><a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o2">00135</a>     WORD  <a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o2">ffhPointers</a>;
<a name="l00136"></a><a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o3">00136</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o3">ffhPointerType</a>;
<a name="l00137"></a><a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o4">00137</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o4">ffhOffset1</a>;
<a name="l00138"></a><a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o5">00138</a>     WORD  <a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o5">ffhOffset2</a>;
<a name="l00139"></a><a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o6">00139</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o6">ffhOffset3</a>;
00140 } <a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html">FONTFILEHEADER</a>, *<a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html">LPFONTFILEHEADER</a>;
00141 
<a name="l00142"></a><a class="code" href="../../d0/d0/struct__FONTINFOHEADER.html">00142</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d0/struct__FONTINFOHEADER.html">_FONTINFOHEADER</a> {
<a name="l00143"></a><a class="code" href="../../d0/d0/struct__FONTINFOHEADER.html#o0">00143</a>     WORD  <a class="code" href="../../d0/d0/struct__FONTINFOHEADER.html#o0">fihCodePages</a>;
00144 } <a class="code" href="../../d0/d0/struct__FONTINFOHEADER.html">FONTINFOHEADER</a>, *<a class="code" href="../../d0/d0/struct__FONTINFOHEADER.html">LPFONTINFOHEADER</a>;
00145 
<a name="l00146"></a><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html">00146</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html">_CPENTRYHEADER</a> {
<a name="l00147"></a><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o0">00147</a>     WORD  <a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o0">cpeLength</a>;
<a name="l00148"></a><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o1">00148</a>     WORD  <a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o1">cpeNext1</a>;
<a name="l00149"></a><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o2">00149</a>     WORD  <a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o2">cpeNext2</a>;
<a name="l00150"></a><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o3">00150</a>     WORD  <a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o3">cpeDevType</a>;
<a name="l00151"></a><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o4">00151</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o4">cpeDevSubtype</a>[8];
<a name="l00152"></a><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o5">00152</a>     WORD  <a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o5">cpeCodepageID</a>;
<a name="l00153"></a><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o6">00153</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o6">cpeReserved</a>[6];
<a name="l00154"></a><a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o7">00154</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o7">cpeOffset</a>;
00155 } <a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html">CPENTRYHEADER</a>, *<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html">LPCPENTRYHEADER</a>;
00156 
<a name="l00157"></a><a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html">00157</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html">_FONTDATAHEADER</a> {
<a name="l00158"></a><a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html#o0">00158</a>     WORD  <a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html#o0">fdhReserved</a>;
<a name="l00159"></a><a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html#o1">00159</a>     WORD  <a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html#o1">fdhFonts</a>;
<a name="l00160"></a><a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html#o2">00160</a>     WORD  <a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html#o2">fdhLength</a>;
00161 } <a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html">FONTDATAHEADER</a>, *<a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html">LPFONTDATAHEADER</a>;
00162 
<a name="l00163"></a><a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html">00163</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html">_SCREENFONTHEADER</a> {
<a name="l00164"></a><a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">00164</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">sfhHeight</a>;
<a name="l00165"></a><a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o1">00165</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o1">sfhWidth</a>;
<a name="l00166"></a><a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o2">00166</a>     WORD  <a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o2">sfhAspect</a>;
<a name="l00167"></a><a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o3">00167</a>     WORD  <a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o3">sfhCharacters</a>;
00168 } <a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html">SCREENFONTHEADER</a>, *<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html">LPSCREENFONTHEADER</a>;
00169 
<a name="l00170"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a18">00170</a> <span class="preprocessor">#define CONSOLE_WINDOWS_DIR_LENGTH 256</span>
<a name="l00171"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a19">00171</a> <span class="preprocessor"></span><span class="preprocessor">#define CONSOLE_EGACPI_LENGTH 9 // includes NULL</span>
<a name="l00172"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a20">00172</a> <span class="preprocessor"></span><span class="preprocessor">#define CONSOLE_EGACPI "\\ega.cpi"</span>
<a name="l00173"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a21">00173</a> <span class="preprocessor"></span><span class="preprocessor">#define CONSOLE_FONT_BUFFER_LENGTH 50</span>
<a name="l00174"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a22">00174</a> <span class="preprocessor"></span><span class="preprocessor">#define CONSOLE_DEFAULT_ROM_FONT 437</span>
00175 <span class="preprocessor"></span>
00176 
00177 <span class="preprocessor">#ifdef i386</span>
00178 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00179 ReverseMousePointer(
00180     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00181     IN PSMALL_RECT Region
00182     );
00183 
00184 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00185 <a class="code" href="../../d6/d2/output_8c.html#a50">ReadRectFromScreenBuffer</a>(
00186     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00187     IN COORD SourcePoint,
00188     IN PCHAR_INFO Target,
00189     IN COORD TargetSize,
00190     IN PSMALL_RECT TargetRect
00191     );
00192 
00193 <span class="preprocessor">#endif</span>
00194 <span class="preprocessor"></span>
00195 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00196 <a class="code" href="../../d7/d4/server_2private_8c.html#a40">MapViewOfSection</a>(
00197     PHANDLE SectionHandle,
00198     ULONG CommitSize,
00199     PVOID *BaseAddress,
00200     PSIZE_T ViewSize,
00201     HANDLE ClientHandle,
00202     PVOID *BaseClientAddress
00203     );
00204 
00205 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00206 <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(
00207     IN BOOL Connect,
00208     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00209     );
00210 
00211 
00212 ULONG
<a name="l00213"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a42">00213</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a42">SrvSetConsoleCursor</a>(
00214     IN OUT PCSR_API_MSG m,
00215     IN OUT PCSR_REPLY_STATUS ReplyStatus
00216     )
00217 
00218 <span class="comment">/*++</span>
00219 <span class="comment"></span>
00220 <span class="comment">Description:</span>
00221 <span class="comment"></span>
00222 <span class="comment">    Sets the mouse pointer for the specified screen buffer.</span>
00223 <span class="comment"></span>
00224 <span class="comment">Parameters:</span>
00225 <span class="comment"></span>
00226 <span class="comment">    hConsoleOutput - Supplies a console output handle.</span>
00227 <span class="comment"></span>
00228 <span class="comment">    hCursor - win32 cursor handle, should be NULL to set the default</span>
00229 <span class="comment">        cursor.</span>
00230 <span class="comment"></span>
00231 <span class="comment">Return value:</span>
00232 <span class="comment"></span>
00233 <span class="comment">    TRUE - The operation was successful.</span>
00234 <span class="comment"></span>
00235 <span class="comment">    FALSE/NULL - The operation failed. Extended error status is available</span>
00236 <span class="comment">        using GetLastError.</span>
00237 <span class="comment"></span>
00238 <span class="comment">--*/</span>
00239 
00240 {
00241     <a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html">PCONSOLE_SETCURSOR_MSG</a> a = (<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html">PCONSOLE_SETCURSOR_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00242     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00243     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00244     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00245 
00246     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html#o0">ConsoleHandle</a>,
00247                          &amp;Console
00248                         );
00249     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00250         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00251     }
00252     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00253                                  a-&gt;<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html#o1">OutputHandle</a>,
00254                                  <a class="code" href="../../d1/d7/server_8h.html#a48">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>,
00255                                  GENERIC_WRITE,
00256                                  &amp;HandleData
00257                                 );
00258     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00259         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html#o2">CursorHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00260             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorHandle = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a7">ghNormalCursor</a>;
00261         } <span class="keywordflow">else</span> {
00262             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorHandle = a-&gt;<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html#o2">CursorHandle</a>;
00263         }
00264         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hWnd,
00265                      WM_SETCURSOR,
00266                      0,
00267                      -1
00268                     );
00269     }
00270     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00271     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00272     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00273 }
00274 
00275 <span class="preprocessor">#ifdef i386</span>
00276 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00277 FullScreenCursor(
00278     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00279     IN BOOL On
00280     )
00281 {
00282     <span class="keywordflow">if</span> (On) {
00283         <span class="keywordflow">if</span> (ScreenInfo-&gt;CursorDisplayCount &lt; 0) {
00284             ScreenInfo-&gt;CursorDisplayCount = 0;
00285             ReverseMousePointer(ScreenInfo, &amp;ScreenInfo-&gt;Window);
00286         }
00287     } <span class="keywordflow">else</span> {
00288         <span class="keywordflow">if</span> (ScreenInfo-&gt;CursorDisplayCount &gt;= 0) {
00289             ReverseMousePointer(ScreenInfo, &amp;ScreenInfo-&gt;Window);
00290             ScreenInfo-&gt;CursorDisplayCount = -1;
00291         }
00292     }
00293 
00294 }
00295 <span class="preprocessor">#endif</span>
00296 <span class="preprocessor"></span>
00297 ULONG
<a name="l00298"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a43">00298</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a43">SrvShowConsoleCursor</a>(
00299     IN OUT PCSR_API_MSG m,
00300     IN OUT PCSR_REPLY_STATUS ReplyStatus
00301     )
00302 
00303 <span class="comment">/*++</span>
00304 <span class="comment"></span>
00305 <span class="comment">Description:</span>
00306 <span class="comment"></span>
00307 <span class="comment">    Sets the mouse pointer visibility counter.  If the counter is less than</span>
00308 <span class="comment">    zero, the mouse pointer is not shown.</span>
00309 <span class="comment"></span>
00310 <span class="comment">Parameters:</span>
00311 <span class="comment"></span>
00312 <span class="comment">    hOutput - Supplies a console output handle.</span>
00313 <span class="comment"></span>
00314 <span class="comment">    bShow - if TRUE, the display count is to be increased. if FALSE,</span>
00315 <span class="comment">        decreased.</span>
00316 <span class="comment"></span>
00317 <span class="comment">Return value:</span>
00318 <span class="comment"></span>
00319 <span class="comment">    The return value specifies the new display count.</span>
00320 <span class="comment"></span>
00321 <span class="comment">--*/</span>
00322 
00323 {
00324     <a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html">PCONSOLE_SHOWCURSOR_MSG</a> a = (<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html">PCONSOLE_SHOWCURSOR_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00325     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00326     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00327     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00328 
00329     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o0">ConsoleHandle</a>,
00330                          &amp;Console
00331                         );
00332     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00333         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00334     }
00335     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00336                                  a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o1">OutputHandle</a>,
00337                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a> | <a class="code" href="../../d1/d7/server_8h.html#a48">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>,
00338                                  GENERIC_WRITE,
00339                                  &amp;HandleData
00340                                 );
00341     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00342         <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) ) {
00343             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o2">bShow</a>) {
00344                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorDisplayCount += 1;
00345             } <span class="keywordflow">else</span> {
00346                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorDisplayCount -= 1;
00347             }
00348             <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer == Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) {
00349                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hWnd,
00350                              WM_SETCURSOR,
00351                              0,
00352                              -1
00353                             );
00354             }
00355         } <span class="keywordflow">else</span> {
00356 <span class="preprocessor">#ifdef i386</span>
00357 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> != <a class="code" href="../../d1/d7/server_8h.html#a48">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a> &amp;&amp;
00358                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE &amp;&amp;
00359                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer == Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) {
00360                 FullScreenCursor(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer,a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o2">bShow</a>);
00361             }
00362 <span class="preprocessor">#endif</span>
00363 <span class="preprocessor"></span>        }
00364         a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o3">DisplayCount</a> = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorDisplayCount;
00365     }
00366     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00367     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00368     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00369 }
00370 
00371 
00372 ULONG
<a name="l00373"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a44">00373</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a44">SrvConsoleMenuControl</a>(
00374     IN OUT PCSR_API_MSG m,
00375     IN OUT PCSR_REPLY_STATUS ReplyStatus
00376     )
00377 
00378 <span class="comment">/*++</span>
00379 <span class="comment"></span>
00380 <span class="comment">Description:</span>
00381 <span class="comment"></span>
00382 <span class="comment">    Sets the command id range for the current screen buffer and returns the</span>
00383 <span class="comment">    menu handle.</span>
00384 <span class="comment"></span>
00385 <span class="comment">Parameters:</span>
00386 <span class="comment"></span>
00387 <span class="comment">    hConsoleOutput - Supplies a console output handle.</span>
00388 <span class="comment"></span>
00389 <span class="comment">    dwCommandIdLow - Specifies the lowest command id to store in the input buffer.</span>
00390 <span class="comment"></span>
00391 <span class="comment">    dwCommandIdHigh - Specifies the highest command id to store in the input</span>
00392 <span class="comment">        buffer.</span>
00393 <span class="comment"></span>
00394 <span class="comment">Return value:</span>
00395 <span class="comment"></span>
00396 <span class="comment">    TRUE - The operation was successful.</span>
00397 <span class="comment"></span>
00398 <span class="comment">    FALSE/NULL - The operation failed. Extended error status is available</span>
00399 <span class="comment">        using GetLastError.</span>
00400 <span class="comment"></span>
00401 <span class="comment">--*/</span>
00402 
00403 {
00404     <a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html">PCONSOLE_MENUCONTROL_MSG</a> a = (<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html">PCONSOLE_MENUCONTROL_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00405     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00406     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00407     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00408 
00409     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o0">ConsoleHandle</a>,
00410                          &amp;Console
00411                         );
00412     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00413         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00414     }
00415     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00416                                  a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o1">OutputHandle</a>,
00417                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a> | <a class="code" href="../../d1/d7/server_8h.html#a48">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>,
00418                                  GENERIC_WRITE,
00419                                  &amp;HandleData
00420                                 );
00421     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00422         a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o4">hMenu</a> = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hMenu;
00423         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CommandIdLow = a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o2">CommandIdLow</a>;
00424         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CommandIdHigh = a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o3">CommandIdHigh</a>;
00425     }
00426     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00427     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00428     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00429 }
00430 
00431 ULONG
<a name="l00432"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a45">00432</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a45">SrvSetConsolePalette</a>(
00433     IN OUT PCSR_API_MSG m,
00434     IN OUT PCSR_REPLY_STATUS ReplyStatus
00435     )
00436 
00437 <span class="comment">/*++</span>
00438 <span class="comment"></span>
00439 <span class="comment">Description:</span>
00440 <span class="comment"></span>
00441 <span class="comment">    Sets the palette for the console screen buffer.</span>
00442 <span class="comment"></span>
00443 <span class="comment">Parameters:</span>
00444 <span class="comment"></span>
00445 <span class="comment">    hOutput - Supplies a console output handle.</span>
00446 <span class="comment"></span>
00447 <span class="comment">    hPalette - Supplies a handle to the palette to set.</span>
00448 <span class="comment"></span>
00449 <span class="comment">    dwUsage - Specifies use of the system palette.</span>
00450 <span class="comment"></span>
00451 <span class="comment">        SYSPAL_NOSTATIC - System palette contains no static colors</span>
00452 <span class="comment">                          except black and white.</span>
00453 <span class="comment"></span>
00454 <span class="comment">        SYSPAL_STATIC -   System palette contains static colors</span>
00455 <span class="comment">                          which will not change when an application</span>
00456 <span class="comment">                          realizes its logical palette.</span>
00457 <span class="comment"></span>
00458 <span class="comment">Return value:</span>
00459 <span class="comment"></span>
00460 <span class="comment">    TRUE - The operation was successful.</span>
00461 <span class="comment"></span>
00462 <span class="comment">    FALSE/NULL - The operation failed. Extended error status is available</span>
00463 <span class="comment">        using GetLastError.</span>
00464 <span class="comment"></span>
00465 <span class="comment">--*/</span>
00466 
00467 {
00468     <a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html">PCONSOLE_SETPALETTE_MSG</a> a = (<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html">PCONSOLE_SETPALETTE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00469     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00470     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00471     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00472     HPALETTE hOldPalette;
00473 
00474     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o0">ConsoleHandle</a>,
00475                          &amp;Console
00476                         );
00477     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00478         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00479     }
00480     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00481                                  a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o1">OutputHandle</a>,
00482                                  <a class="code" href="../../d1/d7/server_8h.html#a48">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>,
00483                                  GENERIC_WRITE,
00484                                  &amp;HandleData
00485                                 );
00486     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00487         USERTHREAD_USEDESKTOPINFO utudi;
00488         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00489 
00490         <span class="comment">/*</span>
00491 <span class="comment">         * Palette handle was converted in the client.</span>
00492 <span class="comment">         */</span>
00493         <span class="keywordflow">if</span> (GetCurrentThreadId() != HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;
00494                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o1">ThreadId</a>) {
00495             bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00496             utudi.hThread = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;InputThreadInfo-&gt;ThreadHandle;
00497             utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00498             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00499                     UserThreadUseDesktop,
00500                     &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00501         }
00502 
00503         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsolePublicPalette, &amp;(a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o2">hPalette</a>), <span class="keyword">sizeof</span>(HPALETTE));
00504 
00505         hOldPalette = <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(
00506                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hDC,
00507                 a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o2">hPalette</a>,
00508                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00509 
00510         <span class="keywordflow">if</span> (hOldPalette == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00511             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00512         } <span class="keywordflow">else</span> {
00513             <span class="keywordflow">if</span> ((HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;hPalette != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00514                     (a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o2">hPalette</a> != HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;hPalette)) {
00515                 DeleteObject(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;hPalette);
00516             }
00517             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;hPalette = a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o2">hPalette</a>;
00518             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;dwUsage = a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o3">dwUsage</a>;
00519             <span class="keywordflow">if</span> (!(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) &amp;&amp;
00520                     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;FullScreenFlags == 0) {
00521 
00522                 SetSystemPaletteUse(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hDC,
00523                         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;dwUsage);
00524                 <a class="code" href="../../d3/d0/user32_8def.html#a84">RealizePalette</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hDC);
00525             }
00526             <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hSysPalette == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00527                     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hSysPalette = hOldPalette;
00528             }
00529         }
00530 
00531         <span class="keywordflow">if</span> (bReset) {
00532             utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00533             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00534                     UserThreadUseDesktop, &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00535         }
00536     }
00537     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00538     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00539     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00540 }
00541 
00542 
00543 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00544"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a46">00544</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a46">SetActivePalette</a>(
00545     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00546     )
00547 {
00548     USERTHREAD_USEDESKTOPINFO utudi;
00549     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00550 
00551     <span class="keywordflow">if</span> (GetCurrentThreadId() != ScreenInfo-&gt;Console-&gt;InputThreadInfo-&gt;ThreadId) {
00552         bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00553         utudi.hThread = ScreenInfo-&gt;Console-&gt;InputThreadInfo-&gt;ThreadHandle;
00554         utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00555         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00556                 UserThreadUseDesktop,
00557                 &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00558     }
00559 
00560     SetSystemPaletteUse(ScreenInfo-&gt;Console-&gt;hDC,
00561                         ScreenInfo-&gt;dwUsage
00562                        );
00563     <a class="code" href="../../d3/d0/user32_8def.html#a84">RealizePalette</a>(ScreenInfo-&gt;Console-&gt;hDC);
00564 
00565     <span class="keywordflow">if</span> (bReset == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00566         utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00567         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00568                 UserThreadUseDesktop, &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00569     }
00570 }
00571 
00572 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00573"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a47">00573</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a47">UnsetActivePalette</a>(
00574     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00575     )
00576 {
00577     USERTHREAD_USEDESKTOPINFO utudi;
00578     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00579 
00580     <span class="keywordflow">if</span> (GetCurrentThreadId() != ScreenInfo-&gt;Console-&gt;InputThreadInfo-&gt;ThreadId) {
00581         bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00582         utudi.hThread = ScreenInfo-&gt;Console-&gt;InputThreadInfo-&gt;ThreadHandle;
00583         utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00584         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00585                 UserThreadUseDesktop,
00586                 &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00587     }
00588 
00589     SetSystemPaletteUse(ScreenInfo-&gt;Console-&gt;hDC,
00590                         SYSPAL_STATIC
00591                        );
00592     <a class="code" href="../../d3/d0/user32_8def.html#a84">RealizePalette</a>(ScreenInfo-&gt;Console-&gt;hDC);
00593 
00594 
00595     <span class="keywordflow">if</span> (bReset == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00596         utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00597         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00598                 UserThreadUseDesktop, &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00599     }
00600 }
00601 
00602 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00603"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a48">00603</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a48">ConvertToFullScreen</a>(
00604     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00605     )
00606 {
00607 <span class="preprocessor">#ifdef i386</span>
00608 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> Cur;
00609     COORD WindowedWindowSize, WindowSize;
00610 
00611     <span class="comment">// for each charmode screenbuffer</span>
00612     <span class="comment">//     match window size to a mode/font</span>
00613     <span class="comment">//     grow screen buffer if necessary</span>
00614     <span class="comment">//     save old window dimensions</span>
00615     <span class="comment">//     set new window dimensions</span>
00616 
00617     <span class="keywordflow">for</span> (Cur=Console-&gt;ScreenBuffers;Cur!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;Cur=Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>) {
00618 
00619         <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
00620             <span class="keywordflow">continue</span>;
00621         }
00622 
00623         <span class="comment">// save old window dimensions</span>
00624 
00625         WindowedWindowSize.X = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(Cur);
00626         WindowedWindowSize.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Cur);
00627 
00628         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedWindowSize = WindowedWindowSize;
00629         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedScreenSize = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>;
00630 
00631         <span class="comment">// match window size to a mode/font</span>
00632 
00633         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex = MatchWindowSize(
00634                 Console-&gt;OutputCP,
00635                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>, &amp;WindowSize);
00636 
00637         <span class="comment">// grow screen buffer if necessary</span>
00638 
00639         <span class="keywordflow">if</span> (WindowSize.X &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X ||
00640             WindowSize.Y &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y) {
00641             COORD NewScreenSize;
00642 
00643             NewScreenSize.X = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(WindowSize.X,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X);
00644             NewScreenSize.Y = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(WindowSize.Y,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y);
00645 
00646             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a58">ResizeScreenBuffer</a>(Cur, NewScreenSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == STATUS_INVALID_HANDLE) {
00647                 <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00648             }
00649         }
00650 
00651 <span class="preprocessor">#if 0</span>
00652 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"new window size is %d %d\n"</span>,WindowSize.X,WindowSize.Y);
00653 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"existing window size is %d %d\n"</span>,WindowedWindowSize.X,WindowedWindowSize.Y);
00654 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"existing window is %d %d %d %d\n"</span>,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom);
00655 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"screenbuffersize is %d %d\n"</span>,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y);
00656 <span class="preprocessor">#endif</span>
00657 <span class="preprocessor"></span>        <span class="comment">// set new window dimensions</span>
00658         <span class="comment">// we always resize horizontally from the right (change the</span>
00659         <span class="comment">// right edge).</span>
00660         <span class="comment">// we resize vertically from the bottom, keeping the cursor visible.</span>
00661 
00662         <span class="keywordflow">if</span> (WindowedWindowSize.X != WindowSize.X) {
00663             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right -= WindowedWindowSize.X - WindowSize.X;
00664             <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right &gt;= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X) {
00665                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left -= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X + 1;
00666                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right -= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X + 1;
00667             }
00668         }
00669         <span class="keywordflow">if</span> (WindowedWindowSize.Y &gt; WindowSize.Y) {
00670             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom -= WindowedWindowSize.Y - WindowSize.Y;
00671             <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom &gt;= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y) {
00672                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top -= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y + 1;
00673                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y - 1;
00674             }
00675         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WindowedWindowSize.Y &lt; WindowSize.Y) {
00676             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top -= WindowSize.Y - WindowedWindowSize.Y;
00677             <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top &lt; 0) {
00678                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom -= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00679                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top = 0;
00680             }
00681         }
00682         <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom) {
00683             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top += Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom;
00684             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y;
00685         }
00686 <span class="preprocessor">#if 0</span>
00687 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"new window is %d %d %d %d\n"</span>,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom);
00688 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"cursor is %d %d\n"</span>,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y);
00689 <span class="preprocessor">#endif</span>
00690 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(WindowSize.X == <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(Cur));
00691         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(WindowSize.Y == <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Cur));
00692         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.X = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left;
00693         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.Y = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00694 
00695         <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) {
00696             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertToFullScreen converts UnicodeOem -&gt; Unicode\n"</span>));
00697             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a43">FalseUnicodeToRealUnicode</a>(
00698                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows,
00699                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y,
00700                     Console-&gt;OutputCP);
00701         } <span class="keywordflow">else</span> {
00702             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertToFullScreen needs no conversion\n"</span>));
00703         }
00704         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Cur-&gt;BufferInfo.TextInfo.Rows = %lx\n"</span>,
00705                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows));
00706         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Cur-&gt;BufferInfo.TextInfo.TextRows = %lx\n"</span>,
00707                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows));
00708     }
00709 
00710     Cur = Console-&gt;CurrentScreenBuffer;
00711 
00712     <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00713         <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
00714             PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00715             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot;
00716             <span class="keywordflow">while</span> (ConvAreaInfo) {
00717                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00718 
00719                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">StoreTextBufferFontInfo</a>(ConvAreaInfo-&gt;ScreenBuffer,
00720                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(Cur),
00721                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(Cur),
00722                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a63">SCR_FAMILY</a>(Cur),
00723                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a67">SCR_FONTWEIGHT</a>(Cur),
00724                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a65">SCR_FACENAME</a>(Cur),
00725                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a68">SCR_FONTCODEPAGE</a>(Cur));
00726                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00727                     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00728                 }
00729 
00730                 ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex;
00731                 ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext;
00732             }
00733         }
00734         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
00735     }
00736 
00737     <a class="code" href="../../d6/d2/output_8c.html#a68">SetWindowSize</a>(Cur);
00738     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(Cur, &amp;Console-&gt;CurrentScreenBuffer-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
00739 
00740 <span class="preprocessor">#else</span>
00741 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(Console);
00742 <span class="preprocessor">#endif</span>
00743 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00744 }
00745 
00746 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00747"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a49">00747</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a49">ConvertToWindowed</a>(
00748     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00749     )
00750 {
00751 <span class="preprocessor">#ifdef i386</span>
00752 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> Cur;
00753     SMALL_RECT WindowedWindow;
00754 
00755     <span class="comment">// for each charmode screenbuffer</span>
00756     <span class="comment">//     restore window dimensions</span>
00757 
00758     <span class="keywordflow">for</span> (Cur=Console-&gt;ScreenBuffers;Cur!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;Cur=Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>) {
00759         <span class="keywordflow">if</span> ((Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) == 0) {
00760             <span class="keywordflow">continue</span>;
00761         }
00762 
00763         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a58">ResizeScreenBuffer</a>(Cur,
00764                            Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedScreenSize,
00765                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == STATUS_INVALID_HANDLE) {
00766             <span class="comment">/*</span>
00767 <span class="comment">             * Something really went wrong. All we can do is just to</span>
00768 <span class="comment">             * bail out.</span>
00769 <span class="comment">             */</span>
00770             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00771         }
00772 
00773         WindowedWindow.Right  = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right;
00774         WindowedWindow.Bottom = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom;
00775         WindowedWindow.Left   = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right + 1 -
00776                                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedWindowSize.X;
00777         WindowedWindow.Top    = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom + 1 -
00778                                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedWindowSize.Y;
00779         <span class="keywordflow">if</span> (WindowedWindow.Left &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left) {
00780             WindowedWindow.Right -= WindowedWindow.Left - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left;
00781             WindowedWindow.Left = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left;
00782         }
00783         <span class="keywordflow">if</span> (WindowedWindow.Right &lt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X) {
00784             WindowedWindow.Left += Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X - WindowedWindow.Right;
00785             WindowedWindow.Right = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X;
00786         }
00787         <span class="keywordflow">if</span> (WindowedWindow.Top &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top) {
00788             WindowedWindow.Bottom -= WindowedWindow.Top - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00789             WindowedWindow.Top = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00790         }
00791         <span class="keywordflow">if</span> (WindowedWindow.Bottom &lt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y) {
00792             WindowedWindow.Top += Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y - WindowedWindow.Bottom;
00793             WindowedWindow.Bottom = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y;
00794         }
00795         <a class="code" href="../../d6/d2/output_8c.html#a67">ResizeWindow</a>(Cur, &amp;WindowedWindow, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00796 
00797         <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
00798             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a34">SetFont</a>(Cur);
00799         }
00800 
00801         <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) {
00802             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertToWindowed converts Unicode -&gt; UnicodeOem\n"</span>));
00803             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(
00804                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows,
00805                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y,
00806                     Console-&gt;OutputCP);
00807         } <span class="keywordflow">else</span> {
00808             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertToWindowed needs no conversion\n"</span>));
00809         }
00810         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Cur-&gt;BufferInfo.TextInfo.Rows = %lx\n"</span>,
00811                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows));
00812         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Cur-&gt;BufferInfo.TextInfo.TextRows = %lx\n"</span>,
00813                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows));
00814     }
00815 
00816     Cur = Console-&gt;CurrentScreenBuffer;
00817 
00818     <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00819         <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
00820             PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00821             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot;
00822             <span class="keywordflow">while</span> (ConvAreaInfo) {
00823                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00824 
00825                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">StoreTextBufferFontInfo</a>(ConvAreaInfo-&gt;ScreenBuffer,
00826                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(Cur),
00827                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(Cur),
00828                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a63">SCR_FAMILY</a>(Cur),
00829                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a67">SCR_FONTWEIGHT</a>(Cur),
00830                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a65">SCR_FACENAME</a>(Cur),
00831                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a68">SCR_FONTCODEPAGE</a>(Cur));
00832                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00833                     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00834                 }
00835 
00836                 ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex;
00837                 ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext;
00838             }
00839         }
00840         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
00841     }
00842 
00843     <a class="code" href="../../d6/d2/output_8c.html#a68">SetWindowSize</a>(Cur);
00844     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(Cur, &amp;Console-&gt;CurrentScreenBuffer-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
00845 
00846 <span class="preprocessor">#else</span>
00847 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(Console);
00848 <span class="preprocessor">#endif</span>
00849 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00850 }
00851 
00852 ULONG
<a name="l00853"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a50">00853</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a50">SrvSetConsoleDisplayMode</a>(
00854     IN OUT PCSR_API_MSG m,
00855     IN OUT PCSR_REPLY_STATUS ReplyStatus
00856     )
00857 
00858 <span class="comment">/*++</span>
00859 <span class="comment"></span>
00860 <span class="comment">Description:</span>
00861 <span class="comment"></span>
00862 <span class="comment">    This routine sets the console display mode for an output buffer.</span>
00863 <span class="comment">    This API is only supported on x86 machines.  Jazz consoles are always</span>
00864 <span class="comment">    windowed.</span>
00865 <span class="comment"></span>
00866 <span class="comment">Parameters:</span>
00867 <span class="comment"></span>
00868 <span class="comment">    hConsoleOutput - Supplies a console output handle.</span>
00869 <span class="comment"></span>
00870 <span class="comment">    dwFlags - Specifies the display mode. Options are:</span>
00871 <span class="comment"></span>
00872 <span class="comment">        CONSOLE_FULLSCREEN_MODE - data is displayed fullscreen</span>
00873 <span class="comment"></span>
00874 <span class="comment">        CONSOLE_WINDOWED_MODE - data is displayed in a window</span>
00875 <span class="comment"></span>
00876 <span class="comment">    lpNewScreenBufferDimensions - On output, contains the new dimensions of</span>
00877 <span class="comment">        the screen buffer.  The dimensions are in rows and columns for</span>
00878 <span class="comment">        textmode screen buffers.</span>
00879 <span class="comment"></span>
00880 <span class="comment">Return value:</span>
00881 <span class="comment"></span>
00882 <span class="comment">    TRUE - The operation was successful.</span>
00883 <span class="comment"></span>
00884 <span class="comment">    FALSE/NULL - The operation failed. Extended error status is available</span>
00885 <span class="comment">        using GetLastError.</span>
00886 <span class="comment"></span>
00887 <span class="comment">--*/</span>
00888 
00889 {
00890     <a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html">PCONSOLE_SETDISPLAYMODE_MSG</a> a = (<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html">PCONSOLE_SETDISPLAYMODE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00891     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00892     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00893     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00894     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
00895     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> State;
00896     HANDLE  hEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00897 
00898     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html#o0">ConsoleHandle</a>,
00899                          &amp;Console
00900                         );
00901     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00902         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00903     }
00904 
00905     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
00906                                a-&gt;<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html#o4">hEvent</a>,
00907                                NtCurrentProcess(),
00908                                &amp;hEvent,
00909                                0,
00910                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00911                                DUPLICATE_SAME_ACCESS
00912                                );
00913     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00914         <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00915     }
00916     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00917                                  a-&gt;<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html#o1">OutputHandle</a>,
00918                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a> | <a class="code" href="../../d1/d7/server_8h.html#a48">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>,
00919                                  GENERIC_WRITE,
00920                                  &amp;HandleData
00921                                 );
00922     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00923         ScreenInfo = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer;
00924         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo))  {
00925             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00926             <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00927         }
00928         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html#o2">dwFlags</a> == CONSOLE_FULLSCREEN_MODE) {
00929 <span class="preprocessor">#if !defined(_X86_)</span>
00930 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00931                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00932                 <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00933             }
00934 <span class="preprocessor">#else</span>
00935 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
00936                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00937                 <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00938             }
00939 <span class="preprocessor">#endif</span>
00940 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN) {
00941                 KdPrint((<span class="stringliteral">"CONSRV: VDM converting to fullscreen twice\n"</span>));
00942                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00943                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00944                 <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00945             }
00946             State = FULLSCREEN;
00947         } <span class="keywordflow">else</span> {
00948             <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
00949                 KdPrint((<span class="stringliteral">"CONSRV: VDM converting to windowed twice\n"</span>));
00950                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00951                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00952                 <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00953             }
00954             State = WINDOWED;
00955         }
00956         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a76">QueueConsoleMessage</a>(Console,
00957                     <a class="code" href="../../d1/d7/server_8h.html#a73">CM_MODE_TRANSITION</a>,
00958                     State,
00959                     (LPARAM)hEvent
00960                     );
00961         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00962             <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00963         }
00964     }
00965     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00966     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00967 
00968 SrvSetConsoleDisplayModeFailure:
00969     <span class="keywordflow">if</span> (hEvent) {
00970         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(hEvent, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00971         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hEvent);
00972     }
00973     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00974     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00975 
00976     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00977 }
00978 
00979 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00980"></a><a class="code" href="../../d0/d5/srvinit_8c.html#a22">00980</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(
00981     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00982     )
00983 {
00984 <span class="comment">// williamh, Feb 2 1994.</span>
00985 <span class="comment">// catch multiple calls to unregister vdm. Believe it or not, this could</span>
00986 <span class="comment">// happen</span>
00987     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>);
00988     <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>))
00989         <span class="keywordflow">return</span>;
00990 
00991 <span class="preprocessor">#if defined(FE_SB) &amp;&amp; defined(i386)</span>
00992 <span class="preprocessor"></span><span class="comment">// When HDOS apps exit, console screen resolution is changed to 640*400. Because HBIOS set</span>
00993 <span class="comment">// Screen resolution to 640*400. So, we should replace current screen resoultion(640*480).</span>
00994 <span class="comment">// 09/11/96 bklee</span>
00995     {
00996 
00997     <span class="keywordflow">if</span> ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE)  &amp;&amp;
00998         ( Console-&gt;OutputCP == <a class="code" href="../../d0/d3/dbcs_8h.html#a6">KOREAN_CP</a> ||
00999          (Console-&gt;OutputCP == <a class="code" href="../../d0/d3/dbcs_8h.html#a7">JAPAN_CP</a> &amp;&amp; ISNECPC98(gdwMachineId) ) )) {
01000 
01001          ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01002          DEVMODEW Devmode;
01003          <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fGraphics = fFullScreenGraphics ? <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(Console-&gt;OutputCP) : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01004 
01005          <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex;
01006 
01007          ZeroMemory(&amp;Devmode, <span class="keyword">sizeof</span>(Devmode));
01008 
01009          Devmode.dmSize = <span class="keyword">sizeof</span>(Devmode);
01010          Devmode.dmDriverExtra = 0;
01011          Devmode.dmFields = DM_BITSPERPEL   |
01012                             DM_PELSWIDTH    |
01013                             DM_PELSHEIGHT   |
01014                             DM_DISPLAYFLAGS;
01015 
01016          Devmode.dmBitsPerPel   = 4;
01017 
01018          Devmode.dmPelsWidth  = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X;
01019          Devmode.dmPelsHeight = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y;
01020          Devmode.dmDisplayFlags = (fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a9">FS_MODE_GRAPHICS</a>)) ? 0 : DMDISPLAYFLAGS_TEXTMODE;
01021 
01022          GdiFullscreenControl(FullscreenControlSetMode,
01023                               &amp;Devmode,
01024                               <span class="keyword">sizeof</span>(Devmode),
01025                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01026                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01027     }
01028     }
01029 <span class="preprocessor">#endif</span>
01030 <span class="preprocessor"></span><span class="preprocessor">#ifdef i386</span>
01031 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE &amp;&amp;
01032         Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>) {
01033     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleSetVDMCursorBounds, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
01034         <span class="comment">// connect emulator</span>
01035         <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, Console);
01036     }
01037 
01038     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
01039         CloseHandle(Console-&gt;VDMStartHardwareEvent);
01040         CloseHandle(Console-&gt;VDMEndHardwareEvent);
01041         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),Console-&gt;StateBuffer);
01042         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(Console-&gt;VDMProcessHandle,Console-&gt;StateBufferClient);
01043         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;StateSectionHandle);
01044         Console-&gt;StateLength = 0;
01045     }
01046 
01047 <span class="preprocessor">#endif</span>
01048 <span class="preprocessor"></span>
01049     Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>;
01050 
01051     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
01052         USERTHREAD_FLAGS Flags;
01053 
01054         Flags.dwFlags = 0;
01055         Flags.dwMask = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a810">TIF_VDMAPP</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>);
01056         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(Console-&gt;InputThreadInfo-&gt;ThreadHandle,
01057                 UserThreadFlags, &amp;Flags, <span class="keyword">sizeof</span>(Flags));
01058     }
01059     Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>;
01060     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;VDMBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01061     <span class="keywordflow">if</span> (Console-&gt;VDMBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01062         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(Console-&gt;VDMProcessHandle,Console-&gt;VDMBufferClient);
01063         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),Console-&gt;VDMBuffer);
01064         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;VDMBufferSectionHandle);
01065         Console-&gt;VDMBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01066     }
01067 <span class="preprocessor">#ifdef i386</span>
01068 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;CurrentScreenBuffer &amp;&amp;
01069         Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01070         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.MousePosition.X = 0;
01071         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.MousePosition.Y = 0;
01072     }
01073 <span class="preprocessor">#endif</span>
01074 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;VDMProcessHandle);
01075     CloseHandle(Console-&gt;VDMProcessHandle);
01076     Console-&gt;VDMProcessHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01077 
01078 <span class="preprocessor">#if defined(FE_SB) &amp;&amp; defined(FE_IME) &amp;&amp; defined(i386)</span>
01079 <span class="preprocessor"></span>    {
01080         <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) {
01081             Console-&gt;Flags |= CONSOLE_JUST_VDM_UNREGISTERED ;
01082         }
01083         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01084             <a class="code" href="../../d6/d8/dispatch_8h.html#a10">AdjustCursorPosition</a>(Console-&gt;CurrentScreenBuffer,
01085                                  Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.CursorPosition,
01086                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01087                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01088         }
01089     }
01090 <span class="preprocessor">#endif</span>
01091 <span class="preprocessor"></span>}
01092 
01093 ULONG
<a name="l01094"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a52">01094</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a52">SrvRegisterConsoleVDM</a>(
01095     IN OUT PCSR_API_MSG m,
01096     IN OUT PCSR_REPLY_STATUS ReplyStatus
01097     )
01098 {
01099     <a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html">PCONSOLE_REGISTERVDM_MSG</a> a = (<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html">PCONSOLE_REGISTERVDM_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01100     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01101     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01102     SIZE_T ViewSize;
01103 <span class="preprocessor">#ifdef i386</span>
01104 <span class="preprocessor"></span>    VIDEO_REGISTER_VDM RegisterVdm;
01105     ULONG RegisterVdmSize = <span class="keyword">sizeof</span>(RegisterVdm);
01106     VIDEO_VDM Vdm;
01107 <span class="preprocessor">#endif  //i386</span>
01108 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o0">ConsoleHandle</a>,
01109                          &amp;Console
01110                         );
01111     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01112         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01113     }
01114 
01115 
01116     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o1">RegisterFlags</a>) {
01117 <span class="comment">//      williamh, Jan 28 1994</span>
01118 <span class="comment">//      do not do an assert here because we may have unregistered the ntvdm</span>
01119 <span class="comment">//      and the ntvdm doesn't necessarily know this(and it could post another</span>
01120 <span class="comment">//      unregistervdm). Return error here so NTVDM knows what to do</span>
01121 <span class="comment">//      ASSERT(Console-&gt;Flags &amp; CONSOLE_VDM_REGISTERED);</span>
01122 
01123         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01124             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>));
01125             <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01126 <span class="preprocessor">#ifdef i386</span>
01127 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE &amp;&amp;
01128                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01129             <span class="comment">//    SetVideoMode(Console-&gt;CurrentScreenBuffer);</span>
01130                 <span class="comment">//set up cursor</span>
01131                 SetCursorInformationHW(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>,
01132                                        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorSize,
01133                                        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorVisible);
01134                 SetCursorPositionHW(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>,
01135                                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition);
01136             }
01137 <span class="preprocessor">#endif</span>
01138 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01139         } <span class="keywordflow">else</span> {
01140             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01141         }
01142         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01143         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01144     }
01145 
01146     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o4">StateSectionName</a>, a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o5">StateSectionNameLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
01147         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o8">VDMBufferSectionName</a>, a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o9">VDMBufferSectionNameLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01148 
01149         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01150         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01151     }
01152 
01153     <span class="comment">// check it out. A console should have only one VDM registered.</span>
01154     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>));
01155 
01156     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01157         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01158         <span class="keywordflow">return</span> (ULONG) STATUS_ACCESS_DENIED;
01159     }
01160 
01161     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>);
01162 
01163     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(), <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01164                                NtCurrentProcess(), &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,
01165                                0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, DUPLICATE_SAME_ACCESS);
01166     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01167         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01168         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01169     }
01170     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> = <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>();
01171 
01172 <span class="preprocessor">#ifdef i386</span>
01173 <span class="preprocessor"></span>
01174     Vdm.ProcessHandle = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>;
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">// Assume fullscreen initialization will fail.</span>
01178     <span class="comment">// have state length set to zero so that NTVDM will know</span>
01179     <span class="comment">// full screen is disabled.</span>
01180     <span class="comment">//</span>
01181 
01182     a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o6">StateLength</a> = 0;
01183     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o60">StateLength</a> = 0;
01184     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o59">StateBufferClient</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01185 
01186     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
01187 
01188     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01189                    a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o2">StartEvent</a>,
01190                    NtCurrentProcess(),
01191                    &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>,
01192                    0,
01193                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01194                    DUPLICATE_SAME_ACCESS
01195                   );
01196     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01197         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01198                        a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o3">EndEvent</a>,
01199                        NtCurrentProcess(),
01200                        &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o50">VDMEndHardwareEvent</a>,
01201                        0,
01202                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01203                        DUPLICATE_SAME_ACCESS
01204                       );
01205         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01206                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlRegisterVdm,
01207                                          &amp;Vdm,
01208                                          <span class="keyword">sizeof</span>(Vdm),
01209                                          &amp;RegisterVdm,
01210                                          &amp;RegisterVdmSize
01211                                         );
01212 
01213           <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01214 
01215                     <span class="comment">//</span>
01216                     <span class="comment">// create state section and map a view of it into server and vdm.</span>
01217                     <span class="comment">// this section is used to get/set video hardware state during</span>
01218                     <span class="comment">// the fullscreen&lt;-&gt;windowed transition.  we create the section</span>
01219                     <span class="comment">// instead of the vdm for security purposes.</span>
01220                     <span class="comment">//</span>
01221 
01222             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a40">MapViewOfSection</a>(&amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o57">StateSectionHandle</a>,
01223                           RegisterVdm.MinimumStateSize,
01224                           &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o58">StateBuffer</a>,
01225                           &amp;ViewSize,
01226                           Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,
01227                           &amp;a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o7">StateBuffer</a>
01228                          );
01229 
01230             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01231                         a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o6">StateLength</a> = RegisterVdm.MinimumStateSize;
01232                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o60">StateLength</a> = RegisterVdm.MinimumStateSize;
01233                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o59">StateBufferClient</a> = a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o7">StateBuffer</a>;
01234             }
01235 
01236           } <span class="keywordflow">else</span> {
01237 
01238             CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>);
01239             CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o50">VDMEndHardwareEvent</a>);
01240           }
01241 
01242         } <span class="keywordflow">else</span> {
01243 
01244         <span class="comment">// ASSERT(FALSE);</span>
01245         CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>);
01246         CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o50">VDMEndHardwareEvent</a>);
01247        }
01248 
01249     } <span class="keywordflow">else</span> {
01250         CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>);
01251     }
01252     <span class="comment">//</span>
01253     <span class="comment">// if failed to duplicate screen switch events or  map view</span>
01254     <span class="comment">// to video state shared buffer, fails this API</span>
01255     <span class="comment">//</span>
01256     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01257         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01258         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01259     }
01260     }
01261 
01262 <span class="preprocessor">#endif</span>
01263 <span class="preprocessor"></span>    <span class="comment">//</span>
01264     <span class="comment">// create vdm char section and map a view of it into server and vdm.</span>
01265     <span class="comment">// this section is used by the vdm to update the screen when in a</span>
01266     <span class="comment">// charmode window.  this is a performance optimization.  we create</span>
01267     <span class="comment">// the section instead of the vdm for security purposes.</span>
01268     <span class="comment">//</span>
01269 
01270     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a40">MapViewOfSection</a>(&amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o53">VDMBufferSectionHandle</a>,
01271 #ifdef i386
01272                               a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>.X*a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>.Y*2,
01273 #<span class="keywordflow">else</span> <span class="comment">//risc</span>
01274                               a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>.X*a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>.Y*4,
01275 #endif
01276                               &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o54">VDMBuffer</a>,
01277                               &amp;ViewSize,
01278                               Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,
01279                               &amp;a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o11">VDMBuffer</a>
01280                              );
01281     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01282 
01283         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o54">VDMBuffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01284 
01285 <span class="preprocessor">#ifdef i386</span>
01286 <span class="preprocessor"></span>
01287         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
01288 
01289             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o58">StateBuffer</a>);
01290             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o59">StateBufferClient</a>);
01291             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o57">StateSectionHandle</a>);
01292             CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>);
01293             CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o50">VDMEndHardwareEvent</a>);
01294         }
01295 
01296 <span class="preprocessor">#endif</span>
01297 <span class="preprocessor"></span>        CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>);
01298         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01299         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01300         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01301     }
01302     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o55">VDMBufferClient</a> = a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o11">VDMBuffer</a>;
01303 
01304     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>;
01305 
01306     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
01307         USERTHREAD_FLAGS Flags;
01308 
01309         Flags.dwFlags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a810">TIF_VDMAPP</a>;
01310         Flags.dwMask = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a810">TIF_VDMAPP</a>;
01311         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o0">ThreadHandle</a>,
01312                 UserThreadFlags, &amp;Flags, <span class="keyword">sizeof</span>(Flags));
01313     }
01314     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o56">VDMBufferSize</a> = a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>;
01315 
01316     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o1">RegisterFlags</a> &amp; CONSOLE_REGISTER_WOW)
01317         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>;
01318     <span class="keywordflow">else</span>
01319         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>;
01320 
01321     <span class="comment">//</span>
01322     <span class="comment">// if we're already in fullscreen and we run a DOS app for</span>
01323     <span class="comment">// the first time, connect the emulator.</span>
01324     <span class="comment">//</span>
01325 
01326 <span class="preprocessor">#ifdef i386</span>
01327 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) {
01328         RECT CursorRect;
01329         CursorRect.left = -32767;
01330         CursorRect.top = -32767;
01331         CursorRect.right = 32767;
01332         CursorRect.bottom = 32767;
01333         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleSetVDMCursorBounds, &amp;CursorRect, <span class="keyword">sizeof</span>(RECT));
01334         <span class="comment">// connect emulator</span>
01335         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>));
01336         <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, Console);
01337     }
01338 <span class="preprocessor">#endif</span>
01339 <span class="preprocessor"></span>
01340     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01341     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01342     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01343 }
01344 
01345 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01346"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a53">01346</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a53">SrvConsoleNotifyLastClose</a>(
01347     IN OUT PCSR_API_MSG m,
01348     IN OUT PCSR_REPLY_STATUS ReplyStatus
01349     )
01350 {
01351     <a class="code" href="../../d8/d3/struct__CONSOLE__NOTIFYLASTCLOSE__MSG.html">PCONSOLE_NOTIFYLASTCLOSE_MSG</a> a = (<a class="code" href="../../d8/d3/struct__CONSOLE__NOTIFYLASTCLOSE__MSG.html">PCONSOLE_NOTIFYLASTCLOSE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01352     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01353     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01354 
01355     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d8/d3/struct__CONSOLE__NOTIFYLASTCLOSE__MSG.html#o0">ConsoleHandle</a>,
01356                          &amp;Console
01357                         );
01358     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01359         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01360     }
01361 <span class="comment">// williamh, Feb 2 1994.</span>
01362 <span class="comment">// this non-X86 special case is not necessary. We expect</span>
01363 <span class="comment">// ntvdm to call RegisterConsoleVDM API and there we do duplicate</span>
01364 <span class="comment">// the vdm process handle and grab its process id.</span>
01365 <span class="comment">// If we continue to do this we may hit the assert below</span>
01366 <span class="comment">// because when RegisterConsoleVDM failed(short of memory, for example)</span>
01367 <span class="comment">// the VDMProcessHandle may have been set and next time a vdm application</span>
01368 <span class="comment">// was launched from the same console(ntvdm will do the NotifyLastClose</span>
01369 <span class="comment">// before RegisterConsoleVDM).</span>
01370 <span class="preprocessor">#if 0</span>
01371 <span class="preprocessor"></span><span class="preprocessor">#if !defined(_X86_)</span>
01372 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01373     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(), <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01374             NtCurrentProcess(), &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,
01375             0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, DUPLICATE_SAME_ACCESS);
01376     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01377         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01378     }
01379     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> = <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>();
01380 <span class="preprocessor">#endif</span>
01381 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01382 <span class="preprocessor"></span>    <span class="comment">// Doesn't allow two or more processes to have last-close notify on</span>
01383     <span class="comment">// the same console</span>
01384     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>) {
01385         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01386         <span class="keywordflow">return</span> (ULONG)STATUS_ACCESS_DENIED;
01387     }
01388 
01389     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(), <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01390                                NtCurrentProcess(),
01391                                &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o72">hProcessLastNotifyClose</a>,
01392                                0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, DUPLICATE_SAME_ACCESS
01393                                );
01394     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01395         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01396         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01397     }
01398 
01399     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>;
01400     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o73">ProcessIdLastNotifyClose</a> = <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>();
01401     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01402     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01403     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01404 }
01405 
01406 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01407"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a40">01407</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a40">MapViewOfSection</a>(
01408     PHANDLE SectionHandle,
01409     ULONG CommitSize,
01410     PVOID *BaseAddress,
01411     PSIZE_T ViewSize,
01412     HANDLE ClientHandle,
01413     PVOID *BaseClientAddress
01414     )
01415 {
01416 
01417     OBJECT_ATTRIBUTES Obja;
01418     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01419     LARGE_INTEGER secSize;
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">// open section and map a view of it.</span>
01423     <span class="comment">//</span>
01424     InitializeObjectAttributes(
01425         &amp;Obja,
01426         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01427         OBJ_CASE_INSENSITIVE,
01428         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01429         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01430         );
01431 
01432     secSize.QuadPart = CommitSize;
01433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a> (SectionHandle,
01434                               SECTION_ALL_ACCESS,
01435                               &amp;Obja,
01436                               &amp;secSize,
01437                               PAGE_READWRITE,
01438                               SEC_RESERVE,
01439                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01440                              );
01441     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01442         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01443     }
01444 
01445     *BaseAddress = 0;
01446     *ViewSize = 0;
01447 
01448     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(*SectionHandle,
01449                                 NtCurrentProcess(),
01450                                 BaseAddress,        <span class="comment">// Receives the base</span>
01451                                                     <span class="comment">// address of the section.</span>
01452 
01453                                 0,                  <span class="comment">// No specific type of</span>
01454                                                     <span class="comment">// address required.</span>
01455 
01456                                 CommitSize,         <span class="comment">// Commit size. It was</span>
01457                                                     <span class="comment">// passed by the caller.</span>
01458                                                     <span class="comment">// NULL for a save, and</span>
01459                                                     <span class="comment">// size of the section</span>
01460                                                     <span class="comment">// for a set.</span>
01461 
01462                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,               <span class="comment">// Section offset it NULL;</span>
01463                                                     <span class="comment">// Map from the start.</span>
01464 
01465                                 ViewSize,           <span class="comment">// View Size is NULL since</span>
01466                                                     <span class="comment">// we want to map the</span>
01467                                                     <span class="comment">// entire section.</span>
01468 
01469                                 ViewUnmap,
01470                                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01471                                 PAGE_READWRITE
01472                                );
01473     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01474         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(*SectionHandle);
01475         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01476     }
01477 
01478     *BaseClientAddress = 0;
01479     *ViewSize = 0;
01480     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(*SectionHandle,
01481                                 ClientHandle,
01482                                 BaseClientAddress,  <span class="comment">// Receives the base</span>
01483                                                     <span class="comment">// address of the section.</span>
01484 
01485                                 0,                  <span class="comment">// No specific type of</span>
01486                                                     <span class="comment">// address required.</span>
01487 
01488                                 CommitSize,         <span class="comment">// Commit size. It was</span>
01489                                                     <span class="comment">// passed by the caller.</span>
01490                                                     <span class="comment">// NULL for a save, and</span>
01491                                                     <span class="comment">// size of the section</span>
01492                                                     <span class="comment">// for a set.</span>
01493 
01494                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,               <span class="comment">// Section offset it NULL;</span>
01495                                                     <span class="comment">// Map from the start.</span>
01496 
01497                                 ViewSize,           <span class="comment">// View Size is NULL since</span>
01498                                                     <span class="comment">// we want to map the</span>
01499                                                     <span class="comment">// entire section.</span>
01500 
01501                                 ViewUnmap,
01502 <span class="comment">// williamh, Jan 28 1994</span>
01503 <span class="comment">// This MEM_TOP_DOWN is necessary.</span>
01504 <span class="comment">// if the console has VDM registered, ntvdm would have released its video memory</span>
01505 <span class="comment">// address space(0xA0000 ~ 0xBFFFF). Without the MEM_TOP_DOWN, the</span>
01506 <span class="comment">// NtMapViewOfSection can grab the address space and we will have trouble of</span>
01507 <span class="comment">// mapping the address space to the physical video ram. We don't do a test</span>
01508 <span class="comment">// for VDM because there is no harm of doing this for non-vdm application.</span>
01509                                 MEM_TOP_DOWN,
01510                                 PAGE_READWRITE
01511                                );
01512     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01513         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(*SectionHandle);
01514     }
01515     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01516 }
01517 
01518 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01519"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a41">01519</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(
01520     IN BOOL Connect,
01521     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
01522     )
01523 {
01524     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01525     FULLSCREENCONTROL fsctl;
01526     VIDEO_VDM ConnectInfo;
01527     HANDLE ProcessHandle = Console-&gt;VDMProcessHandle;
01528     USERTHREAD_FLAGS Flags;
01529 
01530     <a class="code" href="../../d8/d5/consrv_8h.html#a4">DBGFULLSCR</a>((<span class="stringliteral">"ConnectToEmulator :  %s - entering\n"</span>, Connect ? <span class="stringliteral">"CONNECT"</span> : <span class="stringliteral">"DISCONNECT"</span>));
01531 
01532     Flags.dwMask = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>;
01533     <span class="keywordflow">if</span> (Connect) {
01534         fsctl = FullscreenControlEnable;
01535         Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>;
01536         Flags.dwFlags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>;
01537     } <span class="keywordflow">else</span> {
01538         fsctl = FullscreenControlDisable;
01539         Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>;
01540         Flags.dwFlags = 0;
01541     }
01542 
01543     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
01544         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(Console-&gt;InputThreadInfo-&gt;ThreadHandle,
01545                 UserThreadFlags, &amp;Flags, <span class="keyword">sizeof</span>(Flags));
01546     }
01547 
01548     ConnectInfo.ProcessHandle = ProcessHandle;
01549 
01550 
01551     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(fsctl,
01552                                      &amp;ConnectInfo,
01553                                      <span class="keyword">sizeof</span>(ConnectInfo),
01554                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01555                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01556 
01557     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS || <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PROCESS_IS_TERMINATING);
01558 
01559     <a class="code" href="../../d8/d5/consrv_8h.html#a4">DBGFULLSCR</a>((<span class="stringliteral">"ConnectToEmulator : leaving, staus = %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01560 
01561     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01562 }
01563 
<a name="l01564"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a23">01564</a> <span class="preprocessor">#define CONSOLE_VDM_TIMEOUT 200000</span>
01565 <span class="preprocessor"></span>
01566 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01567"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a54">01567</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a54">DisplayModeTransition</a>(
01568     IN BOOL bForeground,
01569     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01570     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
01571     )
01572 {
01573 <span class="preprocessor">#ifdef i386</span>
01574 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01575     LARGE_INTEGER li;
01576 
01577     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>)
01578         <span class="keywordflow">return</span> STATUS_SUCCESS;
01579 
01580     <span class="keywordflow">if</span> (bForeground) {
01581 
01582         <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo = Console-&gt;CurrentScreenBuffer;
01583         LARGE_INTEGER li;
01584         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01585 
01586         KdPrint((<span class="stringliteral">"    CONSRV - Display Mode transition to fullscreen \n"</span>));
01587 
01588         <span class="keywordflow">if</span> (!(Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01589             KdPrint((<span class="stringliteral">"CONSRV: received fullscreen message too early\n"</span>));
01590             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01591         }
01592 
01593         Console-&gt;FullScreenFlags |= CONSOLE_FULLSCREEN_HARDWARE;
01594 
01595         <span class="keywordflow">if</span> (!(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)) {
01596 <span class="preprocessor">#if defined(FE_SB)</span>
01597 <span class="preprocessor"></span>            <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fGraphics = fFullScreenGraphics ? <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(Console-&gt;OutputCP) : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01598 <span class="preprocessor">#endif</span>
01599 <span class="preprocessor"></span><span class="preprocessor">#if 1</span>
01600 <span class="preprocessor"></span>            DEVMODEW Devmode;
01601             ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01602 
01603             KdPrint((<span class="stringliteral">"CONSRV: ChangeDispSettings fullscreen\n"</span>));
01604 
01605             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex;
01606 
01607             <span class="comment">//</span>
01608             <span class="comment">// set mode to go to full screen</span>
01609             <span class="comment">//</span>
01610 
01611             ZeroMemory(&amp;Devmode, <span class="keyword">sizeof</span>(Devmode));
01612 
01613             Devmode.dmSize = <span class="keyword">sizeof</span>(Devmode);
01614             Devmode.dmDriverExtra = 0;
01615             Devmode.dmFields = DM_BITSPERPEL   |
01616                                DM_PELSWIDTH    |
01617                                DM_PELSHEIGHT   |
01618                                DM_DISPLAYFLAGS;
01619 
01620             Devmode.dmBitsPerPel   = 4;
01621 <span class="preprocessor">#if defined(FE_SB)</span>
01622 <span class="preprocessor"></span>            Devmode.dmPelsWidth    = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X;
01623             Devmode.dmPelsHeight   = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y;
01624             Devmode.dmDisplayFlags = (fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a9">FS_MODE_GRAPHICS</a>)) ? 0 : DMDISPLAYFLAGS_TEXTMODE;
01625 <span class="preprocessor">#else</span>
01626 <span class="preprocessor"></span>            Devmode.dmPelsWidth    = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X;
01627             Devmode.dmPelsHeight   = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y;
01628             Devmode.dmDisplayFlags = DMDISPLAYFLAGS_TEXTMODE;
01629 <span class="preprocessor">#endif</span>
01630 <span class="preprocessor"></span>
01631             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(GdiFullscreenControl(FullscreenControlSetMode,
01632                                                    &amp;Devmode,
01633                                                    <span class="keyword">sizeof</span>(Devmode),
01634                                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01635                                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)))
01636             {
01637 <span class="preprocessor">#endif</span>
01638 <span class="preprocessor"></span>                <span class="comment">// set video mode and font</span>
01639                 <span class="keywordflow">if</span> (SetVideoMode(ScreenInfo)) {
01640 
01641 <span class="preprocessor">#if defined(FE_SB)</span>
01642 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>)) {
01643                         <span class="keywordtype">int</span>     i ;
01644                         <span class="keywordflow">for</span> (i = 0 ; i &lt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y; i++) {
01645                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.OldLeft = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a> ;
01646                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.OldRight = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a> ;
01647                         }
01648                     }
01649 <span class="preprocessor">#endif</span>
01650 <span class="preprocessor"></span>                    <span class="comment">//set up cursor</span>
01651 
01652                     SetCursorInformationHW(ScreenInfo,
01653                                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorSize,
01654                                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorVisible);
01655                     SetCursorPositionHW(ScreenInfo,
01656                                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition);
01657                 }
01658             }
01659         }
01660 
01661         <span class="comment">// tell VDM to unmap memory</span>
01662 
01663         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01664             li.QuadPart = (LONGLONG)-10000 * <a class="code" href="../../d7/d4/server_2private_8c.html#a23">CONSOLE_VDM_TIMEOUT</a>;
01665             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a3">NtSignalAndWaitForSingleObject</a>(Console-&gt;VDMStartHardwareEvent,
01666                                                     Console-&gt;VDMEndHardwareEvent,
01667                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;li);
01668              <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != 0) {
01669                 Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01670                 <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01671                 KdPrint((<span class="stringliteral">"CONSRV: VDM not responding.\n"</span>));
01672              }
01673         }
01674 
01675         <span class="keywordflow">if</span> (!(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)) {
01676 
01677             <a class="code" href="../../d6/d8/dispatch_8h.html#a5">WriteRegionToScreen</a>(ScreenInfo,&amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
01678         }
01679 
01680         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01681 
01682             <span class="comment">// connect emulator and map memory into the VDMs address space.</span>
01683             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>));
01684 
01685             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, Console);
01686 
01687             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01688 
01689                 VIDEO_HARDWARE_STATE State;
01690                 ULONG StateSize = <span class="keyword">sizeof</span>(State);
01691 
01692                 State.StateHeader = Console-&gt;StateBuffer;
01693                 State.StateLength = Console-&gt;StateLength;
01694 
01695 
01696                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlRestoreHardwareState,
01697                                                  &amp;State,
01698                                                  StateSize,
01699                                                  &amp;State,
01700                                                  &amp;StateSize);
01701             }
01702 
01703             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
01704                 Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01705                 <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01706                 KdPrint((<span class="stringliteral">"CONSRV: set hardware state failed.\n"</span>));
01707             } <span class="keywordflow">else</span> {
01708 
01709                 <span class="comment">//</span>
01710                 <span class="comment">// tell VDM that it's getting the hardware.</span>
01711                 <span class="comment">//</span>
01712 
01713                 RECT CursorRect;
01714                 CursorRect.left = -32767;
01715                 CursorRect.top = -32767;
01716                 CursorRect.right = 32767;
01717                 CursorRect.bottom = 32767;
01718                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleSetVDMCursorBounds,
01719                         &amp;CursorRect, <span class="keyword">sizeof</span>(RECT));
01720 
01721                 <span class="comment">// wait for vdm to say ok. We could initiate another switch</span>
01722                 <span class="comment">// (set hStartHardwareEvent which vdm is now waiting for to</span>
01723                 <span class="comment">//  complete the handshaking) when we return(WM_FULLSCREEN</span>
01724                 <span class="comment">// could be in the message queue already). If we don't wait</span>
01725                 <span class="comment">// for vdm to get signaled here, the hStartHardwareEvent</span>
01726                 <span class="comment">// can get set twice and signaled once so the vdm will never</span>
01727                 <span class="comment">// gets the newly switch request we may post after return.</span>
01728                 <a class="code" href="../../d1/d2/obwait_8c.html#a3">NtSignalAndWaitForSingleObject</a>(Console-&gt;VDMStartHardwareEvent,
01729                                                Console-&gt;VDMEndHardwareEvent,
01730                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;li);
01731                 <span class="comment">// no need to check time out here</span>
01732 
01733             }
01734 
01735         }
01736 
01737         <span class="comment">//</span>
01738         <span class="comment">// let the app know that it has the focus.</span>
01739         <span class="comment">//</span>
01740 
01741         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">HandleFocusEvent</a>(Console,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01742 
01743         <span class="comment">// unset palette</span>
01744 
01745         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01746             <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
01747                              ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o13">hSysPalette</a>,
01748                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01749             <a class="code" href="../../d7/d4/server_2private_8c.html#a47">UnsetActivePalette</a>(ScreenInfo);
01750         }
01751         <a class="code" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys</a>(Console-&gt;hWnd, Console-&gt;ReserveKeys);
01752         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">HandleFocusEvent</a>(Console,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01753 
01754     } <span class="keywordflow">else</span> {
01755 
01756         KdPrint((<span class="stringliteral">"    CONSRV - Display Mode transition to windowed \n"</span>));
01757 
01758         <span class="comment">//</span>
01759         <span class="comment">// Check first to see if we're not already fullscreen. If we aren't,</span>
01760         <span class="comment">// don't allow this. Temporary BETA fix till USER gets fixed.</span>
01761         <span class="comment">//</span>
01762         <span class="keywordflow">if</span> (!(Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE)) {
01763             KdPrint((<span class="stringliteral">"CONSRV: received multiple windowed messages\n"</span>));
01764             <span class="keywordflow">return</span> STATUS_SUCCESS;
01765         }
01766 
01767         <span class="comment">// turn off mouse pointer so VDM doesn't see it when saving</span>
01768         <span class="comment">// hardware</span>
01769         <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)) {
01770             ReverseMousePointer(ScreenInfo, &amp;ScreenInfo-&gt;Window);
01771         }
01772 
01773 
01774         Console-&gt;FullScreenFlags &amp;= ~CONSOLE_FULLSCREEN_HARDWARE;
01775         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01776 
01777             <span class="comment">//</span>
01778             <span class="comment">// tell vdm that it's losing the hardware</span>
01779             <span class="comment">//</span>
01780 
01781             li.QuadPart = (LONGLONG)-10000 * <a class="code" href="../../d7/d4/server_2private_8c.html#a23">CONSOLE_VDM_TIMEOUT</a>;
01782             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a3">NtSignalAndWaitForSingleObject</a>(Console-&gt;VDMStartHardwareEvent,
01783                                                     Console-&gt;VDMEndHardwareEvent,
01784                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;li);
01785 
01786             <span class="comment">// if ntvdm didn't respond or we failed to save the video hardware</span>
01787             <span class="comment">// states, kick ntvdm out of our world. The ntvdm process eventually</span>
01788             <span class="comment">// would die but what choice do have here?</span>
01789 
01790             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01791 
01792                 VIDEO_HARDWARE_STATE State;
01793                 ULONG StateSize = <span class="keyword">sizeof</span>(State);
01794 
01795                 State.StateHeader = Console-&gt;StateBuffer;
01796                 State.StateLength = Console-&gt;StateLength;
01797 
01798 
01799                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlSaveHardwareState,
01800                                                  &amp;State,
01801                                                  StateSize,
01802                                                  &amp;State,
01803                                                  &amp;StateSize);
01804             }
01805 
01806             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01807 
01808 
01809                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleSetVDMCursorBounds, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
01810 
01811                 <span class="comment">// disconnect emulator and unmap video memory</span>
01812 
01813                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>);
01814                 <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, Console);
01815 
01816             } <span class="keywordflow">else</span> {
01817 
01818                 Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01819                 <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01820                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != 0) {
01821                     KdPrint((<span class="stringliteral">"CONSRV: VDM not responding.\n"</span>));
01822                 }
01823                 <span class="keywordflow">else</span>
01824                     KdPrint((<span class="stringliteral">"CONSRV: Save Video States Failed\n"</span>));
01825 
01826             }
01827         }
01828 
01829         <span class="comment">// tell VDM to map memory</span>
01830 
01831         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01832 
01833             <span class="comment">// make a special case for ntvdm during switching because</span>
01834             <span class="comment">// ntvdm has to make console api calls. We don't want to</span>
01835             <span class="comment">// unlock the console at this moment because as soon as</span>
01836             <span class="comment">// we release the lock, other theads which are waiting</span>
01837             <span class="comment">// for the lock will claim the lock and the ntvdm thread doing</span>
01838             <span class="comment">// the screen switch will have to wait for the lock. In an</span>
01839             <span class="comment">// extreme case, the following NtWaitForSingleObject will time</span>
01840             <span class="comment">// out because the ntvdm may be still waiting for the lock.</span>
01841             <span class="comment">// We keep this thing in a single global variable because</span>
01842             <span class="comment">// there is only one process who can own the screen at any moment.</span>
01843 
01844             RtlEnterCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a13">ConsoleVDMCriticalSection</a>);
01845             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a> = Console;
01846             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a13">ConsoleVDMCriticalSection</a>);
01847             li.QuadPart = (LONGLONG)-10000 * <a class="code" href="../../d7/d4/server_2private_8c.html#a23">CONSOLE_VDM_TIMEOUT</a>;
01848             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a3">NtSignalAndWaitForSingleObject</a>(Console-&gt;VDMStartHardwareEvent,
01849                                                     Console-&gt;VDMEndHardwareEvent,
01850                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;li);
01851 
01852             <span class="comment">// time to go back to normal</span>
01853             RtlEnterCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a13">ConsoleVDMCriticalSection</a>);
01854             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01855             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a13">ConsoleVDMCriticalSection</a>);
01856 
01857             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != 0) {
01858                 Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01859                 <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01860                 KdPrint((<span class="stringliteral">"CONSRV: VDM not responding. - second wait\n"</span>));
01861                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01862             }
01863             ScreenInfo = Console-&gt;CurrentScreenBuffer;
01864         }
01865 
01866         <span class="comment">// set palette</span>
01867 
01868         <span class="keywordflow">if</span> (ScreenInfo-&gt;hPalette != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01869             <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(ScreenInfo-&gt;Console-&gt;hDC,
01870                              ScreenInfo-&gt;hPalette,
01871                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01872             <a class="code" href="../../d7/d4/server_2private_8c.html#a46">SetActivePalette</a>(ScreenInfo);
01873         }
01874         <a class="code" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys</a>(Console-&gt;hWnd, CONSOLE_NOSHORTCUTKEY);
01875         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">HandleFocusEvent</a>(Console,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01876 
01877     }
01878 
01879     <span class="comment">/*</span>
01880 <span class="comment">     * Boost or lower the priority if we are going fullscreen or away.</span>
01881 <span class="comment">     *</span>
01882 <span class="comment">     * Note that console usually boosts and lowers its priority based</span>
01883 <span class="comment">     * on WM_FOCUSS and WM_KILLFOCUS but when you switch to full screen</span>
01884 <span class="comment">     * the implementation actually sends a WM_KILLFOCUS so we reboost the</span>
01885 <span class="comment">     * correct console here.</span>
01886 <span class="comment">     */</span>
01887     <a class="code" href="../../d6/d2/output_8c.html#a74">ModifyConsoleProcessFocus</a>(Console, bForeground);
01888 
01889 
01890 <span class="preprocessor">#else</span>
01891 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(bForeground);
01892     UNREFERENCED_PARAMETER(Console);
01893     UNREFERENCED_PARAMETER(ScreenInfo);
01894 <span class="preprocessor">#endif</span>
01895 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
01896 }
01897 
01898 <span class="preprocessor">#if defined(_X86_)</span>
01899 <span class="preprocessor"></span>
01900 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
01901 SetVideoMode(
01902     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
01903     )
01904 {
01905     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01906     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i, j;
01907 
01908 <span class="preprocessor">#if defined(FE_SB)</span>
01909 <span class="preprocessor"></span>    <span class="comment">//</span>
01910     <span class="comment">// load RAM font</span>
01911     <span class="comment">//</span>
01912 
01913     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a63">SetRAMFontCodePage</a>(ScreenInfo);
01914 <span class="preprocessor">#endif</span>
01915 <span class="preprocessor"></span>
01916     <span class="comment">//</span>
01917     <span class="comment">// load ROM font</span>
01918     <span class="comment">//</span>
01919 
01920     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = SetROMFontCodePage(ScreenInfo-&gt;Console-&gt;OutputCP,
01921                                 ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex);
01922 
01923     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_PARAMETER) {
01924         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = SetROMFontCodePage(GetOEMCP(),
01925                                     ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex);
01926 
01927         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_PARAMETER) {
01928             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = SetROMFontCodePage(CONSOLE_DEFAULT_ROM_FONT,
01929                                         ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex);
01930         }
01931     }
01932 
01933     <span class="comment">//</span>
01934     <span class="comment">// initialize palette</span>
01935     <span class="comment">//</span>
01936 
01937 <span class="preprocessor">#if defined(FE_SB)</span>
01938 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlSetPalette,
01939                                   (PVOID) RegInitialPalette,
01940                                   RegInitialPalette[0] * <span class="keyword">sizeof</span>(USHORT) + <span class="keyword">sizeof</span>(DWORD),
01941                                   NULL,
01942                                   NULL);
01943 <span class="preprocessor">#else</span>
01944 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlSetPalette,
01945                                   (PVOID) &amp;InitialPalette,
01946                                   <span class="keyword">sizeof</span> (InitialPalette),
01947                                   NULL,
01948                                   NULL);
01949 <span class="preprocessor">#endif</span>
01950 <span class="preprocessor"></span>
01951     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
01952         KdPrint((<span class="stringliteral">"CONSRV: FullscreenControlSetPalette failed - status = %x\n"</span>,
01953                  Status));
01954         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
01955         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01956     }
01957 
01958     <span class="comment">//</span>
01959     <span class="comment">// initialize color table</span>
01960     <span class="comment">//</span>
01961 
01962 <span class="preprocessor">#if defined(FE_SB)</span>
01963 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a22">RegColorBufferNoTranslate</a>)
01964     {
01965         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlSetColors,
01966                                       (PVOID) RegColorBufferNoTranslate,
01967                                       RegColorBufferNoTranslate[0] * <span class="keyword">sizeof</span>(DWORD) + <span class="keyword">sizeof</span>(DWORD),
01968                                       NULL,
01969                                       NULL);
01970     }
01971     <span class="keywordflow">else</span>
01972     {
01973         <span class="keywordflow">for</span> (i = 0, j = 4; i &lt; 16; i++) {
01974             <a class="code" href="../../d0/d3/dbcs_8h.html#a21">RegColorBuffer</a>[j++] = ((((GetRValue(ScreenInfo-&gt;Console-&gt;ColorTable[i]) +
01975                                       0x2A) * 0x02) / 0x55) * 0x15) / 0x02;
01976             <a class="code" href="../../d0/d3/dbcs_8h.html#a21">RegColorBuffer</a>[j++] = ((((GetGValue(ScreenInfo-&gt;Console-&gt;ColorTable[i]) +
01977                                       0x2A) * 0x02) / 0x55) * 0x15) / 0x02;
01978             <a class="code" href="../../d0/d3/dbcs_8h.html#a21">RegColorBuffer</a>[j++] = ((((GetBValue(ScreenInfo-&gt;Console-&gt;ColorTable[i]) +
01979                                       0x2A) * 0x02) / 0x55) * 0x15) / 0x02;
01980             <a class="code" href="../../d0/d3/dbcs_8h.html#a21">RegColorBuffer</a>[j++] = 0;
01981         }
01982 
01983         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlSetColors,
01984                                       (PVOID) RegColorBuffer,
01985                                       RegColorBuffer[0] * <span class="keyword">sizeof</span>(DWORD) + <span class="keyword">sizeof</span>(DWORD),
01986                                       NULL,
01987                                       NULL);
01988     }
01989 <span class="preprocessor">#else</span>
01990 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0, j = 4; i &lt; 16; i++) {
01991         <a class="code" href="../../d7/d4/server_2private_8c.html#a25">ColorBuffer</a>[j++] = ((((GetRValue(ScreenInfo-&gt;Console-&gt;ColorTable[i]) +
01992                                0x2A) * 0x02) / 0x55) * 0x15) / 0x02;
01993         <a class="code" href="../../d7/d4/server_2private_8c.html#a25">ColorBuffer</a>[j++] = ((((GetGValue(ScreenInfo-&gt;Console-&gt;ColorTable[i]) +
01994                                0x2A) * 0x02) / 0x55) * 0x15) / 0x02;
01995         <a class="code" href="../../d7/d4/server_2private_8c.html#a25">ColorBuffer</a>[j++] = ((((GetBValue(ScreenInfo-&gt;Console-&gt;ColorTable[i]) +
01996                                0x2A) * 0x02) / 0x55) * 0x15) / 0x02;
01997         <a class="code" href="../../d7/d4/server_2private_8c.html#a25">ColorBuffer</a>[j++] = 0;
01998     }
01999 
02000     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlSetColors,
02001                                      (PVOID) &amp;ColorBuffer,
02002                                      <span class="keyword">sizeof</span> (ColorBuffer),
02003                                      NULL,
02004                                      NULL);
02005 <span class="preprocessor">#endif</span>
02006 <span class="preprocessor"></span>
02007     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
02008         KdPrint((<span class="stringliteral">"CONSRV: FullscreenControlSetColors failed - status = %x\n"</span>,
02009                  Status));
02010         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
02011         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02012     }
02013 
02014 
02015     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02016 }
02017 
02018 <span class="preprocessor">#endif</span>
02019 <span class="preprocessor"></span>
02020 
02021 <span class="preprocessor">#if defined(_X86_)</span>
02022 <span class="preprocessor"></span>
02023 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02024 <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(
02025     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02026     HWND hwnd,
02027     DWORD dwFlags)
02028 {
02029     DEVMODEW Devmode;
02030     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02031     CONSOLE_FULLSCREEN_SWITCH switchBlock;
02032 
02033     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == CDS_FULLSCREEN)
02034     {
02035 <span class="preprocessor">#if defined(FE_SB)</span>
02036 <span class="preprocessor"></span>        <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fGraphics = fFullScreenGraphics ? <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>) : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02037 <span class="preprocessor">#endif</span>
02038 <span class="preprocessor"></span>
02039         KdPrint((<span class="stringliteral">"CONSRV: ChangeDispSettings fullscreen\n"</span>));
02040 
02041         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex;
02042 
02043         <span class="comment">//</span>
02044         <span class="comment">// set mode to go to full screen</span>
02045         <span class="comment">//</span>
02046 
02047         ZeroMemory(&amp;Devmode, <span class="keyword">sizeof</span>(Devmode));
02048 
02049         Devmode.dmSize = <span class="keyword">sizeof</span>(Devmode);
02050         Devmode.dmDriverExtra = 0;
02051         Devmode.dmFields = DM_BITSPERPEL   |
02052                            DM_PELSWIDTH    |
02053                            DM_PELSHEIGHT   |
02054                            DM_DISPLAYFLAGS;
02055 
02056         Devmode.dmBitsPerPel   = 4;
02057 <span class="preprocessor">#if defined(FE_SB)</span>
02058 <span class="preprocessor"></span>        Devmode.dmPelsWidth    = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X;
02059         Devmode.dmPelsHeight   = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y;
02060         Devmode.dmDisplayFlags = (fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a9">FS_MODE_GRAPHICS</a>)) ? 0 : DMDISPLAYFLAGS_TEXTMODE;
02061 <span class="preprocessor">#else</span>
02062 <span class="preprocessor"></span>        Devmode.dmPelsWidth    = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X;
02063         Devmode.dmPelsHeight   = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y;
02064         Devmode.dmDisplayFlags = DMDISPLAYFLAGS_TEXTMODE;
02065 <span class="preprocessor">#endif</span>
02066 <span class="preprocessor"></span>
02067         switchBlock.bFullscreenSwitch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02068         switchBlock.hwnd              = hwnd;
02069         switchBlock.pNewMode          = &amp;Devmode;
02070 
02071     }
02072     <span class="keywordflow">else</span>
02073     {
02074         KdPrint((<span class="stringliteral">"CONSRV: ChangeDispSettings windowed\n"</span>));
02075 
02076         switchBlock.bFullscreenSwitch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02077         switchBlock.hwnd              = hwnd;
02078         switchBlock.pNewMode          = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02079     }
02080 
02081     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleFullscreenSwitch,
02082                                 &amp;switchBlock,
02083                                 <span class="keyword">sizeof</span>(CONSOLE_FULLSCREEN_SWITCH));
02084 }
02085 
02086 <span class="preprocessor">#endif</span>
02087 <span class="preprocessor"></span>
02088 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02089"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a55">02089</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a55">InitializeFullScreen</a>( VOID )
02090 {
02091     UNICODE_STRING vgaString;
02092     DEVMODEW devmode;
02093     ULONG   i;
02094 <span class="preprocessor">#if !defined(FE_SB)</span>
02095 <span class="preprocessor"></span>    BOOLEAN mode1 = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02096     BOOLEAN mode2 = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02097 <span class="preprocessor">#else</span>
02098 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> mode1 = 0;
02099     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> mode2 = 0;
02100 <span class="preprocessor">#endif</span>
02101 <span class="preprocessor"></span>
02102     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> WindowsDir[<a class="code" href="../../d7/d4/server_2private_8c.html#a18">CONSOLE_WINDOWS_DIR_LENGTH</a>+<a class="code" href="../../d7/d4/server_2private_8c.html#a19">CONSOLE_EGACPI_LENGTH</a>];
02103     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WindowsDirLength;
02104 
02105     <span class="comment">//</span>
02106     <span class="comment">// query number of available modes</span>
02107     <span class="comment">//</span>
02108 
02109     ZeroMemory(&amp;devmode, <span class="keyword">sizeof</span>(DEVMODEW));
02110     devmode.dmSize = <span class="keyword">sizeof</span>(DEVMODEW);
02111 
02112     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;vgaString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VGACOMPATIBLE"</span>);
02113 
02114     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Number of modes = %d\n"</span>, <a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>));
02115 
02116     <span class="keywordflow">for</span> (i=0; ; i++)
02117     {
02118         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"EnumDisplaySettings %d\n"</span>, i));
02119 
02120         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a321">NtUserEnumDisplaySettings</a>(&amp;vgaString,
02121                                                    i,
02122                                                    &amp;devmode,
02123                                                    0))))
02124         {
02125             <span class="keywordflow">break</span>;
02126         }
02127 
02128 <span class="preprocessor">#if defined(FE_SB)</span>
02129 <span class="preprocessor"></span>        {
02130             ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02131 
02132             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Mode X = %d, Y = %d\n"</span>,
02133                      devmode.dmPelsWidth, devmode.dmPelsHeight));
02134 
02135             <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;<a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++)
02136             {
02137                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)devmode.dmPelsWidth == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X &amp;&amp;
02138                     (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)devmode.dmPelsHeight == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y  )
02139                 {
02140                     <span class="keywordflow">if</span> (devmode.dmDisplayFlags &amp; DMDISPLAYFLAGS_TEXTMODE)
02141                     {
02142                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a8">FS_MODE_TEXT</a>)
02143                         {
02144                             <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> |= <a class="code" href="../../d0/d3/dbcs_8h.html#a10">FS_MODE_FIND</a>;
02145                             mode1++;
02146                         }
02147                     }
02148                     <span class="keywordflow">else</span>
02149                     {
02150                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a9">FS_MODE_GRAPHICS</a>)
02151                         {
02152                             <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> |= <a class="code" href="../../d0/d3/dbcs_8h.html#a10">FS_MODE_FIND</a>;
02153                             mode2++;
02154                         }
02155                     }
02156                 }
02157             }
02158 
02159             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"mode1 = %d, mode2 = %d\n"</span>, mode1, mode2));
02160         }
02161 <span class="preprocessor">#else</span>
02162 <span class="preprocessor"></span>
02163         <span class="keywordflow">if</span> (devmode.dmPelsWidth == 720 &amp;&amp;
02164             devmode.dmPelsHeight == 400)
02165         {
02166             mode1 = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02167         }
02168         <span class="keywordflow">if</span> (devmode.dmPelsWidth == 640 &amp;&amp;
02169             devmode.dmPelsHeight == 350)
02170         {
02171             mode2 = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02172         }
02173 <span class="preprocessor">#endif</span>
02174 <span class="preprocessor"></span>    }
02175 
02176 <span class="preprocessor">#if !defined(FE_SB)</span>
02177 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(mode1 &amp;&amp; mode2))
02178 <span class="preprocessor">#else</span>
02179 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (mode1 &lt; 2)
02180 <span class="preprocessor">#endif</span>
02181 <span class="preprocessor"></span>    {
02182         <span class="comment">//</span>
02183         <span class="comment">// One of the modes we expected to get was not returned.</span>
02184         <span class="comment">// lets just fail fullscreen initialization.</span>
02185         <span class="comment">//</span>
02186 
02187         KdPrint((<span class="stringliteral">"CONSRV: InitializeFullScreen Missing text mode\n"</span>));
02188         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02189     }
02190 
02191 <span class="preprocessor">#if defined(FE_SB)</span>
02192 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (mode2 &gt; 0)
02193     {
02194         <span class="comment">// Can do trun graphics mode.</span>
02195         fFullScreenGraphics = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02196     }
02197 <span class="preprocessor">#endif</span>
02198 <span class="preprocessor"></span>
02199     <span class="comment">//</span>
02200     <span class="comment">// open ega.cpi</span>
02201     <span class="comment">//</span>
02202 
02203     WindowsDirLength = GetSystemDirectoryA(WindowsDir,
02204                                            <a class="code" href="../../d7/d4/server_2private_8c.html#a18">CONSOLE_WINDOWS_DIR_LENGTH</a>);
02205     <span class="keywordflow">if</span> (WindowsDirLength == 0)
02206     {
02207         KdPrint((<span class="stringliteral">"CONSRV: InitializeFullScreen Finding Font file failed\n"</span>));
02208         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02209     }
02210 
02211     RtlCopyMemory(&amp;WindowsDir[WindowsDirLength],
02212                   <a class="code" href="../../d7/d4/server_2private_8c.html#a20">CONSOLE_EGACPI</a>,
02213                   <a class="code" href="../../d7/d4/server_2private_8c.html#a19">CONSOLE_EGACPI_LENGTH</a>);
02214 
02215     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d4/server_2private_8c.html#a29">hCPIFile</a> = CreateFileA(WindowsDir,
02216                                 GENERIC_READ,
02217                                 FILE_SHARE_READ,
02218                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02219                                 <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>,
02220                                 0,
02221                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == (HANDLE)-1)
02222     {
02223         KdPrint((<span class="stringliteral">"CONSRV: InitializeFullScreen Opening Font file failed\n"</span>));
02224         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02225     }
02226 
02227     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02228 }
02229 
02230 
02231 ULONG
<a name="l02232"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a56">02232</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a56">SrvGetConsoleHardwareState</a>(
02233     IN OUT PCSR_API_MSG m,
02234     IN OUT PCSR_REPLY_STATUS ReplyStatus
02235     )
02236 {
02237 <span class="preprocessor">#ifdef i386</span>
02238 <span class="preprocessor"></span>    <a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html">PCONSOLE_GETHARDWARESTATE_MSG</a> a = (<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html">PCONSOLE_GETHARDWARESTATE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02239     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02240     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02241     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02242     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
02243 
02244     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o0">ConsoleHandle</a>,
02245                          &amp;Console
02246                         );
02247     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02248         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02249     }
02250     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
02251                                  a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o1">OutputHandle</a>,
02252                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
02253                                  GENERIC_READ,
02254                                  &amp;HandleData
02255                                 );
02256     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02257         ScreenInfo = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer;
02258         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex == -1) {
02259             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02260             <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
02261         }
02262 <span class="preprocessor">#if defined(FE_SB)</span>
02263 <span class="preprocessor"></span>        a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o2">Resolution</a> = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>;
02264         a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o3">FontSize</a> = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
02265 <span class="preprocessor">#else</span>
02266 <span class="preprocessor"></span>        a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o2">Resolution</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>;
02267         a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o3">FontSize</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
02268 <span class="preprocessor">#endif</span>
02269 <span class="preprocessor"></span>    }
02270     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02271     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02272 <span class="preprocessor">#else</span>
02273 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
02274     UNREFERENCED_PARAMETER(m);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02275 <span class="preprocessor">#endif</span>
02276 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02277 }
02278 
02279 ULONG
<a name="l02280"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a57">02280</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a57">SrvSetConsoleHardwareState</a>(
02281     IN OUT PCSR_API_MSG m,
02282     IN OUT PCSR_REPLY_STATUS ReplyStatus
02283     )
02284 {
02285 <span class="preprocessor">#ifdef i386</span>
02286 <span class="preprocessor"></span>    <a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html">PCONSOLE_SETHARDWARESTATE_MSG</a> a = (<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html">PCONSOLE_SETHARDWARESTATE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02287     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02288     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02289     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02290     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
02291     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02292 
02293     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o0">ConsoleHandle</a>,
02294                          &amp;Console
02295                         );
02296     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02297         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02298     }
02299     <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE)) {
02300         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02301         <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
02302     }
02303     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
02304                                  a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o1">OutputHandle</a>,
02305                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
02306                                  GENERIC_READ,
02307                                  &amp;HandleData
02308                                 );
02309     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02310 <span class="preprocessor">#if defined(FE_SB)</span>
02311 <span class="preprocessor"></span>        <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fGraphics = fFullScreenGraphics ? <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>) : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02312 <span class="preprocessor">#endif</span>
02313 <span class="preprocessor"></span>        ScreenInfo = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer;
02314 
02315         <span class="comment">// match requested mode</span>
02316 
02317         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;<a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
02318 <span class="preprocessor">#if defined(FE_SB)</span>
02319 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o2">Resolution</a>.X == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X &amp;&amp;
02320                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o2">Resolution</a>.Y == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y &amp;&amp;
02321                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o3">FontSize</a>.Y == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>.Y &amp;&amp;
02322                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o3">FontSize</a>.X == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>.X &amp;&amp;
02323                 ( ( fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a12">FS_GRAPHICS</a>)==<a class="code" href="../../d0/d3/dbcs_8h.html#a12">FS_GRAPHICS</a>) ||
02324                   (!fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a11">FS_TEXT</a>)==<a class="code" href="../../d0/d3/dbcs_8h.html#a11">FS_TEXT</a>)           )
02325                ) {
02326                 <span class="keywordflow">break</span>;
02327             }
02328 <span class="preprocessor">#else</span>
02329 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o2">Resolution</a>.X == <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X &amp;&amp;
02330                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o2">Resolution</a>.Y == <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y &amp;&amp;
02331                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o3">FontSize</a>.Y == <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>.Y &amp;&amp;
02332                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o3">FontSize</a>.X == <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>.X) {
02333                 <span class="keywordflow">break</span>;
02334             }
02335 <span class="preprocessor">#endif</span>
02336 <span class="preprocessor"></span>        }
02337         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == <a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>) {
02338             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02339         } <span class="keywordflow">else</span> {
02340             <span class="comment">// set requested mode</span>
02341             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02342             SetVideoMode(ScreenInfo);
02343         }
02344     }
02345     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02346     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02347 <span class="preprocessor">#else</span>
02348 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
02349     UNREFERENCED_PARAMETER(m);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02350 <span class="preprocessor">#endif</span>
02351 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02352 }
02353 
02354 ULONG
<a name="l02355"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a58">02355</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a58">SrvGetConsoleDisplayMode</a>(
02356     IN OUT PCSR_API_MSG m,
02357     IN OUT PCSR_REPLY_STATUS ReplyStatus
02358     )
02359 {
02360     <a class="code" href="../../d7/d1/struct__CONSOLE__GETDISPLAYMODE__MSG.html">PCONSOLE_GETDISPLAYMODE_MSG</a> a = (<a class="code" href="../../d7/d1/struct__CONSOLE__GETDISPLAYMODE__MSG.html">PCONSOLE_GETDISPLAYMODE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02361     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02362     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02363 
02364     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d7/d1/struct__CONSOLE__GETDISPLAYMODE__MSG.html#o0">ConsoleHandle</a>,
02365                          &amp;Console
02366                         );
02367     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02368         a-&gt;<a class="code" href="../../d7/d1/struct__CONSOLE__GETDISPLAYMODE__MSG.html#o1">ModeFlags</a> = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a>;
02369         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02370     }
02371     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02372     UNREFERENCED_PARAMETER(ReplyStatus);
02373 }
02374 
02375 ULONG
<a name="l02376"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a59">02376</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a59">SrvSetConsoleMenuClose</a>(
02377     IN OUT PCSR_API_MSG m,
02378     IN OUT PCSR_REPLY_STATUS ReplyStatus
02379     )
02380 {
02381     <a class="code" href="../../d1/d6/struct__CONSOLE__SETMENUCLOSE__MSG.html">PCONSOLE_SETMENUCLOSE_MSG</a> a = (<a class="code" href="../../d1/d6/struct__CONSOLE__SETMENUCLOSE__MSG.html">PCONSOLE_SETMENUCLOSE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02382     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02383     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02384 
02385     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d1/d6/struct__CONSOLE__SETMENUCLOSE__MSG.html#o0">ConsoleHandle</a>,
02386                          &amp;Console
02387                         );
02388     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02389         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02390     }
02391     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d1/d6/struct__CONSOLE__SETMENUCLOSE__MSG.html#o1">Enable</a>) {
02392         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a6">CONSOLE_DISABLE_CLOSE</a>;
02393     } <span class="keywordflow">else</span> {
02394         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a6">CONSOLE_DISABLE_CLOSE</a>;
02395     }
02396     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02397     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02398     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02399 }
02400 
02401 
02402 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l02403"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a60">02403</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a60">ConvertHotKey</a>(
02404     IN LPAPPKEY UserAppKey
02405     )
02406 {
02407     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> wParam;
02408 
02409     wParam = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a18">MapVirtualKey</a>(UserAppKey-&gt;ScanCode,1);
02410     <span class="keywordflow">if</span> (UserAppKey-&gt;Modifier &amp; CONSOLE_MODIFIER_SHIFT) {
02411         wParam |= 0x0100;
02412     }
02413     <span class="keywordflow">if</span> (UserAppKey-&gt;Modifier &amp; CONSOLE_MODIFIER_CONTROL) {
02414         wParam |= 0x0200;
02415     }
02416     <span class="keywordflow">if</span> (UserAppKey-&gt;Modifier &amp; CONSOLE_MODIFIER_ALT) {
02417         wParam |= 0x0400;
02418     }
02419     <span class="keywordflow">return</span> wParam;
02420 }
02421 
02422 ULONG
<a name="l02423"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a61">02423</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a61">SrvSetConsoleKeyShortcuts</a>(
02424     IN OUT PCSR_API_MSG m,
02425     IN OUT PCSR_REPLY_STATUS ReplyStatus
02426     )
02427 {
02428     <a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html">PCONSOLE_SETKEYSHORTCUTS_MSG</a> a = (<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html">PCONSOLE_SETKEYSHORTCUTS_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02429     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02430     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02431 
02432     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o0">ConsoleHandle</a>,
02433                          &amp;Console
02434                         );
02435     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02436         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02437     }
02438 
02439     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o4">AppKeys</a>, a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o3">NumAppKeys</a>, <span class="keyword">sizeof</span>(*a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o4">AppKeys</a>))) {
02440         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02441         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02442     }
02443 
02444     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o3">NumAppKeys</a> &lt;= <a class="code" href="../../d1/d7/server_8h.html#a94">CONSOLE_MAX_APP_SHORTCUTS</a>) {
02445         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o34">ReserveKeys</a> = a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o2">ReserveKeys</a>;
02446         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
02447             <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>,a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o2">ReserveKeys</a>))) {
02448                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02449             }
02450         }
02451         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o3">NumAppKeys</a>) {
02452             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>,
02453                          WM_SETHOTKEY,
02454                          <a class="code" href="../../d7/d4/server_2private_8c.html#a60">ConvertHotKey</a>(a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o4">AppKeys</a>),
02455                          0
02456                         );
02457         }
02458     } <span class="keywordflow">else</span> {
02459         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02460     }
02461     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02462     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02463     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02464 }
02465 
02466 <span class="preprocessor">#ifdef i386</span>
02467 <span class="preprocessor"></span>ULONG
02468 MatchWindowSize(
02469 #<span class="keywordflow">if</span> defined(FE_SB)
02470     IN UINT CodePage,
02471 #endif
02472     IN COORD WindowSize,
02473     OUT PCOORD pWindowSize
02474     )
02475 
02476 <span class="comment">/*++</span>
02477 <span class="comment"></span>
02478 <span class="comment">    find the best match font.  it's the one that's the same size</span>
02479 <span class="comment">    or slightly larger than the window size.</span>
02480 <span class="comment"></span>
02481 <span class="comment">--*/</span>
02482 {
02483     ULONG i;
02484 <span class="preprocessor">#if defined(FE_SB)</span>
02485 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fGraphics = fFullScreenGraphics ? <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(CodePage) : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02486 <span class="preprocessor">#endif</span>
02487 <span class="preprocessor"></span>
02488     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>;i++) {
02489 <span class="preprocessor">#if defined(FE_SB)</span>
02490 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (WindowSize.Y &lt;= <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[i].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o1">ScreenSize</a>.Y &amp;&amp;
02491             ( ( fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[i].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a12">FS_GRAPHICS</a>)==<a class="code" href="../../d0/d3/dbcs_8h.html#a12">FS_GRAPHICS</a>) ||
02492               (!fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[i].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a11">FS_TEXT</a>)==<a class="code" href="../../d0/d3/dbcs_8h.html#a11">FS_TEXT</a>)           )
02493            )
02494 <span class="preprocessor">#else</span>
02495 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (WindowSize.Y &lt;= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[i].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o4">Height</a>)
02496 <span class="preprocessor">#endif</span>
02497 <span class="preprocessor"></span>        {
02498             <span class="keywordflow">break</span>;
02499         }
02500     }
02501     <span class="keywordflow">if</span> (i == <a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>)
02502 <span class="preprocessor">#if defined(FE_SB)</span>
02503 <span class="preprocessor"></span>    {
02504         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Find;
02505         ULONG FindIndex;
02506         COORD WindowSizeDelta;
02507 
02508         FindIndex = 0;
02509         Find = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
02510         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>;i++) {
02511             <span class="keywordflow">if</span> ( ( fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[i].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a12">FS_GRAPHICS</a>)==<a class="code" href="../../d0/d3/dbcs_8h.html#a12">FS_GRAPHICS</a>) ||
02512                  (!fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[i].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a11">FS_TEXT</a>)==<a class="code" href="../../d0/d3/dbcs_8h.html#a11">FS_TEXT</a>)           )
02513             {
02514                 WindowSizeDelta.Y = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(WindowSize.Y - RegModeFontPairs[i].ScreenSize.Y);
02515                 <span class="keywordflow">if</span> (Find &gt; (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(WindowSizeDelta.Y))
02516                 {
02517                     Find = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(WindowSizeDelta.Y);
02518                     FindIndex = i;
02519                 }
02520             }
02521         }
02522 
02523         i = FindIndex;
02524     }
02525 <span class="preprocessor">#else</span>
02526 <span class="preprocessor"></span>        i-=1;
02527 <span class="preprocessor">#endif</span>
02528 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_SB)</span>
02529 <span class="preprocessor"></span>    *pWindowSize = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[i].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o1">ScreenSize</a>;
02530 <span class="preprocessor">#else</span>
02531 <span class="preprocessor"></span>    pWindowSize-&gt;X = 80;
02532     pWindowSize-&gt;Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[i].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o4">Height</a>;
02533 <span class="preprocessor">#endif</span>
02534 <span class="preprocessor"></span>    <span class="keywordflow">return</span> i;
02535 }
02536 
02537 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02538 ReadRegionFromScreenHW(
02539     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02540     IN PSMALL_RECT Region,
02541     IN PCHAR_INFO ReadBufPtr
02542     )
02543 {
02544     ULONG CurFrameBufPtr;   <span class="comment">// offset in frame buffer</span>
02545     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> FrameY;
02546     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> WindowY, WindowX, WindowSizeX;
02547 
02548     <span class="comment">//</span>
02549     <span class="comment">// get pointer to start of region in frame buffer</span>
02550     <span class="comment">//</span>
02551 
02552     WindowY = Region-&gt;Top - ScreenInfo-&gt;Window.Top;
02553     WindowX = Region-&gt;Left - ScreenInfo-&gt;Window.Left;
02554     WindowSizeX = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
02555 
02556     <span class="comment">//</span>
02557     <span class="comment">// copy the chars and attrs from the frame buffer</span>
02558     <span class="comment">//</span>
02559 
02560     <span class="keywordflow">for</span> (FrameY = Region-&gt;Top;
02561          FrameY &lt;= Region-&gt;Bottom;
02562          FrameY++, WindowY++) {
02563 
02564         CurFrameBufPtr = <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(WindowX,
02565                                                WindowY,
02566                                                WindowSizeX,
02567                                                <span class="keyword">sizeof</span>(VGA_CHAR));
02568 
02569         GdiFullscreenControl(FullscreenControlReadFromFrameBuffer,
02570                                 (PULONG) CurFrameBufPtr,
02571                                 (Region-&gt;Right - Region-&gt;Left + 1) *
02572                                     <span class="keyword">sizeof</span>(VGA_CHAR),
02573                                 ReadBufPtr, NULL);
02574         ReadBufPtr += (Region-&gt;Right - Region-&gt;Left + 1);
02575     }
02576 }
02577 
02578 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02579 ReverseMousePointer(
02580     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02581     IN PSMALL_RECT Region
02582     )
02583 {
02584     ULONG CurFrameBufPtr;   <span class="comment">// offset in frame buffer</span>
02585     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> WindowSizeX;
02586 
02587     <span class="comment">// if (ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) {</span>
02588     <span class="comment">//     ASSERT(FALSE);</span>
02589     <span class="comment">// }</span>
02590 
02591 <span class="preprocessor">#ifdef FE_SB</span>
02592 <span class="preprocessor"></span>    <span class="comment">// fail safe</span>
02593     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;Flags &amp; CONSOLE_TEXTMODE_BUFFER);
02594     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)) {
02595         <span class="keywordflow">return</span>;
02596     }
02597 <span class="preprocessor">#endif</span>
02598 <span class="preprocessor"></span>
02599     WindowSizeX = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
02600 
02601     <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X &lt; Region-&gt;Left ||
02602         ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X &gt; Region-&gt;Right ||
02603         ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y &lt; Region-&gt;Top ||
02604         ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y &gt; Region-&gt;Bottom ||
02605         ScreenInfo-&gt;CursorDisplayCount &lt; 0 ||
02606         !(ScreenInfo-&gt;Console-&gt;InputBuffer.InputMode &amp; ENABLE_MOUSE_INPUT) ||
02607         ScreenInfo-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
02608         <span class="keywordflow">return</span>;
02609     }
02610 
02611 <span class="preprocessor">#if defined(FE_SB)</span>
02612 <span class="preprocessor"></span>    {
02613         FSVIDEO_REVERSE_MOUSE_POINTER MousePointer;
02614         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
02615         <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
02616         COORD TargetPoint;
02617 
02618         TargetPoint.X = ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X;
02619         TargetPoint.Y = ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y;
02620 
02621         RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+TargetPoint.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
02622         Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
02623         <span class="keywordflow">if</span> (!CONSOLE_IS_DBCS_CP(ScreenInfo-&gt;Console))
02624             MousePointer.dwType = CHAR_TYPE_SBCS;
02625         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X] &amp; ATTR_TRAILING_BYTE)
02626             MousePointer.dwType = CHAR_TYPE_TRAILING;
02627         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X] &amp; ATTR_LEADING_BYTE)
02628             MousePointer.dwType = CHAR_TYPE_LEADING;
02629         <span class="keywordflow">else</span>
02630             MousePointer.dwType = CHAR_TYPE_SBCS;
02631 
02632         MousePointer.Screen.Position.X = TargetPoint.X - ScreenInfo-&gt;Window.Left;
02633         MousePointer.Screen.Position.Y = TargetPoint.Y - ScreenInfo-&gt;Window.Top;
02634         MousePointer.Screen.ScreenSize.X = WindowSizeX;
02635         MousePointer.Screen.ScreenSize.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
02636         MousePointer.Screen.nNumberOfChars = 0;
02637 
02638         GdiFullscreenControl(FullscreenControlReverseMousePointerDB,
02639                              &amp;MousePointer,
02640                              <span class="keyword">sizeof</span>(MousePointer),
02641                              NULL,
02642                              NULL);
02643 
02644         UNREFERENCED_PARAMETER(CurFrameBufPtr);
02645     }
02646 <span class="preprocessor">#else</span>
02647 <span class="preprocessor"></span>    CurFrameBufPtr = <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X - ScreenInfo-&gt;Window.Left,
02648                                            ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y - ScreenInfo-&gt;Window.Top,
02649                                            WindowSizeX,
02650                                            <span class="keyword">sizeof</span>(VGA_CHAR));
02651 
02652     GdiFullscreenControl(FullscreenControlReverseMousePointer,
02653                             (PULONG) CurFrameBufPtr,
02654                             0,
02655                             NULL,
02656                             NULL);
02657 <span class="preprocessor">#endif</span>
02658 <span class="preprocessor"></span>}
02659 
02660 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02661 CopyVideoMemory(
02662     SHORT SourceY,
02663     SHORT TargetY,
02664     SHORT Length,
02665     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
02666     )
02667 
02668 <span class="comment">/*++</span>
02669 <span class="comment"></span>
02670 <span class="comment">Routine Description:</span>
02671 <span class="comment"></span>
02672 <span class="comment">    This routine copies rows of characters in video memory.  It only copies</span>
02673 <span class="comment">    complete rows.</span>
02674 <span class="comment"></span>
02675 <span class="comment">Arguments:</span>
02676 <span class="comment"></span>
02677 <span class="comment">    SourceY - Row to copy from.</span>
02678 <span class="comment"></span>
02679 <span class="comment">    TargetY - Row to copy to.</span>
02680 <span class="comment"></span>
02681 <span class="comment">    Length - Number of rows to copy.</span>
02682 <span class="comment"></span>
02683 <span class="comment">Return Value:</span>
02684 <span class="comment"></span>
02685 <span class="comment">--*/</span>
02686 
02687 {
02688     ULONG SourcePtr, TargetPtr;
02689     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> WindowSizeX, WindowSizeY;
02690 
02691     WindowSizeX = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
02692     WindowSizeY = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
02693 
02694     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(SourceY, TargetY) + Length &gt; WindowSizeY) {
02695         Length = WindowSizeY - <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(SourceY, TargetY);
02696         <span class="keywordflow">if</span> (Length &lt;= 0 ) {
02697             <span class="keywordflow">return</span>;
02698         }
02699     }
02700 
02701 <span class="preprocessor">#if defined(FE_SB)</span>
02702 <span class="preprocessor"></span>    {
02703         FSCNTL_SCREEN_INFO FsCntlSrc;
02704         FSCNTL_SCREEN_INFO FsCntlDest;
02705 
02706         FsCntlSrc.Position.X = 0;
02707         FsCntlSrc.Position.Y = SourceY;
02708         FsCntlSrc.ScreenSize.X = WindowSizeX;
02709         FsCntlSrc.ScreenSize.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
02710         FsCntlSrc.nNumberOfChars = Length * WindowSizeX;
02711 
02712         FsCntlDest.Position.X = 0;
02713         FsCntlDest.Position.Y = TargetY;
02714         FsCntlDest.ScreenSize.X = WindowSizeX;
02715         FsCntlDest.ScreenSize.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
02716         FsCntlDest.nNumberOfChars = Length * WindowSizeX;
02717 
02718         GdiFullscreenControl(FullscreenControlCopyFrameBufferDB,
02719                              &amp;FsCntlSrc,
02720                              <span class="keyword">sizeof</span>(FsCntlSrc),
02721                              &amp;FsCntlDest,
02722                              (PULONG)<span class="keyword">sizeof</span>(FsCntlDest));
02723 
02724         UNREFERENCED_PARAMETER(SourcePtr);
02725         UNREFERENCED_PARAMETER(TargetPtr);
02726     }
02727 <span class="preprocessor">#else</span>
02728 <span class="preprocessor"></span>    SourcePtr = <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(0,
02729                                       SourceY,
02730                                       WindowSizeX,
02731                                       <span class="keyword">sizeof</span>(VGA_CHAR));
02732 
02733     TargetPtr = <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(0,
02734                                       TargetY,
02735                                       WindowSizeX,
02736                                       <span class="keyword">sizeof</span>(VGA_CHAR));
02737 
02738     GdiFullscreenControl(FullscreenControlCopyFrameBuffer,
02739                             (PULONG) SourcePtr,
02740                             Length * WindowSizeX * <span class="keyword">sizeof</span>(VGA_CHAR),
02741                             (PULONG) TargetPtr,
02742                             (PULONG) (Length * WindowSizeX * <span class="keyword">sizeof</span>(VGA_CHAR)));
02743 <span class="preprocessor">#endif</span>
02744 <span class="preprocessor"></span>}
02745 
02746 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02747 ScrollHW(
02748     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02749     IN PSMALL_RECT ScrollRect,
02750     IN PSMALL_RECT MergeRect,
02751     IN COORD TargetPoint
02752     )
02753 {
02754     SMALL_RECT TargetRectangle;
02755     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>)
02756         <span class="keywordflow">return</span>;
02757 
02758     TargetRectangle.Left = TargetPoint.X;
02759     TargetRectangle.Top = TargetPoint.Y;
02760     TargetRectangle.Right = TargetPoint.X + ScrollRect-&gt;Right - ScrollRect-&gt;Left;
02761     TargetRectangle.Bottom = TargetPoint.Y + ScrollRect-&gt;Bottom - ScrollRect-&gt;Top;
02762 
02763     <span class="comment">//</span>
02764     <span class="comment">// if the scroll region is as wide as the screen, we can update</span>
02765     <span class="comment">// the screen by copying the video memory.  if we scroll this</span>
02766     <span class="comment">// way, we then must clip and update the fill region.</span>
02767     <span class="comment">//</span>
02768 
02769     <span class="keywordflow">if</span> (ScrollRect-&gt;Left == ScreenInfo-&gt;Window.Left &amp;&amp;
02770         TargetRectangle.Left == ScreenInfo-&gt;Window.Left &amp;&amp;
02771         ScrollRect-&gt;Right == ScreenInfo-&gt;Window.Right &amp;&amp;
02772         TargetRectangle.Right == ScreenInfo-&gt;Window.Right &amp;&amp;
02773         ScrollRect-&gt;Top &gt;= ScreenInfo-&gt;Window.Top &amp;&amp;
02774         TargetRectangle.Top &gt;= ScreenInfo-&gt;Window.Top &amp;&amp;
02775         ScrollRect-&gt;Bottom &lt;= ScreenInfo-&gt;Window.Bottom &amp;&amp;
02776         TargetRectangle.Bottom &lt;= ScreenInfo-&gt;Window.Bottom) {
02777 
02778         <span class="comment">//</span>
02779         <span class="comment">// we must first make the mouse pointer invisible because</span>
02780         <span class="comment">// otherwise it would get copied to another place on the</span>
02781         <span class="comment">// screen if it were part of the scroll region.</span>
02782         <span class="comment">//</span>
02783 
02784         ReverseMousePointer(ScreenInfo, &amp;ScreenInfo-&gt;Window);
02785 
02786         CopyVideoMemory((SHORT) (ScrollRect-&gt;Top - ScreenInfo-&gt;Window.Top),
02787                         (SHORT) (TargetRectangle.Top - ScreenInfo-&gt;Window.Top),
02788                         (SHORT) (TargetRectangle.Bottom - TargetRectangle.Top + 1),
02789                         ScreenInfo);
02790 
02791         <span class="comment">//</span>
02792         <span class="comment">// update the fill region.  first we ensure that the scroll and</span>
02793         <span class="comment">// target regions aren't the same.  if they are, we don't fill.</span>
02794         <span class="comment">//</span>
02795 
02796         <span class="keywordflow">if</span> (TargetRectangle.Top != ScrollRect-&gt;Top) {
02797 
02798             <span class="comment">//</span>
02799             <span class="comment">// if scroll and target regions overlap, with scroll</span>
02800             <span class="comment">// region above target region, clip scroll region.</span>
02801             <span class="comment">//</span>
02802 
02803             <span class="keywordflow">if</span> (TargetRectangle.Top &lt;= ScrollRect-&gt;Bottom &amp;&amp;
02804                 TargetRectangle.Bottom &gt;= ScrollRect-&gt;Bottom) {
02805                 ScrollRect-&gt;Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRectangle.Top-1);
02806             }
02807             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TargetRectangle.Top &lt;= ScrollRect-&gt;Top &amp;&amp;
02808                 TargetRectangle.Bottom &gt;= ScrollRect-&gt;Top) {
02809                 ScrollRect-&gt;Top = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRectangle.Bottom+1);
02810             }
02811             <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,ScrollRect);
02812 
02813             <span class="comment">//</span>
02814             <span class="comment">// WriteToScreen should take care of writing the mouse pointer.</span>
02815             <span class="comment">// however, the update region may be clipped so that the</span>
02816             <span class="comment">// mouse pointer is not written. in that case, we draw the</span>
02817             <span class="comment">// mouse pointer here.</span>
02818             <span class="comment">//</span>
02819 
02820             <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y &lt; ScrollRect-&gt;Top ||
02821                 ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y &gt; ScrollRect-&gt;Bottom) {
02822                 ReverseMousePointer(ScreenInfo, &amp;ScreenInfo-&gt;Window);
02823             }
02824         }
02825         <span class="keywordflow">if</span> (MergeRect) {
02826             <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,MergeRect);
02827         }
02828     }
02829     <span class="keywordflow">else</span> {
02830         <span class="keywordflow">if</span> (MergeRect) {
02831             <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,MergeRect);
02832         }
02833         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,ScrollRect);
02834         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;TargetRectangle);
02835     }
02836 }
02837 
02838 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02839 <a class="code" href="../../d8/d5/consrv_8h.html#a277">UpdateMousePosition</a>(
02840     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02841     COORD Position
02842     )
02843 
02844 <span class="comment">/*++</span>
02845 <span class="comment"></span>
02846 <span class="comment">Routine Description:</span>
02847 <span class="comment"></span>
02848 <span class="comment">    This routine moves the mouse pointer.</span>
02849 <span class="comment"></span>
02850 <span class="comment">Arguments:</span>
02851 <span class="comment"></span>
02852 <span class="comment">    ScreenInfo - Pointer to screen buffer information.</span>
02853 <span class="comment"></span>
02854 <span class="comment">    Position - Contains the new position of the mouse in screen buffer</span>
02855 <span class="comment">    coordinates.</span>
02856 <span class="comment"></span>
02857 <span class="comment">Return Value:</span>
02858 <span class="comment"></span>
02859 <span class="comment">    none.</span>
02860 <span class="comment"></span>
02861 <span class="comment">--*/</span>
02862 
02863 <span class="comment">// Note: CurrentConsole lock must be held in share mode when calling this routine</span>
02864 {
02865     SMALL_RECT CursorRegion;
02866 <span class="preprocessor">#ifdef FE_SB</span>
02867 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
02868     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a>  Row;
02869     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fOneMore = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02870 <span class="preprocessor">#endif</span>
02871 <span class="preprocessor"></span>
02872     <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) ||
02873             (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)) {
02874         <span class="keywordflow">return</span>;
02875     }
02876 
02877     <span class="keywordflow">if</span> (Position.X &lt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left ||
02878         Position.X &gt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right ||
02879         Position.Y &lt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top ||
02880         Position.Y &gt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom) {
02881         <span class="keywordflow">return</span>;
02882     }
02883 
02884     <span class="keywordflow">if</span> (Position.X == ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.X &amp;&amp;
02885         Position.Y == ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.Y) {
02886         <span class="keywordflow">return</span>;
02887     }
02888 
02889 <span class="preprocessor">#ifdef FE_SB</span>
02890 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>)) {
02891         RowIndex = (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.FirstRow+Position.Y) % ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y;
02892         Row = &amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[RowIndex];
02893         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[Position.X] &amp; ATTR_LEADING_BYTE) {
02894             <span class="keywordflow">if</span> (Position.X != ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X - 1) {
02895                 fOneMore = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02896             }
02897         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[Position.X] &amp; ATTR_TRAILING_BYTE) {
02898             <span class="keywordflow">if</span> (Position.X != 0) {
02899                 fOneMore = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02900                 Position.X--;
02901             }
02902         }
02903 
02904     }
02905 <span class="preprocessor">#endif</span>
02906 <span class="preprocessor"></span>
02907     <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o18">CursorDisplayCount</a> &lt; 0 || !(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o4">InputMode</a> &amp; ENABLE_MOUSE_INPUT)) {
02908         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition = Position;
02909         <span class="keywordflow">return</span>;
02910     }
02911 
02912 
02913     <span class="comment">// turn off old mouse position.</span>
02914 
02915     CursorRegion.Left = CursorRegion.Right = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.X;
02916     CursorRegion.Top = CursorRegion.Bottom = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.Y;
02917 
02918 <span class="preprocessor">#ifdef FE_SB</span>
02919 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>)) {
02920         RowIndex = (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.FirstRow+CursorRegion.Top) % ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y;
02921         Row = &amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[RowIndex];
02922         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[CursorRegion.Left] &amp; ATTR_LEADING_BYTE) {
02923             <span class="keywordflow">if</span> (CursorRegion.Left != ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X - 1) {
02924                 CursorRegion.Right++;
02925             }
02926         }
02927     }
02928 <span class="preprocessor">#endif</span>
02929 <span class="preprocessor"></span>
02930     <span class="comment">// store new mouse position</span>
02931 
02932     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.X = Position.X;
02933     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.Y = Position.Y;
02934     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;CursorRegion);
02935 
02936     <span class="comment">// turn on new mouse position</span>
02937 
02938     CursorRegion.Left = CursorRegion.Right = Position.X;
02939     CursorRegion.Top = CursorRegion.Bottom = Position.Y;
02940 <span class="preprocessor">#ifdef FE_SB</span>
02941 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (fOneMore)
02942         CursorRegion.Right++;
02943 <span class="preprocessor">#endif</span>
02944 <span class="preprocessor"></span>    <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;CursorRegion);
02945 }
02946 
02947 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02948 SetROMFontCodePage(
02949     IN UINT wCodePage,
02950     IN ULONG ModeIndex
02951     )
02952 
02953 <span class="comment">/*</span>
02954 <span class="comment"></span>
02955 <span class="comment">    this function opens ega.cpi and looks for the desired font in the</span>
02956 <span class="comment">    specified codepage.  if found, it loads it into the video ROM.</span>
02957 <span class="comment"></span>
02958 <span class="comment">*/</span>
02959 
02960 {
02961     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d7/d4/server_2private_8c.html#a21">CONSOLE_FONT_BUFFER_LENGTH</a>];
02962     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwBytesRead;
02963     <a class="code" href="../../d7/d4/server_2private_8c.html#a31">LPFONTFILEHEADER</a> lpFontFileHeader=(<a class="code" href="../../d7/d4/server_2private_8c.html#a31">LPFONTFILEHEADER</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02964     <a class="code" href="../../d7/d4/server_2private_8c.html#a33">LPFONTINFOHEADER</a> lpFontInfoHeader=(<a class="code" href="../../d7/d4/server_2private_8c.html#a33">LPFONTINFOHEADER</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02965     <a class="code" href="../../d7/d4/server_2private_8c.html#a37">LPFONTDATAHEADER</a> lpFontDataHeader=(<a class="code" href="../../d7/d4/server_2private_8c.html#a37">LPFONTDATAHEADER</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02966     <a class="code" href="../../d7/d4/server_2private_8c.html#a35">LPCPENTRYHEADER</a> lpCPEntryHeader=(<a class="code" href="../../d7/d4/server_2private_8c.html#a35">LPCPENTRYHEADER</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02967     <a class="code" href="../../d7/d4/server_2private_8c.html#a39">LPSCREENFONTHEADER</a> lpScreenFontHeader=(<a class="code" href="../../d7/d4/server_2private_8c.html#a39">LPSCREENFONTHEADER</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02968     WORD NumEntries;
02969     COORD FontDimensions;
02970     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02971     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Found;
02972     LONG FilePtr;
02973     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bDOS = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02974 
02975     FontDimensions = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
02976 
02977     <span class="comment">//</span>
02978     <span class="comment">// read FONTINFOHEADER</span>
02979     <span class="comment">//</span>
02980     <span class="comment">// do {</span>
02981     <span class="comment">//     read CPENTRYHEADER</span>
02982     <span class="comment">//     if (correct codepage)</span>
02983     <span class="comment">//         break;</span>
02984     <span class="comment">// } while (codepages)</span>
02985     <span class="comment">// if (codepage found)</span>
02986     <span class="comment">//     read FONTDATAHEADER</span>
02987     <span class="comment">//</span>
02988 
02989     <span class="comment">// read FONTFILEHEADER</span>
02990 
02991     FilePtr = 0;
02992     <span class="keywordflow">if</span> (SetFilePointer(hCPIFile,FilePtr,NULL,FILE_BEGIN) == -1) {
02993         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02994         <span class="keywordflow">goto</span> DoExit;
02995     }
02996 
02997     <span class="keywordflow">if</span> (!ReadFile(hCPIFile,Buffer,<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html">FONTFILEHEADER</a>),&amp;dwBytesRead,NULL) ||
02998         dwBytesRead != <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html">FONTFILEHEADER</a>)) {
02999         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03000         <span class="keywordflow">goto</span> DoExit;
03001     }
03002 
03003     <span class="comment">// verify signature</span>
03004 
03005     <span class="keywordflow">if</span> (memcmp(lpFontFileHeader-&gt;<a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o0">ffhFileTag</a>, <span class="stringliteral">"\xFF"</span><span class="stringliteral">"FONT.NT"</span>,8) ) {
03006         <span class="keywordflow">if</span> (memcmp(lpFontFileHeader-&gt;<a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o0">ffhFileTag</a>, <span class="stringliteral">"\xFF"</span><span class="stringliteral">"FONT   "</span>,8) ) {
03007             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03008             <span class="keywordflow">goto</span> DoExit;
03009         } <span class="keywordflow">else</span> {
03010             bDOS = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03011         }
03012     }
03013 
03014     <span class="comment">// seek to FONTINFOHEADER.  jump through hoops to get the offset value.</span>
03015 
03016     FilePtr = lpFontFileHeader-&gt;<a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o4">ffhOffset1</a>;
03017     FilePtr |= (lpFontFileHeader-&gt;<a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o5">ffhOffset2</a> &lt;&lt; 8);
03018     FilePtr |= (lpFontFileHeader-&gt;<a class="code" href="../../d9/d9/struct__FONTFILEHEADER.html#o6">ffhOffset3</a> &lt;&lt; 24);
03019 
03020     <span class="keywordflow">if</span> (SetFilePointer(hCPIFile,FilePtr,NULL,FILE_BEGIN) == -1) {
03021         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03022         <span class="keywordflow">goto</span> DoExit;
03023     }
03024 
03025     <span class="comment">// read FONTINFOHEADER</span>
03026 
03027     <span class="keywordflow">if</span> (!ReadFile(hCPIFile,Buffer,<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/struct__FONTINFOHEADER.html">FONTINFOHEADER</a>),&amp;dwBytesRead,NULL) ||
03028         dwBytesRead != <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/struct__FONTINFOHEADER.html">FONTINFOHEADER</a>)) {
03029         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03030         <span class="keywordflow">goto</span> DoExit;
03031     }
03032     FilePtr += dwBytesRead;
03033     NumEntries = lpFontInfoHeader-&gt;<a class="code" href="../../d0/d0/struct__FONTINFOHEADER.html#o0">fihCodePages</a>;
03034 
03035     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03036     <span class="keywordflow">while</span> (NumEntries &amp;&amp;
03037            ReadFile(hCPIFile,Buffer,<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html">CPENTRYHEADER</a>),&amp;dwBytesRead,NULL) &amp;&amp;
03038            dwBytesRead == <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html">CPENTRYHEADER</a>)) {
03039         <span class="keywordflow">if</span> (lpCPEntryHeader-&gt;<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o5">cpeCodepageID</a> == wCodePage) {
03040             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03041             <span class="keywordflow">break</span>;
03042         }
03043         <span class="comment">// seek to next CPEENTRYHEADER</span>
03044 
03045         <span class="keywordflow">if</span> (bDOS) {
03046             FilePtr = MAKELONG(lpCPEntryHeader-&gt;<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o1">cpeNext1</a>,lpCPEntryHeader-&gt;<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o2">cpeNext2</a>);
03047         } <span class="keywordflow">else</span> {
03048             FilePtr += MAKELONG(lpCPEntryHeader-&gt;<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o1">cpeNext1</a>,lpCPEntryHeader-&gt;<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o2">cpeNext2</a>);
03049         }
03050         <span class="keywordflow">if</span> (SetFilePointer(hCPIFile, FilePtr, NULL,FILE_BEGIN) == -1) {
03051             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03052             <span class="keywordflow">goto</span> DoExit;
03053         }
03054         NumEntries-=1;
03055     }
03056     <span class="keywordflow">if</span> (!Found) {
03057         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03058         <span class="keywordflow">goto</span> DoExit;
03059     }
03060 
03061     <span class="comment">// seek to FONTDATAHEADER</span>
03062 
03063     <span class="keywordflow">if</span> (bDOS) {
03064         FilePtr = lpCPEntryHeader-&gt;<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o7">cpeOffset</a>;
03065     } <span class="keywordflow">else</span> {
03066         FilePtr += lpCPEntryHeader-&gt;<a class="code" href="../../d4/d9/struct__CPENTRYHEADER.html#o7">cpeOffset</a>;
03067     }
03068     <span class="keywordflow">if</span> (SetFilePointer(hCPIFile, FilePtr, NULL,FILE_BEGIN) == -1) {
03069         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03070         <span class="keywordflow">goto</span> DoExit;
03071     }
03072 
03073     <span class="comment">// read FONTDATAHEADER</span>
03074 
03075     <span class="keywordflow">if</span> (!ReadFile(hCPIFile,Buffer,<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html">FONTDATAHEADER</a>),&amp;dwBytesRead,NULL) ||
03076         dwBytesRead != <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html">FONTDATAHEADER</a>)) {
03077         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03078         <span class="keywordflow">goto</span> DoExit;
03079     }
03080     FilePtr += dwBytesRead;
03081 
03082     NumEntries = lpFontDataHeader-&gt;<a class="code" href="../../d7/d9/struct__FONTDATAHEADER.html#o1">fdhFonts</a>;
03083 
03084     <span class="keywordflow">while</span> (NumEntries) {
03085         <span class="keywordflow">if</span> (!ReadFile(hCPIFile,Buffer,<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html">SCREENFONTHEADER</a>),&amp;dwBytesRead,NULL) ||
03086             dwBytesRead != <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html">SCREENFONTHEADER</a>)) {
03087             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03088             <span class="keywordflow">goto</span> DoExit;
03089         }
03090 
03091         <span class="keywordflow">if</span> (lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">sfhHeight</a> == (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)FontDimensions.Y &amp;&amp;
03092             lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o1">sfhWidth</a> == (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)FontDimensions.X) {
03093             PVIDEO_LOAD_FONT_INFORMATION FontInformation;
03094 
03095             FontInformation = (PVIDEO_LOAD_FONT_INFORMATION)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_TAG ),
03096                                     lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o3">sfhCharacters</a>*
03097                                     lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">sfhHeight</a>+
03098                                     <span class="keyword">sizeof</span>(VIDEO_LOAD_FONT_INFORMATION));
03099             <span class="keywordflow">if</span> (FontInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03100                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetROMFontCodePage: failed to memory allocation %d bytes"</span>,
03101                     lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o3">sfhCharacters</a> * lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">sfhHeight</a> +
03102                     <span class="keyword">sizeof</span>(VIDEO_LOAD_FONT_INFORMATION));
03103                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
03104             }
03105             <span class="keywordflow">if</span> (!ReadFile(hCPIFile,FontInformation-&gt;Font,
03106                           lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o3">sfhCharacters</a>*lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">sfhHeight</a>,
03107                           &amp;dwBytesRead,NULL) ||
03108                           dwBytesRead != (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o3">sfhCharacters</a>*lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">sfhHeight</a>)) {
03109                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontInformation);
03110                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03111             }
03112             FontInformation-&gt;WidthInPixels = FontDimensions.X;
03113             FontInformation-&gt;HeightInPixels = FontDimensions.Y;
03114             FontInformation-&gt;FontSize = lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o3">sfhCharacters</a>*lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">sfhHeight</a>;
03115 
03116             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlLoadFont,
03117                                              FontInformation,
03118                                              lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o3">sfhCharacters</a>*lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">sfhHeight</a>+<span class="keyword">sizeof</span>(VIDEO_LOAD_FONT_INFORMATION),
03119                                              NULL,
03120                                              NULL);
03121 
03122             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontInformation);
03123             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03124         } <span class="keywordflow">else</span> {
03125             FilePtr = lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o3">sfhCharacters</a>*lpScreenFontHeader-&gt;<a class="code" href="../../d9/d8/struct__SCREENFONTHEADER.html#o0">sfhHeight</a>;
03126             <span class="keywordflow">if</span> (SetFilePointer(hCPIFile, FilePtr, NULL,FILE_CURRENT) == -1) {
03127                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
03128                 <span class="keywordflow">goto</span> DoExit;
03129             }
03130         }
03131         NumEntries -= 1;
03132     }
03133 DoExit:
03134     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03135 }
03136 <span class="preprocessor">#endif</span>
03137 <span class="preprocessor"></span>
03138 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03139"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a43">03139</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a43">GetThreadConsoleDesktop</a>(
03140     DWORD dwThreadId,
03141     HDESK *phdeskConsole)
03142 {
03143     PCSR_THREAD pcsrt;
03144     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
03145     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
03146     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03147     HANDLE ConsoleHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03148 
03149     *phdeskConsole = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03150     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = CsrLockThreadByClientId((HANDLE)dwThreadId, &amp;pcsrt);
03151     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03152         ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a83">CONSOLE_FROMTHREADPERPROCESSDATA</a>(pcsrt);
03153         ConsoleHandle = ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a>;
03154         CsrUnlockThread(pcsrt);
03155     }
03156 
03157     <span class="comment">//</span>
03158     <span class="comment">// If this process is a console app, return the</span>
03159     <span class="comment">// handle to its desktop.  Otherwise, return NULL.</span>
03160     <span class="comment">//</span>
03161 
03162     <span class="keywordflow">if</span> (ConsoleHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03163         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle, &amp;Console);
03164         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03165             *phdeskConsole = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o7">hDesk</a>;
03166         }
03167         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
03168     }
03169 
03170     <span class="keywordflow">return</span> STATUS_SUCCESS;
03171 }
03172 
03173 
03174 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03175"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a63">03175</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a63">SetRAMFontCodePage</a>(
03176     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
03177     )
03178 {
03179     FSVIDEO_SCREEN_INFORMATION ScreenInformation;
03180     ULONG ModeIndex = ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex;
03181     COORD FontSize;
03182     WCHAR wChar;
03183     WCHAR wCharBuf[2];
03184     <a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">LPSTRINGBITMAP</a> StringBitmap;
03185     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
03186     PWORD FontImage;
03187     <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache;
03188     WCHAR AltFaceName[LF_FACESIZE];
03189     COORD AltFontSize;
03190     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  AltFontFamily;
03191     ULONG AltFontIndex = 0;
03192     HFONT hOldFont;
03193     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03194 
03195     ScreenInformation.ScreenSize = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o1">ScreenSize</a>;
03196     ScreenInformation.FontSize = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
03197     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;FontCacheInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03198     {
03199         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a23">CreateFontCache</a>(&amp;FontCache);
03200         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03201             RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed in CreateFontCache. Status=%08x"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03202             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03203         }
03204         (<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a>)ScreenInfo-&gt;Console-&gt;FontCacheInformation = FontCache;
03205 
03206         <a class="code" href="../../d0/d3/dbcs_8h.html#a43">MakeAltRasterFont</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a68">SCR_FONTCODEPAGE</a>(ScreenInfo),
03207                           <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ModeIndex].FontSize,
03208                           &amp;AltFontSize, &amp;AltFontFamily, &amp;AltFontIndex, AltFaceName);
03209         FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o0">FullScreenFontIndex</a> = AltFontIndex;
03210         FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o1">FullScreenFontSize</a>  = AltFontSize;
03211 
03212         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o1">FullScreenFontSize</a>,<a class="code" href="../../d6/d6/foncache_8h.html#a9">BYTE_ALIGN</a>);
03213         StringBitmap = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(TMP_DBCS_TAG),
03214                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">STRINGBITMAP</a>) + <span class="keyword">sizeof</span>(StringBitmap-&gt;<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html#o2">ajBits</a>) * <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
03215         <span class="keywordflow">if</span> (StringBitmap==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03216         {
03217             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed to allocate StringBitmap"</span>);
03218             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03219         }
03220 
03221 
03222         <span class="comment">/*</span>
03223 <span class="comment">         * Change GDI font to full screen font that best matched.</span>
03224 <span class="comment">         */</span>
03225         hOldFont = SelectObject(ScreenInfo-&gt;Console-&gt;hDC,<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o0">FullScreenFontIndex</a>].hFont);
03226 
03227 
03228         <span class="keywordflow">for</span> (wChar=0x00; wChar &lt; 0x80; wChar++) {
03229             wCharBuf[0] = wChar;
03230             wCharBuf[1] = TEXT(<span class="charliteral">'\0'</span>);
03231             <a class="code" href="../../d0/d3/dbcs_8h.html#a28">GetStringBitmapW</a>(ScreenInfo-&gt;Console-&gt;hDC,
03232                              wCharBuf,
03233                              1,
03234                              (ULONG)<a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(StringBitmap),
03235                              (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)StringBitmap
03236                             );
03237 
03238             FontSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)StringBitmap-&gt;uiWidth;
03239             FontSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)StringBitmap-&gt;uiHeight;
03240 
03241 <span class="preprocessor">#if defined(LATER_DBCS_FOR_GRID_CHAR)  // by kazum</span>
03242 <span class="preprocessor"></span>            <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize,<a class="code" href="../../d6/d6/foncache_8h.html#a9">BYTE_ALIGN</a>);
03243             *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) = 0;
03244             *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> + 1) = 0;
03245 
03246             <span class="keywordflow">if</span> (gpGridCharacter) {
03247                 PGRID_CHARACTER_INFORMATION GridCharacter;
03248                 PWCHAR CodePoint;
03249 
03250                 GridCharacter = gpGridCharacter;
03251                 <span class="keywordflow">do</span> {
03252                     <span class="keywordflow">if</span> (GridCharacter-&gt;CodePage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
03253                         CodePoint = GridCharacter-&gt;CodePoint;
03254                         <span class="keywordflow">while</span> (*CodePoint) {
03255                             <span class="keywordflow">if</span> (*CodePoint == wChar) {
03256                                 <span class="keywordflow">if</span> (FontSize.X &lt;= 8)
03257                                     *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) = *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - 1);
03258                                 <span class="keywordflow">else</span> {
03259                                     *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) = *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - 2);
03260                                     *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> + 1) = *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - 1);
03261                                 }
03262                                 <span class="keywordflow">break</span>;
03263                             }
03264                             <span class="keywordflow">else</span>
03265                                 CodePoint++;
03266                         }
03267                         <span class="keywordflow">break</span>;
03268                     }
03269                 } <span class="keywordflow">while</span> (GridCharacter = GridCharacter-&gt;pNext);
03270             }
03271 <span class="preprocessor">#endif // LATER_DBCS_FOR_GRID_CHAR  // by kazum</span>
03272 <span class="preprocessor"></span>
03273             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03274                                   wChar,
03275                                   FontSize,
03276                                   <a class="code" href="../../d6/d6/foncache_8h.html#a9">BYTE_ALIGN</a>,
03277                                   StringBitmap-&gt;ajBits
03278                                  );
03279             <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03280                 RIPMSG3(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed to set font image. wc=%04x sz=(%x, %x)."</span>,
03281                         wChar, FontSize.X, FontSize.Y);
03282             }
03283 
03284             <span class="keywordflow">if</span> (FontSize.X != ScreenInformation.FontSize.X ||
03285                 FontSize.Y != ScreenInformation.FontSize.Y)
03286             {
03287                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(ScreenInformation.FontSize,<a class="code" href="../../d6/d6/foncache_8h.html#a10">WORD_ALIGN</a>);
03288                 FontImage = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(TMP_DBCS_TAG),
03289                                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>
03290                                      );
03291                 <span class="keywordflow">if</span> (FontImage!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03292 
03293                     <a class="code" href="../../d6/d6/foncache_8h.html#a30">GetExpandFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03294                                        wChar,
03295                                        FontSize,
03296                                        ScreenInformation.FontSize,
03297                                        FontImage
03298                                       );
03299 
03300                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03301                                           wChar,
03302                                           ScreenInformation.FontSize,
03303                                           <a class="code" href="../../d6/d6/foncache_8h.html#a10">WORD_ALIGN</a>,
03304                                           FontImage
03305                                          );
03306                     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03307                         RIPMSG3(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed to set font image. wc=%04x, sz=(%x,%x)"</span>,
03308                                 wChar, ScreenInformation.FontSize.X, ScreenInformation.FontSize.Y);
03309                     }
03310 
03311                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontImage);
03312                 } <span class="keywordflow">else</span> {
03313                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed to allocate FontImage."</span>);
03314                 }
03315             }
03316         }
03317 
03318         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(StringBitmap);
03319 
03320         <span class="comment">/*</span>
03321 <span class="comment">         * Back to GDI font</span>
03322 <span class="comment">         */</span>
03323         SelectObject(ScreenInfo-&gt;Console-&gt;hDC,hOldFont);
03324     }
03325 
03326     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlSetScreenInformation,
03327                                   &amp;ScreenInformation,
03328                                   <span class="keyword">sizeof</span>(ScreenInformation),
03329                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03330                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03331 
03332     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03333 }
03334 
03335 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03336"></a><a class="code" href="../../d7/d4/server_2private_8c.html#a64">03336</a> <a class="code" href="../../d7/d4/server_2private_8c.html#a64">SetRAMFont</a>(
03337     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
03338     IN PCHAR_INFO ScreenBufPtr,
03339     IN DWORD Length
03340     )
03341 {
03342     ULONG ModeIndex = ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex;
03343     COORD FsFontSize1 = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
03344     COORD FsFontSize2 = FsFontSize1;
03345     COORD GdiFontSize1;
03346     COORD GdiFontSize2;
03347     COORD RetFontSize;
03348     WCHAR wCharBuf[2];
03349     <a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">LPSTRINGBITMAP</a> StringBitmap;
03350     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
03351     PWORD FontImage;
03352     <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache;
03353     HFONT hOldFont;
03354     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03355 
03356     FontCache = (<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a>)ScreenInfo-&gt;Console-&gt;FontCacheInformation;
03357     <span class="keywordflow">if</span> (FontCache==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03358     {
03359         RIPMSG0(RIP_ERROR, <span class="stringliteral">"SetRAMFont: ScreenInfo-&gt;Console-&gt;FontCacheInformation == NULL."</span>);
03360         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03361     }
03362 
03363     GdiFontSize1 = FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o1">FullScreenFontSize</a>;
03364     GdiFontSize2 = GdiFontSize1;
03365     GdiFontSize2.X *= 2;
03366     FsFontSize2.X *= 2;
03367 
03368     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(GdiFontSize2,<a class="code" href="../../d6/d6/foncache_8h.html#a9">BYTE_ALIGN</a>);
03369     StringBitmap = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(TMP_DBCS_TAG),
03370                              <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">STRINGBITMAP</a>) + <span class="keyword">sizeof</span>(StringBitmap-&gt;<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html#o2">ajBits</a>) * <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
03371     <span class="keywordflow">if</span> (StringBitmap==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03372     {
03373         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetRAMFont: failed to allocate StringBitmap"</span>);
03374         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03375     }
03376 
03377     <span class="comment">/*</span>
03378 <span class="comment">     * Change GDI font to full screen font that best matched.</span>
03379 <span class="comment">     */</span>
03380     hOldFont = SelectObject(ScreenInfo-&gt;Console-&gt;hDC,<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o0">FullScreenFontIndex</a>].hFont);
03381 
03382     <span class="keywordflow">while</span> (Length--)
03383     {
03384         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a25">GetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03385                               ScreenBufPtr-&gt;Char.UnicodeChar,
03386                               (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1,
03387                               0,
03388                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03389         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) )
03390         {
03391             wCharBuf[0] = ScreenBufPtr-&gt;Char.UnicodeChar;
03392             wCharBuf[1] = TEXT(<span class="charliteral">'\0'</span>);
03393             <a class="code" href="../../d0/d3/dbcs_8h.html#a28">GetStringBitmapW</a>(ScreenInfo-&gt;Console-&gt;hDC,
03394                              wCharBuf,
03395                              1,
03396                              (ULONG)<a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(StringBitmap),
03397                              (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)StringBitmap
03398                             );
03399 
03400             RetFontSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)StringBitmap-&gt;uiWidth;
03401             RetFontSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)StringBitmap-&gt;uiHeight;
03402 
03403             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03404                                   ScreenBufPtr-&gt;Char.UnicodeChar,
03405                                   RetFontSize,
03406                                   <a class="code" href="../../d6/d6/foncache_8h.html#a9">BYTE_ALIGN</a>,
03407                                   StringBitmap-&gt;ajBits
03408                                  );
03409             <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03410                 RIPMSG3(RIP_WARNING, <span class="stringliteral">"SetRAMFont: failed to set font image. wc=%04x sz=(%x,%x)"</span>,
03411                         ScreenBufPtr-&gt;Char.UnicodeChar, RetFontSize.X, RetFontSize.Y);
03412             }
03413 
03414             <span class="keywordflow">if</span> ( ( (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) &amp;&amp;
03415                     (GdiFontSize2.X != FsFontSize2.X || GdiFontSize2.Y != FsFontSize2.Y)) ||
03416                  (!(ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) &amp;&amp;
03417                     (GdiFontSize1.X != FsFontSize1.X || GdiFontSize1.Y != FsFontSize1.Y))    )
03418             {
03419                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FsFontSize2,<a class="code" href="../../d6/d6/foncache_8h.html#a10">WORD_ALIGN</a>);
03420                 FontImage = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(TMP_DBCS_TAG),
03421                                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>
03422                                      );
03423                 <span class="keywordflow">if</span> (FontImage!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03424 
03425                     <a class="code" href="../../d6/d6/foncache_8h.html#a30">GetExpandFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03426                                        ScreenBufPtr-&gt;Char.UnicodeChar,
03427                                        (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? GdiFontSize2 : GdiFontSize1,
03428                                        (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1,
03429                                        FontImage
03430                                       );
03431 
03432                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03433                                           ScreenBufPtr-&gt;Char.UnicodeChar,
03434                                           (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1,
03435                                           <a class="code" href="../../d6/d6/foncache_8h.html#a10">WORD_ALIGN</a>,
03436                                           FontImage
03437                                          );
03438                     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03439                         RIPMSG3(RIP_WARNING, <span class="stringliteral">"SetRAMFont: failed to set font image. wc=%04x sz=(%x,%x)"</span>,
03440                                 ScreenBufPtr-&gt;Char.UnicodeChar,
03441                                 ((ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1).X,
03442                                 ((ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1).Y);
03443                     }
03444 
03445                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontImage);
03446                 } <span class="keywordflow">else</span> {
03447                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetRAMFont: failed to allocate FontImage."</span>);
03448                 }
03449             }
03450         }
03451 
03452         <span class="keywordflow">if</span> (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS)
03453         {
03454             ScreenBufPtr += 2;
03455             <span class="keywordflow">if</span> (Length &gt;= 1)
03456                 Length -= 1;
03457             <span class="keywordflow">else</span>
03458                 <span class="keywordflow">break</span>;
03459         }
03460         <span class="keywordflow">else</span>
03461         {
03462             ScreenBufPtr++;
03463         }
03464     }
03465 
03466     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(StringBitmap);
03467 
03468     <span class="comment">/*</span>
03469 <span class="comment">     * Back to GDI font</span>
03470 <span class="comment">     */</span>
03471     SelectObject(ScreenInfo-&gt;Console-&gt;hDC,hOldFont);
03472 
03473     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03474 }
03475 
03476 <span class="preprocessor">#ifdef i386</span>
03477 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_SB)</span>
03478 <span class="preprocessor"></span>
03479 <span class="preprocessor">#define WWSB_NOFE</span>
03480 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d9/d2/__priv_8h.html">_priv.h</a>"</span>
03481 <span class="preprocessor">#undef  WWSB_NOFE</span>
03482 <span class="preprocessor"></span><span class="preprocessor">#define WWSB_FE</span>
03483 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d9/d2/__priv_8h.html">_priv.h</a>"</span>
03484 <span class="preprocessor">#undef  WWSB_FE</span>
03485 <span class="preprocessor"></span>
03486 <span class="preprocessor">#endif  // FE_SB</span>
03487 <span class="preprocessor"></span><span class="preprocessor">#endif  // i386</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
