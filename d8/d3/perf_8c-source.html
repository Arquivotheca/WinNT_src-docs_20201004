<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: perf.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>perf.c</h1><a href="../../d7/d4/perf_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: perf.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* performance timing calls</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 12-Jun-1991 mikeke</span>
00010 <span class="comment">*</span>
00011 <span class="comment">\**************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00014 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00015 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00016 <span class="preprocessor">#include "<a class="code" href="../../d6/d0/usercli_8h.html">usercli.h</a>"</span>
00017 <span class="preprocessor">#include &lt;string.h&gt;</span>
00018 
00019 <span class="preprocessor">#include "ntcsrdll.h"</span>
00020 <span class="preprocessor">#include "csuser.h"</span>
00021 
00022 <span class="comment">/**************************************************************************\</span>
00023 <span class="comment">\**************************************************************************/</span>
00024 
<a name="l00025"></a><a class="code" href="../../d7/d4/perf_8c.html#a0">00025</a> <span class="keyword">typedef</span> CSR_QLPC_API_MSG *<a class="code" href="../../d7/d4/perf_8c.html#a0">PCSRMSG</a>;
00026 
<a name="l00027"></a><a class="code" href="../../d7/d4/perf_8c.html#a1">00027</a> <span class="keyword">typedef</span> PDWORD (* <a class="code" href="../../d7/d4/perf_8c.html#a1">PINSTUBFUNC</a>)(PDWORD, PDWORD, PDWORD, PDWORD);
<a name="l00028"></a><a class="code" href="../../d7/d4/perf_8c.html#a2">00028</a> <span class="keyword">typedef</span> void (* <a class="code" href="../../d7/d4/perf_8c.html#a2">POUTSTUBFUNC</a>)(PDWORD, PDWORD);
00029 
00030 PDWORD <a class="code" href="../../d7/d4/perf_8c.html#a6">Copy4</a>(PDWORD psrc,PDWORD pdst,PDWORD pparam,PDWORD pmax);
00031 PDWORD <a class="code" href="../../d7/d4/perf_8c.html#a7">Copy5</a>(PDWORD psrc,PDWORD pdst,PDWORD pparam,PDWORD pmax);
00032 PDWORD <a class="code" href="../../d7/d4/perf_8c.html#a8">CopySTR</a>(PDWORD psrc,PDWORD pdst,PDWORD pparam,PDWORD pmax);
00033 
00034 <span class="preprocessor">#if !defined(_MIPS_) &amp;&amp; !defined(_PPC_)</span>
<a name="l00035"></a><a class="code" href="../../d7/d4/perf_8c.html#a9">00035</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d7/d4/perf_8c.html#a9">OutCopy4</a>(
00036     PDWORD psrc,
00037     PDWORD pdst)
00038 {
00039     pdst[0] = psrc[0];
00040     pdst[1] = psrc[1];
00041     pdst[2] = psrc[2];
00042     pdst[3] = psrc[3];
00043 }
00044 
<a name="l00045"></a><a class="code" href="../../d7/d4/perf_8c.html#a6">00045</a> PDWORD <a class="code" href="../../d7/d4/perf_8c.html#a6">Copy4</a>(
00046     PDWORD psrc,
00047     PDWORD pdst,
00048     PDWORD pparam,
00049     PDWORD pmax)
00050 {
00051     <span class="keywordflow">if</span> (pdst + 5 &lt;= pmax) {
00052         pdst[0] = psrc[0];
00053         pdst[1] = psrc[1];
00054         pdst[2] = psrc[2];
00055         pdst[3] = psrc[3];
00056         <span class="keywordflow">return</span> pdst + 4;
00057     }
00058     <span class="keywordflow">return</span> 0;
00059     pparam;
00060 }
00061 
<a name="l00062"></a><a class="code" href="../../d7/d4/perf_8c.html#a7">00062</a> PDWORD <a class="code" href="../../d7/d4/perf_8c.html#a7">Copy5</a>(
00063     PDWORD psrc,
00064     PDWORD pdst,
00065     PDWORD pparam,
00066     PDWORD pmax)
00067 {
00068     <span class="keywordflow">if</span> (pdst + 5 &lt;= pmax) {
00069         pdst[0] = psrc[0];
00070         pdst[1] = psrc[1];
00071         pdst[2] = psrc[2];
00072         pdst[3] = psrc[3];
00073         pdst[4] = psrc[4];
00074         <span class="keywordflow">return</span> pdst + 5;
00075     }
00076     <span class="keywordflow">return</span> 0;
00077     pparam;
00078 }
00079 
<a name="l00080"></a><a class="code" href="../../d7/d4/perf_8c.html#a10">00080</a> PDWORD <a class="code" href="../../d7/d4/perf_8c.html#a10">Copy6</a>(
00081     PDWORD psrc,
00082     PDWORD pdst,
00083     PDWORD pparam,
00084     PDWORD pmax)
00085 {
00086     <span class="keywordflow">if</span> (pdst + 6 &lt;= pmax) {
00087         pdst[0] = psrc[0];
00088         pdst[1] = psrc[1];
00089         pdst[2] = psrc[2];
00090         pdst[3] = psrc[3];
00091         pdst[4] = psrc[4];
00092         pdst[5] = psrc[5];
00093         <span class="keywordflow">return</span> pdst + 6;
00094     }
00095     <span class="keywordflow">return</span> 0;
00096     pparam;
00097 }
00098 
<a name="l00099"></a><a class="code" href="../../d7/d4/perf_8c.html#a8">00099</a> PDWORD <a class="code" href="../../d7/d4/perf_8c.html#a8">CopySTR</a>(
00100     PDWORD psrc,
00101     PDWORD pdst,
00102     PDWORD pparam,
00103     PDWORD pmax)
00104 {
00105     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> length = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)psrc;
00106 
00107     <span class="keywordflow">while</span> (*length)
00108         length++;
00109 
00110     length = (length - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)psrc + (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdst);
00111     length = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)length +3 ) &amp; ~3);
00112 
00113     <span class="keywordflow">if</span> (length &lt;= (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pmax) {
00114         <span class="keywordflow">while</span> ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdst != (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)length) {
00115             *pdst = *psrc;
00116             pdst++;
00117             psrc++;
00118         }
00119         <span class="keywordflow">return</span> (PDWORD)length;
00120     }
00121     <span class="keywordflow">return</span> 0;
00122     pparam;
00123 }
00124 <span class="preprocessor">#endif</span>
00125 <span class="preprocessor"></span>
00126 <span class="comment">/**************************************************************************\</span>
00127 <span class="comment">\**************************************************************************/</span>
00128 
00129 PDWORD <a class="code" href="../../d7/d4/perf_8c.html#a11">AIDoClientInStuff</a>(
00130     PDWORD psrc,
00131     PDWORD pbase,
00132     PDWORD ptemplate,
00133     PDWORD pmax);
00134 
00135 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d4/perf_8c.html#a12">AIDoClientOutStuff</a>(
00136     PDWORD psrc,
00137     PDWORD pbase,
00138     PDWORD ptemplate);
00139 
<a name="l00140"></a><a class="code" href="../../d7/d4/perf_8c.html#a13">00140</a> PDWORD <a class="code" href="../../d7/d4/perf_8c.html#a13">DoClientInStuff</a>(
00141     PDWORD psrc,
00142     PDWORD pbase,
00143     PDWORD ptemplate,
00144     PDWORD pmax)
00145 {
00146     PDWORD pparam;
00147     PDWORD param;
00148     PDWORD pdst;
00149 
00150     <span class="keywordflow">if</span> (ptemplate[0]) {
00151         pdst = ((<a class="code" href="../../d7/d4/perf_8c.html#a1">PINSTUBFUNC</a>)ptemplate[0])(psrc, pbase, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pmax);
00152         <span class="keywordflow">if</span> (!pdst) {
00153             <span class="keywordflow">return</span> 0;
00154         }
00155         ptemplate++;
00156 
00157         <span class="keywordflow">while</span> (ptemplate[0]) {
00158             pparam = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pbase + ptemplate[1]);
00159             param = (PDWORD)*pparam;
00160             *pparam = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdst - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pbase;
00161             pdst = ((<a class="code" href="../../d7/d4/perf_8c.html#a1">PINSTUBFUNC</a>)ptemplate[0])(param, pdst, pparam, pmax);
00162             <span class="keywordflow">if</span> (!pdst) {
00163                 <span class="keywordflow">return</span> 0;
00164             }
00165             ptemplate += 2;
00166         }
00167     }
00168 }
00169 
<a name="l00170"></a><a class="code" href="../../d7/d4/perf_8c.html#a14">00170</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d4/perf_8c.html#a14">DoClientOutStuff</a>(
00171     PDWORD psrc,
00172     PDWORD pdst,
00173     PDWORD ptemplate)
00174 {
00175     PDWORD pparam;
00176 
00177     <span class="keywordflow">while</span> (ptemplate[0]) {
00178         pparam = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)psrc + ptemplate[1]);
00179         ((<a class="code" href="../../d7/d4/perf_8c.html#a2">POUTSTUBFUNC</a>)ptemplate[0])(
00180             (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)psrc + *pparam),
00181             *(PDWORD *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdst + ptemplate[1])
00182         );
00183         ptemplate += 2;
00184     }
00185 }
00186 
00187 <span class="comment">/**************************************************************************\</span>
00188 <span class="comment">\**************************************************************************/</span>
00189 
<a name="l00190"></a><a class="code" href="../../d7/d4/perf_8c.html#a15">00190</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d4/perf_8c.html#a15">MakeCSCall</a>(
00191     DWORD findex,
00192     PDWORD psrc,
00193     PDWORD pInTemplate,
00194     PDWORD pOutTemplate
00195     )
00196 {
00197     PCSR_QLPC_TEB pteb = (PCSR_QLPC_TEB)NtCurrentTeb()-&gt;CsrQlpcTeb;
00198     PCSR_QLPC_STACK pstack;
00199     <a class="code" href="../../d7/d4/perf_8c.html#a0">PCSRMSG</a> pmsg;
00200     ULONG retval;
00201     PDWORD pbase;
00202     PDWORD pdst;
00203     PDWORD plast;
00204     PDWORD pmax;
00205 
00206     <span class="comment">//</span>
00207     <span class="comment">// connect to the server</span>
00208     <span class="comment">//</span>
00209 
00210     <span class="keywordflow">if</span> (pteb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00211         pteb = CsrClientThreadConnect();
00212         <span class="keywordflow">if</span> (pteb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00213             <span class="keywordflow">return</span> 0;
00214         }
00215     }
00216 
00217     pstack = pteb-&gt;MessageStack;
00218     <span class="keywordflow">if</span> (pstack-&gt;BatchCount) {
00219         CsrClientSendMessage();
00220         pbase = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack + pstack-&gt;Base);
00221     } <span class="keywordflow">else</span> {
00222         pbase = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack + pstack-&gt;Current);
00223     }
00224     pmax = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack + pstack-&gt;Limit);
00225     pmsg = (<a class="code" href="../../d7/d4/perf_8c.html#a0">PCSRMSG</a>)(pbase+1);
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">// is there enough space left on the stack?</span>
00229     <span class="comment">//</span>
00230 
00231     pdst = (PDWORD)(pmsg + 1);
00232     <span class="keywordflow">if</span> (pdst &lt;= pmax) {
00233 
00234         <span class="comment">//</span>
00235         <span class="comment">// copy the data to shared memory</span>
00236         <span class="comment">//</span>
00237 
00238         <span class="keywordflow">if</span> (pInTemplate) {
00239             plast = <a class="code" href="../../d7/d4/perf_8c.html#a13">DoClientInStuff</a>(psrc, pdst, pInTemplate, pmax);
00240         } <span class="keywordflow">else</span> {
00241             plast = pdst;
00242         }
00243 
00244         <span class="keywordflow">if</span> (plast) {
00245 
00246             <span class="comment">//</span>
00247             <span class="comment">// Make the call</span>
00248             <span class="comment">//</span>
00249 
00250             pmsg-&gt;Length = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)plast - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pmsg;
00251             pmsg-&gt;ApiNumber = findex;
00252             *pbase = pstack-&gt;Base;
00253             pstack-&gt;Base = pstack-&gt;Current+4;
00254             pstack-&gt;Current = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdst - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack;
00255             pstack-&gt;BatchCount = 1;
00256 
00257             retval = CsrClientSendMessage();
00258 
00259             pstack-&gt;Current = pstack-&gt;Base - 4;
00260             pstack-&gt;Base = *pbase;
00261 
00262             <span class="comment">//</span>
00263             <span class="comment">// Do any post call copies</span>
00264             <span class="comment">//</span>
00265 
00266             <span class="keywordflow">if</span> (pOutTemplate) {
00267                 <a class="code" href="../../d7/d4/perf_8c.html#a14">DoClientOutStuff</a>(pdst, psrc, pOutTemplate);
00268             }
00269 
00270             <span class="keywordflow">return</span> retval;
00271         }
00272     }
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">// an error occured</span>
00276     <span class="comment">//</span>
00277 
00278     <span class="keywordflow">return</span> 0;
00279 }
00280 
00281 <span class="comment">/**************************************************************************\</span>
00282 <span class="comment">\**************************************************************************/</span>
00283 
00284 <span class="preprocessor">#if defined(_MIPS_) || defined(_PPC_)</span>
00285 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> AIMakeCSCall(
00286     DWORD findex,
00287     PDWORD psrc,
00288     PDWORD pInTemplate,
00289     PDWORD pOutTemplate
00290     )
00291 {
00292     PCSR_QLPC_TEB pteb = (PCSR_QLPC_TEB)NtCurrentTeb()-&gt;CsrQlpcTeb;
00293     PCSR_QLPC_STACK pstack;
00294     <a class="code" href="../../d7/d4/perf_8c.html#a0">PCSRMSG</a> pmsg;
00295     ULONG retval;
00296     PDWORD pbase;
00297     PDWORD pdst;
00298     PDWORD plast;
00299     PDWORD pmax;
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">// connect to the server</span>
00303     <span class="comment">//</span>
00304 
00305     <span class="keywordflow">if</span> (pteb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00306         pteb = CsrClientThreadConnect();
00307         <span class="keywordflow">if</span> (pteb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00308             <span class="keywordflow">return</span> 0;
00309         }
00310     }
00311 
00312     pstack = pteb-&gt;MessageStack;
00313     <span class="keywordflow">if</span> (pstack-&gt;BatchCount) {
00314         CsrClientSendMessage();
00315         pbase = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack + pstack-&gt;Base);
00316     } <span class="keywordflow">else</span> {
00317         pbase = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack + pstack-&gt;Current);
00318     }
00319     pmax = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack + pstack-&gt;Limit);
00320     pmsg = (<a class="code" href="../../d7/d4/perf_8c.html#a0">PCSRMSG</a>)(pbase+1);
00321 
00322     <span class="comment">//</span>
00323     <span class="comment">// is there enough space left on the stack?</span>
00324     <span class="comment">//</span>
00325 
00326     <span class="keywordflow">if</span> ((PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pmsg + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/perf_8c.html#a0">PCSRMSG</a>)) &lt;= pmax) {
00327 
00328         <span class="comment">//</span>
00329         <span class="comment">// copy the data to shared memory</span>
00330         <span class="comment">//</span>
00331 
00332         pdst = (PDWORD)(pmsg + 1);
00333         <span class="keywordflow">if</span> (pInTemplate) {
00334             plast = <a class="code" href="../../d7/d4/perf_8c.html#a11">AIDoClientInStuff</a>(psrc, pdst, pInTemplate, pmax);
00335         } <span class="keywordflow">else</span> {
00336             plast = pdst;
00337         }
00338 
00339         <span class="keywordflow">if</span> (plast) {
00340 
00341             <span class="comment">//</span>
00342             <span class="comment">// Make the call</span>
00343             <span class="comment">//</span>
00344 
00345             pmsg-&gt;Length = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)plast - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pmsg;
00346             pmsg-&gt;ApiNumber = findex;
00347             *pbase = pstack-&gt;Base;
00348             pstack-&gt;Base = pstack-&gt;Current+4;
00349             pstack-&gt;Current = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdst - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack;
00350             pstack-&gt;BatchCount = 1;
00351 
00352             retval = CsrClientSendMessage();
00353 
00354             pstack-&gt;Current = pstack-&gt;Base - 4;
00355             pstack-&gt;Base = *pbase;
00356 
00357             <span class="comment">//</span>
00358             <span class="comment">// Do any post call copies</span>
00359             <span class="comment">//</span>
00360 
00361             <span class="keywordflow">if</span> (pOutTemplate) {
00362                 <a class="code" href="../../d7/d4/perf_8c.html#a12">AIDoClientOutStuff</a>(pdst, psrc, pOutTemplate);
00363             }
00364 
00365             <span class="keywordflow">return</span> retval;
00366         }
00367     }
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">// an error occured</span>
00371     <span class="comment">//</span>
00372 
00373     <span class="keywordflow">return</span> 0;
00374 }
00375 <span class="preprocessor">#endif</span>
00376 <span class="preprocessor"></span>
00377 <span class="comment">/**************************************************************************\</span>
00378 <span class="comment">\**************************************************************************/</span>
00379 
00380 <span class="preprocessor">#ifdef LATER</span>
00381 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>_TESTMSG {
00382     <span class="keywordtype">int</span> a;
00383     <span class="keywordtype">int</span> b;
00384     RECT *lprc;
00385     <span class="keywordtype">int</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00386     LPSTR lpstr;
00387     RECT rc;
00388 } TESTMSG;
00389 
00390 PDWORD CSInTestCall(
00391     PDWORD psrc,
00392     PDWORD pdst,
00393     PDWORD pmax)
00394 {
00395     PDWORD pvar;
00396     TESTMSG *pmsg;
00397     TESTMSG *pparam;
00398 
00399     <span class="keywordflow">if</span> (pmax &gt; pdst + <span class="keyword">sizeof</span>(TESTMSG)) {
00400         pmsg = (TESTMSG *)pdst;
00401         pparam = (TESTMSG *)psrc;
00402         pvar = (PDWORD)(pmsg + 1);
00403 
00404         pmsg-&gt;a = pparam-&gt;a;
00405         pmsg-&gt;b = pparam-&gt;b;
00406         pmsg-&gt;c = pparam-&gt;c;
00407 
00408         pmsg-&gt;lprc = (RECT *)(((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;(pmsg-&gt;rc)) - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pmsg);
00409         pmsg-&gt;rc = *(pparam-&gt;lprc);
00410 
00411         pmsg-&gt;lpstr = (LPSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pvar - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pmsg);
00412         pvar = <a class="code" href="../../d7/d4/perf_8c.html#a8">CopySTR</a>((PDWORD)pparam-&gt;lpstr, pvar, NULL, pmax);
00413 
00414         <span class="keywordflow">if</span> (pvar) {
00415             <span class="keywordflow">return</span> (PDWORD)pvar;
00416         }
00417     }
00418     <span class="keywordflow">return</span> 0;
00419 }
00420 
00421 <span class="keyword">typedef</span> <span class="keyword">struct </span>_TESTMSG {
00422     HWND hwnd;
00423     <span class="keywordtype">int</span> a;
00424     <span class="keywordtype">int</span> b;
00425     <span class="keywordtype">int</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00426     <span class="keywordtype">int</span> d;
00427     <span class="keywordtype">int</span> e;
00428 } TESTMSG;
00429 
00430 PDWORD CSInTestCall(
00431     PDWORD psrc,
00432     PDWORD pdst,
00433     PDWORD pmax)
00434 {
00435     TESTMSG *pmsg;
00436     TESTMSG *pparam;
00437 
00438     <span class="keywordflow">if</span> (pmax &gt; pdst + <span class="keyword">sizeof</span>(TESTMSG)) {
00439         pmsg = (TESTMSG *)pdst;
00440         pparam = (TESTMSG *)psrc;
00441 
00442         pmsg-&gt;hwnd = pparam-&gt;hwnd;
00443         pmsg-&gt;a = pparam-&gt;a;
00444         pmsg-&gt;b = pparam-&gt;b;
00445         pmsg-&gt;c = pparam-&gt;c;
00446         pmsg-&gt;d = pparam-&gt;d;
00447         pmsg-&gt;e = pparam-&gt;e;
00448         <span class="keywordflow">return</span> (PDWORD)(pmsg + 1);
00449     }
00450     <span class="keywordflow">return</span> 0;
00451 }
00452 <span class="preprocessor">#endif</span>
00453 <span class="preprocessor"></span>
00454 <span class="comment">/**************************************************************************\</span>
00455 <span class="comment">\**************************************************************************/</span>
00456 
<a name="l00457"></a><a class="code" href="../../d7/d4/perf_8c.html#a3">00457</a> <span class="keyword">typedef</span> PDWORD (* <a class="code" href="../../d7/d4/perf_8c.html#a3">PCSINFUNC</a>)(PDWORD, PDWORD, PDWORD);
<a name="l00458"></a><a class="code" href="../../d7/d4/perf_8c.html#a4">00458</a> <span class="keyword">typedef</span> PDWORD (* <a class="code" href="../../d7/d4/perf_8c.html#a4">PCSOUTFUNC</a>)(PDWORD, PDWORD);
00459 
00460 
<a name="l00461"></a><a class="code" href="../../d7/d4/perf_8c.html#a16">00461</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d4/perf_8c.html#a16">CSMakeCall</a>(
00462     DWORD findex,
00463     PDWORD psrc,
00464     PCSINFUNC pInFunc,
00465     PCSOUTFUNC pOutFunc
00466     )
00467 {
00468     PCSR_QLPC_TEB pteb = (PCSR_QLPC_TEB)NtCurrentTeb()-&gt;CsrQlpcTeb;
00469     PCSR_QLPC_STACK pstack;
00470     <a class="code" href="../../d7/d4/perf_8c.html#a0">PCSRMSG</a> pmsg;
00471     ULONG retval;
00472     PDWORD pbase;
00473     PDWORD pdst;
00474     PDWORD plast;
00475     PDWORD pmax;
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// connect to the server</span>
00479     <span class="comment">//</span>
00480 
00481     <span class="keywordflow">if</span> (pteb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00482         pteb = CsrClientThreadConnect();
00483         <span class="keywordflow">if</span> (pteb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00484             <span class="keywordflow">return</span> 0;
00485         }
00486     }
00487 
00488     pstack = pteb-&gt;MessageStack;
00489     <span class="keywordflow">if</span> (pstack-&gt;BatchCount) {
00490         CsrClientSendMessage();
00491         pbase = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack + pstack-&gt;Base);
00492     } <span class="keywordflow">else</span> {
00493         pbase = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack + pstack-&gt;Current);
00494     }
00495     pmax = (PDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack + pstack-&gt;Limit);
00496     pmsg = (<a class="code" href="../../d7/d4/perf_8c.html#a0">PCSRMSG</a>)(pbase+1);
00497 
00498     <span class="comment">//</span>
00499     <span class="comment">// is there enough space left on the stack?</span>
00500     <span class="comment">//</span>
00501 
00502     pdst = (PDWORD)(pmsg + 1);
00503     <span class="keywordflow">if</span> (pdst &lt;= pmax) {
00504 
00505         <span class="comment">//</span>
00506         <span class="comment">// copy the data to shared memory</span>
00507         <span class="comment">//</span>
00508 
00509         <span class="keywordflow">if</span> (pInFunc) {
00510             plast = pInFunc(psrc, pdst, pmax);
00511         } <span class="keywordflow">else</span> {
00512             plast = pdst;
00513         }
00514 
00515         <span class="keywordflow">if</span> (plast) {
00516 
00517             <span class="comment">//</span>
00518             <span class="comment">// Make the call</span>
00519             <span class="comment">//</span>
00520 
00521             pmsg-&gt;Length = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)plast - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pmsg;
00522             pmsg-&gt;ApiNumber = findex;
00523             *pbase = pstack-&gt;Base;
00524             pstack-&gt;Base = pstack-&gt;Current+4;
00525             pstack-&gt;Current = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pdst - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pstack;
00526             pstack-&gt;BatchCount = 1;
00527 
00528             retval = CsrClientSendMessage();
00529 
00530             pstack-&gt;Current = pstack-&gt;Base - 4;
00531             pstack-&gt;Base = *pbase;
00532 
00533             <span class="comment">//</span>
00534             <span class="comment">// Do any post call copies</span>
00535             <span class="comment">//</span>
00536 
00537             <span class="keywordflow">if</span> (pOutFunc) {
00538                 pOutFunc(pdst, psrc);
00539             }
00540 
00541             <span class="keywordflow">return</span> retval;
00542         }
00543     }
00544 
00545     <span class="comment">//</span>
00546     <span class="comment">// an error occured</span>
00547     <span class="comment">//</span>
00548 
00549     <span class="keywordflow">return</span> 0;
00550 }
00551 
00552 <span class="comment">/**************************************************************************\</span>
00553 <span class="comment">\**************************************************************************/</span>
00554 
00555 <span class="comment">// DWORD CTestCall(int a, int b, LPRECT lprc, int c, LPSTR lpstr)</span>
00556 
00557 <span class="preprocessor">#if 0</span>
00558 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CTestCall(HWND hwnd, <span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b, <span class="keywordtype">int</span> c, <span class="keywordtype">int</span> d, <span class="keywordtype">int</span> e)
00559 {
00560     <span class="keywordflow">return</span> <a class="code" href="../../d7/d4/perf_8c.html#a16">CSMakeCall</a>(
00561         CSR_MAKE_API_NUMBER(4,FI_CTESTCALL),
00562         (PDWORD)&amp;hwnd,
00563         CSInTestCall,
00564         NULL);
00565 }
00566 <span class="preprocessor">#endif</span>
00567 <span class="preprocessor"></span>
00568 <span class="comment">/**************************************************************************\</span>
00569 <span class="comment">\**************************************************************************/</span>
00570 
00571 <span class="comment">/**************************************************************************\</span>
00572 <span class="comment">\**************************************************************************/</span>
00573 
00574 <span class="comment">/**************************************************************************\</span>
00575 <span class="comment">\**************************************************************************/</span>
00576 
00577 <span class="preprocessor">#ifdef LATER</span>
00578 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d4/perf_8c.html#a5">InTestCall</a>[] = {
00579     (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d7/d4/perf_8c.html#a7">Copy5</a>,
00580     (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d7/d4/perf_8c.html#a6">Copy4</a>,
00581     8,
00582     (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d7/d4/perf_8c.html#a8">CopySTR</a>,
00583     16,
00584     0
00585 };
00586 <span class="preprocessor">#endif</span>
00587 <span class="preprocessor"></span>
<a name="l00588"></a><a class="code" href="../../d7/d4/perf_8c.html#a5">00588</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d4/perf_8c.html#a5">InTestCall</a>[] = {
00589     (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d7/d4/perf_8c.html#a10">Copy6</a>,
00590     0
00591 };
00592 
<a name="l00593"></a><a class="code" href="../../d7/d4/perf_8c.html#a17">00593</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d4/perf_8c.html#a17">ITestCall</a>(HWND hwnd, <span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b, <span class="keywordtype">int</span> c, <span class="keywordtype">int</span> d, <span class="keywordtype">int</span> e)
00594 {
00595    <span class="keywordflow">return</span> <a class="code" href="../../d7/d4/perf_8c.html#a15">MakeCSCall</a>(
00596        CSR_MAKE_API_NUMBER(4,FI_CTESTCALL),
00597        (PDWORD)&amp;hwnd,
00598        <a class="code" href="../../d7/d4/perf_8c.html#a5">InTestCall</a>,
00599        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00600    );
00601 }
00602 
<a name="l00603"></a><a class="code" href="../../d7/d4/perf_8c.html#a18">00603</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d4/perf_8c.html#a18">AITestCall</a>(HWND hwnd, <span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b, <span class="keywordtype">int</span> c, <span class="keywordtype">int</span> d, <span class="keywordtype">int</span> e)
00604 {
00605 <span class="preprocessor">#if defined(_MIPS_) || defined(_PPC_)</span>
00606 <span class="preprocessor"></span>   <span class="keywordflow">return</span> AIMakeCSCall(
00607 #<span class="keywordflow">else</span>
00608    <span class="keywordflow">return</span> <a class="code" href="../../d7/d4/perf_8c.html#a15">MakeCSCall</a>(
00609 #endif
00610        CSR_MAKE_API_NUMBER(4,FI_CTESTCALL),
00611        (PDWORD)&amp;hwnd,
00612        <a class="code" href="../../d7/d4/perf_8c.html#a5">InTestCall</a>,
00613        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00614    );
00615 }
00616 
00617 <span class="comment">/**************************************************************************\</span>
00618 <span class="comment">\**************************************************************************/</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
