<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ddkresrc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ddkresrc.c</h1><a href="../../d7/d4/ddkresrc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Resource.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the executive functions to acquire and release</span>
00012 <span class="comment">    a shared resource, that was unfortunately export to ntddk in release 1.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Gary D. Kimura      [GaryKi]    25-Jun-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00027 <span class="preprocessor">#pragma hdrstop</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00030 
00031 <span class="comment">//</span>
00032 <span class="comment">//  The following variable, macros, and procedure are only for debug purposes.</span>
00033 <span class="comment">//</span>
00034 
<a name="l00035"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a14">00035</a> <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d7/d4/ddkresrc_8c.html#a14">ExpTimeout</a>;
00036 
00037 <span class="comment">//</span>
00038 <span class="comment">//  thirty days worth</span>
00039 <span class="comment">//</span>
00040 
<a name="l00041"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a15">00041</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a44">ExpResourceTimeoutCount</a>;
00042 
00043 <span class="comment">//</span>
00044 <span class="comment">//  Avoid the aliasing done in ex.h</span>
00045 <span class="comment">//</span>
00046 
00047 <span class="preprocessor">#undef ExInitializeResource</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#undef ExAcquireResourceExclusive</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#undef ExReleaseResourceForThread</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#undef ExDeleteResource</span>
00051 <span class="preprocessor"></span>
00052 <span class="preprocessor">#if !DBG &amp;&amp; NT_UP &amp;&amp; defined(i386)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#define ExReleaseResourceForThread ExpReleaseResourceForThread</span>
00054 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00055 <a class="code" href="../../d5/d8/ex_8h.html#a71">ExReleaseResourceForThread</a>(
00056     IN <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a> Resource,
00057     IN ERESOURCE_THREAD OurThread
00058     );
00059 <span class="preprocessor">#endif</span>
00060 <span class="preprocessor"></span>
00061 <span class="preprocessor">#if DBG</span>
00062 <span class="preprocessor"></span>
00063 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00064 ExpAssertResourceDdk (
00065     IN <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a>   Resource
00066     );
00067 
00068 <span class="preprocessor">#define ASSERT_RESOURCE(_Resource)  ExpAssertResourceDdk(_Resource)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00070"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define ASSERT_RESOURCE(_Resource)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00072 <span class="preprocessor"></span>
00073 <span class="comment">//</span>
00074 <span class="comment">// bit value for ERESOURCE.Flag</span>
00075 <span class="comment">//</span>
00076 
<a name="l00077"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a1">00077</a> <span class="preprocessor">#define ExclusiveWaiter             0x01    // ** Also in i386\resoura.asm **</span>
<a name="l00078"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a2">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define SharedWaiter                0x02    // ** Also in i386\resoura.asm **</span>
00079 <span class="preprocessor"></span><span class="comment">//      CounterShiftBit             0x04    - see below</span>
<a name="l00080"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a3">00080</a> <span class="preprocessor">#define DisablePriorityBoost        0x08</span>
00081 <span class="preprocessor"></span><span class="comment">//      ResourceOwnedExclusive      0x80    - from ex.h</span>
00082 
00083 <span class="preprocessor">#if NT_UP</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#define CounterShiftBit     0x00</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00086"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a4">00086</a> <span class="preprocessor"></span><span class="preprocessor">#define CounterShiftBit     0x04        // Must be 0x04!</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>
<a name="l00089"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">00089</a> <span class="preprocessor">#define IsExclusiveWaiting(a)   (((a)-&gt;Flag &amp; ExclusiveWaiter) != 0)</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#define IsOwnedExclusive(a)     (((a)-&gt;Flag &amp; ResourceOwnedExclusive) != 0)</span>
<a name="l00091"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a7">00091</a> <span class="preprocessor"></span><span class="preprocessor">#define IsOwnedExclusive(a)     (((a)-&gt;Flag &amp; ResourceOwnedExclusive) != 0)</span>
<a name="l00092"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a8">00092</a> <span class="preprocessor"></span><span class="preprocessor">#define IsBoostAllowed(a)       (((a)-&gt;Flag &amp; DisablePriorityBoost) == 0)</span>
00093 <span class="preprocessor"></span>
00094 <span class="comment">//</span>
00095 <span class="comment">//  The following static data and two macros are used to control entering and</span>
00096 <span class="comment">//  exiting the resource critical section.</span>
00097 <span class="comment">//</span>
00098 
<a name="l00099"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a16">00099</a> <span class="keyword">static</span> KSPIN_LOCK <a class="code" href="../../d7/d4/ddkresrc_8c.html#a16">ExpResourceSpinLock</a>;
00100 
00101 <span class="comment">//++</span>
00102 <span class="comment">//</span>
00103 <span class="comment">//  Macros:</span>
00104 <span class="comment">//      AcquireResourceLock - Obtains the Resource's spinlock</span>
00105 <span class="comment">//      ReleaseResourceLock - Releases the Resource's spinlock</span>
00106 <span class="comment">//</span>
00107 <span class="comment">//      WaitForResourceExclusive(Resource, OldIrql)</span>
00108 <span class="comment">//          Block on resource until WakeSharedWaiters</span>
00109 <span class="comment">//</span>
00110 <span class="comment">//      WakeExclusiveWaiters</span>
00111 <span class="comment">//          Wakes threads on resource which are WaitForResourceShared</span>
00112 <span class="comment">//</span>
00113 <span class="comment">//--</span>
00114 
<a name="l00115"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a9">00115</a> <span class="preprocessor">#define AcquireResourceLock(_Resource,_Irql) {              \</span>
00116 <span class="preprocessor">    ExAcquireSpinLock( &amp;_Resource-&gt;SpinLock, _Irql );       \</span>
00117 <span class="preprocessor">    ASSERT_RESOURCE( _Resource );                           \</span>
00118 <span class="preprocessor">}</span>
00119 <span class="preprocessor"></span>
<a name="l00120"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a10">00120</a> <span class="preprocessor">#define ReleaseResourceLock(_Resource,_Irql) {              \</span>
00121 <span class="preprocessor">    ExReleaseSpinLock( &amp;_Resource-&gt;SpinLock, _Irql );       \</span>
00122 <span class="preprocessor">}</span>
00123 <span class="preprocessor"></span>
<a name="l00124"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a11">00124</a> <span class="preprocessor">#define INITIAL_TABLE_SIZE  4</span>
00125 <span class="preprocessor"></span>
<a name="l00126"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a12">00126</a> <span class="preprocessor">#define WaitForResourceExclusive(_Resource, _OldIrql)   {               \</span>
00127 <span class="preprocessor">    _Resource-&gt;Flag |= ExclusiveWaiter;                                 \</span>
00128 <span class="preprocessor">    _Resource-&gt;NumberOfExclusiveWaiters += 1;                           \</span>
00129 <span class="preprocessor">    ReleaseResourceLock ( _Resource, _OldIrql );                        \</span>
00130 <span class="preprocessor">    ExpWaitForResourceDdk  ( _Resource, &amp;_Resource-&gt;ExclusiveWaiters ); \</span>
00131 <span class="preprocessor">    AcquireResourceLock ( _Resource, &amp;_OldIrql);                        \</span>
00132 <span class="preprocessor">    if (--_Resource-&gt;NumberOfExclusiveWaiters != 0) {                   \</span>
00133 <span class="preprocessor">        _Resource-&gt;Flag |= ExclusiveWaiter;                             \</span>
00134 <span class="preprocessor">    }                                                                   \</span>
00135 <span class="preprocessor">}</span>
00136 <span class="preprocessor"></span>
<a name="l00137"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a13">00137</a> <span class="preprocessor">#define WakeExclusiveWaiters(_Resource)    {                            \</span>
00138 <span class="preprocessor">    _Resource-&gt;Flag &amp;= ~ExclusiveWaiter;                                \</span>
00139 <span class="preprocessor">    KeSetEvent(&amp;_Resource-&gt;ExclusiveWaiters, 0, FALSE);                 \</span>
00140 <span class="preprocessor">}</span>
00141 <span class="preprocessor"></span>
00142 <span class="comment">//</span>
00143 <span class="comment">//  Local procedure prototypes</span>
00144 <span class="comment">//</span>
00145 
00146 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00147 <a class="code" href="../../d7/d4/ddkresrc_8c.html#a18">ExpWaitForResourceDdk</a> (
00148     IN <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a>   Resource,
00149     IN PVOID        Object
00150     );
00151 
00152 <span class="comment">//</span>
00153 <span class="comment">// The following list head points to a list of all currently</span>
00154 <span class="comment">// initialized Executive Resources in the system.</span>
00155 <span class="comment">//</span>
00156 
<a name="l00157"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">00157</a> <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">ExpSystemResourcesList</a>;
00158 
00159 
00160 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00161 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,ExpResourceInitialization)</span>
00162 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,ExQuerySystemLockInformation)</span>
00163 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00164 <span class="preprocessor"></span>
00165 <span class="comment">//</span>
00166 <span class="comment">//</span>
00167 <span class="comment">//</span>
00168 <span class="comment">//</span>
00169 
00170 
00171 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00172"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a19">00172</a> <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (
00173     IN <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a> Resource
00174     )
00175 
00176 <span class="comment">/*++</span>
00177 <span class="comment"></span>
00178 <span class="comment">Routine Description:</span>
00179 <span class="comment"></span>
00180 <span class="comment">    This routine initializes the input resource variable</span>
00181 <span class="comment"></span>
00182 <span class="comment">Arguments:</span>
00183 <span class="comment"></span>
00184 <span class="comment">    Resource - Supplies the resource variable being initialized</span>
00185 <span class="comment"></span>
00186 <span class="comment">Return Value:</span>
00187 <span class="comment"></span>
00188 <span class="comment">    Status of the operation.</span>
00189 <span class="comment"></span>
00190 <span class="comment">--*/</span>
00191 
00192 {
00193     ULONG   i;
00194 
00195     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"A resource cannot be in paged pool "</span>, <a class="code" href="../../d1/d6/allocpag_8c.html#a48">MmDeterminePoolType</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
00196     <span class="comment">//</span>
00197     <span class="comment">//  Initialize the shared and exclusive waiting counters and semaphore.</span>
00198     <span class="comment">//  The counters indicate how many are waiting for access to the resource</span>
00199     <span class="comment">//  and the semaphores are used to wait on the resource.  Note that</span>
00200     <span class="comment">//  the semaphores can also indicate the number waiting for a resource</span>
00201     <span class="comment">//  however there is a race condition in the algorithm on the acquire</span>
00202     <span class="comment">//  side if count if not updated before the critical section is exited.</span>
00203     <span class="comment">//  So we need to have an outside counter.</span>
00204     <span class="comment">//</span>
00205 
00206     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o8">NumberOfSharedWaiters</a>    = 0;
00207     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a> = 0;
00208 
00209     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a> ( &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>, 0, MAXLONG );
00210     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>     ( &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00211     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>  ( &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o12">SpinLock</a> );
00212 
00213     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a> = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;InitialOwnerThreads;
00214     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;OwnerCounts  = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;InitialOwnerCounts;
00215 
00216     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;TableSize    = <a class="code" href="../../d7/d4/ddkresrc_8c.html#a11">INITIAL_TABLE_SIZE</a>;
00217     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a>  = 0;
00218     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;TableRover   = 1;
00219     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a>         = 0;
00220 
00221     <span class="keywordflow">for</span>(i=0; i &lt; <a class="code" href="../../d7/d4/ddkresrc_8c.html#a11">INITIAL_TABLE_SIZE</a>; i++) {
00222         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[i] = 0;
00223         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;OwnerCounts[i] = 0;
00224     }
00225 
00226     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a> = 0;
00227     InitializeListHead( &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o0">SystemResourcesList</a> );
00228 
00229 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
00230 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00231         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
00232         }
00233     <span class="keywordflow">else</span> {
00234         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o11">CreatorBackTraceIndex</a> = 0;
00235         }
00236 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
00237 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> &gt;= (<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a>)MM_USER_PROBE_ADDRESS) {
00238         <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a> (
00239                 &amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a17">ExpSystemResourcesList</a>,
00240                 &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o0">SystemResourcesList</a>,
00241                 &amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a16">ExpResourceSpinLock</a> );
00242     }
00243 
00244     <span class="keywordflow">return</span> STATUS_SUCCESS;
00245 }
00246 
00247 
00248 BOOLEAN
<a name="l00249"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a20">00249</a> <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(
00250     IN <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a> Resource,
00251     IN BOOLEAN Wait
00252     )
00253 
00254 <span class="comment">/*++</span>
00255 <span class="comment"></span>
00256 <span class="comment">Routine Description:</span>
00257 <span class="comment"></span>
00258 <span class="comment">    The routine acquires the resource for exclusive access.  Upon return from</span>
00259 <span class="comment">    the procedure the resource is acquired for exclusive access.</span>
00260 <span class="comment"></span>
00261 <span class="comment">Arguments:</span>
00262 <span class="comment"></span>
00263 <span class="comment">    Resource - Supplies the resource to acquire</span>
00264 <span class="comment"></span>
00265 <span class="comment">    Wait - Indicates if the call is allowed to wait for the resource</span>
00266 <span class="comment">        to become available for must return immediately</span>
00267 <span class="comment"></span>
00268 <span class="comment">Return Value:</span>
00269 <span class="comment"></span>
00270 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise</span>
00271 <span class="comment"></span>
00272 <span class="comment">--*/</span>
00273 
00274 {
00275     KIRQL OldIrql;
00276     <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>  OurThread;
00277 
00278     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Routine cannot be called at DPC "</span>, !KeIsExecutingDpc() );
00279 
00280     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp; <a class="code" href="../../d5/d8/ex_8h.html#a62">ResourceNeverExclusive</a>) == 0);
00281 
00282     OurThread = (ULONG_PTR)<a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">//  Get exclusive access to this resource structure</span>
00286     <span class="comment">//</span>
00287 
00288     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a9">AcquireResourceLock</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, &amp;OldIrql );
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">//  Loop until the resource is ours or exit if we cannot wait.</span>
00292     <span class="comment">//</span>
00293 
00294     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00295         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0) {
00296 
00297             <span class="comment">//</span>
00298             <span class="comment">// Resource is un-owned, obtain it exclusive</span>
00299             <span class="comment">//</span>
00300 
00301             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;InitialOwnerThreads[0] = OurThread;
00302             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0] = OurThread;
00303             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;OwnerCounts[0]  = 1;
00304             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a>     = 1;
00305             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a>           |= <a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
00306             <a class="code" href="../../d7/d4/ddkresrc_8c.html#a10">ReleaseResourceLock</a> ( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OldIrql );
00307             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00308         }
00309 
00310         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) &amp;&amp;
00311             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0] == OurThread) {
00312 
00313             <span class="comment">//</span>
00314             <span class="comment">// Our thread is already the exclusive resource owner</span>
00315             <span class="comment">//</span>
00316 
00317             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;OwnerCounts[0] += 1;
00318             <a class="code" href="../../d7/d4/ddkresrc_8c.html#a10">ReleaseResourceLock</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OldIrql );
00319             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00320         }
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">//  Check if we are allowed to wait or must return immediately, and</span>
00324         <span class="comment">//  indicate that we didn't acquire the resource</span>
00325         <span class="comment">//</span>
00326 
00327         <span class="keywordflow">if</span> (!Wait) {
00328             <a class="code" href="../../d7/d4/ddkresrc_8c.html#a10">ReleaseResourceLock</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OldIrql );
00329             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00330         }
00331 
00332         <span class="comment">//</span>
00333         <span class="comment">//  Otherwise we need to wait to acquire the resource.</span>
00334         <span class="comment">//</span>
00335 
00336         <a class="code" href="../../d7/d4/ddkresrc_8c.html#a12">WaitForResourceExclusive</a> ( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OldIrql );
00337     }
00338 }
00339 
00340 
00341 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00342"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a21">00342</a> <a class="code" href="../../d5/d8/ex_8h.html#a71">ExReleaseResourceForThread</a>(
00343     IN <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a> Resource,
00344     IN ERESOURCE_THREAD OurThread
00345     )
00346 
00347 <span class="comment">/*++</span>
00348 <span class="comment"></span>
00349 <span class="comment">Routine Description:</span>
00350 <span class="comment"></span>
00351 <span class="comment">    This routine release the input resource for the indicated thread.  The</span>
00352 <span class="comment">    resource could have been acquired for either shared or exclusive access.</span>
00353 <span class="comment"></span>
00354 <span class="comment">Arguments:</span>
00355 <span class="comment"></span>
00356 <span class="comment">    Resource - Supplies the resource to release</span>
00357 <span class="comment"></span>
00358 <span class="comment">    Thread - Supplies the thread that originally acquired the resource</span>
00359 <span class="comment"></span>
00360 <span class="comment">Return Value:</span>
00361 <span class="comment"></span>
00362 <span class="comment">    None.</span>
00363 <span class="comment"></span>
00364 <span class="comment">--*/</span>
00365 
00366 {
00367     KIRQL OldIrql;
00368 
00369     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OurThread != 0 );
00370 
00371     <span class="comment">//</span>
00372     <span class="comment">//  Get exclusive access to this resource structure</span>
00373     <span class="comment">//</span>
00374 
00375     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a9">AcquireResourceLock</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, &amp;OldIrql );
00376 
00377     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0] == OurThread );
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">// OwnerThread[0] is optimized for resources which get</span>
00381     <span class="comment">// single users.  We check it first, plus we clear the</span>
00382     <span class="comment">// threadid if the counts goes to zero</span>
00383     <span class="comment">//</span>
00384 
00385     <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;OwnerCounts[0] != 0) {
00386         <a class="code" href="../../d7/d4/ddkresrc_8c.html#a10">ReleaseResourceLock</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OldIrql );
00387         <span class="keywordflow">return</span>;
00388     }
00389 
00390     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0] = 0;
00391     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;InitialOwnerThreads[0] = 0;
00392 
00393     <span class="comment">//</span>
00394     <span class="comment">// Thread's count went to zero, lower the resource's active count.</span>
00395     <span class="comment">//</span>
00396 
00397     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> -= 1;
00398 
00399     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == 0 );
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">// Resource's activecount went to zero - clear possible exclusive</span>
00403     <span class="comment">// owner bit, and wake any waiters</span>
00404     <span class="comment">//</span>
00405 
00406     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
00407 
00408         <a class="code" href="../../d7/d4/ddkresrc_8c.html#a13">WakeExclusiveWaiters</a> ( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> );
00409     }
00410 
00411     <span class="comment">//</span>
00412     <span class="comment">//  No longer owned exclusive</span>
00413     <span class="comment">//</span>
00414 
00415     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o3">Flag</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a64">ResourceOwnedExclusive</a>;
00416 
00417     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a10">ReleaseResourceLock</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OldIrql );
00418     <span class="keywordflow">return</span>;
00419 }
00420 
00421 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00422"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a22">00422</a> <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a> (
00423     IN <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a> Resource
00424     )
00425 
00426 <span class="comment">/*++</span>
00427 <span class="comment"></span>
00428 <span class="comment">Routine Description:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    This routine deletes (i.e., uninitializes) the input resource variable</span>
00431 <span class="comment"></span>
00432 <span class="comment"></span>
00433 <span class="comment">Arguments:</span>
00434 <span class="comment"></span>
00435 <span class="comment">    Resource - Supplies the resource variable being deleted</span>
00436 <span class="comment"></span>
00437 <span class="comment">Return Value:</span>
00438 <span class="comment"></span>
00439 <span class="comment">    None</span>
00440 <span class="comment"></span>
00441 <span class="comment">--*/</span>
00442 
00443 {
00444     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Routine cannot be called at DPC "</span>, !KeIsExecutingDpc() );
00445 
00446     <a class="code" href="../../d7/d4/ddkresrc_8c.html#a0">ASSERT_RESOURCE</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> );
00447     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) );
00448 
00449 
00450     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> &gt;= (<a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a>)MM_USER_PROBE_ADDRESS) {
00451         KIRQL OldIrql;
00452 
00453         ExAcquireSpinLock( &amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a16">ExpResourceSpinLock</a>, &amp;OldIrql );
00454         RemoveEntryList( &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o0">SystemResourcesList</a> );
00455         ExReleaseSpinLock( &amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a16">ExpResourceSpinLock</a>, OldIrql );
00456 
00457     }
00458 
00459     <span class="keywordflow">return</span> STATUS_SUCCESS;
00460 }
00461 
00462 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00463"></a><a class="code" href="../../d7/d4/ddkresrc_8c.html#a18">00463</a> <a class="code" href="../../d7/d4/ddkresrc_8c.html#a18">ExpWaitForResourceDdk</a> (
00464     IN <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a>   Resource,
00465     IN PVOID        Object
00466     )
00467 <span class="comment">/*++</span>
00468 <span class="comment"></span>
00469 <span class="comment">Routine Description:</span>
00470 <span class="comment"></span>
00471 <span class="comment">    The routine waits on the Resource's object to be set.  If the</span>
00472 <span class="comment">    wait is too long the current owners of the resource are boosted</span>
00473 <span class="comment">    in priority.</span>
00474 <span class="comment"></span>
00475 <span class="comment">Arguments:</span>
00476 <span class="comment"></span>
00477 <span class="comment">    Resource - Supplies the resource</span>
00478 <span class="comment"></span>
00479 <span class="comment">    Object - Event or Semaphore to wait on</span>
00480 <span class="comment"></span>
00481 <span class="comment">Return Value:</span>
00482 <span class="comment"></span>
00483 <span class="comment">    None</span>
00484 <span class="comment"></span>
00485 <span class="comment">--*/</span>
00486 {
00487     KIRQL       OldIrql;
00488     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00489     ULONG       i;
00490 
00491 
00492     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a> += 1;
00493 
00494     i = 0;
00495     <span class="keywordflow">for</span> (; ;) {
00496         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (
00497                         Object,
00498                         <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00499                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00500                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00501                         &amp;<a class="code" href="../../d7/d4/ddkresrc_8c.html#a14">ExpTimeout</a> );
00502 
00503         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_TIMEOUT) {
00504             <span class="keywordflow">break</span>;
00505         }
00506 
00507         <span class="keywordflow">if</span> (i++ &gt;= <a class="code" href="../../d8/d0/cmdat3_8c.html#a44">ExpResourceTimeoutCount</a>) {
00508             i = 0;
00509 
00510             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Resource @ %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
00511             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" ActiveCount = %04lx  Flags = %s%s%s\n"</span>,
00512                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a>,
00513                 <a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)   ? <span class="stringliteral">"IsOwnedExclusive "</span> : <span class="stringliteral">""</span>,
00514                 <span class="stringliteral">""</span>,
00515                 <a class="code" href="../../d7/d4/ddkresrc_8c.html#a5">IsExclusiveWaiting</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) ? <span class="stringliteral">"ExclusiveWaiter "</span>  : <span class="stringliteral">""</span>
00516             );
00517 
00518             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" NumberOfExclusiveWaiters = %04lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o9">NumberOfExclusiveWaiters</a>);
00519 
00520             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  Thread = %08lx, Count = %02x\n"</span>,
00521                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0],
00522                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;OwnerCounts[0] );
00523 
00524             DbgBreakPoint();
00525             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EX - Rewaiting\n"</span>);
00526         }
00527 
00528         <span class="comment">//</span>
00529         <span class="comment">//  Give owning thread(s) a priority boost</span>
00530         <span class="comment">//</span>
00531 
00532         <a class="code" href="../../d7/d4/ddkresrc_8c.html#a9">AcquireResourceLock</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, &amp;OldIrql );
00533 
00534         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a8">IsBoostAllowed</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>) &amp;&amp; <a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>)) {
00535 
00536             <span class="comment">//</span>
00537             <span class="comment">//  Only one thread, boost it</span>
00538             <span class="comment">//</span>
00539 
00540             <a class="code" href="../../d9/d1/thredobj_8c.html#a4">KeBoostPriorityThread</a>((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>) <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0],
00541                                   <a class="code" href="../../d7/d8/exboosts_8h.html#a18">ERESOURCE_INCREMENT</a> );
00542         }
00543 
00544         <a class="code" href="../../d7/d4/ddkresrc_8c.html#a10">ReleaseResourceLock</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OldIrql );
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">//  Loop and wait some more</span>
00548         <span class="comment">//</span>
00549     }
00550 
00551     <span class="comment">//</span>
00552     <span class="comment">//  Wait was satisfied</span>
00553     <span class="comment">//</span>
00554 
00555     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00556     <span class="keywordflow">return</span> ;
00557 }
00558 
00559 <span class="preprocessor">#if DBG</span>
00560 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00561 ExpAssertResourceDdk (
00562     IN <a class="code" href="../../d3/d4/struct__NTDDK__ERESOURCE.html">PNTDDK_ERESOURCE</a>   Resource
00563 )
00564 {
00565     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d6/d6/ttime_8c.html#a12">Sum</a>;
00566 
00567     <span class="comment">//</span>
00568     <span class="comment">//  Assert internal structures headers are correct</span>
00569     <span class="comment">//</span>
00570 
00571     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>.<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> == SemaphoreObject);
00572     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o4">SharedWaiters</a>.<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o2">Size</a> == <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>));
00573     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> == SynchronizationEvent);
00574     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o5">ExclusiveWaiters</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o2">Size</a> == <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>));
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">//  Count number of currently owned threads</span>
00578     <span class="comment">//</span>
00579 
00580     <a class="code" href="../../d6/d6/ttime_8c.html#a12">Sum</a> = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;OwnerCounts[0];
00581 
00582     <span class="comment">//</span>
00583     <span class="comment">//  Verify sum is consistent with what's in the resource</span>
00584     <span class="comment">//</span>
00585 
00586     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o2">ActiveCount</a> == Sum);
00587 
00588     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ttime_8c.html#a12">Sum</a> == 0) {
00589         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource));
00590         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0] == 0);
00591         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;InitialOwnerThreads[0] == 0);
00592     }
00593 
00594     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ttime_8c.html#a12">Sum</a> &gt; 1) {
00595         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource));
00596     }
00597 
00598     <span class="comment">//</span>
00599     <span class="comment">//  Verify resource flags appear correct</span>
00600     <span class="comment">//</span>
00601 
00602     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/ddkresrc_8c.html#a6">IsOwnedExclusive</a>(Resource)) {
00603         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Sum == 1);
00604         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;OwnerCounts[0] != 0);
00605         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o6">OwnerThreads</a>[0] == <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;InitialOwnerThreads[0]);
00606     }
00607 }
00608 <span class="preprocessor">#endif  // dbg</span>
00609 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
