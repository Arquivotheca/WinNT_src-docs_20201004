<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: read.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>read.c</h1><a href="../../d7/d5/udfs_2read_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Read.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the File Read routine for Read called by the</span>
00012 <span class="comment">    Fsd/Fsp dispatch drivers.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    [DanLo]     22-Sep-1996</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d7/d5/udfs_2read_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_READ)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d7/d5/udfs_2read_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_READ)</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">//  VOID</span>
00038 <span class="comment">//  SafeZeroMemory (</span>
00039 <span class="comment">//      IN PUCHAR At,</span>
00040 <span class="comment">//      IN ULONG ByteCount</span>
00041 <span class="comment">//      );</span>
00042 <span class="comment">//</span>
00043 
00044 <span class="comment">//</span>
00045 <span class="comment">//  This macro just puts a nice little try-except around RtlZeroMemory</span>
00046 <span class="comment">//</span>
00047 
<a name="l00048"></a><a class="code" href="../../d7/d5/udfs_2read_8c.html#a2">00048</a> <span class="preprocessor">#define SafeZeroMemory(IC,AT,BYTE_COUNT) {                  \</span>
00049 <span class="preprocessor">    try {                                                   \</span>
00050 <span class="preprocessor">        RtlZeroMemory( (AT), (BYTE_COUNT) );                \</span>
00051 <span class="preprocessor">    } except( EXCEPTION_EXECUTE_HANDLER ) {                 \</span>
00052 <span class="preprocessor">         UdfRaiseStatus( IC, STATUS_INVALID_USER_BUFFER );   \</span>
00053 <span class="preprocessor">    }                                                       \</span>
00054 <span class="preprocessor">}</span>
00055 <span class="preprocessor"></span>
00056 <span class="comment">//</span>
00057 <span class="comment">// Read ahead amount used for normal data files</span>
00058 <span class="comment">//</span>
00059 
<a name="l00060"></a><a class="code" href="../../d7/d5/udfs_2read_8c.html#a3">00060</a> <span class="preprocessor">#define READ_AHEAD_GRANULARITY           (0x10000)</span>
00061 <span class="preprocessor"></span>
00062 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCommonRead)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00065 <span class="preprocessor"></span>
00066 
00067 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00068"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a261">00068</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a261">UdfCommonRead</a> (
00069     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00070     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00071     )
00072 
00073 <span class="comment">/*++</span>
00074 <span class="comment"></span>
00075 <span class="comment">Routine Description:</span>
00076 <span class="comment"></span>
00077 <span class="comment">    This is the common entry point for NtReadFile calls.  For synchronous requests,</span>
00078 <span class="comment">    CommonRead will complete the request in the current thread.  If not</span>
00079 <span class="comment">    synchronous the request will be passed to the Fsp if there is a need to</span>
00080 <span class="comment">    block.</span>
00081 <span class="comment"></span>
00082 <span class="comment">Arguments:</span>
00083 <span class="comment"></span>
00084 <span class="comment">    Irp - Supplies the Irp to process</span>
00085 <span class="comment"></span>
00086 <span class="comment">Return Value:</span>
00087 <span class="comment"></span>
00088 <span class="comment">    NTSTATUS - The result of this operation.</span>
00089 <span class="comment"></span>
00090 <span class="comment">--*/</span>
00091 
00092 {
00093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00094     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00095 
00096     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00097     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00098     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00099     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00100 
00101     BOOLEAN Wait;
00102     ULONG PagingIo;
00103     ULONG <a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>;
00104     ULONG NonCachedIo;
00105 
00106     LONGLONG StartingOffset;
00107     LONGLONG ByteRange;
00108     ULONG ByteCount;
00109     ULONG ReadByteCount;
00110     ULONG OriginalByteCount;
00111 
00112     PVOID SystemBuffer, UserBuffer;
00113 
00114     BOOLEAN ReleaseFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00115 
00116     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> MappingFileObject;
00117 
00118     <a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">UDF_IO_CONTEXT</a> LocalIoContext;
00119 
00120     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">//  If this is a zero length read then return SUCCESS immediately.</span>
00124     <span class="comment">//</span>
00125 
00126     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length == 0) {
00127 
00128         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00129         <span class="keywordflow">return</span> STATUS_SUCCESS;
00130     }
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  Decode the file object and verify we support read on this.  It</span>
00134     <span class="comment">//  must be a user file, stream file or volume file (for a data disk).</span>
00135     <span class="comment">//</span>
00136 
00137     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb, &amp;Ccb );
00138 
00139     Vcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00140 
00141     <span class="keywordflow">if</span> ((TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) || (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>)) {
00142 
00143         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_INVALID_DEVICE_REQUEST );
00144         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
00145     }
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">//  Examine our input parameters to determine if this is noncached and/or</span>
00149     <span class="comment">//  a paging io operation.</span>
00150     <span class="comment">//</span>
00151 
00152     Wait = <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a30">IRP_CONTEXT_FLAG_WAIT</a> );
00153     PagingIo = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a174">IRP_PAGING_IO</a> );
00154     NonCachedIo = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a173">IRP_NOCACHE</a> );
00155     <a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a> );
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">//  Extract the range of the Io.</span>
00159     <span class="comment">//</span>
00160 
00161     StartingOffset = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.ByteOffset.QuadPart;
00162     OriginalByteCount = ByteCount = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length;
00163 
00164     ByteRange = StartingOffset + ByteCount;
00165 
00166     <span class="comment">//</span>
00167     <span class="comment">//  Make sure that Dasd access is always non-cached.</span>
00168     <span class="comment">//</span>
00169 
00170     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00171 
00172         NonCachedIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00173     }
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">//  Acquire the file shared to perform the read.  If we are doing paging IO,</span>
00177     <span class="comment">//  it may be the case that we would have a deadlock imminent because we may</span>
00178     <span class="comment">//  block on shared access, so starve out any exclusive waiters.  This requires</span>
00179     <span class="comment">//  a degree of caution - we believe that any paging IO bursts will recede and</span>
00180     <span class="comment">//  allow the exclusive waiter in.</span>
00181     <span class="comment">//</span>
00182 
00183     <span class="keywordflow">if</span> (PagingIo) {
00184 
00185         <a class="code" href="../../d3/d8/udfprocs_8h.html#a81">UdfAcquireFileSharedStarveExclusive</a>( IrpContext, Fcb );
00186     
00187     } <span class="keywordflow">else</span> {
00188         
00189         <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, Fcb );
00190     }
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00194     <span class="comment">//</span>
00195 
00196     <span class="keywordflow">try</span> {
00197 
00198         <span class="comment">//</span>
00199         <span class="comment">//  Verify the Fcb.</span>
00200         <span class="comment">//</span>
00201 
00202         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00203 
00204         <span class="comment">//</span>
00205         <span class="comment">//  If this is a user request then verify the oplock and filelock state.</span>
00206         <span class="comment">//</span>
00207 
00208         <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00209 
00210             <span class="comment">//</span>
00211             <span class="comment">//  We check whether we can proceed</span>
00212             <span class="comment">//  based on the state of the file oplocks.</span>
00213             <span class="comment">//</span>
00214 
00215             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
00216                                        <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00217                                        IrpContext,
00218                                        <a class="code" href="../../d3/d8/udfprocs_8h.html#a247">UdfOplockComplete</a>,
00219                                        <a class="code" href="../../d3/d8/udfprocs_8h.html#a246">UdfPrePostIrp</a> );
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">//  If the result is not STATUS_SUCCESS then the Irp was completed</span>
00223             <span class="comment">//  elsewhere.</span>
00224             <span class="comment">//</span>
00225 
00226             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00227 
00228                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00229                 IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00230 
00231                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00232             }
00233 
00234             <span class="keywordflow">if</span> (!PagingIo &amp;&amp;
00235                 (Fcb-&gt;FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00236                 !<a class="code" href="../../d1/d8/fsrtl_8h.html#a117">FsRtlCheckLockForReadAccess</a>( Fcb-&gt;FileLock, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )) {
00237 
00238                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FILE_LOCK_CONFLICT );
00239             }
00240         }
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">//  Complete the request if it begins beyond the end of file.</span>
00244         <span class="comment">//</span>
00245 
00246         <span class="keywordflow">if</span> (StartingOffset &gt;= Fcb-&gt;FileSize.QuadPart) {
00247 
00248             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_END_OF_FILE );
00249         }
00250 
00251         <span class="comment">//</span>
00252         <span class="comment">//  Truncate the read if it extends beyond the end of the file.</span>
00253         <span class="comment">//</span>
00254 
00255         <span class="keywordflow">if</span> (ByteRange &gt; Fcb-&gt;FileSize.QuadPart) {
00256 
00257             ByteCount = (ULONG) (Fcb-&gt;FileSize.QuadPart - StartingOffset);
00258             ByteRange = Fcb-&gt;FileSize.QuadPart;
00259         }
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Now if the data is embedded in the ICB, map through the metadata</span>
00263         <span class="comment">//  stream to retrieve the bytes.</span>
00264         <span class="comment">//</span>
00265             
00266         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a16">FCB_STATE_EMBEDDED_DATA</a> )) {
00267 
00268             <span class="comment">//</span>
00269             <span class="comment">//  The metadata stream better be here by now.</span>
00270             <span class="comment">//</span>
00271 
00272             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a>-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00273 
00274             <span class="comment">//</span>
00275             <span class="comment">//  Bias our starting offset by the offset of the ICB in the metadata</span>
00276             <span class="comment">//  stream plus the offset of the data bytes in that ICB.  Obviously,</span>
00277             <span class="comment">//  we aren't doing non-cached IO here.</span>
00278             <span class="comment">//</span>
00279 
00280             StartingOffset += (<a class="code" href="../../d3/d8/fsrtlp_8h.html#a14">BytesFromSectors</a>( Vcb, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o15">EmbeddedVsn</a> ) + Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o16">EmbeddedOffset</a>);
00281             MappingFileObject = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a>-&gt;FileObject;
00282             NonCachedIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  We are mapping through the caller's fileobject</span>
00286         <span class="comment">//</span>
00287 
00288         } <span class="keywordflow">else</span> {
00289 
00290             MappingFileObject = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
00291         }
00292         
00293         <span class="comment">//</span>
00294         <span class="comment">//  Handle the non-cached read first.</span>
00295         <span class="comment">//</span>
00296 
00297         <span class="keywordflow">if</span> (NonCachedIo) {
00298 
00299             <span class="comment">//</span>
00300             <span class="comment">//  If we have an unaligned transfer then post this request if</span>
00301             <span class="comment">//  we can't wait.  Unaligned means that the starting offset</span>
00302             <span class="comment">//  is not on a sector boundary or the read is not integral</span>
00303             <span class="comment">//  sectors.</span>
00304             <span class="comment">//</span>
00305 
00306             ReadByteCount = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a12">SectorAlign</a>( Vcb, ByteCount );
00307 
00308             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb,  StartingOffset ) ||
00309                 (ReadByteCount &gt; OriginalByteCount)) {
00310 
00311                 <span class="keywordflow">if</span> (!Wait) {
00312 
00313                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00314                 }
00315 
00316                 <span class="comment">//</span>
00317                 <span class="comment">//  Make sure we don't overwrite the buffer.</span>
00318                 <span class="comment">//</span>
00319 
00320                 ReadByteCount = ByteCount;
00321             }
00322 
00323             <span class="comment">//</span>
00324             <span class="comment">//  Initialize the IoContext for the read.</span>
00325             <span class="comment">//  If there is a context pointer, we need to make sure it was</span>
00326             <span class="comment">//  allocated and not a stale stack pointer.</span>
00327             <span class="comment">//</span>
00328 
00329             <span class="keywordflow">if</span> (IrpContext-&gt;IoContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00330                 !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a36">IRP_CONTEXT_FLAG_ALLOC_IO</a> )) {
00331 
00332                 <span class="comment">//</span>
00333                 <span class="comment">//  If we can wait, use the context on the stack.  Otherwise</span>
00334                 <span class="comment">//  we need to allocate one.</span>
00335                 <span class="comment">//</span>
00336 
00337                 <span class="keywordflow">if</span> (Wait) {
00338 
00339                     IrpContext-&gt;IoContext = &amp;LocalIoContext;
00340                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a36">IRP_CONTEXT_FLAG_ALLOC_IO</a> );
00341 
00342                 } <span class="keywordflow">else</span> {
00343 
00344                     IrpContext-&gt;IoContext = <a class="code" href="../../d3/d8/udfprocs_8h.html#a94">UdfAllocateIoContext</a>();
00345                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a36">IRP_CONTEXT_FLAG_ALLOC_IO</a> );
00346                 }
00347             }
00348 
00349             RtlZeroMemory( IrpContext-&gt;IoContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">UDF_IO_CONTEXT</a> ));
00350     
00351             <span class="comment">//</span>
00352             <span class="comment">//  Store whether we allocated this context structure in the structure</span>
00353             <span class="comment">//  itself.</span>
00354             <span class="comment">//</span>
00355     
00356             IrpContext-&gt;IoContext-&gt;AllocatedContext =
00357                 <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a36">IRP_CONTEXT_FLAG_ALLOC_IO</a> );
00358 
00359             <span class="keywordflow">if</span> (Wait) {
00360 
00361                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;IrpContext-&gt;IoContext-&gt;SyncEvent,
00362                                    NotificationEvent,
00363                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00364 
00365             } <span class="keywordflow">else</span> {
00366 
00367                 IrpContext-&gt;IoContext-&gt;ResourceThreadId = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00368                 IrpContext-&gt;IoContext-&gt;Resource = Fcb-&gt;Resource;
00369                 IrpContext-&gt;IoContext-&gt;RequestedByteCount = ByteCount;
00370             }
00371     
00372             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = ReadByteCount;
00373 
00374             <span class="comment">//</span>
00375             <span class="comment">//  Call the NonCacheIo routine to perform the actual read.</span>
00376             <span class="comment">//</span>
00377 
00378             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a161">UdfNonCachedRead</a>( IrpContext, Fcb, StartingOffset, ReadByteCount );
00379 
00380             <span class="comment">//</span>
00381             <span class="comment">//  Don't complete this request now if STATUS_PENDING was returned.</span>
00382             <span class="comment">//</span>
00383 
00384             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00385 
00386                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00387                 ReleaseFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00388 
00389             <span class="comment">//</span>
00390             <span class="comment">//  Test is we should zero part of the buffer or update the</span>
00391             <span class="comment">//  synchronous file position.</span>
00392             <span class="comment">//</span>
00393 
00394             } <span class="keywordflow">else</span> {
00395 
00396                 <span class="comment">//</span>
00397                 <span class="comment">//  Convert any unknown error code to IO_ERROR.</span>
00398                 <span class="comment">//</span>
00399 
00400                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00401 
00402                     <span class="comment">//</span>
00403                     <span class="comment">//  Set the information field to zero.</span>
00404                     <span class="comment">//</span>
00405 
00406                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00407 
00408                     <span class="comment">//</span>
00409                     <span class="comment">//  Raise if this is a user induced error.</span>
00410                     <span class="comment">//</span>
00411 
00412                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a232">IoIsErrorUserInduced</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00413 
00414                         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00415                     }
00416 
00417                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a136">FsRtlNormalizeNtstatus</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, STATUS_UNEXPECTED_IO_ERROR );
00418 
00419                 <span class="comment">//</span>
00420                 <span class="comment">//  Check if there is any portion of the user's buffer to zero.</span>
00421                 <span class="comment">//</span>
00422 
00423                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReadByteCount != ByteCount) {
00424 
00425                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;UserBuffer );
00426                     
00427                     <a class="code" href="../../d7/d5/udfs_2read_8c.html#a2">SafeZeroMemory</a>( IrpContext,
00428                                     <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer,
00429                                              ByteCount,
00430                                              PVOID ),
00431                                     ReadByteCount - ByteCount );
00432 
00433                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = ByteCount;
00434                 }
00435 
00436                 <span class="comment">//</span>
00437                 <span class="comment">//  Update the file position if this is a synchronous request.</span>
00438                 <span class="comment">//</span>
00439 
00440                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> &amp;&amp; !PagingIo &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00441 
00442                     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a>.QuadPart = ByteRange;
00443                 }
00444             }
00445 
00446             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00447         }
00448 
00449         <span class="comment">//</span>
00450         <span class="comment">//  Handle the cached case.  Start by initializing the private</span>
00451         <span class="comment">//  cache map.</span>
00452         <span class="comment">//</span>
00453 
00454         <span class="keywordflow">if</span> (MappingFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o7">PrivateCacheMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00455 
00456             <span class="comment">//</span>
00457             <span class="comment">//  The metadata Fcb stream was fired up before any data read.  We should never</span>
00458             <span class="comment">//  see it here.</span>
00459             <span class="comment">//</span>
00460 
00461             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( MappingFileObject != Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a>-&gt;FileObject );
00462             
00463             <span class="comment">//</span>
00464             <span class="comment">//  Now initialize the cache map.</span>
00465             <span class="comment">//</span>
00466 
00467             <a class="code" href="../../d4/d2/cache_8h.html#a58">CcInitializeCacheMap</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
00468                                   (<a class="code" href="../../d1/d9/struct__CC__FILE__SIZES.html">PCC_FILE_SIZES</a>) &amp;Fcb-&gt;AllocationSize,
00469                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00470                                   &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>,
00471                                   Fcb );
00472 
00473             <a class="code" href="../../d4/d2/cache_8h.html#a86">CcSetReadAheadGranularity</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, <a class="code" href="../../d7/d5/udfs_2read_8c.html#a3">READ_AHEAD_GRANULARITY</a> );
00474         }
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">//  Read from the cache if this is not an Mdl read.</span>
00478         <span class="comment">//</span>
00479 
00480         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;MinorFunction, <a class="code" href="../../d0/d5/io_8h.html#a58">IRP_MN_MDL</a> )) {
00481 
00482             <span class="comment">//</span>
00483             <span class="comment">// If we are in the Fsp now because we had to wait earlier,</span>
00484             <span class="comment">// we must map the user buffer, otherwise we can use the</span>
00485             <span class="comment">// user's buffer directly.</span>
00486             <span class="comment">//</span>
00487 
00488             <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;SystemBuffer);
00489 
00490             <span class="comment">//</span>
00491             <span class="comment">// Now try to do the copy.</span>
00492             <span class="comment">//</span>
00493 
00494             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d2/cache_8h.html#a74">CcCopyRead</a>( MappingFileObject,
00495                              (PLARGE_INTEGER) &amp;StartingOffset,
00496                              ByteCount,
00497                              Wait,
00498                              SystemBuffer,
00499                              &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a> )) {
00500 
00501                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CANT_WAIT );
00502             }
00503 
00504             <span class="comment">//</span>
00505             <span class="comment">//  If the call didn't succeed, raise the error status</span>
00506             <span class="comment">//</span>
00507 
00508             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
00509 
00510                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
00511             }
00512 
00513             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00514 
00515         <span class="comment">//</span>
00516         <span class="comment">//  Otherwise perform the MdlRead operation.</span>
00517         <span class="comment">//</span>
00518 
00519         } <span class="keywordflow">else</span> {
00520 
00521             <a class="code" href="../../d4/d2/cache_8h.html#a78">CcMdlRead</a>( MappingFileObject,
00522                        (PLARGE_INTEGER) &amp;StartingOffset,
00523                        ByteCount,
00524                        &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>,
00525                        &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a> );
00526 
00527             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00528         }
00529 
00530         <span class="comment">//</span>
00531         <span class="comment">//  Update the current file position in the user file object.</span>
00532         <span class="comment">//</span>
00533 
00534         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> &amp;&amp; !PagingIo &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00535 
00536             IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a>.QuadPart = ByteRange;
00537         }
00538 
00539     } finally {
00540 
00541         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfCommonRead"</span> );
00542 
00543         <span class="comment">//</span>
00544         <span class="comment">//  Release the Fcb.</span>
00545         <span class="comment">//</span>
00546 
00547         <span class="keywordflow">if</span> (ReleaseFile) {
00548 
00549             <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, Fcb );
00550         }
00551     }
00552 
00553     <span class="comment">//</span>
00554     <span class="comment">//  Post the request if we got CANT_WAIT.</span>
00555     <span class="comment">//</span>
00556 
00557     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_WAIT) {
00558 
00559         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">//  Otherwise complete the request.</span>
00563     <span class="comment">//</span>
00564 
00565     } <span class="keywordflow">else</span> {
00566 
00567         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00568     }
00569 
00570     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00571 }
00572 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
