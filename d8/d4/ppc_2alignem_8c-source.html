<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: alignem.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>alignem.c</h1><a href="../../d7/d5/ppc_2alignem_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1993   IBM Corporation and Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    alignem.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the code necessary to emulate unaligned data</span>
00012 <span class="comment">    references.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Rick Simpson  4-Aug-1993</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Based on MIPS version by David N. Cutler (davec) 17-Jun-1991</span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Kernel mode only.</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00029 
00030 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00031 <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a3">KiSetFloatRegisterValue</a> (
00032     IN ULONG,
00033     IN DOUBLE,
00034     OUT PKEXCEPTION_FRAME,
00035     OUT PKTRAP_FRAME
00036     );
00037 
00038 DOUBLE
00039 <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a2">KiGetFloatRegisterValue</a> (
00040     IN ULONG,
00041     IN PKEXCEPTION_FRAME,
00042     IN PKTRAP_FRAME
00043     );
00044 
00045 <span class="comment">/*++</span>
00046 <span class="comment">    When PowerPC takes an Alignment Interrupt, the hardware loads the following:</span>
00047 <span class="comment">        SRR 0 &lt;- Address of instruction causing the interrupt</span>
00048 <span class="comment">        SRR 1 &lt;- MSR</span>
00049 <span class="comment">        DAR   &lt;- Effective address of the misaligned reference as computed</span>
00050 <span class="comment">                   by the instruction that caused the interrupt</span>
00051 <span class="comment">        DSISR &lt;- Several fields relevant to the failing instruction:</span>
00052 <span class="comment">                   Bits 12..13 &lt;- Extended op-code (XO) if instr is DS-form</span>
00053 <span class="comment">                   Bits 15..21 &lt;- Index into the table below, identifying</span>
00054 <span class="comment">                                    (for the most part) the failing instr</span>
00055 <span class="comment">                   Bits 22..26 &lt;- RT/RS/FRT/FRS field (reg no.) of instr</span>
00056 <span class="comment">                   Bits 27..31 &lt;- RA (reg no.) field for update-form instrs</span>
00057 <span class="comment"></span>
00058 <span class="comment">    For the most part, it is not necessary to retrieve the actual instruction</span>
00059 <span class="comment">    in order to emulate the effects of an unaligned load or store.  Enough</span>
00060 <span class="comment">    information is in the DSISR to distinguish most cases.  Special processing</span>
00061 <span class="comment">    is required for certain instructions -- the DSISR does not have enough</span>
00062 <span class="comment">    information for them.</span>
00063 <span class="comment"></span>
00064 <span class="comment">    It is unnecessary to compute the failing effective address by emulating</span>
00065 <span class="comment">    the instruction's addressing arithmetic, because the value required is</span>
00066 <span class="comment">    contained in the DAR.</span>
00067 <span class="comment"></span>
00068 <span class="comment">    The table here is indexed by bits 15..21 of the DSISR.</span>
00069 <span class="comment"></span>
00070 <span class="comment">    The "escape" flag indicates that some sort of special handling is needed,</span>
00071 <span class="comment">    for one of the following reasons:</span>
00072 <span class="comment">         1) More than one instruction maps to the same DSISR value</span>
00073 <span class="comment">              (ld/ldu/lwa, std/stdu)</span>
00074 <span class="comment">         2) The instruction is load-and-reserve or store-conditional,</span>
00075 <span class="comment">              and misalignment should not be "fixed up"</span>
00076 <span class="comment">         3) The instruction is a byte-reversed load or store</span>
00077 <span class="comment">         4) The instruction is "ecowx" or "eciwx"</span>
00078 <span class="comment">         5) The instruction is "dcbz"</span>
00079 <span class="comment">         6) The instruction is "stfiwx"</span>
00080 <span class="comment"></span>
00081 <span class="comment">    NOTE:  Even though lwz and lwarx share the same DSISR value (0), the</span>
00082 <span class="comment">    table entry for position 0 is used only for lwz.  This is so that the</span>
00083 <span class="comment">    most likely case (load word from unaligned address) can take the</span>
00084 <span class="comment">    mainline path.  The less likely case (load word and reserve from</span>
00085 <span class="comment">    unaligned address) is ignored and treated as if it were simply load</span>
00086 <span class="comment">    word.  Unaligned addresses are not supported for lwarx/stwcx. in the</span>
00087 <span class="comment">    PowerPC architecture.  The implementation here (allowing lwarx to</span>
00088 <span class="comment">    proceed as if it were lwx, without establishing a reservation) is</span>
00089 <span class="comment">    allowable according to the architecture; a matching store conditional</span>
00090 <span class="comment">    (stwcx.) to the same unaligned address will fail (return FALSE from</span>
00091 <span class="comment">    this routine), so the incorrect reservation address will be caught</span>
00092 <span class="comment">    then.</span>
00093 <span class="comment">--*/</span>
00094 
<a name="l00095"></a><a class="code" href="../../d0/d6/struct__ALFAULT.html">00095</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d6/struct__ALFAULT.html">_ALFAULT</a> {
<a name="l00096"></a><a class="code" href="../../d0/d6/struct__ALFAULT.html#o0">00096</a>     ULONG <a class="code" href="../../d0/d6/struct__ALFAULT.html#o0">Valid</a>    : 1;  <span class="comment">// Valid DSISR value (1) vs. Should not occur (0)</span>
<a name="l00097"></a><a class="code" href="../../d0/d6/struct__ALFAULT.html#o1">00097</a>     ULONG <a class="code" href="../../d0/d6/struct__ALFAULT.html#o1">Load</a>     : 1;  <span class="comment">// Load (1) vs. Store (0)</span>
<a name="l00098"></a><a class="code" href="../../d0/d6/struct__ALFAULT.html#o2">00098</a>     ULONG <a class="code" href="../../d0/d6/struct__ALFAULT.html#o2">Length</a>   : 2;  <span class="comment">// Length:  2 bytes (1), 4 bytes (2), 8 bytes (3)</span>
<a name="l00099"></a><a class="code" href="../../d0/d6/struct__ALFAULT.html#o3">00099</a>     ULONG <a class="code" href="../../d0/d6/struct__ALFAULT.html#o3">Signed</a>   : 1;  <span class="comment">// Sign-extended (1) vs. Zero-extended (0)</span>
<a name="l00100"></a><a class="code" href="../../d0/d6/struct__ALFAULT.html#o4">00100</a>     ULONG <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a33">Fixed</a>    : 1;  <span class="comment">// Fixed point (1) vs. Floating point (0)</span>
<a name="l00101"></a><a class="code" href="../../d0/d6/struct__ALFAULT.html#o5">00101</a>     ULONG <a class="code" href="../../d0/d6/struct__ALFAULT.html#o5">Update</a>   : 1;  <span class="comment">// Update-form (1) vs. Non-Update-form (0)</span>
<a name="l00102"></a><a class="code" href="../../d0/d6/struct__ALFAULT.html#o6">00102</a>     ULONG <a class="code" href="../../d0/d6/struct__ALFAULT.html#o6">Escape</a>   : 1;  <span class="comment">// Needs special processing (1) vs. Regular (0)</span>
00103 } <a class="code" href="../../d0/d6/struct__ALFAULT.html">ALFAULT</a>, *<a class="code" href="../../d0/d6/struct__ALFAULT.html">PALFAULT</a>;
00104 
00105 <span class="comment">// Table indices for instructions needing special handling</span>
00106 
<a name="l00107"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a0">00107</a> <span class="preprocessor">#define LDARX_INDEX_VALUE     1</span>
<a name="l00108"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a1">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define LD_INDEX_VALUE       13</span>
<a name="l00109"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a2">00109</a> <span class="preprocessor"></span><span class="preprocessor">#define STD_INDEX_VALUE      15</span>
<a name="l00110"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a3">00110</a> <span class="preprocessor"></span><span class="preprocessor">#define STWCX_INDEX_VALUE    66</span>
<a name="l00111"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a4">00111</a> <span class="preprocessor"></span><span class="preprocessor">#define STDCX_INDEX_VALUE    67</span>
<a name="l00112"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a5">00112</a> <span class="preprocessor"></span><span class="preprocessor">#define LWBRX_INDEX_VALUE    72</span>
<a name="l00113"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a6">00113</a> <span class="preprocessor"></span><span class="preprocessor">#define STWBRX_INDEX_VALUE   74</span>
<a name="l00114"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a7">00114</a> <span class="preprocessor"></span><span class="preprocessor">#define LHBRX_INDEX_VALUE    76</span>
<a name="l00115"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a8">00115</a> <span class="preprocessor"></span><span class="preprocessor">#define STHBRX_INDEX_VALUE   78</span>
<a name="l00116"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a9">00116</a> <span class="preprocessor"></span><span class="preprocessor">#define ECIWX_INDEX_VALUE    84</span>
<a name="l00117"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a10">00117</a> <span class="preprocessor"></span><span class="preprocessor">#define ECOWX_INDEX_VALUE    86</span>
<a name="l00118"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a11">00118</a> <span class="preprocessor"></span><span class="preprocessor">#define DCBZ_INDEX_VALUE     95</span>
<a name="l00119"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a12">00119</a> <span class="preprocessor"></span><span class="preprocessor">#define STFIWX_INDEX_VALUE  111</span>
00120 <span class="preprocessor"></span>
<a name="l00121"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a15">00121</a> <span class="keyword">static</span> <a class="code" href="../../d0/d6/struct__ALFAULT.html">ALFAULT</a> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a15">AlFault</a>[128] = {
00122 
00123 <span class="comment">//   Valid  Load  Length  Signed  Fixed  Update  Escape</span>
00124     {  1,     1,     2,      0,     1,      0,      0  },  <span class="comment">//   0   lwz, lwarx</span>
00125     {  1,     1,     3,      0,     1,      0,      1  },  <span class="comment">//   1   ldarx</span>
00126     {  1,     0,     2,      0,     1,      0,      0  },  <span class="comment">//   2   stw</span>
00127     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//   3</span>
00128     {  1,     1,     1,      0,     1,      0,      0  },  <span class="comment">//   4   lhz</span>
00129     {  1,     1,     1,      1,     1,      0,      0  },  <span class="comment">//   5   lha</span>
00130     {  1,     0,     1,      0,     1,      0,      0  },  <span class="comment">//   6   sth</span>
00131     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//   7</span>
00132     {  1,     1,     2,      0,     0,      0,      0  },  <span class="comment">//   8   lfs</span>
00133     {  1,     1,     3,      0,     0,      0,      0  },  <span class="comment">//   9   lfd</span>
00134     {  1,     0,     2,      0,     0,      0,      0  },  <span class="comment">//  10   stfs</span>
00135     {  1,     0,     3,      0,     0,      0,      0  },  <span class="comment">//  11   stfd</span>
00136     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  12</span>
00137     {  1,     1,     0,      0,     0,      0,      1  },  <span class="comment">//  13   ld, ldu, lwa</span>
00138     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  14</span>
00139     {  1,     0,     0,      0,     0,      0,      1  },  <span class="comment">//  15   std, stdu</span>
00140     {  1,     1,     2,      0,     1,      1,      0  },  <span class="comment">//  16   lwzu</span>
00141     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  17</span>
00142     {  1,     0,     2,      0,     1,      1,      0  },  <span class="comment">//  18   stwu</span>
00143     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  19</span>
00144     {  1,     1,     1,      0,     1,      1,      0  },  <span class="comment">//  20   lhzu</span>
00145     {  1,     1,     1,      1,     1,      1,      0  },  <span class="comment">//  21   lhau</span>
00146     {  1,     0,     1,      0,     1,      1,      0  },  <span class="comment">//  22   sthu</span>
00147     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  23</span>
00148     {  1,     1,     2,      0,     0,      1,      0  },  <span class="comment">//  24   lfsu</span>
00149     {  1,     1,     3,      0,     0,      1,      0  },  <span class="comment">//  25   lfdu</span>
00150     {  1,     0,     2,      0,     0,      1,      0  },  <span class="comment">//  26   stfsu</span>
00151     {  1,     0,     3,      0,     0,      1,      0  },  <span class="comment">//  27   stfdu</span>
00152     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  28</span>
00153     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  29</span>
00154     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  30</span>
00155     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  31</span>
00156     {  1,     1,     3,      0,     1,      0,      0  },  <span class="comment">//  32   ldx</span>
00157     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  33</span>
00158     {  1,     0,     3,      0,     1,      0,      0  },  <span class="comment">//  34   stdx</span>
00159     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  35</span>
00160     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  36</span>
00161     {  1,     1,     2,      1,     1,      0,      0  },  <span class="comment">//  37   lwax</span>
00162     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  38</span>
00163     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  39</span>
00164     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  40</span>
00165     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  41</span>
00166     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  42</span>
00167     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  43</span>
00168     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  44</span>
00169     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  45</span>
00170     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  46</span>
00171     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  47</span>
00172     {  1,     1,     3,      0,     1,      1,      0  },  <span class="comment">//  48   ldux</span>
00173     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  49</span>
00174     {  1,     0,     3,      0,     1,      1,      0  },  <span class="comment">//  50   stdux</span>
00175     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  51</span>
00176     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  52</span>
00177     {  1,     1,     2,      1,     1,      1,      0  },  <span class="comment">//  53   lwaux</span>
00178     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  54</span>
00179     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  55</span>
00180     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  56</span>
00181     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  57</span>
00182     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  58</span>
00183     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  59</span>
00184     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  60</span>
00185     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  61</span>
00186     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  62</span>
00187     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  63</span>
00188     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  64</span>
00189     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  65</span>
00190     {  1,     0,     2,      0,     1,      0,      1  },  <span class="comment">//  66   stwcx.</span>
00191     {  1,     0,     3,      0,     1,      0,      1  },  <span class="comment">//  67   stdcx.</span>
00192     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  68</span>
00193     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  69</span>
00194     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  70</span>
00195     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  71</span>
00196     {  1,     1,     2,      0,     1,      0,      1  },  <span class="comment">//  72   lwbrx</span>
00197     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  73</span>
00198     {  1,     0,     2,      0,     1,      0,      1  },  <span class="comment">//  74   stwbrx</span>
00199     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  75</span>
00200     {  1,     1,     1,      0,     1,      0,      1  },  <span class="comment">//  76   lhbrx</span>
00201     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  77</span>
00202     {  1,     0,     1,      0,     1,      0,      1  },  <span class="comment">//  78   sthbrx</span>
00203     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  79</span>
00204     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  80</span>
00205     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  81</span>
00206     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  82</span>
00207     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  83</span>
00208     {  1,     1,     2,      0,     1,      0,      1  },  <span class="comment">//  84   eciwx</span>
00209     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  85</span>
00210     {  1,     0,     2,      0,     1,      0,      1  },  <span class="comment">//  86   ecowx</span>
00211     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  87</span>
00212     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  88</span>
00213     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  89</span>
00214     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  90</span>
00215     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  91</span>
00216     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  92</span>
00217     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  93</span>
00218     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  94</span>
00219     {  1,     0,     0,      0,     0,      0,      1  },  <span class="comment">//  95   dcbz</span>
00220     {  1,     1,     2,      0,     1,      0,      0  },  <span class="comment">//  96   lwzx</span>
00221     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  97</span>
00222     {  1,     0,     2,      0,     1,      0,      0  },  <span class="comment">//  98   stwzx</span>
00223     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">//  99</span>
00224     {  1,     1,     1,      0,     1,      0,      0  },  <span class="comment">// 100   lhzx</span>
00225     {  1,     1,     1,      1,     1,      0,      0  },  <span class="comment">// 101   lhax</span>
00226     {  1,     0,     1,      0,     1,      0,      0  },  <span class="comment">// 102   sthx</span>
00227     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 103</span>
00228     {  1,     1,     2,      0,     0,      0,      0  },  <span class="comment">// 104   lfsx</span>
00229     {  1,     1,     3,      0,     0,      0,      0  },  <span class="comment">// 105   lfdx</span>
00230     {  1,     0,     2,      0,     0,      0,      0  },  <span class="comment">// 106   stfsx</span>
00231     {  1,     0,     3,      0,     0,      0,      0  },  <span class="comment">// 107   stfdx</span>
00232     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 108</span>
00233     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 109</span>
00234     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 110</span>
00235     {  1,     0,     2,      0,     1,      0,      1  },  <span class="comment">// 111   stfiwx</span>
00236     {  1,     1,     2,      0,     1,      1,      0  },  <span class="comment">// 112   lwzux</span>
00237     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 113</span>
00238     {  1,     0,     2,      0,     1,      1,      0  },  <span class="comment">// 114   stwux</span>
00239     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 115</span>
00240     {  1,     1,     1,      0,     1,      1,      0  },  <span class="comment">// 116   lhzux</span>
00241     {  1,     1,     1,      1,     1,      1,      0  },  <span class="comment">// 117   lhaux</span>
00242     {  1,     0,     1,      0,     1,      1,      0  },  <span class="comment">// 118   sthux</span>
00243     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 119</span>
00244     {  1,     1,     2,      0,     0,      1,      0  },  <span class="comment">// 120   lfsux</span>
00245     {  1,     1,     3,      0,     0,      1,      0  },  <span class="comment">// 121   lfdux</span>
00246     {  1,     0,     2,      0,     0,      1,      0  },  <span class="comment">// 122   stfsux</span>
00247     {  1,     0,     3,      0,     0,      1,      0  },  <span class="comment">// 123   stfdux</span>
00248     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 124</span>
00249     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 125</span>
00250     {  0,     0,     0,      0,     0,      0,      0  },  <span class="comment">// 126</span>
00251     {  0,     0,     0,      0,     0,      0,      0  }   <span class="comment">// 127</span>
00252 };
00253 
00254 BOOLEAN
<a name="l00255"></a><a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">00255</a> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a> (
00256     IN OUT PEXCEPTION_RECORD ExceptionRecord,
00257     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00258     IN OUT PKTRAP_FRAME TrapFrame
00259     )
00260 
00261 <span class="comment">/*++</span>
00262 <span class="comment"></span>
00263 <span class="comment">Routine Description:</span>
00264 <span class="comment"></span>
00265 <span class="comment">    This function is called to emulate an unaligned data reference to an</span>
00266 <span class="comment">    address in the user part of the address space.</span>
00267 <span class="comment"></span>
00268 <span class="comment">Arguments:</span>
00269 <span class="comment"></span>
00270 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00271 <span class="comment"></span>
00272 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00273 <span class="comment"></span>
00274 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00275 <span class="comment"></span>
00276 <span class="comment">Return Value:</span>
00277 <span class="comment"></span>
00278 <span class="comment">    A value of TRUE is returned if the data reference is successfully</span>
00279 <span class="comment">    emulated. Otherwise, a value of FALSE is returned.</span>
00280 <span class="comment"></span>
00281 <span class="comment">--*/</span>
00282 
00283 {
00284 
00285     ULONG BranchAddress;
00286     PUCHAR DataAddress;
00287 
00288     <span class="keyword">union </span>{
00289         DOUBLE Double;
00290         <span class="keywordtype">float</span>  Float;
00291         ULONG  Long;
00292         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>  Short;
00293     } DataReference;
00294     PUCHAR DataValue = (PUCHAR) &amp;DataReference;
00295 
00296     PVOID ExceptionAddress;
00297     <a class="code" href="../../d7/d9/struct__DSISR.html">DSISR</a> DsisrValue;
00298     ULONG TableIndex;
00299     ULONG DataRegNum;
00300     <a class="code" href="../../d0/d6/struct__ALFAULT.html">ALFAULT</a> Info;
00301     KIRQL OldIrql;
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">// Call out to profile interrupt if alignment profiling is active</span>
00305     <span class="comment">//</span>
00306     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/kernldat_8c.html#a52">KiProfileAlignmentFixup</a>) {
00307 
00308         <span class="keywordflow">if</span> (++<a class="code" href="../../d5/d9/kernldat_8c.html#a54">KiProfileAlignmentFixupCount</a> &gt;= <a class="code" href="../../d5/d9/kernldat_8c.html#a53">KiProfileAlignmentFixupInterval</a>) {
00309 
00310             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a56">PROFILE_LEVEL</a>, &amp;OldIrql);
00311             <a class="code" href="../../d5/d9/kernldat_8c.html#a54">KiProfileAlignmentFixupCount</a> = 0;
00312             <a class="code" href="../../d1/d9/clock_8c.html#a6">KeProfileInterruptWithSource</a>(TrapFrame, ProfileAlignmentFixup);
00313             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00314 
00315         }
00316     }
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// Save the original exception address in case another exception</span>
00320     <span class="comment">// occurs.</span>
00321     <span class="comment">//</span>
00322 
00323     ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Any exception that occurs during the attempted emulation of the</span>
00327     <span class="comment">// unaligned reference causes the emulation to be aborted. The new</span>
00328     <span class="comment">// exception code and information is copied to the original exception</span>
00329     <span class="comment">// record and a value of FALSE is returned.</span>
00330     <span class="comment">//</span>
00331 
00332     <span class="keywordflow">try</span> {
00333 
00334         <span class="comment">//</span>
00335         <span class="comment">// PowerPC has no branch-delay-slot complexities like MIPS</span>
00336         <span class="comment">//</span>
00337 
00338         BranchAddress = TrapFrame-&gt;Iar + 4;
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// The effective address of the reference from the DAR was saved</span>
00342         <span class="comment">// in the exception record. Check to make sure it is within the</span>
00343         <span class="comment">// user part of the address space. Alignment exceptions take</span>
00344         <span class="comment">// precedence over memory management exceptions (this is true</span>
00345         <span class="comment">// for PowerPC as well as MIPS) and the address could be a</span>
00346         <span class="comment">// system address.</span>
00347         <span class="comment">//</span>
00348 
00349         DataAddress = (PUCHAR) (ExceptionRecord-&gt;ExceptionInformation[1]);
00350 
00351         <span class="keywordflow">if</span> ((ULONG)DataAddress &lt; MM_USER_PROBE_ADDRESS) {
00352 
00353             <span class="comment">//</span>
00354             <span class="comment">// Get information about the failing instruction from saved DSISR.</span>
00355             <span class="comment">//</span>
00356 
00357             DsisrValue = *(<a class="code" href="../../d7/d9/struct__DSISR.html">DSISR</a>*) &amp;(ExceptionRecord-&gt;ExceptionInformation[2]);
00358             TableIndex = DsisrValue.<a class="code" href="../../d7/d9/struct__DSISR.html#o2">Index</a>;
00359             DataRegNum = DsisrValue.<a class="code" href="../../d7/d9/struct__DSISR.html#o1">DataReg</a>;
00360             Info = <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a15">AlFault</a>[TableIndex];
00361 
00362             <span class="comment">//</span>
00363             <span class="comment">// If table entry is marked invalid, we have some sort of logic error.</span>
00364             <span class="comment">//</span>
00365 
00366             <span class="keywordflow">if</span> (!Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o0">Valid</a>)
00367                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00368 
00369             <span class="comment">//</span>
00370             <span class="comment">// If table entry does not indicate special processing needed,</span>
00371             <span class="comment">//   emulate the execution of the instruction</span>
00372             <span class="comment">//</span>
00373 
00374             <span class="keywordflow">if</span> (!Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o6">Escape</a>) {
00375 
00376                     <span class="comment">//</span>
00377                     <span class="comment">// Integer or float load or store</span>
00378                     <span class="comment">//</span>
00379 
00380                 <span class="keywordflow">if</span> (Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o4">Fixed</a>) {
00381 
00382                         <span class="comment">//</span>
00383                         <span class="comment">// Integer register</span>
00384                         <span class="comment">//</span>
00385 
00386                     <span class="keywordflow">if</span> (Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o1">Load</a>) {
00387 
00388                             <span class="comment">//</span>
00389                             <span class="comment">// Integer load</span>
00390                             <span class="comment">//</span>
00391 
00392                         <span class="keywordflow">switch</span> (Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o2">Length</a>) {
00393 
00394                                 <span class="comment">//</span>
00395                                 <span class="comment">// Halfword integer load</span>
00396                                 <span class="comment">//</span>
00397 
00398                           <span class="keywordflow">case</span> 1:
00399                             DataValue[0] = DataAddress[0];
00400                             DataValue[1] = DataAddress[1];
00401                             <a class="code" href="../../d5/d5/alpha_2getsetrg_8c.html#a1">KiSetRegisterValue</a>
00402                                 (DataRegNum,
00403                                  Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o3">Signed</a> ?   <span class="comment">// sign extension ...</span>
00404                                      (ULONG) ((LONG) DataReference.Short) :
00405                                      (ULONG) ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) DataReference.Short),
00406                                  ExceptionFrame,
00407                                  TrapFrame);
00408                             <span class="keywordflow">break</span>;
00409 
00410                                 <span class="comment">//</span>
00411                                 <span class="comment">// Fullword integer load</span>
00412                                 <span class="comment">//</span>
00413 
00414                           <span class="keywordflow">case</span> 2:
00415                             DataValue[0] = DataAddress[0];
00416                             DataValue[1] = DataAddress[1];
00417                             DataValue[2] = DataAddress[2];
00418                             DataValue[3] = DataAddress[3];
00419                             <a class="code" href="../../d5/d5/alpha_2getsetrg_8c.html#a1">KiSetRegisterValue</a>
00420                                 (DataRegNum,
00421                                  DataReference.Long,
00422                                  ExceptionFrame,
00423                                  TrapFrame);
00424                             <span class="keywordflow">break</span>;
00425 
00426                                 <span class="comment">//</span>
00427                                 <span class="comment">// Doubleword integer load</span>
00428                                 <span class="comment">//</span>
00429 
00430                           <span class="keywordflow">case</span> 3:
00431                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">// Have no 8-byte integer regs yet</span>
00432 
00433                         }
00434                     } <span class="keywordflow">else</span> {
00435 
00436                             <span class="comment">//</span>
00437                             <span class="comment">// Integer store</span>
00438                             <span class="comment">//</span>
00439 
00440                         <span class="keywordflow">switch</span> (Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o2">Length</a>) {
00441 
00442                                 <span class="comment">//</span>
00443                                 <span class="comment">// Halfword integer store</span>
00444                                 <span class="comment">//</span>
00445 
00446                           <span class="keywordflow">case</span> 1:
00447                             DataReference.Short = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)
00448                                 <a class="code" href="../../d5/d5/alpha_2getsetrg_8c.html#a0">KiGetRegisterValue</a>
00449                                     (DataRegNum,
00450                                      ExceptionFrame,
00451                                      TrapFrame);
00452                             DataAddress[0] = DataValue[0];
00453                             DataAddress[1] = DataValue[1];
00454                             <span class="keywordflow">break</span>;
00455 
00456                                 <span class="comment">//</span>
00457                                 <span class="comment">// Fullword integer store</span>
00458                                 <span class="comment">//</span>
00459 
00460                           <span class="keywordflow">case</span> 2:       <span class="comment">// Word</span>
00461                             DataReference.Long =
00462                                 <a class="code" href="../../d5/d5/alpha_2getsetrg_8c.html#a0">KiGetRegisterValue</a>
00463                                     (DataRegNum,
00464                                      ExceptionFrame,
00465                                      TrapFrame);
00466                             DataAddress[0] = DataValue[0];
00467                             DataAddress[1] = DataValue[1];
00468                             DataAddress[2] = DataValue[2];
00469                             DataAddress[3] = DataValue[3];
00470                             <span class="keywordflow">break</span>;
00471 
00472                                 <span class="comment">//</span>
00473                                 <span class="comment">// Doubleword integer store</span>
00474                                 <span class="comment">//</span>
00475 
00476                           <span class="keywordflow">case</span> 3:
00477 
00478                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">// Have no 8-byte integer regs yet</span>
00479                         }
00480                     }
00481                 } <span class="keywordflow">else</span> {                <span class="comment">// Floating point</span>
00482 
00483                         <span class="comment">//</span>
00484                         <span class="comment">// Floating-point register</span>
00485                         <span class="comment">//</span>
00486 
00487                     <span class="keywordflow">if</span> (Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o1">Load</a>) {    <span class="comment">// Floating point load</span>
00488 
00489                             <span class="comment">//</span>
00490                             <span class="comment">// Floating-point load</span>
00491                             <span class="comment">//</span>
00492 
00493                         <span class="keywordflow">if</span> (Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o2">Length</a> == 2) {
00494 
00495                                 <span class="comment">//</span>
00496                                 <span class="comment">// Floating-point single precision load</span>
00497                                 <span class="comment">//</span>
00498                             DataValue[0] = DataAddress[0];
00499                             DataValue[1] = DataAddress[1];
00500                             DataValue[2] = DataAddress[2];
00501                             DataValue[3] = DataAddress[3];
00502                             <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a6">KiSetFloatRegisterValue</a>
00503                                 (DataRegNum,
00504                                  (DOUBLE) DataReference.Float,
00505                                  ExceptionFrame,
00506                                  TrapFrame);
00507 
00508                         } <span class="keywordflow">else</span> {
00509 
00510                                 <span class="comment">//</span>
00511                                 <span class="comment">// Floating-point double precision load</span>
00512                                 <span class="comment">//</span>
00513                             DataValue[0] = DataAddress[0];
00514                             DataValue[1] = DataAddress[1];
00515                             DataValue[2] = DataAddress[2];
00516                             DataValue[3] = DataAddress[3];
00517                             DataValue[4] = DataAddress[4];
00518                             DataValue[5] = DataAddress[5];
00519                             DataValue[6] = DataAddress[6];
00520                             DataValue[7] = DataAddress[7];
00521                             <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a6">KiSetFloatRegisterValue</a>
00522                                 (DataRegNum,
00523                                  DataReference.Double,
00524                                  ExceptionFrame,
00525                                  TrapFrame);
00526                         }
00527                     } <span class="keywordflow">else</span> {
00528 
00529                             <span class="comment">//</span>
00530                             <span class="comment">// Floating-point store</span>
00531                             <span class="comment">//</span>
00532 
00533                         <span class="keywordflow">if</span> (Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o2">Length</a> == 2) {
00534 
00535                                 <span class="comment">//</span>
00536                                 <span class="comment">// Floating-point single precision store</span>
00537                                 <span class="comment">//</span>
00538 
00539                             DataReference.Float = (<span class="keywordtype">float</span>)
00540                                 <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a5">KiGetFloatRegisterValue</a>
00541                                     (DataRegNum,
00542                                      ExceptionFrame,
00543                                      TrapFrame);
00544                             DataAddress[0] = DataValue[0];
00545                             DataAddress[1] = DataValue[1];
00546                             DataAddress[2] = DataValue[2];
00547                             DataAddress[3] = DataValue[3];
00548 
00549                         } <span class="keywordflow">else</span> {
00550 
00551                                 <span class="comment">//</span>
00552                                 <span class="comment">// Floating-point double precision store</span>
00553                                 <span class="comment">//</span>
00554                             DataReference.Double =
00555                                 <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a5">KiGetFloatRegisterValue</a>
00556                                     (DataRegNum,
00557                                      ExceptionFrame,
00558                                      TrapFrame);
00559                             DataAddress[0] = DataValue[0];
00560                             DataAddress[1] = DataValue[1];
00561                             DataAddress[2] = DataValue[2];
00562                             DataAddress[3] = DataValue[3];
00563                             DataAddress[4] = DataValue[4];
00564                             DataAddress[5] = DataValue[5];
00565                             DataAddress[6] = DataValue[6];
00566                             DataAddress[7] = DataValue[7];
00567                         }
00568                     }
00569                 }
00570 
00571                 <span class="comment">//</span>
00572                 <span class="comment">// See if "update" (post-increment) form of addressing</span>
00573                 <span class="comment">//</span>
00574 
00575                 <span class="keywordflow">if</span> (Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o5">Update</a>)
00576                     <a class="code" href="../../d5/d5/alpha_2getsetrg_8c.html#a1">KiSetRegisterValue</a>  <span class="comment">// Store effective addr back into base reg</span>
00577                         (DsisrValue.<a class="code" href="../../d7/d9/struct__DSISR.html#o0">UpdateReg</a>,
00578                          (ULONG) DataAddress,
00579                          ExceptionFrame,
00580                          TrapFrame);
00581 
00582             }
00583 
00584             <span class="comment">//</span>
00585             <span class="comment">// Table indicates that special processing is needed, either because</span>
00586             <span class="comment">// the DSISR does not contain enough information to disambiguate the</span>
00587             <span class="comment">// failing instruction, or the instruction is not a load or store,</span>
00588             <span class="comment">// or the instruction has some other unusual requirement.</span>
00589             <span class="comment">//</span>
00590 
00591             <span class="keywordflow">else</span> {                      <span class="comment">// Info.Escape == 1</span>
00592                 <span class="keywordflow">switch</span> (TableIndex) {
00593 
00594                 <span class="comment">//</span>
00595                 <span class="comment">// Doubleword integers not yet supported</span>
00596                 <span class="comment">//</span>
00597 
00598                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a1">LD_INDEX_VALUE</a>:
00599                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a2">STD_INDEX_VALUE</a>:
00600                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00601 
00602                 <span class="comment">//</span>
00603                 <span class="comment">// Load-and-reserve, store-conditional not supported</span>
00604                 <span class="comment">//   for misaligned addresses</span>
00605                 <span class="comment">//</span>
00606 
00607                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a0">LDARX_INDEX_VALUE</a>:
00608                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a3">STWCX_INDEX_VALUE</a>:
00609                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a4">STDCX_INDEX_VALUE</a>:
00610                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00611 
00612                 <span class="comment">//</span>
00613                 <span class="comment">// Integer byte-reversed fullword load</span>
00614                 <span class="comment">//</span>
00615 
00616                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a5">LWBRX_INDEX_VALUE</a>:
00617                     DataValue[0] = DataAddress[3];
00618                     DataValue[1] = DataAddress[2];
00619                     DataValue[2] = DataAddress[1];
00620                     DataValue[3] = DataAddress[0];
00621                     <a class="code" href="../../d5/d5/alpha_2getsetrg_8c.html#a1">KiSetRegisterValue</a>
00622                         (DataRegNum,
00623                          DataReference.Long,
00624                          ExceptionFrame,
00625                          TrapFrame);
00626                     <span class="keywordflow">break</span>;
00627 
00628                 <span class="comment">//</span>
00629                 <span class="comment">// Integer byte-reversed fullword store</span>
00630                 <span class="comment">//</span>
00631 
00632                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a6">STWBRX_INDEX_VALUE</a>:
00633                     DataReference.Long =
00634                         <a class="code" href="../../d5/d5/alpha_2getsetrg_8c.html#a0">KiGetRegisterValue</a>
00635                             (DataRegNum,
00636                              ExceptionFrame,
00637                              TrapFrame);
00638                     DataAddress[0] = DataValue[3];
00639                     DataAddress[1] = DataValue[2];
00640                     DataAddress[2] = DataValue[1];
00641                     DataAddress[3] = DataValue[0];
00642                     <span class="keywordflow">break</span>;
00643 
00644                 <span class="comment">//</span>
00645                 <span class="comment">// Integer byte-reversed halfword load</span>
00646                 <span class="comment">//</span>
00647 
00648                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a7">LHBRX_INDEX_VALUE</a>:
00649                     DataValue[0] = DataAddress[1];
00650                     DataValue[1] = DataAddress[0];
00651                     <a class="code" href="../../d5/d5/alpha_2getsetrg_8c.html#a1">KiSetRegisterValue</a>
00652                         (DataRegNum,
00653                          Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o3">Signed</a> ?   <span class="comment">// sign extension ...</span>
00654                              (ULONG) ((LONG) DataReference.Short) :
00655                              (ULONG) ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) DataReference.Short),
00656                          ExceptionFrame,
00657                          TrapFrame);
00658                     <span class="keywordflow">break</span>;
00659 
00660                 <span class="comment">//</span>
00661                 <span class="comment">// Integer byte-reversed halfword store</span>
00662                 <span class="comment">//</span>
00663 
00664                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a8">STHBRX_INDEX_VALUE</a>:
00665                     DataReference.Short = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)
00666                         <a class="code" href="../../d5/d5/alpha_2getsetrg_8c.html#a0">KiGetRegisterValue</a>
00667                             (DataRegNum,
00668                              ExceptionFrame,
00669                              TrapFrame);
00670                     DataAddress[0] = DataValue[1];
00671                     DataAddress[1] = DataValue[0];
00672                     <span class="keywordflow">break</span>;
00673 
00674                 <span class="comment">//</span>
00675                 <span class="comment">// Special I/O instructions not supported yet</span>
00676                 <span class="comment">//</span>
00677 
00678                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a9">ECIWX_INDEX_VALUE</a>:
00679                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a10">ECOWX_INDEX_VALUE</a>:
00680                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00681 
00682                 <span class="comment">//</span>
00683                 <span class="comment">// Data Cache Block Zero</span>
00684                 <span class="comment">//</span>
00685                 <span class="comment">//   dcbz causes an alignment fault if cache is disabled</span>
00686                 <span class="comment">//   for the address range covered by the block.</span>
00687                 <span class="comment">//</span>
00688                 <span class="comment">//   A data cache block is 32 bytes long, we emulate this</span>
00689                 <span class="comment">//   instruction by storing 8 zero integers a the address</span>
00690                 <span class="comment">//   specified.</span>
00691                 <span class="comment">//</span>
00692                 <span class="comment">//   Note, dcbz zeros the block "containing" the address</span>
00693                 <span class="comment">//   so we round down first.</span>
00694                 <span class="comment">//</span>
00695 
00696                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a11">DCBZ_INDEX_VALUE</a>: {
00697                     PULONG DcbAddress = (PULONG)((ULONG)DataAddress &amp; ~0x1f);
00698 
00699                     *DcbAddress++ = 0;
00700                     *DcbAddress++ = 0;
00701                     *DcbAddress++ = 0;
00702                     *DcbAddress++ = 0;
00703                     *DcbAddress++ = 0;
00704                     *DcbAddress++ = 0;
00705                     *DcbAddress++ = 0;
00706                     *DcbAddress++ = 0;
00707                     <span class="keywordflow">break</span>;
00708                   }
00709 
00710                 <span class="comment">//</span>
00711                 <span class="comment">// Store Floating as Integer</span>
00712                 <span class="comment">//</span>
00713 
00714                   <span class="keywordflow">case</span> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a12">STFIWX_INDEX_VALUE</a>:
00715                     DataReference.Double =
00716                         <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a5">KiGetFloatRegisterValue</a>
00717                             (DataRegNum,
00718                              ExceptionFrame,
00719                              TrapFrame);
00720                     DataAddress[0] = DataValue[0];
00721                     DataAddress[1] = DataValue[1];
00722                     DataAddress[2] = DataValue[2];
00723                     DataAddress[3] = DataValue[3];
00724                 }
00725             }
00726 
00727             TrapFrame-&gt;Iar = BranchAddress;
00728             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00729         }
00730 
00731     <span class="comment">//</span>
00732     <span class="comment">// If an exception occurs, then copy the new exception information to the</span>
00733     <span class="comment">// original exception record and handle the exception.</span>
00734     <span class="comment">//</span>
00735 
00736     } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(ExceptionRecord,
00737                                (GetExceptionInformation())-&gt;ExceptionRecord)) {
00738 
00739         <span class="comment">//</span>
00740         <span class="comment">// Preserve the original exception address.</span>
00741         <span class="comment">//</span>
00742 
00743         ExceptionRecord-&gt;ExceptionAddress = ExceptionAddress;
00744     }
00745 
00746     <span class="comment">//</span>
00747     <span class="comment">// Return a value of FALSE.</span>
00748     <span class="comment">//</span>
00749 
00750     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00751 }
00752 
00753 BOOLEAN
<a name="l00754"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a8">00754</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a8">KiEmulateDcbz</a> (
00755     IN OUT PEXCEPTION_RECORD ExceptionRecord,
00756     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00757     IN OUT PKTRAP_FRAME TrapFrame
00758     )
00759 
00760 <span class="comment">/*++</span>
00761 <span class="comment"></span>
00762 <span class="comment">Routine Description:</span>
00763 <span class="comment"></span>
00764 <span class="comment">    This function is called to emulate a Data Cache Block Zero instruction.</span>
00765 <span class="comment">    The PowerPC hardware will raise an alignment exception if a DCBZ is</span>
00766 <span class="comment">    attempted on non-cached memory.   We need to emulate this even in kernel</span>
00767 <span class="comment">    mode so we can debug h/w problems by disabling the data cache.</span>
00768 <span class="comment"></span>
00769 <span class="comment">Arguments:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00772 <span class="comment"></span>
00773 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00774 <span class="comment"></span>
00775 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00776 <span class="comment"></span>
00777 <span class="comment">Return Value:</span>
00778 <span class="comment"></span>
00779 <span class="comment">    A value of TRUE is returned if the data reference is successfully</span>
00780 <span class="comment">    emulated. Otherwise, a value of FALSE is returned.</span>
00781 <span class="comment"></span>
00782 <span class="comment">--*/</span>
00783 
00784 {
00785 
00786     PUCHAR DataAddress;
00787     PVOID ExceptionAddress;
00788     <a class="code" href="../../d7/d9/struct__DSISR.html">DSISR</a> DsisrValue;
00789     ULONG TableIndex;
00790     ULONG DataRegNum;
00791     <a class="code" href="../../d0/d6/struct__ALFAULT.html">ALFAULT</a> Info;
00792 
00793     <span class="comment">//</span>
00794     <span class="comment">// Save the original exception address in case another exception</span>
00795     <span class="comment">// occurs.</span>
00796     <span class="comment">//</span>
00797 
00798     ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// Any exception that occurs during the attempted emulation of the</span>
00802     <span class="comment">// unaligned reference causes the emulation to be aborted. The new</span>
00803     <span class="comment">// exception code and information is copied to the original exception</span>
00804     <span class="comment">// record and a value of FALSE is returned.</span>
00805     <span class="comment">//</span>
00806 
00807     <span class="keywordflow">try</span> {
00808 
00809         <span class="comment">//</span>
00810         <span class="comment">// The effective address of the reference from the DAR was saved</span>
00811         <span class="comment">// in the exception record. Check to make sure it is within the</span>
00812         <span class="comment">// user part of the address space. Alignment exceptions take</span>
00813         <span class="comment">// precedence over memory management exceptions (this is true</span>
00814         <span class="comment">// for PowerPC as well as MIPS) and the address could be a</span>
00815         <span class="comment">// system address.</span>
00816         <span class="comment">//</span>
00817 
00818         DataAddress = (PUCHAR) (ExceptionRecord-&gt;ExceptionInformation[1]);
00819 
00820         <span class="comment">//</span>
00821         <span class="comment">// Get information about the failing instruction from saved DSISR.</span>
00822         <span class="comment">//</span>
00823 
00824         DsisrValue = *(<a class="code" href="../../d7/d9/struct__DSISR.html">DSISR</a>*) &amp;(ExceptionRecord-&gt;ExceptionInformation[2]);
00825         TableIndex = DsisrValue.<a class="code" href="../../d7/d9/struct__DSISR.html#o2">Index</a>;
00826         DataRegNum = DsisrValue.<a class="code" href="../../d7/d9/struct__DSISR.html#o1">DataReg</a>;
00827         Info = <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a15">AlFault</a>[TableIndex];
00828 
00829         <span class="comment">//</span>
00830         <span class="comment">// If table entry is valid and does not indicate special processing</span>
00831         <span class="comment">// needed, and is a DCBZ instruction, emulate the execution of the </span>
00832         <span class="comment">// instruction</span>
00833         <span class="comment">//</span>
00834 
00835         <span class="keywordflow">if</span> (Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o0">Valid</a> &amp;&amp; Info.<a class="code" href="../../d0/d6/struct__ALFAULT.html#o6">Escape</a> &amp;&amp; (TableIndex == <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a11">DCBZ_INDEX_VALUE</a>)) {
00836 
00837             <span class="comment">//</span>
00838             <span class="comment">// Data Cache Block Zero</span>
00839             <span class="comment">//</span>
00840             <span class="comment">//   A data cache block is 32 bytes long, we emulate this</span>
00841             <span class="comment">//   instruction by storing 8 zero integers a the address</span>
00842             <span class="comment">//   specified.</span>
00843             <span class="comment">//</span>
00844             <span class="comment">//   Note, dcbz zeros the block "containing" the address</span>
00845             <span class="comment">//   so we round down first.</span>
00846             <span class="comment">//</span>
00847 
00848             PULONG DcbAddress = (PULONG)((ULONG)DataAddress &amp; ~0x1f);
00849 
00850             *DcbAddress++ = 0;
00851             *DcbAddress++ = 0;
00852             *DcbAddress++ = 0;
00853             *DcbAddress++ = 0;
00854             *DcbAddress++ = 0;
00855             *DcbAddress++ = 0;
00856             *DcbAddress++ = 0;
00857             *DcbAddress++ = 0;
00858 
00859             <span class="comment">//</span>
00860             <span class="comment">// Bump instruction address to next instruction.</span>
00861             <span class="comment">//</span>
00862 
00863             TrapFrame-&gt;Iar += 4;
00864 
00865             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00866         }
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">// If an exception occurs, then copy the new exception information to the</span>
00870     <span class="comment">// original exception record and handle the exception.</span>
00871     <span class="comment">//</span>
00872 
00873     } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(ExceptionRecord,
00874                                (GetExceptionInformation())-&gt;ExceptionRecord)) {
00875 
00876         <span class="comment">//</span>
00877         <span class="comment">// Preserve the original exception address.</span>
00878         <span class="comment">//</span>
00879 
00880         ExceptionRecord-&gt;ExceptionAddress = ExceptionAddress;
00881     }
00882 
00883     <span class="comment">//</span>
00884     <span class="comment">// Return a value of FALSE.</span>
00885     <span class="comment">//</span>
00886 
00887     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00888 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
